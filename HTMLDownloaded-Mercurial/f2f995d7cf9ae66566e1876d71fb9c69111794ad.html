<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25521:f2f995d7cf9ae66566e1876d71fb9c69111794ad</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f2f995d7cf9ae66566e1876d71fb9c69111794ad" />
<meta property="og:url" content="/comm-central/rev/f2f995d7cf9ae66566e1876d71fb9c69111794ad" />
<meta property="og:description" content="Bug 1517059 - Tidy up Mozmill/JSBridge resources; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f2f995d7cf9ae66566e1876d71fb9c69111794ad 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f2f995d7cf9ae66566e1876d71fb9c69111794ad">shortlog</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f2f995d7cf9ae66566e1876d71fb9c69111794ad">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad">files</a> |
changeset |
<a href="/comm-central/raw-rev/f2f995d7cf9ae66566e1876d71fb9c69111794ad">raw</a>  | <a href="/comm-central/archive/f2f995d7cf9ae66566e1876d71fb9c69111794ad.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1517059">Bug 1517059</a> - Tidy up Mozmill/JSBridge resources; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 07 Jan 2019 21:53:00 +1300</td></tr>

<tr>
 <td>changeset 25521</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f2f995d7cf9ae66566e1876d71fb9c69111794ad">f2f995d7cf9ae66566e1876d71fb9c69111794ad</a></td>
</tr>



<tr>
<td>parent 25520</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ab47677bc7ad7c124e96bd50102a6983fdf51a74">ab47677bc7ad7c124e96bd50102a6983fdf51a74</a>
</td>
</tr>

<tr>
<td>child 25522</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f8ef458411f47cdc8d7b39dc4ccbf4ab0afaf546">f8ef458411f47cdc8d7b39dc4ccbf4ab0afaf546</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f2f995d7cf9ae66566e1876d71fb9c69111794ad">15315</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 07 Jan 2019 08:57:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b5994bd3ba76 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b5994bd3ba7619d27bbae69c8243911afb2e1583">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b5994bd3ba7619d27bbae69c8243911afb2e1583&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b5994bd3ba7619d27bbae69c8243911afb2e1583&newProject=comm-central&newRevision=f2f995d7cf9ae66566e1876d71fb9c69111794ad&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b5994bd3ba7619d27bbae69c8243911afb2e1583&newProject=comm-central&newRevision=f2f995d7cf9ae66566e1876d71fb9c69111794ad&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b5994bd3ba7619d27bbae69c8243911afb2e1583&newProject=comm-central&newRevision=f2f995d7cf9ae66566e1876d71fb9c69111794ad&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1517059">1517059</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1517059">Bug 1517059</a> - Tidy up Mozmill/JSBridge resources; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-policy/wrapper.py">mail/test/mozmill/content-policy/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-policy/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-policy/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-policy/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-policy/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-policy/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-tabs/wrapper.py">mail/test/mozmill/content-tabs/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-tabs/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-tabs/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-tabs/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-tabs/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/content-tabs/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/folder-tree-modes/wrapper.py">mail/test/mozmill/folder-tree-modes/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/folder-tree-modes/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/folder-tree-modes/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/folder-tree-modes/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/folder-tree-modes/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/folder-tree-modes/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/instrumentation/wrapper.py">mail/test/mozmill/instrumentation/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/instrumentation/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/instrumentation/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/instrumentation/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/instrumentation/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/instrumentation/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/override-main-menu-collapse/wrapper.py">mail/test/mozmill/override-main-menu-collapse/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/override-main-menu-collapse/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/override-main-menu-collapse/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/override-main-menu-collapse/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/override-main-menu-collapse/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/override-main-menu-collapse/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/pref-window/wrapper.py">mail/test/mozmill/pref-window/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/pref-window/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/pref-window/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/pref-window/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/pref-window/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/pref-window/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtest.py">mail/test/mozmill/runtest.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtest.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtest.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtest.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtest.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtest.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtestlist.py">mail/test/mozmill/runtestlist.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtestlist.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtestlist.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtestlist.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtestlist.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/runtestlist.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/startup-firstrun/wrapper.py">mail/test/mozmill/startup-firstrun/wrapper.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/startup-firstrun/wrapper.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/startup-firstrun/wrapper.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/startup-firstrun/wrapper.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/startup-firstrun/wrapper.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/mozmill/startup-firstrun/wrapper.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/installmozmill.py">mail/test/resources/installmozmill.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/installmozmill.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/installmozmill.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/installmozmill.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/installmozmill.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/installmozmill.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/__init__.py">mail/test/resources/jsbridge/jsbridge/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/__init__.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/__init__.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/__init__.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/__init__.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/jsobjects.py">mail/test/resources/jsbridge/jsbridge/jsobjects.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/jsobjects.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/jsobjects.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/jsobjects.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/jsobjects.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/jsobjects.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/network.py">mail/test/resources/jsbridge/jsbridge/network.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/network.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/network.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/network.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/network.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/jsbridge/network.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/setup.py">mail/test/resources/jsbridge/setup.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/setup.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/setup.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/setup.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/setup.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/jsbridge/setup.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/MANIFEST.in">mail/test/resources/mozmill/MANIFEST.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/MANIFEST.in">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/MANIFEST.in">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/MANIFEST.in">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/MANIFEST.in">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/MANIFEST.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/mozmill/__init__.py">mail/test/resources/mozmill/mozmill/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/mozmill/__init__.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/mozmill/__init__.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/mozmill/__init__.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/mozmill/__init__.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/mozmill/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/setup.py">mail/test/resources/mozmill/setup.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/setup.py">file</a> |
<a href="/comm-central/annotate/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/setup.py">annotate</a> |
<a href="/comm-central/diff/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/setup.py">diff</a> |
<a href="/comm-central/comparison/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/setup.py">comparison</a> |
<a href="/comm-central/log/f2f995d7cf9ae66566e1876d71fb9c69111794ad/mail/test/resources/mozmill/setup.py">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/wrapper.py</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/wrapper.py</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> import os</span>
<a href="#l1.9"></a><span id="l1.9"> import shutil</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-import sys</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+</span>
<a href="#l1.12"></a><span id="l1.12"> </span>
<a href="#l1.13"></a><span id="l1.13"> def on_profile_created(profiledir):</span>
<a href="#l1.14"></a><span id="l1.14">     &quot;&quot;&quot;</span>
<a href="#l1.15"></a><span id="l1.15">     On profile creation, this copies *-prefs.js from the current folder to</span>
<a href="#l1.16"></a><span id="l1.16">     profile_dir as a user.js file. These user prefs is interpreted in addition</span>
<a href="#l1.17"></a><span id="l1.17">     to the standard prefs.js file.</span>
<a href="#l1.18"></a><span id="l1.18">     &quot;&quot;&quot;</span>
<a href="#l1.19"></a><span id="l1.19">     # The pref file is in the same directory this script is in.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/wrapper.py</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/wrapper.py</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l2.4"></a><span id="l2.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> import os</span>
<a href="#l2.9"></a><span id="l2.9"> import shutil</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-import sys</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+</span>
<a href="#l2.12"></a><span id="l2.12"> </span>
<a href="#l2.13"></a><span id="l2.13"> def on_profile_created(profiledir):</span>
<a href="#l2.14"></a><span id="l2.14">     &quot;&quot;&quot;</span>
<a href="#l2.15"></a><span id="l2.15">     On profile creation, this copies *-prefs.js from the current folder to</span>
<a href="#l2.16"></a><span id="l2.16">     profile_dir as a user.js file. These user prefs is interpreted in addition</span>
<a href="#l2.17"></a><span id="l2.17">     to the standard prefs.js file.</span>
<a href="#l2.18"></a><span id="l2.18">     &quot;&quot;&quot;</span>
<a href="#l2.19"></a><span id="l2.19">     # The pref file is in the same directory this script is in.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/wrapper.py</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/wrapper.py</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> # We install an extension that provides a test folder tree mode.</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> import os</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13"> def on_before_start(profile):</span>
<a href="#l3.14"></a><span id="l3.14">     &quot;&quot;&quot;</span>
<a href="#l3.15"></a><span id="l3.15">     This installs the extension in the test-extension subdirectory into the</span>
<a href="#l3.16"></a><span id="l3.16">     profile folder. We cannot use on_profile_created here because</span>
<a href="#l3.17"></a><span id="l3.17">     install_plugin/install_addon depends on the profile object being fully</span>
<a href="#l3.18"></a><span id="l3.18">     initialized.</span>
<a href="#l3.19"></a><span id="l3.19">     &quot;&quot;&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/instrumentation/wrapper.py</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/instrumentation/wrapper.py</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,21 +3,21 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> # For test-instrumentation.js, we need to disable the account provisioner, or</span>
<a href="#l4.7"></a><span id="l4.7"> # else it will spawn immediately and block before we have a chance to run</span>
<a href="#l4.8"></a><span id="l4.8"> # any Mozmill tests.</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> import os</span>
<a href="#l4.11"></a><span id="l4.11"> import shutil</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-import sys</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> # We don't want any accounts for these tests.</span>
<a href="#l4.15"></a><span id="l4.15"> NO_ACCOUNTS = True</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18"> def on_profile_created(profiledir):</span>
<a href="#l4.19"></a><span id="l4.19">     &quot;&quot;&quot;</span>
<a href="#l4.20"></a><span id="l4.20">     On profile creation, this copies *-prefs.js from the current folder to</span>
<a href="#l4.21"></a><span id="l4.21">     profile_dir as a user.js file. These user prefs is interpreted in addition</span>
<a href="#l4.22"></a><span id="l4.22">     to the standard prefs.js file.</span>
<a href="#l4.23"></a><span id="l4.23">     &quot;&quot;&quot;</span>
<a href="#l4.24"></a><span id="l4.24">     # The pref file is in the same directory this script is in.</span>
<a href="#l4.25"></a><span id="l4.25">     preffile = os.path.join(os.path.dirname(__file__), &quot;prefs.js&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/override-main-menu-collapse/wrapper.py</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/override-main-menu-collapse/wrapper.py</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,23 +3,23 @@</span>
<a href="#l5.4"></a><span id="l5.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> # For these tests, we need to disable the account provisioner, or</span>
<a href="#l5.7"></a><span id="l5.7"> # else it will spawn immediately and block before we have a chance to run</span>
<a href="#l5.8"></a><span id="l5.8"> # any Mozmill tests.</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> import os</span>
<a href="#l5.11"></a><span id="l5.11"> import shutil</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-import sys</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> # We don't want any accounts for these tests.</span>
<a href="#l5.15"></a><span id="l5.15"> NO_ACCOUNTS = True</span>
<a href="#l5.16"></a><span id="l5.16"> # Do not force enable main menu bar, we'll set our own value in prefs.js.</span>
<a href="#l5.17"></a><span id="l5.17"> DEFAULT_MENUBAR = True</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20"> def on_profile_created(profiledir):</span>
<a href="#l5.21"></a><span id="l5.21">     &quot;&quot;&quot;</span>
<a href="#l5.22"></a><span id="l5.22">     On profile creation, this copies prefs.js from the current folder to</span>
<a href="#l5.23"></a><span id="l5.23">     profile_dir as a user.js file. These user prefs is interpreted in addition</span>
<a href="#l5.24"></a><span id="l5.24">     to the standard prefs.js file.</span>
<a href="#l5.25"></a><span id="l5.25">     &quot;&quot;&quot;</span>
<a href="#l5.26"></a><span id="l5.26">     # The pref file is in the same directory this script is in.</span>
<a href="#l5.27"></a><span id="l5.27">     preffile = os.path.join(os.path.dirname(__file__), &quot;prefs.js&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/pref-window/wrapper.py</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/pref-window/wrapper.py</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -9,16 +9,17 @@ import shutil</span>
<a href="#l6.4"></a><span id="l6.4"> import sys</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> _pref_file_names = {</span>
<a href="#l6.7"></a><span id="l6.7">     &quot;win32&quot;: &quot;windows-prefs.js&quot;,</span>
<a href="#l6.8"></a><span id="l6.8">     &quot;darwin&quot;: &quot;mac-prefs.js&quot;,</span>
<a href="#l6.9"></a><span id="l6.9">     &quot;linux2&quot;: &quot;linux-prefs.js&quot;,</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13"> def on_profile_created(profiledir):</span>
<a href="#l6.14"></a><span id="l6.14">     &quot;&quot;&quot;</span>
<a href="#l6.15"></a><span id="l6.15">     On profile creation, this copies *-prefs.js from the current folder to</span>
<a href="#l6.16"></a><span id="l6.16">     profile_dir as a user.js file. These user prefs is interpreted in addition</span>
<a href="#l6.17"></a><span id="l6.17">     to the standard prefs.js file.</span>
<a href="#l6.18"></a><span id="l6.18">     &quot;&quot;&quot;</span>
<a href="#l6.19"></a><span id="l6.19">     # The pref file is in the same directory this script is in.</span>
<a href="#l6.20"></a><span id="l6.20">     # Fallback to Linux prefs for anything not in the dictionary -- we're</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,42 +1,35 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #!/usr/bin/env python</span>
<a href="#l7.5"></a><span id="l7.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-&quot;&quot;&quot;</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-Runs the Bloat test harness</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-&quot;&quot;&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-import sys</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-import os, os.path, platform, subprocess, signal</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-import shutil</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+from base64 import b64decode</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+from time import sleep</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+import atexit</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+import imp</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+import jsbridge</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+import json</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+import mozcrash</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+import mozmill</span>
<a href="#l7.24"></a><span id="l7.24"> import mozprofile</span>
<a href="#l7.25"></a><span id="l7.25"> import mozrunner</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-import jsbridge</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-import mozmill</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-import socket</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-import copy</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-# Python 2.6 has the json module, but Python 2.5 doesn't.</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-try:</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    import json</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-except ImportError:</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    import simplejson as json</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+import os</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+import platform</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+import shutil</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+import stat</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+import subprocess</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+import sys</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+import tempfile</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44"> SCRIPT_DIRECTORY = os.path.abspath(os.path.realpath(os.path.dirname(sys.argv[0])))</span>
<a href="#l7.45"></a><span id="l7.45"> sys.path.append(SCRIPT_DIRECTORY)</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-import mozcrash</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-from time import sleep</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-import imp</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-PROFILE_DIR = os.path.join(SCRIPT_DIRECTORY, 'mozmillprofile')</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+PROFILE_DIR = os.path.join(tempfile.gettempdir(), 'mozmillprofile')</span>
<a href="#l7.54"></a><span id="l7.54"> SYMBOLS_PATH = None</span>
<a href="#l7.55"></a><span id="l7.55"> PLUGINS_PATH = None</span>
<a href="#l7.56"></a><span id="l7.56"> # XXX This breaks any semblance of test runner modularity, and only works</span>
<a href="#l7.57"></a><span id="l7.57"> # because we know that we run MozMill only once per process. This needs to be</span>
<a href="#l7.58"></a><span id="l7.58"> # fixed if that ever changes.</span>
<a href="#l7.59"></a><span id="l7.59"> TEST_NAME = None</span>
<a href="#l7.60"></a><span id="l7.60"> TESTING_MODULES_DIR = None</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62" class="difflineat">@@ -50,46 +43,47 @@ wrapper = None</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64"> # Shall we print out a big blob of base64 to allow post-processors to print out</span>
<a href="#l7.65"></a><span id="l7.65"> # a screenshot at the time the failure happened?</span>
<a href="#l7.66"></a><span id="l7.66"> USE_RICH_FAILURES = False</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68"> # Save screenshots of failures, so they can be uploaded as a TaskCluster artifact?</span>
<a href="#l7.69"></a><span id="l7.69"> UPLOAD_SCREENSHOTS = False</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+</span>
<a href="#l7.72"></a><span id="l7.72"> # We need this because rmtree-ing read-only files fails on Windows</span>
<a href="#l7.73"></a><span id="l7.73"> def rmtree_onerror(func, path, exc_info):</span>
<a href="#l7.74"></a><span id="l7.74">     &quot;&quot;&quot;</span>
<a href="#l7.75"></a><span id="l7.75">     Error handler for ``shutil.rmtree``.</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">     If the error is due to an access error (read only file)</span>
<a href="#l7.78"></a><span id="l7.78">     it attempts to add write permission and then retries.</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     If the error is for another reason it re-raises the error.</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    Usage : ``shutil.rmtree(path, onerror=rmtree_onerror)``</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    Usage: ``shutil.rmtree(path, onerror=rmtree_onerror)``</span>
<a href="#l7.84"></a><span id="l7.84">     &quot;&quot;&quot;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    import stat</span>
<a href="#l7.86"></a><span id="l7.86">     if not os.access(path, os.W_OK):</span>
<a href="#l7.87"></a><span id="l7.87">         # Is the error an access error ?</span>
<a href="#l7.88"></a><span id="l7.88">         os.chmod(path, stat.S_IWUSR)</span>
<a href="#l7.89"></a><span id="l7.89">         func(path)</span>
<a href="#l7.90"></a><span id="l7.90">     else:</span>
<a href="#l7.91"></a><span id="l7.91">         raise</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+</span>
<a href="#l7.94"></a><span id="l7.94"> class ThunderTestProfile(mozprofile.ThunderbirdProfile):</span>
<a href="#l7.95"></a><span id="l7.95">     preferences = {</span>
<a href="#l7.96"></a><span id="l7.96">         # say yes to debug output via dump</span>
<a href="#l7.97"></a><span id="l7.97">         'browser.dom.window.dump.enabled': True,</span>
<a href="#l7.98"></a><span id="l7.98">         # say no to slow script warnings</span>
<a href="#l7.99"></a><span id="l7.99">         'dom.max_chrome_script_run_time': 0,</span>
<a href="#l7.100"></a><span id="l7.100">         'dom.max_script_run_time': 0,</span>
<a href="#l7.101"></a><span id="l7.101">         # disable extension stuffs</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-        'extensions.update.enabled'    : False,</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-        'extensions.update.notifyUser' : False,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+        'extensions.update.enabled': False,</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+        'extensions.update.notifyUser': False,</span>
<a href="#l7.106"></a><span id="l7.106">         # don't warn about third party extensions in profile or elsewhere.</span>
<a href="#l7.107"></a><span id="l7.107">         'extensions.autoDisableScopes': 10,</span>
<a href="#l7.108"></a><span id="l7.108">         # do not ask about being the default mail client</span>
<a href="#l7.109"></a><span id="l7.109">         'mail.shell.checkDefaultClient': False,</span>
<a href="#l7.110"></a><span id="l7.110">         # do not tell us about the greatness that is mozilla (about:rights)</span>
<a href="#l7.111"></a><span id="l7.111">         'mail.rights.override': True,</span>
<a href="#l7.112"></a><span id="l7.112">         # disable non-gloda indexing daemons</span>
<a href="#l7.113"></a><span id="l7.113">         'mail.winsearch.enable': False,</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineat">@@ -97,167 +91,170 @@ class ThunderTestProfile(mozprofile.Thun</span>
<a href="#l7.115"></a><span id="l7.115">         'mail.spotlight.enable': False,</span>
<a href="#l7.116"></a><span id="l7.116">         'mail.spotlight.firstRunDone': True,</span>
<a href="#l7.117"></a><span id="l7.117">         # disable address books for undisclosed reasons</span>
<a href="#l7.118"></a><span id="l7.118">         'ldap_2.servers.osx.position': 0,</span>
<a href="#l7.119"></a><span id="l7.119">         'ldap_2.servers.oe.position': 0,</span>
<a href="#l7.120"></a><span id="l7.120">         # disable the first use junk dialog</span>
<a href="#l7.121"></a><span id="l7.121">         'mailnews.ui.junk.firstuse': False,</span>
<a href="#l7.122"></a><span id="l7.122">         # set the relative dirs properly</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-        'mail.root.none-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-        'mail.root.pop3-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+        'mail.root.none-rel': &quot;[ProfD]Mail&quot;,</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+        'mail.root.pop3-rel': &quot;[ProfD]Mail&quot;,</span>
<a href="#l7.127"></a><span id="l7.127">         # Do not allow check new mail to be set</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-        'mail.startup.enabledMailCheckOnce' :  True,</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+        'mail.startup.enabledMailCheckOnce': True,</span>
<a href="#l7.130"></a><span id="l7.130">         # Disable compatibility checking</span>
<a href="#l7.131"></a><span id="l7.131">         'extensions.checkCompatibility.nightly': False,</span>
<a href="#l7.132"></a><span id="l7.132">         # Stop any pings to AMO on add-on install</span>
<a href="#l7.133"></a><span id="l7.133">         'extensions.getAddons.cache.enabled': False,</span>
<a href="#l7.134"></a><span id="l7.134">         # In case a developer is working on a laptop without a network</span>
<a href="#l7.135"></a><span id="l7.135">         # connection, don't detect offline mode; hence we'll still startup</span>
<a href="#l7.136"></a><span id="l7.136">         # online which is what mozmill currently requires. It'll also protect us</span>
<a href="#l7.137"></a><span id="l7.137">         # from any random network failures.</span>
<a href="#l7.138"></a><span id="l7.138">         'offline.autoDetect': False,</span>
<a href="#l7.139"></a><span id="l7.139">         # Don't load what's new or the remote start page - keep everything local</span>
<a href="#l7.140"></a><span id="l7.140">         # under our control.</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-        'mailnews.start_page_override.mstone' :  &quot;ignore&quot;,</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+        'mailnews.start_page_override.mstone': &quot;ignore&quot;,</span>
<a href="#l7.143"></a><span id="l7.143">         'mailnews.start_page.url': &quot;about:blank&quot;,</span>
<a href="#l7.144"></a><span id="l7.144">         # Do not enable gloda</span>
<a href="#l7.145"></a><span id="l7.145">         'mailnews.database.global.indexer.enabled': False,</span>
<a href="#l7.146"></a><span id="l7.146">         # But do have gloda log if it does anything.  (When disabled, queries</span>
<a href="#l7.147"></a><span id="l7.147">         # are still serviced; they just should not result in any matches.)</span>
<a href="#l7.148"></a><span id="l7.148">         'mailnews.database.global.logging.upstream': True,</span>
<a href="#l7.149"></a><span id="l7.149">         # Do not allow fonts to be upgraded</span>
<a href="#l7.150"></a><span id="l7.150">         'mail.font.windows.version': 2,</span>
<a href="#l7.151"></a><span id="l7.151">         # No, we don't want to be prompted about Telemetry</span>
<a href="#l7.152"></a><span id="l7.152">         'toolkit.telemetry.prompted': 999,</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-        }</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    }</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156">     menubar_preferences = {</span>
<a href="#l7.157"></a><span id="l7.157">         # Many tests operate items in the main menu, so keep it shown</span>
<a href="#l7.158"></a><span id="l7.158">         # until they are migrated to appmenu.</span>
<a href="#l7.159"></a><span id="l7.159">         'mail.main_menu.collapse_by_default': False,</span>
<a href="#l7.160"></a><span id="l7.160">     }</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">     # Dummied up local accounts to stop the account wizard</span>
<a href="#l7.163"></a><span id="l7.163">     account_preferences = {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-        'mail.account.account1.server' :  &quot;server1&quot;,</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-        'mail.account.account2.identities' :  &quot;id1,id2&quot;,</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-        'mail.account.account2.server' :  &quot;server2&quot;,</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-        'mail.account.account3.server' :  &quot;server3&quot;,</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-        'mail.accountmanager.accounts' :  &quot;account1,account2,account3&quot;,</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-        'mail.accountmanager.defaultaccount' :  &quot;account2&quot;,</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-        'mail.accountmanager.localfoldersserver' :  &quot;server1&quot;,</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-        'mail.identity.id1.fullName' :  &quot;Tinderbox&quot;,</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-        'mail.identity.id1.htmlSigFormat' : False,</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-        'mail.identity.id1.htmlSigText' : &quot;Tinderbox is soo 90ies&quot;,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-        'mail.identity.id1.smtpServer' :  &quot;smtp1&quot;,</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-        'mail.identity.id1.useremail' :  &quot;tinderbox@foo.invalid&quot;,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-        'mail.identity.id1.valid' :  True,</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-        'mail.identity.id2.fullName' : &quot;Tinderboxpushlog&quot;,</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-        'mail.identity.id2.htmlSigFormat' : True,</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-        'mail.identity.id2.htmlSigText' : &quot;Tinderboxpushlog is the new &lt;b&gt;hotness!&lt;/b&gt;&quot;,</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-        'mail.identity.id2.smtpServer' : &quot;smtp1&quot;,</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-        'mail.identity.id2.useremail' : &quot;tinderboxpushlog@foo.invalid&quot;,</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-        'mail.identity.id2.valid' : True,</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-        'mail.server.server1.directory-rel' :  &quot;[ProfD]Mail/Local Folders&quot;,</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-        'mail.server.server1.hostname' :  &quot;Local Folders&quot;,</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-        'mail.server.server1.name' :  &quot;Local Folders&quot;,</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-        'mail.server.server1.type' :  &quot;none&quot;,</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-        'mail.server.server1.userName' :  &quot;nobody&quot;,</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-        'mail.server.server2.check_new_mail' :  False,</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-        'mail.server.server2.directory-rel' :  &quot;[ProfD]Mail/tinderbox&quot;,</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-        'mail.server.server2.download_on_biff' :  True,</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-        'mail.server.server2.hostname' :  &quot;tinderbox123&quot;,</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-        'mail.server.server2.login_at_startup' :  False,</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-        'mail.server.server2.name' :  &quot;tinderbox@foo.invalid&quot;,</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-        'mail.server.server2.type' :  &quot;pop3&quot;,</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-        'mail.server.server2.userName' :  &quot;tinderbox&quot;,</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+        'mail.account.account1.server': &quot;server1&quot;,</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+        'mail.account.account2.identities': &quot;id1,id2&quot;,</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+        'mail.account.account2.server': &quot;server2&quot;,</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+        'mail.account.account3.server': &quot;server3&quot;,</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+        'mail.accountmanager.accounts': &quot;account1,account2,account3&quot;,</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+        'mail.accountmanager.defaultaccount': &quot;account2&quot;,</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+        'mail.accountmanager.localfoldersserver': &quot;server1&quot;,</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+        'mail.identity.id1.fullName': &quot;Tinderbox&quot;,</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+        'mail.identity.id1.htmlSigFormat': False,</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+        'mail.identity.id1.htmlSigText': &quot;Tinderbox is soo 90ies&quot;,</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+        'mail.identity.id1.smtpServer': &quot;smtp1&quot;,</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+        'mail.identity.id1.useremail': &quot;tinderbox@foo.invalid&quot;,</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+        'mail.identity.id1.valid': True,</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+        'mail.identity.id2.fullName': &quot;Tinderboxpushlog&quot;,</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+        'mail.identity.id2.htmlSigFormat': True,</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+        'mail.identity.id2.htmlSigText': &quot;Tinderboxpushlog is the new &lt;b&gt;hotness!&lt;/b&gt;&quot;,</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+        'mail.identity.id2.smtpServer': &quot;smtp1&quot;,</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+        'mail.identity.id2.useremail': &quot;tinderboxpushlog@foo.invalid&quot;,</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+        'mail.identity.id2.valid': True,</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+        'mail.server.server1.directory-rel': &quot;[ProfD]Mail/Local Folders&quot;,</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+        'mail.server.server1.hostname': &quot;Local Folders&quot;,</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+        'mail.server.server1.name': &quot;Local Folders&quot;,</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+        'mail.server.server1.type': &quot;none&quot;,</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+        'mail.server.server1.userName': &quot;nobody&quot;,</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+        'mail.server.server2.check_new_mail': False,</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+        'mail.server.server2.directory-rel': &quot;[ProfD]Mail/tinderbox&quot;,</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+        'mail.server.server2.download_on_biff': True,</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+        'mail.server.server2.hostname': &quot;tinderbox123&quot;,</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+        'mail.server.server2.login_at_startup': False,</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+        'mail.server.server2.name': &quot;tinderbox@foo.invalid&quot;,</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+        'mail.server.server2.type': &quot;pop3&quot;,</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+        'mail.server.server2.userName': &quot;tinderbox&quot;,</span>
<a href="#l7.228"></a><span id="l7.228">         'mail.server.server2.whiteListAbURI': &quot;&quot;,</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-        'mail.server.server3.hostname' :  &quot;prpl-irc&quot;,</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-        'mail.server.server3.imAccount' :  &quot;account1&quot;,</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-        'mail.server.server3.type' :  &quot;im&quot;,</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-        'mail.server.server3.userName' :  &quot;mozmilltest@irc.mozilla.invalid&quot;,</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-        'mail.smtp.defaultserver' :  &quot;smtp1&quot;,</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-        'mail.smtpserver.smtp1.hostname' :  &quot;tinderbox123&quot;,</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-        'mail.smtpserver.smtp1.username' :  &quot;tinderbox&quot;,</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-        'mail.smtpservers' :  &quot;smtp1&quot;,</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-        'messenger.account.account1.autoLogin' :  False,</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-        'messenger.account.account1.firstConnectionState' :  1,</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-        'messenger.account.account1.name' :  &quot;mozmilltest@irc.mozilla.invalid&quot;,</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-        'messenger.account.account1.prpl' :  &quot;prpl-irc&quot;,</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-        'messenger.accounts' :  &quot;account1&quot;,</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+        'mail.server.server3.hostname': &quot;prpl-irc&quot;,</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+        'mail.server.server3.imAccount': &quot;account1&quot;,</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+        'mail.server.server3.type': &quot;im&quot;,</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+        'mail.server.server3.userName': &quot;mozmilltest@irc.mozilla.invalid&quot;,</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+        'mail.smtp.defaultserver': &quot;smtp1&quot;,</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+        'mail.smtpserver.smtp1.hostname': &quot;tinderbox123&quot;,</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+        'mail.smtpserver.smtp1.username': &quot;tinderbox&quot;,</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+        'mail.smtpservers': &quot;smtp1&quot;,</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+        'messenger.account.account1.autoLogin': False,</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+        'messenger.account.account1.firstConnectionState': 1,</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+        'messenger.account.account1.name': &quot;mozmilltest@irc.mozilla.invalid&quot;,</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+        'messenger.account.account1.prpl': &quot;prpl-irc&quot;,</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+        'messenger.accounts': &quot;account1&quot;,</span>
<a href="#l7.255"></a><span id="l7.255">     }</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257">     def __init__(self, *args, **kwargs):</span>
<a href="#l7.258"></a><span id="l7.258">         kwargs['profile'] = self.get_profile_dir()</span>
<a href="#l7.259"></a><span id="l7.259">         super(ThunderTestProfile, self).__init__(*args, **kwargs)</span>
<a href="#l7.260"></a><span id="l7.260">         self.set_preferences(self.preferences)</span>
<a href="#l7.261"></a><span id="l7.261"> </span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-        if (wrapper is not None and hasattr(wrapper, &quot;DEFAULT_MENUBAR&quot;)</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-            and wrapper.DEFAULT_MENUBAR):</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+        if (wrapper is not None and</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+                hasattr(wrapper, &quot;DEFAULT_MENUBAR&quot;) and</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+                wrapper.DEFAULT_MENUBAR):</span>
<a href="#l7.267"></a><span id="l7.267">             pass</span>
<a href="#l7.268"></a><span id="l7.268">         else:</span>
<a href="#l7.269"></a><span id="l7.269">             self.set_preferences(self.menubar_preferences)</span>
<a href="#l7.270"></a><span id="l7.270"> </span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-        if (wrapper is not None and hasattr(wrapper, &quot;NO_ACCOUNTS&quot;)</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-            and wrapper.NO_ACCOUNTS):</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+        if (wrapper is not None and</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+                hasattr(wrapper, &quot;NO_ACCOUNTS&quot;) and</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+                wrapper.NO_ACCOUNTS):</span>
<a href="#l7.276"></a><span id="l7.276">             pass</span>
<a href="#l7.277"></a><span id="l7.277">         else:</span>
<a href="#l7.278"></a><span id="l7.278">             self.set_preferences(self.account_preferences)</span>
<a href="#l7.279"></a><span id="l7.279"> </span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-</span>
<a href="#l7.281"></a><span id="l7.281">     def get_profile_dir(self):</span>
<a href="#l7.282"></a><span id="l7.282">         '''</span>
<a href="#l7.283"></a><span id="l7.283">         We always put our profile in the same location.  We only clear it out</span>
<a href="#l7.284"></a><span id="l7.284">         when we are creating a new profile so that we can go in after the run</span>
<a href="#l7.285"></a><span id="l7.285">         and examine things for debugging or general interest.</span>
<a href="#l7.286"></a><span id="l7.286">         '''</span>
<a href="#l7.287"></a><span id="l7.287">         # create a clean directory</span>
<a href="#l7.288"></a><span id="l7.288">         if os.path.exists(PROFILE_DIR):</span>
<a href="#l7.289"></a><span id="l7.289">             shutil.rmtree(PROFILE_DIR, onerror=rmtree_onerror)</span>
<a href="#l7.290"></a><span id="l7.290">         os.makedirs(PROFILE_DIR)</span>
<a href="#l7.291"></a><span id="l7.291">         print 'Using profile dir:', PROFILE_DIR</span>
<a href="#l7.292"></a><span id="l7.292">         if not os.path.exists(PROFILE_DIR):</span>
<a href="#l7.293"></a><span id="l7.293">             raise Exception('somehow failed to create profile dir!')</span>
<a href="#l7.294"></a><span id="l7.294"> </span>
<a href="#l7.295"></a><span id="l7.295">         if PLUGINS_PATH:</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-          if not os.path.exists(PLUGINS_PATH):</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-            raise Exception('Plugins path &quot;%s&quot; does not exist.' % PLUGINS_PATH)</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+            if not os.path.exists(PLUGINS_PATH):</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+                raise Exception('Plugins path &quot;%s&quot; does not exist.' % PLUGINS_PATH)</span>
<a href="#l7.300"></a><span id="l7.300"> </span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-          dest = os.path.join(PROFILE_DIR, &quot;plugins&quot;)</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-          shutil.copytree(PLUGINS_PATH, dest)</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+            dest = os.path.join(PROFILE_DIR, &quot;plugins&quot;)</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+            shutil.copytree(PLUGINS_PATH, dest)</span>
<a href="#l7.305"></a><span id="l7.305"> </span>
<a href="#l7.306"></a><span id="l7.306">         if wrapper is not None and hasattr(wrapper, &quot;on_profile_created&quot;):</span>
<a href="#l7.307"></a><span id="l7.307">             # It's a little dangerous to allow on_profile_created access to the</span>
<a href="#l7.308"></a><span id="l7.308">             # profile object, because it isn't fully initialized yet</span>
<a href="#l7.309"></a><span id="l7.309">             wrapper.on_profile_created(PROFILE_DIR)</span>
<a href="#l7.310"></a><span id="l7.310"> </span>
<a href="#l7.311"></a><span id="l7.311">         return PROFILE_DIR</span>
<a href="#l7.312"></a><span id="l7.312"> </span>
<a href="#l7.313"></a><span id="l7.313">     def cleanup(self):</span>
<a href="#l7.314"></a><span id="l7.314">         '''</span>
<a href="#l7.315"></a><span id="l7.315">         Do not cleanup at all.  The next iteration will cleanup for us, but</span>
<a href="#l7.316"></a><span id="l7.316">         until that time it's useful for debugging failures to leave everything</span>
<a href="#l7.317"></a><span id="l7.317">         around.</span>
<a href="#l7.318"></a><span id="l7.318">         '''</span>
<a href="#l7.319"></a><span id="l7.319">         pass</span>
<a href="#l7.320"></a><span id="l7.320"> </span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+</span>
<a href="#l7.322"></a><span id="l7.322"> def ThunderTestRunner(*args, **kwargs):</span>
<a href="#l7.323"></a><span id="l7.323">     kwargs['env'] = env = dict(os.environ)</span>
<a href="#l7.324"></a><span id="l7.324">     # note, we do NOT want to set NO_EM_RESTART or jsbridge wouldn't work</span>
<a href="#l7.325"></a><span id="l7.325">     # avoid dialogs on windows</span>
<a href="#l7.326"></a><span id="l7.326">     if 'NO_EM_RESTART' in env:</span>
<a href="#l7.327"></a><span id="l7.327">         del env['NO_EM_RESTART']</span>
<a href="#l7.328"></a><span id="l7.328">     if 'XPCOM_DEBUG_BREAK' not in env:</span>
<a href="#l7.329"></a><span id="l7.329">         env['XPCOM_DEBUG_BREAK'] = 'stack'</span>
<a href="#l7.330"></a><span id="l7.330">     # do not reuse an existing instance</span>
<a href="#l7.331"></a><span id="l7.331">     env['MOZ_NO_REMOTE'] = '1'</span>
<a href="#l7.332"></a><span id="l7.332"> </span>
<a href="#l7.333"></a><span id="l7.333">     return mozrunner.ThunderbirdRunner(*args, **kwargs)</span>
<a href="#l7.334"></a><span id="l7.334"> </span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+</span>
<a href="#l7.336"></a><span id="l7.336"> class ThunderTestMozmill(mozmill.MozMill):</span>
<a href="#l7.337"></a><span id="l7.337">     VNC_SERVER_PATH = '/usr/bin/vncserver'</span>
<a href="#l7.338"></a><span id="l7.338">     VNC_PASSWD_PATH = '~/.vnc/passwd'</span>
<a href="#l7.339"></a><span id="l7.339"> </span>
<a href="#l7.340"></a><span id="l7.340">     def __init__(self, *args, **kwargs):</span>
<a href="#l7.341"></a><span id="l7.341">         # Only use the VNC server if the capability is available and a password</span>
<a href="#l7.342"></a><span id="l7.342">         # is already defined so this can run without prompting the user.</span>
<a href="#l7.343"></a><span id="l7.343">         self.use_vnc_server = (</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineat">@@ -270,26 +267,26 @@ class ThunderTestMozmill(mozmill.MozMill</span>
<a href="#l7.345"></a><span id="l7.345">         USE_RICH_FAILURES = (os.environ.get('MOZMILL_RICH_FAILURES') == '1')</span>
<a href="#l7.346"></a><span id="l7.346"> </span>
<a href="#l7.347"></a><span id="l7.347">         super(ThunderTestMozmill, self).__init__(*args, **kwargs)</span>
<a href="#l7.348"></a><span id="l7.348"> </span>
<a href="#l7.349"></a><span id="l7.349">     def start(self, profile=None, runner=None):</span>
<a href="#l7.350"></a><span id="l7.350">         if not profile:</span>
<a href="#l7.351"></a><span id="l7.351">             profile = self.profile_class(addons=[jsbridge.extension_path, extension_path])</span>
<a href="#l7.352"></a><span id="l7.352">         self.profile = profile</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-        </span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+</span>
<a href="#l7.355"></a><span id="l7.355">         if not runner:</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-            runner = self.runner_class(profile=self.profile, </span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+            runner = self.runner_class(profile=self.profile,</span>
<a href="#l7.358"></a><span id="l7.358">                                        cmdargs=[&quot;-jsbridge&quot;, str(self.jsbridge_port)])</span>
<a href="#l7.359"></a><span id="l7.359">         self.runner = runner</span>
<a href="#l7.360"></a><span id="l7.360"> </span>
<a href="#l7.361"></a><span id="l7.361">         if self.use_vnc_server:</span>
<a href="#l7.362"></a><span id="l7.362">             try:</span>
<a href="#l7.363"></a><span id="l7.363">                 subprocess.check_call([self.VNC_SERVER_PATH, ':99'])</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-            except subprocess.CalledProcessError, ex:</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+            except subprocess.CalledProcessError:</span>
<a href="#l7.366"></a><span id="l7.366">                 # Okay, so that display probably already exists.  We can either</span>
<a href="#l7.367"></a><span id="l7.367">                 # use it as-is or kill it.  I'm deciding we want to kill it</span>
<a href="#l7.368"></a><span id="l7.368">                 # since there might be other processes alive in there that</span>
<a href="#l7.369"></a><span id="l7.369">                 # want to make trouble for us.</span>
<a href="#l7.370"></a><span id="l7.370">                 subprocess.check_call([self.VNC_SERVER_PATH, '-kill', ':99'])</span>
<a href="#l7.371"></a><span id="l7.371">                 # Now let's try again.  if this didn't work, let's just let</span>
<a href="#l7.372"></a><span id="l7.372">                 # the exception kill us.</span>
<a href="#l7.373"></a><span id="l7.373">                 subprocess.check_call([self.VNC_SERVER_PATH, ':99'])</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineat">@@ -336,21 +333,23 @@ def monkeypatched_15_run_tests(self, tes</span>
<a href="#l7.375"></a><span id="l7.375">         frame.runTestFile(test)</span>
<a href="#l7.376"></a><span id="l7.376">     else:</span>
<a href="#l7.377"></a><span id="l7.377">         # run the test files</span>
<a href="#l7.378"></a><span id="l7.378">         for test_dir in self.test_dirs:</span>
<a href="#l7.379"></a><span id="l7.379">             frame.runTestDirectory(test_dir)</span>
<a href="#l7.380"></a><span id="l7.380"> </span>
<a href="#l7.381"></a><span id="l7.381">     # Give a second for any callbacks to finish.</span>
<a href="#l7.382"></a><span id="l7.382">     sleep(1)</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+</span>
<a href="#l7.384"></a><span id="l7.384"> if hasattr(mozmill.MozMill, 'find_tests'):</span>
<a href="#l7.385"></a><span id="l7.385">     # Monkey-patch run_tests</span>
<a href="#l7.386"></a><span id="l7.386">     mozmill.MozMill.old_run_tests = mozmill.MozMill.run_tests</span>
<a href="#l7.387"></a><span id="l7.387">     mozmill.MozMill.run_tests = monkeypatched_15_run_tests</span>
<a href="#l7.388"></a><span id="l7.388"> </span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+</span>
<a href="#l7.390"></a><span id="l7.390"> class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l7.391"></a><span id="l7.391">     mozmill_class = ThunderTestMozmill</span>
<a href="#l7.392"></a><span id="l7.392"> </span>
<a href="#l7.393"></a><span id="l7.393">     def add_options(self, parser):</span>
<a href="#l7.394"></a><span id="l7.394">         mozmill.CLI.add_options(self, parser)</span>
<a href="#l7.395"></a><span id="l7.395">         parser.add_option('--symbols-path', default=None, dest=&quot;symbols&quot;,</span>
<a href="#l7.396"></a><span id="l7.396">                           help=&quot;The path to the symbol files from build_symbols&quot;)</span>
<a href="#l7.397"></a><span id="l7.397">         parser.add_option('--plugins-path', default=None, dest=&quot;plugins&quot;,</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineat">@@ -387,17 +386,17 @@ class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l7.399"></a><span id="l7.399">             test_paths = self.options.test</span>
<a href="#l7.400"></a><span id="l7.400">         TEST_NAME = ', '.join([os.path.basename(t) for t in test_paths])</span>
<a href="#l7.401"></a><span id="l7.401"> </span>
<a href="#l7.402"></a><span id="l7.402">         test_dirs = self.test_dirs = []</span>
<a href="#l7.403"></a><span id="l7.403">         for test_file in test_paths:</span>
<a href="#l7.404"></a><span id="l7.404">             test_file = os.path.abspath(test_file)</span>
<a href="#l7.405"></a><span id="l7.405">             if not os.path.isdir(test_file):</span>
<a href="#l7.406"></a><span id="l7.406">                 test_file = os.path.dirname(test_file)</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-            if not test_file in test_dirs:</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+            if test_file not in test_dirs:</span>
<a href="#l7.409"></a><span id="l7.409">                 test_dirs.append(test_file)</span>
<a href="#l7.410"></a><span id="l7.410"> </span>
<a href="#l7.411"></a><span id="l7.411">         # if we are monkeypatching, give it the test directories.</span>
<a href="#l7.412"></a><span id="l7.412">         if hasattr(self.mozmill, 'find_tests'):</span>
<a href="#l7.413"></a><span id="l7.413">             self.mozmill.test_dirs = test_dirs</span>
<a href="#l7.414"></a><span id="l7.414"> </span>
<a href="#l7.415"></a><span id="l7.415">         self._load_wrapper()</span>
<a href="#l7.416"></a><span id="l7.416"> </span>
<a href="#l7.417"></a><span id="l7.417" class="difflineat">@@ -419,16 +418,18 @@ class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l7.418"></a><span id="l7.418">             try:</span>
<a href="#l7.419"></a><span id="l7.419">                 wrapper = imp.load_module(WRAPPER_MODULE_NAME, fd, path, desc)</span>
<a href="#l7.420"></a><span id="l7.420">             finally:</span>
<a href="#l7.421"></a><span id="l7.421">                 if fd is not None:</span>
<a href="#l7.422"></a><span id="l7.422">                     fd.close()</span>
<a href="#l7.423"></a><span id="l7.423"> </span>
<a href="#l7.424"></a><span id="l7.424"> </span>
<a href="#l7.425"></a><span id="l7.425"> TEST_RESULTS = []</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+</span>
<a href="#l7.428"></a><span id="l7.428"> # Versions of MozMill prior to 1.5 did not output test-pass /</span>
<a href="#l7.429"></a><span id="l7.429"> # TEST-UNEXPECTED-FAIL. Since 1.5 happened this gets output, so we only want</span>
<a href="#l7.430"></a><span id="l7.430"> # a summary at the end to make it easy for developers.</span>
<a href="#l7.431"></a><span id="l7.431"> def logEndTest(obj):</span>
<a href="#l7.432"></a><span id="l7.432">     # If we've got a string here, we know we're later than 1.5, and we can just</span>
<a href="#l7.433"></a><span id="l7.433">     # display a summary at the end as 1.5 will do TEST-UNEXPECTED-FAIL for us.</span>
<a href="#l7.434"></a><span id="l7.434">     if isinstance(obj, str):</span>
<a href="#l7.435"></a><span id="l7.435">         obj = json.loads(obj)</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineat">@@ -436,16 +437,18 @@ def logEndTest(obj):</span>
<a href="#l7.437"></a><span id="l7.437">     TEST_RESULTS.append(obj)</span>
<a href="#l7.438"></a><span id="l7.438"> mozmill.LoggerListener.cases['mozmill.endTest'] = logEndTest</span>
<a href="#l7.439"></a><span id="l7.439"> </span>
<a href="#l7.440"></a><span id="l7.440"> # We now send extended meta-data about failures.  We do not want the entire</span>
<a href="#l7.441"></a><span id="l7.441"> # message dumped with this extra data, so clobber the default mozmill.fail</span>
<a href="#l7.442"></a><span id="l7.442"> # with one that wraps it and only tells it the exception message rather than</span>
<a href="#l7.443"></a><span id="l7.443"> # the whole JSON blob.</span>
<a href="#l7.444"></a><span id="l7.444"> ORIGINAL_FAILURE_LOGGER = mozmill.LoggerListener.cases['mozmill.fail']</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+</span>
<a href="#l7.447"></a><span id="l7.447"> def logFailure(obj):</span>
<a href="#l7.448"></a><span id="l7.448">     if isinstance(obj, basestring):</span>
<a href="#l7.449"></a><span id="l7.449">         obj = json.loads(obj)</span>
<a href="#l7.450"></a><span id="l7.450">     if 'exception' in obj:</span>
<a href="#l7.451"></a><span id="l7.451">         objex = obj['exception']</span>
<a href="#l7.452"></a><span id="l7.452">         if 'message' in objex:</span>
<a href="#l7.453"></a><span id="l7.453">             report_as = objex['message']</span>
<a href="#l7.454"></a><span id="l7.454">         else:</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineat">@@ -455,102 +458,102 @@ def logFailure(obj):</span>
<a href="#l7.456"></a><span id="l7.456">     ORIGINAL_FAILURE_LOGGER(report_as)</span>
<a href="#l7.457"></a><span id="l7.457"> mozmill.LoggerListener.cases['mozmill.fail'] = logFailure</span>
<a href="#l7.458"></a><span id="l7.458"> </span>
<a href="#l7.459"></a><span id="l7.459"> </span>
<a href="#l7.460"></a><span id="l7.460"> def prettifyFilename(path, tail_segs_desired=1):</span>
<a href="#l7.461"></a><span id="l7.461">     parts = path.split('/')</span>
<a href="#l7.462"></a><span id="l7.462">     return '/'.join(parts[-tail_segs_desired:])</span>
<a href="#l7.463"></a><span id="l7.463"> </span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+</span>
<a href="#l7.465"></a><span id="l7.465"> def prettyPrintException(e):</span>
<a href="#l7.466"></a><span id="l7.466">     print '  EXCEPTION:', e.get('message', 'no message!').encode('utf-8')</span>
<a href="#l7.467"></a><span id="l7.467">     print '    at:', prettifyFilename(e.get('fileName', 'nonesuch')), 'line', e.get('lineNumber', 0)</span>
<a href="#l7.468"></a><span id="l7.468">     if 'stack' in e:</span>
<a href="#l7.469"></a><span id="l7.469">         for line in e['stack'].splitlines():</span>
<a href="#l7.470"></a><span id="l7.470">             if not line:</span>
<a href="#l7.471"></a><span id="l7.471">                 continue</span>
<a href="#l7.472"></a><span id="l7.472">             if line[0] == &quot;(&quot;:</span>
<a href="#l7.473"></a><span id="l7.473">                 funcname = None</span>
<a href="#l7.474"></a><span id="l7.474">             elif line[0] == &quot;@&quot;:</span>
<a href="#l7.475"></a><span id="l7.475">                 # this is probably the root, don't care</span>
<a href="#l7.476"></a><span id="l7.476">                 continue</span>
<a href="#l7.477"></a><span id="l7.477">             else:</span>
<a href="#l7.478"></a><span id="l7.478">                 funcname = line[:line.find('@')]</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-            pathAndLine = line[line.rfind('@')+1:]</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+            pathAndLine = line[line.rfind('@') + 1:]</span>
<a href="#l7.481"></a><span id="l7.481">             rcolon = pathAndLine.rfind(':')</span>
<a href="#l7.482"></a><span id="l7.482">             if rcolon != -1:</span>
<a href="#l7.483"></a><span id="l7.483">                 path = pathAndLine[:rcolon]</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineminus">-                line = pathAndLine[rcolon+1:]</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+                line = pathAndLine[rcolon + 1:]</span>
<a href="#l7.486"></a><span id="l7.486">             else:</span>
<a href="#l7.487"></a><span id="l7.487">                 path = pathAndLine</span>
<a href="#l7.488"></a><span id="l7.488">                 line = 0</span>
<a href="#l7.489"></a><span id="l7.489">             if funcname:</span>
<a href="#l7.490"></a><span id="l7.490">                 print '      ', funcname, prettifyFilename(path), line</span>
<a href="#l7.491"></a><span id="l7.491">             else:</span>
<a href="#l7.492"></a><span id="l7.492">                 print '           ', prettifyFilename(path), line</span>
<a href="#l7.493"></a><span id="l7.493"> </span>
<a href="#l7.494"></a><span id="l7.494"> </span>
<a href="#l7.495"></a><span id="l7.495"> # Tests that are useless and shouldn't be printed if successful</span>
<a href="#l7.496"></a><span id="l7.496"> TEST_BLACKLIST = [&quot;setupModule&quot;, &quot;setupTest&quot;, &quot;teardownTest&quot;, &quot;teardownModule&quot;]</span>
<a href="#l7.497"></a><span id="l7.497"> </span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-import pprint, atexit</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+</span>
<a href="#l7.500"></a><span id="l7.500"> @atexit.register</span>
<a href="#l7.501"></a><span id="l7.501"> def prettyPrintResults():</span>
<a href="#l7.502"></a><span id="l7.502">     for result in TEST_RESULTS:</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-        #pprint.pprint(result)</span>
<a href="#l7.504"></a><span id="l7.504">         testOrSummary = 'TEST'</span>
<a href="#l7.505"></a><span id="l7.505">         if 'summary' in result:</span>
<a href="#l7.506"></a><span id="l7.506">             testOrSummary = 'SUMMARY'</span>
<a href="#l7.507"></a><span id="l7.507">         if len(result['fails']) == 0:</span>
<a href="#l7.508"></a><span id="l7.508">             if result.get('skipped', False):</span>
<a href="#l7.509"></a><span id="l7.509">                 kind = 'SKIP'</span>
<a href="#l7.510"></a><span id="l7.510">             else:</span>
<a href="#l7.511"></a><span id="l7.511">                 kind = 'PASS'</span>
<a href="#l7.512"></a><span id="l7.512">             if result['name'] not in TEST_BLACKLIST:</span>
<a href="#l7.513"></a><span id="l7.513">                 print '%s-%s | %s' % (testOrSummary, kind, result['name'])</span>
<a href="#l7.514"></a><span id="l7.514">         else:</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-            print '%s-UNEXPECTED-FAIL | %s | %s' % (testOrSummary, prettifyFilename(result['filename']), result['name'])</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+            print '%s-UNEXPECTED-FAIL | %s | %s' % \</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+                (testOrSummary, prettifyFilename(result['filename']), result['name'])</span>
<a href="#l7.518"></a><span id="l7.518">         for failure in result['fails']:</span>
<a href="#l7.519"></a><span id="l7.519">             if 'exception' in failure:</span>
<a href="#l7.520"></a><span id="l7.520">                 prettyPrintException(failure['exception'])</span>
<a href="#l7.521"></a><span id="l7.521"> </span>
<a href="#l7.522"></a><span id="l7.522" class="difflineplus">+</span>
<a href="#l7.523"></a><span id="l7.523"> @atexit.register</span>
<a href="#l7.524"></a><span id="l7.524"> def dumpRichResults():</span>
<a href="#l7.525"></a><span id="l7.525">     if USE_RICH_FAILURES:</span>
<a href="#l7.526"></a><span id="l7.526">         print '##### MOZMILL-RICH-FAILURES-BEGIN #####'</span>
<a href="#l7.527"></a><span id="l7.527">         for result in TEST_RESULTS:</span>
<a href="#l7.528"></a><span id="l7.528">             if len(result['fails']) &gt; 0:</span>
<a href="#l7.529"></a><span id="l7.529">                 for failure in result['fails']:</span>
<a href="#l7.530"></a><span id="l7.530">                     failure['fileName'] = prettifyFilename(result['filename'], 2)</span>
<a href="#l7.531"></a><span id="l7.531">                     failure['testName'] = result['name']</span>
<a href="#l7.532"></a><span id="l7.532">                     print json.dumps(failure)</span>
<a href="#l7.533"></a><span id="l7.533">         print '##### MOZMILL-RICH-FAILURES-END #####'</span>
<a href="#l7.534"></a><span id="l7.534"> </span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+</span>
<a href="#l7.536"></a><span id="l7.536"> @atexit.register</span>
<a href="#l7.537"></a><span id="l7.537"> def uploadScreenshots():</span>
<a href="#l7.538"></a><span id="l7.538">     if not UPLOAD_SCREENSHOTS:</span>
<a href="#l7.539"></a><span id="l7.539">         return</span>
<a href="#l7.540"></a><span id="l7.540"> </span>
<a href="#l7.541"></a><span id="l7.541">     parent_dir = os.environ.get('MOZ_UPLOAD_DIR', None)</span>
<a href="#l7.542"></a><span id="l7.542">     if not parent_dir:</span>
<a href="#l7.543"></a><span id="l7.543">         return</span>
<a href="#l7.544"></a><span id="l7.544"> </span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-    from base64 import b64decode</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-    from os import fdopen</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-    from tempfile import mkstemp</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-</span>
<a href="#l7.549"></a><span id="l7.549">     for result in TEST_RESULTS:</span>
<a href="#l7.550"></a><span id="l7.550">         for failure in result['fails']:</span>
<a href="#l7.551"></a><span id="l7.551">             for win in failure['failureContext']['windows']['windows']:</span>
<a href="#l7.552"></a><span id="l7.552">                 prefix = result['name'].replace(':', '_')</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-                fp, path = mkstemp(prefix=prefix + '-', suffix='.png', dir=parent_dir)</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-                with fdopen(fp, 'wb') as shot:</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+                fp, path = tempfile.mkstemp(prefix=prefix + '-', suffix='.png', dir=parent_dir)</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+                with os.fdopen(fp, 'wb') as shot:</span>
<a href="#l7.557"></a><span id="l7.557">                     shot.write(b64decode(win['screenshotDataUrl'][len('data:image/png;base64,'):]))</span>
<a href="#l7.558"></a><span id="l7.558">                 print 'Wrote screenshot to', path</span>
<a href="#l7.559"></a><span id="l7.559"> </span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+</span>
<a href="#l7.561"></a><span id="l7.561"> def checkCrashesAtExit():</span>
<a href="#l7.562"></a><span id="l7.562">     if mozcrash.check_for_crashes(dump_directory=os.path.join(PROFILE_DIR, 'minidumps'),</span>
<a href="#l7.563"></a><span id="l7.563">                                   symbols_path=SYMBOLS_PATH,</span>
<a href="#l7.564"></a><span id="l7.564">                                   test_name=TEST_NAME):</span>
<a href="#l7.565"></a><span id="l7.565">         print &gt;&gt; sys.stderr, 'TinderboxPrint: ' + TEST_NAME + '&lt;br/&gt;&lt;em class=&quot;testfail&quot;&gt;CRASH&lt;/em&gt;'</span>
<a href="#l7.566"></a><span id="l7.566">         sys.exit(1)</span>
<a href="#l7.567"></a><span id="l7.567"> </span>
<a href="#l7.568"></a><span id="l7.568"> if __name__ == '__main__':</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/runtestlist.py</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/runtestlist.py</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -7,61 +7,62 @@ import glob</span>
<a href="#l8.4"></a><span id="l8.4"> import optparse</span>
<a href="#l8.5"></a><span id="l8.5"> import sys</span>
<a href="#l8.6"></a><span id="l8.6"> import os</span>
<a href="#l8.7"></a><span id="l8.7"> import subprocess</span>
<a href="#l8.8"></a><span id="l8.8"> import logging</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> SCRIPT_DIRECTORY = os.path.abspath(os.path.realpath(os.path.dirname(sys.argv[0])))</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13"> class RunTestListOptions(optparse.OptionParser):</span>
<a href="#l8.14"></a><span id="l8.14">     &quot;&quot;&quot;Parsed run test list command line options.&quot;&quot;&quot;</span>
<a href="#l8.15"></a><span id="l8.15">     def __init__(self, **kwargs):</span>
<a href="#l8.16"></a><span id="l8.16">         optparse.OptionParser.__init__(self, **kwargs)</span>
<a href="#l8.17"></a><span id="l8.17">         defaults = {}</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">         self.add_option(&quot;--binary&quot;,</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;string&quot;, dest = &quot;binary&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-                        help = &quot;Binary to be run&quot;)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;string&quot;, dest=&quot;binary&quot;,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+                        help=&quot;Binary to be run&quot;)</span>
<a href="#l8.24"></a><span id="l8.24">         defaults[&quot;binary&quot;] = &quot;&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">         self.add_option(&quot;--list&quot;,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;string&quot;, dest = &quot;list&quot;,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-                        help = &quot;List of tests to be run&quot;)</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;string&quot;, dest=&quot;list&quot;,</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+                        help=&quot;List of tests to be run&quot;)</span>
<a href="#l8.31"></a><span id="l8.31">         defaults[&quot;list&quot;] = &quot;&quot;</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33">         self.add_option(&quot;--dir&quot;,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;string&quot;, dest = &quot;dir&quot;,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-                        help = &quot;Directory of the tests, leave blank for current directory&quot;)</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;string&quot;, dest=&quot;dir&quot;,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                        help=&quot;Directory of the tests, leave blank for current directory&quot;)</span>
<a href="#l8.38"></a><span id="l8.38">         defaults[&quot;dir&quot;] = &quot;&quot;</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">         self.add_option(&quot;--symbols-path&quot;,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;string&quot;, dest = &quot;symbols&quot;,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-                        help = &quot;The path to the symbol files from build_symbols&quot;)</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;string&quot;, dest=&quot;symbols&quot;,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+                        help=&quot;The path to the symbol files from build_symbols&quot;)</span>
<a href="#l8.45"></a><span id="l8.45">         defaults[&quot;symbols&quot;] = &quot;&quot;</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">         self.add_option(&quot;--total-chunks&quot;,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;int&quot;, dest = &quot;total_chunks&quot;,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;int&quot;, dest=&quot;total_chunks&quot;,</span>
<a href="#l8.50"></a><span id="l8.50">                         help=&quot;how many chunks to split the tests up into&quot;)</span>
<a href="#l8.51"></a><span id="l8.51">         defaults[&quot;total_chunks&quot;] = 1</span>
<a href="#l8.52"></a><span id="l8.52">         self.add_option(&quot;--this-chunk&quot;,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;int&quot;, dest = &quot;this_chunk&quot;,</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;int&quot;, dest=&quot;this_chunk&quot;,</span>
<a href="#l8.55"></a><span id="l8.55">                         help=&quot;which chunk to run between 1 and --total-chunks&quot;)</span>
<a href="#l8.56"></a><span id="l8.56">         defaults[&quot;this_chunk&quot;] = 1</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">         self.add_option(&quot;--plugins-path&quot;,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-                        action = &quot;store&quot;, type = &quot;string&quot;, dest = &quot;plugins&quot;,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-                        help = &quot;The path to the plugins folder for the test profiles&quot;)</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+                        action=&quot;store&quot;, type=&quot;string&quot;, dest=&quot;plugins&quot;,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+                        help=&quot;The path to the plugins folder for the test profiles&quot;)</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">         self.add_option(&quot;--testing-modules-dir&quot;,</span>
<a href="#l8.65"></a><span id="l8.65">                         action=&quot;store&quot;, type=&quot;string&quot;, dest=&quot;testingmodules&quot;,</span>
<a href="#l8.66"></a><span id="l8.66">                         help=&quot;The path to the testing modules directory&quot;)</span>
<a href="#l8.67"></a><span id="l8.67">         defaults[&quot;testingmodules&quot;] = &quot;&quot;</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-        self.set_defaults(**defaults);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+        self.set_defaults(**defaults)</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">         usage = &quot;&quot;&quot;\</span>
<a href="#l8.73"></a><span id="l8.73"> Usage instructions for runtestlist.py</span>
<a href="#l8.74"></a><span id="l8.74"> &quot;&quot;&quot;</span>
<a href="#l8.75"></a><span id="l8.75">         self.set_usage(usage)</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77"> log = logging.getLogger()</span>
<a href="#l8.78"></a><span id="l8.78"> handler = logging.StreamHandler(sys.stdout)</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineat">@@ -121,17 +122,17 @@ for directory in tests:</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">     if options.testingmodules:</span>
<a href="#l8.82"></a><span id="l8.82">         args.append(&quot;--testing-modules-dir&quot;)</span>
<a href="#l8.83"></a><span id="l8.83">         args.append(os.path.abspath(options.testingmodules))</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85">     print args</span>
<a href="#l8.86"></a><span id="l8.86">     outputPipe = subprocess.PIPE</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    proc = subprocess.Popen(args, cwd=SCRIPT_DIRECTORY, stdout = subprocess.PIPE, stderr = subprocess.STDOUT)</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    proc = subprocess.Popen(args, cwd=SCRIPT_DIRECTORY, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91">     testErrors = 0</span>
<a href="#l8.92"></a><span id="l8.92">     testPasses = 0</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">     line = proc.stdout.readline()</span>
<a href="#l8.95"></a><span id="l8.95">     while line != &quot;&quot;:</span>
<a href="#l8.96"></a><span id="l8.96">         log.info(line.rstrip())</span>
<a href="#l8.97"></a><span id="l8.97">         if line.find(&quot;TEST-UNEXPECTED-&quot;) != -1:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/startup-firstrun/wrapper.py</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/startup-firstrun/wrapper.py</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3,23 +3,23 @@</span>
<a href="#l9.4"></a><span id="l9.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> # For these tests, we need to disable the account provisioner, or</span>
<a href="#l9.7"></a><span id="l9.7"> # else it will spawn immediately and block before we have a chance to run</span>
<a href="#l9.8"></a><span id="l9.8"> # any Mozmill tests.</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> import os</span>
<a href="#l9.11"></a><span id="l9.11"> import shutil</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-import sys</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> # We don't want any accounts for these tests.</span>
<a href="#l9.15"></a><span id="l9.15"> NO_ACCOUNTS = True</span>
<a href="#l9.16"></a><span id="l9.16"> # Do not force enable main menu bar (keep the default).</span>
<a href="#l9.17"></a><span id="l9.17"> DEFAULT_MENUBAR = True</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20"> def on_profile_created(profiledir):</span>
<a href="#l9.21"></a><span id="l9.21">     &quot;&quot;&quot;</span>
<a href="#l9.22"></a><span id="l9.22">     On profile creation, this copies *-prefs.js from the current folder to</span>
<a href="#l9.23"></a><span id="l9.23">     profile_dir as a user.js file. These user prefs is interpreted in addition</span>
<a href="#l9.24"></a><span id="l9.24">     to the standard prefs.js file.</span>
<a href="#l9.25"></a><span id="l9.25">     &quot;&quot;&quot;</span>
<a href="#l9.26"></a><span id="l9.26">     # The pref file is in the same directory this script is in</span>
<a href="#l9.27"></a><span id="l9.27">     preffile = os.path.join(os.path.dirname(__file__), &quot;prefs.js&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/resources/installmozmill.py</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/resources/installmozmill.py</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -9,18 +9,18 @@ install mozmill and its dependencies</span>
<a href="#l10.4"></a><span id="l10.4"> &quot;&quot;&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> import os</span>
<a href="#l10.7"></a><span id="l10.7"> import sys</span>
<a href="#l10.8"></a><span id="l10.8"> from subprocess import call</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> import buildconfig</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+# utility functions for cross-platform</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-# utility functions for cross-platform</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> def is_windows():</span>
<a href="#l10.17"></a><span id="l10.17">     return sys.platform.startswith('win')</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20"> def esc(path):</span>
<a href="#l10.21"></a><span id="l10.21">     &quot;&quot;&quot;quote and escape a path for cross-platform use&quot;&quot;&quot;</span>
<a href="#l10.22"></a><span id="l10.22">     return '&quot;%s&quot;' % repr(path)[1:-1]</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -44,17 +44,16 @@ def python_script_path(virtual_env, scri</span>
<a href="#l10.24"></a><span id="l10.24"> def entry_point_path(virtual_env, entry_point):</span>
<a href="#l10.25"></a><span id="l10.25">     path = os.path.join(scripts_path(virtual_env), entry_point)</span>
<a href="#l10.26"></a><span id="l10.26">     if is_windows():</span>
<a href="#l10.27"></a><span id="l10.27">         path += '.exe'</span>
<a href="#l10.28"></a><span id="l10.28">     return path</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31"> # command-line entry point</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-</span>
<a href="#l10.33"></a><span id="l10.33"> def main(args=None):</span>
<a href="#l10.34"></a><span id="l10.34">     &quot;&quot;&quot;command line front-end function&quot;&quot;&quot;</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">     # parse command line arguments</span>
<a href="#l10.37"></a><span id="l10.37">     args = args or sys.argv[1:]</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">     # Print the python version</span>
<a href="#l10.40"></a><span id="l10.40">     print 'Python: %s' % sys.version</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/__init__.py</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/__init__.py</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,179 +1,184 @@</span>
<a href="#l11.4"></a><span id="l11.4"> # ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.5"></a><span id="l11.5"> # Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-# </span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+#</span>
<a href="#l11.8"></a><span id="l11.8"> # The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.9"></a><span id="l11.9"> # 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.10"></a><span id="l11.10"> # the License. You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11"> # http://www.mozilla.org/MPL/</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-# </span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#</span>
<a href="#l11.14"></a><span id="l11.14"> # Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.15"></a><span id="l11.15"> # WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.16"></a><span id="l11.16"> # for the specific language governing rights and limitations under the</span>
<a href="#l11.17"></a><span id="l11.17"> # License.</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-# </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+#</span>
<a href="#l11.20"></a><span id="l11.20"> # The Original Code is Mozilla Corporation Code.</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-# </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+#</span>
<a href="#l11.23"></a><span id="l11.23"> # The Initial Developer of the Original Code is</span>
<a href="#l11.24"></a><span id="l11.24"> # Mikeal Rogers.</span>
<a href="#l11.25"></a><span id="l11.25"> # Portions created by the Initial Developer are Copyright (C) 2008 -2009</span>
<a href="#l11.26"></a><span id="l11.26"> # the Initial Developer. All Rights Reserved.</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-# </span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+#</span>
<a href="#l11.29"></a><span id="l11.29"> # Contributor(s):</span>
<a href="#l11.30"></a><span id="l11.30"> #  Mikeal Rogers &lt;mikeal.rogers@gmail.com&gt;</span>
<a href="#l11.31"></a><span id="l11.31"> #  Henrik Skupin &lt;hskupin@mozilla.com&gt;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-# </span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+#</span>
<a href="#l11.34"></a><span id="l11.34"> # Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.35"></a><span id="l11.35"> # either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.36"></a><span id="l11.36"> # the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.37"></a><span id="l11.37"> # in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.38"></a><span id="l11.38"> # of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.39"></a><span id="l11.39"> # under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.40"></a><span id="l11.40"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.41"></a><span id="l11.41"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.42"></a><span id="l11.42"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.43"></a><span id="l11.43"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.44"></a><span id="l11.44"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-# </span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+#</span>
<a href="#l11.47"></a><span id="l11.47"> # ***** END LICENSE BLOCK *****</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49"> import socket</span>
<a href="#l11.50"></a><span id="l11.50"> import os</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-import copy</span>
<a href="#l11.52"></a><span id="l11.52"> import asyncore</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54"> from time import sleep</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-from network import Bridge, BackChannel, create_network</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+from network import create_network</span>
<a href="#l11.57"></a><span id="l11.57"> from jsobjects import JSObject</span>
<a href="#l11.58"></a><span id="l11.58"> </span>
<a href="#l11.59"></a><span id="l11.59"> import mozrunner</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61"> settings_env = 'JSBRIDGE_SETTINGS_FILE'</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63"> parent = os.path.abspath(os.path.dirname(__file__))</span>
<a href="#l11.64"></a><span id="l11.64"> extension_path = os.path.join(parent, 'extension')</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66"> window_string = &quot;Cc['@mozilla.org/appshell/window-mediator;1'].getService(Ci.nsIWindowMediator).getMostRecentWindow('')&quot;</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68"> wait_to_create_timeout = 60</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+</span>
<a href="#l11.71"></a><span id="l11.71"> def wait_and_create_network(host, port, timeout=wait_to_create_timeout):</span>
<a href="#l11.72"></a><span id="l11.72">     ttl = 0</span>
<a href="#l11.73"></a><span id="l11.73">     while ttl &lt; timeout:</span>
<a href="#l11.74"></a><span id="l11.74">         try:</span>
<a href="#l11.75"></a><span id="l11.75">             s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<a href="#l11.76"></a><span id="l11.76">             s.connect((host, port))</span>
<a href="#l11.77"></a><span id="l11.77">             s.close()</span>
<a href="#l11.78"></a><span id="l11.78">             break</span>
<a href="#l11.79"></a><span id="l11.79">         except socket.error:</span>
<a href="#l11.80"></a><span id="l11.80">             pass</span>
<a href="#l11.81"></a><span id="l11.81">         sleep(.25)</span>
<a href="#l11.82"></a><span id="l11.82">         ttl += .25</span>
<a href="#l11.83"></a><span id="l11.83">     if ttl == timeout:</span>
<a href="#l11.84"></a><span id="l11.84">         raise Exception(&quot;Sorry, cannot connect to jsbridge extension, port %s&quot; % port)</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    </span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+</span>
<a href="#l11.87"></a><span id="l11.87">     back_channel, bridge = create_network(host, port)</span>
<a href="#l11.88"></a><span id="l11.88">     sleep(.5)</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-    </span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+</span>
<a href="#l11.91"></a><span id="l11.91">     while back_channel.registered is False:</span>
<a href="#l11.92"></a><span id="l11.92">         back_channel.close()</span>
<a href="#l11.93"></a><span id="l11.93">         bridge.close()</span>
<a href="#l11.94"></a><span id="l11.94">         asyncore.socket_map = {}</span>
<a href="#l11.95"></a><span id="l11.95">         sleep(1)</span>
<a href="#l11.96"></a><span id="l11.96">         back_channel, bridge = create_network(host, port)</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-    </span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+</span>
<a href="#l11.99"></a><span id="l11.99">     return back_channel, bridge</span>
<a href="#l11.100"></a><span id="l11.100"> </span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+</span>
<a href="#l11.102"></a><span id="l11.102"> class CLI(mozrunner.CLI):</span>
<a href="#l11.103"></a><span id="l11.103">     &quot;&quot;&quot;Command line interface.&quot;&quot;&quot;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    </span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+</span>
<a href="#l11.106"></a><span id="l11.106">     module = &quot;jsbridge&quot;</span>
<a href="#l11.107"></a><span id="l11.107"> </span>
<a href="#l11.108"></a><span id="l11.108">     def add_options(self, parser):</span>
<a href="#l11.109"></a><span id="l11.109">         &quot;&quot;&quot;add options to parser&quot;&quot;&quot;</span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111">         mozrunner.CLI.add_options(self, parser)</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-        parser.add_option('-D', '--debug', dest=&quot;debug&quot;, </span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+        parser.add_option('-D', '--debug', dest=&quot;debug&quot;,</span>
<a href="#l11.114"></a><span id="l11.114">                           action=&quot;store_true&quot;,</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-                          help=&quot;Debug mode&quot;, </span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+                          help=&quot;Debug mode&quot;,</span>
<a href="#l11.117"></a><span id="l11.117">                           metavar=&quot;JSBRIDGE_DEBUG&quot;,</span>
<a href="#l11.118"></a><span id="l11.118">                           default=False)</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-        parser.add_option('-s', '--shell', dest=&quot;shell&quot;, </span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+        parser.add_option('-s', '--shell', dest=&quot;shell&quot;,</span>
<a href="#l11.121"></a><span id="l11.121">                           action=&quot;store_true&quot;,</span>
<a href="#l11.122"></a><span id="l11.122">                           help=&quot;Start a Python shell&quot;,</span>
<a href="#l11.123"></a><span id="l11.123">                           metavar=&quot;JSBRIDGE_SHELL&quot;,</span>
<a href="#l11.124"></a><span id="l11.124">                           default=False)</span>
<a href="#l11.125"></a><span id="l11.125">         parser.add_option('-u', '--usecode', dest=&quot;usecode&quot;,</span>
<a href="#l11.126"></a><span id="l11.126">                           action=&quot;store_true&quot;,</span>
<a href="#l11.127"></a><span id="l11.127">                           help=&quot;Use code module instead of iPython&quot;,</span>
<a href="#l11.128"></a><span id="l11.128">                           default=False)</span>
<a href="#l11.129"></a><span id="l11.129">         parser.add_option('-P', '--port', dest=&quot;port&quot;, default=&quot;24242&quot;,</span>
<a href="#l11.130"></a><span id="l11.130">                           help=&quot;TCP port to run jsbridge on.&quot;)</span>
<a href="#l11.131"></a><span id="l11.131"> </span>
<a href="#l11.132"></a><span id="l11.132">     def profile_args(self):</span>
<a href="#l11.133"></a><span id="l11.133">         profargs = super(CLI, self).profile_args()</span>
<a href="#l11.134"></a><span id="l11.134">         # Bug 1103551: re-enable these preferences.</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-        #if self.options.debug:</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+        # if self.options.debug:</span>
<a href="#l11.137"></a><span id="l11.137">         #    profargs.setdefault('prefences', []).update({</span>
<a href="#l11.138"></a><span id="l11.138">         #      'extensions.checkCompatibility':False,</span>
<a href="#l11.139"></a><span id="l11.139">         #      'devtools.errorconsole.enabled':True,</span>
<a href="#l11.140"></a><span id="l11.140">         #      'javascript.options.strict': True</span>
<a href="#l11.141"></a><span id="l11.141">         #    })</span>
<a href="#l11.142"></a><span id="l11.142">         profargs.setdefault('addons', []).append(extension_path)</span>
<a href="#l11.143"></a><span id="l11.143">         return profargs</span>
<a href="#l11.144"></a><span id="l11.144"> </span>
<a href="#l11.145"></a><span id="l11.145">     def command_args(self):</span>
<a href="#l11.146"></a><span id="l11.146">         args = super(CLI, self).command_args()</span>
<a href="#l11.147"></a><span id="l11.147">         if self.options.debug:</span>
<a href="#l11.148"></a><span id="l11.148">             args.append('-jsconsole')</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-        if not 'jsbridge' in args:</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+        if 'jsbridge' not in args:</span>
<a href="#l11.151"></a><span id="l11.151">             args += ['-jsbridge', self.options.port]</span>
<a href="#l11.152"></a><span id="l11.152">         return args</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-        </span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+</span>
<a href="#l11.155"></a><span id="l11.155">     def run(self):</span>
<a href="#l11.156"></a><span id="l11.156">         runner = self.create_runner()</span>
<a href="#l11.157"></a><span id="l11.157">         runner.start()</span>
<a href="#l11.158"></a><span id="l11.158">         self.start_jsbridge_network()</span>
<a href="#l11.159"></a><span id="l11.159">         if self.options.shell:</span>
<a href="#l11.160"></a><span id="l11.160">             self.start_shell(runner)</span>
<a href="#l11.161"></a><span id="l11.161">         else:</span>
<a href="#l11.162"></a><span id="l11.162">             try:</span>
<a href="#l11.163"></a><span id="l11.163">                 runner.wait()</span>
<a href="#l11.164"></a><span id="l11.164">             except KeyboardInterrupt:</span>
<a href="#l11.165"></a><span id="l11.165">                 runner.stop()</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-                </span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+</span>
<a href="#l11.168"></a><span id="l11.168">         runner.profile.cleanup()</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-    </span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+</span>
<a href="#l11.171"></a><span id="l11.171">     def start_shell(self, runner):</span>
<a href="#l11.172"></a><span id="l11.172">         try:</span>
<a href="#l11.173"></a><span id="l11.173">             import IPython</span>
<a href="#l11.174"></a><span id="l11.174">         except:</span>
<a href="#l11.175"></a><span id="l11.175">             IPython = None</span>
<a href="#l11.176"></a><span id="l11.176">         if not hasattr(self, 'bridge'):</span>
<a href="#l11.177"></a><span id="l11.177">             self.start_jsbridge_network()</span>
<a href="#l11.178"></a><span id="l11.178">         jsobj = JSObject(self.bridge, window_string)</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-        </span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+</span>
<a href="#l11.181"></a><span id="l11.181">         if IPython is None or self.options.usecode:</span>
<a href="#l11.182"></a><span id="l11.182">             import code</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-            code.interact(local={&quot;jsobj&quot;:jsobj, </span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-                                 &quot;getBrowserWindow&quot;:lambda : getBrowserWindow(self.bridge),</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-                                 &quot;back_channel&quot;:self.back_channel,</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-                                 })</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+            code.interact(local={</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+                &quot;jsobj&quot;: jsobj,</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+                &quot;getBrowserWindow&quot;: lambda: getBrowserWindow(self.bridge),</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+                &quot;back_channel&quot;: self.back_channel,</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+            })</span>
<a href="#l11.192"></a><span id="l11.192">         else:</span>
<a href="#l11.193"></a><span id="l11.193">             from IPython.Shell import IPShellEmbed</span>
<a href="#l11.194"></a><span id="l11.194">             ipshell = IPShellEmbed([])</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-            ipshell(local_ns={&quot;jsobj&quot;:jsobj, </span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-                              &quot;getBrowserWindow&quot;:lambda : getBrowserWindow(self.bridge),</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-                              &quot;back_channel&quot;:self.back_channel,</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-                              })</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+            ipshell(local_ns={</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+                &quot;jsobj&quot;: jsobj,</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+                &quot;getBrowserWindow&quot;: lambda: getBrowserWindow(self.bridge),</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+                &quot;back_channel&quot;: self.back_channel,</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+            })</span>
<a href="#l11.204"></a><span id="l11.204">         runner.stop()</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-        </span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+</span>
<a href="#l11.207"></a><span id="l11.207">     def start_jsbridge_network(self, timeout=10):</span>
<a href="#l11.208"></a><span id="l11.208">         port = int(self.options.port)</span>
<a href="#l11.209"></a><span id="l11.209">         host = '127.0.0.1'</span>
<a href="#l11.210"></a><span id="l11.210">         self.back_channel, self.bridge = wait_and_create_network(host, port, timeout)</span>
<a href="#l11.211"></a><span id="l11.211"> </span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+</span>
<a href="#l11.213"></a><span id="l11.213"> def cli():</span>
<a href="#l11.214"></a><span id="l11.214">     CLI().run()</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+</span>
<a href="#l11.217"></a><span id="l11.217"> def getBrowserWindow(bridge):</span>
<a href="#l11.218"></a><span id="l11.218">     return JSObject(bridge, &quot;Cc['@mozilla.org/appshell/window-mediator;1'].getService(Ci.nsIWindowMediator).getMostRecentWindow('')&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/jsobjects.py</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/jsobjects.py</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -30,138 +30,149 @@</span>
<a href="#l12.4"></a><span id="l12.4"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9"> #</span>
<a href="#l12.10"></a><span id="l12.10"> # ***** END LICENSE BLOCK *****</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13"> def init_jsobject(cls, bridge, name, value, description=None):</span>
<a href="#l12.14"></a><span id="l12.14">     &quot;&quot;&quot;Initialize a js object that is a subclassed base type; int, str, unicode, float.&quot;&quot;&quot;</span>
<a href="#l12.15"></a><span id="l12.15">     obj = cls(value)</span>
<a href="#l12.16"></a><span id="l12.16">     obj._bridge_ = bridge</span>
<a href="#l12.17"></a><span id="l12.17">     obj._name_ = name</span>
<a href="#l12.18"></a><span id="l12.18">     obj._description_ = description</span>
<a href="#l12.19"></a><span id="l12.19">     return obj</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+</span>
<a href="#l12.22"></a><span id="l12.22"> def create_jsobject(bridge, fullname, value=None, obj_type=None, override_set=False):</span>
<a href="#l12.23"></a><span id="l12.23">     &quot;&quot;&quot;Create a single JSObject for named object on other side of the bridge.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-    </span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+</span>
<a href="#l12.26"></a><span id="l12.26">     Handles various initization cases for different JSObjects.&quot;&quot;&quot;</span>
<a href="#l12.27"></a><span id="l12.27">     description = bridge.describe(fullname)</span>
<a href="#l12.28"></a><span id="l12.28">     obj_type = description['type']</span>
<a href="#l12.29"></a><span id="l12.29">     value = description.get('data', None)</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32">     if value is True or value is False:</span>
<a href="#l12.33"></a><span id="l12.33">         return value</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">     if js_type_cases.has_key(obj_type):</span>
<a href="#l12.36"></a><span id="l12.36">         cls, needs_init = js_type_cases[obj_type]</span>
<a href="#l12.37"></a><span id="l12.37">         # Objects that requires initialization are base types that have &quot;values&quot;.</span>
<a href="#l12.38"></a><span id="l12.38">         if needs_init:</span>
<a href="#l12.39"></a><span id="l12.39">             obj = init_jsobject(cls, bridge, fullname, value, description=description)</span>
<a href="#l12.40"></a><span id="l12.40">         else:</span>
<a href="#l12.41"></a><span id="l12.41">             obj = cls(bridge, fullname, description=description, override_set=override_set)</span>
<a href="#l12.42"></a><span id="l12.42">         return obj</span>
<a href="#l12.43"></a><span id="l12.43">     else:</span>
<a href="#l12.44"></a><span id="l12.44">         # Something very bad happened, we don't have a representation for the given type.</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-        raise TypeError(&quot;Don't have a JSObject for javascript type &quot;+obj_type)</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    </span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+        raise TypeError(&quot;Don't have a JSObject for javascript type &quot; + obj_type)</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+</span>
<a href="#l12.50"></a><span id="l12.50"> class JSObject(object):</span>
<a href="#l12.51"></a><span id="l12.51">     &quot;&quot;&quot;Base javascript object representation.&quot;&quot;&quot;</span>
<a href="#l12.52"></a><span id="l12.52">     _loaded_ = False</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    </span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+</span>
<a href="#l12.55"></a><span id="l12.55">     def __init__(self, bridge, name, override_set=False, description=None, *args, **kwargs):</span>
<a href="#l12.56"></a><span id="l12.56">         self._bridge_ = bridge</span>
<a href="#l12.57"></a><span id="l12.57">         if not override_set:</span>
<a href="#l12.58"></a><span id="l12.58">             name = bridge.set(name)['data']</span>
<a href="#l12.59"></a><span id="l12.59">         self._name_ = name</span>
<a href="#l12.60"></a><span id="l12.60">         self._description_ = description</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-    </span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+</span>
<a href="#l12.63"></a><span id="l12.63">     def __jsget__(self, name):</span>
<a href="#l12.64"></a><span id="l12.64">         &quot;&quot;&quot;Abstraction for final step in get events; __getitem__ and __getattr__.</span>
<a href="#l12.65"></a><span id="l12.65">         &quot;&quot;&quot;</span>
<a href="#l12.66"></a><span id="l12.66">         result = create_jsobject(self._bridge_, name, override_set=True)</span>
<a href="#l12.67"></a><span id="l12.67">         return result</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    </span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+</span>
<a href="#l12.70"></a><span id="l12.70">     def __getattr__(self, name):</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-        &quot;&quot;&quot;Get the object from jsbridge. </span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-        </span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+        &quot;&quot;&quot;Get the object from jsbridge.</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+</span>
<a href="#l12.75"></a><span id="l12.75">         Handles lazy loading of all attributes of self.&quot;&quot;&quot;</span>
<a href="#l12.76"></a><span id="l12.76">         # A little hack so that ipython returns all the names.</span>
<a href="#l12.77"></a><span id="l12.77">         if name == '_getAttributeNames':</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-            return lambda : self._bridge_.describe(self._name_)['attributes']</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-            </span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+            return lambda: self._bridge_.describe(self._name_)['attributes']</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+</span>
<a href="#l12.82"></a><span id="l12.82">         attributes = self._bridge_.describe(self._name_)['attributes']</span>
<a href="#l12.83"></a><span id="l12.83">         if name in attributes:</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-            return self.__jsget__(self._name_+'[&quot;'+name+'&quot;]')</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+            return self.__jsget__(self._name_ + '[&quot;' + name + '&quot;]')</span>
<a href="#l12.86"></a><span id="l12.86">         else:</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-            raise AttributeError(name+&quot; is undefined.&quot;)</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-    </span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+            raise AttributeError(name + &quot; is undefined.&quot;)</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+</span>
<a href="#l12.91"></a><span id="l12.91">     __getitem__ = __getattr__</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-        </span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+</span>
<a href="#l12.94"></a><span id="l12.94">     def __setattr__(self, name, value):</span>
<a href="#l12.95"></a><span id="l12.95">         &quot;&quot;&quot;Set the given JSObject as an attribute of this JSObject and make proper javascript</span>
<a href="#l12.96"></a><span id="l12.96">         assignment on the other side of the bridge.&quot;&quot;&quot;</span>
<a href="#l12.97"></a><span id="l12.97">         if name.startswith('_') and name.endswith('_'):</span>
<a href="#l12.98"></a><span id="l12.98">             return object.__setattr__(self, name, value)</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100">         response = self._bridge_.setAttribute(self._name_, name, value)</span>
<a href="#l12.101"></a><span id="l12.101">         object.__setattr__(self, name, create_jsobject(self._bridge_, response['data'], override_set=True))</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    </span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+</span>
<a href="#l12.104"></a><span id="l12.104">     __setitem__ = __setattr__</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107"> class JSFunction(JSObject):</span>
<a href="#l12.108"></a><span id="l12.108">     &quot;&quot;&quot;Javascript function represenation.</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-    </span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-    Returns a JSObject instance for the serialized js type with </span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-    name set to the full javascript call for this function. </span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-    &quot;&quot;&quot;    </span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-    </span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+    Returns a JSObject instance for the serialized js type with</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+    name set to the full javascript call for this function.</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+</span>
<a href="#l12.119"></a><span id="l12.119">     def __init__(self, bridge, name, override_set=False, description=None, *args, **kwargs):</span>
<a href="#l12.120"></a><span id="l12.120">         self._bridge_ = bridge</span>
<a href="#l12.121"></a><span id="l12.121">         self._name_ = name</span>
<a href="#l12.122"></a><span id="l12.122">         self._description_ = description</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-    </span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+</span>
<a href="#l12.125"></a><span id="l12.125">     def __call__(self, *args):</span>
<a href="#l12.126"></a><span id="l12.126">         response = self._bridge_.execFunction(self._name_, args)</span>
<a href="#l12.127"></a><span id="l12.127">         if response['data'] is not None:</span>
<a href="#l12.128"></a><span id="l12.128">             return create_jsobject(self._bridge_, response['data'], override_set=True)</span>
<a href="#l12.129"></a><span id="l12.129"> </span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131"> class JSString(JSObject, unicode):</span>
<a href="#l12.132"></a><span id="l12.132">     &quot;Javascript string representation.&quot;</span>
<a href="#l12.133"></a><span id="l12.133">     __init__ = unicode.__init__</span>
<a href="#l12.134"></a><span id="l12.134"> </span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-class JSInt(JSObject, int): </span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+class JSInt(JSObject, int):</span>
<a href="#l12.138"></a><span id="l12.138">     &quot;&quot;&quot;Javascript number representation for Python int.&quot;&quot;&quot;</span>
<a href="#l12.139"></a><span id="l12.139">     __init__ = int.__init__</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+</span>
<a href="#l12.142"></a><span id="l12.142"> class JSFloat(JSObject, float):</span>
<a href="#l12.143"></a><span id="l12.143">     &quot;&quot;&quot;Javascript number representation for Python float.&quot;&quot;&quot;</span>
<a href="#l12.144"></a><span id="l12.144">     __init__ = float.__init__</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-    </span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+</span>
<a href="#l12.148"></a><span id="l12.148"> class JSUndefined(JSObject):</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-    &quot;&quot;&quot;Javascript undefined representation.&quot;&quot;&quot;    </span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-    __str__ = lambda self : &quot;undefined&quot;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    &quot;&quot;&quot;Javascript undefined representation.&quot;&quot;&quot;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+    def __str__(self):</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+        return &quot;undefined&quot;</span>
<a href="#l12.154"></a><span id="l12.154"> </span>
<a href="#l12.155"></a><span id="l12.155">     def __cmp__(self, other):</span>
<a href="#l12.156"></a><span id="l12.156">         if isinstance(other, JSUndefined):</span>
<a href="#l12.157"></a><span id="l12.157">             return True</span>
<a href="#l12.158"></a><span id="l12.158">         else:</span>
<a href="#l12.159"></a><span id="l12.159">             return False</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-    __nonzero__ = lambda self: False</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+    def __nonzero__(self):</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+        return False</span>
<a href="#l12.164"></a><span id="l12.164"> </span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-js_type_cases = {'function'  :(JSFunction, False,), </span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-                  'object'   :(JSObject, False,), </span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-                  'array'    :(JSObject, False,),</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-                  'string'   :(JSString, True,), </span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-                  'number'   :(JSFloat, True,),</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-                  'undefined':(JSUndefined, False,),</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-                  'null'     :(JSObject, False,),</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-                  }</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-py_type_cases = {unicode  :JSString,</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-                  str     :JSString,</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-                  int     :JSInt,</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-                  float   :JSFloat,</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-                  }</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+js_type_cases = {</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+    'function': (JSFunction, False,),</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+    'object': (JSObject, False,),</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+    'array': (JSObject, False,),</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    'string': (JSString, True,),</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+    'number': (JSFloat, True,),</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+    'undefined': (JSUndefined, False,),</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    'null': (JSObject, False,),</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+}</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+py_type_cases = {</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+    unicode: JSString,</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+    str: JSString,</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+    int: JSInt,</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+    float: JSFloat,</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/resources/jsbridge/jsbridge/network.py</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/jsbridge/network.py</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -43,17 +43,20 @@ import uuid</span>
<a href="#l13.4"></a><span id="l13.4"> from time import sleep</span>
<a href="#l13.5"></a><span id="l13.5"> from threading import Thread</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> import json</span>
<a href="#l13.8"></a><span id="l13.8"> from json.encoder import encode_basestring_ascii, encode_basestring</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> logger = logging.getLogger(__name__)</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-class JavaScriptException(Exception): pass</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+class JavaScriptException(Exception):</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    pass</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> class Telnet(asyncore.dispatcher):</span>
<a href="#l13.19"></a><span id="l13.19">     def __init__(self, host, port):</span>
<a href="#l13.20"></a><span id="l13.20">         self.host, self.port = host, port</span>
<a href="#l13.21"></a><span id="l13.21">         asyncore.dispatcher.__init__(self)</span>
<a href="#l13.22"></a><span id="l13.22">         self.create_socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<a href="#l13.23"></a><span id="l13.23">         self.connect((host, port))</span>
<a href="#l13.24"></a><span id="l13.24">         self.buffer = ''</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineat">@@ -61,45 +64,46 @@ class Telnet(asyncore.dispatcher):</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">     def __del__(self):</span>
<a href="#l13.28"></a><span id="l13.28">         self.close()</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">     def handle_close(self):</span>
<a href="#l13.31"></a><span id="l13.31">         &quot;&quot;&quot;override method of asyncore.dispatcher&quot;&quot;&quot;</span>
<a href="#l13.32"></a><span id="l13.32">         self.close()</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    def handle_expt(self): </span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-        self.close() # connection failed, shutdown</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    </span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+    def handle_expt(self):</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+        self.close()  # connection failed, shutdown</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+</span>
<a href="#l13.40"></a><span id="l13.40">     def writable(self):</span>
<a href="#l13.41"></a><span id="l13.41">         return (len(self.buffer) &gt; 0)</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">     def handle_write(self):</span>
<a href="#l13.44"></a><span id="l13.44">         sent = self.send(self.buffer)</span>
<a href="#l13.45"></a><span id="l13.45">         self.buffer = self.buffer[sent:]</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-        </span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+</span>
<a href="#l13.48"></a><span id="l13.48">     def read_all(self):</span>
<a href="#l13.49"></a><span id="l13.49">         import socket</span>
<a href="#l13.50"></a><span id="l13.50">         data = ''</span>
<a href="#l13.51"></a><span id="l13.51">         while self.connected:</span>
<a href="#l13.52"></a><span id="l13.52">             try:</span>
<a href="#l13.53"></a><span id="l13.53">                 data += self.recv(4096)</span>
<a href="#l13.54"></a><span id="l13.54">             except socket.error:</span>
<a href="#l13.55"></a><span id="l13.55">                 break</span>
<a href="#l13.56"></a><span id="l13.56">         return data</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">     def handle_read(self):</span>
<a href="#l13.59"></a><span id="l13.59">         self.data = self.read_all()</span>
<a href="#l13.60"></a><span id="l13.60">         self.process_read(self.data)</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-        </span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    read_callback = lambda self, data: None</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+    def read_callback(self, data):</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+        return None</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67"> decoder = json.JSONDecoder()</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+</span>
<a href="#l13.70"></a><span id="l13.70"> class JSObjectEncoder(json.JSONEncoder):</span>
<a href="#l13.71"></a><span id="l13.71">     &quot;&quot;&quot;Encoder that supports jsobject references by name.&quot;&quot;&quot;</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73">     def encode(self, o):</span>
<a href="#l13.74"></a><span id="l13.74">         import jsobjects</span>
<a href="#l13.75"></a><span id="l13.75">         if isinstance(o, jsobjects.JSObject):</span>
<a href="#l13.76"></a><span id="l13.76">             return o._name_</span>
<a href="#l13.77"></a><span id="l13.77">         else:</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineat">@@ -143,163 +147,166 @@ class JSObjectEncoder(json.JSONEncoder):</span>
<a href="#l13.79"></a><span id="l13.79">                 markers[markerid] = o</span>
<a href="#l13.80"></a><span id="l13.80">             for chunk in self._iterencode_default(o, markers):</span>
<a href="#l13.81"></a><span id="l13.81">                 yield chunk</span>
<a href="#l13.82"></a><span id="l13.82">             if markers is not None:</span>
<a href="#l13.83"></a><span id="l13.83">                 del markers[markerid]</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85"> encoder = JSObjectEncoder()</span>
<a href="#l13.86"></a><span id="l13.86"> </span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-class JSBridgeDisconnectError(Exception): </span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+class JSBridgeDisconnectError(Exception):</span>
<a href="#l13.90"></a><span id="l13.90">     &quot;&quot;&quot;exception raised when an unexpected disconect happens&quot;&quot;&quot;</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93"> class Bridge(Telnet):</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-    </span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+</span>
<a href="#l13.96"></a><span id="l13.96">     trashes = []</span>
<a href="#l13.97"></a><span id="l13.97">     reading = False</span>
<a href="#l13.98"></a><span id="l13.98">     sbuffer = ''</span>
<a href="#l13.99"></a><span id="l13.99">     events_list = []</span>
<a href="#l13.100"></a><span id="l13.100"> </span>
<a href="#l13.101"></a><span id="l13.101">     callbacks = {}</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-        </span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+</span>
<a href="#l13.104"></a><span id="l13.104">     bridge_type = &quot;bridge&quot;</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-    </span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+</span>
<a href="#l13.107"></a><span id="l13.107">     registered = False</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-    timeout_ctr = 0. # global timeout counter</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-    </span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    timeout_ctr = 0.  # global timeout counter</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+</span>
<a href="#l13.112"></a><span id="l13.112">     def __init__(self, host, port, timeout=60.):</span>
<a href="#l13.113"></a><span id="l13.113">         &quot;&quot;&quot;</span>
<a href="#l13.114"></a><span id="l13.114">         - timeout : failsafe timeout for each call to run in seconds</span>
<a href="#l13.115"></a><span id="l13.115">         &quot;&quot;&quot;</span>
<a href="#l13.116"></a><span id="l13.116">         self.timeout = timeout</span>
<a href="#l13.117"></a><span id="l13.117">         Telnet.__init__(self, host, port)</span>
<a href="#l13.118"></a><span id="l13.118">         sleep(.1)</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120">         # XXX we've actually already connected in Telnet</span>
<a href="#l13.121"></a><span id="l13.121">         self.connect((host, port))</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-    </span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+</span>
<a href="#l13.124"></a><span id="l13.124">     def handle_connect(self):</span>
<a href="#l13.125"></a><span id="l13.125">         self.register()</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127">     def run(self, _uuid, exec_string, interval=.2, raise_exeption=True):</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-</span>
<a href="#l13.130"></a><span id="l13.130">         exec_string += '\r\n'</span>
<a href="#l13.131"></a><span id="l13.131">         self.send(exec_string)</span>
<a href="#l13.132"></a><span id="l13.132"> </span>
<a href="#l13.133"></a><span id="l13.133">         while _uuid not in self.callbacks.keys():</span>
<a href="#l13.134"></a><span id="l13.134"> </span>
<a href="#l13.135"></a><span id="l13.135">             Bridge.timeout_ctr += interval</span>
<a href="#l13.136"></a><span id="l13.136">             if Bridge.timeout_ctr &gt; self.timeout:</span>
<a href="#l13.137"></a><span id="l13.137">                 print 'Timeout: %s' % exec_string</span>
<a href="#l13.138"></a><span id="l13.138">                 raise JSBridgeDisconnectError(&quot;Connection timed out&quot;)</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-            </span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+</span>
<a href="#l13.141"></a><span id="l13.141">             sleep(interval)</span>
<a href="#l13.142"></a><span id="l13.142">             try:</span>
<a href="#l13.143"></a><span id="l13.143">                 self.send('')</span>
<a href="#l13.144"></a><span id="l13.144">             except socket.error, e:</span>
<a href="#l13.145"></a><span id="l13.145">                 raise JSBridgeDisconnectError(&quot;JSBridge Socket Disconnected: %s&quot; % e)</span>
<a href="#l13.146"></a><span id="l13.146"> </span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-        Bridge.timeout_ctr = 0. # reset the counter</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-        </span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+        Bridge.timeout_ctr = 0.  # reset the counter</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+</span>
<a href="#l13.151"></a><span id="l13.151">         callback = self.callbacks.pop(_uuid)</span>
<a href="#l13.152"></a><span id="l13.152">         if callback['result'] is False and raise_exeption is True:</span>
<a href="#l13.153"></a><span id="l13.153">             raise JavaScriptException(callback['exception'])</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-        return callback </span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-        </span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+        return callback</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+</span>
<a href="#l13.158"></a><span id="l13.158">     def register(self):</span>
<a href="#l13.159"></a><span id="l13.159">         _uuid = str(uuid.uuid1())</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-        self.send('bridge.register(&quot;'+_uuid+'&quot;, &quot;'+self.bridge_type+'&quot;)\r\n')</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+        self.send('bridge.register(&quot;' + _uuid + '&quot;, &quot;' + self.bridge_type + '&quot;)\r\n')</span>
<a href="#l13.162"></a><span id="l13.162">         self.registered = True</span>
<a href="#l13.163"></a><span id="l13.163"> </span>
<a href="#l13.164"></a><span id="l13.164">     def execFunction(self, func_name, args, interval=.25):</span>
<a href="#l13.165"></a><span id="l13.165">         _uuid = str(uuid.uuid1())</span>
<a href="#l13.166"></a><span id="l13.166">         exec_args = [encoder.encode(_uuid), func_name, encoder.encode(args)]</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-        return self.run(_uuid, 'bridge.execFunction('+ ', '.join(exec_args)+')', interval)</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-        </span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+        return self.run(_uuid, 'bridge.execFunction(' + ', '.join(exec_args) + ')', interval)</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+</span>
<a href="#l13.171"></a><span id="l13.171">     def setAttribute(self, obj_name, name, value):</span>
<a href="#l13.172"></a><span id="l13.172">         _uuid = str(uuid.uuid1())</span>
<a href="#l13.173"></a><span id="l13.173">         exec_args = [encoder.encode(_uuid), obj_name, encoder.encode(name), encoder.encode(value)]</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-        return self.run(_uuid, 'bridge.setAttribute('+', '.join(exec_args)+')')</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-        </span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+        return self.run(_uuid, 'bridge.setAttribute(' + ', '.join(exec_args) + ')')</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+</span>
<a href="#l13.178"></a><span id="l13.178">     def set(self, obj_name):</span>
<a href="#l13.179"></a><span id="l13.179">         _uuid = str(uuid.uuid1())</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-        return self.run(_uuid, 'bridge.set('+', '.join([encoder.encode(_uuid), obj_name])+')')</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-        </span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+        return self.run(_uuid, 'bridge.set(' + ', '.join([encoder.encode(_uuid), obj_name]) + ')')</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+</span>
<a href="#l13.184"></a><span id="l13.184">     def describe(self, obj_name):</span>
<a href="#l13.185"></a><span id="l13.185">         _uuid = str(uuid.uuid1())</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-        return self.run(_uuid, 'bridge.describe('+', '.join([encoder.encode(_uuid), obj_name])+')')</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-    </span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+        return self.run(_uuid, 'bridge.describe(' + ', '.join([encoder.encode(_uuid), obj_name]) + ')')</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+</span>
<a href="#l13.190"></a><span id="l13.190">     def fire_callbacks(self, obj):</span>
<a href="#l13.191"></a><span id="l13.191">         self.callbacks[obj['uuid']] = obj</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-    </span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+</span>
<a href="#l13.194"></a><span id="l13.194">     def process_read(self, data):</span>
<a href="#l13.195"></a><span id="l13.195">         &quot;&quot;&quot;Parse out json objects and fire callbacks.&quot;&quot;&quot;</span>
<a href="#l13.196"></a><span id="l13.196">         self.sbuffer += data</span>
<a href="#l13.197"></a><span id="l13.197">         self.reading = True</span>
<a href="#l13.198"></a><span id="l13.198">         self.parsing = True</span>
<a href="#l13.199"></a><span id="l13.199">         while self.parsing:</span>
<a href="#l13.200"></a><span id="l13.200">             # Remove erroneous data in front of callback object</span>
<a href="#l13.201"></a><span id="l13.201">             index = self.sbuffer.find('{')</span>
<a href="#l13.202"></a><span id="l13.202">             if index is not -1 and index is not 0:</span>
<a href="#l13.203"></a><span id="l13.203">                 self.sbuffer = self.sbuffer[index:]</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-            # Try to get a json object from the data stream    </span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+            # Try to get a json object from the data stream</span>
<a href="#l13.206"></a><span id="l13.206">             try:</span>
<a href="#l13.207"></a><span id="l13.207">                 obj, index = decoder.raw_decode(self.sbuffer)</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-            except Exception, e:</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+            except Exception:</span>
<a href="#l13.210"></a><span id="l13.210">                 self.parsing = False</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-            # If we got an object fire the callback infra    </span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+            # If we got an object fire the callback infra</span>
<a href="#l13.213"></a><span id="l13.213">             if self.parsing:</span>
<a href="#l13.214"></a><span id="l13.214">                 self.fire_callbacks(obj)</span>
<a href="#l13.215"></a><span id="l13.215">                 self.sbuffer = self.sbuffer[index:]</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-        </span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+</span>
<a href="#l13.219"></a><span id="l13.219"> class BackChannel(Bridge):</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-    </span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+</span>
<a href="#l13.222"></a><span id="l13.222">     bridge_type = &quot;backchannel&quot;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-    </span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+</span>
<a href="#l13.225"></a><span id="l13.225">     def __init__(self, host, port):</span>
<a href="#l13.226"></a><span id="l13.226">         Bridge.__init__(self, host, port)</span>
<a href="#l13.227"></a><span id="l13.227">         self.uuid_listener_index = {}</span>
<a href="#l13.228"></a><span id="l13.228">         self.event_listener_index = {}</span>
<a href="#l13.229"></a><span id="l13.229">         self.global_listeners = []</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-        </span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+</span>
<a href="#l13.232"></a><span id="l13.232">     def fire_callbacks(self, obj):</span>
<a href="#l13.233"></a><span id="l13.233">         &quot;&quot;&quot;Handle all callback fireing on json objects pulled from the data stream.&quot;&quot;&quot;</span>
<a href="#l13.234"></a><span id="l13.234">         self.fire_event(**dict([(str(key), value,) for key, value in obj.items()]))</span>
<a href="#l13.235"></a><span id="l13.235"> </span>
<a href="#l13.236"></a><span id="l13.236">     def add_listener(self, callback, uuid=None, eventType=None):</span>
<a href="#l13.237"></a><span id="l13.237">         if uuid is not None:</span>
<a href="#l13.238"></a><span id="l13.238">             self.uuid_listener_index.setdefault(uuid, []).append(callback)</span>
<a href="#l13.239"></a><span id="l13.239">         if eventType is not None:</span>
<a href="#l13.240"></a><span id="l13.240">             self.event_listener_index.setdefault(eventType, []).append(callback)</span>
<a href="#l13.241"></a><span id="l13.241"> </span>
<a href="#l13.242"></a><span id="l13.242">     def add_global_listener(self, callback):</span>
<a href="#l13.243"></a><span id="l13.243">         self.global_listeners.append(callback)</span>
<a href="#l13.244"></a><span id="l13.244"> </span>
<a href="#l13.245"></a><span id="l13.245">     def fire_event(self, eventType=None, uuid=None, result=None, exception=None):</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-        Bridge.timeout_ctr = 0. # reset the counter</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+        Bridge.timeout_ctr = 0.  # reset the counter</span>
<a href="#l13.248"></a><span id="l13.248">         event = eventType</span>
<a href="#l13.249"></a><span id="l13.249">         if uuid is not None and self.uuid_listener_index.has_key(uuid):</span>
<a href="#l13.250"></a><span id="l13.250">             for callback in self.uuid_listener_index[uuid]:</span>
<a href="#l13.251"></a><span id="l13.251">                 callback(result)</span>
<a href="#l13.252"></a><span id="l13.252">         if event is not None and self.event_listener_index.has_key(event):</span>
<a href="#l13.253"></a><span id="l13.253">             for callback in self.event_listener_index[event]:</span>
<a href="#l13.254"></a><span id="l13.254">                 callback(result)</span>
<a href="#l13.255"></a><span id="l13.255">         for listener in self.global_listeners:</span>
<a href="#l13.256"></a><span id="l13.256">             listener(eventType, result)</span>
<a href="#l13.257"></a><span id="l13.257"> </span>
<a href="#l13.258"></a><span id="l13.258"> thread = None</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">- </span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+</span>
<a href="#l13.262"></a><span id="l13.262"> def create_network(hostname, port):</span>
<a href="#l13.263"></a><span id="l13.263">     back_channel = BackChannel(hostname, port)</span>
<a href="#l13.264"></a><span id="l13.264">     bridge = Bridge(hostname, port)</span>
<a href="#l13.265"></a><span id="l13.265">     global thread</span>
<a href="#l13.266"></a><span id="l13.266">     if not thread or not thread.isAlive():</span>
<a href="#l13.267"></a><span id="l13.267">         def do():</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-            try: asyncore.loop(use_poll=True)</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-            except select.error:pass</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-            </span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+            try:</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+                asyncore.loop(use_poll=True)</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+            except select.error:</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+                pass</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+</span>
<a href="#l13.276"></a><span id="l13.276">         thread = Thread(target=do)</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-        getattr(thread, 'setDaemon', lambda x : None)(True)</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+        getattr(thread, 'setDaemon', lambda x: None)(True)</span>
<a href="#l13.279"></a><span id="l13.279">         thread.start()</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-    </span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+</span>
<a href="#l13.282"></a><span id="l13.282">     return back_channel, bridge</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/resources/jsbridge/setup.py</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/resources/jsbridge/setup.py</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -30,17 +30,16 @@</span>
<a href="#l14.4"></a><span id="l14.4"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.5"></a><span id="l14.5"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.6"></a><span id="l14.6"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.7"></a><span id="l14.7"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.8"></a><span id="l14.8"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.9"></a><span id="l14.9"> #</span>
<a href="#l14.10"></a><span id="l14.10"> # ***** END LICENSE BLOCK *****</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-import sys</span>
<a href="#l14.13"></a><span id="l14.13"> from setuptools import setup, find_packages</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> desc = &quot;&quot;&quot;Python to JavaScript bridge interface.&quot;&quot;&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> summ = &quot;&quot;&quot;A powerful and extensible Python to JavaScript bridge interface.&quot;&quot;&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> PACKAGE_NAME = &quot;jsbridge&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> # You must update the required version in mozmill's setup.py to match this.</span>
<a href="#l14.20"></a><span id="l14.20"> PACKAGE_VERSION = &quot;2.4.15&quot;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -52,24 +51,27 @@ setup(name=PACKAGE_NAME,</span>
<a href="#l14.22"></a><span id="l14.22">       description=desc,</span>
<a href="#l14.23"></a><span id="l14.23">       long_description=summ,</span>
<a href="#l14.24"></a><span id="l14.24">       author='Mikeal Rogers, Mozilla',</span>
<a href="#l14.25"></a><span id="l14.25">       author_email='mikeal.rogers@gmail.com',</span>
<a href="#l14.26"></a><span id="l14.26">       url='http://github.com/mozautomation/mozmill',</span>
<a href="#l14.27"></a><span id="l14.27">       license='http://www.apache.org/licenses/LICENSE-2.0',</span>
<a href="#l14.28"></a><span id="l14.28">       packages=find_packages(exclude=['test']),</span>
<a href="#l14.29"></a><span id="l14.29">       include_package_data=True,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-      package_data = {'': ['*.js', '*.css', '*.html', '*.txt', '*.xpi', '*.rdf', '*.xul', '*.jsm', '*.xml' 'extension'],},</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+      package_data={</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+          '': ['*.js', '*.css', '*.html', '*.txt', '*.xpi', '*.rdf', '*.xul', '*.jsm', '*.xml' 'extension'],</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      },</span>
<a href="#l14.34"></a><span id="l14.34">       zip_safe=False,</span>
<a href="#l14.35"></a><span id="l14.35">       entry_points=&quot;&quot;&quot;</span>
<a href="#l14.36"></a><span id="l14.36">           [console_scripts]</span>
<a href="#l14.37"></a><span id="l14.37">           jsbridge = jsbridge:cli</span>
<a href="#l14.38"></a><span id="l14.38">         &quot;&quot;&quot;,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-      platforms =['Any'],</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-      install_requires = requires,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-      classifiers=['Development Status :: 4 - Beta',</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-                   'Environment :: Console',</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-                   'Intended Audience :: Developers',</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-                   'License :: OSI Approved :: Apache Software License',</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-                   'Operating System :: OS Independent',</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-                   'Topic :: Software Development :: Libraries :: Python Modules',</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-                  ]</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-     )</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+      platforms=['Any'],</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      install_requires=requires,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+      classifiers=[</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+          'Development Status :: 4 - Beta',</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+          'Environment :: Console',</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+          'Intended Audience :: Developers',</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+          'License :: OSI Approved :: Apache Software License',</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+          'Operating System :: OS Independent',</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+          'Topic :: Software Development :: Libraries :: Python Modules',</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+      ]</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+      )</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/resources/mozmill/MANIFEST.in</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/resources/mozmill/MANIFEST.in</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,2 +1,1 @@</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineminus">-recursive-include docs *</span>
<a href="#l15.5"></a><span id="l15.5"> recursive-include mozmill/extension *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/__init__.py</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/__init__.py</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -32,17 +32,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.5"></a><span id="l16.5"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.6"></a><span id="l16.6"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.7"></a><span id="l16.7"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.8"></a><span id="l16.8"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.9"></a><span id="l16.9"> #</span>
<a href="#l16.10"></a><span id="l16.10"> # ***** END LICENSE BLOCK *****</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-import copy</span>
<a href="#l16.13"></a><span id="l16.13"> import imp</span>
<a href="#l16.14"></a><span id="l16.14"> import os</span>
<a href="#l16.15"></a><span id="l16.15"> import socket</span>
<a href="#l16.16"></a><span id="l16.16"> import sys</span>
<a href="#l16.17"></a><span id="l16.17"> import traceback</span>
<a href="#l16.18"></a><span id="l16.18"> import urllib2</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> from datetime import datetime, timedelta</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -50,53 +49,56 @@ import manifestparser</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23"> try:</span>
<a href="#l16.24"></a><span id="l16.24">     import json</span>
<a href="#l16.25"></a><span id="l16.25"> except:</span>
<a href="#l16.26"></a><span id="l16.26">     import simplejson as json</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28"> # setup logger</span>
<a href="#l16.29"></a><span id="l16.29"> import logging</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-logger = logging.getLogger('mozmill')</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32"> import jsbridge</span>
<a href="#l16.33"></a><span id="l16.33"> from jsbridge.network import JSBridgeDisconnectError</span>
<a href="#l16.34"></a><span id="l16.34"> import mozprofile</span>
<a href="#l16.35"></a><span id="l16.35"> import mozrunner</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37"> from time import sleep</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+logger = logging.getLogger('mozmill')</span>
<a href="#l16.40"></a><span id="l16.40"> basedir = os.path.abspath(os.path.dirname(__file__))</span>
<a href="#l16.41"></a><span id="l16.41"> </span>
<a href="#l16.42"></a><span id="l16.42"> extension_path = os.path.join(basedir, 'extension')</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44"> mozmillModuleJs = &quot;ChromeUtils.import('chrome://mozmill/content/modules/mozmill.js')&quot;</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46"> try:</span>
<a href="#l16.47"></a><span id="l16.47">     import pkg_resources</span>
<a href="#l16.48"></a><span id="l16.48">     version = pkg_resources.get_distribution('mozmill').version</span>
<a href="#l16.49"></a><span id="l16.49"> except:</span>
<a href="#l16.50"></a><span id="l16.50">     # pkg_resources not available</span>
<a href="#l16.51"></a><span id="l16.51">     version = None</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54"> class LoggerListener(object):</span>
<a href="#l16.55"></a><span id="l16.55">     cases = {</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-        'mozmill.pass':   lambda string: logger.info('Step Pass: ' + string),</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-        'mozmill.fail':   lambda string: logger.error('Test Failure: ' + string),</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-        'mozmill.skip':   lambda string: logger.info('Test Skipped: ' + string)</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+        'mozmill.pass': lambda string: logger.info('Step Pass: ' + string),</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+        'mozmill.fail': lambda string: logger.error('Test Failure: ' + string),</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+        'mozmill.skip': lambda string: logger.info('Test Skipped: ' + string)</span>
<a href="#l16.62"></a><span id="l16.62">     }</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-    </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+</span>
<a href="#l16.65"></a><span id="l16.65">     class default(object):</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-        def __init__(self, eName): self.eName = eName</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+        def __init__(self, eName):</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+            self.eName = eName</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+</span>
<a href="#l16.70"></a><span id="l16.70">         def __call__(self, string):</span>
<a href="#l16.71"></a><span id="l16.71">             if string:</span>
<a href="#l16.72"></a><span id="l16.72">                 logger.debug(self.eName + ' | ' + string)</span>
<a href="#l16.73"></a><span id="l16.73">             else:</span>
<a href="#l16.74"></a><span id="l16.74">                 logger.debug(self.eName)</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-    </span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+</span>
<a href="#l16.77"></a><span id="l16.77">     def __call__(self, eName, obj):</span>
<a href="#l16.78"></a><span id="l16.78">         if obj == {}:</span>
<a href="#l16.79"></a><span id="l16.79">             string = ''</span>
<a href="#l16.80"></a><span id="l16.80">         else:</span>
<a href="#l16.81"></a><span id="l16.81">             string = json.dumps(obj)</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83">         if eName not in self.cases:</span>
<a href="#l16.84"></a><span id="l16.84">             self.cases[eName] = self.default(eName)</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineat">@@ -119,33 +121,35 @@ class MozMill(object):</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87">     You should *NOT* vary from this order of execution.  If you have need to</span>
<a href="#l16.88"></a><span id="l16.88">     run different sets of tests, create a new instantiation of MozMill</span>
<a href="#l16.89"></a><span id="l16.89">     &quot;&quot;&quot;</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91">     report_type = 'mozmill-test'</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93">     def __init__(self,</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-                 runner_class=mozrunner.FirefoxRunner, </span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+                 runner_class=mozrunner.FirefoxRunner,</span>
<a href="#l16.96"></a><span id="l16.96">                  profile_class=mozprofile.FirefoxProfile,</span>
<a href="#l16.97"></a><span id="l16.97">                  jsbridge_port=24242,</span>
<a href="#l16.98"></a><span id="l16.98">                  jsbridge_timeout=60):</span>
<a href="#l16.99"></a><span id="l16.99">         &quot;&quot;&quot;</span>
<a href="#l16.100"></a><span id="l16.100">         - runner_class : which mozrunner class to use</span>
<a href="#l16.101"></a><span id="l16.101">         - profile_class : which class to use to generate application profiles</span>
<a href="#l16.102"></a><span id="l16.102">         - jsbridge_port : port jsbridge uses to connect to to the application</span>
<a href="#l16.103"></a><span id="l16.103">         - jsbridge_timeout : how long to go without jsbridge communication</span>
<a href="#l16.104"></a><span id="l16.104">         &quot;&quot;&quot;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-        </span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+</span>
<a href="#l16.107"></a><span id="l16.107">         self.runner_class = runner_class</span>
<a href="#l16.108"></a><span id="l16.108">         self.profile_class = profile_class</span>
<a href="#l16.109"></a><span id="l16.109">         self.jsbridge_port = jsbridge_port</span>
<a href="#l16.110"></a><span id="l16.110">         self.jsbridge_timeout = jsbridge_timeout</span>
<a href="#l16.111"></a><span id="l16.111"> </span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-        self.passes = [] ; self.fails = [] ; self.skipped = []</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+        self.passes = []</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+        self.fails = []</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+        self.skipped = []</span>
<a href="#l16.116"></a><span id="l16.116">         self.alltests = []</span>
<a href="#l16.117"></a><span id="l16.117"> </span>
<a href="#l16.118"></a><span id="l16.118">         self.persisted = {}</span>
<a href="#l16.119"></a><span id="l16.119">         self.endRunnerCalled = False</span>
<a href="#l16.120"></a><span id="l16.120">         self.shutdownModes = enum('default', 'user_shutdown', 'user_restart')</span>
<a href="#l16.121"></a><span id="l16.121">         self.currentShutdownMode = self.shutdownModes.default</span>
<a href="#l16.122"></a><span id="l16.122">         self.userShutdownEnabled = False</span>
<a href="#l16.123"></a><span id="l16.123">         self.tests = []</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineat">@@ -174,95 +178,100 @@ class MozMill(object):</span>
<a href="#l16.125"></a><span id="l16.125">     def persist_listener(self, obj):</span>
<a href="#l16.126"></a><span id="l16.126">         self.persisted = obj</span>
<a href="#l16.127"></a><span id="l16.127"> </span>
<a href="#l16.128"></a><span id="l16.128">     def fire_python_callback(self, method, arg, python_callbacks_module):</span>
<a href="#l16.129"></a><span id="l16.129">         meth = getattr(python_callbacks_module, method)</span>
<a href="#l16.130"></a><span id="l16.130">         try:</span>
<a href="#l16.131"></a><span id="l16.131">             meth(arg)</span>
<a href="#l16.132"></a><span id="l16.132">         except Exception, e:</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-            self.endTest_listener({&quot;name&quot;:method, &quot;failed&quot;:1, </span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-                                   &quot;python_exception_type&quot;:e.__class__.__name__,</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-                                   &quot;python_exception_string&quot;:str(e),</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-                                   &quot;python_traceback&quot;:traceback.format_exc(),</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-                                   &quot;filename&quot;:python_callbacks_module.__file__})</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+            self.endTest_listener({</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+                &quot;name&quot;: method,</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+                &quot;failed&quot;: 1,</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+                &quot;python_exception_type&quot;: e.__class__.__name__,</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+                &quot;python_exception_string&quot;: str(e),</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+                &quot;python_traceback&quot;: traceback.format_exc(),</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+                &quot;filename&quot;: python_callbacks_module.__file__</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+            })</span>
<a href="#l16.146"></a><span id="l16.146">             return False</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-        self.endTest_listener({&quot;name&quot;:method, &quot;failed&quot;:0, </span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-                               &quot;filename&quot;:python_callbacks_module.__file__})</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+        self.endTest_listener({</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+            &quot;name&quot;: method,</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+            &quot;failed&quot;: 0,</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+            &quot;filename&quot;: python_callbacks_module.__file__</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+        })</span>
<a href="#l16.154"></a><span id="l16.154">         return True</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-    </span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+</span>
<a href="#l16.157"></a><span id="l16.157">     def firePythonCallback_listener(self, obj):</span>
<a href="#l16.158"></a><span id="l16.158">         callback_file = &quot;%s_callbacks.py&quot; % os.path.splitext(obj['filename'])[0]</span>
<a href="#l16.159"></a><span id="l16.159">         if os.path.isfile(callback_file):</span>
<a href="#l16.160"></a><span id="l16.160">             python_callbacks_module = imp.load_source('callbacks', callback_file)</span>
<a href="#l16.161"></a><span id="l16.161">         else:</span>
<a href="#l16.162"></a><span id="l16.162">             raise Exception(&quot;No valid callback file&quot;)</span>
<a href="#l16.163"></a><span id="l16.163">         self.fire_python_callback(obj['method'], obj['arg'], python_callbacks_module)</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165">     def create_network(self):</span>
<a href="#l16.166"></a><span id="l16.166"> </span>
<a href="#l16.167"></a><span id="l16.167">         # get the bridge and the back-channel</span>
<a href="#l16.168"></a><span id="l16.168">         self.back_channel, self.bridge = jsbridge.wait_and_create_network(&quot;127.0.0.1&quot;,</span>
<a href="#l16.169"></a><span id="l16.169">                                                                           self.jsbridge_port)</span>
<a href="#l16.170"></a><span id="l16.170"> </span>
<a href="#l16.171"></a><span id="l16.171">         # set a timeout on jsbridge actions in order to ensure termination</span>
<a href="#l16.172"></a><span id="l16.172">         self.back_channel.timeout = self.bridge.timeout = self.jsbridge_timeout</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-        </span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+</span>
<a href="#l16.175"></a><span id="l16.175">         # Assign listeners to the back channel</span>
<a href="#l16.176"></a><span id="l16.176">         for listener in self.listeners:</span>
<a href="#l16.177"></a><span id="l16.177">             self.back_channel.add_listener(listener[0], **listener[1])</span>
<a href="#l16.178"></a><span id="l16.178">         for global_listener in self.global_listeners:</span>
<a href="#l16.179"></a><span id="l16.179">             self.back_channel.add_global_listener(global_listener)</span>
<a href="#l16.180"></a><span id="l16.180"> </span>
<a href="#l16.181"></a><span id="l16.181">     def start(self, profile=None, runner=None):</span>
<a href="#l16.182"></a><span id="l16.182"> </span>
<a href="#l16.183"></a><span id="l16.183">         if not profile:</span>
<a href="#l16.184"></a><span id="l16.184">             profile = self.profile_class(addons=[jsbridge.extension_path, extension_path])</span>
<a href="#l16.185"></a><span id="l16.185">         self.profile = profile</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-        </span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+</span>
<a href="#l16.188"></a><span id="l16.188">         if not runner:</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-            runner = self.runner_class(profile=self.profile, </span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+            runner = self.runner_class(profile=self.profile,</span>
<a href="#l16.191"></a><span id="l16.191">                                        cmdargs=[&quot;-jsbridge&quot;, str(self.jsbridge_port)])</span>
<a href="#l16.192"></a><span id="l16.192"> </span>
<a href="#l16.193"></a><span id="l16.193">         self.add_listener(self.firePythonCallback_listener, eventType='mozmill.firePythonCallback')</span>
<a href="#l16.194"></a><span id="l16.194">         self.runner = runner</span>
<a href="#l16.195"></a><span id="l16.195">         self.endRunnerCalled = False</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-        </span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+</span>
<a href="#l16.198"></a><span id="l16.198">         self.runner.start()</span>
<a href="#l16.199"></a><span id="l16.199">         self.create_network()</span>
<a href="#l16.200"></a><span id="l16.200">         self.appinfo = self.get_appinfo(self.bridge)</span>
<a href="#l16.201"></a><span id="l16.201"> </span>
<a href="#l16.202"></a><span id="l16.202">         # set the starttime for the tests</span>
<a href="#l16.203"></a><span id="l16.203">         # XXX assumes run_tests will be called soon after (currently true)</span>
<a href="#l16.204"></a><span id="l16.204">         self.starttime = datetime.utcnow()</span>
<a href="#l16.205"></a><span id="l16.205"> </span>
<a href="#l16.206"></a><span id="l16.206">     def find_tests(self, tests, files=None):</span>
<a href="#l16.207"></a><span id="l16.207">         if files is None:</span>
<a href="#l16.208"></a><span id="l16.208">             files = []</span>
<a href="#l16.209"></a><span id="l16.209">         for test in tests:</span>
<a href="#l16.210"></a><span id="l16.210"> </span>
<a href="#l16.211"></a><span id="l16.211">             # tests have to be absolute paths to be loaded from JS</span>
<a href="#l16.212"></a><span id="l16.212">             test = os.path.abspath(test)</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-            </span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+</span>
<a href="#l16.215"></a><span id="l16.215">             if os.path.isdir(test):</span>
<a href="#l16.216"></a><span id="l16.216">                 directory = test</span>
<a href="#l16.217"></a><span id="l16.217">                 for f in os.listdir(directory):</span>
<a href="#l16.218"></a><span id="l16.218">                     if not f.startswith('test'):</span>
<a href="#l16.219"></a><span id="l16.219">                         continue</span>
<a href="#l16.220"></a><span id="l16.220">                     path = os.path.join(directory, f)</span>
<a href="#l16.221"></a><span id="l16.221">                     if os.path.isdir(path):</span>
<a href="#l16.222"></a><span id="l16.222">                         self.find_tests([path], files)</span>
<a href="#l16.223"></a><span id="l16.223">                     else:</span>
<a href="#l16.224"></a><span id="l16.224">                         if f.endswith('.js') and path not in files:</span>
<a href="#l16.225"></a><span id="l16.225">                             files.append(path)</span>
<a href="#l16.226"></a><span id="l16.226">             else:</span>
<a href="#l16.227"></a><span id="l16.227">                 files.append(test)</span>
<a href="#l16.228"></a><span id="l16.228">         return files</span>
<a href="#l16.229"></a><span id="l16.229"> </span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-</span>
<a href="#l16.231"></a><span id="l16.231">     def run_tests(self, tests, sleeptime=0):</span>
<a href="#l16.232"></a><span id="l16.232">         &quot;&quot;&quot;</span>
<a href="#l16.233"></a><span id="l16.233">         run test files or directories</span>
<a href="#l16.234"></a><span id="l16.234">         - test : test files or directories to run</span>
<a href="#l16.235"></a><span id="l16.235">         - sleeptime : initial time to sleep [s] (not sure why the default is 4)</span>
<a href="#l16.236"></a><span id="l16.236">         &quot;&quot;&quot;</span>
<a href="#l16.237"></a><span id="l16.237"> </span>
<a href="#l16.238"></a><span id="l16.238">         tests = self.find_tests(tests)</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineat">@@ -299,56 +308,57 @@ class MozMill(object):</span>
<a href="#l16.240"></a><span id="l16.240">             print &quot;TEST-UNEXPECTED-FAIL | %s | %s&quot; % (test['filename'], test['name'])</span>
<a href="#l16.241"></a><span id="l16.241">             self.fails.append(test)</span>
<a href="#l16.242"></a><span id="l16.242">         else:</span>
<a href="#l16.243"></a><span id="l16.243">             print &quot;TEST-PASS | %s | %s&quot; % (test['filename'], test['name'])</span>
<a href="#l16.244"></a><span id="l16.244">             self.passes.append(test)</span>
<a href="#l16.245"></a><span id="l16.245"> </span>
<a href="#l16.246"></a><span id="l16.246">     def endRunner_listener(self, obj):</span>
<a href="#l16.247"></a><span id="l16.247">         self.endRunnerCalled = True</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-        </span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+</span>
<a href="#l16.250"></a><span id="l16.250">     def userShutdown_listener(self, obj):</span>
<a href="#l16.251"></a><span id="l16.251">         if obj in [self.shutdownModes.default, self.shutdownModes.user_restart, self.shutdownModes.user_shutdown]:</span>
<a href="#l16.252"></a><span id="l16.252">             self.currentShutdownMode = obj</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-        self.userShutdownEnabled = not self.userShutdownEnabled        </span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+        self.userShutdownEnabled = not self.userShutdownEnabled</span>
<a href="#l16.255"></a><span id="l16.255"> </span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-    ### methods for reporting</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+    # Methods for reporting</span>
<a href="#l16.258"></a><span id="l16.258"> </span>
<a href="#l16.259"></a><span id="l16.259">     def printStats(self):</span>
<a href="#l16.260"></a><span id="l16.260">         &quot;&quot;&quot;print pass/failed/skipped statistics&quot;&quot;&quot;</span>
<a href="#l16.261"></a><span id="l16.261">         print &quot;INFO Passed: %d&quot; % len(self.passes)</span>
<a href="#l16.262"></a><span id="l16.262">         print &quot;INFO Failed: %d&quot; % len(self.fails)</span>
<a href="#l16.263"></a><span id="l16.263">         print &quot;INFO Skipped: %d&quot; % len(self.skipped)</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-        </span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+</span>
<a href="#l16.266"></a><span id="l16.266">     def report_disconnect(self):</span>
<a href="#l16.267"></a><span id="l16.267">         test = self.current_test</span>
<a href="#l16.268"></a><span id="l16.268">         test['passes'] = []</span>
<a href="#l16.269"></a><span id="l16.269">         test['fails'] = [{</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-          'exception' : {</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-            'message': 'Disconnect Error: Application unexpectedly closed'</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-          }</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+            'exception': {</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+                'message': 'Disconnect Error: Application unexpectedly closed'</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+            }</span>
<a href="#l16.276"></a><span id="l16.276">         }]</span>
<a href="#l16.277"></a><span id="l16.277">         test['passed'] = 0</span>
<a href="#l16.278"></a><span id="l16.278">         test['failed'] = 1</span>
<a href="#l16.279"></a><span id="l16.279">         self.alltests.append(test)</span>
<a href="#l16.280"></a><span id="l16.280">         self.fails.append(test)</span>
<a href="#l16.281"></a><span id="l16.281"> </span>
<a href="#l16.282"></a><span id="l16.282">     def get_appinfo(self, bridge):</span>
<a href="#l16.283"></a><span id="l16.283">         &quot;&quot;&quot; Collect application specific information &quot;&quot;&quot;</span>
<a href="#l16.284"></a><span id="l16.284"> </span>
<a href="#l16.285"></a><span id="l16.285">         mozmill = jsbridge.JSObject(bridge, mozmillModuleJs)</span>
<a href="#l16.286"></a><span id="l16.286">         appInfo = mozmill.appInfo</span>
<a href="#l16.287"></a><span id="l16.287"> </span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-        results = {'application_id': str(appInfo.ID),</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-                   'application_name': str(appInfo.name),</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineminus">-                   'application_version': str(appInfo.version),</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineminus">-                   'application_locale': str(mozmill.locale),</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineminus">-                   'platform_buildid': str(appInfo.platformBuildID),</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-                   'platform_version': str(appInfo.platformVersion),</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-                  }</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+        results = {</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+            'application_id': str(appInfo.ID),</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+            'application_name': str(appInfo.name),</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+            'application_version': str(appInfo.version),</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+            'application_locale': str(mozmill.locale),</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+            'platform_buildid': str(appInfo.platformBuildID),</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+            'platform_version': str(appInfo.platformVersion),</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+        }</span>
<a href="#l16.303"></a><span id="l16.303"> </span>
<a href="#l16.304"></a><span id="l16.304">         return results</span>
<a href="#l16.305"></a><span id="l16.305"> </span>
<a href="#l16.306"></a><span id="l16.306">     def get_platform_information(self):</span>
<a href="#l16.307"></a><span id="l16.307">         &quot;&quot;&quot; Retrieves platform information for test reports. Parts of that code</span>
<a href="#l16.308"></a><span id="l16.308">             come from the dirtyharry application:</span>
<a href="#l16.309"></a><span id="l16.309">             http://github.com/harthur/dirtyharry/blob/master/dirtyutils.py &quot;&quot;&quot;</span>
<a href="#l16.310"></a><span id="l16.310"> </span>
<a href="#l16.311"></a><span id="l16.311" class="difflineat">@@ -358,19 +368,19 @@ class MozMill(object):</span>
<a href="#l16.312"></a><span id="l16.312">         (system, node, release, version, machine, processor) = platform.uname()</span>
<a href="#l16.313"></a><span id="l16.313">         (bits, linkage) = platform.architecture()</span>
<a href="#l16.314"></a><span id="l16.314">         service_pack = ''</span>
<a href="#l16.315"></a><span id="l16.315"> </span>
<a href="#l16.316"></a><span id="l16.316">         if system in [&quot;Microsoft&quot;, &quot;Windows&quot;]:</span>
<a href="#l16.317"></a><span id="l16.317">             # There is a Python bug on Windows to determine platform values</span>
<a href="#l16.318"></a><span id="l16.318">             # http://bugs.python.org/issue7860</span>
<a href="#l16.319"></a><span id="l16.319">             if &quot;PROCESSOR_ARCHITEW6432&quot; in os.environ:</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineminus">-              processor = os.environ.get(&quot;PROCESSOR_ARCHITEW6432&quot;, processor)</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+                processor = os.environ.get(&quot;PROCESSOR_ARCHITEW6432&quot;, processor)</span>
<a href="#l16.322"></a><span id="l16.322">             else:</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-              processor = os.environ.get('PROCESSOR_ARCHITECTURE', processor)</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+                processor = os.environ.get('PROCESSOR_ARCHITECTURE', processor)</span>
<a href="#l16.325"></a><span id="l16.325">             system = os.environ.get(&quot;OS&quot;, system).replace('_', ' ')</span>
<a href="#l16.326"></a><span id="l16.326">             service_pack = os.sys.getwindowsversion()[4]</span>
<a href="#l16.327"></a><span id="l16.327">         elif system == &quot;Linux&quot;:</span>
<a href="#l16.328"></a><span id="l16.328">             (distro, version, codename) = platform.dist()</span>
<a href="#l16.329"></a><span id="l16.329">             version = distro + &quot; &quot; + version</span>
<a href="#l16.330"></a><span id="l16.330">             if not processor:</span>
<a href="#l16.331"></a><span id="l16.331">                 processor = machine</span>
<a href="#l16.332"></a><span id="l16.332">         elif system == &quot;Darwin&quot;:</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineat">@@ -384,60 +394,62 @@ class MozMill(object):</span>
<a href="#l16.334"></a><span id="l16.334">             elif bits == &quot;64bit&quot;:</span>
<a href="#l16.335"></a><span id="l16.335">                 processor = &quot;x86_64&quot;</span>
<a href="#l16.336"></a><span id="l16.336">         elif processor == &quot;AMD64&quot;:</span>
<a href="#l16.337"></a><span id="l16.337">             bits = &quot;64bit&quot;</span>
<a href="#l16.338"></a><span id="l16.338">             processor = &quot;x86_64&quot;</span>
<a href="#l16.339"></a><span id="l16.339">         elif processor == &quot;Power Macintosh&quot;:</span>
<a href="#l16.340"></a><span id="l16.340">             processor = &quot;ppc&quot;</span>
<a href="#l16.341"></a><span id="l16.341"> </span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-        bits = re.search('(\d+)bit', bits).group(1)</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+        bits = re.search(r'(\d+)bit', bits).group(1)</span>
<a href="#l16.344"></a><span id="l16.344"> </span>
<a href="#l16.345"></a><span id="l16.345" class="difflineminus">-        platform = {'hostname': node,</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-                    'system': system,</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-                    'version': version,</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineminus">-                    'service_pack': service_pack,</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineminus">-                    'processor': processor,</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-                    'bits': bits</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-                   }</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+        platform = {</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+            'hostname': node,</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+            'system': system,</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+            'version': version,</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineplus">+            'service_pack': service_pack,</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineplus">+            'processor': processor,</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+            'bits': bits</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+        }</span>
<a href="#l16.360"></a><span id="l16.360"> </span>
<a href="#l16.361"></a><span id="l16.361">         return platform</span>
<a href="#l16.362"></a><span id="l16.362"> </span>
<a href="#l16.363"></a><span id="l16.363">     def get_report(self):</span>
<a href="#l16.364"></a><span id="l16.364">         &quot;&quot;&quot;get the report results&quot;&quot;&quot;</span>
<a href="#l16.365"></a><span id="l16.365">         format = &quot;%Y-%m-%dT%H:%M:%SZ&quot;</span>
<a href="#l16.366"></a><span id="l16.366"> </span>
<a href="#l16.367"></a><span id="l16.367">         assert self.tests, 'no tests have been run!'</span>
<a href="#l16.368"></a><span id="l16.368">         assert self.starttime, 'starttime not set; have you started the tests?'</span>
<a href="#l16.369"></a><span id="l16.369">         if not self.endtime:</span>
<a href="#l16.370"></a><span id="l16.370">             self.endtime = datetime.utcnow()</span>
<a href="#l16.371"></a><span id="l16.371"> </span>
<a href="#l16.372"></a><span id="l16.372" class="difflineminus">-        report = {'report_type': self.report_type,</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineminus">-                  'mozmill_version': version,</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineminus">-                  'time_start': self.starttime.strftime(format),</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineminus">-                  'time_end': self.endtime.strftime(format),</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineminus">-                  'time_upload': 'n/a',</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineminus">-                  'tests_passed': len(self.passes),</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineminus">-                  'tests_failed': len(self.fails),</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-                  'tests_skipped': len(self.skipped),</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineminus">-                  'results': self.alltests</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-                 }</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+        report = {</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+            'report_type': self.report_type,</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+            'mozmill_version': version,</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+            'time_start': self.starttime.strftime(format),</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+            'time_end': self.endtime.strftime(format),</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+            'time_upload': 'n/a',</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+            'tests_passed': len(self.passes),</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+            'tests_failed': len(self.fails),</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+            'tests_skipped': len(self.skipped),</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+            'results': self.alltests</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+        }</span>
<a href="#l16.393"></a><span id="l16.393"> </span>
<a href="#l16.394"></a><span id="l16.394">         report.update(self.appinfo)</span>
<a href="#l16.395"></a><span id="l16.395">         report.update(self.runner.get_repositoryInfo())</span>
<a href="#l16.396"></a><span id="l16.396">         report['system_info'] = self.get_platform_information()</span>
<a href="#l16.397"></a><span id="l16.397"> </span>
<a href="#l16.398"></a><span id="l16.398">         return report</span>
<a href="#l16.399"></a><span id="l16.399"> </span>
<a href="#l16.400"></a><span id="l16.400">     def send_report(self, results, report_url):</span>
<a href="#l16.401"></a><span id="l16.401">         &quot;&quot;&quot; Send a report of the results to a CouchdB instance or a file. &quot;&quot;&quot;</span>
<a href="#l16.402"></a><span id="l16.402"> </span>
<a href="#l16.403"></a><span id="l16.403">         # report to file or stdout</span>
<a href="#l16.404"></a><span id="l16.404">         f = None</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineminus">-        if report_url == 'stdout': # stdout</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+        if report_url == 'stdout':  # stdout</span>
<a href="#l16.407"></a><span id="l16.407">             f = sys.stdout</span>
<a href="#l16.408"></a><span id="l16.408">         if report_url.startswith('file://'):</span>
<a href="#l16.409"></a><span id="l16.409">             filename = report_url.split('file://', 1)[1]</span>
<a href="#l16.410"></a><span id="l16.410">             try:</span>
<a href="#l16.411"></a><span id="l16.411">                 f = file(filename, 'w')</span>
<a href="#l16.412"></a><span id="l16.412">             except Exception, e:</span>
<a href="#l16.413"></a><span id="l16.413">                 print &quot;Printing results to '%s' failed (%s).&quot; % (filename, e)</span>
<a href="#l16.414"></a><span id="l16.414">                 return</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineat">@@ -471,40 +483,40 @@ class MozMill(object):</span>
<a href="#l16.416"></a><span id="l16.416">     def report(self, report_url):</span>
<a href="#l16.417"></a><span id="l16.417">         &quot;&quot;&quot;print statistics and send the JSON report&quot;&quot;&quot;</span>
<a href="#l16.418"></a><span id="l16.418">         self.printStats()</span>
<a href="#l16.419"></a><span id="l16.419"> </span>
<a href="#l16.420"></a><span id="l16.420">         if report_url:</span>
<a href="#l16.421"></a><span id="l16.421">             results = self.get_report()</span>
<a href="#l16.422"></a><span id="l16.422">             return self.send_report(results, report_url)</span>
<a href="#l16.423"></a><span id="l16.423"> </span>
<a href="#l16.424"></a><span id="l16.424" class="difflineminus">-    ### methods for shutting down and cleanup</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+    # Methods for shutting down and cleanup</span>
<a href="#l16.426"></a><span id="l16.426"> </span>
<a href="#l16.427"></a><span id="l16.427">     def stop_runner(self, timeout=30, close_bridge=False, hard=False):</span>
<a href="#l16.428"></a><span id="l16.428">         sleep(1)</span>
<a href="#l16.429"></a><span id="l16.429">         try:</span>
<a href="#l16.430"></a><span id="l16.430">             mozmill = jsbridge.JSObject(self.bridge, mozmillModuleJs)</span>
<a href="#l16.431"></a><span id="l16.431">             mozmill.cleanQuit()</span>
<a href="#l16.432"></a><span id="l16.432">         except (socket.error, JSBridgeDisconnectError):</span>
<a href="#l16.433"></a><span id="l16.433">             pass</span>
<a href="#l16.434"></a><span id="l16.434">         except:</span>
<a href="#l16.435"></a><span id="l16.435">             self.runner.cleanup()</span>
<a href="#l16.436"></a><span id="l16.436">             raise</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineminus">-        </span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+</span>
<a href="#l16.439"></a><span id="l16.439">         if not close_bridge:</span>
<a href="#l16.440"></a><span id="l16.440">             starttime = datetime.utcnow()</span>
<a href="#l16.441"></a><span id="l16.441">             self.runner.wait(timeout=timeout)</span>
<a href="#l16.442"></a><span id="l16.442">             endtime = datetime.utcnow()</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineminus">-            if ( endtime - starttime ) &gt; timedelta(seconds=timeout):</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+            if (endtime - starttime) &gt; timedelta(seconds=timeout):</span>
<a href="#l16.445"></a><span id="l16.445">                 try:</span>
<a href="#l16.446"></a><span id="l16.446">                     self.runner.stop()</span>
<a href="#l16.447"></a><span id="l16.447">                 except:</span>
<a href="#l16.448"></a><span id="l16.448">                     pass</span>
<a href="#l16.449"></a><span id="l16.449">                 self.runner.wait()</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineminus">-        else: # TODO: unify this logic with the above better</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+        else:  # TODO: unify this logic with the above better</span>
<a href="#l16.452"></a><span id="l16.452">             if hard:</span>
<a href="#l16.453"></a><span id="l16.453">                 self.runner.cleanup()</span>
<a href="#l16.454"></a><span id="l16.454">                 return</span>
<a href="#l16.455"></a><span id="l16.455"> </span>
<a href="#l16.456"></a><span id="l16.456">             # XXX this call won't actually finish in the specified timeout time</span>
<a href="#l16.457"></a><span id="l16.457">             self.runner.wait(timeout=timeout)</span>
<a href="#l16.458"></a><span id="l16.458"> </span>
<a href="#l16.459"></a><span id="l16.459">             self.back_channel.close()</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineat">@@ -539,72 +551,72 @@ class MozMillRestart(MozMill):</span>
<a href="#l16.461"></a><span id="l16.461">         MozMill.__init__(self, *args, **kwargs)</span>
<a href="#l16.462"></a><span id="l16.462">         self.python_callbacks = []</span>
<a href="#l16.463"></a><span id="l16.463"> </span>
<a href="#l16.464"></a><span id="l16.464">     def add_listener(self, callback, **kwargs):</span>
<a href="#l16.465"></a><span id="l16.465">         self.listeners.append((callback, kwargs,))</span>
<a href="#l16.466"></a><span id="l16.466"> </span>
<a href="#l16.467"></a><span id="l16.467">     def add_global_listener(self, callback):</span>
<a href="#l16.468"></a><span id="l16.468">         self.global_listeners.append(callback)</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineminus">-    </span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+</span>
<a href="#l16.471"></a><span id="l16.471">     def start(self, runner=None, profile=None):</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineminus">-        </span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+</span>
<a href="#l16.474"></a><span id="l16.474">         if not profile:</span>
<a href="#l16.475"></a><span id="l16.475">             profile = self.profile_class(addons=[jsbridge.extension_path, extension_path])</span>
<a href="#l16.476"></a><span id="l16.476">         self.profile = profile</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineminus">-        </span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+</span>
<a href="#l16.479"></a><span id="l16.479">         if not runner:</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineminus">-            runner = self.runner_class(profile=self.profile, </span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+            runner = self.runner_class(profile=self.profile,</span>
<a href="#l16.482"></a><span id="l16.482">                                        cmdargs=[&quot;-jsbridge&quot;, str(self.jsbridge_port)])</span>
<a href="#l16.483"></a><span id="l16.483">         self.runner = runner</span>
<a href="#l16.484"></a><span id="l16.484">         self.endRunnerCalled = False</span>
<a href="#l16.485"></a><span id="l16.485">         self.add_listener(self.firePythonCallback_listener, eventType='mozmill.firePythonCallback')</span>
<a href="#l16.486"></a><span id="l16.486"> </span>
<a href="#l16.487"></a><span id="l16.487">         # set the starttime for the tests</span>
<a href="#l16.488"></a><span id="l16.488">         # XXX assumes run_tests will be called soon after (currently true)</span>
<a href="#l16.489"></a><span id="l16.489">         self.starttime = datetime.utcnow()</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineminus">-     </span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+</span>
<a href="#l16.492"></a><span id="l16.492">     def firePythonCallback_listener(self, obj):</span>
<a href="#l16.493"></a><span id="l16.493">         if obj['fire_now']:</span>
<a href="#l16.494"></a><span id="l16.494">             self.fire_python_callback(obj['method'], obj['arg'], self.python_callbacks_module)</span>
<a href="#l16.495"></a><span id="l16.495">         else:</span>
<a href="#l16.496"></a><span id="l16.496">             self.python_callbacks.append(obj)</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineminus">-        </span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+</span>
<a href="#l16.499"></a><span id="l16.499">     def start_runner(self):</span>
<a href="#l16.500"></a><span id="l16.500"> </span>
<a href="#l16.501"></a><span id="l16.501">         # if user_restart we don't need to start the browser back up</span>
<a href="#l16.502"></a><span id="l16.502">         if self.currentShutdownMode != self.shutdownModes.user_restart:</span>
<a href="#l16.503"></a><span id="l16.503">             self.runner.start()</span>
<a href="#l16.504"></a><span id="l16.504"> </span>
<a href="#l16.505"></a><span id="l16.505">         self.create_network()</span>
<a href="#l16.506"></a><span id="l16.506">         self.appinfo = self.get_appinfo(self.bridge)</span>
<a href="#l16.507"></a><span id="l16.507">         frame = jsbridge.JSObject(self.bridge,</span>
<a href="#l16.508"></a><span id="l16.508">                                   &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.js')&quot;)</span>
<a href="#l16.509"></a><span id="l16.509">         return frame</span>
<a href="#l16.510"></a><span id="l16.510"> </span>
<a href="#l16.511"></a><span id="l16.511">     def run_dir(self, test_dir, sleeptime=0):</span>
<a href="#l16.512"></a><span id="l16.512">         &quot;&quot;&quot;run a directory of restart tests resetting the profile per directory&quot;&quot;&quot;</span>
<a href="#l16.513"></a><span id="l16.513"> </span>
<a href="#l16.514"></a><span id="l16.514">         # TODO:  document this behaviour!</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineminus">-        if os.path.isfile(os.path.join(test_dir, 'testPre.js')):   </span>
<a href="#l16.516"></a><span id="l16.516" class="difflineplus">+        if os.path.isfile(os.path.join(test_dir, 'testPre.js')):</span>
<a href="#l16.517"></a><span id="l16.517">             pre_test = os.path.join(test_dir, 'testPre.js')</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineminus">-            post_test = os.path.join(test_dir, 'testPost.js') </span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+            post_test = os.path.join(test_dir, 'testPost.js')</span>
<a href="#l16.520"></a><span id="l16.520">             if not os.path.exists(pre_test) or not os.path.exists(post_test):</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineminus">-                print &quot;Skipping &quot;+test_dir+&quot; does not contain both pre and post test.&quot;</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+                print &quot;Skipping &quot; + test_dir + &quot; does not contain both pre and post test.&quot;</span>
<a href="#l16.523"></a><span id="l16.523">                 return</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineminus">-            </span>
<a href="#l16.525"></a><span id="l16.525" class="difflineplus">+</span>
<a href="#l16.526"></a><span id="l16.526">             tests = [pre_test, post_test]</span>
<a href="#l16.527"></a><span id="l16.527">         else:</span>
<a href="#l16.528"></a><span id="l16.528">             if not os.path.isfile(os.path.join(test_dir, 'test1.js')):</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineminus">-                print &quot;Skipping &quot;+test_dir+&quot; does not contain any known test file names&quot;</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+                print &quot;Skipping &quot; + test_dir + &quot; does not contain any known test file names&quot;</span>
<a href="#l16.531"></a><span id="l16.531">                 return</span>
<a href="#l16.532"></a><span id="l16.532">             tests = []</span>
<a href="#l16.533"></a><span id="l16.533">             counter = 1</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineminus">-            while os.path.isfile(os.path.join(test_dir, &quot;test&quot;+str(counter)+&quot;.js&quot;)):</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-                tests.append(os.path.join(test_dir, &quot;test&quot;+str(counter)+&quot;.js&quot;))</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+            while os.path.isfile(os.path.join(test_dir, &quot;test&quot; + str(counter) + &quot;.js&quot;)):</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+                tests.append(os.path.join(test_dir, &quot;test&quot; + str(counter) + &quot;.js&quot;))</span>
<a href="#l16.538"></a><span id="l16.538">                 counter += 1</span>
<a href="#l16.539"></a><span id="l16.539"> </span>
<a href="#l16.540"></a><span id="l16.540">         self.add_listener(self.endRunner_listener, eventType='mozmill.endRunner')</span>
<a href="#l16.541"></a><span id="l16.541"> </span>
<a href="#l16.542"></a><span id="l16.542">         if os.path.isfile(os.path.join(test_dir, 'callbacks.py')):</span>
<a href="#l16.543"></a><span id="l16.543">             self.python_callbacks_module = imp.load_source('callbacks', os.path.join(test_dir, 'callbacks.py'))</span>
<a href="#l16.544"></a><span id="l16.544"> </span>
<a href="#l16.545"></a><span id="l16.545">         for test in tests:</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineat">@@ -615,89 +627,88 @@ class MozMillRestart(MozMill):</span>
<a href="#l16.547"></a><span id="l16.547"> </span>
<a href="#l16.548"></a><span id="l16.548">             frame.persisted = self.persisted</span>
<a href="#l16.549"></a><span id="l16.549">             try:</span>
<a href="#l16.550"></a><span id="l16.550">                 frame.runTestFile(test)</span>
<a href="#l16.551"></a><span id="l16.551">                 while not self.endRunnerCalled:</span>
<a href="#l16.552"></a><span id="l16.552">                     sleep(.25)</span>
<a href="#l16.553"></a><span id="l16.553">                 self.currentShutdownMode = self.shutdownModes.default</span>
<a href="#l16.554"></a><span id="l16.554">                 self.stop_runner()</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineminus">-                sleep(2) # Give mozrunner some time to shutdown the browser</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineplus">+                sleep(2)  # Give mozrunner some time to shutdown the browser</span>
<a href="#l16.557"></a><span id="l16.557">             except JSBridgeDisconnectError:</span>
<a href="#l16.558"></a><span id="l16.558">                 if not self.userShutdownEnabled:</span>
<a href="#l16.559"></a><span id="l16.559">                     raise JSBridgeDisconnectError()</span>
<a href="#l16.560"></a><span id="l16.560">             self.userShutdownEnabled = False</span>
<a href="#l16.561"></a><span id="l16.561"> </span>
<a href="#l16.562"></a><span id="l16.562">             for callback in self.python_callbacks:</span>
<a href="#l16.563"></a><span id="l16.563">                 self.fire_python_callback(callback['method'], callback['arg'], self.python_callbacks_module)</span>
<a href="#l16.564"></a><span id="l16.564">             self.python_callbacks = []</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineminus">-        </span>
<a href="#l16.566"></a><span id="l16.566" class="difflineminus">-        self.python_callbacks_module = None    </span>
<a href="#l16.567"></a><span id="l16.567" class="difflineminus">-        </span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineplus">+        self.python_callbacks_module = None</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineplus">+</span>
<a href="#l16.571"></a><span id="l16.571">         # Reset the profile.</span>
<a href="#l16.572"></a><span id="l16.572">         profile = self.runner.profile</span>
<a href="#l16.573"></a><span id="l16.573">         profile.cleanup()</span>
<a href="#l16.574"></a><span id="l16.574">         if profile.create_new:</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineminus">-            profile.profile = profile.create_new_profile(self.runner.binary)                </span>
<a href="#l16.576"></a><span id="l16.576" class="difflineplus">+            profile.profile = profile.create_new_profile(self.runner.binary)</span>
<a href="#l16.577"></a><span id="l16.577">         for addon in profile.addons:</span>
<a href="#l16.578"></a><span id="l16.578">             profile.install_addon(addon)</span>
<a href="#l16.579"></a><span id="l16.579">         if jsbridge.extension_path not in profile.addons:</span>
<a href="#l16.580"></a><span id="l16.580">             profile.install_addon(jsbridge.extension_path)</span>
<a href="#l16.581"></a><span id="l16.581">         if extension_path not in profile.addons:</span>
<a href="#l16.582"></a><span id="l16.582">             profile.install_addon(extension_path)</span>
<a href="#l16.583"></a><span id="l16.583">         profile.set_preferences(profile.preferences)</span>
<a href="#l16.584"></a><span id="l16.584"> </span>
<a href="#l16.585"></a><span id="l16.585">     def find_tests(self, tests):</span>
<a href="#l16.586"></a><span id="l16.586">         files = []</span>
<a href="#l16.587"></a><span id="l16.587"> </span>
<a href="#l16.588"></a><span id="l16.588">         # make sure these are all directories</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineminus">-        not_dir = [ i for i in tests</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineminus">-                    if not os.path.isdir(i) ]</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineplus">+        not_dir = [i for i in tests if not os.path.isdir(i)]</span>
<a href="#l16.592"></a><span id="l16.592">         if not_dir:</span>
<a href="#l16.593"></a><span id="l16.593">             raise IOError('Restart tests must be directories (%s)' % ', '.join(not_dir))</span>
<a href="#l16.594"></a><span id="l16.594"> </span>
<a href="#l16.595"></a><span id="l16.595">         for test_dir in tests:</span>
<a href="#l16.596"></a><span id="l16.596"> </span>
<a href="#l16.597"></a><span id="l16.597">             # tests have to be absolute paths, for some reason</span>
<a href="#l16.598"></a><span id="l16.598">             test_dir = os.path.abspath(test_dir)</span>
<a href="#l16.599"></a><span id="l16.599"> </span>
<a href="#l16.600"></a><span id="l16.600">             # XXX this allows for only one sub-level of test directories</span>
<a href="#l16.601"></a><span id="l16.601">             # is this a spec or a side-effect?</span>
<a href="#l16.602"></a><span id="l16.602">             # If the former, it should be documented</span>
<a href="#l16.603"></a><span id="l16.603">             test_dirs = [os.path.join(test_dir, d)</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineminus">-                         for d in os.listdir(test_dir) </span>
<a href="#l16.605"></a><span id="l16.605" class="difflineplus">+                         for d in os.listdir(test_dir)</span>
<a href="#l16.606"></a><span id="l16.606">                          if d.startswith('test') and os.path.isdir(os.path.join(test_dir, d))]</span>
<a href="#l16.607"></a><span id="l16.607"> </span>
<a href="#l16.608"></a><span id="l16.608">             if len(test_dirs):</span>
<a href="#l16.609"></a><span id="l16.609">                 files.extend(test_dirs)</span>
<a href="#l16.610"></a><span id="l16.610">             else:</span>
<a href="#l16.611"></a><span id="l16.611">                 files.append(test_dir)</span>
<a href="#l16.612"></a><span id="l16.612"> </span>
<a href="#l16.613"></a><span id="l16.613">         return files</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineminus">-    </span>
<a href="#l16.615"></a><span id="l16.615" class="difflineplus">+</span>
<a href="#l16.616"></a><span id="l16.616">     def run_tests(self, tests, sleeptime=0):</span>
<a href="#l16.617"></a><span id="l16.617"> </span>
<a href="#l16.618"></a><span id="l16.618">         test_dirs = self.find_tests(tests)</span>
<a href="#l16.619"></a><span id="l16.619">         self.tests.extend(test_dirs)</span>
<a href="#l16.620"></a><span id="l16.620"> </span>
<a href="#l16.621"></a><span id="l16.621">         for test_dir in test_dirs:</span>
<a href="#l16.622"></a><span id="l16.622">             self.run_dir(test_dir, sleeptime)</span>
<a href="#l16.623"></a><span id="l16.623"> </span>
<a href="#l16.624"></a><span id="l16.624">         # cleanup the profile</span>
<a href="#l16.625"></a><span id="l16.625">         self.runner.cleanup()</span>
<a href="#l16.626"></a><span id="l16.626"> </span>
<a href="#l16.627"></a><span id="l16.627">         # Give a second for any pending callbacks to finish</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineminus">-        sleep(1) </span>
<a href="#l16.629"></a><span id="l16.629" class="difflineplus">+        sleep(1)</span>
<a href="#l16.630"></a><span id="l16.630"> </span>
<a href="#l16.631"></a><span id="l16.631">     def stop(self, fatal=False):</span>
<a href="#l16.632"></a><span id="l16.632">         &quot;&quot;&quot;MozmillRestart doesn't need to do cleanup as this is already done per directory&quot;&quot;&quot;</span>
<a href="#l16.633"></a><span id="l16.633"> </span>
<a href="#l16.634"></a><span id="l16.634">         # XXX this is a one-off to fix bug 581733</span>
<a href="#l16.635"></a><span id="l16.635">         # really, the entire shutdown sequence should be reconsidered and</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineminus">-        # made more robust. </span>
<a href="#l16.637"></a><span id="l16.637" class="difflineplus">+        # made more robust.</span>
<a href="#l16.638"></a><span id="l16.638">         # See https://bugzilla.mozilla.org/show_bug.cgi?id=581733#c20</span>
<a href="#l16.639"></a><span id="l16.639">         # This will *NOT* work with all edge cases and it shouldn't be</span>
<a href="#l16.640"></a><span id="l16.640">         # expected that adding on more kills() for each edge case will ever</span>
<a href="#l16.641"></a><span id="l16.641">         # be able to fix a systematic issue by patching holes</span>
<a href="#l16.642"></a><span id="l16.642">         if fatal:</span>
<a href="#l16.643"></a><span id="l16.643">             self.runner.cleanup()</span>
<a href="#l16.644"></a><span id="l16.644"> </span>
<a href="#l16.645"></a><span id="l16.645"> </span>
<a href="#l16.646"></a><span id="l16.646" class="difflineat">@@ -709,17 +720,17 @@ class CLI(jsbridge.CLI):</span>
<a href="#l16.647"></a><span id="l16.647">         jsbridge.CLI.add_options(self, parser)</span>
<a href="#l16.648"></a><span id="l16.648">         parser.add_option(&quot;-t&quot;, &quot;--test&quot;, dest=&quot;test&quot;, action='append',</span>
<a href="#l16.649"></a><span id="l16.649">                           default=[],</span>
<a href="#l16.650"></a><span id="l16.650">                           help=&quot;Run test&quot;)</span>
<a href="#l16.651"></a><span id="l16.651">         parser.add_option(&quot;-l&quot;, &quot;--logfile&quot;, dest=&quot;logfile&quot;,</span>
<a href="#l16.652"></a><span id="l16.652">                           default=None,</span>
<a href="#l16.653"></a><span id="l16.653">                           help=&quot;Log all events to file.&quot;)</span>
<a href="#l16.654"></a><span id="l16.654">         parser.add_option(&quot;--show-errors&quot;, dest=&quot;showerrors&quot;,</span>
<a href="#l16.655"></a><span id="l16.655" class="difflineminus">-                          default=False, </span>
<a href="#l16.656"></a><span id="l16.656" class="difflineplus">+                          default=False,</span>
<a href="#l16.657"></a><span id="l16.657">                           action=&quot;store_true&quot;,</span>
<a href="#l16.658"></a><span id="l16.658">                           help=&quot;Print logger errors to the console.&quot;)</span>
<a href="#l16.659"></a><span id="l16.659">         parser.add_option(&quot;--report&quot;, dest=&quot;report&quot;, default=False,</span>
<a href="#l16.660"></a><span id="l16.660">                           help=&quot;Report the results. Requires url to results server. Use 'stdout' for stdout.&quot;)</span>
<a href="#l16.661"></a><span id="l16.661">         parser.add_option(&quot;--show-all&quot;, dest=&quot;showall&quot;, default=False,</span>
<a href="#l16.662"></a><span id="l16.662">                           action=&quot;store_true&quot;,</span>
<a href="#l16.663"></a><span id="l16.663">                           help=&quot;Show all test output.&quot;)</span>
<a href="#l16.664"></a><span id="l16.664">         parser.add_option(&quot;--timeout&quot;, dest=&quot;timeout&quot;, type=&quot;float&quot;,</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineat">@@ -736,26 +747,28 @@ class CLI(jsbridge.CLI):</span>
<a href="#l16.666"></a><span id="l16.666">                                           jsbridge_port=int(self.options.port),</span>
<a href="#l16.667"></a><span id="l16.667">                                           jsbridge_timeout=self.options.timeout,</span>
<a href="#l16.668"></a><span id="l16.668">                                           )</span>
<a href="#l16.669"></a><span id="l16.669"> </span>
<a href="#l16.670"></a><span id="l16.670">         self.tests = []</span>
<a href="#l16.671"></a><span id="l16.671"> </span>
<a href="#l16.672"></a><span id="l16.672">         # setup log formatting</span>
<a href="#l16.673"></a><span id="l16.673">         self.mozmill.add_global_listener(LoggerListener())</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineminus">-        log_options = { 'format': &quot;%(levelname)s | %(message)s&quot;,</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineminus">-                        'level': logging.CRITICAL }</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineplus">+        log_options = {</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineplus">+            'format': &quot;%(levelname)s | %(message)s&quot;,</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineplus">+            'level': logging.CRITICAL,</span>
<a href="#l16.679"></a><span id="l16.679" class="difflineplus">+        }</span>
<a href="#l16.680"></a><span id="l16.680">         if self.options.showerrors:</span>
<a href="#l16.681"></a><span id="l16.681">             log_options['level'] = logging.ERROR</span>
<a href="#l16.682"></a><span id="l16.682">         if self.options.logfile:</span>
<a href="#l16.683"></a><span id="l16.683">             log_options['filename'] = self.options.logfile</span>
<a href="#l16.684"></a><span id="l16.684">             log_options['filemode'] = 'w'</span>
<a href="#l16.685"></a><span id="l16.685">             log_options['level'] = logging.DEBUG</span>
<a href="#l16.686"></a><span id="l16.686">         if self.options.test and self.options.showall:</span>
<a href="#l16.687"></a><span id="l16.687" class="difflineminus">-            log_options['level'] = logging.DEBUG    </span>
<a href="#l16.688"></a><span id="l16.688" class="difflineplus">+            log_options['level'] = logging.DEBUG</span>
<a href="#l16.689"></a><span id="l16.689">         logging.basicConfig(**log_options)</span>
<a href="#l16.690"></a><span id="l16.690"> </span>
<a href="#l16.691"></a><span id="l16.691">     def profile_args(self):</span>
<a href="#l16.692"></a><span id="l16.692">         profargs = super(CLI, self).profile_args()</span>
<a href="#l16.693"></a><span id="l16.693">         profargs.setdefault('addons', []).append(extension_path)</span>
<a href="#l16.694"></a><span id="l16.694">         return profargs</span>
<a href="#l16.695"></a><span id="l16.695"> </span>
<a href="#l16.696"></a><span id="l16.696">     def run(self):</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineat">@@ -765,22 +778,21 @@ class CLI(jsbridge.CLI):</span>
<a href="#l16.698"></a><span id="l16.698">             manifest_parser = manifestparser.TestManifest(manifests=self.options.manifests)</span>
<a href="#l16.699"></a><span id="l16.699"> </span>
<a href="#l16.700"></a><span id="l16.700">             self.tests.extend(manifest_parser.test_paths())</span>
<a href="#l16.701"></a><span id="l16.701"> </span>
<a href="#l16.702"></a><span id="l16.702">         # expand user directory for individual tests</span>
<a href="#l16.703"></a><span id="l16.703">         for test in self.options.test:</span>
<a href="#l16.704"></a><span id="l16.704">             test = os.path.expanduser(test)</span>
<a href="#l16.705"></a><span id="l16.705">             self.tests.append(test)</span>
<a href="#l16.706"></a><span id="l16.706" class="difflineminus">-                </span>
<a href="#l16.707"></a><span id="l16.707" class="difflineplus">+</span>
<a href="#l16.708"></a><span id="l16.708">         # check existence for the tests</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineminus">-        missing = [ test for test in self.tests</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineminus">-                    if not os.path.exists(test) ]</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineplus">+        missing = [test_ for test_ in self.tests if not os.path.exists(test)]</span>
<a href="#l16.712"></a><span id="l16.712">         if missing:</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineminus">-            raise IOError(&quot;Not a valid test file/directory: %s&quot; % ', '.join([&quot;'%s'&quot; % test for test in missing]))</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineplus">+            raise IOError(&quot;Not a valid test file/directory: %s&quot; % ', '.join([&quot;'%s'&quot; % test_ for test_ in missing]))</span>
<a href="#l16.715"></a><span id="l16.715"> </span>
<a href="#l16.716"></a><span id="l16.716">         # create a Mozrunner</span>
<a href="#l16.717"></a><span id="l16.717">         runner = self.create_runner()</span>
<a href="#l16.718"></a><span id="l16.718"> </span>
<a href="#l16.719"></a><span id="l16.719">         runner.cmdargs.extend(self.options.appArgs)</span>
<a href="#l16.720"></a><span id="l16.720"> </span>
<a href="#l16.721"></a><span id="l16.721">         # make sure the application starts in the foreground</span>
<a href="#l16.722"></a><span id="l16.722">         if '-foreground' not in runner.cmdargs:</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineat">@@ -796,29 +808,29 @@ class CLI(jsbridge.CLI):</span>
<a href="#l16.724"></a><span id="l16.724"> </span>
<a href="#l16.725"></a><span id="l16.725">             # run the tests</span>
<a href="#l16.726"></a><span id="l16.726">             disconnected = False</span>
<a href="#l16.727"></a><span id="l16.727">             try:</span>
<a href="#l16.728"></a><span id="l16.728">                 self.mozmill.run_tests(self.tests)</span>
<a href="#l16.729"></a><span id="l16.729">             except JSBridgeDisconnectError:</span>
<a href="#l16.730"></a><span id="l16.730">                 disconnected = True</span>
<a href="#l16.731"></a><span id="l16.731">                 if not self.mozmill.userShutdownEnabled:</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineminus">-                    self.mozmill.report_disconnect()               </span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+                    self.mozmill.report_disconnect()</span>
<a href="#l16.734"></a><span id="l16.734">                     print 'TEST-UNEXPECTED-FAIL | Disconnect Error: Application unexpectedly closed'</span>
<a href="#l16.735"></a><span id="l16.735">                 runner.cleanup()</span>
<a href="#l16.736"></a><span id="l16.736">             except:</span>
<a href="#l16.737"></a><span id="l16.737">                 runner.cleanup()</span>
<a href="#l16.738"></a><span id="l16.738">                 raise</span>
<a href="#l16.739"></a><span id="l16.739"> </span>
<a href="#l16.740"></a><span id="l16.740">             # shutdown the test harness</span>
<a href="#l16.741"></a><span id="l16.741">             self.mozmill.stop(fatal=disconnected)</span>
<a href="#l16.742"></a><span id="l16.742"> </span>
<a href="#l16.743"></a><span id="l16.743">             # print statistics and send the JSON report</span>
<a href="#l16.744"></a><span id="l16.744">             self.mozmill.report(self.options.report)</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineminus">-            </span>
<a href="#l16.746"></a><span id="l16.746" class="difflineplus">+</span>
<a href="#l16.747"></a><span id="l16.747">             if self.mozmill.fails or disconnected:</span>
<a href="#l16.748"></a><span id="l16.748">                 sys.exit(1)</span>
<a href="#l16.749"></a><span id="l16.749">         else:</span>
<a href="#l16.750"></a><span id="l16.750">             if self.options.shell:</span>
<a href="#l16.751"></a><span id="l16.751">                 self.start_shell(runner)</span>
<a href="#l16.752"></a><span id="l16.752">             else:</span>
<a href="#l16.753"></a><span id="l16.753">                 try:</span>
<a href="#l16.754"></a><span id="l16.754">                     if not hasattr(runner, 'process_handler'):</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineat">@@ -834,27 +846,33 @@ class CLI(jsbridge.CLI):</span>
<a href="#l16.756"></a><span id="l16.756"> class RestartCLI(CLI):</span>
<a href="#l16.757"></a><span id="l16.757">     mozmill_class = MozMillRestart</span>
<a href="#l16.758"></a><span id="l16.758"> </span>
<a href="#l16.759"></a><span id="l16.759"> </span>
<a href="#l16.760"></a><span id="l16.760"> class ThunderbirdCLI(CLI):</span>
<a href="#l16.761"></a><span id="l16.761">     profile_class = mozprofile.ThunderbirdProfile</span>
<a href="#l16.762"></a><span id="l16.762">     runner_class = mozrunner.ThunderbirdRunner</span>
<a href="#l16.763"></a><span id="l16.763"> </span>
<a href="#l16.764"></a><span id="l16.764" class="difflineplus">+</span>
<a href="#l16.765"></a><span id="l16.765"> class ThunderbirdRestartCLI(RestartCLI):</span>
<a href="#l16.766"></a><span id="l16.766">     profile_class = mozprofile.ThunderbirdProfile</span>
<a href="#l16.767"></a><span id="l16.767">     runner_class = mozrunner.ThunderbirdRunner</span>
<a href="#l16.768"></a><span id="l16.768"> </span>
<a href="#l16.769"></a><span id="l16.769" class="difflineplus">+</span>
<a href="#l16.770"></a><span id="l16.770"> def enum(*sequential, **named):</span>
<a href="#l16.771"></a><span id="l16.771">     enums = dict(zip(sequential, range(len(sequential))), **named)</span>
<a href="#l16.772"></a><span id="l16.772">     return type('Enum', (), enums)</span>
<a href="#l16.773"></a><span id="l16.773"> </span>
<a href="#l16.774"></a><span id="l16.774" class="difflineplus">+</span>
<a href="#l16.775"></a><span id="l16.775"> def cli():</span>
<a href="#l16.776"></a><span id="l16.776">     CLI().run()</span>
<a href="#l16.777"></a><span id="l16.777"> </span>
<a href="#l16.778"></a><span id="l16.778" class="difflineplus">+</span>
<a href="#l16.779"></a><span id="l16.779"> def tbird_cli():</span>
<a href="#l16.780"></a><span id="l16.780">     ThunderbirdCLI().run()</span>
<a href="#l16.781"></a><span id="l16.781"> </span>
<a href="#l16.782"></a><span id="l16.782" class="difflineplus">+</span>
<a href="#l16.783"></a><span id="l16.783"> def restart_cli():</span>
<a href="#l16.784"></a><span id="l16.784">     RestartCLI().run()</span>
<a href="#l16.785"></a><span id="l16.785"> </span>
<a href="#l16.786"></a><span id="l16.786" class="difflineplus">+</span>
<a href="#l16.787"></a><span id="l16.787"> def tbird_restart_cli():</span>
<a href="#l16.788"></a><span id="l16.788">     ThunderbirdRestartCLI().run()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/resources/mozmill/setup.py</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/resources/mozmill/setup.py</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -48,28 +48,33 @@ setup(name=PACKAGE_NAME,</span>
<a href="#l17.4"></a><span id="l17.4">       description=desc,</span>
<a href="#l17.5"></a><span id="l17.5">       long_description=summ,</span>
<a href="#l17.6"></a><span id="l17.6">       author='Mozilla, Mikeal Rogers',</span>
<a href="#l17.7"></a><span id="l17.7">       author_email='mikeal.rogers@gmail.com',</span>
<a href="#l17.8"></a><span id="l17.8">       url='http://github.com/mozautomation/mozmill',</span>
<a href="#l17.9"></a><span id="l17.9">       license='http://www.apache.org/licenses/LICENSE-2.0',</span>
<a href="#l17.10"></a><span id="l17.10">       packages=find_packages(exclude=['test']),</span>
<a href="#l17.11"></a><span id="l17.11">       include_package_data=True,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-      package_data = {'': ['*.js', '*.css', '*.html', '*.txt', '*.xpi', '*.rdf', '*.xul', '*.jsm', '*.xml'],},</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+      package_data={</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+          '': ['*.js', '*.css', '*.html', '*.txt', '*.xpi', '*.rdf', '*.xul', '*.jsm', '*.xml'],</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+      },</span>
<a href="#l17.16"></a><span id="l17.16">       zip_safe=False,</span>
<a href="#l17.17"></a><span id="l17.17">       entry_points=&quot;&quot;&quot;</span>
<a href="#l17.18"></a><span id="l17.18">           [console_scripts]</span>
<a href="#l17.19"></a><span id="l17.19">           mozmill = mozmill:cli</span>
<a href="#l17.20"></a><span id="l17.20">           mozmill-thunderbird = mozmill:tbird_cli</span>
<a href="#l17.21"></a><span id="l17.21">           mozmill-restart = mozmill:restart_cli</span>
<a href="#l17.22"></a><span id="l17.22">         &quot;&quot;&quot;,</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-      platforms =['Any'],</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-      install_requires = ['jsbridge == 2.4.15',</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-                          'mozrunner &gt;= 6.0',</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-                          'manifestparser &gt;= 0.9'],</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-      classifiers=['Development Status :: 4 - Beta',</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-                   'Environment :: Console',</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-                   'Intended Audience :: Developers',</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-                   'License :: OSI Approved :: Apache Software License',</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-                   'Operating System :: OS Independent',</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-                   'Topic :: Software Development :: Libraries :: Python Modules',</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-                  ]</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-     )</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+      platforms=['Any'],</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+      install_requires=[</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+          'jsbridge == 2.4.15',</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+          'mozrunner &gt;= 6.0',</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+          'manifestparser &gt;= 0.9'</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+      ],</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+      classifiers=[</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+          'Development Status :: 4 - Beta',</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+          'Environment :: Console',</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+          'Intended Audience :: Developers',</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+          'License :: OSI Approved :: Apache Software License',</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+          'Operating System :: OS Independent',</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+          'Topic :: Software Development :: Libraries :: Python Modules',</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+      ]</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+      )</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

