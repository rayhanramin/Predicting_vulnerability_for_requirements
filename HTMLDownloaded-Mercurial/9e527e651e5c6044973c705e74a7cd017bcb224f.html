<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26460:9e527e651e5c6044973c705e74a7cd017bcb224f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9e527e651e5c6044973c705e74a7cd017bcb224f" />
<meta property="og:url" content="/comm-central/rev/9e527e651e5c6044973c705e74a7cd017bcb224f" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/news. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9e527e651e5c6044973c705e74a7cd017bcb224f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9e527e651e5c6044973c705e74a7cd017bcb224f">shortlog</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9e527e651e5c6044973c705e74a7cd017bcb224f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f">files</a> |
changeset |
<a href="/comm-central/raw-rev/9e527e651e5c6044973c705e74a7cd017bcb224f">raw</a>  | <a href="/comm-central/archive/9e527e651e5c6044973c705e74a7cd017bcb224f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/news. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 26 Apr 2019 11:48:27 +0200</td></tr>

<tr>
 <td>changeset 26460</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9e527e651e5c6044973c705e74a7cd017bcb224f">9e527e651e5c6044973c705e74a7cd017bcb224f</a></td>
</tr>



<tr>
<td>parent 26459</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2458408cc87e8c3127ecab8b88a734ba45abcd7d">2458408cc87e8c3127ecab8b88a734ba45abcd7d</a>
</td>
</tr>

<tr>
<td>child 26461</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9dda6f78d5adea30f00e04659451a9bca6478841">9dda6f78d5adea30f00e04659451a9bca6478841</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9e527e651e5c6044973c705e74a7cd017bcb224f">15841</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 26 Apr 2019 10:00:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dc7943c0ecc9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dc7943c0ecc96b6565b45878a80150944941ac1a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dc7943c0ecc96b6565b45878a80150944941ac1a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dc7943c0ecc96b6565b45878a80150944941ac1a&newProject=comm-central&newRevision=9e527e651e5c6044973c705e74a7cd017bcb224f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dc7943c0ecc96b6565b45878a80150944941ac1a&newProject=comm-central&newRevision=9e527e651e5c6044973c705e74a7cd017bcb224f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dc7943c0ecc96b6565b45878a80150944941ac1a&newProject=comm-central&newRevision=9e527e651e5c6044973c705e74a7cd017bcb224f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/news. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/public/nsMsgNewsCID.h">mailnews/news/public/nsMsgNewsCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/public/nsMsgNewsCID.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/public/nsMsgNewsCID.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/public/nsMsgNewsCID.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/public/nsMsgNewsCID.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/public/nsMsgNewsCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nntpCore.h">mailnews/news/src/nntpCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nntpCore.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nntpCore.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nntpCore.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nntpCore.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nntpCore.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.cpp">mailnews/news/src/nsNNTPArticleList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.h">mailnews/news/src/nsNNTPArticleList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPArticleList.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.h">mailnews/news/src/nsNNTPNewsgroupList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupList.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.cpp">mailnews/news/src/nsNNTPNewsgroupPost.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.h">mailnews/news/src/nsNNTPNewsgroupPost.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPNewsgroupPost.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.h">mailnews/news/src/nsNNTPProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNNTPProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.cpp">mailnews/news/src/nsNewsDownloadDialogArgs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.h">mailnews/news/src/nsNewsDownloadDialogArgs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloadDialogArgs.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.cpp">mailnews/news/src/nsNewsDownloader.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.h">mailnews/news/src/nsNewsDownloader.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsDownloader.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.h">mailnews/news/src/nsNewsFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.cpp">mailnews/news/src/nsNewsUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.h">mailnews/news/src/nsNewsUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNewsUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.h">mailnews/news/src/nsNntpIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.cpp">mailnews/news/src/nsNntpMockChannel.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.h">mailnews/news/src/nsNntpMockChannel.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpMockChannel.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.h">mailnews/news/src/nsNntpService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.cpp">mailnews/news/src/nsNntpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.cpp">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.cpp">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.h">mailnews/news/src/nsNntpUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.h">file</a> |
<a href="/comm-central/annotate/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.h">annotate</a> |
<a href="/comm-central/diff/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.h">diff</a> |
<a href="/comm-central/comparison/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.h">comparison</a> |
<a href="/comm-central/log/9e527e651e5c6044973c705e74a7cd017bcb224f/mailnews/news/src/nsNntpUrl.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/news/public/nsMsgNewsCID.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/news/public/nsMsgNewsCID.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -10,108 +10,115 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIFactory.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> //</span>
<a href="#l1.9"></a><span id="l1.9"> // nsMsgNewsFolder</span>
<a href="#l1.10"></a><span id="l1.10"> #define NS_NEWSFOLDERRESOURCE_CONTRACTID \</span>
<a href="#l1.11"></a><span id="l1.11">   NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX &quot;news&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#define NS_NEWSFOLDERRESOURCE_CID                      \</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{ /* 4ace448a-f6d4-11d2-880d-004005263078 */           \</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">- 0x4ace448a, 0xf6d4, 0x11d2,         \</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">- {0x88, 0x0d, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78}   \</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-}</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+#define NS_NEWSFOLDERRESOURCE_CID                    \</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  { /* 4ace448a-f6d4-11d2-880d-004005263078 */       \</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    0x4ace448a, 0xf6d4, 0x11d2, {                    \</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+      0x88, 0x0d, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78 \</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    }                                                \</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> //</span>
<a href="#l1.25"></a><span id="l1.25"> // nsNntpIncomingServer</span>
<a href="#l1.26"></a><span id="l1.26"> //</span>
<a href="#l1.27"></a><span id="l1.27"> #define NS_NNTPINCOMINGSERVER_CONTRACTID \</span>
<a href="#l1.28"></a><span id="l1.28">   NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX &quot;nntp&quot;</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-#define NS_NNTPINCOMINGSERVER_CID       \</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-{ /* 6ff28d0a-f776-11d2-87ca-004005263078 */     \</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">- 0x6ff28d0a, 0xf776, 0x11d2,         \</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">- {0x87, 0xca, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78}   \</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-}</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+#define NS_NNTPINCOMINGSERVER_CID                    \</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  { /* 6ff28d0a-f776-11d2-87ca-004005263078 */       \</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    0x6ff28d0a, 0xf776, 0x11d2, {                    \</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+      0x87, 0xca, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78 \</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    }                                                \</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42"> //</span>
<a href="#l1.43"></a><span id="l1.43"> // nsNntpService</span>
<a href="#l1.44"></a><span id="l1.44"> //</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-#define NS_NNTPPROTOCOLINFO_CONTRACTID    \</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+#define NS_NNTPPROTOCOLINFO_CONTRACTID \</span>
<a href="#l1.48"></a><span id="l1.48">   NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX &quot;nntp&quot;</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50"> #define NS_NEWSPROTOCOLHANDLER_CONTRACTID \</span>
<a href="#l1.51"></a><span id="l1.51">   NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;news&quot;</span>
<a href="#l1.52"></a><span id="l1.52"> #define NS_SNEWSPROTOCOLHANDLER_CONTRACTID \</span>
<a href="#l1.53"></a><span id="l1.53">   NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;snews&quot;</span>
<a href="#l1.54"></a><span id="l1.54"> #define NS_NNTPPROTOCOLHANDLER_CONTRACTID \</span>
<a href="#l1.55"></a><span id="l1.55">   NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;nntp&quot;</span>
<a href="#l1.56"></a><span id="l1.56"> #define NS_NEWSMESSAGESERVICE_CONTRACTID \</span>
<a href="#l1.57"></a><span id="l1.57">   &quot;@mozilla.org/messenger/messageservice;1?type=news-message&quot;</span>
<a href="#l1.58"></a><span id="l1.58"> #define NS_NNTPMESSAGESERVICE_CONTRACTID \</span>
<a href="#l1.59"></a><span id="l1.59">   &quot;@mozilla.org/messenger/messageservice;1?type=news&quot;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-#define NS_NNTPSERVICE_CONTRACTID \</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  &quot;@mozilla.org/messenger/nntpservice;1&quot;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+#define NS_NNTPSERVICE_CONTRACTID &quot;@mozilla.org/messenger/nntpservice;1&quot;</span>
<a href="#l1.63"></a><span id="l1.63"> #define NS_NEWSSTARTUPHANDLER_CONTRACTID \</span>
<a href="#l1.64"></a><span id="l1.64">   &quot;@mozilla.org/commandlinehandler/general-startup;1?type=news&quot;</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-#define NS_NNTPSERVICE_CID                              \</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-{ /* 4C9F90E1-E19B-11d2-806E-006008128C4E */      \</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">- 0x4c9f90e1, 0xe19b, 0x11d2,                            \</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">- {0x80, 0x6e, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e}   \</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-}</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+#define NS_NNTPSERVICE_CID                         \</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  { /* 4C9F90E1-E19B-11d2-806E-006008128C4E */     \</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+    0x4c9f90e1, 0xe19b, 0x11d2, {                  \</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+      0x80, 0x6e, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    }                                              \</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  }</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78"> //</span>
<a href="#l1.79"></a><span id="l1.79"> // nsNNTPNewsgroupPost</span>
<a href="#l1.80"></a><span id="l1.80"> //</span>
<a href="#l1.81"></a><span id="l1.81"> #define NS_NNTPNEWSGROUPPOST_CONTRACTID \</span>
<a href="#l1.82"></a><span id="l1.82">   &quot;@mozilla.org/messenger/nntpnewsgrouppost;1&quot;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-#define NS_NNTPNEWSGROUPPOST_CID  \</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-{ /* 30c60228-187e-11d3-842f-004005263078 */ \</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">- 0x30c60228, 0x187e, 0x11d3, \</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">- {0x84, 0x2f, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78} \</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-}</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+#define NS_NNTPNEWSGROUPPOST_CID                     \</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  { /* 30c60228-187e-11d3-842f-004005263078 */       \</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    0x30c60228, 0x187e, 0x11d3, {                    \</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+      0x84, 0x2f, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78 \</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+    }                                                \</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+  }</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95"> //</span>
<a href="#l1.96"></a><span id="l1.96"> // nsNNTPNewsgroupList</span>
<a href="#l1.97"></a><span id="l1.97"> //</span>
<a href="#l1.98"></a><span id="l1.98"> #define NS_NNTPNEWSGROUPLIST_CONTRACTID \</span>
<a href="#l1.99"></a><span id="l1.99">   &quot;@mozilla.org/messenger/nntpnewsgrouplist;1&quot;</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-#define NS_NNTPNEWSGROUPLIST_CID \</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-{ /* 631e9054-1893-11d3-9916-004005263078 */ \</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">- 0x631e9054, 0x1893, 0x11d3, \</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">- {0x99, 0x16, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78} \</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-}</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+#define NS_NNTPNEWSGROUPLIST_CID                     \</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+  { /* 631e9054-1893-11d3-9916-004005263078 */       \</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    0x631e9054, 0x1893, 0x11d3, {                    \</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+      0x99, 0x16, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78 \</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    }                                                \</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+  }</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112"> //</span>
<a href="#l1.113"></a><span id="l1.113"> // nsNNTPArticleList</span>
<a href="#l1.114"></a><span id="l1.114"> //</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-#define NS_NNTPARTICLELIST_CONTRACTID \</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-  &quot;@mozilla.org/messenger/nntparticlelist;1&quot;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-#define NS_NNTPARTICLELIST_CID  \</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-{ /* 9f12bdf0-189f-11d3-973e-00805f916fd3 */ \</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">- 0x9f12bdf0, 0x189f, 0x11d3, \</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">- {0x97, 0x3e, 0x00, 0x80, 0x5f, 0x91, 0x6f, 0xd3} \</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-}</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+#define NS_NNTPARTICLELIST_CONTRACTID &quot;@mozilla.org/messenger/nntparticlelist;1&quot;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+#define NS_NNTPARTICLELIST_CID                       \</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  { /* 9f12bdf0-189f-11d3-973e-00805f916fd3 */       \</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    0x9f12bdf0, 0x189f, 0x11d3, {                    \</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+      0x97, 0x3e, 0x00, 0x80, 0x5f, 0x91, 0x6f, 0xd3 \</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    }                                                \</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  }</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130"> //</span>
<a href="#l1.131"></a><span id="l1.131"> // nsNntpUrl</span>
<a href="#l1.132"></a><span id="l1.132"> //</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-#define NS_NNTPURL_CONTRACTID \</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  &quot;@mozilla.org/messenger/nntpurl;1&quot;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-#define NS_NNTPURL_CID                  \</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-{ /* 196B4B30-E18C-11d2-806E-006008128C4E */      \</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-  0x196b4b30, 0xe18c, 0x11d2,              \</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    { 0x80, 0x6e, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e } }</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+#define NS_NNTPURL_CONTRACTID &quot;@mozilla.org/messenger/nntpurl;1&quot;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+#define NS_NNTPURL_CID                             \</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  { /* 196B4B30-E18C-11d2-806E-006008128C4E */     \</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+    0x196b4b30, 0xe18c, 0x11d2, {                  \</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+      0x80, 0x6e, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    }                                              \</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+  }</span>
<a href="#l1.146"></a><span id="l1.146"> </span>
<a href="#l1.147"></a><span id="l1.147"> //</span>
<a href="#l1.148"></a><span id="l1.148"> // nsNewsDownloadDialogArgs</span>
<a href="#l1.149"></a><span id="l1.149"> //</span>
<a href="#l1.150"></a><span id="l1.150"> #define NS_NEWSDOWNLOADDIALOGARGS_CONTRACTID \</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-   &quot;@mozilla.org/messenger/newsdownloaddialogargs;1&quot;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-#define NS_NEWSDOWNLOADDIALOGARGS_CID   \</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-{ /* 1540689e-1dd2-11b2-933d-f0d1e460ef4a */    \</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-  0x1540689e, 0x1dd2, 0x11b2,   \</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-    { 0x93, 0x3d, 0xf0, 0xd1, 0xe4, 0x60, 0xef, 0x4a} }</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+  &quot;@mozilla.org/messenger/newsdownloaddialogargs;1&quot;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+#define NS_NEWSDOWNLOADDIALOGARGS_CID                \</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+  { /* 1540689e-1dd2-11b2-933d-f0d1e460ef4a */       \</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    0x1540689e, 0x1dd2, 0x11b2, {                    \</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+      0x93, 0x3d, 0xf0, 0xd1, 0xe4, 0x60, 0xef, 0x4a \</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+    }                                                \</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  }</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-#endif // nsMsgNewsCID_h__</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+#endif  // nsMsgNewsCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/news/src/nntpCore.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/news/src/nntpCore.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,28 +1,29 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l2.5"></a><span id="l2.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> #ifndef _NNTPCore_H__</span>
<a href="#l2.10"></a><span id="l2.10"> #define _NNTPCore_H__</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define NEWS_MSGS_URL       &quot;chrome://messenger/locale/news.properties&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#define NEWS_MSGS_URL &quot;chrome://messenger/locale/news.properties&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-// The following string constants are protocol strings. I'm defining them as macros here</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-// so I don't have to sprinkle all of the strings throughout the protocol.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-#define NNTP_CMD_LIST_EXTENSIONS    &quot;LIST EXTENSIONS&quot; CRLF</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-#define NNTP_CMD_MODE_READER      &quot;MODE READER&quot; CRLF</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-#define NNTP_CMD_LIST_SEARCHES      &quot;LIST SEARCHES&quot; CRLF</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-#define NNTP_CMD_LIST_SEARCH_FIELDS     &quot;LIST SRCHFIELDS&quot; CRLF</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-#define NNTP_CMD_GET_PROPERTIES         &quot;GET&quot; CRLF</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-#define NNTP_CMD_LIST_SUBSCRIPTIONS     &quot;LIST SUBSCRIPTIONS&quot; CRLF</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-#define NNTP_CMD_POST        &quot;POST&quot; CRLF</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-#define NNTP_CMD_QUIT        &quot;QUIT&quot; CRLF</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+// The following string constants are protocol strings. I'm defining them as</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+// macros here so I don't have to sprinkle all of the strings throughout the</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+// protocol.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+#define NNTP_CMD_LIST_EXTENSIONS &quot;LIST EXTENSIONS&quot; CRLF</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+#define NNTP_CMD_MODE_READER &quot;MODE READER&quot; CRLF</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+#define NNTP_CMD_LIST_SEARCHES &quot;LIST SEARCHES&quot; CRLF</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+#define NNTP_CMD_LIST_SEARCH_FIELDS &quot;LIST SRCHFIELDS&quot; CRLF</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+#define NNTP_CMD_GET_PROPERTIES &quot;GET&quot; CRLF</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+#define NNTP_CMD_LIST_SUBSCRIPTIONS &quot;LIST SUBSCRIPTIONS&quot; CRLF</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+#define NNTP_CMD_POST &quot;POST&quot; CRLF</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+#define NNTP_CMD_QUIT &quot;QUIT&quot; CRLF</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37"> // end of protocol strings</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> #define MK_NNTP_RESPONSE_HELP 100</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41"> #define MK_NNTP_RESPONSE_POSTING_ALLOWED 200</span>
<a href="#l2.42"></a><span id="l2.42"> #define MK_NNTP_RESPONSE_POSTING_DENIED 201</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44" class="difflineat">@@ -37,127 +38,128 @@</span>
<a href="#l2.45"></a><span id="l2.45"> #define MK_NNTP_RESPONSE_ARTICLE_HEAD 221</span>
<a href="#l2.46"></a><span id="l2.46"> #define MK_NNTP_RESPONSE_ARTICLE_BODY 222</span>
<a href="#l2.47"></a><span id="l2.47"> #define MK_NNTP_RESPONSE_ARTICLE_NONE 223</span>
<a href="#l2.48"></a><span id="l2.48"> #define MK_NNTP_RESPONSE_ARTICLE_NO_GROUP 412</span>
<a href="#l2.49"></a><span id="l2.49"> #define MK_NNTP_RESPONSE_ARTICLE_NO_CURRENT 420</span>
<a href="#l2.50"></a><span id="l2.50"> #define MK_NNTP_RESPONSE_ARTICLE_NONEXIST 423</span>
<a href="#l2.51"></a><span id="l2.51"> #define MK_NNTP_RESPONSE_ARTICLE_NOTFOUND 430</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-#define MK_NNTP_RESPONSE_GROUP_SELECTED   211</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-#define MK_NNTP_RESPONSE_GROUP_NO_GROUP   411</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+#define MK_NNTP_RESPONSE_GROUP_SELECTED 211</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+#define MK_NNTP_RESPONSE_GROUP_NO_GROUP 411</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-#define MK_NNTP_RESPONSE_IHAVE_OK         235</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-#define MK_NNTP_RESPONSE_IHAVE_ARTICLE    335</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+#define MK_NNTP_RESPONSE_IHAVE_OK 235</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+#define MK_NNTP_RESPONSE_IHAVE_ARTICLE 335</span>
<a href="#l2.62"></a><span id="l2.62"> #define MK_NNTP_RESPONSE_IHAVE_NOT_WANTED 435</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-#define MK_NNTP_RESPONSE_IHAVE_FAILED     436</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-#define MK_NNTP_RESPONSE_IHAVE_REJECTED   437</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+#define MK_NNTP_RESPONSE_IHAVE_FAILED 436</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+#define MK_NNTP_RESPONSE_IHAVE_REJECTED 437</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-#define MK_NNTP_RESPONSE_LAST_OK          223</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-#define MK_NNTP_RESPONSE_LAST_NO_GROUP    412</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-#define MK_NNTP_RESPONSE_LAST_NO_CURRENT  420</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-#define MK_NNTP_RESPONSE_LAST_NO_ARTICLE  422</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+#define MK_NNTP_RESPONSE_LAST_OK 223</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+#define MK_NNTP_RESPONSE_LAST_NO_GROUP 412</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+#define MK_NNTP_RESPONSE_LAST_NO_CURRENT 420</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+#define MK_NNTP_RESPONSE_LAST_NO_ARTICLE 422</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-#define MK_NNTP_RESPONSE_LIST_OK          215</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+#define MK_NNTP_RESPONSE_LIST_OK 215</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-#define MK_NNTP_RESPONSE_NEWGROUPS_OK     231</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+#define MK_NNTP_RESPONSE_NEWGROUPS_OK 231</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-#define MK_NNTP_RESPONSE_NEWNEWS_OK       230</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+#define MK_NNTP_RESPONSE_NEWNEWS_OK 230</span>
<a href="#l2.85"></a><span id="l2.85"> </span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-#define MK_NNTP_RESPONSE_NEXT_OK          223</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-#define MK_NNTP_RESPONSE_NEXT_NO_GROUP    412</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-#define MK_NNTP_RESPONSE_NEXT_NO_CURRENT  420</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-#define MK_NNTP_RESPONSE_NEXT_NO_ARTICLE  421</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+#define MK_NNTP_RESPONSE_NEXT_OK 223</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+#define MK_NNTP_RESPONSE_NEXT_NO_GROUP 412</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+#define MK_NNTP_RESPONSE_NEXT_NO_CURRENT 420</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+#define MK_NNTP_RESPONSE_NEXT_NO_ARTICLE 421</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-#define MK_NNTP_RESPONSE_POST_OK          240</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-#define MK_NNTP_RESPONSE_POST_SEND_NOW    340</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-#define MK_NNTP_RESPONSE_POST_DENIED      440</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-#define MK_NNTP_RESPONSE_POST_FAILED      441</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+#define MK_NNTP_RESPONSE_POST_OK 240</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+#define MK_NNTP_RESPONSE_POST_SEND_NOW 340</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+#define MK_NNTP_RESPONSE_POST_DENIED 440</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+#define MK_NNTP_RESPONSE_POST_FAILED 441</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-#define MK_NNTP_RESPONSE_QUIT_OK          205</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+#define MK_NNTP_RESPONSE_QUIT_OK 205</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-#define MK_NNTP_RESPONSE_SLAVE_OK         202</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+#define MK_NNTP_RESPONSE_SLAVE_OK 202</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110"> #define MK_NNTP_RESPONSE_CHECK_NO_ARTICLE 238</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-#define MK_NNTP_RESPONSE_CHECK_NO_ACCEPT  400</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-#define MK_NNTP_RESPONSE_CHECK_LATER      431</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-#define MK_NNTP_RESPONSE_CHECK_DONT_SEND  438</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-#define MK_NNTP_RESPONSE_CHECK_DENIED     480</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-#define MK_NNTP_RESPONSE_CHECK_ERROR      500</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+#define MK_NNTP_RESPONSE_CHECK_NO_ACCEPT 400</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+#define MK_NNTP_RESPONSE_CHECK_LATER 431</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+#define MK_NNTP_RESPONSE_CHECK_DONT_SEND 438</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+#define MK_NNTP_RESPONSE_CHECK_DENIED 480</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+#define MK_NNTP_RESPONSE_CHECK_ERROR 500</span>
<a href="#l2.121"></a><span id="l2.121"> </span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-#define MK_NNTP_RESPONSE_XHDR_OK          221</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-#define MK_NNTP_RESPONSE_XHDR_NO_GROUP    412</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-#define MK_NNTP_RESPONSE_XHDR_NO_CURRENT  420</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-#define MK_NNTP_RESPONSE_XHDR_NO_ARTICLE  430</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-#define MK_NNTP_RESPONSE_XHDR_DENIED      502</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+#define MK_NNTP_RESPONSE_XHDR_OK 221</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+#define MK_NNTP_RESPONSE_XHDR_NO_GROUP 412</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+#define MK_NNTP_RESPONSE_XHDR_NO_CURRENT 420</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+#define MK_NNTP_RESPONSE_XHDR_NO_ARTICLE 430</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+#define MK_NNTP_RESPONSE_XHDR_DENIED 502</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-#define MK_NNTP_RESPONSE_XOVER_OK         224</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-#define MK_NNTP_RESPONSE_XOVER_NO_GROUP   412</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+#define MK_NNTP_RESPONSE_XOVER_OK 224</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+#define MK_NNTP_RESPONSE_XOVER_NO_GROUP 412</span>
<a href="#l2.137"></a><span id="l2.137"> #define MK_NNTP_RESPONSE_XOVER_NO_CURRENT 420</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-#define MK_NNTP_RESPONSE_XOVER_DENIED     502</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+#define MK_NNTP_RESPONSE_XOVER_DENIED 502</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-#define MK_NNTP_RESPONSE_XPAT_OK          221</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-#define MK_NNTP_RESPONSE_XPAT_NO_ARTICLE  430</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-#define MK_NNTP_RESPONSE_XPAT_DENIED      502</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+#define MK_NNTP_RESPONSE_XPAT_OK 221</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+#define MK_NNTP_RESPONSE_XPAT_NO_ARTICLE 430</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+#define MK_NNTP_RESPONSE_XPAT_DENIED 502</span>
<a href="#l2.147"></a><span id="l2.147"> </span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_OK      281</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_CONT    381</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_OK 281</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_CONT 381</span>
<a href="#l2.152"></a><span id="l2.152"> #define MK_NNTP_RESPONSE_AUTHINFO_REQUIRE 480</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_REJECT  482</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_DENIED  502</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_REJECT 482</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_DENIED 502</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158"> #define MK_NNTP_RESPONSE_</span>
<a href="#l2.159"></a><span id="l2.159"> </span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK      250</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_CONT    350</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK 250</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_CONT 350</span>
<a href="#l2.164"></a><span id="l2.164"> #define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REQUIRE 450</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-#define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REJECT  452</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+#define MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REJECT 452</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-#define MK_NNTP_RESPONSE_TYPE_INFO    1</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-#define MK_NNTP_RESPONSE_TYPE_OK      2</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-#define MK_NNTP_RESPONSE_TYPE_CONT    3</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-#define MK_NNTP_RESPONSE_TYPE_CANNOT  4</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-#define MK_NNTP_RESPONSE_TYPE_ERROR   5</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+#define MK_NNTP_RESPONSE_TYPE_INFO 1</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+#define MK_NNTP_RESPONSE_TYPE_OK 2</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+#define MK_NNTP_RESPONSE_TYPE_CONT 3</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+#define MK_NNTP_RESPONSE_TYPE_CANNOT 4</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+#define MK_NNTP_RESPONSE_TYPE_ERROR 5</span>
<a href="#l2.178"></a><span id="l2.178"> </span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-#define MK_NNTP_RESPONSE_TYPE(x) (x/100)</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+#define MK_NNTP_RESPONSE_TYPE(x) (x / 100)</span>
<a href="#l2.181"></a><span id="l2.181"> </span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-// the following used to be defined in allxpstr.h. Until we find a new values for these,</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-// I'm defining them here because I don't want to link against xplib.lib...(mscott)</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+// the following used to be defined in allxpstr.h. Until we find a new values</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+// for these, I'm defining them here because I don't want to link against</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+// xplib.lib...(mscott)</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-#define MK_DATA_LOADED    1</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-#define MK_EMPTY_NEWS_LIST  -227</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-#define MK_INTERRUPTED    -201</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-#define MK_MALFORMED_URL_ERROR  -209</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-#define MK_NEWS_ERROR_FMT    -430</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-#define MK_NNTP_CANCEL_CONFIRM  -426</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+#define MK_DATA_LOADED 1</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+#define MK_EMPTY_NEWS_LIST -227</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+#define MK_INTERRUPTED -201</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+#define MK_MALFORMED_URL_ERROR -209</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+#define MK_NEWS_ERROR_FMT -430</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+#define MK_NNTP_CANCEL_CONFIRM -426</span>
<a href="#l2.200"></a><span id="l2.200"> #define MK_NNTP_CANCEL_DISALLOWED -427</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-#define MK_NNTP_NOT_CANCELLED    -429</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-#define MK_OUT_OF_MEMORY     -207</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-#define XP_CONFIRM_SAVE_NEWSGROUPS      -1</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-#define XP_HTML_ARTICLE_EXPIRED        -1</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-#define XP_HTML_NEWS_ERROR          -1</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-#define XP_PROGRESS_READ_NEWSGROUPINFO     1</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-#define XP_PROGRESS_RECEIVE_ARTICLE       1</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-#define XP_PROGRESS_RECEIVE_LISTARTICLES   1</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-#define XP_PROGRESS_RECEIVE_NEWSGROUP     1</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-#define XP_PROGRESS_SORT_ARTICLES         1</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-#define XP_PROGRESS_READ_NEWSGROUP_COUNTS   1</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-#define XP_THERMO_PERCENT_FORM         1</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-#define XP_PROMPT_ENTER_USERNAME       1</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-#define MK_NNTP_AUTH_FAILED            -260</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-#define MK_NNTP_ERROR_MESSAGE          -304</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-#define MK_NNTP_NEWSGROUP_SCAN_ERROR    -305</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-#define MK_NNTP_SERVER_ERROR          -217</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-#define MK_NNTP_SERVER_NOT_CONFIGURED     -307</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-#define MK_TCP_READ_ERROR          -252</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-#define MK_TCP_WRITE_ERROR          -236</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-#define MK_NNTP_CANCEL_ERROR        -428</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-#define XP_CONNECT_NEWS_HOST_CONTACTED_WAITING_FOR_REPLY  1</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+#define MK_NNTP_NOT_CANCELLED -429</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+#define MK_OUT_OF_MEMORY -207</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+#define XP_CONFIRM_SAVE_NEWSGROUPS -1</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+#define XP_HTML_ARTICLE_EXPIRED -1</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+#define XP_HTML_NEWS_ERROR -1</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+#define XP_PROGRESS_READ_NEWSGROUPINFO 1</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+#define XP_PROGRESS_RECEIVE_ARTICLE 1</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+#define XP_PROGRESS_RECEIVE_LISTARTICLES 1</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+#define XP_PROGRESS_RECEIVE_NEWSGROUP 1</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+#define XP_PROGRESS_SORT_ARTICLES 1</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+#define XP_PROGRESS_READ_NEWSGROUP_COUNTS 1</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+#define XP_THERMO_PERCENT_FORM 1</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+#define XP_PROMPT_ENTER_USERNAME 1</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+#define MK_NNTP_AUTH_FAILED -260</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+#define MK_NNTP_ERROR_MESSAGE -304</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+#define MK_NNTP_NEWSGROUP_SCAN_ERROR -305</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+#define MK_NNTP_SERVER_ERROR -217</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+#define MK_NNTP_SERVER_NOT_CONFIGURED -307</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+#define MK_TCP_READ_ERROR -252</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+#define MK_TCP_WRITE_ERROR -236</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+#define MK_NNTP_CANCEL_ERROR -428</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+#define XP_CONNECT_NEWS_HOST_CONTACTED_WAITING_FOR_REPLY 1</span>
<a href="#l2.245"></a><span id="l2.245"> #define XP_PLEASE_ENTER_A_PASSWORD_FOR_NEWS_SERVER_ACCESS 1</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-#define XP_GARBAGE_COLLECTING                1</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-#define XP_MESSAGE_SENT_WAITING_NEWS_REPLY          1</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-#define MK_MSG_DELIV_NEWS                  1</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-#define MK_MSG_COLLABRA_DISABLED              1</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-#define MK_MSG_EXPIRE_NEWS_ARTICLES                1</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-#define MK_MSG_HTML_IMAP_NO_CACHED_BODY            1</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-#define MK_MSG_CANT_MOVE_FOLDER                1</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+#define XP_GARBAGE_COLLECTING 1</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+#define XP_MESSAGE_SENT_WAITING_NEWS_REPLY 1</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+#define MK_MSG_DELIV_NEWS 1</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+#define MK_MSG_COLLABRA_DISABLED 1</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+#define MK_MSG_EXPIRE_NEWS_ARTICLES 1</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+#define MK_MSG_HTML_IMAP_NO_CACHED_BODY 1</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+#define MK_MSG_CANT_MOVE_FOLDER 1</span>
<a href="#l2.260"></a><span id="l2.260"> </span>
<a href="#l2.261"></a><span id="l2.261"> #endif /* NNTPCore_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPArticleList.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPArticleList.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,104 +1,93 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> #include &quot;nsNNTPArticleList.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> NS_IMPL_ISUPPORTS(nsNNTPArticleList, nsINNTPArticleList)</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-nsNNTPArticleList::nsNNTPArticleList()</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-{</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-}</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+nsNNTPArticleList::nsNNTPArticleList() {}</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-nsNNTPArticleList::~nsNNTPArticleList()</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-{</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+nsNNTPArticleList::~nsNNTPArticleList() {</span>
<a href="#l3.28"></a><span id="l3.28">   if (m_newsDB) {</span>
<a href="#l3.29"></a><span id="l3.29">     m_newsDB-&gt;Commit(nsMsgDBCommitType::kSessionCommit);</span>
<a href="#l3.30"></a><span id="l3.30">     m_newsDB-&gt;Close(true);</span>
<a href="#l3.31"></a><span id="l3.31">     m_newsDB = nullptr;</span>
<a href="#l3.32"></a><span id="l3.32">   }</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">   m_newsFolder = nullptr;</span>
<a href="#l3.35"></a><span id="l3.35"> }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> NS_IMETHODIMP</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-nsNNTPArticleList::Initialize(nsIMsgNewsFolder *newsFolder)</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-{</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    nsresult rv;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-    NS_ENSURE_ARG_POINTER(newsFolder);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+nsNNTPArticleList::Initialize(nsIMsgNewsFolder *newsFolder) {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  NS_ENSURE_ARG_POINTER(newsFolder);</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-    m_dbIndex = 0;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  m_dbIndex = 0;</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    m_newsFolder = newsFolder;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  m_newsFolder = newsFolder;</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-    rv = folder-&gt;GetMsgDatabase(getter_AddRefs(m_newsDB));</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    if (!m_newsDB) return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  rv = folder-&gt;GetMsgDatabase(getter_AddRefs(m_newsDB));</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  if (!m_newsDB) return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    RefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    rv = m_newsDB-&gt;ListAllKeys(keys);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    keys-&gt;Sort();</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    m_idsInDB.AppendElements(keys-&gt;m_keys);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  RefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  rv = m_newsDB-&gt;ListAllKeys(keys);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  keys-&gt;Sort();</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  m_idsInDB.AppendElements(keys-&gt;m_keys);</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.77"></a><span id="l3.77"> }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79"> NS_IMETHODIMP</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-nsNNTPArticleList::AddArticleKey(nsMsgKey key)</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-{</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+nsNNTPArticleList::AddArticleKey(nsMsgKey key) {</span>
<a href="#l3.83"></a><span id="l3.83"> #ifdef DEBUG</span>
<a href="#l3.84"></a><span id="l3.84">   m_idsOnServer.AppendElement(key);</span>
<a href="#l3.85"></a><span id="l3.85"> #endif</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  if (m_dbIndex &lt; m_idsInDB.Length())</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  {</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  if (m_dbIndex &lt; m_idsInDB.Length()) {</span>
<a href="#l3.90"></a><span id="l3.90">     nsMsgKey idInDBToCheck = m_idsInDB[m_dbIndex];</span>
<a href="#l3.91"></a><span id="l3.91">     // if there are keys in the database that aren't in the newsgroup</span>
<a href="#l3.92"></a><span id="l3.92">     // on the server, remove them. We probably shouldn't do this if</span>
<a href="#l3.93"></a><span id="l3.93">     // we have a copy of the article offline.</span>
<a href="#l3.94"></a><span id="l3.94">     // We'll add to m_idsDeleted for now and remove the id later</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    while (idInDBToCheck &lt; key)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+    while (idInDBToCheck &lt; key) {</span>
<a href="#l3.98"></a><span id="l3.98">       m_idsDeleted.AppendElement(idInDBToCheck);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-      if (m_dbIndex &gt;= m_idsInDB.Length())</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-        break;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+      if (m_dbIndex &gt;= m_idsInDB.Length()) break;</span>
<a href="#l3.102"></a><span id="l3.102">       idInDBToCheck = m_idsInDB[++m_dbIndex];</span>
<a href="#l3.103"></a><span id="l3.103">     }</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-    if (idInDBToCheck == key)</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-      m_dbIndex++;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+    if (idInDBToCheck == key) m_dbIndex++;</span>
<a href="#l3.107"></a><span id="l3.107">   }</span>
<a href="#l3.108"></a><span id="l3.108">   return NS_OK;</span>
<a href="#l3.109"></a><span id="l3.109"> }</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111"> NS_IMETHODIMP</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-nsNNTPArticleList::FinishAddingArticleKeys()</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-{</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-  // if the last n messages in the group are cancelled, they won't have gotten removed</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  // so we have to go and remove them now.</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+nsNNTPArticleList::FinishAddingArticleKeys() {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+  // if the last n messages in the group are cancelled, they won't have gotten</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  // removed so we have to go and remove them now.</span>
<a href="#l3.119"></a><span id="l3.119">   if (m_dbIndex &lt; m_idsInDB.Length())</span>
<a href="#l3.120"></a><span id="l3.120">     m_idsDeleted.AppendElements(&amp;m_idsInDB[m_dbIndex],</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-      m_idsInDB.Length() - m_dbIndex);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+                                m_idsInDB.Length() - m_dbIndex);</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-  if (m_idsDeleted.Length())</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-    m_newsFolder-&gt;RemoveMessages(m_idsDeleted);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+  if (m_idsDeleted.Length()) m_newsFolder-&gt;RemoveMessages(m_idsDeleted);</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128"> #ifdef DEBUG</span>
<a href="#l3.129"></a><span id="l3.129">   // make sure none of the deleted turned up on the idsOnServer list</span>
<a href="#l3.130"></a><span id="l3.130">   for (uint32_t i = 0; i &lt; m_idsDeleted.Length(); i++) {</span>
<a href="#l3.131"></a><span id="l3.131">     NS_ASSERTION(!m_idsOnServer.Contains((nsMsgKey)m_idsDeleted[i]),</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      &quot;a deleted turned up on the idsOnServer list&quot;);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                 &quot;a deleted turned up on the idsOnServer list&quot;);</span>
<a href="#l3.134"></a><span id="l3.134">   }</span>
<a href="#l3.135"></a><span id="l3.135"> #endif</span>
<a href="#l3.136"></a><span id="l3.136">   return NS_OK;</span>
<a href="#l3.137"></a><span id="l3.137"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPArticleList.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPArticleList.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -8,33 +8,32 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsINNTPArticleList.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsIMsgNewsFolder.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-class nsNNTPArticleList : public nsINNTPArticleList</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-public:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+class nsNNTPArticleList : public nsINNTPArticleList {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ public:</span>
<a href="#l4.17"></a><span id="l4.17">   nsNNTPArticleList();</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    NS_DECL_NSINNTPARTICLELIST</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  NS_DECL_NSINNTPARTICLELIST</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-protected:</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ protected:</span>
<a href="#l4.26"></a><span id="l4.26">   virtual ~nsNNTPArticleList();</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; m_idsInDB;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_idsInDB;</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31"> #ifdef DEBUG</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; m_idsOnServer;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_idsOnServer;</span>
<a href="#l4.34"></a><span id="l4.34"> #endif</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; m_idsDeleted;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_idsDeleted;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    nsCOMPtr &lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    uint32_t  m_dbIndex;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  uint32_t m_dbIndex;</span>
<a href="#l4.45"></a><span id="l4.45"> };</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47"> #endif /* nsNNTPArticleList_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /*</span>
<a href="#l5.5"></a><span id="l5.5">  * formerly listngst.cpp</span>
<a href="#l5.6"></a><span id="l5.6">  * This class should ultimately be part of a news group listing</span>
<a href="#l5.7"></a><span id="l5.7">  * state machine - either by inheritance or delegation.</span>
<a href="#l5.8"></a><span id="l5.8">  * Currently, a folder pane owns one and libnet news group listing</span>
<a href="#l5.9"></a><span id="l5.9">  * related messages get passed to this object.</span>
<a href="#l5.10"></a><span id="l5.10">  */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsINewsDatabase.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsPIDOMWindow.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -59,564 +59,509 @@</span>
<a href="#l5.23"></a><span id="l5.23"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l5.24"></a><span id="l5.24"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.26"></a><span id="l5.26"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> // update status on header download once per second</span>
<a href="#l5.29"></a><span id="l5.29"> #define MIN_STATUS_UPDATE_INTERVAL PRTime(PR_USEC_PER_SEC)</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-</span>
<a href="#l5.32"></a><span id="l5.32"> nsNNTPNewsgroupList::nsNNTPNewsgroupList()</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  : m_finishingXover(false),</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  m_getOldMessages(false),</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  m_promptedAlready(false),</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  m_downloadAll(false),</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  m_maxArticles(0),</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  m_lastPercent(-1),</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  m_lastStatusUpdate(0),</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  m_lastProcessedNumber(0),</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  m_firstMsgNumber(0),</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  m_lastMsgNumber(0),</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  m_firstMsgToDownload(0),</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  m_lastMsgToDownload(0),</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  m_set(nullptr)</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-{</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    : m_finishingXover(false),</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+      m_getOldMessages(false),</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+      m_promptedAlready(false),</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+      m_downloadAll(false),</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      m_maxArticles(0),</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      m_lastPercent(-1),</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      m_lastStatusUpdate(0),</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      m_lastProcessedNumber(0),</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+      m_firstMsgNumber(0),</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      m_lastMsgNumber(0),</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+      m_firstMsgToDownload(0),</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      m_lastMsgToDownload(0),</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+      m_set(nullptr) {</span>
<a href="#l5.60"></a><span id="l5.60">   memset(&amp;m_knownArts, 0, sizeof(m_knownArts));</span>
<a href="#l5.61"></a><span id="l5.61"> }</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-nsNNTPNewsgroupList::~nsNNTPNewsgroupList()</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-{</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  CleanUp();</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-}</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+nsNNTPNewsgroupList::~nsNNTPNewsgroupList() { CleanUp(); }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-NS_IMPL_ISUPPORTS(nsNNTPNewsgroupList, nsINNTPNewsgroupList, nsIMsgFilterHitNotify)</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+NS_IMPL_ISUPPORTS(nsNNTPNewsgroupList, nsINNTPNewsgroupList,</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+                  nsIMsgFilterHitNotify)</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-nsresult</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-nsNNTPNewsgroupList::Initialize(nsINntpUrl *runningURL, nsIMsgNewsFolder *newsFolder)</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-{</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+nsresult nsNNTPNewsgroupList::Initialize(nsINntpUrl *runningURL,</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+                                         nsIMsgNewsFolder *newsFolder) {</span>
<a href="#l5.78"></a><span id="l5.78">   m_newsFolder = newsFolder;</span>
<a href="#l5.79"></a><span id="l5.79">   m_runningURL = runningURL;</span>
<a href="#l5.80"></a><span id="l5.80">   m_knownArts.set = nsMsgKeySet::Create();</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82">   nsresult rv = m_newsFolder-&gt;GetDatabaseWithoutCache(getter_AddRefs(m_newsDB));</span>
<a href="#l5.83"></a><span id="l5.83">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.84"></a><span id="l5.84"> </span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90">   rv = folder-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.93"></a><span id="l5.93">   nsCString ngHeaders;</span>
<a href="#l5.94"></a><span id="l5.94">   m_filterList-&gt;GetArbitraryHeaders(ngHeaders);</span>
<a href="#l5.95"></a><span id="l5.95">   ParseString(ngHeaders, ' ', m_filterHeaders);</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.98"></a><span id="l5.98">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102">   rv = server-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_serverFilterList));</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.105"></a><span id="l5.105">   nsAutoCString servHeaders;</span>
<a href="#l5.106"></a><span id="l5.106">   m_serverFilterList-&gt;GetArbitraryHeaders(servHeaders);</span>
<a href="#l5.107"></a><span id="l5.107"> </span>
<a href="#l5.108"></a><span id="l5.108">   nsTArray&lt;nsCString&gt; servArray;</span>
<a href="#l5.109"></a><span id="l5.109">   ParseString(servHeaders, ' ', servArray);</span>
<a href="#l5.110"></a><span id="l5.110"> </span>
<a href="#l5.111"></a><span id="l5.111">   // servArray may have duplicates already in m_filterHeaders.</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-  for (uint32_t i = 0; i &lt; servArray.Length(); i++)</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-  {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+  for (uint32_t i = 0; i &lt; servArray.Length(); i++) {</span>
<a href="#l5.115"></a><span id="l5.115">     if (!m_filterHeaders.Contains(servArray[i]))</span>
<a href="#l5.116"></a><span id="l5.116">       m_filterHeaders.AppendElement(servArray[i]);</span>
<a href="#l5.117"></a><span id="l5.117">   }</span>
<a href="#l5.118"></a><span id="l5.118">   return NS_OK;</span>
<a href="#l5.119"></a><span id="l5.119"> }</span>
<a href="#l5.120"></a><span id="l5.120"> </span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-nsresult</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-nsNNTPNewsgroupList::CleanUp()</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-{</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+nsresult nsNNTPNewsgroupList::CleanUp() {</span>
<a href="#l5.125"></a><span id="l5.125">   // here we make sure that there aren't missing articles in the unread set</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-  // So if an article is the unread set, and the known arts set, but isn't in the</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-  // db, then we should mark it read in the unread set.</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-  if (m_newsDB)</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-  {</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-    if (m_knownArts.set &amp;&amp; m_knownArts.set-&gt;getLength() &amp;&amp; m_set-&gt;getLength())</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-    {</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-      nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  // So if an article is the unread set, and the known arts set, but isn't in</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  // the db, then we should mark it read in the unread set.</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  if (m_newsDB) {</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    if (m_knownArts.set &amp;&amp; m_knownArts.set-&gt;getLength() &amp;&amp; m_set-&gt;getLength()) {</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l5.138"></a><span id="l5.138">       m_newsDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l5.139"></a><span id="l5.139">       int32_t firstKnown = m_knownArts.set-&gt;GetFirstMember();</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-      int32_t lastKnown =  m_knownArts.set-&gt;GetLastMember();</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-      if (folderInfo)</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-      {</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+      int32_t lastKnown = m_knownArts.set-&gt;GetLastMember();</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+      if (folderInfo) {</span>
<a href="#l5.145"></a><span id="l5.145">         uint32_t lastMissingCheck;</span>
<a href="#l5.146"></a><span id="l5.146">         folderInfo-&gt;GetUint32Property(&quot;lastMissingCheck&quot;, 0, &amp;lastMissingCheck);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-        if (lastMissingCheck)</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-          firstKnown = lastMissingCheck + 1;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+        if (lastMissingCheck) firstKnown = lastMissingCheck + 1;</span>
<a href="#l5.150"></a><span id="l5.150">       }</span>
<a href="#l5.151"></a><span id="l5.151">       bool foundMissingArticle = false;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-      while (firstKnown &lt;= lastKnown)</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-      {</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+      while (firstKnown &lt;= lastKnown) {</span>
<a href="#l5.155"></a><span id="l5.155">         int32_t firstUnreadStart, firstUnreadEnd;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-        if (firstKnown == 0)</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-          firstKnown = 1;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-        m_set-&gt;FirstMissingRange(firstKnown, lastKnown, &amp;firstUnreadStart, &amp;firstUnreadEnd);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-        if (firstUnreadStart)</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-        {</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-          while (firstUnreadStart &lt;= firstUnreadEnd)</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-          {</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+        if (firstKnown == 0) firstKnown = 1;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+        m_set-&gt;FirstMissingRange(firstKnown, lastKnown, &amp;firstUnreadStart,</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+                                 &amp;firstUnreadEnd);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+        if (firstUnreadStart) {</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+          while (firstUnreadStart &lt;= firstUnreadEnd) {</span>
<a href="#l5.168"></a><span id="l5.168">             bool containsKey;</span>
<a href="#l5.169"></a><span id="l5.169">             m_newsDB-&gt;ContainsKey(firstUnreadStart, &amp;containsKey);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-            if (!containsKey)</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-            {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+            if (!containsKey) {</span>
<a href="#l5.173"></a><span id="l5.173">               m_set-&gt;Add(firstUnreadStart);</span>
<a href="#l5.174"></a><span id="l5.174">               foundMissingArticle = true;</span>
<a href="#l5.175"></a><span id="l5.175">             }</span>
<a href="#l5.176"></a><span id="l5.176">             firstUnreadStart++;</span>
<a href="#l5.177"></a><span id="l5.177">           }</span>
<a href="#l5.178"></a><span id="l5.178">           firstKnown = firstUnreadStart;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-        }</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-        else</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+        } else</span>
<a href="#l5.182"></a><span id="l5.182">           break;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-</span>
<a href="#l5.184"></a><span id="l5.184">       }</span>
<a href="#l5.185"></a><span id="l5.185">       if (folderInfo)</span>
<a href="#l5.186"></a><span id="l5.186">         folderInfo-&gt;SetUint32Property(&quot;lastMissingCheck&quot;, lastKnown);</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-      if (foundMissingArticle)</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-      {</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+      if (foundMissingArticle) {</span>
<a href="#l5.191"></a><span id="l5.191">         nsresult rv;</span>
<a href="#l5.192"></a><span id="l5.192">         nsCOMPtr&lt;nsINewsDatabase&gt; db(do_QueryInterface(m_newsDB, &amp;rv));</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.195"></a><span id="l5.195">         db-&gt;SetReadSet(m_set);</span>
<a href="#l5.196"></a><span id="l5.196">       }</span>
<a href="#l5.197"></a><span id="l5.197">     }</span>
<a href="#l5.198"></a><span id="l5.198">     m_newsDB-&gt;Commit(nsMsgDBCommitType::kSessionCommit);</span>
<a href="#l5.199"></a><span id="l5.199">     m_newsDB-&gt;Close(true);</span>
<a href="#l5.200"></a><span id="l5.200">     m_newsDB = nullptr;</span>
<a href="#l5.201"></a><span id="l5.201">   }</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  if (m_knownArts.set)</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-  {</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+  if (m_knownArts.set) {</span>
<a href="#l5.206"></a><span id="l5.206">     delete m_knownArts.set;</span>
<a href="#l5.207"></a><span id="l5.207">     m_knownArts.set = nullptr;</span>
<a href="#l5.208"></a><span id="l5.208">   }</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  if (m_newsFolder)</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-    m_newsFolder-&gt;NotifyFinishedDownloadinghdrs();</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  if (m_newsFolder) m_newsFolder-&gt;NotifyFinishedDownloadinghdrs();</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213">   m_newsFolder = nullptr;</span>
<a href="#l5.214"></a><span id="l5.214">   m_runningURL = nullptr;</span>
<a href="#l5.215"></a><span id="l5.215"> </span>
<a href="#l5.216"></a><span id="l5.216">   return NS_OK;</span>
<a href="#l5.217"></a><span id="l5.217"> }</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219"> #ifdef HAVE_CHANGELISTENER</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-void nsNNTPNewsgroupList::OnAnnouncerGoingAway (ChangeAnnouncer *instigator)</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-{</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-}</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+void nsNNTPNewsgroupList::OnAnnouncerGoingAway(ChangeAnnouncer *instigator) {}</span>
<a href="#l5.224"></a><span id="l5.224"> #endif</span>
<a href="#l5.225"></a><span id="l5.225"> </span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-static nsresult</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-openWindow(nsIMsgWindow *aMsgWindow, const char *chromeURL,</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-           nsINewsDownloadDialogArgs *param)</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-{</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+static nsresult openWindow(nsIMsgWindow *aMsgWindow, const char *chromeURL,</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+                           nsINewsDownloadDialogArgs *param) {</span>
<a href="#l5.232"></a><span id="l5.232">   nsresult rv;</span>
<a href="#l5.233"></a><span id="l5.233">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l5.234"></a><span id="l5.234">   nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l5.235"></a><span id="l5.235">   rv = aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-      return rv;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.239"></a><span id="l5.239"> </span>
<a href="#l5.240"></a><span id="l5.240">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow(do_GetInterface(docShell));</span>
<a href="#l5.241"></a><span id="l5.241">   NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow =</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+      nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l5.245"></a><span id="l5.245"> </span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-  nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr = do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+  nsCOMPtr&lt;nsISupportsInterfacePointer&gt; ifptr =</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l5.249"></a><span id="l5.249">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251">   ifptr-&gt;SetData(param);</span>
<a href="#l5.252"></a><span id="l5.252">   ifptr-&gt;SetDataIID(&amp;NS_GET_IID(nsINewsDownloadDialogArgs));</span>
<a href="#l5.253"></a><span id="l5.253"> </span>
<a href="#l5.254"></a><span id="l5.254">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; dialogWindow;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-  rv = parentWindow-&gt;OpenDialog(NS_ConvertASCIItoUTF16(chromeURL),</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-                                NS_LITERAL_STRING(&quot;_blank&quot;),</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-                                NS_LITERAL_STRING(&quot;centerscreen,chrome,modal,titlebar&quot;),</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-                                ifptr, getter_AddRefs(dialogWindow));</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+  rv = parentWindow-&gt;OpenDialog(</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+      NS_ConvertASCIItoUTF16(chromeURL), NS_LITERAL_STRING(&quot;_blank&quot;),</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+      NS_LITERAL_STRING(&quot;centerscreen,chrome,modal,titlebar&quot;), ifptr,</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+      getter_AddRefs(dialogWindow));</span>
<a href="#l5.263"></a><span id="l5.263"> </span>
<a href="#l5.264"></a><span id="l5.264">   return rv;</span>
<a href="#l5.265"></a><span id="l5.265"> }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-nsresult</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-nsNNTPNewsgroupList::GetRangeOfArtsToDownload(nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-                                              int32_t first_possible,</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-                                              int32_t last_possible,</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-                                              int32_t maxextra,</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-                                              int32_t *first,</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-                                              int32_t *last,</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-                                              int32_t *status)</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-{</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+nsresult nsNNTPNewsgroupList::GetRangeOfArtsToDownload(</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+    nsIMsgWindow *aMsgWindow, int32_t first_possible, int32_t last_possible,</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+    int32_t maxextra, int32_t *first, int32_t *last, int32_t *status) {</span>
<a href="#l5.279"></a><span id="l5.279">   nsresult rv = NS_OK;</span>
<a href="#l5.280"></a><span id="l5.280"> </span>
<a href="#l5.281"></a><span id="l5.281">   NS_ENSURE_ARG_POINTER(first);</span>
<a href="#l5.282"></a><span id="l5.282">   NS_ENSURE_ARG_POINTER(last);</span>
<a href="#l5.283"></a><span id="l5.283">   NS_ENSURE_ARG_POINTER(status);</span>
<a href="#l5.284"></a><span id="l5.284">   *first = 0;</span>
<a href="#l5.285"></a><span id="l5.285">   *last = 0;</span>
<a href="#l5.286"></a><span id="l5.286"> </span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.291"></a><span id="l5.291">   m_msgWindow = aMsgWindow;</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293">   nsCOMPtr&lt;nsINewsDatabase&gt; db(do_QueryInterface(m_newsDB, &amp;rv));</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.296"></a><span id="l5.296"> </span>
<a href="#l5.297"></a><span id="l5.297">   rv = db-&gt;GetReadSet(&amp;m_set);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-  if (NS_FAILED(rv) || !m_set)</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-    return rv;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  if (NS_FAILED(rv) || !m_set) return rv;</span>
<a href="#l5.301"></a><span id="l5.301"> </span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-  m_set-&gt;SetLastMember(last_possible); // make sure highwater mark is valid.</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+  m_set-&gt;SetLastMember(last_possible);  // make sure highwater mark is valid.</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; newsGroupInfo;</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; newsGroupInfo;</span>
<a href="#l5.307"></a><span id="l5.307">   rv = m_newsDB-&gt;GetDBFolderInfo(getter_AddRefs(newsGroupInfo));</span>
<a href="#l5.308"></a><span id="l5.308">   if (NS_SUCCEEDED(rv) &amp;&amp; newsGroupInfo) {</span>
<a href="#l5.309"></a><span id="l5.309">     nsCString knownArtsString;</span>
<a href="#l5.310"></a><span id="l5.310">     nsMsgKey mark;</span>
<a href="#l5.311"></a><span id="l5.311">     newsGroupInfo-&gt;GetKnownArtsSet(getter_Copies(knownArtsString));</span>
<a href="#l5.312"></a><span id="l5.312"> </span>
<a href="#l5.313"></a><span id="l5.313">     rv = newsGroupInfo-&gt;GetHighWater(&amp;mark);</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.316"></a><span id="l5.316"> </span>
<a href="#l5.317"></a><span id="l5.317">     if (last_possible &lt; ((int32_t)mark))</span>
<a href="#l5.318"></a><span id="l5.318">       newsGroupInfo-&gt;SetHighWater(last_possible);</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-    if (m_knownArts.set)</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-      delete m_knownArts.set;</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+    if (m_knownArts.set) delete m_knownArts.set;</span>
<a href="#l5.322"></a><span id="l5.322">     m_knownArts.set = nsMsgKeySet::Create(knownArtsString.get());</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  }</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-  else</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-  {</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-    if (m_knownArts.set)</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-      delete m_knownArts.set;</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+  } else {</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+    if (m_knownArts.set) delete m_knownArts.set;</span>
<a href="#l5.330"></a><span id="l5.330">     m_knownArts.set = nsMsgKeySet::Create();</span>
<a href="#l5.331"></a><span id="l5.331">     nsMsgKey low, high;</span>
<a href="#l5.332"></a><span id="l5.332">     rv = m_newsDB-&gt;GetLowWaterArticleNum(&amp;low);</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.335"></a><span id="l5.335">     rv = m_newsDB-&gt;GetHighWaterArticleNum(&amp;high);</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-    m_knownArts.set-&gt;AddRange(low,high);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+    m_knownArts.set-&gt;AddRange(low, high);</span>
<a href="#l5.340"></a><span id="l5.340">   }</span>
<a href="#l5.341"></a><span id="l5.341"> </span>
<a href="#l5.342"></a><span id="l5.342">   if (m_knownArts.set-&gt;IsMember(last_possible)) {</span>
<a href="#l5.343"></a><span id="l5.343">     nsString statusString;</span>
<a href="#l5.344"></a><span id="l5.344">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l5.347"></a><span id="l5.347">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.348"></a><span id="l5.348"> </span>
<a href="#l5.349"></a><span id="l5.349">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.350"></a><span id="l5.350">     rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l5.351"></a><span id="l5.351">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353">     rv = bundle-&gt;GetStringFromName(&quot;noNewMessages&quot;, statusString);</span>
<a href="#l5.354"></a><span id="l5.354">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.355"></a><span id="l5.355"> </span>
<a href="#l5.356"></a><span id="l5.356">     SetProgressStatus(statusString.get());</span>
<a href="#l5.357"></a><span id="l5.357">   }</span>
<a href="#l5.358"></a><span id="l5.358"> </span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-  if (maxextra &lt;= 0 || last_possible &lt; first_possible || last_possible &lt; 1)</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-  {</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-    *status=0;</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+  if (maxextra &lt;= 0 || last_possible &lt; first_possible || last_possible &lt; 1) {</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+    *status = 0;</span>
<a href="#l5.364"></a><span id="l5.364">     return NS_OK;</span>
<a href="#l5.365"></a><span id="l5.365">   }</span>
<a href="#l5.366"></a><span id="l5.366"> </span>
<a href="#l5.367"></a><span id="l5.367">   m_knownArts.first_possible = first_possible;</span>
<a href="#l5.368"></a><span id="l5.368">   m_knownArts.last_possible = last_possible;</span>
<a href="#l5.369"></a><span id="l5.369"> </span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.372"></a><span id="l5.372">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.375"></a><span id="l5.375"> </span>
<a href="#l5.376"></a><span id="l5.376">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.379"></a><span id="l5.379"> </span>
<a href="#l5.380"></a><span id="l5.380">   /* Determine if we only want to get just new articles or more messages.</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-  If there are new articles at the end we haven't seen, we always want to get those first.</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-  Otherwise, we get the newest articles we haven't gotten, if we're getting more.</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-  My thought for now is that opening a newsgroup should only try to get new articles.</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-  Selecting &quot;More Messages&quot; will first try to get unseen messages, then old messages. */</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+  If there are new articles at the end we haven't seen, we always want to get</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+  those first. Otherwise, we get the newest articles we haven't gotten, if we're</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+  getting more. My thought for now is that opening a newsgroup should only try</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+  to get new articles. Selecting &quot;More Messages&quot; will first try to get unseen</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+  messages, then old messages. */</span>
<a href="#l5.390"></a><span id="l5.390"> </span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-  if (m_getOldMessages || !m_knownArts.set-&gt;IsMember(last_possible))</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-  {</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+  if (m_getOldMessages || !m_knownArts.set-&gt;IsMember(last_possible)) {</span>
<a href="#l5.394"></a><span id="l5.394">     bool notifyMaxExceededOn = true;</span>
<a href="#l5.395"></a><span id="l5.395">     rv = nntpServer-&gt;GetNotifyOn(&amp;notifyMaxExceededOn);</span>
<a href="#l5.396"></a><span id="l5.396">     if (NS_FAILED(rv)) notifyMaxExceededOn = true;</span>
<a href="#l5.397"></a><span id="l5.397"> </span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-    // if the preference to notify when downloading more than x headers is not on,</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-    // and we're downloading new headers, set maxextra to a very large number.</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-    if (!m_getOldMessages &amp;&amp; !notifyMaxExceededOn)</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-      maxextra = 0x7FFFFFFFL;</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-        int result =</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-            m_knownArts.set-&gt;LastMissingRange(first_possible, last_possible,</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-                                              first, last);</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+    // if the preference to notify when downloading more than x headers is not</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+    // on, and we're downloading new headers, set maxextra to a very large</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+    // number.</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+    if (!m_getOldMessages &amp;&amp; !notifyMaxExceededOn) maxextra = 0x7FFFFFFFL;</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+    int result = m_knownArts.set-&gt;LastMissingRange(first_possible,</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+                                                   last_possible, first, last);</span>
<a href="#l5.411"></a><span id="l5.411">     if (result &lt; 0) {</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-            *status=result;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+      *status = result;</span>
<a href="#l5.414"></a><span id="l5.414">       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-        }</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-    if (*first &gt; 0 &amp;&amp; *last - *first &gt;= maxextra)</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-    {</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-      if (!m_getOldMessages &amp;&amp; !m_promptedAlready &amp;&amp; notifyMaxExceededOn)</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-      {</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+    }</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+    if (*first &gt; 0 &amp;&amp; *last - *first &gt;= maxextra) {</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+      if (!m_getOldMessages &amp;&amp; !m_promptedAlready &amp;&amp; notifyMaxExceededOn) {</span>
<a href="#l5.423"></a><span id="l5.423">         m_downloadAll = false;</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-        nsCOMPtr&lt;nsINewsDownloadDialogArgs&gt; args = do_CreateInstance(&quot;@mozilla.org/messenger/newsdownloaddialogargs;1&quot;, &amp;rv);</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+        nsCOMPtr&lt;nsINewsDownloadDialogArgs&gt; args = do_CreateInstance(</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+            &quot;@mozilla.org/messenger/newsdownloaddialogargs;1&quot;, &amp;rv);</span>
<a href="#l5.427"></a><span id="l5.427">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.430"></a><span id="l5.430"> </span>
<a href="#l5.431"></a><span id="l5.431">         rv = args-&gt;SetArticleCount(*last - *first + 1);</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.434"></a><span id="l5.434"> </span>
<a href="#l5.435"></a><span id="l5.435">         nsString groupName;</span>
<a href="#l5.436"></a><span id="l5.436">         rv = m_newsFolder-&gt;GetUnicodeName(groupName);</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.439"></a><span id="l5.439"> </span>
<a href="#l5.440"></a><span id="l5.440">         rv = args-&gt;SetGroupName(groupName);</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.443"></a><span id="l5.443"> </span>
<a href="#l5.444"></a><span id="l5.444">         // get the server key</span>
<a href="#l5.445"></a><span id="l5.445">         nsCString serverKey;</span>
<a href="#l5.446"></a><span id="l5.446">         rv = server-&gt;GetKey(serverKey);</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.449"></a><span id="l5.449"> </span>
<a href="#l5.450"></a><span id="l5.450">         rv = args-&gt;SetServerKey(serverKey.get());</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.453"></a><span id="l5.453"> </span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-        // we many not have a msgWindow if we are running an autosubscribe url from the browser</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-        // and there isn't a 3 pane open.</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+        // we many not have a msgWindow if we are running an autosubscribe url</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+        // from the browser and there isn't a 3 pane open.</span>
<a href="#l5.458"></a><span id="l5.458">         //</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-        // if we don't have one, bad things will happen when we fail to open up the &quot;download headers dialog&quot;</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-        // (we will subscribe to the newsgroup, but it will appear like there are no messages!)</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+        // if we don't have one, bad things will happen when we fail to open up</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+        // the &quot;download headers dialog&quot; (we will subscribe to the newsgroup,</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+        // but it will appear like there are no messages!)</span>
<a href="#l5.464"></a><span id="l5.464">         //</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-        // for now, act like the &quot;download headers dialog&quot; came up, and the user hit cancel.  (very safe)</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+        // for now, act like the &quot;download headers dialog&quot; came up, and the user</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+        // hit cancel.  (very safe)</span>
<a href="#l5.468"></a><span id="l5.468">         //</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-        // TODO, figure out why we aren't opening and using a 3 pane when the autosubscribe url is run.</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-        // perhaps we can find an available 3 pane, and use it.</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+        // TODO, figure out why we aren't opening and using a 3 pane when the</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+        // autosubscribe url is run. perhaps we can find an available 3 pane,</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+        // and use it.</span>
<a href="#l5.474"></a><span id="l5.474"> </span>
<a href="#l5.475"></a><span id="l5.475">         bool download = false;</span>
<a href="#l5.476"></a><span id="l5.476"> </span>
<a href="#l5.477"></a><span id="l5.477">         if (aMsgWindow) {</span>
<a href="#l5.478"></a><span id="l5.478">           rv = openWindow(aMsgWindow, DOWNLOAD_HEADERS_URL, args);</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.481"></a><span id="l5.481"> </span>
<a href="#l5.482"></a><span id="l5.482">           rv = args-&gt;GetHitOK(&amp;download);</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.485"></a><span id="l5.485">         }</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-      if (download) {</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-         rv = args-&gt;GetDownloadAll(&amp;m_downloadAll);</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-         m_maxArticles = 0;</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineminus">-         rv = nntpServer-&gt;GetMaxArticles(&amp;m_maxArticles);</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+        if (download) {</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+          rv = args-&gt;GetDownloadAll(&amp;m_downloadAll);</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+          m_maxArticles = 0;</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+          rv = nntpServer-&gt;GetMaxArticles(&amp;m_maxArticles);</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.499"></a><span id="l5.499"> </span>
<a href="#l5.500"></a><span id="l5.500">           maxextra = m_maxArticles;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineminus">-          if (!m_downloadAll)</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-          {</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+          if (!m_downloadAll) {</span>
<a href="#l5.504"></a><span id="l5.504">             bool markOldRead = false;</span>
<a href="#l5.505"></a><span id="l5.505"> </span>
<a href="#l5.506"></a><span id="l5.506">             rv = nntpServer-&gt;GetMarkOldRead(&amp;markOldRead);</span>
<a href="#l5.507"></a><span id="l5.507">             if (NS_FAILED(rv)) markOldRead = false;</span>
<a href="#l5.508"></a><span id="l5.508"> </span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-            if (markOldRead &amp;&amp; m_set)</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-              m_set-&gt;AddRange(*first, *last - maxextra);</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+            if (markOldRead &amp;&amp; m_set) m_set-&gt;AddRange(*first, *last - maxextra);</span>
<a href="#l5.512"></a><span id="l5.512">             *first = *last - maxextra + 1;</span>
<a href="#l5.513"></a><span id="l5.513">           }</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-        }</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-        else</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+        } else</span>
<a href="#l5.517"></a><span id="l5.517">           *first = *last = 0;</span>
<a href="#l5.518"></a><span id="l5.518">         m_promptedAlready = true;</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-      }</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-      else if (m_promptedAlready &amp;&amp; !m_downloadAll)</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+      } else if (m_promptedAlready &amp;&amp; !m_downloadAll)</span>
<a href="#l5.522"></a><span id="l5.522">         *first = *last - m_maxArticles + 1;</span>
<a href="#l5.523"></a><span id="l5.523">       else if (!m_downloadAll)</span>
<a href="#l5.524"></a><span id="l5.524">         *first = *last - maxextra + 1;</span>
<a href="#l5.525"></a><span id="l5.525">     }</span>
<a href="#l5.526"></a><span id="l5.526">   }</span>
<a href="#l5.527"></a><span id="l5.527"> </span>
<a href="#l5.528"></a><span id="l5.528">   m_firstMsgToDownload = *first;</span>
<a href="#l5.529"></a><span id="l5.529">   m_lastMsgToDownload = *last;</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-  *status=0;</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+  *status = 0;</span>
<a href="#l5.532"></a><span id="l5.532">   return NS_OK;</span>
<a href="#l5.533"></a><span id="l5.533"> }</span>
<a href="#l5.534"></a><span id="l5.534"> </span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-nsresult</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-nsNNTPNewsgroupList::AddToKnownArticles(int32_t first, int32_t last)</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-{</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+nsresult nsNNTPNewsgroupList::AddToKnownArticles(int32_t first, int32_t last) {</span>
<a href="#l5.539"></a><span id="l5.539">   nsresult status;</span>
<a href="#l5.540"></a><span id="l5.540"> </span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-  if (!m_knownArts.set)</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-  {</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+  if (!m_knownArts.set) {</span>
<a href="#l5.544"></a><span id="l5.544">     m_knownArts.set = nsMsgKeySet::Create();</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineminus">-    if (!m_knownArts.set)</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+    if (!m_knownArts.set) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.548"></a><span id="l5.548">   }</span>
<a href="#l5.549"></a><span id="l5.549"> </span>
<a href="#l5.550"></a><span id="l5.550">   // XXX Casting int to nsresult</span>
<a href="#l5.551"></a><span id="l5.551">   status = static_cast&lt;nsresult&gt;(m_knownArts.set-&gt;AddRange(first, last));</span>
<a href="#l5.552"></a><span id="l5.552"> </span>
<a href="#l5.553"></a><span id="l5.553">   if (m_newsDB) {</span>
<a href="#l5.554"></a><span id="l5.554">     nsresult rv = NS_OK;</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; newsGroupInfo;</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; newsGroupInfo;</span>
<a href="#l5.557"></a><span id="l5.557">     rv = m_newsDB-&gt;GetDBFolderInfo(getter_AddRefs(newsGroupInfo));</span>
<a href="#l5.558"></a><span id="l5.558">     if (NS_SUCCEEDED(rv) &amp;&amp; newsGroupInfo) {</span>
<a href="#l5.559"></a><span id="l5.559">       nsCString output;</span>
<a href="#l5.560"></a><span id="l5.560">       status = m_knownArts.set-&gt;Output(getter_Copies(output));</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineminus">-      if (!output.IsEmpty())</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineminus">-        newsGroupInfo-&gt;SetKnownArtsSet(output.get());</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+      if (!output.IsEmpty()) newsGroupInfo-&gt;SetKnownArtsSet(output.get());</span>
<a href="#l5.564"></a><span id="l5.564">     }</span>
<a href="#l5.565"></a><span id="l5.565">   }</span>
<a href="#l5.566"></a><span id="l5.566">   return status;</span>
<a href="#l5.567"></a><span id="l5.567"> }</span>
<a href="#l5.568"></a><span id="l5.568"> </span>
<a href="#l5.569"></a><span id="l5.569" class="difflineminus">-nsresult</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineminus">-nsNNTPNewsgroupList::InitXOVER(int32_t first_msg, int32_t last_msg)</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineminus">-{</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+nsresult nsNNTPNewsgroupList::InitXOVER(int32_t first_msg, int32_t last_msg) {</span>
<a href="#l5.573"></a><span id="l5.573">   /* Consistency checks, not that I know what to do if it fails (it will</span>
<a href="#l5.574"></a><span id="l5.574">    probably handle it OK...) */</span>
<a href="#l5.575"></a><span id="l5.575">   NS_ASSERTION(first_msg &lt;= last_msg, &quot;first &gt; last&quot;);</span>
<a href="#l5.576"></a><span id="l5.576"> </span>
<a href="#l5.577"></a><span id="l5.577">   /* If any XOVER lines from the last time failed to come in, mark those</span>
<a href="#l5.578"></a><span id="l5.578">      messages as read. */</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-  if (m_lastProcessedNumber &lt; m_lastMsgNumber)</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-  {</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+  if (m_lastProcessedNumber &lt; m_lastMsgNumber) {</span>
<a href="#l5.582"></a><span id="l5.582">     m_set-&gt;AddRange(m_lastProcessedNumber + 1, m_lastMsgNumber);</span>
<a href="#l5.583"></a><span id="l5.583">   }</span>
<a href="#l5.584"></a><span id="l5.584">   m_firstMsgNumber = first_msg;</span>
<a href="#l5.585"></a><span id="l5.585">   m_lastMsgNumber = last_msg;</span>
<a href="#l5.586"></a><span id="l5.586">   m_lastProcessedNumber = first_msg &gt; 1 ? first_msg - 1 : 1;</span>
<a href="#l5.587"></a><span id="l5.587">   m_currentXHDRIndex = -1;</span>
<a href="#l5.588"></a><span id="l5.588">   return NS_OK;</span>
<a href="#l5.589"></a><span id="l5.589"> }</span>
<a href="#l5.590"></a><span id="l5.590"> </span>
<a href="#l5.591"></a><span id="l5.591"> // from RFC 822, don't translate</span>
<a href="#l5.592"></a><span id="l5.592"> #define FROM_HEADER &quot;From: &quot;</span>
<a href="#l5.593"></a><span id="l5.593"> #define SUBJECT_HEADER &quot;Subject: &quot;</span>
<a href="#l5.594"></a><span id="l5.594"> #define DATE_HEADER &quot;Date: &quot;</span>
<a href="#l5.595"></a><span id="l5.595"> </span>
<a href="#l5.596"></a><span id="l5.596" class="difflineminus">-nsresult</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineminus">-nsNNTPNewsgroupList::ParseLine(char *line, uint32_t * message_number)</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-{</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+nsresult nsNNTPNewsgroupList::ParseLine(char *line, uint32_t *message_number) {</span>
<a href="#l5.600"></a><span id="l5.600">   nsresult rv = NS_OK;</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l5.603"></a><span id="l5.603"> </span>
<a href="#l5.604"></a><span id="l5.604">   if (!line || !message_number) {</span>
<a href="#l5.605"></a><span id="l5.605">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.606"></a><span id="l5.606">   }</span>
<a href="#l5.607"></a><span id="l5.607"> </span>
<a href="#l5.608"></a><span id="l5.608">   char *next = line;</span>
<a href="#l5.609"></a><span id="l5.609"> </span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-#define GET_TOKEN()                           \</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-  line = next;                                \</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-  next = (line ? PL_strchr (line, '\t') : 0); \</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+#define GET_TOKEN()                          \</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+  line = next;                               \</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+  next = (line ? PL_strchr(line, '\t') : 0); \</span>
<a href="#l5.616"></a><span id="l5.616">   if (next) *next++ = 0</span>
<a href="#l5.617"></a><span id="l5.617"> </span>
<a href="#l5.618"></a><span id="l5.618" class="difflineminus">-  GET_TOKEN (); /* message number */</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+  GET_TOKEN(); /* message number */</span>
<a href="#l5.620"></a><span id="l5.620">   *message_number = atol(line);</span>
<a href="#l5.621"></a><span id="l5.621"> </span>
<a href="#l5.622"></a><span id="l5.622">   if (atol(line) == 0) /* bogus xover data */</span>
<a href="#l5.623"></a><span id="l5.623">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l5.624"></a><span id="l5.624"> </span>
<a href="#l5.625"></a><span id="l5.625">   m_newsDB-&gt;CreateNewHdr(*message_number, getter_AddRefs(newMsgHdr));</span>
<a href="#l5.626"></a><span id="l5.626"> </span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-  NS_ASSERTION(newMsgHdr, &quot;CreateNewHdr didn't fail, but it returned a null newMsgHdr&quot;);</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-  if (!newMsgHdr)</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+  NS_ASSERTION(newMsgHdr,</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+               &quot;CreateNewHdr didn't fail, but it returned a null newMsgHdr&quot;);</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+  if (!newMsgHdr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.633"></a><span id="l5.633"> </span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-  GET_TOKEN (); /* subject */</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+  GET_TOKEN(); /* subject */</span>
<a href="#l5.636"></a><span id="l5.636">   if (line) {</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-    const char *subject = line;  /* #### const evilness */</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+    const char *subject = line; /* #### const evilness */</span>
<a href="#l5.639"></a><span id="l5.639"> </span>
<a href="#l5.640"></a><span id="l5.640">     uint32_t flags = 0;</span>
<a href="#l5.641"></a><span id="l5.641">     // ### should call IsHeaderRead here...</span>
<a href="#l5.642"></a><span id="l5.642">     /* strip &quot;Re: &quot; */</span>
<a href="#l5.643"></a><span id="l5.643">     nsCString modifiedSubject;</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineminus">-    bool strippedRE = NS_MsgStripRE(nsDependentCString(subject), modifiedSubject);</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineminus">-    if (strippedRE)</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-      (void) newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::HasRe, &amp;flags);</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+    bool strippedRE =</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+        NS_MsgStripRE(nsDependentCString(subject), modifiedSubject);</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+    if (strippedRE) (void)newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::HasRe, &amp;flags);</span>
<a href="#l5.650"></a><span id="l5.650"> </span>
<a href="#l5.651"></a><span id="l5.651">     // this will make sure read flags agree with newsrc</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-    if (! (flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+    if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l5.654"></a><span id="l5.654">       rv = newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;flags);</span>
<a href="#l5.655"></a><span id="l5.655"> </span>
<a href="#l5.656"></a><span id="l5.656">     rv = newMsgHdr-&gt;SetSubject(strippedRE ? modifiedSubject.get() : subject);</span>
<a href="#l5.657"></a><span id="l5.657"> </span>
<a href="#l5.658"></a><span id="l5.658" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineminus">-      return rv;</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.661"></a><span id="l5.661">   }</span>
<a href="#l5.662"></a><span id="l5.662"> </span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-  GET_TOKEN (); /* author */</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+  GET_TOKEN(); /* author */</span>
<a href="#l5.665"></a><span id="l5.665">   if (line) {</span>
<a href="#l5.666"></a><span id="l5.666">     rv = newMsgHdr-&gt;SetAuthor(line);</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineminus">-      return rv;</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.670"></a><span id="l5.670">   }</span>
<a href="#l5.671"></a><span id="l5.671"> </span>
<a href="#l5.672"></a><span id="l5.672" class="difflineminus">-  GET_TOKEN ();</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+  GET_TOKEN();</span>
<a href="#l5.674"></a><span id="l5.674">   if (line) {</span>
<a href="#l5.675"></a><span id="l5.675">     PRTime date;</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineminus">-    PRStatus status = PR_ParseTimeString (line, false, &amp;date);</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+    PRStatus status = PR_ParseTimeString(line, false, &amp;date);</span>
<a href="#l5.678"></a><span id="l5.678">     if (PR_SUCCESS == status) {</span>
<a href="#l5.679"></a><span id="l5.679">       rv = newMsgHdr-&gt;SetDate(date); /* date */</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-        return rv;</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.683"></a><span id="l5.683">     }</span>
<a href="#l5.684"></a><span id="l5.684">   }</span>
<a href="#l5.685"></a><span id="l5.685"> </span>
<a href="#l5.686"></a><span id="l5.686" class="difflineminus">-  GET_TOKEN (); /* message id */</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+  GET_TOKEN(); /* message id */</span>
<a href="#l5.688"></a><span id="l5.688">   if (line) {</span>
<a href="#l5.689"></a><span id="l5.689">     char *strippedId = line;</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineminus">-    if (strippedId[0] == '&lt;')</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineminus">-      strippedId++;</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-    char * lastChar = strippedId + PL_strlen(strippedId) -1;</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+    if (strippedId[0] == '&lt;') strippedId++;</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+    char *lastChar = strippedId + PL_strlen(strippedId) - 1;</span>
<a href="#l5.695"></a><span id="l5.695"> </span>
<a href="#l5.696"></a><span id="l5.696" class="difflineminus">-    if (*lastChar == '&gt;')</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineminus">-      *lastChar = '\0';</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+    if (*lastChar == '&gt;') *lastChar = '\0';</span>
<a href="#l5.699"></a><span id="l5.699"> </span>
<a href="#l5.700"></a><span id="l5.700">     rv = newMsgHdr-&gt;SetMessageId(strippedId);</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineminus">-      return rv;</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.704"></a><span id="l5.704">   }</span>
<a href="#l5.705"></a><span id="l5.705"> </span>
<a href="#l5.706"></a><span id="l5.706" class="difflineminus">-  GET_TOKEN (); /* references */</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+  GET_TOKEN(); /* references */</span>
<a href="#l5.708"></a><span id="l5.708">   if (line) {</span>
<a href="#l5.709"></a><span id="l5.709">     rv = newMsgHdr-&gt;SetReferences(line);</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-      return rv;</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.713"></a><span id="l5.713">   }</span>
<a href="#l5.714"></a><span id="l5.714"> </span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-  GET_TOKEN (); /* bytes */</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+  GET_TOKEN(); /* bytes */</span>
<a href="#l5.717"></a><span id="l5.717">   if (line) {</span>
<a href="#l5.718"></a><span id="l5.718">     uint32_t msgSize = 0;</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineminus">-    msgSize = (line) ? atol (line) : 0;</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+    msgSize = (line) ? atol(line) : 0;</span>
<a href="#l5.721"></a><span id="l5.721"> </span>
<a href="#l5.722"></a><span id="l5.722">     rv = newMsgHdr-&gt;SetMessageSize(msgSize);</span>
<a href="#l5.723"></a><span id="l5.723">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.724"></a><span id="l5.724">   }</span>
<a href="#l5.725"></a><span id="l5.725"> </span>
<a href="#l5.726"></a><span id="l5.726" class="difflineminus">-  GET_TOKEN (); /* lines */</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+  GET_TOKEN(); /* lines */</span>
<a href="#l5.728"></a><span id="l5.728">   if (line) {</span>
<a href="#l5.729"></a><span id="l5.729">     uint32_t numLines = 0;</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineminus">-    numLines = line ? atol (line) : 0;</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+    numLines = line ? atol(line) : 0;</span>
<a href="#l5.732"></a><span id="l5.732">     rv = newMsgHdr-&gt;SetLineCount(numLines);</span>
<a href="#l5.733"></a><span id="l5.733">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.734"></a><span id="l5.734">   }</span>
<a href="#l5.735"></a><span id="l5.735"> </span>
<a href="#l5.736"></a><span id="l5.736" class="difflineminus">-  GET_TOKEN (); /* xref */</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+  GET_TOKEN(); /* xref */</span>
<a href="#l5.738"></a><span id="l5.738"> </span>
<a href="#l5.739"></a><span id="l5.739">   m_newHeaders.AppendObject(newMsgHdr);</span>
<a href="#l5.740"></a><span id="l5.740">   return NS_OK;</span>
<a href="#l5.741"></a><span id="l5.741"> }</span>
<a href="#l5.742"></a><span id="l5.742"> </span>
<a href="#l5.743"></a><span id="l5.743" class="difflineminus">-NS_IMETHODIMP nsNNTPNewsgroupList::ApplyFilterHit(nsIMsgFilter *aFilter, nsIMsgWindow *aMsgWindow, bool *aApplyMore)</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineminus">-{</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+NS_IMETHODIMP nsNNTPNewsgroupList::ApplyFilterHit(nsIMsgFilter *aFilter,</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+                                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+                                                  bool *aApplyMore) {</span>
<a href="#l5.748"></a><span id="l5.748">   NS_ENSURE_ARG_POINTER(aFilter);</span>
<a href="#l5.749"></a><span id="l5.749">   NS_ENSURE_ARG_POINTER(aApplyMore);</span>
<a href="#l5.750"></a><span id="l5.750">   NS_ENSURE_TRUE(m_newMsgHdr, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.751"></a><span id="l5.751">   NS_ENSURE_TRUE(m_newsDB, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.752"></a><span id="l5.752"> </span>
<a href="#l5.753"></a><span id="l5.753">   // you can't move news messages, so applyMore is always true</span>
<a href="#l5.754"></a><span id="l5.754">   *aApplyMore = true;</span>
<a href="#l5.755"></a><span id="l5.755"> </span>
<a href="#l5.756"></a><span id="l5.756" class="difflineat">@@ -630,697 +575,599 @@ NS_IMETHODIMP nsNNTPNewsgroupList::Apply</span>
<a href="#l5.757"></a><span id="l5.757">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.758"></a><span id="l5.758"> </span>
<a href="#l5.759"></a><span id="l5.759">   bool loggingEnabled = false;</span>
<a href="#l5.760"></a><span id="l5.760">   nsCOMPtr&lt;nsIMsgFilterList&gt; currentFilterList;</span>
<a href="#l5.761"></a><span id="l5.761">   rv = aFilter-&gt;GetFilterList(getter_AddRefs(currentFilterList));</span>
<a href="#l5.762"></a><span id="l5.762">   if (NS_SUCCEEDED(rv) &amp;&amp; currentFilterList &amp;&amp; numActions)</span>
<a href="#l5.763"></a><span id="l5.763">     currentFilterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l5.764"></a><span id="l5.764"> </span>
<a href="#l5.765"></a><span id="l5.765" class="difflineminus">-  for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++)</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineminus">-  {</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+  for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++) {</span>
<a href="#l5.768"></a><span id="l5.768">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-      do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineminus">-    if (NS_FAILED(rv) || !filterAction)</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineminus">-      continue;</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+        do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+    if (NS_FAILED(rv) || !filterAction) continue;</span>
<a href="#l5.774"></a><span id="l5.774"> </span>
<a href="#l5.775"></a><span id="l5.775">     nsMsgRuleActionType actionType;</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineminus">-    if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType)))</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineminus">-    {</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineminus">-      if (loggingEnabled)</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineminus">-        (void) aFilter-&gt;LogRuleHit(filterAction, m_newMsgHdr);</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+    if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType))) {</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+      if (loggingEnabled) (void)aFilter-&gt;LogRuleHit(filterAction, m_newMsgHdr);</span>
<a href="#l5.782"></a><span id="l5.782"> </span>
<a href="#l5.783"></a><span id="l5.783" class="difflineminus">-      switch (actionType)</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineminus">-      {</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-      case nsMsgFilterAction::Delete:</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineminus">-        m_addHdrToDB = false;</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineminus">-        break;</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineminus">-      case nsMsgFilterAction::MarkRead:</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineminus">-        m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, true, nullptr);</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineminus">-        break;</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineminus">-      case nsMsgFilterAction::MarkUnread:</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineminus">-        m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, false, nullptr);</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineminus">-        break;</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-      case nsMsgFilterAction::KillThread:</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineminus">-        m_newMsgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineminus">-        break;</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineminus">-      case nsMsgFilterAction::KillSubthread:</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineminus">-        {</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+      switch (actionType) {</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+        case nsMsgFilterAction::Delete:</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+          m_addHdrToDB = false;</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+          break;</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+        case nsMsgFilterAction::MarkRead:</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+          m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, true, nullptr);</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+          break;</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+        case nsMsgFilterAction::MarkUnread:</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+          m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, false, nullptr);</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+          break;</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+        case nsMsgFilterAction::KillThread:</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+          m_newMsgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+                                         nsMsgMessageFlags::Ignored);</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+          break;</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+        case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l5.814"></a><span id="l5.814">           uint32_t newFlags;</span>
<a href="#l5.815"></a><span id="l5.815">           m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineminus">-        }</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineminus">-        break;</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineminus">-      case nsMsgFilterAction::WatchThread:</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineminus">-        {</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineplus">+        } break;</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+        case nsMsgFilterAction::WatchThread: {</span>
<a href="#l5.822"></a><span id="l5.822">           uint32_t newFlags;</span>
<a href="#l5.823"></a><span id="l5.823">           m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineminus">-        }</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-        break;</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-      case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-        m_newMsgHdr-&gt;MarkFlagged(true);</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineminus">-        break;</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineminus">-      case nsMsgFilterAction::ChangePriority:</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineminus">-        {</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+        } break;</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+        case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+          m_newMsgHdr-&gt;MarkFlagged(true);</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+          break;</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+        case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l5.836"></a><span id="l5.836">           nsMsgPriorityValue filterPriority;</span>
<a href="#l5.837"></a><span id="l5.837">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l5.838"></a><span id="l5.838">           m_newMsgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+        } break;</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+        case nsMsgFilterAction::AddTag: {</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+          nsCString keyword;</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+          filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+          messageArray-&gt;AppendElement(m_newMsgHdr);</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+          if (folder) folder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+          break;</span>
<a href="#l5.849"></a><span id="l5.849">         }</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineminus">-        break;</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineminus">-      case nsMsgFilterAction::AddTag:</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineminus">-      {</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-        nsCString keyword;</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineminus">-        filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineminus">-        messageArray-&gt;AppendElement(m_newMsgHdr);</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineminus">-        if (folder)</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineminus">-          folder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-        break;</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineminus">-      }</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineminus">-      case nsMsgFilterAction::Label:</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineminus">-        {</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+        case nsMsgFilterAction::Label: {</span>
<a href="#l5.865"></a><span id="l5.865">           nsMsgLabelValue filterLabel;</span>
<a href="#l5.866"></a><span id="l5.866">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l5.867"></a><span id="l5.867">           nsMsgKey msgKey;</span>
<a href="#l5.868"></a><span id="l5.868">           m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.869"></a><span id="l5.869">           m_newsDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineminus">-        }</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineminus">-        break;</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+        } break;</span>
<a href="#l5.873"></a><span id="l5.873"> </span>
<a href="#l5.874"></a><span id="l5.874" class="difflineminus">-      case nsMsgFilterAction::StopExecution:</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineminus">-      {</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-        // don't apply any more filters</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-        *aApplyMore = false;</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineminus">-      }</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineminus">-      break;</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+        case nsMsgFilterAction::StopExecution: {</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineplus">+          // don't apply any more filters</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineplus">+          *aApplyMore = false;</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+        } break;</span>
<a href="#l5.884"></a><span id="l5.884"> </span>
<a href="#l5.885"></a><span id="l5.885" class="difflineminus">-      case nsMsgFilterAction::Custom:</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-      {</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineminus">-        rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineplus">+        case nsMsgFilterAction::Custom: {</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+          rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.894"></a><span id="l5.894"> </span>
<a href="#l5.895"></a><span id="l5.895" class="difflineminus">-        nsAutoCString value;</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineminus">-        filterAction-&gt;GetStrValue(value);</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineplus">+          nsAutoCString value;</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+          filterAction-&gt;GetStrValue(value);</span>
<a href="#l5.899"></a><span id="l5.899"> </span>
<a href="#l5.900"></a><span id="l5.900" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineminus">-            do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineminus">-        NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineminus">-        messageArray-&gt;AppendElement(m_newMsgHdr);</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+          NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+          messageArray-&gt;AppendElement(m_newMsgHdr);</span>
<a href="#l5.908"></a><span id="l5.908"> </span>
<a href="#l5.909"></a><span id="l5.909" class="difflineminus">-        customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineminus">-                            nsMsgFilterType::NewsRule, aMsgWindow);</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineminus">-      }</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineminus">-      break;</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+          customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineplus">+                              nsMsgFilterType::NewsRule, aMsgWindow);</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineplus">+        } break;</span>
<a href="#l5.916"></a><span id="l5.916"> </span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-      default:</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-        NS_ERROR(&quot;unexpected action&quot;);</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-        break;</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+        default:</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineplus">+          NS_ERROR(&quot;unexpected action&quot;);</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+          break;</span>
<a href="#l5.923"></a><span id="l5.923">       }</span>
<a href="#l5.924"></a><span id="l5.924">     }</span>
<a href="#l5.925"></a><span id="l5.925">   }</span>
<a href="#l5.926"></a><span id="l5.926">   return NS_OK;</span>
<a href="#l5.927"></a><span id="l5.927"> }</span>
<a href="#l5.928"></a><span id="l5.928"> </span>
<a href="#l5.929"></a><span id="l5.929" class="difflineminus">-nsresult</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineminus">-nsNNTPNewsgroupList::ProcessXOVERLINE(const char *line, uint32_t *status)</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineminus">-{</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineminus">-  uint32_t message_number=0;</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+nsresult nsNNTPNewsgroupList::ProcessXOVERLINE(const char *line,</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+                                               uint32_t *status) {</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+  uint32_t message_number = 0;</span>
<a href="#l5.936"></a><span id="l5.936">   //  int32_t lines;</span>
<a href="#l5.937"></a><span id="l5.937">   nsresult rv = NS_OK;</span>
<a href="#l5.938"></a><span id="l5.938"> </span>
<a href="#l5.939"></a><span id="l5.939">   NS_ASSERTION(line, &quot;null ptr&quot;);</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineminus">-  if (!line)</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineplus">+  if (!line) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.943"></a><span id="l5.943"> </span>
<a href="#l5.944"></a><span id="l5.944" class="difflineminus">-  if (m_newsDB)</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineminus">-  {</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+  if (m_newsDB) {</span>
<a href="#l5.947"></a><span id="l5.947">     char *xoverline = PL_strdup(line);</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineminus">-    if (!xoverline)</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+    if (!xoverline) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.951"></a><span id="l5.951">     rv = ParseLine(xoverline, &amp;message_number);</span>
<a href="#l5.952"></a><span id="l5.952">     PL_strfree(xoverline);</span>
<a href="#l5.953"></a><span id="l5.953">     xoverline = nullptr;</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-      return rv;</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineminus">-  }</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-  else</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+  } else</span>
<a href="#l5.960"></a><span id="l5.960">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l5.961"></a><span id="l5.961"> </span>
<a href="#l5.962"></a><span id="l5.962" class="difflineminus">-  NS_ASSERTION(message_number &gt; m_lastProcessedNumber ||</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineminus">-               message_number == 1, &quot;bad message_number&quot;);</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineminus">-  if (m_set &amp;&amp; message_number &gt; m_lastProcessedNumber + 1)</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineminus">-  {</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineminus">-  /* There are some articles that XOVER skipped; they must no longer</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineminus">-     exist.  Mark them as read in the newsrc, so we don't include them</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineminus">-     next time in our estimated number of unread messages. */</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineminus">-    if (m_set-&gt;AddRange(m_lastProcessedNumber + 1, message_number - 1))</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineminus">-    {</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineminus">-    /* This isn't really an important enough change to warrant causing</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineminus">-       the newsrc file to be saved; we haven't gathered any information</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineminus">-       that won't also be gathered for free next time.  */</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineplus">+  NS_ASSERTION(message_number &gt; m_lastProcessedNumber || message_number == 1,</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineplus">+               &quot;bad message_number&quot;);</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineplus">+  if (m_set &amp;&amp; message_number &gt; m_lastProcessedNumber + 1) {</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineplus">+    /* There are some articles that XOVER skipped; they must no longer</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineplus">+       exist.  Mark them as read in the newsrc, so we don't include them</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+       next time in our estimated number of unread messages. */</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineplus">+    if (m_set-&gt;AddRange(m_lastProcessedNumber + 1, message_number - 1)) {</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+      /* This isn't really an important enough change to warrant causing</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineplus">+         the newsrc file to be saved; we haven't gathered any information</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineplus">+         that won't also be gathered for free next time.  */</span>
<a href="#l5.984"></a><span id="l5.984">     }</span>
<a href="#l5.985"></a><span id="l5.985">   }</span>
<a href="#l5.986"></a><span id="l5.986"> </span>
<a href="#l5.987"></a><span id="l5.987">   m_lastProcessedNumber = message_number;</span>
<a href="#l5.988"></a><span id="l5.988" class="difflineminus">-  if (m_knownArts.set)</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineminus">-  {</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineplus">+  if (m_knownArts.set) {</span>
<a href="#l5.991"></a><span id="l5.991">     int result = m_knownArts.set-&gt;Add(message_number);</span>
<a href="#l5.992"></a><span id="l5.992">     if (result &lt; 0) {</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineminus">-      if (status)</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineminus">-        *status = result;</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineplus">+      if (status) *status = result;</span>
<a href="#l5.996"></a><span id="l5.996">       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l5.997"></a><span id="l5.997">     }</span>
<a href="#l5.998"></a><span id="l5.998">   }</span>
<a href="#l5.999"></a><span id="l5.999"> </span>
<a href="#l5.1000"></a><span id="l5.1000">   if (message_number &gt; m_lastMsgNumber)</span>
<a href="#l5.1001"></a><span id="l5.1001">     m_lastMsgNumber = message_number;</span>
<a href="#l5.1002"></a><span id="l5.1002">   else if (message_number &lt; m_firstMsgNumber)</span>
<a href="#l5.1003"></a><span id="l5.1003">     m_firstMsgNumber = message_number;</span>
<a href="#l5.1004"></a><span id="l5.1004"> </span>
<a href="#l5.1005"></a><span id="l5.1005">   if (m_set) {</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineminus">-    (void) m_set-&gt;IsMember(message_number);</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineplus">+    (void)m_set-&gt;IsMember(message_number);</span>
<a href="#l5.1008"></a><span id="l5.1008">   }</span>
<a href="#l5.1009"></a><span id="l5.1009"> </span>
<a href="#l5.1010"></a><span id="l5.1010">   /* Update the progress meter with a percentage of articles retrieved */</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineminus">-  if (m_lastMsgNumber &gt; m_firstMsgNumber)</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineminus">-  {</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+  if (m_lastMsgNumber &gt; m_firstMsgNumber) {</span>
<a href="#l5.1014"></a><span id="l5.1014">     int32_t totalToDownload = m_lastMsgToDownload - m_firstMsgToDownload + 1;</span>
<a href="#l5.1015"></a><span id="l5.1015">     int32_t lastIndex = m_lastProcessedNumber - m_firstMsgNumber + 1;</span>
<a href="#l5.1016"></a><span id="l5.1016">     int32_t numDownloaded = lastIndex;</span>
<a href="#l5.1017"></a><span id="l5.1017">     int32_t totIndex = m_lastMsgNumber - m_firstMsgNumber + 1;</span>
<a href="#l5.1018"></a><span id="l5.1018"> </span>
<a href="#l5.1019"></a><span id="l5.1019">     PRTime elapsedTime = PR_Now() - m_lastStatusUpdate;</span>
<a href="#l5.1020"></a><span id="l5.1020"> </span>
<a href="#l5.1021"></a><span id="l5.1021">     if (elapsedTime &gt; MIN_STATUS_UPDATE_INTERVAL || lastIndex == totIndex)</span>
<a href="#l5.1022"></a><span id="l5.1022">       UpdateStatus(false, numDownloaded, totalToDownload);</span>
<a href="#l5.1023"></a><span id="l5.1023">   }</span>
<a href="#l5.1024"></a><span id="l5.1024">   return NS_OK;</span>
<a href="#l5.1025"></a><span id="l5.1025"> }</span>
<a href="#l5.1026"></a><span id="l5.1026"> </span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineminus">-nsresult</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineminus">-nsNNTPNewsgroupList::ResetXOVER()</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineminus">-{</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineplus">+nsresult nsNNTPNewsgroupList::ResetXOVER() {</span>
<a href="#l5.1031"></a><span id="l5.1031">   m_lastMsgNumber = m_firstMsgNumber;</span>
<a href="#l5.1032"></a><span id="l5.1032">   m_lastProcessedNumber = m_lastMsgNumber;</span>
<a href="#l5.1033"></a><span id="l5.1033">   return NS_OK;</span>
<a href="#l5.1034"></a><span id="l5.1034"> }</span>
<a href="#l5.1035"></a><span id="l5.1035"> </span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineminus">-nsresult</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineminus">-nsNNTPNewsgroupList::FinishXOVERLINE(int status, int *newstatus)</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineminus">-{</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+nsresult nsNNTPNewsgroupList::FinishXOVERLINE(int status, int *newstatus) {</span>
<a href="#l5.1040"></a><span id="l5.1040">   nsresult rv;</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineminus">-  struct MSG_NewsKnown* k;</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineplus">+  struct MSG_NewsKnown *k;</span>
<a href="#l5.1043"></a><span id="l5.1043"> </span>
<a href="#l5.1044"></a><span id="l5.1044">   /* If any XOVER lines from the last time failed to come in, mark those</span>
<a href="#l5.1045"></a><span id="l5.1045">      messages as read. */</span>
<a href="#l5.1046"></a><span id="l5.1046"> </span>
<a href="#l5.1047"></a><span id="l5.1047">   if (status &gt;= 0 &amp;&amp; m_lastProcessedNumber &lt; m_lastMsgNumber) {</span>
<a href="#l5.1048"></a><span id="l5.1048">     m_set-&gt;AddRange(m_lastProcessedNumber + 1, m_lastMsgNumber);</span>
<a href="#l5.1049"></a><span id="l5.1049">   }</span>
<a href="#l5.1050"></a><span id="l5.1050"> </span>
<a href="#l5.1051"></a><span id="l5.1051">   if (m_lastProcessedNumber)</span>
<a href="#l5.1052"></a><span id="l5.1052">     AddToKnownArticles(m_firstMsgNumber, m_lastProcessedNumber);</span>
<a href="#l5.1053"></a><span id="l5.1053"> </span>
<a href="#l5.1054"></a><span id="l5.1054">   k = &amp;m_knownArts;</span>
<a href="#l5.1055"></a><span id="l5.1055"> </span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineminus">-  if (k &amp;&amp; k-&gt;set)</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineminus">-  {</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineplus">+  if (k &amp;&amp; k-&gt;set) {</span>
<a href="#l5.1059"></a><span id="l5.1059">     int32_t n = k-&gt;set-&gt;FirstNonMember();</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineminus">-    if (n &lt; k-&gt;first_possible || n &gt; k-&gt;last_possible)</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineminus">-    {</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineplus">+    if (n &lt; k-&gt;first_possible || n &gt; k-&gt;last_possible) {</span>
<a href="#l5.1063"></a><span id="l5.1063">       /* We know we've gotten all there is to know.</span>
<a href="#l5.1064"></a><span id="l5.1064">          Take advantage of that to update our counts... */</span>
<a href="#l5.1065"></a><span id="l5.1065">       // ### dmb</span>
<a href="#l5.1066"></a><span id="l5.1066">     }</span>
<a href="#l5.1067"></a><span id="l5.1067">   }</span>
<a href="#l5.1068"></a><span id="l5.1068"> </span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineminus">-  if (!m_finishingXover)</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineminus">-  {</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineplus">+  if (!m_finishingXover) {</span>
<a href="#l5.1072"></a><span id="l5.1072">     // turn on m_finishingXover - this is a horrible hack to avoid recursive</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineminus">-    // calls which happen when the fe selects a message as a result of getting EndingUpdate,</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineminus">-    // which interrupts this url right before it was going to finish and causes FinishXOver</span>
<a href="#l5.1075"></a><span id="l5.1075" class="difflineminus">-    // to get called again.</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineplus">+    // calls which happen when the fe selects a message as a result of getting</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineplus">+    // EndingUpdate, which interrupts this url right before it was going to</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+    // finish and causes FinishXOver to get called again.</span>
<a href="#l5.1079"></a><span id="l5.1079">     m_finishingXover = true;</span>
<a href="#l5.1080"></a><span id="l5.1080"> </span>
<a href="#l5.1081"></a><span id="l5.1081">     // XXX is this correct?</span>
<a href="#l5.1082"></a><span id="l5.1082">     m_runningURL = nullptr;</span>
<a href="#l5.1083"></a><span id="l5.1083"> </span>
<a href="#l5.1084"></a><span id="l5.1084">     if (m_lastMsgNumber &gt; 0) {</span>
<a href="#l5.1085"></a><span id="l5.1085">       nsAutoString firstStr;</span>
<a href="#l5.1086"></a><span id="l5.1086">       firstStr.AppendInt(m_lastProcessedNumber - m_firstMsgNumber + 1);</span>
<a href="#l5.1087"></a><span id="l5.1087"> </span>
<a href="#l5.1088"></a><span id="l5.1088">       nsAutoString lastStr;</span>
<a href="#l5.1089"></a><span id="l5.1089">       lastStr.AppendInt(m_lastMsgNumber - m_firstMsgNumber + 1);</span>
<a href="#l5.1090"></a><span id="l5.1090"> </span>
<a href="#l5.1091"></a><span id="l5.1091">       nsString statusString;</span>
<a href="#l5.1092"></a><span id="l5.1092">       nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l5.1095"></a><span id="l5.1095">       NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.1096"></a><span id="l5.1096"> </span>
<a href="#l5.1097"></a><span id="l5.1097">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.1098"></a><span id="l5.1098">       rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l5.1099"></a><span id="l5.1099">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1100"></a><span id="l5.1100"> </span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineminus">-      const char16_t *formatStrings[2] = { firstStr.get(), lastStr.get() };</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(&quot;downloadingArticles&quot;, formatStrings, 2, statusString);</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineplus">+      const char16_t *formatStrings[2] = {firstStr.get(), lastStr.get()};</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;downloadingArticles&quot;, formatStrings, 2,</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineplus">+                                        statusString);</span>
<a href="#l5.1106"></a><span id="l5.1106">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1107"></a><span id="l5.1107"> </span>
<a href="#l5.1108"></a><span id="l5.1108">       SetProgressStatus(statusString.get());</span>
<a href="#l5.1109"></a><span id="l5.1109">     }</span>
<a href="#l5.1110"></a><span id="l5.1110">   }</span>
<a href="#l5.1111"></a><span id="l5.1111"> </span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineminus">-  if (newstatus)</span>
<a href="#l5.1113"></a><span id="l5.1113" class="difflineminus">-    *newstatus=0;</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineplus">+  if (newstatus) *newstatus = 0;</span>
<a href="#l5.1115"></a><span id="l5.1115"> </span>
<a href="#l5.1116"></a><span id="l5.1116">   return NS_OK;</span>
<a href="#l5.1117"></a><span id="l5.1117"> }</span>
<a href="#l5.1118"></a><span id="l5.1118"> </span>
<a href="#l5.1119"></a><span id="l5.1119"> NS_IMETHODIMP</span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineminus">-nsNNTPNewsgroupList::InitXHDR(nsACString &amp;header)</span>
<a href="#l5.1121"></a><span id="l5.1121" class="difflineminus">-{</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineplus">+nsNNTPNewsgroupList::InitXHDR(nsACString &amp;header) {</span>
<a href="#l5.1123"></a><span id="l5.1123">   if (++m_currentXHDRIndex &gt;= m_filterHeaders.Length())</span>
<a href="#l5.1124"></a><span id="l5.1124">     header.Truncate();</span>
<a href="#l5.1125"></a><span id="l5.1125">   else</span>
<a href="#l5.1126"></a><span id="l5.1126">     header.Assign(m_filterHeaders[m_currentXHDRIndex]);</span>
<a href="#l5.1127"></a><span id="l5.1127">   // Don't include these in our XHDR bouts, as they are already provided through</span>
<a href="#l5.1128"></a><span id="l5.1128">   // XOVER.</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineminus">-  if (header.EqualsLiteral(&quot;message-id&quot;) ||</span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineminus">-      header.EqualsLiteral(&quot;references&quot;))</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineplus">+  if (header.EqualsLiteral(&quot;message-id&quot;) || header.EqualsLiteral(&quot;references&quot;))</span>
<a href="#l5.1132"></a><span id="l5.1132">     return InitXHDR(header);</span>
<a href="#l5.1133"></a><span id="l5.1133">   return NS_OK;</span>
<a href="#l5.1134"></a><span id="l5.1134"> }</span>
<a href="#l5.1135"></a><span id="l5.1135"> </span>
<a href="#l5.1136"></a><span id="l5.1136"> NS_IMETHODIMP</span>
<a href="#l5.1137"></a><span id="l5.1137" class="difflineminus">-nsNNTPNewsgroupList::ProcessXHDRLine(const nsACString &amp;line)</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineminus">-{</span>
<a href="#l5.1139"></a><span id="l5.1139" class="difflineplus">+nsNNTPNewsgroupList::ProcessXHDRLine(const nsACString &amp;line) {</span>
<a href="#l5.1140"></a><span id="l5.1140">   int32_t middle = line.FindChar(' ');</span>
<a href="#l5.1141"></a><span id="l5.1141">   nsCString value, key = PromiseFlatCString(line);</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineminus">-  if (middle == -1)</span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineminus">-  value = Substring(line, middle+1);</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineplus">+  if (middle == -1) return NS_OK;</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+  value = Substring(line, middle + 1);</span>
<a href="#l5.1147"></a><span id="l5.1147">   key.SetLength((uint32_t)middle);</span>
<a href="#l5.1148"></a><span id="l5.1148"> </span>
<a href="#l5.1149"></a><span id="l5.1149">   // According to RFC 2980, some will send (none) instead.</span>
<a href="#l5.1150"></a><span id="l5.1150">   // So we don't treat this is an error.</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineminus">-  if (key.CharAt(0) &lt; '0' || key.CharAt(0) &gt; '9')</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineplus">+  if (key.CharAt(0) &lt; '0' || key.CharAt(0) &gt; '9') return NS_OK;</span>
<a href="#l5.1154"></a><span id="l5.1154"> </span>
<a href="#l5.1155"></a><span id="l5.1155">   nsresult rv;</span>
<a href="#l5.1156"></a><span id="l5.1156">   int32_t number = key.ToInteger(&amp;rv);</span>
<a href="#l5.1157"></a><span id="l5.1157">   NS_ENSURE_SUCCESS(rv, NS_ERROR_FAILURE);</span>
<a href="#l5.1158"></a><span id="l5.1158">   // RFC 2980 specifies one or more spaces.</span>
<a href="#l5.1159"></a><span id="l5.1159">   value.Trim(&quot; &quot;);</span>
<a href="#l5.1160"></a><span id="l5.1160"> </span>
<a href="#l5.1161"></a><span id="l5.1161">   nsCOMPtr&lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l5.1162"></a><span id="l5.1162">   rv = m_newsDB-&gt;GetMsgHdrForKey(number, getter_AddRefs(header));</span>
<a href="#l5.1163"></a><span id="l5.1163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1164"></a><span id="l5.1164"> </span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineminus">-  rv = header-&gt;SetStringProperty(m_filterHeaders[m_currentXHDRIndex].get(), value.get());</span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineplus">+  rv = header-&gt;SetStringProperty(m_filterHeaders[m_currentXHDRIndex].get(),</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+                                 value.get());</span>
<a href="#l5.1168"></a><span id="l5.1168">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1169"></a><span id="l5.1169"> </span>
<a href="#l5.1170"></a><span id="l5.1170">   int32_t totalToDownload = m_lastMsgToDownload - m_firstMsgToDownload + 1;</span>
<a href="#l5.1171"></a><span id="l5.1171">   int32_t numDownloaded = number - m_firstMsgNumber + 1;</span>
<a href="#l5.1172"></a><span id="l5.1172"> </span>
<a href="#l5.1173"></a><span id="l5.1173">   PRTime elapsedTime = PR_Now() - m_lastStatusUpdate;</span>
<a href="#l5.1174"></a><span id="l5.1174"> </span>
<a href="#l5.1175"></a><span id="l5.1175">   if (elapsedTime &gt; MIN_STATUS_UPDATE_INTERVAL)</span>
<a href="#l5.1176"></a><span id="l5.1176">     UpdateStatus(true, numDownloaded, totalToDownload);</span>
<a href="#l5.1177"></a><span id="l5.1177">   return rv;</span>
<a href="#l5.1178"></a><span id="l5.1178"> }</span>
<a href="#l5.1179"></a><span id="l5.1179"> </span>
<a href="#l5.1180"></a><span id="l5.1180"> NS_IMETHODIMP</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineminus">-nsNNTPNewsgroupList::InitHEAD(int32_t number)</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineminus">-{</span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineminus">-  if (m_newMsgHdr)</span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineminus">-  {</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineplus">+nsNNTPNewsgroupList::InitHEAD(int32_t number) {</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+  if (m_newMsgHdr) {</span>
<a href="#l5.1187"></a><span id="l5.1187">     // Finish processing for this header</span>
<a href="#l5.1188"></a><span id="l5.1188">     // If HEAD didn't properly return, then the header won't be set</span>
<a href="#l5.1189"></a><span id="l5.1189">     m_newHeaders.AppendObject(m_newMsgHdr);</span>
<a href="#l5.1190"></a><span id="l5.1190"> </span>
<a href="#l5.1191"></a><span id="l5.1191">     int32_t totalToDownload = m_lastMsgToDownload - m_firstMsgToDownload + 1;</span>
<a href="#l5.1192"></a><span id="l5.1192">     int32_t lastIndex = m_lastProcessedNumber - m_firstMsgNumber + 1;</span>
<a href="#l5.1193"></a><span id="l5.1193">     int32_t numDownloaded = lastIndex;</span>
<a href="#l5.1194"></a><span id="l5.1194">     int32_t totIndex = m_lastMsgNumber - m_firstMsgNumber + 1;</span>
<a href="#l5.1195"></a><span id="l5.1195"> </span>
<a href="#l5.1196"></a><span id="l5.1196">     PRTime elapsedTime = PR_Now() - m_lastStatusUpdate;</span>
<a href="#l5.1197"></a><span id="l5.1197"> </span>
<a href="#l5.1198"></a><span id="l5.1198">     if (elapsedTime &gt; MIN_STATUS_UPDATE_INTERVAL || lastIndex == totIndex)</span>
<a href="#l5.1199"></a><span id="l5.1199">       UpdateStatus(false, numDownloaded, totalToDownload);</span>
<a href="#l5.1200"></a><span id="l5.1200">   }</span>
<a href="#l5.1201"></a><span id="l5.1201"> </span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineminus">-  if (number &gt;= 0)</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineminus">-  {</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineminus">-    if (m_newHeaders.Count() &gt; 0 &amp;&amp; m_lastMsgNumber == m_lastProcessedNumber)</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineminus">-    {</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+  if (number &gt;= 0) {</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineplus">+    if (m_newHeaders.Count() &gt; 0 &amp;&amp; m_lastMsgNumber == m_lastProcessedNumber) {</span>
<a href="#l5.1208"></a><span id="l5.1208">       // We have done some processing of messages. This means that we have</span>
<a href="#l5.1209"></a><span id="l5.1209">       // relics of headers from XOVER. Since we will get everything from HEAD</span>
<a href="#l5.1210"></a><span id="l5.1210">       // anyways, just clear the array.</span>
<a href="#l5.1211"></a><span id="l5.1211">       m_newHeaders.Clear();</span>
<a href="#l5.1212"></a><span id="l5.1212">     }</span>
<a href="#l5.1213"></a><span id="l5.1213"> </span>
<a href="#l5.1214"></a><span id="l5.1214">     nsresult rv = m_newsDB-&gt;CreateNewHdr(number, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l5.1215"></a><span id="l5.1215">     m_lastProcessedNumber = number;</span>
<a href="#l5.1216"></a><span id="l5.1216">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineminus">-  }</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineminus">-  else</span>
<a href="#l5.1219"></a><span id="l5.1219" class="difflineminus">-  {</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineplus">+  } else {</span>
<a href="#l5.1221"></a><span id="l5.1221">     AddToKnownArticles(m_firstMsgNumber, m_lastProcessedNumber);</span>
<a href="#l5.1222"></a><span id="l5.1222">   }</span>
<a href="#l5.1223"></a><span id="l5.1223">   return NS_OK;</span>
<a href="#l5.1224"></a><span id="l5.1224"> }</span>
<a href="#l5.1225"></a><span id="l5.1225"> </span>
<a href="#l5.1226"></a><span id="l5.1226"> NS_IMETHODIMP</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineminus">-nsNNTPNewsgroupList::HEADFailed(int32_t number)</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineminus">-{</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineplus">+nsNNTPNewsgroupList::HEADFailed(int32_t number) {</span>
<a href="#l5.1230"></a><span id="l5.1230">   m_set-&gt;Add(number);</span>
<a href="#l5.1231"></a><span id="l5.1231">   return NS_OK;</span>
<a href="#l5.1232"></a><span id="l5.1232"> }</span>
<a href="#l5.1233"></a><span id="l5.1233"> </span>
<a href="#l5.1234"></a><span id="l5.1234"> NS_IMETHODIMP</span>
<a href="#l5.1235"></a><span id="l5.1235" class="difflineminus">-nsNNTPNewsgroupList::ProcessHEADLine(const nsACString &amp;line)</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineminus">-{</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineplus">+nsNNTPNewsgroupList::ProcessHEADLine(const nsACString &amp;line) {</span>
<a href="#l5.1238"></a><span id="l5.1238">   int32_t colon = line.FindChar(':');</span>
<a href="#l5.1239"></a><span id="l5.1239">   nsCString header = PromiseFlatCString(line), value;</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineminus">-  if (colon != -1)</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineminus">-  {</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineminus">-    value = Substring(line, colon+1);</span>
<a href="#l5.1243"></a><span id="l5.1243" class="difflineplus">+  if (colon != -1) {</span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineplus">+    value = Substring(line, colon + 1);</span>
<a href="#l5.1245"></a><span id="l5.1245">     header.SetLength((uint32_t)colon);</span>
<a href="#l5.1246"></a><span id="l5.1246" class="difflineminus">-  }</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineminus">-  else if (line.CharAt(0) == ' ' || line.CharAt(0) == '\t') // We are continuing the header</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineplus">+  } else if (line.CharAt(0) == ' ' ||</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineplus">+             line.CharAt(0) == '\t')  // We are continuing the header</span>
<a href="#l5.1250"></a><span id="l5.1250">   {</span>
<a href="#l5.1251"></a><span id="l5.1251" class="difflineminus">-    m_thisLine += header; // Preserve whitespace (should we?)</span>
<a href="#l5.1252"></a><span id="l5.1252" class="difflineplus">+    m_thisLine += header;  // Preserve whitespace (should we?)</span>
<a href="#l5.1253"></a><span id="l5.1253">     return NS_OK;</span>
<a href="#l5.1254"></a><span id="l5.1254" class="difflineminus">-  }</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineminus">-  else</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineminus">-  {</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineminus">-    return NS_OK; // We are malformed. Just ignore and hope for the best...</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineplus">+  } else {</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+    return NS_OK;  // We are malformed. Just ignore and hope for the best...</span>
<a href="#l5.1260"></a><span id="l5.1260">   }</span>
<a href="#l5.1261"></a><span id="l5.1261"> </span>
<a href="#l5.1262"></a><span id="l5.1262">   nsresult rv;</span>
<a href="#l5.1263"></a><span id="l5.1263" class="difflineminus">-  if (!m_lastHeader.IsEmpty())</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineminus">-  {</span>
<a href="#l5.1265"></a><span id="l5.1265" class="difflineplus">+  if (!m_lastHeader.IsEmpty()) {</span>
<a href="#l5.1266"></a><span id="l5.1266">     rv = AddHeader(m_lastHeader.get(), m_thisLine.get());</span>
<a href="#l5.1267"></a><span id="l5.1267" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1269"></a><span id="l5.1269">   }</span>
<a href="#l5.1270"></a><span id="l5.1270"> </span>
<a href="#l5.1271"></a><span id="l5.1271">   value.Trim(&quot; &quot;);</span>
<a href="#l5.1272"></a><span id="l5.1272"> </span>
<a href="#l5.1273"></a><span id="l5.1273">   ToLowerCase(header, m_lastHeader);</span>
<a href="#l5.1274"></a><span id="l5.1274">   m_thisLine.Assign(value);</span>
<a href="#l5.1275"></a><span id="l5.1275">   return NS_OK;</span>
<a href="#l5.1276"></a><span id="l5.1276"> }</span>
<a href="#l5.1277"></a><span id="l5.1277"> </span>
<a href="#l5.1278"></a><span id="l5.1278" class="difflineminus">-nsresult</span>
<a href="#l5.1279"></a><span id="l5.1279" class="difflineminus">-nsNNTPNewsgroupList::AddHeader(const char *header, const char *value)</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineminus">-{</span>
<a href="#l5.1281"></a><span id="l5.1281" class="difflineplus">+nsresult nsNNTPNewsgroupList::AddHeader(const char *header, const char *value) {</span>
<a href="#l5.1282"></a><span id="l5.1282">   nsresult rv = NS_OK;</span>
<a href="#l5.1283"></a><span id="l5.1283">   // The From, Date, and Subject headers have special requirements.</span>
<a href="#l5.1284"></a><span id="l5.1284" class="difflineminus">-  if (PL_strcmp(header, &quot;from&quot;) == 0)</span>
<a href="#l5.1285"></a><span id="l5.1285" class="difflineminus">-  {</span>
<a href="#l5.1286"></a><span id="l5.1286" class="difflineplus">+  if (PL_strcmp(header, &quot;from&quot;) == 0) {</span>
<a href="#l5.1287"></a><span id="l5.1287">     rv = m_newMsgHdr-&gt;SetAuthor(value);</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineminus">-  }</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineminus">-  else if (PL_strcmp(header, &quot;date&quot;) == 0)</span>
<a href="#l5.1290"></a><span id="l5.1290" class="difflineminus">-  {</span>
<a href="#l5.1291"></a><span id="l5.1291" class="difflineplus">+  } else if (PL_strcmp(header, &quot;date&quot;) == 0) {</span>
<a href="#l5.1292"></a><span id="l5.1292">     PRTime date;</span>
<a href="#l5.1293"></a><span id="l5.1293" class="difflineminus">-    PRStatus status = PR_ParseTimeString (value, false, &amp;date);</span>
<a href="#l5.1294"></a><span id="l5.1294" class="difflineminus">-    if (PR_SUCCESS == status)</span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineminus">-      rv = m_newMsgHdr-&gt;SetDate(date);</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineminus">-  }</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineminus">-  else if (PL_strcmp(header, &quot;subject&quot;) == 0)</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineminus">-  {</span>
<a href="#l5.1299"></a><span id="l5.1299" class="difflineplus">+    PRStatus status = PR_ParseTimeString(value, false, &amp;date);</span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineplus">+    if (PR_SUCCESS == status) rv = m_newMsgHdr-&gt;SetDate(date);</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineplus">+  } else if (PL_strcmp(header, &quot;subject&quot;) == 0) {</span>
<a href="#l5.1302"></a><span id="l5.1302">     const char *subject = value;</span>
<a href="#l5.1303"></a><span id="l5.1303"> </span>
<a href="#l5.1304"></a><span id="l5.1304">     uint32_t flags = 0;</span>
<a href="#l5.1305"></a><span id="l5.1305">     // ### should call IsHeaderRead here...</span>
<a href="#l5.1306"></a><span id="l5.1306">     /* strip &quot;Re: &quot; */</span>
<a href="#l5.1307"></a><span id="l5.1307">     nsCString modifiedSubject;</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineminus">-    bool strippedRE = NS_MsgStripRE(nsDependentCString(subject), modifiedSubject);</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineplus">+    bool strippedRE =</span>
<a href="#l5.1310"></a><span id="l5.1310" class="difflineplus">+        NS_MsgStripRE(nsDependentCString(subject), modifiedSubject);</span>
<a href="#l5.1311"></a><span id="l5.1311">     if (strippedRE)</span>
<a href="#l5.1312"></a><span id="l5.1312">       // this will make sure read flags agree with newsrc</span>
<a href="#l5.1313"></a><span id="l5.1313" class="difflineminus">-     (void) m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::HasRe, &amp;flags);</span>
<a href="#l5.1314"></a><span id="l5.1314" class="difflineplus">+      (void)m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::HasRe, &amp;flags);</span>
<a href="#l5.1315"></a><span id="l5.1315"> </span>
<a href="#l5.1316"></a><span id="l5.1316" class="difflineminus">-    if (! (flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l5.1317"></a><span id="l5.1317" class="difflineplus">+    if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l5.1318"></a><span id="l5.1318">       rv = m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;flags);</span>
<a href="#l5.1319"></a><span id="l5.1319"> </span>
<a href="#l5.1320"></a><span id="l5.1320">     rv = m_newMsgHdr-&gt;SetSubject(strippedRE ? modifiedSubject.get() : subject);</span>
<a href="#l5.1321"></a><span id="l5.1321" class="difflineminus">-  }</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineminus">-  else if (PL_strcmp(header, &quot;message-id&quot;) == 0)</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineminus">-  {</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineplus">+  } else if (PL_strcmp(header, &quot;message-id&quot;) == 0) {</span>
<a href="#l5.1325"></a><span id="l5.1325">     rv = m_newMsgHdr-&gt;SetMessageId(value);</span>
<a href="#l5.1326"></a><span id="l5.1326" class="difflineminus">-  }</span>
<a href="#l5.1327"></a><span id="l5.1327" class="difflineminus">-  else if (PL_strcmp(header, &quot;references&quot;) == 0)</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineminus">-  {</span>
<a href="#l5.1329"></a><span id="l5.1329" class="difflineplus">+  } else if (PL_strcmp(header, &quot;references&quot;) == 0) {</span>
<a href="#l5.1330"></a><span id="l5.1330">     rv = m_newMsgHdr-&gt;SetReferences(value);</span>
<a href="#l5.1331"></a><span id="l5.1331" class="difflineminus">-  }</span>
<a href="#l5.1332"></a><span id="l5.1332" class="difflineminus">-  else if (PL_strcmp(header, &quot;bytes&quot;) == 0)</span>
<a href="#l5.1333"></a><span id="l5.1333" class="difflineminus">-  {</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineplus">+  } else if (PL_strcmp(header, &quot;bytes&quot;) == 0) {</span>
<a href="#l5.1335"></a><span id="l5.1335">     rv = m_newMsgHdr-&gt;SetMessageSize(atol(value));</span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineminus">-  }</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineminus">-  else if (PL_strcmp(header, &quot;lines&quot;) == 0)</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineminus">-  {</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+  } else if (PL_strcmp(header, &quot;lines&quot;) == 0) {</span>
<a href="#l5.1340"></a><span id="l5.1340">     rv = m_newMsgHdr-&gt;SetLineCount(atol(value));</span>
<a href="#l5.1341"></a><span id="l5.1341" class="difflineminus">-  }</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineminus">-  else if (m_filterHeaders.Contains(nsDependentCString(header)))</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineminus">-  {</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+  } else if (m_filterHeaders.Contains(nsDependentCString(header))) {</span>
<a href="#l5.1345"></a><span id="l5.1345">     rv = m_newMsgHdr-&gt;SetStringProperty(header, value);</span>
<a href="#l5.1346"></a><span id="l5.1346">   }</span>
<a href="#l5.1347"></a><span id="l5.1347">   return rv;</span>
<a href="#l5.1348"></a><span id="l5.1348"> }</span>
<a href="#l5.1349"></a><span id="l5.1349"> </span>
<a href="#l5.1350"></a><span id="l5.1350" class="difflineminus">-nsresult</span>
<a href="#l5.1351"></a><span id="l5.1351" class="difflineminus">-nsNNTPNewsgroupList::CallFilters()</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineminus">-{</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineplus">+nsresult nsNNTPNewsgroupList::CallFilters() {</span>
<a href="#l5.1354"></a><span id="l5.1354">   nsresult rv;</span>
<a href="#l5.1355"></a><span id="l5.1355">   nsCString filterString;</span>
<a href="#l5.1356"></a><span id="l5.1356"> </span>
<a href="#l5.1357"></a><span id="l5.1357" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.1358"></a><span id="l5.1358" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1359"></a><span id="l5.1359" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.1360"></a><span id="l5.1360" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1361"></a><span id="l5.1361"> </span>
<a href="#l5.1362"></a><span id="l5.1362">   uint32_t filterCount = 0;</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineminus">-  if (m_filterList)</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineminus">-  {</span>
<a href="#l5.1365"></a><span id="l5.1365" class="difflineplus">+  if (m_filterList) {</span>
<a href="#l5.1366"></a><span id="l5.1366">     rv = m_filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1368"></a><span id="l5.1368" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1369"></a><span id="l5.1369">   }</span>
<a href="#l5.1370"></a><span id="l5.1370"> </span>
<a href="#l5.1371"></a><span id="l5.1371">   uint32_t serverFilterCount = 0;</span>
<a href="#l5.1372"></a><span id="l5.1372" class="difflineminus">-  if (m_serverFilterList)</span>
<a href="#l5.1373"></a><span id="l5.1373" class="difflineminus">-  {</span>
<a href="#l5.1374"></a><span id="l5.1374" class="difflineplus">+  if (m_serverFilterList) {</span>
<a href="#l5.1375"></a><span id="l5.1375">     rv = m_serverFilterList-&gt;GetFilterCount(&amp;serverFilterCount);</span>
<a href="#l5.1376"></a><span id="l5.1376" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1377"></a><span id="l5.1377" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1378"></a><span id="l5.1378">   }</span>
<a href="#l5.1379"></a><span id="l5.1379"> </span>
<a href="#l5.1380"></a><span id="l5.1380">   uint32_t count = m_newHeaders.Count();</span>
<a href="#l5.1381"></a><span id="l5.1381"> </span>
<a href="#l5.1382"></a><span id="l5.1382">   // Notify MsgFolderListeners of message adds</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.1384"></a><span id="l5.1384" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l5.1385"></a><span id="l5.1385" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.1386"></a><span id="l5.1386"> </span>
<a href="#l5.1387"></a><span id="l5.1387" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l5.1388"></a><span id="l5.1388" class="difflineminus">-  {</span>
<a href="#l5.1389"></a><span id="l5.1389" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l5.1390"></a><span id="l5.1390">     m_newMsgHdr = m_newHeaders[i];</span>
<a href="#l5.1391"></a><span id="l5.1391" class="difflineminus">-    if (!filterCount &amp;&amp; !serverFilterCount)</span>
<a href="#l5.1392"></a><span id="l5.1392" class="difflineminus">-    {</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineplus">+    if (!filterCount &amp;&amp; !serverFilterCount) {</span>
<a href="#l5.1394"></a><span id="l5.1394">       m_newsDB-&gt;AddNewHdrToDB(m_newMsgHdr, true);</span>
<a href="#l5.1395"></a><span id="l5.1395"> </span>
<a href="#l5.1396"></a><span id="l5.1396" class="difflineminus">-      if (notifier)</span>
<a href="#l5.1397"></a><span id="l5.1397" class="difflineminus">-        notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l5.1398"></a><span id="l5.1398" class="difflineplus">+      if (notifier) notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l5.1399"></a><span id="l5.1399">       // mark the header as not yet reported classified</span>
<a href="#l5.1400"></a><span id="l5.1400">       nsMsgKey msgKey;</span>
<a href="#l5.1401"></a><span id="l5.1401">       m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.1402"></a><span id="l5.1402">       folder-&gt;OrProcessingFlags(msgKey,</span>
<a href="#l5.1403"></a><span id="l5.1403">                                 nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l5.1404"></a><span id="l5.1404"> </span>
<a href="#l5.1405"></a><span id="l5.1405">       continue;</span>
<a href="#l5.1406"></a><span id="l5.1406">     }</span>
<a href="#l5.1407"></a><span id="l5.1407">     m_addHdrToDB = true;</span>
<a href="#l5.1408"></a><span id="l5.1408"> </span>
<a href="#l5.1409"></a><span id="l5.1409">     // build up a &quot;headers&quot; for filter code</span>
<a href="#l5.1410"></a><span id="l5.1410">     nsCString subject, author, date;</span>
<a href="#l5.1411"></a><span id="l5.1411">     rv = m_newMsgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l5.1412"></a><span id="l5.1412" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1413"></a><span id="l5.1413" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1414"></a><span id="l5.1414">     rv = m_newMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l5.1415"></a><span id="l5.1415" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1416"></a><span id="l5.1416" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1417"></a><span id="l5.1417"> </span>
<a href="#l5.1418"></a><span id="l5.1418">     nsCString fullHeaders;</span>
<a href="#l5.1419"></a><span id="l5.1419" class="difflineminus">-    if (!(author.IsEmpty()))</span>
<a href="#l5.1420"></a><span id="l5.1420" class="difflineminus">-    {</span>
<a href="#l5.1421"></a><span id="l5.1421" class="difflineplus">+    if (!(author.IsEmpty())) {</span>
<a href="#l5.1422"></a><span id="l5.1422">       fullHeaders.AppendLiteral(FROM_HEADER);</span>
<a href="#l5.1423"></a><span id="l5.1423">       fullHeaders += author;</span>
<a href="#l5.1424"></a><span id="l5.1424">       fullHeaders += '\0';</span>
<a href="#l5.1425"></a><span id="l5.1425">     }</span>
<a href="#l5.1426"></a><span id="l5.1426"> </span>
<a href="#l5.1427"></a><span id="l5.1427" class="difflineminus">-    if (!(subject.IsEmpty()))</span>
<a href="#l5.1428"></a><span id="l5.1428" class="difflineminus">-    {</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineplus">+    if (!(subject.IsEmpty())) {</span>
<a href="#l5.1430"></a><span id="l5.1430">       fullHeaders.AppendLiteral(SUBJECT_HEADER);</span>
<a href="#l5.1431"></a><span id="l5.1431">       fullHeaders += subject;</span>
<a href="#l5.1432"></a><span id="l5.1432">       fullHeaders += '\0';</span>
<a href="#l5.1433"></a><span id="l5.1433">     }</span>
<a href="#l5.1434"></a><span id="l5.1434"> </span>
<a href="#l5.1435"></a><span id="l5.1435" class="difflineminus">-    for (uint32_t header = 0; header &lt; m_filterHeaders.Length(); header++)</span>
<a href="#l5.1436"></a><span id="l5.1436" class="difflineminus">-    {</span>
<a href="#l5.1437"></a><span id="l5.1437" class="difflineplus">+    for (uint32_t header = 0; header &lt; m_filterHeaders.Length(); header++) {</span>
<a href="#l5.1438"></a><span id="l5.1438">       nsCString retValue;</span>
<a href="#l5.1439"></a><span id="l5.1439">       m_newMsgHdr-&gt;GetStringProperty(m_filterHeaders[header].get(),</span>
<a href="#l5.1440"></a><span id="l5.1440">                                      getter_Copies(retValue));</span>
<a href="#l5.1441"></a><span id="l5.1441" class="difflineminus">-      if (!retValue.IsEmpty())</span>
<a href="#l5.1442"></a><span id="l5.1442" class="difflineminus">-      {</span>
<a href="#l5.1443"></a><span id="l5.1443" class="difflineplus">+      if (!retValue.IsEmpty()) {</span>
<a href="#l5.1444"></a><span id="l5.1444">         fullHeaders += m_filterHeaders[header];</span>
<a href="#l5.1445"></a><span id="l5.1445">         fullHeaders.AppendLiteral(&quot;: &quot;);</span>
<a href="#l5.1446"></a><span id="l5.1446">         fullHeaders += retValue;</span>
<a href="#l5.1447"></a><span id="l5.1447">         fullHeaders += '\0';</span>
<a href="#l5.1448"></a><span id="l5.1448">       }</span>
<a href="#l5.1449"></a><span id="l5.1449">     }</span>
<a href="#l5.1450"></a><span id="l5.1450"> </span>
<a href="#l5.1451"></a><span id="l5.1451">     // The per-newsgroup filters should go first. If something stops filter</span>
<a href="#l5.1452"></a><span id="l5.1452">     // execution, then users should be able to override the global filters in</span>
<a href="#l5.1453"></a><span id="l5.1453">     // the per-newsgroup filters.</span>
<a href="#l5.1454"></a><span id="l5.1454" class="difflineminus">-    if (filterCount)</span>
<a href="#l5.1455"></a><span id="l5.1455" class="difflineminus">-    {</span>
<a href="#l5.1456"></a><span id="l5.1456" class="difflineplus">+    if (filterCount) {</span>
<a href="#l5.1457"></a><span id="l5.1457">       rv = m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule,</span>
<a href="#l5.1458"></a><span id="l5.1458" class="difflineminus">-          m_newMsgHdr, folder, m_newsDB, fullHeaders, this, m_msgWindow);</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineplus">+                                           m_newMsgHdr, folder, m_newsDB,</span>
<a href="#l5.1460"></a><span id="l5.1460" class="difflineplus">+                                           fullHeaders, this, m_msgWindow);</span>
<a href="#l5.1461"></a><span id="l5.1461">     }</span>
<a href="#l5.1462"></a><span id="l5.1462" class="difflineminus">-    if (serverFilterCount)</span>
<a href="#l5.1463"></a><span id="l5.1463" class="difflineminus">-    {</span>
<a href="#l5.1464"></a><span id="l5.1464" class="difflineminus">-      rv = m_serverFilterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule,</span>
<a href="#l5.1465"></a><span id="l5.1465" class="difflineminus">-          m_newMsgHdr, folder, m_newsDB, fullHeaders, this, m_msgWindow);</span>
<a href="#l5.1466"></a><span id="l5.1466" class="difflineplus">+    if (serverFilterCount) {</span>
<a href="#l5.1467"></a><span id="l5.1467" class="difflineplus">+      rv = m_serverFilterList-&gt;ApplyFiltersToHdr(</span>
<a href="#l5.1468"></a><span id="l5.1468" class="difflineplus">+          nsMsgFilterType::NewsRule, m_newMsgHdr, folder, m_newsDB, fullHeaders,</span>
<a href="#l5.1469"></a><span id="l5.1469" class="difflineplus">+          this, m_msgWindow);</span>
<a href="#l5.1470"></a><span id="l5.1470">     }</span>
<a href="#l5.1471"></a><span id="l5.1471"> </span>
<a href="#l5.1472"></a><span id="l5.1472" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.1473"></a><span id="l5.1473" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1474"></a><span id="l5.1474"> </span>
<a href="#l5.1475"></a><span id="l5.1475" class="difflineminus">-    if (m_addHdrToDB)</span>
<a href="#l5.1476"></a><span id="l5.1476" class="difflineminus">-    {</span>
<a href="#l5.1477"></a><span id="l5.1477" class="difflineplus">+    if (m_addHdrToDB) {</span>
<a href="#l5.1478"></a><span id="l5.1478">       m_newsDB-&gt;AddNewHdrToDB(m_newMsgHdr, true);</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineminus">-      if (notifier)</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineminus">-        notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l5.1481"></a><span id="l5.1481" class="difflineplus">+      if (notifier) notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l5.1482"></a><span id="l5.1482">       // mark the header as not yet reported classified</span>
<a href="#l5.1483"></a><span id="l5.1483">       nsMsgKey msgKey;</span>
<a href="#l5.1484"></a><span id="l5.1484">       m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.1485"></a><span id="l5.1485">       folder-&gt;OrProcessingFlags(msgKey,</span>
<a href="#l5.1486"></a><span id="l5.1486">                                 nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l5.1487"></a><span id="l5.1487">     }</span>
<a href="#l5.1488"></a><span id="l5.1488">   }</span>
<a href="#l5.1489"></a><span id="l5.1489">   m_newHeaders.Clear();</span>
<a href="#l5.1490"></a><span id="l5.1490">   return NS_OK;</span>
<a href="#l5.1491"></a><span id="l5.1491"> }</span>
<a href="#l5.1492"></a><span id="l5.1492"> </span>
<a href="#l5.1493"></a><span id="l5.1493" class="difflineminus">-void</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineminus">-nsNNTPNewsgroupList::SetProgressBarPercent(int32_t percent)</span>
<a href="#l5.1495"></a><span id="l5.1495" class="difflineminus">-{</span>
<a href="#l5.1496"></a><span id="l5.1496" class="difflineminus">-  if (!m_runningURL)</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineminus">-    return;</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineplus">+void nsNNTPNewsgroupList::SetProgressBarPercent(int32_t percent) {</span>
<a href="#l5.1499"></a><span id="l5.1499" class="difflineplus">+  if (!m_runningURL) return;</span>
<a href="#l5.1500"></a><span id="l5.1500"> </span>
<a href="#l5.1501"></a><span id="l5.1501" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l5.1502"></a><span id="l5.1502" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l5.1503"></a><span id="l5.1503">   if (mailnewsUrl) {</span>
<a href="#l5.1504"></a><span id="l5.1504" class="difflineminus">-    nsCOMPtr &lt;nsIMsgStatusFeedback&gt; feedback;</span>
<a href="#l5.1505"></a><span id="l5.1505" class="difflineplus">+    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; feedback;</span>
<a href="#l5.1506"></a><span id="l5.1506">     mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(feedback));</span>
<a href="#l5.1507"></a><span id="l5.1507"> </span>
<a href="#l5.1508"></a><span id="l5.1508">     if (feedback) {</span>
<a href="#l5.1509"></a><span id="l5.1509">       feedback-&gt;ShowProgress(percent);</span>
<a href="#l5.1510"></a><span id="l5.1510">     }</span>
<a href="#l5.1511"></a><span id="l5.1511">   }</span>
<a href="#l5.1512"></a><span id="l5.1512"> }</span>
<a href="#l5.1513"></a><span id="l5.1513"> </span>
<a href="#l5.1514"></a><span id="l5.1514" class="difflineminus">-void</span>
<a href="#l5.1515"></a><span id="l5.1515" class="difflineminus">-nsNNTPNewsgroupList::SetProgressStatus(const char16_t *aMessage)</span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineminus">-{</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineminus">-  if (!m_runningURL)</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineminus">-    return;</span>
<a href="#l5.1519"></a><span id="l5.1519" class="difflineplus">+void nsNNTPNewsgroupList::SetProgressStatus(const char16_t *aMessage) {</span>
<a href="#l5.1520"></a><span id="l5.1520" class="difflineplus">+  if (!m_runningURL) return;</span>
<a href="#l5.1521"></a><span id="l5.1521"> </span>
<a href="#l5.1522"></a><span id="l5.1522" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l5.1523"></a><span id="l5.1523" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l5.1524"></a><span id="l5.1524">   if (mailnewsUrl) {</span>
<a href="#l5.1525"></a><span id="l5.1525" class="difflineminus">-    nsCOMPtr &lt;nsIMsgStatusFeedback&gt; feedback;</span>
<a href="#l5.1526"></a><span id="l5.1526" class="difflineplus">+    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; feedback;</span>
<a href="#l5.1527"></a><span id="l5.1527">     mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(feedback));</span>
<a href="#l5.1528"></a><span id="l5.1528"> </span>
<a href="#l5.1529"></a><span id="l5.1529">     if (feedback) {</span>
<a href="#l5.1530"></a><span id="l5.1530">       // prepending the account name to the status message.</span>
<a href="#l5.1531"></a><span id="l5.1531">       nsresult rv;</span>
<a href="#l5.1532"></a><span id="l5.1532" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.1533"></a><span id="l5.1533" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.1534"></a><span id="l5.1534">       rv = mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.1535"></a><span id="l5.1535">       NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l5.1536"></a><span id="l5.1536">       nsString accountName;</span>
<a href="#l5.1537"></a><span id="l5.1537">       server-&gt;GetPrettyName(accountName);</span>
<a href="#l5.1538"></a><span id="l5.1538">       nsString statusMessage;</span>
<a href="#l5.1539"></a><span id="l5.1539">       nsCOMPtr&lt;nsIStringBundleService&gt; sbs =</span>
<a href="#l5.1540"></a><span id="l5.1540" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l5.1542"></a><span id="l5.1542">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.1543"></a><span id="l5.1543" class="difflineminus">-      rv = sbs-&gt;CreateBundle(MSGS_URL,</span>
<a href="#l5.1544"></a><span id="l5.1544" class="difflineminus">-                             getter_AddRefs(bundle));</span>
<a href="#l5.1545"></a><span id="l5.1545" class="difflineplus">+      rv = sbs-&gt;CreateBundle(MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l5.1546"></a><span id="l5.1546">       NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l5.1547"></a><span id="l5.1547" class="difflineminus">-      const char16_t *params[] = { accountName.get(), aMessage };</span>
<a href="#l5.1548"></a><span id="l5.1548" class="difflineminus">-      bundle-&gt;FormatStringFromName(&quot;statusMessage&quot;,</span>
<a href="#l5.1549"></a><span id="l5.1549" class="difflineminus">-                                   params, 2, statusMessage);</span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineplus">+      const char16_t *params[] = {accountName.get(), aMessage};</span>
<a href="#l5.1551"></a><span id="l5.1551" class="difflineplus">+      bundle-&gt;FormatStringFromName(&quot;statusMessage&quot;, params, 2, statusMessage);</span>
<a href="#l5.1552"></a><span id="l5.1552"> </span>
<a href="#l5.1553"></a><span id="l5.1553">       feedback-&gt;ShowStatusString(statusMessage);</span>
<a href="#l5.1554"></a><span id="l5.1554">     }</span>
<a href="#l5.1555"></a><span id="l5.1555">   }</span>
<a href="#l5.1556"></a><span id="l5.1556"> }</span>
<a href="#l5.1557"></a><span id="l5.1557"> </span>
<a href="#l5.1558"></a><span id="l5.1558" class="difflineminus">-void</span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineminus">-nsNNTPNewsgroupList::UpdateStatus(bool filtering, int32_t numDLed, int32_t totToDL)</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineminus">-{</span>
<a href="#l5.1561"></a><span id="l5.1561" class="difflineplus">+void nsNNTPNewsgroupList::UpdateStatus(bool filtering, int32_t numDLed,</span>
<a href="#l5.1562"></a><span id="l5.1562" class="difflineplus">+                                       int32_t totToDL) {</span>
<a href="#l5.1563"></a><span id="l5.1563">   int32_t numerator = (filtering ? m_currentXHDRIndex + 1 : 1) * numDLed;</span>
<a href="#l5.1564"></a><span id="l5.1564">   int32_t denominator = (m_filterHeaders.Length() + 1) * totToDL;</span>
<a href="#l5.1565"></a><span id="l5.1565">   int32_t percent = numerator * 100 / denominator;</span>
<a href="#l5.1566"></a><span id="l5.1566"> </span>
<a href="#l5.1567"></a><span id="l5.1567">   nsAutoString numDownloadedStr;</span>
<a href="#l5.1568"></a><span id="l5.1568">   numDownloadedStr.AppendInt(numDLed);</span>
<a href="#l5.1569"></a><span id="l5.1569"> </span>
<a href="#l5.1570"></a><span id="l5.1570">   nsAutoString totalToDownloadStr;</span>
<a href="#l5.1571"></a><span id="l5.1571">   totalToDownloadStr.AppendInt(totToDL);</span>
<a href="#l5.1572"></a><span id="l5.1572"> </span>
<a href="#l5.1573"></a><span id="l5.1573">   nsAutoString newsgroupName;</span>
<a href="#l5.1574"></a><span id="l5.1574">   nsresult rv = m_newsFolder-&gt;GetUnicodeName(newsgroupName);</span>
<a href="#l5.1575"></a><span id="l5.1575" class="difflineminus">-  if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.1576"></a><span id="l5.1576" class="difflineminus">-      return;</span>
<a href="#l5.1577"></a><span id="l5.1577" class="difflineplus">+  if (!NS_SUCCEEDED(rv)) return;</span>
<a href="#l5.1578"></a><span id="l5.1578"> </span>
<a href="#l5.1579"></a><span id="l5.1579">   nsString statusString;</span>
<a href="#l5.1580"></a><span id="l5.1580">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l5.1581"></a><span id="l5.1581" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l5.1582"></a><span id="l5.1582" class="difflineminus">-  if (!bundleService)</span>
<a href="#l5.1583"></a><span id="l5.1583" class="difflineminus">-    return;</span>
<a href="#l5.1584"></a><span id="l5.1584" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l5.1585"></a><span id="l5.1585" class="difflineplus">+  if (!bundleService) return;</span>
<a href="#l5.1586"></a><span id="l5.1586"> </span>
<a href="#l5.1587"></a><span id="l5.1587">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.1588"></a><span id="l5.1588">   rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l5.1589"></a><span id="l5.1589" class="difflineminus">-  if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.1590"></a><span id="l5.1590" class="difflineminus">-    return;</span>
<a href="#l5.1591"></a><span id="l5.1591" class="difflineplus">+  if (!NS_SUCCEEDED(rv)) return;</span>
<a href="#l5.1592"></a><span id="l5.1592"> </span>
<a href="#l5.1593"></a><span id="l5.1593" class="difflineminus">-  if (filtering)</span>
<a href="#l5.1594"></a><span id="l5.1594" class="difflineminus">-  {</span>
<a href="#l5.1595"></a><span id="l5.1595" class="difflineplus">+  if (filtering) {</span>
<a href="#l5.1596"></a><span id="l5.1596">     NS_ConvertUTF8toUTF16 header(m_filterHeaders[m_currentXHDRIndex]);</span>
<a href="#l5.1597"></a><span id="l5.1597" class="difflineminus">-    const char16_t *formatStrings[4] = { header.get(),</span>
<a href="#l5.1598"></a><span id="l5.1598" class="difflineminus">-      numDownloadedStr.get(), totalToDownloadStr.get(), newsgroupName.get() };</span>
<a href="#l5.1599"></a><span id="l5.1599" class="difflineplus">+    const char16_t *formatStrings[4] = {header.get(), numDownloadedStr.get(),</span>
<a href="#l5.1600"></a><span id="l5.1600" class="difflineplus">+                                        totalToDownloadStr.get(),</span>
<a href="#l5.1601"></a><span id="l5.1601" class="difflineplus">+                                        newsgroupName.get()};</span>
<a href="#l5.1602"></a><span id="l5.1602">     rv = bundle-&gt;FormatStringFromName(&quot;newNewsgroupFilteringHeaders&quot;,</span>
<a href="#l5.1603"></a><span id="l5.1603" class="difflineminus">-      formatStrings, 4, statusString);</span>
<a href="#l5.1604"></a><span id="l5.1604" class="difflineplus">+                                      formatStrings, 4, statusString);</span>
<a href="#l5.1605"></a><span id="l5.1605" class="difflineplus">+  } else {</span>
<a href="#l5.1606"></a><span id="l5.1606" class="difflineplus">+    const char16_t *formatStrings[3] = {</span>
<a href="#l5.1607"></a><span id="l5.1607" class="difflineplus">+        numDownloadedStr.get(), totalToDownloadStr.get(), newsgroupName.get()};</span>
<a href="#l5.1608"></a><span id="l5.1608" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;newNewsgroupHeaders&quot;, formatStrings, 3,</span>
<a href="#l5.1609"></a><span id="l5.1609" class="difflineplus">+                                      statusString);</span>
<a href="#l5.1610"></a><span id="l5.1610">   }</span>
<a href="#l5.1611"></a><span id="l5.1611" class="difflineminus">-  else</span>
<a href="#l5.1612"></a><span id="l5.1612" class="difflineminus">-  {</span>
<a href="#l5.1613"></a><span id="l5.1613" class="difflineminus">-    const char16_t *formatStrings[3] = { numDownloadedStr.get(),</span>
<a href="#l5.1614"></a><span id="l5.1614" class="difflineminus">-      totalToDownloadStr.get(), newsgroupName.get() };</span>
<a href="#l5.1615"></a><span id="l5.1615" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(&quot;newNewsgroupHeaders&quot;,</span>
<a href="#l5.1616"></a><span id="l5.1616" class="difflineminus">-      formatStrings, 3, statusString);</span>
<a href="#l5.1617"></a><span id="l5.1617" class="difflineminus">-  }</span>
<a href="#l5.1618"></a><span id="l5.1618" class="difflineminus">-  if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineminus">-    return;</span>
<a href="#l5.1620"></a><span id="l5.1620" class="difflineplus">+  if (!NS_SUCCEEDED(rv)) return;</span>
<a href="#l5.1621"></a><span id="l5.1621"> </span>
<a href="#l5.1622"></a><span id="l5.1622">   SetProgressStatus(statusString.get());</span>
<a href="#l5.1623"></a><span id="l5.1623">   m_lastStatusUpdate = PR_Now();</span>
<a href="#l5.1624"></a><span id="l5.1624"> </span>
<a href="#l5.1625"></a><span id="l5.1625">   // only update the progress meter if it has changed</span>
<a href="#l5.1626"></a><span id="l5.1626" class="difflineminus">-  if (percent != m_lastPercent)</span>
<a href="#l5.1627"></a><span id="l5.1627" class="difflineminus">-  {</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineplus">+  if (percent != m_lastPercent) {</span>
<a href="#l5.1629"></a><span id="l5.1629">     SetProgressBarPercent(percent);</span>
<a href="#l5.1630"></a><span id="l5.1630">     m_lastPercent = percent;</span>
<a href="#l5.1631"></a><span id="l5.1631">   }</span>
<a href="#l5.1632"></a><span id="l5.1632"> }</span>
<a href="#l5.1633"></a><span id="l5.1633"> </span>
<a href="#l5.1634"></a><span id="l5.1634" class="difflineminus">-NS_IMETHODIMP nsNNTPNewsgroupList::SetGetOldMessages(bool aGetOldMessages)</span>
<a href="#l5.1635"></a><span id="l5.1635" class="difflineminus">-{</span>
<a href="#l5.1636"></a><span id="l5.1636" class="difflineplus">+NS_IMETHODIMP nsNNTPNewsgroupList::SetGetOldMessages(bool aGetOldMessages) {</span>
<a href="#l5.1637"></a><span id="l5.1637">   m_getOldMessages = aGetOldMessages;</span>
<a href="#l5.1638"></a><span id="l5.1638">   return NS_OK;</span>
<a href="#l5.1639"></a><span id="l5.1639"> }</span>
<a href="#l5.1640"></a><span id="l5.1640"> </span>
<a href="#l5.1641"></a><span id="l5.1641" class="difflineminus">-NS_IMETHODIMP nsNNTPNewsgroupList::GetGetOldMessages(bool *aGetOldMessages)</span>
<a href="#l5.1642"></a><span id="l5.1642" class="difflineminus">-{</span>
<a href="#l5.1643"></a><span id="l5.1643" class="difflineplus">+NS_IMETHODIMP nsNNTPNewsgroupList::GetGetOldMessages(bool *aGetOldMessages) {</span>
<a href="#l5.1644"></a><span id="l5.1644">   NS_ENSURE_ARG(aGetOldMessages);</span>
<a href="#l5.1645"></a><span id="l5.1645"> </span>
<a href="#l5.1646"></a><span id="l5.1646">   *aGetOldMessages = m_getOldMessages;</span>
<a href="#l5.1647"></a><span id="l5.1647">   return NS_OK;</span>
<a href="#l5.1648"></a><span id="l5.1648"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -22,76 +22,78 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> /* The below is all stuff that we remember for netlib about which</span>
<a href="#l6.9"></a><span id="l6.9">    articles we've already seen in the current newsgroup. */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> typedef struct MSG_NewsKnown {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsMsgKeySet* set; /* Set of articles we've already gotten</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsMsgKeySet *set; /* Set of articles we've already gotten</span>
<a href="#l6.14"></a><span id="l6.14">                        from the newsserver (if it's marked</span>
<a href="#l6.15"></a><span id="l6.15">                        &quot;read&quot;, then we've already gotten it).</span>
<a href="#l6.16"></a><span id="l6.16">                        If an article is marked &quot;read&quot;, it</span>
<a href="#l6.17"></a><span id="l6.17">                        doesn't mean we're actually displaying</span>
<a href="#l6.18"></a><span id="l6.18">                        it; it may be an article that no longer</span>
<a href="#l6.19"></a><span id="l6.19">                        exists, or it may be one that we've</span>
<a href="#l6.20"></a><span id="l6.20">                        marked read and we're only viewing</span>
<a href="#l6.21"></a><span id="l6.21">                        unread messages. */</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   int32_t first_possible; /* The oldest article in this group. */</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  int32_t last_possible; /* The newest article in this group. */</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  int32_t last_possible;  /* The newest article in this group. */</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   bool shouldGetOldest;</span>
<a href="#l6.28"></a><span id="l6.28"> } MSG_NewsKnown;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> // This class should ultimately be part of a news group listing</span>
<a href="#l6.31"></a><span id="l6.31"> // state machine - either by inheritance or delegation.</span>
<a href="#l6.32"></a><span id="l6.32"> // Currently, a folder pane owns one and libnet news group listing</span>
<a href="#l6.33"></a><span id="l6.33"> // related messages get passed to this object.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-class nsNNTPNewsgroupList : public nsINNTPNewsgroupList, public nsIMsgFilterHitNotify</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+class nsNNTPNewsgroupList : public nsINNTPNewsgroupList,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+                            public nsIMsgFilterHitNotify</span>
<a href="#l6.37"></a><span id="l6.37"> #ifdef HAVE_CHANGELISTENER</span>
<a href="#l6.38"></a><span id="l6.38"> /* ,public ChangeListener */</span>
<a href="#l6.39"></a><span id="l6.39"> #endif</span>
<a href="#l6.40"></a><span id="l6.40"> {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-public:</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+ public:</span>
<a href="#l6.43"></a><span id="l6.43">   nsNNTPNewsgroupList();</span>
<a href="#l6.44"></a><span id="l6.44">   NS_DECL_ISUPPORTS</span>
<a href="#l6.45"></a><span id="l6.45">   NS_DECL_NSINNTPNEWSGROUPLIST</span>
<a href="#l6.46"></a><span id="l6.46">   NS_DECL_NSIMSGFILTERHITNOTIFY</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-private:</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  virtual  ~nsNNTPNewsgroupList();</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+ private:</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  virtual ~nsNNTPNewsgroupList();</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">   nsresult CleanUp();</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  bool    m_finishingXover;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+  bool m_finishingXover;</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58"> #ifdef HAVE_CHANGELISTENER</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  virtual void OnAnnouncerGoingAway (ChangeAnnouncer *instigator);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  virtual void OnAnnouncerGoingAway(ChangeAnnouncer *instigator);</span>
<a href="#l6.61"></a><span id="l6.61"> #endif</span>
<a href="#l6.62"></a><span id="l6.62">   nsresult ParseLine(char *line, uint32_t *message_number);</span>
<a href="#l6.63"></a><span id="l6.63">   nsresult GetDatabase(const char *uri, nsIMsgDatabase **db);</span>
<a href="#l6.64"></a><span id="l6.64">   void SetProgressBarPercent(int32_t percent);</span>
<a href="#l6.65"></a><span id="l6.65">   void SetProgressStatus(const char16_t *aMessage);</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">   void UpdateStatus(bool filtering, int32_t numDled, int32_t totToDL);</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  nsresult AddHeader(const char * header, const char * value);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-protected:</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  nsresult AddHeader(const char *header, const char *value);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+ protected:</span>
<a href="#l6.74"></a><span id="l6.74">   bool m_getOldMessages;</span>
<a href="#l6.75"></a><span id="l6.75">   bool m_promptedAlready;</span>
<a href="#l6.76"></a><span id="l6.76">   bool m_downloadAll;</span>
<a href="#l6.77"></a><span id="l6.77">   int32_t m_maxArticles;</span>
<a href="#l6.78"></a><span id="l6.78">   int32_t m_lastPercent;</span>
<a href="#l6.79"></a><span id="l6.79">   PRTime m_lastStatusUpdate;</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  nsCOMPtr &lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  nsCOMPtr &lt;nsINntpUrl&gt; m_runningURL;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  nsCOMPtr&lt;nsINntpUrl&gt; m_runningURL;</span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88">   /**</span>
<a href="#l6.89"></a><span id="l6.89">    * The last message that we have processed (XOVER or HEAD).</span>
<a href="#l6.90"></a><span id="l6.90">    */</span>
<a href="#l6.91"></a><span id="l6.91">   nsMsgKey m_lastProcessedNumber;</span>
<a href="#l6.92"></a><span id="l6.92">   /**</span>
<a href="#l6.93"></a><span id="l6.93">    * The endpoints of the message chunk we are actually downloading.</span>
<a href="#l6.94"></a><span id="l6.94">    */</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineat">@@ -104,21 +106,19 @@ protected:</span>
<a href="#l6.96"></a><span id="l6.96">   struct MSG_NewsKnown m_knownArts;</span>
<a href="#l6.97"></a><span id="l6.97">   nsMsgKeySet *m_set;</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99">   nsTArray&lt;nsCString&gt; m_filterHeaders;</span>
<a href="#l6.100"></a><span id="l6.100">   uint32_t m_currentXHDRIndex;</span>
<a href="#l6.101"></a><span id="l6.101">   nsCString m_lastHeader;</span>
<a href="#l6.102"></a><span id="l6.102">   nsCString m_thisLine;</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-private:</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; m_serverFilterList;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_newMsgHdr; // current message header we're building</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+ private:</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; m_serverFilterList;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newMsgHdr;  // current message header we're building</span>
<a href="#l6.114"></a><span id="l6.114">   nsCOMArray&lt;nsIMsgDBHdr&gt; m_newHeaders;</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">   bool m_addHdrToDB;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-</span>
<a href="#l6.118"></a><span id="l6.118"> };</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120"> #endif /* nsNNTPNewsgroupListState_h___ */</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupPost.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupPost.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,38 +1,31 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsNNTPNewsgroupPost.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12"> </span>
<a href="#l7.13"></a><span id="l7.13"> NS_IMPL_ISUPPORTS(nsNNTPNewsgroupPost, nsINNTPNewsgroupPost)</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-nsNNTPNewsgroupPost::nsNNTPNewsgroupPost()</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-{</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  m_isControl=false;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-}</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+nsNNTPNewsgroupPost::nsNNTPNewsgroupPost() { m_isControl = false; }</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-nsNNTPNewsgroupPost::~nsNNTPNewsgroupPost()</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-{</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-}</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+nsNNTPNewsgroupPost::~nsNNTPNewsgroupPost() {}</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-#define IMPL_GETSET(attribute, member) \</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  NS_IMETHODIMP nsNNTPNewsgroupPost::Get##attribute(char **result) \</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  { \</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-    NS_ENSURE_ARG_POINTER(result); \</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-    *result = ToNewCString(member); \</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    return NS_OK; \</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  } \</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  NS_IMETHODIMP nsNNTPNewsgroupPost::Set##attribute(const char *aValue) \</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  { \</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    member.Assign(aValue); \</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-    return NS_OK; \</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+#define IMPL_GETSET(attribute, member)                                    \</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  NS_IMETHODIMP nsNNTPNewsgroupPost::Get##attribute(char **result) {      \</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    NS_ENSURE_ARG_POINTER(result);                                        \</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    *result = ToNewCString(member);                                       \</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    return NS_OK;                                                         \</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  }                                                                       \</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  NS_IMETHODIMP nsNNTPNewsgroupPost::Set##attribute(const char *aValue) { \</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    member.Assign(aValue);                                                \</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    return NS_OK;                                                         \</span>
<a href="#l7.46"></a><span id="l7.46">   }</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48"> IMPL_GETSET(RelayVersion, m_header[IDX_HEADER_RELAYVERSION])</span>
<a href="#l7.49"></a><span id="l7.49"> IMPL_GETSET(PostingVersion, m_header[IDX_HEADER_POSTINGVERSION])</span>
<a href="#l7.50"></a><span id="l7.50"> IMPL_GETSET(From, m_header[IDX_HEADER_FROM])</span>
<a href="#l7.51"></a><span id="l7.51"> IMPL_GETSET(Date, m_header[IDX_HEADER_DATE])</span>
<a href="#l7.52"></a><span id="l7.52"> IMPL_GETSET(Subject, m_header[IDX_HEADER_SUBJECT])</span>
<a href="#l7.53"></a><span id="l7.53"> IMPL_GETSET(Path, m_header[IDX_HEADER_PATH])</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineat">@@ -41,54 +34,43 @@ IMPL_GETSET(Sender, m_header[IDX_HEADER_</span>
<a href="#l7.55"></a><span id="l7.55"> IMPL_GETSET(FollowupTo, m_header[IDX_HEADER_FOLLOWUPTO])</span>
<a href="#l7.56"></a><span id="l7.56"> IMPL_GETSET(DateReceived, m_header[IDX_HEADER_DATERECEIVED])</span>
<a href="#l7.57"></a><span id="l7.57"> IMPL_GETSET(Expires, m_header[IDX_HEADER_EXPIRES])</span>
<a href="#l7.58"></a><span id="l7.58"> IMPL_GETSET(Control, m_header[IDX_HEADER_CONTROL])</span>
<a href="#l7.59"></a><span id="l7.59"> IMPL_GETSET(Distribution, m_header[IDX_HEADER_DISTRIBUTION])</span>
<a href="#l7.60"></a><span id="l7.60"> IMPL_GETSET(Organization, m_header[IDX_HEADER_ORGANIZATION])</span>
<a href="#l7.61"></a><span id="l7.61"> IMPL_GETSET(Body, m_body)</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-NS_IMETHODIMP nsNNTPNewsgroupPost::GetNewsgroups(char **result)</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-{</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+NS_IMETHODIMP nsNNTPNewsgroupPost::GetNewsgroups(char **result) {</span>
<a href="#l7.66"></a><span id="l7.66">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l7.67"></a><span id="l7.67">   *result = ToNewCString(m_header[IDX_HEADER_NEWSGROUPS]);</span>
<a href="#l7.68"></a><span id="l7.68">   return NS_OK;</span>
<a href="#l7.69"></a><span id="l7.69"> }</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-NS_IMETHODIMP nsNNTPNewsgroupPost::GetReferences(char **result)</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-{</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+NS_IMETHODIMP nsNNTPNewsgroupPost::GetReferences(char **result) {</span>
<a href="#l7.74"></a><span id="l7.74">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l7.75"></a><span id="l7.75">   *result = ToNewCString(m_header[IDX_HEADER_REFERENCES]);</span>
<a href="#l7.76"></a><span id="l7.76">   return NS_OK;</span>
<a href="#l7.77"></a><span id="l7.77"> }</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-NS_IMETHODIMP nsNNTPNewsgroupPost::GetIsControl(bool *result)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-{</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+NS_IMETHODIMP nsNNTPNewsgroupPost::GetIsControl(bool *result) {</span>
<a href="#l7.82"></a><span id="l7.82">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l7.83"></a><span id="l7.83">   *result = m_isControl;</span>
<a href="#l7.84"></a><span id="l7.84">   return NS_OK;</span>
<a href="#l7.85"></a><span id="l7.85"> }</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-nsresult</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-nsNNTPNewsgroupPost::AddNewsgroup(const char *newsgroup)</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-{</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-    m_header[IDX_HEADER_NEWSGROUPS].AppendLiteral(&quot;, &quot;);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-    m_header[IDX_HEADER_NEWSGROUPS].Append(newsgroup);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+nsresult nsNNTPNewsgroupPost::AddNewsgroup(const char *newsgroup) {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  m_header[IDX_HEADER_NEWSGROUPS].AppendLiteral(&quot;, &quot;);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  m_header[IDX_HEADER_NEWSGROUPS].Append(newsgroup);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.97"></a><span id="l7.97"> }</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-// the message can be stored in a file....allow accessors for getting and setting</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-// the file name to post...</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-nsresult</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-nsNNTPNewsgroupPost::SetPostMessageFile(nsIFile * aPostMessageFile)</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-{</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+// the message can be stored in a file....allow accessors for getting and</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+// setting the file name to post...</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+nsresult nsNNTPNewsgroupPost::SetPostMessageFile(nsIFile *aPostMessageFile) {</span>
<a href="#l7.108"></a><span id="l7.108">   m_postMessageFile = aPostMessageFile;</span>
<a href="#l7.109"></a><span id="l7.109">   return NS_OK;</span>
<a href="#l7.110"></a><span id="l7.110"> }</span>
<a href="#l7.111"></a><span id="l7.111"> </span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-nsresult</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-nsNNTPNewsgroupPost::GetPostMessageFile(nsIFile ** aPostMessageFile)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-{</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-  if (aPostMessageFile)</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-    NS_IF_ADDREF(*aPostMessageFile = m_postMessageFile);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+nsresult nsNNTPNewsgroupPost::GetPostMessageFile(nsIFile **aPostMessageFile) {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  if (aPostMessageFile) NS_IF_ADDREF(*aPostMessageFile = m_postMessageFile);</span>
<a href="#l7.119"></a><span id="l7.119">   return NS_OK;</span>
<a href="#l7.120"></a><span id="l7.120"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupPost.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupPost.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -7,55 +7,54 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #define __nsNNTPNewsgroupPost_h</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsINNTPNewsgroupPost.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsString.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIFile.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#define IDX_HEADER_FROM             0</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#define IDX_HEADER_NEWSGROUPS       1</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#define IDX_HEADER_SUBJECT          2</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+#define IDX_HEADER_FROM 0</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+#define IDX_HEADER_NEWSGROUPS 1</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+#define IDX_HEADER_SUBJECT 2</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> // set this to the last required header</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-#define IDX_HEADER_LAST_REQUIRED    IDX_HEADER_SUBJECT</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+#define IDX_HEADER_LAST_REQUIRED IDX_HEADER_SUBJECT</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-#define IDX_HEADER_PATH             3</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-#define IDX_HEADER_DATE             4</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+#define IDX_HEADER_PATH 3</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+#define IDX_HEADER_DATE 4</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-#define IDX_HEADER_REPLYTO          5</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-#define IDX_HEADER_SENDER           6</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-#define IDX_HEADER_FOLLOWUPTO       7</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-#define IDX_HEADER_DATERECEIVED     8</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-#define IDX_HEADER_EXPIRES          9</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-#define IDX_HEADER_CONTROL          10</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-#define IDX_HEADER_DISTRIBUTION     11</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-#define IDX_HEADER_ORGANIZATION     12</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-#define IDX_HEADER_REFERENCES       13</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+#define IDX_HEADER_REPLYTO 5</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+#define IDX_HEADER_SENDER 6</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+#define IDX_HEADER_FOLLOWUPTO 7</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+#define IDX_HEADER_DATERECEIVED 8</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+#define IDX_HEADER_EXPIRES 9</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+#define IDX_HEADER_CONTROL 10</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+#define IDX_HEADER_DISTRIBUTION 11</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+#define IDX_HEADER_ORGANIZATION 12</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+#define IDX_HEADER_REFERENCES 13</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47"> // stuff that's required to be in the message,</span>
<a href="#l8.48"></a><span id="l8.48"> // but probably generated on the server</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-#define IDX_HEADER_RELAYVERSION     14</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-#define IDX_HEADER_POSTINGVERSION   15</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-#define IDX_HEADER_MESSAGEID        16</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+#define IDX_HEADER_RELAYVERSION 14</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+#define IDX_HEADER_POSTINGVERSION 15</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+#define IDX_HEADER_MESSAGEID 16</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56"> // keep this in sync with the above</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-#define HEADER_LAST                 IDX_HEADER_MESSAGEID</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+#define HEADER_LAST IDX_HEADER_MESSAGEID</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60"> class nsNNTPNewsgroupPost : public nsINNTPNewsgroupPost {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+ public:</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  nsNNTPNewsgroupPost();</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-public:</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    nsNNTPNewsgroupPost();</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-    NS_DECL_NSINNTPNEWSGROUPPOST</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  NS_DECL_NSINNTPNEWSGROUPPOST</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-private:</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-    virtual ~nsNNTPNewsgroupPost();</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ private:</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  virtual ~nsNNTPNewsgroupPost();</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; m_postMessageFile;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    nsCString m_header[HEADER_LAST+1];</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    nsCString m_body;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-    bool m_isControl;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_postMessageFile;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  nsCString m_header[HEADER_LAST + 1];</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  nsCString m_body;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  bool m_isControl;</span>
<a href="#l8.85"></a><span id="l8.85"> };</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87"> #endif /* __nsNNTPNewsgroupPost_h */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12"> #include &quot;nntpCore.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nsNNTPProtocol.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineat">@@ -77,238 +77,235 @@</span>
<a href="#l9.20"></a><span id="l9.20"> #include &quot;nsICancelable.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22"> #include &quot;nsIInputStreamPump.h&quot;</span>
<a href="#l9.23"></a><span id="l9.23"> #include &quot;nsIProxyInfo.h&quot;</span>
<a href="#l9.24"></a><span id="l9.24"> #include &quot;nsContentSecurityManager.h&quot;</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> #include &lt;time.h&gt;</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-#undef GetPort  // XXX Windows!</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-#undef SetPort  // XXX Windows!</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-#undef PostMessage // avoid to collision with WinUser.h</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-#define PREF_NEWS_CANCEL_CONFIRM  &quot;news.cancel.confirm&quot;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+#undef GetPort      // XXX Windows!</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+#undef SetPort      // XXX Windows!</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+#undef PostMessage  // avoid to collision with WinUser.h</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+#define PREF_NEWS_CANCEL_CONFIRM &quot;news.cancel.confirm&quot;</span>
<a href="#l9.38"></a><span id="l9.38"> #define PREF_NEWS_CANCEL_ALERT_ON_SUCCESS &quot;news.cancel.alert_on_success&quot;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-#define READ_NEWS_LIST_COUNT_MAX 500 /* number of groups to process at a time when reading the list from the server */</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-#define READ_NEWS_LIST_TIMEOUT 50  /* uSec to wait until doing more */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+#define READ_NEWS_LIST_COUNT_MAX                                              \</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  500 /* number of groups to process at a time when reading the list from the \</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+         server */</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+#define READ_NEWS_LIST_TIMEOUT 50 /* uSec to wait until doing more */</span>
<a href="#l9.45"></a><span id="l9.45"> #define RATE_STR_BUF_LEN 32</span>
<a href="#l9.46"></a><span id="l9.46"> #define UPDATE_THRESHOLD 25600 /* only update every 25 KB */</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48"> using namespace mozilla::mailnews;</span>
<a href="#l9.49"></a><span id="l9.49"> using namespace mozilla;</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51"> // NNTP extensions are supported yet</span>
<a href="#l9.52"></a><span id="l9.52"> // until the extension code is ported,</span>
<a href="#l9.53"></a><span id="l9.53"> // we'll skip right to the first nntp command</span>
<a href="#l9.54"></a><span id="l9.54"> // after doing &quot;mode reader&quot;</span>
<a href="#l9.55"></a><span id="l9.55"> // and &quot;pushed&quot; authentication (if necessary),</span>
<a href="#l9.56"></a><span id="l9.56"> //#define HAVE_NNTP_EXTENSIONS</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58"> // quiet compiler warnings by defining these function prototypes</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-char *MSG_UnEscapeSearchUrl (const char *commandSpecificData);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+char *MSG_UnEscapeSearchUrl(const char *commandSpecificData);</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62"> /* Logging stuff */</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64"> static mozilla::LazyLogModule NNTP(&quot;NNTP&quot;);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-#define out     LogLevel::Info</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+#define out LogLevel::Info</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68"> #define NNTP_LOG_READ(buf) \</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-MOZ_LOG(NNTP, out, (&quot;(%p) Receiving: %s&quot;, this, buf)) ;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-#define NNTP_LOG_WRITE(buf) \</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-MOZ_LOG(NNTP, out, (&quot;(%p) Sending: %s&quot;, this, buf)) ;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-#define NNTP_LOG_NOTE(buf) \</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-MOZ_LOG(NNTP, out, (&quot;(%p) %s&quot;,this, buf)) ;</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  MOZ_LOG(NNTP, out, (&quot;(%p) Receiving: %s&quot;, this, buf));</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+#define NNTP_LOG_WRITE(buf) MOZ_LOG(NNTP, out, (&quot;(%p) Sending: %s&quot;, this, buf));</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+#define NNTP_LOG_NOTE(buf) MOZ_LOG(NNTP, out, (&quot;(%p) %s&quot;, this, buf));</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+// clang-format off</span>
<a href="#l9.84"></a><span id="l9.84"> const char *const stateLabels[] = {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-&quot;NNTP_RESPONSE&quot;,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  &quot;NNTP_RESPONSE&quot;,</span>
<a href="#l9.87"></a><span id="l9.87"> #ifdef BLOCK_UNTIL_AVAILABLE_CONNECTION</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-&quot;NNTP_BLOCK_UNTIL_CONNECTIONS_ARE_AVAILABLE&quot;,</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-&quot;NNTP_CONNECTIONS_ARE_AVAILABLE&quot;,</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  &quot;NNTP_BLOCK_UNTIL_CONNECTIONS_ARE_AVAILABLE&quot;,</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  &quot;NNTP_CONNECTIONS_ARE_AVAILABLE&quot;,</span>
<a href="#l9.92"></a><span id="l9.92"> #endif</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-&quot;NNTP_CONNECT&quot;,</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-&quot;NNTP_CONNECT_WAIT&quot;,</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-&quot;NNTP_LOGIN_RESPONSE&quot;,</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-&quot;NNTP_SEND_MODE_READER&quot;,</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-&quot;NNTP_SEND_MODE_READER_RESPONSE&quot;,</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-&quot;SEND_LIST_EXTENSIONS&quot;,</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-&quot;SEND_LIST_EXTENSIONS_RESPONSE&quot;,</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-&quot;SEND_LIST_SEARCHES&quot;,</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-&quot;SEND_LIST_SEARCHES_RESPONSE&quot;,</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-&quot;NNTP_LIST_SEARCH_HEADERS&quot;,</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-&quot;NNTP_LIST_SEARCH_HEADERS_RESPONSE&quot;,</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-&quot;NNTP_GET_PROPERTIES&quot;,</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-&quot;NNTP_GET_PROPERTIES_RESPONSE&quot;,</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-&quot;SEND_LIST_SUBSCRIPTIONS&quot;,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-&quot;SEND_LIST_SUBSCRIPTIONS_RESPONSE&quot;,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-&quot;SEND_FIRST_NNTP_COMMAND&quot;,</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-&quot;SEND_FIRST_NNTP_COMMAND_RESPONSE&quot;,</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-&quot;SETUP_NEWS_STREAM&quot;,</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-&quot;NNTP_BEGIN_AUTHORIZE&quot;,</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-&quot;NNTP_AUTHORIZE_RESPONSE&quot;,</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-&quot;NNTP_PASSWORD_RESPONSE&quot;,</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-&quot;NNTP_READ_LIST_BEGIN&quot;,</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-&quot;NNTP_READ_LIST&quot;,</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-&quot;DISPLAY_NEWSGROUPS&quot;,</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-&quot;NNTP_NEWGROUPS_BEGIN&quot;,</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-&quot;NNTP_NEWGROUPS&quot;,</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-&quot;NNTP_BEGIN_ARTICLE&quot;,</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-&quot;NNTP_READ_ARTICLE&quot;,</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-&quot;NNTP_XOVER_BEGIN&quot;,</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-&quot;NNTP_FIGURE_NEXT_CHUNK&quot;,</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-&quot;NNTP_XOVER_SEND&quot;,</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-&quot;NNTP_XOVER_RESPONSE&quot;,</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-&quot;NNTP_XOVER&quot;,</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-&quot;NEWS_PROCESS_XOVER&quot;,</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-&quot;NNTP_XHDR_SEND&quot;,</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-&quot;NNTP_XHDR_RESPONSE&quot;,</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-&quot;NNTP_READ_GROUP&quot;,</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-&quot;NNTP_READ_GROUP_RESPONSE&quot;,</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-&quot;NNTP_READ_GROUP_BODY&quot;,</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-&quot;NNTP_SEND_GROUP_FOR_ARTICLE&quot;,</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-&quot;NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE&quot;,</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-&quot;NNTP_SEND_ARTICLE_NUMBER&quot;,</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-&quot;NEWS_PROCESS_BODIES&quot;,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-&quot;NNTP_PRINT_ARTICLE_HEADERS&quot;,</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-&quot;NNTP_SEND_POST_DATA&quot;,</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-&quot;NNTP_SEND_POST_DATA_RESPONSE&quot;,</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-&quot;NNTP_CHECK_FOR_MESSAGE&quot;,</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-&quot;NEWS_START_CANCEL&quot;,</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-&quot;NEWS_DO_CANCEL&quot;,</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-&quot;NNTP_XPAT_SEND&quot;,</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-&quot;NNTP_XPAT_RESPONSE&quot;,</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-&quot;NNTP_SEARCH&quot;,</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-&quot;NNTP_SEARCH_RESPONSE&quot;,</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-&quot;NNTP_SEARCH_RESULTS&quot;,</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-&quot;NNTP_LIST_PRETTY_NAMES&quot;,</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-&quot;NNTP_LIST_PRETTY_NAMES_RESPONSE&quot;,</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-&quot;NNTP_LIST_XACTIVE_RESPONSE&quot;,</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-&quot;NNTP_LIST_XACTIVE&quot;,</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-&quot;NNTP_LIST_GROUP&quot;,</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-&quot;NNTP_LIST_GROUP_RESPONSE&quot;,</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-&quot;NEWS_DONE&quot;,</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-&quot;NEWS_POST_DONE&quot;,</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-&quot;NEWS_ERROR&quot;,</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-&quot;NNTP_ERROR&quot;,</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-&quot;NEWS_FREE&quot;,</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-&quot;NNTP_SUSPENDED&quot;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+  &quot;NNTP_CONNECT&quot;,</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  &quot;NNTP_CONNECT_WAIT&quot;,</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  &quot;NNTP_LOGIN_RESPONSE&quot;,</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+  &quot;NNTP_SEND_MODE_READER&quot;,</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  &quot;NNTP_SEND_MODE_READER_RESPONSE&quot;,</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  &quot;SEND_LIST_EXTENSIONS&quot;,</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  &quot;SEND_LIST_EXTENSIONS_RESPONSE&quot;,</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+  &quot;SEND_LIST_SEARCHES&quot;,</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+  &quot;SEND_LIST_SEARCHES_RESPONSE&quot;,</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+  &quot;NNTP_LIST_SEARCH_HEADERS&quot;,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+  &quot;NNTP_LIST_SEARCH_HEADERS_RESPONSE&quot;,</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+  &quot;NNTP_GET_PROPERTIES&quot;,</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+  &quot;NNTP_GET_PROPERTIES_RESPONSE&quot;,</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+  &quot;SEND_LIST_SUBSCRIPTIONS&quot;,</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+  &quot;SEND_LIST_SUBSCRIPTIONS_RESPONSE&quot;,</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+  &quot;SEND_FIRST_NNTP_COMMAND&quot;,</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+  &quot;SEND_FIRST_NNTP_COMMAND_RESPONSE&quot;,</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+  &quot;SETUP_NEWS_STREAM&quot;,</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+  &quot;NNTP_BEGIN_AUTHORIZE&quot;,</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+  &quot;NNTP_AUTHORIZE_RESPONSE&quot;,</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+  &quot;NNTP_PASSWORD_RESPONSE&quot;,</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+  &quot;NNTP_READ_LIST_BEGIN&quot;,</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+  &quot;NNTP_READ_LIST&quot;,</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+  &quot;DISPLAY_NEWSGROUPS&quot;,</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+  &quot;NNTP_NEWGROUPS_BEGIN&quot;,</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+  &quot;NNTP_NEWGROUPS&quot;,</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+  &quot;NNTP_BEGIN_ARTICLE&quot;,</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+  &quot;NNTP_READ_ARTICLE&quot;,</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+  &quot;NNTP_XOVER_BEGIN&quot;,</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+  &quot;NNTP_FIGURE_NEXT_CHUNK&quot;,</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+  &quot;NNTP_XOVER_SEND&quot;,</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+  &quot;NNTP_XOVER_RESPONSE&quot;,</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+  &quot;NNTP_XOVER&quot;,</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+  &quot;NEWS_PROCESS_XOVER&quot;,</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+  &quot;NNTP_XHDR_SEND&quot;,</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+  &quot;NNTP_XHDR_RESPONSE&quot;,</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+  &quot;NNTP_READ_GROUP&quot;,</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+  &quot;NNTP_READ_GROUP_RESPONSE&quot;,</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+  &quot;NNTP_READ_GROUP_BODY&quot;,</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+  &quot;NNTP_SEND_GROUP_FOR_ARTICLE&quot;,</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  &quot;NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE&quot;,</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+  &quot;NNTP_SEND_ARTICLE_NUMBER&quot;,</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+  &quot;NEWS_PROCESS_BODIES&quot;,</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+  &quot;NNTP_PRINT_ARTICLE_HEADERS&quot;,</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+  &quot;NNTP_SEND_POST_DATA&quot;,</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  &quot;NNTP_SEND_POST_DATA_RESPONSE&quot;,</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+  &quot;NNTP_CHECK_FOR_MESSAGE&quot;,</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+  &quot;NEWS_START_CANCEL&quot;,</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+  &quot;NEWS_DO_CANCEL&quot;,</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+  &quot;NNTP_XPAT_SEND&quot;,</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+  &quot;NNTP_XPAT_RESPONSE&quot;,</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+  &quot;NNTP_SEARCH&quot;,</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+  &quot;NNTP_SEARCH_RESPONSE&quot;,</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+  &quot;NNTP_SEARCH_RESULTS&quot;,</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+  &quot;NNTP_LIST_PRETTY_NAMES&quot;,</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+  &quot;NNTP_LIST_PRETTY_NAMES_RESPONSE&quot;,</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+  &quot;NNTP_LIST_XACTIVE_RESPONSE&quot;,</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+  &quot;NNTP_LIST_XACTIVE&quot;,</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+  &quot;NNTP_LIST_GROUP&quot;,</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+  &quot;NNTP_LIST_GROUP_RESPONSE&quot;,</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+  &quot;NEWS_DONE&quot;,</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+  &quot;NEWS_POST_DONE&quot;,</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  &quot;NEWS_ERROR&quot;,</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+  &quot;NNTP_ERROR&quot;,</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+  &quot;NEWS_FREE&quot;,</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+  &quot;NNTP_SUSPENDED&quot;</span>
<a href="#l9.225"></a><span id="l9.225"> };</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+// clang-format on</span>
<a href="#l9.228"></a><span id="l9.228"> </span>
<a href="#l9.229"></a><span id="l9.229"> /* end logging */</span>
<a href="#l9.230"></a><span id="l9.230"> </span>
<a href="#l9.231"></a><span id="l9.231"> /* Forward declarations */</span>
<a href="#l9.232"></a><span id="l9.232"> </span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-#define LIST_WANTED     0</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-#define ARTICLE_WANTED  1</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-#define CANCEL_WANTED   2</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-#define GROUP_WANTED    3</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-#define NEWS_POST       4</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-#define NEW_GROUPS      5</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-#define SEARCH_WANTED   6</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-#define IDS_WANTED      7</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+#define LIST_WANTED 0</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+#define ARTICLE_WANTED 1</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+#define CANCEL_WANTED 2</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+#define GROUP_WANTED 3</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+#define NEWS_POST 4</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+#define NEW_GROUPS 5</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+#define SEARCH_WANTED 6</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+#define IDS_WANTED 7</span>
<a href="#l9.249"></a><span id="l9.249"> </span>
<a href="#l9.250"></a><span id="l9.250"> /* the output_buffer_size must be larger than the largest possible line</span>
<a href="#l9.251"></a><span id="l9.251">  * 2000 seems good for news</span>
<a href="#l9.252"></a><span id="l9.252">  *</span>
<a href="#l9.253"></a><span id="l9.253">  * jwz: I increased this to 4k since it must be big enough to hold the</span>
<a href="#l9.254"></a><span id="l9.254">  * entire button-bar HTML, and with the new &quot;mailto&quot; format, that can</span>
<a href="#l9.255"></a><span id="l9.255">  * contain arbitrarily long header fields like &quot;references&quot;.</span>
<a href="#l9.256"></a><span id="l9.256">  *</span>
<a href="#l9.257"></a><span id="l9.257">  * fortezza: proxy auth is huge, buffer increased to 8k (sigh).</span>
<a href="#l9.258"></a><span id="l9.258">  */</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-#define OUTPUT_BUFFER_SIZE (4096*2)</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+#define OUTPUT_BUFFER_SIZE (4096 * 2)</span>
<a href="#l9.261"></a><span id="l9.261"> </span>
<a href="#l9.262"></a><span id="l9.262"> /* the amount of time to subtract from the machine time</span>
<a href="#l9.263"></a><span id="l9.263">  * for the newgroup command sent to the nntp server</span>
<a href="#l9.264"></a><span id="l9.264">  */</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-#define NEWGROUPS_TIME_OFFSET 60L*60L*12L   /* 12 hours */</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+#define NEWGROUPS_TIME_OFFSET 60L * 60L * 12L /* 12 hours */</span>
<a href="#l9.267"></a><span id="l9.267"> </span>
<a href="#l9.268"></a><span id="l9.268"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.269"></a><span id="l9.269"> // TEMPORARY HARD CODED FUNCTIONS</span>
<a href="#l9.270"></a><span id="l9.270"> ///////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-#define NET_IS_SPACE(x) ((x)==' ' || (x)=='\t')</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+#define NET_IS_SPACE(x) ((x) == ' ' || (x) == '\t')</span>
<a href="#l9.273"></a><span id="l9.273"> </span>
<a href="#l9.274"></a><span id="l9.274"> // turn &quot;\xx&quot; (with xx being hex numbers) in string into chars</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-char *MSG_UnEscapeSearchUrl (const char *commandSpecificData)</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-{</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+char *MSG_UnEscapeSearchUrl(const char *commandSpecificData) {</span>
<a href="#l9.278"></a><span id="l9.278">   nsAutoCString result(commandSpecificData);</span>
<a href="#l9.279"></a><span id="l9.279">   int32_t slashpos = 0;</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-  while ((slashpos = result.FindChar('\\', slashpos)) != kNotFound)</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-  {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+  while ((slashpos = result.FindChar('\\', slashpos)) != kNotFound) {</span>
<a href="#l9.283"></a><span id="l9.283">     nsAutoCString hex;</span>
<a href="#l9.284"></a><span id="l9.284">     hex.Assign(Substring(result, slashpos + 1, 2));</span>
<a href="#l9.285"></a><span id="l9.285">     int32_t ch;</span>
<a href="#l9.286"></a><span id="l9.286">     nsresult rv;</span>
<a href="#l9.287"></a><span id="l9.287">     ch = hex.ToInteger(&amp;rv, 16);</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-    result.Replace(slashpos, 3, NS_SUCCEEDED(rv) &amp;&amp; ch != 0 ? (char) ch : 'X');</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+    result.Replace(slashpos, 3, NS_SUCCEEDED(rv) &amp;&amp; ch != 0 ? (char)ch : 'X');</span>
<a href="#l9.290"></a><span id="l9.290">     slashpos++;</span>
<a href="#l9.291"></a><span id="l9.291">   }</span>
<a href="#l9.292"></a><span id="l9.292">   return ToNewCString(result);</span>
<a href="#l9.293"></a><span id="l9.293"> }</span>
<a href="#l9.294"></a><span id="l9.294"> </span>
<a href="#l9.295"></a><span id="l9.295"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.296"></a><span id="l9.296"> // END OF TEMPORARY HARD CODED FUNCTIONS</span>
<a href="#l9.297"></a><span id="l9.297"> ///////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.298"></a><span id="l9.298"> </span>
<a href="#l9.299"></a><span id="l9.299"> NS_IMPL_ISUPPORTS_INHERITED(nsNNTPProtocol, nsMsgProtocol, nsINNTPProtocol,</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-  nsITimerCallback, nsICacheEntryOpenCallback, nsIMsgAsyncPromptListener, nsIProtocolProxyCallback)</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+                            nsITimerCallback, nsICacheEntryOpenCallback,</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+                            nsIMsgAsyncPromptListener, nsIProtocolProxyCallback)</span>
<a href="#l9.303"></a><span id="l9.303"> </span>
<a href="#l9.304"></a><span id="l9.304"> nsNNTPProtocol::nsNNTPProtocol(nsINntpIncomingServer *aServer, nsIURI *aURL,</span>
<a href="#l9.305"></a><span id="l9.305">                                nsIMsgWindow *aMsgWindow)</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-: nsMsgProtocol(aURL),</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-  m_connectionBusy(false),</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-  m_nntpServer(aServer)</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-{</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+    : nsMsgProtocol(aURL), m_connectionBusy(false), m_nntpServer(aServer) {</span>
<a href="#l9.311"></a><span id="l9.311">   m_ProxyServer = nullptr;</span>
<a href="#l9.312"></a><span id="l9.312">   m_responseText = nullptr;</span>
<a href="#l9.313"></a><span id="l9.313">   m_dataBuf = nullptr;</span>
<a href="#l9.314"></a><span id="l9.314"> </span>
<a href="#l9.315"></a><span id="l9.315">   m_key = nsMsgKey_None;</span>
<a href="#l9.316"></a><span id="l9.316"> </span>
<a href="#l9.317"></a><span id="l9.317">   mBytesReceived = 0;</span>
<a href="#l9.318"></a><span id="l9.318">   mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l9.319"></a><span id="l9.319">   m_startTime = PR_Now();</span>
<a href="#l9.320"></a><span id="l9.320"> </span>
<a href="#l9.321"></a><span id="l9.321">   if (aMsgWindow) {</span>
<a href="#l9.322"></a><span id="l9.322">     m_msgWindow = aMsgWindow;</span>
<a href="#l9.323"></a><span id="l9.323">   }</span>
<a href="#l9.324"></a><span id="l9.324"> </span>
<a href="#l9.325"></a><span id="l9.325">   m_runningURL = nullptr;</span>
<a href="#l9.326"></a><span id="l9.326">   m_fromCache = false;</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) creating&quot;,this));</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) initializing, so unset m_currentGroup&quot;,this));</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) creating&quot;, this));</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+          (&quot;(%p) initializing, so unset m_currentGroup&quot;, this));</span>
<a href="#l9.332"></a><span id="l9.332">   m_currentGroup.Truncate();</span>
<a href="#l9.333"></a><span id="l9.333">   m_lastActiveTimeStamp = 0;</span>
<a href="#l9.334"></a><span id="l9.334"> }</span>
<a href="#l9.335"></a><span id="l9.335"> </span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-nsNNTPProtocol::~nsNNTPProtocol()</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-{</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) destroying&quot;,this));</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+nsNNTPProtocol::~nsNNTPProtocol() {</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) destroying&quot;, this));</span>
<a href="#l9.341"></a><span id="l9.341">   if (m_nntpServer) {</span>
<a href="#l9.342"></a><span id="l9.342">     m_nntpServer-&gt;WriteNewsrcFile();</span>
<a href="#l9.343"></a><span id="l9.343">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l9.344"></a><span id="l9.344">   }</span>
<a href="#l9.345"></a><span id="l9.345">   if (mUpdateTimer) {</span>
<a href="#l9.346"></a><span id="l9.346">     mUpdateTimer-&gt;Cancel();</span>
<a href="#l9.347"></a><span id="l9.347">     mUpdateTimer = nullptr;</span>
<a href="#l9.348"></a><span id="l9.348">   }</span>
<a href="#l9.349"></a><span id="l9.349">   Cleanup();</span>
<a href="#l9.350"></a><span id="l9.350"> }</span>
<a href="#l9.351"></a><span id="l9.351"> </span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-void nsNNTPProtocol::Cleanup()  //free char* member variables</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+void nsNNTPProtocol::Cleanup()  // free char* member variables</span>
<a href="#l9.354"></a><span id="l9.354"> {</span>
<a href="#l9.355"></a><span id="l9.355">   PR_FREEIF(m_responseText);</span>
<a href="#l9.356"></a><span id="l9.356">   PR_FREEIF(m_dataBuf);</span>
<a href="#l9.357"></a><span id="l9.357"> }</span>
<a href="#l9.358"></a><span id="l9.358"> </span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::Initialize(nsIURI *aURL, nsIMsgWindow *aMsgWindow)</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-{</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::Initialize(nsIURI *aURL,</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+                                         nsIMsgWindow *aMsgWindow) {</span>
<a href="#l9.363"></a><span id="l9.363">   if (aMsgWindow) {</span>
<a href="#l9.364"></a><span id="l9.364">     m_msgWindow = aMsgWindow;</span>
<a href="#l9.365"></a><span id="l9.365">   }</span>
<a href="#l9.366"></a><span id="l9.366">   nsMsgProtocol::InitFromURI(aURL);</span>
<a href="#l9.367"></a><span id="l9.367"> </span>
<a href="#l9.368"></a><span id="l9.368">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer);</span>
<a href="#l9.369"></a><span id="l9.369">   NS_ASSERTION(m_nntpServer, &quot;nsNNTPProtocol need an m_nntpServer.&quot;);</span>
<a href="#l9.370"></a><span id="l9.370">   NS_ENSURE_TRUE(m_nntpServer, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineat">@@ -317,23 +314,24 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l9.372"></a><span id="l9.372">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.373"></a><span id="l9.373"> </span>
<a href="#l9.374"></a><span id="l9.374">   int32_t socketType;</span>
<a href="#l9.375"></a><span id="l9.375">   rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l9.376"></a><span id="l9.376">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.377"></a><span id="l9.377"> </span>
<a href="#l9.378"></a><span id="l9.378">   int32_t port = 0;</span>
<a href="#l9.379"></a><span id="l9.379">   rv = m_url-&gt;GetPort(&amp;port);</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-  if (NS_FAILED(rv) || (port&lt;=0)) {</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+  if (NS_FAILED(rv) || (port &lt;= 0)) {</span>
<a href="#l9.382"></a><span id="l9.382">     rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l9.383"></a><span id="l9.383">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.384"></a><span id="l9.384"> </span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-    if (port&lt;=0) {</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-      port = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-             nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+    if (port &lt;= 0) {</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+      port = (socketType == nsMsgSocketType::SSL)</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+                 ? nsINntpUrl::DEFAULT_NNTPS_PORT</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+                 : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l9.392"></a><span id="l9.392">     }</span>
<a href="#l9.393"></a><span id="l9.393"> </span>
<a href="#l9.394"></a><span id="l9.394">     // Don't mutate/clone here.</span>
<a href="#l9.395"></a><span id="l9.395">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_url);</span>
<a href="#l9.396"></a><span id="l9.396">     rv = mailnewsurl-&gt;SetPortInternal(port);</span>
<a href="#l9.397"></a><span id="l9.397">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.398"></a><span id="l9.398">   }</span>
<a href="#l9.399"></a><span id="l9.399"> </span>
<a href="#l9.400"></a><span id="l9.400" class="difflineat">@@ -347,67 +345,61 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l9.401"></a><span id="l9.401"> </span>
<a href="#l9.402"></a><span id="l9.402">   // Initialize m_newsAction before possible use in ParseURL method</span>
<a href="#l9.403"></a><span id="l9.403">   m_runningURL-&gt;GetNewsAction(&amp;m_newsAction);</span>
<a href="#l9.404"></a><span id="l9.404"> </span>
<a href="#l9.405"></a><span id="l9.405">   // parse url to get the msg folder and check if the message is in the folder's</span>
<a href="#l9.406"></a><span id="l9.406">   // local cache before opening a new socket and trying to download the message</span>
<a href="#l9.407"></a><span id="l9.407">   rv = ParseURL(m_url, group, m_messageID);</span>
<a href="#l9.408"></a><span id="l9.408"> </span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; m_runningURL)</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-  {</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; m_runningURL) {</span>
<a href="#l9.412"></a><span id="l9.412">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-    {</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-      if (aMsgWindow)</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-        mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-      if (m_newsAction == nsINntpUrl::ActionFetchArticle || m_newsAction == nsINntpUrl::ActionFetchPart</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-          || m_newsAction == nsINntpUrl::ActionSaveMessageToDisk)</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-      {</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+    if (mailnewsUrl) {</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineplus">+      if (aMsgWindow) mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+      if (m_newsAction == nsINntpUrl::ActionFetchArticle ||</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+          m_newsAction == nsINntpUrl::ActionFetchPart ||</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+          m_newsAction == nsINntpUrl::ActionSaveMessageToDisk) {</span>
<a href="#l9.427"></a><span id="l9.427">         // Look for the content length</span>
<a href="#l9.428"></a><span id="l9.428">         nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(m_runningURL));</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-        if (msgUrl)</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-        {</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+        if (msgUrl) {</span>
<a href="#l9.432"></a><span id="l9.432">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.433"></a><span id="l9.433">           msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-          if (msgHdr)</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-          {</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+          if (msgHdr) {</span>
<a href="#l9.437"></a><span id="l9.437">             // Note that for attachments, the messageSize is going to be the</span>
<a href="#l9.438"></a><span id="l9.438">             // size of the entire message</span>
<a href="#l9.439"></a><span id="l9.439">             uint32_t messageSize;</span>
<a href="#l9.440"></a><span id="l9.440">             msgHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l9.441"></a><span id="l9.441">             SetContentLength(messageSize);</span>
<a href="#l9.442"></a><span id="l9.442">           }</span>
<a href="#l9.443"></a><span id="l9.443">         }</span>
<a href="#l9.444"></a><span id="l9.444"> </span>
<a href="#l9.445"></a><span id="l9.445">         bool msgIsInLocalCache = false;</span>
<a href="#l9.446"></a><span id="l9.446">         mailnewsUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInLocalCache);</span>
<a href="#l9.447"></a><span id="l9.447">         if (msgIsInLocalCache || WeAreOffline())</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-          return NS_OK; // probably don't need to do anything else - definitely don't want</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+          return NS_OK;  // probably don't need to do anything else - definitely</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+                         // don't want</span>
<a href="#l9.451"></a><span id="l9.451">         // to open the socket.</span>
<a href="#l9.452"></a><span id="l9.452">       }</span>
<a href="#l9.453"></a><span id="l9.453">     }</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineminus">-  }</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineminus">-  else {</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+  } else {</span>
<a href="#l9.457"></a><span id="l9.457">     return rv;</span>
<a href="#l9.458"></a><span id="l9.458">   }</span>
<a href="#l9.459"></a><span id="l9.459"> </span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-  if (!m_socketIsOpen)</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-  {</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+  if (!m_socketIsOpen) {</span>
<a href="#l9.463"></a><span id="l9.463">     m_nextState = NNTP_LOGIN_RESPONSE;</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-  }</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-  else {</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+  } else {</span>
<a href="#l9.467"></a><span id="l9.467">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.468"></a><span id="l9.468">   }</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-  m_dataBuf = (char *) PR_Malloc(sizeof(char) * OUTPUT_BUFFER_SIZE);</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+  m_dataBuf = (char *)PR_Malloc(sizeof(char) * OUTPUT_BUFFER_SIZE);</span>
<a href="#l9.471"></a><span id="l9.471">   m_dataBufSize = OUTPUT_BUFFER_SIZE;</span>
<a href="#l9.472"></a><span id="l9.472"> </span>
<a href="#l9.473"></a><span id="l9.473">   if (!m_lineStreamBuffer)</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-    m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true /* create new lines */);</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+    m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+                                                   true /* create new lines */);</span>
<a href="#l9.477"></a><span id="l9.477"> </span>
<a href="#l9.478"></a><span id="l9.478">   m_typeWanted = 0;</span>
<a href="#l9.479"></a><span id="l9.479">   m_responseCode = 0;</span>
<a href="#l9.480"></a><span id="l9.480">   m_previousResponseCode = 0;</span>
<a href="#l9.481"></a><span id="l9.481">   m_responseText = nullptr;</span>
<a href="#l9.482"></a><span id="l9.482"> </span>
<a href="#l9.483"></a><span id="l9.483">   m_firstArticle = 0;</span>
<a href="#l9.484"></a><span id="l9.484">   m_lastArticle = 0;</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineat">@@ -422,390 +414,374 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l9.486"></a><span id="l9.486">   m_originalContentLength = 0;</span>
<a href="#l9.487"></a><span id="l9.487">   m_cancelID.Truncate();</span>
<a href="#l9.488"></a><span id="l9.488">   m_cancelFromHdr.Truncate();</span>
<a href="#l9.489"></a><span id="l9.489">   m_cancelNewsgroups.Truncate();</span>
<a href="#l9.490"></a><span id="l9.490">   m_cancelDistribution.Truncate();</span>
<a href="#l9.491"></a><span id="l9.491">   return NS_OK;</span>
<a href="#l9.492"></a><span id="l9.492"> }</span>
<a href="#l9.493"></a><span id="l9.493"> </span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::GetIsBusy(bool *aIsBusy)</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-{</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::GetIsBusy(bool *aIsBusy) {</span>
<a href="#l9.497"></a><span id="l9.497">   NS_ENSURE_ARG_POINTER(aIsBusy);</span>
<a href="#l9.498"></a><span id="l9.498">   *aIsBusy = m_connectionBusy;</span>
<a href="#l9.499"></a><span id="l9.499">   return NS_OK;</span>
<a href="#l9.500"></a><span id="l9.500"> }</span>
<a href="#l9.501"></a><span id="l9.501"> </span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::SetIsBusy(bool aIsBusy)</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-{</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) setting busy to %d&quot;,this, aIsBusy));</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::SetIsBusy(bool aIsBusy) {</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) setting busy to %d&quot;, this, aIsBusy));</span>
<a href="#l9.507"></a><span id="l9.507">   m_connectionBusy = aIsBusy;</span>
<a href="#l9.508"></a><span id="l9.508"> </span>
<a href="#l9.509"></a><span id="l9.509">   // Maybe we could load another URI.</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-  if (!aIsBusy &amp;&amp; m_nntpServer)</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-    m_nntpServer-&gt;PrepareForNextUrl(this);</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+  if (!aIsBusy &amp;&amp; m_nntpServer) m_nntpServer-&gt;PrepareForNextUrl(this);</span>
<a href="#l9.513"></a><span id="l9.513"> </span>
<a href="#l9.514"></a><span id="l9.514">   return NS_OK;</span>
<a href="#l9.515"></a><span id="l9.515"> }</span>
<a href="#l9.516"></a><span id="l9.516"> </span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::GetIsCachedConnection(bool *aIsCachedConnection)</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineminus">-{</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::GetIsCachedConnection(bool *aIsCachedConnection) {</span>
<a href="#l9.520"></a><span id="l9.520">   NS_ENSURE_ARG_POINTER(aIsCachedConnection);</span>
<a href="#l9.521"></a><span id="l9.521">   *aIsCachedConnection = m_fromCache;</span>
<a href="#l9.522"></a><span id="l9.522">   return NS_OK;</span>
<a href="#l9.523"></a><span id="l9.523"> }</span>
<a href="#l9.524"></a><span id="l9.524"> </span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::SetIsCachedConnection(bool aIsCachedConnection)</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-{</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::SetIsCachedConnection(bool aIsCachedConnection) {</span>
<a href="#l9.528"></a><span id="l9.528">   m_fromCache = aIsCachedConnection;</span>
<a href="#l9.529"></a><span id="l9.529">   return NS_OK;</span>
<a href="#l9.530"></a><span id="l9.530"> }</span>
<a href="#l9.531"></a><span id="l9.531"> </span>
<a href="#l9.532"></a><span id="l9.532"> /* void GetLastActiveTimeStamp (out PRTime aTimeStamp); */</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::GetLastActiveTimeStamp(PRTime *aTimeStamp)</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineminus">-{</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::GetLastActiveTimeStamp(PRTime *aTimeStamp) {</span>
<a href="#l9.536"></a><span id="l9.536">   NS_ENSURE_ARG_POINTER(aTimeStamp);</span>
<a href="#l9.537"></a><span id="l9.537">   *aTimeStamp = m_lastActiveTimeStamp;</span>
<a href="#l9.538"></a><span id="l9.538">   return NS_OK;</span>
<a href="#l9.539"></a><span id="l9.539"> }</span>
<a href="#l9.540"></a><span id="l9.540"> </span>
<a href="#l9.541"></a><span id="l9.541" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::LoadNewsUrl(nsIURI * aURL, nsISupports * aConsumer)</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineminus">-{</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::LoadNewsUrl(nsIURI *aURL,</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+                                          nsISupports *aConsumer) {</span>
<a href="#l9.545"></a><span id="l9.545">   // clear the previous channel listener and use the new one....</span>
<a href="#l9.546"></a><span id="l9.546">   // don't reuse an existing channel listener</span>
<a href="#l9.547"></a><span id="l9.547">   m_channelListener = nullptr;</span>
<a href="#l9.548"></a><span id="l9.548">   m_channelListener = do_QueryInterface(aConsumer);</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-  nsCOMPtr&lt;nsINntpUrl&gt; newsUrl (do_QueryInterface(aURL));</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+  nsCOMPtr&lt;nsINntpUrl&gt; newsUrl(do_QueryInterface(aURL));</span>
<a href="#l9.551"></a><span id="l9.551">   newsUrl-&gt;GetNewsAction(&amp;m_newsAction);</span>
<a href="#l9.552"></a><span id="l9.552"> </span>
<a href="#l9.553"></a><span id="l9.553">   SetupPartExtractorListener(m_channelListener);</span>
<a href="#l9.554"></a><span id="l9.554">   return LoadUrl(aURL, aConsumer);</span>
<a href="#l9.555"></a><span id="l9.555"> }</span>
<a href="#l9.556"></a><span id="l9.556"> </span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-// WARNING: the cache stream listener is intended to be accessed from the UI thread!</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-// it will NOT create another proxy for the stream listener that gets passed in...</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-class nsNntpCacheStreamListener : public nsIStreamListener</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-{</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-public:</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+// WARNING: the cache stream listener is intended to be accessed from the UI</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+// thread! it will NOT create another proxy for the stream listener that gets</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+// passed in...</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+class nsNntpCacheStreamListener : public nsIStreamListener {</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+ public:</span>
<a href="#l9.568"></a><span id="l9.568">   NS_DECL_ISUPPORTS</span>
<a href="#l9.569"></a><span id="l9.569">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l9.570"></a><span id="l9.570">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l9.571"></a><span id="l9.571"> </span>
<a href="#l9.572"></a><span id="l9.572" class="difflineminus">-  nsNntpCacheStreamListener ();</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineminus">-</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineminus">-  nsresult Init(nsIStreamListener * aStreamListener, nsIChannel* channel, nsIMsgMailNewsUrl *aRunningUrl);</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-protected:</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineplus">+  nsNntpCacheStreamListener();</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineplus">+</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+  nsresult Init(nsIStreamListener *aStreamListener, nsIChannel *channel,</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+                nsIMsgMailNewsUrl *aRunningUrl);</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineplus">+</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineplus">+ protected:</span>
<a href="#l9.582"></a><span id="l9.582">   virtual ~nsNntpCacheStreamListener();</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; mChannelToUse;</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; mChannelToUse;</span>
<a href="#l9.585"></a><span id="l9.585">   nsCOMPtr&lt;nsIStreamListener&gt; mListener;</span>
<a href="#l9.586"></a><span id="l9.586">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mRunningUrl;</span>
<a href="#l9.587"></a><span id="l9.587"> };</span>
<a href="#l9.588"></a><span id="l9.588"> </span>
<a href="#l9.589"></a><span id="l9.589"> NS_IMPL_ADDREF(nsNntpCacheStreamListener)</span>
<a href="#l9.590"></a><span id="l9.590"> NS_IMPL_RELEASE(nsNntpCacheStreamListener)</span>
<a href="#l9.591"></a><span id="l9.591"> </span>
<a href="#l9.592"></a><span id="l9.592"> NS_INTERFACE_MAP_BEGIN(nsNntpCacheStreamListener)</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIStreamListener)</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIStreamListener)</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIStreamListener)</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIStreamListener)</span>
<a href="#l9.599"></a><span id="l9.599"> NS_INTERFACE_MAP_END</span>
<a href="#l9.600"></a><span id="l9.600"> </span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-nsNntpCacheStreamListener::nsNntpCacheStreamListener()</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-{</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineminus">-}</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-nsNntpCacheStreamListener::~nsNntpCacheStreamListener()</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-{}</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-nsresult nsNntpCacheStreamListener::Init(nsIStreamListener * aStreamListener, nsIChannel* channel,</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-                                         nsIMsgMailNewsUrl *aRunningUrl)</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-{</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+nsNntpCacheStreamListener::nsNntpCacheStreamListener() {}</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineplus">+nsNntpCacheStreamListener::~nsNntpCacheStreamListener() {}</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineplus">+</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+nsresult nsNntpCacheStreamListener::Init(nsIStreamListener *aStreamListener,</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+                                         nsIChannel *channel,</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+                                         nsIMsgMailNewsUrl *aRunningUrl) {</span>
<a href="#l9.618"></a><span id="l9.618">   NS_ENSURE_ARG(aStreamListener);</span>
<a href="#l9.619"></a><span id="l9.619">   NS_ENSURE_ARG(channel);</span>
<a href="#l9.620"></a><span id="l9.620"> </span>
<a href="#l9.621"></a><span id="l9.621">   mChannelToUse = channel;</span>
<a href="#l9.622"></a><span id="l9.622"> </span>
<a href="#l9.623"></a><span id="l9.623">   mListener = aStreamListener;</span>
<a href="#l9.624"></a><span id="l9.624">   mRunningUrl = aRunningUrl;</span>
<a href="#l9.625"></a><span id="l9.625">   return NS_OK;</span>
<a href="#l9.626"></a><span id="l9.626"> }</span>
<a href="#l9.627"></a><span id="l9.627"> </span>
<a href="#l9.628"></a><span id="l9.628"> NS_IMETHODIMP</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-nsNntpCacheStreamListener::OnStartRequest(nsIRequest *request)</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-{</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-  nsCOMPtr &lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+nsNntpCacheStreamListener::OnStartRequest(nsIRequest *request) {</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+  nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l9.634"></a><span id="l9.634"> </span>
<a href="#l9.635"></a><span id="l9.635">   NS_ASSERTION(mChannelToUse, &quot;null channel in OnStartRequest&quot;);</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-  if (mChannelToUse)</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineminus">-    mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineplus">+  if (mChannelToUse) mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l9.639"></a><span id="l9.639">   if (loadGroup)</span>
<a href="#l9.640"></a><span id="l9.640">     loadGroup-&gt;AddRequest(mChannelToUse, nullptr /* context isupports */);</span>
<a href="#l9.641"></a><span id="l9.641">   return (mListener) ? mListener-&gt;OnStartRequest(mChannelToUse) : NS_OK;</span>
<a href="#l9.642"></a><span id="l9.642"> }</span>
<a href="#l9.643"></a><span id="l9.643"> </span>
<a href="#l9.644"></a><span id="l9.644"> NS_IMETHODIMP</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-nsNntpCacheStreamListener::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-{</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineplus">+nsNntpCacheStreamListener::OnStopRequest(nsIRequest *request,</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineplus">+                                         nsresult aStatus) {</span>
<a href="#l9.649"></a><span id="l9.649">   nsresult rv = NS_OK;</span>
<a href="#l9.650"></a><span id="l9.650">   NS_ASSERTION(mListener, &quot;this assertion is for Bug 531794 comment 7&quot;);</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-  if (mListener)</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineminus">-    mListener-&gt;OnStopRequest(mChannelToUse, aStatus);</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineminus">-  nsCOMPtr &lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+  if (mListener) mListener-&gt;OnStopRequest(mChannelToUse, aStatus);</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+  nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l9.656"></a><span id="l9.656">   NS_ASSERTION(mChannelToUse, &quot;null channel in OnStopRequest&quot;);</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineminus">-  if (mChannelToUse)</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineminus">-    mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineminus">-  if (loadGroup)</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-    loadGroup-&gt;RemoveRequest(mChannelToUse, nullptr, aStatus);</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineplus">+  if (mChannelToUse) mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+  if (loadGroup) loadGroup-&gt;RemoveRequest(mChannelToUse, nullptr, aStatus);</span>
<a href="#l9.663"></a><span id="l9.663"> </span>
<a href="#l9.664"></a><span id="l9.664">   // clear out mem cache entry so we're not holding onto it.</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-  if (mRunningUrl)</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-    mRunningUrl-&gt;SetMemCacheEntry(nullptr);</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineplus">+  if (mRunningUrl) mRunningUrl-&gt;SetMemCacheEntry(nullptr);</span>
<a href="#l9.668"></a><span id="l9.668"> </span>
<a href="#l9.669"></a><span id="l9.669">   mListener = nullptr;</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-  nsCOMPtr &lt;nsINNTPProtocol&gt; nntpProtocol = do_QueryInterface(mChannelToUse);</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+  nsCOMPtr&lt;nsINNTPProtocol&gt; nntpProtocol = do_QueryInterface(mChannelToUse);</span>
<a href="#l9.672"></a><span id="l9.672">   if (nntpProtocol) {</span>
<a href="#l9.673"></a><span id="l9.673">     rv = nntpProtocol-&gt;SetIsBusy(false);</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.676"></a><span id="l9.676">   }</span>
<a href="#l9.677"></a><span id="l9.677">   mChannelToUse = nullptr;</span>
<a href="#l9.678"></a><span id="l9.678">   return rv;</span>
<a href="#l9.679"></a><span id="l9.679"> }</span>
<a href="#l9.680"></a><span id="l9.680"> </span>
<a href="#l9.681"></a><span id="l9.681"> NS_IMETHODIMP</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-nsNntpCacheStreamListener::OnDataAvailable(nsIRequest *request, nsIInputStream * aInStream, uint64_t aSourceOffset, uint32_t aCount)</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-{</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-    NS_ENSURE_STATE(mListener);</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-    return mListener-&gt;OnDataAvailable(mChannelToUse, aInStream, aSourceOffset, aCount);</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineplus">+nsNntpCacheStreamListener::OnDataAvailable(nsIRequest *request,</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineplus">+                                           nsIInputStream *aInStream,</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineplus">+                                           uint64_t aSourceOffset,</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineplus">+                                           uint32_t aCount) {</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineplus">+  NS_ENSURE_STATE(mListener);</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineplus">+  return mListener-&gt;OnDataAvailable(mChannelToUse, aInStream, aSourceOffset,</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineplus">+                                    aCount);</span>
<a href="#l9.693"></a><span id="l9.693"> }</span>
<a href="#l9.694"></a><span id="l9.694"> </span>
<a href="#l9.695"></a><span id="l9.695" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::GetOriginalURI(nsIURI* *aURI)</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineminus">-{</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-    // News does not seem to have the notion of an original URI (See Bug #193317)</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-    NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::GetOriginalURI(nsIURI **aURI) {</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+  // News does not seem to have the notion of an original URI (See Bug #193317)</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineplus">+  NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.704"></a><span id="l9.704"> }</span>
<a href="#l9.705"></a><span id="l9.705"> </span>
<a href="#l9.706"></a><span id="l9.706" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::SetOriginalURI(nsIURI* aURI)</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineminus">-{</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineminus">-    // News does not seem to have the notion of an original URI (See Bug #193317)</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-    return NS_OK;       // ignore</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::SetOriginalURI(nsIURI *aURI) {</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+  // News does not seem to have the notion of an original URI (See Bug #193317)</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineplus">+  return NS_OK;  // ignore</span>
<a href="#l9.713"></a><span id="l9.713"> }</span>
<a href="#l9.714"></a><span id="l9.714"> </span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-nsresult nsNNTPProtocol::SetupPartExtractorListener(nsIStreamListener * aConsumer)</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-{</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+nsresult nsNNTPProtocol::SetupPartExtractorListener(</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+    nsIStreamListener *aConsumer) {</span>
<a href="#l9.719"></a><span id="l9.719">   bool convertData = false;</span>
<a href="#l9.720"></a><span id="l9.720">   nsresult rv = NS_OK;</span>
<a href="#l9.721"></a><span id="l9.721"> </span>
<a href="#l9.722"></a><span id="l9.722" class="difflineminus">-  if (m_newsAction == nsINntpUrl::ActionFetchArticle)</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-  {</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+  if (m_newsAction == nsINntpUrl::ActionFetchArticle) {</span>
<a href="#l9.725"></a><span id="l9.725">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.728"></a><span id="l9.728"> </span>
<a href="#l9.729"></a><span id="l9.729">     nsAutoCString queryStr;</span>
<a href="#l9.730"></a><span id="l9.730">     rv = msgUrl-&gt;GetQuery(queryStr);</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.733"></a><span id="l9.733"> </span>
<a href="#l9.734"></a><span id="l9.734">     // check if this is a filter plugin requesting the message.</span>
<a href="#l9.735"></a><span id="l9.735">     // in that case, set up a text converter</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineminus">-    convertData = (queryStr.Find(&quot;header=filter&quot;) != kNotFound</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineminus">-      || queryStr.Find(&quot;header=attach&quot;) != kNotFound);</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-  }</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineminus">-  else</span>
<a href="#l9.740"></a><span id="l9.740" class="difflineminus">-  {</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineplus">+    convertData = (queryStr.Find(&quot;header=filter&quot;) != kNotFound ||</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineplus">+                   queryStr.Find(&quot;header=attach&quot;) != kNotFound);</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineplus">+  } else {</span>
<a href="#l9.744"></a><span id="l9.744">     convertData = (m_newsAction == nsINntpUrl::ActionFetchPart);</span>
<a href="#l9.745"></a><span id="l9.745">   }</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineminus">-  if (convertData)</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineminus">-  {</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-    nsCOMPtr&lt;nsIStreamConverterService&gt; converter = do_GetService(&quot;@mozilla.org/streamConverters;1&quot;);</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-    if (converter &amp;&amp; aConsumer)</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineminus">-    {</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineplus">+  if (convertData) {</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+    nsCOMPtr&lt;nsIStreamConverterService&gt; converter =</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+        do_GetService(&quot;@mozilla.org/streamConverters;1&quot;);</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+    if (converter &amp;&amp; aConsumer) {</span>
<a href="#l9.755"></a><span id="l9.755">       nsCOMPtr&lt;nsIStreamListener&gt; newConsumer;</span>
<a href="#l9.756"></a><span id="l9.756">       nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l9.757"></a><span id="l9.757">       QueryInterface(NS_GET_IID(nsIChannel), getter_AddRefs(channel));</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineminus">-      converter-&gt;AsyncConvertData(&quot;message/rfc822&quot;, &quot;*/*&quot;,</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineminus">-           aConsumer, channel, getter_AddRefs(newConsumer));</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineminus">-      if (newConsumer)</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineminus">-        m_channelListener = newConsumer;</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineplus">+      converter-&gt;AsyncConvertData(&quot;message/rfc822&quot;, &quot;*/*&quot;, aConsumer, channel,</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineplus">+                                  getter_AddRefs(newConsumer));</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineplus">+      if (newConsumer) m_channelListener = newConsumer;</span>
<a href="#l9.765"></a><span id="l9.765">     }</span>
<a href="#l9.766"></a><span id="l9.766">   }</span>
<a href="#l9.767"></a><span id="l9.767"> </span>
<a href="#l9.768"></a><span id="l9.768">   return rv;</span>
<a href="#l9.769"></a><span id="l9.769"> }</span>
<a href="#l9.770"></a><span id="l9.770"> </span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-nsresult nsNNTPProtocol::ReadFromMemCache(nsICacheEntry *entry)</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-{</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+nsresult nsNNTPProtocol::ReadFromMemCache(nsICacheEntry *entry) {</span>
<a href="#l9.774"></a><span id="l9.774">   NS_ENSURE_ARG(entry);</span>
<a href="#l9.775"></a><span id="l9.775"> </span>
<a href="#l9.776"></a><span id="l9.776">   nsCOMPtr&lt;nsIInputStream&gt; cacheStream;</span>
<a href="#l9.777"></a><span id="l9.777">   nsresult rv = entry-&gt;OpenInputStream(0, getter_AddRefs(cacheStream));</span>
<a href="#l9.778"></a><span id="l9.778"> </span>
<a href="#l9.779"></a><span id="l9.779" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineminus">-  {</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.782"></a><span id="l9.782">     nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l9.783"></a><span id="l9.783">     rv = NS_NewInputStreamPump(getter_AddRefs(pump), cacheStream.forget());</span>
<a href="#l9.784"></a><span id="l9.784">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.785"></a><span id="l9.785"> </span>
<a href="#l9.786"></a><span id="l9.786">     nsCString group;</span>
<a href="#l9.787"></a><span id="l9.787">     // do this to get m_key set, so that marking the message read will work.</span>
<a href="#l9.788"></a><span id="l9.788">     rv = ParseURL(m_url, group, m_messageID);</span>
<a href="#l9.789"></a><span id="l9.789"> </span>
<a href="#l9.790"></a><span id="l9.790">     RefPtr&lt;nsNntpCacheStreamListener&gt; cacheListener =</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineminus">-      new nsNntpCacheStreamListener();</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+        new nsNntpCacheStreamListener();</span>
<a href="#l9.793"></a><span id="l9.793"> </span>
<a href="#l9.794"></a><span id="l9.794">     SetLoadGroup(m_loadGroup);</span>
<a href="#l9.795"></a><span id="l9.795">     m_typeWanted = ARTICLE_WANTED;</span>
<a href="#l9.796"></a><span id="l9.796"> </span>
<a href="#l9.797"></a><span id="l9.797">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineminus">-    cacheListener-&gt;Init(m_channelListener, static_cast&lt;nsIChannel *&gt;(this), mailnewsUrl);</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineminus">-</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineminus">-    mContentType = &quot;&quot;; // reset the content type for the upcoming read....</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+    cacheListener-&gt;Init(m_channelListener, static_cast&lt;nsIChannel *&gt;(this),</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineplus">+                        mailnewsUrl);</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineplus">+</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineplus">+    mContentType = &quot;&quot;;  // reset the content type for the upcoming read....</span>
<a href="#l9.805"></a><span id="l9.805"> </span>
<a href="#l9.806"></a><span id="l9.806">     rv = pump-&gt;AsyncRead(cacheListener, m_channelContext);</span>
<a href="#l9.807"></a><span id="l9.807"> </span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-    if (NS_SUCCEEDED(rv)) // ONLY if we succeeded in actually starting the read should we return</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+    if (NS_SUCCEEDED(rv))  // ONLY if we succeeded in actually starting the read</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineplus">+                           // should we return</span>
<a href="#l9.811"></a><span id="l9.811">     {</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineminus">-      // we're not calling nsMsgProtocol::AsyncRead(), which calls nsNNTPProtocol::LoadUrl, so we need to take care of some stuff it does.</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineplus">+      // we're not calling nsMsgProtocol::AsyncRead(), which calls</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineplus">+      // nsNNTPProtocol::LoadUrl, so we need to take care of some stuff it does.</span>
<a href="#l9.815"></a><span id="l9.815">       m_channelListener = nullptr;</span>
<a href="#l9.816"></a><span id="l9.816">       return rv;</span>
<a href="#l9.817"></a><span id="l9.817">     }</span>
<a href="#l9.818"></a><span id="l9.818">   }</span>
<a href="#l9.819"></a><span id="l9.819"> </span>
<a href="#l9.820"></a><span id="l9.820">   return rv;</span>
<a href="#l9.821"></a><span id="l9.821"> }</span>
<a href="#l9.822"></a><span id="l9.822"> </span>
<a href="#l9.823"></a><span id="l9.823" class="difflineminus">-nsresult nsNNTPProtocol::ReadFromNewsConnection()</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineminus">-{</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineplus">+nsresult nsNNTPProtocol::ReadFromNewsConnection() {</span>
<a href="#l9.826"></a><span id="l9.826">   // we might end up here if we thought we had a news message offline</span>
<a href="#l9.827"></a><span id="l9.827">   // but it turned out not to be so. In which case, we need to</span>
<a href="#l9.828"></a><span id="l9.828">   // recall Initialize().</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-  if (!m_socketIsOpen || !m_dataBuf)</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-  {</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineplus">+  if (!m_socketIsOpen || !m_dataBuf) {</span>
<a href="#l9.832"></a><span id="l9.832">     nsresult rv = Initialize(m_url, m_msgWindow);</span>
<a href="#l9.833"></a><span id="l9.833">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.834"></a><span id="l9.834">   }</span>
<a href="#l9.835"></a><span id="l9.835"> </span>
<a href="#l9.836"></a><span id="l9.836" class="difflineminus">-  // XXX TODO: m_channelContext should be passes as URI on the channel. Previously passed as context.</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+  // XXX TODO: m_channelContext should be passes as URI on the channel.</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineplus">+  // Previously passed as context.</span>
<a href="#l9.839"></a><span id="l9.839">   return nsMsgProtocol::AsyncOpen(m_channelListener);</span>
<a href="#l9.840"></a><span id="l9.840"> }</span>
<a href="#l9.841"></a><span id="l9.841"> </span>
<a href="#l9.842"></a><span id="l9.842" class="difflineminus">-// for messages stored in our offline cache, we have special code to handle that...</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineminus">-// If it's in the local cache, we return true and we can abort the download because</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineminus">-// this method does the rest of the work.</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineminus">-bool nsNNTPProtocol::ReadFromLocalCache()</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineminus">-{</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineplus">+// for messages stored in our offline cache, we have special code to handle</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineplus">+// that... If it's in the local cache, we return true and we can abort the</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineplus">+// download because this method does the rest of the work.</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+bool nsNNTPProtocol::ReadFromLocalCache() {</span>
<a href="#l9.851"></a><span id="l9.851">   bool msgIsInLocalCache = false;</span>
<a href="#l9.852"></a><span id="l9.852">   nsresult rv = NS_OK;</span>
<a href="#l9.853"></a><span id="l9.853">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.854"></a><span id="l9.854">   mailnewsUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInLocalCache);</span>
<a href="#l9.855"></a><span id="l9.855"> </span>
<a href="#l9.856"></a><span id="l9.856" class="difflineminus">-  if (msgIsInLocalCache)</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineminus">-  {</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder);</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineminus">-    if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-    {</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineminus">-    // we want to create a file channel and read the msg from there.</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+  if (msgIsInLocalCache) {</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder);</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineplus">+    if (folder &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineplus">+      // we want to create a file channel and read the msg from there.</span>
<a href="#l9.866"></a><span id="l9.866">       nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineminus">-      int64_t offset=0;</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineminus">-      uint32_t size=0;</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineminus">-      rv = folder-&gt;GetOfflineFileStream(m_key, &amp;offset, &amp;size, getter_AddRefs(fileStream));</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+      int64_t offset = 0;</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineplus">+      uint32_t size = 0;</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineplus">+      rv = folder-&gt;GetOfflineFileStream(m_key, &amp;offset, &amp;size,</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineplus">+                                        getter_AddRefs(fileStream));</span>
<a href="#l9.874"></a><span id="l9.874"> </span>
<a href="#l9.875"></a><span id="l9.875">       // get the file stream from the folder, somehow (through the message or</span>
<a href="#l9.876"></a><span id="l9.876" class="difflineminus">-      // folder sink?) We also need to set the transfer offset to the message offset</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineminus">-      if (fileStream &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineminus">-      {</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineminus">-        // dougt - This may break the ablity to &quot;cancel&quot; a read from offline mail reading.</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineminus">-        // fileChannel-&gt;SetLoadGroup(m_loadGroup);</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineplus">+      // folder sink?) We also need to set the transfer offset to the message</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineplus">+      // offset</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineplus">+      if (fileStream &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineplus">+        // dougt - This may break the ablity to &quot;cancel&quot; a read from offline</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+        // mail reading. fileChannel-&gt;SetLoadGroup(m_loadGroup);</span>
<a href="#l9.886"></a><span id="l9.886"> </span>
<a href="#l9.887"></a><span id="l9.887">         m_typeWanted = ARTICLE_WANTED;</span>
<a href="#l9.888"></a><span id="l9.888"> </span>
<a href="#l9.889"></a><span id="l9.889">         RefPtr&lt;nsNntpCacheStreamListener&gt; cacheListener =</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineminus">-          new nsNntpCacheStreamListener();</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineminus">-</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineminus">-        cacheListener-&gt;Init(m_channelListener, static_cast&lt;nsIChannel *&gt;(this), mailnewsUrl);</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineminus">-</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineminus">-        // create a stream pump that will async read the specified amount of data.</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineplus">+            new nsNntpCacheStreamListener();</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineplus">+</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineplus">+        cacheListener-&gt;Init(m_channelListener, static_cast&lt;nsIChannel *&gt;(this),</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineplus">+                            mailnewsUrl);</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineplus">+</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineplus">+        // create a stream pump that will async read the specified amount of</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+        // data.</span>
<a href="#l9.902"></a><span id="l9.902">         // XXX make size 64-bit int</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineminus">-        RefPtr&lt;SlicedInputStream&gt; slicedStream =</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineminus">-          new SlicedInputStream(fileStream.forget(), uint64_t(offset), uint64_t(size));</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineplus">+        RefPtr&lt;SlicedInputStream&gt; slicedStream = new SlicedInputStream(</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineplus">+            fileStream.forget(), uint64_t(offset), uint64_t(size));</span>
<a href="#l9.907"></a><span id="l9.907">         nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l9.908"></a><span id="l9.908">         rv = NS_NewInputStreamPump(getter_AddRefs(pump), slicedStream.forget());</span>
<a href="#l9.909"></a><span id="l9.909">         if (NS_SUCCEEDED(rv))</span>
<a href="#l9.910"></a><span id="l9.910">           rv = pump-&gt;AsyncRead(cacheListener, m_channelContext);</span>
<a href="#l9.911"></a><span id="l9.911"> </span>
<a href="#l9.912"></a><span id="l9.912" class="difflineminus">-        if (NS_SUCCEEDED(rv)) // ONLY if we succeeded in actually starting the read should we return</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+        if (NS_SUCCEEDED(rv))  // ONLY if we succeeded in actually starting the</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineplus">+                               // read should we return</span>
<a href="#l9.915"></a><span id="l9.915">         {</span>
<a href="#l9.916"></a><span id="l9.916">           mContentType.Truncate();</span>
<a href="#l9.917"></a><span id="l9.917">           m_channelListener = nullptr;</span>
<a href="#l9.918"></a><span id="l9.918">           NNTP_LOG_NOTE(&quot;Loading message from offline storage&quot;);</span>
<a href="#l9.919"></a><span id="l9.919">           return true;</span>
<a href="#l9.920"></a><span id="l9.920">         }</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineminus">-      }</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineminus">-      else</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+      } else</span>
<a href="#l9.924"></a><span id="l9.924">         mailnewsUrl-&gt;SetMsgIsInLocalCache(false);</span>
<a href="#l9.925"></a><span id="l9.925">     }</span>
<a href="#l9.926"></a><span id="l9.926">   }</span>
<a href="#l9.927"></a><span id="l9.927"> </span>
<a href="#l9.928"></a><span id="l9.928">   return false;</span>
<a href="#l9.929"></a><span id="l9.929"> }</span>
<a href="#l9.930"></a><span id="l9.930"> </span>
<a href="#l9.931"></a><span id="l9.931"> NS_IMETHODIMP</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineminus">-nsNNTPProtocol::OnCacheEntryAvailable(nsICacheEntry *entry, bool aNew, nsIApplicationCache* aAppCache, nsresult status)</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineminus">-{</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineplus">+nsNNTPProtocol::OnCacheEntryAvailable(nsICacheEntry *entry, bool aNew,</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+                                      nsIApplicationCache *aAppCache,</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+                                      nsresult status) {</span>
<a href="#l9.937"></a><span id="l9.937">   nsresult rv = NS_OK;</span>
<a href="#l9.938"></a><span id="l9.938"> </span>
<a href="#l9.939"></a><span id="l9.939" class="difflineminus">-  if (NS_SUCCEEDED(status))</span>
<a href="#l9.940"></a><span id="l9.940" class="difflineminus">-  {</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineplus">+  if (NS_SUCCEEDED(status)) {</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineplus">+        do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.945"></a><span id="l9.945">     mailnewsUrl-&gt;SetMemCacheEntry(entry);</span>
<a href="#l9.946"></a><span id="l9.946"> </span>
<a href="#l9.947"></a><span id="l9.947">     // Insert a &quot;stream T&quot; into the flow so data gets written to both.</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineminus">-    if (aNew)</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineminus">-    {</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineminus">-      // use a stream listener Tee to force data into the cache and to our current channel listener...</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+    if (aNew) {</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineplus">+      // use a stream listener Tee to force data into the cache and to our</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineplus">+      // current channel listener...</span>
<a href="#l9.954"></a><span id="l9.954">       nsCOMPtr&lt;nsIStreamListener&gt; newListener;</span>
<a href="#l9.955"></a><span id="l9.955" class="difflineminus">-      nsCOMPtr&lt;nsIStreamListenerTee&gt; tee = do_CreateInstance(NS_STREAMLISTENERTEE_CONTRACTID, &amp;rv);</span>
<a href="#l9.956"></a><span id="l9.956" class="difflineplus">+      nsCOMPtr&lt;nsIStreamListenerTee&gt; tee =</span>
<a href="#l9.957"></a><span id="l9.957" class="difflineplus">+          do_CreateInstance(NS_STREAMLISTENERTEE_CONTRACTID, &amp;rv);</span>
<a href="#l9.958"></a><span id="l9.958">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.959"></a><span id="l9.959"> </span>
<a href="#l9.960"></a><span id="l9.960">       nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l9.961"></a><span id="l9.961">       rv = entry-&gt;OpenOutputStream(0, -1, getter_AddRefs(outStream));</span>
<a href="#l9.962"></a><span id="l9.962">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.963"></a><span id="l9.963"> </span>
<a href="#l9.964"></a><span id="l9.964">       rv = tee-&gt;Init(m_channelListener, outStream, nullptr);</span>
<a href="#l9.965"></a><span id="l9.965">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.966"></a><span id="l9.966">       m_channelListener = tee;</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineminus">-    }</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineminus">-    else</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineminus">-    {</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineplus">+    } else {</span>
<a href="#l9.971"></a><span id="l9.971">       rv = ReadFromMemCache(entry);</span>
<a href="#l9.972"></a><span id="l9.972">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.973"></a><span id="l9.973">         entry-&gt;MarkValid();</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineminus">-        return NS_OK; // kick out if reading from the cache succeeded...</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+        return NS_OK;  // kick out if reading from the cache succeeded...</span>
<a href="#l9.976"></a><span id="l9.976">       }</span>
<a href="#l9.977"></a><span id="l9.977">     }</span>
<a href="#l9.978"></a><span id="l9.978" class="difflineminus">-  } // if we got a valid entry back from the cache...</span>
<a href="#l9.979"></a><span id="l9.979" class="difflineminus">-</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineminus">-  // if reading from the cache failed or if we are writing into the cache, default to ReadFromNewsConnection.</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineplus">+  }  // if we got a valid entry back from the cache...</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineplus">+</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineplus">+  // if reading from the cache failed or if we are writing into the cache,</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineplus">+  // default to ReadFromNewsConnection.</span>
<a href="#l9.985"></a><span id="l9.985">   return ReadFromNewsConnection();</span>
<a href="#l9.986"></a><span id="l9.986"> }</span>
<a href="#l9.987"></a><span id="l9.987"> </span>
<a href="#l9.988"></a><span id="l9.988"> NS_IMETHODIMP</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineminus">-nsNNTPProtocol::OnCacheEntryCheck(nsICacheEntry* entry, nsIApplicationCache* appCache,</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineminus">-                                  uint32_t* aResult)</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineminus">-{</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+nsNNTPProtocol::OnCacheEntryCheck(nsICacheEntry *entry,</span>
<a href="#l9.993"></a><span id="l9.993" class="difflineplus">+                                  nsIApplicationCache *appCache,</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineplus">+                                  uint32_t *aResult) {</span>
<a href="#l9.995"></a><span id="l9.995">   *aResult = nsICacheEntryOpenCallback::ENTRY_WANTED;</span>
<a href="#l9.996"></a><span id="l9.996">   return NS_OK;</span>
<a href="#l9.997"></a><span id="l9.997"> }</span>
<a href="#l9.998"></a><span id="l9.998"> </span>
<a href="#l9.999"></a><span id="l9.999" class="difflineminus">-nsresult nsNNTPProtocol::OpenCacheEntry()</span>
<a href="#l9.1000"></a><span id="l9.1000" class="difflineminus">-{</span>
<a href="#l9.1001"></a><span id="l9.1001" class="difflineplus">+nsresult nsNNTPProtocol::OpenCacheEntry() {</span>
<a href="#l9.1002"></a><span id="l9.1002">   nsresult rv = NS_OK;</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineplus">+      do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.1006"></a><span id="l9.1006">   // get the cache session from our nntp service...</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineminus">-  nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l9.1009"></a><span id="l9.1009" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.1010"></a><span id="l9.1010">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1011"></a><span id="l9.1011"> </span>
<a href="#l9.1012"></a><span id="l9.1012">   nsCOMPtr&lt;nsICacheStorage&gt; cacheStorage;</span>
<a href="#l9.1013"></a><span id="l9.1013">   rv = nntpService-&gt;GetCacheStorage(getter_AddRefs(cacheStorage));</span>
<a href="#l9.1014"></a><span id="l9.1014">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1015"></a><span id="l9.1015"> </span>
<a href="#l9.1016"></a><span id="l9.1016">   // Open a cache entry with key = url, no extension.</span>
<a href="#l9.1017"></a><span id="l9.1017">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l9.1018"></a><span id="l9.1018" class="difflineat">@@ -822,312 +798,276 @@ nsresult nsNNTPProtocol::OpenCacheEntry(</span>
<a href="#l9.1019"></a><span id="l9.1019">     path.SetLength(pos);</span>
<a href="#l9.1020"></a><span id="l9.1020">     rv = NS_MutateURI(uri).SetPathQueryRef(path).Finalize(newUri);</span>
<a href="#l9.1021"></a><span id="l9.1021">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1022"></a><span id="l9.1022">   }</span>
<a href="#l9.1023"></a><span id="l9.1023">   return cacheStorage-&gt;AsyncOpenURI(newUri ? newUri : uri, EmptyCString(),</span>
<a href="#l9.1024"></a><span id="l9.1024">                                     nsICacheStorage::OPEN_NORMALLY, this);</span>
<a href="#l9.1025"></a><span id="l9.1025"> }</span>
<a href="#l9.1026"></a><span id="l9.1026"> </span>
<a href="#l9.1027"></a><span id="l9.1027" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::AsyncOpen(nsIStreamListener *aListener)</span>
<a href="#l9.1028"></a><span id="l9.1028" class="difflineminus">-{</span>
<a href="#l9.1029"></a><span id="l9.1029" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::AsyncOpen(nsIStreamListener *aListener) {</span>
<a href="#l9.1030"></a><span id="l9.1030">   nsCOMPtr&lt;nsIStreamListener&gt; listener = aListener;</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineminus">-  nsresult rv = nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineplus">+  nsresult rv =</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineplus">+      nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l9.1034"></a><span id="l9.1034">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1035"></a><span id="l9.1035"> </span>
<a href="#l9.1036"></a><span id="l9.1036" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.1037"></a><span id="l9.1037" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1038"></a><span id="l9.1038" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l9.1039"></a><span id="l9.1039" class="difflineplus">+      do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1041"></a><span id="l9.1041"> </span>
<a href="#l9.1042"></a><span id="l9.1042">   int32_t port;</span>
<a href="#l9.1043"></a><span id="l9.1043">   rv = mailnewsUrl-&gt;GetPort(&amp;port);</span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineminus">-      return rv;</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.1047"></a><span id="l9.1047"> </span>
<a href="#l9.1048"></a><span id="l9.1048">   rv = NS_CheckPortSafety(port, &quot;news&quot;);</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.1050"></a><span id="l9.1050" class="difflineminus">-      return rv;</span>
<a href="#l9.1051"></a><span id="l9.1051" class="difflineminus">-</span>
<a href="#l9.1052"></a><span id="l9.1052" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l9.1053"></a><span id="l9.1053" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.1054"></a><span id="l9.1054" class="difflineplus">+</span>
<a href="#l9.1055"></a><span id="l9.1055" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l9.1056"></a><span id="l9.1056">   GetURI(getter_AddRefs(uri));</span>
<a href="#l9.1057"></a><span id="l9.1057">   m_channelContext = uri;</span>
<a href="#l9.1058"></a><span id="l9.1058">   m_channelListener = listener;</span>
<a href="#l9.1059"></a><span id="l9.1059">   m_runningURL-&gt;GetNewsAction(&amp;m_newsAction);</span>
<a href="#l9.1060"></a><span id="l9.1060"> </span>
<a href="#l9.1061"></a><span id="l9.1061">   // Before running through the connection, try to see if we can grab the data</span>
<a href="#l9.1062"></a><span id="l9.1062">   // from the offline storage or the memory cache. Only actions retrieving</span>
<a href="#l9.1063"></a><span id="l9.1063">   // messages can be cached.</span>
<a href="#l9.1064"></a><span id="l9.1064">   if (mailnewsUrl &amp;&amp; (m_newsAction == nsINntpUrl::ActionFetchArticle ||</span>
<a href="#l9.1065"></a><span id="l9.1065">                       m_newsAction == nsINntpUrl::ActionFetchPart ||</span>
<a href="#l9.1066"></a><span id="l9.1066" class="difflineminus">-                      m_newsAction == nsINntpUrl::ActionSaveMessageToDisk))</span>
<a href="#l9.1067"></a><span id="l9.1067" class="difflineminus">-  {</span>
<a href="#l9.1068"></a><span id="l9.1068" class="difflineplus">+                      m_newsAction == nsINntpUrl::ActionSaveMessageToDisk)) {</span>
<a href="#l9.1069"></a><span id="l9.1069">     SetupPartExtractorListener(m_channelListener);</span>
<a href="#l9.1070"></a><span id="l9.1070"> </span>
<a href="#l9.1071"></a><span id="l9.1071">     // Attempt to get the message from the offline storage cache. If this</span>
<a href="#l9.1072"></a><span id="l9.1072">     // succeeds, we don't need to use our connection, so tell the server that we</span>
<a href="#l9.1073"></a><span id="l9.1073">     // are ready for the next URL.</span>
<a href="#l9.1074"></a><span id="l9.1074" class="difflineminus">-    if (ReadFromLocalCache())</span>
<a href="#l9.1075"></a><span id="l9.1075" class="difflineminus">-    {</span>
<a href="#l9.1076"></a><span id="l9.1076" class="difflineminus">-      if (m_nntpServer)</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineminus">-        m_nntpServer-&gt;PrepareForNextUrl(this);</span>
<a href="#l9.1078"></a><span id="l9.1078" class="difflineplus">+    if (ReadFromLocalCache()) {</span>
<a href="#l9.1079"></a><span id="l9.1079" class="difflineplus">+      if (m_nntpServer) m_nntpServer-&gt;PrepareForNextUrl(this);</span>
<a href="#l9.1080"></a><span id="l9.1080">       return NS_OK;</span>
<a href="#l9.1081"></a><span id="l9.1081">     }</span>
<a href="#l9.1082"></a><span id="l9.1082"> </span>
<a href="#l9.1083"></a><span id="l9.1083">     // If it wasn't offline, try to get the cache from memory. If this call</span>
<a href="#l9.1084"></a><span id="l9.1084">     // succeeds, we probably won't need the connection, but the cache might fail</span>
<a href="#l9.1085"></a><span id="l9.1085">     // later on. The code there will determine if we need to fallback and will</span>
<a href="#l9.1086"></a><span id="l9.1086">     // handle informing the server of our readiness.</span>
<a href="#l9.1087"></a><span id="l9.1087" class="difflineminus">-    if (NS_SUCCEEDED(OpenCacheEntry()))</span>
<a href="#l9.1088"></a><span id="l9.1088" class="difflineminus">-      return NS_OK;</span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineplus">+    if (NS_SUCCEEDED(OpenCacheEntry())) return NS_OK;</span>
<a href="#l9.1090"></a><span id="l9.1090">   }</span>
<a href="#l9.1091"></a><span id="l9.1091"> </span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineminus">-  return nsMsgProtocol::AsyncOpen(listener);  // Context already attached to the channel.</span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+  return nsMsgProtocol::AsyncOpen(</span>
<a href="#l9.1094"></a><span id="l9.1094" class="difflineplus">+      listener);  // Context already attached to the channel.</span>
<a href="#l9.1095"></a><span id="l9.1095"> }</span>
<a href="#l9.1096"></a><span id="l9.1096"> </span>
<a href="#l9.1097"></a><span id="l9.1097" class="difflineminus">-void nsNNTPProtocol::PostLoadAssertions()</span>
<a href="#l9.1098"></a><span id="l9.1098" class="difflineminus">-{</span>
<a href="#l9.1099"></a><span id="l9.1099" class="difflineminus">-</span>
<a href="#l9.1100"></a><span id="l9.1100" class="difflineplus">+void nsNNTPProtocol::PostLoadAssertions() {</span>
<a href="#l9.1101"></a><span id="l9.1101">   // Make sure that we have the information we need to be able to run the</span>
<a href="#l9.1102"></a><span id="l9.1102">   // URLs</span>
<a href="#l9.1103"></a><span id="l9.1103">   NS_ASSERTION(m_nntpServer, &quot;Parsing must result in an m_nntpServer&quot;);</span>
<a href="#l9.1104"></a><span id="l9.1104" class="difflineminus">-  if (m_typeWanted == ARTICLE_WANTED)</span>
<a href="#l9.1105"></a><span id="l9.1105" class="difflineminus">-  {</span>
<a href="#l9.1106"></a><span id="l9.1106" class="difflineplus">+  if (m_typeWanted == ARTICLE_WANTED) {</span>
<a href="#l9.1107"></a><span id="l9.1107">     if (m_key != nsMsgKey_None)</span>
<a href="#l9.1108"></a><span id="l9.1108">       NS_ASSERTION(m_newsFolder, &quot;ARTICLE_WANTED needs m_newsFolder w/ key&quot;);</span>
<a href="#l9.1109"></a><span id="l9.1109">     else</span>
<a href="#l9.1110"></a><span id="l9.1110" class="difflineminus">-      NS_ASSERTION(!m_messageID.IsEmpty(), &quot;ARTICLE_WANTED needs m_messageID w/o key&quot;);</span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineminus">-  }</span>
<a href="#l9.1112"></a><span id="l9.1112" class="difflineminus">-  else if (m_typeWanted == CANCEL_WANTED)</span>
<a href="#l9.1113"></a><span id="l9.1113" class="difflineminus">-  {</span>
<a href="#l9.1114"></a><span id="l9.1114" class="difflineplus">+      NS_ASSERTION(!m_messageID.IsEmpty(),</span>
<a href="#l9.1115"></a><span id="l9.1115" class="difflineplus">+                   &quot;ARTICLE_WANTED needs m_messageID w/o key&quot;);</span>
<a href="#l9.1116"></a><span id="l9.1116" class="difflineplus">+  } else if (m_typeWanted == CANCEL_WANTED) {</span>
<a href="#l9.1117"></a><span id="l9.1117">     NS_ASSERTION(!m_messageID.IsEmpty(), &quot;CANCEL_WANTED needs m_messageID&quot;);</span>
<a href="#l9.1118"></a><span id="l9.1118">     NS_ASSERTION(m_newsFolder, &quot;CANCEL_WANTED needs m_newsFolder&quot;);</span>
<a href="#l9.1119"></a><span id="l9.1119">     NS_ASSERTION(m_key != nsMsgKey_None, &quot;CANCEL_WANTED needs m_key&quot;);</span>
<a href="#l9.1120"></a><span id="l9.1120" class="difflineminus">-  }</span>
<a href="#l9.1121"></a><span id="l9.1121" class="difflineminus">-  else if (m_typeWanted == GROUP_WANTED)</span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineplus">+  } else if (m_typeWanted == GROUP_WANTED)</span>
<a href="#l9.1123"></a><span id="l9.1123">     NS_ASSERTION(m_newsFolder, &quot;GROUP_WANTED needs m_newsFolder&quot;);</span>
<a href="#l9.1124"></a><span id="l9.1124">   else if (m_typeWanted == SEARCH_WANTED)</span>
<a href="#l9.1125"></a><span id="l9.1125">     NS_ASSERTION(!m_searchData.IsEmpty(), &quot;SEARCH_WANTED needs m_searchData&quot;);</span>
<a href="#l9.1126"></a><span id="l9.1126">   else if (m_typeWanted == IDS_WANTED)</span>
<a href="#l9.1127"></a><span id="l9.1127">     NS_ASSERTION(m_newsFolder, &quot;IDS_WANTED needs m_newsFolder&quot;);</span>
<a href="#l9.1128"></a><span id="l9.1128"> }</span>
<a href="#l9.1129"></a><span id="l9.1129"> </span>
<a href="#l9.1130"></a><span id="l9.1130" class="difflineminus">-nsresult nsNNTPProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer)</span>
<a href="#l9.1131"></a><span id="l9.1131" class="difflineminus">-{</span>
<a href="#l9.1132"></a><span id="l9.1132" class="difflineplus">+nsresult nsNNTPProtocol::LoadUrl(nsIURI *aURL, nsISupports *aConsumer) {</span>
<a href="#l9.1133"></a><span id="l9.1133">   NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l9.1134"></a><span id="l9.1134"> </span>
<a href="#l9.1135"></a><span id="l9.1135">   nsCString group;</span>
<a href="#l9.1136"></a><span id="l9.1136">   mContentType.Truncate();</span>
<a href="#l9.1137"></a><span id="l9.1137">   nsresult rv = NS_OK;</span>
<a href="#l9.1138"></a><span id="l9.1138"> </span>
<a href="#l9.1139"></a><span id="l9.1139">   m_runningURL = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l9.1140"></a><span id="l9.1140">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.1141"></a><span id="l9.1141">   m_runningURL-&gt;GetNewsAction(&amp;m_newsAction);</span>
<a href="#l9.1142"></a><span id="l9.1142"> </span>
<a href="#l9.1143"></a><span id="l9.1143">   SetIsBusy(true);</span>
<a href="#l9.1144"></a><span id="l9.1144"> </span>
<a href="#l9.1145"></a><span id="l9.1145">   rv = ParseURL(aURL, group, m_messageID);</span>
<a href="#l9.1146"></a><span id="l9.1146" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to parse news url&quot;);</span>
<a href="#l9.1147"></a><span id="l9.1147" class="difflineminus">-  //if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to parse news url&quot;);</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineplus">+  // if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.1150"></a><span id="l9.1150">   // XXX group returned from ParseURL is assumed to be in UTF-8</span>
<a href="#l9.1151"></a><span id="l9.1151">   NS_ASSERTION(MsgIsUTF8(group), &quot;newsgroup name is not in UTF-8&quot;);</span>
<a href="#l9.1152"></a><span id="l9.1152">   NS_ASSERTION(m_nntpServer, &quot;Parsing must result in an m_nntpServer&quot;);</span>
<a href="#l9.1153"></a><span id="l9.1153"> </span>
<a href="#l9.1154"></a><span id="l9.1154" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) m_messageID = %s&quot;, this, m_messageID.get()));</span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) group = %s&quot;, this, group.get()));</span>
<a href="#l9.1156"></a><span id="l9.1156" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) m_key = %d&quot;,this,m_key));</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.1158"></a><span id="l9.1158" class="difflineplus">+          (&quot;(%p) m_messageID = %s&quot;, this, m_messageID.get()));</span>
<a href="#l9.1159"></a><span id="l9.1159" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) group = %s&quot;, this, group.get()));</span>
<a href="#l9.1160"></a><span id="l9.1160" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) m_key = %d&quot;, this, m_key));</span>
<a href="#l9.1161"></a><span id="l9.1161"> </span>
<a href="#l9.1162"></a><span id="l9.1162">   if (m_newsAction == nsINntpUrl::ActionFetchArticle ||</span>
<a href="#l9.1163"></a><span id="l9.1163">       m_newsAction == nsINntpUrl::ActionFetchPart ||</span>
<a href="#l9.1164"></a><span id="l9.1164">       m_newsAction == nsINntpUrl::ActionSaveMessageToDisk)</span>
<a href="#l9.1165"></a><span id="l9.1165">     m_typeWanted = ARTICLE_WANTED;</span>
<a href="#l9.1166"></a><span id="l9.1166">   else if (m_newsAction == nsINntpUrl::ActionCancelArticle)</span>
<a href="#l9.1167"></a><span id="l9.1167">     m_typeWanted = CANCEL_WANTED;</span>
<a href="#l9.1168"></a><span id="l9.1168" class="difflineminus">-  else if (m_newsAction == nsINntpUrl::ActionPostArticle)</span>
<a href="#l9.1169"></a><span id="l9.1169" class="difflineminus">-  {</span>
<a href="#l9.1170"></a><span id="l9.1170" class="difflineplus">+  else if (m_newsAction == nsINntpUrl::ActionPostArticle) {</span>
<a href="#l9.1171"></a><span id="l9.1171">     m_typeWanted = NEWS_POST;</span>
<a href="#l9.1172"></a><span id="l9.1172">     m_messageID = &quot;&quot;;</span>
<a href="#l9.1173"></a><span id="l9.1173" class="difflineminus">-  }</span>
<a href="#l9.1174"></a><span id="l9.1174" class="difflineminus">-  else if (m_newsAction == nsINntpUrl::ActionListIds)</span>
<a href="#l9.1175"></a><span id="l9.1175" class="difflineminus">-  {</span>
<a href="#l9.1176"></a><span id="l9.1176" class="difflineplus">+  } else if (m_newsAction == nsINntpUrl::ActionListIds) {</span>
<a href="#l9.1177"></a><span id="l9.1177">     m_typeWanted = IDS_WANTED;</span>
<a href="#l9.1178"></a><span id="l9.1178">     rv = m_nntpServer-&gt;FindGroup(group, getter_AddRefs(m_newsFolder));</span>
<a href="#l9.1179"></a><span id="l9.1179" class="difflineminus">-  }</span>
<a href="#l9.1180"></a><span id="l9.1180" class="difflineminus">-  else if (m_newsAction == nsINntpUrl::ActionSearch)</span>
<a href="#l9.1181"></a><span id="l9.1181" class="difflineminus">-  {</span>
<a href="#l9.1182"></a><span id="l9.1182" class="difflineplus">+  } else if (m_newsAction == nsINntpUrl::ActionSearch) {</span>
<a href="#l9.1183"></a><span id="l9.1183">     m_typeWanted = SEARCH_WANTED;</span>
<a href="#l9.1184"></a><span id="l9.1184"> </span>
<a href="#l9.1185"></a><span id="l9.1185">     // Get the search data</span>
<a href="#l9.1186"></a><span id="l9.1186">     nsCString commandSpecificData;</span>
<a href="#l9.1187"></a><span id="l9.1187">     nsCOMPtr&lt;nsIURL&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l9.1188"></a><span id="l9.1188">     rv = url-&gt;GetQuery(commandSpecificData);</span>
<a href="#l9.1189"></a><span id="l9.1189">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1190"></a><span id="l9.1190">     MsgUnescapeString(commandSpecificData, 0, m_searchData);</span>
<a href="#l9.1191"></a><span id="l9.1191"> </span>
<a href="#l9.1192"></a><span id="l9.1192">     rv = m_nntpServer-&gt;FindGroup(group, getter_AddRefs(m_newsFolder));</span>
<a href="#l9.1193"></a><span id="l9.1193" class="difflineminus">-    if (!m_newsFolder)</span>
<a href="#l9.1194"></a><span id="l9.1194" class="difflineminus">-      goto FAIL;</span>
<a href="#l9.1195"></a><span id="l9.1195" class="difflineminus">-  }</span>
<a href="#l9.1196"></a><span id="l9.1196" class="difflineminus">-  else if (m_newsAction == nsINntpUrl::ActionGetNewNews)</span>
<a href="#l9.1197"></a><span id="l9.1197" class="difflineminus">-  {</span>
<a href="#l9.1198"></a><span id="l9.1198" class="difflineplus">+    if (!m_newsFolder) goto FAIL;</span>
<a href="#l9.1199"></a><span id="l9.1199" class="difflineplus">+  } else if (m_newsAction == nsINntpUrl::ActionGetNewNews) {</span>
<a href="#l9.1200"></a><span id="l9.1200">     bool containsGroup = true;</span>
<a href="#l9.1201"></a><span id="l9.1201">     rv = m_nntpServer-&gt;ContainsNewsgroup(group, &amp;containsGroup);</span>
<a href="#l9.1202"></a><span id="l9.1202" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.1203"></a><span id="l9.1203" class="difflineminus">-      goto FAIL;</span>
<a href="#l9.1204"></a><span id="l9.1204" class="difflineminus">-</span>
<a href="#l9.1205"></a><span id="l9.1205" class="difflineminus">-    if (!containsGroup)</span>
<a href="#l9.1206"></a><span id="l9.1206" class="difflineminus">-    {</span>
<a href="#l9.1207"></a><span id="l9.1207" class="difflineplus">+    if (NS_FAILED(rv)) goto FAIL;</span>
<a href="#l9.1208"></a><span id="l9.1208" class="difflineplus">+</span>
<a href="#l9.1209"></a><span id="l9.1209" class="difflineplus">+    if (!containsGroup) {</span>
<a href="#l9.1210"></a><span id="l9.1210">       // We have the name of a newsgroup which we're not subscribed to,</span>
<a href="#l9.1211"></a><span id="l9.1211">       // the next step is to ask the user whether we should subscribe to it.</span>
<a href="#l9.1212"></a><span id="l9.1212">       nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l9.1213"></a><span id="l9.1213"> </span>
<a href="#l9.1214"></a><span id="l9.1214" class="difflineminus">-      if (m_msgWindow)</span>
<a href="#l9.1215"></a><span id="l9.1215" class="difflineminus">-        m_msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l9.1216"></a><span id="l9.1216" class="difflineminus">-</span>
<a href="#l9.1217"></a><span id="l9.1217" class="difflineminus">-      if (!dialog)</span>
<a href="#l9.1218"></a><span id="l9.1218" class="difflineminus">-      {</span>
<a href="#l9.1219"></a><span id="l9.1219" class="difflineminus">-         nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l9.1220"></a><span id="l9.1220" class="difflineminus">-         wwatch-&gt;GetNewPrompter(nullptr, getter_AddRefs(dialog));</span>
<a href="#l9.1221"></a><span id="l9.1221" class="difflineplus">+      if (m_msgWindow) m_msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineplus">+</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineplus">+      if (!dialog) {</span>
<a href="#l9.1224"></a><span id="l9.1224" class="difflineplus">+        nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l9.1225"></a><span id="l9.1225" class="difflineplus">+            do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l9.1226"></a><span id="l9.1226" class="difflineplus">+        wwatch-&gt;GetNewPrompter(nullptr, getter_AddRefs(dialog));</span>
<a href="#l9.1227"></a><span id="l9.1227">       }</span>
<a href="#l9.1228"></a><span id="l9.1228"> </span>
<a href="#l9.1229"></a><span id="l9.1229">       nsString statusString, confirmText;</span>
<a href="#l9.1230"></a><span id="l9.1230">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l9.1231"></a><span id="l9.1231">       nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l9.1232"></a><span id="l9.1232" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l9.1233"></a><span id="l9.1233" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l9.1234"></a><span id="l9.1234"> </span>
<a href="#l9.1235"></a><span id="l9.1235">       // to handle non-ASCII newsgroup names, we store them internally</span>
<a href="#l9.1236"></a><span id="l9.1236">       // as escaped. decode and unescape the newsgroup name so we'll</span>
<a href="#l9.1237"></a><span id="l9.1237">       // display a proper name.</span>
<a href="#l9.1238"></a><span id="l9.1238"> </span>
<a href="#l9.1239"></a><span id="l9.1239">       nsAutoString unescapedName;</span>
<a href="#l9.1240"></a><span id="l9.1240">       rv = NS_MsgDecodeUnescapeURLPath(group, unescapedName);</span>
<a href="#l9.1241"></a><span id="l9.1241" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1242"></a><span id="l9.1242" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1243"></a><span id="l9.1243"> </span>
<a href="#l9.1244"></a><span id="l9.1244">       bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l9.1245"></a><span id="l9.1245" class="difflineminus">-      const char16_t *formatStrings[1] = { unescapedName.get() };</span>
<a href="#l9.1246"></a><span id="l9.1246" class="difflineminus">-</span>
<a href="#l9.1247"></a><span id="l9.1247" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l9.1248"></a><span id="l9.1248" class="difflineminus">-        &quot;autoSubscribeText&quot;, formatStrings, 1,</span>
<a href="#l9.1249"></a><span id="l9.1249" class="difflineminus">-        confirmText);</span>
<a href="#l9.1250"></a><span id="l9.1250" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1251"></a><span id="l9.1251" class="difflineplus">+      const char16_t *formatStrings[1] = {unescapedName.get()};</span>
<a href="#l9.1252"></a><span id="l9.1252" class="difflineplus">+</span>
<a href="#l9.1253"></a><span id="l9.1253" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;autoSubscribeText&quot;, formatStrings, 1,</span>
<a href="#l9.1254"></a><span id="l9.1254" class="difflineplus">+                                        confirmText);</span>
<a href="#l9.1255"></a><span id="l9.1255" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1256"></a><span id="l9.1256"> </span>
<a href="#l9.1257"></a><span id="l9.1257">       bool confirmResult = false;</span>
<a href="#l9.1258"></a><span id="l9.1258">       rv = dialog-&gt;Confirm(nullptr, confirmText.get(), &amp;confirmResult);</span>
<a href="#l9.1259"></a><span id="l9.1259">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1260"></a><span id="l9.1260"> </span>
<a href="#l9.1261"></a><span id="l9.1261" class="difflineminus">-      if (confirmResult)</span>
<a href="#l9.1262"></a><span id="l9.1262" class="difflineminus">-      {</span>
<a href="#l9.1263"></a><span id="l9.1263" class="difflineminus">-         rv = m_nntpServer-&gt;SubscribeToNewsgroup(group);</span>
<a href="#l9.1264"></a><span id="l9.1264" class="difflineminus">-         containsGroup = true;</span>
<a href="#l9.1265"></a><span id="l9.1265" class="difflineminus">-      }</span>
<a href="#l9.1266"></a><span id="l9.1266" class="difflineminus">-      else</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineminus">-      {</span>
<a href="#l9.1268"></a><span id="l9.1268" class="difflineplus">+      if (confirmResult) {</span>
<a href="#l9.1269"></a><span id="l9.1269" class="difflineplus">+        rv = m_nntpServer-&gt;SubscribeToNewsgroup(group);</span>
<a href="#l9.1270"></a><span id="l9.1270" class="difflineplus">+        containsGroup = true;</span>
<a href="#l9.1271"></a><span id="l9.1271" class="difflineplus">+      } else {</span>
<a href="#l9.1272"></a><span id="l9.1272">         // XXX FIX ME</span>
<a href="#l9.1273"></a><span id="l9.1273">         // the way news is current written, we've already opened the socket</span>
<a href="#l9.1274"></a><span id="l9.1274">         // and initialized the connection.</span>
<a href="#l9.1275"></a><span id="l9.1275">         //</span>
<a href="#l9.1276"></a><span id="l9.1276" class="difflineminus">-        // until that is fixed, when the user cancels an autosubscribe, we've got to close it and clean up after ourselves</span>
<a href="#l9.1277"></a><span id="l9.1277" class="difflineplus">+        // until that is fixed, when the user cancels an autosubscribe, we've</span>
<a href="#l9.1278"></a><span id="l9.1278" class="difflineplus">+        // got to close it and clean up after ourselves</span>
<a href="#l9.1279"></a><span id="l9.1279">         //</span>
<a href="#l9.1280"></a><span id="l9.1280">         // see bug http://bugzilla.mozilla.org/show_bug.cgi?id=108293</span>
<a href="#l9.1281"></a><span id="l9.1281">         // another problem, autosubscribe urls are ending up as cache entries</span>
<a href="#l9.1282"></a><span id="l9.1282">         // because the default action on nntp urls is ActionFetchArticle</span>
<a href="#l9.1283"></a><span id="l9.1283">         //</span>
<a href="#l9.1284"></a><span id="l9.1284">         // see bug http://bugzilla.mozilla.org/show_bug.cgi?id=108294</span>
<a href="#l9.1285"></a><span id="l9.1285">         if (m_runningURL)</span>
<a href="#l9.1286"></a><span id="l9.1286" class="difflineminus">-          FinishMemCacheEntry(false); // cleanup mem cache entry</span>
<a href="#l9.1287"></a><span id="l9.1287" class="difflineplus">+          FinishMemCacheEntry(false);  // cleanup mem cache entry</span>
<a href="#l9.1288"></a><span id="l9.1288"> </span>
<a href="#l9.1289"></a><span id="l9.1289">         return CloseConnection();</span>
<a href="#l9.1290"></a><span id="l9.1290">       }</span>
<a href="#l9.1291"></a><span id="l9.1291">     }</span>
<a href="#l9.1292"></a><span id="l9.1292"> </span>
<a href="#l9.1293"></a><span id="l9.1293" class="difflineminus">-    // If we have a group (since before, or just subscribed), set the m_newsFolder.</span>
<a href="#l9.1294"></a><span id="l9.1294" class="difflineminus">-    if (containsGroup)</span>
<a href="#l9.1295"></a><span id="l9.1295" class="difflineminus">-    {</span>
<a href="#l9.1296"></a><span id="l9.1296" class="difflineplus">+    // If we have a group (since before, or just subscribed), set the</span>
<a href="#l9.1297"></a><span id="l9.1297" class="difflineplus">+    // m_newsFolder.</span>
<a href="#l9.1298"></a><span id="l9.1298" class="difflineplus">+    if (containsGroup) {</span>
<a href="#l9.1299"></a><span id="l9.1299">       rv = m_nntpServer-&gt;FindGroup(group, getter_AddRefs(m_newsFolder));</span>
<a href="#l9.1300"></a><span id="l9.1300" class="difflineminus">-      if (!m_newsFolder)</span>
<a href="#l9.1301"></a><span id="l9.1301" class="difflineminus">-        goto FAIL;</span>
<a href="#l9.1302"></a><span id="l9.1302" class="difflineplus">+      if (!m_newsFolder) goto FAIL;</span>
<a href="#l9.1303"></a><span id="l9.1303">     }</span>
<a href="#l9.1304"></a><span id="l9.1304">     m_typeWanted = GROUP_WANTED;</span>
<a href="#l9.1305"></a><span id="l9.1305" class="difflineminus">-  }</span>
<a href="#l9.1306"></a><span id="l9.1306" class="difflineminus">-  else if (m_newsAction == nsINntpUrl::ActionListGroups)</span>
<a href="#l9.1307"></a><span id="l9.1307" class="difflineplus">+  } else if (m_newsAction == nsINntpUrl::ActionListGroups)</span>
<a href="#l9.1308"></a><span id="l9.1308">     m_typeWanted = LIST_WANTED;</span>
<a href="#l9.1309"></a><span id="l9.1309">   else if (m_newsAction == nsINntpUrl::ActionListNewGroups)</span>
<a href="#l9.1310"></a><span id="l9.1310">     m_typeWanted = NEW_GROUPS;</span>
<a href="#l9.1311"></a><span id="l9.1311">   else if (!m_messageID.IsEmpty() || m_key != nsMsgKey_None)</span>
<a href="#l9.1312"></a><span id="l9.1312">     m_typeWanted = ARTICLE_WANTED;</span>
<a href="#l9.1313"></a><span id="l9.1313" class="difflineminus">-  else</span>
<a href="#l9.1314"></a><span id="l9.1314" class="difflineminus">-  {</span>
<a href="#l9.1315"></a><span id="l9.1315" class="difflineplus">+  else {</span>
<a href="#l9.1316"></a><span id="l9.1316">     MOZ_ASSERT_UNREACHABLE(&quot;Unknown news action&quot;);</span>
<a href="#l9.1317"></a><span id="l9.1317">     rv = NS_ERROR_FAILURE;</span>
<a href="#l9.1318"></a><span id="l9.1318">   }</span>
<a href="#l9.1319"></a><span id="l9.1319"> </span>
<a href="#l9.1320"></a><span id="l9.1320" class="difflineminus">-    // if this connection comes from the cache, we need to initialize the</span>
<a href="#l9.1321"></a><span id="l9.1321" class="difflineminus">-    // load group here, by generating the start request notification. nsMsgProtocol::OnStartRequest</span>
<a href="#l9.1322"></a><span id="l9.1322" class="difflineminus">-    // ignores the first parameter (which is supposed to be the channel) so we'll pass in null.</span>
<a href="#l9.1323"></a><span id="l9.1323" class="difflineminus">-    if (m_fromCache)</span>
<a href="#l9.1324"></a><span id="l9.1324" class="difflineminus">-      nsMsgProtocol::OnStartRequest(nullptr);</span>
<a href="#l9.1325"></a><span id="l9.1325" class="difflineminus">-</span>
<a href="#l9.1326"></a><span id="l9.1326" class="difflineminus">-      /* At this point, we're all done parsing the URL, and know exactly</span>
<a href="#l9.1327"></a><span id="l9.1327" class="difflineminus">-      what we want to do with it.</span>
<a href="#l9.1328"></a><span id="l9.1328" class="difflineminus">-    */</span>
<a href="#l9.1329"></a><span id="l9.1329" class="difflineplus">+  // if this connection comes from the cache, we need to initialize the</span>
<a href="#l9.1330"></a><span id="l9.1330" class="difflineplus">+  // load group here, by generating the start request notification.</span>
<a href="#l9.1331"></a><span id="l9.1331" class="difflineplus">+  // nsMsgProtocol::OnStartRequest ignores the first parameter (which is</span>
<a href="#l9.1332"></a><span id="l9.1332" class="difflineplus">+  // supposed to be the channel) so we'll pass in null.</span>
<a href="#l9.1333"></a><span id="l9.1333" class="difflineplus">+  if (m_fromCache) nsMsgProtocol::OnStartRequest(nullptr);</span>
<a href="#l9.1334"></a><span id="l9.1334" class="difflineplus">+</span>
<a href="#l9.1335"></a><span id="l9.1335" class="difflineplus">+  /* At this point, we're all done parsing the URL, and know exactly</span>
<a href="#l9.1336"></a><span id="l9.1336" class="difflineplus">+  what we want to do with it.</span>
<a href="#l9.1337"></a><span id="l9.1337" class="difflineplus">+*/</span>
<a href="#l9.1338"></a><span id="l9.1338"> </span>
<a href="#l9.1339"></a><span id="l9.1339"> FAIL:</span>
<a href="#l9.1340"></a><span id="l9.1340" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.1341"></a><span id="l9.1341" class="difflineminus">-    {</span>
<a href="#l9.1342"></a><span id="l9.1342" class="difflineminus">-      AlertError(0, nullptr);</span>
<a href="#l9.1343"></a><span id="l9.1343" class="difflineminus">-      return rv;</span>
<a href="#l9.1344"></a><span id="l9.1344" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l9.1345"></a><span id="l9.1345" class="difflineplus">+    AlertError(0, nullptr);</span>
<a href="#l9.1346"></a><span id="l9.1346" class="difflineplus">+    return rv;</span>
<a href="#l9.1347"></a><span id="l9.1347" class="difflineplus">+  } else {</span>
<a href="#l9.1348"></a><span id="l9.1348" class="difflineplus">+    if (!m_socketIsOpen) {</span>
<a href="#l9.1349"></a><span id="l9.1349" class="difflineplus">+      m_nextStateAfterResponse = m_nextState;</span>
<a href="#l9.1350"></a><span id="l9.1350" class="difflineplus">+      m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.1351"></a><span id="l9.1351" class="difflineplus">+</span>
<a href="#l9.1352"></a><span id="l9.1352" class="difflineplus">+      // Calls LoadUrl in nsNNTPProtocol::OnProxyAvailable</span>
<a href="#l9.1353"></a><span id="l9.1353" class="difflineplus">+      rv = MsgExamineForProxyAsync(this, this, getter_AddRefs(m_proxyRequest));</span>
<a href="#l9.1354"></a><span id="l9.1354" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l9.1355"></a><span id="l9.1355" class="difflineplus">+        rv = LoadUrlInternal(nullptr);</span>
<a href="#l9.1356"></a><span id="l9.1356" class="difflineplus">+      }</span>
<a href="#l9.1357"></a><span id="l9.1357" class="difflineplus">+    } else {</span>
<a href="#l9.1358"></a><span id="l9.1358" class="difflineplus">+      rv = nsMsgProtocol::LoadUrl(aURL, aConsumer);</span>
<a href="#l9.1359"></a><span id="l9.1359">     }</span>
<a href="#l9.1360"></a><span id="l9.1360" class="difflineminus">-    else</span>
<a href="#l9.1361"></a><span id="l9.1361" class="difflineminus">-    {</span>
<a href="#l9.1362"></a><span id="l9.1362" class="difflineminus">-      if (!m_socketIsOpen)</span>
<a href="#l9.1363"></a><span id="l9.1363" class="difflineminus">-      {</span>
<a href="#l9.1364"></a><span id="l9.1364" class="difflineminus">-        m_nextStateAfterResponse = m_nextState;</span>
<a href="#l9.1365"></a><span id="l9.1365" class="difflineminus">-        m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.1366"></a><span id="l9.1366" class="difflineminus">-</span>
<a href="#l9.1367"></a><span id="l9.1367" class="difflineminus">-        // Calls LoadUrl in nsNNTPProtocol::OnProxyAvailable</span>
<a href="#l9.1368"></a><span id="l9.1368" class="difflineminus">-        rv = MsgExamineForProxyAsync(this, this, getter_AddRefs(m_proxyRequest));</span>
<a href="#l9.1369"></a><span id="l9.1369" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l9.1370"></a><span id="l9.1370" class="difflineminus">-          rv = LoadUrlInternal(nullptr);</span>
<a href="#l9.1371"></a><span id="l9.1371" class="difflineminus">-        }</span>
<a href="#l9.1372"></a><span id="l9.1372" class="difflineminus">-      }</span>
<a href="#l9.1373"></a><span id="l9.1373" class="difflineminus">-      else</span>
<a href="#l9.1374"></a><span id="l9.1374" class="difflineminus">-      {</span>
<a href="#l9.1375"></a><span id="l9.1375" class="difflineminus">-        rv = nsMsgProtocol::LoadUrl(aURL, aConsumer);</span>
<a href="#l9.1376"></a><span id="l9.1376" class="difflineminus">-      }</span>
<a href="#l9.1377"></a><span id="l9.1377" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l9.1378"></a><span id="l9.1378" class="difflineminus">-        PostLoadAssertions();</span>
<a href="#l9.1379"></a><span id="l9.1379" class="difflineminus">-    }</span>
<a href="#l9.1380"></a><span id="l9.1380" class="difflineminus">-</span>
<a href="#l9.1381"></a><span id="l9.1381" class="difflineminus">-    return rv;</span>
<a href="#l9.1382"></a><span id="l9.1382" class="difflineplus">+    if (NS_SUCCEEDED(rv)) PostLoadAssertions();</span>
<a href="#l9.1383"></a><span id="l9.1383" class="difflineplus">+  }</span>
<a href="#l9.1384"></a><span id="l9.1384" class="difflineplus">+</span>
<a href="#l9.1385"></a><span id="l9.1385" class="difflineplus">+  return rv;</span>
<a href="#l9.1386"></a><span id="l9.1386"> }</span>
<a href="#l9.1387"></a><span id="l9.1387"> </span>
<a href="#l9.1388"></a><span id="l9.1388"> // nsIProtocolProxyCallback</span>
<a href="#l9.1389"></a><span id="l9.1389"> NS_IMETHODIMP</span>
<a href="#l9.1390"></a><span id="l9.1390"> nsNNTPProtocol::OnProxyAvailable(nsICancelable *aRequest, nsIChannel *aChannel,</span>
<a href="#l9.1391"></a><span id="l9.1391" class="difflineminus">-                                 nsIProxyInfo *aProxyInfo, nsresult aStatus)</span>
<a href="#l9.1392"></a><span id="l9.1392" class="difflineminus">-{</span>
<a href="#l9.1393"></a><span id="l9.1393" class="difflineminus">-  MOZ_ASSERT(aChannel == this, &quot;Should never request a proxy for anyone but ourselves&quot;);</span>
<a href="#l9.1394"></a><span id="l9.1394" class="difflineplus">+                                 nsIProxyInfo *aProxyInfo, nsresult aStatus) {</span>
<a href="#l9.1395"></a><span id="l9.1395" class="difflineplus">+  MOZ_ASSERT(aChannel == this,</span>
<a href="#l9.1396"></a><span id="l9.1396" class="difflineplus">+             &quot;Should never request a proxy for anyone but ourselves&quot;);</span>
<a href="#l9.1397"></a><span id="l9.1397"> </span>
<a href="#l9.1398"></a><span id="l9.1398">   // If we're called with NS_BINDING_ABORTED, we came here via Cancel().</span>
<a href="#l9.1399"></a><span id="l9.1399">   // Otherwise, no checking of 'aStatus' here, see</span>
<a href="#l9.1400"></a><span id="l9.1400">   // nsHttpChannel::OnProxyAvailable(). Status is non-fatal and we just kick on.</span>
<a href="#l9.1401"></a><span id="l9.1401" class="difflineminus">-  if (aStatus == NS_BINDING_ABORTED)</span>
<a href="#l9.1402"></a><span id="l9.1402" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.1403"></a><span id="l9.1403" class="difflineplus">+  if (aStatus == NS_BINDING_ABORTED) return NS_ERROR_FAILURE;</span>
<a href="#l9.1404"></a><span id="l9.1404"> </span>
<a href="#l9.1405"></a><span id="l9.1405">   nsresult rv = LoadUrlInternal(aProxyInfo);</span>
<a href="#l9.1406"></a><span id="l9.1406">   if (NS_FAILED(rv)) {</span>
<a href="#l9.1407"></a><span id="l9.1407">     return Cancel(rv);</span>
<a href="#l9.1408"></a><span id="l9.1408">   }</span>
<a href="#l9.1409"></a><span id="l9.1409"> </span>
<a href="#l9.1410"></a><span id="l9.1410">   PostLoadAssertions();</span>
<a href="#l9.1411"></a><span id="l9.1411"> </span>
<a href="#l9.1412"></a><span id="l9.1412">   return rv;</span>
<a href="#l9.1413"></a><span id="l9.1413"> }</span>
<a href="#l9.1414"></a><span id="l9.1414"> </span>
<a href="#l9.1415"></a><span id="l9.1415" class="difflineminus">-nsresult</span>
<a href="#l9.1416"></a><span id="l9.1416" class="difflineminus">-nsNNTPProtocol::LoadUrlInternal(nsIProxyInfo* aProxyInfo)</span>
<a href="#l9.1417"></a><span id="l9.1417" class="difflineminus">-{</span>
<a href="#l9.1418"></a><span id="l9.1418" class="difflineplus">+nsresult nsNNTPProtocol::LoadUrlInternal(nsIProxyInfo *aProxyInfo) {</span>
<a href="#l9.1419"></a><span id="l9.1419">   m_proxyRequest = nullptr;</span>
<a href="#l9.1420"></a><span id="l9.1420"> </span>
<a href="#l9.1421"></a><span id="l9.1421">   nsresult rv;</span>
<a href="#l9.1422"></a><span id="l9.1422">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer, &amp;rv);</span>
<a href="#l9.1423"></a><span id="l9.1423">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1424"></a><span id="l9.1424"> </span>
<a href="#l9.1425"></a><span id="l9.1425">   nsCString hostName;</span>
<a href="#l9.1426"></a><span id="l9.1426">   int32_t port = 0;</span>
<a href="#l9.1427"></a><span id="l9.1427" class="difflineat">@@ -1138,2063 +1078,1916 @@ nsNNTPProtocol::LoadUrlInternal(nsIProxy</span>
<a href="#l9.1428"></a><span id="l9.1428"> </span>
<a href="#l9.1429"></a><span id="l9.1429">   rv = m_url-&gt;GetPort(&amp;port);</span>
<a href="#l9.1430"></a><span id="l9.1430">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1431"></a><span id="l9.1431"> </span>
<a href="#l9.1432"></a><span id="l9.1432">   rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l9.1433"></a><span id="l9.1433">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1434"></a><span id="l9.1434"> </span>
<a href="#l9.1435"></a><span id="l9.1435">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir;</span>
<a href="#l9.1436"></a><span id="l9.1436" class="difflineminus">-  if (socketType != nsMsgSocketType::plain &amp;&amp; m_msgWindow)</span>
<a href="#l9.1437"></a><span id="l9.1437" class="difflineminus">-  {</span>
<a href="#l9.1438"></a><span id="l9.1438" class="difflineplus">+  if (socketType != nsMsgSocketType::plain &amp;&amp; m_msgWindow) {</span>
<a href="#l9.1439"></a><span id="l9.1439">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l9.1440"></a><span id="l9.1440">     m_msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l9.1441"></a><span id="l9.1441">     ir = do_QueryInterface(docShell);</span>
<a href="#l9.1442"></a><span id="l9.1442">   }</span>
<a href="#l9.1443"></a><span id="l9.1443"> </span>
<a href="#l9.1444"></a><span id="l9.1444" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) opening connection to %s on port %d&quot;,</span>
<a href="#l9.1445"></a><span id="l9.1445" class="difflineminus">-    this, hostName.get(), port));</span>
<a href="#l9.1446"></a><span id="l9.1446" class="difflineminus">-</span>
<a href="#l9.1447"></a><span id="l9.1447" class="difflineminus">-  rv = OpenNetworkSocketWithInfo(hostName.get(), port,</span>
<a href="#l9.1448"></a><span id="l9.1448" class="difflineminus">-    (socketType == nsMsgSocketType::SSL) ? &quot;ssl&quot; : nullptr,</span>
<a href="#l9.1449"></a><span id="l9.1449" class="difflineminus">-    aProxyInfo, ir);</span>
<a href="#l9.1450"></a><span id="l9.1450" class="difflineplus">+  MOZ_LOG(</span>
<a href="#l9.1451"></a><span id="l9.1451" class="difflineplus">+      NNTP, LogLevel::Info,</span>
<a href="#l9.1452"></a><span id="l9.1452" class="difflineplus">+      (&quot;(%p) opening connection to %s on port %d&quot;, this, hostName.get(), port));</span>
<a href="#l9.1453"></a><span id="l9.1453" class="difflineplus">+</span>
<a href="#l9.1454"></a><span id="l9.1454" class="difflineplus">+  rv = OpenNetworkSocketWithInfo(</span>
<a href="#l9.1455"></a><span id="l9.1455" class="difflineplus">+      hostName.get(), port,</span>
<a href="#l9.1456"></a><span id="l9.1456" class="difflineplus">+      (socketType == nsMsgSocketType::SSL) ? &quot;ssl&quot; : nullptr, aProxyInfo, ir);</span>
<a href="#l9.1457"></a><span id="l9.1457"> </span>
<a href="#l9.1458"></a><span id="l9.1458">   rv = nsMsgProtocol::LoadUrl(m_url, m_consumer);</span>
<a href="#l9.1459"></a><span id="l9.1459">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1460"></a><span id="l9.1460"> </span>
<a href="#l9.1461"></a><span id="l9.1461">   return rv;</span>
<a href="#l9.1462"></a><span id="l9.1462"> }</span>
<a href="#l9.1463"></a><span id="l9.1463"> </span>
<a href="#l9.1464"></a><span id="l9.1464" class="difflineminus">-void nsNNTPProtocol::FinishMemCacheEntry(bool valid)</span>
<a href="#l9.1465"></a><span id="l9.1465" class="difflineminus">-{</span>
<a href="#l9.1466"></a><span id="l9.1466" class="difflineminus">-  nsCOMPtr &lt;nsICacheEntry&gt; memCacheEntry;</span>
<a href="#l9.1467"></a><span id="l9.1467" class="difflineplus">+void nsNNTPProtocol::FinishMemCacheEntry(bool valid) {</span>
<a href="#l9.1468"></a><span id="l9.1468" class="difflineplus">+  nsCOMPtr&lt;nsICacheEntry&gt; memCacheEntry;</span>
<a href="#l9.1469"></a><span id="l9.1469">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.1470"></a><span id="l9.1470" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l9.1471"></a><span id="l9.1471" class="difflineminus">-    mailnewsurl-&gt;GetMemCacheEntry(getter_AddRefs(memCacheEntry));</span>
<a href="#l9.1472"></a><span id="l9.1472" class="difflineminus">-  if (memCacheEntry)</span>
<a href="#l9.1473"></a><span id="l9.1473" class="difflineminus">-  {</span>
<a href="#l9.1474"></a><span id="l9.1474" class="difflineplus">+  if (mailnewsurl) mailnewsurl-&gt;GetMemCacheEntry(getter_AddRefs(memCacheEntry));</span>
<a href="#l9.1475"></a><span id="l9.1475" class="difflineplus">+  if (memCacheEntry) {</span>
<a href="#l9.1476"></a><span id="l9.1476">     if (valid)</span>
<a href="#l9.1477"></a><span id="l9.1477">       memCacheEntry-&gt;MarkValid();</span>
<a href="#l9.1478"></a><span id="l9.1478">     else</span>
<a href="#l9.1479"></a><span id="l9.1479">       memCacheEntry-&gt;AsyncDoom(nullptr);</span>
<a href="#l9.1480"></a><span id="l9.1480">   }</span>
<a href="#l9.1481"></a><span id="l9.1481"> }</span>
<a href="#l9.1482"></a><span id="l9.1482"> </span>
<a href="#l9.1483"></a><span id="l9.1483" class="difflineminus">-// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l9.1484"></a><span id="l9.1484" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l9.1485"></a><span id="l9.1485" class="difflineminus">-{</span>
<a href="#l9.1486"></a><span id="l9.1486" class="difflineminus">-    // either remove mem cache entry, or mark it valid if url successful and</span>
<a href="#l9.1487"></a><span id="l9.1487" class="difflineminus">-    // command succeeded</span>
<a href="#l9.1488"></a><span id="l9.1488" class="difflineminus">-    FinishMemCacheEntry(NS_SUCCEEDED(aStatus)</span>
<a href="#l9.1489"></a><span id="l9.1489" class="difflineminus">-      &amp;&amp; MK_NNTP_RESPONSE_TYPE(m_responseCode) == MK_NNTP_RESPONSE_TYPE_OK);</span>
<a href="#l9.1490"></a><span id="l9.1490" class="difflineminus">-</span>
<a href="#l9.1491"></a><span id="l9.1491" class="difflineminus">-    nsMsgProtocol::OnStopRequest(request, aStatus);</span>
<a href="#l9.1492"></a><span id="l9.1492" class="difflineminus">-</span>
<a href="#l9.1493"></a><span id="l9.1493" class="difflineminus">-    // nsMsgProtocol::OnStopRequest() has called m_channelListener. There is</span>
<a href="#l9.1494"></a><span id="l9.1494" class="difflineminus">-    // no need to be called again in CloseSocket(). Let's clear it here.</span>
<a href="#l9.1495"></a><span id="l9.1495" class="difflineminus">-    if (m_channelListener) {</span>
<a href="#l9.1496"></a><span id="l9.1496" class="difflineminus">-        m_channelListener = nullptr;</span>
<a href="#l9.1497"></a><span id="l9.1497" class="difflineminus">-    }</span>
<a href="#l9.1498"></a><span id="l9.1498" class="difflineminus">-</span>
<a href="#l9.1499"></a><span id="l9.1499" class="difflineminus">-  // okay, we've been told that the send is done and the connection is going away. So</span>
<a href="#l9.1500"></a><span id="l9.1500" class="difflineminus">-  // we need to release all of our state</span>
<a href="#l9.1501"></a><span id="l9.1501" class="difflineplus">+// stop binding is a &quot;notification&quot; informing us that the stream associated with</span>
<a href="#l9.1502"></a><span id="l9.1502" class="difflineplus">+// aURL is going away.</span>
<a href="#l9.1503"></a><span id="l9.1503" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::OnStopRequest(nsIRequest *request,</span>
<a href="#l9.1504"></a><span id="l9.1504" class="difflineplus">+                                            nsresult aStatus) {</span>
<a href="#l9.1505"></a><span id="l9.1505" class="difflineplus">+  // either remove mem cache entry, or mark it valid if url successful and</span>
<a href="#l9.1506"></a><span id="l9.1506" class="difflineplus">+  // command succeeded</span>
<a href="#l9.1507"></a><span id="l9.1507" class="difflineplus">+  FinishMemCacheEntry(NS_SUCCEEDED(aStatus) &amp;&amp;</span>
<a href="#l9.1508"></a><span id="l9.1508" class="difflineplus">+                      MK_NNTP_RESPONSE_TYPE(m_responseCode) ==</span>
<a href="#l9.1509"></a><span id="l9.1509" class="difflineplus">+                          MK_NNTP_RESPONSE_TYPE_OK);</span>
<a href="#l9.1510"></a><span id="l9.1510" class="difflineplus">+</span>
<a href="#l9.1511"></a><span id="l9.1511" class="difflineplus">+  nsMsgProtocol::OnStopRequest(request, aStatus);</span>
<a href="#l9.1512"></a><span id="l9.1512" class="difflineplus">+</span>
<a href="#l9.1513"></a><span id="l9.1513" class="difflineplus">+  // nsMsgProtocol::OnStopRequest() has called m_channelListener. There is</span>
<a href="#l9.1514"></a><span id="l9.1514" class="difflineplus">+  // no need to be called again in CloseSocket(). Let's clear it here.</span>
<a href="#l9.1515"></a><span id="l9.1515" class="difflineplus">+  if (m_channelListener) {</span>
<a href="#l9.1516"></a><span id="l9.1516" class="difflineplus">+    m_channelListener = nullptr;</span>
<a href="#l9.1517"></a><span id="l9.1517" class="difflineplus">+  }</span>
<a href="#l9.1518"></a><span id="l9.1518" class="difflineplus">+</span>
<a href="#l9.1519"></a><span id="l9.1519" class="difflineplus">+  // okay, we've been told that the send is done and the connection is going</span>
<a href="#l9.1520"></a><span id="l9.1520" class="difflineplus">+  // away. So we need to release all of our state</span>
<a href="#l9.1521"></a><span id="l9.1521">   return CloseSocket();</span>
<a href="#l9.1522"></a><span id="l9.1522"> }</span>
<a href="#l9.1523"></a><span id="l9.1523"> </span>
<a href="#l9.1524"></a><span id="l9.1524"> NS_IMETHODIMP nsNNTPProtocol::Cancel(nsresult status)  // handle stop button</span>
<a href="#l9.1525"></a><span id="l9.1525"> {</span>
<a href="#l9.1526"></a><span id="l9.1526" class="difflineminus">-    if (m_proxyRequest)</span>
<a href="#l9.1527"></a><span id="l9.1527" class="difflineminus">-    {</span>
<a href="#l9.1528"></a><span id="l9.1528" class="difflineminus">-      m_proxyRequest-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l9.1529"></a><span id="l9.1529" class="difflineminus">-</span>
<a href="#l9.1530"></a><span id="l9.1530" class="difflineminus">-      // Note that nsMsgProtocol::Cancel() also calls</span>
<a href="#l9.1531"></a><span id="l9.1531" class="difflineminus">-      // nsProtocolProxyService::Cancel(), so no need to call it twice</span>
<a href="#l9.1532"></a><span id="l9.1532" class="difflineminus">-      // (although it self-protects against multiple calls).</span>
<a href="#l9.1533"></a><span id="l9.1533" class="difflineminus">-      m_proxyRequest = nullptr;</span>
<a href="#l9.1534"></a><span id="l9.1534" class="difflineminus">-    }</span>
<a href="#l9.1535"></a><span id="l9.1535" class="difflineminus">-</span>
<a href="#l9.1536"></a><span id="l9.1536" class="difflineminus">-    m_nextState = NNTP_ERROR;</span>
<a href="#l9.1537"></a><span id="l9.1537" class="difflineminus">-    return nsMsgProtocol::Cancel(NS_BINDING_ABORTED);</span>
<a href="#l9.1538"></a><span id="l9.1538" class="difflineplus">+  if (m_proxyRequest) {</span>
<a href="#l9.1539"></a><span id="l9.1539" class="difflineplus">+    m_proxyRequest-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l9.1540"></a><span id="l9.1540" class="difflineplus">+</span>
<a href="#l9.1541"></a><span id="l9.1541" class="difflineplus">+    // Note that nsMsgProtocol::Cancel() also calls</span>
<a href="#l9.1542"></a><span id="l9.1542" class="difflineplus">+    // nsProtocolProxyService::Cancel(), so no need to call it twice</span>
<a href="#l9.1543"></a><span id="l9.1543" class="difflineplus">+    // (although it self-protects against multiple calls).</span>
<a href="#l9.1544"></a><span id="l9.1544" class="difflineplus">+    m_proxyRequest = nullptr;</span>
<a href="#l9.1545"></a><span id="l9.1545" class="difflineplus">+  }</span>
<a href="#l9.1546"></a><span id="l9.1546" class="difflineplus">+</span>
<a href="#l9.1547"></a><span id="l9.1547" class="difflineplus">+  m_nextState = NNTP_ERROR;</span>
<a href="#l9.1548"></a><span id="l9.1548" class="difflineplus">+  return nsMsgProtocol::Cancel(NS_BINDING_ABORTED);</span>
<a href="#l9.1549"></a><span id="l9.1549"> }</span>
<a href="#l9.1550"></a><span id="l9.1550"> </span>
<a href="#l9.1551"></a><span id="l9.1551" class="difflineminus">-nsresult</span>
<a href="#l9.1552"></a><span id="l9.1552" class="difflineminus">-nsNNTPProtocol::ParseURL(nsIURI *aURL, nsCString &amp;aGroup, nsCString &amp;aMessageID)</span>
<a href="#l9.1553"></a><span id="l9.1553" class="difflineminus">-{</span>
<a href="#l9.1554"></a><span id="l9.1554" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l9.1555"></a><span id="l9.1555" class="difflineminus">-</span>
<a href="#l9.1556"></a><span id="l9.1556" class="difflineminus">-    MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) ParseURL&quot;,this));</span>
<a href="#l9.1557"></a><span id="l9.1557" class="difflineminus">-</span>
<a href="#l9.1558"></a><span id="l9.1558" class="difflineminus">-    nsresult rv;</span>
<a href="#l9.1559"></a><span id="l9.1559" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.1560"></a><span id="l9.1560" class="difflineminus">-    nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.1561"></a><span id="l9.1561" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1562"></a><span id="l9.1562" class="difflineminus">-</span>
<a href="#l9.1563"></a><span id="l9.1563" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.1564"></a><span id="l9.1564" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1565"></a><span id="l9.1565" class="difflineminus">-</span>
<a href="#l9.1566"></a><span id="l9.1566" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(msgUrl, &amp;rv);</span>
<a href="#l9.1567"></a><span id="l9.1567" class="difflineplus">+nsresult nsNNTPProtocol::ParseURL(nsIURI *aURL, nsCString &amp;aGroup,</span>
<a href="#l9.1568"></a><span id="l9.1568" class="difflineplus">+                                  nsCString &amp;aMessageID) {</span>
<a href="#l9.1569"></a><span id="l9.1569" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l9.1570"></a><span id="l9.1570" class="difflineplus">+</span>
<a href="#l9.1571"></a><span id="l9.1571" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) ParseURL&quot;, this));</span>
<a href="#l9.1572"></a><span id="l9.1572" class="difflineplus">+</span>
<a href="#l9.1573"></a><span id="l9.1573" class="difflineplus">+  nsresult rv;</span>
<a href="#l9.1574"></a><span id="l9.1574" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.1575"></a><span id="l9.1575" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l9.1576"></a><span id="l9.1576" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.1577"></a><span id="l9.1577" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1578"></a><span id="l9.1578" class="difflineplus">+</span>
<a href="#l9.1579"></a><span id="l9.1579" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l9.1580"></a><span id="l9.1580" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1581"></a><span id="l9.1581" class="difflineplus">+</span>
<a href="#l9.1582"></a><span id="l9.1582" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(msgUrl, &amp;rv);</span>
<a href="#l9.1583"></a><span id="l9.1583" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1584"></a><span id="l9.1584" class="difflineplus">+</span>
<a href="#l9.1585"></a><span id="l9.1585" class="difflineplus">+  nsCString spec;</span>
<a href="#l9.1586"></a><span id="l9.1586" class="difflineplus">+  rv = msgUrl-&gt;GetOriginalSpec(getter_Copies(spec));</span>
<a href="#l9.1587"></a><span id="l9.1587" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1588"></a><span id="l9.1588" class="difflineplus">+</span>
<a href="#l9.1589"></a><span id="l9.1589" class="difflineplus">+  // if the original spec is non empty, use it to determine m_newsFolder and</span>
<a href="#l9.1590"></a><span id="l9.1590" class="difflineplus">+  // m_key</span>
<a href="#l9.1591"></a><span id="l9.1591" class="difflineplus">+  if (!spec.IsEmpty()) {</span>
<a href="#l9.1592"></a><span id="l9.1592" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.1593"></a><span id="l9.1593" class="difflineplus">+            (&quot;(%p) original message spec = %s&quot;, this, spec.get()));</span>
<a href="#l9.1594"></a><span id="l9.1594" class="difflineplus">+</span>
<a href="#l9.1595"></a><span id="l9.1595" class="difflineplus">+    rv = nntpService-&gt;DecomposeNewsURI(spec.get(), getter_AddRefs(folder),</span>
<a href="#l9.1596"></a><span id="l9.1596" class="difflineplus">+                                       &amp;m_key);</span>
<a href="#l9.1597"></a><span id="l9.1597">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1598"></a><span id="l9.1598"> </span>
<a href="#l9.1599"></a><span id="l9.1599" class="difflineminus">-    nsCString spec;</span>
<a href="#l9.1600"></a><span id="l9.1600" class="difflineminus">-    rv = msgUrl-&gt;GetOriginalSpec(getter_Copies(spec));</span>
<a href="#l9.1601"></a><span id="l9.1601" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1602"></a><span id="l9.1602" class="difflineminus">-</span>
<a href="#l9.1603"></a><span id="l9.1603" class="difflineminus">-    // if the original spec is non empty, use it to determine m_newsFolder and m_key</span>
<a href="#l9.1604"></a><span id="l9.1604" class="difflineminus">-    if (!spec.IsEmpty()) {</span>
<a href="#l9.1605"></a><span id="l9.1605" class="difflineminus">-        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) original message spec = %s&quot;,this,spec.get()));</span>
<a href="#l9.1606"></a><span id="l9.1606" class="difflineminus">-</span>
<a href="#l9.1607"></a><span id="l9.1607" class="difflineminus">-        rv = nntpService-&gt;DecomposeNewsURI(spec.get(), getter_AddRefs(folder), &amp;m_key);</span>
<a href="#l9.1608"></a><span id="l9.1608" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1609"></a><span id="l9.1609" class="difflineminus">-</span>
<a href="#l9.1610"></a><span id="l9.1610" class="difflineminus">-        // since we are reading a message in this folder, we can set m_newsFolder</span>
<a href="#l9.1611"></a><span id="l9.1611" class="difflineminus">-        m_newsFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l9.1612"></a><span id="l9.1612" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1613"></a><span id="l9.1613" class="difflineminus">-</span>
<a href="#l9.1614"></a><span id="l9.1614" class="difflineminus">-        // if we are cancelling, we aren't done.  we still need to parse out the messageID from the url</span>
<a href="#l9.1615"></a><span id="l9.1615" class="difflineminus">-        // later, we'll use m_newsFolder and m_key to delete the message from the DB, if the cancel is successful.</span>
<a href="#l9.1616"></a><span id="l9.1616" class="difflineminus">-        if (m_newsAction != nsINntpUrl::ActionCancelArticle) {</span>
<a href="#l9.1617"></a><span id="l9.1617" class="difflineminus">-            return NS_OK;</span>
<a href="#l9.1618"></a><span id="l9.1618" class="difflineminus">-        }</span>
<a href="#l9.1619"></a><span id="l9.1619" class="difflineplus">+    // since we are reading a message in this folder, we can set m_newsFolder</span>
<a href="#l9.1620"></a><span id="l9.1620" class="difflineplus">+    m_newsFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l9.1621"></a><span id="l9.1621" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1622"></a><span id="l9.1622" class="difflineplus">+</span>
<a href="#l9.1623"></a><span id="l9.1623" class="difflineplus">+    // if we are cancelling, we aren't done.  we still need to parse out the</span>
<a href="#l9.1624"></a><span id="l9.1624" class="difflineplus">+    // messageID from the url later, we'll use m_newsFolder and m_key to delete</span>
<a href="#l9.1625"></a><span id="l9.1625" class="difflineplus">+    // the message from the DB, if the cancel is successful.</span>
<a href="#l9.1626"></a><span id="l9.1626" class="difflineplus">+    if (m_newsAction != nsINntpUrl::ActionCancelArticle) {</span>
<a href="#l9.1627"></a><span id="l9.1627" class="difflineplus">+      return NS_OK;</span>
<a href="#l9.1628"></a><span id="l9.1628">     }</span>
<a href="#l9.1629"></a><span id="l9.1629" class="difflineminus">-    else {</span>
<a href="#l9.1630"></a><span id="l9.1630" class="difflineminus">-        // clear this, we'll set it later.</span>
<a href="#l9.1631"></a><span id="l9.1631" class="difflineminus">-        m_newsFolder = nullptr;</span>
<a href="#l9.1632"></a><span id="l9.1632" class="difflineminus">-        m_currentGroup.Truncate();</span>
<a href="#l9.1633"></a><span id="l9.1633" class="difflineminus">-    }</span>
<a href="#l9.1634"></a><span id="l9.1634" class="difflineplus">+  } else {</span>
<a href="#l9.1635"></a><span id="l9.1635" class="difflineplus">+    // clear this, we'll set it later.</span>
<a href="#l9.1636"></a><span id="l9.1636" class="difflineplus">+    m_newsFolder = nullptr;</span>
<a href="#l9.1637"></a><span id="l9.1637" class="difflineplus">+    m_currentGroup.Truncate();</span>
<a href="#l9.1638"></a><span id="l9.1638" class="difflineplus">+  }</span>
<a href="#l9.1639"></a><span id="l9.1639"> </span>
<a href="#l9.1640"></a><span id="l9.1640">   // Load the values from the URL for parsing.</span>
<a href="#l9.1641"></a><span id="l9.1641">   rv = m_runningURL-&gt;GetGroup(aGroup);</span>
<a href="#l9.1642"></a><span id="l9.1642">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1643"></a><span id="l9.1643">   rv = m_runningURL-&gt;GetMessageID(aMessageID);</span>
<a href="#l9.1644"></a><span id="l9.1644">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1645"></a><span id="l9.1645"> </span>
<a href="#l9.1646"></a><span id="l9.1646" class="difflineminus">-  NS_ASSERTION(aMessageID.IsEmpty() || aMessageID != aGroup, &quot;something not null&quot;);</span>
<a href="#l9.1647"></a><span id="l9.1647" class="difflineplus">+  NS_ASSERTION(aMessageID.IsEmpty() || aMessageID != aGroup,</span>
<a href="#l9.1648"></a><span id="l9.1648" class="difflineplus">+               &quot;something not null&quot;);</span>
<a href="#l9.1649"></a><span id="l9.1649"> </span>
<a href="#l9.1650"></a><span id="l9.1650">   // If we are cancelling, we've got our message id, m_key, and m_newsFolder.</span>
<a href="#l9.1651"></a><span id="l9.1651">   // Bail out now to prevent messing those up.</span>
<a href="#l9.1652"></a><span id="l9.1652" class="difflineminus">-  if (m_newsAction == nsINntpUrl::ActionCancelArticle)</span>
<a href="#l9.1653"></a><span id="l9.1653" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.1654"></a><span id="l9.1654" class="difflineplus">+  if (m_newsAction == nsINntpUrl::ActionCancelArticle) return NS_OK;</span>
<a href="#l9.1655"></a><span id="l9.1655"> </span>
<a href="#l9.1656"></a><span id="l9.1656">   rv = m_runningURL-&gt;GetKey(&amp;m_key);</span>
<a href="#l9.1657"></a><span id="l9.1657">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1658"></a><span id="l9.1658"> </span>
<a href="#l9.1659"></a><span id="l9.1659">   // Check if the key is in the local cache.</span>
<a href="#l9.1660"></a><span id="l9.1660">   // It's possible that we're have a server/group/key combo that doesn't exist</span>
<a href="#l9.1661"></a><span id="l9.1661">   // (think nntp://server/group/key), so not having the folder isn't a bad</span>
<a href="#l9.1662"></a><span id="l9.1662">   // thing.</span>
<a href="#l9.1663"></a><span id="l9.1663" class="difflineminus">-  if (m_key != nsMsgKey_None)</span>
<a href="#l9.1664"></a><span id="l9.1664" class="difflineminus">-  {</span>
<a href="#l9.1665"></a><span id="l9.1665" class="difflineplus">+  if (m_key != nsMsgKey_None) {</span>
<a href="#l9.1666"></a><span id="l9.1666">     rv = mailnewsUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l9.1667"></a><span id="l9.1667">     m_newsFolder = do_QueryInterface(folder);</span>
<a href="#l9.1668"></a><span id="l9.1668"> </span>
<a href="#l9.1669"></a><span id="l9.1669" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; m_newsFolder)</span>
<a href="#l9.1670"></a><span id="l9.1670" class="difflineminus">-    {</span>
<a href="#l9.1671"></a><span id="l9.1671" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; m_newsFolder) {</span>
<a href="#l9.1672"></a><span id="l9.1672">       bool useLocalCache = false;</span>
<a href="#l9.1673"></a><span id="l9.1673">       rv = folder-&gt;HasMsgOffline(m_key, &amp;useLocalCache);</span>
<a href="#l9.1674"></a><span id="l9.1674" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1675"></a><span id="l9.1675" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1676"></a><span id="l9.1676"> </span>
<a href="#l9.1677"></a><span id="l9.1677">       // set message is in local cache</span>
<a href="#l9.1678"></a><span id="l9.1678">       rv = mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l9.1679"></a><span id="l9.1679" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1680"></a><span id="l9.1680" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1681"></a><span id="l9.1681">     }</span>
<a href="#l9.1682"></a><span id="l9.1682">   }</span>
<a href="#l9.1683"></a><span id="l9.1683"> </span>
<a href="#l9.1684"></a><span id="l9.1684">   return NS_OK;</span>
<a href="#l9.1685"></a><span id="l9.1685"> }</span>
<a href="#l9.1686"></a><span id="l9.1686"> /*</span>
<a href="#l9.1687"></a><span id="l9.1687" class="difflineminus">- * Writes the data contained in dataBuffer into the current output stream. It also informs</span>
<a href="#l9.1688"></a><span id="l9.1688" class="difflineminus">- * the transport layer that this data is now available for transmission.</span>
<a href="#l9.1689"></a><span id="l9.1689" class="difflineminus">- * Returns a positive number for success, 0 for failure (not all the bytes were written to the</span>
<a href="#l9.1690"></a><span id="l9.1690" class="difflineminus">- * stream, etc). We need to make another pass through this file to install an error system (mscott)</span>
<a href="#l9.1691"></a><span id="l9.1691" class="difflineplus">+ * Writes the data contained in dataBuffer into the current output stream. It</span>
<a href="#l9.1692"></a><span id="l9.1692" class="difflineplus">+ * also informs the transport layer that this data is now available for</span>
<a href="#l9.1693"></a><span id="l9.1693" class="difflineplus">+ * transmission. Returns a positive number for success, 0 for failure (not all</span>
<a href="#l9.1694"></a><span id="l9.1694" class="difflineplus">+ * the bytes were written to the stream, etc). We need to make another pass</span>
<a href="#l9.1695"></a><span id="l9.1695" class="difflineplus">+ * through this file to install an error system (mscott)</span>
<a href="#l9.1696"></a><span id="l9.1696">  */</span>
<a href="#l9.1697"></a><span id="l9.1697"> </span>
<a href="#l9.1698"></a><span id="l9.1698" class="difflineminus">-nsresult nsNNTPProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l9.1699"></a><span id="l9.1699" class="difflineminus">-{</span>
<a href="#l9.1700"></a><span id="l9.1700" class="difflineminus">-    if (!aSuppressLogging) {</span>
<a href="#l9.1701"></a><span id="l9.1701" class="difflineminus">-        NNTP_LOG_WRITE(dataBuffer);</span>
<a href="#l9.1702"></a><span id="l9.1702" class="difflineminus">-    }</span>
<a href="#l9.1703"></a><span id="l9.1703" class="difflineminus">-    else {</span>
<a href="#l9.1704"></a><span id="l9.1704" class="difflineminus">-        MOZ_LOG(NNTP, out, (&quot;(%p) Logging suppressed for this command (it probably contained authentication information)&quot;, this));</span>
<a href="#l9.1705"></a><span id="l9.1705" class="difflineminus">-    }</span>
<a href="#l9.1706"></a><span id="l9.1706" class="difflineminus">-</span>
<a href="#l9.1707"></a><span id="l9.1707" class="difflineminus">-  return nsMsgProtocol::SendData(dataBuffer); // base class actually transmits the data</span>
<a href="#l9.1708"></a><span id="l9.1708" class="difflineplus">+nsresult nsNNTPProtocol::SendData(const char *dataBuffer,</span>
<a href="#l9.1709"></a><span id="l9.1709" class="difflineplus">+                                  bool aSuppressLogging) {</span>
<a href="#l9.1710"></a><span id="l9.1710" class="difflineplus">+  if (!aSuppressLogging) {</span>
<a href="#l9.1711"></a><span id="l9.1711" class="difflineplus">+    NNTP_LOG_WRITE(dataBuffer);</span>
<a href="#l9.1712"></a><span id="l9.1712" class="difflineplus">+  } else {</span>
<a href="#l9.1713"></a><span id="l9.1713" class="difflineplus">+    MOZ_LOG(NNTP, out,</span>
<a href="#l9.1714"></a><span id="l9.1714" class="difflineplus">+            (&quot;(%p) Logging suppressed for this command (it probably contained &quot;</span>
<a href="#l9.1715"></a><span id="l9.1715" class="difflineplus">+             &quot;authentication information)&quot;,</span>
<a href="#l9.1716"></a><span id="l9.1716" class="difflineplus">+             this));</span>
<a href="#l9.1717"></a><span id="l9.1717" class="difflineplus">+  }</span>
<a href="#l9.1718"></a><span id="l9.1718" class="difflineplus">+</span>
<a href="#l9.1719"></a><span id="l9.1719" class="difflineplus">+  return nsMsgProtocol::SendData(</span>
<a href="#l9.1720"></a><span id="l9.1720" class="difflineplus">+      dataBuffer);  // base class actually transmits the data</span>
<a href="#l9.1721"></a><span id="l9.1721"> }</span>
<a href="#l9.1722"></a><span id="l9.1722"> </span>
<a href="#l9.1723"></a><span id="l9.1723"> /* gets the response code from the nntp server and the</span>
<a href="#l9.1724"></a><span id="l9.1724">  * response line</span>
<a href="#l9.1725"></a><span id="l9.1725">  *</span>
<a href="#l9.1726"></a><span id="l9.1726">  * returns the TCP return code from the read</span>
<a href="#l9.1727"></a><span id="l9.1727">  */</span>
<a href="#l9.1728"></a><span id="l9.1728" class="difflineminus">-nsresult nsNNTPProtocol::NewsResponse(nsIInputStream *inputStream, uint32_t length)</span>
<a href="#l9.1729"></a><span id="l9.1729" class="difflineminus">-{</span>
<a href="#l9.1730"></a><span id="l9.1730" class="difflineplus">+nsresult nsNNTPProtocol::NewsResponse(nsIInputStream *inputStream,</span>
<a href="#l9.1731"></a><span id="l9.1731" class="difflineplus">+                                      uint32_t length) {</span>
<a href="#l9.1732"></a><span id="l9.1732">   uint32_t status = 0;</span>
<a href="#l9.1733"></a><span id="l9.1733"> </span>
<a href="#l9.1734"></a><span id="l9.1734">   NS_ASSERTION(nullptr != inputStream, &quot;invalid input stream&quot;);</span>
<a href="#l9.1735"></a><span id="l9.1735"> </span>
<a href="#l9.1736"></a><span id="l9.1736">   bool pauseForMoreData = false;</span>
<a href="#l9.1737"></a><span id="l9.1737" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.1738"></a><span id="l9.1738" class="difflineplus">+  char *line =</span>
<a href="#l9.1739"></a><span id="l9.1739" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.1740"></a><span id="l9.1740"> </span>
<a href="#l9.1741"></a><span id="l9.1741">   NNTP_LOG_READ(line);</span>
<a href="#l9.1742"></a><span id="l9.1742"> </span>
<a href="#l9.1743"></a><span id="l9.1743" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.1744"></a><span id="l9.1744" class="difflineminus">-  {</span>
<a href="#l9.1745"></a><span id="l9.1745" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.1746"></a><span id="l9.1746">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1747"></a><span id="l9.1747">     return NS_OK;</span>
<a href="#l9.1748"></a><span id="l9.1748">   }</span>
<a href="#l9.1749"></a><span id="l9.1749"> </span>
<a href="#l9.1750"></a><span id="l9.1750" class="difflineminus">-  if(!line)</span>
<a href="#l9.1751"></a><span id="l9.1751" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.1752"></a><span id="l9.1752" class="difflineminus">-</span>
<a href="#l9.1753"></a><span id="l9.1753" class="difflineminus">-  ClearFlag(NNTP_PAUSE_FOR_READ);  /* don't pause if we got a line */</span>
<a href="#l9.1754"></a><span id="l9.1754" class="difflineplus">+  if (!line) return NS_ERROR_FAILURE;</span>
<a href="#l9.1755"></a><span id="l9.1755" class="difflineplus">+</span>
<a href="#l9.1756"></a><span id="l9.1756" class="difflineplus">+  ClearFlag(NNTP_PAUSE_FOR_READ); /* don't pause if we got a line */</span>
<a href="#l9.1757"></a><span id="l9.1757"> </span>
<a href="#l9.1758"></a><span id="l9.1758">   /* almost correct */</span>
<a href="#l9.1759"></a><span id="l9.1759" class="difflineminus">-  if(status &gt; 1)</span>
<a href="#l9.1760"></a><span id="l9.1760" class="difflineminus">-  {</span>
<a href="#l9.1761"></a><span id="l9.1761" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.1762"></a><span id="l9.1762">     mBytesReceived += status;</span>
<a href="#l9.1763"></a><span id="l9.1763">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.1764"></a><span id="l9.1764">   }</span>
<a href="#l9.1765"></a><span id="l9.1765"> </span>
<a href="#l9.1766"></a><span id="l9.1766">   m_previousResponseCode = m_responseCode;</span>
<a href="#l9.1767"></a><span id="l9.1767"> </span>
<a href="#l9.1768"></a><span id="l9.1768">   PR_sscanf(line, &quot;%d&quot;, &amp;m_responseCode);</span>
<a href="#l9.1769"></a><span id="l9.1769"> </span>
<a href="#l9.1770"></a><span id="l9.1770">   if (m_responseCode &amp;&amp; PL_strlen(line) &gt; 3)</span>
<a href="#l9.1771"></a><span id="l9.1771">     NS_MsgSACopy(&amp;m_responseText, line + 4);</span>
<a href="#l9.1772"></a><span id="l9.1772">   else</span>
<a href="#l9.1773"></a><span id="l9.1773">     NS_MsgSACopy(&amp;m_responseText, line);</span>
<a href="#l9.1774"></a><span id="l9.1774"> </span>
<a href="#l9.1775"></a><span id="l9.1775">   /* authentication required can come at any time</span>
<a href="#l9.1776"></a><span id="l9.1776" class="difflineminus">-  */</span>
<a href="#l9.1777"></a><span id="l9.1777" class="difflineplus">+   */</span>
<a href="#l9.1778"></a><span id="l9.1778">   if (MK_NNTP_RESPONSE_AUTHINFO_REQUIRE == m_responseCode ||</span>
<a href="#l9.1779"></a><span id="l9.1779" class="difflineminus">-    MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REQUIRE == m_responseCode)</span>
<a href="#l9.1780"></a><span id="l9.1780" class="difflineminus">-  {</span>
<a href="#l9.1781"></a><span id="l9.1781" class="difflineplus">+      MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REQUIRE == m_responseCode) {</span>
<a href="#l9.1782"></a><span id="l9.1782">     m_nextState = NNTP_BEGIN_AUTHORIZE;</span>
<a href="#l9.1783"></a><span id="l9.1783" class="difflineminus">-  }</span>
<a href="#l9.1784"></a><span id="l9.1784" class="difflineminus">-  else {</span>
<a href="#l9.1785"></a><span id="l9.1785" class="difflineplus">+  } else {</span>
<a href="#l9.1786"></a><span id="l9.1786">     m_nextState = m_nextStateAfterResponse;</span>
<a href="#l9.1787"></a><span id="l9.1787">   }</span>
<a href="#l9.1788"></a><span id="l9.1788"> </span>
<a href="#l9.1789"></a><span id="l9.1789">   PR_FREEIF(line);</span>
<a href="#l9.1790"></a><span id="l9.1790">   return NS_OK;</span>
<a href="#l9.1791"></a><span id="l9.1791"> }</span>
<a href="#l9.1792"></a><span id="l9.1792"> </span>
<a href="#l9.1793"></a><span id="l9.1793"> /* interpret the server response after the connect</span>
<a href="#l9.1794"></a><span id="l9.1794">  *</span>
<a href="#l9.1795"></a><span id="l9.1795">  * returns negative if the server responds unexpectedly</span>
<a href="#l9.1796"></a><span id="l9.1796">  */</span>
<a href="#l9.1797"></a><span id="l9.1797"> </span>
<a href="#l9.1798"></a><span id="l9.1798" class="difflineminus">-nsresult nsNNTPProtocol::LoginResponse()</span>
<a href="#l9.1799"></a><span id="l9.1799" class="difflineminus">-{</span>
<a href="#l9.1800"></a><span id="l9.1800" class="difflineplus">+nsresult nsNNTPProtocol::LoginResponse() {</span>
<a href="#l9.1801"></a><span id="l9.1801">   bool postingAllowed = m_responseCode == MK_NNTP_RESPONSE_POSTING_ALLOWED;</span>
<a href="#l9.1802"></a><span id="l9.1802"> </span>
<a href="#l9.1803"></a><span id="l9.1803" class="difflineminus">-  if(MK_NNTP_RESPONSE_TYPE(m_responseCode)!=MK_NNTP_RESPONSE_TYPE_OK)</span>
<a href="#l9.1804"></a><span id="l9.1804" class="difflineminus">-  {</span>
<a href="#l9.1805"></a><span id="l9.1805" class="difflineplus">+  if (MK_NNTP_RESPONSE_TYPE(m_responseCode) != MK_NNTP_RESPONSE_TYPE_OK) {</span>
<a href="#l9.1806"></a><span id="l9.1806">     AlertError(MK_NNTP_ERROR_MESSAGE, m_responseText);</span>
<a href="#l9.1807"></a><span id="l9.1807"> </span>
<a href="#l9.1808"></a><span id="l9.1808">     m_nextState = NNTP_ERROR;</span>
<a href="#l9.1809"></a><span id="l9.1809">     return NS_ERROR_FAILURE;</span>
<a href="#l9.1810"></a><span id="l9.1810">   }</span>
<a href="#l9.1811"></a><span id="l9.1811"> </span>
<a href="#l9.1812"></a><span id="l9.1812">   m_nntpServer-&gt;SetPostingAllowed(postingAllowed);</span>
<a href="#l9.1813"></a><span id="l9.1813">   m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.1814"></a><span id="l9.1814">   return NS_OK;</span>
<a href="#l9.1815"></a><span id="l9.1815"> }</span>
<a href="#l9.1816"></a><span id="l9.1816"> </span>
<a href="#l9.1817"></a><span id="l9.1817" class="difflineminus">-nsresult nsNNTPProtocol::SendModeReader()</span>
<a href="#l9.1818"></a><span id="l9.1818" class="difflineminus">-{</span>
<a href="#l9.1819"></a><span id="l9.1819" class="difflineplus">+nsresult nsNNTPProtocol::SendModeReader() {</span>
<a href="#l9.1820"></a><span id="l9.1820">   nsresult rv = NS_OK;</span>
<a href="#l9.1821"></a><span id="l9.1821"> </span>
<a href="#l9.1822"></a><span id="l9.1822">   rv = SendData(NNTP_CMD_MODE_READER);</span>
<a href="#l9.1823"></a><span id="l9.1823" class="difflineminus">-    m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.1824"></a><span id="l9.1824" class="difflineminus">-    m_nextStateAfterResponse = NNTP_SEND_MODE_READER_RESPONSE;</span>
<a href="#l9.1825"></a><span id="l9.1825" class="difflineminus">-    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1826"></a><span id="l9.1826" class="difflineminus">-</span>
<a href="#l9.1827"></a><span id="l9.1827" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.1828"></a><span id="l9.1828" class="difflineminus">-    return rv;</span>
<a href="#l9.1829"></a><span id="l9.1829" class="difflineplus">+  m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.1830"></a><span id="l9.1830" class="difflineplus">+  m_nextStateAfterResponse = NNTP_SEND_MODE_READER_RESPONSE;</span>
<a href="#l9.1831"></a><span id="l9.1831" class="difflineplus">+  SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1832"></a><span id="l9.1832" class="difflineplus">+</span>
<a href="#l9.1833"></a><span id="l9.1833" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.1834"></a><span id="l9.1834" class="difflineplus">+  return rv;</span>
<a href="#l9.1835"></a><span id="l9.1835"> }</span>
<a href="#l9.1836"></a><span id="l9.1836"> </span>
<a href="#l9.1837"></a><span id="l9.1837" class="difflineminus">-nsresult nsNNTPProtocol::SendModeReaderResponse()</span>
<a href="#l9.1838"></a><span id="l9.1838" class="difflineminus">-{</span>
<a href="#l9.1839"></a><span id="l9.1839" class="difflineplus">+nsresult nsNNTPProtocol::SendModeReaderResponse() {</span>
<a href="#l9.1840"></a><span id="l9.1840">   SetFlag(NNTP_READER_PERFORMED);</span>
<a href="#l9.1841"></a><span id="l9.1841"> </span>
<a href="#l9.1842"></a><span id="l9.1842">   /* ignore the response code and continue</span>
<a href="#l9.1843"></a><span id="l9.1843">    */</span>
<a href="#l9.1844"></a><span id="l9.1844">   bool pushAuth = false;</span>
<a href="#l9.1845"></a><span id="l9.1845">   nsresult rv = NS_OK;</span>
<a href="#l9.1846"></a><span id="l9.1846"> </span>
<a href="#l9.1847"></a><span id="l9.1847">   NS_ASSERTION(m_nntpServer, &quot;no server, see bug #107797&quot;);</span>
<a href="#l9.1848"></a><span id="l9.1848">   if (m_nntpServer) {</span>
<a href="#l9.1849"></a><span id="l9.1849">     rv = m_nntpServer-&gt;GetPushAuth(&amp;pushAuth);</span>
<a href="#l9.1850"></a><span id="l9.1850">   }</span>
<a href="#l9.1851"></a><span id="l9.1851">   if (NS_SUCCEEDED(rv) &amp;&amp; pushAuth) {</span>
<a href="#l9.1852"></a><span id="l9.1852" class="difflineminus">-    /* if the news host is set up to require volunteered (pushed) authentication,</span>
<a href="#l9.1853"></a><span id="l9.1853" class="difflineminus">-    * do that before we do anything else</span>
<a href="#l9.1854"></a><span id="l9.1854" class="difflineminus">-    */</span>
<a href="#l9.1855"></a><span id="l9.1855" class="difflineplus">+    /* if the news host is set up to require volunteered (pushed)</span>
<a href="#l9.1856"></a><span id="l9.1856" class="difflineplus">+     * authentication, do that before we do anything else</span>
<a href="#l9.1857"></a><span id="l9.1857" class="difflineplus">+     */</span>
<a href="#l9.1858"></a><span id="l9.1858">     m_nextState = NNTP_BEGIN_AUTHORIZE;</span>
<a href="#l9.1859"></a><span id="l9.1859" class="difflineminus">-  }</span>
<a href="#l9.1860"></a><span id="l9.1860" class="difflineminus">-  else {</span>
<a href="#l9.1861"></a><span id="l9.1861" class="difflineplus">+  } else {</span>
<a href="#l9.1862"></a><span id="l9.1862"> #ifdef HAVE_NNTP_EXTENSIONS</span>
<a href="#l9.1863"></a><span id="l9.1863">     m_nextState = SEND_LIST_EXTENSIONS;</span>
<a href="#l9.1864"></a><span id="l9.1864"> #else</span>
<a href="#l9.1865"></a><span id="l9.1865">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.1866"></a><span id="l9.1866" class="difflineminus">-#endif  /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l9.1867"></a><span id="l9.1867" class="difflineplus">+#endif /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l9.1868"></a><span id="l9.1868">   }</span>
<a href="#l9.1869"></a><span id="l9.1869"> </span>
<a href="#l9.1870"></a><span id="l9.1870">   return NS_OK;</span>
<a href="#l9.1871"></a><span id="l9.1871"> }</span>
<a href="#l9.1872"></a><span id="l9.1872"> </span>
<a href="#l9.1873"></a><span id="l9.1873" class="difflineminus">-nsresult nsNNTPProtocol::SendListExtensions()</span>
<a href="#l9.1874"></a><span id="l9.1874" class="difflineminus">-{</span>
<a href="#l9.1875"></a><span id="l9.1875" class="difflineplus">+nsresult nsNNTPProtocol::SendListExtensions() {</span>
<a href="#l9.1876"></a><span id="l9.1876">   nsresult rv = SendData(NNTP_CMD_LIST_EXTENSIONS);</span>
<a href="#l9.1877"></a><span id="l9.1877"> </span>
<a href="#l9.1878"></a><span id="l9.1878">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.1879"></a><span id="l9.1879">   m_nextStateAfterResponse = SEND_LIST_EXTENSIONS_RESPONSE;</span>
<a href="#l9.1880"></a><span id="l9.1880">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1881"></a><span id="l9.1881">   return rv;</span>
<a href="#l9.1882"></a><span id="l9.1882"> }</span>
<a href="#l9.1883"></a><span id="l9.1883"> </span>
<a href="#l9.1884"></a><span id="l9.1884" class="difflineminus">-nsresult nsNNTPProtocol::SendListExtensionsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.1885"></a><span id="l9.1885" class="difflineminus">-{</span>
<a href="#l9.1886"></a><span id="l9.1886" class="difflineplus">+nsresult nsNNTPProtocol::SendListExtensionsResponse(nsIInputStream *inputStream,</span>
<a href="#l9.1887"></a><span id="l9.1887" class="difflineplus">+                                                    uint32_t length) {</span>
<a href="#l9.1888"></a><span id="l9.1888">   nsresult rv = NS_OK;</span>
<a href="#l9.1889"></a><span id="l9.1889"> </span>
<a href="#l9.1890"></a><span id="l9.1890" class="difflineminus">-  if (MK_NNTP_RESPONSE_TYPE(m_responseCode) == MK_NNTP_RESPONSE_TYPE_OK)</span>
<a href="#l9.1891"></a><span id="l9.1891" class="difflineminus">-  {</span>
<a href="#l9.1892"></a><span id="l9.1892" class="difflineplus">+  if (MK_NNTP_RESPONSE_TYPE(m_responseCode) == MK_NNTP_RESPONSE_TYPE_OK) {</span>
<a href="#l9.1893"></a><span id="l9.1893">     uint32_t status = 0;</span>
<a href="#l9.1894"></a><span id="l9.1894">     bool pauseForMoreData = false;</span>
<a href="#l9.1895"></a><span id="l9.1895" class="difflineminus">-    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.1896"></a><span id="l9.1896" class="difflineminus">-</span>
<a href="#l9.1897"></a><span id="l9.1897" class="difflineminus">-    if(pauseForMoreData)</span>
<a href="#l9.1898"></a><span id="l9.1898" class="difflineminus">-    {</span>
<a href="#l9.1899"></a><span id="l9.1899" class="difflineplus">+    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.1900"></a><span id="l9.1900" class="difflineplus">+                                                  pauseForMoreData, &amp;rv);</span>
<a href="#l9.1901"></a><span id="l9.1901" class="difflineplus">+</span>
<a href="#l9.1902"></a><span id="l9.1902" class="difflineplus">+    if (pauseForMoreData) {</span>
<a href="#l9.1903"></a><span id="l9.1903">       SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1904"></a><span id="l9.1904">       return NS_OK;</span>
<a href="#l9.1905"></a><span id="l9.1905">     }</span>
<a href="#l9.1906"></a><span id="l9.1906" class="difflineminus">-    if (!line)</span>
<a href="#l9.1907"></a><span id="l9.1907" class="difflineminus">-      return rv;  /* no line yet */</span>
<a href="#l9.1908"></a><span id="l9.1908" class="difflineminus">-</span>
<a href="#l9.1909"></a><span id="l9.1909" class="difflineminus">-        if ('.' != line[0]) {</span>
<a href="#l9.1910"></a><span id="l9.1910" class="difflineminus">-            m_nntpServer-&gt;AddExtension(line);</span>
<a href="#l9.1911"></a><span id="l9.1911" class="difflineminus">-        }</span>
<a href="#l9.1912"></a><span id="l9.1912" class="difflineminus">-    else</span>
<a href="#l9.1913"></a><span id="l9.1913" class="difflineminus">-    {</span>
<a href="#l9.1914"></a><span id="l9.1914" class="difflineplus">+    if (!line) return rv; /* no line yet */</span>
<a href="#l9.1915"></a><span id="l9.1915" class="difflineplus">+</span>
<a href="#l9.1916"></a><span id="l9.1916" class="difflineplus">+    if ('.' != line[0]) {</span>
<a href="#l9.1917"></a><span id="l9.1917" class="difflineplus">+      m_nntpServer-&gt;AddExtension(line);</span>
<a href="#l9.1918"></a><span id="l9.1918" class="difflineplus">+    } else {</span>
<a href="#l9.1919"></a><span id="l9.1919">       /* tell libmsg that it's ok to ask this news host for extensions */</span>
<a href="#l9.1920"></a><span id="l9.1920">       m_nntpServer-&gt;SetSupportsExtensions(true);</span>
<a href="#l9.1921"></a><span id="l9.1921">       /* all extensions received */</span>
<a href="#l9.1922"></a><span id="l9.1922">       m_nextState = SEND_LIST_SEARCHES;</span>
<a href="#l9.1923"></a><span id="l9.1923">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1924"></a><span id="l9.1924">     }</span>
<a href="#l9.1925"></a><span id="l9.1925" class="difflineminus">-  }</span>
<a href="#l9.1926"></a><span id="l9.1926" class="difflineminus">-  else</span>
<a href="#l9.1927"></a><span id="l9.1927" class="difflineminus">-  {</span>
<a href="#l9.1928"></a><span id="l9.1928" class="difflineplus">+  } else {</span>
<a href="#l9.1929"></a><span id="l9.1929">     /* LIST EXTENSIONS not recognized</span>
<a href="#l9.1930"></a><span id="l9.1930">      * tell libmsg not to ask for any more extensions and move on to</span>
<a href="#l9.1931"></a><span id="l9.1931">      * the real NNTP command we were trying to do. */</span>
<a href="#l9.1932"></a><span id="l9.1932"> </span>
<a href="#l9.1933"></a><span id="l9.1933" class="difflineminus">-     m_nntpServer-&gt;SetSupportsExtensions(false);</span>
<a href="#l9.1934"></a><span id="l9.1934" class="difflineminus">-     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.1935"></a><span id="l9.1935" class="difflineplus">+    m_nntpServer-&gt;SetSupportsExtensions(false);</span>
<a href="#l9.1936"></a><span id="l9.1936" class="difflineplus">+    m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.1937"></a><span id="l9.1937">   }</span>
<a href="#l9.1938"></a><span id="l9.1938"> </span>
<a href="#l9.1939"></a><span id="l9.1939">   return NS_OK;</span>
<a href="#l9.1940"></a><span id="l9.1940"> }</span>
<a href="#l9.1941"></a><span id="l9.1941"> </span>
<a href="#l9.1942"></a><span id="l9.1942" class="difflineminus">-nsresult nsNNTPProtocol::SendListSearches()</span>
<a href="#l9.1943"></a><span id="l9.1943" class="difflineminus">-{</span>
<a href="#l9.1944"></a><span id="l9.1944" class="difflineminus">-    nsresult rv;</span>
<a href="#l9.1945"></a><span id="l9.1945" class="difflineminus">-    bool searchable=false;</span>
<a href="#l9.1946"></a><span id="l9.1946" class="difflineminus">-</span>
<a href="#l9.1947"></a><span id="l9.1947" class="difflineminus">-    rv = m_nntpServer-&gt;QueryExtension(&quot;SEARCH&quot;,&amp;searchable);</span>
<a href="#l9.1948"></a><span id="l9.1948" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; searchable)</span>
<a href="#l9.1949"></a><span id="l9.1949" class="difflineminus">-  {</span>
<a href="#l9.1950"></a><span id="l9.1950" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearches() {</span>
<a href="#l9.1951"></a><span id="l9.1951" class="difflineplus">+  nsresult rv;</span>
<a href="#l9.1952"></a><span id="l9.1952" class="difflineplus">+  bool searchable = false;</span>
<a href="#l9.1953"></a><span id="l9.1953" class="difflineplus">+</span>
<a href="#l9.1954"></a><span id="l9.1954" class="difflineplus">+  rv = m_nntpServer-&gt;QueryExtension(&quot;SEARCH&quot;, &amp;searchable);</span>
<a href="#l9.1955"></a><span id="l9.1955" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; searchable) {</span>
<a href="#l9.1956"></a><span id="l9.1956">     rv = SendData(NNTP_CMD_LIST_SEARCHES);</span>
<a href="#l9.1957"></a><span id="l9.1957"> </span>
<a href="#l9.1958"></a><span id="l9.1958">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.1959"></a><span id="l9.1959">     m_nextStateAfterResponse = SEND_LIST_SEARCHES_RESPONSE;</span>
<a href="#l9.1960"></a><span id="l9.1960">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1961"></a><span id="l9.1961" class="difflineminus">-  }</span>
<a href="#l9.1962"></a><span id="l9.1962" class="difflineminus">-  else</span>
<a href="#l9.1963"></a><span id="l9.1963" class="difflineminus">-  {</span>
<a href="#l9.1964"></a><span id="l9.1964" class="difflineplus">+  } else {</span>
<a href="#l9.1965"></a><span id="l9.1965">     /* since SEARCH isn't supported, move on to GET */</span>
<a href="#l9.1966"></a><span id="l9.1966">     m_nextState = NNTP_GET_PROPERTIES;</span>
<a href="#l9.1967"></a><span id="l9.1967">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1968"></a><span id="l9.1968">   }</span>
<a href="#l9.1969"></a><span id="l9.1969"> </span>
<a href="#l9.1970"></a><span id="l9.1970">   return rv;</span>
<a href="#l9.1971"></a><span id="l9.1971"> }</span>
<a href="#l9.1972"></a><span id="l9.1972"> </span>
<a href="#l9.1973"></a><span id="l9.1973" class="difflineminus">-nsresult nsNNTPProtocol::SendListSearchesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.1974"></a><span id="l9.1974" class="difflineminus">-{</span>
<a href="#l9.1975"></a><span id="l9.1975" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearchesResponse(nsIInputStream *inputStream,</span>
<a href="#l9.1976"></a><span id="l9.1976" class="difflineplus">+                                                  uint32_t length) {</span>
<a href="#l9.1977"></a><span id="l9.1977">   uint32_t status = 0;</span>
<a href="#l9.1978"></a><span id="l9.1978">   nsresult rv = NS_OK;</span>
<a href="#l9.1979"></a><span id="l9.1979"> </span>
<a href="#l9.1980"></a><span id="l9.1980">   NS_ASSERTION(inputStream, &quot;invalid input stream&quot;);</span>
<a href="#l9.1981"></a><span id="l9.1981"> </span>
<a href="#l9.1982"></a><span id="l9.1982">   bool pauseForMoreData = false;</span>
<a href="#l9.1983"></a><span id="l9.1983" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.1984"></a><span id="l9.1984" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.1985"></a><span id="l9.1985" class="difflineplus">+                                                pauseForMoreData, &amp;rv);</span>
<a href="#l9.1986"></a><span id="l9.1986"> </span>
<a href="#l9.1987"></a><span id="l9.1987">   NNTP_LOG_READ(line);</span>
<a href="#l9.1988"></a><span id="l9.1988"> </span>
<a href="#l9.1989"></a><span id="l9.1989" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.1990"></a><span id="l9.1990" class="difflineminus">-  {</span>
<a href="#l9.1991"></a><span id="l9.1991" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.1992"></a><span id="l9.1992">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.1993"></a><span id="l9.1993">     return NS_OK;</span>
<a href="#l9.1994"></a><span id="l9.1994">   }</span>
<a href="#l9.1995"></a><span id="l9.1995" class="difflineminus">-  if (!line)</span>
<a href="#l9.1996"></a><span id="l9.1996" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.1997"></a><span id="l9.1997" class="difflineminus">-</span>
<a href="#l9.1998"></a><span id="l9.1998" class="difflineminus">-  if ('.' != line[0])</span>
<a href="#l9.1999"></a><span id="l9.1999" class="difflineminus">-  {</span>
<a href="#l9.2000"></a><span id="l9.2000" class="difflineminus">-        nsAutoCString charset;</span>
<a href="#l9.2001"></a><span id="l9.2001" class="difflineminus">-        nsAutoString lineUtf16;</span>
<a href="#l9.2002"></a><span id="l9.2002" class="difflineminus">-        if (NS_FAILED(m_nntpServer-&gt;GetCharset(charset)) ||</span>
<a href="#l9.2003"></a><span id="l9.2003" class="difflineminus">-            NS_FAILED(nsMsgI18NConvertToUnicode(charset,</span>
<a href="#l9.2004"></a><span id="l9.2004" class="difflineminus">-                                                nsDependentCString(line),</span>
<a href="#l9.2005"></a><span id="l9.2005" class="difflineminus">-                                                lineUtf16)))</span>
<a href="#l9.2006"></a><span id="l9.2006" class="difflineminus">-            CopyUTF8toUTF16(nsDependentCString(line), lineUtf16);</span>
<a href="#l9.2007"></a><span id="l9.2007" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.2008"></a><span id="l9.2008" class="difflineplus">+</span>
<a href="#l9.2009"></a><span id="l9.2009" class="difflineplus">+  if ('.' != line[0]) {</span>
<a href="#l9.2010"></a><span id="l9.2010" class="difflineplus">+    nsAutoCString charset;</span>
<a href="#l9.2011"></a><span id="l9.2011" class="difflineplus">+    nsAutoString lineUtf16;</span>
<a href="#l9.2012"></a><span id="l9.2012" class="difflineplus">+    if (NS_FAILED(m_nntpServer-&gt;GetCharset(charset)) ||</span>
<a href="#l9.2013"></a><span id="l9.2013" class="difflineplus">+        NS_FAILED(nsMsgI18NConvertToUnicode(charset, nsDependentCString(line),</span>
<a href="#l9.2014"></a><span id="l9.2014" class="difflineplus">+                                            lineUtf16)))</span>
<a href="#l9.2015"></a><span id="l9.2015" class="difflineplus">+      CopyUTF8toUTF16(nsDependentCString(line), lineUtf16);</span>
<a href="#l9.2016"></a><span id="l9.2016"> </span>
<a href="#l9.2017"></a><span id="l9.2017">     m_nntpServer-&gt;AddSearchableGroup(lineUtf16);</span>
<a href="#l9.2018"></a><span id="l9.2018" class="difflineminus">-  }</span>
<a href="#l9.2019"></a><span id="l9.2019" class="difflineminus">-  else</span>
<a href="#l9.2020"></a><span id="l9.2020" class="difflineminus">-  {</span>
<a href="#l9.2021"></a><span id="l9.2021" class="difflineplus">+  } else {</span>
<a href="#l9.2022"></a><span id="l9.2022">     /* all searchable groups received */</span>
<a href="#l9.2023"></a><span id="l9.2023" class="difflineminus">-    /* LIST SRCHFIELDS is legal if the server supports the SEARCH extension, which */</span>
<a href="#l9.2024"></a><span id="l9.2024" class="difflineplus">+    /* LIST SRCHFIELDS is legal if the server supports the SEARCH extension,</span>
<a href="#l9.2025"></a><span id="l9.2025" class="difflineplus">+     * which */</span>
<a href="#l9.2026"></a><span id="l9.2026">     /* we already know it does */</span>
<a href="#l9.2027"></a><span id="l9.2027">     m_nextState = NNTP_LIST_SEARCH_HEADERS;</span>
<a href="#l9.2028"></a><span id="l9.2028">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2029"></a><span id="l9.2029">   }</span>
<a href="#l9.2030"></a><span id="l9.2030"> </span>
<a href="#l9.2031"></a><span id="l9.2031">   PR_FREEIF(line);</span>
<a href="#l9.2032"></a><span id="l9.2032">   return rv;</span>
<a href="#l9.2033"></a><span id="l9.2033"> }</span>
<a href="#l9.2034"></a><span id="l9.2034"> </span>
<a href="#l9.2035"></a><span id="l9.2035" class="difflineminus">-nsresult nsNNTPProtocol::SendListSearchHeaders()</span>
<a href="#l9.2036"></a><span id="l9.2036" class="difflineminus">-{</span>
<a href="#l9.2037"></a><span id="l9.2037" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearchHeaders() {</span>
<a href="#l9.2038"></a><span id="l9.2038">   nsresult rv = SendData(NNTP_CMD_LIST_SEARCH_FIELDS);</span>
<a href="#l9.2039"></a><span id="l9.2039"> </span>
<a href="#l9.2040"></a><span id="l9.2040">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2041"></a><span id="l9.2041">   m_nextStateAfterResponse = NNTP_LIST_SEARCH_HEADERS_RESPONSE;</span>
<a href="#l9.2042"></a><span id="l9.2042">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2043"></a><span id="l9.2043"> </span>
<a href="#l9.2044"></a><span id="l9.2044">   return rv;</span>
<a href="#l9.2045"></a><span id="l9.2045"> }</span>
<a href="#l9.2046"></a><span id="l9.2046"> </span>
<a href="#l9.2047"></a><span id="l9.2047" class="difflineminus">-nsresult nsNNTPProtocol::SendListSearchHeadersResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.2048"></a><span id="l9.2048" class="difflineminus">-{</span>
<a href="#l9.2049"></a><span id="l9.2049" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearchHeadersResponse(</span>
<a href="#l9.2050"></a><span id="l9.2050" class="difflineplus">+    nsIInputStream *inputStream, uint32_t length) {</span>
<a href="#l9.2051"></a><span id="l9.2051">   uint32_t status = 0;</span>
<a href="#l9.2052"></a><span id="l9.2052">   nsresult rv;</span>
<a href="#l9.2053"></a><span id="l9.2053"> </span>
<a href="#l9.2054"></a><span id="l9.2054">   bool pauseForMoreData = false;</span>
<a href="#l9.2055"></a><span id="l9.2055" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.2056"></a><span id="l9.2056" class="difflineminus">-</span>
<a href="#l9.2057"></a><span id="l9.2057" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.2058"></a><span id="l9.2058" class="difflineminus">-  {</span>
<a href="#l9.2059"></a><span id="l9.2059" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.2060"></a><span id="l9.2060" class="difflineplus">+                                                pauseForMoreData, &amp;rv);</span>
<a href="#l9.2061"></a><span id="l9.2061" class="difflineplus">+</span>
<a href="#l9.2062"></a><span id="l9.2062" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.2063"></a><span id="l9.2063">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2064"></a><span id="l9.2064">     return NS_OK;</span>
<a href="#l9.2065"></a><span id="l9.2065">   }</span>
<a href="#l9.2066"></a><span id="l9.2066" class="difflineminus">-  if (!line)</span>
<a href="#l9.2067"></a><span id="l9.2067" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.2068"></a><span id="l9.2068" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.2069"></a><span id="l9.2069"> </span>
<a href="#l9.2070"></a><span id="l9.2070">   if ('.' != line[0])</span>
<a href="#l9.2071"></a><span id="l9.2071" class="difflineminus">-        m_nntpServer-&gt;AddSearchableHeader(line);</span>
<a href="#l9.2072"></a><span id="l9.2072" class="difflineminus">-  else</span>
<a href="#l9.2073"></a><span id="l9.2073" class="difflineminus">-  {</span>
<a href="#l9.2074"></a><span id="l9.2074" class="difflineplus">+    m_nntpServer-&gt;AddSearchableHeader(line);</span>
<a href="#l9.2075"></a><span id="l9.2075" class="difflineplus">+  else {</span>
<a href="#l9.2076"></a><span id="l9.2076">     m_nextState = NNTP_GET_PROPERTIES;</span>
<a href="#l9.2077"></a><span id="l9.2077">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2078"></a><span id="l9.2078">   }</span>
<a href="#l9.2079"></a><span id="l9.2079"> </span>
<a href="#l9.2080"></a><span id="l9.2080">   PR_FREEIF(line);</span>
<a href="#l9.2081"></a><span id="l9.2081">   return rv;</span>
<a href="#l9.2082"></a><span id="l9.2082"> }</span>
<a href="#l9.2083"></a><span id="l9.2083"> </span>
<a href="#l9.2084"></a><span id="l9.2084" class="difflineminus">-nsresult nsNNTPProtocol::GetProperties()</span>
<a href="#l9.2085"></a><span id="l9.2085" class="difflineminus">-{</span>
<a href="#l9.2086"></a><span id="l9.2086" class="difflineminus">-    nsresult rv;</span>
<a href="#l9.2087"></a><span id="l9.2087" class="difflineminus">-    bool setget=false;</span>
<a href="#l9.2088"></a><span id="l9.2088" class="difflineminus">-</span>
<a href="#l9.2089"></a><span id="l9.2089" class="difflineminus">-    rv = m_nntpServer-&gt;QueryExtension(&quot;SETGET&quot;,&amp;setget);</span>
<a href="#l9.2090"></a><span id="l9.2090" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; setget)</span>
<a href="#l9.2091"></a><span id="l9.2091" class="difflineminus">-  {</span>
<a href="#l9.2092"></a><span id="l9.2092" class="difflineplus">+nsresult nsNNTPProtocol::GetProperties() {</span>
<a href="#l9.2093"></a><span id="l9.2093" class="difflineplus">+  nsresult rv;</span>
<a href="#l9.2094"></a><span id="l9.2094" class="difflineplus">+  bool setget = false;</span>
<a href="#l9.2095"></a><span id="l9.2095" class="difflineplus">+</span>
<a href="#l9.2096"></a><span id="l9.2096" class="difflineplus">+  rv = m_nntpServer-&gt;QueryExtension(&quot;SETGET&quot;, &amp;setget);</span>
<a href="#l9.2097"></a><span id="l9.2097" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; setget) {</span>
<a href="#l9.2098"></a><span id="l9.2098">     rv = SendData(NNTP_CMD_GET_PROPERTIES);</span>
<a href="#l9.2099"></a><span id="l9.2099">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2100"></a><span id="l9.2100">     m_nextStateAfterResponse = NNTP_GET_PROPERTIES_RESPONSE;</span>
<a href="#l9.2101"></a><span id="l9.2101">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2102"></a><span id="l9.2102" class="difflineminus">-  }</span>
<a href="#l9.2103"></a><span id="l9.2103" class="difflineminus">-  else</span>
<a href="#l9.2104"></a><span id="l9.2104" class="difflineminus">-  {</span>
<a href="#l9.2105"></a><span id="l9.2105" class="difflineplus">+  } else {</span>
<a href="#l9.2106"></a><span id="l9.2106">     /* since GET isn't supported, move on LIST SUBSCRIPTIONS */</span>
<a href="#l9.2107"></a><span id="l9.2107">     m_nextState = SEND_LIST_SUBSCRIPTIONS;</span>
<a href="#l9.2108"></a><span id="l9.2108">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2109"></a><span id="l9.2109">   }</span>
<a href="#l9.2110"></a><span id="l9.2110">   return rv;</span>
<a href="#l9.2111"></a><span id="l9.2111"> }</span>
<a href="#l9.2112"></a><span id="l9.2112"> </span>
<a href="#l9.2113"></a><span id="l9.2113" class="difflineminus">-nsresult nsNNTPProtocol::GetPropertiesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.2114"></a><span id="l9.2114" class="difflineminus">-{</span>
<a href="#l9.2115"></a><span id="l9.2115" class="difflineplus">+nsresult nsNNTPProtocol::GetPropertiesResponse(nsIInputStream *inputStream,</span>
<a href="#l9.2116"></a><span id="l9.2116" class="difflineplus">+                                               uint32_t length) {</span>
<a href="#l9.2117"></a><span id="l9.2117">   uint32_t status = 0;</span>
<a href="#l9.2118"></a><span id="l9.2118">   nsresult rv;</span>
<a href="#l9.2119"></a><span id="l9.2119"> </span>
<a href="#l9.2120"></a><span id="l9.2120">   bool pauseForMoreData = false;</span>
<a href="#l9.2121"></a><span id="l9.2121" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.2122"></a><span id="l9.2122" class="difflineminus">-</span>
<a href="#l9.2123"></a><span id="l9.2123" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.2124"></a><span id="l9.2124" class="difflineminus">-  {</span>
<a href="#l9.2125"></a><span id="l9.2125" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.2126"></a><span id="l9.2126" class="difflineplus">+                                                pauseForMoreData, &amp;rv);</span>
<a href="#l9.2127"></a><span id="l9.2127" class="difflineplus">+</span>
<a href="#l9.2128"></a><span id="l9.2128" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.2129"></a><span id="l9.2129">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2130"></a><span id="l9.2130">     return NS_OK;</span>
<a href="#l9.2131"></a><span id="l9.2131">   }</span>
<a href="#l9.2132"></a><span id="l9.2132" class="difflineminus">-  if (!line)</span>
<a href="#l9.2133"></a><span id="l9.2133" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.2134"></a><span id="l9.2134" class="difflineminus">-</span>
<a href="#l9.2135"></a><span id="l9.2135" class="difflineminus">-  if ('.' != line[0])</span>
<a href="#l9.2136"></a><span id="l9.2136" class="difflineminus">-  {</span>
<a href="#l9.2137"></a><span id="l9.2137" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.2138"></a><span id="l9.2138" class="difflineplus">+</span>
<a href="#l9.2139"></a><span id="l9.2139" class="difflineplus">+  if ('.' != line[0]) {</span>
<a href="#l9.2140"></a><span id="l9.2140">     char *propertyName = NS_xstrdup(line);</span>
<a href="#l9.2141"></a><span id="l9.2141" class="difflineminus">-    if (propertyName)</span>
<a href="#l9.2142"></a><span id="l9.2142" class="difflineminus">-    {</span>
<a href="#l9.2143"></a><span id="l9.2143" class="difflineplus">+    if (propertyName) {</span>
<a href="#l9.2144"></a><span id="l9.2144">       char *space = PL_strchr(propertyName, ' ');</span>
<a href="#l9.2145"></a><span id="l9.2145" class="difflineminus">-      if (space)</span>
<a href="#l9.2146"></a><span id="l9.2146" class="difflineminus">-      {</span>
<a href="#l9.2147"></a><span id="l9.2147" class="difflineplus">+      if (space) {</span>
<a href="#l9.2148"></a><span id="l9.2148">         char *propertyValue = space + 1;</span>
<a href="#l9.2149"></a><span id="l9.2149">         *space = '\0';</span>
<a href="#l9.2150"></a><span id="l9.2150" class="difflineminus">-                m_nntpServer-&gt;AddPropertyForGet(propertyName, propertyValue);</span>
<a href="#l9.2151"></a><span id="l9.2151" class="difflineplus">+        m_nntpServer-&gt;AddPropertyForGet(propertyName, propertyValue);</span>
<a href="#l9.2152"></a><span id="l9.2152">       }</span>
<a href="#l9.2153"></a><span id="l9.2153">       PR_Free(propertyName);</span>
<a href="#l9.2154"></a><span id="l9.2154">     }</span>
<a href="#l9.2155"></a><span id="l9.2155" class="difflineminus">-  }</span>
<a href="#l9.2156"></a><span id="l9.2156" class="difflineminus">-  else</span>
<a href="#l9.2157"></a><span id="l9.2157" class="difflineminus">-  {</span>
<a href="#l9.2158"></a><span id="l9.2158" class="difflineplus">+  } else {</span>
<a href="#l9.2159"></a><span id="l9.2159">     /* all GET properties received, move on to LIST SUBSCRIPTIONS */</span>
<a href="#l9.2160"></a><span id="l9.2160">     m_nextState = SEND_LIST_SUBSCRIPTIONS;</span>
<a href="#l9.2161"></a><span id="l9.2161">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2162"></a><span id="l9.2162">   }</span>
<a href="#l9.2163"></a><span id="l9.2163"> </span>
<a href="#l9.2164"></a><span id="l9.2164">   PR_FREEIF(line);</span>
<a href="#l9.2165"></a><span id="l9.2165">   return rv;</span>
<a href="#l9.2166"></a><span id="l9.2166"> }</span>
<a href="#l9.2167"></a><span id="l9.2167"> </span>
<a href="#l9.2168"></a><span id="l9.2168" class="difflineminus">-nsresult nsNNTPProtocol::SendListSubscriptions()</span>
<a href="#l9.2169"></a><span id="l9.2169" class="difflineminus">-{</span>
<a href="#l9.2170"></a><span id="l9.2170" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l9.2171"></a><span id="l9.2171" class="difflineminus">-/* TODO: is this needed for anything?</span>
<a href="#l9.2172"></a><span id="l9.2172" class="difflineminus">-#if 0</span>
<a href="#l9.2173"></a><span id="l9.2173" class="difflineminus">-    bool searchable=false;</span>
<a href="#l9.2174"></a><span id="l9.2174" class="difflineminus">-    rv = m_nntpServer-&gt;QueryExtension(&quot;LISTSUBSCR&quot;,&amp;listsubscr);</span>
<a href="#l9.2175"></a><span id="l9.2175" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; listsubscr)</span>
<a href="#l9.2176"></a><span id="l9.2176" class="difflineminus">-#else</span>
<a href="#l9.2177"></a><span id="l9.2177" class="difflineminus">-  if (0)</span>
<a href="#l9.2178"></a><span id="l9.2178" class="difflineminus">-#endif</span>
<a href="#l9.2179"></a><span id="l9.2179" class="difflineminus">-  {</span>
<a href="#l9.2180"></a><span id="l9.2180" class="difflineminus">-    rv = SendData(NNTP_CMD_LIST_SUBSCRIPTIONS);</span>
<a href="#l9.2181"></a><span id="l9.2181" class="difflineminus">-    m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2182"></a><span id="l9.2182" class="difflineminus">-    m_nextStateAfterResponse = SEND_LIST_SUBSCRIPTIONS_RESPONSE;</span>
<a href="#l9.2183"></a><span id="l9.2183" class="difflineminus">-    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2184"></a><span id="l9.2184" class="difflineminus">-  }</span>
<a href="#l9.2185"></a><span id="l9.2185" class="difflineminus">-  else</span>
<a href="#l9.2186"></a><span id="l9.2186" class="difflineminus">-*/</span>
<a href="#l9.2187"></a><span id="l9.2187" class="difflineplus">+nsresult nsNNTPProtocol::SendListSubscriptions() {</span>
<a href="#l9.2188"></a><span id="l9.2188" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l9.2189"></a><span id="l9.2189" class="difflineplus">+  /* TODO: is this needed for anything?</span>
<a href="#l9.2190"></a><span id="l9.2190" class="difflineplus">+  #if 0</span>
<a href="#l9.2191"></a><span id="l9.2191" class="difflineplus">+      bool searchable=false;</span>
<a href="#l9.2192"></a><span id="l9.2192" class="difflineplus">+      rv = m_nntpServer-&gt;QueryExtension(&quot;LISTSUBSCR&quot;,&amp;listsubscr);</span>
<a href="#l9.2193"></a><span id="l9.2193" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; listsubscr)</span>
<a href="#l9.2194"></a><span id="l9.2194" class="difflineplus">+  #else</span>
<a href="#l9.2195"></a><span id="l9.2195" class="difflineplus">+    if (0)</span>
<a href="#l9.2196"></a><span id="l9.2196" class="difflineplus">+  #endif</span>
<a href="#l9.2197"></a><span id="l9.2197" class="difflineplus">+    {</span>
<a href="#l9.2198"></a><span id="l9.2198" class="difflineplus">+      rv = SendData(NNTP_CMD_LIST_SUBSCRIPTIONS);</span>
<a href="#l9.2199"></a><span id="l9.2199" class="difflineplus">+      m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2200"></a><span id="l9.2200" class="difflineplus">+      m_nextStateAfterResponse = SEND_LIST_SUBSCRIPTIONS_RESPONSE;</span>
<a href="#l9.2201"></a><span id="l9.2201" class="difflineplus">+      SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2202"></a><span id="l9.2202" class="difflineplus">+    }</span>
<a href="#l9.2203"></a><span id="l9.2203" class="difflineplus">+    else</span>
<a href="#l9.2204"></a><span id="l9.2204" class="difflineplus">+  */</span>
<a href="#l9.2205"></a><span id="l9.2205">   {</span>
<a href="#l9.2206"></a><span id="l9.2206">     /* since LIST SUBSCRIPTIONS isn't supported, move on to real work */</span>
<a href="#l9.2207"></a><span id="l9.2207">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.2208"></a><span id="l9.2208">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2209"></a><span id="l9.2209">   }</span>
<a href="#l9.2210"></a><span id="l9.2210"> </span>
<a href="#l9.2211"></a><span id="l9.2211">   return rv;</span>
<a href="#l9.2212"></a><span id="l9.2212"> }</span>
<a href="#l9.2213"></a><span id="l9.2213"> </span>
<a href="#l9.2214"></a><span id="l9.2214" class="difflineminus">-nsresult nsNNTPProtocol::SendListSubscriptionsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.2215"></a><span id="l9.2215" class="difflineminus">-{</span>
<a href="#l9.2216"></a><span id="l9.2216" class="difflineplus">+nsresult nsNNTPProtocol::SendListSubscriptionsResponse(</span>
<a href="#l9.2217"></a><span id="l9.2217" class="difflineplus">+    nsIInputStream *inputStream, uint32_t length) {</span>
<a href="#l9.2218"></a><span id="l9.2218">   uint32_t status = 0;</span>
<a href="#l9.2219"></a><span id="l9.2219">   nsresult rv;</span>
<a href="#l9.2220"></a><span id="l9.2220"> </span>
<a href="#l9.2221"></a><span id="l9.2221">   bool pauseForMoreData = false;</span>
<a href="#l9.2222"></a><span id="l9.2222" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.2223"></a><span id="l9.2223" class="difflineminus">-</span>
<a href="#l9.2224"></a><span id="l9.2224" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.2225"></a><span id="l9.2225" class="difflineminus">-  {</span>
<a href="#l9.2226"></a><span id="l9.2226" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.2227"></a><span id="l9.2227" class="difflineplus">+                                                pauseForMoreData, &amp;rv);</span>
<a href="#l9.2228"></a><span id="l9.2228" class="difflineplus">+</span>
<a href="#l9.2229"></a><span id="l9.2229" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.2230"></a><span id="l9.2230">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2231"></a><span id="l9.2231">     return NS_OK;</span>
<a href="#l9.2232"></a><span id="l9.2232">   }</span>
<a href="#l9.2233"></a><span id="l9.2233" class="difflineminus">-  if (!line)</span>
<a href="#l9.2234"></a><span id="l9.2234" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.2235"></a><span id="l9.2235" class="difflineminus">-</span>
<a href="#l9.2236"></a><span id="l9.2236" class="difflineminus">-  if ('.' != line[0])</span>
<a href="#l9.2237"></a><span id="l9.2237" class="difflineminus">-  {</span>
<a href="#l9.2238"></a><span id="l9.2238" class="difflineminus">-        NS_ERROR(&quot;fix me&quot;);</span>
<a href="#l9.2239"></a><span id="l9.2239" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.2240"></a><span id="l9.2240" class="difflineplus">+</span>
<a href="#l9.2241"></a><span id="l9.2241" class="difflineplus">+  if ('.' != line[0]) {</span>
<a href="#l9.2242"></a><span id="l9.2242" class="difflineplus">+    NS_ERROR(&quot;fix me&quot;);</span>
<a href="#l9.2243"></a><span id="l9.2243"> #if 0</span>
<a href="#l9.2244"></a><span id="l9.2244">     char *url = PR_smprintf (&quot;%s//%s/%s&quot;, NEWS_SCHEME, m_hostName, line);</span>
<a href="#l9.2245"></a><span id="l9.2245">     if (url)</span>
<a href="#l9.2246"></a><span id="l9.2246">       MSG_AddSubscribedNewsgroup (cd-&gt;pane, url);</span>
<a href="#l9.2247"></a><span id="l9.2247"> #endif</span>
<a href="#l9.2248"></a><span id="l9.2248" class="difflineminus">-  }</span>
<a href="#l9.2249"></a><span id="l9.2249" class="difflineminus">-  else</span>
<a href="#l9.2250"></a><span id="l9.2250" class="difflineminus">-  {</span>
<a href="#l9.2251"></a><span id="l9.2251" class="difflineplus">+  } else {</span>
<a href="#l9.2252"></a><span id="l9.2252">     /* all default subscriptions received */</span>
<a href="#l9.2253"></a><span id="l9.2253">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.2254"></a><span id="l9.2254">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2255"></a><span id="l9.2255">   }</span>
<a href="#l9.2256"></a><span id="l9.2256"> </span>
<a href="#l9.2257"></a><span id="l9.2257">   PR_FREEIF(line);</span>
<a href="#l9.2258"></a><span id="l9.2258">   return rv;</span>
<a href="#l9.2259"></a><span id="l9.2259"> }</span>
<a href="#l9.2260"></a><span id="l9.2260"> </span>
<a href="#l9.2261"></a><span id="l9.2261"> /* figure out what the first command is and send it</span>
<a href="#l9.2262"></a><span id="l9.2262">  *</span>
<a href="#l9.2263"></a><span id="l9.2263">  * returns the status from the NETWrite */</span>
<a href="#l9.2264"></a><span id="l9.2264"> </span>
<a href="#l9.2265"></a><span id="l9.2265" class="difflineminus">-nsresult nsNNTPProtocol::SendFirstNNTPCommand(nsIURI * url)</span>
<a href="#l9.2266"></a><span id="l9.2266" class="difflineminus">-{</span>
<a href="#l9.2267"></a><span id="l9.2267" class="difflineminus">-    char *command=0;</span>
<a href="#l9.2268"></a><span id="l9.2268" class="difflineminus">-</span>
<a href="#l9.2269"></a><span id="l9.2269" class="difflineminus">-    if (m_typeWanted == ARTICLE_WANTED) {</span>
<a href="#l9.2270"></a><span id="l9.2270" class="difflineminus">-        if (m_key != nsMsgKey_None) {</span>
<a href="#l9.2271"></a><span id="l9.2271" class="difflineminus">-            nsresult rv;</span>
<a href="#l9.2272"></a><span id="l9.2272" class="difflineminus">-            nsCString newsgroupName;</span>
<a href="#l9.2273"></a><span id="l9.2273" class="difflineminus">-            if (m_newsFolder) {</span>
<a href="#l9.2274"></a><span id="l9.2274" class="difflineminus">-                rv = m_newsFolder-&gt;GetRawName(newsgroupName);</span>
<a href="#l9.2275"></a><span id="l9.2275" class="difflineminus">-                NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.2276"></a><span id="l9.2276" class="difflineminus">-            }</span>
<a href="#l9.2277"></a><span id="l9.2277" class="difflineminus">-            MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.2278"></a><span id="l9.2278" class="difflineminus">-                   (&quot;(%p) current group = %s, desired group = %s&quot;, this,</span>
<a href="#l9.2279"></a><span id="l9.2279" class="difflineminus">-                   m_currentGroup.get(), newsgroupName.get()));</span>
<a href="#l9.2280"></a><span id="l9.2280" class="difflineminus">-            // if the current group is the desired group, we can just issue the ARTICLE command</span>
<a href="#l9.2281"></a><span id="l9.2281" class="difflineminus">-            // if not, we have to do a GROUP first</span>
<a href="#l9.2282"></a><span id="l9.2282" class="difflineminus">-            if (newsgroupName.Equals(m_currentGroup))</span>
<a href="#l9.2283"></a><span id="l9.2283" class="difflineminus">-              m_nextState = NNTP_SEND_ARTICLE_NUMBER;</span>
<a href="#l9.2284"></a><span id="l9.2284" class="difflineminus">-            else</span>
<a href="#l9.2285"></a><span id="l9.2285" class="difflineminus">-              m_nextState = NNTP_SEND_GROUP_FOR_ARTICLE;</span>
<a href="#l9.2286"></a><span id="l9.2286" class="difflineminus">-</span>
<a href="#l9.2287"></a><span id="l9.2287" class="difflineminus">-            ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2288"></a><span id="l9.2288" class="difflineminus">-            return NS_OK;</span>
<a href="#l9.2289"></a><span id="l9.2289" class="difflineminus">-        }</span>
<a href="#l9.2290"></a><span id="l9.2290" class="difflineminus">-    }</span>
<a href="#l9.2291"></a><span id="l9.2291" class="difflineminus">-</span>
<a href="#l9.2292"></a><span id="l9.2292" class="difflineminus">-    if(m_typeWanted == NEWS_POST)</span>
<a href="#l9.2293"></a><span id="l9.2293" class="difflineminus">-    {  /* posting to the news group */</span>
<a href="#l9.2294"></a><span id="l9.2294" class="difflineminus">-        NS_MsgSACopy(&amp;command, &quot;POST&quot;);</span>
<a href="#l9.2295"></a><span id="l9.2295" class="difflineplus">+nsresult nsNNTPProtocol::SendFirstNNTPCommand(nsIURI *url) {</span>
<a href="#l9.2296"></a><span id="l9.2296" class="difflineplus">+  char *command = 0;</span>
<a href="#l9.2297"></a><span id="l9.2297" class="difflineplus">+</span>
<a href="#l9.2298"></a><span id="l9.2298" class="difflineplus">+  if (m_typeWanted == ARTICLE_WANTED) {</span>
<a href="#l9.2299"></a><span id="l9.2299" class="difflineplus">+    if (m_key != nsMsgKey_None) {</span>
<a href="#l9.2300"></a><span id="l9.2300" class="difflineplus">+      nsresult rv;</span>
<a href="#l9.2301"></a><span id="l9.2301" class="difflineplus">+      nsCString newsgroupName;</span>
<a href="#l9.2302"></a><span id="l9.2302" class="difflineplus">+      if (m_newsFolder) {</span>
<a href="#l9.2303"></a><span id="l9.2303" class="difflineplus">+        rv = m_newsFolder-&gt;GetRawName(newsgroupName);</span>
<a href="#l9.2304"></a><span id="l9.2304" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2305"></a><span id="l9.2305" class="difflineplus">+      }</span>
<a href="#l9.2306"></a><span id="l9.2306" class="difflineplus">+      MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.2307"></a><span id="l9.2307" class="difflineplus">+              (&quot;(%p) current group = %s, desired group = %s&quot;, this,</span>
<a href="#l9.2308"></a><span id="l9.2308" class="difflineplus">+               m_currentGroup.get(), newsgroupName.get()));</span>
<a href="#l9.2309"></a><span id="l9.2309" class="difflineplus">+      // if the current group is the desired group, we can just issue the</span>
<a href="#l9.2310"></a><span id="l9.2310" class="difflineplus">+      // ARTICLE command if not, we have to do a GROUP first</span>
<a href="#l9.2311"></a><span id="l9.2311" class="difflineplus">+      if (newsgroupName.Equals(m_currentGroup))</span>
<a href="#l9.2312"></a><span id="l9.2312" class="difflineplus">+        m_nextState = NNTP_SEND_ARTICLE_NUMBER;</span>
<a href="#l9.2313"></a><span id="l9.2313" class="difflineplus">+      else</span>
<a href="#l9.2314"></a><span id="l9.2314" class="difflineplus">+        m_nextState = NNTP_SEND_GROUP_FOR_ARTICLE;</span>
<a href="#l9.2315"></a><span id="l9.2315" class="difflineplus">+</span>
<a href="#l9.2316"></a><span id="l9.2316" class="difflineplus">+      ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2317"></a><span id="l9.2317" class="difflineplus">+      return NS_OK;</span>
<a href="#l9.2318"></a><span id="l9.2318">     }</span>
<a href="#l9.2319"></a><span id="l9.2319" class="difflineminus">-  else if (m_typeWanted == NEW_GROUPS)</span>
<a href="#l9.2320"></a><span id="l9.2320" class="difflineminus">-  {</span>
<a href="#l9.2321"></a><span id="l9.2321" class="difflineminus">-      uint32_t last_update;</span>
<a href="#l9.2322"></a><span id="l9.2322" class="difflineminus">-      nsresult rv;</span>
<a href="#l9.2323"></a><span id="l9.2323" class="difflineminus">-</span>
<a href="#l9.2324"></a><span id="l9.2324" class="difflineminus">-      if (!m_nntpServer)</span>
<a href="#l9.2325"></a><span id="l9.2325" class="difflineminus">-      {</span>
<a href="#l9.2326"></a><span id="l9.2326" class="difflineminus">-        NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l9.2327"></a><span id="l9.2327" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l9.2328"></a><span id="l9.2328" class="difflineminus">-      }</span>
<a href="#l9.2329"></a><span id="l9.2329" class="difflineminus">-      rv = m_nntpServer-&gt;GetLastUpdatedTime(&amp;last_update);</span>
<a href="#l9.2330"></a><span id="l9.2330" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2331"></a><span id="l9.2331" class="difflineminus">-</span>
<a href="#l9.2332"></a><span id="l9.2332" class="difflineminus">-      if (!last_update)</span>
<a href="#l9.2333"></a><span id="l9.2333" class="difflineminus">-    {</span>
<a href="#l9.2334"></a><span id="l9.2334" class="difflineminus">-        NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l9.2335"></a><span id="l9.2335" class="difflineminus">-      }</span>
<a href="#l9.2336"></a><span id="l9.2336" class="difflineminus">-    else</span>
<a href="#l9.2337"></a><span id="l9.2337" class="difflineminus">-      {</span>
<a href="#l9.2338"></a><span id="l9.2338" class="difflineminus">-        char small_buf[64];</span>
<a href="#l9.2339"></a><span id="l9.2339" class="difflineminus">-        PRExplodedTime  expandedTime;</span>
<a href="#l9.2340"></a><span id="l9.2340" class="difflineminus">-        PRTime t_usec = (PRTime)last_update * PR_USEC_PER_SEC;</span>
<a href="#l9.2341"></a><span id="l9.2341" class="difflineminus">-        PR_ExplodeTime(t_usec, PR_LocalTimeParameters, &amp;expandedTime);</span>
<a href="#l9.2342"></a><span id="l9.2342" class="difflineminus">-        PR_FormatTimeUSEnglish(small_buf, sizeof(small_buf),</span>
<a href="#l9.2343"></a><span id="l9.2343" class="difflineminus">-                               &quot;NEWGROUPS %y%m%d %H%M%S&quot;, &amp;expandedTime);</span>
<a href="#l9.2344"></a><span id="l9.2344" class="difflineminus">-        NS_MsgSACopy(&amp;command, small_buf);</span>
<a href="#l9.2345"></a><span id="l9.2345" class="difflineminus">-      }</span>
<a href="#l9.2346"></a><span id="l9.2346">   }</span>
<a href="#l9.2347"></a><span id="l9.2347" class="difflineminus">-    else if(m_typeWanted == LIST_WANTED)</span>
<a href="#l9.2348"></a><span id="l9.2348" class="difflineminus">-    {</span>
<a href="#l9.2349"></a><span id="l9.2349" class="difflineminus">-      nsresult rv;</span>
<a href="#l9.2350"></a><span id="l9.2350" class="difflineplus">+</span>
<a href="#l9.2351"></a><span id="l9.2351" class="difflineplus">+  if (m_typeWanted == NEWS_POST) { /* posting to the news group */</span>
<a href="#l9.2352"></a><span id="l9.2352" class="difflineplus">+    NS_MsgSACopy(&amp;command, &quot;POST&quot;);</span>
<a href="#l9.2353"></a><span id="l9.2353" class="difflineplus">+  } else if (m_typeWanted == NEW_GROUPS) {</span>
<a href="#l9.2354"></a><span id="l9.2354" class="difflineplus">+    uint32_t last_update;</span>
<a href="#l9.2355"></a><span id="l9.2355" class="difflineplus">+    nsresult rv;</span>
<a href="#l9.2356"></a><span id="l9.2356" class="difflineplus">+</span>
<a href="#l9.2357"></a><span id="l9.2357" class="difflineplus">+    if (!m_nntpServer) {</span>
<a href="#l9.2358"></a><span id="l9.2358" class="difflineplus">+      NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l9.2359"></a><span id="l9.2359" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l9.2360"></a><span id="l9.2360" class="difflineplus">+    }</span>
<a href="#l9.2361"></a><span id="l9.2361" class="difflineplus">+    rv = m_nntpServer-&gt;GetLastUpdatedTime(&amp;last_update);</span>
<a href="#l9.2362"></a><span id="l9.2362" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2363"></a><span id="l9.2363" class="difflineplus">+</span>
<a href="#l9.2364"></a><span id="l9.2364" class="difflineplus">+    if (!last_update) {</span>
<a href="#l9.2365"></a><span id="l9.2365" class="difflineplus">+      NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l9.2366"></a><span id="l9.2366" class="difflineplus">+    } else {</span>
<a href="#l9.2367"></a><span id="l9.2367" class="difflineplus">+      char small_buf[64];</span>
<a href="#l9.2368"></a><span id="l9.2368" class="difflineplus">+      PRExplodedTime expandedTime;</span>
<a href="#l9.2369"></a><span id="l9.2369" class="difflineplus">+      PRTime t_usec = (PRTime)last_update * PR_USEC_PER_SEC;</span>
<a href="#l9.2370"></a><span id="l9.2370" class="difflineplus">+      PR_ExplodeTime(t_usec, PR_LocalTimeParameters, &amp;expandedTime);</span>
<a href="#l9.2371"></a><span id="l9.2371" class="difflineplus">+      PR_FormatTimeUSEnglish(small_buf, sizeof(small_buf),</span>
<a href="#l9.2372"></a><span id="l9.2372" class="difflineplus">+                             &quot;NEWGROUPS %y%m%d %H%M%S&quot;, &amp;expandedTime);</span>
<a href="#l9.2373"></a><span id="l9.2373" class="difflineplus">+      NS_MsgSACopy(&amp;command, small_buf);</span>
<a href="#l9.2374"></a><span id="l9.2374" class="difflineplus">+    }</span>
<a href="#l9.2375"></a><span id="l9.2375" class="difflineplus">+  } else if (m_typeWanted == LIST_WANTED) {</span>
<a href="#l9.2376"></a><span id="l9.2376" class="difflineplus">+    nsresult rv;</span>
<a href="#l9.2377"></a><span id="l9.2377"> </span>
<a href="#l9.2378"></a><span id="l9.2378">     ClearFlag(NNTP_USE_FANCY_NEWSGROUP);</span>
<a href="#l9.2379"></a><span id="l9.2379"> </span>
<a href="#l9.2380"></a><span id="l9.2380" class="difflineminus">-        NS_ASSERTION(m_nntpServer, &quot;no m_nntpServer&quot;);</span>
<a href="#l9.2381"></a><span id="l9.2381" class="difflineplus">+    NS_ASSERTION(m_nntpServer, &quot;no m_nntpServer&quot;);</span>
<a href="#l9.2382"></a><span id="l9.2382">     if (!m_nntpServer) {</span>
<a href="#l9.2383"></a><span id="l9.2383" class="difflineminus">-          NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l9.2384"></a><span id="l9.2384" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l9.2385"></a><span id="l9.2385" class="difflineplus">+      NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l9.2386"></a><span id="l9.2386" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l9.2387"></a><span id="l9.2387" class="difflineplus">+    }</span>
<a href="#l9.2388"></a><span id="l9.2388" class="difflineplus">+</span>
<a href="#l9.2389"></a><span id="l9.2389" class="difflineplus">+    bool xactive = false;</span>
<a href="#l9.2390"></a><span id="l9.2390" class="difflineplus">+    rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;, &amp;xactive);</span>
<a href="#l9.2391"></a><span id="l9.2391" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; xactive) {</span>
<a href="#l9.2392"></a><span id="l9.2392" class="difflineplus">+      NS_MsgSACopy(&amp;command, &quot;LIST XACTIVE&quot;);</span>
<a href="#l9.2393"></a><span id="l9.2393" class="difflineplus">+      SetFlag(NNTP_USE_FANCY_NEWSGROUP);</span>
<a href="#l9.2394"></a><span id="l9.2394" class="difflineplus">+    } else {</span>
<a href="#l9.2395"></a><span id="l9.2395" class="difflineplus">+      NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l9.2396"></a><span id="l9.2396">     }</span>
<a href="#l9.2397"></a><span id="l9.2397" class="difflineminus">-</span>
<a href="#l9.2398"></a><span id="l9.2398" class="difflineminus">-      bool xactive=false;</span>
<a href="#l9.2399"></a><span id="l9.2399" class="difflineminus">-      rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l9.2400"></a><span id="l9.2400" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l9.2401"></a><span id="l9.2401" class="difflineminus">-      {</span>
<a href="#l9.2402"></a><span id="l9.2402" class="difflineminus">-        NS_MsgSACopy(&amp;command, &quot;LIST XACTIVE&quot;);</span>
<a href="#l9.2403"></a><span id="l9.2403" class="difflineminus">-        SetFlag(NNTP_USE_FANCY_NEWSGROUP);</span>
<a href="#l9.2404"></a><span id="l9.2404" class="difflineminus">-      }</span>
<a href="#l9.2405"></a><span id="l9.2405" class="difflineminus">-      else</span>
<a href="#l9.2406"></a><span id="l9.2406" class="difflineminus">-      {</span>
<a href="#l9.2407"></a><span id="l9.2407" class="difflineminus">-        NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l9.2408"></a><span id="l9.2408" class="difflineminus">-      }</span>
<a href="#l9.2409"></a><span id="l9.2409" class="difflineminus">-  }</span>
<a href="#l9.2410"></a><span id="l9.2410" class="difflineminus">-  else if(m_typeWanted == GROUP_WANTED)</span>
<a href="#l9.2411"></a><span id="l9.2411" class="difflineminus">-    {</span>
<a href="#l9.2412"></a><span id="l9.2412" class="difflineminus">-        nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l9.2413"></a><span id="l9.2413" class="difflineminus">-</span>
<a href="#l9.2414"></a><span id="l9.2414" class="difflineminus">-        NS_ASSERTION(m_newsFolder, &quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l9.2415"></a><span id="l9.2415" class="difflineminus">-        if (!m_newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l9.2416"></a><span id="l9.2416" class="difflineminus">-</span>
<a href="#l9.2417"></a><span id="l9.2417" class="difflineminus">-        nsCString group_name;</span>
<a href="#l9.2418"></a><span id="l9.2418" class="difflineminus">-        rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l9.2419"></a><span id="l9.2419" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get newsgroup name&quot;);</span>
<a href="#l9.2420"></a><span id="l9.2420" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2421"></a><span id="l9.2421" class="difflineminus">-</span>
<a href="#l9.2422"></a><span id="l9.2422" class="difflineminus">-        m_firstArticle = 0;</span>
<a href="#l9.2423"></a><span id="l9.2423" class="difflineminus">-        m_lastArticle = 0;</span>
<a href="#l9.2424"></a><span id="l9.2424" class="difflineminus">-</span>
<a href="#l9.2425"></a><span id="l9.2425" class="difflineminus">-        NS_MsgSACopy(&amp;command, &quot;GROUP &quot;);</span>
<a href="#l9.2426"></a><span id="l9.2426" class="difflineminus">-        NS_MsgSACat(&amp;command, group_name.get());</span>
<a href="#l9.2427"></a><span id="l9.2427" class="difflineminus">-      }</span>
<a href="#l9.2428"></a><span id="l9.2428" class="difflineminus">-  else if (m_typeWanted == SEARCH_WANTED)</span>
<a href="#l9.2429"></a><span id="l9.2429" class="difflineminus">-  {</span>
<a href="#l9.2430"></a><span id="l9.2430" class="difflineplus">+  } else if (m_typeWanted == GROUP_WANTED) {</span>
<a href="#l9.2431"></a><span id="l9.2431" class="difflineplus">+    nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l9.2432"></a><span id="l9.2432" class="difflineplus">+</span>
<a href="#l9.2433"></a><span id="l9.2433" class="difflineplus">+    NS_ASSERTION(m_newsFolder, &quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l9.2434"></a><span id="l9.2434" class="difflineplus">+    if (!m_newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l9.2435"></a><span id="l9.2435" class="difflineplus">+</span>
<a href="#l9.2436"></a><span id="l9.2436" class="difflineplus">+    nsCString group_name;</span>
<a href="#l9.2437"></a><span id="l9.2437" class="difflineplus">+    rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l9.2438"></a><span id="l9.2438" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to get newsgroup name&quot;);</span>
<a href="#l9.2439"></a><span id="l9.2439" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2440"></a><span id="l9.2440" class="difflineplus">+</span>
<a href="#l9.2441"></a><span id="l9.2441" class="difflineplus">+    m_firstArticle = 0;</span>
<a href="#l9.2442"></a><span id="l9.2442" class="difflineplus">+    m_lastArticle = 0;</span>
<a href="#l9.2443"></a><span id="l9.2443" class="difflineplus">+</span>
<a href="#l9.2444"></a><span id="l9.2444" class="difflineplus">+    NS_MsgSACopy(&amp;command, &quot;GROUP &quot;);</span>
<a href="#l9.2445"></a><span id="l9.2445" class="difflineplus">+    NS_MsgSACat(&amp;command, group_name.get());</span>
<a href="#l9.2446"></a><span id="l9.2446" class="difflineplus">+  } else if (m_typeWanted == SEARCH_WANTED) {</span>
<a href="#l9.2447"></a><span id="l9.2447">     nsresult rv;</span>
<a href="#l9.2448"></a><span id="l9.2448" class="difflineminus">-    MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) doing GROUP for XPAT&quot;, this));</span>
<a href="#l9.2449"></a><span id="l9.2449" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) doing GROUP for XPAT&quot;, this));</span>
<a href="#l9.2450"></a><span id="l9.2450">     nsCString group_name;</span>
<a href="#l9.2451"></a><span id="l9.2451"> </span>
<a href="#l9.2452"></a><span id="l9.2452">     /* for XPAT, we have to GROUP into the group before searching */</span>
<a href="#l9.2453"></a><span id="l9.2453">     if (!m_newsFolder) {</span>
<a href="#l9.2454"></a><span id="l9.2454" class="difflineminus">-        NNTP_LOG_NOTE(&quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l9.2455"></a><span id="l9.2455" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l9.2456"></a><span id="l9.2456" class="difflineplus">+      NNTP_LOG_NOTE(&quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l9.2457"></a><span id="l9.2457" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l9.2458"></a><span id="l9.2458">     }</span>
<a href="#l9.2459"></a><span id="l9.2459">     rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l9.2460"></a><span id="l9.2460">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2461"></a><span id="l9.2461"> </span>
<a href="#l9.2462"></a><span id="l9.2462">     NS_MsgSACopy(&amp;command, &quot;GROUP &quot;);</span>
<a href="#l9.2463"></a><span id="l9.2463" class="difflineminus">-    NS_MsgSACat (&amp;command, group_name.get());</span>
<a href="#l9.2464"></a><span id="l9.2464" class="difflineplus">+    NS_MsgSACat(&amp;command, group_name.get());</span>
<a href="#l9.2465"></a><span id="l9.2465"> </span>
<a href="#l9.2466"></a><span id="l9.2466">     // force a GROUP next time</span>
<a href="#l9.2467"></a><span id="l9.2467">     m_currentGroup.Truncate();</span>
<a href="#l9.2468"></a><span id="l9.2468">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2469"></a><span id="l9.2469">     m_nextStateAfterResponse = NNTP_XPAT_SEND;</span>
<a href="#l9.2470"></a><span id="l9.2470" class="difflineminus">-  }</span>
<a href="#l9.2471"></a><span id="l9.2471" class="difflineminus">-  else if (m_typeWanted == IDS_WANTED)</span>
<a href="#l9.2472"></a><span id="l9.2472" class="difflineminus">-  {</span>
<a href="#l9.2473"></a><span id="l9.2473" class="difflineplus">+  } else if (m_typeWanted == IDS_WANTED) {</span>
<a href="#l9.2474"></a><span id="l9.2474">     m_nextState = NNTP_LIST_GROUP;</span>
<a href="#l9.2475"></a><span id="l9.2475">     return NS_OK;</span>
<a href="#l9.2476"></a><span id="l9.2476" class="difflineminus">-  }</span>
<a href="#l9.2477"></a><span id="l9.2477" class="difflineminus">-  else  /* article or cancel */</span>
<a href="#l9.2478"></a><span id="l9.2478" class="difflineplus">+  } else /* article or cancel */</span>
<a href="#l9.2479"></a><span id="l9.2479">   {</span>
<a href="#l9.2480"></a><span id="l9.2480">     NS_ASSERTION(!m_messageID.IsEmpty(), &quot;No message ID, bailing!&quot;);</span>
<a href="#l9.2481"></a><span id="l9.2481">     if (m_messageID.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l9.2482"></a><span id="l9.2482"> </span>
<a href="#l9.2483"></a><span id="l9.2483">     if (m_typeWanted == CANCEL_WANTED)</span>
<a href="#l9.2484"></a><span id="l9.2484">       NS_MsgSACopy(&amp;command, &quot;HEAD &quot;);</span>
<a href="#l9.2485"></a><span id="l9.2485">     else {</span>
<a href="#l9.2486"></a><span id="l9.2486" class="difflineminus">-      NS_ASSERTION(m_typeWanted == ARTICLE_WANTED, &quot;not cancel, and not article&quot;);</span>
<a href="#l9.2487"></a><span id="l9.2487" class="difflineplus">+      NS_ASSERTION(m_typeWanted == ARTICLE_WANTED,</span>
<a href="#l9.2488"></a><span id="l9.2488" class="difflineplus">+                   &quot;not cancel, and not article&quot;);</span>
<a href="#l9.2489"></a><span id="l9.2489">       NS_MsgSACopy(&amp;command, &quot;ARTICLE &quot;);</span>
<a href="#l9.2490"></a><span id="l9.2490">     }</span>
<a href="#l9.2491"></a><span id="l9.2491"> </span>
<a href="#l9.2492"></a><span id="l9.2492" class="difflineminus">-    if (m_messageID[0] != '&lt;')</span>
<a href="#l9.2493"></a><span id="l9.2493" class="difflineminus">-      NS_MsgSACat(&amp;command,&quot;&lt;&quot;);</span>
<a href="#l9.2494"></a><span id="l9.2494" class="difflineplus">+    if (m_messageID[0] != '&lt;') NS_MsgSACat(&amp;command, &quot;&lt;&quot;);</span>
<a href="#l9.2495"></a><span id="l9.2495"> </span>
<a href="#l9.2496"></a><span id="l9.2496">     NS_MsgSACat(&amp;command, m_messageID.get());</span>
<a href="#l9.2497"></a><span id="l9.2497"> </span>
<a href="#l9.2498"></a><span id="l9.2498" class="difflineminus">-    if (PL_strchr(command+8, '&gt;')==0)</span>
<a href="#l9.2499"></a><span id="l9.2499" class="difflineminus">-      NS_MsgSACat(&amp;command,&quot;&gt;&quot;);</span>
<a href="#l9.2500"></a><span id="l9.2500" class="difflineplus">+    if (PL_strchr(command + 8, '&gt;') == 0) NS_MsgSACat(&amp;command, &quot;&gt;&quot;);</span>
<a href="#l9.2501"></a><span id="l9.2501">   }</span>
<a href="#l9.2502"></a><span id="l9.2502"> </span>
<a href="#l9.2503"></a><span id="l9.2503">   NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l9.2504"></a><span id="l9.2504">   nsresult rv = SendData(command);</span>
<a href="#l9.2505"></a><span id="l9.2505">   PR_Free(command);</span>
<a href="#l9.2506"></a><span id="l9.2506"> </span>
<a href="#l9.2507"></a><span id="l9.2507">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2508"></a><span id="l9.2508">   if (m_typeWanted != SEARCH_WANTED)</span>
<a href="#l9.2509"></a><span id="l9.2509">     m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l9.2510"></a><span id="l9.2510">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2511"></a><span id="l9.2511">   return rv;</span>
<a href="#l9.2512"></a><span id="l9.2512"> } /* sent first command */</span>
<a href="#l9.2513"></a><span id="l9.2513"> </span>
<a href="#l9.2514"></a><span id="l9.2514" class="difflineminus">-</span>
<a href="#l9.2515"></a><span id="l9.2515"> /* interprets the server response from the first command sent</span>
<a href="#l9.2516"></a><span id="l9.2516">  *</span>
<a href="#l9.2517"></a><span id="l9.2517">  * returns negative if the server responds unexpectedly</span>
<a href="#l9.2518"></a><span id="l9.2518">  */</span>
<a href="#l9.2519"></a><span id="l9.2519"> </span>
<a href="#l9.2520"></a><span id="l9.2520" class="difflineminus">-nsresult nsNNTPProtocol::SendFirstNNTPCommandResponse()</span>
<a href="#l9.2521"></a><span id="l9.2521" class="difflineminus">-{</span>
<a href="#l9.2522"></a><span id="l9.2522" class="difflineplus">+nsresult nsNNTPProtocol::SendFirstNNTPCommandResponse() {</span>
<a href="#l9.2523"></a><span id="l9.2523">   int32_t major_opcode = MK_NNTP_RESPONSE_TYPE(m_responseCode);</span>
<a href="#l9.2524"></a><span id="l9.2524"> </span>
<a href="#l9.2525"></a><span id="l9.2525" class="difflineminus">-  if((major_opcode == MK_NNTP_RESPONSE_TYPE_CONT &amp;&amp;</span>
<a href="#l9.2526"></a><span id="l9.2526" class="difflineminus">-    m_typeWanted == NEWS_POST)</span>
<a href="#l9.2527"></a><span id="l9.2527" class="difflineminus">-    || (major_opcode == MK_NNTP_RESPONSE_TYPE_OK &amp;&amp;</span>
<a href="#l9.2528"></a><span id="l9.2528" class="difflineminus">-    m_typeWanted != NEWS_POST) )</span>
<a href="#l9.2529"></a><span id="l9.2529" class="difflineminus">-  {</span>
<a href="#l9.2530"></a><span id="l9.2530" class="difflineminus">-</span>
<a href="#l9.2531"></a><span id="l9.2531" class="difflineplus">+  if ((major_opcode == MK_NNTP_RESPONSE_TYPE_CONT &amp;&amp;</span>
<a href="#l9.2532"></a><span id="l9.2532" class="difflineplus">+       m_typeWanted == NEWS_POST) ||</span>
<a href="#l9.2533"></a><span id="l9.2533" class="difflineplus">+      (major_opcode == MK_NNTP_RESPONSE_TYPE_OK &amp;&amp; m_typeWanted != NEWS_POST)) {</span>
<a href="#l9.2534"></a><span id="l9.2534">     m_nextState = SETUP_NEWS_STREAM;</span>
<a href="#l9.2535"></a><span id="l9.2535">     SetFlag(NNTP_SOME_PROTOCOL_SUCCEEDED);</span>
<a href="#l9.2536"></a><span id="l9.2536">     return NS_OK;</span>
<a href="#l9.2537"></a><span id="l9.2537" class="difflineminus">-  }</span>
<a href="#l9.2538"></a><span id="l9.2538" class="difflineminus">-  else</span>
<a href="#l9.2539"></a><span id="l9.2539" class="difflineminus">-  {</span>
<a href="#l9.2540"></a><span id="l9.2540" class="difflineplus">+  } else {</span>
<a href="#l9.2541"></a><span id="l9.2541">     nsresult rv = NS_OK;</span>
<a href="#l9.2542"></a><span id="l9.2542"> </span>
<a href="#l9.2543"></a><span id="l9.2543">     nsString group_name;</span>
<a href="#l9.2544"></a><span id="l9.2544">     NS_ASSERTION(m_newsFolder, &quot;no newsFolder&quot;);</span>
<a href="#l9.2545"></a><span id="l9.2545" class="difflineminus">-    if (m_newsFolder)</span>
<a href="#l9.2546"></a><span id="l9.2546" class="difflineminus">-      rv = m_newsFolder-&gt;GetUnicodeName(group_name);</span>
<a href="#l9.2547"></a><span id="l9.2547" class="difflineplus">+    if (m_newsFolder) rv = m_newsFolder-&gt;GetUnicodeName(group_name);</span>
<a href="#l9.2548"></a><span id="l9.2548"> </span>
<a href="#l9.2549"></a><span id="l9.2549">     if (m_responseCode == MK_NNTP_RESPONSE_GROUP_NO_GROUP &amp;&amp;</span>
<a href="#l9.2550"></a><span id="l9.2550" class="difflineminus">-      m_typeWanted == GROUP_WANTED) {</span>
<a href="#l9.2551"></a><span id="l9.2551" class="difflineminus">-      MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) group (%s) not found, so unset&quot;</span>
<a href="#l9.2552"></a><span id="l9.2552" class="difflineminus">-                                 &quot; m_currentGroup&quot;, this,</span>
<a href="#l9.2553"></a><span id="l9.2553" class="difflineminus">-                                 NS_ConvertUTF16toUTF8(group_name).get()));</span>
<a href="#l9.2554"></a><span id="l9.2554" class="difflineplus">+        m_typeWanted == GROUP_WANTED) {</span>
<a href="#l9.2555"></a><span id="l9.2555" class="difflineplus">+      MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.2556"></a><span id="l9.2556" class="difflineplus">+              (&quot;(%p) group (%s) not found, so unset&quot;</span>
<a href="#l9.2557"></a><span id="l9.2557" class="difflineplus">+               &quot; m_currentGroup&quot;,</span>
<a href="#l9.2558"></a><span id="l9.2558" class="difflineplus">+               this, NS_ConvertUTF16toUTF8(group_name).get()));</span>
<a href="#l9.2559"></a><span id="l9.2559">       m_currentGroup.Truncate();</span>
<a href="#l9.2560"></a><span id="l9.2560"> </span>
<a href="#l9.2561"></a><span id="l9.2561">       m_nntpServer-&gt;GroupNotFound(m_msgWindow, group_name, true /* opening */);</span>
<a href="#l9.2562"></a><span id="l9.2562">     }</span>
<a href="#l9.2563"></a><span id="l9.2563"> </span>
<a href="#l9.2564"></a><span id="l9.2564">     /* if the server returned a 400 error then it is an expected</span>
<a href="#l9.2565"></a><span id="l9.2565" class="difflineminus">-    * error.  the NEWS_ERROR state will not sever the connection</span>
<a href="#l9.2566"></a><span id="l9.2566" class="difflineminus">-    */</span>
<a href="#l9.2567"></a><span id="l9.2567" class="difflineminus">-    if(major_opcode == MK_NNTP_RESPONSE_TYPE_CANNOT)</span>
<a href="#l9.2568"></a><span id="l9.2568" class="difflineplus">+     * error.  the NEWS_ERROR state will not sever the connection</span>
<a href="#l9.2569"></a><span id="l9.2569" class="difflineplus">+     */</span>
<a href="#l9.2570"></a><span id="l9.2570" class="difflineplus">+    if (major_opcode == MK_NNTP_RESPONSE_TYPE_CANNOT)</span>
<a href="#l9.2571"></a><span id="l9.2571">       m_nextState = NEWS_ERROR;</span>
<a href="#l9.2572"></a><span id="l9.2572">     else</span>
<a href="#l9.2573"></a><span id="l9.2573">       m_nextState = NNTP_ERROR;</span>
<a href="#l9.2574"></a><span id="l9.2574">     // if we have no channel listener, then we're likely downloading</span>
<a href="#l9.2575"></a><span id="l9.2575">     // the message for offline use (or at least not displaying it)</span>
<a href="#l9.2576"></a><span id="l9.2576">     bool savingArticleOffline = (m_channelListener == nullptr);</span>
<a href="#l9.2577"></a><span id="l9.2577"> </span>
<a href="#l9.2578"></a><span id="l9.2578" class="difflineminus">-    if (m_runningURL)</span>
<a href="#l9.2579"></a><span id="l9.2579" class="difflineminus">-      FinishMemCacheEntry(false);  // cleanup mem cache entry</span>
<a href="#l9.2580"></a><span id="l9.2580" class="difflineplus">+    if (m_runningURL) FinishMemCacheEntry(false);  // cleanup mem cache entry</span>
<a href="#l9.2581"></a><span id="l9.2581"> </span>
<a href="#l9.2582"></a><span id="l9.2582">     if (NS_SUCCEEDED(rv) &amp;&amp; !group_name.IsEmpty() &amp;&amp; !savingArticleOffline) {</span>
<a href="#l9.2583"></a><span id="l9.2583">       nsCString uri(NS_LITERAL_CSTRING(&quot;about:newserror?r=&quot;));</span>
<a href="#l9.2584"></a><span id="l9.2584">       nsCString escapedResponse;</span>
<a href="#l9.2585"></a><span id="l9.2585" class="difflineminus">-      MsgEscapeURL(nsDependentCString(m_responseText), nsINetUtil::ESCAPE_URL_QUERY, escapedResponse);</span>
<a href="#l9.2586"></a><span id="l9.2586" class="difflineplus">+      MsgEscapeURL(nsDependentCString(m_responseText),</span>
<a href="#l9.2587"></a><span id="l9.2587" class="difflineplus">+                   nsINetUtil::ESCAPE_URL_QUERY, escapedResponse);</span>
<a href="#l9.2588"></a><span id="l9.2588">       uri.Append(escapedResponse);</span>
<a href="#l9.2589"></a><span id="l9.2589"> </span>
<a href="#l9.2590"></a><span id="l9.2590">       if ((m_key != nsMsgKey_None) &amp;&amp; m_newsFolder) {</span>
<a href="#l9.2591"></a><span id="l9.2591">         nsCString messageID;</span>
<a href="#l9.2592"></a><span id="l9.2592">         nsCString escapedMessageID;</span>
<a href="#l9.2593"></a><span id="l9.2593">         rv = m_newsFolder-&gt;GetMessageIdForKey(m_key, messageID);</span>
<a href="#l9.2594"></a><span id="l9.2594">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.2595"></a><span id="l9.2595">           uri.AppendLiteral(&quot;&amp;m=&quot;);</span>
<a href="#l9.2596"></a><span id="l9.2596" class="difflineminus">-          MsgEscapeURL(messageID, nsINetUtil::ESCAPE_URL_QUERY, escapedMessageID);</span>
<a href="#l9.2597"></a><span id="l9.2597" class="difflineplus">+          MsgEscapeURL(messageID, nsINetUtil::ESCAPE_URL_QUERY,</span>
<a href="#l9.2598"></a><span id="l9.2598" class="difflineplus">+                       escapedMessageID);</span>
<a href="#l9.2599"></a><span id="l9.2599">           uri.Append(escapedMessageID);</span>
<a href="#l9.2600"></a><span id="l9.2600">           uri.AppendLiteral(&quot;&amp;k=&quot;);</span>
<a href="#l9.2601"></a><span id="l9.2601">           uri.AppendInt(m_key);</span>
<a href="#l9.2602"></a><span id="l9.2602">         }</span>
<a href="#l9.2603"></a><span id="l9.2603">       }</span>
<a href="#l9.2604"></a><span id="l9.2604"> </span>
<a href="#l9.2605"></a><span id="l9.2605">       if (m_newsFolder) {</span>
<a href="#l9.2606"></a><span id="l9.2606" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l9.2607"></a><span id="l9.2607" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l9.2608"></a><span id="l9.2608">         if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l9.2609"></a><span id="l9.2609">           nsCString folderURI;</span>
<a href="#l9.2610"></a><span id="l9.2610">           nsCString escapedFolderURI;</span>
<a href="#l9.2611"></a><span id="l9.2611">           rv = folder-&gt;GetURI(folderURI);</span>
<a href="#l9.2612"></a><span id="l9.2612">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.2613"></a><span id="l9.2613">             uri.AppendLiteral(&quot;&amp;f=&quot;);</span>
<a href="#l9.2614"></a><span id="l9.2614" class="difflineminus">-            MsgEscapeURL(folderURI, nsINetUtil::ESCAPE_URL_QUERY, escapedFolderURI);</span>
<a href="#l9.2615"></a><span id="l9.2615" class="difflineplus">+            MsgEscapeURL(folderURI, nsINetUtil::ESCAPE_URL_QUERY,</span>
<a href="#l9.2616"></a><span id="l9.2616" class="difflineplus">+                         escapedFolderURI);</span>
<a href="#l9.2617"></a><span id="l9.2617">             uri.Append(escapedFolderURI);</span>
<a href="#l9.2618"></a><span id="l9.2618">           }</span>
<a href="#l9.2619"></a><span id="l9.2619">         }</span>
<a href="#l9.2620"></a><span id="l9.2620">       }</span>
<a href="#l9.2621"></a><span id="l9.2621"> </span>
<a href="#l9.2622"></a><span id="l9.2622">       if (!m_msgWindow) {</span>
<a href="#l9.2623"></a><span id="l9.2623" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.2624"></a><span id="l9.2624" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl =</span>
<a href="#l9.2625"></a><span id="l9.2625" class="difflineplus">+            do_QueryInterface(m_runningURL);</span>
<a href="#l9.2626"></a><span id="l9.2626">         if (mailnewsurl) {</span>
<a href="#l9.2627"></a><span id="l9.2627">           rv = mailnewsurl-&gt;GetMsgWindow(getter_AddRefs(m_msgWindow));</span>
<a href="#l9.2628"></a><span id="l9.2628" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.2629"></a><span id="l9.2629" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2630"></a><span id="l9.2630">         }</span>
<a href="#l9.2631"></a><span id="l9.2631">       }</span>
<a href="#l9.2632"></a><span id="l9.2632">       if (!m_msgWindow) return NS_ERROR_FAILURE;</span>
<a href="#l9.2633"></a><span id="l9.2633"> </span>
<a href="#l9.2634"></a><span id="l9.2634">       // note, this will cause us to close the connection.</span>
<a href="#l9.2635"></a><span id="l9.2635">       // this will call nsDocShell::LoadURI(), which will</span>
<a href="#l9.2636"></a><span id="l9.2636">       // call nsDocShell::Stop(STOP_NETWORK), which will eventually</span>
<a href="#l9.2637"></a><span id="l9.2637">       // call nsNNTPProtocol::Cancel(), which will close the socket.</span>
<a href="#l9.2638"></a><span id="l9.2638">       // we need to fix this, since the connection is still valid.</span>
<a href="#l9.2639"></a><span id="l9.2639" class="difflineminus">-      rv = m_msgWindow-&gt;DisplayURIInMessagePane(NS_ConvertASCIItoUTF16(uri), true,</span>
<a href="#l9.2640"></a><span id="l9.2640" class="difflineminus">-                                                nsContentUtils::GetSystemPrincipal());</span>
<a href="#l9.2641"></a><span id="l9.2641" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.2642"></a><span id="l9.2642" class="difflineplus">+      rv = m_msgWindow-&gt;DisplayURIInMessagePane(</span>
<a href="#l9.2643"></a><span id="l9.2643" class="difflineplus">+          NS_ConvertASCIItoUTF16(uri), true,</span>
<a href="#l9.2644"></a><span id="l9.2644" class="difflineplus">+          nsContentUtils::GetSystemPrincipal());</span>
<a href="#l9.2645"></a><span id="l9.2645" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2646"></a><span id="l9.2646">     }</span>
<a href="#l9.2647"></a><span id="l9.2647" class="difflineminus">-    // let's take the opportunity of removing the hdr from the db so we don't try to download</span>
<a href="#l9.2648"></a><span id="l9.2648" class="difflineminus">-    // it again.</span>
<a href="#l9.2649"></a><span id="l9.2649" class="difflineminus">-    else if (savingArticleOffline)</span>
<a href="#l9.2650"></a><span id="l9.2650" class="difflineminus">-    {</span>
<a href="#l9.2651"></a><span id="l9.2651" class="difflineplus">+    // let's take the opportunity of removing the hdr from the db so we don't</span>
<a href="#l9.2652"></a><span id="l9.2652" class="difflineplus">+    // try to download it again.</span>
<a href="#l9.2653"></a><span id="l9.2653" class="difflineplus">+    else if (savingArticleOffline) {</span>
<a href="#l9.2654"></a><span id="l9.2654">       if ((m_key != nsMsgKey_None) &amp;&amp; (m_newsFolder)) {</span>
<a href="#l9.2655"></a><span id="l9.2655" class="difflineminus">-         rv = m_newsFolder-&gt;RemoveMessage(m_key);</span>
<a href="#l9.2656"></a><span id="l9.2656" class="difflineplus">+        rv = m_newsFolder-&gt;RemoveMessage(m_key);</span>
<a href="#l9.2657"></a><span id="l9.2657">       }</span>
<a href="#l9.2658"></a><span id="l9.2658">     }</span>
<a href="#l9.2659"></a><span id="l9.2659">     return NS_ERROR_FAILURE;</span>
<a href="#l9.2660"></a><span id="l9.2660">   }</span>
<a href="#l9.2661"></a><span id="l9.2661"> }</span>
<a href="#l9.2662"></a><span id="l9.2662"> </span>
<a href="#l9.2663"></a><span id="l9.2663" class="difflineminus">-nsresult nsNNTPProtocol::SendGroupForArticle()</span>
<a href="#l9.2664"></a><span id="l9.2664" class="difflineminus">-{</span>
<a href="#l9.2665"></a><span id="l9.2665" class="difflineplus">+nsresult nsNNTPProtocol::SendGroupForArticle() {</span>
<a href="#l9.2666"></a><span id="l9.2666">   nsresult rv;</span>
<a href="#l9.2667"></a><span id="l9.2667"> </span>
<a href="#l9.2668"></a><span id="l9.2668">   nsCString groupname;</span>
<a href="#l9.2669"></a><span id="l9.2669">   rv = m_newsFolder-&gt;GetRawName(groupname);</span>
<a href="#l9.2670"></a><span id="l9.2670">   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !groupname.IsEmpty(), &quot;no group name&quot;);</span>
<a href="#l9.2671"></a><span id="l9.2671"> </span>
<a href="#l9.2672"></a><span id="l9.2672">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.2673"></a><span id="l9.2673"> </span>
<a href="#l9.2674"></a><span id="l9.2674" class="difflineminus">-  PR_snprintf(outputBuffer,</span>
<a href="#l9.2675"></a><span id="l9.2675" class="difflineminus">-      OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.2676"></a><span id="l9.2676" class="difflineminus">-      &quot;GROUP %.512s&quot; CRLF,</span>
<a href="#l9.2677"></a><span id="l9.2677" class="difflineminus">-      groupname.get());</span>
<a href="#l9.2678"></a><span id="l9.2678" class="difflineplus">+  PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;GROUP %.512s&quot; CRLF,</span>
<a href="#l9.2679"></a><span id="l9.2679" class="difflineplus">+              groupname.get());</span>
<a href="#l9.2680"></a><span id="l9.2680"> </span>
<a href="#l9.2681"></a><span id="l9.2681">   rv = SendData(outputBuffer);</span>
<a href="#l9.2682"></a><span id="l9.2682"> </span>
<a href="#l9.2683"></a><span id="l9.2683">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2684"></a><span id="l9.2684">   m_nextStateAfterResponse = NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE;</span>
<a href="#l9.2685"></a><span id="l9.2685">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2686"></a><span id="l9.2686">   return rv;</span>
<a href="#l9.2687"></a><span id="l9.2687"> }</span>
<a href="#l9.2688"></a><span id="l9.2688"> </span>
<a href="#l9.2689"></a><span id="l9.2689" class="difflineminus">-nsresult</span>
<a href="#l9.2690"></a><span id="l9.2690" class="difflineminus">-nsNNTPProtocol::SetCurrentGroup()</span>
<a href="#l9.2691"></a><span id="l9.2691" class="difflineminus">-{</span>
<a href="#l9.2692"></a><span id="l9.2692" class="difflineplus">+nsresult nsNNTPProtocol::SetCurrentGroup() {</span>
<a href="#l9.2693"></a><span id="l9.2693">   nsCString groupname;</span>
<a href="#l9.2694"></a><span id="l9.2694">   NS_ASSERTION(m_newsFolder, &quot;no news folder&quot;);</span>
<a href="#l9.2695"></a><span id="l9.2695">   if (!m_newsFolder) {</span>
<a href="#l9.2696"></a><span id="l9.2696">     m_currentGroup.Truncate();</span>
<a href="#l9.2697"></a><span id="l9.2697">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.2698"></a><span id="l9.2698">   }</span>
<a href="#l9.2699"></a><span id="l9.2699"> </span>
<a href="#l9.2700"></a><span id="l9.2700">   mozilla::DebugOnly&lt;nsresult&gt; rv = m_newsFolder-&gt;GetRawName(groupname);</span>
<a href="#l9.2701"></a><span id="l9.2701">   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !groupname.IsEmpty(), &quot;no group name&quot;);</span>
<a href="#l9.2702"></a><span id="l9.2702" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) SetCurrentGroup to %s&quot;,this, groupname.get()));</span>
<a href="#l9.2703"></a><span id="l9.2703" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.2704"></a><span id="l9.2704" class="difflineplus">+          (&quot;(%p) SetCurrentGroup to %s&quot;, this, groupname.get()));</span>
<a href="#l9.2705"></a><span id="l9.2705">   m_currentGroup = groupname;</span>
<a href="#l9.2706"></a><span id="l9.2706">   return NS_OK;</span>
<a href="#l9.2707"></a><span id="l9.2707"> }</span>
<a href="#l9.2708"></a><span id="l9.2708"> </span>
<a href="#l9.2709"></a><span id="l9.2709" class="difflineminus">-nsresult nsNNTPProtocol::SendGroupForArticleResponse()</span>
<a href="#l9.2710"></a><span id="l9.2710" class="difflineminus">-{</span>
<a href="#l9.2711"></a><span id="l9.2711" class="difflineplus">+nsresult nsNNTPProtocol::SendGroupForArticleResponse() {</span>
<a href="#l9.2712"></a><span id="l9.2712">   /* ignore the response code and continue</span>
<a href="#l9.2713"></a><span id="l9.2713">    */</span>
<a href="#l9.2714"></a><span id="l9.2714">   m_nextState = NNTP_SEND_ARTICLE_NUMBER;</span>
<a href="#l9.2715"></a><span id="l9.2715"> </span>
<a href="#l9.2716"></a><span id="l9.2716">   return SetCurrentGroup();</span>
<a href="#l9.2717"></a><span id="l9.2717"> }</span>
<a href="#l9.2718"></a><span id="l9.2718"> </span>
<a href="#l9.2719"></a><span id="l9.2719" class="difflineminus">-</span>
<a href="#l9.2720"></a><span id="l9.2720" class="difflineminus">-nsresult nsNNTPProtocol::SendArticleNumber()</span>
<a href="#l9.2721"></a><span id="l9.2721" class="difflineminus">-{</span>
<a href="#l9.2722"></a><span id="l9.2722" class="difflineplus">+nsresult nsNNTPProtocol::SendArticleNumber() {</span>
<a href="#l9.2723"></a><span id="l9.2723">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.2724"></a><span id="l9.2724">   PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;ARTICLE %lu&quot; CRLF, m_key);</span>
<a href="#l9.2725"></a><span id="l9.2725"> </span>
<a href="#l9.2726"></a><span id="l9.2726">   nsresult rv = SendData(outputBuffer);</span>
<a href="#l9.2727"></a><span id="l9.2727"> </span>
<a href="#l9.2728"></a><span id="l9.2728" class="difflineminus">-    m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2729"></a><span id="l9.2729" class="difflineminus">-    m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l9.2730"></a><span id="l9.2730" class="difflineminus">-    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2731"></a><span id="l9.2731" class="difflineplus">+  m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.2732"></a><span id="l9.2732" class="difflineplus">+  m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l9.2733"></a><span id="l9.2733" class="difflineplus">+  SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2734"></a><span id="l9.2734"> </span>
<a href="#l9.2735"></a><span id="l9.2735">   return rv;</span>
<a href="#l9.2736"></a><span id="l9.2736"> }</span>
<a href="#l9.2737"></a><span id="l9.2737"> </span>
<a href="#l9.2738"></a><span id="l9.2738" class="difflineminus">-nsresult nsNNTPProtocol::BeginArticle()</span>
<a href="#l9.2739"></a><span id="l9.2739" class="difflineminus">-{</span>
<a href="#l9.2740"></a><span id="l9.2740" class="difflineplus">+nsresult nsNNTPProtocol::BeginArticle() {</span>
<a href="#l9.2741"></a><span id="l9.2741">   if (m_typeWanted != ARTICLE_WANTED &amp;&amp; m_typeWanted != CANCEL_WANTED)</span>
<a href="#l9.2742"></a><span id="l9.2742">     return NS_OK;</span>
<a href="#l9.2743"></a><span id="l9.2743"> </span>
<a href="#l9.2744"></a><span id="l9.2744" class="difflineminus">-  /*  Set up the HTML stream</span>
<a href="#l9.2745"></a><span id="l9.2745" class="difflineminus">-   */</span>
<a href="#l9.2746"></a><span id="l9.2746" class="difflineplus">+    /*  Set up the HTML stream</span>
<a href="#l9.2747"></a><span id="l9.2747" class="difflineplus">+     */</span>
<a href="#l9.2748"></a><span id="l9.2748"> </span>
<a href="#l9.2749"></a><span id="l9.2749"> #ifdef NO_ARTICLE_CACHEING</span>
<a href="#l9.2750"></a><span id="l9.2750" class="difflineminus">-  ce-&gt;format_out = CLEAR_CACHE_BIT (ce-&gt;format_out);</span>
<a href="#l9.2751"></a><span id="l9.2751" class="difflineplus">+  ce-&gt;format_out = CLEAR_CACHE_BIT(ce-&gt;format_out);</span>
<a href="#l9.2752"></a><span id="l9.2752"> #endif</span>
<a href="#l9.2753"></a><span id="l9.2753"> </span>
<a href="#l9.2754"></a><span id="l9.2754">   // if we have a channel listener,</span>
<a href="#l9.2755"></a><span id="l9.2755">   // create a pipe to pump the message into...the output will go to whoever</span>
<a href="#l9.2756"></a><span id="l9.2756">   // is consuming the message display</span>
<a href="#l9.2757"></a><span id="l9.2757">   //</span>
<a href="#l9.2758"></a><span id="l9.2758">   // the pipe must have an unlimited length since we are going to be filling</span>
<a href="#l9.2759"></a><span id="l9.2759">   // it on the main thread while reading it from the main thread.  iow, the</span>
<a href="#l9.2760"></a><span id="l9.2760">   // write must not block!! (see bug 190988)</span>
<a href="#l9.2761"></a><span id="l9.2761">   //</span>
<a href="#l9.2762"></a><span id="l9.2762">   if (m_channelListener) {</span>
<a href="#l9.2763"></a><span id="l9.2763" class="difflineminus">-      nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l9.2764"></a><span id="l9.2764" class="difflineminus">-      nsresult rv = pipe-&gt;Init(false, false, 4096, PR_UINT32_MAX);</span>
<a href="#l9.2765"></a><span id="l9.2765" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2766"></a><span id="l9.2766" class="difflineminus">-</span>
<a href="#l9.2767"></a><span id="l9.2767" class="difflineminus">-      // These always succeed because the pipe is initialized above.</span>
<a href="#l9.2768"></a><span id="l9.2768" class="difflineminus">-      MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(mDisplayInputStream)));</span>
<a href="#l9.2769"></a><span id="l9.2769" class="difflineminus">-      MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(mDisplayOutputStream)));</span>
<a href="#l9.2770"></a><span id="l9.2770" class="difflineplus">+    nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l9.2771"></a><span id="l9.2771" class="difflineplus">+    nsresult rv = pipe-&gt;Init(false, false, 4096, PR_UINT32_MAX);</span>
<a href="#l9.2772"></a><span id="l9.2772" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.2773"></a><span id="l9.2773" class="difflineplus">+</span>
<a href="#l9.2774"></a><span id="l9.2774" class="difflineplus">+    // These always succeed because the pipe is initialized above.</span>
<a href="#l9.2775"></a><span id="l9.2775" class="difflineplus">+    MOZ_ALWAYS_SUCCEEDS(</span>
<a href="#l9.2776"></a><span id="l9.2776" class="difflineplus">+        pipe-&gt;GetInputStream(getter_AddRefs(mDisplayInputStream)));</span>
<a href="#l9.2777"></a><span id="l9.2777" class="difflineplus">+    MOZ_ALWAYS_SUCCEEDS(</span>
<a href="#l9.2778"></a><span id="l9.2778" class="difflineplus">+        pipe-&gt;GetOutputStream(getter_AddRefs(mDisplayOutputStream)));</span>
<a href="#l9.2779"></a><span id="l9.2779">   }</span>
<a href="#l9.2780"></a><span id="l9.2780"> </span>
<a href="#l9.2781"></a><span id="l9.2781">   m_nextState = NNTP_READ_ARTICLE;</span>
<a href="#l9.2782"></a><span id="l9.2782"> </span>
<a href="#l9.2783"></a><span id="l9.2783">   return NS_OK;</span>
<a href="#l9.2784"></a><span id="l9.2784"> }</span>
<a href="#l9.2785"></a><span id="l9.2785"> </span>
<a href="#l9.2786"></a><span id="l9.2786" class="difflineminus">-nsresult nsNNTPProtocol::DisplayArticle(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.2787"></a><span id="l9.2787" class="difflineminus">-{</span>
<a href="#l9.2788"></a><span id="l9.2788" class="difflineplus">+nsresult nsNNTPProtocol::DisplayArticle(nsIInputStream *inputStream,</span>
<a href="#l9.2789"></a><span id="l9.2789" class="difflineplus">+                                        uint32_t length) {</span>
<a href="#l9.2790"></a><span id="l9.2790">   uint32_t line_length = 0;</span>
<a href="#l9.2791"></a><span id="l9.2791"> </span>
<a href="#l9.2792"></a><span id="l9.2792">   bool pauseForMoreData = false;</span>
<a href="#l9.2793"></a><span id="l9.2793" class="difflineminus">-  if (m_channelListener)</span>
<a href="#l9.2794"></a><span id="l9.2794" class="difflineminus">-  {</span>
<a href="#l9.2795"></a><span id="l9.2795" class="difflineplus">+  if (m_channelListener) {</span>
<a href="#l9.2796"></a><span id="l9.2796">     nsresult rv = NS_OK;</span>
<a href="#l9.2797"></a><span id="l9.2797" class="difflineminus">-    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, line_length, pauseForMoreData, &amp;rv, true);</span>
<a href="#l9.2798"></a><span id="l9.2798" class="difflineminus">-    if (pauseForMoreData)</span>
<a href="#l9.2799"></a><span id="l9.2799" class="difflineminus">-    {</span>
<a href="#l9.2800"></a><span id="l9.2800" class="difflineplus">+    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, line_length,</span>
<a href="#l9.2801"></a><span id="l9.2801" class="difflineplus">+                                                  pauseForMoreData, &amp;rv, true);</span>
<a href="#l9.2802"></a><span id="l9.2802" class="difflineplus">+    if (pauseForMoreData) {</span>
<a href="#l9.2803"></a><span id="l9.2803">       uint64_t inlength = 0;</span>
<a href="#l9.2804"></a><span id="l9.2804">       mDisplayInputStream-&gt;Available(&amp;inlength);</span>
<a href="#l9.2805"></a><span id="l9.2805" class="difflineminus">-      if (inlength &gt; 0) // broadcast our batched up ODA changes</span>
<a href="#l9.2806"></a><span id="l9.2806" class="difflineminus">-        m_channelListener-&gt;OnDataAvailable(this, mDisplayInputStream, 0, std::min(inlength, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l9.2807"></a><span id="l9.2807" class="difflineplus">+      if (inlength &gt; 0)  // broadcast our batched up ODA changes</span>
<a href="#l9.2808"></a><span id="l9.2808" class="difflineplus">+        m_channelListener-&gt;OnDataAvailable(</span>
<a href="#l9.2809"></a><span id="l9.2809" class="difflineplus">+            this, mDisplayInputStream, 0,</span>
<a href="#l9.2810"></a><span id="l9.2810" class="difflineplus">+            std::min(inlength, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l9.2811"></a><span id="l9.2811">       SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2812"></a><span id="l9.2812">       PR_Free(line);</span>
<a href="#l9.2813"></a><span id="l9.2813">       return rv;</span>
<a href="#l9.2814"></a><span id="l9.2814">     }</span>
<a href="#l9.2815"></a><span id="l9.2815"> </span>
<a href="#l9.2816"></a><span id="l9.2816" class="difflineminus">-    if (m_newsFolder)</span>
<a href="#l9.2817"></a><span id="l9.2817" class="difflineminus">-      m_newsFolder-&gt;NotifyDownloadedLine(line, m_key);</span>
<a href="#l9.2818"></a><span id="l9.2818" class="difflineplus">+    if (m_newsFolder) m_newsFolder-&gt;NotifyDownloadedLine(line, m_key);</span>
<a href="#l9.2819"></a><span id="l9.2819"> </span>
<a href="#l9.2820"></a><span id="l9.2820">     // line only contains a single dot -&gt; message end</span>
<a href="#l9.2821"></a><span id="l9.2821" class="difflineminus">-    if (line_length == 1 + MSG_LINEBREAK_LEN &amp;&amp; line[0] == '.')</span>
<a href="#l9.2822"></a><span id="l9.2822" class="difflineminus">-    {</span>
<a href="#l9.2823"></a><span id="l9.2823" class="difflineplus">+    if (line_length == 1 + MSG_LINEBREAK_LEN &amp;&amp; line[0] == '.') {</span>
<a href="#l9.2824"></a><span id="l9.2824">       m_nextState = NEWS_DONE;</span>
<a href="#l9.2825"></a><span id="l9.2825"> </span>
<a href="#l9.2826"></a><span id="l9.2826">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2827"></a><span id="l9.2827"> </span>
<a href="#l9.2828"></a><span id="l9.2828">       uint64_t inlength = 0;</span>
<a href="#l9.2829"></a><span id="l9.2829">       mDisplayInputStream-&gt;Available(&amp;inlength);</span>
<a href="#l9.2830"></a><span id="l9.2830" class="difflineminus">-      if (inlength &gt; 0) // broadcast our batched up ODA changes</span>
<a href="#l9.2831"></a><span id="l9.2831" class="difflineminus">-        m_channelListener-&gt;OnDataAvailable(this, mDisplayInputStream, 0, std::min(inlength, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l9.2832"></a><span id="l9.2832" class="difflineplus">+      if (inlength &gt; 0)  // broadcast our batched up ODA changes</span>
<a href="#l9.2833"></a><span id="l9.2833" class="difflineplus">+        m_channelListener-&gt;OnDataAvailable(</span>
<a href="#l9.2834"></a><span id="l9.2834" class="difflineplus">+            this, mDisplayInputStream, 0,</span>
<a href="#l9.2835"></a><span id="l9.2835" class="difflineplus">+            std::min(inlength, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l9.2836"></a><span id="l9.2836">       PR_Free(line);</span>
<a href="#l9.2837"></a><span id="l9.2837">       return rv;</span>
<a href="#l9.2838"></a><span id="l9.2838" class="difflineminus">-    }</span>
<a href="#l9.2839"></a><span id="l9.2839" class="difflineminus">-    else // we aren't finished with the message yet</span>
<a href="#l9.2840"></a><span id="l9.2840" class="difflineplus">+    } else  // we aren't finished with the message yet</span>
<a href="#l9.2841"></a><span id="l9.2841">     {</span>
<a href="#l9.2842"></a><span id="l9.2842">       uint32_t count = 0;</span>
<a href="#l9.2843"></a><span id="l9.2843"> </span>
<a href="#l9.2844"></a><span id="l9.2844">       // skip over the quoted '.'</span>
<a href="#l9.2845"></a><span id="l9.2845">       if (line_length &gt; 1 &amp;&amp; line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l9.2846"></a><span id="l9.2846" class="difflineminus">-        mDisplayOutputStream-&gt;Write(line+1, line_length-1, &amp;count);</span>
<a href="#l9.2847"></a><span id="l9.2847" class="difflineplus">+        mDisplayOutputStream-&gt;Write(line + 1, line_length - 1, &amp;count);</span>
<a href="#l9.2848"></a><span id="l9.2848">       else</span>
<a href="#l9.2849"></a><span id="l9.2849">         mDisplayOutputStream-&gt;Write(line, line_length, &amp;count);</span>
<a href="#l9.2850"></a><span id="l9.2850">     }</span>
<a href="#l9.2851"></a><span id="l9.2851"> </span>
<a href="#l9.2852"></a><span id="l9.2852">     PR_Free(line);</span>
<a href="#l9.2853"></a><span id="l9.2853">   }</span>
<a href="#l9.2854"></a><span id="l9.2854"> </span>
<a href="#l9.2855"></a><span id="l9.2855">   return NS_OK;</span>
<a href="#l9.2856"></a><span id="l9.2856"> }</span>
<a href="#l9.2857"></a><span id="l9.2857"> </span>
<a href="#l9.2858"></a><span id="l9.2858" class="difflineminus">-nsresult nsNNTPProtocol::ReadArticle(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.2859"></a><span id="l9.2859" class="difflineminus">-{</span>
<a href="#l9.2860"></a><span id="l9.2860" class="difflineplus">+nsresult nsNNTPProtocol::ReadArticle(nsIInputStream *inputStream,</span>
<a href="#l9.2861"></a><span id="l9.2861" class="difflineplus">+                                     uint32_t length) {</span>
<a href="#l9.2862"></a><span id="l9.2862">   uint32_t status = 0;</span>
<a href="#l9.2863"></a><span id="l9.2863">   nsresult rv;</span>
<a href="#l9.2864"></a><span id="l9.2864">   char *outputBuffer;</span>
<a href="#l9.2865"></a><span id="l9.2865"> </span>
<a href="#l9.2866"></a><span id="l9.2866">   bool pauseForMoreData = false;</span>
<a href="#l9.2867"></a><span id="l9.2867"> </span>
<a href="#l9.2868"></a><span id="l9.2868">   // if we have a channel listener, spool directly to it....</span>
<a href="#l9.2869"></a><span id="l9.2869">   // otherwise we must be doing something like save to disk or cancel</span>
<a href="#l9.2870"></a><span id="l9.2870">   // in which case we are doing the work.</span>
<a href="#l9.2871"></a><span id="l9.2871" class="difflineminus">-  if (m_channelListener)</span>
<a href="#l9.2872"></a><span id="l9.2872" class="difflineminus">-    return DisplayArticle(inputStream, length);</span>
<a href="#l9.2873"></a><span id="l9.2873" class="difflineminus">-</span>
<a href="#l9.2874"></a><span id="l9.2874" class="difflineminus">-</span>
<a href="#l9.2875"></a><span id="l9.2875" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv, true);</span>
<a href="#l9.2876"></a><span id="l9.2876" class="difflineminus">-  if (m_newsFolder &amp;&amp; line)</span>
<a href="#l9.2877"></a><span id="l9.2877" class="difflineminus">-  {</span>
<a href="#l9.2878"></a><span id="l9.2878" class="difflineplus">+  if (m_channelListener) return DisplayArticle(inputStream, length);</span>
<a href="#l9.2879"></a><span id="l9.2879" class="difflineplus">+</span>
<a href="#l9.2880"></a><span id="l9.2880" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.2881"></a><span id="l9.2881" class="difflineplus">+                                                pauseForMoreData, &amp;rv, true);</span>
<a href="#l9.2882"></a><span id="l9.2882" class="difflineplus">+  if (m_newsFolder &amp;&amp; line) {</span>
<a href="#l9.2883"></a><span id="l9.2883">     const char *unescapedLine = line;</span>
<a href="#l9.2884"></a><span id="l9.2884">     // lines beginning with '.' are escaped by nntp server</span>
<a href="#l9.2885"></a><span id="l9.2885">     // or is it just '.' on a line by itself?</span>
<a href="#l9.2886"></a><span id="l9.2886" class="difflineminus">-    if (line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l9.2887"></a><span id="l9.2887" class="difflineminus">-      unescapedLine++;</span>
<a href="#l9.2888"></a><span id="l9.2888" class="difflineplus">+    if (line[0] == '.' &amp;&amp; line[1] == '.') unescapedLine++;</span>
<a href="#l9.2889"></a><span id="l9.2889">     m_newsFolder-&gt;NotifyDownloadedLine(unescapedLine, m_key);</span>
<a href="#l9.2890"></a><span id="l9.2890" class="difflineminus">-</span>
<a href="#l9.2891"></a><span id="l9.2891">   }</span>
<a href="#l9.2892"></a><span id="l9.2892"> </span>
<a href="#l9.2893"></a><span id="l9.2893" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.2894"></a><span id="l9.2894" class="difflineminus">-  {</span>
<a href="#l9.2895"></a><span id="l9.2895" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.2896"></a><span id="l9.2896">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2897"></a><span id="l9.2897">     return NS_OK;</span>
<a href="#l9.2898"></a><span id="l9.2898">   }</span>
<a href="#l9.2899"></a><span id="l9.2899" class="difflineminus">-  if(status &gt; 1)</span>
<a href="#l9.2900"></a><span id="l9.2900" class="difflineminus">-  {</span>
<a href="#l9.2901"></a><span id="l9.2901" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.2902"></a><span id="l9.2902">     mBytesReceived += status;</span>
<a href="#l9.2903"></a><span id="l9.2903">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.2904"></a><span id="l9.2904">   }</span>
<a href="#l9.2905"></a><span id="l9.2905"> </span>
<a href="#l9.2906"></a><span id="l9.2906" class="difflineminus">-  if(!line)</span>
<a href="#l9.2907"></a><span id="l9.2907" class="difflineminus">-    return rv;  /* no line yet or error */</span>
<a href="#l9.2908"></a><span id="l9.2908" class="difflineminus">-</span>
<a href="#l9.2909"></a><span id="l9.2909" class="difflineminus">-  if (m_typeWanted == CANCEL_WANTED &amp;&amp; m_responseCode != MK_NNTP_RESPONSE_ARTICLE_HEAD)</span>
<a href="#l9.2910"></a><span id="l9.2910" class="difflineminus">-  {</span>
<a href="#l9.2911"></a><span id="l9.2911" class="difflineplus">+  if (!line) return rv; /* no line yet or error */</span>
<a href="#l9.2912"></a><span id="l9.2912" class="difflineplus">+</span>
<a href="#l9.2913"></a><span id="l9.2913" class="difflineplus">+  if (m_typeWanted == CANCEL_WANTED &amp;&amp;</span>
<a href="#l9.2914"></a><span id="l9.2914" class="difflineplus">+      m_responseCode != MK_NNTP_RESPONSE_ARTICLE_HEAD) {</span>
<a href="#l9.2915"></a><span id="l9.2915">     /* HEAD command failed. */</span>
<a href="#l9.2916"></a><span id="l9.2916">     PR_FREEIF(line);</span>
<a href="#l9.2917"></a><span id="l9.2917">     return NS_ERROR_FAILURE;</span>
<a href="#l9.2918"></a><span id="l9.2918">   }</span>
<a href="#l9.2919"></a><span id="l9.2919"> </span>
<a href="#l9.2920"></a><span id="l9.2920" class="difflineminus">-  if (line[0] == '.' &amp;&amp; line[MSG_LINEBREAK_LEN + 1] == 0)</span>
<a href="#l9.2921"></a><span id="l9.2921" class="difflineminus">-  {</span>
<a href="#l9.2922"></a><span id="l9.2922" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[MSG_LINEBREAK_LEN + 1] == 0) {</span>
<a href="#l9.2923"></a><span id="l9.2923">     if (m_typeWanted == CANCEL_WANTED)</span>
<a href="#l9.2924"></a><span id="l9.2924">       m_nextState = NEWS_START_CANCEL;</span>
<a href="#l9.2925"></a><span id="l9.2925">     else</span>
<a href="#l9.2926"></a><span id="l9.2926">       m_nextState = NEWS_DONE;</span>
<a href="#l9.2927"></a><span id="l9.2927"> </span>
<a href="#l9.2928"></a><span id="l9.2928">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.2929"></a><span id="l9.2929" class="difflineminus">-  }</span>
<a href="#l9.2930"></a><span id="l9.2930" class="difflineminus">-  else</span>
<a href="#l9.2931"></a><span id="l9.2931" class="difflineminus">-  {</span>
<a href="#l9.2932"></a><span id="l9.2932" class="difflineplus">+  } else {</span>
<a href="#l9.2933"></a><span id="l9.2933">     if (line[0] == '.')</span>
<a href="#l9.2934"></a><span id="l9.2934">       outputBuffer = line + 1;</span>
<a href="#l9.2935"></a><span id="l9.2935">     else</span>
<a href="#l9.2936"></a><span id="l9.2936">       outputBuffer = line;</span>
<a href="#l9.2937"></a><span id="l9.2937"> </span>
<a href="#l9.2938"></a><span id="l9.2938" class="difflineminus">-      /* Don't send content-type to mime parser if we're doing a cancel</span>
<a href="#l9.2939"></a><span id="l9.2939" class="difflineminus">-      because it confuses mime parser into not parsing.</span>
<a href="#l9.2940"></a><span id="l9.2940" class="difflineminus">-      */</span>
<a href="#l9.2941"></a><span id="l9.2941" class="difflineminus">-    if (m_typeWanted != CANCEL_WANTED || strncmp(outputBuffer, &quot;Content-Type:&quot;, 13))</span>
<a href="#l9.2942"></a><span id="l9.2942" class="difflineminus">-    {</span>
<a href="#l9.2943"></a><span id="l9.2943" class="difflineminus">-      // if we are attempting to cancel, we want to snarf the headers and save the aside, which is what</span>
<a href="#l9.2944"></a><span id="l9.2944" class="difflineminus">-      // ParseHeaderForCancel() does.</span>
<a href="#l9.2945"></a><span id="l9.2945" class="difflineplus">+    /* Don't send content-type to mime parser if we're doing a cancel</span>
<a href="#l9.2946"></a><span id="l9.2946" class="difflineplus">+    because it confuses mime parser into not parsing.</span>
<a href="#l9.2947"></a><span id="l9.2947" class="difflineplus">+    */</span>
<a href="#l9.2948"></a><span id="l9.2948" class="difflineplus">+    if (m_typeWanted != CANCEL_WANTED ||</span>
<a href="#l9.2949"></a><span id="l9.2949" class="difflineplus">+        strncmp(outputBuffer, &quot;Content-Type:&quot;, 13)) {</span>
<a href="#l9.2950"></a><span id="l9.2950" class="difflineplus">+      // if we are attempting to cancel, we want to snarf the headers and save</span>
<a href="#l9.2951"></a><span id="l9.2951" class="difflineplus">+      // the aside, which is what ParseHeaderForCancel() does.</span>
<a href="#l9.2952"></a><span id="l9.2952">       if (m_typeWanted == CANCEL_WANTED) {</span>
<a href="#l9.2953"></a><span id="l9.2953">         ParseHeaderForCancel(outputBuffer);</span>
<a href="#l9.2954"></a><span id="l9.2954">       }</span>
<a href="#l9.2955"></a><span id="l9.2955" class="difflineminus">-</span>
<a href="#l9.2956"></a><span id="l9.2956">     }</span>
<a href="#l9.2957"></a><span id="l9.2957">   }</span>
<a href="#l9.2958"></a><span id="l9.2958"> </span>
<a href="#l9.2959"></a><span id="l9.2959">   PR_Free(line);</span>
<a href="#l9.2960"></a><span id="l9.2960"> </span>
<a href="#l9.2961"></a><span id="l9.2961">   return NS_OK;</span>
<a href="#l9.2962"></a><span id="l9.2962"> }</span>
<a href="#l9.2963"></a><span id="l9.2963"> </span>
<a href="#l9.2964"></a><span id="l9.2964" class="difflineminus">-void nsNNTPProtocol::ParseHeaderForCancel(char *buf)</span>
<a href="#l9.2965"></a><span id="l9.2965" class="difflineminus">-{</span>
<a href="#l9.2966"></a><span id="l9.2966" class="difflineminus">-    static int lastHeader = 0;</span>
<a href="#l9.2967"></a><span id="l9.2967" class="difflineminus">-    nsAutoCString header(buf);</span>
<a href="#l9.2968"></a><span id="l9.2968" class="difflineminus">-    if (header.First() == ' ' || header.First() == '\t') {</span>
<a href="#l9.2969"></a><span id="l9.2969" class="difflineminus">-        header.StripWhitespace();</span>
<a href="#l9.2970"></a><span id="l9.2970" class="difflineminus">-        // Add folded line to header if needed.</span>
<a href="#l9.2971"></a><span id="l9.2971" class="difflineminus">-        switch (lastHeader) {</span>
<a href="#l9.2972"></a><span id="l9.2972" class="difflineminus">-        case 1:</span>
<a href="#l9.2973"></a><span id="l9.2973" class="difflineminus">-            m_cancelFromHdr += header;</span>
<a href="#l9.2974"></a><span id="l9.2974" class="difflineminus">-            break;</span>
<a href="#l9.2975"></a><span id="l9.2975" class="difflineminus">-        case 2:</span>
<a href="#l9.2976"></a><span id="l9.2976" class="difflineminus">-            m_cancelID += header;</span>
<a href="#l9.2977"></a><span id="l9.2977" class="difflineminus">-            break;</span>
<a href="#l9.2978"></a><span id="l9.2978" class="difflineminus">-        case 3:</span>
<a href="#l9.2979"></a><span id="l9.2979" class="difflineminus">-            m_cancelNewsgroups += header;</span>
<a href="#l9.2980"></a><span id="l9.2980" class="difflineminus">-            break;</span>
<a href="#l9.2981"></a><span id="l9.2981" class="difflineminus">-        case 4:</span>
<a href="#l9.2982"></a><span id="l9.2982" class="difflineminus">-            m_cancelDistribution += header;</span>
<a href="#l9.2983"></a><span id="l9.2983" class="difflineminus">-            break;</span>
<a href="#l9.2984"></a><span id="l9.2984" class="difflineminus">-        }</span>
<a href="#l9.2985"></a><span id="l9.2985" class="difflineminus">-        // Other folded lines are of no interest.</span>
<a href="#l9.2986"></a><span id="l9.2986" class="difflineminus">-        return;</span>
<a href="#l9.2987"></a><span id="l9.2987" class="difflineminus">-    }</span>
<a href="#l9.2988"></a><span id="l9.2988" class="difflineminus">-</span>
<a href="#l9.2989"></a><span id="l9.2989" class="difflineminus">-    lastHeader = 0;</span>
<a href="#l9.2990"></a><span id="l9.2990" class="difflineminus">-    int32_t colon = header.FindChar(':');</span>
<a href="#l9.2991"></a><span id="l9.2991" class="difflineminus">-    if (!colon)</span>
<a href="#l9.2992"></a><span id="l9.2992" class="difflineminus">-    return;</span>
<a href="#l9.2993"></a><span id="l9.2993" class="difflineminus">-</span>
<a href="#l9.2994"></a><span id="l9.2994" class="difflineminus">-    nsCString value(Substring(header, colon + 1));</span>
<a href="#l9.2995"></a><span id="l9.2995" class="difflineminus">-    value.StripWhitespace();</span>
<a href="#l9.2996"></a><span id="l9.2996" class="difflineminus">-</span>
<a href="#l9.2997"></a><span id="l9.2997" class="difflineminus">-    switch (header.First()) {</span>
<a href="#l9.2998"></a><span id="l9.2998" class="difflineminus">-    case 'F': case 'f':</span>
<a href="#l9.2999"></a><span id="l9.2999" class="difflineminus">-        if (header.Find(&quot;From&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3000"></a><span id="l9.3000" class="difflineminus">-            m_cancelFromHdr = value;</span>
<a href="#l9.3001"></a><span id="l9.3001" class="difflineminus">-            lastHeader = 1;</span>
<a href="#l9.3002"></a><span id="l9.3002" class="difflineminus">-        }</span>
<a href="#l9.3003"></a><span id="l9.3003" class="difflineplus">+void nsNNTPProtocol::ParseHeaderForCancel(char *buf) {</span>
<a href="#l9.3004"></a><span id="l9.3004" class="difflineplus">+  static int lastHeader = 0;</span>
<a href="#l9.3005"></a><span id="l9.3005" class="difflineplus">+  nsAutoCString header(buf);</span>
<a href="#l9.3006"></a><span id="l9.3006" class="difflineplus">+  if (header.First() == ' ' || header.First() == '\t') {</span>
<a href="#l9.3007"></a><span id="l9.3007" class="difflineplus">+    header.StripWhitespace();</span>
<a href="#l9.3008"></a><span id="l9.3008" class="difflineplus">+    // Add folded line to header if needed.</span>
<a href="#l9.3009"></a><span id="l9.3009" class="difflineplus">+    switch (lastHeader) {</span>
<a href="#l9.3010"></a><span id="l9.3010" class="difflineplus">+      case 1:</span>
<a href="#l9.3011"></a><span id="l9.3011" class="difflineplus">+        m_cancelFromHdr += header;</span>
<a href="#l9.3012"></a><span id="l9.3012">         break;</span>
<a href="#l9.3013"></a><span id="l9.3013" class="difflineminus">-    case 'M': case 'm':</span>
<a href="#l9.3014"></a><span id="l9.3014" class="difflineminus">-        if (header.Find(&quot;Message-ID&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3015"></a><span id="l9.3015" class="difflineminus">-            m_cancelID = value;</span>
<a href="#l9.3016"></a><span id="l9.3016" class="difflineminus">-            lastHeader = 2;</span>
<a href="#l9.3017"></a><span id="l9.3017" class="difflineminus">-        }</span>
<a href="#l9.3018"></a><span id="l9.3018" class="difflineplus">+      case 2:</span>
<a href="#l9.3019"></a><span id="l9.3019" class="difflineplus">+        m_cancelID += header;</span>
<a href="#l9.3020"></a><span id="l9.3020">         break;</span>
<a href="#l9.3021"></a><span id="l9.3021" class="difflineminus">-    case 'N': case 'n':</span>
<a href="#l9.3022"></a><span id="l9.3022" class="difflineminus">-        if (header.Find(&quot;Newsgroups&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3023"></a><span id="l9.3023" class="difflineminus">-            m_cancelNewsgroups = value;</span>
<a href="#l9.3024"></a><span id="l9.3024" class="difflineminus">-            lastHeader = 3;</span>
<a href="#l9.3025"></a><span id="l9.3025" class="difflineminus">-        }</span>
<a href="#l9.3026"></a><span id="l9.3026" class="difflineplus">+      case 3:</span>
<a href="#l9.3027"></a><span id="l9.3027" class="difflineplus">+        m_cancelNewsgroups += header;</span>
<a href="#l9.3028"></a><span id="l9.3028">         break;</span>
<a href="#l9.3029"></a><span id="l9.3029" class="difflineminus">-     case 'D': case 'd':</span>
<a href="#l9.3030"></a><span id="l9.3030" class="difflineminus">-        if (header.Find(&quot;Distributions&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3031"></a><span id="l9.3031" class="difflineminus">-            m_cancelDistribution = value;</span>
<a href="#l9.3032"></a><span id="l9.3032" class="difflineminus">-            lastHeader = 4;</span>
<a href="#l9.3033"></a><span id="l9.3033" class="difflineminus">-        }</span>
<a href="#l9.3034"></a><span id="l9.3034" class="difflineplus">+      case 4:</span>
<a href="#l9.3035"></a><span id="l9.3035" class="difflineplus">+        m_cancelDistribution += header;</span>
<a href="#l9.3036"></a><span id="l9.3036">         break;</span>
<a href="#l9.3037"></a><span id="l9.3037">     }</span>
<a href="#l9.3038"></a><span id="l9.3038" class="difflineplus">+    // Other folded lines are of no interest.</span>
<a href="#l9.3039"></a><span id="l9.3039" class="difflineplus">+    return;</span>
<a href="#l9.3040"></a><span id="l9.3040" class="difflineplus">+  }</span>
<a href="#l9.3041"></a><span id="l9.3041" class="difflineplus">+</span>
<a href="#l9.3042"></a><span id="l9.3042" class="difflineplus">+  lastHeader = 0;</span>
<a href="#l9.3043"></a><span id="l9.3043" class="difflineplus">+  int32_t colon = header.FindChar(':');</span>
<a href="#l9.3044"></a><span id="l9.3044" class="difflineplus">+  if (!colon) return;</span>
<a href="#l9.3045"></a><span id="l9.3045" class="difflineplus">+</span>
<a href="#l9.3046"></a><span id="l9.3046" class="difflineplus">+  nsCString value(Substring(header, colon + 1));</span>
<a href="#l9.3047"></a><span id="l9.3047" class="difflineplus">+  value.StripWhitespace();</span>
<a href="#l9.3048"></a><span id="l9.3048" class="difflineplus">+</span>
<a href="#l9.3049"></a><span id="l9.3049" class="difflineplus">+  switch (header.First()) {</span>
<a href="#l9.3050"></a><span id="l9.3050" class="difflineplus">+    case 'F':</span>
<a href="#l9.3051"></a><span id="l9.3051" class="difflineplus">+    case 'f':</span>
<a href="#l9.3052"></a><span id="l9.3052" class="difflineplus">+      if (header.Find(&quot;From&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3053"></a><span id="l9.3053" class="difflineplus">+        m_cancelFromHdr = value;</span>
<a href="#l9.3054"></a><span id="l9.3054" class="difflineplus">+        lastHeader = 1;</span>
<a href="#l9.3055"></a><span id="l9.3055" class="difflineplus">+      }</span>
<a href="#l9.3056"></a><span id="l9.3056" class="difflineplus">+      break;</span>
<a href="#l9.3057"></a><span id="l9.3057" class="difflineplus">+    case 'M':</span>
<a href="#l9.3058"></a><span id="l9.3058" class="difflineplus">+    case 'm':</span>
<a href="#l9.3059"></a><span id="l9.3059" class="difflineplus">+      if (header.Find(&quot;Message-ID&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3060"></a><span id="l9.3060" class="difflineplus">+        m_cancelID = value;</span>
<a href="#l9.3061"></a><span id="l9.3061" class="difflineplus">+        lastHeader = 2;</span>
<a href="#l9.3062"></a><span id="l9.3062" class="difflineplus">+      }</span>
<a href="#l9.3063"></a><span id="l9.3063" class="difflineplus">+      break;</span>
<a href="#l9.3064"></a><span id="l9.3064" class="difflineplus">+    case 'N':</span>
<a href="#l9.3065"></a><span id="l9.3065" class="difflineplus">+    case 'n':</span>
<a href="#l9.3066"></a><span id="l9.3066" class="difflineplus">+      if (header.Find(&quot;Newsgroups&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3067"></a><span id="l9.3067" class="difflineplus">+        m_cancelNewsgroups = value;</span>
<a href="#l9.3068"></a><span id="l9.3068" class="difflineplus">+        lastHeader = 3;</span>
<a href="#l9.3069"></a><span id="l9.3069" class="difflineplus">+      }</span>
<a href="#l9.3070"></a><span id="l9.3070" class="difflineplus">+      break;</span>
<a href="#l9.3071"></a><span id="l9.3071" class="difflineplus">+    case 'D':</span>
<a href="#l9.3072"></a><span id="l9.3072" class="difflineplus">+    case 'd':</span>
<a href="#l9.3073"></a><span id="l9.3073" class="difflineplus">+      if (header.Find(&quot;Distributions&quot;, /* ignoreCase = */ true) == 0) {</span>
<a href="#l9.3074"></a><span id="l9.3074" class="difflineplus">+        m_cancelDistribution = value;</span>
<a href="#l9.3075"></a><span id="l9.3075" class="difflineplus">+        lastHeader = 4;</span>
<a href="#l9.3076"></a><span id="l9.3076" class="difflineplus">+      }</span>
<a href="#l9.3077"></a><span id="l9.3077" class="difflineplus">+      break;</span>
<a href="#l9.3078"></a><span id="l9.3078" class="difflineplus">+  }</span>
<a href="#l9.3079"></a><span id="l9.3079"> </span>
<a href="#l9.3080"></a><span id="l9.3080">   return;</span>
<a href="#l9.3081"></a><span id="l9.3081"> }</span>
<a href="#l9.3082"></a><span id="l9.3082"> </span>
<a href="#l9.3083"></a><span id="l9.3083" class="difflineminus">-nsresult nsNNTPProtocol::BeginAuthorization()</span>
<a href="#l9.3084"></a><span id="l9.3084" class="difflineminus">-{</span>
<a href="#l9.3085"></a><span id="l9.3085" class="difflineminus">-  char * command = 0;</span>
<a href="#l9.3086"></a><span id="l9.3086" class="difflineplus">+nsresult nsNNTPProtocol::BeginAuthorization() {</span>
<a href="#l9.3087"></a><span id="l9.3087" class="difflineplus">+  char *command = 0;</span>
<a href="#l9.3088"></a><span id="l9.3088">   nsresult rv = NS_OK;</span>
<a href="#l9.3089"></a><span id="l9.3089"> </span>
<a href="#l9.3090"></a><span id="l9.3090">   if (!m_newsFolder &amp;&amp; m_nntpServer) {</span>
<a href="#l9.3091"></a><span id="l9.3091">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer);</span>
<a href="#l9.3092"></a><span id="l9.3092">     if (m_nntpServer) {</span>
<a href="#l9.3093"></a><span id="l9.3093">       nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l9.3094"></a><span id="l9.3094">       rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l9.3095"></a><span id="l9.3095">       if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l9.3096"></a><span id="l9.3096">         m_newsFolder = do_QueryInterface(rootFolder);</span>
<a href="#l9.3097"></a><span id="l9.3097">       }</span>
<a href="#l9.3098"></a><span id="l9.3098">     }</span>
<a href="#l9.3099"></a><span id="l9.3099">   }</span>
<a href="#l9.3100"></a><span id="l9.3100"> </span>
<a href="#l9.3101"></a><span id="l9.3101">   NS_ASSERTION(m_newsFolder, &quot;no m_newsFolder&quot;);</span>
<a href="#l9.3102"></a><span id="l9.3102" class="difflineminus">-  if (!m_newsFolder)</span>
<a href="#l9.3103"></a><span id="l9.3103" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.3104"></a><span id="l9.3104" class="difflineplus">+  if (!m_newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l9.3105"></a><span id="l9.3105"> </span>
<a href="#l9.3106"></a><span id="l9.3106">   // We want to get authentication credentials, but it is possible that the</span>
<a href="#l9.3107"></a><span id="l9.3107">   // master password prompt will end up being synchronous. In that case, check</span>
<a href="#l9.3108"></a><span id="l9.3108">   // to see if we already have the credentials stored.</span>
<a href="#l9.3109"></a><span id="l9.3109">   nsCString username, password;</span>
<a href="#l9.3110"></a><span id="l9.3110">   rv = m_newsFolder-&gt;GetGroupUsername(username);</span>
<a href="#l9.3111"></a><span id="l9.3111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3112"></a><span id="l9.3112">   rv = m_newsFolder-&gt;GetGroupPassword(password);</span>
<a href="#l9.3113"></a><span id="l9.3113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3114"></a><span id="l9.3114"> </span>
<a href="#l9.3115"></a><span id="l9.3115">   // If we don't have either a username or a password, queue an asynchronous</span>
<a href="#l9.3116"></a><span id="l9.3116">   // prompt.</span>
<a href="#l9.3117"></a><span id="l9.3117" class="difflineminus">-  if (username.IsEmpty() || password.IsEmpty())</span>
<a href="#l9.3118"></a><span id="l9.3118" class="difflineminus">-  {</span>
<a href="#l9.3119"></a><span id="l9.3119" class="difflineplus">+  if (username.IsEmpty() || password.IsEmpty()) {</span>
<a href="#l9.3120"></a><span id="l9.3120">     nsCOMPtr&lt;nsIMsgAsyncPrompter&gt; asyncPrompter =</span>
<a href="#l9.3121"></a><span id="l9.3121" class="difflineminus">-      do_GetService(NS_MSGASYNCPROMPTER_CONTRACTID, &amp;rv);</span>
<a href="#l9.3122"></a><span id="l9.3122" class="difflineplus">+        do_GetService(NS_MSGASYNCPROMPTER_CONTRACTID, &amp;rv);</span>
<a href="#l9.3123"></a><span id="l9.3123">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3124"></a><span id="l9.3124"> </span>
<a href="#l9.3125"></a><span id="l9.3125">     // Get the key to coalesce auth prompts.</span>
<a href="#l9.3126"></a><span id="l9.3126">     bool singleSignon = false;</span>
<a href="#l9.3127"></a><span id="l9.3127">     m_nntpServer-&gt;GetSingleSignon(&amp;singleSignon);</span>
<a href="#l9.3128"></a><span id="l9.3128"> </span>
<a href="#l9.3129"></a><span id="l9.3129">     nsCString queueKey;</span>
<a href="#l9.3130"></a><span id="l9.3130">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer);</span>
<a href="#l9.3131"></a><span id="l9.3131">     server-&gt;GetKey(queueKey);</span>
<a href="#l9.3132"></a><span id="l9.3132" class="difflineminus">-    if (!singleSignon)</span>
<a href="#l9.3133"></a><span id="l9.3133" class="difflineminus">-    {</span>
<a href="#l9.3134"></a><span id="l9.3134" class="difflineplus">+    if (!singleSignon) {</span>
<a href="#l9.3135"></a><span id="l9.3135">       nsCString groupName;</span>
<a href="#l9.3136"></a><span id="l9.3136">       m_newsFolder-&gt;GetRawName(groupName);</span>
<a href="#l9.3137"></a><span id="l9.3137">       queueKey += groupName;</span>
<a href="#l9.3138"></a><span id="l9.3138">     }</span>
<a href="#l9.3139"></a><span id="l9.3139"> </span>
<a href="#l9.3140"></a><span id="l9.3140">     // If we were called back from HandleAuthenticationFailure, we must have</span>
<a href="#l9.3141"></a><span id="l9.3141">     // been handling the response of an authorization state. In that case,</span>
<a href="#l9.3142"></a><span id="l9.3142">     // let's hurry up on the auth request</span>
<a href="#l9.3143"></a><span id="l9.3143">     bool didAuthFail = m_nextStateAfterResponse == NNTP_AUTHORIZE_RESPONSE ||</span>
<a href="#l9.3144"></a><span id="l9.3144" class="difflineminus">-      m_nextStateAfterResponse == NNTP_PASSWORD_RESPONSE;</span>
<a href="#l9.3145"></a><span id="l9.3145" class="difflineplus">+                       m_nextStateAfterResponse == NNTP_PASSWORD_RESPONSE;</span>
<a href="#l9.3146"></a><span id="l9.3146">     rv = asyncPrompter-&gt;QueueAsyncAuthPrompt(queueKey, didAuthFail, this);</span>
<a href="#l9.3147"></a><span id="l9.3147">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3148"></a><span id="l9.3148"> </span>
<a href="#l9.3149"></a><span id="l9.3149">     m_nextState = NNTP_SUSPENDED;</span>
<a href="#l9.3150"></a><span id="l9.3150" class="difflineminus">-    if (m_request)</span>
<a href="#l9.3151"></a><span id="l9.3151" class="difflineminus">-      m_request-&gt;Suspend();</span>
<a href="#l9.3152"></a><span id="l9.3152" class="difflineplus">+    if (m_request) m_request-&gt;Suspend();</span>
<a href="#l9.3153"></a><span id="l9.3153">     return NS_OK;</span>
<a href="#l9.3154"></a><span id="l9.3154">   }</span>
<a href="#l9.3155"></a><span id="l9.3155"> </span>
<a href="#l9.3156"></a><span id="l9.3156">   NS_MsgSACopy(&amp;command, &quot;AUTHINFO user &quot;);</span>
<a href="#l9.3157"></a><span id="l9.3157" class="difflineminus">-  MOZ_LOG(NNTP,  LogLevel::Info,(&quot;(%p) use %s as the username&quot;, this, username.get()));</span>
<a href="#l9.3158"></a><span id="l9.3158" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.3159"></a><span id="l9.3159" class="difflineplus">+          (&quot;(%p) use %s as the username&quot;, this, username.get()));</span>
<a href="#l9.3160"></a><span id="l9.3160">   NS_MsgSACat(&amp;command, username.get());</span>
<a href="#l9.3161"></a><span id="l9.3161">   NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l9.3162"></a><span id="l9.3162"> </span>
<a href="#l9.3163"></a><span id="l9.3163">   rv = SendData(command);</span>
<a href="#l9.3164"></a><span id="l9.3164"> </span>
<a href="#l9.3165"></a><span id="l9.3165">   PR_Free(command);</span>
<a href="#l9.3166"></a><span id="l9.3166"> </span>
<a href="#l9.3167"></a><span id="l9.3167">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.3168"></a><span id="l9.3168">   m_nextStateAfterResponse = NNTP_AUTHORIZE_RESPONSE;</span>
<a href="#l9.3169"></a><span id="l9.3169"> </span>
<a href="#l9.3170"></a><span id="l9.3170">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3171"></a><span id="l9.3171"> </span>
<a href="#l9.3172"></a><span id="l9.3172">   return rv;</span>
<a href="#l9.3173"></a><span id="l9.3173"> }</span>
<a href="#l9.3174"></a><span id="l9.3174"> </span>
<a href="#l9.3175"></a><span id="l9.3175" class="difflineminus">-nsresult nsNNTPProtocol::AuthorizationResponse()</span>
<a href="#l9.3176"></a><span id="l9.3176" class="difflineminus">-{</span>
<a href="#l9.3177"></a><span id="l9.3177" class="difflineplus">+nsresult nsNNTPProtocol::AuthorizationResponse() {</span>
<a href="#l9.3178"></a><span id="l9.3178">   nsresult rv = NS_OK;</span>
<a href="#l9.3179"></a><span id="l9.3179"> </span>
<a href="#l9.3180"></a><span id="l9.3180">   if (MK_NNTP_RESPONSE_AUTHINFO_OK == m_responseCode ||</span>
<a href="#l9.3181"></a><span id="l9.3181" class="difflineminus">-    MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK == m_responseCode)</span>
<a href="#l9.3182"></a><span id="l9.3182" class="difflineminus">-  {</span>
<a href="#l9.3183"></a><span id="l9.3183" class="difflineplus">+      MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK == m_responseCode) {</span>
<a href="#l9.3184"></a><span id="l9.3184">     /* successful login */</span>
<a href="#l9.3185"></a><span id="l9.3185"> #ifdef HAVE_NNTP_EXTENSIONS</span>
<a href="#l9.3186"></a><span id="l9.3186">     bool pushAuth;</span>
<a href="#l9.3187"></a><span id="l9.3187">     /* If we're here because the host demanded authentication before we</span>
<a href="#l9.3188"></a><span id="l9.3188" class="difflineminus">-    * even sent a single command, then jump back to the beginning of everything</span>
<a href="#l9.3189"></a><span id="l9.3189" class="difflineminus">-    */</span>
<a href="#l9.3190"></a><span id="l9.3190" class="difflineplus">+     * even sent a single command, then jump back to the beginning of everything</span>
<a href="#l9.3191"></a><span id="l9.3191" class="difflineplus">+     */</span>
<a href="#l9.3192"></a><span id="l9.3192">     rv = m_nntpServer-&gt;GetPushAuth(&amp;pushAuth);</span>
<a href="#l9.3193"></a><span id="l9.3193"> </span>
<a href="#l9.3194"></a><span id="l9.3194" class="difflineminus">-    if (!TestFlag(NNTP_READER_PERFORMED))</span>
<a href="#l9.3195"></a><span id="l9.3195" class="difflineminus">-      m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.3196"></a><span id="l9.3196" class="difflineminus">-      /* If we're here because the host needs pushed authentication, then we</span>
<a href="#l9.3197"></a><span id="l9.3197" class="difflineminus">-      * should jump back to SEND_LIST_EXTENSIONS</span>
<a href="#l9.3198"></a><span id="l9.3198" class="difflineminus">-    */</span>
<a href="#l9.3199"></a><span id="l9.3199" class="difflineplus">+    if (!TestFlag(NNTP_READER_PERFORMED)) m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.3200"></a><span id="l9.3200" class="difflineplus">+    /* If we're here because the host needs pushed authentication, then we</span>
<a href="#l9.3201"></a><span id="l9.3201" class="difflineplus">+     * should jump back to SEND_LIST_EXTENSIONS</span>
<a href="#l9.3202"></a><span id="l9.3202" class="difflineplus">+     */</span>
<a href="#l9.3203"></a><span id="l9.3203">     else if (NS_SUCCEEDED(rv) &amp;&amp; pushAuth)</span>
<a href="#l9.3204"></a><span id="l9.3204">       m_nextState = SEND_LIST_EXTENSIONS;</span>
<a href="#l9.3205"></a><span id="l9.3205">     else</span>
<a href="#l9.3206"></a><span id="l9.3206">       /* Normal authentication */</span>
<a href="#l9.3207"></a><span id="l9.3207">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.3208"></a><span id="l9.3208"> #else</span>
<a href="#l9.3209"></a><span id="l9.3209">     if (!TestFlag(NNTP_READER_PERFORMED))</span>
<a href="#l9.3210"></a><span id="l9.3210">       m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.3211"></a><span id="l9.3211">     else</span>
<a href="#l9.3212"></a><span id="l9.3212">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.3213"></a><span id="l9.3213"> #endif /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l9.3214"></a><span id="l9.3214"> </span>
<a href="#l9.3215"></a><span id="l9.3215">     return NS_OK;</span>
<a href="#l9.3216"></a><span id="l9.3216" class="difflineminus">-  }</span>
<a href="#l9.3217"></a><span id="l9.3217" class="difflineminus">-  else if (MK_NNTP_RESPONSE_AUTHINFO_CONT == m_responseCode)</span>
<a href="#l9.3218"></a><span id="l9.3218" class="difflineminus">-  {</span>
<a href="#l9.3219"></a><span id="l9.3219" class="difflineminus">-    char * command = 0;</span>
<a href="#l9.3220"></a><span id="l9.3220" class="difflineplus">+  } else if (MK_NNTP_RESPONSE_AUTHINFO_CONT == m_responseCode) {</span>
<a href="#l9.3221"></a><span id="l9.3221" class="difflineplus">+    char *command = 0;</span>
<a href="#l9.3222"></a><span id="l9.3222"> </span>
<a href="#l9.3223"></a><span id="l9.3223">     // Since we had to have called BeginAuthorization to get here, we've already</span>
<a href="#l9.3224"></a><span id="l9.3224">     // prompted for the authorization credentials. Just grab them without a</span>
<a href="#l9.3225"></a><span id="l9.3225">     // further prompt.</span>
<a href="#l9.3226"></a><span id="l9.3226">     nsCString password;</span>
<a href="#l9.3227"></a><span id="l9.3227">     rv = m_newsFolder-&gt;GetGroupPassword(password);</span>
<a href="#l9.3228"></a><span id="l9.3228" class="difflineminus">-    if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l9.3229"></a><span id="l9.3229" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l9.3230"></a><span id="l9.3230" class="difflineplus">+    if (NS_FAILED(rv) || password.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l9.3231"></a><span id="l9.3231"> </span>
<a href="#l9.3232"></a><span id="l9.3232">     NS_MsgSACopy(&amp;command, &quot;AUTHINFO pass &quot;);</span>
<a href="#l9.3233"></a><span id="l9.3233">     NS_MsgSACat(&amp;command, password.get());</span>
<a href="#l9.3234"></a><span id="l9.3234">     NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l9.3235"></a><span id="l9.3235"> </span>
<a href="#l9.3236"></a><span id="l9.3236">     rv = SendData(command, true);</span>
<a href="#l9.3237"></a><span id="l9.3237"> </span>
<a href="#l9.3238"></a><span id="l9.3238">     PR_FREEIF(command);</span>
<a href="#l9.3239"></a><span id="l9.3239"> </span>
<a href="#l9.3240"></a><span id="l9.3240">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.3241"></a><span id="l9.3241">     m_nextStateAfterResponse = NNTP_PASSWORD_RESPONSE;</span>
<a href="#l9.3242"></a><span id="l9.3242">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3243"></a><span id="l9.3243"> </span>
<a href="#l9.3244"></a><span id="l9.3244">     return rv;</span>
<a href="#l9.3245"></a><span id="l9.3245" class="difflineminus">-  }</span>
<a href="#l9.3246"></a><span id="l9.3246" class="difflineminus">-  else</span>
<a href="#l9.3247"></a><span id="l9.3247" class="difflineminus">-  {</span>
<a href="#l9.3248"></a><span id="l9.3248" class="difflineplus">+  } else {</span>
<a href="#l9.3249"></a><span id="l9.3249">     /* login failed */</span>
<a href="#l9.3250"></a><span id="l9.3250">     HandleAuthenticationFailure();</span>
<a href="#l9.3251"></a><span id="l9.3251">     return NS_OK;</span>
<a href="#l9.3252"></a><span id="l9.3252">   }</span>
<a href="#l9.3253"></a><span id="l9.3253"> </span>
<a href="#l9.3254"></a><span id="l9.3254">   NS_ERROR(&quot;should never get here&quot;);</span>
<a href="#l9.3255"></a><span id="l9.3255">   return NS_ERROR_FAILURE;</span>
<a href="#l9.3256"></a><span id="l9.3256" class="difflineminus">-</span>
<a href="#l9.3257"></a><span id="l9.3257"> }</span>
<a href="#l9.3258"></a><span id="l9.3258"> </span>
<a href="#l9.3259"></a><span id="l9.3259" class="difflineminus">-nsresult nsNNTPProtocol::PasswordResponse()</span>
<a href="#l9.3260"></a><span id="l9.3260" class="difflineminus">-{</span>
<a href="#l9.3261"></a><span id="l9.3261" class="difflineplus">+nsresult nsNNTPProtocol::PasswordResponse() {</span>
<a href="#l9.3262"></a><span id="l9.3262">   if (MK_NNTP_RESPONSE_AUTHINFO_OK == m_responseCode ||</span>
<a href="#l9.3263"></a><span id="l9.3263" class="difflineminus">-    MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK == m_responseCode)</span>
<a href="#l9.3264"></a><span id="l9.3264" class="difflineminus">-  {</span>
<a href="#l9.3265"></a><span id="l9.3265" class="difflineplus">+      MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK == m_responseCode) {</span>
<a href="#l9.3266"></a><span id="l9.3266">     /* successful login */</span>
<a href="#l9.3267"></a><span id="l9.3267"> #ifdef HAVE_NNTP_EXTENSIONS</span>
<a href="#l9.3268"></a><span id="l9.3268">     bool pushAuth;</span>
<a href="#l9.3269"></a><span id="l9.3269">     /* If we're here because the host demanded authentication before we</span>
<a href="#l9.3270"></a><span id="l9.3270" class="difflineminus">-    * even sent a single command, then jump back to the beginning of everything</span>
<a href="#l9.3271"></a><span id="l9.3271" class="difflineminus">-    */</span>
<a href="#l9.3272"></a><span id="l9.3272" class="difflineplus">+     * even sent a single command, then jump back to the beginning of everything</span>
<a href="#l9.3273"></a><span id="l9.3273" class="difflineplus">+     */</span>
<a href="#l9.3274"></a><span id="l9.3274">     nsresult rv = m_nntpServer-&gt;GetPushAuth(&amp;pushAuth);</span>
<a href="#l9.3275"></a><span id="l9.3275"> </span>
<a href="#l9.3276"></a><span id="l9.3276" class="difflineminus">-    if (!TestFlag(NNTP_READER_PERFORMED))</span>
<a href="#l9.3277"></a><span id="l9.3277" class="difflineminus">-      m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.3278"></a><span id="l9.3278" class="difflineminus">-      /* If we're here because the host needs pushed authentication, then we</span>
<a href="#l9.3279"></a><span id="l9.3279" class="difflineminus">-      * should jump back to SEND_LIST_EXTENSIONS</span>
<a href="#l9.3280"></a><span id="l9.3280" class="difflineminus">-    */</span>
<a href="#l9.3281"></a><span id="l9.3281" class="difflineplus">+    if (!TestFlag(NNTP_READER_PERFORMED)) m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.3282"></a><span id="l9.3282" class="difflineplus">+    /* If we're here because the host needs pushed authentication, then we</span>
<a href="#l9.3283"></a><span id="l9.3283" class="difflineplus">+     * should jump back to SEND_LIST_EXTENSIONS</span>
<a href="#l9.3284"></a><span id="l9.3284" class="difflineplus">+     */</span>
<a href="#l9.3285"></a><span id="l9.3285">     else if (NS_SUCCEEDED(rv) &amp;&amp; pushAuth)</span>
<a href="#l9.3286"></a><span id="l9.3286">       m_nextState = SEND_LIST_EXTENSIONS;</span>
<a href="#l9.3287"></a><span id="l9.3287">     else</span>
<a href="#l9.3288"></a><span id="l9.3288">       /* Normal authentication */</span>
<a href="#l9.3289"></a><span id="l9.3289">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.3290"></a><span id="l9.3290"> #else</span>
<a href="#l9.3291"></a><span id="l9.3291">     if (!TestFlag(NNTP_READER_PERFORMED))</span>
<a href="#l9.3292"></a><span id="l9.3292">       m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l9.3293"></a><span id="l9.3293">     else</span>
<a href="#l9.3294"></a><span id="l9.3294">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l9.3295"></a><span id="l9.3295"> #endif /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l9.3296"></a><span id="l9.3296">     return NS_OK;</span>
<a href="#l9.3297"></a><span id="l9.3297" class="difflineminus">-  }</span>
<a href="#l9.3298"></a><span id="l9.3298" class="difflineminus">-  else</span>
<a href="#l9.3299"></a><span id="l9.3299" class="difflineminus">-  {</span>
<a href="#l9.3300"></a><span id="l9.3300" class="difflineplus">+  } else {</span>
<a href="#l9.3301"></a><span id="l9.3301">     HandleAuthenticationFailure();</span>
<a href="#l9.3302"></a><span id="l9.3302">     return NS_OK;</span>
<a href="#l9.3303"></a><span id="l9.3303">   }</span>
<a href="#l9.3304"></a><span id="l9.3304"> </span>
<a href="#l9.3305"></a><span id="l9.3305">   NS_ERROR(&quot;should never get here&quot;);</span>
<a href="#l9.3306"></a><span id="l9.3306">   return NS_ERROR_FAILURE;</span>
<a href="#l9.3307"></a><span id="l9.3307"> }</span>
<a href="#l9.3308"></a><span id="l9.3308"> </span>
<a href="#l9.3309"></a><span id="l9.3309" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::OnPromptStartAsync(nsIMsgAsyncPromptCallback *aCallback)</span>
<a href="#l9.3310"></a><span id="l9.3310" class="difflineminus">-{</span>
<a href="#l9.3311"></a><span id="l9.3311" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::OnPromptStartAsync(</span>
<a href="#l9.3312"></a><span id="l9.3312" class="difflineplus">+    nsIMsgAsyncPromptCallback *aCallback) {</span>
<a href="#l9.3313"></a><span id="l9.3313">   bool result = false;</span>
<a href="#l9.3314"></a><span id="l9.3314">   OnPromptStart(&amp;result);</span>
<a href="#l9.3315"></a><span id="l9.3315">   return aCallback-&gt;OnAuthResult(result);</span>
<a href="#l9.3316"></a><span id="l9.3316"> }</span>
<a href="#l9.3317"></a><span id="l9.3317"> </span>
<a href="#l9.3318"></a><span id="l9.3318" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::OnPromptStart(bool *authAvailable)</span>
<a href="#l9.3319"></a><span id="l9.3319" class="difflineminus">-{</span>
<a href="#l9.3320"></a><span id="l9.3320" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::OnPromptStart(bool *authAvailable) {</span>
<a href="#l9.3321"></a><span id="l9.3321">   NS_ENSURE_ARG_POINTER(authAvailable);</span>
<a href="#l9.3322"></a><span id="l9.3322">   NS_ENSURE_STATE(m_nextState == NNTP_SUSPENDED);</span>
<a href="#l9.3323"></a><span id="l9.3323"> </span>
<a href="#l9.3324"></a><span id="l9.3324" class="difflineminus">-  if (!m_newsFolder)</span>
<a href="#l9.3325"></a><span id="l9.3325" class="difflineminus">-  {</span>
<a href="#l9.3326"></a><span id="l9.3326" class="difflineplus">+  if (!m_newsFolder) {</span>
<a href="#l9.3327"></a><span id="l9.3327">     // If we don't have a news folder, we may have been closed already.</span>
<a href="#l9.3328"></a><span id="l9.3328">     NNTP_LOG_NOTE(&quot;Canceling queued authentication prompt&quot;);</span>
<a href="#l9.3329"></a><span id="l9.3329">     *authAvailable = false;</span>
<a href="#l9.3330"></a><span id="l9.3330">     return NS_OK;</span>
<a href="#l9.3331"></a><span id="l9.3331">   }</span>
<a href="#l9.3332"></a><span id="l9.3332"> </span>
<a href="#l9.3333"></a><span id="l9.3333">   bool didAuthFail = m_nextState == NNTP_AUTHORIZE_RESPONSE ||</span>
<a href="#l9.3334"></a><span id="l9.3334" class="difflineminus">-    m_nextState == NNTP_PASSWORD_RESPONSE;</span>
<a href="#l9.3335"></a><span id="l9.3335" class="difflineminus">-  nsresult rv = m_newsFolder-&gt;GetAuthenticationCredentials(m_msgWindow,</span>
<a href="#l9.3336"></a><span id="l9.3336" class="difflineminus">-    true, didAuthFail, authAvailable);</span>
<a href="#l9.3337"></a><span id="l9.3337" class="difflineplus">+                     m_nextState == NNTP_PASSWORD_RESPONSE;</span>
<a href="#l9.3338"></a><span id="l9.3338" class="difflineplus">+  nsresult rv = m_newsFolder-&gt;GetAuthenticationCredentials(</span>
<a href="#l9.3339"></a><span id="l9.3339" class="difflineplus">+      m_msgWindow, true, didAuthFail, authAvailable);</span>
<a href="#l9.3340"></a><span id="l9.3340">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3341"></a><span id="l9.3341"> </span>
<a href="#l9.3342"></a><span id="l9.3342">   // What we do depends on whether or not we have valid credentials</span>
<a href="#l9.3343"></a><span id="l9.3343">   return *authAvailable ? OnPromptAuthAvailable() : OnPromptCanceled();</span>
<a href="#l9.3344"></a><span id="l9.3344"> }</span>
<a href="#l9.3345"></a><span id="l9.3345"> </span>
<a href="#l9.3346"></a><span id="l9.3346" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::OnPromptAuthAvailable()</span>
<a href="#l9.3347"></a><span id="l9.3347" class="difflineminus">-{</span>
<a href="#l9.3348"></a><span id="l9.3348" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::OnPromptAuthAvailable() {</span>
<a href="#l9.3349"></a><span id="l9.3349">   NS_ENSURE_STATE(m_nextState == NNTP_SUSPENDED);</span>
<a href="#l9.3350"></a><span id="l9.3350"> </span>
<a href="#l9.3351"></a><span id="l9.3351">   // We previously suspended the request; now resume it to read input</span>
<a href="#l9.3352"></a><span id="l9.3352" class="difflineminus">-  if (m_request)</span>
<a href="#l9.3353"></a><span id="l9.3353" class="difflineminus">-    m_request-&gt;Resume();</span>
<a href="#l9.3354"></a><span id="l9.3354" class="difflineplus">+  if (m_request) m_request-&gt;Resume();</span>
<a href="#l9.3355"></a><span id="l9.3355"> </span>
<a href="#l9.3356"></a><span id="l9.3356">   // Now we have our password details accessible from the group, so just call</span>
<a href="#l9.3357"></a><span id="l9.3357">   // into the state machine to start the process going again.</span>
<a href="#l9.3358"></a><span id="l9.3358">   m_nextState = NNTP_BEGIN_AUTHORIZE;</span>
<a href="#l9.3359"></a><span id="l9.3359">   return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l9.3360"></a><span id="l9.3360"> }</span>
<a href="#l9.3361"></a><span id="l9.3361"> </span>
<a href="#l9.3362"></a><span id="l9.3362" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::OnPromptCanceled()</span>
<a href="#l9.3363"></a><span id="l9.3363" class="difflineminus">-{</span>
<a href="#l9.3364"></a><span id="l9.3364" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::OnPromptCanceled() {</span>
<a href="#l9.3365"></a><span id="l9.3365">   NS_ENSURE_STATE(m_nextState == NNTP_SUSPENDED);</span>
<a href="#l9.3366"></a><span id="l9.3366"> </span>
<a href="#l9.3367"></a><span id="l9.3367">   // We previously suspended the request; now resume it to read input</span>
<a href="#l9.3368"></a><span id="l9.3368" class="difflineminus">-  if (m_request)</span>
<a href="#l9.3369"></a><span id="l9.3369" class="difflineminus">-    m_request-&gt;Resume();</span>
<a href="#l9.3370"></a><span id="l9.3370" class="difflineplus">+  if (m_request) m_request-&gt;Resume();</span>
<a href="#l9.3371"></a><span id="l9.3371"> </span>
<a href="#l9.3372"></a><span id="l9.3372">   // Since the prompt was canceled, we can no longer continue the connection.</span>
<a href="#l9.3373"></a><span id="l9.3373">   // Thus, we need to go to the NNTP_ERROR state.</span>
<a href="#l9.3374"></a><span id="l9.3374">   m_nextState = NNTP_ERROR;</span>
<a href="#l9.3375"></a><span id="l9.3375">   return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l9.3376"></a><span id="l9.3376"> }</span>
<a href="#l9.3377"></a><span id="l9.3377"> </span>
<a href="#l9.3378"></a><span id="l9.3378" class="difflineminus">-nsresult nsNNTPProtocol::DisplayNewsgroups()</span>
<a href="#l9.3379"></a><span id="l9.3379" class="difflineminus">-{</span>
<a href="#l9.3380"></a><span id="l9.3380" class="difflineplus">+nsresult nsNNTPProtocol::DisplayNewsgroups() {</span>
<a href="#l9.3381"></a><span id="l9.3381">   m_nextState = NEWS_DONE;</span>
<a href="#l9.3382"></a><span id="l9.3382">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3383"></a><span id="l9.3383"> </span>
<a href="#l9.3384"></a><span id="l9.3384" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) DisplayNewsgroups()&quot;,this));</span>
<a href="#l9.3385"></a><span id="l9.3385" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) DisplayNewsgroups()&quot;, this));</span>
<a href="#l9.3386"></a><span id="l9.3386"> </span>
<a href="#l9.3387"></a><span id="l9.3387">   return NS_OK;</span>
<a href="#l9.3388"></a><span id="l9.3388"> }</span>
<a href="#l9.3389"></a><span id="l9.3389"> </span>
<a href="#l9.3390"></a><span id="l9.3390" class="difflineminus">-nsresult nsNNTPProtocol::BeginNewsgroups()</span>
<a href="#l9.3391"></a><span id="l9.3391" class="difflineminus">-{</span>
<a href="#l9.3392"></a><span id="l9.3392" class="difflineplus">+nsresult nsNNTPProtocol::BeginNewsgroups() {</span>
<a href="#l9.3393"></a><span id="l9.3393">   m_nextState = NNTP_NEWGROUPS;</span>
<a href="#l9.3394"></a><span id="l9.3394">   mBytesReceived = 0;</span>
<a href="#l9.3395"></a><span id="l9.3395" class="difflineminus">-    mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l9.3396"></a><span id="l9.3396" class="difflineminus">-    m_startTime = PR_Now();</span>
<a href="#l9.3397"></a><span id="l9.3397" class="difflineplus">+  mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l9.3398"></a><span id="l9.3398" class="difflineplus">+  m_startTime = PR_Now();</span>
<a href="#l9.3399"></a><span id="l9.3399">   return NS_OK;</span>
<a href="#l9.3400"></a><span id="l9.3400"> }</span>
<a href="#l9.3401"></a><span id="l9.3401"> </span>
<a href="#l9.3402"></a><span id="l9.3402" class="difflineminus">-nsresult nsNNTPProtocol::ProcessNewsgroups(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.3403"></a><span id="l9.3403" class="difflineminus">-{</span>
<a href="#l9.3404"></a><span id="l9.3404" class="difflineminus">-  char *line, *lineToFree, *s, *s1=NULL, *s2=NULL;</span>
<a href="#l9.3405"></a><span id="l9.3405" class="difflineplus">+nsresult nsNNTPProtocol::ProcessNewsgroups(nsIInputStream *inputStream,</span>
<a href="#l9.3406"></a><span id="l9.3406" class="difflineplus">+                                           uint32_t length) {</span>
<a href="#l9.3407"></a><span id="l9.3407" class="difflineplus">+  char *line, *lineToFree, *s, *s1 = NULL, *s2 = NULL;</span>
<a href="#l9.3408"></a><span id="l9.3408">   uint32_t status = 0;</span>
<a href="#l9.3409"></a><span id="l9.3409">   nsresult rv = NS_OK;</span>
<a href="#l9.3410"></a><span id="l9.3410"> </span>
<a href="#l9.3411"></a><span id="l9.3411">   bool pauseForMoreData = false;</span>
<a href="#l9.3412"></a><span id="l9.3412" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.3413"></a><span id="l9.3413" class="difflineminus">-</span>
<a href="#l9.3414"></a><span id="l9.3414" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.3415"></a><span id="l9.3415" class="difflineminus">-  {</span>
<a href="#l9.3416"></a><span id="l9.3416" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.3417"></a><span id="l9.3417" class="difflineplus">+                                                       pauseForMoreData, &amp;rv);</span>
<a href="#l9.3418"></a><span id="l9.3418" class="difflineplus">+</span>
<a href="#l9.3419"></a><span id="l9.3419" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.3420"></a><span id="l9.3420">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3421"></a><span id="l9.3421">     return NS_OK;</span>
<a href="#l9.3422"></a><span id="l9.3422">   }</span>
<a href="#l9.3423"></a><span id="l9.3423"> </span>
<a href="#l9.3424"></a><span id="l9.3424" class="difflineminus">-  if(!line)</span>
<a href="#l9.3425"></a><span id="l9.3425" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.3426"></a><span id="l9.3426" class="difflineminus">-</span>
<a href="#l9.3427"></a><span id="l9.3427" class="difflineminus">-                     /* End of list?</span>
<a href="#l9.3428"></a><span id="l9.3428" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.3429"></a><span id="l9.3429" class="difflineplus">+</span>
<a href="#l9.3430"></a><span id="l9.3430" class="difflineplus">+  /* End of list?</span>
<a href="#l9.3431"></a><span id="l9.3431">    */</span>
<a href="#l9.3432"></a><span id="l9.3432" class="difflineminus">-  if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l9.3433"></a><span id="l9.3433" class="difflineminus">-  {</span>
<a href="#l9.3434"></a><span id="l9.3434" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[1] == '\0') {</span>
<a href="#l9.3435"></a><span id="l9.3435">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3436"></a><span id="l9.3436" class="difflineminus">-    bool xactive=false;</span>
<a href="#l9.3437"></a><span id="l9.3437" class="difflineminus">-    rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l9.3438"></a><span id="l9.3438" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l9.3439"></a><span id="l9.3439" class="difflineminus">-    {</span>
<a href="#l9.3440"></a><span id="l9.3440" class="difflineplus">+    bool xactive = false;</span>
<a href="#l9.3441"></a><span id="l9.3441" class="difflineplus">+    rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;, &amp;xactive);</span>
<a href="#l9.3442"></a><span id="l9.3442" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; xactive) {</span>
<a href="#l9.3443"></a><span id="l9.3443">       nsAutoCString groupName;</span>
<a href="#l9.3444"></a><span id="l9.3444">       rv = m_nntpServer-&gt;GetFirstGroupNeedingExtraInfo(groupName);</span>
<a href="#l9.3445"></a><span id="l9.3445">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.3446"></a><span id="l9.3446">         rv = m_nntpServer-&gt;FindGroup(groupName, getter_AddRefs(m_newsFolder));</span>
<a href="#l9.3447"></a><span id="l9.3447">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;FindGroup failed&quot;);</span>
<a href="#l9.3448"></a><span id="l9.3448">         m_nextState = NNTP_LIST_XACTIVE;</span>
<a href="#l9.3449"></a><span id="l9.3449" class="difflineminus">-        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) listing xactive for %s&quot;, this,</span>
<a href="#l9.3450"></a><span id="l9.3450" class="difflineminus">-                                   groupName.get()));</span>
<a href="#l9.3451"></a><span id="l9.3451" class="difflineplus">+        MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.3452"></a><span id="l9.3452" class="difflineplus">+                (&quot;(%p) listing xactive for %s&quot;, this, groupName.get()));</span>
<a href="#l9.3453"></a><span id="l9.3453">         PR_Free(lineToFree);</span>
<a href="#l9.3454"></a><span id="l9.3454">         return NS_OK;</span>
<a href="#l9.3455"></a><span id="l9.3455">       }</span>
<a href="#l9.3456"></a><span id="l9.3456">     }</span>
<a href="#l9.3457"></a><span id="l9.3457">     m_nextState = NEWS_DONE;</span>
<a href="#l9.3458"></a><span id="l9.3458"> </span>
<a href="#l9.3459"></a><span id="l9.3459">     PR_Free(lineToFree);</span>
<a href="#l9.3460"></a><span id="l9.3460" class="difflineminus">-    if(status &gt; 0)</span>
<a href="#l9.3461"></a><span id="l9.3461" class="difflineplus">+    if (status &gt; 0)</span>
<a href="#l9.3462"></a><span id="l9.3462">       return NS_OK;</span>
<a href="#l9.3463"></a><span id="l9.3463">     else</span>
<a href="#l9.3464"></a><span id="l9.3464">       return rv;</span>
<a href="#l9.3465"></a><span id="l9.3465" class="difflineminus">-  }</span>
<a href="#l9.3466"></a><span id="l9.3466" class="difflineminus">-  else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l9.3467"></a><span id="l9.3467" class="difflineplus">+  } else if (line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l9.3468"></a><span id="l9.3468">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l9.3469"></a><span id="l9.3469">     line++;</span>
<a href="#l9.3470"></a><span id="l9.3470"> </span>
<a href="#l9.3471"></a><span id="l9.3471" class="difflineminus">-    /* almost correct</span>
<a href="#l9.3472"></a><span id="l9.3472" class="difflineminus">-  */</span>
<a href="#l9.3473"></a><span id="l9.3473" class="difflineminus">-  if(status &gt; 1)</span>
<a href="#l9.3474"></a><span id="l9.3474" class="difflineminus">-  {</span>
<a href="#l9.3475"></a><span id="l9.3475" class="difflineplus">+  /* almost correct</span>
<a href="#l9.3476"></a><span id="l9.3476" class="difflineplus">+   */</span>
<a href="#l9.3477"></a><span id="l9.3477" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.3478"></a><span id="l9.3478">     mBytesReceived += status;</span>
<a href="#l9.3479"></a><span id="l9.3479">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.3480"></a><span id="l9.3480">   }</span>
<a href="#l9.3481"></a><span id="l9.3481"> </span>
<a href="#l9.3482"></a><span id="l9.3482">   /* format is &quot;rec.arts.movies.past-films 7302 7119 y&quot;</span>
<a href="#l9.3483"></a><span id="l9.3483">    */</span>
<a href="#l9.3484"></a><span id="l9.3484" class="difflineminus">-  s = PL_strchr (line, ' ');</span>
<a href="#l9.3485"></a><span id="l9.3485" class="difflineminus">-  if (s)</span>
<a href="#l9.3486"></a><span id="l9.3486" class="difflineminus">-  {</span>
<a href="#l9.3487"></a><span id="l9.3487" class="difflineplus">+  s = PL_strchr(line, ' ');</span>
<a href="#l9.3488"></a><span id="l9.3488" class="difflineplus">+  if (s) {</span>
<a href="#l9.3489"></a><span id="l9.3489">     *s = 0;</span>
<a href="#l9.3490"></a><span id="l9.3490" class="difflineminus">-    s1 = s+1;</span>
<a href="#l9.3491"></a><span id="l9.3491" class="difflineminus">-    s = PL_strchr (s1, ' ');</span>
<a href="#l9.3492"></a><span id="l9.3492" class="difflineminus">-    if (s)</span>
<a href="#l9.3493"></a><span id="l9.3493" class="difflineminus">-    {</span>
<a href="#l9.3494"></a><span id="l9.3494" class="difflineplus">+    s1 = s + 1;</span>
<a href="#l9.3495"></a><span id="l9.3495" class="difflineplus">+    s = PL_strchr(s1, ' ');</span>
<a href="#l9.3496"></a><span id="l9.3496" class="difflineplus">+    if (s) {</span>
<a href="#l9.3497"></a><span id="l9.3497">       *s = 0;</span>
<a href="#l9.3498"></a><span id="l9.3498" class="difflineminus">-      s2 = s+1;</span>
<a href="#l9.3499"></a><span id="l9.3499" class="difflineminus">-      s = PL_strchr (s2, ' ');</span>
<a href="#l9.3500"></a><span id="l9.3500" class="difflineminus">-      if (s)</span>
<a href="#l9.3501"></a><span id="l9.3501" class="difflineminus">-      {</span>
<a href="#l9.3502"></a><span id="l9.3502" class="difflineplus">+      s2 = s + 1;</span>
<a href="#l9.3503"></a><span id="l9.3503" class="difflineplus">+      s = PL_strchr(s2, ' ');</span>
<a href="#l9.3504"></a><span id="l9.3504" class="difflineplus">+      if (s) {</span>
<a href="#l9.3505"></a><span id="l9.3505">         *s = 0;</span>
<a href="#l9.3506"></a><span id="l9.3506">       }</span>
<a href="#l9.3507"></a><span id="l9.3507">     }</span>
<a href="#l9.3508"></a><span id="l9.3508">   }</span>
<a href="#l9.3509"></a><span id="l9.3509"> </span>
<a href="#l9.3510"></a><span id="l9.3510">   mBytesReceived += status;</span>
<a href="#l9.3511"></a><span id="l9.3511">   mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.3512"></a><span id="l9.3512"> </span>
<a href="#l9.3513"></a><span id="l9.3513">   NS_ASSERTION(m_nntpServer, &quot;no nntp incoming server&quot;);</span>
<a href="#l9.3514"></a><span id="l9.3514">   if (m_nntpServer) {</span>
<a href="#l9.3515"></a><span id="l9.3515">     rv = m_nntpServer-&gt;AddNewsgroupToList(line);</span>
<a href="#l9.3516"></a><span id="l9.3516" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to add to subscribe ds&quot;);</span>
<a href="#l9.3517"></a><span id="l9.3517" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to add to subscribe ds&quot;);</span>
<a href="#l9.3518"></a><span id="l9.3518">   }</span>
<a href="#l9.3519"></a><span id="l9.3519"> </span>
<a href="#l9.3520"></a><span id="l9.3520" class="difflineminus">-  bool xactive=false;</span>
<a href="#l9.3521"></a><span id="l9.3521" class="difflineminus">-  rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l9.3522"></a><span id="l9.3522" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l9.3523"></a><span id="l9.3523" class="difflineminus">-  {</span>
<a href="#l9.3524"></a><span id="l9.3524" class="difflineplus">+  bool xactive = false;</span>
<a href="#l9.3525"></a><span id="l9.3525" class="difflineplus">+  rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;, &amp;xactive);</span>
<a href="#l9.3526"></a><span id="l9.3526" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; xactive) {</span>
<a href="#l9.3527"></a><span id="l9.3527">     nsAutoCString charset;</span>
<a href="#l9.3528"></a><span id="l9.3528">     nsAutoString lineUtf16;</span>
<a href="#l9.3529"></a><span id="l9.3529">     if (NS_SUCCEEDED(m_nntpServer-&gt;GetCharset(charset)) &amp;&amp;</span>
<a href="#l9.3530"></a><span id="l9.3530" class="difflineminus">-        NS_SUCCEEDED(nsMsgI18NConvertToUnicode(charset,</span>
<a href="#l9.3531"></a><span id="l9.3531" class="difflineminus">-                                               nsDependentCString(line),</span>
<a href="#l9.3532"></a><span id="l9.3532" class="difflineminus">-                                               lineUtf16)))</span>
<a href="#l9.3533"></a><span id="l9.3533" class="difflineplus">+        NS_SUCCEEDED(nsMsgI18NConvertToUnicode(</span>
<a href="#l9.3534"></a><span id="l9.3534" class="difflineplus">+            charset, nsDependentCString(line), lineUtf16)))</span>
<a href="#l9.3535"></a><span id="l9.3535">       m_nntpServer-&gt;SetGroupNeedsExtraInfo(NS_ConvertUTF16toUTF8(lineUtf16),</span>
<a href="#l9.3536"></a><span id="l9.3536">                                            true);</span>
<a href="#l9.3537"></a><span id="l9.3537">     else</span>
<a href="#l9.3538"></a><span id="l9.3538">       m_nntpServer-&gt;SetGroupNeedsExtraInfo(nsDependentCString(line), true);</span>
<a href="#l9.3539"></a><span id="l9.3539">   }</span>
<a href="#l9.3540"></a><span id="l9.3540"> </span>
<a href="#l9.3541"></a><span id="l9.3541">   PR_Free(lineToFree);</span>
<a href="#l9.3542"></a><span id="l9.3542">   return rv;</span>
<a href="#l9.3543"></a><span id="l9.3543"> }</span>
<a href="#l9.3544"></a><span id="l9.3544"> </span>
<a href="#l9.3545"></a><span id="l9.3545"> /* Ahhh, this like print's out the headers and stuff</span>
<a href="#l9.3546"></a><span id="l9.3546">  *</span>
<a href="#l9.3547"></a><span id="l9.3547">  * always returns 0</span>
<a href="#l9.3548"></a><span id="l9.3548">  */</span>
<a href="#l9.3549"></a><span id="l9.3549"> </span>
<a href="#l9.3550"></a><span id="l9.3550" class="difflineminus">-nsresult nsNNTPProtocol::BeginReadNewsList()</span>
<a href="#l9.3551"></a><span id="l9.3551" class="difflineminus">-{</span>
<a href="#l9.3552"></a><span id="l9.3552" class="difflineplus">+nsresult nsNNTPProtocol::BeginReadNewsList() {</span>
<a href="#l9.3553"></a><span id="l9.3553">   m_readNewsListCount = 0;</span>
<a href="#l9.3554"></a><span id="l9.3554" class="difflineminus">-    mNumGroupsListed = 0;</span>
<a href="#l9.3555"></a><span id="l9.3555" class="difflineminus">-    m_nextState = NNTP_READ_LIST;</span>
<a href="#l9.3556"></a><span id="l9.3556" class="difflineminus">-</span>
<a href="#l9.3557"></a><span id="l9.3557" class="difflineminus">-    mBytesReceived = 0;</span>
<a href="#l9.3558"></a><span id="l9.3558" class="difflineminus">-    mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l9.3559"></a><span id="l9.3559" class="difflineminus">-    m_startTime = PR_Now();</span>
<a href="#l9.3560"></a><span id="l9.3560" class="difflineplus">+  mNumGroupsListed = 0;</span>
<a href="#l9.3561"></a><span id="l9.3561" class="difflineplus">+  m_nextState = NNTP_READ_LIST;</span>
<a href="#l9.3562"></a><span id="l9.3562" class="difflineplus">+</span>
<a href="#l9.3563"></a><span id="l9.3563" class="difflineplus">+  mBytesReceived = 0;</span>
<a href="#l9.3564"></a><span id="l9.3564" class="difflineplus">+  mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l9.3565"></a><span id="l9.3565" class="difflineplus">+  m_startTime = PR_Now();</span>
<a href="#l9.3566"></a><span id="l9.3566"> </span>
<a href="#l9.3567"></a><span id="l9.3567">   return NS_OK;</span>
<a href="#l9.3568"></a><span id="l9.3568"> }</span>
<a href="#l9.3569"></a><span id="l9.3569"> </span>
<a href="#l9.3570"></a><span id="l9.3570" class="difflineminus">-#define RATE_CONSTANT 976.5625      /* PR_USEC_PER_SEC / 1024 bytes */</span>
<a href="#l9.3571"></a><span id="l9.3571" class="difflineminus">-</span>
<a href="#l9.3572"></a><span id="l9.3572" class="difflineminus">-static void ComputeRate(int32_t bytes, PRTime startTime, float *rate)</span>
<a href="#l9.3573"></a><span id="l9.3573" class="difflineminus">-{</span>
<a href="#l9.3574"></a><span id="l9.3574" class="difflineplus">+#define RATE_CONSTANT 976.5625 /* PR_USEC_PER_SEC / 1024 bytes */</span>
<a href="#l9.3575"></a><span id="l9.3575" class="difflineplus">+</span>
<a href="#l9.3576"></a><span id="l9.3576" class="difflineplus">+static void ComputeRate(int32_t bytes, PRTime startTime, float *rate) {</span>
<a href="#l9.3577"></a><span id="l9.3577">   // rate = (bytes / USECS since start) * RATE_CONSTANT</span>
<a href="#l9.3578"></a><span id="l9.3578"> </span>
<a href="#l9.3579"></a><span id="l9.3579">   // compute usecs since we started.</span>
<a href="#l9.3580"></a><span id="l9.3580">   int32_t delta = (int32_t)(PR_Now() - startTime);</span>
<a href="#l9.3581"></a><span id="l9.3581"> </span>
<a href="#l9.3582"></a><span id="l9.3582">   // compute rate</span>
<a href="#l9.3583"></a><span id="l9.3583">   if (delta &gt; 0) {</span>
<a href="#l9.3584"></a><span id="l9.3584" class="difflineminus">-    *rate = (float) ((bytes * RATE_CONSTANT) / delta);</span>
<a href="#l9.3585"></a><span id="l9.3585" class="difflineminus">-  }</span>
<a href="#l9.3586"></a><span id="l9.3586" class="difflineminus">-  else {</span>
<a href="#l9.3587"></a><span id="l9.3587" class="difflineplus">+    *rate = (float)((bytes * RATE_CONSTANT) / delta);</span>
<a href="#l9.3588"></a><span id="l9.3588" class="difflineplus">+  } else {</span>
<a href="#l9.3589"></a><span id="l9.3589">     *rate = 0.0;</span>
<a href="#l9.3590"></a><span id="l9.3590">   }</span>
<a href="#l9.3591"></a><span id="l9.3591"> }</span>
<a href="#l9.3592"></a><span id="l9.3592"> </span>
<a href="#l9.3593"></a><span id="l9.3593"> /* display a list of all or part of the newsgroups list</span>
<a href="#l9.3594"></a><span id="l9.3594">  * from the news server</span>
<a href="#l9.3595"></a><span id="l9.3595">  */</span>
<a href="#l9.3596"></a><span id="l9.3596" class="difflineminus">-nsresult nsNNTPProtocol::ReadNewsList(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.3597"></a><span id="l9.3597" class="difflineminus">-{</span>
<a href="#l9.3598"></a><span id="l9.3598" class="difflineplus">+nsresult nsNNTPProtocol::ReadNewsList(nsIInputStream *inputStream,</span>
<a href="#l9.3599"></a><span id="l9.3599" class="difflineplus">+                                      uint32_t length) {</span>
<a href="#l9.3600"></a><span id="l9.3600">   nsresult rv = NS_OK;</span>
<a href="#l9.3601"></a><span id="l9.3601" class="difflineminus">-  int32_t i=0;</span>
<a href="#l9.3602"></a><span id="l9.3602" class="difflineplus">+  int32_t i = 0;</span>
<a href="#l9.3603"></a><span id="l9.3603">   uint32_t status = 1;</span>
<a href="#l9.3604"></a><span id="l9.3604"> </span>
<a href="#l9.3605"></a><span id="l9.3605">   bool pauseForMoreData = false;</span>
<a href="#l9.3606"></a><span id="l9.3606">   char *line, *lineToFree;</span>
<a href="#l9.3607"></a><span id="l9.3607" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.3608"></a><span id="l9.3608" class="difflineminus">-</span>
<a href="#l9.3609"></a><span id="l9.3609" class="difflineminus">-  if (pauseForMoreData)</span>
<a href="#l9.3610"></a><span id="l9.3610" class="difflineminus">-  {</span>
<a href="#l9.3611"></a><span id="l9.3611" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.3612"></a><span id="l9.3612" class="difflineplus">+                                                       pauseForMoreData, &amp;rv);</span>
<a href="#l9.3613"></a><span id="l9.3613" class="difflineplus">+</span>
<a href="#l9.3614"></a><span id="l9.3614" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.3615"></a><span id="l9.3615">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3616"></a><span id="l9.3616">     PR_Free(lineToFree);</span>
<a href="#l9.3617"></a><span id="l9.3617">     return NS_OK;</span>
<a href="#l9.3618"></a><span id="l9.3618">   }</span>
<a href="#l9.3619"></a><span id="l9.3619"> </span>
<a href="#l9.3620"></a><span id="l9.3620" class="difflineminus">-  if (!line)</span>
<a href="#l9.3621"></a><span id="l9.3621" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.3622"></a><span id="l9.3622" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.3623"></a><span id="l9.3623"> </span>
<a href="#l9.3624"></a><span id="l9.3624">   /* End of list? */</span>
<a href="#l9.3625"></a><span id="l9.3625" class="difflineminus">-  if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l9.3626"></a><span id="l9.3626" class="difflineminus">-  {</span>
<a href="#l9.3627"></a><span id="l9.3627" class="difflineminus">-    bool listpnames=false;</span>
<a href="#l9.3628"></a><span id="l9.3628" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[1] == '\0') {</span>
<a href="#l9.3629"></a><span id="l9.3629" class="difflineplus">+    bool listpnames = false;</span>
<a href="#l9.3630"></a><span id="l9.3630">     NS_ASSERTION(m_nntpServer, &quot;no nntp incoming server&quot;);</span>
<a href="#l9.3631"></a><span id="l9.3631">     if (m_nntpServer) {</span>
<a href="#l9.3632"></a><span id="l9.3632" class="difflineminus">-      rv = m_nntpServer-&gt;QueryExtension(&quot;LISTPNAMES&quot;,&amp;listpnames);</span>
<a href="#l9.3633"></a><span id="l9.3633" class="difflineplus">+      rv = m_nntpServer-&gt;QueryExtension(&quot;LISTPNAMES&quot;, &amp;listpnames);</span>
<a href="#l9.3634"></a><span id="l9.3634">     }</span>
<a href="#l9.3635"></a><span id="l9.3635">     if (NS_SUCCEEDED(rv) &amp;&amp; listpnames)</span>
<a href="#l9.3636"></a><span id="l9.3636">       m_nextState = NNTP_LIST_PRETTY_NAMES;</span>
<a href="#l9.3637"></a><span id="l9.3637">     else</span>
<a href="#l9.3638"></a><span id="l9.3638">       m_nextState = DISPLAY_NEWSGROUPS;</span>
<a href="#l9.3639"></a><span id="l9.3639">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3640"></a><span id="l9.3640">     PR_Free(lineToFree);</span>
<a href="#l9.3641"></a><span id="l9.3641">     return NS_OK;</span>
<a href="#l9.3642"></a><span id="l9.3642" class="difflineminus">-  }</span>
<a href="#l9.3643"></a><span id="l9.3643" class="difflineminus">-  else if (line[0] == '.')</span>
<a href="#l9.3644"></a><span id="l9.3644" class="difflineminus">-  {</span>
<a href="#l9.3645"></a><span id="l9.3645" class="difflineminus">-    if ((line[1] == ' ') || (line[1] == '.' &amp;&amp; line [2] == '.' &amp;&amp; line[3] == ' '))</span>
<a href="#l9.3646"></a><span id="l9.3646" class="difflineminus">-    {</span>
<a href="#l9.3647"></a><span id="l9.3647" class="difflineplus">+  } else if (line[0] == '.') {</span>
<a href="#l9.3648"></a><span id="l9.3648" class="difflineplus">+    if ((line[1] == ' ') ||</span>
<a href="#l9.3649"></a><span id="l9.3649" class="difflineplus">+        (line[1] == '.' &amp;&amp; line[2] == '.' &amp;&amp; line[3] == ' ')) {</span>
<a href="#l9.3650"></a><span id="l9.3650">       // some servers send &quot;... 0000000001 0000000002 y&quot;</span>
<a href="#l9.3651"></a><span id="l9.3651">       // and some servers send &quot;. 0000000001 0000000002 y&quot;</span>
<a href="#l9.3652"></a><span id="l9.3652">       // just skip that those lines</span>
<a href="#l9.3653"></a><span id="l9.3653">       // see bug #69231 and #123560</span>
<a href="#l9.3654"></a><span id="l9.3654">       PR_Free(lineToFree);</span>
<a href="#l9.3655"></a><span id="l9.3655">       return rv;</span>
<a href="#l9.3656"></a><span id="l9.3656">     }</span>
<a href="#l9.3657"></a><span id="l9.3657" class="difflineminus">-    // The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it, so unquote</span>
<a href="#l9.3658"></a><span id="l9.3658" class="difflineplus">+    // The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it, so</span>
<a href="#l9.3659"></a><span id="l9.3659" class="difflineplus">+    // unquote</span>
<a href="#l9.3660"></a><span id="l9.3660">     line++;</span>
<a href="#l9.3661"></a><span id="l9.3661">   }</span>
<a href="#l9.3662"></a><span id="l9.3662"> </span>
<a href="#l9.3663"></a><span id="l9.3663">   /* almost correct</span>
<a href="#l9.3664"></a><span id="l9.3664" class="difflineminus">-  */</span>
<a href="#l9.3665"></a><span id="l9.3665" class="difflineminus">-  if(status &gt; 1)</span>
<a href="#l9.3666"></a><span id="l9.3666" class="difflineminus">-  {</span>
<a href="#l9.3667"></a><span id="l9.3667" class="difflineplus">+   */</span>
<a href="#l9.3668"></a><span id="l9.3668" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.3669"></a><span id="l9.3669">     mBytesReceived += status;</span>
<a href="#l9.3670"></a><span id="l9.3670">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.3671"></a><span id="l9.3671"> </span>
<a href="#l9.3672"></a><span id="l9.3672" class="difflineminus">-    if ((mBytesReceivedSinceLastStatusUpdate &gt; UPDATE_THRESHOLD) &amp;&amp; m_msgWindow) {</span>
<a href="#l9.3673"></a><span id="l9.3673" class="difflineplus">+    if ((mBytesReceivedSinceLastStatusUpdate &gt; UPDATE_THRESHOLD) &amp;&amp;</span>
<a href="#l9.3674"></a><span id="l9.3674" class="difflineplus">+        m_msgWindow) {</span>
<a href="#l9.3675"></a><span id="l9.3675">       mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l9.3676"></a><span id="l9.3676"> </span>
<a href="#l9.3677"></a><span id="l9.3677" class="difflineminus">-      nsCOMPtr &lt;nsIMsgStatusFeedback&gt; msgStatusFeedback;</span>
<a href="#l9.3678"></a><span id="l9.3678" class="difflineplus">+      nsCOMPtr&lt;nsIMsgStatusFeedback&gt; msgStatusFeedback;</span>
<a href="#l9.3679"></a><span id="l9.3679"> </span>
<a href="#l9.3680"></a><span id="l9.3680">       rv = m_msgWindow-&gt;GetStatusFeedback(getter_AddRefs(msgStatusFeedback));</span>
<a href="#l9.3681"></a><span id="l9.3681">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3682"></a><span id="l9.3682"> </span>
<a href="#l9.3683"></a><span id="l9.3683">       nsString statusString;</span>
<a href="#l9.3684"></a><span id="l9.3684"> </span>
<a href="#l9.3685"></a><span id="l9.3685">       nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l9.3686"></a><span id="l9.3686" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l9.3687"></a><span id="l9.3687" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l9.3688"></a><span id="l9.3688">       NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.3689"></a><span id="l9.3689"> </span>
<a href="#l9.3690"></a><span id="l9.3690">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l9.3691"></a><span id="l9.3691">       rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l9.3692"></a><span id="l9.3692">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3693"></a><span id="l9.3693"> </span>
<a href="#l9.3694"></a><span id="l9.3694">       nsAutoString bytesStr;</span>
<a href="#l9.3695"></a><span id="l9.3695">       bytesStr.AppendInt(mBytesReceived / 1024);</span>
<a href="#l9.3696"></a><span id="l9.3696"> </span>
<a href="#l9.3697"></a><span id="l9.3697">       // compute the rate, and then convert it have one</span>
<a href="#l9.3698"></a><span id="l9.3698">       // decimal precision.</span>
<a href="#l9.3699"></a><span id="l9.3699">       float rate = 0.0;</span>
<a href="#l9.3700"></a><span id="l9.3700">       ComputeRate(mBytesReceived, m_startTime, &amp;rate);</span>
<a href="#l9.3701"></a><span id="l9.3701">       char rate_buf[RATE_STR_BUF_LEN];</span>
<a href="#l9.3702"></a><span id="l9.3702" class="difflineminus">-      PR_snprintf(rate_buf,RATE_STR_BUF_LEN,&quot;%.1f&quot;, rate);</span>
<a href="#l9.3703"></a><span id="l9.3703" class="difflineplus">+      PR_snprintf(rate_buf, RATE_STR_BUF_LEN, &quot;%.1f&quot;, rate);</span>
<a href="#l9.3704"></a><span id="l9.3704"> </span>
<a href="#l9.3705"></a><span id="l9.3705">       nsAutoString numGroupsStr;</span>
<a href="#l9.3706"></a><span id="l9.3706">       numGroupsStr.AppendInt(mNumGroupsListed);</span>
<a href="#l9.3707"></a><span id="l9.3707">       NS_ConvertASCIItoUTF16 rateStr(rate_buf);</span>
<a href="#l9.3708"></a><span id="l9.3708"> </span>
<a href="#l9.3709"></a><span id="l9.3709" class="difflineminus">-      const char16_t *formatStrings[3] = { numGroupsStr.get(), bytesStr.get(), rateStr.get()};</span>
<a href="#l9.3710"></a><span id="l9.3710" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(&quot;bytesReceived&quot;,</span>
<a href="#l9.3711"></a><span id="l9.3711" class="difflineminus">-        formatStrings, 3,</span>
<a href="#l9.3712"></a><span id="l9.3712" class="difflineminus">-        statusString);</span>
<a href="#l9.3713"></a><span id="l9.3713" class="difflineplus">+      const char16_t *formatStrings[3] = {numGroupsStr.get(), bytesStr.get(),</span>
<a href="#l9.3714"></a><span id="l9.3714" class="difflineplus">+                                          rateStr.get()};</span>
<a href="#l9.3715"></a><span id="l9.3715" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;bytesReceived&quot;, formatStrings, 3,</span>
<a href="#l9.3716"></a><span id="l9.3716" class="difflineplus">+                                        statusString);</span>
<a href="#l9.3717"></a><span id="l9.3717"> </span>
<a href="#l9.3718"></a><span id="l9.3718">       rv = msgStatusFeedback-&gt;ShowStatusString(statusString);</span>
<a href="#l9.3719"></a><span id="l9.3719">       if (NS_FAILED(rv)) {</span>
<a href="#l9.3720"></a><span id="l9.3720">         PR_Free(lineToFree);</span>
<a href="#l9.3721"></a><span id="l9.3721">         return rv;</span>
<a href="#l9.3722"></a><span id="l9.3722">       }</span>
<a href="#l9.3723"></a><span id="l9.3723">     }</span>
<a href="#l9.3724"></a><span id="l9.3724">   }</span>
<a href="#l9.3725"></a><span id="l9.3725"> </span>
<a href="#l9.3726"></a><span id="l9.3726">   /* find whitespace separator if it exits */</span>
<a href="#l9.3727"></a><span id="l9.3727" class="difflineminus">-  for(i=0; line[i] != '\0' &amp;&amp; !NET_IS_SPACE(line[i]); i++)</span>
<a href="#l9.3728"></a><span id="l9.3728" class="difflineminus">-    ;  /* null body */</span>
<a href="#l9.3729"></a><span id="l9.3729" class="difflineplus">+  for (i = 0; line[i] != '\0' &amp;&amp; !NET_IS_SPACE(line[i]); i++)</span>
<a href="#l9.3730"></a><span id="l9.3730" class="difflineplus">+    ; /* null body */</span>
<a href="#l9.3731"></a><span id="l9.3731"> </span>
<a href="#l9.3732"></a><span id="l9.3732">   line[i] = 0; /* terminate group name */</span>
<a href="#l9.3733"></a><span id="l9.3733"> </span>
<a href="#l9.3734"></a><span id="l9.3734">   /* store all the group names */</span>
<a href="#l9.3735"></a><span id="l9.3735">   NS_ASSERTION(m_nntpServer, &quot;no nntp incoming server&quot;);</span>
<a href="#l9.3736"></a><span id="l9.3736">   if (m_nntpServer) {</span>
<a href="#l9.3737"></a><span id="l9.3737">     m_readNewsListCount++;</span>
<a href="#l9.3738"></a><span id="l9.3738">     mNumGroupsListed++;</span>
<a href="#l9.3739"></a><span id="l9.3739">     rv = m_nntpServer-&gt;AddNewsgroupToList(line);</span>
<a href="#l9.3740"></a><span id="l9.3740" class="difflineminus">-//    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to add to subscribe ds&quot;);</span>
<a href="#l9.3741"></a><span id="l9.3741" class="difflineplus">+    //    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to add to subscribe ds&quot;);</span>
<a href="#l9.3742"></a><span id="l9.3742">     // since it's not fatal, don't let this error stop the LIST command.</span>
<a href="#l9.3743"></a><span id="l9.3743">     rv = NS_OK;</span>
<a href="#l9.3744"></a><span id="l9.3744" class="difflineminus">-  }</span>
<a href="#l9.3745"></a><span id="l9.3745" class="difflineminus">-  else</span>
<a href="#l9.3746"></a><span id="l9.3746" class="difflineplus">+  } else</span>
<a href="#l9.3747"></a><span id="l9.3747">     rv = NS_ERROR_FAILURE;</span>
<a href="#l9.3748"></a><span id="l9.3748"> </span>
<a href="#l9.3749"></a><span id="l9.3749">   if (m_readNewsListCount == READ_NEWS_LIST_COUNT_MAX) {</span>
<a href="#l9.3750"></a><span id="l9.3750">     m_readNewsListCount = 0;</span>
<a href="#l9.3751"></a><span id="l9.3751">     if (mUpdateTimer) {</span>
<a href="#l9.3752"></a><span id="l9.3752">       mUpdateTimer-&gt;Cancel();</span>
<a href="#l9.3753"></a><span id="l9.3753">       mUpdateTimer = nullptr;</span>
<a href="#l9.3754"></a><span id="l9.3754">     }</span>
<a href="#l9.3755"></a><span id="l9.3755">     mUpdateTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l9.3756"></a><span id="l9.3756" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create timer&quot;);</span>
<a href="#l9.3757"></a><span id="l9.3757" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create timer&quot;);</span>
<a href="#l9.3758"></a><span id="l9.3758">     if (NS_FAILED(rv)) {</span>
<a href="#l9.3759"></a><span id="l9.3759">       PR_Free(lineToFree);</span>
<a href="#l9.3760"></a><span id="l9.3760">       return rv;</span>
<a href="#l9.3761"></a><span id="l9.3761">     }</span>
<a href="#l9.3762"></a><span id="l9.3762"> </span>
<a href="#l9.3763"></a><span id="l9.3763">     mInputStream = inputStream;</span>
<a href="#l9.3764"></a><span id="l9.3764"> </span>
<a href="#l9.3765"></a><span id="l9.3765">     const uint32_t kUpdateTimerDelay = READ_NEWS_LIST_TIMEOUT;</span>
<a href="#l9.3766"></a><span id="l9.3766" class="difflineminus">-    rv = mUpdateTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback*&gt;(this), kUpdateTimerDelay,</span>
<a href="#l9.3767"></a><span id="l9.3767" class="difflineminus">-      nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l9.3768"></a><span id="l9.3768" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to init timer&quot;);</span>
<a href="#l9.3769"></a><span id="l9.3769" class="difflineplus">+    rv = mUpdateTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback *&gt;(this),</span>
<a href="#l9.3770"></a><span id="l9.3770" class="difflineplus">+                                        kUpdateTimerDelay,</span>
<a href="#l9.3771"></a><span id="l9.3771" class="difflineplus">+                                        nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l9.3772"></a><span id="l9.3772" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to init timer&quot;);</span>
<a href="#l9.3773"></a><span id="l9.3773">     if (NS_FAILED(rv)) {</span>
<a href="#l9.3774"></a><span id="l9.3774">       PR_Free(lineToFree);</span>
<a href="#l9.3775"></a><span id="l9.3775">       return rv;</span>
<a href="#l9.3776"></a><span id="l9.3776">     }</span>
<a href="#l9.3777"></a><span id="l9.3777"> </span>
<a href="#l9.3778"></a><span id="l9.3778">     m_nextState = NNTP_SUSPENDED;</span>
<a href="#l9.3779"></a><span id="l9.3779"> </span>
<a href="#l9.3780"></a><span id="l9.3780">     // suspend necko request until timeout</span>
<a href="#l9.3781"></a><span id="l9.3781">     // might not have a request if someone called CloseSocket()</span>
<a href="#l9.3782"></a><span id="l9.3782">     // see bug #195440</span>
<a href="#l9.3783"></a><span id="l9.3783" class="difflineminus">-    if (m_request)</span>
<a href="#l9.3784"></a><span id="l9.3784" class="difflineminus">-      m_request-&gt;Suspend();</span>
<a href="#l9.3785"></a><span id="l9.3785" class="difflineplus">+    if (m_request) m_request-&gt;Suspend();</span>
<a href="#l9.3786"></a><span id="l9.3786">   }</span>
<a href="#l9.3787"></a><span id="l9.3787"> </span>
<a href="#l9.3788"></a><span id="l9.3788">   PR_Free(lineToFree);</span>
<a href="#l9.3789"></a><span id="l9.3789">   return rv;</span>
<a href="#l9.3790"></a><span id="l9.3790"> }</span>
<a href="#l9.3791"></a><span id="l9.3791"> </span>
<a href="#l9.3792"></a><span id="l9.3792"> NS_IMETHODIMP</span>
<a href="#l9.3793"></a><span id="l9.3793" class="difflineminus">-nsNNTPProtocol::Notify(nsITimer *timer)</span>
<a href="#l9.3794"></a><span id="l9.3794" class="difflineminus">-{</span>
<a href="#l9.3795"></a><span id="l9.3795" class="difflineplus">+nsNNTPProtocol::Notify(nsITimer *timer) {</span>
<a href="#l9.3796"></a><span id="l9.3796">   NS_ASSERTION(timer == mUpdateTimer.get(), &quot;Hey, this ain't my timer!&quot;);</span>
<a href="#l9.3797"></a><span id="l9.3797" class="difflineminus">-  mUpdateTimer = nullptr;    // release my hold</span>
<a href="#l9.3798"></a><span id="l9.3798" class="difflineplus">+  mUpdateTimer = nullptr;  // release my hold</span>
<a href="#l9.3799"></a><span id="l9.3799">   TimerCallback();</span>
<a href="#l9.3800"></a><span id="l9.3800">   return NS_OK;</span>
<a href="#l9.3801"></a><span id="l9.3801"> }</span>
<a href="#l9.3802"></a><span id="l9.3802"> </span>
<a href="#l9.3803"></a><span id="l9.3803" class="difflineminus">-void nsNNTPProtocol::TimerCallback()</span>
<a href="#l9.3804"></a><span id="l9.3804" class="difflineminus">-{</span>
<a href="#l9.3805"></a><span id="l9.3805" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;nsNNTPProtocol::TimerCallback\n&quot;));</span>
<a href="#l9.3806"></a><span id="l9.3806" class="difflineplus">+void nsNNTPProtocol::TimerCallback() {</span>
<a href="#l9.3807"></a><span id="l9.3807" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;nsNNTPProtocol::TimerCallback\n&quot;));</span>
<a href="#l9.3808"></a><span id="l9.3808">   m_nextState = NNTP_READ_LIST;</span>
<a href="#l9.3809"></a><span id="l9.3809"> </span>
<a href="#l9.3810"></a><span id="l9.3810">   // process whatever is already in the buffer at least once.</span>
<a href="#l9.3811"></a><span id="l9.3811">   //</span>
<a href="#l9.3812"></a><span id="l9.3812">   // NOTE: while downloading, it would almost be enough to just</span>
<a href="#l9.3813"></a><span id="l9.3813">   // resume necko since it will call us again with data.  however,</span>
<a href="#l9.3814"></a><span id="l9.3814">   // if we are at the end of the data stream then we must call</span>
<a href="#l9.3815"></a><span id="l9.3815">   // ProcessProtocolState since necko will not call us again.</span>
<a href="#l9.3816"></a><span id="l9.3816">   //</span>
<a href="#l9.3817"></a><span id="l9.3817">   // NOTE: this function may Suspend necko.  Suspend is a reference</span>
<a href="#l9.3818"></a><span id="l9.3818">   // counted (i.e., two suspends requires two resumes before the</span>
<a href="#l9.3819"></a><span id="l9.3819">   // request will actually be resumed).</span>
<a href="#l9.3820"></a><span id="l9.3820">   //</span>
<a href="#l9.3821"></a><span id="l9.3821" class="difflineminus">-  ProcessProtocolState(nullptr, mInputStream, 0,0);</span>
<a href="#l9.3822"></a><span id="l9.3822" class="difflineplus">+  ProcessProtocolState(nullptr, mInputStream, 0, 0);</span>
<a href="#l9.3823"></a><span id="l9.3823"> </span>
<a href="#l9.3824"></a><span id="l9.3824">   // resume necko request</span>
<a href="#l9.3825"></a><span id="l9.3825">   // might not have a request if someone called CloseSocket()</span>
<a href="#l9.3826"></a><span id="l9.3826">   // see bug #195440</span>
<a href="#l9.3827"></a><span id="l9.3827" class="difflineminus">-  if (m_request)</span>
<a href="#l9.3828"></a><span id="l9.3828" class="difflineminus">-    m_request-&gt;Resume();</span>
<a href="#l9.3829"></a><span id="l9.3829" class="difflineplus">+  if (m_request) m_request-&gt;Resume();</span>
<a href="#l9.3830"></a><span id="l9.3830"> </span>
<a href="#l9.3831"></a><span id="l9.3831">   return;</span>
<a href="#l9.3832"></a><span id="l9.3832"> }</span>
<a href="#l9.3833"></a><span id="l9.3833"> </span>
<a href="#l9.3834"></a><span id="l9.3834" class="difflineminus">-void nsNNTPProtocol::HandleAuthenticationFailure()</span>
<a href="#l9.3835"></a><span id="l9.3835" class="difflineminus">-{</span>
<a href="#l9.3836"></a><span id="l9.3836" class="difflineplus">+void nsNNTPProtocol::HandleAuthenticationFailure() {</span>
<a href="#l9.3837"></a><span id="l9.3837">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryInterface(m_nntpServer));</span>
<a href="#l9.3838"></a><span id="l9.3838">   nsCString hostname;</span>
<a href="#l9.3839"></a><span id="l9.3839">   server-&gt;GetRealHostName(hostname);</span>
<a href="#l9.3840"></a><span id="l9.3840">   nsCString username;</span>
<a href="#l9.3841"></a><span id="l9.3841">   server-&gt;GetRealUsername(username);</span>
<a href="#l9.3842"></a><span id="l9.3842">   nsString accountname;</span>
<a href="#l9.3843"></a><span id="l9.3843">   server-&gt;GetPrettyName(accountname);</span>
<a href="#l9.3844"></a><span id="l9.3844"> </span>
<a href="#l9.3845"></a><span id="l9.3845">   int32_t choice = 1;</span>
<a href="#l9.3846"></a><span id="l9.3846">   MsgPromptLoginFailed(m_msgWindow, hostname, username, accountname, &amp;choice);</span>
<a href="#l9.3847"></a><span id="l9.3847"> </span>
<a href="#l9.3848"></a><span id="l9.3848" class="difflineminus">-  if (choice == 1) // Cancel</span>
<a href="#l9.3849"></a><span id="l9.3849" class="difflineplus">+  if (choice == 1)  // Cancel</span>
<a href="#l9.3850"></a><span id="l9.3850">   {</span>
<a href="#l9.3851"></a><span id="l9.3851">     // When the user requests to cancel the connection, we can't do anything</span>
<a href="#l9.3852"></a><span id="l9.3852">     // anymore.</span>
<a href="#l9.3853"></a><span id="l9.3853">     NNTP_LOG_NOTE(&quot;Password failed, user opted to cancel connection&quot;);</span>
<a href="#l9.3854"></a><span id="l9.3854">     m_nextState = NNTP_ERROR;</span>
<a href="#l9.3855"></a><span id="l9.3855">     return;</span>
<a href="#l9.3856"></a><span id="l9.3856">   }</span>
<a href="#l9.3857"></a><span id="l9.3857"> </span>
<a href="#l9.3858"></a><span id="l9.3858" class="difflineminus">-  if (choice == 2) // New password</span>
<a href="#l9.3859"></a><span id="l9.3859" class="difflineplus">+  if (choice == 2)  // New password</span>
<a href="#l9.3860"></a><span id="l9.3860">   {</span>
<a href="#l9.3861"></a><span id="l9.3861">     NNTP_LOG_NOTE(&quot;Password failed, user opted to enter new password&quot;);</span>
<a href="#l9.3862"></a><span id="l9.3862">     NS_ASSERTION(m_newsFolder, &quot;no newsFolder&quot;);</span>
<a href="#l9.3863"></a><span id="l9.3863">     m_newsFolder-&gt;ForgetAuthenticationCredentials();</span>
<a href="#l9.3864"></a><span id="l9.3864" class="difflineminus">-  }</span>
<a href="#l9.3865"></a><span id="l9.3865" class="difflineminus">-  else if (choice == 0) // Retry</span>
<a href="#l9.3866"></a><span id="l9.3866" class="difflineplus">+  } else if (choice == 0)  // Retry</span>
<a href="#l9.3867"></a><span id="l9.3867">   {</span>
<a href="#l9.3868"></a><span id="l9.3868">     NNTP_LOG_NOTE(&quot;Password failed, user opted to retry&quot;);</span>
<a href="#l9.3869"></a><span id="l9.3869">   }</span>
<a href="#l9.3870"></a><span id="l9.3870"> </span>
<a href="#l9.3871"></a><span id="l9.3871">   // At this point, we've either forgotten the password or opted to retry. In</span>
<a href="#l9.3872"></a><span id="l9.3872">   // both cases, we need to try to auth with the password again, so return to</span>
<a href="#l9.3873"></a><span id="l9.3873">   // the authentication state.</span>
<a href="#l9.3874"></a><span id="l9.3874">   m_nextState = NNTP_BEGIN_AUTHORIZE;</span>
<a href="#l9.3875"></a><span id="l9.3875"> }</span>
<a href="#l9.3876"></a><span id="l9.3876"> </span>
<a href="#l9.3877"></a><span id="l9.3877"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.3878"></a><span id="l9.3878"> // XOVER, XHDR, and HEAD processing code</span>
<a href="#l9.3879"></a><span id="l9.3879"> // Used for filters</span>
<a href="#l9.3880"></a><span id="l9.3880"> // State machine explanation located in doxygen comments for nsNNTPProtocol</span>
<a href="#l9.3881"></a><span id="l9.3881"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.3882"></a><span id="l9.3882"> </span>
<a href="#l9.3883"></a><span id="l9.3883" class="difflineminus">-nsresult nsNNTPProtocol::BeginReadXover()</span>
<a href="#l9.3884"></a><span id="l9.3884" class="difflineminus">-{</span>
<a href="#l9.3885"></a><span id="l9.3885" class="difflineminus">-  int32_t count;     /* Response fields */</span>
<a href="#l9.3886"></a><span id="l9.3886" class="difflineplus">+nsresult nsNNTPProtocol::BeginReadXover() {</span>
<a href="#l9.3887"></a><span id="l9.3887" class="difflineplus">+  int32_t count; /* Response fields */</span>
<a href="#l9.3888"></a><span id="l9.3888">   nsresult rv = NS_OK;</span>
<a href="#l9.3889"></a><span id="l9.3889"> </span>
<a href="#l9.3890"></a><span id="l9.3890">   rv = SetCurrentGroup();</span>
<a href="#l9.3891"></a><span id="l9.3891">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3892"></a><span id="l9.3892"> </span>
<a href="#l9.3893"></a><span id="l9.3893">   /* Make sure we never close and automatically reopen the connection at this</span>
<a href="#l9.3894"></a><span id="l9.3894">   point; we'll confuse libmsg too much... */</span>
<a href="#l9.3895"></a><span id="l9.3895"> </span>
<a href="#l9.3896"></a><span id="l9.3896">   SetFlag(NNTP_SOME_PROTOCOL_SUCCEEDED);</span>
<a href="#l9.3897"></a><span id="l9.3897"> </span>
<a href="#l9.3898"></a><span id="l9.3898">   /* We have just issued a GROUP command and read the response.</span>
<a href="#l9.3899"></a><span id="l9.3899">   Now parse that response to help decide which articles to request</span>
<a href="#l9.3900"></a><span id="l9.3900">   xover data for.</span>
<a href="#l9.3901"></a><span id="l9.3901">    */</span>
<a href="#l9.3902"></a><span id="l9.3902" class="difflineminus">-  PR_sscanf(m_responseText,</span>
<a href="#l9.3903"></a><span id="l9.3903" class="difflineminus">-    &quot;%d %d %d&quot;,</span>
<a href="#l9.3904"></a><span id="l9.3904" class="difflineminus">-    &amp;count,</span>
<a href="#l9.3905"></a><span id="l9.3905" class="difflineminus">-    &amp;m_firstPossibleArticle,</span>
<a href="#l9.3906"></a><span id="l9.3906" class="difflineminus">-    &amp;m_lastPossibleArticle);</span>
<a href="#l9.3907"></a><span id="l9.3907" class="difflineplus">+  PR_sscanf(m_responseText, &quot;%d %d %d&quot;, &amp;count, &amp;m_firstPossibleArticle,</span>
<a href="#l9.3908"></a><span id="l9.3908" class="difflineplus">+            &amp;m_lastPossibleArticle);</span>
<a href="#l9.3909"></a><span id="l9.3909"> </span>
<a href="#l9.3910"></a><span id="l9.3910">   m_newsgroupList = do_CreateInstance(NS_NNTPNEWSGROUPLIST_CONTRACTID, &amp;rv);</span>
<a href="#l9.3911"></a><span id="l9.3911">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3912"></a><span id="l9.3912"> </span>
<a href="#l9.3913"></a><span id="l9.3913">   rv = m_newsgroupList-&gt;Initialize(m_runningURL, m_newsFolder);</span>
<a href="#l9.3914"></a><span id="l9.3914">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3915"></a><span id="l9.3915"> </span>
<a href="#l9.3916"></a><span id="l9.3916" class="difflineminus">-  rv = m_newsFolder-&gt;UpdateSummaryFromNNTPInfo(m_firstPossibleArticle, m_lastPossibleArticle, count);</span>
<a href="#l9.3917"></a><span id="l9.3917" class="difflineplus">+  rv = m_newsFolder-&gt;UpdateSummaryFromNNTPInfo(m_firstPossibleArticle,</span>
<a href="#l9.3918"></a><span id="l9.3918" class="difflineplus">+                                               m_lastPossibleArticle, count);</span>
<a href="#l9.3919"></a><span id="l9.3919">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3920"></a><span id="l9.3920"> </span>
<a href="#l9.3921"></a><span id="l9.3921">   m_numArticlesLoaded = 0;</span>
<a href="#l9.3922"></a><span id="l9.3922"> </span>
<a href="#l9.3923"></a><span id="l9.3923">   // if the user sets max_articles to a bogus value, get them everything</span>
<a href="#l9.3924"></a><span id="l9.3924">   m_numArticlesWanted = m_maxArticles &gt; 0 ? m_maxArticles : 1L &lt;&lt; 30;</span>
<a href="#l9.3925"></a><span id="l9.3925"> </span>
<a href="#l9.3926"></a><span id="l9.3926">   m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l9.3927"></a><span id="l9.3927">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3928"></a><span id="l9.3928">   return NS_OK;</span>
<a href="#l9.3929"></a><span id="l9.3929"> }</span>
<a href="#l9.3930"></a><span id="l9.3930"> </span>
<a href="#l9.3931"></a><span id="l9.3931" class="difflineminus">-nsresult nsNNTPProtocol::FigureNextChunk()</span>
<a href="#l9.3932"></a><span id="l9.3932" class="difflineminus">-{</span>
<a href="#l9.3933"></a><span id="l9.3933" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l9.3934"></a><span id="l9.3934" class="difflineplus">+nsresult nsNNTPProtocol::FigureNextChunk() {</span>
<a href="#l9.3935"></a><span id="l9.3935" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l9.3936"></a><span id="l9.3936">   int32_t status = 0;</span>
<a href="#l9.3937"></a><span id="l9.3937"> </span>
<a href="#l9.3938"></a><span id="l9.3938" class="difflineminus">-  if (m_firstArticle &gt; 0)</span>
<a href="#l9.3939"></a><span id="l9.3939" class="difflineminus">-  {</span>
<a href="#l9.3940"></a><span id="l9.3940" class="difflineminus">-      MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) add to known articles:  %d - %d&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l9.3941"></a><span id="l9.3941" class="difflineminus">-</span>
<a href="#l9.3942"></a><span id="l9.3942" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; m_newsgroupList) {</span>
<a href="#l9.3943"></a><span id="l9.3943" class="difflineminus">-          rv = m_newsgroupList-&gt;AddToKnownArticles(m_firstArticle,</span>
<a href="#l9.3944"></a><span id="l9.3944" class="difflineminus">-                                                 m_lastArticle);</span>
<a href="#l9.3945"></a><span id="l9.3945" class="difflineminus">-      }</span>
<a href="#l9.3946"></a><span id="l9.3946" class="difflineplus">+  if (m_firstArticle &gt; 0) {</span>
<a href="#l9.3947"></a><span id="l9.3947" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.3948"></a><span id="l9.3948" class="difflineplus">+            (&quot;(%p) add to known articles:  %d - %d&quot;, this, m_firstArticle,</span>
<a href="#l9.3949"></a><span id="l9.3949" class="difflineplus">+             m_lastArticle));</span>
<a href="#l9.3950"></a><span id="l9.3950" class="difflineplus">+</span>
<a href="#l9.3951"></a><span id="l9.3951" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; m_newsgroupList) {</span>
<a href="#l9.3952"></a><span id="l9.3952" class="difflineplus">+      rv = m_newsgroupList-&gt;AddToKnownArticles(m_firstArticle, m_lastArticle);</span>
<a href="#l9.3953"></a><span id="l9.3953" class="difflineplus">+    }</span>
<a href="#l9.3954"></a><span id="l9.3954"> </span>
<a href="#l9.3955"></a><span id="l9.3955">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3956"></a><span id="l9.3956">   }</span>
<a href="#l9.3957"></a><span id="l9.3957"> </span>
<a href="#l9.3958"></a><span id="l9.3958" class="difflineminus">-  if (m_numArticlesLoaded &gt;= m_numArticlesWanted)</span>
<a href="#l9.3959"></a><span id="l9.3959" class="difflineminus">-  {</span>
<a href="#l9.3960"></a><span id="l9.3960" class="difflineplus">+  if (m_numArticlesLoaded &gt;= m_numArticlesWanted) {</span>
<a href="#l9.3961"></a><span id="l9.3961">     m_nextState = NEWS_PROCESS_XOVER;</span>
<a href="#l9.3962"></a><span id="l9.3962">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.3963"></a><span id="l9.3963">     return NS_OK;</span>
<a href="#l9.3964"></a><span id="l9.3964">   }</span>
<a href="#l9.3965"></a><span id="l9.3965"> </span>
<a href="#l9.3966"></a><span id="l9.3966" class="difflineminus">-    NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l9.3967"></a><span id="l9.3967" class="difflineminus">-    if (!m_newsgroupList) return NS_ERROR_FAILURE;</span>
<a href="#l9.3968"></a><span id="l9.3968" class="difflineminus">-</span>
<a href="#l9.3969"></a><span id="l9.3969" class="difflineminus">-    bool getOldMessages = false;</span>
<a href="#l9.3970"></a><span id="l9.3970" class="difflineminus">-    if (m_runningURL) {</span>
<a href="#l9.3971"></a><span id="l9.3971" class="difflineminus">-      rv = m_runningURL-&gt;GetGetOldMessages(&amp;getOldMessages);</span>
<a href="#l9.3972"></a><span id="l9.3972" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3973"></a><span id="l9.3973" class="difflineminus">-    }</span>
<a href="#l9.3974"></a><span id="l9.3974" class="difflineminus">-</span>
<a href="#l9.3975"></a><span id="l9.3975" class="difflineminus">-    rv = m_newsgroupList-&gt;SetGetOldMessages(getOldMessages);</span>
<a href="#l9.3976"></a><span id="l9.3976" class="difflineplus">+  NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l9.3977"></a><span id="l9.3977" class="difflineplus">+  if (!m_newsgroupList) return NS_ERROR_FAILURE;</span>
<a href="#l9.3978"></a><span id="l9.3978" class="difflineplus">+</span>
<a href="#l9.3979"></a><span id="l9.3979" class="difflineplus">+  bool getOldMessages = false;</span>
<a href="#l9.3980"></a><span id="l9.3980" class="difflineplus">+  if (m_runningURL) {</span>
<a href="#l9.3981"></a><span id="l9.3981" class="difflineplus">+    rv = m_runningURL-&gt;GetGetOldMessages(&amp;getOldMessages);</span>
<a href="#l9.3982"></a><span id="l9.3982">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3983"></a><span id="l9.3983" class="difflineminus">-</span>
<a href="#l9.3984"></a><span id="l9.3984" class="difflineminus">-    rv = m_newsgroupList-&gt;GetRangeOfArtsToDownload(m_msgWindow,</span>
<a href="#l9.3985"></a><span id="l9.3985" class="difflineminus">-      m_firstPossibleArticle,</span>
<a href="#l9.3986"></a><span id="l9.3986" class="difflineminus">-      m_lastPossibleArticle,</span>
<a href="#l9.3987"></a><span id="l9.3987" class="difflineminus">-      m_numArticlesWanted - m_numArticlesLoaded,</span>
<a href="#l9.3988"></a><span id="l9.3988" class="difflineminus">-      &amp;(m_firstArticle),</span>
<a href="#l9.3989"></a><span id="l9.3989" class="difflineminus">-      &amp;(m_lastArticle),</span>
<a href="#l9.3990"></a><span id="l9.3990" class="difflineminus">-      &amp;status);</span>
<a href="#l9.3991"></a><span id="l9.3991" class="difflineplus">+  }</span>
<a href="#l9.3992"></a><span id="l9.3992" class="difflineplus">+</span>
<a href="#l9.3993"></a><span id="l9.3993" class="difflineplus">+  rv = m_newsgroupList-&gt;SetGetOldMessages(getOldMessages);</span>
<a href="#l9.3994"></a><span id="l9.3994" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.3995"></a><span id="l9.3995" class="difflineplus">+</span>
<a href="#l9.3996"></a><span id="l9.3996" class="difflineplus">+  rv = m_newsgroupList-&gt;GetRangeOfArtsToDownload(</span>
<a href="#l9.3997"></a><span id="l9.3997" class="difflineplus">+      m_msgWindow, m_firstPossibleArticle, m_lastPossibleArticle,</span>
<a href="#l9.3998"></a><span id="l9.3998" class="difflineplus">+      m_numArticlesWanted - m_numArticlesLoaded, &amp;(m_firstArticle),</span>
<a href="#l9.3999"></a><span id="l9.3999" class="difflineplus">+      &amp;(m_lastArticle), &amp;status);</span>
<a href="#l9.4000"></a><span id="l9.4000"> </span>
<a href="#l9.4001"></a><span id="l9.4001">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4002"></a><span id="l9.4002"> </span>
<a href="#l9.4003"></a><span id="l9.4003" class="difflineminus">-  if (m_firstArticle &lt;= 0 || m_firstArticle &gt; m_lastArticle)</span>
<a href="#l9.4004"></a><span id="l9.4004" class="difflineminus">-  {</span>
<a href="#l9.4005"></a><span id="l9.4005" class="difflineplus">+  if (m_firstArticle &lt;= 0 || m_firstArticle &gt; m_lastArticle) {</span>
<a href="#l9.4006"></a><span id="l9.4006">     /* Nothing more to get. */</span>
<a href="#l9.4007"></a><span id="l9.4007">     m_nextState = NEWS_PROCESS_XOVER;</span>
<a href="#l9.4008"></a><span id="l9.4008">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4009"></a><span id="l9.4009">     return NS_OK;</span>
<a href="#l9.4010"></a><span id="l9.4010">   }</span>
<a href="#l9.4011"></a><span id="l9.4011"> </span>
<a href="#l9.4012"></a><span id="l9.4012" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) Chunk will be (%d-%d)&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l9.4013"></a><span id="l9.4013" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.4014"></a><span id="l9.4014" class="difflineplus">+          (&quot;(%p) Chunk will be (%d-%d)&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l9.4015"></a><span id="l9.4015"> </span>
<a href="#l9.4016"></a><span id="l9.4016">   m_articleNumber = m_firstArticle;</span>
<a href="#l9.4017"></a><span id="l9.4017"> </span>
<a href="#l9.4018"></a><span id="l9.4018" class="difflineminus">-    /* was MSG_InitXOVER() */</span>
<a href="#l9.4019"></a><span id="l9.4019" class="difflineminus">-    if (m_newsgroupList) {</span>
<a href="#l9.4020"></a><span id="l9.4020" class="difflineminus">-        rv = m_newsgroupList-&gt;InitXOVER(m_firstArticle, m_lastArticle);</span>
<a href="#l9.4021"></a><span id="l9.4021" class="difflineplus">+  /* was MSG_InitXOVER() */</span>
<a href="#l9.4022"></a><span id="l9.4022" class="difflineplus">+  if (m_newsgroupList) {</span>
<a href="#l9.4023"></a><span id="l9.4023" class="difflineplus">+    rv = m_newsgroupList-&gt;InitXOVER(m_firstArticle, m_lastArticle);</span>
<a href="#l9.4024"></a><span id="l9.4024">   }</span>
<a href="#l9.4025"></a><span id="l9.4025"> </span>
<a href="#l9.4026"></a><span id="l9.4026">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4027"></a><span id="l9.4027"> </span>
<a href="#l9.4028"></a><span id="l9.4028">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4029"></a><span id="l9.4029">   if (TestFlag(NNTP_NO_XOVER_SUPPORT))</span>
<a href="#l9.4030"></a><span id="l9.4030">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l9.4031"></a><span id="l9.4031">   else</span>
<a href="#l9.4032"></a><span id="l9.4032">     m_nextState = NNTP_XOVER_SEND;</span>
<a href="#l9.4033"></a><span id="l9.4033"> </span>
<a href="#l9.4034"></a><span id="l9.4034">   return NS_OK;</span>
<a href="#l9.4035"></a><span id="l9.4035"> }</span>
<a href="#l9.4036"></a><span id="l9.4036"> </span>
<a href="#l9.4037"></a><span id="l9.4037" class="difflineminus">-nsresult nsNNTPProtocol::XoverSend()</span>
<a href="#l9.4038"></a><span id="l9.4038" class="difflineminus">-{</span>
<a href="#l9.4039"></a><span id="l9.4039" class="difflineplus">+nsresult nsNNTPProtocol::XoverSend() {</span>
<a href="#l9.4040"></a><span id="l9.4040">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.4041"></a><span id="l9.4041"> </span>
<a href="#l9.4042"></a><span id="l9.4042" class="difflineminus">-    PR_snprintf(outputBuffer,</span>
<a href="#l9.4043"></a><span id="l9.4043" class="difflineminus">-        OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.4044"></a><span id="l9.4044" class="difflineminus">-        &quot;XOVER %d-%d&quot; CRLF,</span>
<a href="#l9.4045"></a><span id="l9.4045" class="difflineminus">-        m_firstArticle,</span>
<a href="#l9.4046"></a><span id="l9.4046" class="difflineminus">-        m_lastArticle);</span>
<a href="#l9.4047"></a><span id="l9.4047" class="difflineminus">-</span>
<a href="#l9.4048"></a><span id="l9.4048" class="difflineminus">-    m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4049"></a><span id="l9.4049" class="difflineminus">-    m_nextStateAfterResponse = NNTP_XOVER_RESPONSE;</span>
<a href="#l9.4050"></a><span id="l9.4050" class="difflineminus">-    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4051"></a><span id="l9.4051" class="difflineplus">+  PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;XOVER %d-%d&quot; CRLF,</span>
<a href="#l9.4052"></a><span id="l9.4052" class="difflineplus">+              m_firstArticle, m_lastArticle);</span>
<a href="#l9.4053"></a><span id="l9.4053" class="difflineplus">+</span>
<a href="#l9.4054"></a><span id="l9.4054" class="difflineplus">+  m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4055"></a><span id="l9.4055" class="difflineplus">+  m_nextStateAfterResponse = NNTP_XOVER_RESPONSE;</span>
<a href="#l9.4056"></a><span id="l9.4056" class="difflineplus">+  SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4057"></a><span id="l9.4057"> </span>
<a href="#l9.4058"></a><span id="l9.4058">   return SendData(outputBuffer);</span>
<a href="#l9.4059"></a><span id="l9.4059"> }</span>
<a href="#l9.4060"></a><span id="l9.4060"> </span>
<a href="#l9.4061"></a><span id="l9.4061"> /* see if the xover response is going to return us data</span>
<a href="#l9.4062"></a><span id="l9.4062">  * if the proper code isn't returned then assume xover</span>
<a href="#l9.4063"></a><span id="l9.4063">  * isn't supported and use</span>
<a href="#l9.4064"></a><span id="l9.4064">  * normal read_group</span>
<a href="#l9.4065"></a><span id="l9.4065">  */</span>
<a href="#l9.4066"></a><span id="l9.4066"> </span>
<a href="#l9.4067"></a><span id="l9.4067" class="difflineminus">-nsresult nsNNTPProtocol::ReadXoverResponse()</span>
<a href="#l9.4068"></a><span id="l9.4068" class="difflineminus">-{</span>
<a href="#l9.4069"></a><span id="l9.4069" class="difflineplus">+nsresult nsNNTPProtocol::ReadXoverResponse() {</span>
<a href="#l9.4070"></a><span id="l9.4070"> #ifdef TEST_NO_XOVER_SUPPORT</span>
<a href="#l9.4071"></a><span id="l9.4071" class="difflineminus">-  m_responseCode = MK_NNTP_RESPONSE_CHECK_ERROR; /* pretend XOVER generated an error */</span>
<a href="#l9.4072"></a><span id="l9.4072" class="difflineplus">+  m_responseCode =</span>
<a href="#l9.4073"></a><span id="l9.4073" class="difflineplus">+      MK_NNTP_RESPONSE_CHECK_ERROR; /* pretend XOVER generated an error */</span>
<a href="#l9.4074"></a><span id="l9.4074"> #endif</span>
<a href="#l9.4075"></a><span id="l9.4075"> </span>
<a href="#l9.4076"></a><span id="l9.4076" class="difflineminus">-    if(m_responseCode != MK_NNTP_RESPONSE_XOVER_OK)</span>
<a href="#l9.4077"></a><span id="l9.4077" class="difflineminus">-    {</span>
<a href="#l9.4078"></a><span id="l9.4078" class="difflineminus">-        /* If we didn't get back &quot;224 data follows&quot; from the XOVER request,</span>
<a href="#l9.4079"></a><span id="l9.4079" class="difflineminus">-       then that must mean that this server doesn't support XOVER.  Or</span>
<a href="#l9.4080"></a><span id="l9.4080" class="difflineminus">-       maybe the server's XOVER support is busted or something.  So,</span>
<a href="#l9.4081"></a><span id="l9.4081" class="difflineminus">-       in that case, fall back to the very slow HEAD method.</span>
<a href="#l9.4082"></a><span id="l9.4082" class="difflineminus">-</span>
<a href="#l9.4083"></a><span id="l9.4083" class="difflineminus">-       But, while debugging here at HQ, getting into this state means</span>
<a href="#l9.4084"></a><span id="l9.4084" class="difflineminus">-       something went very wrong, since our servers do XOVER.  Thus</span>
<a href="#l9.4085"></a><span id="l9.4085" class="difflineminus">-       the assert.</span>
<a href="#l9.4086"></a><span id="l9.4086" class="difflineminus">-         */</span>
<a href="#l9.4087"></a><span id="l9.4087" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_XOVER_OK) {</span>
<a href="#l9.4088"></a><span id="l9.4088" class="difflineplus">+    /* If we didn't get back &quot;224 data follows&quot; from the XOVER request,</span>
<a href="#l9.4089"></a><span id="l9.4089" class="difflineplus">+   then that must mean that this server doesn't support XOVER.  Or</span>
<a href="#l9.4090"></a><span id="l9.4090" class="difflineplus">+   maybe the server's XOVER support is busted or something.  So,</span>
<a href="#l9.4091"></a><span id="l9.4091" class="difflineplus">+   in that case, fall back to the very slow HEAD method.</span>
<a href="#l9.4092"></a><span id="l9.4092" class="difflineplus">+</span>
<a href="#l9.4093"></a><span id="l9.4093" class="difflineplus">+   But, while debugging here at HQ, getting into this state means</span>
<a href="#l9.4094"></a><span id="l9.4094" class="difflineplus">+   something went very wrong, since our servers do XOVER.  Thus</span>
<a href="#l9.4095"></a><span id="l9.4095" class="difflineplus">+   the assert.</span>
<a href="#l9.4096"></a><span id="l9.4096" class="difflineplus">+     */</span>
<a href="#l9.4097"></a><span id="l9.4097">     /*NS_ASSERTION (0,&quot;something went very wrong&quot;);*/</span>
<a href="#l9.4098"></a><span id="l9.4098">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l9.4099"></a><span id="l9.4099">     SetFlag(NNTP_NO_XOVER_SUPPORT);</span>
<a href="#l9.4100"></a><span id="l9.4100" class="difflineminus">-    }</span>
<a href="#l9.4101"></a><span id="l9.4101" class="difflineminus">-    else</span>
<a href="#l9.4102"></a><span id="l9.4102" class="difflineminus">-    {</span>
<a href="#l9.4103"></a><span id="l9.4103" class="difflineminus">-        m_nextState = NNTP_XOVER;</span>
<a href="#l9.4104"></a><span id="l9.4104" class="difflineminus">-    }</span>
<a href="#l9.4105"></a><span id="l9.4105" class="difflineminus">-</span>
<a href="#l9.4106"></a><span id="l9.4106" class="difflineminus">-    return NS_OK;  /* continue */</span>
<a href="#l9.4107"></a><span id="l9.4107" class="difflineplus">+  } else {</span>
<a href="#l9.4108"></a><span id="l9.4108" class="difflineplus">+    m_nextState = NNTP_XOVER;</span>
<a href="#l9.4109"></a><span id="l9.4109" class="difflineplus">+  }</span>
<a href="#l9.4110"></a><span id="l9.4110" class="difflineplus">+</span>
<a href="#l9.4111"></a><span id="l9.4111" class="difflineplus">+  return NS_OK; /* continue */</span>
<a href="#l9.4112"></a><span id="l9.4112"> }</span>
<a href="#l9.4113"></a><span id="l9.4113"> </span>
<a href="#l9.4114"></a><span id="l9.4114"> /* process the xover list as it comes from the server</span>
<a href="#l9.4115"></a><span id="l9.4115">  * and load it into the sort list.</span>
<a href="#l9.4116"></a><span id="l9.4116">  */</span>
<a href="#l9.4117"></a><span id="l9.4117"> </span>
<a href="#l9.4118"></a><span id="l9.4118" class="difflineminus">-nsresult nsNNTPProtocol::ReadXover(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.4119"></a><span id="l9.4119" class="difflineminus">-{</span>
<a href="#l9.4120"></a><span id="l9.4120" class="difflineplus">+nsresult nsNNTPProtocol::ReadXover(nsIInputStream *inputStream,</span>
<a href="#l9.4121"></a><span id="l9.4121" class="difflineplus">+                                   uint32_t length) {</span>
<a href="#l9.4122"></a><span id="l9.4122">   char *line, *lineToFree;</span>
<a href="#l9.4123"></a><span id="l9.4123">   nsresult rv;</span>
<a href="#l9.4124"></a><span id="l9.4124">   uint32_t status = 1;</span>
<a href="#l9.4125"></a><span id="l9.4125"> </span>
<a href="#l9.4126"></a><span id="l9.4126">   bool pauseForMoreData = false;</span>
<a href="#l9.4127"></a><span id="l9.4127" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.4128"></a><span id="l9.4128" class="difflineminus">-</span>
<a href="#l9.4129"></a><span id="l9.4129" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.4130"></a><span id="l9.4130" class="difflineminus">-  {</span>
<a href="#l9.4131"></a><span id="l9.4131" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.4132"></a><span id="l9.4132" class="difflineplus">+                                                       pauseForMoreData, &amp;rv);</span>
<a href="#l9.4133"></a><span id="l9.4133" class="difflineplus">+</span>
<a href="#l9.4134"></a><span id="l9.4134" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.4135"></a><span id="l9.4135">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4136"></a><span id="l9.4136">     return NS_OK;</span>
<a href="#l9.4137"></a><span id="l9.4137">   }</span>
<a href="#l9.4138"></a><span id="l9.4138"> </span>
<a href="#l9.4139"></a><span id="l9.4139" class="difflineminus">-  if(!line)</span>
<a href="#l9.4140"></a><span id="l9.4140" class="difflineminus">-    return rv;  /* no line yet or TCP error */</span>
<a href="#l9.4141"></a><span id="l9.4141" class="difflineminus">-</span>
<a href="#l9.4142"></a><span id="l9.4142" class="difflineminus">-  if(line[0] == '.' &amp;&amp; line[1] == '\0')</span>
<a href="#l9.4143"></a><span id="l9.4143" class="difflineminus">-  {</span>
<a href="#l9.4144"></a><span id="l9.4144" class="difflineplus">+  if (!line) return rv; /* no line yet or TCP error */</span>
<a href="#l9.4145"></a><span id="l9.4145" class="difflineplus">+</span>
<a href="#l9.4146"></a><span id="l9.4146" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[1] == '\0') {</span>
<a href="#l9.4147"></a><span id="l9.4147">     m_nextState = NNTP_XHDR_SEND;</span>
<a href="#l9.4148"></a><span id="l9.4148">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4149"></a><span id="l9.4149">     PR_Free(lineToFree);</span>
<a href="#l9.4150"></a><span id="l9.4150">     return NS_OK;</span>
<a href="#l9.4151"></a><span id="l9.4151" class="difflineminus">-  }</span>
<a href="#l9.4152"></a><span id="l9.4152" class="difflineminus">-  else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l9.4153"></a><span id="l9.4153" class="difflineplus">+  } else if (line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l9.4154"></a><span id="l9.4154">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l9.4155"></a><span id="l9.4155">     line++;</span>
<a href="#l9.4156"></a><span id="l9.4156"> </span>
<a href="#l9.4157"></a><span id="l9.4157" class="difflineminus">-    /* almost correct</span>
<a href="#l9.4158"></a><span id="l9.4158" class="difflineminus">-  */</span>
<a href="#l9.4159"></a><span id="l9.4159" class="difflineminus">-  if(status &gt; 1)</span>
<a href="#l9.4160"></a><span id="l9.4160" class="difflineminus">-  {</span>
<a href="#l9.4161"></a><span id="l9.4161" class="difflineplus">+  /* almost correct</span>
<a href="#l9.4162"></a><span id="l9.4162" class="difflineplus">+   */</span>
<a href="#l9.4163"></a><span id="l9.4163" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.4164"></a><span id="l9.4164">     mBytesReceived += status;</span>
<a href="#l9.4165"></a><span id="l9.4165">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.4166"></a><span id="l9.4166">   }</span>
<a href="#l9.4167"></a><span id="l9.4167"> </span>
<a href="#l9.4168"></a><span id="l9.4168">   rv = m_newsgroupList-&gt;ProcessXOVERLINE(line, &amp;status);</span>
<a href="#l9.4169"></a><span id="l9.4169">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to process the XOVERLINE&quot;);</span>
<a href="#l9.4170"></a><span id="l9.4170"> </span>
<a href="#l9.4171"></a><span id="l9.4171">   m_numArticlesLoaded++;</span>
<a href="#l9.4172"></a><span id="l9.4172">   PR_Free(lineToFree);</span>
<a href="#l9.4173"></a><span id="l9.4173">   return rv;</span>
<a href="#l9.4174"></a><span id="l9.4174"> }</span>
<a href="#l9.4175"></a><span id="l9.4175"> </span>
<a href="#l9.4176"></a><span id="l9.4176"> /* Finished processing all the XOVER data.</span>
<a href="#l9.4177"></a><span id="l9.4177" class="difflineminus">-*/</span>
<a href="#l9.4178"></a><span id="l9.4178" class="difflineminus">-</span>
<a href="#l9.4179"></a><span id="l9.4179" class="difflineminus">-nsresult nsNNTPProtocol::ProcessXover()</span>
<a href="#l9.4180"></a><span id="l9.4180" class="difflineminus">-{</span>
<a href="#l9.4181"></a><span id="l9.4181" class="difflineplus">+ */</span>
<a href="#l9.4182"></a><span id="l9.4182" class="difflineplus">+</span>
<a href="#l9.4183"></a><span id="l9.4183" class="difflineplus">+nsresult nsNNTPProtocol::ProcessXover() {</span>
<a href="#l9.4184"></a><span id="l9.4184">   nsresult rv;</span>
<a href="#l9.4185"></a><span id="l9.4185"> </span>
<a href="#l9.4186"></a><span id="l9.4186">   /* xover_parse_state stored in MSG_Pane cd-&gt;pane */</span>
<a href="#l9.4187"></a><span id="l9.4187">   NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l9.4188"></a><span id="l9.4188">   if (!m_newsgroupList) return NS_ERROR_FAILURE;</span>
<a href="#l9.4189"></a><span id="l9.4189"> </span>
<a href="#l9.4190"></a><span id="l9.4190">   // Some people may use the notifications in CallFilters to close the cached</span>
<a href="#l9.4191"></a><span id="l9.4191">   // connections, which will clear m_newsgroupList. So we keep a copy for</span>
<a href="#l9.4192"></a><span id="l9.4192" class="difflineat">@@ -3206,400 +2999,360 @@ nsresult nsNNTPProtocol::ProcessXover()</span>
<a href="#l9.4193"></a><span id="l9.4193">   m_newsgroupList = nullptr;</span>
<a href="#l9.4194"></a><span id="l9.4194">   if (NS_SUCCEEDED(rv) &amp;&amp; status &lt; 0) return NS_ERROR_FAILURE;</span>
<a href="#l9.4195"></a><span id="l9.4195"> </span>
<a href="#l9.4196"></a><span id="l9.4196">   m_nextState = NEWS_DONE;</span>
<a href="#l9.4197"></a><span id="l9.4197"> </span>
<a href="#l9.4198"></a><span id="l9.4198">   return NS_OK;</span>
<a href="#l9.4199"></a><span id="l9.4199"> }</span>
<a href="#l9.4200"></a><span id="l9.4200"> </span>
<a href="#l9.4201"></a><span id="l9.4201" class="difflineminus">-nsresult nsNNTPProtocol::XhdrSend()</span>
<a href="#l9.4202"></a><span id="l9.4202" class="difflineminus">-{</span>
<a href="#l9.4203"></a><span id="l9.4203" class="difflineplus">+nsresult nsNNTPProtocol::XhdrSend() {</span>
<a href="#l9.4204"></a><span id="l9.4204">   nsCString header;</span>
<a href="#l9.4205"></a><span id="l9.4205">   m_newsgroupList-&gt;InitXHDR(header);</span>
<a href="#l9.4206"></a><span id="l9.4206" class="difflineminus">-  if (header.IsEmpty())</span>
<a href="#l9.4207"></a><span id="l9.4207" class="difflineminus">-  {</span>
<a href="#l9.4208"></a><span id="l9.4208" class="difflineplus">+  if (header.IsEmpty()) {</span>
<a href="#l9.4209"></a><span id="l9.4209">     m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l9.4210"></a><span id="l9.4210">     return NS_OK;</span>
<a href="#l9.4211"></a><span id="l9.4211">   }</span>
<a href="#l9.4212"></a><span id="l9.4212"> </span>
<a href="#l9.4213"></a><span id="l9.4213">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.4214"></a><span id="l9.4214">   PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;XHDR %s %d-%d&quot; CRLF,</span>
<a href="#l9.4215"></a><span id="l9.4215">               header.get(), m_firstArticle, m_lastArticle);</span>
<a href="#l9.4216"></a><span id="l9.4216"> </span>
<a href="#l9.4217"></a><span id="l9.4217">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4218"></a><span id="l9.4218">   m_nextStateAfterResponse = NNTP_XHDR_RESPONSE;</span>
<a href="#l9.4219"></a><span id="l9.4219">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4220"></a><span id="l9.4220"> </span>
<a href="#l9.4221"></a><span id="l9.4221">   return SendData(outputBuffer);</span>
<a href="#l9.4222"></a><span id="l9.4222"> }</span>
<a href="#l9.4223"></a><span id="l9.4223"> </span>
<a href="#l9.4224"></a><span id="l9.4224" class="difflineminus">-nsresult nsNNTPProtocol::XhdrResponse(nsIInputStream *inputStream)</span>
<a href="#l9.4225"></a><span id="l9.4225" class="difflineminus">-{</span>
<a href="#l9.4226"></a><span id="l9.4226" class="difflineminus">-  if (m_responseCode != MK_NNTP_RESPONSE_XHDR_OK)</span>
<a href="#l9.4227"></a><span id="l9.4227" class="difflineminus">-  {</span>
<a href="#l9.4228"></a><span id="l9.4228" class="difflineplus">+nsresult nsNNTPProtocol::XhdrResponse(nsIInputStream *inputStream) {</span>
<a href="#l9.4229"></a><span id="l9.4229" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_XHDR_OK) {</span>
<a href="#l9.4230"></a><span id="l9.4230">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l9.4231"></a><span id="l9.4231">     // The reasoning behind setting this flag and not an XHDR flag is that we</span>
<a href="#l9.4232"></a><span id="l9.4232">     // are going to have to use HEAD instead. At that point, using XOVER as</span>
<a href="#l9.4233"></a><span id="l9.4233">     // well is just wasting bandwidth.</span>
<a href="#l9.4234"></a><span id="l9.4234">     SetFlag(NNTP_NO_XOVER_SUPPORT);</span>
<a href="#l9.4235"></a><span id="l9.4235">     return NS_OK;</span>
<a href="#l9.4236"></a><span id="l9.4236">   }</span>
<a href="#l9.4237"></a><span id="l9.4237"> </span>
<a href="#l9.4238"></a><span id="l9.4238">   char *line, *lineToFree;</span>
<a href="#l9.4239"></a><span id="l9.4239">   nsresult rv;</span>
<a href="#l9.4240"></a><span id="l9.4240">   uint32_t status = 1;</span>
<a href="#l9.4241"></a><span id="l9.4241"> </span>
<a href="#l9.4242"></a><span id="l9.4242">   bool pauseForMoreData = false;</span>
<a href="#l9.4243"></a><span id="l9.4243" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.4244"></a><span id="l9.4244" class="difflineminus">-</span>
<a href="#l9.4245"></a><span id="l9.4245" class="difflineminus">-  if (pauseForMoreData)</span>
<a href="#l9.4246"></a><span id="l9.4246" class="difflineminus">-  {</span>
<a href="#l9.4247"></a><span id="l9.4247" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.4248"></a><span id="l9.4248" class="difflineplus">+                                                       pauseForMoreData, &amp;rv);</span>
<a href="#l9.4249"></a><span id="l9.4249" class="difflineplus">+</span>
<a href="#l9.4250"></a><span id="l9.4250" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.4251"></a><span id="l9.4251">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4252"></a><span id="l9.4252">     return NS_OK;</span>
<a href="#l9.4253"></a><span id="l9.4253">   }</span>
<a href="#l9.4254"></a><span id="l9.4254"> </span>
<a href="#l9.4255"></a><span id="l9.4255" class="difflineminus">-  if (!line)</span>
<a href="#l9.4256"></a><span id="l9.4256" class="difflineminus">-    return rv;  /* no line yet or TCP error */</span>
<a href="#l9.4257"></a><span id="l9.4257" class="difflineminus">-</span>
<a href="#l9.4258"></a><span id="l9.4258" class="difflineminus">-  if (line[0] == '.' &amp;&amp; line[1] == '\0')</span>
<a href="#l9.4259"></a><span id="l9.4259" class="difflineminus">-  {</span>
<a href="#l9.4260"></a><span id="l9.4260" class="difflineplus">+  if (!line) return rv; /* no line yet or TCP error */</span>
<a href="#l9.4261"></a><span id="l9.4261" class="difflineplus">+</span>
<a href="#l9.4262"></a><span id="l9.4262" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[1] == '\0') {</span>
<a href="#l9.4263"></a><span id="l9.4263">     m_nextState = NNTP_XHDR_SEND;</span>
<a href="#l9.4264"></a><span id="l9.4264">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4265"></a><span id="l9.4265">     PR_Free(lineToFree);</span>
<a href="#l9.4266"></a><span id="l9.4266">     return NS_OK;</span>
<a href="#l9.4267"></a><span id="l9.4267">   }</span>
<a href="#l9.4268"></a><span id="l9.4268"> </span>
<a href="#l9.4269"></a><span id="l9.4269" class="difflineminus">-  if (status &gt; 1)</span>
<a href="#l9.4270"></a><span id="l9.4270" class="difflineminus">-  {</span>
<a href="#l9.4271"></a><span id="l9.4271" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.4272"></a><span id="l9.4272">     mBytesReceived += status;</span>
<a href="#l9.4273"></a><span id="l9.4273">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.4274"></a><span id="l9.4274">   }</span>
<a href="#l9.4275"></a><span id="l9.4275"> </span>
<a href="#l9.4276"></a><span id="l9.4276">   rv = m_newsgroupList-&gt;ProcessXHDRLine(nsDependentCString(line));</span>
<a href="#l9.4277"></a><span id="l9.4277">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to process the XHDRLINE&quot;);</span>
<a href="#l9.4278"></a><span id="l9.4278"> </span>
<a href="#l9.4279"></a><span id="l9.4279">   m_numArticlesLoaded++;</span>
<a href="#l9.4280"></a><span id="l9.4280">   PR_Free(lineToFree);</span>
<a href="#l9.4281"></a><span id="l9.4281">   return rv;</span>
<a href="#l9.4282"></a><span id="l9.4282"> }</span>
<a href="#l9.4283"></a><span id="l9.4283"> </span>
<a href="#l9.4284"></a><span id="l9.4284" class="difflineminus">-nsresult nsNNTPProtocol::ReadHeaders()</span>
<a href="#l9.4285"></a><span id="l9.4285" class="difflineminus">-{</span>
<a href="#l9.4286"></a><span id="l9.4286" class="difflineminus">-  if(m_articleNumber &gt; m_lastArticle)</span>
<a href="#l9.4287"></a><span id="l9.4287" class="difflineminus">-  {  /* end of groups */</span>
<a href="#l9.4288"></a><span id="l9.4288" class="difflineplus">+nsresult nsNNTPProtocol::ReadHeaders() {</span>
<a href="#l9.4289"></a><span id="l9.4289" class="difflineplus">+  if (m_articleNumber &gt; m_lastArticle) { /* end of groups */</span>
<a href="#l9.4290"></a><span id="l9.4290"> </span>
<a href="#l9.4291"></a><span id="l9.4291">     m_newsgroupList-&gt;InitHEAD(-1);</span>
<a href="#l9.4292"></a><span id="l9.4292">     m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l9.4293"></a><span id="l9.4293">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4294"></a><span id="l9.4294">     return NS_OK;</span>
<a href="#l9.4295"></a><span id="l9.4295" class="difflineminus">-  }</span>
<a href="#l9.4296"></a><span id="l9.4296" class="difflineminus">-  else</span>
<a href="#l9.4297"></a><span id="l9.4297" class="difflineminus">-  {</span>
<a href="#l9.4298"></a><span id="l9.4298" class="difflineplus">+  } else {</span>
<a href="#l9.4299"></a><span id="l9.4299">     m_newsgroupList-&gt;InitHEAD(m_articleNumber);</span>
<a href="#l9.4300"></a><span id="l9.4300"> </span>
<a href="#l9.4301"></a><span id="l9.4301">     char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.4302"></a><span id="l9.4302" class="difflineminus">-    PR_snprintf(outputBuffer,</span>
<a href="#l9.4303"></a><span id="l9.4303" class="difflineminus">-      OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.4304"></a><span id="l9.4304" class="difflineminus">-      &quot;HEAD %ld&quot; CRLF,</span>
<a href="#l9.4305"></a><span id="l9.4305" class="difflineminus">-      m_articleNumber++);</span>
<a href="#l9.4306"></a><span id="l9.4306" class="difflineplus">+    PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;HEAD %ld&quot; CRLF,</span>
<a href="#l9.4307"></a><span id="l9.4307" class="difflineplus">+                m_articleNumber++);</span>
<a href="#l9.4308"></a><span id="l9.4308">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4309"></a><span id="l9.4309">     m_nextStateAfterResponse = NNTP_READ_GROUP_RESPONSE;</span>
<a href="#l9.4310"></a><span id="l9.4310"> </span>
<a href="#l9.4311"></a><span id="l9.4311">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4312"></a><span id="l9.4312">     return SendData(outputBuffer);</span>
<a href="#l9.4313"></a><span id="l9.4313">   }</span>
<a href="#l9.4314"></a><span id="l9.4314"> }</span>
<a href="#l9.4315"></a><span id="l9.4315"> </span>
<a href="#l9.4316"></a><span id="l9.4316"> /* See if the &quot;HEAD&quot; command was successful</span>
<a href="#l9.4317"></a><span id="l9.4317" class="difflineminus">-*/</span>
<a href="#l9.4318"></a><span id="l9.4318" class="difflineminus">-</span>
<a href="#l9.4319"></a><span id="l9.4319" class="difflineminus">-nsresult nsNNTPProtocol::ReadNewsgroupResponse()</span>
<a href="#l9.4320"></a><span id="l9.4320" class="difflineminus">-{</span>
<a href="#l9.4321"></a><span id="l9.4321" class="difflineminus">-  if (m_responseCode == MK_NNTP_RESPONSE_ARTICLE_HEAD)</span>
<a href="#l9.4322"></a><span id="l9.4322" class="difflineminus">-  {     /* Head follows - parse it:*/</span>
<a href="#l9.4323"></a><span id="l9.4323" class="difflineplus">+ */</span>
<a href="#l9.4324"></a><span id="l9.4324" class="difflineplus">+</span>
<a href="#l9.4325"></a><span id="l9.4325" class="difflineplus">+nsresult nsNNTPProtocol::ReadNewsgroupResponse() {</span>
<a href="#l9.4326"></a><span id="l9.4326" class="difflineplus">+  if (m_responseCode ==</span>
<a href="#l9.4327"></a><span id="l9.4327" class="difflineplus">+      MK_NNTP_RESPONSE_ARTICLE_HEAD) { /* Head follows - parse it:*/</span>
<a href="#l9.4328"></a><span id="l9.4328">     m_nextState = NNTP_READ_GROUP_BODY;</span>
<a href="#l9.4329"></a><span id="l9.4329"> </span>
<a href="#l9.4330"></a><span id="l9.4330">     return NS_OK;</span>
<a href="#l9.4331"></a><span id="l9.4331" class="difflineminus">-  }</span>
<a href="#l9.4332"></a><span id="l9.4332" class="difflineminus">-  else</span>
<a href="#l9.4333"></a><span id="l9.4333" class="difflineminus">-  {</span>
<a href="#l9.4334"></a><span id="l9.4334" class="difflineplus">+  } else {</span>
<a href="#l9.4335"></a><span id="l9.4335">     m_newsgroupList-&gt;HEADFailed(m_articleNumber);</span>
<a href="#l9.4336"></a><span id="l9.4336">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l9.4337"></a><span id="l9.4337">     return NS_OK;</span>
<a href="#l9.4338"></a><span id="l9.4338">   }</span>
<a href="#l9.4339"></a><span id="l9.4339"> }</span>
<a href="#l9.4340"></a><span id="l9.4340"> </span>
<a href="#l9.4341"></a><span id="l9.4341"> /* read the body of the &quot;HEAD&quot; command</span>
<a href="#l9.4342"></a><span id="l9.4342" class="difflineminus">-*/</span>
<a href="#l9.4343"></a><span id="l9.4343" class="difflineminus">-nsresult nsNNTPProtocol::ReadNewsgroupBody(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.4344"></a><span id="l9.4344" class="difflineminus">-{</span>
<a href="#l9.4345"></a><span id="l9.4345" class="difflineplus">+ */</span>
<a href="#l9.4346"></a><span id="l9.4346" class="difflineplus">+nsresult nsNNTPProtocol::ReadNewsgroupBody(nsIInputStream *inputStream,</span>
<a href="#l9.4347"></a><span id="l9.4347" class="difflineplus">+                                           uint32_t length) {</span>
<a href="#l9.4348"></a><span id="l9.4348">   char *line, *lineToFree;</span>
<a href="#l9.4349"></a><span id="l9.4349">   nsresult rv;</span>
<a href="#l9.4350"></a><span id="l9.4350">   uint32_t status = 1;</span>
<a href="#l9.4351"></a><span id="l9.4351"> </span>
<a href="#l9.4352"></a><span id="l9.4352">   bool pauseForMoreData = false;</span>
<a href="#l9.4353"></a><span id="l9.4353" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.4354"></a><span id="l9.4354" class="difflineminus">-</span>
<a href="#l9.4355"></a><span id="l9.4355" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.4356"></a><span id="l9.4356" class="difflineminus">-  {</span>
<a href="#l9.4357"></a><span id="l9.4357" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.4358"></a><span id="l9.4358" class="difflineplus">+                                                       pauseForMoreData, &amp;rv);</span>
<a href="#l9.4359"></a><span id="l9.4359" class="difflineplus">+</span>
<a href="#l9.4360"></a><span id="l9.4360" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.4361"></a><span id="l9.4361">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4362"></a><span id="l9.4362">     return NS_OK;</span>
<a href="#l9.4363"></a><span id="l9.4363">   }</span>
<a href="#l9.4364"></a><span id="l9.4364"> </span>
<a href="#l9.4365"></a><span id="l9.4365">   /* if TCP error of if there is not a full line yet return</span>
<a href="#l9.4366"></a><span id="l9.4366" class="difflineminus">-  */</span>
<a href="#l9.4367"></a><span id="l9.4367" class="difflineminus">-  if(!line)</span>
<a href="#l9.4368"></a><span id="l9.4368" class="difflineminus">-    return rv;</span>
<a href="#l9.4369"></a><span id="l9.4369" class="difflineminus">-</span>
<a href="#l9.4370"></a><span id="l9.4370" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) read_group_body: got line: %s|&quot;,this,line));</span>
<a href="#l9.4371"></a><span id="l9.4371" class="difflineplus">+   */</span>
<a href="#l9.4372"></a><span id="l9.4372" class="difflineplus">+  if (!line) return rv;</span>
<a href="#l9.4373"></a><span id="l9.4373" class="difflineplus">+</span>
<a href="#l9.4374"></a><span id="l9.4374" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.4375"></a><span id="l9.4375" class="difflineplus">+          (&quot;(%p) read_group_body: got line: %s|&quot;, this, line));</span>
<a href="#l9.4376"></a><span id="l9.4376"> </span>
<a href="#l9.4377"></a><span id="l9.4377">   /* End of body? */</span>
<a href="#l9.4378"></a><span id="l9.4378" class="difflineminus">-  if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l9.4379"></a><span id="l9.4379" class="difflineminus">-  {</span>
<a href="#l9.4380"></a><span id="l9.4380" class="difflineplus">+  if (line[0] == '.' &amp;&amp; line[1] == '\0') {</span>
<a href="#l9.4381"></a><span id="l9.4381">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l9.4382"></a><span id="l9.4382">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4383"></a><span id="l9.4383">     return NS_OK;</span>
<a href="#l9.4384"></a><span id="l9.4384" class="difflineminus">-  }</span>
<a href="#l9.4385"></a><span id="l9.4385" class="difflineminus">-  else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l9.4386"></a><span id="l9.4386" class="difflineplus">+  } else if (line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l9.4387"></a><span id="l9.4387">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l9.4388"></a><span id="l9.4388">     line++;</span>
<a href="#l9.4389"></a><span id="l9.4389"> </span>
<a href="#l9.4390"></a><span id="l9.4390">   nsCString safe_line(line);</span>
<a href="#l9.4391"></a><span id="l9.4391">   rv = m_newsgroupList-&gt;ProcessHEADLine(safe_line);</span>
<a href="#l9.4392"></a><span id="l9.4392">   PR_Free(lineToFree);</span>
<a href="#l9.4393"></a><span id="l9.4393">   return rv;</span>
<a href="#l9.4394"></a><span id="l9.4394"> }</span>
<a href="#l9.4395"></a><span id="l9.4395"> </span>
<a href="#l9.4396"></a><span id="l9.4396" class="difflineminus">-</span>
<a href="#l9.4397"></a><span id="l9.4397" class="difflineminus">-nsresult nsNNTPProtocol::GetNewsStringByID(int32_t stringID, char16_t **aString)</span>
<a href="#l9.4398"></a><span id="l9.4398" class="difflineminus">-{</span>
<a href="#l9.4399"></a><span id="l9.4399" class="difflineplus">+nsresult nsNNTPProtocol::GetNewsStringByID(int32_t stringID,</span>
<a href="#l9.4400"></a><span id="l9.4400" class="difflineplus">+                                           char16_t **aString) {</span>
<a href="#l9.4401"></a><span id="l9.4401">   nsresult rv;</span>
<a href="#l9.4402"></a><span id="l9.4402">   nsAutoString resultString(NS_LITERAL_STRING(&quot;???&quot;));</span>
<a href="#l9.4403"></a><span id="l9.4403"> </span>
<a href="#l9.4404"></a><span id="l9.4404" class="difflineminus">-  if (!m_stringBundle)</span>
<a href="#l9.4405"></a><span id="l9.4405" class="difflineminus">-  {</span>
<a href="#l9.4406"></a><span id="l9.4406" class="difflineplus">+  if (!m_stringBundle) {</span>
<a href="#l9.4407"></a><span id="l9.4407">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l9.4408"></a><span id="l9.4408" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l9.4409"></a><span id="l9.4409" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l9.4410"></a><span id="l9.4410">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.4411"></a><span id="l9.4411"> </span>
<a href="#l9.4412"></a><span id="l9.4412" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l9.4413"></a><span id="l9.4413" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL,</span>
<a href="#l9.4414"></a><span id="l9.4414" class="difflineplus">+                                     getter_AddRefs(m_stringBundle));</span>
<a href="#l9.4415"></a><span id="l9.4415">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4416"></a><span id="l9.4416">   }</span>
<a href="#l9.4417"></a><span id="l9.4417"> </span>
<a href="#l9.4418"></a><span id="l9.4418">   if (m_stringBundle) {</span>
<a href="#l9.4419"></a><span id="l9.4419">     nsAutoString str;</span>
<a href="#l9.4420"></a><span id="l9.4420">     rv = m_stringBundle-&gt;GetStringFromID(stringID, str);</span>
<a href="#l9.4421"></a><span id="l9.4421"> </span>
<a href="#l9.4422"></a><span id="l9.4422">     if (NS_FAILED(rv)) {</span>
<a href="#l9.4423"></a><span id="l9.4423">       resultString.AssignLiteral(&quot;[StringID&quot;);</span>
<a href="#l9.4424"></a><span id="l9.4424">       resultString.AppendInt(stringID);</span>
<a href="#l9.4425"></a><span id="l9.4425">       resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l9.4426"></a><span id="l9.4426">       *aString = ToNewUnicode(resultString);</span>
<a href="#l9.4427"></a><span id="l9.4427" class="difflineminus">-    }</span>
<a href="#l9.4428"></a><span id="l9.4428" class="difflineminus">-    else {</span>
<a href="#l9.4429"></a><span id="l9.4429" class="difflineplus">+    } else {</span>
<a href="#l9.4430"></a><span id="l9.4430">       *aString = ToNewUnicode(str);</span>
<a href="#l9.4431"></a><span id="l9.4431">     }</span>
<a href="#l9.4432"></a><span id="l9.4432" class="difflineminus">-  }</span>
<a href="#l9.4433"></a><span id="l9.4433" class="difflineminus">-  else {</span>
<a href="#l9.4434"></a><span id="l9.4434" class="difflineplus">+  } else {</span>
<a href="#l9.4435"></a><span id="l9.4435">     rv = NS_OK;</span>
<a href="#l9.4436"></a><span id="l9.4436">     *aString = ToNewUnicode(resultString);</span>
<a href="#l9.4437"></a><span id="l9.4437">   }</span>
<a href="#l9.4438"></a><span id="l9.4438">   return rv;</span>
<a href="#l9.4439"></a><span id="l9.4439"> }</span>
<a href="#l9.4440"></a><span id="l9.4440"> </span>
<a href="#l9.4441"></a><span id="l9.4441" class="difflineminus">-nsresult nsNNTPProtocol::GetNewsStringByName(const char *aName, char16_t **aString)</span>
<a href="#l9.4442"></a><span id="l9.4442" class="difflineminus">-{</span>
<a href="#l9.4443"></a><span id="l9.4443" class="difflineplus">+nsresult nsNNTPProtocol::GetNewsStringByName(const char *aName,</span>
<a href="#l9.4444"></a><span id="l9.4444" class="difflineplus">+                                             char16_t **aString) {</span>
<a href="#l9.4445"></a><span id="l9.4445">   nsresult rv;</span>
<a href="#l9.4446"></a><span id="l9.4446">   nsAutoString resultString(NS_LITERAL_STRING(&quot;???&quot;));</span>
<a href="#l9.4447"></a><span id="l9.4447" class="difflineminus">-  if (!m_stringBundle)</span>
<a href="#l9.4448"></a><span id="l9.4448" class="difflineminus">-  {</span>
<a href="#l9.4449"></a><span id="l9.4449" class="difflineplus">+  if (!m_stringBundle) {</span>
<a href="#l9.4450"></a><span id="l9.4450">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l9.4451"></a><span id="l9.4451" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l9.4452"></a><span id="l9.4452" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l9.4453"></a><span id="l9.4453">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.4454"></a><span id="l9.4454"> </span>
<a href="#l9.4455"></a><span id="l9.4455" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l9.4456"></a><span id="l9.4456" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL,</span>
<a href="#l9.4457"></a><span id="l9.4457" class="difflineplus">+                                     getter_AddRefs(m_stringBundle));</span>
<a href="#l9.4458"></a><span id="l9.4458">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4459"></a><span id="l9.4459">   }</span>
<a href="#l9.4460"></a><span id="l9.4460"> </span>
<a href="#l9.4461"></a><span id="l9.4461" class="difflineminus">-  if (m_stringBundle)</span>
<a href="#l9.4462"></a><span id="l9.4462" class="difflineminus">-  {</span>
<a href="#l9.4463"></a><span id="l9.4463" class="difflineplus">+  if (m_stringBundle) {</span>
<a href="#l9.4464"></a><span id="l9.4464">     nsAutoString str;</span>
<a href="#l9.4465"></a><span id="l9.4465">     rv = m_stringBundle-&gt;GetStringFromName(aName, str);</span>
<a href="#l9.4466"></a><span id="l9.4466"> </span>
<a href="#l9.4467"></a><span id="l9.4467" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.4468"></a><span id="l9.4468" class="difflineminus">-    {</span>
<a href="#l9.4469"></a><span id="l9.4469" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l9.4470"></a><span id="l9.4470">       resultString.AssignLiteral(&quot;[StringName&quot;);</span>
<a href="#l9.4471"></a><span id="l9.4471">       resultString.Append(NS_ConvertASCIItoUTF16(aName));</span>
<a href="#l9.4472"></a><span id="l9.4472">       resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l9.4473"></a><span id="l9.4473">       *aString = ToNewUnicode(resultString);</span>
<a href="#l9.4474"></a><span id="l9.4474" class="difflineminus">-    }</span>
<a href="#l9.4475"></a><span id="l9.4475" class="difflineminus">-    else</span>
<a href="#l9.4476"></a><span id="l9.4476" class="difflineminus">-    {</span>
<a href="#l9.4477"></a><span id="l9.4477" class="difflineplus">+    } else {</span>
<a href="#l9.4478"></a><span id="l9.4478">       *aString = ToNewUnicode(str);</span>
<a href="#l9.4479"></a><span id="l9.4479">     }</span>
<a href="#l9.4480"></a><span id="l9.4480" class="difflineminus">-  }</span>
<a href="#l9.4481"></a><span id="l9.4481" class="difflineminus">-  else</span>
<a href="#l9.4482"></a><span id="l9.4482" class="difflineminus">-  {</span>
<a href="#l9.4483"></a><span id="l9.4483" class="difflineplus">+  } else {</span>
<a href="#l9.4484"></a><span id="l9.4484">     rv = NS_OK;</span>
<a href="#l9.4485"></a><span id="l9.4485">     *aString = ToNewUnicode(resultString);</span>
<a href="#l9.4486"></a><span id="l9.4486">   }</span>
<a href="#l9.4487"></a><span id="l9.4487">   return rv;</span>
<a href="#l9.4488"></a><span id="l9.4488"> }</span>
<a href="#l9.4489"></a><span id="l9.4489"> </span>
<a href="#l9.4490"></a><span id="l9.4490" class="difflineminus">-// sspitzer:  PostMessageInFile is derived from nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l9.4491"></a><span id="l9.4491" class="difflineminus">-nsresult nsNNTPProtocol::PostMessageInFile(nsIFile *postMessageFile)</span>
<a href="#l9.4492"></a><span id="l9.4492" class="difflineminus">-{</span>
<a href="#l9.4493"></a><span id="l9.4493" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l9.4494"></a><span id="l9.4494" class="difflineminus">-    if (url &amp;&amp; postMessageFile)</span>
<a href="#l9.4495"></a><span id="l9.4495" class="difflineminus">-        nsMsgProtocol::PostMessage(url, postMessageFile);</span>
<a href="#l9.4496"></a><span id="l9.4496" class="difflineminus">-</span>
<a href="#l9.4497"></a><span id="l9.4497" class="difflineminus">-    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4498"></a><span id="l9.4498" class="difflineminus">-</span>
<a href="#l9.4499"></a><span id="l9.4499" class="difflineminus">-    // for now, we are always done at this point..we aren't making multiple</span>
<a href="#l9.4500"></a><span id="l9.4500" class="difflineminus">-    // calls to post data...</span>
<a href="#l9.4501"></a><span id="l9.4501" class="difflineminus">-</span>
<a href="#l9.4502"></a><span id="l9.4502" class="difflineminus">-    // always issue a '.' and CRLF when we are done...</span>
<a href="#l9.4503"></a><span id="l9.4503" class="difflineminus">-    PL_strcpy(m_dataBuf, &quot;.&quot; CRLF);</span>
<a href="#l9.4504"></a><span id="l9.4504" class="difflineminus">-    SendData(m_dataBuf);</span>
<a href="#l9.4505"></a><span id="l9.4505" class="difflineminus">-    m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4506"></a><span id="l9.4506" class="difflineminus">-    m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l9.4507"></a><span id="l9.4507" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.4508"></a><span id="l9.4508" class="difflineplus">+// sspitzer:  PostMessageInFile is derived from</span>
<a href="#l9.4509"></a><span id="l9.4509" class="difflineplus">+// nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l9.4510"></a><span id="l9.4510" class="difflineplus">+nsresult nsNNTPProtocol::PostMessageInFile(nsIFile *postMessageFile) {</span>
<a href="#l9.4511"></a><span id="l9.4511" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l9.4512"></a><span id="l9.4512" class="difflineplus">+  if (url &amp;&amp; postMessageFile) nsMsgProtocol::PostMessage(url, postMessageFile);</span>
<a href="#l9.4513"></a><span id="l9.4513" class="difflineplus">+</span>
<a href="#l9.4514"></a><span id="l9.4514" class="difflineplus">+  SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4515"></a><span id="l9.4515" class="difflineplus">+</span>
<a href="#l9.4516"></a><span id="l9.4516" class="difflineplus">+  // for now, we are always done at this point..we aren't making multiple</span>
<a href="#l9.4517"></a><span id="l9.4517" class="difflineplus">+  // calls to post data...</span>
<a href="#l9.4518"></a><span id="l9.4518" class="difflineplus">+</span>
<a href="#l9.4519"></a><span id="l9.4519" class="difflineplus">+  // always issue a '.' and CRLF when we are done...</span>
<a href="#l9.4520"></a><span id="l9.4520" class="difflineplus">+  PL_strcpy(m_dataBuf, &quot;.&quot; CRLF);</span>
<a href="#l9.4521"></a><span id="l9.4521" class="difflineplus">+  SendData(m_dataBuf);</span>
<a href="#l9.4522"></a><span id="l9.4522" class="difflineplus">+  m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4523"></a><span id="l9.4523" class="difflineplus">+  m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l9.4524"></a><span id="l9.4524" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.4525"></a><span id="l9.4525"> }</span>
<a href="#l9.4526"></a><span id="l9.4526"> </span>
<a href="#l9.4527"></a><span id="l9.4527" class="difflineminus">-nsresult nsNNTPProtocol::PostData()</span>
<a href="#l9.4528"></a><span id="l9.4528" class="difflineminus">-{</span>
<a href="#l9.4529"></a><span id="l9.4529" class="difflineminus">-    /* returns 0 on done and negative on error</span>
<a href="#l9.4530"></a><span id="l9.4530" class="difflineminus">-     * positive if it needs to continue.</span>
<a href="#l9.4531"></a><span id="l9.4531" class="difflineminus">-     */</span>
<a href="#l9.4532"></a><span id="l9.4532" class="difflineminus">-    NNTP_LOG_NOTE(&quot;nsNNTPProtocol::PostData()&quot;);</span>
<a href="#l9.4533"></a><span id="l9.4533" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l9.4534"></a><span id="l9.4534" class="difflineminus">-</span>
<a href="#l9.4535"></a><span id="l9.4535" class="difflineminus">-    nsCOMPtr &lt;nsINNTPNewsgroupPost&gt; message;</span>
<a href="#l9.4536"></a><span id="l9.4536" class="difflineminus">-    rv = m_runningURL-&gt;GetMessageToPost(getter_AddRefs(message));</span>
<a href="#l9.4537"></a><span id="l9.4537" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.4538"></a><span id="l9.4538" class="difflineminus">-    {</span>
<a href="#l9.4539"></a><span id="l9.4539" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; filePath;</span>
<a href="#l9.4540"></a><span id="l9.4540" class="difflineminus">-        rv = message-&gt;GetPostMessageFile(getter_AddRefs(filePath));</span>
<a href="#l9.4541"></a><span id="l9.4541" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l9.4542"></a><span id="l9.4542" class="difflineminus">-            PostMessageInFile(filePath);</span>
<a href="#l9.4543"></a><span id="l9.4543" class="difflineminus">-     }</span>
<a href="#l9.4544"></a><span id="l9.4544" class="difflineminus">-</span>
<a href="#l9.4545"></a><span id="l9.4545" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.4546"></a><span id="l9.4546" class="difflineplus">+nsresult nsNNTPProtocol::PostData() {</span>
<a href="#l9.4547"></a><span id="l9.4547" class="difflineplus">+  /* returns 0 on done and negative on error</span>
<a href="#l9.4548"></a><span id="l9.4548" class="difflineplus">+   * positive if it needs to continue.</span>
<a href="#l9.4549"></a><span id="l9.4549" class="difflineplus">+   */</span>
<a href="#l9.4550"></a><span id="l9.4550" class="difflineplus">+  NNTP_LOG_NOTE(&quot;nsNNTPProtocol::PostData()&quot;);</span>
<a href="#l9.4551"></a><span id="l9.4551" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l9.4552"></a><span id="l9.4552" class="difflineplus">+</span>
<a href="#l9.4553"></a><span id="l9.4553" class="difflineplus">+  nsCOMPtr&lt;nsINNTPNewsgroupPost&gt; message;</span>
<a href="#l9.4554"></a><span id="l9.4554" class="difflineplus">+  rv = m_runningURL-&gt;GetMessageToPost(getter_AddRefs(message));</span>
<a href="#l9.4555"></a><span id="l9.4555" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.4556"></a><span id="l9.4556" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; filePath;</span>
<a href="#l9.4557"></a><span id="l9.4557" class="difflineplus">+    rv = message-&gt;GetPostMessageFile(getter_AddRefs(filePath));</span>
<a href="#l9.4558"></a><span id="l9.4558" class="difflineplus">+    if (NS_SUCCEEDED(rv)) PostMessageInFile(filePath);</span>
<a href="#l9.4559"></a><span id="l9.4559" class="difflineplus">+  }</span>
<a href="#l9.4560"></a><span id="l9.4560" class="difflineplus">+</span>
<a href="#l9.4561"></a><span id="l9.4561" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.4562"></a><span id="l9.4562"> }</span>
<a href="#l9.4563"></a><span id="l9.4563"> </span>
<a href="#l9.4564"></a><span id="l9.4564" class="difflineminus">-</span>
<a href="#l9.4565"></a><span id="l9.4565"> /* interpret the response code from the server</span>
<a href="#l9.4566"></a><span id="l9.4566">  * after the post is done</span>
<a href="#l9.4567"></a><span id="l9.4567">  */</span>
<a href="#l9.4568"></a><span id="l9.4568" class="difflineminus">-nsresult nsNNTPProtocol::PostDataResponse()</span>
<a href="#l9.4569"></a><span id="l9.4569" class="difflineminus">-{</span>
<a href="#l9.4570"></a><span id="l9.4570" class="difflineminus">-  if (m_responseCode != MK_NNTP_RESPONSE_POST_OK)</span>
<a href="#l9.4571"></a><span id="l9.4571" class="difflineminus">-  {</span>
<a href="#l9.4572"></a><span id="l9.4572" class="difflineminus">-    AlertError(MK_NNTP_ERROR_MESSAGE,m_responseText);</span>
<a href="#l9.4573"></a><span id="l9.4573" class="difflineplus">+nsresult nsNNTPProtocol::PostDataResponse() {</span>
<a href="#l9.4574"></a><span id="l9.4574" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_POST_OK) {</span>
<a href="#l9.4575"></a><span id="l9.4575" class="difflineplus">+    AlertError(MK_NNTP_ERROR_MESSAGE, m_responseText);</span>
<a href="#l9.4576"></a><span id="l9.4576">     m_nextState = NEWS_ERROR;</span>
<a href="#l9.4577"></a><span id="l9.4577">     return NS_ERROR_FAILURE;</span>
<a href="#l9.4578"></a><span id="l9.4578">   }</span>
<a href="#l9.4579"></a><span id="l9.4579" class="difflineminus">-    m_nextState = NEWS_POST_DONE;</span>
<a href="#l9.4580"></a><span id="l9.4580" class="difflineplus">+  m_nextState = NEWS_POST_DONE;</span>
<a href="#l9.4581"></a><span id="l9.4581">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4582"></a><span id="l9.4582">   return NS_OK;</span>
<a href="#l9.4583"></a><span id="l9.4583"> }</span>
<a href="#l9.4584"></a><span id="l9.4584"> </span>
<a href="#l9.4585"></a><span id="l9.4585" class="difflineminus">-nsresult nsNNTPProtocol::CheckForArticle()</span>
<a href="#l9.4586"></a><span id="l9.4586" class="difflineminus">-{</span>
<a href="#l9.4587"></a><span id="l9.4587" class="difflineplus">+nsresult nsNNTPProtocol::CheckForArticle() {</span>
<a href="#l9.4588"></a><span id="l9.4588">   m_nextState = NEWS_ERROR;</span>
<a href="#l9.4589"></a><span id="l9.4589">   if (m_responseCode &gt;= 220 &amp;&amp; m_responseCode &lt;= 223) {</span>
<a href="#l9.4590"></a><span id="l9.4590">     /* Yes, this article is already there, we're all done. */</span>
<a href="#l9.4591"></a><span id="l9.4591">     return NS_OK;</span>
<a href="#l9.4592"></a><span id="l9.4592" class="difflineminus">-  }</span>
<a href="#l9.4593"></a><span id="l9.4593" class="difflineminus">-  else</span>
<a href="#l9.4594"></a><span id="l9.4594" class="difflineminus">-  {</span>
<a href="#l9.4595"></a><span id="l9.4595" class="difflineminus">-  /* The article isn't there, so the failure we had earlier wasn't due to</span>
<a href="#l9.4596"></a><span id="l9.4596" class="difflineminus">-     a duplicate message-id.  Return the error from that previous</span>
<a href="#l9.4597"></a><span id="l9.4597" class="difflineminus">-     posting attempt (which is already in ce-&gt;URL_s-&gt;error_msg). */</span>
<a href="#l9.4598"></a><span id="l9.4598" class="difflineplus">+  } else {</span>
<a href="#l9.4599"></a><span id="l9.4599" class="difflineplus">+    /* The article isn't there, so the failure we had earlier wasn't due to</span>
<a href="#l9.4600"></a><span id="l9.4600" class="difflineplus">+       a duplicate message-id.  Return the error from that previous</span>
<a href="#l9.4601"></a><span id="l9.4601" class="difflineplus">+       posting attempt (which is already in ce-&gt;URL_s-&gt;error_msg). */</span>
<a href="#l9.4602"></a><span id="l9.4602">     return NS_ERROR_FAILURE;</span>
<a href="#l9.4603"></a><span id="l9.4603">   }</span>
<a href="#l9.4604"></a><span id="l9.4604"> }</span>
<a href="#l9.4605"></a><span id="l9.4605"> </span>
<a href="#l9.4606"></a><span id="l9.4606" class="difflineminus">-nsresult nsNNTPProtocol::StartCancel()</span>
<a href="#l9.4607"></a><span id="l9.4607" class="difflineminus">-{</span>
<a href="#l9.4608"></a><span id="l9.4608" class="difflineplus">+nsresult nsNNTPProtocol::StartCancel() {</span>
<a href="#l9.4609"></a><span id="l9.4609">   nsresult rv = SendData(NNTP_CMD_POST);</span>
<a href="#l9.4610"></a><span id="l9.4610"> </span>
<a href="#l9.4611"></a><span id="l9.4611">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4612"></a><span id="l9.4612">   m_nextStateAfterResponse = NEWS_DO_CANCEL;</span>
<a href="#l9.4613"></a><span id="l9.4613">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4614"></a><span id="l9.4614">   return rv;</span>
<a href="#l9.4615"></a><span id="l9.4615"> }</span>
<a href="#l9.4616"></a><span id="l9.4616"> </span>
<a href="#l9.4617"></a><span id="l9.4617" class="difflineminus">-void nsNNTPProtocol::CheckIfAuthor(nsIMsgIdentity *aIdentity, const nsCString &amp;aOldFrom, nsCString &amp;aFrom)</span>
<a href="#l9.4618"></a><span id="l9.4618" class="difflineminus">-{</span>
<a href="#l9.4619"></a><span id="l9.4619" class="difflineplus">+void nsNNTPProtocol::CheckIfAuthor(nsIMsgIdentity *aIdentity,</span>
<a href="#l9.4620"></a><span id="l9.4620" class="difflineplus">+                                   const nsCString &amp;aOldFrom,</span>
<a href="#l9.4621"></a><span id="l9.4621" class="difflineplus">+                                   nsCString &amp;aFrom) {</span>
<a href="#l9.4622"></a><span id="l9.4622">   nsAutoCString from;</span>
<a href="#l9.4623"></a><span id="l9.4623">   nsresult rv = aIdentity-&gt;GetEmail(from);</span>
<a href="#l9.4624"></a><span id="l9.4624" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.4625"></a><span id="l9.4625" class="difflineminus">-    return;</span>
<a href="#l9.4626"></a><span id="l9.4626" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;from = %s&quot;, from.get()));</span>
<a href="#l9.4627"></a><span id="l9.4627" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l9.4628"></a><span id="l9.4628" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;from = %s&quot;, from.get()));</span>
<a href="#l9.4629"></a><span id="l9.4629"> </span>
<a href="#l9.4630"></a><span id="l9.4630">   nsCString us;</span>
<a href="#l9.4631"></a><span id="l9.4631">   nsCString them;</span>
<a href="#l9.4632"></a><span id="l9.4632">   ExtractEmail(EncodedHeader(from), us);</span>
<a href="#l9.4633"></a><span id="l9.4633">   ExtractEmail(EncodedHeader(aOldFrom), them);</span>
<a href="#l9.4634"></a><span id="l9.4634"> </span>
<a href="#l9.4635"></a><span id="l9.4635" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;us = %s, them = %s&quot;, us.get(), them.get()));</span>
<a href="#l9.4636"></a><span id="l9.4636" class="difflineminus">-</span>
<a href="#l9.4637"></a><span id="l9.4637" class="difflineminus">-  if (us.Equals(them, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l9.4638"></a><span id="l9.4638" class="difflineminus">-    aFrom = from;</span>
<a href="#l9.4639"></a><span id="l9.4639" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;us = %s, them = %s&quot;, us.get(), them.get()));</span>
<a href="#l9.4640"></a><span id="l9.4640" class="difflineplus">+</span>
<a href="#l9.4641"></a><span id="l9.4641" class="difflineplus">+  if (us.Equals(them, nsCaseInsensitiveCStringComparator())) aFrom = from;</span>
<a href="#l9.4642"></a><span id="l9.4642"> }</span>
<a href="#l9.4643"></a><span id="l9.4643"> </span>
<a href="#l9.4644"></a><span id="l9.4644" class="difflineminus">-nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l9.4645"></a><span id="l9.4645" class="difflineminus">-{</span>
<a href="#l9.4646"></a><span id="l9.4646" class="difflineminus">-    int32_t status = 0;</span>
<a href="#l9.4647"></a><span id="l9.4647" class="difflineminus">-    bool failure = false;</span>
<a href="#l9.4648"></a><span id="l9.4648" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l9.4649"></a><span id="l9.4649" class="difflineminus">-    bool requireConfirmationForCancel = true;</span>
<a href="#l9.4650"></a><span id="l9.4650" class="difflineminus">-    bool showAlertAfterCancel = true;</span>
<a href="#l9.4651"></a><span id="l9.4651" class="difflineplus">+nsresult nsNNTPProtocol::DoCancel() {</span>
<a href="#l9.4652"></a><span id="l9.4652" class="difflineplus">+  int32_t status = 0;</span>
<a href="#l9.4653"></a><span id="l9.4653" class="difflineplus">+  bool failure = false;</span>
<a href="#l9.4654"></a><span id="l9.4654" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l9.4655"></a><span id="l9.4655" class="difflineplus">+  bool requireConfirmationForCancel = true;</span>
<a href="#l9.4656"></a><span id="l9.4656" class="difflineplus">+  bool showAlertAfterCancel = true;</span>
<a href="#l9.4657"></a><span id="l9.4657"> </span>
<a href="#l9.4658"></a><span id="l9.4658">   /* #### Should we do a more real check than this?  If the POST command</span>
<a href="#l9.4659"></a><span id="l9.4659" class="difflineminus">-     didn't respond with &quot;MK_NNTP_RESPONSE_POST_SEND_NOW Ok&quot;, then it's not ready for us to throw a</span>
<a href="#l9.4660"></a><span id="l9.4660" class="difflineminus">-     message at it...   But the normal posting code doesn't do this check.</span>
<a href="#l9.4661"></a><span id="l9.4661" class="difflineminus">-     Why?</span>
<a href="#l9.4662"></a><span id="l9.4662" class="difflineplus">+     didn't respond with &quot;MK_NNTP_RESPONSE_POST_SEND_NOW Ok&quot;, then it's not</span>
<a href="#l9.4663"></a><span id="l9.4663" class="difflineplus">+     ready for us to throw a message at it...   But the normal posting code</span>
<a href="#l9.4664"></a><span id="l9.4664" class="difflineplus">+     doesn't do this check. Why?</span>
<a href="#l9.4665"></a><span id="l9.4665">    */</span>
<a href="#l9.4666"></a><span id="l9.4666" class="difflineminus">-  NS_ASSERTION (m_responseCode == MK_NNTP_RESPONSE_POST_SEND_NOW, &quot;code != POST_SEND_NOW&quot;);</span>
<a href="#l9.4667"></a><span id="l9.4667" class="difflineplus">+  NS_ASSERTION(m_responseCode == MK_NNTP_RESPONSE_POST_SEND_NOW,</span>
<a href="#l9.4668"></a><span id="l9.4668" class="difflineplus">+               &quot;code != POST_SEND_NOW&quot;);</span>
<a href="#l9.4669"></a><span id="l9.4669"> </span>
<a href="#l9.4670"></a><span id="l9.4670">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l9.4671"></a><span id="l9.4671" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l9.4672"></a><span id="l9.4672" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l9.4673"></a><span id="l9.4673">   NS_ENSURE_TRUE(bundleService, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.4674"></a><span id="l9.4674"> </span>
<a href="#l9.4675"></a><span id="l9.4675">   nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l9.4676"></a><span id="l9.4676">   bundleService-&gt;CreateBundle(&quot;chrome://branding/locale/brand.properties&quot;,</span>
<a href="#l9.4677"></a><span id="l9.4677">                               getter_AddRefs(brandBundle));</span>
<a href="#l9.4678"></a><span id="l9.4678">   NS_ENSURE_TRUE(brandBundle, NS_ERROR_FAILURE);</span>
<a href="#l9.4679"></a><span id="l9.4679"> </span>
<a href="#l9.4680"></a><span id="l9.4680">   nsString brandFullName;</span>
<a href="#l9.4681"></a><span id="l9.4681">   rv = brandBundle-&gt;GetStringFromName(&quot;brandFullName&quot;, brandFullName);</span>
<a href="#l9.4682"></a><span id="l9.4682" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.4683"></a><span id="l9.4683" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4684"></a><span id="l9.4684">   NS_ConvertUTF16toUTF8 appName(brandFullName);</span>
<a href="#l9.4685"></a><span id="l9.4685"> </span>
<a href="#l9.4686"></a><span id="l9.4686">   nsCString newsgroups(m_cancelNewsgroups);</span>
<a href="#l9.4687"></a><span id="l9.4687" class="difflineminus">-  nsCString distribution (m_cancelDistribution);</span>
<a href="#l9.4688"></a><span id="l9.4688" class="difflineminus">-  nsCString id (m_cancelID);</span>
<a href="#l9.4689"></a><span id="l9.4689" class="difflineplus">+  nsCString distribution(m_cancelDistribution);</span>
<a href="#l9.4690"></a><span id="l9.4690" class="difflineplus">+  nsCString id(m_cancelID);</span>
<a href="#l9.4691"></a><span id="l9.4691">   nsCString oldFrom(m_cancelFromHdr);</span>
<a href="#l9.4692"></a><span id="l9.4692"> </span>
<a href="#l9.4693"></a><span id="l9.4693" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.4694"></a><span id="l9.4694" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.4695"></a><span id="l9.4695" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l9.4696"></a><span id="l9.4696" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.4697"></a><span id="l9.4697" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4698"></a><span id="l9.4698"> </span>
<a href="#l9.4699"></a><span id="l9.4699">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l9.4700"></a><span id="l9.4700" class="difflineminus">-  if (m_runningURL)</span>
<a href="#l9.4701"></a><span id="l9.4701" class="difflineminus">-  {</span>
<a href="#l9.4702"></a><span id="l9.4702" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(m_runningURL));</span>
<a href="#l9.4703"></a><span id="l9.4703" class="difflineplus">+  if (m_runningURL) {</span>
<a href="#l9.4704"></a><span id="l9.4704" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(m_runningURL));</span>
<a href="#l9.4705"></a><span id="l9.4705">     rv = GetPromptDialogFromUrl(msgUrl, getter_AddRefs(dialog));</span>
<a href="#l9.4706"></a><span id="l9.4706">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4707"></a><span id="l9.4707">   }</span>
<a href="#l9.4708"></a><span id="l9.4708"> </span>
<a href="#l9.4709"></a><span id="l9.4709" class="difflineminus">-  if (id.IsEmpty() || newsgroups.IsEmpty())</span>
<a href="#l9.4710"></a><span id="l9.4710" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.4711"></a><span id="l9.4711" class="difflineplus">+  if (id.IsEmpty() || newsgroups.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l9.4712"></a><span id="l9.4712"> </span>
<a href="#l9.4713"></a><span id="l9.4713">   m_cancelNewsgroups.Truncate();</span>
<a href="#l9.4714"></a><span id="l9.4714">   m_cancelDistribution.Truncate();</span>
<a href="#l9.4715"></a><span id="l9.4715">   m_cancelFromHdr.Truncate();</span>
<a href="#l9.4716"></a><span id="l9.4716">   m_cancelID.Truncate();</span>
<a href="#l9.4717"></a><span id="l9.4717"> </span>
<a href="#l9.4718"></a><span id="l9.4718">   nsString alertText;</span>
<a href="#l9.4719"></a><span id="l9.4719">   nsString confirmText;</span>
<a href="#l9.4720"></a><span id="l9.4720" class="difflineat">@@ -3610,86 +3363,83 @@ nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l9.4721"></a><span id="l9.4721"> </span>
<a href="#l9.4722"></a><span id="l9.4722">   /* Make sure that this loser isn't cancelling someone else's posting.</span>
<a href="#l9.4723"></a><span id="l9.4723">      Yes, there are occasionally good reasons to do so.  Those people</span>
<a href="#l9.4724"></a><span id="l9.4724">      capable of making that decision (news admins) have other tools with</span>
<a href="#l9.4725"></a><span id="l9.4725">      which to cancel postings (like telnet.)</span>
<a href="#l9.4726"></a><span id="l9.4726"> </span>
<a href="#l9.4727"></a><span id="l9.4727">      Don't do this if server tells us it will validate user. DMB 3/19/97</span>
<a href="#l9.4728"></a><span id="l9.4728">    */</span>
<a href="#l9.4729"></a><span id="l9.4729" class="difflineminus">-  bool cancelchk=false;</span>
<a href="#l9.4730"></a><span id="l9.4730" class="difflineminus">-  rv = m_nntpServer-&gt;QueryExtension(&quot;CANCELCHK&quot;,&amp;cancelchk);</span>
<a href="#l9.4731"></a><span id="l9.4731" class="difflineplus">+  bool cancelchk = false;</span>
<a href="#l9.4732"></a><span id="l9.4732" class="difflineplus">+  rv = m_nntpServer-&gt;QueryExtension(&quot;CANCELCHK&quot;, &amp;cancelchk);</span>
<a href="#l9.4733"></a><span id="l9.4733">   nsCString from;</span>
<a href="#l9.4734"></a><span id="l9.4734" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !cancelchk)</span>
<a href="#l9.4735"></a><span id="l9.4735" class="difflineminus">-  {</span>
<a href="#l9.4736"></a><span id="l9.4736" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !cancelchk) {</span>
<a href="#l9.4737"></a><span id="l9.4737">     NNTP_LOG_NOTE(&quot;CANCELCHK not supported&quot;);</span>
<a href="#l9.4738"></a><span id="l9.4738"> </span>
<a href="#l9.4739"></a><span id="l9.4739">     // get the current identity from the news session....</span>
<a href="#l9.4740"></a><span id="l9.4740">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l9.4741"></a><span id="l9.4741" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l9.4742"></a><span id="l9.4742" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l9.4743"></a><span id="l9.4743">     if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l9.4744"></a><span id="l9.4744">       nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l9.4745"></a><span id="l9.4745">       rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l9.4746"></a><span id="l9.4746">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4747"></a><span id="l9.4747"> </span>
<a href="#l9.4748"></a><span id="l9.4748">       uint32_t length;</span>
<a href="#l9.4749"></a><span id="l9.4749">       rv = identities-&gt;GetLength(&amp;length);</span>
<a href="#l9.4750"></a><span id="l9.4750">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.4751"></a><span id="l9.4751"> </span>
<a href="#l9.4752"></a><span id="l9.4752" class="difflineminus">-      for (uint32_t i = 0; i &lt; length &amp;&amp; from.IsEmpty(); ++i)</span>
<a href="#l9.4753"></a><span id="l9.4753" class="difflineminus">-      {</span>
<a href="#l9.4754"></a><span id="l9.4754" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l9.4755"></a><span id="l9.4755" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l9.4756"></a><span id="l9.4756" class="difflineminus">-          CheckIfAuthor(identity, oldFrom, from);</span>
<a href="#l9.4757"></a><span id="l9.4757" class="difflineplus">+      for (uint32_t i = 0; i &lt; length &amp;&amp; from.IsEmpty(); ++i) {</span>
<a href="#l9.4758"></a><span id="l9.4758" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; identity(</span>
<a href="#l9.4759"></a><span id="l9.4759" class="difflineplus">+            do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l9.4760"></a><span id="l9.4760" class="difflineplus">+        if (NS_SUCCEEDED(rv)) CheckIfAuthor(identity, oldFrom, from);</span>
<a href="#l9.4761"></a><span id="l9.4761">       }</span>
<a href="#l9.4762"></a><span id="l9.4762">     }</span>
<a href="#l9.4763"></a><span id="l9.4763"> </span>
<a href="#l9.4764"></a><span id="l9.4764" class="difflineminus">-    if (from.IsEmpty())</span>
<a href="#l9.4765"></a><span id="l9.4765" class="difflineminus">-    {</span>
<a href="#l9.4766"></a><span id="l9.4766" class="difflineplus">+    if (from.IsEmpty()) {</span>
<a href="#l9.4767"></a><span id="l9.4767">       GetNewsStringByName(&quot;cancelDisallowed&quot;, getter_Copies(alertText));</span>
<a href="#l9.4768"></a><span id="l9.4768">       rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l9.4769"></a><span id="l9.4769">       // XXX:  todo, check rv?</span>
<a href="#l9.4770"></a><span id="l9.4770"> </span>
<a href="#l9.4771"></a><span id="l9.4771" class="difflineminus">-      /* After the cancel is disallowed, Make the status update to be the same as though the</span>
<a href="#l9.4772"></a><span id="l9.4772" class="difflineminus">-         cancel was allowed, otherwise, the newsgroup is not able to take further requests as</span>
<a href="#l9.4773"></a><span id="l9.4773" class="difflineminus">-         reported here */</span>
<a href="#l9.4774"></a><span id="l9.4774" class="difflineplus">+      /* After the cancel is disallowed, Make the status update to be the same</span>
<a href="#l9.4775"></a><span id="l9.4775" class="difflineplus">+         as though the cancel was allowed, otherwise, the newsgroup is not able</span>
<a href="#l9.4776"></a><span id="l9.4776" class="difflineplus">+         to take further requests as reported here */</span>
<a href="#l9.4777"></a><span id="l9.4777">       status = MK_NNTP_CANCEL_DISALLOWED;</span>
<a href="#l9.4778"></a><span id="l9.4778">       m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4779"></a><span id="l9.4779">       m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l9.4780"></a><span id="l9.4780">       SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4781"></a><span id="l9.4781">       failure = true;</span>
<a href="#l9.4782"></a><span id="l9.4782">       goto FAIL;</span>
<a href="#l9.4783"></a><span id="l9.4783" class="difflineminus">-    }</span>
<a href="#l9.4784"></a><span id="l9.4784" class="difflineminus">-    else</span>
<a href="#l9.4785"></a><span id="l9.4785" class="difflineminus">-    {</span>
<a href="#l9.4786"></a><span id="l9.4786" class="difflineminus">-      MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) CANCELCHK not supported, so post the cancel message as %s&quot;, this, from.get()));</span>
<a href="#l9.4787"></a><span id="l9.4787" class="difflineplus">+    } else {</span>
<a href="#l9.4788"></a><span id="l9.4788" class="difflineplus">+      MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.4789"></a><span id="l9.4789" class="difflineplus">+              (&quot;(%p) CANCELCHK not supported, so post the cancel message as %s&quot;,</span>
<a href="#l9.4790"></a><span id="l9.4790" class="difflineplus">+               this, from.get()));</span>
<a href="#l9.4791"></a><span id="l9.4791">     }</span>
<a href="#l9.4792"></a><span id="l9.4792" class="difflineminus">-  }</span>
<a href="#l9.4793"></a><span id="l9.4793" class="difflineminus">-  else</span>
<a href="#l9.4794"></a><span id="l9.4794" class="difflineplus">+  } else</span>
<a href="#l9.4795"></a><span id="l9.4795">     NNTP_LOG_NOTE(&quot;CANCELCHK supported, don't do the us vs. them test&quot;);</span>
<a href="#l9.4796"></a><span id="l9.4796"> </span>
<a href="#l9.4797"></a><span id="l9.4797" class="difflineminus">-  // QA needs to be able to disable this confirm dialog, for the automated tests.  see bug #31057</span>
<a href="#l9.4798"></a><span id="l9.4798" class="difflineminus">-  rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_CONFIRM, &amp;requireConfirmationForCancel);</span>
<a href="#l9.4799"></a><span id="l9.4799" class="difflineplus">+  // QA needs to be able to disable this confirm dialog, for the automated</span>
<a href="#l9.4800"></a><span id="l9.4800" class="difflineplus">+  // tests.  see bug #31057</span>
<a href="#l9.4801"></a><span id="l9.4801" class="difflineplus">+  rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_CONFIRM,</span>
<a href="#l9.4802"></a><span id="l9.4802" class="difflineplus">+                               &amp;requireConfirmationForCancel);</span>
<a href="#l9.4803"></a><span id="l9.4803">   if (NS_FAILED(rv) || requireConfirmationForCancel) {</span>
<a href="#l9.4804"></a><span id="l9.4804">     /* Last chance to cancel the cancel.*/</span>
<a href="#l9.4805"></a><span id="l9.4805">     GetNewsStringByName(&quot;cancelConfirm&quot;, getter_Copies(confirmText));</span>
<a href="#l9.4806"></a><span id="l9.4806">     bool dummyValue = false;</span>
<a href="#l9.4807"></a><span id="l9.4807" class="difflineminus">-    rv = dialog-&gt;ConfirmEx(nullptr, confirmText.get(), nsIPrompt::STD_YES_NO_BUTTONS,</span>
<a href="#l9.4808"></a><span id="l9.4808" class="difflineminus">-                           nullptr, nullptr, nullptr, nullptr, &amp;dummyValue, &amp;confirmCancelResult);</span>
<a href="#l9.4809"></a><span id="l9.4809" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.4810"></a><span id="l9.4810" class="difflineminus">-      confirmCancelResult = 1; // Default to No.</span>
<a href="#l9.4811"></a><span id="l9.4811" class="difflineminus">-  }</span>
<a href="#l9.4812"></a><span id="l9.4812" class="difflineminus">-  else</span>
<a href="#l9.4813"></a><span id="l9.4813" class="difflineminus">-    confirmCancelResult = 0; // Default to Yes.</span>
<a href="#l9.4814"></a><span id="l9.4814" class="difflineplus">+    rv = dialog-&gt;ConfirmEx(nullptr, confirmText.get(),</span>
<a href="#l9.4815"></a><span id="l9.4815" class="difflineplus">+                           nsIPrompt::STD_YES_NO_BUTTONS, nullptr, nullptr,</span>
<a href="#l9.4816"></a><span id="l9.4816" class="difflineplus">+                           nullptr, nullptr, &amp;dummyValue, &amp;confirmCancelResult);</span>
<a href="#l9.4817"></a><span id="l9.4817" class="difflineplus">+    if (NS_FAILED(rv)) confirmCancelResult = 1;  // Default to No.</span>
<a href="#l9.4818"></a><span id="l9.4818" class="difflineplus">+  } else</span>
<a href="#l9.4819"></a><span id="l9.4819" class="difflineplus">+    confirmCancelResult = 0;  // Default to Yes.</span>
<a href="#l9.4820"></a><span id="l9.4820"> </span>
<a href="#l9.4821"></a><span id="l9.4821">   if (confirmCancelResult != 0) {</span>
<a href="#l9.4822"></a><span id="l9.4822" class="difflineminus">-      // they cancelled the cancel</span>
<a href="#l9.4823"></a><span id="l9.4823" class="difflineminus">-      status = MK_NNTP_NOT_CANCELLED;</span>
<a href="#l9.4824"></a><span id="l9.4824" class="difflineminus">-      failure = true;</span>
<a href="#l9.4825"></a><span id="l9.4825" class="difflineminus">-      goto FAIL;</span>
<a href="#l9.4826"></a><span id="l9.4826" class="difflineplus">+    // they cancelled the cancel</span>
<a href="#l9.4827"></a><span id="l9.4827" class="difflineplus">+    status = MK_NNTP_NOT_CANCELLED;</span>
<a href="#l9.4828"></a><span id="l9.4828" class="difflineplus">+    failure = true;</span>
<a href="#l9.4829"></a><span id="l9.4829" class="difflineplus">+    goto FAIL;</span>
<a href="#l9.4830"></a><span id="l9.4830">   }</span>
<a href="#l9.4831"></a><span id="l9.4831"> </span>
<a href="#l9.4832"></a><span id="l9.4832">   otherHeaders.AppendLiteral(&quot;Control: cancel &quot;);</span>
<a href="#l9.4833"></a><span id="l9.4833">   otherHeaders += id;</span>
<a href="#l9.4834"></a><span id="l9.4834">   otherHeaders.AppendLiteral(CRLF);</span>
<a href="#l9.4835"></a><span id="l9.4835">   if (!distribution.IsEmpty()) {</span>
<a href="#l9.4836"></a><span id="l9.4836">     otherHeaders.AppendLiteral(&quot;Distribution: &quot;);</span>
<a href="#l9.4837"></a><span id="l9.4837">     otherHeaders += distribution;</span>
<a href="#l9.4838"></a><span id="l9.4838" class="difflineat">@@ -3701,150 +3451,137 @@ nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l9.4839"></a><span id="l9.4839">   otherHeaders.AppendLiteral(CRLF);</span>
<a href="#l9.4840"></a><span id="l9.4840"> </span>
<a href="#l9.4841"></a><span id="l9.4841">   m_cancelStatus = 0;</span>
<a href="#l9.4842"></a><span id="l9.4842"> </span>
<a href="#l9.4843"></a><span id="l9.4843">   {</span>
<a href="#l9.4844"></a><span id="l9.4844">     /* NET_BlockingWrite() should go away soon? I think. */</span>
<a href="#l9.4845"></a><span id="l9.4845">     /* The following are what we really need to cancel a posted message */</span>
<a href="#l9.4846"></a><span id="l9.4846">     char *data;</span>
<a href="#l9.4847"></a><span id="l9.4847" class="difflineminus">-    data = PR_smprintf(&quot;From: %s&quot; CRLF</span>
<a href="#l9.4848"></a><span id="l9.4848" class="difflineminus">-                       &quot;Newsgroups: %s&quot; CRLF</span>
<a href="#l9.4849"></a><span id="l9.4849" class="difflineminus">-                       &quot;Subject: cancel %s&quot; CRLF</span>
<a href="#l9.4850"></a><span id="l9.4850" class="difflineminus">-                       &quot;References: %s&quot; CRLF</span>
<a href="#l9.4851"></a><span id="l9.4851" class="difflineminus">-                       &quot;%s&quot; /* otherHeaders, already with CRLF */</span>
<a href="#l9.4852"></a><span id="l9.4852" class="difflineminus">-                       CRLF /* body separator */</span>
<a href="#l9.4853"></a><span id="l9.4853" class="difflineminus">-                       &quot;This message was cancelled from within %s.&quot; CRLF /* body */</span>
<a href="#l9.4854"></a><span id="l9.4854" class="difflineminus">-                       &quot;.&quot; CRLF, /* trailing message terminator &quot;.&quot; */</span>
<a href="#l9.4855"></a><span id="l9.4855" class="difflineminus">-                       from.get(), newsgroups.get(), id.get(), id.get(),</span>
<a href="#l9.4856"></a><span id="l9.4856" class="difflineminus">-                       otherHeaders.get(), appName.get());</span>
<a href="#l9.4857"></a><span id="l9.4857" class="difflineplus">+    data = PR_smprintf(</span>
<a href="#l9.4858"></a><span id="l9.4858" class="difflineplus">+        &quot;From: %s&quot; CRLF &quot;Newsgroups: %s&quot; CRLF &quot;Subject: cancel %s&quot; CRLF</span>
<a href="#l9.4859"></a><span id="l9.4859" class="difflineplus">+        &quot;References: %s&quot; CRLF &quot;%s&quot; /* otherHeaders, already with CRLF */</span>
<a href="#l9.4860"></a><span id="l9.4860" class="difflineplus">+        CRLF                       /* body separator */</span>
<a href="#l9.4861"></a><span id="l9.4861" class="difflineplus">+        &quot;This message was cancelled from within %s.&quot; CRLF /* body */</span>
<a href="#l9.4862"></a><span id="l9.4862" class="difflineplus">+        &quot;.&quot; CRLF, /* trailing message terminator &quot;.&quot; */</span>
<a href="#l9.4863"></a><span id="l9.4863" class="difflineplus">+        from.get(), newsgroups.get(), id.get(), id.get(), otherHeaders.get(),</span>
<a href="#l9.4864"></a><span id="l9.4864" class="difflineplus">+        appName.get());</span>
<a href="#l9.4865"></a><span id="l9.4865"> </span>
<a href="#l9.4866"></a><span id="l9.4866">     rv = SendData(data);</span>
<a href="#l9.4867"></a><span id="l9.4867" class="difflineminus">-    PR_Free (data);</span>
<a href="#l9.4868"></a><span id="l9.4868" class="difflineplus">+    PR_Free(data);</span>
<a href="#l9.4869"></a><span id="l9.4869">     if (NS_FAILED(rv)) {</span>
<a href="#l9.4870"></a><span id="l9.4870">       nsAutoCString errorText;</span>
<a href="#l9.4871"></a><span id="l9.4871">       errorText.AppendInt(status);</span>
<a href="#l9.4872"></a><span id="l9.4872">       AlertError(MK_TCP_WRITE_ERROR, errorText.get());</span>
<a href="#l9.4873"></a><span id="l9.4873">       failure = true;</span>
<a href="#l9.4874"></a><span id="l9.4874">       goto FAIL;</span>
<a href="#l9.4875"></a><span id="l9.4875">     }</span>
<a href="#l9.4876"></a><span id="l9.4876"> </span>
<a href="#l9.4877"></a><span id="l9.4877">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4878"></a><span id="l9.4878">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4879"></a><span id="l9.4879">     m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l9.4880"></a><span id="l9.4880"> </span>
<a href="#l9.4881"></a><span id="l9.4881" class="difflineminus">-    // QA needs to be able to turn this alert off, for the automate tests.  see bug #31057</span>
<a href="#l9.4882"></a><span id="l9.4882" class="difflineminus">-    rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_ALERT_ON_SUCCESS, &amp;showAlertAfterCancel);</span>
<a href="#l9.4883"></a><span id="l9.4883" class="difflineplus">+    // QA needs to be able to turn this alert off, for the automate tests.  see</span>
<a href="#l9.4884"></a><span id="l9.4884" class="difflineplus">+    // bug #31057</span>
<a href="#l9.4885"></a><span id="l9.4885" class="difflineplus">+    rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_ALERT_ON_SUCCESS,</span>
<a href="#l9.4886"></a><span id="l9.4886" class="difflineplus">+                                 &amp;showAlertAfterCancel);</span>
<a href="#l9.4887"></a><span id="l9.4887">     if (NS_FAILED(rv) || showAlertAfterCancel) {</span>
<a href="#l9.4888"></a><span id="l9.4888">       GetNewsStringByName(&quot;messageCancelled&quot;, getter_Copies(alertText));</span>
<a href="#l9.4889"></a><span id="l9.4889">       rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l9.4890"></a><span id="l9.4890">       // XXX:  todo, check rv?</span>
<a href="#l9.4891"></a><span id="l9.4891">     }</span>
<a href="#l9.4892"></a><span id="l9.4892"> </span>
<a href="#l9.4893"></a><span id="l9.4893">     if (!m_runningURL) return NS_ERROR_FAILURE;</span>
<a href="#l9.4894"></a><span id="l9.4894"> </span>
<a href="#l9.4895"></a><span id="l9.4895">     // delete the message from the db here.</span>
<a href="#l9.4896"></a><span id="l9.4896" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; m_newsFolder &amp;&amp; (m_key != nsMsgKey_None), &quot;need more to remove this message from the db&quot;);</span>
<a href="#l9.4897"></a><span id="l9.4897" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; m_newsFolder &amp;&amp; (m_key != nsMsgKey_None),</span>
<a href="#l9.4898"></a><span id="l9.4898" class="difflineplus">+                 &quot;need more to remove this message from the db&quot;);</span>
<a href="#l9.4899"></a><span id="l9.4899">     if ((m_key != nsMsgKey_None) &amp;&amp; (m_newsFolder))</span>
<a href="#l9.4900"></a><span id="l9.4900" class="difflineminus">-       rv = m_newsFolder-&gt;RemoveMessage(m_key);</span>
<a href="#l9.4901"></a><span id="l9.4901" class="difflineminus">-</span>
<a href="#l9.4902"></a><span id="l9.4902" class="difflineplus">+      rv = m_newsFolder-&gt;RemoveMessage(m_key);</span>
<a href="#l9.4903"></a><span id="l9.4903">   }</span>
<a href="#l9.4904"></a><span id="l9.4904"> </span>
<a href="#l9.4905"></a><span id="l9.4905"> FAIL:</span>
<a href="#l9.4906"></a><span id="l9.4906" class="difflineminus">-  NS_ASSERTION(m_newsFolder,&quot;no news folder&quot;);</span>
<a href="#l9.4907"></a><span id="l9.4907" class="difflineplus">+  NS_ASSERTION(m_newsFolder, &quot;no news folder&quot;);</span>
<a href="#l9.4908"></a><span id="l9.4908">   if (m_newsFolder)</span>
<a href="#l9.4909"></a><span id="l9.4909" class="difflineminus">-    rv = ( failure ) ? m_newsFolder-&gt;CancelFailed()</span>
<a href="#l9.4910"></a><span id="l9.4910" class="difflineminus">-                     : m_newsFolder-&gt;CancelComplete();</span>
<a href="#l9.4911"></a><span id="l9.4911" class="difflineplus">+    rv = (failure) ? m_newsFolder-&gt;CancelFailed()</span>
<a href="#l9.4912"></a><span id="l9.4912" class="difflineplus">+                   : m_newsFolder-&gt;CancelComplete();</span>
<a href="#l9.4913"></a><span id="l9.4913"> </span>
<a href="#l9.4914"></a><span id="l9.4914">   return rv;</span>
<a href="#l9.4915"></a><span id="l9.4915"> }</span>
<a href="#l9.4916"></a><span id="l9.4916"> </span>
<a href="#l9.4917"></a><span id="l9.4917" class="difflineminus">-nsresult nsNNTPProtocol::XPATSend()</span>
<a href="#l9.4918"></a><span id="l9.4918" class="difflineminus">-{</span>
<a href="#l9.4919"></a><span id="l9.4919" class="difflineplus">+nsresult nsNNTPProtocol::XPATSend() {</span>
<a href="#l9.4920"></a><span id="l9.4920">   nsresult rv = NS_OK;</span>
<a href="#l9.4921"></a><span id="l9.4921">   int32_t slash = m_searchData.FindChar('/');</span>
<a href="#l9.4922"></a><span id="l9.4922"> </span>
<a href="#l9.4923"></a><span id="l9.4923" class="difflineminus">-  if (slash &gt;= 0)</span>
<a href="#l9.4924"></a><span id="l9.4924" class="difflineminus">-  {</span>
<a href="#l9.4925"></a><span id="l9.4925" class="difflineplus">+  if (slash &gt;= 0) {</span>
<a href="#l9.4926"></a><span id="l9.4926">     /* extract the XPAT encoding for one query term */</span>
<a href="#l9.4927"></a><span id="l9.4927">     /* char *next_search = NULL; */</span>
<a href="#l9.4928"></a><span id="l9.4928">     char *command = NULL;</span>
<a href="#l9.4929"></a><span id="l9.4929">     char *unescapedCommand = NULL;</span>
<a href="#l9.4930"></a><span id="l9.4930">     char *endOfTerm = NULL;</span>
<a href="#l9.4931"></a><span id="l9.4931" class="difflineminus">-    NS_MsgSACopy (&amp;command, m_searchData.get() + slash + 1);</span>
<a href="#l9.4932"></a><span id="l9.4932" class="difflineplus">+    NS_MsgSACopy(&amp;command, m_searchData.get() + slash + 1);</span>
<a href="#l9.4933"></a><span id="l9.4933">     endOfTerm = PL_strchr(command, '/');</span>
<a href="#l9.4934"></a><span id="l9.4934" class="difflineminus">-    if (endOfTerm)</span>
<a href="#l9.4935"></a><span id="l9.4935" class="difflineminus">-      *endOfTerm = '\0';</span>
<a href="#l9.4936"></a><span id="l9.4936" class="difflineplus">+    if (endOfTerm) *endOfTerm = '\0';</span>
<a href="#l9.4937"></a><span id="l9.4937">     NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l9.4938"></a><span id="l9.4938"> </span>
<a href="#l9.4939"></a><span id="l9.4939">     unescapedCommand = MSG_UnEscapeSearchUrl(command);</span>
<a href="#l9.4940"></a><span id="l9.4940"> </span>
<a href="#l9.4941"></a><span id="l9.4941">     /* send one term off to the server */</span>
<a href="#l9.4942"></a><span id="l9.4942">     rv = SendData(unescapedCommand);</span>
<a href="#l9.4943"></a><span id="l9.4943"> </span>
<a href="#l9.4944"></a><span id="l9.4944">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.4945"></a><span id="l9.4945">     m_nextStateAfterResponse = NNTP_XPAT_RESPONSE;</span>
<a href="#l9.4946"></a><span id="l9.4946">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4947"></a><span id="l9.4947"> </span>
<a href="#l9.4948"></a><span id="l9.4948">     PR_Free(command);</span>
<a href="#l9.4949"></a><span id="l9.4949">     PR_Free(unescapedCommand);</span>
<a href="#l9.4950"></a><span id="l9.4950" class="difflineminus">-  }</span>
<a href="#l9.4951"></a><span id="l9.4951" class="difflineminus">-  else</span>
<a href="#l9.4952"></a><span id="l9.4952" class="difflineminus">-  {</span>
<a href="#l9.4953"></a><span id="l9.4953" class="difflineplus">+  } else {</span>
<a href="#l9.4954"></a><span id="l9.4954">     m_nextState = NEWS_DONE;</span>
<a href="#l9.4955"></a><span id="l9.4955">   }</span>
<a href="#l9.4956"></a><span id="l9.4956">   return rv;</span>
<a href="#l9.4957"></a><span id="l9.4957"> }</span>
<a href="#l9.4958"></a><span id="l9.4958"> </span>
<a href="#l9.4959"></a><span id="l9.4959" class="difflineminus">-nsresult nsNNTPProtocol::XPATResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.4960"></a><span id="l9.4960" class="difflineminus">-{</span>
<a href="#l9.4961"></a><span id="l9.4961" class="difflineplus">+nsresult nsNNTPProtocol::XPATResponse(nsIInputStream *inputStream,</span>
<a href="#l9.4962"></a><span id="l9.4962" class="difflineplus">+                                      uint32_t length) {</span>
<a href="#l9.4963"></a><span id="l9.4963">   uint32_t status = 1;</span>
<a href="#l9.4964"></a><span id="l9.4964">   nsresult rv;</span>
<a href="#l9.4965"></a><span id="l9.4965"> </span>
<a href="#l9.4966"></a><span id="l9.4966" class="difflineminus">-  if (m_responseCode != MK_NNTP_RESPONSE_XPAT_OK)</span>
<a href="#l9.4967"></a><span id="l9.4967" class="difflineminus">-  {</span>
<a href="#l9.4968"></a><span id="l9.4968" class="difflineminus">-    AlertError(MK_NNTP_ERROR_MESSAGE,m_responseText);</span>
<a href="#l9.4969"></a><span id="l9.4969" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_XPAT_OK) {</span>
<a href="#l9.4970"></a><span id="l9.4970" class="difflineplus">+    AlertError(MK_NNTP_ERROR_MESSAGE, m_responseText);</span>
<a href="#l9.4971"></a><span id="l9.4971">     m_nextState = NNTP_ERROR;</span>
<a href="#l9.4972"></a><span id="l9.4972">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4973"></a><span id="l9.4973">     return NS_ERROR_FAILURE;</span>
<a href="#l9.4974"></a><span id="l9.4974">   }</span>
<a href="#l9.4975"></a><span id="l9.4975"> </span>
<a href="#l9.4976"></a><span id="l9.4976">   bool pauseForMoreData = false;</span>
<a href="#l9.4977"></a><span id="l9.4977" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.4978"></a><span id="l9.4978" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.4979"></a><span id="l9.4979" class="difflineplus">+                                                pauseForMoreData, &amp;rv);</span>
<a href="#l9.4980"></a><span id="l9.4980"> </span>
<a href="#l9.4981"></a><span id="l9.4981">   NNTP_LOG_READ(line);</span>
<a href="#l9.4982"></a><span id="l9.4982"> </span>
<a href="#l9.4983"></a><span id="l9.4983" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.4984"></a><span id="l9.4984" class="difflineminus">-  {</span>
<a href="#l9.4985"></a><span id="l9.4985" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.4986"></a><span id="l9.4986">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.4987"></a><span id="l9.4987">     return NS_OK;</span>
<a href="#l9.4988"></a><span id="l9.4988">   }</span>
<a href="#l9.4989"></a><span id="l9.4989"> </span>
<a href="#l9.4990"></a><span id="l9.4990" class="difflineminus">-  if (line)</span>
<a href="#l9.4991"></a><span id="l9.4991" class="difflineminus">-  {</span>
<a href="#l9.4992"></a><span id="l9.4992" class="difflineminus">-    if (line[0] != '.')</span>
<a href="#l9.4993"></a><span id="l9.4993" class="difflineminus">-    {</span>
<a href="#l9.4994"></a><span id="l9.4994" class="difflineplus">+  if (line) {</span>
<a href="#l9.4995"></a><span id="l9.4995" class="difflineplus">+    if (line[0] != '.') {</span>
<a href="#l9.4996"></a><span id="l9.4996">       long articleNumber;</span>
<a href="#l9.4997"></a><span id="l9.4997">       PR_sscanf(line, &quot;%ld&quot;, &amp;articleNumber);</span>
<a href="#l9.4998"></a><span id="l9.4998">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.4999"></a><span id="l9.4999" class="difflineminus">-      if (mailnewsurl)</span>
<a href="#l9.5000"></a><span id="l9.5000" class="difflineminus">-      {</span>
<a href="#l9.5001"></a><span id="l9.5001" class="difflineminus">-        nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l9.5002"></a><span id="l9.5002" class="difflineminus">-        nsCOMPtr &lt;nsIMsgSearchAdapter&gt; searchAdapter;</span>
<a href="#l9.5003"></a><span id="l9.5003" class="difflineplus">+      if (mailnewsurl) {</span>
<a href="#l9.5004"></a><span id="l9.5004" class="difflineplus">+        nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l9.5005"></a><span id="l9.5005" class="difflineplus">+        nsCOMPtr&lt;nsIMsgSearchAdapter&gt; searchAdapter;</span>
<a href="#l9.5006"></a><span id="l9.5006">         mailnewsurl-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l9.5007"></a><span id="l9.5007" class="difflineminus">-        if (searchSession)</span>
<a href="#l9.5008"></a><span id="l9.5008" class="difflineminus">-        {</span>
<a href="#l9.5009"></a><span id="l9.5009" class="difflineplus">+        if (searchSession) {</span>
<a href="#l9.5010"></a><span id="l9.5010">           searchSession-&gt;GetRunningAdapter(getter_AddRefs(searchAdapter));</span>
<a href="#l9.5011"></a><span id="l9.5011" class="difflineminus">-          if (searchAdapter)</span>
<a href="#l9.5012"></a><span id="l9.5012" class="difflineminus">-            searchAdapter-&gt;AddHit((uint32_t) articleNumber);</span>
<a href="#l9.5013"></a><span id="l9.5013" class="difflineplus">+          if (searchAdapter) searchAdapter-&gt;AddHit((uint32_t)articleNumber);</span>
<a href="#l9.5014"></a><span id="l9.5014">         }</span>
<a href="#l9.5015"></a><span id="l9.5015">       }</span>
<a href="#l9.5016"></a><span id="l9.5016" class="difflineminus">-    }</span>
<a href="#l9.5017"></a><span id="l9.5017" class="difflineminus">-    else</span>
<a href="#l9.5018"></a><span id="l9.5018" class="difflineminus">-    {</span>
<a href="#l9.5019"></a><span id="l9.5019" class="difflineplus">+    } else {</span>
<a href="#l9.5020"></a><span id="l9.5020">       /* set up the next term for next time around */</span>
<a href="#l9.5021"></a><span id="l9.5021">       int32_t slash = m_searchData.FindChar('/');</span>
<a href="#l9.5022"></a><span id="l9.5022"> </span>
<a href="#l9.5023"></a><span id="l9.5023">       if (slash &gt;= 0)</span>
<a href="#l9.5024"></a><span id="l9.5024">         m_searchData.Cut(0, slash + 1);</span>
<a href="#l9.5025"></a><span id="l9.5025">       else</span>
<a href="#l9.5026"></a><span id="l9.5026">         m_searchData.Truncate();</span>
<a href="#l9.5027"></a><span id="l9.5027"> </span>
<a href="#l9.5028"></a><span id="l9.5028" class="difflineat">@@ -3853,64 +3590,57 @@ nsresult nsNNTPProtocol::XPATResponse(ns</span>
<a href="#l9.5029"></a><span id="l9.5029">       PR_FREEIF(line);</span>
<a href="#l9.5030"></a><span id="l9.5030">       return NS_OK;</span>
<a href="#l9.5031"></a><span id="l9.5031">     }</span>
<a href="#l9.5032"></a><span id="l9.5032">   }</span>
<a href="#l9.5033"></a><span id="l9.5033">   PR_FREEIF(line);</span>
<a href="#l9.5034"></a><span id="l9.5034">   return NS_OK;</span>
<a href="#l9.5035"></a><span id="l9.5035"> }</span>
<a href="#l9.5036"></a><span id="l9.5036"> </span>
<a href="#l9.5037"></a><span id="l9.5037" class="difflineminus">-nsresult nsNNTPProtocol::ListPrettyNames()</span>
<a href="#l9.5038"></a><span id="l9.5038" class="difflineminus">-{</span>
<a href="#l9.5039"></a><span id="l9.5039" class="difflineminus">-</span>
<a href="#l9.5040"></a><span id="l9.5040" class="difflineplus">+nsresult nsNNTPProtocol::ListPrettyNames() {</span>
<a href="#l9.5041"></a><span id="l9.5041">   nsCString group_name;</span>
<a href="#l9.5042"></a><span id="l9.5042">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.5043"></a><span id="l9.5043"> </span>
<a href="#l9.5044"></a><span id="l9.5044">   m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l9.5045"></a><span id="l9.5045" class="difflineminus">-  PR_snprintf(outputBuffer,</span>
<a href="#l9.5046"></a><span id="l9.5046" class="difflineminus">-    OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.5047"></a><span id="l9.5047" class="difflineminus">-    &quot;LIST PRETTYNAMES %.512s&quot; CRLF,</span>
<a href="#l9.5048"></a><span id="l9.5048" class="difflineminus">-    group_name.get());</span>
<a href="#l9.5049"></a><span id="l9.5049" class="difflineplus">+  PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;LIST PRETTYNAMES %.512s&quot; CRLF,</span>
<a href="#l9.5050"></a><span id="l9.5050" class="difflineplus">+              group_name.get());</span>
<a href="#l9.5051"></a><span id="l9.5051"> </span>
<a href="#l9.5052"></a><span id="l9.5052">   nsresult rv = SendData(outputBuffer);</span>
<a href="#l9.5053"></a><span id="l9.5053">   NNTP_LOG_NOTE(outputBuffer);</span>
<a href="#l9.5054"></a><span id="l9.5054">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.5055"></a><span id="l9.5055">   m_nextStateAfterResponse = NNTP_LIST_PRETTY_NAMES_RESPONSE;</span>
<a href="#l9.5056"></a><span id="l9.5056"> </span>
<a href="#l9.5057"></a><span id="l9.5057">   return rv;</span>
<a href="#l9.5058"></a><span id="l9.5058"> }</span>
<a href="#l9.5059"></a><span id="l9.5059"> </span>
<a href="#l9.5060"></a><span id="l9.5060" class="difflineminus">-nsresult nsNNTPProtocol::ListPrettyNamesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.5061"></a><span id="l9.5061" class="difflineminus">-{</span>
<a href="#l9.5062"></a><span id="l9.5062" class="difflineplus">+nsresult nsNNTPProtocol::ListPrettyNamesResponse(nsIInputStream *inputStream,</span>
<a href="#l9.5063"></a><span id="l9.5063" class="difflineplus">+                                                 uint32_t length) {</span>
<a href="#l9.5064"></a><span id="l9.5064">   uint32_t status = 0;</span>
<a href="#l9.5065"></a><span id="l9.5065"> </span>
<a href="#l9.5066"></a><span id="l9.5066" class="difflineminus">-  if (m_responseCode != MK_NNTP_RESPONSE_LIST_OK)</span>
<a href="#l9.5067"></a><span id="l9.5067" class="difflineminus">-  {</span>
<a href="#l9.5068"></a><span id="l9.5068" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_LIST_OK) {</span>
<a href="#l9.5069"></a><span id="l9.5069">     m_nextState = DISPLAY_NEWSGROUPS;</span>
<a href="#l9.5070"></a><span id="l9.5070">     /*    m_nextState = NEWS_DONE; */</span>
<a href="#l9.5071"></a><span id="l9.5071">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5072"></a><span id="l9.5072">     return NS_OK;</span>
<a href="#l9.5073"></a><span id="l9.5073">   }</span>
<a href="#l9.5074"></a><span id="l9.5074"> </span>
<a href="#l9.5075"></a><span id="l9.5075">   bool pauseForMoreData = false;</span>
<a href="#l9.5076"></a><span id="l9.5076" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.5077"></a><span id="l9.5077" class="difflineplus">+  char *line =</span>
<a href="#l9.5078"></a><span id="l9.5078" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.5079"></a><span id="l9.5079"> </span>
<a href="#l9.5080"></a><span id="l9.5080">   NNTP_LOG_READ(line);</span>
<a href="#l9.5081"></a><span id="l9.5081"> </span>
<a href="#l9.5082"></a><span id="l9.5082" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.5083"></a><span id="l9.5083" class="difflineminus">-  {</span>
<a href="#l9.5084"></a><span id="l9.5084" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.5085"></a><span id="l9.5085">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5086"></a><span id="l9.5086">     return NS_OK;</span>
<a href="#l9.5087"></a><span id="l9.5087">   }</span>
<a href="#l9.5088"></a><span id="l9.5088"> </span>
<a href="#l9.5089"></a><span id="l9.5089" class="difflineminus">-  if (line)</span>
<a href="#l9.5090"></a><span id="l9.5090" class="difflineminus">-  {</span>
<a href="#l9.5091"></a><span id="l9.5091" class="difflineminus">-    if (line[0] != '.')</span>
<a href="#l9.5092"></a><span id="l9.5092" class="difflineminus">-    {</span>
<a href="#l9.5093"></a><span id="l9.5093" class="difflineminus">-#if 0 // SetPrettyName is not yet implemented. No reason to bother</span>
<a href="#l9.5094"></a><span id="l9.5094" class="difflineplus">+  if (line) {</span>
<a href="#l9.5095"></a><span id="l9.5095" class="difflineplus">+    if (line[0] != '.') {</span>
<a href="#l9.5096"></a><span id="l9.5096" class="difflineplus">+#if 0  // SetPrettyName is not yet implemented. No reason to bother</span>
<a href="#l9.5097"></a><span id="l9.5097">       int i;</span>
<a href="#l9.5098"></a><span id="l9.5098">       /* find whitespace separator if it exits */</span>
<a href="#l9.5099"></a><span id="l9.5099">       for (i=0; line[i] != '\0' &amp;&amp; !NET_IS_SPACE(line[i]); i++)</span>
<a href="#l9.5100"></a><span id="l9.5100">         ;  /* null body */</span>
<a href="#l9.5101"></a><span id="l9.5101"> </span>
<a href="#l9.5102"></a><span id="l9.5102">       char *prettyName;</span>
<a href="#l9.5103"></a><span id="l9.5103">       if(line[i] == '\0')</span>
<a href="#l9.5104"></a><span id="l9.5104">         prettyName = &amp;line[i];</span>
<a href="#l9.5105"></a><span id="l9.5105" class="difflineat">@@ -3928,699 +3658,661 @@ nsresult nsNNTPProtocol::ListPrettyNames</span>
<a href="#l9.5106"></a><span id="l9.5106">           CopyUTF8toUTF16(prettyName, prettyNameUtf16);</span>
<a href="#l9.5107"></a><span id="l9.5107">         }</span>
<a href="#l9.5108"></a><span id="l9.5108">         m_nntpServer-&gt;SetPrettyNameForGroup(lineUtf16, prettyNameUtf16);</span>
<a href="#l9.5109"></a><span id="l9.5109"> </span>
<a href="#l9.5110"></a><span id="l9.5110">         MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) adding pretty name %s&quot;, this,</span>
<a href="#l9.5111"></a><span id="l9.5111">                NS_ConvertUTF16toUTF8(prettyNameUtf16).get()));</span>
<a href="#l9.5112"></a><span id="l9.5112">       }</span>
<a href="#l9.5113"></a><span id="l9.5113"> #endif</span>
<a href="#l9.5114"></a><span id="l9.5114" class="difflineminus">-    }</span>
<a href="#l9.5115"></a><span id="l9.5115" class="difflineminus">-    else</span>
<a href="#l9.5116"></a><span id="l9.5116" class="difflineminus">-    {</span>
<a href="#l9.5117"></a><span id="l9.5117" class="difflineminus">-      m_nextState = DISPLAY_NEWSGROUPS;  /* this assumes we were doing a list */</span>
<a href="#l9.5118"></a><span id="l9.5118" class="difflineplus">+    } else {</span>
<a href="#l9.5119"></a><span id="l9.5119" class="difflineplus">+      m_nextState = DISPLAY_NEWSGROUPS; /* this assumes we were doing a list */</span>
<a href="#l9.5120"></a><span id="l9.5120">       /*      m_nextState = NEWS_DONE;   */ /* ### dmb - don't really know */</span>
<a href="#l9.5121"></a><span id="l9.5121">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5122"></a><span id="l9.5122">       PR_FREEIF(line);</span>
<a href="#l9.5123"></a><span id="l9.5123">       return NS_OK;</span>
<a href="#l9.5124"></a><span id="l9.5124">     }</span>
<a href="#l9.5125"></a><span id="l9.5125">   }</span>
<a href="#l9.5126"></a><span id="l9.5126">   PR_FREEIF(line);</span>
<a href="#l9.5127"></a><span id="l9.5127">   return NS_OK;</span>
<a href="#l9.5128"></a><span id="l9.5128"> }</span>
<a href="#l9.5129"></a><span id="l9.5129"> </span>
<a href="#l9.5130"></a><span id="l9.5130" class="difflineminus">-nsresult nsNNTPProtocol::ListXActive()</span>
<a href="#l9.5131"></a><span id="l9.5131" class="difflineminus">-{</span>
<a href="#l9.5132"></a><span id="l9.5132" class="difflineplus">+nsresult nsNNTPProtocol::ListXActive() {</span>
<a href="#l9.5133"></a><span id="l9.5133">   nsCString group_name;</span>
<a href="#l9.5134"></a><span id="l9.5134">   nsresult rv;</span>
<a href="#l9.5135"></a><span id="l9.5135">   rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l9.5136"></a><span id="l9.5136">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.5137"></a><span id="l9.5137"> </span>
<a href="#l9.5138"></a><span id="l9.5138">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.5139"></a><span id="l9.5139"> </span>
<a href="#l9.5140"></a><span id="l9.5140" class="difflineminus">-  PR_snprintf(outputBuffer,</span>
<a href="#l9.5141"></a><span id="l9.5141" class="difflineminus">-    OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.5142"></a><span id="l9.5142" class="difflineminus">-    &quot;LIST XACTIVE %.512s&quot; CRLF,</span>
<a href="#l9.5143"></a><span id="l9.5143" class="difflineminus">-    group_name.get());</span>
<a href="#l9.5144"></a><span id="l9.5144" class="difflineplus">+  PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;LIST XACTIVE %.512s&quot; CRLF,</span>
<a href="#l9.5145"></a><span id="l9.5145" class="difflineplus">+              group_name.get());</span>
<a href="#l9.5146"></a><span id="l9.5146"> </span>
<a href="#l9.5147"></a><span id="l9.5147">   rv = SendData(outputBuffer);</span>
<a href="#l9.5148"></a><span id="l9.5148"> </span>
<a href="#l9.5149"></a><span id="l9.5149">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.5150"></a><span id="l9.5150">   m_nextStateAfterResponse = NNTP_LIST_XACTIVE_RESPONSE;</span>
<a href="#l9.5151"></a><span id="l9.5151"> </span>
<a href="#l9.5152"></a><span id="l9.5152">   return rv;</span>
<a href="#l9.5153"></a><span id="l9.5153"> }</span>
<a href="#l9.5154"></a><span id="l9.5154"> </span>
<a href="#l9.5155"></a><span id="l9.5155" class="difflineminus">-nsresult nsNNTPProtocol::ListXActiveResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.5156"></a><span id="l9.5156" class="difflineminus">-{</span>
<a href="#l9.5157"></a><span id="l9.5157" class="difflineplus">+nsresult nsNNTPProtocol::ListXActiveResponse(nsIInputStream *inputStream,</span>
<a href="#l9.5158"></a><span id="l9.5158" class="difflineplus">+                                             uint32_t length) {</span>
<a href="#l9.5159"></a><span id="l9.5159">   uint32_t status = 0;</span>
<a href="#l9.5160"></a><span id="l9.5160">   nsresult rv;</span>
<a href="#l9.5161"></a><span id="l9.5161"> </span>
<a href="#l9.5162"></a><span id="l9.5162">   NS_ASSERTION(m_responseCode == MK_NNTP_RESPONSE_LIST_OK, &quot;code != LIST_OK&quot;);</span>
<a href="#l9.5163"></a><span id="l9.5163" class="difflineminus">-  if (m_responseCode != MK_NNTP_RESPONSE_LIST_OK)</span>
<a href="#l9.5164"></a><span id="l9.5164" class="difflineminus">-  {</span>
<a href="#l9.5165"></a><span id="l9.5165" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_LIST_OK) {</span>
<a href="#l9.5166"></a><span id="l9.5166">     m_nextState = DISPLAY_NEWSGROUPS;</span>
<a href="#l9.5167"></a><span id="l9.5167">     /*    m_nextState = NEWS_DONE; */</span>
<a href="#l9.5168"></a><span id="l9.5168">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5169"></a><span id="l9.5169">     return NS_OK;</span>
<a href="#l9.5170"></a><span id="l9.5170">   }</span>
<a href="#l9.5171"></a><span id="l9.5171"> </span>
<a href="#l9.5172"></a><span id="l9.5172">   bool pauseForMoreData = false;</span>
<a href="#l9.5173"></a><span id="l9.5173" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.5174"></a><span id="l9.5174" class="difflineplus">+  char *line =</span>
<a href="#l9.5175"></a><span id="l9.5175" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.5176"></a><span id="l9.5176"> </span>
<a href="#l9.5177"></a><span id="l9.5177">   NNTP_LOG_READ(line);</span>
<a href="#l9.5178"></a><span id="l9.5178"> </span>
<a href="#l9.5179"></a><span id="l9.5179" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.5180"></a><span id="l9.5180" class="difflineminus">-  {</span>
<a href="#l9.5181"></a><span id="l9.5181" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.5182"></a><span id="l9.5182">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5183"></a><span id="l9.5183">     return NS_OK;</span>
<a href="#l9.5184"></a><span id="l9.5184">   }</span>
<a href="#l9.5185"></a><span id="l9.5185"> </span>
<a href="#l9.5186"></a><span id="l9.5186" class="difflineminus">-   /* almost correct */</span>
<a href="#l9.5187"></a><span id="l9.5187" class="difflineminus">-  if(status &gt; 1)</span>
<a href="#l9.5188"></a><span id="l9.5188" class="difflineminus">-  {</span>
<a href="#l9.5189"></a><span id="l9.5189" class="difflineplus">+  /* almost correct */</span>
<a href="#l9.5190"></a><span id="l9.5190" class="difflineplus">+  if (status &gt; 1) {</span>
<a href="#l9.5191"></a><span id="l9.5191">     mBytesReceived += status;</span>
<a href="#l9.5192"></a><span id="l9.5192">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l9.5193"></a><span id="l9.5193">   }</span>
<a href="#l9.5194"></a><span id="l9.5194"> </span>
<a href="#l9.5195"></a><span id="l9.5195" class="difflineminus">-  if (line)</span>
<a href="#l9.5196"></a><span id="l9.5196" class="difflineminus">-  {</span>
<a href="#l9.5197"></a><span id="l9.5197" class="difflineminus">-    if (line[0] != '.')</span>
<a href="#l9.5198"></a><span id="l9.5198" class="difflineminus">-    {</span>
<a href="#l9.5199"></a><span id="l9.5199" class="difflineplus">+  if (line) {</span>
<a href="#l9.5200"></a><span id="l9.5200" class="difflineplus">+    if (line[0] != '.') {</span>
<a href="#l9.5201"></a><span id="l9.5201">       char *s = line;</span>
<a href="#l9.5202"></a><span id="l9.5202">       /* format is &quot;rec.arts.movies.past-films 7302 7119 csp&quot;</span>
<a href="#l9.5203"></a><span id="l9.5203" class="difflineminus">-      */</span>
<a href="#l9.5204"></a><span id="l9.5204" class="difflineminus">-      while (*s &amp;&amp; !NET_IS_SPACE(*s))</span>
<a href="#l9.5205"></a><span id="l9.5205" class="difflineminus">-        s++;</span>
<a href="#l9.5206"></a><span id="l9.5206" class="difflineminus">-      if (*s)</span>
<a href="#l9.5207"></a><span id="l9.5207" class="difflineminus">-      {</span>
<a href="#l9.5208"></a><span id="l9.5208" class="difflineminus">-        char flags[32];  /* ought to be big enough */</span>
<a href="#l9.5209"></a><span id="l9.5209" class="difflineplus">+       */</span>
<a href="#l9.5210"></a><span id="l9.5210" class="difflineplus">+      while (*s &amp;&amp; !NET_IS_SPACE(*s)) s++;</span>
<a href="#l9.5211"></a><span id="l9.5211" class="difflineplus">+      if (*s) {</span>
<a href="#l9.5212"></a><span id="l9.5212" class="difflineplus">+        char flags[32]; /* ought to be big enough */</span>
<a href="#l9.5213"></a><span id="l9.5213">         *s = 0;</span>
<a href="#l9.5214"></a><span id="l9.5214" class="difflineminus">-        PR_sscanf(s + 1,</span>
<a href="#l9.5215"></a><span id="l9.5215" class="difflineminus">-          &quot;%d %d %31s&quot;,</span>
<a href="#l9.5216"></a><span id="l9.5216" class="difflineminus">-          &amp;m_firstPossibleArticle,</span>
<a href="#l9.5217"></a><span id="l9.5217" class="difflineminus">-          &amp;m_lastPossibleArticle,</span>
<a href="#l9.5218"></a><span id="l9.5218" class="difflineminus">-          flags);</span>
<a href="#l9.5219"></a><span id="l9.5219" class="difflineminus">-</span>
<a href="#l9.5220"></a><span id="l9.5220" class="difflineplus">+        PR_sscanf(s + 1, &quot;%d %d %31s&quot;, &amp;m_firstPossibleArticle,</span>
<a href="#l9.5221"></a><span id="l9.5221" class="difflineplus">+                  &amp;m_lastPossibleArticle, flags);</span>
<a href="#l9.5222"></a><span id="l9.5222"> </span>
<a href="#l9.5223"></a><span id="l9.5223">         NS_ASSERTION(m_nntpServer, &quot;no nntp incoming server&quot;);</span>
<a href="#l9.5224"></a><span id="l9.5224">         if (m_nntpServer) {</span>
<a href="#l9.5225"></a><span id="l9.5225">           rv = m_nntpServer-&gt;AddNewsgroupToList(line);</span>
<a href="#l9.5226"></a><span id="l9.5226" class="difflineminus">-          NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to add to subscribe ds&quot;);</span>
<a href="#l9.5227"></a><span id="l9.5227" class="difflineplus">+          NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to add to subscribe ds&quot;);</span>
<a href="#l9.5228"></a><span id="l9.5228">         }</span>
<a href="#l9.5229"></a><span id="l9.5229"> </span>
<a href="#l9.5230"></a><span id="l9.5230">         /* we're either going to list prettynames first, or list</span>
<a href="#l9.5231"></a><span id="l9.5231">         all prettynames every time, so we won't care so much</span>
<a href="#l9.5232"></a><span id="l9.5232">         if it gets interrupted. */</span>
<a href="#l9.5233"></a><span id="l9.5233" class="difflineminus">-        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) got xactive for %s of %s&quot;, this, line, flags));</span>
<a href="#l9.5234"></a><span id="l9.5234" class="difflineplus">+        MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.5235"></a><span id="l9.5235" class="difflineplus">+                (&quot;(%p) got xactive for %s of %s&quot;, this, line, flags));</span>
<a href="#l9.5236"></a><span id="l9.5236">         /*  This isn't required, because the extra info is</span>
<a href="#l9.5237"></a><span id="l9.5237">         initialized to false for new groups. And it's</span>
<a href="#l9.5238"></a><span id="l9.5238">         an expensive call.</span>
<a href="#l9.5239"></a><span id="l9.5239">         */</span>
<a href="#l9.5240"></a><span id="l9.5240">         /* MSG_SetGroupNeedsExtraInfo(cd-&gt;host, line, false); */</span>
<a href="#l9.5241"></a><span id="l9.5241">       }</span>
<a href="#l9.5242"></a><span id="l9.5242" class="difflineminus">-    }</span>
<a href="#l9.5243"></a><span id="l9.5243" class="difflineminus">-    else</span>
<a href="#l9.5244"></a><span id="l9.5244" class="difflineminus">-    {</span>
<a href="#l9.5245"></a><span id="l9.5245" class="difflineminus">-      bool xactive=false;</span>
<a href="#l9.5246"></a><span id="l9.5246" class="difflineminus">-      rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l9.5247"></a><span id="l9.5247" class="difflineminus">-      if (m_typeWanted == NEW_GROUPS &amp;&amp;</span>
<a href="#l9.5248"></a><span id="l9.5248" class="difflineminus">-        NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l9.5249"></a><span id="l9.5249" class="difflineminus">-      {</span>
<a href="#l9.5250"></a><span id="l9.5250" class="difflineminus">-        nsCOMPtr &lt;nsIMsgNewsFolder&gt; old_newsFolder;</span>
<a href="#l9.5251"></a><span id="l9.5251" class="difflineplus">+    } else {</span>
<a href="#l9.5252"></a><span id="l9.5252" class="difflineplus">+      bool xactive = false;</span>
<a href="#l9.5253"></a><span id="l9.5253" class="difflineplus">+      rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;, &amp;xactive);</span>
<a href="#l9.5254"></a><span id="l9.5254" class="difflineplus">+      if (m_typeWanted == NEW_GROUPS &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; xactive) {</span>
<a href="#l9.5255"></a><span id="l9.5255" class="difflineplus">+        nsCOMPtr&lt;nsIMsgNewsFolder&gt; old_newsFolder;</span>
<a href="#l9.5256"></a><span id="l9.5256">         old_newsFolder = m_newsFolder;</span>
<a href="#l9.5257"></a><span id="l9.5257">         nsCString groupName;</span>
<a href="#l9.5258"></a><span id="l9.5258"> </span>
<a href="#l9.5259"></a><span id="l9.5259">         rv = m_nntpServer-&gt;GetFirstGroupNeedingExtraInfo(groupName);</span>
<a href="#l9.5260"></a><span id="l9.5260">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.5261"></a><span id="l9.5261" class="difflineminus">-        rv = m_nntpServer-&gt;FindGroup(groupName,</span>
<a href="#l9.5262"></a><span id="l9.5262" class="difflineminus">-                                     getter_AddRefs(m_newsFolder));</span>
<a href="#l9.5263"></a><span id="l9.5263" class="difflineplus">+        rv = m_nntpServer-&gt;FindGroup(groupName, getter_AddRefs(m_newsFolder));</span>
<a href="#l9.5264"></a><span id="l9.5264">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.5265"></a><span id="l9.5265"> </span>
<a href="#l9.5266"></a><span id="l9.5266">         // see if we got a different group</span>
<a href="#l9.5267"></a><span id="l9.5267">         if (old_newsFolder &amp;&amp; m_newsFolder &amp;&amp;</span>
<a href="#l9.5268"></a><span id="l9.5268" class="difflineminus">-          (old_newsFolder.get() != m_newsFolder.get()))</span>
<a href="#l9.5269"></a><span id="l9.5269" class="difflineminus">-          /* make sure we're not stuck on the same group */</span>
<a href="#l9.5270"></a><span id="l9.5270" class="difflineplus">+            (old_newsFolder.get() != m_newsFolder.get()))</span>
<a href="#l9.5271"></a><span id="l9.5271" class="difflineplus">+        /* make sure we're not stuck on the same group */</span>
<a href="#l9.5272"></a><span id="l9.5272">         {</span>
<a href="#l9.5273"></a><span id="l9.5273" class="difflineminus">-          MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) listing xactive for %s&quot;, this, groupName.get()));</span>
<a href="#l9.5274"></a><span id="l9.5274" class="difflineplus">+          MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.5275"></a><span id="l9.5275" class="difflineplus">+                  (&quot;(%p) listing xactive for %s&quot;, this, groupName.get()));</span>
<a href="#l9.5276"></a><span id="l9.5276">           m_nextState = NNTP_LIST_XACTIVE;</span>
<a href="#l9.5277"></a><span id="l9.5277">           ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5278"></a><span id="l9.5278">           PR_FREEIF(line);</span>
<a href="#l9.5279"></a><span id="l9.5279">           return NS_OK;</span>
<a href="#l9.5280"></a><span id="l9.5280" class="difflineminus">-        }</span>
<a href="#l9.5281"></a><span id="l9.5281" class="difflineminus">-        else</span>
<a href="#l9.5282"></a><span id="l9.5282" class="difflineminus">-        {</span>
<a href="#l9.5283"></a><span id="l9.5283" class="difflineplus">+        } else {</span>
<a href="#l9.5284"></a><span id="l9.5284">           m_newsFolder = nullptr;</span>
<a href="#l9.5285"></a><span id="l9.5285">         }</span>
<a href="#l9.5286"></a><span id="l9.5286">       }</span>
<a href="#l9.5287"></a><span id="l9.5287">       bool listpname;</span>
<a href="#l9.5288"></a><span id="l9.5288" class="difflineminus">-      rv = m_nntpServer-&gt;QueryExtension(&quot;LISTPNAME&quot;,&amp;listpname);</span>
<a href="#l9.5289"></a><span id="l9.5289" class="difflineplus">+      rv = m_nntpServer-&gt;QueryExtension(&quot;LISTPNAME&quot;, &amp;listpname);</span>
<a href="#l9.5290"></a><span id="l9.5290">       if (NS_SUCCEEDED(rv) &amp;&amp; listpname)</span>
<a href="#l9.5291"></a><span id="l9.5291">         m_nextState = NNTP_LIST_PRETTY_NAMES;</span>
<a href="#l9.5292"></a><span id="l9.5292">       else</span>
<a href="#l9.5293"></a><span id="l9.5293" class="difflineminus">-        m_nextState = DISPLAY_NEWSGROUPS;  /* this assumes we were doing a list - who knows? */</span>
<a href="#l9.5294"></a><span id="l9.5294" class="difflineplus">+        m_nextState = DISPLAY_NEWSGROUPS; /* this assumes we were doing a list -</span>
<a href="#l9.5295"></a><span id="l9.5295" class="difflineplus">+                                             who knows? */</span>
<a href="#l9.5296"></a><span id="l9.5296">       /*      m_nextState = NEWS_DONE;   */ /* ### dmb - don't really know */</span>
<a href="#l9.5297"></a><span id="l9.5297">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5298"></a><span id="l9.5298">       PR_FREEIF(line);</span>
<a href="#l9.5299"></a><span id="l9.5299">       return NS_OK;</span>
<a href="#l9.5300"></a><span id="l9.5300">     }</span>
<a href="#l9.5301"></a><span id="l9.5301">   }</span>
<a href="#l9.5302"></a><span id="l9.5302">   PR_FREEIF(line);</span>
<a href="#l9.5303"></a><span id="l9.5303">   return NS_OK;</span>
<a href="#l9.5304"></a><span id="l9.5304"> }</span>
<a href="#l9.5305"></a><span id="l9.5305"> </span>
<a href="#l9.5306"></a><span id="l9.5306" class="difflineminus">-nsresult nsNNTPProtocol::SendListGroup()</span>
<a href="#l9.5307"></a><span id="l9.5307" class="difflineminus">-{</span>
<a href="#l9.5308"></a><span id="l9.5308" class="difflineplus">+nsresult nsNNTPProtocol::SendListGroup() {</span>
<a href="#l9.5309"></a><span id="l9.5309">   nsresult rv;</span>
<a href="#l9.5310"></a><span id="l9.5310">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l9.5311"></a><span id="l9.5311"> </span>
<a href="#l9.5312"></a><span id="l9.5312" class="difflineminus">-  NS_ASSERTION(m_newsFolder,&quot;no newsFolder&quot;);</span>
<a href="#l9.5313"></a><span id="l9.5313" class="difflineplus">+  NS_ASSERTION(m_newsFolder, &quot;no newsFolder&quot;);</span>
<a href="#l9.5314"></a><span id="l9.5314">   if (!m_newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l9.5315"></a><span id="l9.5315">   nsCString newsgroupName;</span>
<a href="#l9.5316"></a><span id="l9.5316"> </span>
<a href="#l9.5317"></a><span id="l9.5317">   rv = m_newsFolder-&gt;GetRawName(newsgroupName);</span>
<a href="#l9.5318"></a><span id="l9.5318" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.5319"></a><span id="l9.5319" class="difflineminus">-</span>
<a href="#l9.5320"></a><span id="l9.5320" class="difflineminus">-  PR_snprintf(outputBuffer,</span>
<a href="#l9.5321"></a><span id="l9.5321" class="difflineminus">-    OUTPUT_BUFFER_SIZE,</span>
<a href="#l9.5322"></a><span id="l9.5322" class="difflineminus">-    &quot;listgroup %.512s&quot; CRLF,</span>
<a href="#l9.5323"></a><span id="l9.5323" class="difflineminus">-    newsgroupName.get());</span>
<a href="#l9.5324"></a><span id="l9.5324" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.5325"></a><span id="l9.5325" class="difflineplus">+</span>
<a href="#l9.5326"></a><span id="l9.5326" class="difflineplus">+  PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;listgroup %.512s&quot; CRLF,</span>
<a href="#l9.5327"></a><span id="l9.5327" class="difflineplus">+              newsgroupName.get());</span>
<a href="#l9.5328"></a><span id="l9.5328"> </span>
<a href="#l9.5329"></a><span id="l9.5329">   m_articleList = do_CreateInstance(NS_NNTPARTICLELIST_CONTRACTID, &amp;rv);</span>
<a href="#l9.5330"></a><span id="l9.5330" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.5331"></a><span id="l9.5331" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.5332"></a><span id="l9.5332"> </span>
<a href="#l9.5333"></a><span id="l9.5333">   rv = m_articleList-&gt;Initialize(m_newsFolder);</span>
<a href="#l9.5334"></a><span id="l9.5334" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.5335"></a><span id="l9.5335" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.5336"></a><span id="l9.5336"> </span>
<a href="#l9.5337"></a><span id="l9.5337">   rv = SendData(outputBuffer);</span>
<a href="#l9.5338"></a><span id="l9.5338"> </span>
<a href="#l9.5339"></a><span id="l9.5339">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l9.5340"></a><span id="l9.5340">   m_nextStateAfterResponse = NNTP_LIST_GROUP_RESPONSE;</span>
<a href="#l9.5341"></a><span id="l9.5341">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5342"></a><span id="l9.5342"> </span>
<a href="#l9.5343"></a><span id="l9.5343">   return rv;</span>
<a href="#l9.5344"></a><span id="l9.5344"> }</span>
<a href="#l9.5345"></a><span id="l9.5345"> </span>
<a href="#l9.5346"></a><span id="l9.5346" class="difflineminus">-nsresult nsNNTPProtocol::SendListGroupResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l9.5347"></a><span id="l9.5347" class="difflineminus">-{</span>
<a href="#l9.5348"></a><span id="l9.5348" class="difflineplus">+nsresult nsNNTPProtocol::SendListGroupResponse(nsIInputStream *inputStream,</span>
<a href="#l9.5349"></a><span id="l9.5349" class="difflineplus">+                                               uint32_t length) {</span>
<a href="#l9.5350"></a><span id="l9.5350">   uint32_t status = 0;</span>
<a href="#l9.5351"></a><span id="l9.5351"> </span>
<a href="#l9.5352"></a><span id="l9.5352" class="difflineminus">-  NS_ASSERTION(m_responseCode == MK_NNTP_RESPONSE_GROUP_SELECTED, &quot;code != GROUP_SELECTED&quot;);</span>
<a href="#l9.5353"></a><span id="l9.5353" class="difflineminus">-  if (m_responseCode != MK_NNTP_RESPONSE_GROUP_SELECTED)</span>
<a href="#l9.5354"></a><span id="l9.5354" class="difflineminus">-  {</span>
<a href="#l9.5355"></a><span id="l9.5355" class="difflineplus">+  NS_ASSERTION(m_responseCode == MK_NNTP_RESPONSE_GROUP_SELECTED,</span>
<a href="#l9.5356"></a><span id="l9.5356" class="difflineplus">+               &quot;code != GROUP_SELECTED&quot;);</span>
<a href="#l9.5357"></a><span id="l9.5357" class="difflineplus">+  if (m_responseCode != MK_NNTP_RESPONSE_GROUP_SELECTED) {</span>
<a href="#l9.5358"></a><span id="l9.5358">     m_nextState = NEWS_DONE;</span>
<a href="#l9.5359"></a><span id="l9.5359">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5360"></a><span id="l9.5360">     return NS_OK;</span>
<a href="#l9.5361"></a><span id="l9.5361">   }</span>
<a href="#l9.5362"></a><span id="l9.5362"> </span>
<a href="#l9.5363"></a><span id="l9.5363">   bool pauseForMoreData = false;</span>
<a href="#l9.5364"></a><span id="l9.5364" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.5365"></a><span id="l9.5365" class="difflineminus">-</span>
<a href="#l9.5366"></a><span id="l9.5366" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.5367"></a><span id="l9.5367" class="difflineminus">-  {</span>
<a href="#l9.5368"></a><span id="l9.5368" class="difflineplus">+  char *line =</span>
<a href="#l9.5369"></a><span id="l9.5369" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l9.5370"></a><span id="l9.5370" class="difflineplus">+</span>
<a href="#l9.5371"></a><span id="l9.5371" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.5372"></a><span id="l9.5372">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5373"></a><span id="l9.5373">     return NS_OK;</span>
<a href="#l9.5374"></a><span id="l9.5374">   }</span>
<a href="#l9.5375"></a><span id="l9.5375"> </span>
<a href="#l9.5376"></a><span id="l9.5376" class="difflineminus">-  if (line)</span>
<a href="#l9.5377"></a><span id="l9.5377" class="difflineminus">-  {</span>
<a href="#l9.5378"></a><span id="l9.5378" class="difflineplus">+  if (line) {</span>
<a href="#l9.5379"></a><span id="l9.5379">     mozilla::DebugOnly&lt;nsresult&gt; rv;</span>
<a href="#l9.5380"></a><span id="l9.5380" class="difflineminus">-    if (line[0] != '.')</span>
<a href="#l9.5381"></a><span id="l9.5381" class="difflineminus">-    {</span>
<a href="#l9.5382"></a><span id="l9.5382" class="difflineplus">+    if (line[0] != '.') {</span>
<a href="#l9.5383"></a><span id="l9.5383">       nsMsgKey found_id = nsMsgKey_None;</span>
<a href="#l9.5384"></a><span id="l9.5384">       PR_sscanf(line, &quot;%ld&quot;, &amp;found_id);</span>
<a href="#l9.5385"></a><span id="l9.5385">       rv = m_articleList-&gt;AddArticleKey(found_id);</span>
<a href="#l9.5386"></a><span id="l9.5386">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;add article key failed&quot;);</span>
<a href="#l9.5387"></a><span id="l9.5387" class="difflineminus">-    }</span>
<a href="#l9.5388"></a><span id="l9.5388" class="difflineminus">-    else</span>
<a href="#l9.5389"></a><span id="l9.5389" class="difflineminus">-    {</span>
<a href="#l9.5390"></a><span id="l9.5390" class="difflineplus">+    } else {</span>
<a href="#l9.5391"></a><span id="l9.5391">       rv = m_articleList-&gt;FinishAddingArticleKeys();</span>
<a href="#l9.5392"></a><span id="l9.5392">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;finish adding article key failed&quot;);</span>
<a href="#l9.5393"></a><span id="l9.5393">       m_articleList = nullptr;</span>
<a href="#l9.5394"></a><span id="l9.5394" class="difflineminus">-      m_nextState = NEWS_DONE;   /* ### dmb - don't really know */</span>
<a href="#l9.5395"></a><span id="l9.5395" class="difflineplus">+      m_nextState = NEWS_DONE; /* ### dmb - don't really know */</span>
<a href="#l9.5396"></a><span id="l9.5396">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5397"></a><span id="l9.5397">       PR_FREEIF(line);</span>
<a href="#l9.5398"></a><span id="l9.5398">       return NS_OK;</span>
<a href="#l9.5399"></a><span id="l9.5399">     }</span>
<a href="#l9.5400"></a><span id="l9.5400">   }</span>
<a href="#l9.5401"></a><span id="l9.5401">   PR_FREEIF(line);</span>
<a href="#l9.5402"></a><span id="l9.5402">   return NS_OK;</span>
<a href="#l9.5403"></a><span id="l9.5403"> }</span>
<a href="#l9.5404"></a><span id="l9.5404"> </span>
<a href="#l9.5405"></a><span id="l9.5405" class="difflineminus">-</span>
<a href="#l9.5406"></a><span id="l9.5406" class="difflineminus">-nsresult nsNNTPProtocol::Search()</span>
<a href="#l9.5407"></a><span id="l9.5407" class="difflineminus">-{</span>
<a href="#l9.5408"></a><span id="l9.5408" class="difflineplus">+nsresult nsNNTPProtocol::Search() {</span>
<a href="#l9.5409"></a><span id="l9.5409">   NS_ERROR(&quot;Search not implemented&quot;);</span>
<a href="#l9.5410"></a><span id="l9.5410">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.5411"></a><span id="l9.5411"> }</span>
<a href="#l9.5412"></a><span id="l9.5412"> </span>
<a href="#l9.5413"></a><span id="l9.5413" class="difflineminus">-nsresult nsNNTPProtocol::SearchResponse()</span>
<a href="#l9.5414"></a><span id="l9.5414" class="difflineminus">-{</span>
<a href="#l9.5415"></a><span id="l9.5415" class="difflineplus">+nsresult nsNNTPProtocol::SearchResponse() {</span>
<a href="#l9.5416"></a><span id="l9.5416">   if (MK_NNTP_RESPONSE_TYPE(m_responseCode) == MK_NNTP_RESPONSE_TYPE_OK)</span>
<a href="#l9.5417"></a><span id="l9.5417">     m_nextState = NNTP_SEARCH_RESULTS;</span>
<a href="#l9.5418"></a><span id="l9.5418">   else</span>
<a href="#l9.5419"></a><span id="l9.5419">     m_nextState = NEWS_DONE;</span>
<a href="#l9.5420"></a><span id="l9.5420">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5421"></a><span id="l9.5421">   return NS_OK;</span>
<a href="#l9.5422"></a><span id="l9.5422"> }</span>
<a href="#l9.5423"></a><span id="l9.5423"> </span>
<a href="#l9.5424"></a><span id="l9.5424" class="difflineminus">-nsresult nsNNTPProtocol::SearchResults(nsIInputStream *inputStream, uint32_t length)</span>
<a href="#l9.5425"></a><span id="l9.5425" class="difflineminus">-{</span>
<a href="#l9.5426"></a><span id="l9.5426" class="difflineplus">+nsresult nsNNTPProtocol::SearchResults(nsIInputStream *inputStream,</span>
<a href="#l9.5427"></a><span id="l9.5427" class="difflineplus">+                                       uint32_t length) {</span>
<a href="#l9.5428"></a><span id="l9.5428">   uint32_t status = 1;</span>
<a href="#l9.5429"></a><span id="l9.5429">   nsresult rv;</span>
<a href="#l9.5430"></a><span id="l9.5430"> </span>
<a href="#l9.5431"></a><span id="l9.5431">   bool pauseForMoreData = false;</span>
<a href="#l9.5432"></a><span id="l9.5432" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l9.5433"></a><span id="l9.5433" class="difflineminus">-</span>
<a href="#l9.5434"></a><span id="l9.5434" class="difflineminus">-  if(pauseForMoreData)</span>
<a href="#l9.5435"></a><span id="l9.5435" class="difflineminus">-  {</span>
<a href="#l9.5436"></a><span id="l9.5436" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l9.5437"></a><span id="l9.5437" class="difflineplus">+                                                pauseForMoreData, &amp;rv);</span>
<a href="#l9.5438"></a><span id="l9.5438" class="difflineplus">+</span>
<a href="#l9.5439"></a><span id="l9.5439" class="difflineplus">+  if (pauseForMoreData) {</span>
<a href="#l9.5440"></a><span id="l9.5440">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5441"></a><span id="l9.5441">     return NS_OK;</span>
<a href="#l9.5442"></a><span id="l9.5442">   }</span>
<a href="#l9.5443"></a><span id="l9.5443" class="difflineminus">-  if (!line)</span>
<a href="#l9.5444"></a><span id="l9.5444" class="difflineminus">-    return rv;  /* no line yet */</span>
<a href="#l9.5445"></a><span id="l9.5445" class="difflineminus">-</span>
<a href="#l9.5446"></a><span id="l9.5446" class="difflineminus">-  if ('.' == line[0])</span>
<a href="#l9.5447"></a><span id="l9.5447" class="difflineminus">-  {</span>
<a href="#l9.5448"></a><span id="l9.5448" class="difflineplus">+  if (!line) return rv; /* no line yet */</span>
<a href="#l9.5449"></a><span id="l9.5449" class="difflineplus">+</span>
<a href="#l9.5450"></a><span id="l9.5450" class="difflineplus">+  if ('.' == line[0]) {</span>
<a href="#l9.5451"></a><span id="l9.5451">     /* all overview lines received */</span>
<a href="#l9.5452"></a><span id="l9.5452">     m_nextState = NEWS_DONE;</span>
<a href="#l9.5453"></a><span id="l9.5453">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5454"></a><span id="l9.5454">   }</span>
<a href="#l9.5455"></a><span id="l9.5455">   PR_FREEIF(line);</span>
<a href="#l9.5456"></a><span id="l9.5456">   return rv;</span>
<a href="#l9.5457"></a><span id="l9.5457"> }</span>
<a href="#l9.5458"></a><span id="l9.5458"> </span>
<a href="#l9.5459"></a><span id="l9.5459" class="difflineminus">-/* Sets state for the transfer. This used to be known as net_setup_news_stream */</span>
<a href="#l9.5460"></a><span id="l9.5460" class="difflineminus">-nsresult nsNNTPProtocol::SetupForTransfer()</span>
<a href="#l9.5461"></a><span id="l9.5461" class="difflineminus">-{</span>
<a href="#l9.5462"></a><span id="l9.5462" class="difflineminus">-  if (m_typeWanted == NEWS_POST)</span>
<a href="#l9.5463"></a><span id="l9.5463" class="difflineminus">-  {</span>
<a href="#l9.5464"></a><span id="l9.5464" class="difflineplus">+/* Sets state for the transfer. This used to be known as net_setup_news_stream</span>
<a href="#l9.5465"></a><span id="l9.5465" class="difflineplus">+ */</span>
<a href="#l9.5466"></a><span id="l9.5466" class="difflineplus">+nsresult nsNNTPProtocol::SetupForTransfer() {</span>
<a href="#l9.5467"></a><span id="l9.5467" class="difflineplus">+  if (m_typeWanted == NEWS_POST) {</span>
<a href="#l9.5468"></a><span id="l9.5468">     m_nextState = NNTP_SEND_POST_DATA;</span>
<a href="#l9.5469"></a><span id="l9.5469" class="difflineminus">-  }</span>
<a href="#l9.5470"></a><span id="l9.5470" class="difflineminus">-  else if(m_typeWanted == LIST_WANTED)</span>
<a href="#l9.5471"></a><span id="l9.5471" class="difflineminus">-  {</span>
<a href="#l9.5472"></a><span id="l9.5472" class="difflineplus">+  } else if (m_typeWanted == LIST_WANTED) {</span>
<a href="#l9.5473"></a><span id="l9.5473">     if (TestFlag(NNTP_USE_FANCY_NEWSGROUP))</span>
<a href="#l9.5474"></a><span id="l9.5474">       m_nextState = NNTP_LIST_XACTIVE_RESPONSE;</span>
<a href="#l9.5475"></a><span id="l9.5475">     else</span>
<a href="#l9.5476"></a><span id="l9.5476">       m_nextState = NNTP_READ_LIST_BEGIN;</span>
<a href="#l9.5477"></a><span id="l9.5477" class="difflineminus">-  }</span>
<a href="#l9.5478"></a><span id="l9.5478" class="difflineminus">-  else if(m_typeWanted == GROUP_WANTED)</span>
<a href="#l9.5479"></a><span id="l9.5479" class="difflineplus">+  } else if (m_typeWanted == GROUP_WANTED)</span>
<a href="#l9.5480"></a><span id="l9.5480">     m_nextState = NNTP_XOVER_BEGIN;</span>
<a href="#l9.5481"></a><span id="l9.5481" class="difflineminus">-  else if(m_typeWanted == NEW_GROUPS)</span>
<a href="#l9.5482"></a><span id="l9.5482" class="difflineplus">+  else if (m_typeWanted == NEW_GROUPS)</span>
<a href="#l9.5483"></a><span id="l9.5483">     m_nextState = NNTP_NEWGROUPS_BEGIN;</span>
<a href="#l9.5484"></a><span id="l9.5484" class="difflineminus">-  else if(m_typeWanted == ARTICLE_WANTED ||</span>
<a href="#l9.5485"></a><span id="l9.5485" class="difflineminus">-    m_typeWanted== CANCEL_WANTED)</span>
<a href="#l9.5486"></a><span id="l9.5486" class="difflineplus">+  else if (m_typeWanted == ARTICLE_WANTED || m_typeWanted == CANCEL_WANTED)</span>
<a href="#l9.5487"></a><span id="l9.5487">     m_nextState = NNTP_BEGIN_ARTICLE;</span>
<a href="#l9.5488"></a><span id="l9.5488" class="difflineminus">-  else if (m_typeWanted== SEARCH_WANTED)</span>
<a href="#l9.5489"></a><span id="l9.5489" class="difflineplus">+  else if (m_typeWanted == SEARCH_WANTED)</span>
<a href="#l9.5490"></a><span id="l9.5490">     m_nextState = NNTP_XPAT_SEND;</span>
<a href="#l9.5491"></a><span id="l9.5491" class="difflineminus">-  else</span>
<a href="#l9.5492"></a><span id="l9.5492" class="difflineminus">-  {</span>
<a href="#l9.5493"></a><span id="l9.5493" class="difflineplus">+  else {</span>
<a href="#l9.5494"></a><span id="l9.5494">     NS_ERROR(&quot;unexpected&quot;);</span>
<a href="#l9.5495"></a><span id="l9.5495">     return NS_ERROR_FAILURE;</span>
<a href="#l9.5496"></a><span id="l9.5496">   }</span>
<a href="#l9.5497"></a><span id="l9.5497"> </span>
<a href="#l9.5498"></a><span id="l9.5498">   return NS_OK;</span>
<a href="#l9.5499"></a><span id="l9.5499"> }</span>
<a href="#l9.5500"></a><span id="l9.5500"> </span>
<a href="#l9.5501"></a><span id="l9.5501"> /////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.5502"></a><span id="l9.5502"> // The following method is used for processing the news state machine.</span>
<a href="#l9.5503"></a><span id="l9.5503" class="difflineminus">-// It returns a negative number (mscott: we'll change this to be an enumerated type which we'll coordinate</span>
<a href="#l9.5504"></a><span id="l9.5504" class="difflineminus">-// with the netlib folks?) when we are done processing.</span>
<a href="#l9.5505"></a><span id="l9.5505" class="difflineplus">+// It returns a negative number (mscott: we'll change this to be an enumerated</span>
<a href="#l9.5506"></a><span id="l9.5506" class="difflineplus">+// type which we'll coordinate with the netlib folks?) when we are done</span>
<a href="#l9.5507"></a><span id="l9.5507" class="difflineplus">+// processing.</span>
<a href="#l9.5508"></a><span id="l9.5508"> //////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.5509"></a><span id="l9.5509" class="difflineminus">-nsresult nsNNTPProtocol::ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l9.5510"></a><span id="l9.5510" class="difflineminus">-                                              uint64_t sourceOffset, uint32_t length)</span>
<a href="#l9.5511"></a><span id="l9.5511" class="difflineminus">-{</span>
<a href="#l9.5512"></a><span id="l9.5512" class="difflineplus">+nsresult nsNNTPProtocol::ProcessProtocolState(nsIURI *url,</span>
<a href="#l9.5513"></a><span id="l9.5513" class="difflineplus">+                                              nsIInputStream *inputStream,</span>
<a href="#l9.5514"></a><span id="l9.5514" class="difflineplus">+                                              uint64_t sourceOffset,</span>
<a href="#l9.5515"></a><span id="l9.5515" class="difflineplus">+                                              uint32_t length) {</span>
<a href="#l9.5516"></a><span id="l9.5516">   nsresult status = NS_OK;</span>
<a href="#l9.5517"></a><span id="l9.5517">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.5518"></a><span id="l9.5518" class="difflineminus">-  if (inputStream &amp;&amp; (!mailnewsurl || !m_nntpServer))</span>
<a href="#l9.5519"></a><span id="l9.5519" class="difflineminus">-  {</span>
<a href="#l9.5520"></a><span id="l9.5520" class="difflineplus">+  if (inputStream &amp;&amp; (!mailnewsurl || !m_nntpServer)) {</span>
<a href="#l9.5521"></a><span id="l9.5521">     // In these cases, we are going to return since our data is effectively</span>
<a href="#l9.5522"></a><span id="l9.5522">     // invalid. However, nsInputStream would really rather that we at least read</span>
<a href="#l9.5523"></a><span id="l9.5523">     // some of our input data (even if not all of it). Therefore, we'll read a</span>
<a href="#l9.5524"></a><span id="l9.5524">     // little bit.</span>
<a href="#l9.5525"></a><span id="l9.5525">     char buffer[128];</span>
<a href="#l9.5526"></a><span id="l9.5526">     uint32_t readData = 0;</span>
<a href="#l9.5527"></a><span id="l9.5527">     inputStream-&gt;Read(buffer, 127, &amp;readData);</span>
<a href="#l9.5528"></a><span id="l9.5528">     buffer[readData] = '\0';</span>
<a href="#l9.5529"></a><span id="l9.5529">     MOZ_LOG(NNTP, LogLevel::Debug, (&quot;(%p) Ignoring data: %s&quot;, this, buffer));</span>
<a href="#l9.5530"></a><span id="l9.5530">   }</span>
<a href="#l9.5531"></a><span id="l9.5531"> </span>
<a href="#l9.5532"></a><span id="l9.5532" class="difflineminus">-  if (!mailnewsurl)</span>
<a href="#l9.5533"></a><span id="l9.5533" class="difflineminus">-    return NS_OK; // probably no data available - it's OK.</span>
<a href="#l9.5534"></a><span id="l9.5534" class="difflineminus">-</span>
<a href="#l9.5535"></a><span id="l9.5535" class="difflineminus">-  if (!m_nntpServer)</span>
<a href="#l9.5536"></a><span id="l9.5536" class="difflineminus">-  {</span>
<a href="#l9.5537"></a><span id="l9.5537" class="difflineplus">+  if (!mailnewsurl) return NS_OK;  // probably no data available - it's OK.</span>
<a href="#l9.5538"></a><span id="l9.5538" class="difflineplus">+</span>
<a href="#l9.5539"></a><span id="l9.5539" class="difflineplus">+  if (!m_nntpServer) {</span>
<a href="#l9.5540"></a><span id="l9.5540">     // Parsing must result in our m_nntpServer being set, so we should never</span>
<a href="#l9.5541"></a><span id="l9.5541">     // have a case where m_nntpServer being false is safe. Most likely, we have</span>
<a href="#l9.5542"></a><span id="l9.5542">     // already closed our socket and we are merely flushing out the socket</span>
<a href="#l9.5543"></a><span id="l9.5543">     // receive queue. Since the user told us to stop, don't process any more</span>
<a href="#l9.5544"></a><span id="l9.5544">     // input.</span>
<a href="#l9.5545"></a><span id="l9.5545">     return inputStream ? inputStream-&gt;Close() : NS_OK;</span>
<a href="#l9.5546"></a><span id="l9.5546">   }</span>
<a href="#l9.5547"></a><span id="l9.5547"> </span>
<a href="#l9.5548"></a><span id="l9.5548">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5549"></a><span id="l9.5549"> </span>
<a href="#l9.5550"></a><span id="l9.5550" class="difflineminus">-  while(!TestFlag(NNTP_PAUSE_FOR_READ))</span>
<a href="#l9.5551"></a><span id="l9.5551" class="difflineminus">-  {</span>
<a href="#l9.5552"></a><span id="l9.5552" class="difflineminus">-    MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) Next state: %s&quot;,this, stateLabels[m_nextState]));</span>
<a href="#l9.5553"></a><span id="l9.5553" class="difflineminus">-    // examine our current state and call an appropriate handler for that state.....</span>
<a href="#l9.5554"></a><span id="l9.5554" class="difflineminus">-    switch(m_nextState)</span>
<a href="#l9.5555"></a><span id="l9.5555" class="difflineminus">-    {</span>
<a href="#l9.5556"></a><span id="l9.5556" class="difflineminus">-    case NNTP_RESPONSE:</span>
<a href="#l9.5557"></a><span id="l9.5557" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5558"></a><span id="l9.5558" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5559"></a><span id="l9.5559" class="difflineminus">-      else</span>
<a href="#l9.5560"></a><span id="l9.5560" class="difflineminus">-        status = NewsResponse(inputStream, length);</span>
<a href="#l9.5561"></a><span id="l9.5561" class="difflineminus">-      break;</span>
<a href="#l9.5562"></a><span id="l9.5562" class="difflineminus">-</span>
<a href="#l9.5563"></a><span id="l9.5563" class="difflineminus">-      // mscott: I've removed the states involving connections on the assumption</span>
<a href="#l9.5564"></a><span id="l9.5564" class="difflineminus">-      // that core netlib will now be managing that information.</span>
<a href="#l9.5565"></a><span id="l9.5565" class="difflineminus">-</span>
<a href="#l9.5566"></a><span id="l9.5566" class="difflineminus">-    case NNTP_LOGIN_RESPONSE:</span>
<a href="#l9.5567"></a><span id="l9.5567" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5568"></a><span id="l9.5568" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5569"></a><span id="l9.5569" class="difflineminus">-      else</span>
<a href="#l9.5570"></a><span id="l9.5570" class="difflineminus">-        status = LoginResponse();</span>
<a href="#l9.5571"></a><span id="l9.5571" class="difflineminus">-      break;</span>
<a href="#l9.5572"></a><span id="l9.5572" class="difflineminus">-</span>
<a href="#l9.5573"></a><span id="l9.5573" class="difflineminus">-    case NNTP_SEND_MODE_READER:</span>
<a href="#l9.5574"></a><span id="l9.5574" class="difflineminus">-      status = SendModeReader();</span>
<a href="#l9.5575"></a><span id="l9.5575" class="difflineminus">-      break;</span>
<a href="#l9.5576"></a><span id="l9.5576" class="difflineminus">-</span>
<a href="#l9.5577"></a><span id="l9.5577" class="difflineminus">-    case NNTP_SEND_MODE_READER_RESPONSE:</span>
<a href="#l9.5578"></a><span id="l9.5578" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5579"></a><span id="l9.5579" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5580"></a><span id="l9.5580" class="difflineminus">-      else</span>
<a href="#l9.5581"></a><span id="l9.5581" class="difflineminus">-        status = SendModeReaderResponse();</span>
<a href="#l9.5582"></a><span id="l9.5582" class="difflineminus">-      break;</span>
<a href="#l9.5583"></a><span id="l9.5583" class="difflineminus">-</span>
<a href="#l9.5584"></a><span id="l9.5584" class="difflineminus">-    case SEND_LIST_EXTENSIONS:</span>
<a href="#l9.5585"></a><span id="l9.5585" class="difflineminus">-      status = SendListExtensions();</span>
<a href="#l9.5586"></a><span id="l9.5586" class="difflineminus">-      break;</span>
<a href="#l9.5587"></a><span id="l9.5587" class="difflineminus">-    case SEND_LIST_EXTENSIONS_RESPONSE:</span>
<a href="#l9.5588"></a><span id="l9.5588" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5589"></a><span id="l9.5589" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5590"></a><span id="l9.5590" class="difflineminus">-      else</span>
<a href="#l9.5591"></a><span id="l9.5591" class="difflineminus">-        status = SendListExtensionsResponse(inputStream, length);</span>
<a href="#l9.5592"></a><span id="l9.5592" class="difflineminus">-      break;</span>
<a href="#l9.5593"></a><span id="l9.5593" class="difflineminus">-    case SEND_LIST_SEARCHES:</span>
<a href="#l9.5594"></a><span id="l9.5594" class="difflineminus">-      status = SendListSearches();</span>
<a href="#l9.5595"></a><span id="l9.5595" class="difflineminus">-      break;</span>
<a href="#l9.5596"></a><span id="l9.5596" class="difflineminus">-    case SEND_LIST_SEARCHES_RESPONSE:</span>
<a href="#l9.5597"></a><span id="l9.5597" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5598"></a><span id="l9.5598" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5599"></a><span id="l9.5599" class="difflineminus">-      else</span>
<a href="#l9.5600"></a><span id="l9.5600" class="difflineminus">-        status = SendListSearchesResponse(inputStream, length);</span>
<a href="#l9.5601"></a><span id="l9.5601" class="difflineminus">-      break;</span>
<a href="#l9.5602"></a><span id="l9.5602" class="difflineminus">-    case NNTP_LIST_SEARCH_HEADERS:</span>
<a href="#l9.5603"></a><span id="l9.5603" class="difflineminus">-      status = SendListSearchHeaders();</span>
<a href="#l9.5604"></a><span id="l9.5604" class="difflineminus">-      break;</span>
<a href="#l9.5605"></a><span id="l9.5605" class="difflineminus">-    case NNTP_LIST_SEARCH_HEADERS_RESPONSE:</span>
<a href="#l9.5606"></a><span id="l9.5606" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5607"></a><span id="l9.5607" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5608"></a><span id="l9.5608" class="difflineminus">-      else</span>
<a href="#l9.5609"></a><span id="l9.5609" class="difflineminus">-        status = SendListSearchHeadersResponse(inputStream, length);</span>
<a href="#l9.5610"></a><span id="l9.5610" class="difflineminus">-      break;</span>
<a href="#l9.5611"></a><span id="l9.5611" class="difflineminus">-    case NNTP_GET_PROPERTIES:</span>
<a href="#l9.5612"></a><span id="l9.5612" class="difflineminus">-      status = GetProperties();</span>
<a href="#l9.5613"></a><span id="l9.5613" class="difflineminus">-      break;</span>
<a href="#l9.5614"></a><span id="l9.5614" class="difflineminus">-    case NNTP_GET_PROPERTIES_RESPONSE:</span>
<a href="#l9.5615"></a><span id="l9.5615" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5616"></a><span id="l9.5616" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5617"></a><span id="l9.5617" class="difflineminus">-      else</span>
<a href="#l9.5618"></a><span id="l9.5618" class="difflineminus">-        status = GetPropertiesResponse(inputStream, length);</span>
<a href="#l9.5619"></a><span id="l9.5619" class="difflineminus">-      break;</span>
<a href="#l9.5620"></a><span id="l9.5620" class="difflineminus">-    case SEND_LIST_SUBSCRIPTIONS:</span>
<a href="#l9.5621"></a><span id="l9.5621" class="difflineminus">-      status = SendListSubscriptions();</span>
<a href="#l9.5622"></a><span id="l9.5622" class="difflineminus">-      break;</span>
<a href="#l9.5623"></a><span id="l9.5623" class="difflineminus">-    case SEND_LIST_SUBSCRIPTIONS_RESPONSE:</span>
<a href="#l9.5624"></a><span id="l9.5624" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5625"></a><span id="l9.5625" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5626"></a><span id="l9.5626" class="difflineminus">-      else</span>
<a href="#l9.5627"></a><span id="l9.5627" class="difflineminus">-        status = SendListSubscriptionsResponse(inputStream, length);</span>
<a href="#l9.5628"></a><span id="l9.5628" class="difflineminus">-      break;</span>
<a href="#l9.5629"></a><span id="l9.5629" class="difflineminus">-</span>
<a href="#l9.5630"></a><span id="l9.5630" class="difflineminus">-    case SEND_FIRST_NNTP_COMMAND:</span>
<a href="#l9.5631"></a><span id="l9.5631" class="difflineminus">-      status = SendFirstNNTPCommand(url);</span>
<a href="#l9.5632"></a><span id="l9.5632" class="difflineminus">-      break;</span>
<a href="#l9.5633"></a><span id="l9.5633" class="difflineminus">-    case SEND_FIRST_NNTP_COMMAND_RESPONSE:</span>
<a href="#l9.5634"></a><span id="l9.5634" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5635"></a><span id="l9.5635" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5636"></a><span id="l9.5636" class="difflineminus">-      else</span>
<a href="#l9.5637"></a><span id="l9.5637" class="difflineminus">-        status = SendFirstNNTPCommandResponse();</span>
<a href="#l9.5638"></a><span id="l9.5638" class="difflineminus">-      break;</span>
<a href="#l9.5639"></a><span id="l9.5639" class="difflineminus">-</span>
<a href="#l9.5640"></a><span id="l9.5640" class="difflineminus">-    case NNTP_SEND_GROUP_FOR_ARTICLE:</span>
<a href="#l9.5641"></a><span id="l9.5641" class="difflineminus">-      status = SendGroupForArticle();</span>
<a href="#l9.5642"></a><span id="l9.5642" class="difflineminus">-      break;</span>
<a href="#l9.5643"></a><span id="l9.5643" class="difflineminus">-    case NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE:</span>
<a href="#l9.5644"></a><span id="l9.5644" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5645"></a><span id="l9.5645" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5646"></a><span id="l9.5646" class="difflineminus">-      else</span>
<a href="#l9.5647"></a><span id="l9.5647" class="difflineminus">-        status = SendGroupForArticleResponse();</span>
<a href="#l9.5648"></a><span id="l9.5648" class="difflineminus">-      break;</span>
<a href="#l9.5649"></a><span id="l9.5649" class="difflineminus">-    case NNTP_SEND_ARTICLE_NUMBER:</span>
<a href="#l9.5650"></a><span id="l9.5650" class="difflineminus">-      status = SendArticleNumber();</span>
<a href="#l9.5651"></a><span id="l9.5651" class="difflineminus">-      break;</span>
<a href="#l9.5652"></a><span id="l9.5652" class="difflineminus">-</span>
<a href="#l9.5653"></a><span id="l9.5653" class="difflineminus">-    case SETUP_NEWS_STREAM:</span>
<a href="#l9.5654"></a><span id="l9.5654" class="difflineminus">-      status = SetupForTransfer();</span>
<a href="#l9.5655"></a><span id="l9.5655" class="difflineminus">-      break;</span>
<a href="#l9.5656"></a><span id="l9.5656" class="difflineminus">-</span>
<a href="#l9.5657"></a><span id="l9.5657" class="difflineminus">-    case NNTP_BEGIN_AUTHORIZE:</span>
<a href="#l9.5658"></a><span id="l9.5658" class="difflineminus">-      status = BeginAuthorization();</span>
<a href="#l9.5659"></a><span id="l9.5659" class="difflineminus">-      break;</span>
<a href="#l9.5660"></a><span id="l9.5660" class="difflineminus">-</span>
<a href="#l9.5661"></a><span id="l9.5661" class="difflineminus">-    case NNTP_AUTHORIZE_RESPONSE:</span>
<a href="#l9.5662"></a><span id="l9.5662" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5663"></a><span id="l9.5663" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5664"></a><span id="l9.5664" class="difflineminus">-      else</span>
<a href="#l9.5665"></a><span id="l9.5665" class="difflineminus">-        status = AuthorizationResponse();</span>
<a href="#l9.5666"></a><span id="l9.5666" class="difflineminus">-      break;</span>
<a href="#l9.5667"></a><span id="l9.5667" class="difflineminus">-</span>
<a href="#l9.5668"></a><span id="l9.5668" class="difflineminus">-    case NNTP_PASSWORD_RESPONSE:</span>
<a href="#l9.5669"></a><span id="l9.5669" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5670"></a><span id="l9.5670" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5671"></a><span id="l9.5671" class="difflineminus">-      else</span>
<a href="#l9.5672"></a><span id="l9.5672" class="difflineminus">-        status = PasswordResponse();</span>
<a href="#l9.5673"></a><span id="l9.5673" class="difflineminus">-      break;</span>
<a href="#l9.5674"></a><span id="l9.5674" class="difflineminus">-</span>
<a href="#l9.5675"></a><span id="l9.5675" class="difflineminus">-      // read list</span>
<a href="#l9.5676"></a><span id="l9.5676" class="difflineminus">-    case NNTP_READ_LIST_BEGIN:</span>
<a href="#l9.5677"></a><span id="l9.5677" class="difflineminus">-      status = BeginReadNewsList();</span>
<a href="#l9.5678"></a><span id="l9.5678" class="difflineminus">-      break;</span>
<a href="#l9.5679"></a><span id="l9.5679" class="difflineminus">-    case NNTP_READ_LIST:</span>
<a href="#l9.5680"></a><span id="l9.5680" class="difflineminus">-      status = ReadNewsList(inputStream, length);</span>
<a href="#l9.5681"></a><span id="l9.5681" class="difflineminus">-      break;</span>
<a href="#l9.5682"></a><span id="l9.5682" class="difflineminus">-</span>
<a href="#l9.5683"></a><span id="l9.5683" class="difflineminus">-      // news group</span>
<a href="#l9.5684"></a><span id="l9.5684" class="difflineminus">-    case DISPLAY_NEWSGROUPS:</span>
<a href="#l9.5685"></a><span id="l9.5685" class="difflineminus">-      status = DisplayNewsgroups();</span>
<a href="#l9.5686"></a><span id="l9.5686" class="difflineminus">-      break;</span>
<a href="#l9.5687"></a><span id="l9.5687" class="difflineminus">-    case NNTP_NEWGROUPS_BEGIN:</span>
<a href="#l9.5688"></a><span id="l9.5688" class="difflineminus">-      status = BeginNewsgroups();</span>
<a href="#l9.5689"></a><span id="l9.5689" class="difflineminus">-      break;</span>
<a href="#l9.5690"></a><span id="l9.5690" class="difflineminus">-    case NNTP_NEWGROUPS:</span>
<a href="#l9.5691"></a><span id="l9.5691" class="difflineminus">-      status = ProcessNewsgroups(inputStream, length);</span>
<a href="#l9.5692"></a><span id="l9.5692" class="difflineminus">-      break;</span>
<a href="#l9.5693"></a><span id="l9.5693" class="difflineminus">-</span>
<a href="#l9.5694"></a><span id="l9.5694" class="difflineminus">-      // article specific</span>
<a href="#l9.5695"></a><span id="l9.5695" class="difflineminus">-    case NNTP_BEGIN_ARTICLE:</span>
<a href="#l9.5696"></a><span id="l9.5696" class="difflineminus">-      status = BeginArticle();</span>
<a href="#l9.5697"></a><span id="l9.5697" class="difflineminus">-      break;</span>
<a href="#l9.5698"></a><span id="l9.5698" class="difflineminus">-</span>
<a href="#l9.5699"></a><span id="l9.5699" class="difflineminus">-    case NNTP_READ_ARTICLE:</span>
<a href="#l9.5700"></a><span id="l9.5700" class="difflineminus">-      status = ReadArticle(inputStream, length);</span>
<a href="#l9.5701"></a><span id="l9.5701" class="difflineminus">-      break;</span>
<a href="#l9.5702"></a><span id="l9.5702" class="difflineminus">-</span>
<a href="#l9.5703"></a><span id="l9.5703" class="difflineminus">-    case NNTP_XOVER_BEGIN:</span>
<a href="#l9.5704"></a><span id="l9.5704" class="difflineminus">-      status = BeginReadXover();</span>
<a href="#l9.5705"></a><span id="l9.5705" class="difflineminus">-      break;</span>
<a href="#l9.5706"></a><span id="l9.5706" class="difflineminus">-</span>
<a href="#l9.5707"></a><span id="l9.5707" class="difflineminus">-    case NNTP_FIGURE_NEXT_CHUNK:</span>
<a href="#l9.5708"></a><span id="l9.5708" class="difflineminus">-      status = FigureNextChunk();</span>
<a href="#l9.5709"></a><span id="l9.5709" class="difflineminus">-      break;</span>
<a href="#l9.5710"></a><span id="l9.5710" class="difflineminus">-</span>
<a href="#l9.5711"></a><span id="l9.5711" class="difflineminus">-    case NNTP_XOVER_SEND:</span>
<a href="#l9.5712"></a><span id="l9.5712" class="difflineminus">-      status = XoverSend();</span>
<a href="#l9.5713"></a><span id="l9.5713" class="difflineminus">-      break;</span>
<a href="#l9.5714"></a><span id="l9.5714" class="difflineminus">-</span>
<a href="#l9.5715"></a><span id="l9.5715" class="difflineminus">-    case NNTP_XOVER:</span>
<a href="#l9.5716"></a><span id="l9.5716" class="difflineminus">-      status = ReadXover(inputStream, length);</span>
<a href="#l9.5717"></a><span id="l9.5717" class="difflineminus">-      break;</span>
<a href="#l9.5718"></a><span id="l9.5718" class="difflineminus">-</span>
<a href="#l9.5719"></a><span id="l9.5719" class="difflineminus">-    case NNTP_XOVER_RESPONSE:</span>
<a href="#l9.5720"></a><span id="l9.5720" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5721"></a><span id="l9.5721" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5722"></a><span id="l9.5722" class="difflineminus">-      else</span>
<a href="#l9.5723"></a><span id="l9.5723" class="difflineminus">-        status = ReadXoverResponse();</span>
<a href="#l9.5724"></a><span id="l9.5724" class="difflineminus">-      break;</span>
<a href="#l9.5725"></a><span id="l9.5725" class="difflineminus">-</span>
<a href="#l9.5726"></a><span id="l9.5726" class="difflineminus">-    case NEWS_PROCESS_XOVER:</span>
<a href="#l9.5727"></a><span id="l9.5727" class="difflineminus">-    case NEWS_PROCESS_BODIES:</span>
<a href="#l9.5728"></a><span id="l9.5728" class="difflineminus">-      status = ProcessXover();</span>
<a href="#l9.5729"></a><span id="l9.5729" class="difflineminus">-      break;</span>
<a href="#l9.5730"></a><span id="l9.5730" class="difflineminus">-</span>
<a href="#l9.5731"></a><span id="l9.5731" class="difflineminus">-    case NNTP_XHDR_SEND:</span>
<a href="#l9.5732"></a><span id="l9.5732" class="difflineminus">-      status = XhdrSend();</span>
<a href="#l9.5733"></a><span id="l9.5733" class="difflineminus">-      break;</span>
<a href="#l9.5734"></a><span id="l9.5734" class="difflineminus">-</span>
<a href="#l9.5735"></a><span id="l9.5735" class="difflineminus">-    case NNTP_XHDR_RESPONSE:</span>
<a href="#l9.5736"></a><span id="l9.5736" class="difflineminus">-      status = XhdrResponse(inputStream);</span>
<a href="#l9.5737"></a><span id="l9.5737" class="difflineminus">-      break;</span>
<a href="#l9.5738"></a><span id="l9.5738" class="difflineminus">-</span>
<a href="#l9.5739"></a><span id="l9.5739" class="difflineminus">-    case NNTP_READ_GROUP:</span>
<a href="#l9.5740"></a><span id="l9.5740" class="difflineminus">-      status = ReadHeaders();</span>
<a href="#l9.5741"></a><span id="l9.5741" class="difflineminus">-      break;</span>
<a href="#l9.5742"></a><span id="l9.5742" class="difflineminus">-</span>
<a href="#l9.5743"></a><span id="l9.5743" class="difflineminus">-    case NNTP_READ_GROUP_RESPONSE:</span>
<a href="#l9.5744"></a><span id="l9.5744" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5745"></a><span id="l9.5745" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5746"></a><span id="l9.5746" class="difflineminus">-      else</span>
<a href="#l9.5747"></a><span id="l9.5747" class="difflineminus">-        status = ReadNewsgroupResponse();</span>
<a href="#l9.5748"></a><span id="l9.5748" class="difflineminus">-      break;</span>
<a href="#l9.5749"></a><span id="l9.5749" class="difflineminus">-</span>
<a href="#l9.5750"></a><span id="l9.5750" class="difflineminus">-    case NNTP_READ_GROUP_BODY:</span>
<a href="#l9.5751"></a><span id="l9.5751" class="difflineminus">-      status = ReadNewsgroupBody(inputStream, length);</span>
<a href="#l9.5752"></a><span id="l9.5752" class="difflineminus">-      break;</span>
<a href="#l9.5753"></a><span id="l9.5753" class="difflineminus">-</span>
<a href="#l9.5754"></a><span id="l9.5754" class="difflineminus">-    case NNTP_SEND_POST_DATA:</span>
<a href="#l9.5755"></a><span id="l9.5755" class="difflineminus">-      status = PostData();</span>
<a href="#l9.5756"></a><span id="l9.5756" class="difflineminus">-      break;</span>
<a href="#l9.5757"></a><span id="l9.5757" class="difflineminus">-    case NNTP_SEND_POST_DATA_RESPONSE:</span>
<a href="#l9.5758"></a><span id="l9.5758" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5759"></a><span id="l9.5759" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5760"></a><span id="l9.5760" class="difflineminus">-      else</span>
<a href="#l9.5761"></a><span id="l9.5761" class="difflineminus">-        status = PostDataResponse();</span>
<a href="#l9.5762"></a><span id="l9.5762" class="difflineminus">-      break;</span>
<a href="#l9.5763"></a><span id="l9.5763" class="difflineminus">-</span>
<a href="#l9.5764"></a><span id="l9.5764" class="difflineminus">-    case NNTP_CHECK_FOR_MESSAGE:</span>
<a href="#l9.5765"></a><span id="l9.5765" class="difflineminus">-      status = CheckForArticle();</span>
<a href="#l9.5766"></a><span id="l9.5766" class="difflineminus">-      break;</span>
<a href="#l9.5767"></a><span id="l9.5767" class="difflineminus">-</span>
<a href="#l9.5768"></a><span id="l9.5768" class="difflineminus">-      // cancel</span>
<a href="#l9.5769"></a><span id="l9.5769" class="difflineminus">-    case NEWS_START_CANCEL:</span>
<a href="#l9.5770"></a><span id="l9.5770" class="difflineminus">-      status = StartCancel();</span>
<a href="#l9.5771"></a><span id="l9.5771" class="difflineminus">-      break;</span>
<a href="#l9.5772"></a><span id="l9.5772" class="difflineminus">-</span>
<a href="#l9.5773"></a><span id="l9.5773" class="difflineminus">-    case NEWS_DO_CANCEL:</span>
<a href="#l9.5774"></a><span id="l9.5774" class="difflineminus">-      status = DoCancel();</span>
<a href="#l9.5775"></a><span id="l9.5775" class="difflineminus">-      break;</span>
<a href="#l9.5776"></a><span id="l9.5776" class="difflineminus">-</span>
<a href="#l9.5777"></a><span id="l9.5777" class="difflineminus">-      // XPAT</span>
<a href="#l9.5778"></a><span id="l9.5778" class="difflineminus">-    case NNTP_XPAT_SEND:</span>
<a href="#l9.5779"></a><span id="l9.5779" class="difflineminus">-      status = XPATSend();</span>
<a href="#l9.5780"></a><span id="l9.5780" class="difflineminus">-      break;</span>
<a href="#l9.5781"></a><span id="l9.5781" class="difflineminus">-    case NNTP_XPAT_RESPONSE:</span>
<a href="#l9.5782"></a><span id="l9.5782" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5783"></a><span id="l9.5783" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5784"></a><span id="l9.5784" class="difflineminus">-      else</span>
<a href="#l9.5785"></a><span id="l9.5785" class="difflineminus">-        status = XPATResponse(inputStream, length);</span>
<a href="#l9.5786"></a><span id="l9.5786" class="difflineminus">-      break;</span>
<a href="#l9.5787"></a><span id="l9.5787" class="difflineminus">-</span>
<a href="#l9.5788"></a><span id="l9.5788" class="difflineminus">-      // search</span>
<a href="#l9.5789"></a><span id="l9.5789" class="difflineminus">-    case NNTP_SEARCH:</span>
<a href="#l9.5790"></a><span id="l9.5790" class="difflineminus">-      status = Search();</span>
<a href="#l9.5791"></a><span id="l9.5791" class="difflineminus">-      break;</span>
<a href="#l9.5792"></a><span id="l9.5792" class="difflineminus">-    case NNTP_SEARCH_RESPONSE:</span>
<a href="#l9.5793"></a><span id="l9.5793" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5794"></a><span id="l9.5794" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5795"></a><span id="l9.5795" class="difflineminus">-      else</span>
<a href="#l9.5796"></a><span id="l9.5796" class="difflineminus">-        status = SearchResponse();</span>
<a href="#l9.5797"></a><span id="l9.5797" class="difflineminus">-      break;</span>
<a href="#l9.5798"></a><span id="l9.5798" class="difflineminus">-    case NNTP_SEARCH_RESULTS:</span>
<a href="#l9.5799"></a><span id="l9.5799" class="difflineminus">-      status = SearchResults(inputStream, length);</span>
<a href="#l9.5800"></a><span id="l9.5800" class="difflineminus">-      break;</span>
<a href="#l9.5801"></a><span id="l9.5801" class="difflineminus">-</span>
<a href="#l9.5802"></a><span id="l9.5802" class="difflineminus">-</span>
<a href="#l9.5803"></a><span id="l9.5803" class="difflineminus">-    case NNTP_LIST_PRETTY_NAMES:</span>
<a href="#l9.5804"></a><span id="l9.5804" class="difflineminus">-      status = ListPrettyNames();</span>
<a href="#l9.5805"></a><span id="l9.5805" class="difflineminus">-      break;</span>
<a href="#l9.5806"></a><span id="l9.5806" class="difflineminus">-    case NNTP_LIST_PRETTY_NAMES_RESPONSE:</span>
<a href="#l9.5807"></a><span id="l9.5807" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5808"></a><span id="l9.5808" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5809"></a><span id="l9.5809" class="difflineminus">-      else</span>
<a href="#l9.5810"></a><span id="l9.5810" class="difflineminus">-        status = ListPrettyNamesResponse(inputStream, length);</span>
<a href="#l9.5811"></a><span id="l9.5811" class="difflineminus">-      break;</span>
<a href="#l9.5812"></a><span id="l9.5812" class="difflineminus">-    case NNTP_LIST_XACTIVE:</span>
<a href="#l9.5813"></a><span id="l9.5813" class="difflineminus">-      status = ListXActive();</span>
<a href="#l9.5814"></a><span id="l9.5814" class="difflineminus">-      break;</span>
<a href="#l9.5815"></a><span id="l9.5815" class="difflineminus">-    case NNTP_LIST_XACTIVE_RESPONSE:</span>
<a href="#l9.5816"></a><span id="l9.5816" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5817"></a><span id="l9.5817" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5818"></a><span id="l9.5818" class="difflineminus">-      else</span>
<a href="#l9.5819"></a><span id="l9.5819" class="difflineminus">-        status = ListXActiveResponse(inputStream, length);</span>
<a href="#l9.5820"></a><span id="l9.5820" class="difflineminus">-      break;</span>
<a href="#l9.5821"></a><span id="l9.5821" class="difflineminus">-    case NNTP_LIST_GROUP:</span>
<a href="#l9.5822"></a><span id="l9.5822" class="difflineminus">-      status = SendListGroup();</span>
<a href="#l9.5823"></a><span id="l9.5823" class="difflineminus">-      break;</span>
<a href="#l9.5824"></a><span id="l9.5824" class="difflineminus">-    case NNTP_LIST_GROUP_RESPONSE:</span>
<a href="#l9.5825"></a><span id="l9.5825" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l9.5826"></a><span id="l9.5826" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5827"></a><span id="l9.5827" class="difflineminus">-      else</span>
<a href="#l9.5828"></a><span id="l9.5828" class="difflineminus">-        status = SendListGroupResponse(inputStream, length);</span>
<a href="#l9.5829"></a><span id="l9.5829" class="difflineminus">-      break;</span>
<a href="#l9.5830"></a><span id="l9.5830" class="difflineminus">-    case NEWS_DONE:</span>
<a href="#l9.5831"></a><span id="l9.5831" class="difflineminus">-      m_nextState = NEWS_FREE;</span>
<a href="#l9.5832"></a><span id="l9.5832" class="difflineminus">-      break;</span>
<a href="#l9.5833"></a><span id="l9.5833" class="difflineminus">-    case NEWS_POST_DONE:</span>
<a href="#l9.5834"></a><span id="l9.5834" class="difflineminus">-      NNTP_LOG_NOTE(&quot;NEWS_POST_DONE&quot;);</span>
<a href="#l9.5835"></a><span id="l9.5835" class="difflineminus">-      mailnewsurl-&gt;SetUrlState(false, NS_OK);</span>
<a href="#l9.5836"></a><span id="l9.5836" class="difflineminus">-      m_nextState = NEWS_FREE;</span>
<a href="#l9.5837"></a><span id="l9.5837" class="difflineminus">-      break;</span>
<a href="#l9.5838"></a><span id="l9.5838" class="difflineminus">-    case NEWS_ERROR:</span>
<a href="#l9.5839"></a><span id="l9.5839" class="difflineminus">-      NNTP_LOG_NOTE(&quot;NEWS_ERROR&quot;);</span>
<a href="#l9.5840"></a><span id="l9.5840" class="difflineminus">-      if (m_responseCode == MK_NNTP_RESPONSE_ARTICLE_NOTFOUND || m_responseCode == MK_NNTP_RESPONSE_ARTICLE_NONEXIST)</span>
<a href="#l9.5841"></a><span id="l9.5841" class="difflineminus">-        mailnewsurl-&gt;SetUrlState(false, NS_MSG_NEWS_ARTICLE_NOT_FOUND);</span>
<a href="#l9.5842"></a><span id="l9.5842" class="difflineminus">-      else</span>
<a href="#l9.5843"></a><span id="l9.5843" class="difflineminus">-        mailnewsurl-&gt;SetUrlState(false, NS_ERROR_FAILURE);</span>
<a href="#l9.5844"></a><span id="l9.5844" class="difflineminus">-      m_nextState = NEWS_FREE;</span>
<a href="#l9.5845"></a><span id="l9.5845" class="difflineminus">-      break;</span>
<a href="#l9.5846"></a><span id="l9.5846" class="difflineminus">-    case NNTP_ERROR:</span>
<a href="#l9.5847"></a><span id="l9.5847" class="difflineminus">-      // XXX do we really want to remove the connection from</span>
<a href="#l9.5848"></a><span id="l9.5848" class="difflineminus">-      // the cache on error?</span>
<a href="#l9.5849"></a><span id="l9.5849" class="difflineminus">-      /* check if this connection came from the cache or if it was</span>
<a href="#l9.5850"></a><span id="l9.5850" class="difflineminus">-      * a new connection.  If it was not new lets start it over</span>
<a href="#l9.5851"></a><span id="l9.5851" class="difflineminus">-      * again.  But only if we didn't have any successful protocol</span>
<a href="#l9.5852"></a><span id="l9.5852" class="difflineminus">-      * dialog at all.</span>
<a href="#l9.5853"></a><span id="l9.5853" class="difflineminus">-      */</span>
<a href="#l9.5854"></a><span id="l9.5854" class="difflineminus">-      FinishMemCacheEntry(false);  // cleanup mem cache entry</span>
<a href="#l9.5855"></a><span id="l9.5855" class="difflineminus">-      if (m_responseCode != MK_NNTP_RESPONSE_ARTICLE_NOTFOUND &amp;&amp; m_responseCode != MK_NNTP_RESPONSE_ARTICLE_NONEXIST)</span>
<a href="#l9.5856"></a><span id="l9.5856" class="difflineminus">-        return CloseConnection();</span>
<a href="#l9.5857"></a><span id="l9.5857" class="difflineminus">-      MOZ_FALLTHROUGH;</span>
<a href="#l9.5858"></a><span id="l9.5858" class="difflineminus">-    case NEWS_FREE:</span>
<a href="#l9.5859"></a><span id="l9.5859" class="difflineminus">-      // Remember when we last used this connection</span>
<a href="#l9.5860"></a><span id="l9.5860" class="difflineminus">-      m_lastActiveTimeStamp = PR_Now();</span>
<a href="#l9.5861"></a><span id="l9.5861" class="difflineminus">-      CleanupAfterRunningUrl();</span>
<a href="#l9.5862"></a><span id="l9.5862" class="difflineminus">-      MOZ_FALLTHROUGH;</span>
<a href="#l9.5863"></a><span id="l9.5863" class="difflineminus">-    case NNTP_SUSPENDED:</span>
<a href="#l9.5864"></a><span id="l9.5864" class="difflineminus">-      return NS_OK;</span>
<a href="#l9.5865"></a><span id="l9.5865" class="difflineminus">-      break;</span>
<a href="#l9.5866"></a><span id="l9.5866" class="difflineminus">-    default:</span>
<a href="#l9.5867"></a><span id="l9.5867" class="difflineminus">-      /* big error */</span>
<a href="#l9.5868"></a><span id="l9.5868" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l9.5869"></a><span id="l9.5869" class="difflineminus">-</span>
<a href="#l9.5870"></a><span id="l9.5870" class="difflineminus">-    } // end switch</span>
<a href="#l9.5871"></a><span id="l9.5871" class="difflineplus">+  while (!TestFlag(NNTP_PAUSE_FOR_READ)) {</span>
<a href="#l9.5872"></a><span id="l9.5872" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l9.5873"></a><span id="l9.5873" class="difflineplus">+            (&quot;(%p) Next state: %s&quot;, this, stateLabels[m_nextState]));</span>
<a href="#l9.5874"></a><span id="l9.5874" class="difflineplus">+    // examine our current state and call an appropriate handler for that</span>
<a href="#l9.5875"></a><span id="l9.5875" class="difflineplus">+    // state.....</span>
<a href="#l9.5876"></a><span id="l9.5876" class="difflineplus">+    switch (m_nextState) {</span>
<a href="#l9.5877"></a><span id="l9.5877" class="difflineplus">+      case NNTP_RESPONSE:</span>
<a href="#l9.5878"></a><span id="l9.5878" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5879"></a><span id="l9.5879" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5880"></a><span id="l9.5880" class="difflineplus">+        else</span>
<a href="#l9.5881"></a><span id="l9.5881" class="difflineplus">+          status = NewsResponse(inputStream, length);</span>
<a href="#l9.5882"></a><span id="l9.5882" class="difflineplus">+        break;</span>
<a href="#l9.5883"></a><span id="l9.5883" class="difflineplus">+</span>
<a href="#l9.5884"></a><span id="l9.5884" class="difflineplus">+        // mscott: I've removed the states involving connections on the</span>
<a href="#l9.5885"></a><span id="l9.5885" class="difflineplus">+        // assumption that core netlib will now be managing that information.</span>
<a href="#l9.5886"></a><span id="l9.5886" class="difflineplus">+</span>
<a href="#l9.5887"></a><span id="l9.5887" class="difflineplus">+      case NNTP_LOGIN_RESPONSE:</span>
<a href="#l9.5888"></a><span id="l9.5888" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5889"></a><span id="l9.5889" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5890"></a><span id="l9.5890" class="difflineplus">+        else</span>
<a href="#l9.5891"></a><span id="l9.5891" class="difflineplus">+          status = LoginResponse();</span>
<a href="#l9.5892"></a><span id="l9.5892" class="difflineplus">+        break;</span>
<a href="#l9.5893"></a><span id="l9.5893" class="difflineplus">+</span>
<a href="#l9.5894"></a><span id="l9.5894" class="difflineplus">+      case NNTP_SEND_MODE_READER:</span>
<a href="#l9.5895"></a><span id="l9.5895" class="difflineplus">+        status = SendModeReader();</span>
<a href="#l9.5896"></a><span id="l9.5896" class="difflineplus">+        break;</span>
<a href="#l9.5897"></a><span id="l9.5897" class="difflineplus">+</span>
<a href="#l9.5898"></a><span id="l9.5898" class="difflineplus">+      case NNTP_SEND_MODE_READER_RESPONSE:</span>
<a href="#l9.5899"></a><span id="l9.5899" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5900"></a><span id="l9.5900" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5901"></a><span id="l9.5901" class="difflineplus">+        else</span>
<a href="#l9.5902"></a><span id="l9.5902" class="difflineplus">+          status = SendModeReaderResponse();</span>
<a href="#l9.5903"></a><span id="l9.5903" class="difflineplus">+        break;</span>
<a href="#l9.5904"></a><span id="l9.5904" class="difflineplus">+</span>
<a href="#l9.5905"></a><span id="l9.5905" class="difflineplus">+      case SEND_LIST_EXTENSIONS:</span>
<a href="#l9.5906"></a><span id="l9.5906" class="difflineplus">+        status = SendListExtensions();</span>
<a href="#l9.5907"></a><span id="l9.5907" class="difflineplus">+        break;</span>
<a href="#l9.5908"></a><span id="l9.5908" class="difflineplus">+      case SEND_LIST_EXTENSIONS_RESPONSE:</span>
<a href="#l9.5909"></a><span id="l9.5909" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5910"></a><span id="l9.5910" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5911"></a><span id="l9.5911" class="difflineplus">+        else</span>
<a href="#l9.5912"></a><span id="l9.5912" class="difflineplus">+          status = SendListExtensionsResponse(inputStream, length);</span>
<a href="#l9.5913"></a><span id="l9.5913" class="difflineplus">+        break;</span>
<a href="#l9.5914"></a><span id="l9.5914" class="difflineplus">+      case SEND_LIST_SEARCHES:</span>
<a href="#l9.5915"></a><span id="l9.5915" class="difflineplus">+        status = SendListSearches();</span>
<a href="#l9.5916"></a><span id="l9.5916" class="difflineplus">+        break;</span>
<a href="#l9.5917"></a><span id="l9.5917" class="difflineplus">+      case SEND_LIST_SEARCHES_RESPONSE:</span>
<a href="#l9.5918"></a><span id="l9.5918" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5919"></a><span id="l9.5919" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5920"></a><span id="l9.5920" class="difflineplus">+        else</span>
<a href="#l9.5921"></a><span id="l9.5921" class="difflineplus">+          status = SendListSearchesResponse(inputStream, length);</span>
<a href="#l9.5922"></a><span id="l9.5922" class="difflineplus">+        break;</span>
<a href="#l9.5923"></a><span id="l9.5923" class="difflineplus">+      case NNTP_LIST_SEARCH_HEADERS:</span>
<a href="#l9.5924"></a><span id="l9.5924" class="difflineplus">+        status = SendListSearchHeaders();</span>
<a href="#l9.5925"></a><span id="l9.5925" class="difflineplus">+        break;</span>
<a href="#l9.5926"></a><span id="l9.5926" class="difflineplus">+      case NNTP_LIST_SEARCH_HEADERS_RESPONSE:</span>
<a href="#l9.5927"></a><span id="l9.5927" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5928"></a><span id="l9.5928" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5929"></a><span id="l9.5929" class="difflineplus">+        else</span>
<a href="#l9.5930"></a><span id="l9.5930" class="difflineplus">+          status = SendListSearchHeadersResponse(inputStream, length);</span>
<a href="#l9.5931"></a><span id="l9.5931" class="difflineplus">+        break;</span>
<a href="#l9.5932"></a><span id="l9.5932" class="difflineplus">+      case NNTP_GET_PROPERTIES:</span>
<a href="#l9.5933"></a><span id="l9.5933" class="difflineplus">+        status = GetProperties();</span>
<a href="#l9.5934"></a><span id="l9.5934" class="difflineplus">+        break;</span>
<a href="#l9.5935"></a><span id="l9.5935" class="difflineplus">+      case NNTP_GET_PROPERTIES_RESPONSE:</span>
<a href="#l9.5936"></a><span id="l9.5936" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5937"></a><span id="l9.5937" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5938"></a><span id="l9.5938" class="difflineplus">+        else</span>
<a href="#l9.5939"></a><span id="l9.5939" class="difflineplus">+          status = GetPropertiesResponse(inputStream, length);</span>
<a href="#l9.5940"></a><span id="l9.5940" class="difflineplus">+        break;</span>
<a href="#l9.5941"></a><span id="l9.5941" class="difflineplus">+      case SEND_LIST_SUBSCRIPTIONS:</span>
<a href="#l9.5942"></a><span id="l9.5942" class="difflineplus">+        status = SendListSubscriptions();</span>
<a href="#l9.5943"></a><span id="l9.5943" class="difflineplus">+        break;</span>
<a href="#l9.5944"></a><span id="l9.5944" class="difflineplus">+      case SEND_LIST_SUBSCRIPTIONS_RESPONSE:</span>
<a href="#l9.5945"></a><span id="l9.5945" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5946"></a><span id="l9.5946" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5947"></a><span id="l9.5947" class="difflineplus">+        else</span>
<a href="#l9.5948"></a><span id="l9.5948" class="difflineplus">+          status = SendListSubscriptionsResponse(inputStream, length);</span>
<a href="#l9.5949"></a><span id="l9.5949" class="difflineplus">+        break;</span>
<a href="#l9.5950"></a><span id="l9.5950" class="difflineplus">+</span>
<a href="#l9.5951"></a><span id="l9.5951" class="difflineplus">+      case SEND_FIRST_NNTP_COMMAND:</span>
<a href="#l9.5952"></a><span id="l9.5952" class="difflineplus">+        status = SendFirstNNTPCommand(url);</span>
<a href="#l9.5953"></a><span id="l9.5953" class="difflineplus">+        break;</span>
<a href="#l9.5954"></a><span id="l9.5954" class="difflineplus">+      case SEND_FIRST_NNTP_COMMAND_RESPONSE:</span>
<a href="#l9.5955"></a><span id="l9.5955" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5956"></a><span id="l9.5956" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5957"></a><span id="l9.5957" class="difflineplus">+        else</span>
<a href="#l9.5958"></a><span id="l9.5958" class="difflineplus">+          status = SendFirstNNTPCommandResponse();</span>
<a href="#l9.5959"></a><span id="l9.5959" class="difflineplus">+        break;</span>
<a href="#l9.5960"></a><span id="l9.5960" class="difflineplus">+</span>
<a href="#l9.5961"></a><span id="l9.5961" class="difflineplus">+      case NNTP_SEND_GROUP_FOR_ARTICLE:</span>
<a href="#l9.5962"></a><span id="l9.5962" class="difflineplus">+        status = SendGroupForArticle();</span>
<a href="#l9.5963"></a><span id="l9.5963" class="difflineplus">+        break;</span>
<a href="#l9.5964"></a><span id="l9.5964" class="difflineplus">+      case NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE:</span>
<a href="#l9.5965"></a><span id="l9.5965" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5966"></a><span id="l9.5966" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5967"></a><span id="l9.5967" class="difflineplus">+        else</span>
<a href="#l9.5968"></a><span id="l9.5968" class="difflineplus">+          status = SendGroupForArticleResponse();</span>
<a href="#l9.5969"></a><span id="l9.5969" class="difflineplus">+        break;</span>
<a href="#l9.5970"></a><span id="l9.5970" class="difflineplus">+      case NNTP_SEND_ARTICLE_NUMBER:</span>
<a href="#l9.5971"></a><span id="l9.5971" class="difflineplus">+        status = SendArticleNumber();</span>
<a href="#l9.5972"></a><span id="l9.5972" class="difflineplus">+        break;</span>
<a href="#l9.5973"></a><span id="l9.5973" class="difflineplus">+</span>
<a href="#l9.5974"></a><span id="l9.5974" class="difflineplus">+      case SETUP_NEWS_STREAM:</span>
<a href="#l9.5975"></a><span id="l9.5975" class="difflineplus">+        status = SetupForTransfer();</span>
<a href="#l9.5976"></a><span id="l9.5976" class="difflineplus">+        break;</span>
<a href="#l9.5977"></a><span id="l9.5977" class="difflineplus">+</span>
<a href="#l9.5978"></a><span id="l9.5978" class="difflineplus">+      case NNTP_BEGIN_AUTHORIZE:</span>
<a href="#l9.5979"></a><span id="l9.5979" class="difflineplus">+        status = BeginAuthorization();</span>
<a href="#l9.5980"></a><span id="l9.5980" class="difflineplus">+        break;</span>
<a href="#l9.5981"></a><span id="l9.5981" class="difflineplus">+</span>
<a href="#l9.5982"></a><span id="l9.5982" class="difflineplus">+      case NNTP_AUTHORIZE_RESPONSE:</span>
<a href="#l9.5983"></a><span id="l9.5983" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5984"></a><span id="l9.5984" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5985"></a><span id="l9.5985" class="difflineplus">+        else</span>
<a href="#l9.5986"></a><span id="l9.5986" class="difflineplus">+          status = AuthorizationResponse();</span>
<a href="#l9.5987"></a><span id="l9.5987" class="difflineplus">+        break;</span>
<a href="#l9.5988"></a><span id="l9.5988" class="difflineplus">+</span>
<a href="#l9.5989"></a><span id="l9.5989" class="difflineplus">+      case NNTP_PASSWORD_RESPONSE:</span>
<a href="#l9.5990"></a><span id="l9.5990" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.5991"></a><span id="l9.5991" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.5992"></a><span id="l9.5992" class="difflineplus">+        else</span>
<a href="#l9.5993"></a><span id="l9.5993" class="difflineplus">+          status = PasswordResponse();</span>
<a href="#l9.5994"></a><span id="l9.5994" class="difflineplus">+        break;</span>
<a href="#l9.5995"></a><span id="l9.5995" class="difflineplus">+</span>
<a href="#l9.5996"></a><span id="l9.5996" class="difflineplus">+        // read list</span>
<a href="#l9.5997"></a><span id="l9.5997" class="difflineplus">+      case NNTP_READ_LIST_BEGIN:</span>
<a href="#l9.5998"></a><span id="l9.5998" class="difflineplus">+        status = BeginReadNewsList();</span>
<a href="#l9.5999"></a><span id="l9.5999" class="difflineplus">+        break;</span>
<a href="#l9.6000"></a><span id="l9.6000" class="difflineplus">+      case NNTP_READ_LIST:</span>
<a href="#l9.6001"></a><span id="l9.6001" class="difflineplus">+        status = ReadNewsList(inputStream, length);</span>
<a href="#l9.6002"></a><span id="l9.6002" class="difflineplus">+        break;</span>
<a href="#l9.6003"></a><span id="l9.6003" class="difflineplus">+</span>
<a href="#l9.6004"></a><span id="l9.6004" class="difflineplus">+        // news group</span>
<a href="#l9.6005"></a><span id="l9.6005" class="difflineplus">+      case DISPLAY_NEWSGROUPS:</span>
<a href="#l9.6006"></a><span id="l9.6006" class="difflineplus">+        status = DisplayNewsgroups();</span>
<a href="#l9.6007"></a><span id="l9.6007" class="difflineplus">+        break;</span>
<a href="#l9.6008"></a><span id="l9.6008" class="difflineplus">+      case NNTP_NEWGROUPS_BEGIN:</span>
<a href="#l9.6009"></a><span id="l9.6009" class="difflineplus">+        status = BeginNewsgroups();</span>
<a href="#l9.6010"></a><span id="l9.6010" class="difflineplus">+        break;</span>
<a href="#l9.6011"></a><span id="l9.6011" class="difflineplus">+      case NNTP_NEWGROUPS:</span>
<a href="#l9.6012"></a><span id="l9.6012" class="difflineplus">+        status = ProcessNewsgroups(inputStream, length);</span>
<a href="#l9.6013"></a><span id="l9.6013" class="difflineplus">+        break;</span>
<a href="#l9.6014"></a><span id="l9.6014" class="difflineplus">+</span>
<a href="#l9.6015"></a><span id="l9.6015" class="difflineplus">+        // article specific</span>
<a href="#l9.6016"></a><span id="l9.6016" class="difflineplus">+      case NNTP_BEGIN_ARTICLE:</span>
<a href="#l9.6017"></a><span id="l9.6017" class="difflineplus">+        status = BeginArticle();</span>
<a href="#l9.6018"></a><span id="l9.6018" class="difflineplus">+        break;</span>
<a href="#l9.6019"></a><span id="l9.6019" class="difflineplus">+</span>
<a href="#l9.6020"></a><span id="l9.6020" class="difflineplus">+      case NNTP_READ_ARTICLE:</span>
<a href="#l9.6021"></a><span id="l9.6021" class="difflineplus">+        status = ReadArticle(inputStream, length);</span>
<a href="#l9.6022"></a><span id="l9.6022" class="difflineplus">+        break;</span>
<a href="#l9.6023"></a><span id="l9.6023" class="difflineplus">+</span>
<a href="#l9.6024"></a><span id="l9.6024" class="difflineplus">+      case NNTP_XOVER_BEGIN:</span>
<a href="#l9.6025"></a><span id="l9.6025" class="difflineplus">+        status = BeginReadXover();</span>
<a href="#l9.6026"></a><span id="l9.6026" class="difflineplus">+        break;</span>
<a href="#l9.6027"></a><span id="l9.6027" class="difflineplus">+</span>
<a href="#l9.6028"></a><span id="l9.6028" class="difflineplus">+      case NNTP_FIGURE_NEXT_CHUNK:</span>
<a href="#l9.6029"></a><span id="l9.6029" class="difflineplus">+        status = FigureNextChunk();</span>
<a href="#l9.6030"></a><span id="l9.6030" class="difflineplus">+        break;</span>
<a href="#l9.6031"></a><span id="l9.6031" class="difflineplus">+</span>
<a href="#l9.6032"></a><span id="l9.6032" class="difflineplus">+      case NNTP_XOVER_SEND:</span>
<a href="#l9.6033"></a><span id="l9.6033" class="difflineplus">+        status = XoverSend();</span>
<a href="#l9.6034"></a><span id="l9.6034" class="difflineplus">+        break;</span>
<a href="#l9.6035"></a><span id="l9.6035" class="difflineplus">+</span>
<a href="#l9.6036"></a><span id="l9.6036" class="difflineplus">+      case NNTP_XOVER:</span>
<a href="#l9.6037"></a><span id="l9.6037" class="difflineplus">+        status = ReadXover(inputStream, length);</span>
<a href="#l9.6038"></a><span id="l9.6038" class="difflineplus">+        break;</span>
<a href="#l9.6039"></a><span id="l9.6039" class="difflineplus">+</span>
<a href="#l9.6040"></a><span id="l9.6040" class="difflineplus">+      case NNTP_XOVER_RESPONSE:</span>
<a href="#l9.6041"></a><span id="l9.6041" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6042"></a><span id="l9.6042" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6043"></a><span id="l9.6043" class="difflineplus">+        else</span>
<a href="#l9.6044"></a><span id="l9.6044" class="difflineplus">+          status = ReadXoverResponse();</span>
<a href="#l9.6045"></a><span id="l9.6045" class="difflineplus">+        break;</span>
<a href="#l9.6046"></a><span id="l9.6046" class="difflineplus">+</span>
<a href="#l9.6047"></a><span id="l9.6047" class="difflineplus">+      case NEWS_PROCESS_XOVER:</span>
<a href="#l9.6048"></a><span id="l9.6048" class="difflineplus">+      case NEWS_PROCESS_BODIES:</span>
<a href="#l9.6049"></a><span id="l9.6049" class="difflineplus">+        status = ProcessXover();</span>
<a href="#l9.6050"></a><span id="l9.6050" class="difflineplus">+        break;</span>
<a href="#l9.6051"></a><span id="l9.6051" class="difflineplus">+</span>
<a href="#l9.6052"></a><span id="l9.6052" class="difflineplus">+      case NNTP_XHDR_SEND:</span>
<a href="#l9.6053"></a><span id="l9.6053" class="difflineplus">+        status = XhdrSend();</span>
<a href="#l9.6054"></a><span id="l9.6054" class="difflineplus">+        break;</span>
<a href="#l9.6055"></a><span id="l9.6055" class="difflineplus">+</span>
<a href="#l9.6056"></a><span id="l9.6056" class="difflineplus">+      case NNTP_XHDR_RESPONSE:</span>
<a href="#l9.6057"></a><span id="l9.6057" class="difflineplus">+        status = XhdrResponse(inputStream);</span>
<a href="#l9.6058"></a><span id="l9.6058" class="difflineplus">+        break;</span>
<a href="#l9.6059"></a><span id="l9.6059" class="difflineplus">+</span>
<a href="#l9.6060"></a><span id="l9.6060" class="difflineplus">+      case NNTP_READ_GROUP:</span>
<a href="#l9.6061"></a><span id="l9.6061" class="difflineplus">+        status = ReadHeaders();</span>
<a href="#l9.6062"></a><span id="l9.6062" class="difflineplus">+        break;</span>
<a href="#l9.6063"></a><span id="l9.6063" class="difflineplus">+</span>
<a href="#l9.6064"></a><span id="l9.6064" class="difflineplus">+      case NNTP_READ_GROUP_RESPONSE:</span>
<a href="#l9.6065"></a><span id="l9.6065" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6066"></a><span id="l9.6066" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6067"></a><span id="l9.6067" class="difflineplus">+        else</span>
<a href="#l9.6068"></a><span id="l9.6068" class="difflineplus">+          status = ReadNewsgroupResponse();</span>
<a href="#l9.6069"></a><span id="l9.6069" class="difflineplus">+        break;</span>
<a href="#l9.6070"></a><span id="l9.6070" class="difflineplus">+</span>
<a href="#l9.6071"></a><span id="l9.6071" class="difflineplus">+      case NNTP_READ_GROUP_BODY:</span>
<a href="#l9.6072"></a><span id="l9.6072" class="difflineplus">+        status = ReadNewsgroupBody(inputStream, length);</span>
<a href="#l9.6073"></a><span id="l9.6073" class="difflineplus">+        break;</span>
<a href="#l9.6074"></a><span id="l9.6074" class="difflineplus">+</span>
<a href="#l9.6075"></a><span id="l9.6075" class="difflineplus">+      case NNTP_SEND_POST_DATA:</span>
<a href="#l9.6076"></a><span id="l9.6076" class="difflineplus">+        status = PostData();</span>
<a href="#l9.6077"></a><span id="l9.6077" class="difflineplus">+        break;</span>
<a href="#l9.6078"></a><span id="l9.6078" class="difflineplus">+      case NNTP_SEND_POST_DATA_RESPONSE:</span>
<a href="#l9.6079"></a><span id="l9.6079" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6080"></a><span id="l9.6080" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6081"></a><span id="l9.6081" class="difflineplus">+        else</span>
<a href="#l9.6082"></a><span id="l9.6082" class="difflineplus">+          status = PostDataResponse();</span>
<a href="#l9.6083"></a><span id="l9.6083" class="difflineplus">+        break;</span>
<a href="#l9.6084"></a><span id="l9.6084" class="difflineplus">+</span>
<a href="#l9.6085"></a><span id="l9.6085" class="difflineplus">+      case NNTP_CHECK_FOR_MESSAGE:</span>
<a href="#l9.6086"></a><span id="l9.6086" class="difflineplus">+        status = CheckForArticle();</span>
<a href="#l9.6087"></a><span id="l9.6087" class="difflineplus">+        break;</span>
<a href="#l9.6088"></a><span id="l9.6088" class="difflineplus">+</span>
<a href="#l9.6089"></a><span id="l9.6089" class="difflineplus">+        // cancel</span>
<a href="#l9.6090"></a><span id="l9.6090" class="difflineplus">+      case NEWS_START_CANCEL:</span>
<a href="#l9.6091"></a><span id="l9.6091" class="difflineplus">+        status = StartCancel();</span>
<a href="#l9.6092"></a><span id="l9.6092" class="difflineplus">+        break;</span>
<a href="#l9.6093"></a><span id="l9.6093" class="difflineplus">+</span>
<a href="#l9.6094"></a><span id="l9.6094" class="difflineplus">+      case NEWS_DO_CANCEL:</span>
<a href="#l9.6095"></a><span id="l9.6095" class="difflineplus">+        status = DoCancel();</span>
<a href="#l9.6096"></a><span id="l9.6096" class="difflineplus">+        break;</span>
<a href="#l9.6097"></a><span id="l9.6097" class="difflineplus">+</span>
<a href="#l9.6098"></a><span id="l9.6098" class="difflineplus">+        // XPAT</span>
<a href="#l9.6099"></a><span id="l9.6099" class="difflineplus">+      case NNTP_XPAT_SEND:</span>
<a href="#l9.6100"></a><span id="l9.6100" class="difflineplus">+        status = XPATSend();</span>
<a href="#l9.6101"></a><span id="l9.6101" class="difflineplus">+        break;</span>
<a href="#l9.6102"></a><span id="l9.6102" class="difflineplus">+      case NNTP_XPAT_RESPONSE:</span>
<a href="#l9.6103"></a><span id="l9.6103" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6104"></a><span id="l9.6104" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6105"></a><span id="l9.6105" class="difflineplus">+        else</span>
<a href="#l9.6106"></a><span id="l9.6106" class="difflineplus">+          status = XPATResponse(inputStream, length);</span>
<a href="#l9.6107"></a><span id="l9.6107" class="difflineplus">+        break;</span>
<a href="#l9.6108"></a><span id="l9.6108" class="difflineplus">+</span>
<a href="#l9.6109"></a><span id="l9.6109" class="difflineplus">+        // search</span>
<a href="#l9.6110"></a><span id="l9.6110" class="difflineplus">+      case NNTP_SEARCH:</span>
<a href="#l9.6111"></a><span id="l9.6111" class="difflineplus">+        status = Search();</span>
<a href="#l9.6112"></a><span id="l9.6112" class="difflineplus">+        break;</span>
<a href="#l9.6113"></a><span id="l9.6113" class="difflineplus">+      case NNTP_SEARCH_RESPONSE:</span>
<a href="#l9.6114"></a><span id="l9.6114" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6115"></a><span id="l9.6115" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6116"></a><span id="l9.6116" class="difflineplus">+        else</span>
<a href="#l9.6117"></a><span id="l9.6117" class="difflineplus">+          status = SearchResponse();</span>
<a href="#l9.6118"></a><span id="l9.6118" class="difflineplus">+        break;</span>
<a href="#l9.6119"></a><span id="l9.6119" class="difflineplus">+      case NNTP_SEARCH_RESULTS:</span>
<a href="#l9.6120"></a><span id="l9.6120" class="difflineplus">+        status = SearchResults(inputStream, length);</span>
<a href="#l9.6121"></a><span id="l9.6121" class="difflineplus">+        break;</span>
<a href="#l9.6122"></a><span id="l9.6122" class="difflineplus">+</span>
<a href="#l9.6123"></a><span id="l9.6123" class="difflineplus">+      case NNTP_LIST_PRETTY_NAMES:</span>
<a href="#l9.6124"></a><span id="l9.6124" class="difflineplus">+        status = ListPrettyNames();</span>
<a href="#l9.6125"></a><span id="l9.6125" class="difflineplus">+        break;</span>
<a href="#l9.6126"></a><span id="l9.6126" class="difflineplus">+      case NNTP_LIST_PRETTY_NAMES_RESPONSE:</span>
<a href="#l9.6127"></a><span id="l9.6127" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6128"></a><span id="l9.6128" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6129"></a><span id="l9.6129" class="difflineplus">+        else</span>
<a href="#l9.6130"></a><span id="l9.6130" class="difflineplus">+          status = ListPrettyNamesResponse(inputStream, length);</span>
<a href="#l9.6131"></a><span id="l9.6131" class="difflineplus">+        break;</span>
<a href="#l9.6132"></a><span id="l9.6132" class="difflineplus">+      case NNTP_LIST_XACTIVE:</span>
<a href="#l9.6133"></a><span id="l9.6133" class="difflineplus">+        status = ListXActive();</span>
<a href="#l9.6134"></a><span id="l9.6134" class="difflineplus">+        break;</span>
<a href="#l9.6135"></a><span id="l9.6135" class="difflineplus">+      case NNTP_LIST_XACTIVE_RESPONSE:</span>
<a href="#l9.6136"></a><span id="l9.6136" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6137"></a><span id="l9.6137" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6138"></a><span id="l9.6138" class="difflineplus">+        else</span>
<a href="#l9.6139"></a><span id="l9.6139" class="difflineplus">+          status = ListXActiveResponse(inputStream, length);</span>
<a href="#l9.6140"></a><span id="l9.6140" class="difflineplus">+        break;</span>
<a href="#l9.6141"></a><span id="l9.6141" class="difflineplus">+      case NNTP_LIST_GROUP:</span>
<a href="#l9.6142"></a><span id="l9.6142" class="difflineplus">+        status = SendListGroup();</span>
<a href="#l9.6143"></a><span id="l9.6143" class="difflineplus">+        break;</span>
<a href="#l9.6144"></a><span id="l9.6144" class="difflineplus">+      case NNTP_LIST_GROUP_RESPONSE:</span>
<a href="#l9.6145"></a><span id="l9.6145" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l9.6146"></a><span id="l9.6146" class="difflineplus">+          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6147"></a><span id="l9.6147" class="difflineplus">+        else</span>
<a href="#l9.6148"></a><span id="l9.6148" class="difflineplus">+          status = SendListGroupResponse(inputStream, length);</span>
<a href="#l9.6149"></a><span id="l9.6149" class="difflineplus">+        break;</span>
<a href="#l9.6150"></a><span id="l9.6150" class="difflineplus">+      case NEWS_DONE:</span>
<a href="#l9.6151"></a><span id="l9.6151" class="difflineplus">+        m_nextState = NEWS_FREE;</span>
<a href="#l9.6152"></a><span id="l9.6152" class="difflineplus">+        break;</span>
<a href="#l9.6153"></a><span id="l9.6153" class="difflineplus">+      case NEWS_POST_DONE:</span>
<a href="#l9.6154"></a><span id="l9.6154" class="difflineplus">+        NNTP_LOG_NOTE(&quot;NEWS_POST_DONE&quot;);</span>
<a href="#l9.6155"></a><span id="l9.6155" class="difflineplus">+        mailnewsurl-&gt;SetUrlState(false, NS_OK);</span>
<a href="#l9.6156"></a><span id="l9.6156" class="difflineplus">+        m_nextState = NEWS_FREE;</span>
<a href="#l9.6157"></a><span id="l9.6157" class="difflineplus">+        break;</span>
<a href="#l9.6158"></a><span id="l9.6158" class="difflineplus">+      case NEWS_ERROR:</span>
<a href="#l9.6159"></a><span id="l9.6159" class="difflineplus">+        NNTP_LOG_NOTE(&quot;NEWS_ERROR&quot;);</span>
<a href="#l9.6160"></a><span id="l9.6160" class="difflineplus">+        if (m_responseCode == MK_NNTP_RESPONSE_ARTICLE_NOTFOUND ||</span>
<a href="#l9.6161"></a><span id="l9.6161" class="difflineplus">+            m_responseCode == MK_NNTP_RESPONSE_ARTICLE_NONEXIST)</span>
<a href="#l9.6162"></a><span id="l9.6162" class="difflineplus">+          mailnewsurl-&gt;SetUrlState(false, NS_MSG_NEWS_ARTICLE_NOT_FOUND);</span>
<a href="#l9.6163"></a><span id="l9.6163" class="difflineplus">+        else</span>
<a href="#l9.6164"></a><span id="l9.6164" class="difflineplus">+          mailnewsurl-&gt;SetUrlState(false, NS_ERROR_FAILURE);</span>
<a href="#l9.6165"></a><span id="l9.6165" class="difflineplus">+        m_nextState = NEWS_FREE;</span>
<a href="#l9.6166"></a><span id="l9.6166" class="difflineplus">+        break;</span>
<a href="#l9.6167"></a><span id="l9.6167" class="difflineplus">+      case NNTP_ERROR:</span>
<a href="#l9.6168"></a><span id="l9.6168" class="difflineplus">+        // XXX do we really want to remove the connection from</span>
<a href="#l9.6169"></a><span id="l9.6169" class="difflineplus">+        // the cache on error?</span>
<a href="#l9.6170"></a><span id="l9.6170" class="difflineplus">+        /* check if this connection came from the cache or if it was</span>
<a href="#l9.6171"></a><span id="l9.6171" class="difflineplus">+         * a new connection.  If it was not new lets start it over</span>
<a href="#l9.6172"></a><span id="l9.6172" class="difflineplus">+         * again.  But only if we didn't have any successful protocol</span>
<a href="#l9.6173"></a><span id="l9.6173" class="difflineplus">+         * dialog at all.</span>
<a href="#l9.6174"></a><span id="l9.6174" class="difflineplus">+         */</span>
<a href="#l9.6175"></a><span id="l9.6175" class="difflineplus">+        FinishMemCacheEntry(false);  // cleanup mem cache entry</span>
<a href="#l9.6176"></a><span id="l9.6176" class="difflineplus">+        if (m_responseCode != MK_NNTP_RESPONSE_ARTICLE_NOTFOUND &amp;&amp;</span>
<a href="#l9.6177"></a><span id="l9.6177" class="difflineplus">+            m_responseCode != MK_NNTP_RESPONSE_ARTICLE_NONEXIST)</span>
<a href="#l9.6178"></a><span id="l9.6178" class="difflineplus">+          return CloseConnection();</span>
<a href="#l9.6179"></a><span id="l9.6179" class="difflineplus">+        MOZ_FALLTHROUGH;</span>
<a href="#l9.6180"></a><span id="l9.6180" class="difflineplus">+      case NEWS_FREE:</span>
<a href="#l9.6181"></a><span id="l9.6181" class="difflineplus">+        // Remember when we last used this connection</span>
<a href="#l9.6182"></a><span id="l9.6182" class="difflineplus">+        m_lastActiveTimeStamp = PR_Now();</span>
<a href="#l9.6183"></a><span id="l9.6183" class="difflineplus">+        CleanupAfterRunningUrl();</span>
<a href="#l9.6184"></a><span id="l9.6184" class="difflineplus">+        MOZ_FALLTHROUGH;</span>
<a href="#l9.6185"></a><span id="l9.6185" class="difflineplus">+      case NNTP_SUSPENDED:</span>
<a href="#l9.6186"></a><span id="l9.6186" class="difflineplus">+        return NS_OK;</span>
<a href="#l9.6187"></a><span id="l9.6187" class="difflineplus">+        break;</span>
<a href="#l9.6188"></a><span id="l9.6188" class="difflineplus">+      default:</span>
<a href="#l9.6189"></a><span id="l9.6189" class="difflineplus">+        /* big error */</span>
<a href="#l9.6190"></a><span id="l9.6190" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l9.6191"></a><span id="l9.6191" class="difflineplus">+</span>
<a href="#l9.6192"></a><span id="l9.6192" class="difflineplus">+    }  // end switch</span>
<a href="#l9.6193"></a><span id="l9.6193"> </span>
<a href="#l9.6194"></a><span id="l9.6194">     if (NS_FAILED(status) &amp;&amp; m_nextState != NEWS_ERROR &amp;&amp;</span>
<a href="#l9.6195"></a><span id="l9.6195" class="difflineminus">-        m_nextState != NNTP_ERROR &amp;&amp; m_nextState != NEWS_FREE)</span>
<a href="#l9.6196"></a><span id="l9.6196" class="difflineminus">-    {</span>
<a href="#l9.6197"></a><span id="l9.6197" class="difflineplus">+        m_nextState != NNTP_ERROR &amp;&amp; m_nextState != NEWS_FREE) {</span>
<a href="#l9.6198"></a><span id="l9.6198">       m_nextState = NNTP_ERROR;</span>
<a href="#l9.6199"></a><span id="l9.6199">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l9.6200"></a><span id="l9.6200">     }</span>
<a href="#l9.6201"></a><span id="l9.6201"> </span>
<a href="#l9.6202"></a><span id="l9.6202">   } /* end big while */</span>
<a href="#l9.6203"></a><span id="l9.6203"> </span>
<a href="#l9.6204"></a><span id="l9.6204">   return NS_OK; /* keep going */</span>
<a href="#l9.6205"></a><span id="l9.6205"> }</span>
<a href="#l9.6206"></a><span id="l9.6206"> </span>
<a href="#l9.6207"></a><span id="l9.6207" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::CloseConnection()</span>
<a href="#l9.6208"></a><span id="l9.6208" class="difflineminus">-{</span>
<a href="#l9.6209"></a><span id="l9.6209" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) ClosingConnection&quot;,this));</span>
<a href="#l9.6210"></a><span id="l9.6210" class="difflineminus">-  SendData(NNTP_CMD_QUIT); // this will cause OnStopRequest get called, which will call CloseSocket()</span>
<a href="#l9.6211"></a><span id="l9.6211" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::CloseConnection() {</span>
<a href="#l9.6212"></a><span id="l9.6212" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) ClosingConnection&quot;, this));</span>
<a href="#l9.6213"></a><span id="l9.6213" class="difflineplus">+  SendData(NNTP_CMD_QUIT);  // this will cause OnStopRequest get called, which</span>
<a href="#l9.6214"></a><span id="l9.6214" class="difflineplus">+                            // will call CloseSocket()</span>
<a href="#l9.6215"></a><span id="l9.6215">   // break some cycles</span>
<a href="#l9.6216"></a><span id="l9.6216">   CleanupNewsgroupList();</span>
<a href="#l9.6217"></a><span id="l9.6217"> </span>
<a href="#l9.6218"></a><span id="l9.6218">   if (m_nntpServer) {</span>
<a href="#l9.6219"></a><span id="l9.6219">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l9.6220"></a><span id="l9.6220">     m_nntpServer = nullptr;</span>
<a href="#l9.6221"></a><span id="l9.6221">   }</span>
<a href="#l9.6222"></a><span id="l9.6222">   CloseSocket();</span>
<a href="#l9.6223"></a><span id="l9.6223" class="difflineat">@@ -4630,54 +4322,50 @@ NS_IMETHODIMP nsNNTPProtocol::CloseConne</span>
<a href="#l9.6224"></a><span id="l9.6224">     m_articleList-&gt;FinishAddingArticleKeys();</span>
<a href="#l9.6225"></a><span id="l9.6225">     m_articleList = nullptr;</span>
<a href="#l9.6226"></a><span id="l9.6226">   }</span>
<a href="#l9.6227"></a><span id="l9.6227"> </span>
<a href="#l9.6228"></a><span id="l9.6228">   m_key = nsMsgKey_None;</span>
<a href="#l9.6229"></a><span id="l9.6229">   return NS_OK;</span>
<a href="#l9.6230"></a><span id="l9.6230"> }</span>
<a href="#l9.6231"></a><span id="l9.6231"> </span>
<a href="#l9.6232"></a><span id="l9.6232" class="difflineminus">-nsresult nsNNTPProtocol::CleanupNewsgroupList()</span>
<a href="#l9.6233"></a><span id="l9.6233" class="difflineminus">-{</span>
<a href="#l9.6234"></a><span id="l9.6234" class="difflineminus">-    nsresult rv;</span>
<a href="#l9.6235"></a><span id="l9.6235" class="difflineminus">-    if (!m_newsgroupList) return NS_OK;</span>
<a href="#l9.6236"></a><span id="l9.6236" class="difflineplus">+nsresult nsNNTPProtocol::CleanupNewsgroupList() {</span>
<a href="#l9.6237"></a><span id="l9.6237" class="difflineplus">+  nsresult rv;</span>
<a href="#l9.6238"></a><span id="l9.6238" class="difflineplus">+  if (!m_newsgroupList) return NS_OK;</span>
<a href="#l9.6239"></a><span id="l9.6239">   int32_t status = 0;</span>
<a href="#l9.6240"></a><span id="l9.6240" class="difflineminus">-    rv = m_newsgroupList-&gt;FinishXOVERLINE(0,&amp;status);</span>
<a href="#l9.6241"></a><span id="l9.6241" class="difflineminus">-    m_newsgroupList = nullptr;</span>
<a href="#l9.6242"></a><span id="l9.6242" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;FinishXOVERLINE failed&quot;);</span>
<a href="#l9.6243"></a><span id="l9.6243" class="difflineminus">-    return rv;</span>
<a href="#l9.6244"></a><span id="l9.6244" class="difflineplus">+  rv = m_newsgroupList-&gt;FinishXOVERLINE(0, &amp;status);</span>
<a href="#l9.6245"></a><span id="l9.6245" class="difflineplus">+  m_newsgroupList = nullptr;</span>
<a href="#l9.6246"></a><span id="l9.6246" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;FinishXOVERLINE failed&quot;);</span>
<a href="#l9.6247"></a><span id="l9.6247" class="difflineplus">+  return rv;</span>
<a href="#l9.6248"></a><span id="l9.6248"> }</span>
<a href="#l9.6249"></a><span id="l9.6249"> </span>
<a href="#l9.6250"></a><span id="l9.6250" class="difflineminus">-nsresult nsNNTPProtocol::CleanupAfterRunningUrl()</span>
<a href="#l9.6251"></a><span id="l9.6251" class="difflineminus">-{</span>
<a href="#l9.6252"></a><span id="l9.6252" class="difflineplus">+nsresult nsNNTPProtocol::CleanupAfterRunningUrl() {</span>
<a href="#l9.6253"></a><span id="l9.6253">   /* do we need to know if we're parsing xover to call finish xover?  */</span>
<a href="#l9.6254"></a><span id="l9.6254">   /* yes, I think we do! Why did I think we should??? */</span>
<a href="#l9.6255"></a><span id="l9.6255">   /* If we've gotten to NEWS_FREE and there is still XOVER</span>
<a href="#l9.6256"></a><span id="l9.6256">   data, there was an error or we were interrupted or</span>
<a href="#l9.6257"></a><span id="l9.6257">   something.  So, tell libmsg there was an abnormal</span>
<a href="#l9.6258"></a><span id="l9.6258">   exit so that it can free its data. */</span>
<a href="#l9.6259"></a><span id="l9.6259"> </span>
<a href="#l9.6260"></a><span id="l9.6260" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) CleanupAfterRunningUrl()&quot;, this));</span>
<a href="#l9.6261"></a><span id="l9.6261" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) CleanupAfterRunningUrl()&quot;, this));</span>
<a href="#l9.6262"></a><span id="l9.6262"> </span>
<a href="#l9.6263"></a><span id="l9.6263">   // send StopRequest notification after we've cleaned up the protocol</span>
<a href="#l9.6264"></a><span id="l9.6264">   // because it can synchronously causes a new url to get run in the</span>
<a href="#l9.6265"></a><span id="l9.6265">   // protocol - truly evil, but we're stuck at the moment.</span>
<a href="#l9.6266"></a><span id="l9.6266" class="difflineminus">-  if (m_channelListener)</span>
<a href="#l9.6267"></a><span id="l9.6267" class="difflineminus">-    (void) m_channelListener-&gt;OnStopRequest(this, NS_OK);</span>
<a href="#l9.6268"></a><span id="l9.6268" class="difflineplus">+  if (m_channelListener) (void)m_channelListener-&gt;OnStopRequest(this, NS_OK);</span>
<a href="#l9.6269"></a><span id="l9.6269"> </span>
<a href="#l9.6270"></a><span id="l9.6270">   if (m_loadGroup)</span>
<a href="#l9.6271"></a><span id="l9.6271" class="difflineminus">-    (void) m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr, NS_OK);</span>
<a href="#l9.6272"></a><span id="l9.6272" class="difflineplus">+    (void)m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr,</span>
<a href="#l9.6273"></a><span id="l9.6273" class="difflineplus">+                                     NS_OK);</span>
<a href="#l9.6274"></a><span id="l9.6274">   CleanupNewsgroupList();</span>
<a href="#l9.6275"></a><span id="l9.6275"> </span>
<a href="#l9.6276"></a><span id="l9.6276">   // clear out mem cache entry so we're not holding onto it.</span>
<a href="#l9.6277"></a><span id="l9.6277" class="difflineminus">-  if (m_runningURL)</span>
<a href="#l9.6278"></a><span id="l9.6278" class="difflineminus">-  {</span>
<a href="#l9.6279"></a><span id="l9.6279" class="difflineplus">+  if (m_runningURL) {</span>
<a href="#l9.6280"></a><span id="l9.6280">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l9.6281"></a><span id="l9.6281" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l9.6282"></a><span id="l9.6282" class="difflineminus">-    {</span>
<a href="#l9.6283"></a><span id="l9.6283" class="difflineplus">+    if (mailnewsurl) {</span>
<a href="#l9.6284"></a><span id="l9.6284">       mailnewsurl-&gt;SetUrlState(false, NS_OK);</span>
<a href="#l9.6285"></a><span id="l9.6285">       mailnewsurl-&gt;SetMemCacheEntry(nullptr);</span>
<a href="#l9.6286"></a><span id="l9.6286">     }</span>
<a href="#l9.6287"></a><span id="l9.6287">   }</span>
<a href="#l9.6288"></a><span id="l9.6288"> </span>
<a href="#l9.6289"></a><span id="l9.6289">   Cleanup();</span>
<a href="#l9.6290"></a><span id="l9.6290"> </span>
<a href="#l9.6291"></a><span id="l9.6291">   mDisplayInputStream = nullptr;</span>
<a href="#l9.6292"></a><span id="l9.6292" class="difflineat">@@ -4690,101 +4378,92 @@ nsresult nsNNTPProtocol::CleanupAfterRun</span>
<a href="#l9.6293"></a><span id="l9.6293">   m_loadGroup = nullptr;</span>
<a href="#l9.6294"></a><span id="l9.6294">   mCallbacks = nullptr;</span>
<a href="#l9.6295"></a><span id="l9.6295"> </span>
<a href="#l9.6296"></a><span id="l9.6296">   // disable timeout before caching.</span>
<a href="#l9.6297"></a><span id="l9.6297">   nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport);</span>
<a href="#l9.6298"></a><span id="l9.6298">   if (strans)</span>
<a href="#l9.6299"></a><span id="l9.6299">     strans-&gt;SetTimeout(nsISocketTransport::TIMEOUT_READ_WRITE, PR_UINT32_MAX);</span>
<a href="#l9.6300"></a><span id="l9.6300"> </span>
<a href="#l9.6301"></a><span id="l9.6301" class="difflineminus">-  // don't mark ourselves as not busy until we are done cleaning up the connection. it should be the</span>
<a href="#l9.6302"></a><span id="l9.6302" class="difflineminus">-  // last thing we do.</span>
<a href="#l9.6303"></a><span id="l9.6303" class="difflineplus">+  // don't mark ourselves as not busy until we are done cleaning up the</span>
<a href="#l9.6304"></a><span id="l9.6304" class="difflineplus">+  // connection. it should be the last thing we do.</span>
<a href="#l9.6305"></a><span id="l9.6305">   SetIsBusy(false);</span>
<a href="#l9.6306"></a><span id="l9.6306"> </span>
<a href="#l9.6307"></a><span id="l9.6307">   return NS_OK;</span>
<a href="#l9.6308"></a><span id="l9.6308"> }</span>
<a href="#l9.6309"></a><span id="l9.6309"> </span>
<a href="#l9.6310"></a><span id="l9.6310" class="difflineminus">-nsresult nsNNTPProtocol::CloseSocket()</span>
<a href="#l9.6311"></a><span id="l9.6311" class="difflineminus">-{</span>
<a href="#l9.6312"></a><span id="l9.6312" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) ClosingSocket()&quot;,this));</span>
<a href="#l9.6313"></a><span id="l9.6313" class="difflineplus">+nsresult nsNNTPProtocol::CloseSocket() {</span>
<a href="#l9.6314"></a><span id="l9.6314" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;(%p) ClosingSocket()&quot;, this));</span>
<a href="#l9.6315"></a><span id="l9.6315"> </span>
<a href="#l9.6316"></a><span id="l9.6316">   if (m_nntpServer) {</span>
<a href="#l9.6317"></a><span id="l9.6317">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l9.6318"></a><span id="l9.6318">     m_nntpServer = nullptr;</span>
<a href="#l9.6319"></a><span id="l9.6319">   }</span>
<a href="#l9.6320"></a><span id="l9.6320"> </span>
<a href="#l9.6321"></a><span id="l9.6321" class="difflineminus">-  CleanupAfterRunningUrl(); // is this needed?</span>
<a href="#l9.6322"></a><span id="l9.6322" class="difflineplus">+  CleanupAfterRunningUrl();  // is this needed?</span>
<a href="#l9.6323"></a><span id="l9.6323">   return nsMsgProtocol::CloseSocket();</span>
<a href="#l9.6324"></a><span id="l9.6324"> }</span>
<a href="#l9.6325"></a><span id="l9.6325"> </span>
<a href="#l9.6326"></a><span id="l9.6326" class="difflineminus">-void nsNNTPProtocol::SetProgressBarPercent(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l9.6327"></a><span id="l9.6327" class="difflineminus">-{</span>
<a href="#l9.6328"></a><span id="l9.6328" class="difflineplus">+void nsNNTPProtocol::SetProgressBarPercent(uint32_t aProgress,</span>
<a href="#l9.6329"></a><span id="l9.6329" class="difflineplus">+                                           uint32_t aProgressMax) {</span>
<a href="#l9.6330"></a><span id="l9.6330">   // XXX 64-bit</span>
<a href="#l9.6331"></a><span id="l9.6331">   if (mProgressEventSink)</span>
<a href="#l9.6332"></a><span id="l9.6332">     mProgressEventSink-&gt;OnProgress(this, m_channelContext, uint64_t(aProgress),</span>
<a href="#l9.6333"></a><span id="l9.6333">                                    uint64_t(aProgressMax));</span>
<a href="#l9.6334"></a><span id="l9.6334"> }</span>
<a href="#l9.6335"></a><span id="l9.6335"> </span>
<a href="#l9.6336"></a><span id="l9.6336" class="difflineminus">-nsresult</span>
<a href="#l9.6337"></a><span id="l9.6337" class="difflineminus">-nsNNTPProtocol::SetProgressStatus(const char16_t *aMessage)</span>
<a href="#l9.6338"></a><span id="l9.6338" class="difflineminus">-{</span>
<a href="#l9.6339"></a><span id="l9.6339" class="difflineplus">+nsresult nsNNTPProtocol::SetProgressStatus(const char16_t *aMessage) {</span>
<a href="#l9.6340"></a><span id="l9.6340">   nsresult rv = NS_OK;</span>
<a href="#l9.6341"></a><span id="l9.6341">   if (mProgressEventSink)</span>
<a href="#l9.6342"></a><span id="l9.6342">     rv = mProgressEventSink-&gt;OnStatus(this, m_channelContext, NS_OK, aMessage);</span>
<a href="#l9.6343"></a><span id="l9.6343">   return rv;</span>
<a href="#l9.6344"></a><span id="l9.6344"> }</span>
<a href="#l9.6345"></a><span id="l9.6345"> </span>
<a href="#l9.6346"></a><span id="l9.6346" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::GetContentType(nsACString &amp;aContentType)</span>
<a href="#l9.6347"></a><span id="l9.6347" class="difflineminus">-{</span>
<a href="#l9.6348"></a><span id="l9.6348" class="difflineminus">-</span>
<a href="#l9.6349"></a><span id="l9.6349" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::GetContentType(nsACString &amp;aContentType) {</span>
<a href="#l9.6350"></a><span id="l9.6350">   // if we've been set with a content type, then return it....</span>
<a href="#l9.6351"></a><span id="l9.6351">   // this happens when we go through libmime now as it sets our new content type</span>
<a href="#l9.6352"></a><span id="l9.6352" class="difflineminus">-  if (!mContentType.IsEmpty())</span>
<a href="#l9.6353"></a><span id="l9.6353" class="difflineminus">-  {</span>
<a href="#l9.6354"></a><span id="l9.6354" class="difflineplus">+  if (!mContentType.IsEmpty()) {</span>
<a href="#l9.6355"></a><span id="l9.6355">     aContentType = mContentType;</span>
<a href="#l9.6356"></a><span id="l9.6356">     return NS_OK;</span>
<a href="#l9.6357"></a><span id="l9.6357">   }</span>
<a href="#l9.6358"></a><span id="l9.6358"> </span>
<a href="#l9.6359"></a><span id="l9.6359">   // otherwise do what we did before...</span>
<a href="#l9.6360"></a><span id="l9.6360"> </span>
<a href="#l9.6361"></a><span id="l9.6361">   if (m_typeWanted == GROUP_WANTED)</span>
<a href="#l9.6362"></a><span id="l9.6362">     aContentType.AssignLiteral(&quot;x-application-newsgroup&quot;);</span>
<a href="#l9.6363"></a><span id="l9.6363">   else if (m_typeWanted == IDS_WANTED)</span>
<a href="#l9.6364"></a><span id="l9.6364">     aContentType.AssignLiteral(&quot;x-application-newsgroup-listids&quot;);</span>
<a href="#l9.6365"></a><span id="l9.6365">   else</span>
<a href="#l9.6366"></a><span id="l9.6366">     aContentType.AssignLiteral(&quot;message/rfc822&quot;);</span>
<a href="#l9.6367"></a><span id="l9.6367">   return NS_OK;</span>
<a href="#l9.6368"></a><span id="l9.6368"> }</span>
<a href="#l9.6369"></a><span id="l9.6369"> </span>
<a href="#l9.6370"></a><span id="l9.6370" class="difflineminus">-nsresult</span>
<a href="#l9.6371"></a><span id="l9.6371" class="difflineminus">-nsNNTPProtocol::AlertError(int32_t errorCode, const char *text)</span>
<a href="#l9.6372"></a><span id="l9.6372" class="difflineminus">-{</span>
<a href="#l9.6373"></a><span id="l9.6373" class="difflineplus">+nsresult nsNNTPProtocol::AlertError(int32_t errorCode, const char *text) {</span>
<a href="#l9.6374"></a><span id="l9.6374">   nsresult rv = NS_OK;</span>
<a href="#l9.6375"></a><span id="l9.6375"> </span>
<a href="#l9.6376"></a><span id="l9.6376">   // get the prompt from the running url....</span>
<a href="#l9.6377"></a><span id="l9.6377">   if (m_runningURL) {</span>
<a href="#l9.6378"></a><span id="l9.6378" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(m_runningURL));</span>
<a href="#l9.6379"></a><span id="l9.6379" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(m_runningURL));</span>
<a href="#l9.6380"></a><span id="l9.6380">     nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l9.6381"></a><span id="l9.6381">     rv = GetPromptDialogFromUrl(msgUrl, getter_AddRefs(dialog));</span>
<a href="#l9.6382"></a><span id="l9.6382">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.6383"></a><span id="l9.6383"> </span>
<a href="#l9.6384"></a><span id="l9.6384">     nsString alertText;</span>
<a href="#l9.6385"></a><span id="l9.6385">     rv = GetNewsStringByID(MK_NNTP_ERROR_MESSAGE, getter_Copies(alertText));</span>
<a href="#l9.6386"></a><span id="l9.6386" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.6387"></a><span id="l9.6387" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.6388"></a><span id="l9.6388">     if (text) {</span>
<a href="#l9.6389"></a><span id="l9.6389">       alertText.Append(' ');</span>
<a href="#l9.6390"></a><span id="l9.6390">       alertText.Append(NS_ConvertASCIItoUTF16(text));</span>
<a href="#l9.6391"></a><span id="l9.6391">     }</span>
<a href="#l9.6392"></a><span id="l9.6392">     rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l9.6393"></a><span id="l9.6393">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.6394"></a><span id="l9.6394">   }</span>
<a href="#l9.6395"></a><span id="l9.6395">   return rv;</span>
<a href="#l9.6396"></a><span id="l9.6396"> }</span>
<a href="#l9.6397"></a><span id="l9.6397"> </span>
<a href="#l9.6398"></a><span id="l9.6398" class="difflineminus">-NS_IMETHODIMP nsNNTPProtocol::GetCurrentFolder(nsIMsgFolder **aFolder)</span>
<a href="#l9.6399"></a><span id="l9.6399" class="difflineminus">-{</span>
<a href="#l9.6400"></a><span id="l9.6400" class="difflineplus">+NS_IMETHODIMP nsNNTPProtocol::GetCurrentFolder(nsIMsgFolder **aFolder) {</span>
<a href="#l9.6401"></a><span id="l9.6401">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l9.6402"></a><span id="l9.6402">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l9.6403"></a><span id="l9.6403">   if (m_newsFolder)</span>
<a href="#l9.6404"></a><span id="l9.6404" class="difflineminus">-    rv = m_newsFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder), (void **) aFolder);</span>
<a href="#l9.6405"></a><span id="l9.6405" class="difflineplus">+    rv = m_newsFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder),</span>
<a href="#l9.6406"></a><span id="l9.6406" class="difflineplus">+                                      (void **)aFolder);</span>
<a href="#l9.6407"></a><span id="l9.6407">   return rv;</span>
<a href="#l9.6408"></a><span id="l9.6408"> }</span>
<a href="#l9.6409"></a><span id="l9.6409" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -29,138 +29,142 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> // this is only needed as long as our libmime hack is in place</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;prio.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> // State Flags (Note, I use the word state in terms of storing</span>
<a href="#l10.9"></a><span id="l10.9"> // state information about the connection (authentication, have we sent</span>
<a href="#l10.10"></a><span id="l10.10"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#define NNTP_PAUSE_FOR_READ      0x00000001  /* should we pause for the next read */</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-#define NNTP_PROXY_AUTH_REQUIRED    0x00000002  /* is auth required */</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-#define NNTP_SENT_PROXY_AUTH        0x00000004  /* have we sent a proxy auth? */</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-#define NNTP_READER_PERFORMED       0x00000010  /* have we sent any cmds to the server yet? */</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-#define NNTP_USE_FANCY_NEWSGROUP    0x00000020  /* use LIST XACTIVE or LIST */</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-#define NNTP_DESTROY_PROGRESS_GRAPH 0x00000040  /* do we need to destroy graph progress */</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-#define NNTP_SOME_PROTOCOL_SUCCEEDED 0x0000080  /* some protocol has succeeded so don't kill the connection */</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-#define NNTP_NO_XOVER_SUPPORT       0x00000100  /* xover command is not supported here */</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+#define NNTP_PAUSE_FOR_READ 0x00000001 /* should we pause for the next read */</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+#define NNTP_PROXY_AUTH_REQUIRED 0x00000002 /* is auth required */</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+#define NNTP_SENT_PROXY_AUTH 0x00000004     /* have we sent a proxy auth? */</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+#define NNTP_READER_PERFORMED \</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  0x00000010 /* have we sent any cmds to the server yet? */</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+#define NNTP_USE_FANCY_NEWSGROUP 0x00000020 /* use LIST XACTIVE or LIST */</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+#define NNTP_DESTROY_PROGRESS_GRAPH \</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  0x00000040 /* do we need to destroy graph progress */</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+#define NNTP_SOME_PROTOCOL_SUCCEEDED \</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  0x0000080 /* some protocol has succeeded so don't kill the connection */</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+#define NNTP_NO_XOVER_SUPPORT \</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  0x00000100 /* xover command is not supported here */</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33"> /* states of the machine</span>
<a href="#l10.34"></a><span id="l10.34">  */</span>
<a href="#l10.35"></a><span id="l10.35"> typedef enum _StatesEnum {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-NNTP_RESPONSE,</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  NNTP_RESPONSE,</span>
<a href="#l10.38"></a><span id="l10.38"> #ifdef BLOCK_UNTIL_AVAILABLE_CONNECTION</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-NNTP_BLOCK_UNTIL_CONNECTIONS_ARE_AVAILABLE,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-NNTP_CONNECTIONS_ARE_AVAILABLE,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  NNTP_BLOCK_UNTIL_CONNECTIONS_ARE_AVAILABLE,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  NNTP_CONNECTIONS_ARE_AVAILABLE,</span>
<a href="#l10.43"></a><span id="l10.43"> #endif</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-NNTP_CONNECT,</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-NNTP_CONNECT_WAIT,</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-NNTP_LOGIN_RESPONSE,</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-NNTP_SEND_MODE_READER,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-NNTP_SEND_MODE_READER_RESPONSE,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-SEND_LIST_EXTENSIONS,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-SEND_LIST_EXTENSIONS_RESPONSE,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-SEND_LIST_SEARCHES,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-SEND_LIST_SEARCHES_RESPONSE,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-NNTP_LIST_SEARCH_HEADERS,</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-NNTP_LIST_SEARCH_HEADERS_RESPONSE,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-NNTP_GET_PROPERTIES,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-NNTP_GET_PROPERTIES_RESPONSE,</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-SEND_LIST_SUBSCRIPTIONS,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-SEND_LIST_SUBSCRIPTIONS_RESPONSE,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-SEND_FIRST_NNTP_COMMAND,</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-SEND_FIRST_NNTP_COMMAND_RESPONSE,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-SETUP_NEWS_STREAM,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-NNTP_BEGIN_AUTHORIZE,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-NNTP_AUTHORIZE_RESPONSE,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-NNTP_PASSWORD_RESPONSE,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-NNTP_READ_LIST_BEGIN,</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-NNTP_READ_LIST,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-DISPLAY_NEWSGROUPS,</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-NNTP_NEWGROUPS_BEGIN,</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-NNTP_NEWGROUPS,</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-NNTP_BEGIN_ARTICLE,</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-NNTP_READ_ARTICLE,</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-NNTP_XOVER_BEGIN,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-NNTP_FIGURE_NEXT_CHUNK,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-NNTP_XOVER_SEND,</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-NNTP_XOVER_RESPONSE,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-NNTP_XOVER,</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-NEWS_PROCESS_XOVER,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-NNTP_XHDR_SEND,</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-NNTP_XHDR_RESPONSE,</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-NNTP_READ_GROUP,</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-NNTP_READ_GROUP_RESPONSE,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-NNTP_READ_GROUP_BODY,</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-NNTP_SEND_GROUP_FOR_ARTICLE,</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE,</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-NNTP_SEND_ARTICLE_NUMBER,</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-NEWS_PROCESS_BODIES,</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-NNTP_PRINT_ARTICLE_HEADERS,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-NNTP_SEND_POST_DATA,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-NNTP_SEND_POST_DATA_RESPONSE,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-NNTP_CHECK_FOR_MESSAGE,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-NEWS_START_CANCEL,</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-NEWS_DO_CANCEL,</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-NNTP_XPAT_SEND,</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-NNTP_XPAT_RESPONSE,</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-NNTP_SEARCH,</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-NNTP_SEARCH_RESPONSE,</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-NNTP_SEARCH_RESULTS,</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-NNTP_LIST_PRETTY_NAMES,</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-NNTP_LIST_PRETTY_NAMES_RESPONSE,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-NNTP_LIST_XACTIVE,</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-NNTP_LIST_XACTIVE_RESPONSE,</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-NNTP_LIST_GROUP,</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-NNTP_LIST_GROUP_RESPONSE,</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-NEWS_DONE,</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-NEWS_POST_DONE,</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-NEWS_ERROR,</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-NNTP_ERROR,</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-NEWS_FREE,</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-NNTP_SUSPENDED</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+  NNTP_CONNECT,</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  NNTP_CONNECT_WAIT,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+  NNTP_LOGIN_RESPONSE,</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+  NNTP_SEND_MODE_READER,</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  NNTP_SEND_MODE_READER_RESPONSE,</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+  SEND_LIST_EXTENSIONS,</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+  SEND_LIST_EXTENSIONS_RESPONSE,</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+  SEND_LIST_SEARCHES,</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+  SEND_LIST_SEARCHES_RESPONSE,</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  NNTP_LIST_SEARCH_HEADERS,</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  NNTP_LIST_SEARCH_HEADERS_RESPONSE,</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+  NNTP_GET_PROPERTIES,</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+  NNTP_GET_PROPERTIES_RESPONSE,</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+  SEND_LIST_SUBSCRIPTIONS,</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+  SEND_LIST_SUBSCRIPTIONS_RESPONSE,</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+  SEND_FIRST_NNTP_COMMAND,</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+  SEND_FIRST_NNTP_COMMAND_RESPONSE,</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  SETUP_NEWS_STREAM,</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+  NNTP_BEGIN_AUTHORIZE,</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+  NNTP_AUTHORIZE_RESPONSE,</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  NNTP_PASSWORD_RESPONSE,</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  NNTP_READ_LIST_BEGIN,</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  NNTP_READ_LIST,</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  DISPLAY_NEWSGROUPS,</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+  NNTP_NEWGROUPS_BEGIN,</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  NNTP_NEWGROUPS,</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  NNTP_BEGIN_ARTICLE,</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  NNTP_READ_ARTICLE,</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+  NNTP_XOVER_BEGIN,</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  NNTP_FIGURE_NEXT_CHUNK,</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  NNTP_XOVER_SEND,</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+  NNTP_XOVER_RESPONSE,</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+  NNTP_XOVER,</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+  NEWS_PROCESS_XOVER,</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+  NNTP_XHDR_SEND,</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+  NNTP_XHDR_RESPONSE,</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+  NNTP_READ_GROUP,</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  NNTP_READ_GROUP_RESPONSE,</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  NNTP_READ_GROUP_BODY,</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+  NNTP_SEND_GROUP_FOR_ARTICLE,</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+  NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE,</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+  NNTP_SEND_ARTICLE_NUMBER,</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+  NEWS_PROCESS_BODIES,</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+  NNTP_PRINT_ARTICLE_HEADERS,</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+  NNTP_SEND_POST_DATA,</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+  NNTP_SEND_POST_DATA_RESPONSE,</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+  NNTP_CHECK_FOR_MESSAGE,</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+  NEWS_START_CANCEL,</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+  NEWS_DO_CANCEL,</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+  NNTP_XPAT_SEND,</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+  NNTP_XPAT_RESPONSE,</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+  NNTP_SEARCH,</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+  NNTP_SEARCH_RESPONSE,</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+  NNTP_SEARCH_RESULTS,</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+  NNTP_LIST_PRETTY_NAMES,</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+  NNTP_LIST_PRETTY_NAMES_RESPONSE,</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+  NNTP_LIST_XACTIVE,</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+  NNTP_LIST_XACTIVE_RESPONSE,</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+  NNTP_LIST_GROUP,</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+  NNTP_LIST_GROUP_RESPONSE,</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+  NEWS_DONE,</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+  NEWS_POST_DONE,</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  NEWS_ERROR,</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  NNTP_ERROR,</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+  NEWS_FREE,</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+  NNTP_SUSPENDED</span>
<a href="#l10.176"></a><span id="l10.176"> } StatesEnum;</span>
<a href="#l10.177"></a><span id="l10.177"> </span>
<a href="#l10.178"></a><span id="l10.178"> class nsICacheEntry;</span>
<a href="#l10.179"></a><span id="l10.179"> </span>
<a href="#l10.180"></a><span id="l10.180"> class nsNNTPProtocol : public nsMsgProtocol,</span>
<a href="#l10.181"></a><span id="l10.181">                        public nsINNTPProtocol,</span>
<a href="#l10.182"></a><span id="l10.182">                        public nsITimerCallback,</span>
<a href="#l10.183"></a><span id="l10.183">                        public nsICacheEntryOpenCallback,</span>
<a href="#l10.184"></a><span id="l10.184">                        public nsIMsgAsyncPromptListener,</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-                       public nsIProtocolProxyCallback</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-{</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-public:</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+                       public nsIProtocolProxyCallback {</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+ public:</span>
<a href="#l10.190"></a><span id="l10.190">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l10.191"></a><span id="l10.191">   NS_DECL_NSINNTPPROTOCOL</span>
<a href="#l10.192"></a><span id="l10.192">   NS_DECL_NSICACHEENTRYOPENCALLBACK</span>
<a href="#l10.193"></a><span id="l10.193">   NS_DECL_NSITIMERCALLBACK</span>
<a href="#l10.194"></a><span id="l10.194">   NS_DECL_NSIMSGASYNCPROMPTLISTENER</span>
<a href="#l10.195"></a><span id="l10.195">   NS_DECL_NSIPROTOCOLPROXYCALLBACK</span>
<a href="#l10.196"></a><span id="l10.196"> </span>
<a href="#l10.197"></a><span id="l10.197">   // Creating a protocol instance requires the URL</span>
<a href="#l10.198"></a><span id="l10.198">   // need to call Initialize after we do a new of nsNNTPProtocol</span>
<a href="#l10.199"></a><span id="l10.199">   nsNNTPProtocol(nsINntpIncomingServer *aServer, nsIURI *aURL,</span>
<a href="#l10.200"></a><span id="l10.200">                  nsIMsgWindow *aMsgWindow);</span>
<a href="#l10.201"></a><span id="l10.201"> </span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-  // stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  // stop binding is a &quot;notification&quot; informing us that the stream associated</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+  // with aURL is going away.</span>
<a href="#l10.205"></a><span id="l10.205">   NS_IMETHOD OnStopRequest(nsIRequest *request, nsresult aStatus) override;</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-  char * m_ProxyServer;    /* proxy server hostname */</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+  char *m_ProxyServer; /* proxy server hostname */</span>
<a href="#l10.209"></a><span id="l10.209"> </span>
<a href="#l10.210"></a><span id="l10.210">   NS_IMETHOD Cancel(nsresult status) override;  // handle stop button</span>
<a href="#l10.211"></a><span id="l10.211">   NS_IMETHOD GetContentType(nsACString &amp;aContentType) override;</span>
<a href="#l10.212"></a><span id="l10.212">   NS_IMETHOD AsyncOpen(nsIStreamListener *listener) override;</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-  NS_IMETHOD GetOriginalURI(nsIURI* *aURI) override;</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-  NS_IMETHOD SetOriginalURI(nsIURI* aURI) override;</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+  NS_IMETHOD GetOriginalURI(nsIURI **aURI) override;</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+  NS_IMETHOD SetOriginalURI(nsIURI *aURI) override;</span>
<a href="#l10.217"></a><span id="l10.217">   void PostLoadAssertions();</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-  nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer) override;</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+  nsresult LoadUrl(nsIURI *aURL, nsISupports *aConsumer) override;</span>
<a href="#l10.221"></a><span id="l10.221"> </span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-private:</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+ private:</span>
<a href="#l10.224"></a><span id="l10.224">   virtual ~nsNNTPProtocol();</span>
<a href="#l10.225"></a><span id="l10.225">   /**</span>
<a href="#l10.226"></a><span id="l10.226">    * Triggers the protocol state machine.</span>
<a href="#l10.227"></a><span id="l10.227">    * Most of the time, this machine will read as much input as it can before</span>
<a href="#l10.228"></a><span id="l10.228">    * closing.</span>
<a href="#l10.229"></a><span id="l10.229">    *</span>
<a href="#l10.230"></a><span id="l10.230">    * This method additionally handles some states not covered by other methods:</span>
<a href="#l10.231"></a><span id="l10.231">    * NEWS_DONE: Alias for NEWS_FREE</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineat">@@ -170,138 +174,151 @@ private:</span>
<a href="#l10.233"></a><span id="l10.233">    * NEWS_FREE: Cleans up from the current URL and prepares for the next one</span>
<a href="#l10.234"></a><span id="l10.234">    * NNTP_SUSPENDED: A state where the state machine does not read input until</span>
<a href="#l10.235"></a><span id="l10.235">    *                 re-enabled by a non-network related callback</span>
<a href="#l10.236"></a><span id="l10.236">    *</span>
<a href="#l10.237"></a><span id="l10.237">    * @note Use of NNTP_SUSPENDED is dangerous: if input comes along the socket,</span>
<a href="#l10.238"></a><span id="l10.238">    * the code will not read the input stream at all. Therefore, it is strongly</span>
<a href="#l10.239"></a><span id="l10.239">    * advised to suspend the request before using this state.</span>
<a href="#l10.240"></a><span id="l10.240">    */</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-  virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-                                        uint64_t sourceOffset, uint32_t length) override;</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+  virtual nsresult ProcessProtocolState(nsIURI *url,</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+                                        nsIInputStream *inputStream,</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+                                        uint64_t sourceOffset,</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+                                        uint32_t length) override;</span>
<a href="#l10.247"></a><span id="l10.247">   virtual nsresult CloseSocket() override;</span>
<a href="#l10.248"></a><span id="l10.248"> </span>
<a href="#l10.249"></a><span id="l10.249">   // we have our own implementation of SendData which writes to the nntp log</span>
<a href="#l10.250"></a><span id="l10.250">   // and then calls the base class to transmit the data</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-  nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false) override;</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+  nsresult SendData(const char *dataBuffer,</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+                    bool aSuppressLogging = false) override;</span>
<a href="#l10.254"></a><span id="l10.254"> </span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-  nsresult LoadUrlInternal(nsIProxyInfo* aProxyInfo);</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+  nsresult LoadUrlInternal(nsIProxyInfo *aProxyInfo);</span>
<a href="#l10.257"></a><span id="l10.257">   nsresult CleanupAfterRunningUrl();</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-  void Cleanup(); //free char* member variables</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+  void Cleanup();  // free char* member variables</span>
<a href="#l10.260"></a><span id="l10.260"> </span>
<a href="#l10.261"></a><span id="l10.261">   void ParseHeaderForCancel(char *buf);</span>
<a href="#l10.262"></a><span id="l10.262"> </span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-  virtual const char* GetType() override { return &quot;nntp&quot;; }</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+  virtual const char *GetType() override { return &quot;nntp&quot;; }</span>
<a href="#l10.265"></a><span id="l10.265"> </span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-  static void CheckIfAuthor(nsIMsgIdentity *aIdentity, const nsCString &amp;aOldFrom, nsCString &amp;aFrom);</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+  static void CheckIfAuthor(nsIMsgIdentity *aIdentity,</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+                            const nsCString &amp;aOldFrom, nsCString &amp;aFrom);</span>
<a href="#l10.269"></a><span id="l10.269"> </span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-  nsCOMPtr &lt;nsINNTPNewsgroupList&gt; m_newsgroupList;</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-  nsCOMPtr &lt;nsINNTPArticleList&gt; m_articleList;</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+  nsCOMPtr&lt;nsINNTPNewsgroupList&gt; m_newsgroupList;</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+  nsCOMPtr&lt;nsINNTPArticleList&gt; m_articleList;</span>
<a href="#l10.274"></a><span id="l10.274"> </span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-  nsCOMPtr &lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l10.279"></a><span id="l10.279"> </span>
<a href="#l10.280"></a><span id="l10.280">   nsCOMPtr&lt;nsIAsyncInputStream&gt; mDisplayInputStream;</span>
<a href="#l10.281"></a><span id="l10.281">   nsCOMPtr&lt;nsIAsyncOutputStream&gt; mDisplayOutputStream;</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-  RefPtr&lt;nsMsgLineStreamBuffer&gt; m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+  RefPtr&lt;nsMsgLineStreamBuffer&gt;</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+      m_lineStreamBuffer;  // used to efficiently extract lines from the</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+                           // incoming data stream</span>
<a href="#l10.286"></a><span id="l10.286">   // the nsINntpURL that is currently running</span>
<a href="#l10.287"></a><span id="l10.287">   nsCOMPtr&lt;nsINntpUrl&gt; m_runningURL;</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-  bool        m_connectionBusy;</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-  bool        m_fromCache;  // is this connection from the cache?</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-  PRTime      m_lastActiveTimeStamp;</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  bool m_connectionBusy;</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+  bool m_fromCache;  // is this connection from the cache?</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+  PRTime m_lastActiveTimeStamp;</span>
<a href="#l10.294"></a><span id="l10.294">   nsNewsAction m_newsAction;</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; m_consumer;</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; m_consumer;</span>
<a href="#l10.297"></a><span id="l10.297"> </span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-  // Generic state information -- What state are we in? What state do we want to go to</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-  // after the next response? What was the last response code? etc.</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-  StatesEnum  m_nextState;</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-  StatesEnum  m_nextStateAfterResponse;</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-  int32_t     m_typeWanted;     /* Article, List, or Group */</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-  int32_t     m_responseCode;    /* code returned from NNTP server */</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-  int32_t   m_previousResponseCode;</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-  char       *m_responseText;   /* text returned from NNTP server */</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+  // Generic state information -- What state are we in? What state do we want to</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+  // go to after the next response? What was the last response code? etc.</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+  StatesEnum m_nextState;</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+  StatesEnum m_nextStateAfterResponse;</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+  int32_t m_typeWanted;   /* Article, List, or Group */</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+  int32_t m_responseCode; /* code returned from NNTP server */</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+  int32_t m_previousResponseCode;</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+  char *m_responseText; /* text returned from NNTP server */</span>
<a href="#l10.314"></a><span id="l10.314"> </span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-  char    *m_dataBuf;</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-  uint32_t   m_dataBufSize;</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+  char *m_dataBuf;</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+  uint32_t m_dataBufSize;</span>
<a href="#l10.319"></a><span id="l10.319"> </span>
<a href="#l10.320"></a><span id="l10.320">   /* for group command */</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-  nsCString m_currentGroup;     /* current group */</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+  nsCString m_currentGroup; /* current group */</span>
<a href="#l10.323"></a><span id="l10.323"> </span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-  int32_t   m_firstArticle;</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-  int32_t   m_lastArticle;</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-  int32_t   m_firstPossibleArticle;</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-  int32_t   m_lastPossibleArticle;</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+  int32_t m_firstArticle;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+  int32_t m_lastArticle;</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+  int32_t m_firstPossibleArticle;</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+  int32_t m_lastPossibleArticle;</span>
<a href="#l10.332"></a><span id="l10.332"> </span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-  int32_t    m_numArticlesLoaded;  /* How many articles we got XOVER lines for. */</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-  int32_t    m_numArticlesWanted; /* How many articles we wanted to get XOVER lines for. */</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-  int32_t   m_maxArticles;        /* max articles to get during an XOVER */</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+  int32_t m_numArticlesLoaded; /* How many articles we got XOVER lines for. */</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+  int32_t m_numArticlesWanted; /* How many articles we wanted to get XOVER lines</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+                                  for. */</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+  int32_t m_maxArticles;       /* max articles to get during an XOVER */</span>
<a href="#l10.340"></a><span id="l10.340"> </span>
<a href="#l10.341"></a><span id="l10.341">   // Cancelation specific state. In particular, the headers that should be</span>
<a href="#l10.342"></a><span id="l10.342">   // used for the cancelation message.</span>
<a href="#l10.343"></a><span id="l10.343">   nsCString m_cancelFromHdr;</span>
<a href="#l10.344"></a><span id="l10.344">   nsCString m_cancelNewsgroups;</span>
<a href="#l10.345"></a><span id="l10.345">   nsCString m_cancelDistribution;</span>
<a href="#l10.346"></a><span id="l10.346">   nsCString m_cancelID;</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-  int32_t    m_cancelStatus;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+  int32_t m_cancelStatus;</span>
<a href="#l10.349"></a><span id="l10.349"> </span>
<a href="#l10.350"></a><span id="l10.350">   // variable for ReadNewsList</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-  int32_t   m_readNewsListCount;</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+  int32_t m_readNewsListCount;</span>
<a href="#l10.353"></a><span id="l10.353"> </span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-  // Per news article state information. (article number, author, subject, id, etc</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+  // Per news article state information. (article number, author, subject, id,</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+  // etc</span>
<a href="#l10.357"></a><span id="l10.357">   nsCString m_messageID;</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-  int32_t   m_articleNumber;   /* current article number */</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+  int32_t m_articleNumber; /* current article number */</span>
<a href="#l10.360"></a><span id="l10.360">   nsCString m_searchData;</span>
<a href="#l10.361"></a><span id="l10.361"> </span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-  int32_t   m_originalContentLength; /* the content length at the time of calling graph progress */</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+  int32_t m_originalContentLength; /* the content length at the time of calling</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+                                      graph progress */</span>
<a href="#l10.365"></a><span id="l10.365"> </span>
<a href="#l10.366"></a><span id="l10.366">   nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l10.367"></a><span id="l10.367"> </span>
<a href="#l10.368"></a><span id="l10.368">   nsCOMPtr&lt;nsINntpIncomingServer&gt; m_nntpServer;</span>
<a href="#l10.369"></a><span id="l10.369"> </span>
<a href="#l10.370"></a><span id="l10.370">   nsresult GetNewsStringByName(const char *aName, char16_t **aString);</span>
<a href="#l10.371"></a><span id="l10.371">   nsresult GetNewsStringByID(int32_t stringID, char16_t **aString);</span>
<a href="#l10.372"></a><span id="l10.372"> </span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-  nsresult PostMessageInFile(nsIFile * filePath);</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+  nsresult PostMessageInFile(nsIFile *filePath);</span>
<a href="#l10.375"></a><span id="l10.375"> </span>
<a href="#l10.376"></a><span id="l10.376">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.377"></a><span id="l10.377">   // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l10.378"></a><span id="l10.378">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.379"></a><span id="l10.379"> </span>
<a href="#l10.380"></a><span id="l10.380" class="difflineminus">-  int32_t ReadLine(nsIInputStream * inputStream, uint32_t length, char ** line);</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+  int32_t ReadLine(nsIInputStream *inputStream, uint32_t length, char **line);</span>
<a href="#l10.382"></a><span id="l10.382"> </span>
<a href="#l10.383"></a><span id="l10.383">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.384"></a><span id="l10.384">   // Protocol Methods --&gt; This protocol is state driven so each protocol method</span>
<a href="#l10.385"></a><span id="l10.385">   //            is designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l10.386"></a><span id="l10.386">   //            group them together based on functionality.</span>
<a href="#l10.387"></a><span id="l10.387">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.388"></a><span id="l10.388"> </span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-  // gets the response code from the nntp server and the response line. Returns the TCP return code</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-  // from the read.</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+  // gets the response code from the nntp server and the response line. Returns</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+  // the TCP return code from the read.</span>
<a href="#l10.393"></a><span id="l10.393">   nsresult NewsResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.394"></a><span id="l10.394"> </span>
<a href="#l10.395"></a><span id="l10.395">   // Interpret the server response after the connect.</span>
<a href="#l10.396"></a><span id="l10.396">   // Returns negative if the server responds unexpectedly</span>
<a href="#l10.397"></a><span id="l10.397">   nsresult LoginResponse();</span>
<a href="#l10.398"></a><span id="l10.398">   nsresult SendModeReader();</span>
<a href="#l10.399"></a><span id="l10.399">   nsresult SendModeReaderResponse();</span>
<a href="#l10.400"></a><span id="l10.400"> </span>
<a href="#l10.401"></a><span id="l10.401">   nsresult SendListExtensions();</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-  nsresult SendListExtensionsResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+  nsresult SendListExtensionsResponse(nsIInputStream *inputStream,</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+                                      uint32_t length);</span>
<a href="#l10.405"></a><span id="l10.405"> </span>
<a href="#l10.406"></a><span id="l10.406">   nsresult SendListSearches();</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-  nsresult SendListSearchesResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+  nsresult SendListSearchesResponse(nsIInputStream *inputStream,</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+                                    uint32_t length);</span>
<a href="#l10.410"></a><span id="l10.410"> </span>
<a href="#l10.411"></a><span id="l10.411">   nsresult SendListSearchHeaders();</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-  nsresult SendListSearchHeadersResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+  nsresult SendListSearchHeadersResponse(nsIInputStream *inputStream,</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+                                         uint32_t length);</span>
<a href="#l10.415"></a><span id="l10.415"> </span>
<a href="#l10.416"></a><span id="l10.416">   nsresult GetProperties();</span>
<a href="#l10.417"></a><span id="l10.417">   nsresult GetPropertiesResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.418"></a><span id="l10.418"> </span>
<a href="#l10.419"></a><span id="l10.419">   nsresult SendListSubscriptions();</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-  nsresult SendListSubscriptionsResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+  nsresult SendListSubscriptionsResponse(nsIInputStream *inputStream,</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+                                         uint32_t length);</span>
<a href="#l10.423"></a><span id="l10.423"> </span>
<a href="#l10.424"></a><span id="l10.424">   // Figure out what the first command is and send it.</span>
<a href="#l10.425"></a><span id="l10.425">   // Returns the status from the NETWrite.</span>
<a href="#l10.426"></a><span id="l10.426">   nsresult SendFirstNNTPCommand(nsIURI *url);</span>
<a href="#l10.427"></a><span id="l10.427"> </span>
<a href="#l10.428"></a><span id="l10.428">   // Interprets the server response from the first command sent.</span>
<a href="#l10.429"></a><span id="l10.429">   // returns negative if the server responds unexpectedly.</span>
<a href="#l10.430"></a><span id="l10.430">   nsresult SendFirstNNTPCommandResponse();</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineat">@@ -448,27 +465,26 @@ private:</span>
<a href="#l10.432"></a><span id="l10.432">   /**</span>
<a href="#l10.433"></a><span id="l10.433">    * This state, NNTP_PROCESS_XOVER, is the final step of the filter-processing</span>
<a href="#l10.434"></a><span id="l10.434">    * code. Currently, all it does is cleans up the unread count and calls the</span>
<a href="#l10.435"></a><span id="l10.435">    * filters, both via nsNNTPNewsgroupList.</span>
<a href="#l10.436"></a><span id="l10.436">    * Followed by: NEWS_DONE</span>
<a href="#l10.437"></a><span id="l10.437">    */</span>
<a href="#l10.438"></a><span id="l10.438">   nsresult ProcessXover();</span>
<a href="#l10.439"></a><span id="l10.439"> </span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineminus">-</span>
<a href="#l10.442"></a><span id="l10.442">   // Canceling</span>
<a href="#l10.443"></a><span id="l10.443">   nsresult StartCancel();</span>
<a href="#l10.444"></a><span id="l10.444">   nsresult DoCancel();</span>
<a href="#l10.445"></a><span id="l10.445"> </span>
<a href="#l10.446"></a><span id="l10.446">   // XPAT</span>
<a href="#l10.447"></a><span id="l10.447">   nsresult XPATSend();</span>
<a href="#l10.448"></a><span id="l10.448">   nsresult XPATResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.449"></a><span id="l10.449">   nsresult ListPrettyNames();</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-  nsresult ListPrettyNamesResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+  nsresult ListPrettyNamesResponse(nsIInputStream *inputStream,</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineplus">+                                   uint32_t length);</span>
<a href="#l10.453"></a><span id="l10.453"> </span>
<a href="#l10.454"></a><span id="l10.454">   nsresult ListXActive();</span>
<a href="#l10.455"></a><span id="l10.455">   nsresult ListXActiveResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.456"></a><span id="l10.456"> </span>
<a href="#l10.457"></a><span id="l10.457">   // for &quot;?list-ids&quot;</span>
<a href="#l10.458"></a><span id="l10.458">   nsresult SendListGroup();</span>
<a href="#l10.459"></a><span id="l10.459">   nsresult SendListGroupResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l10.460"></a><span id="l10.460"> </span>
<a href="#l10.461"></a><span id="l10.461" class="difflineat">@@ -484,31 +500,36 @@ private:</span>
<a href="#l10.462"></a><span id="l10.462">   nsresult ParseURL(nsIURI *aURL, nsCString &amp;aGroup, nsCString &amp;aMessageID);</span>
<a href="#l10.463"></a><span id="l10.463"> </span>
<a href="#l10.464"></a><span id="l10.464">   void SetProgressBarPercent(uint32_t aProgress, uint32_t aProgressMax);</span>
<a href="#l10.465"></a><span id="l10.465">   nsresult SetProgressStatus(const char16_t *aMessage);</span>
<a href="#l10.466"></a><span id="l10.466">   nsresult InitializeNewsFolderFromUri(const char *uri);</span>
<a href="#l10.467"></a><span id="l10.467">   void TimerCallback();</span>
<a href="#l10.468"></a><span id="l10.468"> </span>
<a href="#l10.469"></a><span id="l10.469">   void HandleAuthenticationFailure();</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; mInputStream;</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-  nsCOMPtr &lt;nsITimer&gt; mUpdateTimer;</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; mInputStream;</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+  nsCOMPtr&lt;nsITimer&gt; mUpdateTimer;</span>
<a href="#l10.474"></a><span id="l10.474">   nsresult AlertError(int32_t errorCode, const char *text);</span>
<a href="#l10.475"></a><span id="l10.475">   int32_t mBytesReceived;</span>
<a href="#l10.476"></a><span id="l10.476">   int32_t mBytesReceivedSinceLastStatusUpdate;</span>
<a href="#l10.477"></a><span id="l10.477">   PRTime m_startTime;</span>
<a href="#l10.478"></a><span id="l10.478">   int32_t mNumGroupsListed;</span>
<a href="#l10.479"></a><span id="l10.479">   nsMsgKey m_key;</span>
<a href="#l10.480"></a><span id="l10.480"> </span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-  nsresult SetCurrentGroup(); /* sets m_currentGroup.  should be called after doing a successful GROUP command */</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-  nsresult CleanupNewsgroupList(); /* cleans up m_newsgroupList, and set it to null */</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineplus">+  nsresult SetCurrentGroup(); /* sets m_currentGroup.  should be called after</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+                                 doing a successful GROUP command */</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+  nsresult</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+  CleanupNewsgroupList(); /* cleans up m_newsgroupList, and set it to null */</span>
<a href="#l10.487"></a><span id="l10.487"> </span>
<a href="#l10.488"></a><span id="l10.488">   // cache related helper methods</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-  void FinishMemCacheEntry(bool valid); // either mark it valid, or doom it</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineminus">-  nsresult OpenCacheEntry(); // makes a request to the cache service for a cache entry for a url</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineminus">-  bool ReadFromLocalCache(); // attempts to read the url out of our local (offline) cache....</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineminus">-  nsresult ReadFromNewsConnection(); // creates a new news connection to read the url</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineminus">-  nsresult ReadFromMemCache(nsICacheEntry *entry); // attempts to read the url out of our memory cache</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-  nsresult SetupPartExtractorListener(nsIStreamListener * aConsumer);</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+  void FinishMemCacheEntry(bool valid);  // either mark it valid, or doom it</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineplus">+  nsresult OpenCacheEntry();  // makes a request to the cache service for a</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+                              // cache entry for a url</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+  bool ReadFromLocalCache();  // attempts to read the url out of our local</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+                              // (offline) cache....</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+  nsresult</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+  ReadFromNewsConnection();  // creates a new news connection to read the url</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+  nsresult ReadFromMemCache(nsICacheEntry *entry);  // attempts to read the url</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineplus">+                                                    // out of our memory cache</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineplus">+  nsresult SetupPartExtractorListener(nsIStreamListener *aConsumer);</span>
<a href="#l10.505"></a><span id="l10.505"> };</span>
<a href="#l10.506"></a><span id="l10.506"> </span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-</span>
<a href="#l10.508"></a><span id="l10.508"> #endif  // nsNNTPProtocol_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloadDialogArgs.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloadDialogArgs.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,91 +1,79 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsNewsDownloadDialogArgs.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-nsNewsDownloadDialogArgs::nsNewsDownloadDialogArgs()</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-{</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    mArticleCount = 0;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-    mServerKey = &quot;&quot;;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    mHitOK = false;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-    mDownloadAll = false;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+nsNewsDownloadDialogArgs::nsNewsDownloadDialogArgs() {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  mArticleCount = 0;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  mServerKey = &quot;&quot;;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  mHitOK = false;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+  mDownloadAll = false;</span>
<a href="#l11.22"></a><span id="l11.22"> }</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-nsNewsDownloadDialogArgs::~nsNewsDownloadDialogArgs()</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-{</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-}</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+nsNewsDownloadDialogArgs::~nsNewsDownloadDialogArgs() {}</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29"> NS_IMPL_ISUPPORTS(nsNewsDownloadDialogArgs, nsINewsDownloadDialogArgs)</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::GetGroupName(nsAString &amp; aGroupName)</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">- {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-    aGroupName = mGroupName;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::GetGroupName(nsAString &amp;aGroupName) {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  aGroupName = mGroupName;</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">- }</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::SetGroupName(const nsAString &amp; aGroupName)</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">- {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+}</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::SetGroupName(</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    const nsAString &amp;aGroupName) {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  mGroupName = aGroupName;</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-     mGroupName = aGroupName;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-     return NS_OK;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">- }</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::GetArticleCount(int32_t *aArticleCount)</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-{</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aArticleCount);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+}</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::GetArticleCount(</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+    int32_t *aArticleCount) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aArticleCount);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    *aArticleCount = mArticleCount;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  *aArticleCount = mArticleCount;</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.65"></a><span id="l11.65"> }</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::SetArticleCount(int32_t aArticleCount)</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-{</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    mArticleCount = aArticleCount;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::SetArticleCount(int32_t aArticleCount) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  mArticleCount = aArticleCount;</span>
<a href="#l11.71"></a><span id="l11.71"> </span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.74"></a><span id="l11.74"> }</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::GetServerKey(char * *aServerKey)</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-{</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aServerKey);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::GetServerKey(char **aServerKey) {</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServerKey);</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    *aServerKey = ToNewCString(mServerKey);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  *aServerKey = ToNewCString(mServerKey);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.85"></a><span id="l11.85"> }</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::SetServerKey(const char * aServerKey)</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-{</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aServerKey);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::SetServerKey(const char *aServerKey) {</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServerKey);</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-    mServerKey = aServerKey;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  mServerKey = aServerKey;</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.97"></a><span id="l11.97"> }</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::GetHitOK(bool *aHitOK)</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-{</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aHitOK);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::GetHitOK(bool *aHitOK) {</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHitOK);</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    *aHitOK = mHitOK;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  *aHitOK = mHitOK;</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.109"></a><span id="l11.109"> }</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::SetHitOK(bool aHitOK)</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-{</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-    mHitOK = aHitOK;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::SetHitOK(bool aHitOK) {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  mHitOK = aHitOK;</span>
<a href="#l11.115"></a><span id="l11.115"> </span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.118"></a><span id="l11.118"> }</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::GetDownloadAll(bool *aDownloadAll)</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-{</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDownloadAll);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::GetDownloadAll(bool *aDownloadAll) {</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDownloadAll);</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-    *aDownloadAll = mDownloadAll;</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+  *aDownloadAll = mDownloadAll;</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.130"></a><span id="l11.130"> }</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-NS_IMETHODIMP nsNewsDownloadDialogArgs::SetDownloadAll(bool aDownloadAll)</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-{</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-    mDownloadAll = aDownloadAll;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+NS_IMETHODIMP nsNewsDownloadDialogArgs::SetDownloadAll(bool aDownloadAll) {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  mDownloadAll = aDownloadAll;</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.139"></a><span id="l11.139"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloadDialogArgs.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloadDialogArgs.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -4,27 +4,26 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> #ifndef nsNewsDownloadDialogArgs_h__</span>
<a href="#l12.7"></a><span id="l12.7"> #define nsNewsDownloadDialogArgs_h__</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsINewsDownloadDialogArgs.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsString.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-class nsNewsDownloadDialogArgs : public nsINewsDownloadDialogArgs</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-public:</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+class nsNewsDownloadDialogArgs : public nsINewsDownloadDialogArgs {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ public:</span>
<a href="#l12.17"></a><span id="l12.17">   nsNewsDownloadDialogArgs();</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   NS_DECL_ISUPPORTS</span>
<a href="#l12.20"></a><span id="l12.20">   NS_DECL_NSINEWSDOWNLOADDIALOGARGS</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-private:</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ private:</span>
<a href="#l12.24"></a><span id="l12.24">   virtual ~nsNewsDownloadDialogArgs();</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">   nsString mGroupName;</span>
<a href="#l12.27"></a><span id="l12.27">   int32_t mArticleCount;</span>
<a href="#l12.28"></a><span id="l12.28">   nsCString mServerKey;</span>
<a href="#l12.29"></a><span id="l12.29">   bool mHitOK;</span>
<a href="#l12.30"></a><span id="l12.30">   bool mDownloadAll;</span>
<a href="#l12.31"></a><span id="l12.31"> };</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-#endif // nsNewsDownloadDialogArgs_h__</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+#endif  // nsNewsDownloadDialogArgs_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -20,559 +20,490 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> // This file contains the news article download state machine.</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-// if pIds is not null, download the articles whose id's are passed in. Otherwise,</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-// which articles to download is determined by nsNewsDownloader object,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-// or subclasses thereof. News can download marked objects, for example.</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-nsresult nsNewsDownloader::DownloadArticles(nsIMsgWindow *window, nsIMsgFolder *folder, nsTArray&lt;nsMsgKey&gt; *pIds)</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-{</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+// if pIds is not null, download the articles whose id's are passed in.</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+// Otherwise, which articles to download is determined by nsNewsDownloader</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+// object, or subclasses thereof. News can download marked objects, for example.</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+nsresult nsNewsDownloader::DownloadArticles(nsIMsgWindow *window,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+                                            nsIMsgFolder *folder,</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+                                            nsTArray&lt;nsMsgKey&gt; *pIds) {</span>
<a href="#l13.23"></a><span id="l13.23">   if (pIds != nullptr)</span>
<a href="#l13.24"></a><span id="l13.24">     m_keysToDownload.InsertElementsAt(0, pIds-&gt;Elements(), pIds-&gt;Length());</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  if (!m_keysToDownload.IsEmpty())</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    m_downloadFromKeys = true;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  if (!m_keysToDownload.IsEmpty()) m_downloadFromKeys = true;</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   m_folder = folder;</span>
<a href="#l13.31"></a><span id="l13.31">   m_window = window;</span>
<a href="#l13.32"></a><span id="l13.32">   m_numwrote = 0;</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">   bool headersToDownload = GetNextHdrToRetrieve();</span>
<a href="#l13.35"></a><span id="l13.35">   // should we have a special error code for failure here?</span>
<a href="#l13.36"></a><span id="l13.36">   return (headersToDownload) ? DownloadNext(true) : NS_ERROR_FAILURE;</span>
<a href="#l13.37"></a><span id="l13.37"> }</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39"> /* Saving news messages</span>
<a href="#l13.40"></a><span id="l13.40">  */</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42"> NS_IMPL_ISUPPORTS(nsNewsDownloader, nsIUrlListener, nsIMsgSearchNotify)</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-nsNewsDownloader::nsNewsDownloader(nsIMsgWindow *window, nsIMsgDatabase *msgDB, nsIUrlListener *listener)</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-{</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+nsNewsDownloader::nsNewsDownloader(nsIMsgWindow *window, nsIMsgDatabase *msgDB,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+                                   nsIUrlListener *listener) {</span>
<a href="#l13.48"></a><span id="l13.48">   m_numwrote = 0;</span>
<a href="#l13.49"></a><span id="l13.49">   m_downloadFromKeys = false;</span>
<a href="#l13.50"></a><span id="l13.50">   m_newsDB = msgDB;</span>
<a href="#l13.51"></a><span id="l13.51">   m_abort = false;</span>
<a href="#l13.52"></a><span id="l13.52">   m_listener = listener;</span>
<a href="#l13.53"></a><span id="l13.53">   m_window = window;</span>
<a href="#l13.54"></a><span id="l13.54">   m_lastPercent = -1;</span>
<a href="#l13.55"></a><span id="l13.55">   m_lastProgressTime = 0;</span>
<a href="#l13.56"></a><span id="l13.56">   // not the perfect place for this, but I think it will work.</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  if (m_window)</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    m_window-&gt;SetStopped(false);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  if (m_window) m_window-&gt;SetStopped(false);</span>
<a href="#l13.60"></a><span id="l13.60"> }</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-nsNewsDownloader::~nsNewsDownloader()</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-{</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+nsNewsDownloader::~nsNewsDownloader() {</span>
<a href="#l13.65"></a><span id="l13.65">   if (m_listener)</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-    m_listener-&gt;OnStopRunningUrl(/* don't have a url */nullptr, m_status);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-  if (m_newsDB)</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-  {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    m_listener-&gt;OnStopRunningUrl(/* don't have a url */ nullptr, m_status);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  if (m_newsDB) {</span>
<a href="#l13.71"></a><span id="l13.71">     m_newsDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l13.72"></a><span id="l13.72">     m_newsDB = nullptr;</span>
<a href="#l13.73"></a><span id="l13.73">   }</span>
<a href="#l13.74"></a><span id="l13.74"> }</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-NS_IMETHODIMP nsNewsDownloader::OnStartRunningUrl(nsIURI* url)</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-{</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-}</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+NS_IMETHODIMP nsNewsDownloader::OnStartRunningUrl(nsIURI *url) { return NS_OK; }</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-NS_IMETHODIMP nsNewsDownloader::OnStopRunningUrl(nsIURI* url, nsresult exitCode)</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-{</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+NS_IMETHODIMP nsNewsDownloader::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+                                                 nsresult exitCode) {</span>
<a href="#l13.86"></a><span id="l13.86">   bool stopped = false;</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-  if (m_window)</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-    m_window-&gt;GetStopped(&amp;stopped);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-  if (stopped)</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-    exitCode = NS_BINDING_ABORTED;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  if (m_window) m_window-&gt;GetStopped(&amp;stopped);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+  if (stopped) exitCode = NS_BINDING_ABORTED;</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">- nsresult rv = exitCode;</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+  nsresult rv = exitCode;</span>
<a href="#l13.96"></a><span id="l13.96">   if (NS_SUCCEEDED(exitCode) || exitCode == NS_MSG_NEWS_ARTICLE_NOT_FOUND)</span>
<a href="#l13.97"></a><span id="l13.97">     rv = DownloadNext(false);</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99">   return rv;</span>
<a href="#l13.100"></a><span id="l13.100"> }</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-nsresult nsNewsDownloader::DownloadNext(bool firstTimeP)</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-{</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+nsresult nsNewsDownloader::DownloadNext(bool firstTimeP) {</span>
<a href="#l13.105"></a><span id="l13.105">   nsresult rv;</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  if (!firstTimeP)</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-  {</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+  if (!firstTimeP) {</span>
<a href="#l13.109"></a><span id="l13.109">     bool moreHeaders = GetNextHdrToRetrieve();</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-    if (!moreHeaders)</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-    {</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-      if (m_listener)</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-        m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    if (!moreHeaders) {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+      if (m_listener) m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l13.116"></a><span id="l13.116">       return NS_OK;</span>
<a href="#l13.117"></a><span id="l13.117">     }</span>
<a href="#l13.118"></a><span id="l13.118">   }</span>
<a href="#l13.119"></a><span id="l13.119">   StartDownload();</span>
<a href="#l13.120"></a><span id="l13.120">   m_wroteAnyP = false;</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.124"></a><span id="l13.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-  return nntpService-&gt;FetchMessage(m_folder, m_keyToDownload, m_window, nullptr, this, nullptr);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+  return nntpService-&gt;FetchMessage(m_folder, m_keyToDownload, m_window, nullptr,</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+                                   this, nullptr);</span>
<a href="#l13.129"></a><span id="l13.129"> }</span>
<a href="#l13.130"></a><span id="l13.130"> </span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-bool DownloadNewsArticlesToOfflineStore::GetNextHdrToRetrieve()</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-{</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+bool DownloadNewsArticlesToOfflineStore::GetNextHdrToRetrieve() {</span>
<a href="#l13.134"></a><span id="l13.134">   nsresult rv;</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-  if (m_downloadFromKeys)</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-    return nsNewsDownloader::GetNextHdrToRetrieve();</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  if (m_downloadFromKeys) return nsNewsDownloader::GetNextHdrToRetrieve();</span>
<a href="#l13.139"></a><span id="l13.139"> </span>
<a href="#l13.140"></a><span id="l13.140">   if (m_headerEnumerator == nullptr)</span>
<a href="#l13.141"></a><span id="l13.141">     rv = m_newsDB-&gt;EnumerateMessages(getter_AddRefs(m_headerEnumerator));</span>
<a href="#l13.142"></a><span id="l13.142"> </span>
<a href="#l13.143"></a><span id="l13.143">   bool hasMore = false;</span>
<a href="#l13.144"></a><span id="l13.144"> </span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-  while (NS_SUCCEEDED(rv = m_headerEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-  {</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+  while (NS_SUCCEEDED(rv = m_headerEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+         hasMore) {</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l13.151"></a><span id="l13.151">     rv = m_headerEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l13.152"></a><span id="l13.152">     m_newsHeader = do_QueryInterface(supports);</span>
<a href="#l13.153"></a><span id="l13.153">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l13.154"></a><span id="l13.154">     uint32_t hdrFlags;</span>
<a href="#l13.155"></a><span id="l13.155">     m_newsHeader-&gt;GetFlags(&amp;hdrFlags);</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-    if (hdrFlags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-    {</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+    if (hdrFlags &amp; nsMsgMessageFlags::Marked) {</span>
<a href="#l13.159"></a><span id="l13.159">       m_newsHeader-&gt;GetMessageKey(&amp;m_keyToDownload);</span>
<a href="#l13.160"></a><span id="l13.160">       break;</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-    }</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-    else</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-    {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+    } else {</span>
<a href="#l13.165"></a><span id="l13.165">       m_newsHeader = nullptr;</span>
<a href="#l13.166"></a><span id="l13.166">     }</span>
<a href="#l13.167"></a><span id="l13.167">   }</span>
<a href="#l13.168"></a><span id="l13.168">   return hasMore;</span>
<a href="#l13.169"></a><span id="l13.169"> }</span>
<a href="#l13.170"></a><span id="l13.170"> </span>
<a href="#l13.171"></a><span id="l13.171"> void nsNewsDownloader::Abort() {}</span>
<a href="#l13.172"></a><span id="l13.172"> void nsNewsDownloader::Complete() {}</span>
<a href="#l13.173"></a><span id="l13.173"> </span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-bool nsNewsDownloader::GetNextHdrToRetrieve()</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-{</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+bool nsNewsDownloader::GetNextHdrToRetrieve() {</span>
<a href="#l13.177"></a><span id="l13.177">   nsresult rv;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-  if (m_downloadFromKeys)</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-  {</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-    if (m_numwrote &gt;= (int32_t) m_keysToDownload.Length())</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-      return false;</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+  if (m_downloadFromKeys) {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+    if (m_numwrote &gt;= (int32_t)m_keysToDownload.Length()) return false;</span>
<a href="#l13.184"></a><span id="l13.184"> </span>
<a href="#l13.185"></a><span id="l13.185">     m_keyToDownload = m_keysToDownload[m_numwrote++];</span>
<a href="#l13.186"></a><span id="l13.186">     int32_t percent;</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-    percent = (100 * m_numwrote) / (int32_t) m_keysToDownload.Length();</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+    percent = (100 * m_numwrote) / (int32_t)m_keysToDownload.Length();</span>
<a href="#l13.189"></a><span id="l13.189"> </span>
<a href="#l13.190"></a><span id="l13.190">     int64_t nowMS = 0;</span>
<a href="#l13.191"></a><span id="l13.191">     if (percent &lt; 100)  // always need to do 100%</span>
<a href="#l13.192"></a><span id="l13.192">     {</span>
<a href="#l13.193"></a><span id="l13.193">       nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-      if (nowMS - m_lastProgressTime &lt; 750)</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-        return true;</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+      if (nowMS - m_lastProgressTime &lt; 750) return true;</span>
<a href="#l13.197"></a><span id="l13.197">     }</span>
<a href="#l13.198"></a><span id="l13.198"> </span>
<a href="#l13.199"></a><span id="l13.199">     m_lastProgressTime = nowMS;</span>
<a href="#l13.200"></a><span id="l13.200">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l13.203"></a><span id="l13.203">     NS_ENSURE_TRUE(bundleService, false);</span>
<a href="#l13.204"></a><span id="l13.204">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l13.205"></a><span id="l13.205">     rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l13.206"></a><span id="l13.206">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l13.207"></a><span id="l13.207"> </span>
<a href="#l13.208"></a><span id="l13.208">     nsAutoString firstStr;</span>
<a href="#l13.209"></a><span id="l13.209">     firstStr.AppendInt(m_numwrote);</span>
<a href="#l13.210"></a><span id="l13.210">     nsAutoString totalStr;</span>
<a href="#l13.211"></a><span id="l13.211">     totalStr.AppendInt(int(m_keysToDownload.Length()));</span>
<a href="#l13.212"></a><span id="l13.212">     nsString prettyName;</span>
<a href="#l13.213"></a><span id="l13.213">     nsString statusString;</span>
<a href="#l13.214"></a><span id="l13.214"> </span>
<a href="#l13.215"></a><span id="l13.215">     m_folder-&gt;GetPrettyName(prettyName);</span>
<a href="#l13.216"></a><span id="l13.216"> </span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-    const char16_t *formatStrings[3] = { firstStr.get(), totalStr.get(), prettyName.get() };</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+    const char16_t *formatStrings[3] = {firstStr.get(), totalStr.get(),</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+                                        prettyName.get()};</span>
<a href="#l13.220"></a><span id="l13.220">     rv = bundle-&gt;FormatStringFromName(&quot;downloadingArticlesForOffline&quot;,</span>
<a href="#l13.221"></a><span id="l13.221">                                       formatStrings, 3, statusString);</span>
<a href="#l13.222"></a><span id="l13.222">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l13.223"></a><span id="l13.223">     ShowProgress(statusString.get(), percent);</span>
<a href="#l13.224"></a><span id="l13.224">     return true;</span>
<a href="#l13.225"></a><span id="l13.225">   }</span>
<a href="#l13.226"></a><span id="l13.226">   NS_ASSERTION(false, &quot;shouldn't get here if we're not downloading from keys.&quot;);</span>
<a href="#l13.227"></a><span id="l13.227">   return false;  // shouldn't get here if we're not downloading from keys.</span>
<a href="#l13.228"></a><span id="l13.228"> }</span>
<a href="#l13.229"></a><span id="l13.229"> </span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-nsresult nsNewsDownloader::ShowProgress(const char16_t *progressString, int32_t percent)</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-{</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-  if (!m_statusFeedback)</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-  {</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-    if (m_window)</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-      m_window-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+nsresult nsNewsDownloader::ShowProgress(const char16_t *progressString,</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+                                        int32_t percent) {</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+  if (!m_statusFeedback) {</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+    if (m_window) m_window-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l13.240"></a><span id="l13.240">   }</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-  if (m_statusFeedback)</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-  {</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+  if (m_statusFeedback) {</span>
<a href="#l13.244"></a><span id="l13.244">     m_statusFeedback-&gt;ShowStatusString(nsDependentString(progressString));</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-    if (percent != m_lastPercent)</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-    {</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+    if (percent != m_lastPercent) {</span>
<a href="#l13.248"></a><span id="l13.248">       m_statusFeedback-&gt;ShowProgress(percent);</span>
<a href="#l13.249"></a><span id="l13.249">       m_lastPercent = percent;</span>
<a href="#l13.250"></a><span id="l13.250">     }</span>
<a href="#l13.251"></a><span id="l13.251">   }</span>
<a href="#l13.252"></a><span id="l13.252">   return NS_OK;</span>
<a href="#l13.253"></a><span id="l13.253"> }</span>
<a href="#l13.254"></a><span id="l13.254"> </span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-NS_IMETHODIMP DownloadNewsArticlesToOfflineStore::OnStartRunningUrl(nsIURI* url)</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-{</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+NS_IMETHODIMP DownloadNewsArticlesToOfflineStore::OnStartRunningUrl(</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+    nsIURI *url) {</span>
<a href="#l13.259"></a><span id="l13.259">   return NS_OK;</span>
<a href="#l13.260"></a><span id="l13.260"> }</span>
<a href="#l13.261"></a><span id="l13.261"> </span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-NS_IMETHODIMP DownloadNewsArticlesToOfflineStore::OnStopRunningUrl(nsIURI* url, nsresult exitCode)</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-{</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+NS_IMETHODIMP DownloadNewsArticlesToOfflineStore::OnStopRunningUrl(</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+    nsIURI *url, nsresult exitCode) {</span>
<a href="#l13.267"></a><span id="l13.267">   m_status = exitCode;</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-  if (m_newsHeader != nullptr)</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-  {</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+  if (m_newsHeader != nullptr) {</span>
<a href="#l13.271"></a><span id="l13.271"> #ifdef DEBUG_bienvenu</span>
<a href="#l13.272"></a><span id="l13.272">     //    XP_Trace(&quot;finished retrieving %ld\n&quot;, m_newsHeader-&gt;GetMessageKey());</span>
<a href="#l13.273"></a><span id="l13.273"> #endif</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-    if (m_newsDB)</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-    {</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+    if (m_newsDB) {</span>
<a href="#l13.277"></a><span id="l13.277">       nsMsgKey msgKey;</span>
<a href="#l13.278"></a><span id="l13.278">       m_newsHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.279"></a><span id="l13.279">       m_newsDB-&gt;MarkMarked(msgKey, false, nullptr);</span>
<a href="#l13.280"></a><span id="l13.280">     }</span>
<a href="#l13.281"></a><span id="l13.281">   }</span>
<a href="#l13.282"></a><span id="l13.282">   m_newsHeader = nullptr;</span>
<a href="#l13.283"></a><span id="l13.283">   return nsNewsDownloader::OnStopRunningUrl(url, exitCode);</span>
<a href="#l13.284"></a><span id="l13.284"> }</span>
<a href="#l13.285"></a><span id="l13.285"> </span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-int DownloadNewsArticlesToOfflineStore::FinishDownload()</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-{</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-  return 0;</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-}</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+int DownloadNewsArticlesToOfflineStore::FinishDownload() { return 0; }</span>
<a href="#l13.291"></a><span id="l13.291"> </span>
<a href="#l13.292"></a><span id="l13.292" class="difflineminus">-</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-NS_IMETHODIMP nsNewsDownloader::OnSearchHit(nsIMsgDBHdr *header, nsIMsgFolder *folder)</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-{</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+NS_IMETHODIMP nsNewsDownloader::OnSearchHit(nsIMsgDBHdr *header,</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+                                            nsIMsgFolder *folder) {</span>
<a href="#l13.297"></a><span id="l13.297">   NS_ENSURE_ARG(header);</span>
<a href="#l13.298"></a><span id="l13.298"> </span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-</span>
<a href="#l13.300"></a><span id="l13.300">   uint32_t msgFlags;</span>
<a href="#l13.301"></a><span id="l13.301">   header-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l13.302"></a><span id="l13.302">   // only need to download articles we don't already have...</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-  if (! (msgFlags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-  {</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+  if (!(msgFlags &amp; nsMsgMessageFlags::Offline)) {</span>
<a href="#l13.306"></a><span id="l13.306">     nsMsgKey key;</span>
<a href="#l13.307"></a><span id="l13.307">     header-&gt;GetMessageKey(&amp;key);</span>
<a href="#l13.308"></a><span id="l13.308">     m_keysToDownload.AppendElement(key);</span>
<a href="#l13.309"></a><span id="l13.309">   }</span>
<a href="#l13.310"></a><span id="l13.310">   return NS_OK;</span>
<a href="#l13.311"></a><span id="l13.311"> }</span>
<a href="#l13.312"></a><span id="l13.312"> </span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-NS_IMETHODIMP nsNewsDownloader::OnSearchDone(nsresult status)</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-{</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-  if (m_keysToDownload.IsEmpty())</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-  {</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-    if (m_listener)</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-      return m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+NS_IMETHODIMP nsNewsDownloader::OnSearchDone(nsresult status) {</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+  if (m_keysToDownload.IsEmpty()) {</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+    if (m_listener) return m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l13.322"></a><span id="l13.322">   }</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-  nsresult rv = DownloadArticles(m_window, m_folder,</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-                  /* we've already set m_keysToDownload, so don't pass it in */ nullptr);</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+  nsresult rv = DownloadArticles(</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+      m_window, m_folder,</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+      /* we've already set m_keysToDownload, so don't pass it in */ nullptr);</span>
<a href="#l13.328"></a><span id="l13.328">   if (NS_FAILED(rv))</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-    if (m_listener)</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-      m_listener-&gt;OnStopRunningUrl(nullptr, rv);</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+    if (m_listener) m_listener-&gt;OnStopRunningUrl(nullptr, rv);</span>
<a href="#l13.332"></a><span id="l13.332"> </span>
<a href="#l13.333"></a><span id="l13.333">   return rv;</span>
<a href="#l13.334"></a><span id="l13.334"> }</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-NS_IMETHODIMP nsNewsDownloader::OnNewSearch()</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-{</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-}</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+NS_IMETHODIMP nsNewsDownloader::OnNewSearch() { return NS_OK; }</span>
<a href="#l13.340"></a><span id="l13.340"> </span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-int DownloadNewsArticlesToOfflineStore::StartDownload()</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-{</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+int DownloadNewsArticlesToOfflineStore::StartDownload() {</span>
<a href="#l13.344"></a><span id="l13.344">   m_newsDB-&gt;GetMsgHdrForKey(m_keyToDownload, getter_AddRefs(m_newsHeader));</span>
<a href="#l13.345"></a><span id="l13.345">   return 0;</span>
<a href="#l13.346"></a><span id="l13.346"> }</span>
<a href="#l13.347"></a><span id="l13.347"> </span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-DownloadNewsArticlesToOfflineStore::DownloadNewsArticlesToOfflineStore(nsIMsgWindow *window, nsIMsgDatabase *db, nsIUrlListener *listener)</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-  : nsNewsDownloader(window, db, listener)</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-{</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+DownloadNewsArticlesToOfflineStore::DownloadNewsArticlesToOfflineStore(</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+    nsIMsgWindow *window, nsIMsgDatabase *db, nsIUrlListener *listener)</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+    : nsNewsDownloader(window, db, listener) {</span>
<a href="#l13.354"></a><span id="l13.354">   m_newsDB = db;</span>
<a href="#l13.355"></a><span id="l13.355"> }</span>
<a href="#l13.356"></a><span id="l13.356"> </span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-DownloadNewsArticlesToOfflineStore::~DownloadNewsArticlesToOfflineStore()</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-{</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-}</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+DownloadNewsArticlesToOfflineStore::~DownloadNewsArticlesToOfflineStore() {}</span>
<a href="#l13.361"></a><span id="l13.361"> </span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-DownloadMatchingNewsArticlesToNewsDB::DownloadMatchingNewsArticlesToNewsDB</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-  (nsIMsgWindow *window, nsIMsgFolder *folder, nsIMsgDatabase *newsDB,</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-   nsIUrlListener *listener) :</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-   DownloadNewsArticlesToOfflineStore(window, newsDB, listener)</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-{</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+DownloadMatchingNewsArticlesToNewsDB::DownloadMatchingNewsArticlesToNewsDB(</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+    nsIMsgWindow *window, nsIMsgFolder *folder, nsIMsgDatabase *newsDB,</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+    nsIUrlListener *listener)</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+    : DownloadNewsArticlesToOfflineStore(window, newsDB, listener) {</span>
<a href="#l13.371"></a><span id="l13.371">   m_window = window;</span>
<a href="#l13.372"></a><span id="l13.372">   m_folder = folder;</span>
<a href="#l13.373"></a><span id="l13.373">   m_newsDB = newsDB;</span>
<a href="#l13.374"></a><span id="l13.374">   m_downloadFromKeys = true;  // search term matching means downloadFromKeys.</span>
<a href="#l13.375"></a><span id="l13.375"> }</span>
<a href="#l13.376"></a><span id="l13.376"> </span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-DownloadMatchingNewsArticlesToNewsDB::~DownloadMatchingNewsArticlesToNewsDB()</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-{</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-}</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+DownloadMatchingNewsArticlesToNewsDB::~DownloadMatchingNewsArticlesToNewsDB() {}</span>
<a href="#l13.382"></a><span id="l13.382"> </span>
<a href="#l13.383"></a><span id="l13.383"> NS_IMPL_ISUPPORTS(nsMsgDownloadAllNewsgroups, nsIUrlListener)</span>
<a href="#l13.384"></a><span id="l13.384"> </span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-nsMsgDownloadAllNewsgroups::nsMsgDownloadAllNewsgroups(nsIMsgWindow *window, nsIUrlListener *listener)</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-{</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+nsMsgDownloadAllNewsgroups::nsMsgDownloadAllNewsgroups(</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+    nsIMsgWindow *window, nsIUrlListener *listener) {</span>
<a href="#l13.390"></a><span id="l13.390">   m_window = window;</span>
<a href="#l13.391"></a><span id="l13.391">   m_listener = listener;</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-  m_downloaderForGroup = new DownloadMatchingNewsArticlesToNewsDB(window, nullptr, nullptr, this);</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+  m_downloaderForGroup =</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+      new DownloadMatchingNewsArticlesToNewsDB(window, nullptr, nullptr, this);</span>
<a href="#l13.395"></a><span id="l13.395">   m_downloadedHdrsForCurGroup = false;</span>
<a href="#l13.396"></a><span id="l13.396"> }</span>
<a href="#l13.397"></a><span id="l13.397"> </span>
<a href="#l13.398"></a><span id="l13.398" class="difflineminus">-nsMsgDownloadAllNewsgroups::~nsMsgDownloadAllNewsgroups()</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-{</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-}</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+nsMsgDownloadAllNewsgroups::~nsMsgDownloadAllNewsgroups() {}</span>
<a href="#l13.402"></a><span id="l13.402"> </span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadAllNewsgroups::OnStartRunningUrl(nsIURI* url)</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-{</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadAllNewsgroups::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.408"></a><span id="l13.408"> }</span>
<a href="#l13.409"></a><span id="l13.409"> </span>
<a href="#l13.410"></a><span id="l13.410"> NS_IMETHODIMP</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineminus">-nsMsgDownloadAllNewsgroups::OnStopRunningUrl(nsIURI* url, nsresult exitCode)</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineminus">-{</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+nsMsgDownloadAllNewsgroups::OnStopRunningUrl(nsIURI *url, nsresult exitCode) {</span>
<a href="#l13.414"></a><span id="l13.414">   nsresult rv = exitCode;</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineminus">-  if (NS_SUCCEEDED(exitCode) || exitCode == NS_MSG_NEWS_ARTICLE_NOT_FOUND)</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineminus">-  {</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-    if (m_downloadedHdrsForCurGroup)</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-    {</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+  if (NS_SUCCEEDED(exitCode) || exitCode == NS_MSG_NEWS_ARTICLE_NOT_FOUND) {</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+    if (m_downloadedHdrsForCurGroup) {</span>
<a href="#l13.421"></a><span id="l13.421">       bool savingArticlesOffline = false;</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineminus">-      nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineminus">-      if (newsFolder)</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineminus">-        newsFolder-&gt;GetSaveArticleOffline(&amp;savingArticlesOffline);</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+      nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder =</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+          do_QueryInterface(m_currentFolder);</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+      if (newsFolder) newsFolder-&gt;GetSaveArticleOffline(&amp;savingArticlesOffline);</span>
<a href="#l13.428"></a><span id="l13.428"> </span>
<a href="#l13.429"></a><span id="l13.429">       m_downloadedHdrsForCurGroup = false;</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-      if (savingArticlesOffline) // skip this group - we're saving to it already</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+      if (savingArticlesOffline)  // skip this group - we're saving to it</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+                                  // already</span>
<a href="#l13.433"></a><span id="l13.433">         rv = ProcessNextGroup();</span>
<a href="#l13.434"></a><span id="l13.434">       else</span>
<a href="#l13.435"></a><span id="l13.435">         rv = DownloadMsgsForCurrentGroup();</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-    }</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-    else</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-    {</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+    } else {</span>
<a href="#l13.440"></a><span id="l13.440">       rv = ProcessNextGroup();</span>
<a href="#l13.441"></a><span id="l13.441">     }</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineminus">-  }</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineminus">-  else if (m_listener)  // notify main observer.</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+  } else if (m_listener)  // notify main observer.</span>
<a href="#l13.445"></a><span id="l13.445">     m_listener-&gt;OnStopRunningUrl(url, exitCode);</span>
<a href="#l13.446"></a><span id="l13.446"> </span>
<a href="#l13.447"></a><span id="l13.447">   return rv;</span>
<a href="#l13.448"></a><span id="l13.448"> }</span>
<a href="#l13.449"></a><span id="l13.449"> </span>
<a href="#l13.450"></a><span id="l13.450"> /**</span>
<a href="#l13.451"></a><span id="l13.451">  * Leaves m_currentServer at the next nntp &quot;server&quot; that</span>
<a href="#l13.452"></a><span id="l13.452">  * might have folders to download for offline use. If no more servers,</span>
<a href="#l13.453"></a><span id="l13.453">  * m_currentServer will be left at nullptr and the function returns false.</span>
<a href="#l13.454"></a><span id="l13.454">  * Also, sets up m_serverEnumerator to enumerate over the server.</span>
<a href="#l13.455"></a><span id="l13.455">  * If no servers found, m_serverEnumerator will be left at null.</span>
<a href="#l13.456"></a><span id="l13.456">  */</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-bool nsMsgDownloadAllNewsgroups::AdvanceToNextServer()</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-{</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+bool nsMsgDownloadAllNewsgroups::AdvanceToNextServer() {</span>
<a href="#l13.460"></a><span id="l13.460">   nsresult rv;</span>
<a href="#l13.461"></a><span id="l13.461"> </span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-  if (!m_allServers)</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineminus">-  {</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+  if (!m_allServers) {</span>
<a href="#l13.465"></a><span id="l13.465">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-             do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-    NS_ASSERTION(accountManager &amp;&amp; NS_SUCCEEDED(rv), &quot;couldn't get account mgr&quot;);</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-    if (!accountManager || NS_FAILED(rv))</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineminus">-      return false;</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineplus">+    NS_ASSERTION(accountManager &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineplus">+                 &quot;couldn't get account mgr&quot;);</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+    if (!accountManager || NS_FAILED(rv)) return false;</span>
<a href="#l13.474"></a><span id="l13.474"> </span>
<a href="#l13.475"></a><span id="l13.475">     rv = accountManager-&gt;GetAllServers(getter_AddRefs(m_allServers));</span>
<a href="#l13.476"></a><span id="l13.476">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l13.477"></a><span id="l13.477">   }</span>
<a href="#l13.478"></a><span id="l13.478">   uint32_t serverIndex = 0;</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-  if (m_currentServer)</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-  {</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+  if (m_currentServer) {</span>
<a href="#l13.482"></a><span id="l13.482">     rv = m_allServers-&gt;IndexOf(0, m_currentServer, &amp;serverIndex);</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineminus">-      serverIndex = -1;</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+    if (NS_FAILED(rv)) serverIndex = -1;</span>
<a href="#l13.486"></a><span id="l13.486"> </span>
<a href="#l13.487"></a><span id="l13.487">     ++serverIndex;</span>
<a href="#l13.488"></a><span id="l13.488">   }</span>
<a href="#l13.489"></a><span id="l13.489">   m_currentServer = nullptr;</span>
<a href="#l13.490"></a><span id="l13.490">   uint32_t numServers;</span>
<a href="#l13.491"></a><span id="l13.491">   m_allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l13.494"></a><span id="l13.494"> </span>
<a href="#l13.495"></a><span id="l13.495" class="difflineminus">-  while (serverIndex &lt; numServers)</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineminus">-  {</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(m_allServers, serverIndex);</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+  while (serverIndex &lt; numServers) {</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+        do_QueryElementAt(m_allServers, serverIndex);</span>
<a href="#l13.501"></a><span id="l13.501">     serverIndex++;</span>
<a href="#l13.502"></a><span id="l13.502"> </span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-    nsCOMPtr &lt;nsINntpIncomingServer&gt; newsServer = do_QueryInterface(server);</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineminus">-    if (!newsServer) // we're only looking for news servers</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+    nsCOMPtr&lt;nsINntpIncomingServer&gt; newsServer = do_QueryInterface(server);</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+    if (!newsServer)  // we're only looking for news servers</span>
<a href="#l13.507"></a><span id="l13.507">       continue;</span>
<a href="#l13.508"></a><span id="l13.508"> </span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-    if (server)</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineminus">-    {</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+    if (server) {</span>
<a href="#l13.512"></a><span id="l13.512">       m_currentServer = server;</span>
<a href="#l13.513"></a><span id="l13.513">       server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineminus">-      if (rootFolder)</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-      {</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+      if (rootFolder) {</span>
<a href="#l13.517"></a><span id="l13.517">         rv = rootFolder-&gt;GetDescendants(getter_AddRefs(m_allFolders));</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineminus">-        {</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.521"></a><span id="l13.521">           rv = m_allFolders-&gt;Enumerate(getter_AddRefs(m_serverEnumerator));</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; m_serverEnumerator)</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineminus">-          {</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; m_serverEnumerator) {</span>
<a href="#l13.525"></a><span id="l13.525">             bool hasMore = false;</span>
<a href="#l13.526"></a><span id="l13.526">             rv = m_serverEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; hasMore)</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineminus">-              return true;</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; hasMore) return true;</span>
<a href="#l13.530"></a><span id="l13.530">           }</span>
<a href="#l13.531"></a><span id="l13.531">         }</span>
<a href="#l13.532"></a><span id="l13.532">       }</span>
<a href="#l13.533"></a><span id="l13.533">     }</span>
<a href="#l13.534"></a><span id="l13.534">   }</span>
<a href="#l13.535"></a><span id="l13.535">   return false;</span>
<a href="#l13.536"></a><span id="l13.536"> }</span>
<a href="#l13.537"></a><span id="l13.537"> </span>
<a href="#l13.538"></a><span id="l13.538"> /**</span>
<a href="#l13.539"></a><span id="l13.539">  * Sets m_currentFolder to the next usable folder.</span>
<a href="#l13.540"></a><span id="l13.540">  *</span>
<a href="#l13.541"></a><span id="l13.541">  * @return  False if no more folders found, otherwise true.</span>
<a href="#l13.542"></a><span id="l13.542">  */</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineminus">-bool nsMsgDownloadAllNewsgroups::AdvanceToNextGroup()</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineminus">-{</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+bool nsMsgDownloadAllNewsgroups::AdvanceToNextGroup() {</span>
<a href="#l13.546"></a><span id="l13.546">   nsresult rv = NS_OK;</span>
<a href="#l13.547"></a><span id="l13.547"> </span>
<a href="#l13.548"></a><span id="l13.548" class="difflineminus">-  if (m_currentFolder)</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-  {</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineminus">-    nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineminus">-    if (newsFolder)</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineminus">-      newsFolder-&gt;SetSaveArticleOffline(false);</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+  if (m_currentFolder) {</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+    nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+    if (newsFolder) newsFolder-&gt;SetSaveArticleOffline(false);</span>
<a href="#l13.556"></a><span id="l13.556"> </span>
<a href="#l13.557"></a><span id="l13.557">     nsCOMPtr&lt;nsIMsgMailSession&gt; session =</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineminus">-             do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; session)</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-    {</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; session) {</span>
<a href="#l13.563"></a><span id="l13.563">       bool folderOpen;</span>
<a href="#l13.564"></a><span id="l13.564">       uint32_t folderFlags;</span>
<a href="#l13.565"></a><span id="l13.565">       m_currentFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l13.566"></a><span id="l13.566">       session-&gt;IsFolderOpenInWindow(m_currentFolder, &amp;folderOpen);</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-      if (!folderOpen &amp;&amp; ! (folderFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Inbox)))</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineplus">+      if (!folderOpen &amp;&amp;</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+          !(folderFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Inbox)))</span>
<a href="#l13.570"></a><span id="l13.570">         m_currentFolder-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l13.571"></a><span id="l13.571">     }</span>
<a href="#l13.572"></a><span id="l13.572">     m_currentFolder = nullptr;</span>
<a href="#l13.573"></a><span id="l13.573">   }</span>
<a href="#l13.574"></a><span id="l13.574"> </span>
<a href="#l13.575"></a><span id="l13.575">   bool hasMore = false;</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineminus">-  if (m_currentServer)</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineminus">-    m_serverEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineminus">-  if (!hasMore)</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineminus">-    hasMore = AdvanceToNextServer();</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineplus">+  if (m_currentServer) m_serverEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineplus">+  if (!hasMore) hasMore = AdvanceToNextServer();</span>
<a href="#l13.582"></a><span id="l13.582"> </span>
<a href="#l13.583"></a><span id="l13.583" class="difflineminus">-  if (hasMore)</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineminus">-  {</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineplus">+  if (hasMore) {</span>
<a href="#l13.586"></a><span id="l13.586">     nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l13.587"></a><span id="l13.587">     rv = m_serverEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l13.588"></a><span id="l13.588" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l13.589"></a><span id="l13.589" class="difflineminus">-      m_currentFolder = do_QueryInterface(supports);</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineplus">+    if (NS_SUCCEEDED(rv)) m_currentFolder = do_QueryInterface(supports);</span>
<a href="#l13.591"></a><span id="l13.591">   }</span>
<a href="#l13.592"></a><span id="l13.592">   return m_currentFolder;</span>
<a href="#l13.593"></a><span id="l13.593"> }</span>
<a href="#l13.594"></a><span id="l13.594"> </span>
<a href="#l13.595"></a><span id="l13.595" class="difflineminus">-nsresult DownloadMatchingNewsArticlesToNewsDB::RunSearch(nsIMsgFolder *folder, nsIMsgDatabase *newsDB, nsIMsgSearchSession *searchSession)</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineminus">-{</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+nsresult DownloadMatchingNewsArticlesToNewsDB::RunSearch(</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineplus">+    nsIMsgFolder *folder, nsIMsgDatabase *newsDB,</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineplus">+    nsIMsgSearchSession *searchSession) {</span>
<a href="#l13.600"></a><span id="l13.600">   m_folder = folder;</span>
<a href="#l13.601"></a><span id="l13.601">   m_newsDB = newsDB;</span>
<a href="#l13.602"></a><span id="l13.602">   m_searchSession = searchSession;</span>
<a href="#l13.603"></a><span id="l13.603"> </span>
<a href="#l13.604"></a><span id="l13.604">   m_keysToDownload.Clear();</span>
<a href="#l13.605"></a><span id="l13.605"> </span>
<a href="#l13.606"></a><span id="l13.606">   NS_ENSURE_ARG(searchSession);</span>
<a href="#l13.607"></a><span id="l13.607">   NS_ENSURE_ARG(folder);</span>
<a href="#l13.608"></a><span id="l13.608"> </span>
<a href="#l13.609"></a><span id="l13.609" class="difflineminus">-  searchSession-&gt;RegisterListener(this,</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-                                  nsIMsgSearchSession::allNotifications);</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineminus">-  nsresult rv = searchSession-&gt;AddScopeTerm(nsMsgSearchScope::localNews, folder);</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+  searchSession-&gt;RegisterListener(this, nsIMsgSearchSession::allNotifications);</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineplus">+  nsresult rv =</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineplus">+      searchSession-&gt;AddScopeTerm(nsMsgSearchScope::localNews, folder);</span>
<a href="#l13.615"></a><span id="l13.615">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.616"></a><span id="l13.616"> </span>
<a href="#l13.617"></a><span id="l13.617">   return searchSession-&gt;Search(m_window);</span>
<a href="#l13.618"></a><span id="l13.618"> }</span>
<a href="#l13.619"></a><span id="l13.619"> </span>
<a href="#l13.620"></a><span id="l13.620" class="difflineminus">-nsresult nsMsgDownloadAllNewsgroups::ProcessNextGroup()</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineminus">-{</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineplus">+nsresult nsMsgDownloadAllNewsgroups::ProcessNextGroup() {</span>
<a href="#l13.623"></a><span id="l13.623">   bool done = false;</span>
<a href="#l13.624"></a><span id="l13.624"> </span>
<a href="#l13.625"></a><span id="l13.625" class="difflineminus">-  while (!done)</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineminus">-  {</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineplus">+  while (!done) {</span>
<a href="#l13.628"></a><span id="l13.628">     done = !AdvanceToNextGroup();</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineminus">-    if (!done &amp;&amp; m_currentFolder)</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineminus">-    {</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+    if (!done &amp;&amp; m_currentFolder) {</span>
<a href="#l13.632"></a><span id="l13.632">       uint32_t folderFlags;</span>
<a href="#l13.633"></a><span id="l13.633">       m_currentFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineminus">-      if (folderFlags &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineminus">-        break;</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineplus">+      if (folderFlags &amp; nsMsgFolderFlags::Offline) break;</span>
<a href="#l13.637"></a><span id="l13.637">     }</span>
<a href="#l13.638"></a><span id="l13.638">   }</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineminus">-  if (done)</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineminus">-  {</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineminus">-    if (m_listener)</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineminus">-      return m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineplus">+  if (done) {</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+    if (m_listener) return m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l13.645"></a><span id="l13.645">   }</span>
<a href="#l13.646"></a><span id="l13.646">   m_downloadedHdrsForCurGroup = true;</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineminus">-  return m_currentFolder ? m_currentFolder-&gt;GetNewMessages(m_window, this) : NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineplus">+  return m_currentFolder ? m_currentFolder-&gt;GetNewMessages(m_window, this)</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineplus">+                         : NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l13.650"></a><span id="l13.650"> }</span>
<a href="#l13.651"></a><span id="l13.651"> </span>
<a href="#l13.652"></a><span id="l13.652" class="difflineminus">-nsresult nsMsgDownloadAllNewsgroups::DownloadMsgsForCurrentGroup()</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineminus">-{</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+nsresult nsMsgDownloadAllNewsgroups::DownloadMsgsForCurrentGroup() {</span>
<a href="#l13.655"></a><span id="l13.655">   NS_ENSURE_TRUE(m_downloaderForGroup, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDownloadSettings&gt; downloadSettings;</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDownloadSettings&gt; downloadSettings;</span>
<a href="#l13.660"></a><span id="l13.660">   m_currentFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineminus">-  nsresult rv = m_currentFolder-&gt;GetDownloadSettings(getter_AddRefs(downloadSettings));</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineplus">+  nsresult rv =</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineplus">+      m_currentFolder-&gt;GetDownloadSettings(getter_AddRefs(downloadSettings));</span>
<a href="#l13.664"></a><span id="l13.664">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.665"></a><span id="l13.665"> </span>
<a href="#l13.666"></a><span id="l13.666" class="difflineminus">-  nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineminus">-  if (newsFolder)</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineminus">-    newsFolder-&gt;SetSaveArticleOffline(true);</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(m_currentFolder);</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineplus">+  if (newsFolder) newsFolder-&gt;SetSaveArticleOffline(true);</span>
<a href="#l13.671"></a><span id="l13.671"> </span>
<a href="#l13.672"></a><span id="l13.672" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineplus">+      do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l13.675"></a><span id="l13.675">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.676"></a><span id="l13.676"> </span>
<a href="#l13.677"></a><span id="l13.677">   bool downloadByDate, downloadUnreadOnly;</span>
<a href="#l13.678"></a><span id="l13.678">   uint32_t ageLimitOfMsgsToDownload;</span>
<a href="#l13.679"></a><span id="l13.679"> </span>
<a href="#l13.680"></a><span id="l13.680">   downloadSettings-&gt;GetDownloadByDate(&amp;downloadByDate);</span>
<a href="#l13.681"></a><span id="l13.681">   downloadSettings-&gt;GetDownloadUnreadOnly(&amp;downloadUnreadOnly);</span>
<a href="#l13.682"></a><span id="l13.682">   downloadSettings-&gt;GetAgeLimitOfMsgsToDownload(&amp;ageLimitOfMsgsToDownload);</span>
<a href="#l13.683"></a><span id="l13.683"> </span>
<a href="#l13.684"></a><span id="l13.684" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchValue&gt;    value;</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValue&gt; value;</span>
<a href="#l13.688"></a><span id="l13.688"> </span>
<a href="#l13.689"></a><span id="l13.689">   rv = searchSession-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l13.690"></a><span id="l13.690">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.691"></a><span id="l13.691">   term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l13.692"></a><span id="l13.692"> </span>
<a href="#l13.693"></a><span id="l13.693" class="difflineminus">-  if (downloadUnreadOnly)</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineminus">-  {</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+  if (downloadUnreadOnly) {</span>
<a href="#l13.696"></a><span id="l13.696">     value-&gt;SetAttrib(nsMsgSearchAttrib::MsgStatus);</span>
<a href="#l13.697"></a><span id="l13.697">     value-&gt;SetStatus(nsMsgMessageFlags::Read);</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineminus">-    searchSession-&gt;AddSearchTerm(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, value, true, nullptr);</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineplus">+    searchSession-&gt;AddSearchTerm(nsMsgSearchAttrib::MsgStatus,</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineplus">+                                 nsMsgSearchOp::Isnt, value, true, nullptr);</span>
<a href="#l13.701"></a><span id="l13.701">   }</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineminus">-  if (downloadByDate)</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineminus">-  {</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineplus">+  if (downloadByDate) {</span>
<a href="#l13.705"></a><span id="l13.705">     value-&gt;SetAttrib(nsMsgSearchAttrib::AgeInDays);</span>
<a href="#l13.706"></a><span id="l13.706">     value-&gt;SetAge(ageLimitOfMsgsToDownload);</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineminus">-    searchSession-&gt;AddSearchTerm(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, value, nsMsgSearchBooleanOp::BooleanAND, nullptr);</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineplus">+    searchSession-&gt;AddSearchTerm(nsMsgSearchAttrib::AgeInDays,</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineplus">+                                 nsMsgSearchOp::IsLessThan, value,</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineplus">+                                 nsMsgSearchBooleanOp::BooleanAND, nullptr);</span>
<a href="#l13.711"></a><span id="l13.711">   }</span>
<a href="#l13.712"></a><span id="l13.712">   value-&gt;SetAttrib(nsMsgSearchAttrib::MsgStatus);</span>
<a href="#l13.713"></a><span id="l13.713">   value-&gt;SetStatus(nsMsgMessageFlags::Offline);</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineminus">-  searchSession-&gt;AddSearchTerm(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, value, nsMsgSearchBooleanOp::BooleanAND, nullptr);</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineplus">+  searchSession-&gt;AddSearchTerm(nsMsgSearchAttrib::MsgStatus,</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineplus">+                               nsMsgSearchOp::Isnt, value,</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineplus">+                               nsMsgSearchBooleanOp::BooleanAND, nullptr);</span>
<a href="#l13.718"></a><span id="l13.718"> </span>
<a href="#l13.719"></a><span id="l13.719">   m_downloaderForGroup-&gt;RunSearch(m_currentFolder, db, searchSession);</span>
<a href="#l13.720"></a><span id="l13.720">   return rv;</span>
<a href="#l13.721"></a><span id="l13.721"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloader.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloader.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,128 +1,136 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.5"></a><span id="l14.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> #ifndef _nsNewsDownloader_H_</span>
<a href="#l14.10"></a><span id="l14.10"> #define _nsNewsDownloader_H_</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsIMsgSearchNotify.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21"> #include &quot;nsTArray.h&quot;</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-// base class for downloading articles in a single newsgroup. Keys to download are passed in</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-// to DownloadArticles method.</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-class nsNewsDownloader : public nsIUrlListener, public nsIMsgSearchNotify</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-{</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-public:</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  nsNewsDownloader(nsIMsgWindow *window, nsIMsgDatabase *db, nsIUrlListener *listener);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+// base class for downloading articles in a single newsgroup. Keys to download</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+// are passed in to DownloadArticles method.</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+class nsNewsDownloader : public nsIUrlListener, public nsIMsgSearchNotify {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ public:</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  nsNewsDownloader(nsIMsgWindow *window, nsIMsgDatabase *db,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+                   nsIUrlListener *listener);</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">   NS_DECL_ISUPPORTS</span>
<a href="#l14.37"></a><span id="l14.37">   NS_DECL_NSIURLLISTENER</span>
<a href="#l14.38"></a><span id="l14.38">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  virtual nsresult DownloadArticles(nsIMsgWindow *window, nsIMsgFolder *folder, nsTArray&lt;nsMsgKey&gt; *pKeyArray);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  virtual nsresult DownloadArticles(nsIMsgWindow *window, nsIMsgFolder *folder,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+                                    nsTArray&lt;nsMsgKey&gt; *pKeyArray);</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">   bool ShouldAbort() const { return m_abort; }</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-protected:</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ protected:</span>
<a href="#l14.48"></a><span id="l14.48">   virtual ~nsNewsDownloader();</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  virtual int32_t Write(const char * /*block*/, int32_t length) {return length;}</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  virtual int32_t Write(const char * /*block*/, int32_t length) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    return length;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  }</span>
<a href="#l14.54"></a><span id="l14.54">   virtual void Abort();</span>
<a href="#l14.55"></a><span id="l14.55">   virtual void Complete();</span>
<a href="#l14.56"></a><span id="l14.56">   virtual bool GetNextHdrToRetrieve();</span>
<a href="#l14.57"></a><span id="l14.57">   virtual nsresult DownloadNext(bool firstTimeP);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  virtual int32_t FinishDownload() {return 0;}</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  virtual int32_t  StartDownload() {return 0;}</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  virtual nsresult ShowProgress(const char16_t *progressString, int32_t percent);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  virtual int32_t FinishDownload() { return 0; }</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  virtual int32_t StartDownload() { return 0; }</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  virtual nsresult ShowProgress(const char16_t *progressString,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+                                int32_t percent);</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt;      m_keysToDownload;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt;  m_folder;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  nsCOMPtr &lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_keysToDownload;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_newsDB;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l14.74"></a><span id="l14.74">   bool m_downloadFromKeys;</span>
<a href="#l14.75"></a><span id="l14.75">   bool m_existedP;</span>
<a href="#l14.76"></a><span id="l14.76">   bool m_wroteAnyP;</span>
<a href="#l14.77"></a><span id="l14.77">   bool m_summaryValidP;</span>
<a href="#l14.78"></a><span id="l14.78">   bool m_abort;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-  int32_t     m_numwrote;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-  nsMsgKey    m_keyToDownload;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-  nsCOMPtr &lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  int32_t m_numwrote;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  nsMsgKey m_keyToDownload;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l14.89"></a><span id="l14.89">   int32_t m_lastPercent;</span>
<a href="#l14.90"></a><span id="l14.90">   int64_t m_lastProgressTime;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-  nsresult  m_status;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  nsresult m_status;</span>
<a href="#l14.93"></a><span id="l14.93"> };</span>
<a href="#l14.94"></a><span id="l14.94"> </span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-</span>
<a href="#l14.96"></a><span id="l14.96"> // class for downloading articles in a single newsgroup to the offline store.</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-class DownloadNewsArticlesToOfflineStore : public nsNewsDownloader</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-{</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-public:</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-  DownloadNewsArticlesToOfflineStore(nsIMsgWindow *window, nsIMsgDatabase *db, nsIUrlListener *listener);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+class DownloadNewsArticlesToOfflineStore : public nsNewsDownloader {</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+ public:</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  DownloadNewsArticlesToOfflineStore(nsIMsgWindow *window, nsIMsgDatabase *db,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+                                     nsIUrlListener *listener);</span>
<a href="#l14.105"></a><span id="l14.105">   virtual ~DownloadNewsArticlesToOfflineStore();</span>
<a href="#l14.106"></a><span id="l14.106"> </span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-  NS_IMETHOD OnStartRunningUrl(nsIURI* url);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-  NS_IMETHOD OnStopRunningUrl(nsIURI* url, nsresult exitCode);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-protected:</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-  virtual int32_t  StartDownload();</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  NS_IMETHOD OnStartRunningUrl(nsIURI *url);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+  NS_IMETHOD OnStopRunningUrl(nsIURI *url, nsresult exitCode);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+ protected:</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  virtual int32_t StartDownload();</span>
<a href="#l14.116"></a><span id="l14.116">   virtual int32_t FinishDownload();</span>
<a href="#l14.117"></a><span id="l14.117">   virtual bool GetNextHdrToRetrieve();</span>
<a href="#l14.118"></a><span id="l14.118"> </span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt;  m_headerEnumerator;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt;  m_newsHeader;</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; m_headerEnumerator;</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newsHeader;</span>
<a href="#l14.123"></a><span id="l14.123"> };</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-// class for downloading all the articles that match the passed in search criteria</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-// for a single newsgroup.</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-class DownloadMatchingNewsArticlesToNewsDB : public DownloadNewsArticlesToOfflineStore</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-{</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-public:</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-  DownloadMatchingNewsArticlesToNewsDB(nsIMsgWindow *window, nsIMsgFolder *folder, nsIMsgDatabase *newsDB,  nsIUrlListener *listener);</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+// class for downloading all the articles that match the passed in search</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+// criteria for a single newsgroup.</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+class DownloadMatchingNewsArticlesToNewsDB</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+    : public DownloadNewsArticlesToOfflineStore {</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+ public:</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+  DownloadMatchingNewsArticlesToNewsDB(nsIMsgWindow *window,</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+                                       nsIMsgFolder *folder,</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+                                       nsIMsgDatabase *newsDB,</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+                                       nsIUrlListener *listener);</span>
<a href="#l14.140"></a><span id="l14.140">   virtual ~DownloadMatchingNewsArticlesToNewsDB();</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-  nsresult RunSearch(nsIMsgFolder *folder, nsIMsgDatabase *newsDB, nsIMsgSearchSession *searchSession);</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-protected:</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+  nsresult RunSearch(nsIMsgFolder *folder, nsIMsgDatabase *newsDB,</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+                     nsIMsgSearchSession *searchSession);</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+ protected:</span>
<a href="#l14.147"></a><span id="l14.147"> };</span>
<a href="#l14.148"></a><span id="l14.148"> </span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-// this class iterates all the news servers for each group on the server that's configured for</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-// offline use, downloads the messages that meet the download criteria for that newsgroup/server</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-class nsMsgDownloadAllNewsgroups : public nsIUrlListener</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-{</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-public:</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+// this class iterates all the news servers for each group on the server that's</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+// configured for offline use, downloads the messages that meet the download</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+// criteria for that newsgroup/server</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+class nsMsgDownloadAllNewsgroups : public nsIUrlListener {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+ public:</span>
<a href="#l14.159"></a><span id="l14.159">   nsMsgDownloadAllNewsgroups(nsIMsgWindow *window, nsIUrlListener *listener);</span>
<a href="#l14.160"></a><span id="l14.160"> </span>
<a href="#l14.161"></a><span id="l14.161">   NS_DECL_ISUPPORTS</span>
<a href="#l14.162"></a><span id="l14.162">   NS_DECL_NSIURLLISTENER</span>
<a href="#l14.163"></a><span id="l14.163"> </span>
<a href="#l14.164"></a><span id="l14.164">   nsresult ProcessNextGroup();</span>
<a href="#l14.165"></a><span id="l14.165"> </span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-protected:</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+ protected:</span>
<a href="#l14.168"></a><span id="l14.168">   virtual ~nsMsgDownloadAllNewsgroups();</span>
<a href="#l14.169"></a><span id="l14.169"> </span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-  bool     AdvanceToNextServer();</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-  bool     AdvanceToNextGroup();</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+  bool AdvanceToNextServer();</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+  bool AdvanceToNextGroup();</span>
<a href="#l14.174"></a><span id="l14.174">   nsresult DownloadMsgsForCurrentGroup();</span>
<a href="#l14.175"></a><span id="l14.175"> </span>
<a href="#l14.176"></a><span id="l14.176">   RefPtr&lt;DownloadMatchingNewsArticlesToNewsDB&gt; m_downloaderForGroup;</span>
<a href="#l14.177"></a><span id="l14.177"> </span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_currentFolder;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-  nsCOMPtr &lt;nsIArray&gt; m_allServers;</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-  nsCOMPtr &lt;nsIArray&gt; m_allFolders;</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; m_currentServer;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; m_serverEnumerator;</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-  nsCOMPtr &lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_currentFolder;</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_allServers;</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_allFolders;</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_currentServer;</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; m_serverEnumerator;</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l14.192"></a><span id="l14.192"> </span>
<a href="#l14.193"></a><span id="l14.193">   bool m_downloadedHdrsForCurGroup;</span>
<a href="#l14.194"></a><span id="l14.194"> };</span>
<a href="#l14.195"></a><span id="l14.195"> </span>
<a href="#l14.196"></a><span id="l14.196"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;prlog.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nntpCore.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsNewsFolder.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;prprf.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;prsystem.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;nsIArray.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -54,92 +54,83 @@</span>
<a href="#l15.23"></a><span id="l15.23"> #include &quot;nsILoginManager.h&quot;</span>
<a href="#l15.24"></a><span id="l15.24"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l15.25"></a><span id="l15.25"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l15.26"></a><span id="l15.26"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l15.27"></a><span id="l15.27"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l15.28"></a><span id="l15.28"> #include &quot;nsMemory.h&quot;</span>
<a href="#l15.29"></a><span id="l15.29"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-</span>
<a href="#l15.32"></a><span id="l15.32"> #define kNewsSortOffset 9000</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34"> #define NEWS_SCHEME &quot;news:&quot;</span>
<a href="#l15.35"></a><span id="l15.35"> #define SNEWS_SCHEME &quot;snews:&quot;</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-nsMsgNewsFolder::nsMsgNewsFolder(void) :</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-     mExpungedBytes(0), mGettingNews(false),</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-     mInitialized(false),</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-     m_downloadMessageForOfflineUse(false), m_downloadingMultipleMessages(false),</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-     mReadSet(nullptr), mSortOrder(kNewsSortOffset)</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-{</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+nsMsgNewsFolder::nsMsgNewsFolder(void)</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+    : mExpungedBytes(0),</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+      mGettingNews(false),</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+      mInitialized(false),</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+      m_downloadMessageForOfflineUse(false),</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+      m_downloadingMultipleMessages(false),</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+      mReadSet(nullptr),</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+      mSortOrder(kNewsSortOffset) {</span>
<a href="#l15.53"></a><span id="l15.53">   mFolderSize = kSizeUnknown;</span>
<a href="#l15.54"></a><span id="l15.54"> }</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-nsMsgNewsFolder::~nsMsgNewsFolder(void)</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-{</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  delete mReadSet;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-}</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+nsMsgNewsFolder::~nsMsgNewsFolder(void) { delete mReadSet; }</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62"> NS_IMPL_ADDREF_INHERITED(nsMsgNewsFolder, nsMsgDBFolder)</span>
<a href="#l15.63"></a><span id="l15.63"> NS_IMPL_RELEASE_INHERITED(nsMsgNewsFolder, nsMsgDBFolder)</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::QueryInterface(REFNSIID aIID, void** aInstancePtr)</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-{</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  if (!aInstancePtr)</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::QueryInterface(REFNSIID aIID,</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+                                              void **aInstancePtr) {</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  if (!aInstancePtr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.72"></a><span id="l15.72">   *aInstancePtr = nullptr;</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74">   if (aIID.Equals(NS_GET_IID(nsIMsgNewsFolder)))</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-    *aInstancePtr = static_cast&lt;nsIMsgNewsFolder*&gt;(this);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-  if(*aInstancePtr)</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-  {</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+    *aInstancePtr = static_cast&lt;nsIMsgNewsFolder *&gt;(this);</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  if (*aInstancePtr) {</span>
<a href="#l15.80"></a><span id="l15.80">     AddRef();</span>
<a href="#l15.81"></a><span id="l15.81">     return NS_OK;</span>
<a href="#l15.82"></a><span id="l15.82">   }</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84">   return nsMsgDBFolder::QueryInterface(aIID, aInstancePtr);</span>
<a href="#l15.85"></a><span id="l15.85"> }</span>
<a href="#l15.86"></a><span id="l15.86"> </span>
<a href="#l15.87"></a><span id="l15.87"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-nsresult</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-nsMsgNewsFolder::CreateSubFolders(nsIFile *path)</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-{</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+nsresult nsMsgNewsFolder::CreateSubFolders(nsIFile *path) {</span>
<a href="#l15.93"></a><span id="l15.93">   nsresult rv;</span>
<a href="#l15.94"></a><span id="l15.94">   bool isNewsServer = false;</span>
<a href="#l15.95"></a><span id="l15.95">   rv = GetIsServer(&amp;isNewsServer);</span>
<a href="#l15.96"></a><span id="l15.96">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.97"></a><span id="l15.97"> </span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-  if (isNewsServer)</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-  {</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  if (isNewsServer) {</span>
<a href="#l15.101"></a><span id="l15.101">     nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.102"></a><span id="l15.102">     rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.103"></a><span id="l15.103">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.104"></a><span id="l15.104"> </span>
<a href="#l15.105"></a><span id="l15.105">     rv = nntpServer-&gt;GetNewsrcFilePath(getter_AddRefs(mNewsrcFilePath));</span>
<a href="#l15.106"></a><span id="l15.106">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.107"></a><span id="l15.107"> </span>
<a href="#l15.108"></a><span id="l15.108">     rv = LoadNewsrcFileAndCreateNewsgroups();</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-  }</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-  else // is not a host, so it has no newsgroups.  (what about categories??)</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+  } else  // is not a host, so it has no newsgroups.  (what about categories??)</span>
<a href="#l15.112"></a><span id="l15.112">     rv = NS_OK;</span>
<a href="#l15.113"></a><span id="l15.113">   return rv;</span>
<a href="#l15.114"></a><span id="l15.114"> }</span>
<a href="#l15.115"></a><span id="l15.115"> </span>
<a href="#l15.116"></a><span id="l15.116"> NS_IMETHODIMP</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-nsMsgNewsFolder::AddNewsgroup(const nsACString &amp;name, const nsACString&amp; setStr,</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-                              nsIMsgFolder **child)</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-{</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+nsMsgNewsFolder::AddNewsgroup(const nsACString &amp;name, const nsACString &amp;setStr,</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+                              nsIMsgFolder **child) {</span>
<a href="#l15.122"></a><span id="l15.122">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l15.123"></a><span id="l15.123">   nsresult rv;</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-  nsCOMPtr &lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+  nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.127"></a><span id="l15.127">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.128"></a><span id="l15.128">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.129"></a><span id="l15.129"> </span>
<a href="#l15.130"></a><span id="l15.130">   nsAutoCString uri(mURI);</span>
<a href="#l15.131"></a><span id="l15.131">   uri.Append('/');</span>
<a href="#l15.132"></a><span id="l15.132">   // URI should use UTF-8</span>
<a href="#l15.133"></a><span id="l15.133">   // (see RFC2396 Uniform Resource Identifiers (URI): Generic Syntax)</span>
<a href="#l15.134"></a><span id="l15.134"> </span>
<a href="#l15.135"></a><span id="l15.135" class="difflineat">@@ -161,58 +152,53 @@ nsMsgNewsFolder::AddNewsgroup(const nsAC</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137">   nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l15.138"></a><span id="l15.138">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.139"></a><span id="l15.139"> </span>
<a href="#l15.140"></a><span id="l15.140">   // cache this for when we open the db</span>
<a href="#l15.141"></a><span id="l15.141">   rv = newsFolder-&gt;SetReadSetFromStr(setStr);</span>
<a href="#l15.142"></a><span id="l15.142"> </span>
<a href="#l15.143"></a><span id="l15.143">   rv = folder-&gt;SetParent(this);</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.146"></a><span id="l15.146"> </span>
<a href="#l15.147"></a><span id="l15.147">   // this what shows up in the UI</span>
<a href="#l15.148"></a><span id="l15.148">   rv = folder-&gt;SetName(nameUtf16);</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.151"></a><span id="l15.151"> </span>
<a href="#l15.152"></a><span id="l15.152">   rv = folder-&gt;SetFlag(nsMsgFolderFlags::Newsgroup);</span>
<a href="#l15.153"></a><span id="l15.153">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.154"></a><span id="l15.154"> </span>
<a href="#l15.155"></a><span id="l15.155">   int32_t numExistingGroups = mSubFolders.Count();</span>
<a href="#l15.156"></a><span id="l15.156"> </span>
<a href="#l15.157"></a><span id="l15.157">   // add kNewsSortOffset (9000) to prevent this problem:  1,10,11,2,3,4,5</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-  // We use 9000 instead of 1000 so newsgroups will sort to bottom of flat folder views</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+  // We use 9000 instead of 1000 so newsgroups will sort to bottom of flat</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+  // folder views</span>
<a href="#l15.161"></a><span id="l15.161">   rv = folder-&gt;SetSortOrder(numExistingGroups + kNewsSortOffset);</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.164"></a><span id="l15.164"> </span>
<a href="#l15.165"></a><span id="l15.165">   mSubFolders.AppendObject(folder);</span>
<a href="#l15.166"></a><span id="l15.166">   folder-&gt;SetParent(this);</span>
<a href="#l15.167"></a><span id="l15.167">   folder.forget(child);</span>
<a href="#l15.168"></a><span id="l15.168">   return rv;</span>
<a href="#l15.169"></a><span id="l15.169"> }</span>
<a href="#l15.170"></a><span id="l15.170"> </span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-nsresult nsMsgNewsFolder::ParseFolder(nsIFile *path)</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-{</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+nsresult nsMsgNewsFolder::ParseFolder(nsIFile *path) {</span>
<a href="#l15.174"></a><span id="l15.174">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.175"></a><span id="l15.175"> }</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-nsresult</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-nsMsgNewsFolder::AddDirectorySeparator(nsIFile *path)</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-{</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+nsresult nsMsgNewsFolder::AddDirectorySeparator(nsIFile *path) {</span>
<a href="#l15.181"></a><span id="l15.181">   // don't concat the full separator with .sbd</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-  return (mURI.Equals(kNewsRootURI)) ?</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-                  NS_OK :</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-                  nsMsgDBFolder::AddDirectorySeparator(path);</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+  return (mURI.Equals(kNewsRootURI))</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+             ? NS_OK</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+             : nsMsgDBFolder::AddDirectorySeparator(path);</span>
<a href="#l15.188"></a><span id="l15.188"> }</span>
<a href="#l15.189"></a><span id="l15.189"> </span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-</span>
<a href="#l15.191"></a><span id="l15.191"> NS_IMETHODIMP</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-nsMsgNewsFolder::GetSubFolders(nsISimpleEnumerator **aResult)</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-{</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-  {</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+nsMsgNewsFolder::GetSubFolders(nsISimpleEnumerator **aResult) {</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+  if (!mInitialized) {</span>
<a href="#l15.198"></a><span id="l15.198">     // do this first, so we make sure to do it, even on failure.</span>
<a href="#l15.199"></a><span id="l15.199">     // see bug #70494</span>
<a href="#l15.200"></a><span id="l15.200">     mInitialized = true;</span>
<a href="#l15.201"></a><span id="l15.201"> </span>
<a href="#l15.202"></a><span id="l15.202">     nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l15.203"></a><span id="l15.203">     nsresult rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l15.204"></a><span id="l15.204">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.205"></a><span id="l15.205"> </span>
<a href="#l15.206"></a><span id="l15.206" class="difflineat">@@ -220,179 +206,163 @@ nsMsgNewsFolder::GetSubFolders(nsISimple</span>
<a href="#l15.207"></a><span id="l15.207">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.208"></a><span id="l15.208"> </span>
<a href="#l15.209"></a><span id="l15.209">     // force ourselves to get initialized from cache</span>
<a href="#l15.210"></a><span id="l15.210">     // Don't care if it fails.  this will fail the first time after</span>
<a href="#l15.211"></a><span id="l15.211">     // migration, but we continue on.  see #66018</span>
<a href="#l15.212"></a><span id="l15.212">     (void)UpdateSummaryTotals(false);</span>
<a href="#l15.213"></a><span id="l15.213">   }</span>
<a href="#l15.214"></a><span id="l15.214"> </span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-  return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders, NS_GET_IID(nsIMsgFolder)) : NS_ERROR_NULL_POINTER;</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+  return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders,</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineplus">+                                         NS_GET_IID(nsIMsgFolder))</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineplus">+                 : NS_ERROR_NULL_POINTER;</span>
<a href="#l15.219"></a><span id="l15.219"> }</span>
<a href="#l15.220"></a><span id="l15.220"> </span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-//Makes sure the database is open and exists.  If the database is valid then</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-//returns NS_OK.  Otherwise returns a failure error value.</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-nsresult nsMsgNewsFolder::GetDatabase()</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-{</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+// Makes sure the database is open and exists.  If the database is valid then</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+// returns NS_OK.  Otherwise returns a failure error value.</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+nsresult nsMsgNewsFolder::GetDatabase() {</span>
<a href="#l15.228"></a><span id="l15.228">   nsresult rv;</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-  {</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.237"></a><span id="l15.237"> </span>
<a href="#l15.238"></a><span id="l15.238">     // Get the database, blowing it away if it's out of date.</span>
<a href="#l15.239"></a><span id="l15.239">     rv = msgDBService-&gt;OpenFolderDB(this, false, getter_AddRefs(mDatabase));</span>
<a href="#l15.240"></a><span id="l15.240">     if (NS_FAILED(rv))</span>
<a href="#l15.241"></a><span id="l15.241">       rv = msgDBService-&gt;CreateNewDB(this, getter_AddRefs(mDatabase));</span>
<a href="#l15.242"></a><span id="l15.242">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.243"></a><span id="l15.243"> </span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-    if(mAddListener)</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-      rv = mDatabase-&gt;AddListener(this);</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+    if (mAddListener) rv = mDatabase-&gt;AddListener(this);</span>
<a href="#l15.247"></a><span id="l15.247"> </span>
<a href="#l15.248"></a><span id="l15.248">     nsCOMPtr&lt;nsINewsDatabase&gt; db = do_QueryInterface(mDatabase, &amp;rv);</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineminus">-      return rv;</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.252"></a><span id="l15.252"> </span>
<a href="#l15.253"></a><span id="l15.253">     rv = db-&gt;SetReadSet(mReadSet);</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-      return rv;</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.257"></a><span id="l15.257"> </span>
<a href="#l15.258"></a><span id="l15.258">     rv = UpdateSummaryTotals(true);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-      return rv;</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.262"></a><span id="l15.262">   }</span>
<a href="#l15.263"></a><span id="l15.263">   return NS_OK;</span>
<a href="#l15.264"></a><span id="l15.264"> }</span>
<a href="#l15.265"></a><span id="l15.265"> </span>
<a href="#l15.266"></a><span id="l15.266"> NS_IMETHODIMP</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-nsMsgNewsFolder::GetDatabaseWithoutCache(nsIMsgDatabase **db)</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-{</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+nsMsgNewsFolder::GetDatabaseWithoutCache(nsIMsgDatabase **db) {</span>
<a href="#l15.270"></a><span id="l15.270">   NS_ENSURE_ARG_POINTER(db);</span>
<a href="#l15.271"></a><span id="l15.271"> </span>
<a href="#l15.272"></a><span id="l15.272">   // The simplest way to perform this operation is to get the database normally</span>
<a href="#l15.273"></a><span id="l15.273">   // and then clear our information about it if we didn't already hold it open.</span>
<a href="#l15.274"></a><span id="l15.274">   bool wasCached = !!mDatabase;</span>
<a href="#l15.275"></a><span id="l15.275">   nsresult rv = GetDatabase();</span>
<a href="#l15.276"></a><span id="l15.276">   NS_IF_ADDREF(*db = mDatabase);</span>
<a href="#l15.277"></a><span id="l15.277"> </span>
<a href="#l15.278"></a><span id="l15.278">   // If the DB was not open before, close our reference to it now.</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-  if (!wasCached &amp;&amp; mDatabase)</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-  {</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+  if (!wasCached &amp;&amp; mDatabase) {</span>
<a href="#l15.282"></a><span id="l15.282">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l15.283"></a><span id="l15.283">     mDatabase = nullptr;</span>
<a href="#l15.284"></a><span id="l15.284">   }</span>
<a href="#l15.285"></a><span id="l15.285"> </span>
<a href="#l15.286"></a><span id="l15.286">   return rv;</span>
<a href="#l15.287"></a><span id="l15.287"> }</span>
<a href="#l15.288"></a><span id="l15.288"> </span>
<a href="#l15.289"></a><span id="l15.289"> NS_IMETHODIMP</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-nsMsgNewsFolder::UpdateFolder(nsIMsgWindow *aWindow)</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-{</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+nsMsgNewsFolder::UpdateFolder(nsIMsgWindow *aWindow) {</span>
<a href="#l15.293"></a><span id="l15.293">   // Get news.get_messages_on_select pref</span>
<a href="#l15.294"></a><span id="l15.294">   nsresult rv;</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.298"></a><span id="l15.298">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.299"></a><span id="l15.299">   bool getMessagesOnSelect = true;</span>
<a href="#l15.300"></a><span id="l15.300">   prefBranch-&gt;GetBoolPref(&quot;news.get_messages_on_select&quot;, &amp;getMessagesOnSelect);</span>
<a href="#l15.301"></a><span id="l15.301"> </span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-  // Only if news.get_messages_on_select is true do we get new messages automatically</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-  if (getMessagesOnSelect)</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-  {</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-    rv = GetDatabase(); // want this cached...</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-    {</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-      if (mDatabase)</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-      {</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+  // Only if news.get_messages_on_select is true do we get new messages</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+  // automatically</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+  if (getMessagesOnSelect) {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+    rv = GetDatabase();  // want this cached...</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineplus">+      if (mDatabase) {</span>
<a href="#l15.316"></a><span id="l15.316">         nsCOMPtr&lt;nsIMsgRetentionSettings&gt; retentionSettings;</span>
<a href="#l15.317"></a><span id="l15.317">         nsresult rv = GetRetentionSettings(getter_AddRefs(retentionSettings));</span>
<a href="#l15.318"></a><span id="l15.318">         if (NS_SUCCEEDED(rv))</span>
<a href="#l15.319"></a><span id="l15.319">           rv = mDatabase-&gt;ApplyRetentionSettings(retentionSettings, false);</span>
<a href="#l15.320"></a><span id="l15.320">       }</span>
<a href="#l15.321"></a><span id="l15.321">       rv = AutoCompact(aWindow);</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-      // GetNewMessages has to be the last rv set before we get to the next check, so</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-      // that we'll have rv set to NS_MSG_ERROR_OFFLINE when offline and send</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-      // a folder loaded notification to the front end.</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+      // GetNewMessages has to be the last rv set before we get to the next</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+      // check, so that we'll have rv set to NS_MSG_ERROR_OFFLINE when offline</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineplus">+      // and send a folder loaded notification to the front end.</span>
<a href="#l15.330"></a><span id="l15.330">       rv = GetNewMessages(aWindow, nullptr);</span>
<a href="#l15.331"></a><span id="l15.331">     }</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineminus">-    if (rv != NS_MSG_ERROR_OFFLINE)</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-      return rv;</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineplus">+    if (rv != NS_MSG_ERROR_OFFLINE) return rv;</span>
<a href="#l15.335"></a><span id="l15.335">   }</span>
<a href="#l15.336"></a><span id="l15.336">   // We're not getting messages because either get_messages_on_select is</span>
<a href="#l15.337"></a><span id="l15.337">   // false or we're offline. Send an immediate folder loaded notification.</span>
<a href="#l15.338"></a><span id="l15.338">   NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l15.341"></a><span id="l15.341">   return NS_OK;</span>
<a href="#l15.342"></a><span id="l15.342"> }</span>
<a href="#l15.343"></a><span id="l15.343"> </span>
<a href="#l15.344"></a><span id="l15.344"> NS_IMETHODIMP</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-nsMsgNewsFolder::GetCanSubscribe(bool *aResult)</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineminus">-{</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineplus">+nsMsgNewsFolder::GetCanSubscribe(bool *aResult) {</span>
<a href="#l15.348"></a><span id="l15.348">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l15.349"></a><span id="l15.349">   *aResult = false;</span>
<a href="#l15.350"></a><span id="l15.350"> </span>
<a href="#l15.351"></a><span id="l15.351">   bool isNewsServer = false;</span>
<a href="#l15.352"></a><span id="l15.352">   nsresult rv = GetIsServer(&amp;isNewsServer);</span>
<a href="#l15.353"></a><span id="l15.353">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.354"></a><span id="l15.354"> </span>
<a href="#l15.355"></a><span id="l15.355">   // you can only subscribe to news servers, not news groups</span>
<a href="#l15.356"></a><span id="l15.356">   *aResult = isNewsServer;</span>
<a href="#l15.357"></a><span id="l15.357">   return NS_OK;</span>
<a href="#l15.358"></a><span id="l15.358"> }</span>
<a href="#l15.359"></a><span id="l15.359"> </span>
<a href="#l15.360"></a><span id="l15.360"> NS_IMETHODIMP</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-nsMsgNewsFolder::GetCanFileMessages(bool *aResult)</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineminus">-{</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+nsMsgNewsFolder::GetCanFileMessages(bool *aResult) {</span>
<a href="#l15.364"></a><span id="l15.364">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l15.365"></a><span id="l15.365">   // you can't file messages into a news server or news group</span>
<a href="#l15.366"></a><span id="l15.366">   *aResult = false;</span>
<a href="#l15.367"></a><span id="l15.367">   return NS_OK;</span>
<a href="#l15.368"></a><span id="l15.368"> }</span>
<a href="#l15.369"></a><span id="l15.369"> </span>
<a href="#l15.370"></a><span id="l15.370"> NS_IMETHODIMP</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-nsMsgNewsFolder::GetCanCreateSubfolders(bool *aResult)</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-{</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineplus">+nsMsgNewsFolder::GetCanCreateSubfolders(bool *aResult) {</span>
<a href="#l15.374"></a><span id="l15.374">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l15.375"></a><span id="l15.375">   *aResult = false;</span>
<a href="#l15.376"></a><span id="l15.376">   // you can't create subfolders on a news server or a news group</span>
<a href="#l15.377"></a><span id="l15.377">   return NS_OK;</span>
<a href="#l15.378"></a><span id="l15.378"> }</span>
<a href="#l15.379"></a><span id="l15.379"> </span>
<a href="#l15.380"></a><span id="l15.380"> NS_IMETHODIMP</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineminus">-nsMsgNewsFolder::GetCanRename(bool *aResult)</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-{</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+nsMsgNewsFolder::GetCanRename(bool *aResult) {</span>
<a href="#l15.384"></a><span id="l15.384">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l15.385"></a><span id="l15.385">   *aResult = false;</span>
<a href="#l15.386"></a><span id="l15.386">   // you can't rename a news server or a news group</span>
<a href="#l15.387"></a><span id="l15.387">   return NS_OK;</span>
<a href="#l15.388"></a><span id="l15.388"> }</span>
<a href="#l15.389"></a><span id="l15.389"> </span>
<a href="#l15.390"></a><span id="l15.390"> NS_IMETHODIMP</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-nsMsgNewsFolder::GetCanCompact(bool *aResult)</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineminus">-{</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+nsMsgNewsFolder::GetCanCompact(bool *aResult) {</span>
<a href="#l15.394"></a><span id="l15.394">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l15.395"></a><span id="l15.395">   *aResult = false;</span>
<a href="#l15.396"></a><span id="l15.396">   // you can't compact a news server or a news group</span>
<a href="#l15.397"></a><span id="l15.397">   return NS_OK;</span>
<a href="#l15.398"></a><span id="l15.398"> }</span>
<a href="#l15.399"></a><span id="l15.399"> </span>
<a href="#l15.400"></a><span id="l15.400"> NS_IMETHODIMP</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-nsMsgNewsFolder::GetMessages(nsISimpleEnumerator **result)</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-{</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+nsMsgNewsFolder::GetMessages(nsISimpleEnumerator **result) {</span>
<a href="#l15.404"></a><span id="l15.404">   nsresult rv = GetDatabase();</span>
<a href="#l15.405"></a><span id="l15.405">   *result = nullptr;</span>
<a href="#l15.406"></a><span id="l15.406"> </span>
<a href="#l15.407"></a><span id="l15.407" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineminus">-    rv = mDatabase-&gt;EnumerateMessages(result);</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = mDatabase-&gt;EnumerateMessages(result);</span>
<a href="#l15.410"></a><span id="l15.410"> </span>
<a href="#l15.411"></a><span id="l15.411">   return rv;</span>
<a href="#l15.412"></a><span id="l15.412"> }</span>
<a href="#l15.413"></a><span id="l15.413"> </span>
<a href="#l15.414"></a><span id="l15.414" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetFolderURL(nsACString&amp; aUrl)</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-{</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetFolderURL(nsACString &amp;aUrl) {</span>
<a href="#l15.417"></a><span id="l15.417">   nsCString hostName;</span>
<a href="#l15.418"></a><span id="l15.418">   nsresult rv = GetHostname(hostName);</span>
<a href="#l15.419"></a><span id="l15.419">   nsString groupName;</span>
<a href="#l15.420"></a><span id="l15.420">   rv = GetName(groupName);</span>
<a href="#l15.421"></a><span id="l15.421">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.422"></a><span id="l15.422"> </span>
<a href="#l15.423"></a><span id="l15.423">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.424"></a><span id="l15.424">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineat">@@ -400,114 +370,111 @@ NS_IMETHODIMP nsMsgNewsFolder::GetFolder</span>
<a href="#l15.426"></a><span id="l15.426"> </span>
<a href="#l15.427"></a><span id="l15.427">   int32_t socketType;</span>
<a href="#l15.428"></a><span id="l15.428">   rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l15.429"></a><span id="l15.429">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.430"></a><span id="l15.430"> </span>
<a href="#l15.431"></a><span id="l15.431">   int32_t port;</span>
<a href="#l15.432"></a><span id="l15.432">   rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l15.433"></a><span id="l15.433">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineminus">-  const char *newsScheme = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineminus">-                           SNEWS_SCHEME : NEWS_SCHEME;</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineplus">+  const char *newsScheme =</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineplus">+      (socketType == nsMsgSocketType::SSL) ? SNEWS_SCHEME : NEWS_SCHEME;</span>
<a href="#l15.438"></a><span id="l15.438">   nsCString escapedName;</span>
<a href="#l15.439"></a><span id="l15.439">   rv = NS_MsgEscapeEncodeURLPath(groupName, escapedName);</span>
<a href="#l15.440"></a><span id="l15.440">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.441"></a><span id="l15.441">   nsCString tmpStr;</span>
<a href="#l15.442"></a><span id="l15.442">   tmpStr.Adopt(PR_smprintf(&quot;%s//%s:%ld/%s&quot;, newsScheme, hostName.get(), port,</span>
<a href="#l15.443"></a><span id="l15.443">                            escapedName.get()));</span>
<a href="#l15.444"></a><span id="l15.444">   aUrl.Assign(tmpStr);</span>
<a href="#l15.445"></a><span id="l15.445">   return NS_OK;</span>
<a href="#l15.446"></a><span id="l15.446"> }</span>
<a href="#l15.447"></a><span id="l15.447"> </span>
<a href="#l15.448"></a><span id="l15.448" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::SetNewsrcHasChanged(bool newsrcHasChanged)</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineminus">-{</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::SetNewsrcHasChanged(bool newsrcHasChanged) {</span>
<a href="#l15.451"></a><span id="l15.451">   nsresult rv;</span>
<a href="#l15.452"></a><span id="l15.452"> </span>
<a href="#l15.453"></a><span id="l15.453">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.454"></a><span id="l15.454">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.455"></a><span id="l15.455">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.456"></a><span id="l15.456">   return nntpServer-&gt;SetNewsrcHasChanged(newsrcHasChanged);</span>
<a href="#l15.457"></a><span id="l15.457"> }</span>
<a href="#l15.458"></a><span id="l15.458"> </span>
<a href="#l15.459"></a><span id="l15.459" class="difflineminus">-nsresult nsMsgNewsFolder::CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder)</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-{</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+nsresult nsMsgNewsFolder::CreateChildFromURI(const nsCString &amp;uri,</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineplus">+                                             nsIMsgFolder **folder) {</span>
<a href="#l15.463"></a><span id="l15.463">   nsMsgNewsFolder *newFolder = new nsMsgNewsFolder;</span>
<a href="#l15.464"></a><span id="l15.464">   NS_ADDREF(*folder = newFolder);</span>
<a href="#l15.465"></a><span id="l15.465">   newFolder-&gt;Init(uri.get());</span>
<a href="#l15.466"></a><span id="l15.466">   return NS_OK;</span>
<a href="#l15.467"></a><span id="l15.467"> }</span>
<a href="#l15.468"></a><span id="l15.468"> </span>
<a href="#l15.469"></a><span id="l15.469" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::CreateSubfolder(const nsAString&amp; newsgroupName,</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-                                               nsIMsgWindow *msgWindow)</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-{</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::CreateSubfolder(const nsAString &amp;newsgroupName,</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineplus">+                                               nsIMsgWindow *msgWindow) {</span>
<a href="#l15.474"></a><span id="l15.474">   nsresult rv = NS_OK;</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineminus">-  if (newsgroupName.IsEmpty())</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineminus">-    return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+  if (newsgroupName.IsEmpty()) return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l15.478"></a><span id="l15.478"> </span>
<a href="#l15.479"></a><span id="l15.479">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l15.480"></a><span id="l15.480">   // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l15.481"></a><span id="l15.481">   nsCOMPtr&lt;nsIMsgDatabase&gt; newsDBFactory;</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; newsDB;</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; newsDB;</span>
<a href="#l15.484"></a><span id="l15.484"> </span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-  //Now let's create the actual new folder</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineminus">-  rv = AddNewsgroup(NS_ConvertUTF16toUTF8(newsgroupName), EmptyCString(), getter_AddRefs(child));</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineplus">+  // Now let's create the actual new folder</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineplus">+  rv = AddNewsgroup(NS_ConvertUTF16toUTF8(newsgroupName), EmptyCString(),</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineplus">+                    getter_AddRefs(child));</span>
<a href="#l15.490"></a><span id="l15.490"> </span>
<a href="#l15.491"></a><span id="l15.491">   if (NS_SUCCEEDED(rv))</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineminus">-    SetNewsrcHasChanged(true); // subscribe UI does this - but maybe we got here through auto-subscribe</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineplus">+    SetNewsrcHasChanged(true);  // subscribe UI does this - but maybe we got</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineplus">+                                // here through auto-subscribe</span>
<a href="#l15.495"></a><span id="l15.495"> </span>
<a href="#l15.496"></a><span id="l15.496" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; child){</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineminus">-    nsCOMPtr &lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineplus">+    nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.500"></a><span id="l15.500">     rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.501"></a><span id="l15.501">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.502"></a><span id="l15.502"> </span>
<a href="#l15.503"></a><span id="l15.503">     nsAutoCString dataCharset;</span>
<a href="#l15.504"></a><span id="l15.504">     rv = nntpServer-&gt;GetCharset(dataCharset);</span>
<a href="#l15.505"></a><span id="l15.505">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.506"></a><span id="l15.506"> </span>
<a href="#l15.507"></a><span id="l15.507">     child-&gt;SetCharset(dataCharset);</span>
<a href="#l15.508"></a><span id="l15.508">     NotifyItemAdded(child);</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineminus">-    if (notifier)</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineminus">-      notifier-&gt;NotifyFolderAdded(child);</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineplus">+    if (notifier) notifier-&gt;NotifyFolderAdded(child);</span>
<a href="#l15.515"></a><span id="l15.515">   }</span>
<a href="#l15.516"></a><span id="l15.516">   return rv;</span>
<a href="#l15.517"></a><span id="l15.517"> }</span>
<a href="#l15.518"></a><span id="l15.518"> </span>
<a href="#l15.519"></a><span id="l15.519" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::Delete()</span>
<a href="#l15.520"></a><span id="l15.520" class="difflineminus">-{</span>
<a href="#l15.521"></a><span id="l15.521" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::Delete() {</span>
<a href="#l15.522"></a><span id="l15.522">   nsresult rv = nsMsgDBFolder::Delete();</span>
<a href="#l15.523"></a><span id="l15.523">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.524"></a><span id="l15.524"> </span>
<a href="#l15.525"></a><span id="l15.525" class="difflineminus">-  nsCOMPtr &lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineplus">+  nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.527"></a><span id="l15.527">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.528"></a><span id="l15.528">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.529"></a><span id="l15.529"> </span>
<a href="#l15.530"></a><span id="l15.530">   nsAutoString name;</span>
<a href="#l15.531"></a><span id="l15.531">   rv = GetUnicodeName(name);</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.534"></a><span id="l15.534"> </span>
<a href="#l15.535"></a><span id="l15.535">   rv = nntpServer-&gt;RemoveNewsgroup(name);</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.538"></a><span id="l15.538"> </span>
<a href="#l15.539"></a><span id="l15.539" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l15.541"></a><span id="l15.541"> </span>
<a href="#l15.542"></a><span id="l15.542">   return SetNewsrcHasChanged(true);</span>
<a href="#l15.543"></a><span id="l15.543"> }</span>
<a href="#l15.544"></a><span id="l15.544"> </span>
<a href="#l15.545"></a><span id="l15.545" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::Rename(const nsAString&amp; newName, nsIMsgWindow *msgWindow)</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineminus">-{</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::Rename(const nsAString &amp;newName,</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineplus">+                                      nsIMsgWindow *msgWindow) {</span>
<a href="#l15.549"></a><span id="l15.549">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.550"></a><span id="l15.550"> }</span>
<a href="#l15.551"></a><span id="l15.551"> </span>
<a href="#l15.552"></a><span id="l15.552" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetAbbreviatedName(nsAString&amp; aAbbreviatedName)</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineminus">-{</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetAbbreviatedName(nsAString &amp;aAbbreviatedName) {</span>
<a href="#l15.555"></a><span id="l15.555">   nsresult rv;</span>
<a href="#l15.556"></a><span id="l15.556"> </span>
<a href="#l15.557"></a><span id="l15.557">   rv = nsMsgDBFolder::GetPrettyName(aAbbreviatedName);</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineminus">-  if(NS_FAILED(rv)) return rv;</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.560"></a><span id="l15.560"> </span>
<a href="#l15.561"></a><span id="l15.561">   // only do this for newsgroup names, not for newsgroup hosts.</span>
<a href="#l15.562"></a><span id="l15.562">   bool isNewsServer = false;</span>
<a href="#l15.563"></a><span id="l15.563">   rv = GetIsServer(&amp;isNewsServer);</span>
<a href="#l15.564"></a><span id="l15.564">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.565"></a><span id="l15.565"> </span>
<a href="#l15.566"></a><span id="l15.566">   if (!isNewsServer) {</span>
<a href="#l15.567"></a><span id="l15.567">     nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineat">@@ -531,426 +498,396 @@ NS_IMETHODIMP nsMsgNewsFolder::GetAbbrev</span>
<a href="#l15.569"></a><span id="l15.569"> // takes a newsgroup name, number of words from the end to leave unabberviated</span>
<a href="#l15.570"></a><span id="l15.570"> // the newsgroup name, will get reset to the following format:</span>
<a href="#l15.571"></a><span id="l15.571"> // x.x.x, where x is the first letter of each word and with the</span>
<a href="#l15.572"></a><span id="l15.572"> // exception of last 'fullwords' words, which are left intact.</span>
<a href="#l15.573"></a><span id="l15.573"> // If a word has a dash in it, it is abbreviated as a-b, where</span>
<a href="#l15.574"></a><span id="l15.574"> // 'a' is the first letter of the part of the word before the</span>
<a href="#l15.575"></a><span id="l15.575"> // dash and 'b' is the first letter of the part of the word after</span>
<a href="#l15.576"></a><span id="l15.576"> // the dash</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-nsresult nsMsgNewsFolder::AbbreviatePrettyName(nsAString&amp; prettyName, int32_t fullwords)</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineminus">-{</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineplus">+nsresult nsMsgNewsFolder::AbbreviatePrettyName(nsAString &amp;prettyName,</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineplus">+                                               int32_t fullwords) {</span>
<a href="#l15.581"></a><span id="l15.581">   nsAutoString name(prettyName);</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineminus">-  int32_t totalwords = 0; // total no. of words</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineplus">+  int32_t totalwords = 0;  // total no. of words</span>
<a href="#l15.584"></a><span id="l15.584"> </span>
<a href="#l15.585"></a><span id="l15.585">   // get the total no. of words</span>
<a href="#l15.586"></a><span id="l15.586">   int32_t pos = 0;</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineminus">-  while(1)</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineminus">-  {</span>
<a href="#l15.589"></a><span id="l15.589" class="difflineplus">+  while (1) {</span>
<a href="#l15.590"></a><span id="l15.590">     pos = name.FindChar('.', pos);</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineminus">-    if(pos == -1)</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineminus">-    {</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineplus">+    if (pos == -1) {</span>
<a href="#l15.594"></a><span id="l15.594">       totalwords++;</span>
<a href="#l15.595"></a><span id="l15.595">       break;</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineminus">-    }</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineminus">-    else</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineminus">-    {</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineplus">+    } else {</span>
<a href="#l15.600"></a><span id="l15.600">       totalwords++;</span>
<a href="#l15.601"></a><span id="l15.601">       pos++;</span>
<a href="#l15.602"></a><span id="l15.602">     }</span>
<a href="#l15.603"></a><span id="l15.603">   }</span>
<a href="#l15.604"></a><span id="l15.604"> </span>
<a href="#l15.605"></a><span id="l15.605">   // get the no. of words to abbreviate</span>
<a href="#l15.606"></a><span id="l15.606">   int32_t abbrevnum = totalwords - fullwords;</span>
<a href="#l15.607"></a><span id="l15.607" class="difflineminus">-  if (abbrevnum &lt; 1)</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineminus">-    return NS_OK; // nothing to abbreviate</span>
<a href="#l15.609"></a><span id="l15.609" class="difflineplus">+  if (abbrevnum &lt; 1) return NS_OK;  // nothing to abbreviate</span>
<a href="#l15.610"></a><span id="l15.610"> </span>
<a href="#l15.611"></a><span id="l15.611">   // build the ellipsis</span>
<a href="#l15.612"></a><span id="l15.612">   nsAutoString out;</span>
<a href="#l15.613"></a><span id="l15.613">   out += name[0];</span>
<a href="#l15.614"></a><span id="l15.614"> </span>
<a href="#l15.615"></a><span id="l15.615">   int32_t length = name.Length();</span>
<a href="#l15.616"></a><span id="l15.616" class="difflineminus">-  int32_t newword = 0;     // == 2 if done with all abbreviated words</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineplus">+  int32_t newword = 0;  // == 2 if done with all abbreviated words</span>
<a href="#l15.618"></a><span id="l15.618"> </span>
<a href="#l15.619"></a><span id="l15.619">   fullwords = 0;</span>
<a href="#l15.620"></a><span id="l15.620">   char16_t currentChar;</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineminus">-  for (int32_t i = 1; i &lt; length; i++)</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineminus">-  {</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineplus">+  for (int32_t i = 1; i &lt; length; i++) {</span>
<a href="#l15.624"></a><span id="l15.624">     // this temporary assignment is needed to fix an intel mac compiler bug.</span>
<a href="#l15.625"></a><span id="l15.625">     // See Bug #327037 for details.</span>
<a href="#l15.626"></a><span id="l15.626">     currentChar = name[i];</span>
<a href="#l15.627"></a><span id="l15.627">     if (newword &lt; 2) {</span>
<a href="#l15.628"></a><span id="l15.628">       switch (currentChar) {</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineminus">-      case '.':</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineminus">-        fullwords++;</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineminus">-        // check if done with all abbreviated words...</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineminus">-        if (fullwords == abbrevnum)</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineminus">-          newword = 2;</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineminus">-        else</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+        case '.':</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineplus">+          fullwords++;</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineplus">+          // check if done with all abbreviated words...</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineplus">+          if (fullwords == abbrevnum)</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineplus">+            newword = 2;</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineplus">+          else</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineplus">+            newword = 1;</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineplus">+          break;</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineplus">+        case '-':</span>
<a href="#l15.644"></a><span id="l15.644">           newword = 1;</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineminus">-        break;</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineminus">-      case '-':</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineminus">-        newword = 1;</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineminus">-        break;</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineminus">-      default:</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineminus">-        if (newword)</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineminus">-          newword = 0;</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineminus">-        else</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineminus">-          continue;</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineplus">+          break;</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineplus">+        default:</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineplus">+          if (newword)</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineplus">+            newword = 0;</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineplus">+          else</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineplus">+            continue;</span>
<a href="#l15.660"></a><span id="l15.660">       }</span>
<a href="#l15.661"></a><span id="l15.661">     }</span>
<a href="#l15.662"></a><span id="l15.662">     out.Append(currentChar);</span>
<a href="#l15.663"></a><span id="l15.663">   }</span>
<a href="#l15.664"></a><span id="l15.664">   prettyName = out;</span>
<a href="#l15.665"></a><span id="l15.665">   return NS_OK;</span>
<a href="#l15.666"></a><span id="l15.666"> }</span>
<a href="#l15.667"></a><span id="l15.667"> </span>
<a href="#l15.668"></a><span id="l15.668"> NS_IMETHODIMP</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineminus">-nsMsgNewsFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **db)</span>
<a href="#l15.670"></a><span id="l15.670" class="difflineminus">-{</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineplus">+nsMsgNewsFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l15.672"></a><span id="l15.672" class="difflineplus">+                                      nsIMsgDatabase **db) {</span>
<a href="#l15.673"></a><span id="l15.673">   NS_ENSURE_ARG_POINTER(folderInfo);</span>
<a href="#l15.674"></a><span id="l15.674">   NS_ENSURE_ARG_POINTER(db);</span>
<a href="#l15.675"></a><span id="l15.675">   nsresult openErr;</span>
<a href="#l15.676"></a><span id="l15.676">   openErr = GetDatabase();</span>
<a href="#l15.677"></a><span id="l15.677">   if (!mDatabase) {</span>
<a href="#l15.678"></a><span id="l15.678">     *db = nullptr;</span>
<a href="#l15.679"></a><span id="l15.679">     return openErr;</span>
<a href="#l15.680"></a><span id="l15.680">   }</span>
<a href="#l15.681"></a><span id="l15.681"> </span>
<a href="#l15.682"></a><span id="l15.682">   NS_ADDREF(*db = mDatabase);</span>
<a href="#l15.683"></a><span id="l15.683"> </span>
<a href="#l15.684"></a><span id="l15.684" class="difflineminus">-  if (NS_SUCCEEDED(openErr))</span>
<a href="#l15.685"></a><span id="l15.685" class="difflineminus">-    openErr = (*db)-&gt;GetDBFolderInfo(folderInfo);</span>
<a href="#l15.686"></a><span id="l15.686" class="difflineplus">+  if (NS_SUCCEEDED(openErr)) openErr = (*db)-&gt;GetDBFolderInfo(folderInfo);</span>
<a href="#l15.687"></a><span id="l15.687">   return openErr;</span>
<a href="#l15.688"></a><span id="l15.688"> }</span>
<a href="#l15.689"></a><span id="l15.689"> </span>
<a href="#l15.690"></a><span id="l15.690"> /* this used to be MSG_FolderInfoNews::UpdateSummaryFromNNTPInfo() */</span>
<a href="#l15.691"></a><span id="l15.691"> NS_IMETHODIMP</span>
<a href="#l15.692"></a><span id="l15.692" class="difflineminus">-nsMsgNewsFolder::UpdateSummaryFromNNTPInfo(int32_t oldest, int32_t youngest, int32_t total)</span>
<a href="#l15.693"></a><span id="l15.693" class="difflineminus">-{</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineplus">+nsMsgNewsFolder::UpdateSummaryFromNNTPInfo(int32_t oldest, int32_t youngest,</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineplus">+                                           int32_t total) {</span>
<a href="#l15.696"></a><span id="l15.696">   /* First, mark all of the articles now known to be expired as read. */</span>
<a href="#l15.697"></a><span id="l15.697" class="difflineminus">-  if (oldest &gt; 1)</span>
<a href="#l15.698"></a><span id="l15.698" class="difflineminus">-  {</span>
<a href="#l15.699"></a><span id="l15.699" class="difflineplus">+  if (oldest &gt; 1) {</span>
<a href="#l15.700"></a><span id="l15.700">     nsCString oldSet;</span>
<a href="#l15.701"></a><span id="l15.701">     nsCString newSet;</span>
<a href="#l15.702"></a><span id="l15.702">     mReadSet-&gt;Output(getter_Copies(oldSet));</span>
<a href="#l15.703"></a><span id="l15.703">     mReadSet-&gt;AddRange(1, oldest - 1);</span>
<a href="#l15.704"></a><span id="l15.704">     mReadSet-&gt;Output(getter_Copies(newSet));</span>
<a href="#l15.705"></a><span id="l15.705">   }</span>
<a href="#l15.706"></a><span id="l15.706"> </span>
<a href="#l15.707"></a><span id="l15.707" class="difflineminus">-  /* Now search the newsrc line and figure out how many of these messages are marked as unread. */</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineplus">+  /* Now search the newsrc line and figure out how many of these messages are</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineplus">+   * marked as unread. */</span>
<a href="#l15.710"></a><span id="l15.710"> </span>
<a href="#l15.711"></a><span id="l15.711">   /* make sure youngest is a least 1. MSNews seems to return a youngest of 0. */</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-  if (youngest == 0)</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineminus">-    youngest = 1;</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineplus">+  if (youngest == 0) youngest = 1;</span>
<a href="#l15.715"></a><span id="l15.715"> </span>
<a href="#l15.716"></a><span id="l15.716">   int32_t unread = mReadSet-&gt;CountMissingInRange(oldest, youngest);</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineminus">-  NS_ASSERTION(unread &gt;= 0,&quot;CountMissingInRange reported unread &lt; 0&quot;);</span>
<a href="#l15.718"></a><span id="l15.718" class="difflineplus">+  NS_ASSERTION(unread &gt;= 0, &quot;CountMissingInRange reported unread &lt; 0&quot;);</span>
<a href="#l15.719"></a><span id="l15.719">   if (unread &lt; 0)</span>
<a href="#l15.720"></a><span id="l15.720">     // servers can send us stuff like &quot;211 0 41 40 nz.netstatus&quot;</span>
<a href="#l15.721"></a><span id="l15.721">     // we should handle it gracefully.</span>
<a href="#l15.722"></a><span id="l15.722">     unread = 0;</span>
<a href="#l15.723"></a><span id="l15.723"> </span>
<a href="#l15.724"></a><span id="l15.724" class="difflineminus">-  if (unread &gt; total)</span>
<a href="#l15.725"></a><span id="l15.725" class="difflineminus">-  {</span>
<a href="#l15.726"></a><span id="l15.726" class="difflineminus">-    /* This can happen when the newsrc file shows more unread than exist in the group (total is not necessarily `end - start'.) */</span>
<a href="#l15.727"></a><span id="l15.727" class="difflineplus">+  if (unread &gt; total) {</span>
<a href="#l15.728"></a><span id="l15.728" class="difflineplus">+    /* This can happen when the newsrc file shows more unread than exist in the</span>
<a href="#l15.729"></a><span id="l15.729" class="difflineplus">+     * group (total is not necessarily `end - start'.) */</span>
<a href="#l15.730"></a><span id="l15.730">     unread = total;</span>
<a href="#l15.731"></a><span id="l15.731">     int32_t deltaInDB = mNumTotalMessages - mNumUnreadMessages;</span>
<a href="#l15.732"></a><span id="l15.732" class="difflineminus">-    //int32_t deltaInDB = m_totalInDB - m_unreadInDB;</span>
<a href="#l15.733"></a><span id="l15.733" class="difflineminus">-    /* if we know there are read messages in the db, subtract that from the unread total */</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineminus">-    if (deltaInDB &gt; 0)</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineminus">-      unread -= deltaInDB;</span>
<a href="#l15.736"></a><span id="l15.736" class="difflineplus">+    // int32_t deltaInDB = m_totalInDB - m_unreadInDB;</span>
<a href="#l15.737"></a><span id="l15.737" class="difflineplus">+    /* if we know there are read messages in the db, subtract that from the</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineplus">+     * unread total */</span>
<a href="#l15.739"></a><span id="l15.739" class="difflineplus">+    if (deltaInDB &gt; 0) unread -= deltaInDB;</span>
<a href="#l15.740"></a><span id="l15.740">   }</span>
<a href="#l15.741"></a><span id="l15.741"> </span>
<a href="#l15.742"></a><span id="l15.742">   bool dbWasOpen = mDatabase != nullptr;</span>
<a href="#l15.743"></a><span id="l15.743" class="difflineminus">-  int32_t pendingUnreadDelta = unread - mNumUnreadMessages - mNumPendingUnreadMessages;</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineminus">-  int32_t pendingTotalDelta = total - mNumTotalMessages - mNumPendingTotalMessages;</span>
<a href="#l15.745"></a><span id="l15.745" class="difflineplus">+  int32_t pendingUnreadDelta =</span>
<a href="#l15.746"></a><span id="l15.746" class="difflineplus">+      unread - mNumUnreadMessages - mNumPendingUnreadMessages;</span>
<a href="#l15.747"></a><span id="l15.747" class="difflineplus">+  int32_t pendingTotalDelta =</span>
<a href="#l15.748"></a><span id="l15.748" class="difflineplus">+      total - mNumTotalMessages - mNumPendingTotalMessages;</span>
<a href="#l15.749"></a><span id="l15.749">   ChangeNumPendingUnread(pendingUnreadDelta);</span>
<a href="#l15.750"></a><span id="l15.750">   ChangeNumPendingTotalMessages(pendingTotalDelta);</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-  if (!dbWasOpen &amp;&amp; mDatabase)</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineminus">-  {</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineplus">+  if (!dbWasOpen &amp;&amp; mDatabase) {</span>
<a href="#l15.754"></a><span id="l15.754">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l15.755"></a><span id="l15.755">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l15.756"></a><span id="l15.756">     mDatabase = nullptr;</span>
<a href="#l15.757"></a><span id="l15.757">   }</span>
<a href="#l15.758"></a><span id="l15.758">   return NS_OK;</span>
<a href="#l15.759"></a><span id="l15.759"> }</span>
<a href="#l15.760"></a><span id="l15.760"> </span>
<a href="#l15.761"></a><span id="l15.761" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetExpungedBytesCount(int64_t *count)</span>
<a href="#l15.762"></a><span id="l15.762" class="difflineminus">-{</span>
<a href="#l15.763"></a><span id="l15.763" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetExpungedBytesCount(int64_t *count) {</span>
<a href="#l15.764"></a><span id="l15.764">   NS_ENSURE_ARG_POINTER(count);</span>
<a href="#l15.765"></a><span id="l15.765">   *count = mExpungedBytes;</span>
<a href="#l15.766"></a><span id="l15.766">   return NS_OK;</span>
<a href="#l15.767"></a><span id="l15.767"> }</span>
<a href="#l15.768"></a><span id="l15.768"> </span>
<a href="#l15.769"></a><span id="l15.769" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetDeletable(bool *deletable)</span>
<a href="#l15.770"></a><span id="l15.770" class="difflineminus">-{</span>
<a href="#l15.771"></a><span id="l15.771" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetDeletable(bool *deletable) {</span>
<a href="#l15.772"></a><span id="l15.772">   NS_ENSURE_ARG_POINTER(deletable);</span>
<a href="#l15.773"></a><span id="l15.773"> </span>
<a href="#l15.774"></a><span id="l15.774">   *deletable = false;</span>
<a href="#l15.775"></a><span id="l15.775">   // For legacy reasons, there can be Saved search folders under news accounts.</span>
<a href="#l15.776"></a><span id="l15.776">   // Allow deleting those.</span>
<a href="#l15.777"></a><span id="l15.777">   GetFlag(nsMsgFolderFlags::Virtual, deletable);</span>
<a href="#l15.778"></a><span id="l15.778">   return NS_OK;</span>
<a href="#l15.779"></a><span id="l15.779"> }</span>
<a href="#l15.780"></a><span id="l15.780"> </span>
<a href="#l15.781"></a><span id="l15.781" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::RefreshSizeOnDisk()</span>
<a href="#l15.782"></a><span id="l15.782" class="difflineminus">-{</span>
<a href="#l15.783"></a><span id="l15.783" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::RefreshSizeOnDisk() {</span>
<a href="#l15.784"></a><span id="l15.784">   uint64_t oldFolderSize = mFolderSize;</span>
<a href="#l15.785"></a><span id="l15.785">   // We set size to unknown to force it to get recalculated from disk.</span>
<a href="#l15.786"></a><span id="l15.786">   mFolderSize = kSizeUnknown;</span>
<a href="#l15.787"></a><span id="l15.787">   if (NS_SUCCEEDED(GetSizeOnDisk(&amp;mFolderSize)))</span>
<a href="#l15.788"></a><span id="l15.788">     NotifyIntPropertyChanged(kFolderSize, oldFolderSize, mFolderSize);</span>
<a href="#l15.789"></a><span id="l15.789">   return NS_OK;</span>
<a href="#l15.790"></a><span id="l15.790"> }</span>
<a href="#l15.791"></a><span id="l15.791"> </span>
<a href="#l15.792"></a><span id="l15.792" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetSizeOnDisk(int64_t *size)</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineminus">-{</span>
<a href="#l15.794"></a><span id="l15.794" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetSizeOnDisk(int64_t *size) {</span>
<a href="#l15.795"></a><span id="l15.795">   NS_ENSURE_ARG_POINTER(size);</span>
<a href="#l15.796"></a><span id="l15.796"> </span>
<a href="#l15.797"></a><span id="l15.797">   bool isServer = false;</span>
<a href="#l15.798"></a><span id="l15.798">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l15.799"></a><span id="l15.799">   // If this is the rootFolder, return 0 as a safe value.</span>
<a href="#l15.800"></a><span id="l15.800" class="difflineminus">-  if (NS_FAILED(rv) || isServer)</span>
<a href="#l15.801"></a><span id="l15.801" class="difflineminus">-    mFolderSize = 0;</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineplus">+  if (NS_FAILED(rv) || isServer) mFolderSize = 0;</span>
<a href="#l15.803"></a><span id="l15.803"> </span>
<a href="#l15.804"></a><span id="l15.804">   // 0 is a valid folder size (meaning empty file with no offline messages),</span>
<a href="#l15.805"></a><span id="l15.805">   // but 1 is not. So use -1 as a special value meaning no file size was fetched</span>
<a href="#l15.806"></a><span id="l15.806">   // from disk yet.</span>
<a href="#l15.807"></a><span id="l15.807" class="difflineminus">-  if (mFolderSize == kSizeUnknown)</span>
<a href="#l15.808"></a><span id="l15.808" class="difflineminus">-  {</span>
<a href="#l15.809"></a><span id="l15.809" class="difflineplus">+  if (mFolderSize == kSizeUnknown) {</span>
<a href="#l15.810"></a><span id="l15.810">     nsCOMPtr&lt;nsIFile&gt; diskFile;</span>
<a href="#l15.811"></a><span id="l15.811">     nsresult rv = GetFilePath(getter_AddRefs(diskFile));</span>
<a href="#l15.812"></a><span id="l15.812">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.813"></a><span id="l15.813"> </span>
<a href="#l15.814"></a><span id="l15.814" class="difflineminus">-    // If there were no news messages downloaded for offline use, the folder file</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineminus">-    // may not exist yet. In that case size is 0.</span>
<a href="#l15.816"></a><span id="l15.816" class="difflineplus">+    // If there were no news messages downloaded for offline use, the folder</span>
<a href="#l15.817"></a><span id="l15.817" class="difflineplus">+    // file may not exist yet. In that case size is 0.</span>
<a href="#l15.818"></a><span id="l15.818">     bool exists = false;</span>
<a href="#l15.819"></a><span id="l15.819">     rv = diskFile-&gt;Exists(&amp;exists);</span>
<a href="#l15.820"></a><span id="l15.820" class="difflineminus">-    if (NS_FAILED(rv) || !exists)</span>
<a href="#l15.821"></a><span id="l15.821" class="difflineminus">-    {</span>
<a href="#l15.822"></a><span id="l15.822" class="difflineplus">+    if (NS_FAILED(rv) || !exists) {</span>
<a href="#l15.823"></a><span id="l15.823">       mFolderSize = 0;</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineminus">-    }</span>
<a href="#l15.825"></a><span id="l15.825" class="difflineminus">-    else</span>
<a href="#l15.826"></a><span id="l15.826" class="difflineminus">-    {</span>
<a href="#l15.827"></a><span id="l15.827" class="difflineplus">+    } else {</span>
<a href="#l15.828"></a><span id="l15.828">       int64_t fileSize;</span>
<a href="#l15.829"></a><span id="l15.829">       rv = diskFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l15.830"></a><span id="l15.830">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.831"></a><span id="l15.831">       mFolderSize = fileSize;</span>
<a href="#l15.832"></a><span id="l15.832">     }</span>
<a href="#l15.833"></a><span id="l15.833">   }</span>
<a href="#l15.834"></a><span id="l15.834"> </span>
<a href="#l15.835"></a><span id="l15.835">   *size = mFolderSize;</span>
<a href="#l15.836"></a><span id="l15.836">   return NS_OK;</span>
<a href="#l15.837"></a><span id="l15.837"> }</span>
<a href="#l15.838"></a><span id="l15.838"> </span>
<a href="#l15.839"></a><span id="l15.839"> NS_IMETHODIMP</span>
<a href="#l15.840"></a><span id="l15.840"> nsMsgNewsFolder::DeleteMessages(nsIArray *messages, nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.841"></a><span id="l15.841">                                 bool deleteStorage, bool isMove,</span>
<a href="#l15.842"></a><span id="l15.842" class="difflineminus">-                                nsIMsgCopyServiceListener* listener,</span>
<a href="#l15.843"></a><span id="l15.843" class="difflineminus">-                                bool allowUndo)</span>
<a href="#l15.844"></a><span id="l15.844" class="difflineminus">-{</span>
<a href="#l15.845"></a><span id="l15.845" class="difflineplus">+                                nsIMsgCopyServiceListener *listener,</span>
<a href="#l15.846"></a><span id="l15.846" class="difflineplus">+                                bool allowUndo) {</span>
<a href="#l15.847"></a><span id="l15.847">   nsresult rv = NS_OK;</span>
<a href="#l15.848"></a><span id="l15.848"> </span>
<a href="#l15.849"></a><span id="l15.849">   NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l15.850"></a><span id="l15.850">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l15.851"></a><span id="l15.851"> </span>
<a href="#l15.852"></a><span id="l15.852" class="difflineminus">-  if (!isMove)</span>
<a href="#l15.853"></a><span id="l15.853" class="difflineminus">-  {</span>
<a href="#l15.854"></a><span id="l15.854" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.855"></a><span id="l15.855" class="difflineminus">-    if (notifier)</span>
<a href="#l15.856"></a><span id="l15.856" class="difflineminus">-      notifier-&gt;NotifyMsgsDeleted(messages);</span>
<a href="#l15.857"></a><span id="l15.857" class="difflineplus">+  if (!isMove) {</span>
<a href="#l15.858"></a><span id="l15.858" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l15.859"></a><span id="l15.859" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.860"></a><span id="l15.860" class="difflineplus">+    if (notifier) notifier-&gt;NotifyMsgsDeleted(messages);</span>
<a href="#l15.861"></a><span id="l15.861">   }</span>
<a href="#l15.862"></a><span id="l15.862"> </span>
<a href="#l15.863"></a><span id="l15.863">   rv = GetDatabase();</span>
<a href="#l15.864"></a><span id="l15.864">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.865"></a><span id="l15.865"> </span>
<a href="#l15.866"></a><span id="l15.866">   rv = EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l15.867"></a><span id="l15.867" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.868"></a><span id="l15.868" class="difflineminus">-  {</span>
<a href="#l15.869"></a><span id="l15.869" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.870"></a><span id="l15.870">     uint32_t count = 0;</span>
<a href="#l15.871"></a><span id="l15.871">     rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l15.872"></a><span id="l15.872">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.873"></a><span id="l15.873"> </span>
<a href="#l15.874"></a><span id="l15.874" class="difflineminus">-    for (uint32_t i = 0; i &lt; count &amp;&amp; NS_SUCCEEDED(rv); i++)</span>
<a href="#l15.875"></a><span id="l15.875" class="difflineminus">-    {</span>
<a href="#l15.876"></a><span id="l15.876" class="difflineplus">+    for (uint32_t i = 0; i &lt; count &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l15.877"></a><span id="l15.877">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l15.878"></a><span id="l15.878" class="difflineminus">-      if (msgHdr)</span>
<a href="#l15.879"></a><span id="l15.879" class="difflineminus">-        rv = mDatabase-&gt;DeleteHeader(msgHdr, nullptr, true, true);</span>
<a href="#l15.880"></a><span id="l15.880" class="difflineplus">+      if (msgHdr) rv = mDatabase-&gt;DeleteHeader(msgHdr, nullptr, true, true);</span>
<a href="#l15.881"></a><span id="l15.881">     }</span>
<a href="#l15.882"></a><span id="l15.882">     EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l15.883"></a><span id="l15.883">   }</span>
<a href="#l15.884"></a><span id="l15.884"> </span>
<a href="#l15.885"></a><span id="l15.885">   if (!isMove)</span>
<a href="#l15.886"></a><span id="l15.886" class="difflineminus">-    NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted :</span>
<a href="#l15.887"></a><span id="l15.887" class="difflineminus">-      kDeleteOrMoveMsgFailed);</span>
<a href="#l15.888"></a><span id="l15.888" class="difflineplus">+    NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted</span>
<a href="#l15.889"></a><span id="l15.889" class="difflineplus">+                                       : kDeleteOrMoveMsgFailed);</span>
<a href="#l15.890"></a><span id="l15.890"> </span>
<a href="#l15.891"></a><span id="l15.891" class="difflineminus">-  if (listener)</span>
<a href="#l15.892"></a><span id="l15.892" class="difflineminus">-  {</span>
<a href="#l15.893"></a><span id="l15.893" class="difflineplus">+  if (listener) {</span>
<a href="#l15.894"></a><span id="l15.894">     listener-&gt;OnStartCopy();</span>
<a href="#l15.895"></a><span id="l15.895">     listener-&gt;OnStopCopy(NS_OK);</span>
<a href="#l15.896"></a><span id="l15.896">   }</span>
<a href="#l15.897"></a><span id="l15.897"> </span>
<a href="#l15.898"></a><span id="l15.898" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l15.899"></a><span id="l15.899" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l15.900"></a><span id="l15.900"> </span>
<a href="#l15.901"></a><span id="l15.901">   return NS_OK;</span>
<a href="#l15.902"></a><span id="l15.902"> }</span>
<a href="#l15.903"></a><span id="l15.903"> </span>
<a href="#l15.904"></a><span id="l15.904"> NS_IMETHODIMP nsMsgNewsFolder::CancelMessage(nsIMsgDBHdr *msgHdr,</span>
<a href="#l15.905"></a><span id="l15.905" class="difflineminus">-                                             nsIMsgWindow *aMsgWindow)</span>
<a href="#l15.906"></a><span id="l15.906" class="difflineminus">-{</span>
<a href="#l15.907"></a><span id="l15.907" class="difflineplus">+                                             nsIMsgWindow *aMsgWindow) {</span>
<a href="#l15.908"></a><span id="l15.908">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l15.909"></a><span id="l15.909">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l15.910"></a><span id="l15.910"> </span>
<a href="#l15.911"></a><span id="l15.911">   nsresult rv;</span>
<a href="#l15.912"></a><span id="l15.912"> </span>
<a href="#l15.913"></a><span id="l15.913" class="difflineminus">-  nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.914"></a><span id="l15.914" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.915"></a><span id="l15.915" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l15.916"></a><span id="l15.916" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.917"></a><span id="l15.917" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.918"></a><span id="l15.918"> </span>
<a href="#l15.919"></a><span id="l15.919">   // for cancel, we need to</span>
<a href="#l15.920"></a><span id="l15.920">   // turn &quot;newsmessage://sspitzer@news.mozilla.org/netscape.test#5428&quot;</span>
<a href="#l15.921"></a><span id="l15.921">   // into &quot;news://sspitzer@news.mozilla.org/23423@netscape.com&quot;</span>
<a href="#l15.922"></a><span id="l15.922"> </span>
<a href="#l15.923"></a><span id="l15.923" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.924"></a><span id="l15.924" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.925"></a><span id="l15.925">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.926"></a><span id="l15.926" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.927"></a><span id="l15.927" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.928"></a><span id="l15.928"> </span>
<a href="#l15.929"></a><span id="l15.929">   nsCString serverURI;</span>
<a href="#l15.930"></a><span id="l15.930">   rv = server-&gt;GetServerURI(serverURI);</span>
<a href="#l15.931"></a><span id="l15.931" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.932"></a><span id="l15.932" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.933"></a><span id="l15.933"> </span>
<a href="#l15.934"></a><span id="l15.934">   nsCString messageID;</span>
<a href="#l15.935"></a><span id="l15.935">   rv = msgHdr-&gt;GetMessageId(getter_Copies(messageID));</span>
<a href="#l15.936"></a><span id="l15.936" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.937"></a><span id="l15.937" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.938"></a><span id="l15.938"> </span>
<a href="#l15.939"></a><span id="l15.939">   // we need to escape the message ID,</span>
<a href="#l15.940"></a><span id="l15.940">   // it might contain characters which will mess us up later, like #</span>
<a href="#l15.941"></a><span id="l15.941">   // see bug #120502</span>
<a href="#l15.942"></a><span id="l15.942">   nsCString escapedMessageID;</span>
<a href="#l15.943"></a><span id="l15.943">   MsgEscapeString(messageID, nsINetUtil::ESCAPE_URL_PATH, escapedMessageID);</span>
<a href="#l15.944"></a><span id="l15.944"> </span>
<a href="#l15.945"></a><span id="l15.945">   nsAutoCString cancelURL(serverURI.get());</span>
<a href="#l15.946"></a><span id="l15.946">   cancelURL += '/';</span>
<a href="#l15.947"></a><span id="l15.947">   cancelURL += escapedMessageID;</span>
<a href="#l15.948"></a><span id="l15.948">   cancelURL += &quot;?cancel&quot;;</span>
<a href="#l15.949"></a><span id="l15.949"> </span>
<a href="#l15.950"></a><span id="l15.950">   nsCString messageURI;</span>
<a href="#l15.951"></a><span id="l15.951">   rv = GetUriForMsg(msgHdr, messageURI);</span>
<a href="#l15.952"></a><span id="l15.952" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.953"></a><span id="l15.953" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.954"></a><span id="l15.954"> </span>
<a href="#l15.955"></a><span id="l15.955" class="difflineminus">-  return nntpService-&gt;CancelMessage(cancelURL.get(), messageURI.get(), nullptr /* consumer */, nullptr,</span>
<a href="#l15.956"></a><span id="l15.956" class="difflineminus">-                                    aMsgWindow, nullptr);</span>
<a href="#l15.957"></a><span id="l15.957" class="difflineplus">+  return nntpService-&gt;CancelMessage(cancelURL.get(), messageURI.get(),</span>
<a href="#l15.958"></a><span id="l15.958" class="difflineplus">+                                    nullptr /* consumer */, nullptr, aMsgWindow,</span>
<a href="#l15.959"></a><span id="l15.959" class="difflineplus">+                                    nullptr);</span>
<a href="#l15.960"></a><span id="l15.960"> }</span>
<a href="#l15.961"></a><span id="l15.961"> </span>
<a href="#l15.962"></a><span id="l15.962" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetNewMessages(nsIMsgWindow *aMsgWindow, nsIUrlListener *aListener)</span>
<a href="#l15.963"></a><span id="l15.963" class="difflineminus">-{</span>
<a href="#l15.964"></a><span id="l15.964" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetNewMessages(nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.965"></a><span id="l15.965" class="difflineplus">+                                              nsIUrlListener *aListener) {</span>
<a href="#l15.966"></a><span id="l15.966">   return GetNewsMessages(aMsgWindow, false, aListener);</span>
<a href="#l15.967"></a><span id="l15.967"> }</span>
<a href="#l15.968"></a><span id="l15.968"> </span>
<a href="#l15.969"></a><span id="l15.969" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetNextNMessages(nsIMsgWindow *aMsgWindow)</span>
<a href="#l15.970"></a><span id="l15.970" class="difflineminus">-{</span>
<a href="#l15.971"></a><span id="l15.971" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetNextNMessages(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l15.972"></a><span id="l15.972">   return GetNewsMessages(aMsgWindow, true, nullptr);</span>
<a href="#l15.973"></a><span id="l15.973"> }</span>
<a href="#l15.974"></a><span id="l15.974"> </span>
<a href="#l15.975"></a><span id="l15.975" class="difflineminus">-nsresult nsMsgNewsFolder::GetNewsMessages(nsIMsgWindow *aMsgWindow, bool aGetOld, nsIUrlListener *aUrlListener)</span>
<a href="#l15.976"></a><span id="l15.976" class="difflineminus">-{</span>
<a href="#l15.977"></a><span id="l15.977" class="difflineplus">+nsresult nsMsgNewsFolder::GetNewsMessages(nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.978"></a><span id="l15.978" class="difflineplus">+                                          bool aGetOld,</span>
<a href="#l15.979"></a><span id="l15.979" class="difflineplus">+                                          nsIUrlListener *aUrlListener) {</span>
<a href="#l15.980"></a><span id="l15.980">   nsresult rv = NS_OK;</span>
<a href="#l15.981"></a><span id="l15.981"> </span>
<a href="#l15.982"></a><span id="l15.982">   bool isNewsServer = false;</span>
<a href="#l15.983"></a><span id="l15.983">   rv = GetIsServer(&amp;isNewsServer);</span>
<a href="#l15.984"></a><span id="l15.984">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.985"></a><span id="l15.985"> </span>
<a href="#l15.986"></a><span id="l15.986">   if (isNewsServer)</span>
<a href="#l15.987"></a><span id="l15.987">     // get new messages only works on a newsgroup, not a news server</span>
<a href="#l15.988"></a><span id="l15.988">     return NS_OK;</span>
<a href="#l15.989"></a><span id="l15.989"> </span>
<a href="#l15.990"></a><span id="l15.990" class="difflineminus">-  nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.991"></a><span id="l15.991" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.992"></a><span id="l15.992" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l15.993"></a><span id="l15.993" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.994"></a><span id="l15.994" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.995"></a><span id="l15.995"> </span>
<a href="#l15.996"></a><span id="l15.996">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.997"></a><span id="l15.997">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.998"></a><span id="l15.998">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.999"></a><span id="l15.999"> </span>
<a href="#l15.1000"></a><span id="l15.1000" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; resultUri;</span>
<a href="#l15.1001"></a><span id="l15.1001" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; resultUri;</span>
<a href="#l15.1002"></a><span id="l15.1002">   rv = nntpService-&gt;GetNewNews(nntpServer, mURI.get(), aGetOld, this,</span>
<a href="#l15.1003"></a><span id="l15.1003">                                aMsgWindow, getter_AddRefs(resultUri));</span>
<a href="#l15.1004"></a><span id="l15.1004" class="difflineminus">-  if (aUrlListener &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; resultUri)</span>
<a href="#l15.1005"></a><span id="l15.1005" class="difflineminus">-  {</span>
<a href="#l15.1006"></a><span id="l15.1006" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(resultUri));</span>
<a href="#l15.1007"></a><span id="l15.1007" class="difflineminus">-    if (msgUrl)</span>
<a href="#l15.1008"></a><span id="l15.1008" class="difflineminus">-      msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l15.1009"></a><span id="l15.1009" class="difflineplus">+  if (aUrlListener &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; resultUri) {</span>
<a href="#l15.1010"></a><span id="l15.1010" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(resultUri));</span>
<a href="#l15.1011"></a><span id="l15.1011" class="difflineplus">+    if (msgUrl) msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l15.1012"></a><span id="l15.1012">   }</span>
<a href="#l15.1013"></a><span id="l15.1013">   return rv;</span>
<a href="#l15.1014"></a><span id="l15.1014"> }</span>
<a href="#l15.1015"></a><span id="l15.1015"> </span>
<a href="#l15.1016"></a><span id="l15.1016" class="difflineminus">-nsresult</span>
<a href="#l15.1017"></a><span id="l15.1017" class="difflineminus">-nsMsgNewsFolder::LoadNewsrcFileAndCreateNewsgroups()</span>
<a href="#l15.1018"></a><span id="l15.1018" class="difflineminus">-{</span>
<a href="#l15.1019"></a><span id="l15.1019" class="difflineplus">+nsresult nsMsgNewsFolder::LoadNewsrcFileAndCreateNewsgroups() {</span>
<a href="#l15.1020"></a><span id="l15.1020">   nsresult rv = NS_OK;</span>
<a href="#l15.1021"></a><span id="l15.1021">   if (!mNewsrcFilePath) return NS_ERROR_FAILURE;</span>
<a href="#l15.1022"></a><span id="l15.1022"> </span>
<a href="#l15.1023"></a><span id="l15.1023">   bool exists;</span>
<a href="#l15.1024"></a><span id="l15.1024">   rv = mNewsrcFilePath-&gt;Exists(&amp;exists);</span>
<a href="#l15.1025"></a><span id="l15.1025">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.1026"></a><span id="l15.1026"> </span>
<a href="#l15.1027"></a><span id="l15.1027">   if (!exists)</span>
<a href="#l15.1028"></a><span id="l15.1028">     // it is ok for the newsrc file to not exist yet</span>
<a href="#l15.1029"></a><span id="l15.1029">     return NS_OK;</span>
<a href="#l15.1030"></a><span id="l15.1030"> </span>
<a href="#l15.1031"></a><span id="l15.1031">   nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l15.1032"></a><span id="l15.1032">   rv = NS_NewLocalFileInputStream(getter_AddRefs(fileStream), mNewsrcFilePath);</span>
<a href="#l15.1033"></a><span id="l15.1033">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1034"></a><span id="l15.1034"> </span>
<a href="#l15.1035"></a><span id="l15.1035" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l15.1036"></a><span id="l15.1036" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(</span>
<a href="#l15.1037"></a><span id="l15.1037" class="difflineplus">+      do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l15.1038"></a><span id="l15.1038">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1039"></a><span id="l15.1039"> </span>
<a href="#l15.1040"></a><span id="l15.1040">   bool more = true;</span>
<a href="#l15.1041"></a><span id="l15.1041">   nsCString line;</span>
<a href="#l15.1042"></a><span id="l15.1042"> </span>
<a href="#l15.1043"></a><span id="l15.1043" class="difflineminus">-  while (more &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.1044"></a><span id="l15.1044" class="difflineminus">-  {</span>
<a href="#l15.1045"></a><span id="l15.1045" class="difflineplus">+  while (more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l15.1046"></a><span id="l15.1046">     rv = lineInputStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l15.1047"></a><span id="l15.1047" class="difflineminus">-    if (line.IsEmpty())</span>
<a href="#l15.1048"></a><span id="l15.1048" class="difflineminus">-      continue;</span>
<a href="#l15.1049"></a><span id="l15.1049" class="difflineplus">+    if (line.IsEmpty()) continue;</span>
<a href="#l15.1050"></a><span id="l15.1050">     HandleNewsrcLine(line.get(), line.Length());</span>
<a href="#l15.1051"></a><span id="l15.1051">   }</span>
<a href="#l15.1052"></a><span id="l15.1052"> </span>
<a href="#l15.1053"></a><span id="l15.1053">   fileStream-&gt;Close();</span>
<a href="#l15.1054"></a><span id="l15.1054">   return rv;</span>
<a href="#l15.1055"></a><span id="l15.1055"> }</span>
<a href="#l15.1056"></a><span id="l15.1056"> </span>
<a href="#l15.1057"></a><span id="l15.1057" class="difflineminus">-int32_t</span>
<a href="#l15.1058"></a><span id="l15.1058" class="difflineminus">-nsMsgNewsFolder::HandleNewsrcLine(const char * line, uint32_t line_size)</span>
<a href="#l15.1059"></a><span id="l15.1059" class="difflineminus">-{</span>
<a href="#l15.1060"></a><span id="l15.1060" class="difflineplus">+int32_t nsMsgNewsFolder::HandleNewsrcLine(const char *line,</span>
<a href="#l15.1061"></a><span id="l15.1061" class="difflineplus">+                                          uint32_t line_size) {</span>
<a href="#l15.1062"></a><span id="l15.1062">   nsresult rv;</span>
<a href="#l15.1063"></a><span id="l15.1063"> </span>
<a href="#l15.1064"></a><span id="l15.1064">   /* guard against blank line lossage */</span>
<a href="#l15.1065"></a><span id="l15.1065">   if (line[0] == '#' || line[0] == '\r' || line[0] == '\n') return 0;</span>
<a href="#l15.1066"></a><span id="l15.1066"> </span>
<a href="#l15.1067"></a><span id="l15.1067" class="difflineminus">-  if ((line[0] == 'o' || line[0] == 'O') &amp;&amp;</span>
<a href="#l15.1068"></a><span id="l15.1068" class="difflineminus">-    !PL_strncasecmp (line, &quot;options&quot;, 7))</span>
<a href="#l15.1069"></a><span id="l15.1069" class="difflineplus">+  if ((line[0] == 'o' || line[0] == 'O') &amp;&amp; !PL_strncasecmp(line, &quot;options&quot;, 7))</span>
<a href="#l15.1070"></a><span id="l15.1070">     return RememberLine(nsDependentCString(line));</span>
<a href="#l15.1071"></a><span id="l15.1071"> </span>
<a href="#l15.1072"></a><span id="l15.1072">   const char *s = nullptr;</span>
<a href="#l15.1073"></a><span id="l15.1073">   const char *setStr = nullptr;</span>
<a href="#l15.1074"></a><span id="l15.1074">   const char *end = line + line_size;</span>
<a href="#l15.1075"></a><span id="l15.1075"> </span>
<a href="#l15.1076"></a><span id="l15.1076" class="difflineminus">-  for (s = line; s &lt; end;  s++)</span>
<a href="#l15.1077"></a><span id="l15.1077" class="difflineminus">-    if ((*s == ':') || (*s == '!'))</span>
<a href="#l15.1078"></a><span id="l15.1078" class="difflineminus">-      break;</span>
<a href="#l15.1079"></a><span id="l15.1079" class="difflineplus">+  for (s = line; s &lt; end; s++)</span>
<a href="#l15.1080"></a><span id="l15.1080" class="difflineplus">+    if ((*s == ':') || (*s == '!')) break;</span>
<a href="#l15.1081"></a><span id="l15.1081"> </span>
<a href="#l15.1082"></a><span id="l15.1082" class="difflineminus">-  if (*s == 0)</span>
<a href="#l15.1083"></a><span id="l15.1083" class="difflineminus">-    /* What is this?? Well, don't just throw it away... */</span>
<a href="#l15.1084"></a><span id="l15.1084" class="difflineplus">+  if (*s == 0) /* What is this?? Well, don't just throw it away... */</span>
<a href="#l15.1085"></a><span id="l15.1085">     return RememberLine(nsDependentCString(line));</span>
<a href="#l15.1086"></a><span id="l15.1086"> </span>
<a href="#l15.1087"></a><span id="l15.1087">   bool subscribed = (*s == ':');</span>
<a href="#l15.1088"></a><span id="l15.1088" class="difflineminus">-  setStr = s+1;</span>
<a href="#l15.1089"></a><span id="l15.1089" class="difflineplus">+  setStr = s + 1;</span>
<a href="#l15.1090"></a><span id="l15.1090"> </span>
<a href="#l15.1091"></a><span id="l15.1091" class="difflineminus">-  if (*line == '\0')</span>
<a href="#l15.1092"></a><span id="l15.1092" class="difflineminus">-    return 0;</span>
<a href="#l15.1093"></a><span id="l15.1093" class="difflineplus">+  if (*line == '\0') return 0;</span>
<a href="#l15.1094"></a><span id="l15.1094"> </span>
<a href="#l15.1095"></a><span id="l15.1095">   // previous versions of Communicator polluted the</span>
<a href="#l15.1096"></a><span id="l15.1096">   // newsrc files with articles</span>
<a href="#l15.1097"></a><span id="l15.1097">   // (this would happen when you clicked on a link like</span>
<a href="#l15.1098"></a><span id="l15.1098">   // news://news.mozilla.org/3746EF3F.6080309@netscape.com)</span>
<a href="#l15.1099"></a><span id="l15.1099">   //</span>
<a href="#l15.1100"></a><span id="l15.1100">   // legal newsgroup names can't contain @ or %</span>
<a href="#l15.1101"></a><span id="l15.1101">   //</span>
<a href="#l15.1102"></a><span id="l15.1102" class="difflineat">@@ -965,150 +902,140 @@ nsMsgNewsFolder::HandleNewsrcLine(const </span>
<a href="#l15.1103"></a><span id="l15.1103">   //</span>
<a href="#l15.1104"></a><span id="l15.1104">   // So lines like this in a newsrc file should be ignored:</span>
<a href="#l15.1105"></a><span id="l15.1105">   // 3746EF3F.6080309@netscape.com:</span>
<a href="#l15.1106"></a><span id="l15.1106">   // 3746EF3F.6080309%40netscape.com:</span>
<a href="#l15.1107"></a><span id="l15.1107">   if (PL_strchr(line, '@') || PL_strstr(line, &quot;%40&quot;))</span>
<a href="#l15.1108"></a><span id="l15.1108">     // skipping, it contains @ or %40</span>
<a href="#l15.1109"></a><span id="l15.1109">     subscribed = false;</span>
<a href="#l15.1110"></a><span id="l15.1110"> </span>
<a href="#l15.1111"></a><span id="l15.1111" class="difflineminus">-  if (subscribed)</span>
<a href="#l15.1112"></a><span id="l15.1112" class="difflineminus">-  {</span>
<a href="#l15.1113"></a><span id="l15.1113" class="difflineplus">+  if (subscribed) {</span>
<a href="#l15.1114"></a><span id="l15.1114">     // we're subscribed, so add it</span>
<a href="#l15.1115"></a><span id="l15.1115" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; child;</span>
<a href="#l15.1116"></a><span id="l15.1116" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l15.1117"></a><span id="l15.1117"> </span>
<a href="#l15.1118"></a><span id="l15.1118" class="difflineminus">-    rv = AddNewsgroup(Substring(line, s), nsDependentCString(setStr), getter_AddRefs(child));</span>
<a href="#l15.1119"></a><span id="l15.1119" class="difflineplus">+    rv = AddNewsgroup(Substring(line, s), nsDependentCString(setStr),</span>
<a href="#l15.1120"></a><span id="l15.1120" class="difflineplus">+                      getter_AddRefs(child));</span>
<a href="#l15.1121"></a><span id="l15.1121">     if (NS_FAILED(rv)) return -1;</span>
<a href="#l15.1122"></a><span id="l15.1122" class="difflineminus">-  }</span>
<a href="#l15.1123"></a><span id="l15.1123" class="difflineminus">-  else {</span>
<a href="#l15.1124"></a><span id="l15.1124" class="difflineminus">-    rv = RememberUnsubscribedGroup(nsDependentCString(line), nsDependentCString(setStr));</span>
<a href="#l15.1125"></a><span id="l15.1125" class="difflineplus">+  } else {</span>
<a href="#l15.1126"></a><span id="l15.1126" class="difflineplus">+    rv = RememberUnsubscribedGroup(nsDependentCString(line),</span>
<a href="#l15.1127"></a><span id="l15.1127" class="difflineplus">+                                   nsDependentCString(setStr));</span>
<a href="#l15.1128"></a><span id="l15.1128">     if (NS_FAILED(rv)) return -1;</span>
<a href="#l15.1129"></a><span id="l15.1129">   }</span>
<a href="#l15.1130"></a><span id="l15.1130"> </span>
<a href="#l15.1131"></a><span id="l15.1131">   return 0;</span>
<a href="#l15.1132"></a><span id="l15.1132"> }</span>
<a href="#l15.1133"></a><span id="l15.1133"> </span>
<a href="#l15.1134"></a><span id="l15.1134" class="difflineminus">-</span>
<a href="#l15.1135"></a><span id="l15.1135" class="difflineminus">-nsresult</span>
<a href="#l15.1136"></a><span id="l15.1136" class="difflineminus">-nsMsgNewsFolder::RememberUnsubscribedGroup(const nsACString&amp; newsgroup, const nsACString&amp; setStr)</span>
<a href="#l15.1137"></a><span id="l15.1137" class="difflineminus">-{</span>
<a href="#l15.1138"></a><span id="l15.1138" class="difflineplus">+nsresult nsMsgNewsFolder::RememberUnsubscribedGroup(const nsACString &amp;newsgroup,</span>
<a href="#l15.1139"></a><span id="l15.1139" class="difflineplus">+                                                    const nsACString &amp;setStr) {</span>
<a href="#l15.1140"></a><span id="l15.1140">   mUnsubscribedNewsgroupLines.Append(newsgroup);</span>
<a href="#l15.1141"></a><span id="l15.1141">   mUnsubscribedNewsgroupLines.AppendLiteral(&quot;! &quot;);</span>
<a href="#l15.1142"></a><span id="l15.1142">   if (!setStr.IsEmpty())</span>
<a href="#l15.1143"></a><span id="l15.1143">     mUnsubscribedNewsgroupLines.Append(setStr);</span>
<a href="#l15.1144"></a><span id="l15.1144">   else</span>
<a href="#l15.1145"></a><span id="l15.1145">     mUnsubscribedNewsgroupLines.Append(MSG_LINEBREAK);</span>
<a href="#l15.1146"></a><span id="l15.1146">   return NS_OK;</span>
<a href="#l15.1147"></a><span id="l15.1147"> }</span>
<a href="#l15.1148"></a><span id="l15.1148"> </span>
<a href="#l15.1149"></a><span id="l15.1149" class="difflineminus">-int32_t</span>
<a href="#l15.1150"></a><span id="l15.1150" class="difflineminus">-nsMsgNewsFolder::RememberLine(const nsACString&amp; line)</span>
<a href="#l15.1151"></a><span id="l15.1151" class="difflineminus">-{</span>
<a href="#l15.1152"></a><span id="l15.1152" class="difflineplus">+int32_t nsMsgNewsFolder::RememberLine(const nsACString &amp;line) {</span>
<a href="#l15.1153"></a><span id="l15.1153">   mOptionLines = line;</span>
<a href="#l15.1154"></a><span id="l15.1154">   mOptionLines.Append(MSG_LINEBREAK);</span>
<a href="#l15.1155"></a><span id="l15.1155">   return 0;</span>
<a href="#l15.1156"></a><span id="l15.1156"> }</span>
<a href="#l15.1157"></a><span id="l15.1157"> </span>
<a href="#l15.1158"></a><span id="l15.1158" class="difflineminus">-nsresult nsMsgNewsFolder::ForgetLine()</span>
<a href="#l15.1159"></a><span id="l15.1159" class="difflineminus">-{</span>
<a href="#l15.1160"></a><span id="l15.1160" class="difflineplus">+nsresult nsMsgNewsFolder::ForgetLine() {</span>
<a href="#l15.1161"></a><span id="l15.1161">   mOptionLines.Truncate();</span>
<a href="#l15.1162"></a><span id="l15.1162">   return NS_OK;</span>
<a href="#l15.1163"></a><span id="l15.1163"> }</span>
<a href="#l15.1164"></a><span id="l15.1164"> </span>
<a href="#l15.1165"></a><span id="l15.1165" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetGroupUsername(nsACString&amp; aGroupUsername)</span>
<a href="#l15.1166"></a><span id="l15.1166" class="difflineminus">-{</span>
<a href="#l15.1167"></a><span id="l15.1167" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetGroupUsername(nsACString &amp;aGroupUsername) {</span>
<a href="#l15.1168"></a><span id="l15.1168">   aGroupUsername = mGroupUsername;</span>
<a href="#l15.1169"></a><span id="l15.1169">   return NS_OK;</span>
<a href="#l15.1170"></a><span id="l15.1170"> }</span>
<a href="#l15.1171"></a><span id="l15.1171"> </span>
<a href="#l15.1172"></a><span id="l15.1172" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::SetGroupUsername(const nsACString&amp; aGroupUsername)</span>
<a href="#l15.1173"></a><span id="l15.1173" class="difflineminus">-{</span>
<a href="#l15.1174"></a><span id="l15.1174" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::SetGroupUsername(</span>
<a href="#l15.1175"></a><span id="l15.1175" class="difflineplus">+    const nsACString &amp;aGroupUsername) {</span>
<a href="#l15.1176"></a><span id="l15.1176">   mGroupUsername = aGroupUsername;</span>
<a href="#l15.1177"></a><span id="l15.1177">   return NS_OK;</span>
<a href="#l15.1178"></a><span id="l15.1178"> }</span>
<a href="#l15.1179"></a><span id="l15.1179"> </span>
<a href="#l15.1180"></a><span id="l15.1180" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetGroupPassword(nsACString&amp; aGroupPassword)</span>
<a href="#l15.1181"></a><span id="l15.1181" class="difflineminus">-{</span>
<a href="#l15.1182"></a><span id="l15.1182" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetGroupPassword(nsACString &amp;aGroupPassword) {</span>
<a href="#l15.1183"></a><span id="l15.1183">   aGroupPassword = mGroupPassword;</span>
<a href="#l15.1184"></a><span id="l15.1184">   return NS_OK;</span>
<a href="#l15.1185"></a><span id="l15.1185"> }</span>
<a href="#l15.1186"></a><span id="l15.1186"> </span>
<a href="#l15.1187"></a><span id="l15.1187" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::SetGroupPassword(const nsACString&amp; aGroupPassword)</span>
<a href="#l15.1188"></a><span id="l15.1188" class="difflineminus">-{</span>
<a href="#l15.1189"></a><span id="l15.1189" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::SetGroupPassword(</span>
<a href="#l15.1190"></a><span id="l15.1190" class="difflineplus">+    const nsACString &amp;aGroupPassword) {</span>
<a href="#l15.1191"></a><span id="l15.1191">   mGroupPassword = aGroupPassword;</span>
<a href="#l15.1192"></a><span id="l15.1192">   return NS_OK;</span>
<a href="#l15.1193"></a><span id="l15.1193"> }</span>
<a href="#l15.1194"></a><span id="l15.1194"> </span>
<a href="#l15.1195"></a><span id="l15.1195"> nsresult nsMsgNewsFolder::CreateNewsgroupUrlForSignon(const char *ref,</span>
<a href="#l15.1196"></a><span id="l15.1196" class="difflineminus">-    nsAString &amp;result)</span>
<a href="#l15.1197"></a><span id="l15.1197" class="difflineminus">-{</span>
<a href="#l15.1198"></a><span id="l15.1198" class="difflineplus">+                                                      nsAString &amp;result) {</span>
<a href="#l15.1199"></a><span id="l15.1199">   nsresult rv;</span>
<a href="#l15.1200"></a><span id="l15.1200"> </span>
<a href="#l15.1201"></a><span id="l15.1201">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.1202"></a><span id="l15.1202">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.1203"></a><span id="l15.1203">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.1204"></a><span id="l15.1204"> </span>
<a href="#l15.1205"></a><span id="l15.1205">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.1206"></a><span id="l15.1206">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.1207"></a><span id="l15.1207">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.1208"></a><span id="l15.1208"> </span>
<a href="#l15.1209"></a><span id="l15.1209">   bool singleSignon = true;</span>
<a href="#l15.1210"></a><span id="l15.1210">   rv = nntpServer-&gt;GetSingleSignon(&amp;singleSignon);</span>
<a href="#l15.1211"></a><span id="l15.1211"> </span>
<a href="#l15.1212"></a><span id="l15.1212">   nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l15.1213"></a><span id="l15.1213" class="difflineminus">-  if (singleSignon)</span>
<a href="#l15.1214"></a><span id="l15.1214" class="difflineminus">-  {</span>
<a href="#l15.1215"></a><span id="l15.1215" class="difflineplus">+  if (singleSignon) {</span>
<a href="#l15.1216"></a><span id="l15.1216">     nsCString serverURI;</span>
<a href="#l15.1217"></a><span id="l15.1217">     rv = server-&gt;GetServerURI(serverURI);</span>
<a href="#l15.1218"></a><span id="l15.1218">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1219"></a><span id="l15.1219"> </span>
<a href="#l15.1220"></a><span id="l15.1220" class="difflineminus">-    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(serverURI).Finalize(url);</span>
<a href="#l15.1221"></a><span id="l15.1221" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l15.1222"></a><span id="l15.1222" class="difflineplus">+             .SetSpec(serverURI)</span>
<a href="#l15.1223"></a><span id="l15.1223" class="difflineplus">+             .Finalize(url);</span>
<a href="#l15.1224"></a><span id="l15.1224">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1225"></a><span id="l15.1225" class="difflineminus">-  }</span>
<a href="#l15.1226"></a><span id="l15.1226" class="difflineminus">-  else</span>
<a href="#l15.1227"></a><span id="l15.1227" class="difflineminus">-  {</span>
<a href="#l15.1228"></a><span id="l15.1228" class="difflineminus">-    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(mURI).Finalize(url);</span>
<a href="#l15.1229"></a><span id="l15.1229" class="difflineplus">+  } else {</span>
<a href="#l15.1230"></a><span id="l15.1230" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l15.1231"></a><span id="l15.1231" class="difflineplus">+             .SetSpec(mURI)</span>
<a href="#l15.1232"></a><span id="l15.1232" class="difflineplus">+             .Finalize(url);</span>
<a href="#l15.1233"></a><span id="l15.1233">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1234"></a><span id="l15.1234">   }</span>
<a href="#l15.1235"></a><span id="l15.1235"> </span>
<a href="#l15.1236"></a><span id="l15.1236">   int32_t port = 0;</span>
<a href="#l15.1237"></a><span id="l15.1237">   rv = url-&gt;GetPort(&amp;port);</span>
<a href="#l15.1238"></a><span id="l15.1238">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1239"></a><span id="l15.1239"> </span>
<a href="#l15.1240"></a><span id="l15.1240" class="difflineminus">-  if (port &lt;= 0)</span>
<a href="#l15.1241"></a><span id="l15.1241" class="difflineminus">-  {</span>
<a href="#l15.1242"></a><span id="l15.1242" class="difflineplus">+  if (port &lt;= 0) {</span>
<a href="#l15.1243"></a><span id="l15.1243">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.1244"></a><span id="l15.1244">     rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.1245"></a><span id="l15.1245">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1246"></a><span id="l15.1246"> </span>
<a href="#l15.1247"></a><span id="l15.1247">     int32_t socketType;</span>
<a href="#l15.1248"></a><span id="l15.1248">     nsresult rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l15.1249"></a><span id="l15.1249">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1250"></a><span id="l15.1250"> </span>
<a href="#l15.1251"></a><span id="l15.1251">     // Only set this for ssl newsgroups as for non-ssl connections, we don't</span>
<a href="#l15.1252"></a><span id="l15.1252">     // need to specify the port as it is the default for the protocol and</span>
<a href="#l15.1253"></a><span id="l15.1253">     // password manager &quot;blanks&quot; those out.</span>
<a href="#l15.1254"></a><span id="l15.1254" class="difflineminus">-    if (socketType == nsMsgSocketType::SSL)</span>
<a href="#l15.1255"></a><span id="l15.1255" class="difflineminus">-    {</span>
<a href="#l15.1256"></a><span id="l15.1256" class="difflineminus">-      rv = NS_MutateURI(url).SetPort(nsINntpUrl::DEFAULT_NNTPS_PORT).Finalize(url);</span>
<a href="#l15.1257"></a><span id="l15.1257" class="difflineplus">+    if (socketType == nsMsgSocketType::SSL) {</span>
<a href="#l15.1258"></a><span id="l15.1258" class="difflineplus">+      rv = NS_MutateURI(url)</span>
<a href="#l15.1259"></a><span id="l15.1259" class="difflineplus">+               .SetPort(nsINntpUrl::DEFAULT_NNTPS_PORT)</span>
<a href="#l15.1260"></a><span id="l15.1260" class="difflineplus">+               .Finalize(url);</span>
<a href="#l15.1261"></a><span id="l15.1261">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1262"></a><span id="l15.1262">     }</span>
<a href="#l15.1263"></a><span id="l15.1263">   }</span>
<a href="#l15.1264"></a><span id="l15.1264"> </span>
<a href="#l15.1265"></a><span id="l15.1265">   nsCString rawResult;</span>
<a href="#l15.1266"></a><span id="l15.1266" class="difflineminus">-  if (ref)</span>
<a href="#l15.1267"></a><span id="l15.1267" class="difflineminus">-  {</span>
<a href="#l15.1268"></a><span id="l15.1268" class="difflineplus">+  if (ref) {</span>
<a href="#l15.1269"></a><span id="l15.1269">     rv = NS_MutateURI(url).SetRef(nsDependentCString(ref)).Finalize(url);</span>
<a href="#l15.1270"></a><span id="l15.1270">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1271"></a><span id="l15.1271"> </span>
<a href="#l15.1272"></a><span id="l15.1272">     rv = url-&gt;GetSpec(rawResult);</span>
<a href="#l15.1273"></a><span id="l15.1273">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1274"></a><span id="l15.1274" class="difflineminus">-  }</span>
<a href="#l15.1275"></a><span id="l15.1275" class="difflineminus">-  else</span>
<a href="#l15.1276"></a><span id="l15.1276" class="difflineminus">-  {</span>
<a href="#l15.1277"></a><span id="l15.1277" class="difflineplus">+  } else {</span>
<a href="#l15.1278"></a><span id="l15.1278">     // If the url doesn't have a path, make sure we don't get a '/' on the end</span>
<a href="#l15.1279"></a><span id="l15.1279">     // as that will confuse searching in password manager.</span>
<a href="#l15.1280"></a><span id="l15.1280">     nsCString spec;</span>
<a href="#l15.1281"></a><span id="l15.1281">     rv = url-&gt;GetSpec(spec);</span>
<a href="#l15.1282"></a><span id="l15.1282">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1283"></a><span id="l15.1283"> </span>
<a href="#l15.1284"></a><span id="l15.1284">     if (!spec.IsEmpty() &amp;&amp; spec[spec.Length() - 1] == '/')</span>
<a href="#l15.1285"></a><span id="l15.1285">       rawResult = StringHead(spec, spec.Length() - 1);</span>
<a href="#l15.1286"></a><span id="l15.1286" class="difflineat">@@ -1116,84 +1043,77 @@ nsresult nsMsgNewsFolder::CreateNewsgrou</span>
<a href="#l15.1287"></a><span id="l15.1287">       rawResult = spec;</span>
<a href="#l15.1288"></a><span id="l15.1288">   }</span>
<a href="#l15.1289"></a><span id="l15.1289">   result = NS_ConvertASCIItoUTF16(rawResult);</span>
<a href="#l15.1290"></a><span id="l15.1290">   return NS_OK;</span>
<a href="#l15.1291"></a><span id="l15.1291"> }</span>
<a href="#l15.1292"></a><span id="l15.1292"> </span>
<a href="#l15.1293"></a><span id="l15.1293"> NS_IMETHODIMP</span>
<a href="#l15.1294"></a><span id="l15.1294"> nsMsgNewsFolder::GetAuthenticationCredentials(nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.1295"></a><span id="l15.1295" class="difflineminus">-    bool mayPrompt, bool mustPrompt, bool *validCredentials)</span>
<a href="#l15.1296"></a><span id="l15.1296" class="difflineminus">-{</span>
<a href="#l15.1297"></a><span id="l15.1297" class="difflineplus">+                                              bool mayPrompt, bool mustPrompt,</span>
<a href="#l15.1298"></a><span id="l15.1298" class="difflineplus">+                                              bool *validCredentials) {</span>
<a href="#l15.1299"></a><span id="l15.1299">   // Not strictly necessary, but it would help consumers to realize that this is</span>
<a href="#l15.1300"></a><span id="l15.1300">   // a rather nonsensical combination.</span>
<a href="#l15.1301"></a><span id="l15.1301">   NS_ENSURE_FALSE(mustPrompt &amp;&amp; !mayPrompt, NS_ERROR_INVALID_ARG);</span>
<a href="#l15.1302"></a><span id="l15.1302">   NS_ENSURE_ARG_POINTER(validCredentials);</span>
<a href="#l15.1303"></a><span id="l15.1303"> </span>
<a href="#l15.1304"></a><span id="l15.1304">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l15.1305"></a><span id="l15.1305" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l15.1306"></a><span id="l15.1306" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l15.1307"></a><span id="l15.1307">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.1308"></a><span id="l15.1308"> </span>
<a href="#l15.1309"></a><span id="l15.1309">   nsresult rv;</span>
<a href="#l15.1310"></a><span id="l15.1310">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l15.1311"></a><span id="l15.1311">   rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l15.1312"></a><span id="l15.1312">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1313"></a><span id="l15.1313"> </span>
<a href="#l15.1314"></a><span id="l15.1314">   nsString signonUrl;</span>
<a href="#l15.1315"></a><span id="l15.1315">   rv = CreateNewsgroupUrlForSignon(nullptr, signonUrl);</span>
<a href="#l15.1316"></a><span id="l15.1316">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1317"></a><span id="l15.1317"> </span>
<a href="#l15.1318"></a><span id="l15.1318">   // If we don't have a username or password, try to load it via the login mgr.</span>
<a href="#l15.1319"></a><span id="l15.1319">   // Do this even if mustPrompt is true, to prefill the dialog.</span>
<a href="#l15.1320"></a><span id="l15.1320" class="difflineminus">-  if (mGroupUsername.IsEmpty() || mGroupPassword.IsEmpty())</span>
<a href="#l15.1321"></a><span id="l15.1321" class="difflineminus">-  {</span>
<a href="#l15.1322"></a><span id="l15.1322" class="difflineplus">+  if (mGroupUsername.IsEmpty() || mGroupPassword.IsEmpty()) {</span>
<a href="#l15.1323"></a><span id="l15.1323">     nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l15.1324"></a><span id="l15.1324" class="difflineminus">-      do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.1325"></a><span id="l15.1325" class="difflineplus">+        do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.1326"></a><span id="l15.1326">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1327"></a><span id="l15.1327"> </span>
<a href="#l15.1328"></a><span id="l15.1328">     uint32_t numLogins = 0;</span>
<a href="#l15.1329"></a><span id="l15.1329">     nsILoginInfo **logins = nullptr;</span>
<a href="#l15.1330"></a><span id="l15.1330">     rv = loginMgr-&gt;FindLogins(&amp;numLogins, signonUrl, EmptyString(), signonUrl,</span>
<a href="#l15.1331"></a><span id="l15.1331" class="difflineminus">-      &amp;logins);</span>
<a href="#l15.1332"></a><span id="l15.1332" class="difflineplus">+                              &amp;logins);</span>
<a href="#l15.1333"></a><span id="l15.1333">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1334"></a><span id="l15.1334"> </span>
<a href="#l15.1335"></a><span id="l15.1335" class="difflineminus">-    if (numLogins &gt; 0)</span>
<a href="#l15.1336"></a><span id="l15.1336" class="difflineminus">-    {</span>
<a href="#l15.1337"></a><span id="l15.1337" class="difflineplus">+    if (numLogins &gt; 0) {</span>
<a href="#l15.1338"></a><span id="l15.1338">       nsString uniUsername, uniPassword;</span>
<a href="#l15.1339"></a><span id="l15.1339">       logins[0]-&gt;GetUsername(uniUsername);</span>
<a href="#l15.1340"></a><span id="l15.1340">       logins[0]-&gt;GetPassword(uniPassword);</span>
<a href="#l15.1341"></a><span id="l15.1341">       mGroupUsername = NS_LossyConvertUTF16toASCII(uniUsername);</span>
<a href="#l15.1342"></a><span id="l15.1342">       mGroupPassword = NS_LossyConvertUTF16toASCII(uniPassword);</span>
<a href="#l15.1343"></a><span id="l15.1343"> </span>
<a href="#l15.1344"></a><span id="l15.1344">       *validCredentials = true;</span>
<a href="#l15.1345"></a><span id="l15.1345">     }</span>
<a href="#l15.1346"></a><span id="l15.1346">     NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numLogins, logins);</span>
<a href="#l15.1347"></a><span id="l15.1347">   }</span>
<a href="#l15.1348"></a><span id="l15.1348"> </span>
<a href="#l15.1349"></a><span id="l15.1349">   // Show the prompt if we need to</span>
<a href="#l15.1350"></a><span id="l15.1350">   if (mustPrompt ||</span>
<a href="#l15.1351"></a><span id="l15.1351" class="difflineminus">-      (mayPrompt &amp;&amp; (mGroupUsername.IsEmpty() || mGroupPassword.IsEmpty())))</span>
<a href="#l15.1352"></a><span id="l15.1352" class="difflineminus">-  {</span>
<a href="#l15.1353"></a><span id="l15.1353" class="difflineplus">+      (mayPrompt &amp;&amp; (mGroupUsername.IsEmpty() || mGroupPassword.IsEmpty()))) {</span>
<a href="#l15.1354"></a><span id="l15.1354">     nsCOMPtr&lt;nsIAuthPrompt&gt; dialog;</span>
<a href="#l15.1355"></a><span id="l15.1355" class="difflineminus">-    if (aMsgWindow)</span>
<a href="#l15.1356"></a><span id="l15.1356" class="difflineminus">-    {</span>
<a href="#l15.1357"></a><span id="l15.1357" class="difflineplus">+    if (aMsgWindow) {</span>
<a href="#l15.1358"></a><span id="l15.1358">       rv = aMsgWindow-&gt;GetAuthPrompt(getter_AddRefs(dialog));</span>
<a href="#l15.1359"></a><span id="l15.1359">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1360"></a><span id="l15.1360" class="difflineminus">-    }</span>
<a href="#l15.1361"></a><span id="l15.1361" class="difflineminus">-    else</span>
<a href="#l15.1362"></a><span id="l15.1362" class="difflineminus">-    {</span>
<a href="#l15.1363"></a><span id="l15.1363" class="difflineminus">-      nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l15.1364"></a><span id="l15.1364" class="difflineminus">-      if (wwatch)</span>
<a href="#l15.1365"></a><span id="l15.1365" class="difflineminus">-        wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l15.1366"></a><span id="l15.1366" class="difflineplus">+    } else {</span>
<a href="#l15.1367"></a><span id="l15.1367" class="difflineplus">+      nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l15.1368"></a><span id="l15.1368" class="difflineplus">+          do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l15.1369"></a><span id="l15.1369" class="difflineplus">+      if (wwatch) wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l15.1370"></a><span id="l15.1370">       if (!dialog) return NS_ERROR_FAILURE;</span>
<a href="#l15.1371"></a><span id="l15.1371">     }</span>
<a href="#l15.1372"></a><span id="l15.1372"> </span>
<a href="#l15.1373"></a><span id="l15.1373">     NS_ASSERTION(dialog, &quot;We didn't get a net prompt&quot;);</span>
<a href="#l15.1374"></a><span id="l15.1374" class="difflineminus">-    if (dialog)</span>
<a href="#l15.1375"></a><span id="l15.1375" class="difflineminus">-    {</span>
<a href="#l15.1376"></a><span id="l15.1376" class="difflineplus">+    if (dialog) {</span>
<a href="#l15.1377"></a><span id="l15.1377">       // Format the prompt text strings</span>
<a href="#l15.1378"></a><span id="l15.1378">       nsString promptTitle, promptText;</span>
<a href="#l15.1379"></a><span id="l15.1379">       bundle-&gt;GetStringFromName(&quot;enterUserPassTitle&quot;, promptTitle);</span>
<a href="#l15.1380"></a><span id="l15.1380"> </span>
<a href="#l15.1381"></a><span id="l15.1381">       nsString serverName;</span>
<a href="#l15.1382"></a><span id="l15.1382">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.1383"></a><span id="l15.1383">       rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.1384"></a><span id="l15.1384">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1385"></a><span id="l15.1385" class="difflineat">@@ -1206,102 +1126,95 @@ nsMsgNewsFolder::GetAuthenticationCreden</span>
<a href="#l15.1386"></a><span id="l15.1386"> </span>
<a href="#l15.1387"></a><span id="l15.1387">       bool singleSignon = true;</span>
<a href="#l15.1388"></a><span id="l15.1388">       nntpServer-&gt;GetSingleSignon(&amp;singleSignon);</span>
<a href="#l15.1389"></a><span id="l15.1389"> </span>
<a href="#l15.1390"></a><span id="l15.1390">       const char16_t *params[2];</span>
<a href="#l15.1391"></a><span id="l15.1391">       params[0] = mName.get();</span>
<a href="#l15.1392"></a><span id="l15.1392">       params[1] = serverName.get();</span>
<a href="#l15.1393"></a><span id="l15.1393">       if (singleSignon)</span>
<a href="#l15.1394"></a><span id="l15.1394" class="difflineminus">-        bundle-&gt;FormatStringFromName(</span>
<a href="#l15.1395"></a><span id="l15.1395" class="difflineminus">-          &quot;enterUserPassServer&quot;,</span>
<a href="#l15.1396"></a><span id="l15.1396" class="difflineminus">-          &amp;params[1], 1, promptText);</span>
<a href="#l15.1397"></a><span id="l15.1397" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;enterUserPassServer&quot;, &amp;params[1], 1,</span>
<a href="#l15.1398"></a><span id="l15.1398" class="difflineplus">+                                     promptText);</span>
<a href="#l15.1399"></a><span id="l15.1399">       else</span>
<a href="#l15.1400"></a><span id="l15.1400" class="difflineminus">-        bundle-&gt;FormatStringFromName(</span>
<a href="#l15.1401"></a><span id="l15.1401" class="difflineminus">-          &quot;enterUserPassGroup&quot;,</span>
<a href="#l15.1402"></a><span id="l15.1402" class="difflineminus">-          params, 2, promptText);</span>
<a href="#l15.1403"></a><span id="l15.1403" class="difflineplus">+        bundle-&gt;FormatStringFromName(&quot;enterUserPassGroup&quot;, params, 2,</span>
<a href="#l15.1404"></a><span id="l15.1404" class="difflineplus">+                                     promptText);</span>
<a href="#l15.1405"></a><span id="l15.1405"> </span>
<a href="#l15.1406"></a><span id="l15.1406">       // Fill the signon url for the dialog</span>
<a href="#l15.1407"></a><span id="l15.1407">       nsString signonURL;</span>
<a href="#l15.1408"></a><span id="l15.1408">       rv = CreateNewsgroupUrlForSignon(nullptr, signonURL);</span>
<a href="#l15.1409"></a><span id="l15.1409">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1410"></a><span id="l15.1410"> </span>
<a href="#l15.1411"></a><span id="l15.1411">       // Prefill saved username/password</span>
<a href="#l15.1412"></a><span id="l15.1412" class="difflineminus">-      char16_t *uniGroupUsername = ToNewUnicode(</span>
<a href="#l15.1413"></a><span id="l15.1413" class="difflineminus">-        NS_ConvertASCIItoUTF16(mGroupUsername));</span>
<a href="#l15.1414"></a><span id="l15.1414" class="difflineminus">-      char16_t *uniGroupPassword = ToNewUnicode(</span>
<a href="#l15.1415"></a><span id="l15.1415" class="difflineminus">-        NS_ConvertASCIItoUTF16(mGroupPassword));</span>
<a href="#l15.1416"></a><span id="l15.1416" class="difflineplus">+      char16_t *uniGroupUsername =</span>
<a href="#l15.1417"></a><span id="l15.1417" class="difflineplus">+          ToNewUnicode(NS_ConvertASCIItoUTF16(mGroupUsername));</span>
<a href="#l15.1418"></a><span id="l15.1418" class="difflineplus">+      char16_t *uniGroupPassword =</span>
<a href="#l15.1419"></a><span id="l15.1419" class="difflineplus">+          ToNewUnicode(NS_ConvertASCIItoUTF16(mGroupPassword));</span>
<a href="#l15.1420"></a><span id="l15.1420"> </span>
<a href="#l15.1421"></a><span id="l15.1421">       // Prompt for the dialog</span>
<a href="#l15.1422"></a><span id="l15.1422" class="difflineminus">-      rv = dialog-&gt;PromptUsernameAndPassword(promptTitle.get(),</span>
<a href="#l15.1423"></a><span id="l15.1423" class="difflineminus">-        promptText.get(), signonURL.get(),</span>
<a href="#l15.1424"></a><span id="l15.1424" class="difflineminus">-        nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l15.1425"></a><span id="l15.1425" class="difflineminus">-        &amp;uniGroupUsername, &amp;uniGroupPassword, validCredentials);</span>
<a href="#l15.1426"></a><span id="l15.1426" class="difflineplus">+      rv = dialog-&gt;PromptUsernameAndPassword(</span>
<a href="#l15.1427"></a><span id="l15.1427" class="difflineplus">+          promptTitle.get(), promptText.get(), signonURL.get(),</span>
<a href="#l15.1428"></a><span id="l15.1428" class="difflineplus">+          nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY, &amp;uniGroupUsername,</span>
<a href="#l15.1429"></a><span id="l15.1429" class="difflineplus">+          &amp;uniGroupPassword, validCredentials);</span>
<a href="#l15.1430"></a><span id="l15.1430"> </span>
<a href="#l15.1431"></a><span id="l15.1431">       nsAutoString uniPasswordAdopted, uniUsernameAdopted;</span>
<a href="#l15.1432"></a><span id="l15.1432">       uniPasswordAdopted.Adopt(uniGroupPassword);</span>
<a href="#l15.1433"></a><span id="l15.1433">       uniUsernameAdopted.Adopt(uniGroupUsername);</span>
<a href="#l15.1434"></a><span id="l15.1434">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1435"></a><span id="l15.1435"> </span>
<a href="#l15.1436"></a><span id="l15.1436">       // Only use the username/password if the user didn't cancel.</span>
<a href="#l15.1437"></a><span id="l15.1437" class="difflineminus">-      if (*validCredentials)</span>
<a href="#l15.1438"></a><span id="l15.1438" class="difflineminus">-      {</span>
<a href="#l15.1439"></a><span id="l15.1439" class="difflineplus">+      if (*validCredentials) {</span>
<a href="#l15.1440"></a><span id="l15.1440">         SetGroupUsername(NS_LossyConvertUTF16toASCII(uniUsernameAdopted));</span>
<a href="#l15.1441"></a><span id="l15.1441">         SetGroupPassword(NS_LossyConvertUTF16toASCII(uniPasswordAdopted));</span>
<a href="#l15.1442"></a><span id="l15.1442" class="difflineminus">-      }</span>
<a href="#l15.1443"></a><span id="l15.1443" class="difflineminus">-      else</span>
<a href="#l15.1444"></a><span id="l15.1444" class="difflineminus">-      {</span>
<a href="#l15.1445"></a><span id="l15.1445" class="difflineplus">+      } else {</span>
<a href="#l15.1446"></a><span id="l15.1446">         mGroupUsername.Truncate();</span>
<a href="#l15.1447"></a><span id="l15.1447">         mGroupPassword.Truncate();</span>
<a href="#l15.1448"></a><span id="l15.1448">       }</span>
<a href="#l15.1449"></a><span id="l15.1449">     }</span>
<a href="#l15.1450"></a><span id="l15.1450">   }</span>
<a href="#l15.1451"></a><span id="l15.1451"> </span>
<a href="#l15.1452"></a><span id="l15.1452">   *validCredentials = !(mGroupUsername.IsEmpty() || mGroupPassword.IsEmpty());</span>
<a href="#l15.1453"></a><span id="l15.1453">   return NS_OK;</span>
<a href="#l15.1454"></a><span id="l15.1454"> }</span>
<a href="#l15.1455"></a><span id="l15.1455"> </span>
<a href="#l15.1456"></a><span id="l15.1456" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::ForgetAuthenticationCredentials()</span>
<a href="#l15.1457"></a><span id="l15.1457" class="difflineminus">-{</span>
<a href="#l15.1458"></a><span id="l15.1458" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::ForgetAuthenticationCredentials() {</span>
<a href="#l15.1459"></a><span id="l15.1459">   nsString signonUrl;</span>
<a href="#l15.1460"></a><span id="l15.1460">   nsresult rv = CreateNewsgroupUrlForSignon(nullptr, signonUrl);</span>
<a href="#l15.1461"></a><span id="l15.1461">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1462"></a><span id="l15.1462"> </span>
<a href="#l15.1463"></a><span id="l15.1463">   nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l15.1464"></a><span id="l15.1464" class="difflineminus">-    do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.1465"></a><span id="l15.1465" class="difflineplus">+      do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.1466"></a><span id="l15.1466">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1467"></a><span id="l15.1467"> </span>
<a href="#l15.1468"></a><span id="l15.1468">   uint32_t count;</span>
<a href="#l15.1469"></a><span id="l15.1469" class="difflineminus">-  nsILoginInfo** logins;</span>
<a href="#l15.1470"></a><span id="l15.1470" class="difflineplus">+  nsILoginInfo **logins;</span>
<a href="#l15.1471"></a><span id="l15.1471"> </span>
<a href="#l15.1472"></a><span id="l15.1472">   rv = loginMgr-&gt;FindLogins(&amp;count, signonUrl, EmptyString(), signonUrl,</span>
<a href="#l15.1473"></a><span id="l15.1473" class="difflineminus">-    &amp;logins);</span>
<a href="#l15.1474"></a><span id="l15.1474" class="difflineplus">+                            &amp;logins);</span>
<a href="#l15.1475"></a><span id="l15.1475">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1476"></a><span id="l15.1476"> </span>
<a href="#l15.1477"></a><span id="l15.1477">   // There should only be one-login stored for this url, however just in case</span>
<a href="#l15.1478"></a><span id="l15.1478">   // there isn't.</span>
<a href="#l15.1479"></a><span id="l15.1479" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l15.1480"></a><span id="l15.1480" class="difflineminus">-    loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l15.1481"></a><span id="l15.1481" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l15.1482"></a><span id="l15.1482">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l15.1483"></a><span id="l15.1483"> </span>
<a href="#l15.1484"></a><span id="l15.1484">   // Clear out the saved passwords for anyone else who tries to call.</span>
<a href="#l15.1485"></a><span id="l15.1485">   mGroupUsername.Truncate();</span>
<a href="#l15.1486"></a><span id="l15.1486">   mGroupPassword.Truncate();</span>
<a href="#l15.1487"></a><span id="l15.1487"> </span>
<a href="#l15.1488"></a><span id="l15.1488">   return NS_OK;</span>
<a href="#l15.1489"></a><span id="l15.1489"> }</span>
<a href="#l15.1490"></a><span id="l15.1490"> </span>
<a href="#l15.1491"></a><span id="l15.1491"> // change order of subfolders (newsgroups)</span>
<a href="#l15.1492"></a><span id="l15.1492"> // aOrientation = -1 ... aNewsgroupToMove aRefNewsgroup ...</span>
<a href="#l15.1493"></a><span id="l15.1493"> // aOrientation =  1 ... aRefNewsgroup aNewsgroupToMove ...</span>
<a href="#l15.1494"></a><span id="l15.1494" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::MoveFolder(nsIMsgFolder *aNewsgroupToMove, nsIMsgFolder *aRefNewsgroup, int32_t aOrientation)</span>
<a href="#l15.1495"></a><span id="l15.1495" class="difflineminus">-{</span>
<a href="#l15.1496"></a><span id="l15.1496" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::MoveFolder(nsIMsgFolder *aNewsgroupToMove,</span>
<a href="#l15.1497"></a><span id="l15.1497" class="difflineplus">+                                          nsIMsgFolder *aRefNewsgroup,</span>
<a href="#l15.1498"></a><span id="l15.1498" class="difflineplus">+                                          int32_t aOrientation) {</span>
<a href="#l15.1499"></a><span id="l15.1499">   // if folders are identical do nothing</span>
<a href="#l15.1500"></a><span id="l15.1500" class="difflineminus">-  if (aNewsgroupToMove == aRefNewsgroup)</span>
<a href="#l15.1501"></a><span id="l15.1501" class="difflineminus">-    return NS_OK;</span>
<a href="#l15.1502"></a><span id="l15.1502" class="difflineplus">+  if (aNewsgroupToMove == aRefNewsgroup) return NS_OK;</span>
<a href="#l15.1503"></a><span id="l15.1503"> </span>
<a href="#l15.1504"></a><span id="l15.1504">   nsresult rv = NS_OK;</span>
<a href="#l15.1505"></a><span id="l15.1505"> </span>
<a href="#l15.1506"></a><span id="l15.1506">   // get index for aNewsgroupToMove</span>
<a href="#l15.1507"></a><span id="l15.1507">   int32_t indexNewsgroupToMove = mSubFolders.IndexOf(aNewsgroupToMove);</span>
<a href="#l15.1508"></a><span id="l15.1508">   if (indexNewsgroupToMove == -1)</span>
<a href="#l15.1509"></a><span id="l15.1509">     // aNewsgroupToMove is no subfolder of this folder</span>
<a href="#l15.1510"></a><span id="l15.1510">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l15.1511"></a><span id="l15.1511" class="difflineat">@@ -1309,537 +1222,484 @@ NS_IMETHODIMP nsMsgNewsFolder::MoveFolde</span>
<a href="#l15.1512"></a><span id="l15.1512">   // get index for aRefNewsgroup</span>
<a href="#l15.1513"></a><span id="l15.1513">   int32_t indexRefNewsgroup = mSubFolders.IndexOf(aRefNewsgroup);</span>
<a href="#l15.1514"></a><span id="l15.1514">   if (indexRefNewsgroup == -1)</span>
<a href="#l15.1515"></a><span id="l15.1515">     // aRefNewsgroup is no subfolder of this folder</span>
<a href="#l15.1516"></a><span id="l15.1516">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l15.1517"></a><span id="l15.1517"> </span>
<a href="#l15.1518"></a><span id="l15.1518">   // set new index for NewsgroupToMove</span>
<a href="#l15.1519"></a><span id="l15.1519">   uint32_t indexMin, indexMax;</span>
<a href="#l15.1520"></a><span id="l15.1520" class="difflineminus">-  if (indexNewsgroupToMove &lt; indexRefNewsgroup)</span>
<a href="#l15.1521"></a><span id="l15.1521" class="difflineminus">-  {</span>
<a href="#l15.1522"></a><span id="l15.1522" class="difflineminus">-    if (aOrientation &lt; 0)</span>
<a href="#l15.1523"></a><span id="l15.1523" class="difflineminus">-      indexRefNewsgroup--;</span>
<a href="#l15.1524"></a><span id="l15.1524" class="difflineplus">+  if (indexNewsgroupToMove &lt; indexRefNewsgroup) {</span>
<a href="#l15.1525"></a><span id="l15.1525" class="difflineplus">+    if (aOrientation &lt; 0) indexRefNewsgroup--;</span>
<a href="#l15.1526"></a><span id="l15.1526">     indexMin = indexNewsgroupToMove;</span>
<a href="#l15.1527"></a><span id="l15.1527">     indexMax = indexRefNewsgroup;</span>
<a href="#l15.1528"></a><span id="l15.1528" class="difflineminus">-  }</span>
<a href="#l15.1529"></a><span id="l15.1529" class="difflineminus">-  else</span>
<a href="#l15.1530"></a><span id="l15.1530" class="difflineminus">-  {</span>
<a href="#l15.1531"></a><span id="l15.1531" class="difflineminus">-    if (aOrientation &gt; 0)</span>
<a href="#l15.1532"></a><span id="l15.1532" class="difflineminus">-      indexRefNewsgroup++;</span>
<a href="#l15.1533"></a><span id="l15.1533" class="difflineplus">+  } else {</span>
<a href="#l15.1534"></a><span id="l15.1534" class="difflineplus">+    if (aOrientation &gt; 0) indexRefNewsgroup++;</span>
<a href="#l15.1535"></a><span id="l15.1535">     indexMin = indexRefNewsgroup;</span>
<a href="#l15.1536"></a><span id="l15.1536">     indexMax = indexNewsgroupToMove;</span>
<a href="#l15.1537"></a><span id="l15.1537">   }</span>
<a href="#l15.1538"></a><span id="l15.1538"> </span>
<a href="#l15.1539"></a><span id="l15.1539">   // move NewsgroupToMove to new index and set new sort order</span>
<a href="#l15.1540"></a><span id="l15.1540">   NotifyItemRemoved(aNewsgroupToMove);</span>
<a href="#l15.1541"></a><span id="l15.1541"> </span>
<a href="#l15.1542"></a><span id="l15.1542" class="difflineminus">-  if (indexNewsgroupToMove != indexRefNewsgroup)</span>
<a href="#l15.1543"></a><span id="l15.1543" class="difflineminus">-  {</span>
<a href="#l15.1544"></a><span id="l15.1544" class="difflineplus">+  if (indexNewsgroupToMove != indexRefNewsgroup) {</span>
<a href="#l15.1545"></a><span id="l15.1545">     nsCOMPtr&lt;nsIMsgFolder&gt; newsgroup = mSubFolders[indexNewsgroupToMove];</span>
<a href="#l15.1546"></a><span id="l15.1546"> </span>
<a href="#l15.1547"></a><span id="l15.1547">     mSubFolders.RemoveObjectAt(indexNewsgroupToMove);</span>
<a href="#l15.1548"></a><span id="l15.1548"> </span>
<a href="#l15.1549"></a><span id="l15.1549">     // indexRefNewsgroup is already set up correctly.</span>
<a href="#l15.1550"></a><span id="l15.1550">     mSubFolders.InsertObjectAt(newsgroup, indexRefNewsgroup);</span>
<a href="#l15.1551"></a><span id="l15.1551">   }</span>
<a href="#l15.1552"></a><span id="l15.1552"> </span>
<a href="#l15.1553"></a><span id="l15.1553">   for (uint32_t i = indexMin; i &lt;= indexMax; i++)</span>
<a href="#l15.1554"></a><span id="l15.1554">     mSubFolders[i]-&gt;SetSortOrder(kNewsSortOffset + i);</span>
<a href="#l15.1555"></a><span id="l15.1555"> </span>
<a href="#l15.1556"></a><span id="l15.1556">   NotifyItemAdded(aNewsgroupToMove);</span>
<a href="#l15.1557"></a><span id="l15.1557"> </span>
<a href="#l15.1558"></a><span id="l15.1558">   // write changes back to file</span>
<a href="#l15.1559"></a><span id="l15.1559">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.1560"></a><span id="l15.1560">   rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.1561"></a><span id="l15.1561" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1562"></a><span id="l15.1562" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1563"></a><span id="l15.1563"> </span>
<a href="#l15.1564"></a><span id="l15.1564">   rv = nntpServer-&gt;SetNewsrcHasChanged(true);</span>
<a href="#l15.1565"></a><span id="l15.1565" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1566"></a><span id="l15.1566" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1567"></a><span id="l15.1567"> </span>
<a href="#l15.1568"></a><span id="l15.1568">   rv = nntpServer-&gt;WriteNewsrcFile();</span>
<a href="#l15.1569"></a><span id="l15.1569" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1570"></a><span id="l15.1570" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1571"></a><span id="l15.1571"> </span>
<a href="#l15.1572"></a><span id="l15.1572">   return rv;</span>
<a href="#l15.1573"></a><span id="l15.1573"> }</span>
<a href="#l15.1574"></a><span id="l15.1574"> </span>
<a href="#l15.1575"></a><span id="l15.1575" class="difflineminus">-nsresult nsMsgNewsFolder::CreateBaseMessageURI(const nsACString&amp; aURI)</span>
<a href="#l15.1576"></a><span id="l15.1576" class="difflineminus">-{</span>
<a href="#l15.1577"></a><span id="l15.1577" class="difflineplus">+nsresult nsMsgNewsFolder::CreateBaseMessageURI(const nsACString &amp;aURI) {</span>
<a href="#l15.1578"></a><span id="l15.1578">   return nsCreateNewsBaseMessageURI(nsCString(aURI).get(), mBaseMessageURI);</span>
<a href="#l15.1579"></a><span id="l15.1579"> }</span>
<a href="#l15.1580"></a><span id="l15.1580"> </span>
<a href="#l15.1581"></a><span id="l15.1581"> NS_IMETHODIMP</span>
<a href="#l15.1582"></a><span id="l15.1582" class="difflineminus">-nsMsgNewsFolder::GetNewsrcLine(nsACString&amp; newsrcLine)</span>
<a href="#l15.1583"></a><span id="l15.1583" class="difflineminus">-{</span>
<a href="#l15.1584"></a><span id="l15.1584" class="difflineplus">+nsMsgNewsFolder::GetNewsrcLine(nsACString &amp;newsrcLine) {</span>
<a href="#l15.1585"></a><span id="l15.1585">   nsresult rv;</span>
<a href="#l15.1586"></a><span id="l15.1586">   nsString newsgroupNameUtf16;</span>
<a href="#l15.1587"></a><span id="l15.1587">   rv = GetName(newsgroupNameUtf16);</span>
<a href="#l15.1588"></a><span id="l15.1588">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.1589"></a><span id="l15.1589">   NS_ConvertUTF16toUTF8 newsgroupName(newsgroupNameUtf16);</span>
<a href="#l15.1590"></a><span id="l15.1590"> </span>
<a href="#l15.1591"></a><span id="l15.1591">   newsrcLine = newsgroupName;</span>
<a href="#l15.1592"></a><span id="l15.1592">   newsrcLine.Append(':');</span>
<a href="#l15.1593"></a><span id="l15.1593"> </span>
<a href="#l15.1594"></a><span id="l15.1594">   if (mReadSet) {</span>
<a href="#l15.1595"></a><span id="l15.1595">     nsCString setStr;</span>
<a href="#l15.1596"></a><span id="l15.1596">     mReadSet-&gt;Output(getter_Copies(setStr));</span>
<a href="#l15.1597"></a><span id="l15.1597" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1598"></a><span id="l15.1598" class="difflineminus">-    {</span>
<a href="#l15.1599"></a><span id="l15.1599" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.1600"></a><span id="l15.1600">       newsrcLine.Append(' ');</span>
<a href="#l15.1601"></a><span id="l15.1601">       newsrcLine.Append(setStr);</span>
<a href="#l15.1602"></a><span id="l15.1602">       newsrcLine.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l15.1603"></a><span id="l15.1603">     }</span>
<a href="#l15.1604"></a><span id="l15.1604">   }</span>
<a href="#l15.1605"></a><span id="l15.1605">   return NS_OK;</span>
<a href="#l15.1606"></a><span id="l15.1606"> }</span>
<a href="#l15.1607"></a><span id="l15.1607"> </span>
<a href="#l15.1608"></a><span id="l15.1608" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::SetReadSetFromStr(const nsACString&amp; newsrcLine)</span>
<a href="#l15.1609"></a><span id="l15.1609" class="difflineminus">-{</span>
<a href="#l15.1610"></a><span id="l15.1610" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::SetReadSetFromStr(const nsACString &amp;newsrcLine) {</span>
<a href="#l15.1611"></a><span id="l15.1611">   delete mReadSet;</span>
<a href="#l15.1612"></a><span id="l15.1612">   mReadSet = nsMsgKeySet::Create(nsCString(newsrcLine).get());</span>
<a href="#l15.1613"></a><span id="l15.1613">   NS_ENSURE_TRUE(mReadSet, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l15.1614"></a><span id="l15.1614"> </span>
<a href="#l15.1615"></a><span id="l15.1615">   // Now that mReadSet is recreated, make sure it's stored in the db as well.</span>
<a href="#l15.1616"></a><span id="l15.1616">   nsCOMPtr&lt;nsINewsDatabase&gt; db = do_QueryInterface(mDatabase);</span>
<a href="#l15.1617"></a><span id="l15.1617" class="difflineminus">-  if (db) // it's ok not to have a db here.</span>
<a href="#l15.1618"></a><span id="l15.1618" class="difflineplus">+  if (db)  // it's ok not to have a db here.</span>
<a href="#l15.1619"></a><span id="l15.1619">     db-&gt;SetReadSet(mReadSet);</span>
<a href="#l15.1620"></a><span id="l15.1620">   return NS_OK;</span>
<a href="#l15.1621"></a><span id="l15.1621"> }</span>
<a href="#l15.1622"></a><span id="l15.1622"> </span>
<a href="#l15.1623"></a><span id="l15.1623"> NS_IMETHODIMP</span>
<a href="#l15.1624"></a><span id="l15.1624" class="difflineminus">-nsMsgNewsFolder::GetUnsubscribedNewsgroupLines(nsACString&amp; aUnsubscribedNewsgroupLines)</span>
<a href="#l15.1625"></a><span id="l15.1625" class="difflineminus">-{</span>
<a href="#l15.1626"></a><span id="l15.1626" class="difflineplus">+nsMsgNewsFolder::GetUnsubscribedNewsgroupLines(</span>
<a href="#l15.1627"></a><span id="l15.1627" class="difflineplus">+    nsACString &amp;aUnsubscribedNewsgroupLines) {</span>
<a href="#l15.1628"></a><span id="l15.1628">   aUnsubscribedNewsgroupLines = mUnsubscribedNewsgroupLines;</span>
<a href="#l15.1629"></a><span id="l15.1629">   return NS_OK;</span>
<a href="#l15.1630"></a><span id="l15.1630"> }</span>
<a href="#l15.1631"></a><span id="l15.1631"> </span>
<a href="#l15.1632"></a><span id="l15.1632"> NS_IMETHODIMP</span>
<a href="#l15.1633"></a><span id="l15.1633" class="difflineminus">-nsMsgNewsFolder::GetOptionLines(nsACString&amp; optionLines)</span>
<a href="#l15.1634"></a><span id="l15.1634" class="difflineminus">-{</span>
<a href="#l15.1635"></a><span id="l15.1635" class="difflineplus">+nsMsgNewsFolder::GetOptionLines(nsACString &amp;optionLines) {</span>
<a href="#l15.1636"></a><span id="l15.1636">   optionLines = mOptionLines;</span>
<a href="#l15.1637"></a><span id="l15.1637">   return NS_OK;</span>
<a href="#l15.1638"></a><span id="l15.1638"> }</span>
<a href="#l15.1639"></a><span id="l15.1639"> </span>
<a href="#l15.1640"></a><span id="l15.1640"> NS_IMETHODIMP</span>
<a href="#l15.1641"></a><span id="l15.1641" class="difflineminus">-nsMsgNewsFolder::OnReadChanged(nsIDBChangeListener * aInstigator)</span>
<a href="#l15.1642"></a><span id="l15.1642" class="difflineminus">-{</span>
<a href="#l15.1643"></a><span id="l15.1643" class="difflineplus">+nsMsgNewsFolder::OnReadChanged(nsIDBChangeListener *aInstigator) {</span>
<a href="#l15.1644"></a><span id="l15.1644">   return SetNewsrcHasChanged(true);</span>
<a href="#l15.1645"></a><span id="l15.1645"> }</span>
<a href="#l15.1646"></a><span id="l15.1646"> </span>
<a href="#l15.1647"></a><span id="l15.1647"> NS_IMETHODIMP</span>
<a href="#l15.1648"></a><span id="l15.1648" class="difflineminus">-nsMsgNewsFolder::GetUnicodeName(nsAString&amp; aName)</span>
<a href="#l15.1649"></a><span id="l15.1649" class="difflineminus">-{</span>
<a href="#l15.1650"></a><span id="l15.1650" class="difflineminus">-  return GetName(aName);</span>
<a href="#l15.1651"></a><span id="l15.1651" class="difflineminus">-}</span>
<a href="#l15.1652"></a><span id="l15.1652" class="difflineplus">+nsMsgNewsFolder::GetUnicodeName(nsAString &amp;aName) { return GetName(aName); }</span>
<a href="#l15.1653"></a><span id="l15.1653"> </span>
<a href="#l15.1654"></a><span id="l15.1654"> NS_IMETHODIMP</span>
<a href="#l15.1655"></a><span id="l15.1655" class="difflineminus">-nsMsgNewsFolder::GetRawName(nsACString &amp; aRawName)</span>
<a href="#l15.1656"></a><span id="l15.1656" class="difflineminus">-{</span>
<a href="#l15.1657"></a><span id="l15.1657" class="difflineplus">+nsMsgNewsFolder::GetRawName(nsACString &amp;aRawName) {</span>
<a href="#l15.1658"></a><span id="l15.1658">   nsresult rv;</span>
<a href="#l15.1659"></a><span id="l15.1659" class="difflineminus">-  if (mRawName.IsEmpty())</span>
<a href="#l15.1660"></a><span id="l15.1660" class="difflineminus">-  {</span>
<a href="#l15.1661"></a><span id="l15.1661" class="difflineplus">+  if (mRawName.IsEmpty()) {</span>
<a href="#l15.1662"></a><span id="l15.1662">     nsString name;</span>
<a href="#l15.1663"></a><span id="l15.1663">     rv = GetName(name);</span>
<a href="#l15.1664"></a><span id="l15.1664" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1665"></a><span id="l15.1665" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1666"></a><span id="l15.1666"> </span>
<a href="#l15.1667"></a><span id="l15.1667">     // convert to the server-side encoding</span>
<a href="#l15.1668"></a><span id="l15.1668" class="difflineminus">-    nsCOMPtr &lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.1669"></a><span id="l15.1669" class="difflineplus">+    nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l15.1670"></a><span id="l15.1670">     rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l15.1671"></a><span id="l15.1671" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1672"></a><span id="l15.1672" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1673"></a><span id="l15.1673"> </span>
<a href="#l15.1674"></a><span id="l15.1674">     nsAutoCString dataCharset;</span>
<a href="#l15.1675"></a><span id="l15.1675">     rv = nntpServer-&gt;GetCharset(dataCharset);</span>
<a href="#l15.1676"></a><span id="l15.1676" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1677"></a><span id="l15.1677" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1678"></a><span id="l15.1678">     rv = nsMsgI18NConvertFromUnicode(dataCharset, name, mRawName);</span>
<a href="#l15.1679"></a><span id="l15.1679"> </span>
<a href="#l15.1680"></a><span id="l15.1680" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.1681"></a><span id="l15.1681" class="difflineminus">-      LossyCopyUTF16toASCII(name, mRawName);</span>
<a href="#l15.1682"></a><span id="l15.1682" class="difflineplus">+    if (NS_FAILED(rv)) LossyCopyUTF16toASCII(name, mRawName);</span>
<a href="#l15.1683"></a><span id="l15.1683">   }</span>
<a href="#l15.1684"></a><span id="l15.1684">   aRawName = mRawName;</span>
<a href="#l15.1685"></a><span id="l15.1685">   return NS_OK;</span>
<a href="#l15.1686"></a><span id="l15.1686"> }</span>
<a href="#l15.1687"></a><span id="l15.1687"> </span>
<a href="#l15.1688"></a><span id="l15.1688"> NS_IMETHODIMP</span>
<a href="#l15.1689"></a><span id="l15.1689" class="difflineminus">-nsMsgNewsFolder::GetNntpServer(nsINntpIncomingServer **result)</span>
<a href="#l15.1690"></a><span id="l15.1690" class="difflineminus">-{</span>
<a href="#l15.1691"></a><span id="l15.1691" class="difflineplus">+nsMsgNewsFolder::GetNntpServer(nsINntpIncomingServer **result) {</span>
<a href="#l15.1692"></a><span id="l15.1692">   nsresult rv;</span>
<a href="#l15.1693"></a><span id="l15.1693">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l15.1694"></a><span id="l15.1694"> </span>
<a href="#l15.1695"></a><span id="l15.1695">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.1696"></a><span id="l15.1696">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.1697"></a><span id="l15.1697" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l15.1698"></a><span id="l15.1698" class="difflineminus">-    return rv;</span>
<a href="#l15.1699"></a><span id="l15.1699" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.1700"></a><span id="l15.1700"> </span>
<a href="#l15.1701"></a><span id="l15.1701">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l15.1702"></a><span id="l15.1702" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l15.1703"></a><span id="l15.1703" class="difflineminus">-    return rv;</span>
<a href="#l15.1704"></a><span id="l15.1704" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.1705"></a><span id="l15.1705">   nntpServer.forget(result);</span>
<a href="#l15.1706"></a><span id="l15.1706">   return NS_OK;</span>
<a href="#l15.1707"></a><span id="l15.1707"> }</span>
<a href="#l15.1708"></a><span id="l15.1708"> </span>
<a href="#l15.1709"></a><span id="l15.1709"> // this gets called after the message actually gets cancelled</span>
<a href="#l15.1710"></a><span id="l15.1710"> // it removes the cancelled message from the db</span>
<a href="#l15.1711"></a><span id="l15.1711" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::RemoveMessage(nsMsgKey key)</span>
<a href="#l15.1712"></a><span id="l15.1712" class="difflineminus">-{</span>
<a href="#l15.1713"></a><span id="l15.1713" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::RemoveMessage(nsMsgKey key) {</span>
<a href="#l15.1714"></a><span id="l15.1714">   nsresult rv = GetDatabase();</span>
<a href="#l15.1715"></a><span id="l15.1715" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); // if GetDatabase succeeds, mDatabase will be non-null</span>
<a href="#l15.1716"></a><span id="l15.1716" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,</span>
<a href="#l15.1717"></a><span id="l15.1717" class="difflineplus">+                    rv);  // if GetDatabase succeeds, mDatabase will be non-null</span>
<a href="#l15.1718"></a><span id="l15.1718"> </span>
<a href="#l15.1719"></a><span id="l15.1719">   // Notify listeners of a delete for a single message</span>
<a href="#l15.1720"></a><span id="l15.1720" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.1721"></a><span id="l15.1721" class="difflineminus">-  if (notifier)</span>
<a href="#l15.1722"></a><span id="l15.1722" class="difflineminus">-  {</span>
<a href="#l15.1723"></a><span id="l15.1723" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l15.1724"></a><span id="l15.1724" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.1725"></a><span id="l15.1725" class="difflineplus">+  if (notifier) {</span>
<a href="#l15.1726"></a><span id="l15.1726">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l15.1727"></a><span id="l15.1727">     rv = mDatabase-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l15.1728"></a><span id="l15.1728">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1729"></a><span id="l15.1729"> </span>
<a href="#l15.1730"></a><span id="l15.1730">     nsCOMPtr&lt;nsIMutableArray&gt; msgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l15.1731"></a><span id="l15.1731">     msgHdrs-&gt;AppendElement(msgHdr);</span>
<a href="#l15.1732"></a><span id="l15.1732"> </span>
<a href="#l15.1733"></a><span id="l15.1733">     notifier-&gt;NotifyMsgsDeleted(msgHdrs);</span>
<a href="#l15.1734"></a><span id="l15.1734">   }</span>
<a href="#l15.1735"></a><span id="l15.1735">   return mDatabase-&gt;DeleteMessage(key, nullptr, false);</span>
<a href="#l15.1736"></a><span id="l15.1736"> }</span>
<a href="#l15.1737"></a><span id="l15.1737"> </span>
<a href="#l15.1738"></a><span id="l15.1738" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::RemoveMessages(nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeys)</span>
<a href="#l15.1739"></a><span id="l15.1739" class="difflineminus">-{</span>
<a href="#l15.1740"></a><span id="l15.1740" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::RemoveMessages(nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeys) {</span>
<a href="#l15.1741"></a><span id="l15.1741">   nsresult rv = GetDatabase();</span>
<a href="#l15.1742"></a><span id="l15.1742" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); // if GetDatabase succeeds, mDatabase will be non-null</span>
<a href="#l15.1743"></a><span id="l15.1743" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,</span>
<a href="#l15.1744"></a><span id="l15.1744" class="difflineplus">+                    rv);  // if GetDatabase succeeds, mDatabase will be non-null</span>
<a href="#l15.1745"></a><span id="l15.1745"> </span>
<a href="#l15.1746"></a><span id="l15.1746">   // Notify listeners of a multiple message delete</span>
<a href="#l15.1747"></a><span id="l15.1747" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.1748"></a><span id="l15.1748" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l15.1749"></a><span id="l15.1749" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.1750"></a><span id="l15.1750"> </span>
<a href="#l15.1751"></a><span id="l15.1751" class="difflineminus">-  if (notifier)</span>
<a href="#l15.1752"></a><span id="l15.1752" class="difflineminus">-  {</span>
<a href="#l15.1753"></a><span id="l15.1753" class="difflineplus">+  if (notifier) {</span>
<a href="#l15.1754"></a><span id="l15.1754">     nsCOMPtr&lt;nsIMutableArray&gt; msgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l15.1755"></a><span id="l15.1755">     rv = MsgGetHeadersFromKeys(mDatabase, aMsgKeys, msgHdrs);</span>
<a href="#l15.1756"></a><span id="l15.1756">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1757"></a><span id="l15.1757"> </span>
<a href="#l15.1758"></a><span id="l15.1758">     notifier-&gt;NotifyMsgsDeleted(msgHdrs);</span>
<a href="#l15.1759"></a><span id="l15.1759">   }</span>
<a href="#l15.1760"></a><span id="l15.1760"> </span>
<a href="#l15.1761"></a><span id="l15.1761" class="difflineminus">-  return mDatabase-&gt;DeleteMessages(aMsgKeys.Length(), aMsgKeys.Elements(), nullptr);</span>
<a href="#l15.1762"></a><span id="l15.1762" class="difflineplus">+  return mDatabase-&gt;DeleteMessages(aMsgKeys.Length(), aMsgKeys.Elements(),</span>
<a href="#l15.1763"></a><span id="l15.1763" class="difflineplus">+                                   nullptr);</span>
<a href="#l15.1764"></a><span id="l15.1764"> }</span>
<a href="#l15.1765"></a><span id="l15.1765"> </span>
<a href="#l15.1766"></a><span id="l15.1766" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::CancelComplete()</span>
<a href="#l15.1767"></a><span id="l15.1767" class="difflineminus">-{</span>
<a href="#l15.1768"></a><span id="l15.1768" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::CancelComplete() {</span>
<a href="#l15.1769"></a><span id="l15.1769">   NotifyFolderEvent(kDeleteOrMoveMsgCompleted);</span>
<a href="#l15.1770"></a><span id="l15.1770">   return NS_OK;</span>
<a href="#l15.1771"></a><span id="l15.1771"> }</span>
<a href="#l15.1772"></a><span id="l15.1772"> </span>
<a href="#l15.1773"></a><span id="l15.1773" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::CancelFailed()</span>
<a href="#l15.1774"></a><span id="l15.1774" class="difflineminus">-{</span>
<a href="#l15.1775"></a><span id="l15.1775" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::CancelFailed() {</span>
<a href="#l15.1776"></a><span id="l15.1776">   NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l15.1777"></a><span id="l15.1777">   return NS_OK;</span>
<a href="#l15.1778"></a><span id="l15.1778"> }</span>
<a href="#l15.1779"></a><span id="l15.1779"> </span>
<a href="#l15.1780"></a><span id="l15.1780" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetSaveArticleOffline(bool *aBool)</span>
<a href="#l15.1781"></a><span id="l15.1781" class="difflineminus">-{</span>
<a href="#l15.1782"></a><span id="l15.1782" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetSaveArticleOffline(bool *aBool) {</span>
<a href="#l15.1783"></a><span id="l15.1783">   NS_ENSURE_ARG(aBool);</span>
<a href="#l15.1784"></a><span id="l15.1784">   *aBool = m_downloadMessageForOfflineUse;</span>
<a href="#l15.1785"></a><span id="l15.1785">   return NS_OK;</span>
<a href="#l15.1786"></a><span id="l15.1786"> }</span>
<a href="#l15.1787"></a><span id="l15.1787"> </span>
<a href="#l15.1788"></a><span id="l15.1788" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::SetSaveArticleOffline(bool aBool)</span>
<a href="#l15.1789"></a><span id="l15.1789" class="difflineminus">-{</span>
<a href="#l15.1790"></a><span id="l15.1790" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::SetSaveArticleOffline(bool aBool) {</span>
<a href="#l15.1791"></a><span id="l15.1791">   m_downloadMessageForOfflineUse = aBool;</span>
<a href="#l15.1792"></a><span id="l15.1792">   return NS_OK;</span>
<a href="#l15.1793"></a><span id="l15.1793"> }</span>
<a href="#l15.1794"></a><span id="l15.1794"> </span>
<a href="#l15.1795"></a><span id="l15.1795" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::DownloadAllForOffline(nsIUrlListener *listener, nsIMsgWindow *msgWindow)</span>
<a href="#l15.1796"></a><span id="l15.1796" class="difflineminus">-{</span>
<a href="#l15.1797"></a><span id="l15.1797" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::DownloadAllForOffline(nsIUrlListener *listener,</span>
<a href="#l15.1798"></a><span id="l15.1798" class="difflineplus">+                                                     nsIMsgWindow *msgWindow) {</span>
<a href="#l15.1799"></a><span id="l15.1799">   nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l15.1800"></a><span id="l15.1800">   SetSaveArticleOffline(true);</span>
<a href="#l15.1801"></a><span id="l15.1801">   nsresult rv = NS_OK;</span>
<a href="#l15.1802"></a><span id="l15.1802"> </span>
<a href="#l15.1803"></a><span id="l15.1803">   // build up message keys.</span>
<a href="#l15.1804"></a><span id="l15.1804" class="difflineminus">-  if (mDatabase)</span>
<a href="#l15.1805"></a><span id="l15.1805" class="difflineminus">-  {</span>
<a href="#l15.1806"></a><span id="l15.1806" class="difflineminus">-    nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l15.1807"></a><span id="l15.1807" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l15.1808"></a><span id="l15.1808" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l15.1809"></a><span id="l15.1809">     rv = mDatabase-&gt;EnumerateMessages(getter_AddRefs(enumerator));</span>
<a href="#l15.1810"></a><span id="l15.1810" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l15.1811"></a><span id="l15.1811" class="difflineminus">-    {</span>
<a href="#l15.1812"></a><span id="l15.1812" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator) {</span>
<a href="#l15.1813"></a><span id="l15.1813">       bool hasMore;</span>
<a href="#l15.1814"></a><span id="l15.1814" class="difflineminus">-      while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l15.1815"></a><span id="l15.1815" class="difflineminus">-      {</span>
<a href="#l15.1816"></a><span id="l15.1816" class="difflineminus">-        nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l15.1817"></a><span id="l15.1817" class="difflineplus">+      while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l15.1818"></a><span id="l15.1818" class="difflineplus">+             hasMore) {</span>
<a href="#l15.1819"></a><span id="l15.1819" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l15.1820"></a><span id="l15.1820">         rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l15.1821"></a><span id="l15.1821">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l15.1822"></a><span id="l15.1822" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l15.1823"></a><span id="l15.1823" class="difflineminus">-        if (pHeader &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.1824"></a><span id="l15.1824" class="difflineminus">-        {</span>
<a href="#l15.1825"></a><span id="l15.1825" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l15.1826"></a><span id="l15.1826" class="difflineplus">+        if (pHeader &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l15.1827"></a><span id="l15.1827">           bool shouldStoreMsgOffline = false;</span>
<a href="#l15.1828"></a><span id="l15.1828">           nsMsgKey msgKey;</span>
<a href="#l15.1829"></a><span id="l15.1829">           pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l15.1830"></a><span id="l15.1830">           MsgFitsDownloadCriteria(msgKey, &amp;shouldStoreMsgOffline);</span>
<a href="#l15.1831"></a><span id="l15.1831" class="difflineminus">-          if (shouldStoreMsgOffline)</span>
<a href="#l15.1832"></a><span id="l15.1832" class="difflineminus">-            srcKeyArray.AppendElement(msgKey);</span>
<a href="#l15.1833"></a><span id="l15.1833" class="difflineplus">+          if (shouldStoreMsgOffline) srcKeyArray.AppendElement(msgKey);</span>
<a href="#l15.1834"></a><span id="l15.1834">         }</span>
<a href="#l15.1835"></a><span id="l15.1835">       }</span>
<a href="#l15.1836"></a><span id="l15.1836">     }</span>
<a href="#l15.1837"></a><span id="l15.1837">   }</span>
<a href="#l15.1838"></a><span id="l15.1838">   RefPtr&lt;DownloadNewsArticlesToOfflineStore&gt; downloadState =</span>
<a href="#l15.1839"></a><span id="l15.1839" class="difflineminus">-    new DownloadNewsArticlesToOfflineStore(msgWindow, mDatabase, this);</span>
<a href="#l15.1840"></a><span id="l15.1840" class="difflineplus">+      new DownloadNewsArticlesToOfflineStore(msgWindow, mDatabase, this);</span>
<a href="#l15.1841"></a><span id="l15.1841">   m_downloadingMultipleMessages = true;</span>
<a href="#l15.1842"></a><span id="l15.1842">   rv = downloadState-&gt;DownloadArticles(msgWindow, this, &amp;srcKeyArray);</span>
<a href="#l15.1843"></a><span id="l15.1843" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l15.1844"></a><span id="l15.1844" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l15.1845"></a><span id="l15.1845">   return rv;</span>
<a href="#l15.1846"></a><span id="l15.1846"> }</span>
<a href="#l15.1847"></a><span id="l15.1847"> </span>
<a href="#l15.1848"></a><span id="l15.1848" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::DownloadMessagesForOffline(nsIArray *messages, nsIMsgWindow *window)</span>
<a href="#l15.1849"></a><span id="l15.1849" class="difflineminus">-{</span>
<a href="#l15.1850"></a><span id="l15.1850" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::DownloadMessagesForOffline(</span>
<a href="#l15.1851"></a><span id="l15.1851" class="difflineplus">+    nsIArray *messages, nsIMsgWindow *window) {</span>
<a href="#l15.1852"></a><span id="l15.1852">   nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l15.1853"></a><span id="l15.1853" class="difflineminus">-  SetSaveArticleOffline(true); // ### TODO need to clear this when we've finished</span>
<a href="#l15.1854"></a><span id="l15.1854" class="difflineplus">+  SetSaveArticleOffline(</span>
<a href="#l15.1855"></a><span id="l15.1855" class="difflineplus">+      true);  // ### TODO need to clear this when we've finished</span>
<a href="#l15.1856"></a><span id="l15.1856">   uint32_t count = 0;</span>
<a href="#l15.1857"></a><span id="l15.1857">   uint32_t i;</span>
<a href="#l15.1858"></a><span id="l15.1858">   nsresult rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l15.1859"></a><span id="l15.1859">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1860"></a><span id="l15.1860"> </span>
<a href="#l15.1861"></a><span id="l15.1861">   // build up message keys.</span>
<a href="#l15.1862"></a><span id="l15.1862" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l15.1863"></a><span id="l15.1863" class="difflineminus">-  {</span>
<a href="#l15.1864"></a><span id="l15.1864" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l15.1865"></a><span id="l15.1865">     nsMsgKey key;</span>
<a href="#l15.1866"></a><span id="l15.1866" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l15.1867"></a><span id="l15.1867" class="difflineminus">-    if (msgDBHdr)</span>
<a href="#l15.1868"></a><span id="l15.1868" class="difflineminus">-      rv = msgDBHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l15.1869"></a><span id="l15.1869" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1870"></a><span id="l15.1870" class="difflineminus">-      srcKeyArray.AppendElement(key);</span>
<a href="#l15.1871"></a><span id="l15.1871" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l15.1872"></a><span id="l15.1872" class="difflineplus">+    if (msgDBHdr) rv = msgDBHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l15.1873"></a><span id="l15.1873" class="difflineplus">+    if (NS_SUCCEEDED(rv)) srcKeyArray.AppendElement(key);</span>
<a href="#l15.1874"></a><span id="l15.1874">   }</span>
<a href="#l15.1875"></a><span id="l15.1875">   RefPtr&lt;DownloadNewsArticlesToOfflineStore&gt; downloadState =</span>
<a href="#l15.1876"></a><span id="l15.1876" class="difflineminus">-    new DownloadNewsArticlesToOfflineStore(window, mDatabase, this);</span>
<a href="#l15.1877"></a><span id="l15.1877" class="difflineplus">+      new DownloadNewsArticlesToOfflineStore(window, mDatabase, this);</span>
<a href="#l15.1878"></a><span id="l15.1878">   m_downloadingMultipleMessages = true;</span>
<a href="#l15.1879"></a><span id="l15.1879"> </span>
<a href="#l15.1880"></a><span id="l15.1880">   rv = downloadState-&gt;DownloadArticles(window, this, &amp;srcKeyArray);</span>
<a href="#l15.1881"></a><span id="l15.1881" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l15.1882"></a><span id="l15.1882" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l15.1883"></a><span id="l15.1883">   return rv;</span>
<a href="#l15.1884"></a><span id="l15.1884"> }</span>
<a href="#l15.1885"></a><span id="l15.1885"> </span>
<a href="#l15.1886"></a><span id="l15.1886"> // line does not have a line terminator (e.g., CR or CRLF)</span>
<a href="#l15.1887"></a><span id="l15.1887" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::NotifyDownloadedLine(const char *line, nsMsgKey keyOfArticle)</span>
<a href="#l15.1888"></a><span id="l15.1888" class="difflineminus">-{</span>
<a href="#l15.1889"></a><span id="l15.1889" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::NotifyDownloadedLine(const char *line,</span>
<a href="#l15.1890"></a><span id="l15.1890" class="difflineplus">+                                                    nsMsgKey keyOfArticle) {</span>
<a href="#l15.1891"></a><span id="l15.1891">   nsresult rv = NS_OK;</span>
<a href="#l15.1892"></a><span id="l15.1892" class="difflineminus">-  if (m_downloadMessageForOfflineUse)</span>
<a href="#l15.1893"></a><span id="l15.1893" class="difflineminus">-  {</span>
<a href="#l15.1894"></a><span id="l15.1894" class="difflineminus">-    if (!m_offlineHeader)</span>
<a href="#l15.1895"></a><span id="l15.1895" class="difflineminus">-    {</span>
<a href="#l15.1896"></a><span id="l15.1896" class="difflineplus">+  if (m_downloadMessageForOfflineUse) {</span>
<a href="#l15.1897"></a><span id="l15.1897" class="difflineplus">+    if (!m_offlineHeader) {</span>
<a href="#l15.1898"></a><span id="l15.1898">       GetMessageHeader(keyOfArticle, getter_AddRefs(m_offlineHeader));</span>
<a href="#l15.1899"></a><span id="l15.1899">       rv = StartNewOfflineMessage();</span>
<a href="#l15.1900"></a><span id="l15.1900">     }</span>
<a href="#l15.1901"></a><span id="l15.1901">     m_numOfflineMsgLines++;</span>
<a href="#l15.1902"></a><span id="l15.1902">   }</span>
<a href="#l15.1903"></a><span id="l15.1903"> </span>
<a href="#l15.1904"></a><span id="l15.1904" class="difflineminus">-  if (m_tempMessageStream)</span>
<a href="#l15.1905"></a><span id="l15.1905" class="difflineminus">-  {</span>
<a href="#l15.1906"></a><span id="l15.1906" class="difflineplus">+  if (m_tempMessageStream) {</span>
<a href="#l15.1907"></a><span id="l15.1907">     // line now contains the linebreak.</span>
<a href="#l15.1908"></a><span id="l15.1908" class="difflineminus">-    if (line[0] == '.' &amp;&amp; line[MSG_LINEBREAK_LEN + 1] == 0)</span>
<a href="#l15.1909"></a><span id="l15.1909" class="difflineminus">-    {</span>
<a href="#l15.1910"></a><span id="l15.1910" class="difflineplus">+    if (line[0] == '.' &amp;&amp; line[MSG_LINEBREAK_LEN + 1] == 0) {</span>
<a href="#l15.1911"></a><span id="l15.1911">       // end of article.</span>
<a href="#l15.1912"></a><span id="l15.1912" class="difflineminus">-      if (m_offlineHeader)</span>
<a href="#l15.1913"></a><span id="l15.1913" class="difflineminus">-        EndNewOfflineMessage();</span>
<a href="#l15.1914"></a><span id="l15.1914" class="difflineplus">+      if (m_offlineHeader) EndNewOfflineMessage();</span>
<a href="#l15.1915"></a><span id="l15.1915"> </span>
<a href="#l15.1916"></a><span id="l15.1916" class="difflineminus">-      if (m_tempMessageStream &amp;&amp; !m_downloadingMultipleMessages)</span>
<a href="#l15.1917"></a><span id="l15.1917" class="difflineminus">-      {</span>
<a href="#l15.1918"></a><span id="l15.1918" class="difflineplus">+      if (m_tempMessageStream &amp;&amp; !m_downloadingMultipleMessages) {</span>
<a href="#l15.1919"></a><span id="l15.1919">         m_tempMessageStream-&gt;Close();</span>
<a href="#l15.1920"></a><span id="l15.1920">         m_tempMessageStream = nullptr;</span>
<a href="#l15.1921"></a><span id="l15.1921">       }</span>
<a href="#l15.1922"></a><span id="l15.1922" class="difflineminus">-    }</span>
<a href="#l15.1923"></a><span id="l15.1923" class="difflineminus">-    else</span>
<a href="#l15.1924"></a><span id="l15.1924" class="difflineminus">-    {</span>
<a href="#l15.1925"></a><span id="l15.1925" class="difflineplus">+    } else {</span>
<a href="#l15.1926"></a><span id="l15.1926">       uint32_t count = 0;</span>
<a href="#l15.1927"></a><span id="l15.1927">       rv = m_tempMessageStream-&gt;Write(line, strlen(line), &amp;count);</span>
<a href="#l15.1928"></a><span id="l15.1928">     }</span>
<a href="#l15.1929"></a><span id="l15.1929">   }</span>
<a href="#l15.1930"></a><span id="l15.1930"> </span>
<a href="#l15.1931"></a><span id="l15.1931">   return rv;</span>
<a href="#l15.1932"></a><span id="l15.1932"> }</span>
<a href="#l15.1933"></a><span id="l15.1933"> </span>
<a href="#l15.1934"></a><span id="l15.1934" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::NotifyFinishedDownloadinghdrs()</span>
<a href="#l15.1935"></a><span id="l15.1935" class="difflineminus">-{</span>
<a href="#l15.1936"></a><span id="l15.1936" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::NotifyFinishedDownloadinghdrs() {</span>
<a href="#l15.1937"></a><span id="l15.1937">   bool wasCached = !!mDatabase;</span>
<a href="#l15.1938"></a><span id="l15.1938">   ChangeNumPendingTotalMessages(-mNumPendingTotalMessages);</span>
<a href="#l15.1939"></a><span id="l15.1939">   ChangeNumPendingUnread(-mNumPendingUnreadMessages);</span>
<a href="#l15.1940"></a><span id="l15.1940">   bool filtersRun;</span>
<a href="#l15.1941"></a><span id="l15.1941">   // run the bayesian spam filters, if enabled.</span>
<a href="#l15.1942"></a><span id="l15.1942">   CallFilterPlugins(nullptr, &amp;filtersRun);</span>
<a href="#l15.1943"></a><span id="l15.1943"> </span>
<a href="#l15.1944"></a><span id="l15.1944">   // If the DB was not open before, close our reference to it now.</span>
<a href="#l15.1945"></a><span id="l15.1945" class="difflineminus">-  if (!wasCached &amp;&amp; mDatabase)</span>
<a href="#l15.1946"></a><span id="l15.1946" class="difflineminus">-  {</span>
<a href="#l15.1947"></a><span id="l15.1947" class="difflineplus">+  if (!wasCached &amp;&amp; mDatabase) {</span>
<a href="#l15.1948"></a><span id="l15.1948">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l15.1949"></a><span id="l15.1949">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l15.1950"></a><span id="l15.1950">     // This also clears all of the cached headers that may have been added while</span>
<a href="#l15.1951"></a><span id="l15.1951">     // we were downloading messages (and those clearing refcount cycles in the</span>
<a href="#l15.1952"></a><span id="l15.1952">     // database).</span>
<a href="#l15.1953"></a><span id="l15.1953">     mDatabase-&gt;ClearCachedHdrs();</span>
<a href="#l15.1954"></a><span id="l15.1954">     mDatabase = nullptr;</span>
<a href="#l15.1955"></a><span id="l15.1955">   }</span>
<a href="#l15.1956"></a><span id="l15.1956"> </span>
<a href="#l15.1957"></a><span id="l15.1957">   return NS_OK;</span>
<a href="#l15.1958"></a><span id="l15.1958"> }</span>
<a href="#l15.1959"></a><span id="l15.1959"> </span>
<a href="#l15.1960"></a><span id="l15.1960" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l15.1961"></a><span id="l15.1961" class="difflineminus">-{</span>
<a href="#l15.1962"></a><span id="l15.1962" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::Compact(nsIUrlListener *aListener,</span>
<a href="#l15.1963"></a><span id="l15.1963" class="difflineplus">+                                       nsIMsgWindow *aMsgWindow) {</span>
<a href="#l15.1964"></a><span id="l15.1964">   nsresult rv;</span>
<a href="#l15.1965"></a><span id="l15.1965">   rv = GetDatabase();</span>
<a href="#l15.1966"></a><span id="l15.1966" class="difflineminus">-  if (mDatabase)</span>
<a href="#l15.1967"></a><span id="l15.1967" class="difflineminus">-    ApplyRetentionSettings();</span>
<a href="#l15.1968"></a><span id="l15.1968" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l15.1969"></a><span id="l15.1969" class="difflineplus">+  if (mDatabase) ApplyRetentionSettings();</span>
<a href="#l15.1970"></a><span id="l15.1970" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l15.1971"></a><span id="l15.1971">   return rv;</span>
<a href="#l15.1972"></a><span id="l15.1972"> }</span>
<a href="#l15.1973"></a><span id="l15.1973"> </span>
<a href="#l15.1974"></a><span id="l15.1974"> NS_IMETHODIMP</span>
<a href="#l15.1975"></a><span id="l15.1975" class="difflineminus">-nsMsgNewsFolder::ApplyRetentionSettings()</span>
<a href="#l15.1976"></a><span id="l15.1976" class="difflineminus">-{</span>
<a href="#l15.1977"></a><span id="l15.1977" class="difflineplus">+nsMsgNewsFolder::ApplyRetentionSettings() {</span>
<a href="#l15.1978"></a><span id="l15.1978">   return nsMsgDBFolder::ApplyRetentionSettings(false);</span>
<a href="#l15.1979"></a><span id="l15.1979"> }</span>
<a href="#l15.1980"></a><span id="l15.1980"> </span>
<a href="#l15.1981"></a><span id="l15.1981" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetMessageIdForKey(nsMsgKey key, nsACString&amp; result)</span>
<a href="#l15.1982"></a><span id="l15.1982" class="difflineminus">-{</span>
<a href="#l15.1983"></a><span id="l15.1983" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetMessageIdForKey(nsMsgKey key,</span>
<a href="#l15.1984"></a><span id="l15.1984" class="difflineplus">+                                                  nsACString &amp;result) {</span>
<a href="#l15.1985"></a><span id="l15.1985">   nsresult rv = GetDatabase();</span>
<a href="#l15.1986"></a><span id="l15.1986" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l15.1987"></a><span id="l15.1987" class="difflineminus">-    return rv;</span>
<a href="#l15.1988"></a><span id="l15.1988" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l15.1989"></a><span id="l15.1989" class="difflineplus">+  if (!mDatabase) return rv;</span>
<a href="#l15.1990"></a><span id="l15.1990" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l15.1991"></a><span id="l15.1991">   rv = mDatabase-&gt;GetMsgHdrForKey(key, getter_AddRefs(hdr));</span>
<a href="#l15.1992"></a><span id="l15.1992" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.1993"></a><span id="l15.1993" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1994"></a><span id="l15.1994">   nsCString id;</span>
<a href="#l15.1995"></a><span id="l15.1995">   rv = hdr-&gt;GetMessageId(getter_Copies(id));</span>
<a href="#l15.1996"></a><span id="l15.1996">   result.Assign(id);</span>
<a href="#l15.1997"></a><span id="l15.1997">   return rv;</span>
<a href="#l15.1998"></a><span id="l15.1998"> }</span>
<a href="#l15.1999"></a><span id="l15.1999"> </span>
<a href="#l15.2000"></a><span id="l15.2000" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::SetSortOrder(int32_t order)</span>
<a href="#l15.2001"></a><span id="l15.2001" class="difflineminus">-{</span>
<a href="#l15.2002"></a><span id="l15.2002" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::SetSortOrder(int32_t order) {</span>
<a href="#l15.2003"></a><span id="l15.2003">   int32_t oldOrder = mSortOrder;</span>
<a href="#l15.2004"></a><span id="l15.2004">   mSortOrder = order;</span>
<a href="#l15.2005"></a><span id="l15.2005"> </span>
<a href="#l15.2006"></a><span id="l15.2006">   NotifyIntPropertyChanged(kSortOrder, oldOrder, order);</span>
<a href="#l15.2007"></a><span id="l15.2007"> </span>
<a href="#l15.2008"></a><span id="l15.2008">   return NS_OK;</span>
<a href="#l15.2009"></a><span id="l15.2009"> }</span>
<a href="#l15.2010"></a><span id="l15.2010"> </span>
<a href="#l15.2011"></a><span id="l15.2011" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetSortOrder(int32_t *order)</span>
<a href="#l15.2012"></a><span id="l15.2012" class="difflineminus">-{</span>
<a href="#l15.2013"></a><span id="l15.2013" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetSortOrder(int32_t *order) {</span>
<a href="#l15.2014"></a><span id="l15.2014">   NS_ENSURE_ARG_POINTER(order);</span>
<a href="#l15.2015"></a><span id="l15.2015">   *order = mSortOrder;</span>
<a href="#l15.2016"></a><span id="l15.2016">   return NS_OK;</span>
<a href="#l15.2017"></a><span id="l15.2017"> }</span>
<a href="#l15.2018"></a><span id="l15.2018"> </span>
<a href="#l15.2019"></a><span id="l15.2019" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::Shutdown(bool shutdownChildren)</span>
<a href="#l15.2020"></a><span id="l15.2020" class="difflineminus">-{</span>
<a href="#l15.2021"></a><span id="l15.2021" class="difflineminus">-  if (mFilterList)</span>
<a href="#l15.2022"></a><span id="l15.2022" class="difflineminus">-  {</span>
<a href="#l15.2023"></a><span id="l15.2023" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::Shutdown(bool shutdownChildren) {</span>
<a href="#l15.2024"></a><span id="l15.2024" class="difflineplus">+  if (mFilterList) {</span>
<a href="#l15.2025"></a><span id="l15.2025">     // close the filter log stream</span>
<a href="#l15.2026"></a><span id="l15.2026">     nsresult rv = mFilterList-&gt;SetLogStream(nullptr);</span>
<a href="#l15.2027"></a><span id="l15.2027" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.2028"></a><span id="l15.2028" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2029"></a><span id="l15.2029">     mFilterList = nullptr;</span>
<a href="#l15.2030"></a><span id="l15.2030">   }</span>
<a href="#l15.2031"></a><span id="l15.2031"> </span>
<a href="#l15.2032"></a><span id="l15.2032">   mInitialized = false;</span>
<a href="#l15.2033"></a><span id="l15.2033">   if (mReadSet) {</span>
<a href="#l15.2034"></a><span id="l15.2034">     // the nsINewsDatabase holds a weak ref to the readset,</span>
<a href="#l15.2035"></a><span id="l15.2035">     // and we outlive the db, so it's safe to delete it here.</span>
<a href="#l15.2036"></a><span id="l15.2036">     nsCOMPtr&lt;nsINewsDatabase&gt; db = do_QueryInterface(mDatabase);</span>
<a href="#l15.2037"></a><span id="l15.2037" class="difflineminus">-    if (db)</span>
<a href="#l15.2038"></a><span id="l15.2038" class="difflineminus">-      db-&gt;SetReadSet(nullptr);</span>
<a href="#l15.2039"></a><span id="l15.2039" class="difflineplus">+    if (db) db-&gt;SetReadSet(nullptr);</span>
<a href="#l15.2040"></a><span id="l15.2040">     delete mReadSet;</span>
<a href="#l15.2041"></a><span id="l15.2041">     mReadSet = nullptr;</span>
<a href="#l15.2042"></a><span id="l15.2042">   }</span>
<a href="#l15.2043"></a><span id="l15.2043">   return nsMsgDBFolder::Shutdown(shutdownChildren);</span>
<a href="#l15.2044"></a><span id="l15.2044"> }</span>
<a href="#l15.2045"></a><span id="l15.2045"> </span>
<a href="#l15.2046"></a><span id="l15.2046"> NS_IMETHODIMP</span>
<a href="#l15.2047"></a><span id="l15.2047" class="difflineminus">-nsMsgNewsFolder::SetFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l15.2048"></a><span id="l15.2048" class="difflineminus">-{</span>
<a href="#l15.2049"></a><span id="l15.2049" class="difflineminus">-  if (mIsServer)</span>
<a href="#l15.2050"></a><span id="l15.2050" class="difflineminus">-  {</span>
<a href="#l15.2051"></a><span id="l15.2051" class="difflineplus">+nsMsgNewsFolder::SetFilterList(nsIMsgFilterList *aFilterList) {</span>
<a href="#l15.2052"></a><span id="l15.2052" class="difflineplus">+  if (mIsServer) {</span>
<a href="#l15.2053"></a><span id="l15.2053">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.2054"></a><span id="l15.2054">     nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.2055"></a><span id="l15.2055" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.2056"></a><span id="l15.2056" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2057"></a><span id="l15.2057">     return server-&gt;SetFilterList(aFilterList);</span>
<a href="#l15.2058"></a><span id="l15.2058">   }</span>
<a href="#l15.2059"></a><span id="l15.2059"> </span>
<a href="#l15.2060"></a><span id="l15.2060">   mFilterList = aFilterList;</span>
<a href="#l15.2061"></a><span id="l15.2061">   return NS_OK;</span>
<a href="#l15.2062"></a><span id="l15.2062"> }</span>
<a href="#l15.2063"></a><span id="l15.2063"> </span>
<a href="#l15.2064"></a><span id="l15.2064"> NS_IMETHODIMP</span>
<a href="#l15.2065"></a><span id="l15.2065" class="difflineminus">-nsMsgNewsFolder::GetFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l15.2066"></a><span id="l15.2066" class="difflineminus">-{</span>
<a href="#l15.2067"></a><span id="l15.2067" class="difflineminus">-  if (mIsServer)</span>
<a href="#l15.2068"></a><span id="l15.2068" class="difflineminus">-  {</span>
<a href="#l15.2069"></a><span id="l15.2069" class="difflineplus">+nsMsgNewsFolder::GetFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.2070"></a><span id="l15.2070" class="difflineplus">+                               nsIMsgFilterList **aResult) {</span>
<a href="#l15.2071"></a><span id="l15.2071" class="difflineplus">+  if (mIsServer) {</span>
<a href="#l15.2072"></a><span id="l15.2072">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.2073"></a><span id="l15.2073">     nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.2074"></a><span id="l15.2074" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.2075"></a><span id="l15.2075" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2076"></a><span id="l15.2076">     return server-&gt;GetFilterList(aMsgWindow, aResult);</span>
<a href="#l15.2077"></a><span id="l15.2077">   }</span>
<a href="#l15.2078"></a><span id="l15.2078"> </span>
<a href="#l15.2079"></a><span id="l15.2079" class="difflineminus">-  if (!mFilterList)</span>
<a href="#l15.2080"></a><span id="l15.2080" class="difflineminus">-  {</span>
<a href="#l15.2081"></a><span id="l15.2081" class="difflineplus">+  if (!mFilterList) {</span>
<a href="#l15.2082"></a><span id="l15.2082">     nsCOMPtr&lt;nsIFile&gt; thisFolder;</span>
<a href="#l15.2083"></a><span id="l15.2083">     nsresult rv = GetFilePath(getter_AddRefs(thisFolder));</span>
<a href="#l15.2084"></a><span id="l15.2084">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2085"></a><span id="l15.2085"> </span>
<a href="#l15.2086"></a><span id="l15.2086" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; filterFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l15.2087"></a><span id="l15.2087" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);;</span>
<a href="#l15.2088"></a><span id="l15.2088" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; filterFile =</span>
<a href="#l15.2089"></a><span id="l15.2089" class="difflineplus">+        do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l15.2090"></a><span id="l15.2090" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2091"></a><span id="l15.2091" class="difflineplus">+    ;</span>
<a href="#l15.2092"></a><span id="l15.2092">     rv = filterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l15.2093"></a><span id="l15.2093">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2094"></a><span id="l15.2094"> </span>
<a href="#l15.2095"></a><span id="l15.2095">     // in 4.x, the news filter file was</span>
<a href="#l15.2096"></a><span id="l15.2096" class="difflineminus">-    // C:\Program Files\Netscape\Users\meer\News\host-news.mcom.com\mcom.test.dat</span>
<a href="#l15.2097"></a><span id="l15.2097" class="difflineminus">-    // where the summary file was</span>
<a href="#l15.2098"></a><span id="l15.2098" class="difflineminus">-    // C:\Program Files\Netscape\Users\meer\News\host-news.mcom.com\mcom.test.snm</span>
<a href="#l15.2099"></a><span id="l15.2099" class="difflineminus">-    // we make the rules file &quot;.dat&quot; in mozilla, so that migration works.</span>
<a href="#l15.2100"></a><span id="l15.2100" class="difflineplus">+    // C:\Program</span>
<a href="#l15.2101"></a><span id="l15.2101" class="difflineplus">+    // Files\Netscape\Users\meer\News\host-news.mcom.com\mcom.test.dat where the</span>
<a href="#l15.2102"></a><span id="l15.2102" class="difflineplus">+    // summary file was C:\Program</span>
<a href="#l15.2103"></a><span id="l15.2103" class="difflineplus">+    // Files\Netscape\Users\meer\News\host-news.mcom.com\mcom.test.snm we make</span>
<a href="#l15.2104"></a><span id="l15.2104" class="difflineplus">+    // the rules file &quot;.dat&quot; in mozilla, so that migration works.</span>
<a href="#l15.2105"></a><span id="l15.2105"> </span>
<a href="#l15.2106"></a><span id="l15.2106">     // NOTE:</span>
<a href="#l15.2107"></a><span id="l15.2107">     // we don't we need to call NS_MsgHashIfNecessary()</span>
<a href="#l15.2108"></a><span id="l15.2108">     // it's already been hashed, if necessary</span>
<a href="#l15.2109"></a><span id="l15.2109">     nsCString filterFileName;</span>
<a href="#l15.2110"></a><span id="l15.2110">     rv = filterFile-&gt;GetNativeLeafName(filterFileName);</span>
<a href="#l15.2111"></a><span id="l15.2111" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.2112"></a><span id="l15.2112" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2113"></a><span id="l15.2113"> </span>
<a href="#l15.2114"></a><span id="l15.2114">     filterFileName.AppendLiteral(&quot;.dat&quot;);</span>
<a href="#l15.2115"></a><span id="l15.2115"> </span>
<a href="#l15.2116"></a><span id="l15.2116">     rv = filterFile-&gt;SetNativeLeafName(filterFileName);</span>
<a href="#l15.2117"></a><span id="l15.2117" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.2118"></a><span id="l15.2118" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2119"></a><span id="l15.2119"> </span>
<a href="#l15.2120"></a><span id="l15.2120">     nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l15.2121"></a><span id="l15.2121" class="difflineminus">-      do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.2122"></a><span id="l15.2122" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l15.2123"></a><span id="l15.2123">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2124"></a><span id="l15.2124"> </span>
<a href="#l15.2125"></a><span id="l15.2125" class="difflineminus">-    rv = filterService-&gt;OpenFilterList(filterFile, this, aMsgWindow, getter_AddRefs(mFilterList));</span>
<a href="#l15.2126"></a><span id="l15.2126" class="difflineplus">+    rv = filterService-&gt;OpenFilterList(filterFile, this, aMsgWindow,</span>
<a href="#l15.2127"></a><span id="l15.2127" class="difflineplus">+                                       getter_AddRefs(mFilterList));</span>
<a href="#l15.2128"></a><span id="l15.2128">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.2129"></a><span id="l15.2129">   }</span>
<a href="#l15.2130"></a><span id="l15.2130"> </span>
<a href="#l15.2131"></a><span id="l15.2131">   NS_IF_ADDREF(*aResult = mFilterList);</span>
<a href="#l15.2132"></a><span id="l15.2132">   return NS_OK;</span>
<a href="#l15.2133"></a><span id="l15.2133"> }</span>
<a href="#l15.2134"></a><span id="l15.2134"> </span>
<a href="#l15.2135"></a><span id="l15.2135"> NS_IMETHODIMP</span>
<a href="#l15.2136"></a><span id="l15.2136" class="difflineminus">-nsMsgNewsFolder::GetEditableFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l15.2137"></a><span id="l15.2137" class="difflineminus">-{</span>
<a href="#l15.2138"></a><span id="l15.2138" class="difflineplus">+nsMsgNewsFolder::GetEditableFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l15.2139"></a><span id="l15.2139" class="difflineplus">+                                       nsIMsgFilterList **aResult) {</span>
<a href="#l15.2140"></a><span id="l15.2140">   // We don't support pluggable filter list types for news.</span>
<a href="#l15.2141"></a><span id="l15.2141">   return GetFilterList(aMsgWindow, aResult);</span>
<a href="#l15.2142"></a><span id="l15.2142"> }</span>
<a href="#l15.2143"></a><span id="l15.2143"> </span>
<a href="#l15.2144"></a><span id="l15.2144"> NS_IMETHODIMP</span>
<a href="#l15.2145"></a><span id="l15.2145" class="difflineminus">-nsMsgNewsFolder::SetEditableFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l15.2146"></a><span id="l15.2146" class="difflineminus">-{</span>
<a href="#l15.2147"></a><span id="l15.2147" class="difflineplus">+nsMsgNewsFolder::SetEditableFilterList(nsIMsgFilterList *aFilterList) {</span>
<a href="#l15.2148"></a><span id="l15.2148">   return SetFilterList(aFilterList);</span>
<a href="#l15.2149"></a><span id="l15.2149"> }</span>
<a href="#l15.2150"></a><span id="l15.2150"> </span>
<a href="#l15.2151"></a><span id="l15.2151"> NS_IMETHODIMP</span>
<a href="#l15.2152"></a><span id="l15.2152" class="difflineminus">-nsMsgNewsFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l15.2153"></a><span id="l15.2153" class="difflineminus">-{</span>
<a href="#l15.2154"></a><span id="l15.2154" class="difflineminus">- if (m_tempMessageStream)</span>
<a href="#l15.2155"></a><span id="l15.2155" class="difflineminus">-  {</span>
<a href="#l15.2156"></a><span id="l15.2156" class="difflineplus">+nsMsgNewsFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l15.2157"></a><span id="l15.2157" class="difflineplus">+  if (m_tempMessageStream) {</span>
<a href="#l15.2158"></a><span id="l15.2158">     m_tempMessageStream-&gt;Close();</span>
<a href="#l15.2159"></a><span id="l15.2159">     m_tempMessageStream = nullptr;</span>
<a href="#l15.2160"></a><span id="l15.2160">   }</span>
<a href="#l15.2161"></a><span id="l15.2161">   m_downloadingMultipleMessages = false;</span>
<a href="#l15.2162"></a><span id="l15.2162">   return nsMsgDBFolder::OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l15.2163"></a><span id="l15.2163"> }</span>
<a href="#l15.2164"></a><span id="l15.2164"> </span>
<a href="#l15.2165"></a><span id="l15.2165"> NS_IMETHODIMP</span>
<a href="#l15.2166"></a><span id="l15.2166" class="difflineminus">-nsMsgNewsFolder::GetIncomingServerType(nsACString&amp; serverType)</span>
<a href="#l15.2167"></a><span id="l15.2167" class="difflineminus">-{</span>
<a href="#l15.2168"></a><span id="l15.2168" class="difflineplus">+nsMsgNewsFolder::GetIncomingServerType(nsACString &amp;serverType) {</span>
<a href="#l15.2169"></a><span id="l15.2169">   serverType.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l15.2170"></a><span id="l15.2170">   return NS_OK;</span>
<a href="#l15.2171"></a><span id="l15.2171"> }</span>
<a href="#l15.2172"></a><span id="l15.2172" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -15,66 +15,64 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIFile.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsNewsUtils.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsIMsgNewsFolder.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIArray.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class nsMsgNewsFolder : public nsMsgDBFolder, public nsIMsgNewsFolder</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-public:</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+class nsMsgNewsFolder : public nsMsgDBFolder, public nsIMsgNewsFolder {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ public:</span>
<a href="#l16.17"></a><span id="l16.17">   nsMsgNewsFolder(void);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l16.20"></a><span id="l16.20">   NS_DECL_NSIMSGNEWSFOLDER</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22">   // nsIUrlListener method</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-  NS_IMETHOD OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode) override;</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+  NS_IMETHOD OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) override;</span>
<a href="#l16.25"></a><span id="l16.25">   // nsIMsgFolder methods:</span>
<a href="#l16.26"></a><span id="l16.26">   NS_IMETHOD GetSubFolders(nsISimpleEnumerator **aResult) override;</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28">   NS_IMETHOD GetMessages(nsISimpleEnumerator **result) override;</span>
<a href="#l16.29"></a><span id="l16.29">   NS_IMETHOD UpdateFolder(nsIMsgWindow *aWindow) override;</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  NS_IMETHOD CreateSubfolder(const nsAString&amp; folderName,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  NS_IMETHOD CreateSubfolder(const nsAString &amp;folderName,</span>
<a href="#l16.33"></a><span id="l16.33">                              nsIMsgWindow *msgWindow) override;</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">   NS_IMETHOD Delete() override;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  NS_IMETHOD Rename(const nsAString&amp; newName,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-                     nsIMsgWindow *msgWindow) override;</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+  NS_IMETHOD Rename(const nsAString &amp;newName, nsIMsgWindow *msgWindow) override;</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  NS_IMETHOD GetAbbreviatedName(nsAString&amp; aAbbreviatedName) override;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  NS_IMETHOD GetAbbreviatedName(nsAString &amp;aAbbreviatedName) override;</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-  NS_IMETHOD GetFolderURL(nsACString&amp; url) override;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  NS_IMETHOD GetFolderURL(nsACString &amp;url) override;</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">   NS_IMETHOD GetExpungedBytesCount(int64_t *count);</span>
<a href="#l16.47"></a><span id="l16.47">   NS_IMETHOD GetDeletable(bool *deletable) override;</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49">   NS_IMETHOD RefreshSizeOnDisk();</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51">   NS_IMETHOD GetSizeOnDisk(int64_t *size) override;</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53">   NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l16.54"></a><span id="l16.54">                                   nsIMsgDatabase **db) override;</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  NS_IMETHOD DeleteMessages(nsIArray *messages,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-                            nsIMsgWindow *msgWindow, bool deleteStorage,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-                            bool isMove, nsIMsgCopyServiceListener* listener,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+  NS_IMETHOD DeleteMessages(nsIArray *messages, nsIMsgWindow *msgWindow,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+                            bool deleteStorage, bool isMove,</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+                            nsIMsgCopyServiceListener *listener,</span>
<a href="#l16.62"></a><span id="l16.62">                             bool allowUndo) override;</span>
<a href="#l16.63"></a><span id="l16.63">   NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow,</span>
<a href="#l16.64"></a><span id="l16.64">                             nsIUrlListener *aListener) override;</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66">   NS_IMETHOD GetCanSubscribe(bool *aResult) override;</span>
<a href="#l16.67"></a><span id="l16.67">   NS_IMETHOD GetCanFileMessages(bool *aResult) override;</span>
<a href="#l16.68"></a><span id="l16.68">   NS_IMETHOD GetCanCreateSubfolders(bool *aResult) override;</span>
<a href="#l16.69"></a><span id="l16.69">   NS_IMETHOD GetCanRename(bool *aResult) override;</span>
<a href="#l16.70"></a><span id="l16.70">   NS_IMETHOD GetCanCompact(bool *aResult) override;</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  NS_IMETHOD OnReadChanged(nsIDBChangeListener * aInstigator) override;</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  NS_IMETHOD OnReadChanged(nsIDBChangeListener *aInstigator) override;</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74">   NS_IMETHOD DownloadMessagesForOffline(nsIArray *messages,</span>
<a href="#l16.75"></a><span id="l16.75">                                         nsIMsgWindow *window) override;</span>
<a href="#l16.76"></a><span id="l16.76">   NS_IMETHOD Compact(nsIUrlListener *aListener,</span>
<a href="#l16.77"></a><span id="l16.77">                      nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l16.78"></a><span id="l16.78">   NS_IMETHOD DownloadAllForOffline(nsIUrlListener *listener,</span>
<a href="#l16.79"></a><span id="l16.79">                                    nsIMsgWindow *msgWindow) override;</span>
<a href="#l16.80"></a><span id="l16.80">   NS_IMETHOD GetSortOrder(int32_t *order) override;</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineat">@@ -84,39 +82,41 @@ public:</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83">   NS_IMETHOD GetFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l16.84"></a><span id="l16.84">                            nsIMsgFilterList **aFilterList) override;</span>
<a href="#l16.85"></a><span id="l16.85">   NS_IMETHOD GetEditableFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l16.86"></a><span id="l16.86">                                    nsIMsgFilterList **aFilterList) override;</span>
<a href="#l16.87"></a><span id="l16.87">   NS_IMETHOD SetFilterList(nsIMsgFilterList *aFilterList) override;</span>
<a href="#l16.88"></a><span id="l16.88">   NS_IMETHOD SetEditableFilterList(nsIMsgFilterList *aFilterList) override;</span>
<a href="#l16.89"></a><span id="l16.89">   NS_IMETHOD ApplyRetentionSettings() override;</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-  NS_IMETHOD GetIncomingServerType(nsACString&amp; serverType) override;</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+  NS_IMETHOD GetIncomingServerType(nsACString &amp;serverType) override;</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-protected:</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+ protected:</span>
<a href="#l16.95"></a><span id="l16.95">   virtual ~nsMsgNewsFolder();</span>
<a href="#l16.96"></a><span id="l16.96">   // helper routine to parse the URI and update member variables</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-  nsresult AbbreviatePrettyName(nsAString&amp; prettyName, int32_t fullwords);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  nsresult AbbreviatePrettyName(nsAString &amp;prettyName, int32_t fullwords);</span>
<a href="#l16.99"></a><span id="l16.99">   nsresult ParseFolder(nsIFile *path);</span>
<a href="#l16.100"></a><span id="l16.100">   nsresult CreateSubFolders(nsIFile *path);</span>
<a href="#l16.101"></a><span id="l16.101">   nsresult AddDirectorySeparator(nsIFile *path);</span>
<a href="#l16.102"></a><span id="l16.102">   nsresult GetDatabase() override;</span>
<a href="#l16.103"></a><span id="l16.103">   virtual nsresult CreateChildFromURI(const nsCString &amp;uri,</span>
<a href="#l16.104"></a><span id="l16.104">                                       nsIMsgFolder **folder) override;</span>
<a href="#l16.105"></a><span id="l16.105"> </span>
<a href="#l16.106"></a><span id="l16.106">   nsresult LoadNewsrcFileAndCreateNewsgroups();</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-  int32_t RememberLine(const nsACString&amp; line);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-  nsresult RememberUnsubscribedGroup(const nsACString&amp; newsgroup, const nsACString&amp; setStr);</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  int32_t RememberLine(const nsACString &amp;line);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+  nsresult RememberUnsubscribedGroup(const nsACString &amp;newsgroup,</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+                                     const nsACString &amp;setStr);</span>
<a href="#l16.112"></a><span id="l16.112">   nsresult ForgetLine(void);</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-  nsresult GetNewsMessages(nsIMsgWindow *aMsgWindow, bool getOld, nsIUrlListener *aListener);</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+  nsresult GetNewsMessages(nsIMsgWindow *aMsgWindow, bool getOld,</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+                           nsIUrlListener *aListener);</span>
<a href="#l16.116"></a><span id="l16.116"> </span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-  int32_t HandleNewsrcLine(const char * line, uint32_t line_size);</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-  virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI) override;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+  int32_t HandleNewsrcLine(const char *line, uint32_t line_size);</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  virtual nsresult CreateBaseMessageURI(const nsACString &amp;aURI) override;</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-protected:</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+ protected:</span>
<a href="#l16.124"></a><span id="l16.124">   int64_t mExpungedBytes;</span>
<a href="#l16.125"></a><span id="l16.125">   bool mGettingNews;</span>
<a href="#l16.126"></a><span id="l16.126">   bool mInitialized;</span>
<a href="#l16.127"></a><span id="l16.127">   bool m_downloadMessageForOfflineUse;</span>
<a href="#l16.128"></a><span id="l16.128">   bool m_downloadingMultipleMessages;</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130">   nsCString mOptionLines;</span>
<a href="#l16.131"></a><span id="l16.131">   nsCString mUnsubscribedNewsgroupLines;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineat">@@ -127,20 +127,20 @@ protected:</span>
<a href="#l16.133"></a><span id="l16.133">   // used for auth news</span>
<a href="#l16.134"></a><span id="l16.134">   nsCString mGroupUsername;</span>
<a href="#l16.135"></a><span id="l16.135">   nsCString mGroupPassword;</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137">   // the name of the newsgroup.</span>
<a href="#l16.138"></a><span id="l16.138">   nsCString mRawName;</span>
<a href="#l16.139"></a><span id="l16.139">   int32_t mSortOrder;</span>
<a href="#l16.140"></a><span id="l16.140"> </span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-private:</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+ private:</span>
<a href="#l16.143"></a><span id="l16.143">   /**</span>
<a href="#l16.144"></a><span id="l16.144">    * Constructs a signon url for use in login manager.</span>
<a href="#l16.145"></a><span id="l16.145">    *</span>
<a href="#l16.146"></a><span id="l16.146">    * @param ref    The URI ref (should be null unless working with legacy).</span>
<a href="#l16.147"></a><span id="l16.147">    * @param result The result of the string</span>
<a href="#l16.148"></a><span id="l16.148">    */</span>
<a href="#l16.149"></a><span id="l16.149">   nsresult CreateNewsgroupUrlForSignon(const char *ref, nsAString &amp;result);</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; mFilterList;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; mFilterList;</span>
<a href="#l16.152"></a><span id="l16.152"> };</span>
<a href="#l16.153"></a><span id="l16.153"> </span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-#endif // nsMsgNewsFolder_h__</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+#endif  // nsMsgNewsFolder_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/news/src/nsNewsUtils.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsUtils.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -3,60 +3,56 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.5"></a><span id="l17.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nntpCore.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsNewsUtils.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-</span>
<a href="#l17.13"></a><span id="l17.13"> /* parses NewsMessageURI */</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-nsresult</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-nsParseNewsMessageURI(const char* uri, nsCString&amp; group, nsMsgKey *key)</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-{</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+nsresult nsParseNewsMessageURI(const char *uri, nsCString &amp;group,</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+                               nsMsgKey *key) {</span>
<a href="#l17.19"></a><span id="l17.19">   NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l17.20"></a><span id="l17.20">   NS_ENSURE_ARG_POINTER(key);</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22">   nsAutoCString uriStr(uri);</span>
<a href="#l17.23"></a><span id="l17.23">   int32_t keySeparator = uriStr.FindChar('#');</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  if(keySeparator != -1)</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-  {</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+  if (keySeparator != -1) {</span>
<a href="#l17.27"></a><span id="l17.27">     int32_t keyEndSeparator = MsgFindCharInSet(uriStr, &quot;?&amp;&quot;, keySeparator);</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">     // Grab between the last '/' and the '#' for the key</span>
<a href="#l17.30"></a><span id="l17.30">     group = StringHead(uriStr, keySeparator);</span>
<a href="#l17.31"></a><span id="l17.31">     int32_t groupSeparator = group.RFind(&quot;/&quot;);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-    if (groupSeparator == -1)</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    if (groupSeparator == -1) return NS_ERROR_FAILURE;</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">     // Our string APIs don't let us unescape into the same buffer from earlier,</span>
<a href="#l17.37"></a><span id="l17.37">     // so escape into a temporary</span>
<a href="#l17.38"></a><span id="l17.38">     nsAutoCString unescapedGroup;</span>
<a href="#l17.39"></a><span id="l17.39">     MsgUnescapeString(Substring(group, groupSeparator + 1), 0, unescapedGroup);</span>
<a href="#l17.40"></a><span id="l17.40">     group = unescapedGroup;</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42">     nsAutoCString keyStr;</span>
<a href="#l17.43"></a><span id="l17.43">     if (keyEndSeparator != -1)</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-      keyStr = Substring(uriStr, keySeparator + 1, keyEndSeparator - (keySeparator + 1));</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+      keyStr = Substring(uriStr, keySeparator + 1,</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+                         keyEndSeparator - (keySeparator + 1));</span>
<a href="#l17.47"></a><span id="l17.47">     else</span>
<a href="#l17.48"></a><span id="l17.48">       keyStr = Substring(uriStr, keySeparator + 1);</span>
<a href="#l17.49"></a><span id="l17.49">     nsresult errorCode;</span>
<a href="#l17.50"></a><span id="l17.50">     *key = keyStr.ToInteger(&amp;errorCode);</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">     return errorCode;</span>
<a href="#l17.53"></a><span id="l17.53">   }</span>
<a href="#l17.54"></a><span id="l17.54">   return NS_ERROR_FAILURE;</span>
<a href="#l17.55"></a><span id="l17.55"> }</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-nsresult nsCreateNewsBaseMessageURI(const char *baseURI, nsCString &amp;baseMessageURI)</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-{</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+nsresult nsCreateNewsBaseMessageURI(const char *baseURI,</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+                                    nsCString &amp;baseMessageURI) {</span>
<a href="#l17.61"></a><span id="l17.61">   nsAutoCString tailURI(baseURI);</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">   // chop off news:/</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-  if (tailURI.Find(kNewsRootURI) == 0)</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-    tailURI.Cut(0, PL_strlen(kNewsRootURI));</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+  if (tailURI.Find(kNewsRootURI) == 0) tailURI.Cut(0, PL_strlen(kNewsRootURI));</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68">   baseMessageURI = kNewsMessageRootURI;</span>
<a href="#l17.69"></a><span id="l17.69">   baseMessageURI += tailURI;</span>
<a href="#l17.70"></a><span id="l17.70"> </span>
<a href="#l17.71"></a><span id="l17.71">   return NS_OK;</span>
<a href="#l17.72"></a><span id="l17.72"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/news/src/nsNewsUtils.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsUtils.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -16,16 +16,15 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #define kNewsURIKeyQuery &quot;&amp;key=&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> #define kNewsRootURILen 6</span>
<a href="#l18.7"></a><span id="l18.7"> #define kNntpRootURILen 6</span>
<a href="#l18.8"></a><span id="l18.8"> #define kNewsMessageRootURILen 14</span>
<a href="#l18.9"></a><span id="l18.9"> #define kNewsURIGroupQueryLen 7</span>
<a href="#l18.10"></a><span id="l18.10"> #define kNewsURIKeyQueryLen 5</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-extern nsresult</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-nsParseNewsMessageURI(const char* uri, nsCString&amp; group, nsMsgKey *key);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+extern nsresult nsParseNewsMessageURI(const char *uri, nsCString &amp;group,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+                                      nsMsgKey *key);</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-extern nsresult</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-nsCreateNewsBaseMessageURI(const char *baseURI, nsCString &amp;baseMessageURI);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+extern nsresult nsCreateNewsBaseMessageURI(const char *baseURI,</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+                                           nsCString &amp;baseMessageURI);</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-#endif //NS_NEWSUTILS_H</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+#endif  // NS_NEWSUTILS_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -29,74 +29,70 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;mozilla/dom/Element.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;mozilla/ErrorResult.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;mozilla/dom/XULTreeElement.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#define INVALID_VERSION         0</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-#define VALID_VERSION           2</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-#define NEW_NEWS_DIR_NAME       &quot;News&quot;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-#define PREF_MAIL_NEWSRC_ROOT   &quot;mail.newsrc_root&quot;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+#define INVALID_VERSION 0</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+#define VALID_VERSION 2</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+#define NEW_NEWS_DIR_NAME &quot;News&quot;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+#define PREF_MAIL_NEWSRC_ROOT &quot;mail.newsrc_root&quot;</span>
<a href="#l19.20"></a><span id="l19.20"> #define PREF_MAIL_NEWSRC_ROOT_REL &quot;mail.newsrc_root-rel&quot;</span>
<a href="#l19.21"></a><span id="l19.21"> #define PREF_MAILNEWS_VIEW_DEFAULT_CHARSET &quot;mailnews.view_default_charset&quot;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-#define HOSTINFO_FILE_NAME      &quot;hostinfo.dat&quot;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+#define HOSTINFO_FILE_NAME &quot;hostinfo.dat&quot;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-#define NEWS_DELIMITER          '.'</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+#define NEWS_DELIMITER '.'</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28"> // this platform specific junk is so the newsrc filenames we create</span>
<a href="#l19.29"></a><span id="l19.29"> // will resemble the migrated newsrc filenames.</span>
<a href="#l19.30"></a><span id="l19.30"> #if defined(XP_UNIX)</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-#define NEWSRC_FILE_PREFIX &quot;newsrc-&quot;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-#define NEWSRC_FILE_SUFFIX &quot;&quot;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+#  define NEWSRC_FILE_PREFIX &quot;newsrc-&quot;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+#  define NEWSRC_FILE_SUFFIX &quot;&quot;</span>
<a href="#l19.35"></a><span id="l19.35"> #else</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-#define NEWSRC_FILE_PREFIX &quot;&quot;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-#define NEWSRC_FILE_SUFFIX &quot;.rc&quot;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+#  define NEWSRC_FILE_PREFIX &quot;&quot;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+#  define NEWSRC_FILE_SUFFIX &quot;.rc&quot;</span>
<a href="#l19.40"></a><span id="l19.40"> #endif /* XP_UNIX */</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42"> // ###tw  This really ought to be the most</span>
<a href="#l19.43"></a><span id="l19.43"> // efficient file reading size for the current</span>
<a href="#l19.44"></a><span id="l19.44"> // operating system.</span>
<a href="#l19.45"></a><span id="l19.45"> #define HOSTINFO_FILE_BUFFER_SIZE 1024</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49"> /**</span>
<a href="#l19.50"></a><span id="l19.50">  * A comparator class to do cases insensitive comparisons for nsTArray.Sort()</span>
<a href="#l19.51"></a><span id="l19.51">  */</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-class nsCStringLowerCaseComparator</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-{</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-public:</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-  bool Equals(const nsCString &amp;a, const nsCString &amp;b) const</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-  {</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+class nsCStringLowerCaseComparator {</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+ public:</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+  bool Equals(const nsCString &amp;a, const nsCString &amp;b) const {</span>
<a href="#l19.60"></a><span id="l19.60">     return a.Equals(b, nsCaseInsensitiveCStringComparator());</span>
<a href="#l19.61"></a><span id="l19.61">   }</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  bool LessThan(const nsCString &amp;a, const nsCString &amp;b) const</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-  {</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  bool LessThan(const nsCString &amp;a, const nsCString &amp;b) const {</span>
<a href="#l19.66"></a><span id="l19.66">     return Compare(a, b, nsCaseInsensitiveCStringComparator()) &lt; 0;</span>
<a href="#l19.67"></a><span id="l19.67">   }</span>
<a href="#l19.68"></a><span id="l19.68"> };</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70"> static NS_DEFINE_CID(kSubscribableServerCID, NS_SUBSCRIBABLESERVER_CID);</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72"> NS_IMPL_ADDREF_INHERITED(nsNntpIncomingServer, nsMsgIncomingServer)</span>
<a href="#l19.73"></a><span id="l19.73"> NS_IMPL_RELEASE_INHERITED(nsNntpIncomingServer, nsMsgIncomingServer)</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75"> NS_INTERFACE_MAP_BEGIN(nsNntpIncomingServer)</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsINntpIncomingServer)</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIUrlListener)</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsISubscribableServer)</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsITreeView)</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsINntpIncomingServer)</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIUrlListener)</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsISubscribableServer)</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsITreeView)</span>
<a href="#l19.84"></a><span id="l19.84"> NS_INTERFACE_MAP_END_INHERITING(nsMsgIncomingServer)</span>
<a href="#l19.85"></a><span id="l19.85"> </span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-nsNntpIncomingServer::nsNntpIncomingServer()</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-{</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+nsNntpIncomingServer::nsNntpIncomingServer() {</span>
<a href="#l19.89"></a><span id="l19.89">   mNewsrcHasChanged = false;</span>
<a href="#l19.90"></a><span id="l19.90"> </span>
<a href="#l19.91"></a><span id="l19.91">   mGetOnlyNew = true;</span>
<a href="#l19.92"></a><span id="l19.92"> </span>
<a href="#l19.93"></a><span id="l19.93">   mHostInfoLoaded = false;</span>
<a href="#l19.94"></a><span id="l19.94">   mHostInfoHasChanged = false;</span>
<a href="#l19.95"></a><span id="l19.95">   mVersion = INVALID_VERSION;</span>
<a href="#l19.96"></a><span id="l19.96"> </span>
<a href="#l19.97"></a><span id="l19.97" class="difflineat">@@ -107,61 +103,55 @@ nsNntpIncomingServer::nsNntpIncomingServ</span>
<a href="#l19.98"></a><span id="l19.98">   mLastUpdatedTime = 0;</span>
<a href="#l19.99"></a><span id="l19.99"> </span>
<a href="#l19.100"></a><span id="l19.100">   // we have server wide and per group filters</span>
<a href="#l19.101"></a><span id="l19.101">   m_canHaveFilters = true;</span>
<a href="#l19.102"></a><span id="l19.102"> </span>
<a href="#l19.103"></a><span id="l19.103">   SetupNewsrcSaveTimer();</span>
<a href="#l19.104"></a><span id="l19.104"> }</span>
<a href="#l19.105"></a><span id="l19.105"> </span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-nsNntpIncomingServer::~nsNntpIncomingServer()</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-{</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv;</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+nsNntpIncomingServer::~nsNntpIncomingServer() {</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv;</span>
<a href="#l19.111"></a><span id="l19.111"> </span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-    if (mNewsrcSaveTimer) {</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-        mNewsrcSaveTimer-&gt;Cancel();</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-        mNewsrcSaveTimer = nullptr;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-    }</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-    rv = ClearInner();</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;ClearInner failed&quot;);</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+  if (mNewsrcSaveTimer) {</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+    mNewsrcSaveTimer-&gt;Cancel();</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+    mNewsrcSaveTimer = nullptr;</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+  }</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+  rv = ClearInner();</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;ClearInner failed&quot;);</span>
<a href="#l19.124"></a><span id="l19.124"> </span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-    rv = CloseCachedConnections();</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CloseCachedConnections failed&quot;);</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+  rv = CloseCachedConnections();</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CloseCachedConnections failed&quot;);</span>
<a href="#l19.129"></a><span id="l19.129"> }</span>
<a href="#l19.130"></a><span id="l19.130"> </span>
<a href="#l19.131"></a><span id="l19.131"> NS_IMPL_SERVERPREF_BOOL(nsNntpIncomingServer, NotifyOn, &quot;notify.on&quot;)</span>
<a href="#l19.132"></a><span id="l19.132"> NS_IMPL_SERVERPREF_BOOL(nsNntpIncomingServer, MarkOldRead, &quot;mark_old_read&quot;)</span>
<a href="#l19.133"></a><span id="l19.133"> NS_IMPL_SERVERPREF_BOOL(nsNntpIncomingServer, Abbreviate, &quot;abbreviate&quot;)</span>
<a href="#l19.134"></a><span id="l19.134"> NS_IMPL_SERVERPREF_BOOL(nsNntpIncomingServer, PushAuth, &quot;always_authenticate&quot;)</span>
<a href="#l19.135"></a><span id="l19.135"> NS_IMPL_SERVERPREF_BOOL(nsNntpIncomingServer, SingleSignon, &quot;singleSignon&quot;)</span>
<a href="#l19.136"></a><span id="l19.136"> NS_IMPL_SERVERPREF_INT(nsNntpIncomingServer, MaxArticles, &quot;max_articles&quot;)</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-nsresult</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-nsNntpIncomingServer::CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-                                              nsIMsgFolder **rootFolder)</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-{</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+nsresult nsNntpIncomingServer::CreateRootFolderFromUri(</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+    const nsCString &amp;serverUri, nsIMsgFolder **rootFolder) {</span>
<a href="#l19.144"></a><span id="l19.144">   nsMsgNewsFolder *newRootFolder = new nsMsgNewsFolder;</span>
<a href="#l19.145"></a><span id="l19.145">   NS_ADDREF(*rootFolder = newRootFolder);</span>
<a href="#l19.146"></a><span id="l19.146">   newRootFolder-&gt;Init(serverUri.get());</span>
<a href="#l19.147"></a><span id="l19.147">   return NS_OK;</span>
<a href="#l19.148"></a><span id="l19.148"> }</span>
<a href="#l19.149"></a><span id="l19.149"> </span>
<a href="#l19.150"></a><span id="l19.150"> NS_IMETHODIMP</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-nsNntpIncomingServer::GetNewsrcFilePath(nsIFile **aNewsrcFilePath)</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-{</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+nsNntpIncomingServer::GetNewsrcFilePath(nsIFile **aNewsrcFilePath) {</span>
<a href="#l19.154"></a><span id="l19.154">   nsresult rv;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-  if (mNewsrcFilePath)</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-  {</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+  if (mNewsrcFilePath) {</span>
<a href="#l19.158"></a><span id="l19.158">     NS_IF_ADDREF(*aNewsrcFilePath = mNewsrcFilePath);</span>
<a href="#l19.159"></a><span id="l19.159">     return NS_OK;</span>
<a href="#l19.160"></a><span id="l19.160">   }</span>
<a href="#l19.161"></a><span id="l19.161"> </span>
<a href="#l19.162"></a><span id="l19.162">   rv = GetFileValue(&quot;newsrc.file-rel&quot;, &quot;newsrc.file&quot;, aNewsrcFilePath);</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; *aNewsrcFilePath)</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-  {</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; *aNewsrcFilePath) {</span>
<a href="#l19.166"></a><span id="l19.166">     mNewsrcFilePath = *aNewsrcFilePath;</span>
<a href="#l19.167"></a><span id="l19.167">     return rv;</span>
<a href="#l19.168"></a><span id="l19.168">   }</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170">   rv = GetNewsrcRootPath(getter_AddRefs(mNewsrcFilePath));</span>
<a href="#l19.171"></a><span id="l19.171">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.172"></a><span id="l19.172"> </span>
<a href="#l19.173"></a><span id="l19.173">   nsCString hostname;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineat">@@ -178,644 +168,588 @@ nsNntpIncomingServer::GetNewsrcFilePath(</span>
<a href="#l19.175"></a><span id="l19.175">   rv = SetNewsrcFilePath(mNewsrcFilePath);</span>
<a href="#l19.176"></a><span id="l19.176">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.177"></a><span id="l19.177"> </span>
<a href="#l19.178"></a><span id="l19.178">   NS_ADDREF(*aNewsrcFilePath = mNewsrcFilePath);</span>
<a href="#l19.179"></a><span id="l19.179">   return NS_OK;</span>
<a href="#l19.180"></a><span id="l19.180"> }</span>
<a href="#l19.181"></a><span id="l19.181"> </span>
<a href="#l19.182"></a><span id="l19.182"> NS_IMETHODIMP</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-nsNntpIncomingServer::SetNewsrcFilePath(nsIFile *aFile)</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-{</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+nsNntpIncomingServer::SetNewsrcFilePath(nsIFile *aFile) {</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l19.188"></a><span id="l19.188"> </span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-    bool exists;</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-    nsresult rv = aFile-&gt;Exists(&amp;exists);</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-    if (!exists)</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-    {</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-      rv = aFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0664);</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-    }</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-    return SetFileValue(&quot;newsrc.file-rel&quot;, &quot;newsrc.file&quot;, aFile);</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+  bool exists;</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+  nsresult rv = aFile-&gt;Exists(&amp;exists);</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+  if (!exists) {</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+    rv = aFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0664);</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+  }</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+  return SetFileValue(&quot;newsrc.file-rel&quot;, &quot;newsrc.file&quot;, aFile);</span>
<a href="#l19.204"></a><span id="l19.204"> }</span>
<a href="#l19.205"></a><span id="l19.205"> </span>
<a href="#l19.206"></a><span id="l19.206"> NS_IMETHODIMP</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-nsNntpIncomingServer::GetLocalStoreType(nsACString&amp; type)</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-{</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+nsNntpIncomingServer::GetLocalStoreType(nsACString &amp;type) {</span>
<a href="#l19.210"></a><span id="l19.210">   type.AssignLiteral(&quot;news&quot;);</span>
<a href="#l19.211"></a><span id="l19.211">   return NS_OK;</span>
<a href="#l19.212"></a><span id="l19.212"> }</span>
<a href="#l19.213"></a><span id="l19.213"> </span>
<a href="#l19.214"></a><span id="l19.214"> NS_IMETHODIMP</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-nsNntpIncomingServer::GetLocalDatabaseType(nsACString&amp; type)</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-{</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+nsNntpIncomingServer::GetLocalDatabaseType(nsACString &amp;type) {</span>
<a href="#l19.218"></a><span id="l19.218">   type.AssignLiteral(&quot;news&quot;);</span>
<a href="#l19.219"></a><span id="l19.219">   return NS_OK;</span>
<a href="#l19.220"></a><span id="l19.220"> }</span>
<a href="#l19.221"></a><span id="l19.221"> </span>
<a href="#l19.222"></a><span id="l19.222"> NS_IMETHODIMP</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineminus">-nsNntpIncomingServer::SetNewsrcRootPath(nsIFile *aNewsrcRootPath)</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineminus">-{</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineminus">-    NS_ENSURE_ARG(aNewsrcRootPath);</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-    return NS_SetPersistentFile(PREF_MAIL_NEWSRC_ROOT_REL, PREF_MAIL_NEWSRC_ROOT, aNewsrcRootPath);</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+nsNntpIncomingServer::SetNewsrcRootPath(nsIFile *aNewsrcRootPath) {</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+  NS_ENSURE_ARG(aNewsrcRootPath);</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+  return NS_SetPersistentFile(PREF_MAIL_NEWSRC_ROOT_REL, PREF_MAIL_NEWSRC_ROOT,</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+                              aNewsrcRootPath);</span>
<a href="#l19.231"></a><span id="l19.231"> }</span>
<a href="#l19.232"></a><span id="l19.232"> </span>
<a href="#l19.233"></a><span id="l19.233"> NS_IMETHODIMP</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-nsNntpIncomingServer::GetNewsrcRootPath(nsIFile **aNewsrcRootPath)</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineminus">-{</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNewsrcRootPath);</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-    *aNewsrcRootPath = nullptr;</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+nsNntpIncomingServer::GetNewsrcRootPath(nsIFile **aNewsrcRootPath) {</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewsrcRootPath);</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineplus">+  *aNewsrcRootPath = nullptr;</span>
<a href="#l19.241"></a><span id="l19.241"> </span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-    bool havePref;</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-    nsresult rv = NS_GetPersistentFile(PREF_MAIL_NEWSRC_ROOT_REL,</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-                              PREF_MAIL_NEWSRC_ROOT,</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-                              NS_APP_NEWS_50_DIR,</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-                              havePref,</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-                              aNewsrcRootPath);</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+  bool havePref;</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineplus">+  nsresult rv =</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineplus">+      NS_GetPersistentFile(PREF_MAIL_NEWSRC_ROOT_REL, PREF_MAIL_NEWSRC_ROOT,</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+                           NS_APP_NEWS_50_DIR, havePref, aNewsrcRootPath);</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.254"></a><span id="l19.254"> </span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+  bool exists;</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+  rv = (*aNewsrcRootPath)-&gt;Exists(&amp;exists);</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+    rv = (*aNewsrcRootPath)-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.261"></a><span id="l19.261"> </span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-    bool exists;</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-    rv = (*aNewsrcRootPath)-&gt;Exists(&amp;exists);</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineminus">-        rv = (*aNewsrcRootPath)-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-    if (!havePref || !exists)</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-    {</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-        rv = NS_SetPersistentFile(PREF_MAIL_NEWSRC_ROOT_REL, PREF_MAIL_NEWSRC_ROOT, *aNewsrcRootPath);</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-    }</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-    return rv;</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+  if (!havePref || !exists) {</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+    rv = NS_SetPersistentFile(PREF_MAIL_NEWSRC_ROOT_REL, PREF_MAIL_NEWSRC_ROOT,</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineplus">+                              *aNewsrcRootPath);</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+  }</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineplus">+  return rv;</span>
<a href="#l19.280"></a><span id="l19.280"> }</span>
<a href="#l19.281"></a><span id="l19.281"> </span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-/* static */ void nsNntpIncomingServer::OnNewsrcSaveTimer(nsITimer *timer, void *voidIncomingServer)</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-{</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-  nsNntpIncomingServer *incomingServer = (nsNntpIncomingServer*)voidIncomingServer;</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+/* static */ void nsNntpIncomingServer::OnNewsrcSaveTimer(</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+    nsITimer *timer, void *voidIncomingServer) {</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineplus">+  nsNntpIncomingServer *incomingServer =</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineplus">+      (nsNntpIncomingServer *)voidIncomingServer;</span>
<a href="#l19.289"></a><span id="l19.289">   incomingServer-&gt;WriteNewsrcFile();</span>
<a href="#l19.290"></a><span id="l19.290"> }</span>
<a href="#l19.291"></a><span id="l19.291"> </span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-nsresult nsNntpIncomingServer::SetupNewsrcSaveTimer()</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-{</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-  int64_t ms(300000);   // hard code, 5 minutes.</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-  //Convert biffDelay into milliseconds</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineplus">+nsresult nsNntpIncomingServer::SetupNewsrcSaveTimer() {</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineplus">+  int64_t ms(300000);  // hard code, 5 minutes.</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+  // Convert biffDelay into milliseconds</span>
<a href="#l19.299"></a><span id="l19.299">   uint32_t timeInMSUint32 = (uint32_t)ms;</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-  //Can't currently reset a timer when it's in the process of</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-  //calling Notify. So, just release the timer here and create a new one.</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-  if(mNewsrcSaveTimer)</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-    mNewsrcSaveTimer-&gt;Cancel();</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+  // Can't currently reset a timer when it's in the process of</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineplus">+  // calling Notify. So, just release the timer here and create a new one.</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineplus">+  if (mNewsrcSaveTimer) mNewsrcSaveTimer-&gt;Cancel();</span>
<a href="#l19.307"></a><span id="l19.307">   mNewsrcSaveTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-  mNewsrcSaveTimer-&gt;InitWithNamedFuncCallback(OnNewsrcSaveTimer, (void*)this,</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-                                              timeInMSUint32,</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-                                              nsITimer::TYPE_REPEATING_SLACK,</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-                                              &quot;nsNntpIncomingServer::OnNewsrcSaveTimer&quot;);</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+  mNewsrcSaveTimer-&gt;InitWithNamedFuncCallback(</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineplus">+      OnNewsrcSaveTimer, (void *)this, timeInMSUint32,</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineplus">+      nsITimer::TYPE_REPEATING_SLACK,</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineplus">+      &quot;nsNntpIncomingServer::OnNewsrcSaveTimer&quot;);</span>
<a href="#l19.316"></a><span id="l19.316">   return NS_OK;</span>
<a href="#l19.317"></a><span id="l19.317"> }</span>
<a href="#l19.318"></a><span id="l19.318"> </span>
<a href="#l19.319"></a><span id="l19.319"> NS_IMETHODIMP</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineminus">-nsNntpIncomingServer::SetCharset(const nsACString &amp; aCharset)</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-{</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineplus">+nsNntpIncomingServer::SetCharset(const nsACString &amp;aCharset) {</span>
<a href="#l19.323"></a><span id="l19.323">   return SetCharValue(&quot;charset&quot;, aCharset);</span>
<a href="#l19.324"></a><span id="l19.324"> }</span>
<a href="#l19.325"></a><span id="l19.325"> </span>
<a href="#l19.326"></a><span id="l19.326"> NS_IMETHODIMP</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-nsNntpIncomingServer::GetCharset(nsACString &amp; aCharset)</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-{</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-  //first we get the per-server settings mail.server.&lt;serverkey&gt;.charset</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+nsNntpIncomingServer::GetCharset(nsACString &amp;aCharset) {</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+  // first we get the per-server settings mail.server.&lt;serverkey&gt;.charset</span>
<a href="#l19.332"></a><span id="l19.332">   nsresult rv = GetCharValue(&quot;charset&quot;, aCharset);</span>
<a href="#l19.333"></a><span id="l19.333">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.334"></a><span id="l19.334"> </span>
<a href="#l19.335"></a><span id="l19.335" class="difflineminus">-  //if the per-server setting is empty,we get the default charset from</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-  //mailnews.view_default_charset setting and set it as per-server preference.</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+  // if the per-server setting is empty,we get the default charset from</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+  // mailnews.view_default_charset setting and set it as per-server preference.</span>
<a href="#l19.339"></a><span id="l19.339">   if (aCharset.IsEmpty()) {</span>
<a href="#l19.340"></a><span id="l19.340">     nsString defaultCharset;</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineminus">-    rv = NS_GetLocalizedUnicharPreferenceWithDefault(nullptr,</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineminus">-         PREF_MAILNEWS_VIEW_DEFAULT_CHARSET,</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineminus">-         NS_LITERAL_STRING(&quot;ISO-8859-1&quot;), defaultCharset);</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineplus">+    rv = NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineplus">+        nullptr, PREF_MAILNEWS_VIEW_DEFAULT_CHARSET,</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+        NS_LITERAL_STRING(&quot;ISO-8859-1&quot;), defaultCharset);</span>
<a href="#l19.347"></a><span id="l19.347">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.348"></a><span id="l19.348">     LossyCopyUTF16toASCII(defaultCharset, aCharset);</span>
<a href="#l19.349"></a><span id="l19.349">     SetCharset(aCharset);</span>
<a href="#l19.350"></a><span id="l19.350">   }</span>
<a href="#l19.351"></a><span id="l19.351">   return NS_OK;</span>
<a href="#l19.352"></a><span id="l19.352"> }</span>
<a href="#l19.353"></a><span id="l19.353"> </span>
<a href="#l19.354"></a><span id="l19.354"> NS_IMETHODIMP</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineminus">-nsNntpIncomingServer::WriteNewsrcFile()</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-{</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineminus">-    nsresult rv;</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineplus">+nsNntpIncomingServer::WriteNewsrcFile() {</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineplus">+  nsresult rv;</span>
<a href="#l19.360"></a><span id="l19.360"> </span>
<a href="#l19.361"></a><span id="l19.361" class="difflineminus">-    bool newsrcHasChanged;</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineminus">-    rv = GetNewsrcHasChanged(&amp;newsrcHasChanged);</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineplus">+  bool newsrcHasChanged;</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineplus">+  rv = GetNewsrcHasChanged(&amp;newsrcHasChanged);</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.367"></a><span id="l19.367"> </span>
<a href="#l19.368"></a><span id="l19.368"> #ifdef DEBUG_NEWS</span>
<a href="#l19.369"></a><span id="l19.369">   nsCString hostname;</span>
<a href="#l19.370"></a><span id="l19.370">   rv = GetHostName(hostname);</span>
<a href="#l19.371"></a><span id="l19.371">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.372"></a><span id="l19.372"> #endif /* DEBUG_NEWS */</span>
<a href="#l19.373"></a><span id="l19.373"> </span>
<a href="#l19.374"></a><span id="l19.374" class="difflineminus">-    if (newsrcHasChanged) {</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+  if (newsrcHasChanged) {</span>
<a href="#l19.376"></a><span id="l19.376"> #ifdef DEBUG_NEWS</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineminus">-        printf(&quot;write newsrc file for %s\n&quot;, hostname.get());</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineplus">+    printf(&quot;write newsrc file for %s\n&quot;, hostname.get());</span>
<a href="#l19.379"></a><span id="l19.379"> #endif</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; newsrcFile;</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineminus">-        rv = GetNewsrcFilePath(getter_AddRefs(newsrcFile));</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; newsrcFile;</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+    rv = GetNewsrcFilePath(getter_AddRefs(newsrcFile));</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.386"></a><span id="l19.386"> </span>
<a href="#l19.387"></a><span id="l19.387" class="difflineminus">-        nsCOMPtr&lt;nsIOutputStream&gt; newsrcStream;</span>
<a href="#l19.388"></a><span id="l19.388" class="difflineminus">-        nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(newsrcStream), newsrcFile, -1, 00600);</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-          return rv;</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineplus">+    nsCOMPtr&lt;nsIOutputStream&gt; newsrcStream;</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+    nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(newsrcStream),</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+                                                 newsrcFile, -1, 00600);</span>
<a href="#l19.394"></a><span id="l19.394" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineplus">+</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; subFolders;</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineplus">+    rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.400"></a><span id="l19.400"> </span>
<a href="#l19.401"></a><span id="l19.401" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt; subFolders;</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-        rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-        nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+    nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.410"></a><span id="l19.410"> </span>
<a href="#l19.411"></a><span id="l19.411" class="difflineminus">-        uint32_t bytesWritten;</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineminus">-        nsCString optionLines;</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineminus">-        rv = newsFolder-&gt;GetOptionLines(optionLines);</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; !optionLines.IsEmpty()) {</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-          newsrcStream-&gt;Write(optionLines.get(), optionLines.Length(), &amp;bytesWritten);</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineplus">+    uint32_t bytesWritten;</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineplus">+    nsCString optionLines;</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineplus">+    rv = newsFolder-&gt;GetOptionLines(optionLines);</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !optionLines.IsEmpty()) {</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineplus">+      newsrcStream-&gt;Write(optionLines.get(), optionLines.Length(),</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineplus">+                          &amp;bytesWritten);</span>
<a href="#l19.422"></a><span id="l19.422"> #ifdef DEBUG_NEWS</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineminus">-               printf(&quot;option lines:\n%s&quot;, optionLines.get());</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineplus">+      printf(&quot;option lines:\n%s&quot;, optionLines.get());</span>
<a href="#l19.425"></a><span id="l19.425"> #endif /* DEBUG_NEWS */</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineminus">-        }</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineplus">+    }</span>
<a href="#l19.428"></a><span id="l19.428"> #ifdef DEBUG_NEWS</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineminus">-        else {</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-            printf(&quot;no option lines to write out\n&quot;);</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-        }</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineplus">+    else {</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineplus">+      printf(&quot;no option lines to write out\n&quot;);</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineplus">+    }</span>
<a href="#l19.435"></a><span id="l19.435"> #endif /* DEBUG_NEWS */</span>
<a href="#l19.436"></a><span id="l19.436"> </span>
<a href="#l19.437"></a><span id="l19.437" class="difflineminus">-        nsCString unsubscribedLines;</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineminus">-        rv = newsFolder-&gt;GetUnsubscribedNewsgroupLines(unsubscribedLines);</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; !unsubscribedLines.IsEmpty()) {</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineminus">-          newsrcStream-&gt;Write(unsubscribedLines.get(), unsubscribedLines.Length(), &amp;bytesWritten);</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineplus">+    nsCString unsubscribedLines;</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineplus">+    rv = newsFolder-&gt;GetUnsubscribedNewsgroupLines(unsubscribedLines);</span>
<a href="#l19.443"></a><span id="l19.443" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !unsubscribedLines.IsEmpty()) {</span>
<a href="#l19.444"></a><span id="l19.444" class="difflineplus">+      newsrcStream-&gt;Write(unsubscribedLines.get(), unsubscribedLines.Length(),</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineplus">+                          &amp;bytesWritten);</span>
<a href="#l19.446"></a><span id="l19.446"> #ifdef DEBUG_NEWS</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineminus">-               printf(&quot;unsubscribedLines:\n%s&quot;, unsubscribedLines.get());</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineminus">-#endif /* DEBUG_NEWS */</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineminus">-        }</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineminus">-#ifdef DEBUG_NEWS</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineminus">-        else {</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineminus">-            printf(&quot;no unsubscribed lines to write out\n&quot;);</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineminus">-        }</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineplus">+      printf(&quot;unsubscribedLines:\n%s&quot;, unsubscribedLines.get());</span>
<a href="#l19.455"></a><span id="l19.455"> #endif /* DEBUG_NEWS */</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineminus">-</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineminus">-        rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(subFolders));</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineminus">-</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineminus">-        bool moreFolders;</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineminus">-</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineminus">-        while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;moreFolders)) &amp;&amp;</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineminus">-               moreFolders) {</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; child;</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineminus">-            rv = subFolders-&gt;GetNext(getter_AddRefs(child));</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineminus">-                newsFolder = do_QueryInterface(child, &amp;rv);</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineminus">-                if (NS_SUCCEEDED(rv) &amp;&amp; newsFolder) {</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineminus">-                    nsCString newsrcLine;</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineminus">-                    rv = newsFolder-&gt;GetNewsrcLine(newsrcLine);</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineminus">-                    if (NS_SUCCEEDED(rv) &amp;&amp; !newsrcLine.IsEmpty()) {</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineminus">-                        // write the line to the newsrc file</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineminus">-                        newsrcStream-&gt;Write(newsrcLine.get(), newsrcLine.Length(), &amp;bytesWritten);</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineminus">-                    }</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineminus">-                }</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineminus">-            }</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineminus">-        }</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineminus">-</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineminus">-        newsrcStream-&gt;Close();</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineminus">-</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineminus">-        rv = SetNewsrcHasChanged(false);</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.483"></a><span id="l19.483">     }</span>
<a href="#l19.484"></a><span id="l19.484"> #ifdef DEBUG_NEWS</span>
<a href="#l19.485"></a><span id="l19.485">     else {</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineminus">-        printf(&quot;no need to write newsrc file for %s, it was not dirty\n&quot;, (hostname.get()));</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineplus">+      printf(&quot;no unsubscribed lines to write out\n&quot;);</span>
<a href="#l19.488"></a><span id="l19.488">     }</span>
<a href="#l19.489"></a><span id="l19.489"> #endif /* DEBUG_NEWS */</span>
<a href="#l19.490"></a><span id="l19.490"> </span>
<a href="#l19.491"></a><span id="l19.491" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineplus">+    rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(subFolders));</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineplus">+    bool moreFolders;</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineplus">+</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineplus">+    while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;moreFolders)) &amp;&amp;</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineplus">+           moreFolders) {</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; child;</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineplus">+      rv = subFolders-&gt;GetNext(getter_AddRefs(child));</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineplus">+        newsFolder = do_QueryInterface(child, &amp;rv);</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; newsFolder) {</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineplus">+          nsCString newsrcLine;</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineplus">+          rv = newsFolder-&gt;GetNewsrcLine(newsrcLine);</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; !newsrcLine.IsEmpty()) {</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineplus">+            // write the line to the newsrc file</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineplus">+            newsrcStream-&gt;Write(newsrcLine.get(), newsrcLine.Length(),</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineplus">+                                &amp;bytesWritten);</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineplus">+          }</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineplus">+        }</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineplus">+      }</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+    }</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineplus">+</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+    newsrcStream-&gt;Close();</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineplus">+</span>
<a href="#l19.517"></a><span id="l19.517" class="difflineplus">+    rv = SetNewsrcHasChanged(false);</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineplus">+  }</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineplus">+#ifdef DEBUG_NEWS</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineplus">+  else {</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineplus">+    printf(&quot;no need to write newsrc file for %s, it was not dirty\n&quot;,</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineplus">+           (hostname.get()));</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineplus">+  }</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineplus">+#endif /* DEBUG_NEWS */</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineplus">+</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.528"></a><span id="l19.528"> }</span>
<a href="#l19.529"></a><span id="l19.529"> </span>
<a href="#l19.530"></a><span id="l19.530"> NS_IMETHODIMP</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineminus">-nsNntpIncomingServer::SetNewsrcHasChanged(bool aNewsrcHasChanged)</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineminus">-{</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineminus">-    mNewsrcHasChanged = aNewsrcHasChanged;</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineplus">+nsNntpIncomingServer::SetNewsrcHasChanged(bool aNewsrcHasChanged) {</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineplus">+  mNewsrcHasChanged = aNewsrcHasChanged;</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.538"></a><span id="l19.538"> }</span>
<a href="#l19.539"></a><span id="l19.539"> </span>
<a href="#l19.540"></a><span id="l19.540"> NS_IMETHODIMP</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineminus">-nsNntpIncomingServer::GetNewsrcHasChanged(bool *aNewsrcHasChanged)</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineminus">-{</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineminus">-    if (!aNewsrcHasChanged) return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineplus">+nsNntpIncomingServer::GetNewsrcHasChanged(bool *aNewsrcHasChanged) {</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineplus">+  if (!aNewsrcHasChanged) return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.546"></a><span id="l19.546"> </span>
<a href="#l19.547"></a><span id="l19.547" class="difflineminus">-    *aNewsrcHasChanged = mNewsrcHasChanged;</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+  *aNewsrcHasChanged = mNewsrcHasChanged;</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.551"></a><span id="l19.551"> }</span>
<a href="#l19.552"></a><span id="l19.552"> </span>
<a href="#l19.553"></a><span id="l19.553"> NS_IMETHODIMP</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineminus">-nsNntpIncomingServer::CloseCachedConnections()</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineminus">-{</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineplus">+nsNntpIncomingServer::CloseCachedConnections() {</span>
<a href="#l19.557"></a><span id="l19.557">   nsresult rv;</span>
<a href="#l19.558"></a><span id="l19.558">   nsCOMPtr&lt;nsINNTPProtocol&gt; connection;</span>
<a href="#l19.559"></a><span id="l19.559"> </span>
<a href="#l19.560"></a><span id="l19.560">   // iterate through the connection cache and close the connections.</span>
<a href="#l19.561"></a><span id="l19.561">   int32_t cnt = mConnectionCache.Count();</span>
<a href="#l19.562"></a><span id="l19.562"> </span>
<a href="#l19.563"></a><span id="l19.563" class="difflineminus">-  for (int32_t i = 0; i &lt; cnt; ++i)</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineminus">-  {</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineplus">+  for (int32_t i = 0; i &lt; cnt; ++i) {</span>
<a href="#l19.566"></a><span id="l19.566">     connection = mConnectionCache[0];</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineminus">-    if (connection)</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineminus">-    {</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineplus">+    if (connection) {</span>
<a href="#l19.570"></a><span id="l19.570">       rv = connection-&gt;CloseConnection();</span>
<a href="#l19.571"></a><span id="l19.571">       // We need to do this instead of RemoveObjectAt(0) because the</span>
<a href="#l19.572"></a><span id="l19.572">       // above call will likely cause the object to be removed from the</span>
<a href="#l19.573"></a><span id="l19.573">       // array anyway</span>
<a href="#l19.574"></a><span id="l19.574">       mConnectionCache.RemoveObject(connection);</span>
<a href="#l19.575"></a><span id="l19.575">     }</span>
<a href="#l19.576"></a><span id="l19.576">   }</span>
<a href="#l19.577"></a><span id="l19.577"> </span>
<a href="#l19.578"></a><span id="l19.578">   rv = WriteNewsrcFile();</span>
<a href="#l19.579"></a><span id="l19.579">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.580"></a><span id="l19.580"> </span>
<a href="#l19.581"></a><span id="l19.581" class="difflineminus">-  if (!mGetOnlyNew &amp;&amp; !mHostInfoLoaded)</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineminus">-  {</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineplus">+  if (!mGetOnlyNew &amp;&amp; !mHostInfoLoaded) {</span>
<a href="#l19.584"></a><span id="l19.584">     rv = WriteHostInfoFile();</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.587"></a><span id="l19.587">   }</span>
<a href="#l19.588"></a><span id="l19.588"> </span>
<a href="#l19.589"></a><span id="l19.589">   return NS_OK;</span>
<a href="#l19.590"></a><span id="l19.590"> }</span>
<a href="#l19.591"></a><span id="l19.591"> </span>
<a href="#l19.592"></a><span id="l19.592"> NS_IMETHODIMP</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineminus">-nsNntpIncomingServer::GetMaximumConnectionsNumber(int32_t *aMaxConnections)</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineminus">-{</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineplus">+nsNntpIncomingServer::GetMaximumConnectionsNumber(int32_t *aMaxConnections) {</span>
<a href="#l19.596"></a><span id="l19.596">   NS_ENSURE_ARG_POINTER(aMaxConnections);</span>
<a href="#l19.597"></a><span id="l19.597"> </span>
<a href="#l19.598"></a><span id="l19.598">   nsresult rv = GetIntValue(&quot;max_cached_connections&quot;, aMaxConnections);</span>
<a href="#l19.599"></a><span id="l19.599">   // Get our maximum connection count. We need at least 1. If the value is 0,</span>
<a href="#l19.600"></a><span id="l19.600">   // we use the default. If it's negative, we treat that as 1.</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; *aMaxConnections &gt; 0)</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; *aMaxConnections &gt; 0) return NS_OK;</span>
<a href="#l19.604"></a><span id="l19.604"> </span>
<a href="#l19.605"></a><span id="l19.605">   *aMaxConnections = (NS_FAILED(rv) || (*aMaxConnections == 0)) ? 2 : 1;</span>
<a href="#l19.606"></a><span id="l19.606">   (void)SetMaximumConnectionsNumber(*aMaxConnections);</span>
<a href="#l19.607"></a><span id="l19.607"> </span>
<a href="#l19.608"></a><span id="l19.608">   return NS_OK;</span>
<a href="#l19.609"></a><span id="l19.609"> }</span>
<a href="#l19.610"></a><span id="l19.610"> </span>
<a href="#l19.611"></a><span id="l19.611"> NS_IMETHODIMP</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineminus">-nsNntpIncomingServer::SetMaximumConnectionsNumber(int32_t aMaxConnections)</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineminus">-{</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+nsNntpIncomingServer::SetMaximumConnectionsNumber(int32_t aMaxConnections) {</span>
<a href="#l19.615"></a><span id="l19.615">   return SetIntValue(&quot;max_cached_connections&quot;, aMaxConnections);</span>
<a href="#l19.616"></a><span id="l19.616"> }</span>
<a href="#l19.617"></a><span id="l19.617"> </span>
<a href="#l19.618"></a><span id="l19.618" class="difflineminus">-bool</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineminus">-nsNntpIncomingServer::ConnectionTimeOut(nsINNTPProtocol* aConnection)</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineminus">-{</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineminus">-    bool retVal = false;</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineminus">-    if (!aConnection)</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineminus">-      return retVal;</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineplus">+bool nsNntpIncomingServer::ConnectionTimeOut(nsINNTPProtocol *aConnection) {</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineplus">+  bool retVal = false;</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineplus">+  if (!aConnection) return retVal;</span>
<a href="#l19.627"></a><span id="l19.627"> </span>
<a href="#l19.628"></a><span id="l19.628" class="difflineminus">-    PRTime lastActiveTimeStamp;</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-    if (NS_FAILED(aConnection-&gt;GetLastActiveTimeStamp(&amp;lastActiveTimeStamp)))</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineminus">-      return retVal;</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineplus">+  PRTime lastActiveTimeStamp;</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineplus">+  if (NS_FAILED(aConnection-&gt;GetLastActiveTimeStamp(&amp;lastActiveTimeStamp)))</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+    return retVal;</span>
<a href="#l19.634"></a><span id="l19.634"> </span>
<a href="#l19.635"></a><span id="l19.635" class="difflineminus">-    if (PR_Now() - lastActiveTimeStamp &gt;= PRTime(170) * PR_USEC_PER_SEC)</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineminus">-    {</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+  if (PR_Now() - lastActiveTimeStamp &gt;= PRTime(170) * PR_USEC_PER_SEC) {</span>
<a href="#l19.638"></a><span id="l19.638"> #ifdef DEBUG_seth</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineminus">-      printf(&quot;XXX connection timed out, close it, and remove it from the connection cache\n&quot;);</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineplus">+    printf(</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineplus">+        &quot;XXX connection timed out, close it, and remove it from the connection &quot;</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineplus">+        &quot;cache\n&quot;);</span>
<a href="#l19.643"></a><span id="l19.643"> #endif</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineminus">-      aConnection-&gt;CloseConnection();</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineminus">-      mConnectionCache.RemoveObject(aConnection);</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineminus">-      retVal = true;</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineminus">-    }</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineminus">-    return retVal;</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineplus">+    aConnection-&gt;CloseConnection();</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineplus">+    mConnectionCache.RemoveObject(aConnection);</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+    retVal = true;</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+  }</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+  return retVal;</span>
<a href="#l19.654"></a><span id="l19.654"> }</span>
<a href="#l19.655"></a><span id="l19.655"> </span>
<a href="#l19.656"></a><span id="l19.656" class="difflineminus">-</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineminus">-nsresult</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineminus">-nsNntpIncomingServer::CreateProtocolInstance(nsINNTPProtocol ** aNntpConnection, nsIURI *url,</span>
<a href="#l19.659"></a><span id="l19.659" class="difflineminus">-                                             nsIMsgWindow *aMsgWindow)</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineminus">-{</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineplus">+nsresult nsNntpIncomingServer::CreateProtocolInstance(</span>
<a href="#l19.662"></a><span id="l19.662" class="difflineplus">+    nsINNTPProtocol **aNntpConnection, nsIURI *url, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l19.663"></a><span id="l19.663">   // create a new connection and add it to the connection cache</span>
<a href="#l19.664"></a><span id="l19.664">   // we may need to flag the protocol connection as busy so we don't get</span>
<a href="#l19.665"></a><span id="l19.665">   // a race</span>
<a href="#l19.666"></a><span id="l19.666">   // condition where someone else goes through this code</span>
<a href="#l19.667"></a><span id="l19.667">   nsNNTPProtocol *protocolInstance = new nsNNTPProtocol(this, url, aMsgWindow);</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineminus">-  if (!protocolInstance)</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineplus">+  if (!protocolInstance) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.671"></a><span id="l19.671"> </span>
<a href="#l19.672"></a><span id="l19.672" class="difflineminus">-  nsresult rv = protocolInstance-&gt;QueryInterface(NS_GET_IID(nsINNTPProtocol), (void **) aNntpConnection);</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineplus">+  nsresult rv = protocolInstance-&gt;QueryInterface(NS_GET_IID(nsINNTPProtocol),</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineplus">+                                                 (void **)aNntpConnection);</span>
<a href="#l19.675"></a><span id="l19.675">   // take the protocol instance and add it to the connectionCache</span>
<a href="#l19.676"></a><span id="l19.676">   if (NS_SUCCEEDED(rv) &amp;&amp; *aNntpConnection)</span>
<a href="#l19.677"></a><span id="l19.677">     mConnectionCache.AppendObject(*aNntpConnection);</span>
<a href="#l19.678"></a><span id="l19.678">   return rv;</span>
<a href="#l19.679"></a><span id="l19.679"> }</span>
<a href="#l19.680"></a><span id="l19.680"> </span>
<a href="#l19.681"></a><span id="l19.681" class="difflineminus">-</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineminus">-nsresult</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineminus">-nsNntpIncomingServer::GetNntpConnection(nsIURI * aUri, nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineminus">-                                        nsINNTPProtocol ** aNntpConnection)</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineminus">-{</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+nsresult nsNntpIncomingServer::GetNntpConnection(</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineplus">+    nsIURI *aUri, nsIMsgWindow *aMsgWindow, nsINNTPProtocol **aNntpConnection) {</span>
<a href="#l19.688"></a><span id="l19.688">   int32_t maxConnections;</span>
<a href="#l19.689"></a><span id="l19.689">   (void)GetMaximumConnectionsNumber(&amp;maxConnections);</span>
<a href="#l19.690"></a><span id="l19.690"> </span>
<a href="#l19.691"></a><span id="l19.691">   // Find a non-busy connection</span>
<a href="#l19.692"></a><span id="l19.692">   nsCOMPtr&lt;nsINNTPProtocol&gt; connection;</span>
<a href="#l19.693"></a><span id="l19.693">   int32_t cnt = mConnectionCache.Count();</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineminus">-  for (int32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineminus">-  {</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineplus">+  for (int32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l19.697"></a><span id="l19.697">     connection = mConnectionCache[i];</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineminus">-    if (connection)</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineminus">-    {</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineplus">+    if (connection) {</span>
<a href="#l19.701"></a><span id="l19.701">       bool isBusy;</span>
<a href="#l19.702"></a><span id="l19.702">       connection-&gt;GetIsBusy(&amp;isBusy);</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineminus">-      if (!isBusy)</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineminus">-        break;</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineplus">+      if (!isBusy) break;</span>
<a href="#l19.706"></a><span id="l19.706">       connection = nullptr;</span>
<a href="#l19.707"></a><span id="l19.707">     }</span>
<a href="#l19.708"></a><span id="l19.708">   }</span>
<a href="#l19.709"></a><span id="l19.709"> </span>
<a href="#l19.710"></a><span id="l19.710" class="difflineminus">-  if (ConnectionTimeOut(connection))</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineminus">-  {</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+  if (ConnectionTimeOut(connection)) {</span>
<a href="#l19.713"></a><span id="l19.713">     connection = nullptr;</span>
<a href="#l19.714"></a><span id="l19.714">     // We have one less connection, since we closed this one.</span>
<a href="#l19.715"></a><span id="l19.715">     --cnt;</span>
<a href="#l19.716"></a><span id="l19.716">   }</span>
<a href="#l19.717"></a><span id="l19.717"> </span>
<a href="#l19.718"></a><span id="l19.718" class="difflineminus">-  if (connection)</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineminus">-  {</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineplus">+  if (connection) {</span>
<a href="#l19.721"></a><span id="l19.721">     connection.forget(aNntpConnection);</span>
<a href="#l19.722"></a><span id="l19.722">     (*aNntpConnection)-&gt;SetIsCachedConnection(true);</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineminus">-  }</span>
<a href="#l19.724"></a><span id="l19.724" class="difflineminus">-  else if (cnt &lt; maxConnections)</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineminus">-  {</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineplus">+  } else if (cnt &lt; maxConnections) {</span>
<a href="#l19.727"></a><span id="l19.727">     // We have room for another connection. Create this connection and return</span>
<a href="#l19.728"></a><span id="l19.728">     // it to the caller.</span>
<a href="#l19.729"></a><span id="l19.729">     nsresult rv = CreateProtocolInstance(aNntpConnection, aUri, aMsgWindow);</span>
<a href="#l19.730"></a><span id="l19.730">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineminus">-  }</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineminus">-  else</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineminus">-  {</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineplus">+  } else {</span>
<a href="#l19.735"></a><span id="l19.735">     // We maxed out our connection count. The caller must therefore enqueue the</span>
<a href="#l19.736"></a><span id="l19.736">     // call.</span>
<a href="#l19.737"></a><span id="l19.737">     *aNntpConnection = nullptr;</span>
<a href="#l19.738"></a><span id="l19.738">     return NS_OK;</span>
<a href="#l19.739"></a><span id="l19.739">   }</span>
<a href="#l19.740"></a><span id="l19.740"> </span>
<a href="#l19.741"></a><span id="l19.741">   // Initialize the URI here and now.</span>
<a href="#l19.742"></a><span id="l19.742">   return (*aNntpConnection)-&gt;Initialize(aUri, aMsgWindow);</span>
<a href="#l19.743"></a><span id="l19.743"> }</span>
<a href="#l19.744"></a><span id="l19.744"> </span>
<a href="#l19.745"></a><span id="l19.745"> NS_IMETHODIMP</span>
<a href="#l19.746"></a><span id="l19.746"> nsNntpIncomingServer::GetNntpChannel(nsIURI *aURI, nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineminus">-                                     nsIChannel **aChannel)</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineminus">-{</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineplus">+                                     nsIChannel **aChannel) {</span>
<a href="#l19.750"></a><span id="l19.750">   NS_ENSURE_ARG_POINTER(aChannel);</span>
<a href="#l19.751"></a><span id="l19.751"> </span>
<a href="#l19.752"></a><span id="l19.752">   nsCOMPtr&lt;nsINNTPProtocol&gt; protocol;</span>
<a href="#l19.753"></a><span id="l19.753">   nsresult rv = GetNntpConnection(aURI, aMsgWindow, getter_AddRefs(protocol));</span>
<a href="#l19.754"></a><span id="l19.754">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.755"></a><span id="l19.755"> </span>
<a href="#l19.756"></a><span id="l19.756" class="difflineminus">-  if (protocol)</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineminus">-    return CallQueryInterface(protocol, aChannel);</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineplus">+  if (protocol) return CallQueryInterface(protocol, aChannel);</span>
<a href="#l19.759"></a><span id="l19.759"> </span>
<a href="#l19.760"></a><span id="l19.760">   // No protocol? We need our mock channel.</span>
<a href="#l19.761"></a><span id="l19.761">   nsNntpMockChannel *channel = new nsNntpMockChannel(aURI, aMsgWindow);</span>
<a href="#l19.762"></a><span id="l19.762">   NS_ADDREF(*aChannel = channel);</span>
<a href="#l19.763"></a><span id="l19.763"> </span>
<a href="#l19.764"></a><span id="l19.764">   m_queuedChannels.AppendElement(channel);</span>
<a href="#l19.765"></a><span id="l19.765">   return NS_OK;</span>
<a href="#l19.766"></a><span id="l19.766"> }</span>
<a href="#l19.767"></a><span id="l19.767"> </span>
<a href="#l19.768"></a><span id="l19.768"> NS_IMETHODIMP</span>
<a href="#l19.769"></a><span id="l19.769"> nsNntpIncomingServer::LoadNewsUrl(nsIURI *aURI, nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineminus">-                                  nsISupports *aConsumer)</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineminus">-{</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineplus">+                                  nsISupports *aConsumer) {</span>
<a href="#l19.773"></a><span id="l19.773">   nsCOMPtr&lt;nsINNTPProtocol&gt; protocol;</span>
<a href="#l19.774"></a><span id="l19.774">   nsresult rv = GetNntpConnection(aURI, aMsgWindow, getter_AddRefs(protocol));</span>
<a href="#l19.775"></a><span id="l19.775">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.776"></a><span id="l19.776"> </span>
<a href="#l19.777"></a><span id="l19.777" class="difflineminus">-  if (protocol)</span>
<a href="#l19.778"></a><span id="l19.778" class="difflineminus">-    return protocol-&gt;LoadNewsUrl(aURI, aConsumer);</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineplus">+  if (protocol) return protocol-&gt;LoadNewsUrl(aURI, aConsumer);</span>
<a href="#l19.780"></a><span id="l19.780"> </span>
<a href="#l19.781"></a><span id="l19.781">   // No protocol? We need our mock channel.</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineminus">-  nsNntpMockChannel *channel = new nsNntpMockChannel(aURI, aMsgWindow,</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineminus">-                                                     aConsumer);</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineminus">-  if (!channel)</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineplus">+  nsNntpMockChannel *channel =</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineplus">+      new nsNntpMockChannel(aURI, aMsgWindow, aConsumer);</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineplus">+  if (!channel) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.789"></a><span id="l19.789"> </span>
<a href="#l19.790"></a><span id="l19.790">   m_queuedChannels.AppendElement(channel);</span>
<a href="#l19.791"></a><span id="l19.791">   return NS_OK;</span>
<a href="#l19.792"></a><span id="l19.792"> }</span>
<a href="#l19.793"></a><span id="l19.793"> </span>
<a href="#l19.794"></a><span id="l19.794"> NS_IMETHODIMP</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineminus">-nsNntpIncomingServer::PrepareForNextUrl(nsNNTPProtocol *aConnection)</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineminus">-{</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineplus">+nsNntpIncomingServer::PrepareForNextUrl(nsNNTPProtocol *aConnection) {</span>
<a href="#l19.798"></a><span id="l19.798">   NS_ENSURE_ARG(aConnection);</span>
<a href="#l19.799"></a><span id="l19.799"> </span>
<a href="#l19.800"></a><span id="l19.800">   // Start the connection on the next URL in the queue. If it can't get a URL to</span>
<a href="#l19.801"></a><span id="l19.801">   // work, drop that URL (the channel will handle failure notification) and move</span>
<a href="#l19.802"></a><span id="l19.802">   // on.</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineminus">-  while (m_queuedChannels.Length() &gt; 0)</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineminus">-  {</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineplus">+  while (m_queuedChannels.Length() &gt; 0) {</span>
<a href="#l19.806"></a><span id="l19.806">     RefPtr&lt;nsNntpMockChannel&gt; channel = m_queuedChannels[0];</span>
<a href="#l19.807"></a><span id="l19.807">     m_queuedChannels.RemoveElementAt(0);</span>
<a href="#l19.808"></a><span id="l19.808">     nsresult rv = channel-&gt;AttachNNTPConnection(*aConnection);</span>
<a href="#l19.809"></a><span id="l19.809">     // If this succeeded, the connection is now running the URL.</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineminus">-      return NS_OK;</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return NS_OK;</span>
<a href="#l19.813"></a><span id="l19.813">   }</span>
<a href="#l19.814"></a><span id="l19.814"> </span>
<a href="#l19.815"></a><span id="l19.815">   // No queued uris.</span>
<a href="#l19.816"></a><span id="l19.816">   return NS_OK;</span>
<a href="#l19.817"></a><span id="l19.817"> }</span>
<a href="#l19.818"></a><span id="l19.818"> </span>
<a href="#l19.819"></a><span id="l19.819"> /* void RemoveConnection (in nsINNTPProtocol aNntpConnection); */</span>
<a href="#l19.820"></a><span id="l19.820" class="difflineminus">-NS_IMETHODIMP nsNntpIncomingServer::RemoveConnection(nsINNTPProtocol *aNntpConnection)</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineminus">-{</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineminus">-  if (aNntpConnection)</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineminus">-    mConnectionCache.RemoveObject(aNntpConnection);</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineplus">+NS_IMETHODIMP nsNntpIncomingServer::RemoveConnection(</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineplus">+    nsINNTPProtocol *aNntpConnection) {</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineplus">+  if (aNntpConnection) mConnectionCache.RemoveObject(aNntpConnection);</span>
<a href="#l19.827"></a><span id="l19.827"> </span>
<a href="#l19.828"></a><span id="l19.828">   return NS_OK;</span>
<a href="#l19.829"></a><span id="l19.829"> }</span>
<a href="#l19.830"></a><span id="l19.830"> </span>
<a href="#l19.831"></a><span id="l19.831"> NS_IMETHODIMP</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineminus">-nsNntpIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow)</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineminus">-{</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineplus">+nsNntpIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l19.835"></a><span id="l19.835">   // Get news.update_unread_on_expand pref</span>
<a href="#l19.836"></a><span id="l19.836">   nsresult rv;</span>
<a href="#l19.837"></a><span id="l19.837">   bool updateUnreadOnExpand = true;</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.841"></a><span id="l19.841">   if (NS_SUCCEEDED(rv))</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;news.update_unread_on_expand&quot;, &amp;updateUnreadOnExpand);</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineplus">+    prefBranch-&gt;GetBoolPref(&quot;news.update_unread_on_expand&quot;,</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineplus">+                            &amp;updateUnreadOnExpand);</span>
<a href="#l19.845"></a><span id="l19.845"> </span>
<a href="#l19.846"></a><span id="l19.846">   // Only if news.update_unread_on_expand is true do we update the unread counts</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineminus">-  if (updateUnreadOnExpand)</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineminus">-    return DownloadMail(aMsgWindow);</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineplus">+  if (updateUnreadOnExpand) return DownloadMail(aMsgWindow);</span>
<a href="#l19.850"></a><span id="l19.850">   return NS_OK;</span>
<a href="#l19.851"></a><span id="l19.851"> }</span>
<a href="#l19.852"></a><span id="l19.852"> </span>
<a href="#l19.853"></a><span id="l19.853" class="difflineminus">-nsresult</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineminus">-nsNntpIncomingServer::DownloadMail(nsIMsgWindow *aMsgWindow)</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineminus">-{</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineplus">+nsresult nsNntpIncomingServer::DownloadMail(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l19.857"></a><span id="l19.857">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.858"></a><span id="l19.858">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.859"></a><span id="l19.859">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.860"></a><span id="l19.860"> </span>
<a href="#l19.861"></a><span id="l19.861">   nsCOMPtr&lt;nsISimpleEnumerator&gt; groups;</span>
<a href="#l19.862"></a><span id="l19.862">   rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(groups));</span>
<a href="#l19.863"></a><span id="l19.863">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.864"></a><span id="l19.864"> </span>
<a href="#l19.865"></a><span id="l19.865">   bool hasNext;</span>
<a href="#l19.866"></a><span id="l19.866" class="difflineminus">-  while (NS_SUCCEEDED(rv = groups-&gt;HasMoreElements(&amp;hasNext)) &amp;&amp; hasNext)</span>
<a href="#l19.867"></a><span id="l19.867" class="difflineminus">-  {</span>
<a href="#l19.868"></a><span id="l19.868" class="difflineplus">+  while (NS_SUCCEEDED(rv = groups-&gt;HasMoreElements(&amp;hasNext)) &amp;&amp; hasNext) {</span>
<a href="#l19.869"></a><span id="l19.869">     nsCOMPtr&lt;nsISupports&gt; nextGroup;</span>
<a href="#l19.870"></a><span id="l19.870">     rv = groups-&gt;GetNext(getter_AddRefs(nextGroup));</span>
<a href="#l19.871"></a><span id="l19.871">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.872"></a><span id="l19.872"> </span>
<a href="#l19.873"></a><span id="l19.873">     nsCOMPtr&lt;nsIMsgFolder&gt; group(do_QueryInterface(nextGroup));</span>
<a href="#l19.874"></a><span id="l19.874">     rv = group-&gt;GetNewMessages(aMsgWindow, nullptr);</span>
<a href="#l19.875"></a><span id="l19.875">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.876"></a><span id="l19.876">   }</span>
<a href="#l19.877"></a><span id="l19.877">   return rv;</span>
<a href="#l19.878"></a><span id="l19.878"> }</span>
<a href="#l19.879"></a><span id="l19.879"> </span>
<a href="#l19.880"></a><span id="l19.880"> NS_IMETHODIMP</span>
<a href="#l19.881"></a><span id="l19.881" class="difflineminus">-nsNntpIncomingServer::DisplaySubscribedGroup(nsIMsgNewsFolder *aMsgFolder, int32_t aFirstMessage, int32_t aLastMessage, int32_t aTotalMessages)</span>
<a href="#l19.882"></a><span id="l19.882" class="difflineminus">-{</span>
<a href="#l19.883"></a><span id="l19.883" class="difflineplus">+nsNntpIncomingServer::DisplaySubscribedGroup(nsIMsgNewsFolder *aMsgFolder,</span>
<a href="#l19.884"></a><span id="l19.884" class="difflineplus">+                                             int32_t aFirstMessage,</span>
<a href="#l19.885"></a><span id="l19.885" class="difflineplus">+                                             int32_t aLastMessage,</span>
<a href="#l19.886"></a><span id="l19.886" class="difflineplus">+                                             int32_t aTotalMessages) {</span>
<a href="#l19.887"></a><span id="l19.887">   nsresult rv;</span>
<a href="#l19.888"></a><span id="l19.888"> </span>
<a href="#l19.889"></a><span id="l19.889">   if (!aMsgFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.890"></a><span id="l19.890"> #ifdef DEBUG_NEWS</span>
<a href="#l19.891"></a><span id="l19.891" class="difflineminus">-  printf(&quot;DisplaySubscribedGroup(...,%ld,%ld,%ld)\n&quot;,aFirstMessage,aLastMessage,aTotalMessages);</span>
<a href="#l19.892"></a><span id="l19.892" class="difflineplus">+  printf(&quot;DisplaySubscribedGroup(...,%ld,%ld,%ld)\n&quot;, aFirstMessage,</span>
<a href="#l19.893"></a><span id="l19.893" class="difflineplus">+         aLastMessage, aTotalMessages);</span>
<a href="#l19.894"></a><span id="l19.894"> #endif</span>
<a href="#l19.895"></a><span id="l19.895" class="difflineminus">-  rv = aMsgFolder-&gt;UpdateSummaryFromNNTPInfo(aFirstMessage,aLastMessage,aTotalMessages);</span>
<a href="#l19.896"></a><span id="l19.896" class="difflineplus">+  rv = aMsgFolder-&gt;UpdateSummaryFromNNTPInfo(aFirstMessage, aLastMessage,</span>
<a href="#l19.897"></a><span id="l19.897" class="difflineplus">+                                             aTotalMessages);</span>
<a href="#l19.898"></a><span id="l19.898">   return rv;</span>
<a href="#l19.899"></a><span id="l19.899"> }</span>
<a href="#l19.900"></a><span id="l19.900"> </span>
<a href="#l19.901"></a><span id="l19.901"> NS_IMETHODIMP</span>
<a href="#l19.902"></a><span id="l19.902" class="difflineminus">-nsNntpIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow)</span>
<a href="#l19.903"></a><span id="l19.903" class="difflineminus">-{</span>
<a href="#l19.904"></a><span id="l19.904" class="difflineplus">+nsNntpIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l19.905"></a><span id="l19.905">   // Biff will force a download of the messages. If the user doesn't want this</span>
<a href="#l19.906"></a><span id="l19.906">   // (e.g., there is a lot of high-traffic newsgroups), the better option is to</span>
<a href="#l19.907"></a><span id="l19.907">   // just ignore biff.</span>
<a href="#l19.908"></a><span id="l19.908">   return PerformExpand(aMsgWindow);</span>
<a href="#l19.909"></a><span id="l19.909"> }</span>
<a href="#l19.910"></a><span id="l19.910"> </span>
<a href="#l19.911"></a><span id="l19.911" class="difflineminus">-NS_IMETHODIMP nsNntpIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l19.912"></a><span id="l19.912" class="difflineminus">-{</span>
<a href="#l19.913"></a><span id="l19.913" class="difflineplus">+NS_IMETHODIMP nsNntpIncomingServer::GetServerRequiresPasswordForBiff(</span>
<a href="#l19.914"></a><span id="l19.914" class="difflineplus">+    bool *aServerRequiresPasswordForBiff) {</span>
<a href="#l19.915"></a><span id="l19.915">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l19.916"></a><span id="l19.916" class="difflineminus">-  *aServerRequiresPasswordForBiff = false;  // for news, biff is getting the unread counts</span>
<a href="#l19.917"></a><span id="l19.917" class="difflineplus">+  *aServerRequiresPasswordForBiff =</span>
<a href="#l19.918"></a><span id="l19.918" class="difflineplus">+      false;  // for news, biff is getting the unread counts</span>
<a href="#l19.919"></a><span id="l19.919">   return NS_OK;</span>
<a href="#l19.920"></a><span id="l19.920"> }</span>
<a href="#l19.921"></a><span id="l19.921"> </span>
<a href="#l19.922"></a><span id="l19.922"> NS_IMETHODIMP</span>
<a href="#l19.923"></a><span id="l19.923" class="difflineminus">-nsNntpIncomingServer::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l19.924"></a><span id="l19.924" class="difflineminus">-{</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineminus">-}</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineplus">+nsNntpIncomingServer::OnStartRunningUrl(nsIURI *url) { return NS_OK; }</span>
<a href="#l19.928"></a><span id="l19.928"> </span>
<a href="#l19.929"></a><span id="l19.929"> NS_IMETHODIMP</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineminus">-nsNntpIncomingServer::OnStopRunningUrl(nsIURI *url, nsresult exitCode)</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineminus">-{</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineplus">+nsNntpIncomingServer::OnStopRunningUrl(nsIURI *url, nsresult exitCode) {</span>
<a href="#l19.933"></a><span id="l19.933">   nsresult rv;</span>
<a href="#l19.934"></a><span id="l19.934">   rv = UpdateSubscribed();</span>
<a href="#l19.935"></a><span id="l19.935">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.936"></a><span id="l19.936"> </span>
<a href="#l19.937"></a><span id="l19.937">   rv = StopPopulating(mMsgWindow);</span>
<a href="#l19.938"></a><span id="l19.938">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.939"></a><span id="l19.939"> </span>
<a href="#l19.940"></a><span id="l19.940">   return NS_OK;</span>
<a href="#l19.941"></a><span id="l19.941"> }</span>
<a href="#l19.942"></a><span id="l19.942"> </span>
<a href="#l19.943"></a><span id="l19.943"> NS_IMETHODIMP</span>
<a href="#l19.944"></a><span id="l19.944"> nsNntpIncomingServer::ContainsNewsgroup(const nsACString &amp;aName,</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineminus">-                                        bool *containsGroup)</span>
<a href="#l19.946"></a><span id="l19.946" class="difflineminus">-{</span>
<a href="#l19.947"></a><span id="l19.947" class="difflineminus">-    NS_ENSURE_ARG_POINTER(containsGroup);</span>
<a href="#l19.948"></a><span id="l19.948" class="difflineminus">-    NS_ENSURE_FALSE(aName.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l19.949"></a><span id="l19.949" class="difflineplus">+                                        bool *containsGroup) {</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineplus">+  NS_ENSURE_ARG_POINTER(containsGroup);</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineplus">+  NS_ENSURE_FALSE(aName.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l19.952"></a><span id="l19.952"> </span>
<a href="#l19.953"></a><span id="l19.953" class="difflineminus">-    if (mSubscribedNewsgroups.Length() == 0)</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineminus">-    {</span>
<a href="#l19.955"></a><span id="l19.955" class="difflineminus">-      // If this is empty, we may need to discover folders</span>
<a href="#l19.956"></a><span id="l19.956" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.957"></a><span id="l19.957" class="difflineminus">-      GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.958"></a><span id="l19.958" class="difflineminus">-      if (rootFolder)</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineminus">-      {</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineminus">-        nsCOMPtr&lt;nsISimpleEnumerator&gt; subfolders;</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineminus">-        rootFolder-&gt;GetSubFolders(getter_AddRefs(subfolders));</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineminus">-      }</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineplus">+  if (mSubscribedNewsgroups.Length() == 0) {</span>
<a href="#l19.964"></a><span id="l19.964" class="difflineplus">+    // If this is empty, we may need to discover folders</span>
<a href="#l19.965"></a><span id="l19.965" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineplus">+    GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineplus">+    if (rootFolder) {</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineplus">+      nsCOMPtr&lt;nsISimpleEnumerator&gt; subfolders;</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineplus">+      rootFolder-&gt;GetSubFolders(getter_AddRefs(subfolders));</span>
<a href="#l19.970"></a><span id="l19.970">     }</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineminus">-    nsAutoCString unescapedName;</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineminus">-    MsgUnescapeString(aName, 0, unescapedName);</span>
<a href="#l19.973"></a><span id="l19.973" class="difflineminus">-    *containsGroup = mSubscribedNewsgroups.Contains(aName);</span>
<a href="#l19.974"></a><span id="l19.974" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineplus">+  }</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineplus">+  nsAutoCString unescapedName;</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineplus">+  MsgUnescapeString(aName, 0, unescapedName);</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineplus">+  *containsGroup = mSubscribedNewsgroups.Contains(aName);</span>
<a href="#l19.979"></a><span id="l19.979" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.980"></a><span id="l19.980"> }</span>
<a href="#l19.981"></a><span id="l19.981"> </span>
<a href="#l19.982"></a><span id="l19.982"> NS_IMETHODIMP</span>
<a href="#l19.983"></a><span id="l19.983" class="difflineminus">-nsNntpIncomingServer::SubscribeToNewsgroup(const nsACString &amp;aName)</span>
<a href="#l19.984"></a><span id="l19.984" class="difflineminus">-{</span>
<a href="#l19.985"></a><span id="l19.985" class="difflineminus">-    NS_ASSERTION(!aName.IsEmpty(), &quot;no name&quot;);</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineminus">-    NS_ENSURE_FALSE(aName.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineplus">+nsNntpIncomingServer::SubscribeToNewsgroup(const nsACString &amp;aName) {</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineplus">+  NS_ASSERTION(!aName.IsEmpty(), &quot;no name&quot;);</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineplus">+  NS_ENSURE_FALSE(aName.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l19.990"></a><span id="l19.990"> </span>
<a href="#l19.991"></a><span id="l19.991" class="difflineminus">-    // If we already have this newsgroup, do nothing and report success.</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineminus">-    bool containsGroup = false;</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineminus">-    nsresult rv = ContainsNewsgroup(aName, &amp;containsGroup);</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineminus">-    if (containsGroup)</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineminus">-      return NS_OK;</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineplus">+  // If we already have this newsgroup, do nothing and report success.</span>
<a href="#l19.998"></a><span id="l19.998" class="difflineplus">+  bool containsGroup = false;</span>
<a href="#l19.999"></a><span id="l19.999" class="difflineplus">+  nsresult rv = ContainsNewsgroup(aName, &amp;containsGroup);</span>
<a href="#l19.1000"></a><span id="l19.1000" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1001"></a><span id="l19.1001" class="difflineplus">+  if (containsGroup) return NS_OK;</span>
<a href="#l19.1002"></a><span id="l19.1002"> </span>
<a href="#l19.1003"></a><span id="l19.1003" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; msgfolder;</span>
<a href="#l19.1004"></a><span id="l19.1004" class="difflineminus">-    rv = GetRootMsgFolder(getter_AddRefs(msgfolder));</span>
<a href="#l19.1005"></a><span id="l19.1005" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1006"></a><span id="l19.1006" class="difflineminus">-    NS_ENSURE_TRUE(msgfolder, NS_ERROR_FAILURE);</span>
<a href="#l19.1007"></a><span id="l19.1007" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; msgfolder;</span>
<a href="#l19.1008"></a><span id="l19.1008" class="difflineplus">+  rv = GetRootMsgFolder(getter_AddRefs(msgfolder));</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1010"></a><span id="l19.1010" class="difflineplus">+  NS_ENSURE_TRUE(msgfolder, NS_ERROR_FAILURE);</span>
<a href="#l19.1011"></a><span id="l19.1011"> </span>
<a href="#l19.1012"></a><span id="l19.1012" class="difflineminus">-    return msgfolder-&gt;CreateSubfolder(NS_ConvertUTF8toUTF16(aName), nullptr);</span>
<a href="#l19.1013"></a><span id="l19.1013" class="difflineplus">+  return msgfolder-&gt;CreateSubfolder(NS_ConvertUTF8toUTF16(aName), nullptr);</span>
<a href="#l19.1014"></a><span id="l19.1014"> }</span>
<a href="#l19.1015"></a><span id="l19.1015"> </span>
<a href="#l19.1016"></a><span id="l19.1016" class="difflineminus">-bool</span>
<a href="#l19.1017"></a><span id="l19.1017" class="difflineminus">-writeGroupToHostInfoFile(nsCString &amp;aElement, void *aData)</span>
<a href="#l19.1018"></a><span id="l19.1018" class="difflineminus">-{</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineminus">-    nsIOutputStream *stream;</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineminus">-    stream = (nsIOutputStream *)aData;</span>
<a href="#l19.1021"></a><span id="l19.1021" class="difflineminus">-    NS_ASSERTION(stream, &quot;no stream&quot;);</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineminus">-    if (!stream) {</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineminus">-        // stop, something is bad.</span>
<a href="#l19.1024"></a><span id="l19.1024" class="difflineminus">-        return false;</span>
<a href="#l19.1025"></a><span id="l19.1025" class="difflineminus">-    }</span>
<a href="#l19.1026"></a><span id="l19.1026" class="difflineminus">-    return true;</span>
<a href="#l19.1027"></a><span id="l19.1027" class="difflineplus">+bool writeGroupToHostInfoFile(nsCString &amp;aElement, void *aData) {</span>
<a href="#l19.1028"></a><span id="l19.1028" class="difflineplus">+  nsIOutputStream *stream;</span>
<a href="#l19.1029"></a><span id="l19.1029" class="difflineplus">+  stream = (nsIOutputStream *)aData;</span>
<a href="#l19.1030"></a><span id="l19.1030" class="difflineplus">+  NS_ASSERTION(stream, &quot;no stream&quot;);</span>
<a href="#l19.1031"></a><span id="l19.1031" class="difflineplus">+  if (!stream) {</span>
<a href="#l19.1032"></a><span id="l19.1032" class="difflineplus">+    // stop, something is bad.</span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineplus">+    return false;</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineplus">+  }</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineplus">+  return true;</span>
<a href="#l19.1036"></a><span id="l19.1036"> }</span>
<a href="#l19.1037"></a><span id="l19.1037"> </span>
<a href="#l19.1038"></a><span id="l19.1038" class="difflineminus">-void nsNntpIncomingServer::WriteLine(nsIOutputStream *stream, nsCString &amp;str)</span>
<a href="#l19.1039"></a><span id="l19.1039" class="difflineminus">-{</span>
<a href="#l19.1040"></a><span id="l19.1040" class="difflineplus">+void nsNntpIncomingServer::WriteLine(nsIOutputStream *stream, nsCString &amp;str) {</span>
<a href="#l19.1041"></a><span id="l19.1041">   uint32_t bytesWritten;</span>
<a href="#l19.1042"></a><span id="l19.1042">   str.Append(MSG_LINEBREAK);</span>
<a href="#l19.1043"></a><span id="l19.1043">   stream-&gt;Write(str.get(), str.Length(), &amp;bytesWritten);</span>
<a href="#l19.1044"></a><span id="l19.1044"> }</span>
<a href="#l19.1045"></a><span id="l19.1045" class="difflineminus">-nsresult</span>
<a href="#l19.1046"></a><span id="l19.1046" class="difflineminus">-nsNntpIncomingServer::WriteHostInfoFile()</span>
<a href="#l19.1047"></a><span id="l19.1047" class="difflineminus">-{</span>
<a href="#l19.1048"></a><span id="l19.1048" class="difflineminus">-  if (!mHostInfoHasChanged)</span>
<a href="#l19.1049"></a><span id="l19.1049" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.1050"></a><span id="l19.1050" class="difflineplus">+nsresult nsNntpIncomingServer::WriteHostInfoFile() {</span>
<a href="#l19.1051"></a><span id="l19.1051" class="difflineplus">+  if (!mHostInfoHasChanged) return NS_OK;</span>
<a href="#l19.1052"></a><span id="l19.1052"> </span>
<a href="#l19.1053"></a><span id="l19.1053">   mLastUpdatedTime = uint32_t(PR_Now() / PR_USEC_PER_SEC);</span>
<a href="#l19.1054"></a><span id="l19.1054"> </span>
<a href="#l19.1055"></a><span id="l19.1055">   nsCString hostname;</span>
<a href="#l19.1056"></a><span id="l19.1056">   nsresult rv = GetHostName(hostname);</span>
<a href="#l19.1057"></a><span id="l19.1057" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1058"></a><span id="l19.1058" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1059"></a><span id="l19.1059"> </span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineminus">-  if (!mHostInfoFile)</span>
<a href="#l19.1061"></a><span id="l19.1061" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.1062"></a><span id="l19.1062" class="difflineplus">+  if (!mHostInfoFile) return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.1063"></a><span id="l19.1063">   nsCOMPtr&lt;nsIOutputStream&gt; hostInfoStream;</span>
<a href="#l19.1064"></a><span id="l19.1064" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(hostInfoStream), mHostInfoFile, -1, 00600);</span>
<a href="#l19.1065"></a><span id="l19.1065" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(hostInfoStream),</span>
<a href="#l19.1066"></a><span id="l19.1066" class="difflineplus">+                                      mHostInfoFile, -1, 00600);</span>
<a href="#l19.1067"></a><span id="l19.1067">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1068"></a><span id="l19.1068"> </span>
<a href="#l19.1069"></a><span id="l19.1069">   // XXX TODO: missing some formatting, see the 4.x code</span>
<a href="#l19.1070"></a><span id="l19.1070">   nsAutoCString header(&quot;# News host information file.&quot;);</span>
<a href="#l19.1071"></a><span id="l19.1071">   WriteLine(hostInfoStream, header);</span>
<a href="#l19.1072"></a><span id="l19.1072">   header.AssignLiteral(&quot;# This is a generated file!  Do not edit.&quot;);</span>
<a href="#l19.1073"></a><span id="l19.1073">   WriteLine(hostInfoStream, header);</span>
<a href="#l19.1074"></a><span id="l19.1074">   header.Truncate();</span>
<a href="#l19.1075"></a><span id="l19.1075" class="difflineat">@@ -827,37 +761,34 @@ nsNntpIncomingServer::WriteHostInfoFile(</span>
<a href="#l19.1076"></a><span id="l19.1076">   newsrcname.Append(hostname);</span>
<a href="#l19.1077"></a><span id="l19.1077">   WriteLine(hostInfoStream, hostname);</span>
<a href="#l19.1078"></a><span id="l19.1078">   nsAutoCString dateStr(&quot;lastgroupdate=&quot;);</span>
<a href="#l19.1079"></a><span id="l19.1079">   dateStr.AppendInt(mLastUpdatedTime);</span>
<a href="#l19.1080"></a><span id="l19.1080">   WriteLine(hostInfoStream, dateStr);</span>
<a href="#l19.1081"></a><span id="l19.1081">   dateStr = &quot;uniqueid=&quot;;</span>
<a href="#l19.1082"></a><span id="l19.1082">   dateStr.AppendInt(mUniqueId);</span>
<a href="#l19.1083"></a><span id="l19.1083">   WriteLine(hostInfoStream, dateStr);</span>
<a href="#l19.1084"></a><span id="l19.1084" class="difflineminus">-  header.Assign(MSG_LINEBREAK&quot;begingroups&quot;);</span>
<a href="#l19.1085"></a><span id="l19.1085" class="difflineplus">+  header.Assign(MSG_LINEBREAK &quot;begingroups&quot;);</span>
<a href="#l19.1086"></a><span id="l19.1086">   WriteLine(hostInfoStream, header);</span>
<a href="#l19.1087"></a><span id="l19.1087"> </span>
<a href="#l19.1088"></a><span id="l19.1088">   // XXX TODO: sort groups first?</span>
<a href="#l19.1089"></a><span id="l19.1089">   uint32_t length = mGroupsOnServer.Length();</span>
<a href="#l19.1090"></a><span id="l19.1090" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l19.1091"></a><span id="l19.1091" class="difflineminus">-  {</span>
<a href="#l19.1092"></a><span id="l19.1092" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l19.1093"></a><span id="l19.1093">     uint32_t bytesWritten;</span>
<a href="#l19.1094"></a><span id="l19.1094">     hostInfoStream-&gt;Write(mGroupsOnServer[i].get(), mGroupsOnServer[i].Length(),</span>
<a href="#l19.1095"></a><span id="l19.1095">                           &amp;bytesWritten);</span>
<a href="#l19.1096"></a><span id="l19.1096">     hostInfoStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;bytesWritten);</span>
<a href="#l19.1097"></a><span id="l19.1097">   }</span>
<a href="#l19.1098"></a><span id="l19.1098"> </span>
<a href="#l19.1099"></a><span id="l19.1099">   hostInfoStream-&gt;Close();</span>
<a href="#l19.1100"></a><span id="l19.1100">   mHostInfoHasChanged = false;</span>
<a href="#l19.1101"></a><span id="l19.1101">   return NS_OK;</span>
<a href="#l19.1102"></a><span id="l19.1102"> }</span>
<a href="#l19.1103"></a><span id="l19.1103"> </span>
<a href="#l19.1104"></a><span id="l19.1104" class="difflineminus">-nsresult</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineminus">-nsNntpIncomingServer::LoadHostInfoFile()</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineminus">-{</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineplus">+nsresult nsNntpIncomingServer::LoadHostInfoFile() {</span>
<a href="#l19.1108"></a><span id="l19.1108">   nsresult rv;</span>
<a href="#l19.1109"></a><span id="l19.1109">   // we haven't loaded it yet</span>
<a href="#l19.1110"></a><span id="l19.1110">   mHostInfoLoaded = false;</span>
<a href="#l19.1111"></a><span id="l19.1111"> </span>
<a href="#l19.1112"></a><span id="l19.1112">   rv = GetLocalPath(getter_AddRefs(mHostInfoFile));</span>
<a href="#l19.1113"></a><span id="l19.1113">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1114"></a><span id="l19.1114">   if (!mHostInfoFile) return NS_ERROR_FAILURE;</span>
<a href="#l19.1115"></a><span id="l19.1115"> </span>
<a href="#l19.1116"></a><span id="l19.1116" class="difflineat">@@ -870,81 +801,81 @@ nsNntpIncomingServer::LoadHostInfoFile()</span>
<a href="#l19.1117"></a><span id="l19.1117"> </span>
<a href="#l19.1118"></a><span id="l19.1118">   // it is ok if the hostinfo.dat file does not exist.</span>
<a href="#l19.1119"></a><span id="l19.1119">   if (!exists) return NS_OK;</span>
<a href="#l19.1120"></a><span id="l19.1120"> </span>
<a href="#l19.1121"></a><span id="l19.1121">   nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l19.1122"></a><span id="l19.1122">   rv = NS_NewLocalFileInputStream(getter_AddRefs(fileStream), mHostInfoFile);</span>
<a href="#l19.1123"></a><span id="l19.1123">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1124"></a><span id="l19.1124"> </span>
<a href="#l19.1125"></a><span id="l19.1125" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l19.1126"></a><span id="l19.1126" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(</span>
<a href="#l19.1127"></a><span id="l19.1127" class="difflineplus">+      do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l19.1128"></a><span id="l19.1128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1129"></a><span id="l19.1129"> </span>
<a href="#l19.1130"></a><span id="l19.1130">   bool more = true;</span>
<a href="#l19.1131"></a><span id="l19.1131">   nsCString line;</span>
<a href="#l19.1132"></a><span id="l19.1132"> </span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineminus">-  while (more &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l19.1134"></a><span id="l19.1134" class="difflineminus">-  {</span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineplus">+  while (more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l19.1136"></a><span id="l19.1136">     rv = lineInputStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineminus">-    if (line.IsEmpty())</span>
<a href="#l19.1138"></a><span id="l19.1138" class="difflineminus">-      continue;</span>
<a href="#l19.1139"></a><span id="l19.1139" class="difflineplus">+    if (line.IsEmpty()) continue;</span>
<a href="#l19.1140"></a><span id="l19.1140">     HandleLine(line.get(), line.Length());</span>
<a href="#l19.1141"></a><span id="l19.1141">   }</span>
<a href="#l19.1142"></a><span id="l19.1142">   mHasSeenBeginGroups = false;</span>
<a href="#l19.1143"></a><span id="l19.1143">   fileStream-&gt;Close();</span>
<a href="#l19.1144"></a><span id="l19.1144"> </span>
<a href="#l19.1145"></a><span id="l19.1145">   return UpdateSubscribed();</span>
<a href="#l19.1146"></a><span id="l19.1146"> }</span>
<a href="#l19.1147"></a><span id="l19.1147"> </span>
<a href="#l19.1148"></a><span id="l19.1148"> NS_IMETHODIMP</span>
<a href="#l19.1149"></a><span id="l19.1149" class="difflineminus">-nsNntpIncomingServer::StartPopulatingWithUri(nsIMsgWindow *aMsgWindow, bool aForceToServer, const char *uri)</span>
<a href="#l19.1150"></a><span id="l19.1150" class="difflineminus">-{</span>
<a href="#l19.1151"></a><span id="l19.1151" class="difflineplus">+nsNntpIncomingServer::StartPopulatingWithUri(nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.1152"></a><span id="l19.1152" class="difflineplus">+                                             bool aForceToServer,</span>
<a href="#l19.1153"></a><span id="l19.1153" class="difflineplus">+                                             const char *uri) {</span>
<a href="#l19.1154"></a><span id="l19.1154"> #ifdef DEBUG_seth</span>
<a href="#l19.1155"></a><span id="l19.1155" class="difflineminus">-  printf(&quot;StartPopulatingWithUri(%s)\n&quot;,uri);</span>
<a href="#l19.1156"></a><span id="l19.1156" class="difflineplus">+  printf(&quot;StartPopulatingWithUri(%s)\n&quot;, uri);</span>
<a href="#l19.1157"></a><span id="l19.1157"> #endif</span>
<a href="#l19.1158"></a><span id="l19.1158"> </span>
<a href="#l19.1159"></a><span id="l19.1159">   nsresult rv = EnsureInner();</span>
<a href="#l19.1160"></a><span id="l19.1160" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1161"></a><span id="l19.1161" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1162"></a><span id="l19.1162">   rv = mInner-&gt;StartPopulatingWithUri(aMsgWindow, aForceToServer, uri);</span>
<a href="#l19.1163"></a><span id="l19.1163" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1164"></a><span id="l19.1164" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1165"></a><span id="l19.1165"> </span>
<a href="#l19.1166"></a><span id="l19.1166">   rv = StopPopulating(mMsgWindow);</span>
<a href="#l19.1167"></a><span id="l19.1167">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1168"></a><span id="l19.1168"> </span>
<a href="#l19.1169"></a><span id="l19.1169">   return NS_OK;</span>
<a href="#l19.1170"></a><span id="l19.1170"> }</span>
<a href="#l19.1171"></a><span id="l19.1171"> </span>
<a href="#l19.1172"></a><span id="l19.1172"> NS_IMETHODIMP</span>
<a href="#l19.1173"></a><span id="l19.1173" class="difflineminus">-nsNntpIncomingServer::SubscribeCleanup()</span>
<a href="#l19.1174"></a><span id="l19.1174" class="difflineminus">-{</span>
<a href="#l19.1175"></a><span id="l19.1175" class="difflineplus">+nsNntpIncomingServer::SubscribeCleanup() {</span>
<a href="#l19.1176"></a><span id="l19.1176">   nsresult rv = NS_OK;</span>
<a href="#l19.1177"></a><span id="l19.1177" class="difflineminus">-    rv = ClearInner();</span>
<a href="#l19.1178"></a><span id="l19.1178" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1179"></a><span id="l19.1179" class="difflineplus">+  rv = ClearInner();</span>
<a href="#l19.1180"></a><span id="l19.1180" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1181"></a><span id="l19.1181">   return NS_OK;</span>
<a href="#l19.1182"></a><span id="l19.1182"> }</span>
<a href="#l19.1183"></a><span id="l19.1183"> </span>
<a href="#l19.1184"></a><span id="l19.1184"> NS_IMETHODIMP</span>
<a href="#l19.1185"></a><span id="l19.1185" class="difflineminus">-nsNntpIncomingServer::StartPopulating(nsIMsgWindow *aMsgWindow, bool aForceToServer, bool aGetOnlyNew)</span>
<a href="#l19.1186"></a><span id="l19.1186" class="difflineminus">-{</span>
<a href="#l19.1187"></a><span id="l19.1187" class="difflineplus">+nsNntpIncomingServer::StartPopulating(nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.1188"></a><span id="l19.1188" class="difflineplus">+                                      bool aForceToServer, bool aGetOnlyNew) {</span>
<a href="#l19.1189"></a><span id="l19.1189">   mMsgWindow = aMsgWindow;</span>
<a href="#l19.1190"></a><span id="l19.1190"> </span>
<a href="#l19.1191"></a><span id="l19.1191">   nsresult rv = EnsureInner();</span>
<a href="#l19.1192"></a><span id="l19.1192" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1193"></a><span id="l19.1193" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1194"></a><span id="l19.1194"> </span>
<a href="#l19.1195"></a><span id="l19.1195">   rv = mInner-&gt;StartPopulating(aMsgWindow, aForceToServer, aGetOnlyNew);</span>
<a href="#l19.1196"></a><span id="l19.1196" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1197"></a><span id="l19.1197" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1198"></a><span id="l19.1198"> </span>
<a href="#l19.1199"></a><span id="l19.1199">   rv = SetDelimiter(NEWS_DELIMITER);</span>
<a href="#l19.1200"></a><span id="l19.1200">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1201"></a><span id="l19.1201"> </span>
<a href="#l19.1202"></a><span id="l19.1202">   rv = SetShowFullName(true);</span>
<a href="#l19.1203"></a><span id="l19.1203">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1204"></a><span id="l19.1204"> </span>
<a href="#l19.1205"></a><span id="l19.1205" class="difflineminus">-  nsCOMPtr&lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.1206"></a><span id="l19.1206" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1207"></a><span id="l19.1207" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l19.1208"></a><span id="l19.1208" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.1209"></a><span id="l19.1209" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1210"></a><span id="l19.1210"> </span>
<a href="#l19.1211"></a><span id="l19.1211">   mHostInfoLoaded = false;</span>
<a href="#l19.1212"></a><span id="l19.1212">   mVersion = INVALID_VERSION;</span>
<a href="#l19.1213"></a><span id="l19.1213">   mGroupsOnServer.Clear();</span>
<a href="#l19.1214"></a><span id="l19.1214">   mGetOnlyNew = aGetOnlyNew;</span>
<a href="#l19.1215"></a><span id="l19.1215"> </span>
<a href="#l19.1216"></a><span id="l19.1216">   if (!aForceToServer) {</span>
<a href="#l19.1217"></a><span id="l19.1217">     rv = LoadHostInfoFile();</span>
<a href="#l19.1218"></a><span id="l19.1218" class="difflineat">@@ -956,1189 +887,1070 @@ nsNntpIncomingServer::StartPopulating(ns</span>
<a href="#l19.1219"></a><span id="l19.1219">     // set these to true, so when we are done and we call WriteHostInfoFile()</span>
<a href="#l19.1220"></a><span id="l19.1220">     // we'll write out to hostinfo.dat</span>
<a href="#l19.1221"></a><span id="l19.1221">     mHostInfoHasChanged = true;</span>
<a href="#l19.1222"></a><span id="l19.1222">     mVersion = VALID_VERSION;</span>
<a href="#l19.1223"></a><span id="l19.1223"> </span>
<a href="#l19.1224"></a><span id="l19.1224">     mGroupsOnServer.Clear();</span>
<a href="#l19.1225"></a><span id="l19.1225">     rv = nntpService-&gt;GetListOfGroupsOnServer(this, aMsgWindow, aGetOnlyNew);</span>
<a href="#l19.1226"></a><span id="l19.1226">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1227"></a><span id="l19.1227" class="difflineminus">-  }</span>
<a href="#l19.1228"></a><span id="l19.1228" class="difflineminus">-  else {</span>
<a href="#l19.1229"></a><span id="l19.1229" class="difflineplus">+  } else {</span>
<a href="#l19.1230"></a><span id="l19.1230">     rv = StopPopulating(aMsgWindow);</span>
<a href="#l19.1231"></a><span id="l19.1231">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1232"></a><span id="l19.1232">   }</span>
<a href="#l19.1233"></a><span id="l19.1233"> </span>
<a href="#l19.1234"></a><span id="l19.1234">   return NS_OK;</span>
<a href="#l19.1235"></a><span id="l19.1235"> }</span>
<a href="#l19.1236"></a><span id="l19.1236"> </span>
<a href="#l19.1237"></a><span id="l19.1237"> /**</span>
<a href="#l19.1238"></a><span id="l19.1238">  * This method is the entry point for |nsNNTPProtocol| class. |aName| is now</span>
<a href="#l19.1239"></a><span id="l19.1239">  * encoded in the serverside character encoding, but we need to handle</span>
<a href="#l19.1240"></a><span id="l19.1240">  * newsgroup names in UTF-8 internally, So we convert |aName| to</span>
<a href="#l19.1241"></a><span id="l19.1241">  * UTF-8 here for later use.</span>
<a href="#l19.1242"></a><span id="l19.1242">  **/</span>
<a href="#l19.1243"></a><span id="l19.1243"> NS_IMETHODIMP</span>
<a href="#l19.1244"></a><span id="l19.1244" class="difflineminus">-nsNntpIncomingServer::AddNewsgroupToList(const char *aName)</span>
<a href="#l19.1245"></a><span id="l19.1245" class="difflineminus">-{</span>
<a href="#l19.1246"></a><span id="l19.1246" class="difflineminus">-    nsresult rv;</span>
<a href="#l19.1247"></a><span id="l19.1247" class="difflineplus">+nsNntpIncomingServer::AddNewsgroupToList(const char *aName) {</span>
<a href="#l19.1248"></a><span id="l19.1248" class="difflineplus">+  nsresult rv;</span>
<a href="#l19.1249"></a><span id="l19.1249"> </span>
<a href="#l19.1250"></a><span id="l19.1250" class="difflineminus">-    nsAutoString newsgroupName;</span>
<a href="#l19.1251"></a><span id="l19.1251" class="difflineminus">-    nsAutoCString dataCharset;</span>
<a href="#l19.1252"></a><span id="l19.1252" class="difflineminus">-    rv = GetCharset(dataCharset);</span>
<a href="#l19.1253"></a><span id="l19.1253" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1254"></a><span id="l19.1254" class="difflineplus">+  nsAutoString newsgroupName;</span>
<a href="#l19.1255"></a><span id="l19.1255" class="difflineplus">+  nsAutoCString dataCharset;</span>
<a href="#l19.1256"></a><span id="l19.1256" class="difflineplus">+  rv = GetCharset(dataCharset);</span>
<a href="#l19.1257"></a><span id="l19.1257" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1258"></a><span id="l19.1258"> </span>
<a href="#l19.1259"></a><span id="l19.1259" class="difflineminus">-    rv = nsMsgI18NConvertToUnicode(dataCharset,</span>
<a href="#l19.1260"></a><span id="l19.1260" class="difflineminus">-                                   nsDependentCString(aName),</span>
<a href="#l19.1261"></a><span id="l19.1261" class="difflineminus">-                                   newsgroupName);</span>
<a href="#l19.1262"></a><span id="l19.1262" class="difflineplus">+  rv = nsMsgI18NConvertToUnicode(dataCharset, nsDependentCString(aName),</span>
<a href="#l19.1263"></a><span id="l19.1263" class="difflineplus">+                                 newsgroupName);</span>
<a href="#l19.1264"></a><span id="l19.1264"> #ifdef DEBUG_jungshik</span>
<a href="#l19.1265"></a><span id="l19.1265" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;newsgroup name conversion failed&quot;);</span>
<a href="#l19.1266"></a><span id="l19.1266" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;newsgroup name conversion failed&quot;);</span>
<a href="#l19.1267"></a><span id="l19.1267"> #endif</span>
<a href="#l19.1268"></a><span id="l19.1268" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l19.1269"></a><span id="l19.1269" class="difflineminus">-        CopyASCIItoUTF16(nsDependentCString(aName), newsgroupName);</span>
<a href="#l19.1270"></a><span id="l19.1270" class="difflineminus">-    }</span>
<a href="#l19.1271"></a><span id="l19.1271" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l19.1272"></a><span id="l19.1272" class="difflineplus">+    CopyASCIItoUTF16(nsDependentCString(aName), newsgroupName);</span>
<a href="#l19.1273"></a><span id="l19.1273" class="difflineplus">+  }</span>
<a href="#l19.1274"></a><span id="l19.1274"> </span>
<a href="#l19.1275"></a><span id="l19.1275" class="difflineminus">-    rv = AddTo(NS_ConvertUTF16toUTF8(newsgroupName),</span>
<a href="#l19.1276"></a><span id="l19.1276" class="difflineminus">-               false, true, true);</span>
<a href="#l19.1277"></a><span id="l19.1277" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1278"></a><span id="l19.1278" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.1279"></a><span id="l19.1279" class="difflineplus">+  rv = AddTo(NS_ConvertUTF16toUTF8(newsgroupName), false, true, true);</span>
<a href="#l19.1280"></a><span id="l19.1280" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1281"></a><span id="l19.1281" class="difflineplus">+  return NS_OK;</span>
<a href="#l19.1282"></a><span id="l19.1282"> }</span>
<a href="#l19.1283"></a><span id="l19.1283"> </span>
<a href="#l19.1284"></a><span id="l19.1284"> NS_IMETHODIMP</span>
<a href="#l19.1285"></a><span id="l19.1285" class="difflineminus">-nsNntpIncomingServer::SetIncomingServer(nsIMsgIncomingServer *aServer)</span>
<a href="#l19.1286"></a><span id="l19.1286" class="difflineminus">-{</span>
<a href="#l19.1287"></a><span id="l19.1287" class="difflineplus">+nsNntpIncomingServer::SetIncomingServer(nsIMsgIncomingServer *aServer) {</span>
<a href="#l19.1288"></a><span id="l19.1288">   nsresult rv = EnsureInner();</span>
<a href="#l19.1289"></a><span id="l19.1289" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1290"></a><span id="l19.1290" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1291"></a><span id="l19.1291">   return mInner-&gt;SetIncomingServer(aServer);</span>
<a href="#l19.1292"></a><span id="l19.1292"> }</span>
<a href="#l19.1293"></a><span id="l19.1293"> </span>
<a href="#l19.1294"></a><span id="l19.1294"> NS_IMETHODIMP</span>
<a href="#l19.1295"></a><span id="l19.1295" class="difflineminus">-nsNntpIncomingServer::SetShowFullName(bool showFullName)</span>
<a href="#l19.1296"></a><span id="l19.1296" class="difflineminus">-{</span>
<a href="#l19.1297"></a><span id="l19.1297" class="difflineplus">+nsNntpIncomingServer::SetShowFullName(bool showFullName) {</span>
<a href="#l19.1298"></a><span id="l19.1298">   nsresult rv = EnsureInner();</span>
<a href="#l19.1299"></a><span id="l19.1299" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1300"></a><span id="l19.1300" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1301"></a><span id="l19.1301">   return mInner-&gt;SetShowFullName(showFullName);</span>
<a href="#l19.1302"></a><span id="l19.1302"> }</span>
<a href="#l19.1303"></a><span id="l19.1303"> </span>
<a href="#l19.1304"></a><span id="l19.1304" class="difflineminus">-nsresult</span>
<a href="#l19.1305"></a><span id="l19.1305" class="difflineminus">-nsNntpIncomingServer::ClearInner()</span>
<a href="#l19.1306"></a><span id="l19.1306" class="difflineminus">-{</span>
<a href="#l19.1307"></a><span id="l19.1307" class="difflineplus">+nsresult nsNntpIncomingServer::ClearInner() {</span>
<a href="#l19.1308"></a><span id="l19.1308">   nsresult rv = NS_OK;</span>
<a href="#l19.1309"></a><span id="l19.1309"> </span>
<a href="#l19.1310"></a><span id="l19.1310">   if (mInner) {</span>
<a href="#l19.1311"></a><span id="l19.1311">     rv = mInner-&gt;SetSubscribeListener(nullptr);</span>
<a href="#l19.1312"></a><span id="l19.1312" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1313"></a><span id="l19.1313" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1314"></a><span id="l19.1314"> </span>
<a href="#l19.1315"></a><span id="l19.1315">     rv = mInner-&gt;SetIncomingServer(nullptr);</span>
<a href="#l19.1316"></a><span id="l19.1316" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1317"></a><span id="l19.1317" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1318"></a><span id="l19.1318"> </span>
<a href="#l19.1319"></a><span id="l19.1319">     mInner = nullptr;</span>
<a href="#l19.1320"></a><span id="l19.1320">   }</span>
<a href="#l19.1321"></a><span id="l19.1321">   return NS_OK;</span>
<a href="#l19.1322"></a><span id="l19.1322"> }</span>
<a href="#l19.1323"></a><span id="l19.1323"> </span>
<a href="#l19.1324"></a><span id="l19.1324" class="difflineminus">-nsresult</span>
<a href="#l19.1325"></a><span id="l19.1325" class="difflineminus">-nsNntpIncomingServer::EnsureInner()</span>
<a href="#l19.1326"></a><span id="l19.1326" class="difflineminus">-{</span>
<a href="#l19.1327"></a><span id="l19.1327" class="difflineplus">+nsresult nsNntpIncomingServer::EnsureInner() {</span>
<a href="#l19.1328"></a><span id="l19.1328">   nsresult rv = NS_OK;</span>
<a href="#l19.1329"></a><span id="l19.1329"> </span>
<a href="#l19.1330"></a><span id="l19.1330" class="difflineminus">-  if (mInner)</span>
<a href="#l19.1331"></a><span id="l19.1331" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.1332"></a><span id="l19.1332" class="difflineplus">+  if (mInner) return NS_OK;</span>
<a href="#l19.1333"></a><span id="l19.1333"> </span>
<a href="#l19.1334"></a><span id="l19.1334" class="difflineminus">-  mInner = do_CreateInstance(kSubscribableServerCID,&amp;rv);</span>
<a href="#l19.1335"></a><span id="l19.1335" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1336"></a><span id="l19.1336" class="difflineminus">-  if (!mInner)</span>
<a href="#l19.1337"></a><span id="l19.1337" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l19.1338"></a><span id="l19.1338" class="difflineplus">+  mInner = do_CreateInstance(kSubscribableServerCID, &amp;rv);</span>
<a href="#l19.1339"></a><span id="l19.1339" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1340"></a><span id="l19.1340" class="difflineplus">+  if (!mInner) return NS_ERROR_FAILURE;</span>
<a href="#l19.1341"></a><span id="l19.1341"> </span>
<a href="#l19.1342"></a><span id="l19.1342">   rv = SetIncomingServer(this);</span>
<a href="#l19.1343"></a><span id="l19.1343" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1344"></a><span id="l19.1344" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1345"></a><span id="l19.1345"> </span>
<a href="#l19.1346"></a><span id="l19.1346">   return NS_OK;</span>
<a href="#l19.1347"></a><span id="l19.1347"> }</span>
<a href="#l19.1348"></a><span id="l19.1348"> </span>
<a href="#l19.1349"></a><span id="l19.1349"> NS_IMETHODIMP</span>
<a href="#l19.1350"></a><span id="l19.1350" class="difflineminus">-nsNntpIncomingServer::GetDelimiter(char *aDelimiter)</span>
<a href="#l19.1351"></a><span id="l19.1351" class="difflineminus">-{</span>
<a href="#l19.1352"></a><span id="l19.1352" class="difflineplus">+nsNntpIncomingServer::GetDelimiter(char *aDelimiter) {</span>
<a href="#l19.1353"></a><span id="l19.1353">   nsresult rv = EnsureInner();</span>
<a href="#l19.1354"></a><span id="l19.1354" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1355"></a><span id="l19.1355" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1356"></a><span id="l19.1356">   return mInner-&gt;GetDelimiter(aDelimiter);</span>
<a href="#l19.1357"></a><span id="l19.1357"> }</span>
<a href="#l19.1358"></a><span id="l19.1358"> </span>
<a href="#l19.1359"></a><span id="l19.1359"> NS_IMETHODIMP</span>
<a href="#l19.1360"></a><span id="l19.1360" class="difflineminus">-nsNntpIncomingServer::SetDelimiter(char aDelimiter)</span>
<a href="#l19.1361"></a><span id="l19.1361" class="difflineminus">-{</span>
<a href="#l19.1362"></a><span id="l19.1362" class="difflineplus">+nsNntpIncomingServer::SetDelimiter(char aDelimiter) {</span>
<a href="#l19.1363"></a><span id="l19.1363">   nsresult rv = EnsureInner();</span>
<a href="#l19.1364"></a><span id="l19.1364" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1365"></a><span id="l19.1365" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1366"></a><span id="l19.1366">   return mInner-&gt;SetDelimiter(aDelimiter);</span>
<a href="#l19.1367"></a><span id="l19.1367"> }</span>
<a href="#l19.1368"></a><span id="l19.1368"> </span>
<a href="#l19.1369"></a><span id="l19.1369"> NS_IMETHODIMP</span>
<a href="#l19.1370"></a><span id="l19.1370" class="difflineminus">-nsNntpIncomingServer::SetAsSubscribed(const nsACString &amp;path)</span>
<a href="#l19.1371"></a><span id="l19.1371" class="difflineminus">-{</span>
<a href="#l19.1372"></a><span id="l19.1372" class="difflineplus">+nsNntpIncomingServer::SetAsSubscribed(const nsACString &amp;path) {</span>
<a href="#l19.1373"></a><span id="l19.1373">   mTempSubscribed.AppendElement(path);</span>
<a href="#l19.1374"></a><span id="l19.1374" class="difflineminus">-  if (mGetOnlyNew &amp;&amp; (!mGroupsOnServer.Contains(path)))</span>
<a href="#l19.1375"></a><span id="l19.1375" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.1376"></a><span id="l19.1376" class="difflineplus">+  if (mGetOnlyNew &amp;&amp; (!mGroupsOnServer.Contains(path))) return NS_OK;</span>
<a href="#l19.1377"></a><span id="l19.1377"> </span>
<a href="#l19.1378"></a><span id="l19.1378">   nsresult rv = EnsureInner();</span>
<a href="#l19.1379"></a><span id="l19.1379" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1380"></a><span id="l19.1380" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1381"></a><span id="l19.1381">   return mInner-&gt;SetAsSubscribed(path);</span>
<a href="#l19.1382"></a><span id="l19.1382"> }</span>
<a href="#l19.1383"></a><span id="l19.1383"> </span>
<a href="#l19.1384"></a><span id="l19.1384"> NS_IMETHODIMP</span>
<a href="#l19.1385"></a><span id="l19.1385" class="difflineminus">-nsNntpIncomingServer::UpdateSubscribed()</span>
<a href="#l19.1386"></a><span id="l19.1386" class="difflineminus">-{</span>
<a href="#l19.1387"></a><span id="l19.1387" class="difflineplus">+nsNntpIncomingServer::UpdateSubscribed() {</span>
<a href="#l19.1388"></a><span id="l19.1388">   nsresult rv = EnsureInner();</span>
<a href="#l19.1389"></a><span id="l19.1389" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1390"></a><span id="l19.1390" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1391"></a><span id="l19.1391">   mTempSubscribed.Clear();</span>
<a href="#l19.1392"></a><span id="l19.1392">   uint32_t length = mSubscribedNewsgroups.Length();</span>
<a href="#l19.1393"></a><span id="l19.1393">   for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l19.1394"></a><span id="l19.1394">     SetAsSubscribed(mSubscribedNewsgroups[i]);</span>
<a href="#l19.1395"></a><span id="l19.1395">   return NS_OK;</span>
<a href="#l19.1396"></a><span id="l19.1396"> }</span>
<a href="#l19.1397"></a><span id="l19.1397"> </span>
<a href="#l19.1398"></a><span id="l19.1398"> NS_IMETHODIMP</span>
<a href="#l19.1399"></a><span id="l19.1399"> nsNntpIncomingServer::AddTo(const nsACString &amp;aName, bool addAsSubscribed,</span>
<a href="#l19.1400"></a><span id="l19.1400" class="difflineminus">-                            bool aSubscribable, bool changeIfExists)</span>
<a href="#l19.1401"></a><span id="l19.1401" class="difflineminus">-{</span>
<a href="#l19.1402"></a><span id="l19.1402" class="difflineplus">+                            bool aSubscribable, bool changeIfExists) {</span>
<a href="#l19.1403"></a><span id="l19.1403">   NS_ASSERTION(MsgIsUTF8(aName), &quot;Non-UTF-8 newsgroup name&quot;);</span>
<a href="#l19.1404"></a><span id="l19.1404">   nsresult rv = EnsureInner();</span>
<a href="#l19.1405"></a><span id="l19.1405" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1406"></a><span id="l19.1406" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1407"></a><span id="l19.1407"> </span>
<a href="#l19.1408"></a><span id="l19.1408">   rv = AddGroupOnServer(aName);</span>
<a href="#l19.1409"></a><span id="l19.1409" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1410"></a><span id="l19.1410" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1411"></a><span id="l19.1411"> </span>
<a href="#l19.1412"></a><span id="l19.1412">   rv = mInner-&gt;AddTo(aName, addAsSubscribed, aSubscribable, changeIfExists);</span>
<a href="#l19.1413"></a><span id="l19.1413" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1414"></a><span id="l19.1414" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1415"></a><span id="l19.1415"> </span>
<a href="#l19.1416"></a><span id="l19.1416">   return rv;</span>
<a href="#l19.1417"></a><span id="l19.1417"> }</span>
<a href="#l19.1418"></a><span id="l19.1418"> </span>
<a href="#l19.1419"></a><span id="l19.1419"> NS_IMETHODIMP</span>
<a href="#l19.1420"></a><span id="l19.1420" class="difflineminus">-nsNntpIncomingServer::StopPopulating(nsIMsgWindow *aMsgWindow)</span>
<a href="#l19.1421"></a><span id="l19.1421" class="difflineminus">-{</span>
<a href="#l19.1422"></a><span id="l19.1422" class="difflineplus">+nsNntpIncomingServer::StopPopulating(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l19.1423"></a><span id="l19.1423">   nsresult rv = NS_OK;</span>
<a href="#l19.1424"></a><span id="l19.1424"> </span>
<a href="#l19.1425"></a><span id="l19.1425">   rv = EnsureInner();</span>
<a href="#l19.1426"></a><span id="l19.1426" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1427"></a><span id="l19.1427" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1428"></a><span id="l19.1428">   rv = mInner-&gt;StopPopulating(aMsgWindow);</span>
<a href="#l19.1429"></a><span id="l19.1429" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1430"></a><span id="l19.1430" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1431"></a><span id="l19.1431"> </span>
<a href="#l19.1432"></a><span id="l19.1432" class="difflineminus">-  if (!mGetOnlyNew &amp;&amp; !mHostInfoLoaded)</span>
<a href="#l19.1433"></a><span id="l19.1433" class="difflineminus">-  {</span>
<a href="#l19.1434"></a><span id="l19.1434" class="difflineplus">+  if (!mGetOnlyNew &amp;&amp; !mHostInfoLoaded) {</span>
<a href="#l19.1435"></a><span id="l19.1435">     rv = WriteHostInfoFile();</span>
<a href="#l19.1436"></a><span id="l19.1436" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1437"></a><span id="l19.1437" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1438"></a><span id="l19.1438">   }</span>
<a href="#l19.1439"></a><span id="l19.1439"> </span>
<a href="#l19.1440"></a><span id="l19.1440">   // XXX TODO: when do I set this to null?</span>
<a href="#l19.1441"></a><span id="l19.1441">   // rv = ClearInner();</span>
<a href="#l19.1442"></a><span id="l19.1442">   // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1443"></a><span id="l19.1443">   return NS_OK;</span>
<a href="#l19.1444"></a><span id="l19.1444"> }</span>
<a href="#l19.1445"></a><span id="l19.1445"> </span>
<a href="#l19.1446"></a><span id="l19.1446"> NS_IMETHODIMP</span>
<a href="#l19.1447"></a><span id="l19.1447" class="difflineminus">-nsNntpIncomingServer::SetSubscribeListener(nsISubscribeListener *aListener)</span>
<a href="#l19.1448"></a><span id="l19.1448" class="difflineminus">-{</span>
<a href="#l19.1449"></a><span id="l19.1449" class="difflineplus">+nsNntpIncomingServer::SetSubscribeListener(nsISubscribeListener *aListener) {</span>
<a href="#l19.1450"></a><span id="l19.1450">   nsresult rv = EnsureInner();</span>
<a href="#l19.1451"></a><span id="l19.1451" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1452"></a><span id="l19.1452" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1453"></a><span id="l19.1453">   return mInner-&gt;SetSubscribeListener(aListener);</span>
<a href="#l19.1454"></a><span id="l19.1454"> }</span>
<a href="#l19.1455"></a><span id="l19.1455"> </span>
<a href="#l19.1456"></a><span id="l19.1456"> NS_IMETHODIMP</span>
<a href="#l19.1457"></a><span id="l19.1457" class="difflineminus">-nsNntpIncomingServer::GetSubscribeListener(nsISubscribeListener **aListener)</span>
<a href="#l19.1458"></a><span id="l19.1458" class="difflineminus">-{</span>
<a href="#l19.1459"></a><span id="l19.1459" class="difflineplus">+nsNntpIncomingServer::GetSubscribeListener(nsISubscribeListener **aListener) {</span>
<a href="#l19.1460"></a><span id="l19.1460">   nsresult rv = EnsureInner();</span>
<a href="#l19.1461"></a><span id="l19.1461" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1462"></a><span id="l19.1462" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1463"></a><span id="l19.1463">   return mInner-&gt;GetSubscribeListener(aListener);</span>
<a href="#l19.1464"></a><span id="l19.1464"> }</span>
<a href="#l19.1465"></a><span id="l19.1465"> </span>
<a href="#l19.1466"></a><span id="l19.1466"> NS_IMETHODIMP</span>
<a href="#l19.1467"></a><span id="l19.1467" class="difflineminus">-nsNntpIncomingServer::Subscribe(const char16_t *aUnicharName)</span>
<a href="#l19.1468"></a><span id="l19.1468" class="difflineminus">-{</span>
<a href="#l19.1469"></a><span id="l19.1469" class="difflineplus">+nsNntpIncomingServer::Subscribe(const char16_t *aUnicharName) {</span>
<a href="#l19.1470"></a><span id="l19.1470">   return SubscribeToNewsgroup(NS_ConvertUTF16toUTF8(aUnicharName));</span>
<a href="#l19.1471"></a><span id="l19.1471"> }</span>
<a href="#l19.1472"></a><span id="l19.1472"> </span>
<a href="#l19.1473"></a><span id="l19.1473"> NS_IMETHODIMP</span>
<a href="#l19.1474"></a><span id="l19.1474" class="difflineminus">-nsNntpIncomingServer::Unsubscribe(const char16_t *aUnicharName)</span>
<a href="#l19.1475"></a><span id="l19.1475" class="difflineminus">-{</span>
<a href="#l19.1476"></a><span id="l19.1476" class="difflineplus">+nsNntpIncomingServer::Unsubscribe(const char16_t *aUnicharName) {</span>
<a href="#l19.1477"></a><span id="l19.1477">   NS_ENSURE_ARG_POINTER(aUnicharName);</span>
<a href="#l19.1478"></a><span id="l19.1478"> </span>
<a href="#l19.1479"></a><span id="l19.1479">   nsresult rv;</span>
<a href="#l19.1480"></a><span id="l19.1480"> </span>
<a href="#l19.1481"></a><span id="l19.1481" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l19.1482"></a><span id="l19.1482" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l19.1483"></a><span id="l19.1483">   rv = GetRootMsgFolder(getter_AddRefs(serverFolder));</span>
<a href="#l19.1484"></a><span id="l19.1484" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.1485"></a><span id="l19.1485" class="difflineminus">-    return rv;</span>
<a href="#l19.1486"></a><span id="l19.1486" class="difflineminus">-  if (!serverFolder)</span>
<a href="#l19.1487"></a><span id="l19.1487" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l19.1488"></a><span id="l19.1488" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1489"></a><span id="l19.1489" class="difflineplus">+  if (!serverFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.1490"></a><span id="l19.1490"> </span>
<a href="#l19.1491"></a><span id="l19.1491">   nsCOMPtr&lt;nsIMsgFolder&gt; newsgroupFolder;</span>
<a href="#l19.1492"></a><span id="l19.1492">   rv = serverFolder-&gt;GetChildNamed(nsDependentString(aUnicharName),</span>
<a href="#l19.1493"></a><span id="l19.1493">                                    getter_AddRefs(newsgroupFolder));</span>
<a href="#l19.1494"></a><span id="l19.1494" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.1495"></a><span id="l19.1495" class="difflineminus">-    return rv;</span>
<a href="#l19.1496"></a><span id="l19.1496" class="difflineminus">-  if (!newsgroupFolder)</span>
<a href="#l19.1497"></a><span id="l19.1497" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l19.1498"></a><span id="l19.1498" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1499"></a><span id="l19.1499" class="difflineplus">+  if (!newsgroupFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.1500"></a><span id="l19.1500"> </span>
<a href="#l19.1501"></a><span id="l19.1501" class="difflineminus">-  rv = serverFolder-&gt;PropagateDelete(newsgroupFolder, true /* delete storage */, nullptr);</span>
<a href="#l19.1502"></a><span id="l19.1502" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.1503"></a><span id="l19.1503" class="difflineminus">-    return rv;</span>
<a href="#l19.1504"></a><span id="l19.1504" class="difflineplus">+  rv = serverFolder-&gt;PropagateDelete(newsgroupFolder, true /* delete storage */,</span>
<a href="#l19.1505"></a><span id="l19.1505" class="difflineplus">+                                     nullptr);</span>
<a href="#l19.1506"></a><span id="l19.1506" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1507"></a><span id="l19.1507"> </span>
<a href="#l19.1508"></a><span id="l19.1508">   // since we've unsubscribed to a newsgroup, the newsrc needs to be written out</span>
<a href="#l19.1509"></a><span id="l19.1509">   rv = SetNewsrcHasChanged(true);</span>
<a href="#l19.1510"></a><span id="l19.1510" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.1511"></a><span id="l19.1511" class="difflineminus">-    return rv;</span>
<a href="#l19.1512"></a><span id="l19.1512" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.1513"></a><span id="l19.1513"> </span>
<a href="#l19.1514"></a><span id="l19.1514">   return NS_OK;</span>
<a href="#l19.1515"></a><span id="l19.1515"> }</span>
<a href="#l19.1516"></a><span id="l19.1516"> </span>
<a href="#l19.1517"></a><span id="l19.1517" class="difflineminus">-nsresult</span>
<a href="#l19.1518"></a><span id="l19.1518" class="difflineminus">-nsNntpIncomingServer::HandleLine(const char* line, uint32_t line_size)</span>
<a href="#l19.1519"></a><span id="l19.1519" class="difflineminus">-{</span>
<a href="#l19.1520"></a><span id="l19.1520" class="difflineplus">+nsresult nsNntpIncomingServer::HandleLine(const char *line,</span>
<a href="#l19.1521"></a><span id="l19.1521" class="difflineplus">+                                          uint32_t line_size) {</span>
<a href="#l19.1522"></a><span id="l19.1522">   NS_ASSERTION(line, &quot;line is null&quot;);</span>
<a href="#l19.1523"></a><span id="l19.1523" class="difflineminus">-  if (!line)</span>
<a href="#l19.1524"></a><span id="l19.1524" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.1525"></a><span id="l19.1525" class="difflineplus">+  if (!line) return NS_OK;</span>
<a href="#l19.1526"></a><span id="l19.1526"> </span>
<a href="#l19.1527"></a><span id="l19.1527">   // skip blank lines and comments</span>
<a href="#l19.1528"></a><span id="l19.1528" class="difflineminus">-  if (line[0] == '#' || line[0] == '\0')</span>
<a href="#l19.1529"></a><span id="l19.1529" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.1530"></a><span id="l19.1530" class="difflineplus">+  if (line[0] == '#' || line[0] == '\0') return NS_OK;</span>
<a href="#l19.1531"></a><span id="l19.1531">   // XXX TODO: make this truly const, maybe pass in an nsCString &amp;</span>
<a href="#l19.1532"></a><span id="l19.1532"> </span>
<a href="#l19.1533"></a><span id="l19.1533">   if (mHasSeenBeginGroups) {</span>
<a href="#l19.1534"></a><span id="l19.1534">     // v1 hostinfo files had additional data fields delimited by commas.</span>
<a href="#l19.1535"></a><span id="l19.1535">     // with v2 hostinfo files, the additional data fields are removed.</span>
<a href="#l19.1536"></a><span id="l19.1536" class="difflineminus">-    char *commaPos = (char *) PL_strchr(line,',');</span>
<a href="#l19.1537"></a><span id="l19.1537" class="difflineplus">+    char *commaPos = (char *)PL_strchr(line, ',');</span>
<a href="#l19.1538"></a><span id="l19.1538">     if (commaPos) *commaPos = 0;</span>
<a href="#l19.1539"></a><span id="l19.1539"> </span>
<a href="#l19.1540"></a><span id="l19.1540" class="difflineminus">-        // newsrc entries are all in UTF-8</span>
<a href="#l19.1541"></a><span id="l19.1541" class="difflineplus">+      // newsrc entries are all in UTF-8</span>
<a href="#l19.1542"></a><span id="l19.1542"> #ifdef DEBUG_jungshik</span>
<a href="#l19.1543"></a><span id="l19.1543" class="difflineminus">-    NS_ASSERTION(MsgIsUTF8(nsDependentCString(line)), &quot;newsrc line is not utf-8&quot;);</span>
<a href="#l19.1544"></a><span id="l19.1544" class="difflineplus">+    NS_ASSERTION(MsgIsUTF8(nsDependentCString(line)),</span>
<a href="#l19.1545"></a><span id="l19.1545" class="difflineplus">+                 &quot;newsrc line is not utf-8&quot;);</span>
<a href="#l19.1546"></a><span id="l19.1546"> #endif</span>
<a href="#l19.1547"></a><span id="l19.1547">     nsresult rv = AddTo(nsDependentCString(line), false, true, true);</span>
<a href="#l19.1548"></a><span id="l19.1548" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to add line&quot;);</span>
<a href="#l19.1549"></a><span id="l19.1549" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to add line&quot;);</span>
<a href="#l19.1550"></a><span id="l19.1550">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.1551"></a><span id="l19.1551">       // since we've seen one group, we can claim we've loaded the</span>
<a href="#l19.1552"></a><span id="l19.1552">       // hostinfo file</span>
<a href="#l19.1553"></a><span id="l19.1553">       mHostInfoLoaded = true;</span>
<a href="#l19.1554"></a><span id="l19.1554">     }</span>
<a href="#l19.1555"></a><span id="l19.1555" class="difflineminus">-  }</span>
<a href="#l19.1556"></a><span id="l19.1556" class="difflineminus">-  else {</span>
<a href="#l19.1557"></a><span id="l19.1557" class="difflineminus">-    if (PL_strncmp(line,&quot;begingroups&quot;, 11) == 0) {</span>
<a href="#l19.1558"></a><span id="l19.1558" class="difflineplus">+  } else {</span>
<a href="#l19.1559"></a><span id="l19.1559" class="difflineplus">+    if (PL_strncmp(line, &quot;begingroups&quot;, 11) == 0) {</span>
<a href="#l19.1560"></a><span id="l19.1560">       mHasSeenBeginGroups = true;</span>
<a href="#l19.1561"></a><span id="l19.1561">     }</span>
<a href="#l19.1562"></a><span id="l19.1562" class="difflineminus">-    char*equalPos = (char *) PL_strchr(line, '=');</span>
<a href="#l19.1563"></a><span id="l19.1563" class="difflineplus">+    char *equalPos = (char *)PL_strchr(line, '=');</span>
<a href="#l19.1564"></a><span id="l19.1564">     if (equalPos) {</span>
<a href="#l19.1565"></a><span id="l19.1565">       *equalPos++ = '\0';</span>
<a href="#l19.1566"></a><span id="l19.1566">       if (PL_strcmp(line, &quot;lastgroupdate&quot;) == 0) {</span>
<a href="#l19.1567"></a><span id="l19.1567">         mLastUpdatedTime = strtoul(equalPos, nullptr, 10);</span>
<a href="#l19.1568"></a><span id="l19.1568">       } else if (PL_strcmp(line, &quot;uniqueid&quot;) == 0) {</span>
<a href="#l19.1569"></a><span id="l19.1569">         mUniqueId = strtol(equalPos, nullptr, 16);</span>
<a href="#l19.1570"></a><span id="l19.1570">       } else if (PL_strcmp(line, &quot;version&quot;) == 0) {</span>
<a href="#l19.1571"></a><span id="l19.1571">         mVersion = strtol(equalPos, nullptr, 16);</span>
<a href="#l19.1572"></a><span id="l19.1572">       }</span>
<a href="#l19.1573"></a><span id="l19.1573">     }</span>
<a href="#l19.1574"></a><span id="l19.1574">   }</span>
<a href="#l19.1575"></a><span id="l19.1575"> </span>
<a href="#l19.1576"></a><span id="l19.1576">   return NS_OK;</span>
<a href="#l19.1577"></a><span id="l19.1577"> }</span>
<a href="#l19.1578"></a><span id="l19.1578"> </span>
<a href="#l19.1579"></a><span id="l19.1579" class="difflineminus">-nsresult</span>
<a href="#l19.1580"></a><span id="l19.1580" class="difflineminus">-nsNntpIncomingServer::AddGroupOnServer(const nsACString &amp;aName)</span>
<a href="#l19.1581"></a><span id="l19.1581" class="difflineminus">-{</span>
<a href="#l19.1582"></a><span id="l19.1582" class="difflineplus">+nsresult nsNntpIncomingServer::AddGroupOnServer(const nsACString &amp;aName) {</span>
<a href="#l19.1583"></a><span id="l19.1583">   mGroupsOnServer.AppendElement(aName);</span>
<a href="#l19.1584"></a><span id="l19.1584">   return NS_OK;</span>
<a href="#l19.1585"></a><span id="l19.1585"> }</span>
<a href="#l19.1586"></a><span id="l19.1586"> </span>
<a href="#l19.1587"></a><span id="l19.1587"> NS_IMETHODIMP</span>
<a href="#l19.1588"></a><span id="l19.1588" class="difflineminus">-nsNntpIncomingServer::AddNewsgroup(const nsAString &amp;aName)</span>
<a href="#l19.1589"></a><span id="l19.1589" class="difflineminus">-{</span>
<a href="#l19.1590"></a><span id="l19.1590" class="difflineplus">+nsNntpIncomingServer::AddNewsgroup(const nsAString &amp;aName) {</span>
<a href="#l19.1591"></a><span id="l19.1591">   // handle duplicates?</span>
<a href="#l19.1592"></a><span id="l19.1592">   mSubscribedNewsgroups.AppendElement(NS_ConvertUTF16toUTF8(aName));</span>
<a href="#l19.1593"></a><span id="l19.1593">   return NS_OK;</span>
<a href="#l19.1594"></a><span id="l19.1594"> }</span>
<a href="#l19.1595"></a><span id="l19.1595"> </span>
<a href="#l19.1596"></a><span id="l19.1596"> NS_IMETHODIMP</span>
<a href="#l19.1597"></a><span id="l19.1597" class="difflineminus">-nsNntpIncomingServer::RemoveNewsgroup(const nsAString &amp;aName)</span>
<a href="#l19.1598"></a><span id="l19.1598" class="difflineminus">-{</span>
<a href="#l19.1599"></a><span id="l19.1599" class="difflineplus">+nsNntpIncomingServer::RemoveNewsgroup(const nsAString &amp;aName) {</span>
<a href="#l19.1600"></a><span id="l19.1600">   // handle duplicates?</span>
<a href="#l19.1601"></a><span id="l19.1601">   mSubscribedNewsgroups.RemoveElement(NS_ConvertUTF16toUTF8(aName));</span>
<a href="#l19.1602"></a><span id="l19.1602">   return NS_OK;</span>
<a href="#l19.1603"></a><span id="l19.1603"> }</span>
<a href="#l19.1604"></a><span id="l19.1604"> </span>
<a href="#l19.1605"></a><span id="l19.1605"> NS_IMETHODIMP</span>
<a href="#l19.1606"></a><span id="l19.1606"> nsNntpIncomingServer::SetState(const nsACString &amp;path, bool state,</span>
<a href="#l19.1607"></a><span id="l19.1607" class="difflineminus">-                               bool *stateChanged)</span>
<a href="#l19.1608"></a><span id="l19.1608" class="difflineminus">-{</span>
<a href="#l19.1609"></a><span id="l19.1609" class="difflineplus">+                               bool *stateChanged) {</span>
<a href="#l19.1610"></a><span id="l19.1610">   nsresult rv = EnsureInner();</span>
<a href="#l19.1611"></a><span id="l19.1611" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1612"></a><span id="l19.1612" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1613"></a><span id="l19.1613"> </span>
<a href="#l19.1614"></a><span id="l19.1614">   rv = mInner-&gt;SetState(path, state, stateChanged);</span>
<a href="#l19.1615"></a><span id="l19.1615">   if (*stateChanged) {</span>
<a href="#l19.1616"></a><span id="l19.1616">     if (state)</span>
<a href="#l19.1617"></a><span id="l19.1617">       mTempSubscribed.AppendElement(path);</span>
<a href="#l19.1618"></a><span id="l19.1618">     else</span>
<a href="#l19.1619"></a><span id="l19.1619">       mTempSubscribed.RemoveElement(path);</span>
<a href="#l19.1620"></a><span id="l19.1620">   }</span>
<a href="#l19.1621"></a><span id="l19.1621">   return rv;</span>
<a href="#l19.1622"></a><span id="l19.1622"> }</span>
<a href="#l19.1623"></a><span id="l19.1623"> </span>
<a href="#l19.1624"></a><span id="l19.1624"> NS_IMETHODIMP</span>
<a href="#l19.1625"></a><span id="l19.1625" class="difflineminus">-nsNntpIncomingServer::HasChildren(const nsACString &amp;path, bool *aHasChildren)</span>
<a href="#l19.1626"></a><span id="l19.1626" class="difflineminus">-{</span>
<a href="#l19.1627"></a><span id="l19.1627" class="difflineplus">+nsNntpIncomingServer::HasChildren(const nsACString &amp;path, bool *aHasChildren) {</span>
<a href="#l19.1628"></a><span id="l19.1628">   nsresult rv = EnsureInner();</span>
<a href="#l19.1629"></a><span id="l19.1629" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1630"></a><span id="l19.1630" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1631"></a><span id="l19.1631">   return mInner-&gt;HasChildren(path, aHasChildren);</span>
<a href="#l19.1632"></a><span id="l19.1632"> }</span>
<a href="#l19.1633"></a><span id="l19.1633"> </span>
<a href="#l19.1634"></a><span id="l19.1634"> NS_IMETHODIMP</span>
<a href="#l19.1635"></a><span id="l19.1635"> nsNntpIncomingServer::IsSubscribed(const nsACString &amp;path,</span>
<a href="#l19.1636"></a><span id="l19.1636" class="difflineminus">-                                   bool *aIsSubscribed)</span>
<a href="#l19.1637"></a><span id="l19.1637" class="difflineminus">-{</span>
<a href="#l19.1638"></a><span id="l19.1638" class="difflineplus">+                                   bool *aIsSubscribed) {</span>
<a href="#l19.1639"></a><span id="l19.1639">   nsresult rv = EnsureInner();</span>
<a href="#l19.1640"></a><span id="l19.1640" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1641"></a><span id="l19.1641" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1642"></a><span id="l19.1642">   return mInner-&gt;IsSubscribed(path, aIsSubscribed);</span>
<a href="#l19.1643"></a><span id="l19.1643"> }</span>
<a href="#l19.1644"></a><span id="l19.1644"> </span>
<a href="#l19.1645"></a><span id="l19.1645"> NS_IMETHODIMP</span>
<a href="#l19.1646"></a><span id="l19.1646"> nsNntpIncomingServer::IsSubscribable(const nsACString &amp;path,</span>
<a href="#l19.1647"></a><span id="l19.1647" class="difflineminus">-                                     bool *aIsSubscribable)</span>
<a href="#l19.1648"></a><span id="l19.1648" class="difflineminus">-{</span>
<a href="#l19.1649"></a><span id="l19.1649" class="difflineplus">+                                     bool *aIsSubscribable) {</span>
<a href="#l19.1650"></a><span id="l19.1650">   nsresult rv = EnsureInner();</span>
<a href="#l19.1651"></a><span id="l19.1651" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1652"></a><span id="l19.1652" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1653"></a><span id="l19.1653">   return mInner-&gt;IsSubscribable(path, aIsSubscribable);</span>
<a href="#l19.1654"></a><span id="l19.1654"> }</span>
<a href="#l19.1655"></a><span id="l19.1655"> </span>
<a href="#l19.1656"></a><span id="l19.1656"> NS_IMETHODIMP</span>
<a href="#l19.1657"></a><span id="l19.1657" class="difflineminus">-nsNntpIncomingServer::GetLeafName(const nsACString &amp;path, nsAString &amp;aLeafName)</span>
<a href="#l19.1658"></a><span id="l19.1658" class="difflineminus">-{</span>
<a href="#l19.1659"></a><span id="l19.1659" class="difflineplus">+nsNntpIncomingServer::GetLeafName(const nsACString &amp;path,</span>
<a href="#l19.1660"></a><span id="l19.1660" class="difflineplus">+                                  nsAString &amp;aLeafName) {</span>
<a href="#l19.1661"></a><span id="l19.1661">   nsresult rv = EnsureInner();</span>
<a href="#l19.1662"></a><span id="l19.1662" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1663"></a><span id="l19.1663" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1664"></a><span id="l19.1664">   return mInner-&gt;GetLeafName(path, aLeafName);</span>
<a href="#l19.1665"></a><span id="l19.1665"> }</span>
<a href="#l19.1666"></a><span id="l19.1666"> </span>
<a href="#l19.1667"></a><span id="l19.1667"> NS_IMETHODIMP</span>
<a href="#l19.1668"></a><span id="l19.1668" class="difflineminus">-nsNntpIncomingServer::GetFirstChildURI(const nsACString &amp;path, nsACString &amp;aResult)</span>
<a href="#l19.1669"></a><span id="l19.1669" class="difflineminus">-{</span>
<a href="#l19.1670"></a><span id="l19.1670" class="difflineplus">+nsNntpIncomingServer::GetFirstChildURI(const nsACString &amp;path,</span>
<a href="#l19.1671"></a><span id="l19.1671" class="difflineplus">+                                       nsACString &amp;aResult) {</span>
<a href="#l19.1672"></a><span id="l19.1672">   nsresult rv = EnsureInner();</span>
<a href="#l19.1673"></a><span id="l19.1673" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1674"></a><span id="l19.1674" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1675"></a><span id="l19.1675">   return mInner-&gt;GetFirstChildURI(path, aResult);</span>
<a href="#l19.1676"></a><span id="l19.1676"> }</span>
<a href="#l19.1677"></a><span id="l19.1677"> </span>
<a href="#l19.1678"></a><span id="l19.1678"> NS_IMETHODIMP</span>
<a href="#l19.1679"></a><span id="l19.1679"> nsNntpIncomingServer::GetChildURIs(const nsACString &amp;aPath,</span>
<a href="#l19.1680"></a><span id="l19.1680" class="difflineminus">-                                   nsIUTF8StringEnumerator **aResult)</span>
<a href="#l19.1681"></a><span id="l19.1681" class="difflineminus">-{</span>
<a href="#l19.1682"></a><span id="l19.1682" class="difflineplus">+                                   nsIUTF8StringEnumerator **aResult) {</span>
<a href="#l19.1683"></a><span id="l19.1683">   nsresult rv = EnsureInner();</span>
<a href="#l19.1684"></a><span id="l19.1684" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1685"></a><span id="l19.1685" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1686"></a><span id="l19.1686">   return mInner-&gt;GetChildURIs(aPath, aResult);</span>
<a href="#l19.1687"></a><span id="l19.1687"> }</span>
<a href="#l19.1688"></a><span id="l19.1688"> </span>
<a href="#l19.1689"></a><span id="l19.1689"> NS_IMETHODIMP</span>
<a href="#l19.1690"></a><span id="l19.1690" class="difflineminus">-nsNntpIncomingServer::CommitSubscribeChanges()</span>
<a href="#l19.1691"></a><span id="l19.1691" class="difflineminus">-{</span>
<a href="#l19.1692"></a><span id="l19.1692" class="difflineplus">+nsNntpIncomingServer::CommitSubscribeChanges() {</span>
<a href="#l19.1693"></a><span id="l19.1693">   // we force the newrc to be dirty, so it will get written out when</span>
<a href="#l19.1694"></a><span id="l19.1694">   // we call WriteNewsrcFile()</span>
<a href="#l19.1695"></a><span id="l19.1695">   nsresult rv = SetNewsrcHasChanged(true);</span>
<a href="#l19.1696"></a><span id="l19.1696" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1697"></a><span id="l19.1697" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1698"></a><span id="l19.1698">   return WriteNewsrcFile();</span>
<a href="#l19.1699"></a><span id="l19.1699"> }</span>
<a href="#l19.1700"></a><span id="l19.1700"> </span>
<a href="#l19.1701"></a><span id="l19.1701"> NS_IMETHODIMP</span>
<a href="#l19.1702"></a><span id="l19.1702" class="difflineminus">-nsNntpIncomingServer::ForgetPassword()</span>
<a href="#l19.1703"></a><span id="l19.1703" class="difflineminus">-{</span>
<a href="#l19.1704"></a><span id="l19.1704" class="difflineplus">+nsNntpIncomingServer::ForgetPassword() {</span>
<a href="#l19.1705"></a><span id="l19.1705">   // clear password of root folder (for the news account)</span>
<a href="#l19.1706"></a><span id="l19.1706">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l19.1707"></a><span id="l19.1707">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l19.1708"></a><span id="l19.1708" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1709"></a><span id="l19.1709" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1710"></a><span id="l19.1710">   if (!rootFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.1711"></a><span id="l19.1711"> </span>
<a href="#l19.1712"></a><span id="l19.1712" class="difflineminus">-  nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l19.1713"></a><span id="l19.1713" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1714"></a><span id="l19.1714" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l19.1715"></a><span id="l19.1715" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1716"></a><span id="l19.1716">   if (!newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.1717"></a><span id="l19.1717"> </span>
<a href="#l19.1718"></a><span id="l19.1718">   rv = newsFolder-&gt;ForgetAuthenticationCredentials();</span>
<a href="#l19.1719"></a><span id="l19.1719" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1720"></a><span id="l19.1720" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1721"></a><span id="l19.1721"> </span>
<a href="#l19.1722"></a><span id="l19.1722">   // clear password of all child folders</span>
<a href="#l19.1723"></a><span id="l19.1723">   nsCOMPtr&lt;nsISimpleEnumerator&gt; subFolders;</span>
<a href="#l19.1724"></a><span id="l19.1724"> </span>
<a href="#l19.1725"></a><span id="l19.1725">   rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(subFolders));</span>
<a href="#l19.1726"></a><span id="l19.1726" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1727"></a><span id="l19.1727" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1728"></a><span id="l19.1728"> </span>
<a href="#l19.1729"></a><span id="l19.1729">   bool moreFolders = false;</span>
<a href="#l19.1730"></a><span id="l19.1730"> </span>
<a href="#l19.1731"></a><span id="l19.1731">   nsresult return_rv = NS_OK;</span>
<a href="#l19.1732"></a><span id="l19.1732"> </span>
<a href="#l19.1733"></a><span id="l19.1733">   while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;moreFolders)) &amp;&amp;</span>
<a href="#l19.1734"></a><span id="l19.1734">          moreFolders) {</span>
<a href="#l19.1735"></a><span id="l19.1735">     nsCOMPtr&lt;nsISupports&gt; child;</span>
<a href="#l19.1736"></a><span id="l19.1736">     rv = subFolders-&gt;GetNext(getter_AddRefs(child));</span>
<a href="#l19.1737"></a><span id="l19.1737">     if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l19.1738"></a><span id="l19.1738">       newsFolder = do_QueryInterface(child, &amp;rv);</span>
<a href="#l19.1739"></a><span id="l19.1739">       if (NS_SUCCEEDED(rv) &amp;&amp; newsFolder) {</span>
<a href="#l19.1740"></a><span id="l19.1740">         rv = newsFolder-&gt;ForgetAuthenticationCredentials();</span>
<a href="#l19.1741"></a><span id="l19.1741" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l19.1742"></a><span id="l19.1742" class="difflineminus">-          return_rv = rv;</span>
<a href="#l19.1743"></a><span id="l19.1743" class="difflineminus">-      }</span>
<a href="#l19.1744"></a><span id="l19.1744" class="difflineminus">-      else {</span>
<a href="#l19.1745"></a><span id="l19.1745" class="difflineplus">+        if (NS_FAILED(rv)) return_rv = rv;</span>
<a href="#l19.1746"></a><span id="l19.1746" class="difflineplus">+      } else {</span>
<a href="#l19.1747"></a><span id="l19.1747">         return_rv = NS_ERROR_FAILURE;</span>
<a href="#l19.1748"></a><span id="l19.1748">       }</span>
<a href="#l19.1749"></a><span id="l19.1749">     }</span>
<a href="#l19.1750"></a><span id="l19.1750">   }</span>
<a href="#l19.1751"></a><span id="l19.1751"> </span>
<a href="#l19.1752"></a><span id="l19.1752">   return return_rv;</span>
<a href="#l19.1753"></a><span id="l19.1753"> }</span>
<a href="#l19.1754"></a><span id="l19.1754"> </span>
<a href="#l19.1755"></a><span id="l19.1755"> NS_IMETHODIMP</span>
<a href="#l19.1756"></a><span id="l19.1756" class="difflineminus">-nsNntpIncomingServer::GetSupportsExtensions(bool *aSupportsExtensions)</span>
<a href="#l19.1757"></a><span id="l19.1757" class="difflineminus">-{</span>
<a href="#l19.1758"></a><span id="l19.1758" class="difflineplus">+nsNntpIncomingServer::GetSupportsExtensions(bool *aSupportsExtensions) {</span>
<a href="#l19.1759"></a><span id="l19.1759">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1760"></a><span id="l19.1760"> }</span>
<a href="#l19.1761"></a><span id="l19.1761"> </span>
<a href="#l19.1762"></a><span id="l19.1762"> NS_IMETHODIMP</span>
<a href="#l19.1763"></a><span id="l19.1763" class="difflineminus">-nsNntpIncomingServer::SetSupportsExtensions(bool aSupportsExtensions)</span>
<a href="#l19.1764"></a><span id="l19.1764" class="difflineminus">-{</span>
<a href="#l19.1765"></a><span id="l19.1765" class="difflineplus">+nsNntpIncomingServer::SetSupportsExtensions(bool aSupportsExtensions) {</span>
<a href="#l19.1766"></a><span id="l19.1766">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1767"></a><span id="l19.1767"> }</span>
<a href="#l19.1768"></a><span id="l19.1768"> </span>
<a href="#l19.1769"></a><span id="l19.1769"> NS_IMETHODIMP</span>
<a href="#l19.1770"></a><span id="l19.1770" class="difflineminus">-nsNntpIncomingServer::AddExtension(const char *extension)</span>
<a href="#l19.1771"></a><span id="l19.1771" class="difflineminus">-{</span>
<a href="#l19.1772"></a><span id="l19.1772" class="difflineplus">+nsNntpIncomingServer::AddExtension(const char *extension) {</span>
<a href="#l19.1773"></a><span id="l19.1773">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1774"></a><span id="l19.1774"> }</span>
<a href="#l19.1775"></a><span id="l19.1775"> </span>
<a href="#l19.1776"></a><span id="l19.1776"> NS_IMETHODIMP</span>
<a href="#l19.1777"></a><span id="l19.1777" class="difflineminus">-nsNntpIncomingServer::QueryExtension(const char *extension, bool *result)</span>
<a href="#l19.1778"></a><span id="l19.1778" class="difflineminus">-{</span>
<a href="#l19.1779"></a><span id="l19.1779" class="difflineplus">+nsNntpIncomingServer::QueryExtension(const char *extension, bool *result) {</span>
<a href="#l19.1780"></a><span id="l19.1780"> #ifdef DEBUG_seth</span>
<a href="#l19.1781"></a><span id="l19.1781">   printf(&quot;no extension support yet\n&quot;);</span>
<a href="#l19.1782"></a><span id="l19.1782"> #endif</span>
<a href="#l19.1783"></a><span id="l19.1783">   *result = false;</span>
<a href="#l19.1784"></a><span id="l19.1784">   return NS_OK;</span>
<a href="#l19.1785"></a><span id="l19.1785"> }</span>
<a href="#l19.1786"></a><span id="l19.1786"> </span>
<a href="#l19.1787"></a><span id="l19.1787"> NS_IMETHODIMP</span>
<a href="#l19.1788"></a><span id="l19.1788" class="difflineminus">-nsNntpIncomingServer::GetPostingAllowed(bool *aPostingAllowed)</span>
<a href="#l19.1789"></a><span id="l19.1789" class="difflineminus">-{</span>
<a href="#l19.1790"></a><span id="l19.1790" class="difflineplus">+nsNntpIncomingServer::GetPostingAllowed(bool *aPostingAllowed) {</span>
<a href="#l19.1791"></a><span id="l19.1791">   *aPostingAllowed = mPostingAllowed;</span>
<a href="#l19.1792"></a><span id="l19.1792">   return NS_OK;</span>
<a href="#l19.1793"></a><span id="l19.1793"> }</span>
<a href="#l19.1794"></a><span id="l19.1794"> </span>
<a href="#l19.1795"></a><span id="l19.1795"> NS_IMETHODIMP</span>
<a href="#l19.1796"></a><span id="l19.1796" class="difflineminus">-nsNntpIncomingServer::SetPostingAllowed(bool aPostingAllowed)</span>
<a href="#l19.1797"></a><span id="l19.1797" class="difflineminus">-{</span>
<a href="#l19.1798"></a><span id="l19.1798" class="difflineplus">+nsNntpIncomingServer::SetPostingAllowed(bool aPostingAllowed) {</span>
<a href="#l19.1799"></a><span id="l19.1799">   mPostingAllowed = aPostingAllowed;</span>
<a href="#l19.1800"></a><span id="l19.1800">   return NS_OK;</span>
<a href="#l19.1801"></a><span id="l19.1801"> }</span>
<a href="#l19.1802"></a><span id="l19.1802"> </span>
<a href="#l19.1803"></a><span id="l19.1803"> NS_IMETHODIMP</span>
<a href="#l19.1804"></a><span id="l19.1804" class="difflineminus">-nsNntpIncomingServer::GetLastUpdatedTime(uint32_t *aLastUpdatedTime)</span>
<a href="#l19.1805"></a><span id="l19.1805" class="difflineminus">-{</span>
<a href="#l19.1806"></a><span id="l19.1806" class="difflineplus">+nsNntpIncomingServer::GetLastUpdatedTime(uint32_t *aLastUpdatedTime) {</span>
<a href="#l19.1807"></a><span id="l19.1807">   *aLastUpdatedTime = mLastUpdatedTime;</span>
<a href="#l19.1808"></a><span id="l19.1808">   return NS_OK;</span>
<a href="#l19.1809"></a><span id="l19.1809"> }</span>
<a href="#l19.1810"></a><span id="l19.1810"> </span>
<a href="#l19.1811"></a><span id="l19.1811"> NS_IMETHODIMP</span>
<a href="#l19.1812"></a><span id="l19.1812" class="difflineminus">-nsNntpIncomingServer::SetLastUpdatedTime(uint32_t aLastUpdatedTime)</span>
<a href="#l19.1813"></a><span id="l19.1813" class="difflineminus">-{</span>
<a href="#l19.1814"></a><span id="l19.1814" class="difflineplus">+nsNntpIncomingServer::SetLastUpdatedTime(uint32_t aLastUpdatedTime) {</span>
<a href="#l19.1815"></a><span id="l19.1815">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1816"></a><span id="l19.1816"> }</span>
<a href="#l19.1817"></a><span id="l19.1817"> </span>
<a href="#l19.1818"></a><span id="l19.1818"> NS_IMETHODIMP</span>
<a href="#l19.1819"></a><span id="l19.1819" class="difflineminus">-nsNntpIncomingServer::AddPropertyForGet(const char *name, const char *value)</span>
<a href="#l19.1820"></a><span id="l19.1820" class="difflineminus">-{</span>
<a href="#l19.1821"></a><span id="l19.1821" class="difflineplus">+nsNntpIncomingServer::AddPropertyForGet(const char *name, const char *value) {</span>
<a href="#l19.1822"></a><span id="l19.1822">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1823"></a><span id="l19.1823"> }</span>
<a href="#l19.1824"></a><span id="l19.1824"> </span>
<a href="#l19.1825"></a><span id="l19.1825"> NS_IMETHODIMP</span>
<a href="#l19.1826"></a><span id="l19.1826" class="difflineminus">-nsNntpIncomingServer::QueryPropertyForGet(const char *name, char **value)</span>
<a href="#l19.1827"></a><span id="l19.1827" class="difflineminus">-{</span>
<a href="#l19.1828"></a><span id="l19.1828" class="difflineplus">+nsNntpIncomingServer::QueryPropertyForGet(const char *name, char **value) {</span>
<a href="#l19.1829"></a><span id="l19.1829">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1830"></a><span id="l19.1830"> }</span>
<a href="#l19.1831"></a><span id="l19.1831"> </span>
<a href="#l19.1832"></a><span id="l19.1832"> NS_IMETHODIMP</span>
<a href="#l19.1833"></a><span id="l19.1833" class="difflineminus">-nsNntpIncomingServer::AddSearchableGroup(const nsAString &amp;name)</span>
<a href="#l19.1834"></a><span id="l19.1834" class="difflineminus">-{</span>
<a href="#l19.1835"></a><span id="l19.1835" class="difflineplus">+nsNntpIncomingServer::AddSearchableGroup(const nsAString &amp;name) {</span>
<a href="#l19.1836"></a><span id="l19.1836">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1837"></a><span id="l19.1837"> }</span>
<a href="#l19.1838"></a><span id="l19.1838"> </span>
<a href="#l19.1839"></a><span id="l19.1839"> NS_IMETHODIMP</span>
<a href="#l19.1840"></a><span id="l19.1840" class="difflineminus">-nsNntpIncomingServer::QuerySearchableGroup(const nsAString &amp;name, bool *result)</span>
<a href="#l19.1841"></a><span id="l19.1841" class="difflineminus">-{</span>
<a href="#l19.1842"></a><span id="l19.1842" class="difflineplus">+nsNntpIncomingServer::QuerySearchableGroup(const nsAString &amp;name,</span>
<a href="#l19.1843"></a><span id="l19.1843" class="difflineplus">+                                           bool *result) {</span>
<a href="#l19.1844"></a><span id="l19.1844">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1845"></a><span id="l19.1845"> }</span>
<a href="#l19.1846"></a><span id="l19.1846"> </span>
<a href="#l19.1847"></a><span id="l19.1847"> NS_IMETHODIMP</span>
<a href="#l19.1848"></a><span id="l19.1848" class="difflineminus">-nsNntpIncomingServer::AddSearchableHeader(const char *name)</span>
<a href="#l19.1849"></a><span id="l19.1849" class="difflineminus">-{</span>
<a href="#l19.1850"></a><span id="l19.1850" class="difflineplus">+nsNntpIncomingServer::AddSearchableHeader(const char *name) {</span>
<a href="#l19.1851"></a><span id="l19.1851">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1852"></a><span id="l19.1852"> }</span>
<a href="#l19.1853"></a><span id="l19.1853"> </span>
<a href="#l19.1854"></a><span id="l19.1854"> NS_IMETHODIMP</span>
<a href="#l19.1855"></a><span id="l19.1855" class="difflineminus">-nsNntpIncomingServer::QuerySearchableHeader(const char *name, bool *result)</span>
<a href="#l19.1856"></a><span id="l19.1856" class="difflineminus">-{</span>
<a href="#l19.1857"></a><span id="l19.1857" class="difflineplus">+nsNntpIncomingServer::QuerySearchableHeader(const char *name, bool *result) {</span>
<a href="#l19.1858"></a><span id="l19.1858">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1859"></a><span id="l19.1859"> }</span>
<a href="#l19.1860"></a><span id="l19.1860"> </span>
<a href="#l19.1861"></a><span id="l19.1861"> NS_IMETHODIMP</span>
<a href="#l19.1862"></a><span id="l19.1862" class="difflineminus">-nsNntpIncomingServer::FindGroup(const nsACString &amp;name, nsIMsgNewsFolder **result)</span>
<a href="#l19.1863"></a><span id="l19.1863" class="difflineminus">-{</span>
<a href="#l19.1864"></a><span id="l19.1864" class="difflineplus">+nsNntpIncomingServer::FindGroup(const nsACString &amp;name,</span>
<a href="#l19.1865"></a><span id="l19.1865" class="difflineplus">+                                nsIMsgNewsFolder **result) {</span>
<a href="#l19.1866"></a><span id="l19.1866">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l19.1867"></a><span id="l19.1867"> </span>
<a href="#l19.1868"></a><span id="l19.1868">   nsresult rv;</span>
<a href="#l19.1869"></a><span id="l19.1869" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l19.1870"></a><span id="l19.1870" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l19.1871"></a><span id="l19.1871">   rv = GetRootMsgFolder(getter_AddRefs(serverFolder));</span>
<a href="#l19.1872"></a><span id="l19.1872" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1873"></a><span id="l19.1873" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1874"></a><span id="l19.1874"> </span>
<a href="#l19.1875"></a><span id="l19.1875">   if (!serverFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.1876"></a><span id="l19.1876"> </span>
<a href="#l19.1877"></a><span id="l19.1877">   // Escape the name for using FindSubFolder</span>
<a href="#l19.1878"></a><span id="l19.1878">   nsAutoCString escapedName;</span>
<a href="#l19.1879"></a><span id="l19.1879">   rv = MsgEscapeString(name, nsINetUtil::ESCAPE_URL_PATH, escapedName);</span>
<a href="#l19.1880"></a><span id="l19.1880">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1881"></a><span id="l19.1881"> </span>
<a href="#l19.1882"></a><span id="l19.1882" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; subFolder;</span>
<a href="#l19.1883"></a><span id="l19.1883" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; subFolder;</span>
<a href="#l19.1884"></a><span id="l19.1884">   rv = serverFolder-&gt;FindSubFolder(escapedName, getter_AddRefs(subFolder));</span>
<a href="#l19.1885"></a><span id="l19.1885" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1886"></a><span id="l19.1886" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1887"></a><span id="l19.1887">   if (!subFolder) return NS_ERROR_FAILURE;</span>
<a href="#l19.1888"></a><span id="l19.1888"> </span>
<a href="#l19.1889"></a><span id="l19.1889" class="difflineminus">-  rv = subFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgNewsFolder), (void**)result);</span>
<a href="#l19.1890"></a><span id="l19.1890" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1891"></a><span id="l19.1891" class="difflineplus">+  rv = subFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgNewsFolder), (void **)result);</span>
<a href="#l19.1892"></a><span id="l19.1892" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1893"></a><span id="l19.1893">   if (!*result) return NS_ERROR_FAILURE;</span>
<a href="#l19.1894"></a><span id="l19.1894">   return NS_OK;</span>
<a href="#l19.1895"></a><span id="l19.1895"> }</span>
<a href="#l19.1896"></a><span id="l19.1896"> </span>
<a href="#l19.1897"></a><span id="l19.1897"> NS_IMETHODIMP</span>
<a href="#l19.1898"></a><span id="l19.1898" class="difflineminus">-nsNntpIncomingServer::GetFirstGroupNeedingExtraInfo(nsACString &amp;result)</span>
<a href="#l19.1899"></a><span id="l19.1899" class="difflineminus">-{</span>
<a href="#l19.1900"></a><span id="l19.1900" class="difflineplus">+nsNntpIncomingServer::GetFirstGroupNeedingExtraInfo(nsACString &amp;result) {</span>
<a href="#l19.1901"></a><span id="l19.1901">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1902"></a><span id="l19.1902"> }</span>
<a href="#l19.1903"></a><span id="l19.1903"> </span>
<a href="#l19.1904"></a><span id="l19.1904"> NS_IMETHODIMP</span>
<a href="#l19.1905"></a><span id="l19.1905"> nsNntpIncomingServer::SetGroupNeedsExtraInfo(const nsACString &amp;name,</span>
<a href="#l19.1906"></a><span id="l19.1906" class="difflineminus">-                                             bool needsExtraInfo)</span>
<a href="#l19.1907"></a><span id="l19.1907" class="difflineminus">-{</span>
<a href="#l19.1908"></a><span id="l19.1908" class="difflineplus">+                                             bool needsExtraInfo) {</span>
<a href="#l19.1909"></a><span id="l19.1909">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1910"></a><span id="l19.1910"> }</span>
<a href="#l19.1911"></a><span id="l19.1911"> </span>
<a href="#l19.1912"></a><span id="l19.1912"> NS_IMETHODIMP</span>
<a href="#l19.1913"></a><span id="l19.1913"> nsNntpIncomingServer::GroupNotFound(nsIMsgWindow *aMsgWindow,</span>
<a href="#l19.1914"></a><span id="l19.1914" class="difflineminus">-                                    const nsAString &amp;aName, bool aOpening)</span>
<a href="#l19.1915"></a><span id="l19.1915" class="difflineminus">-{</span>
<a href="#l19.1916"></a><span id="l19.1916" class="difflineplus">+                                    const nsAString &amp;aName, bool aOpening) {</span>
<a href="#l19.1917"></a><span id="l19.1917">   nsresult rv;</span>
<a href="#l19.1918"></a><span id="l19.1918" class="difflineminus">-  nsCOMPtr &lt;nsIPrompt&gt; prompt;</span>
<a href="#l19.1919"></a><span id="l19.1919" class="difflineplus">+  nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l19.1920"></a><span id="l19.1920"> </span>
<a href="#l19.1921"></a><span id="l19.1921">   if (aMsgWindow) {</span>
<a href="#l19.1922"></a><span id="l19.1922">     rv = aMsgWindow-&gt;GetPromptDialog(getter_AddRefs(prompt));</span>
<a href="#l19.1923"></a><span id="l19.1923">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;no prompt from the msg window&quot;);</span>
<a href="#l19.1924"></a><span id="l19.1924">   }</span>
<a href="#l19.1925"></a><span id="l19.1925"> </span>
<a href="#l19.1926"></a><span id="l19.1926">   if (!prompt) {</span>
<a href="#l19.1927"></a><span id="l19.1927" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l19.1928"></a><span id="l19.1928" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l19.1929"></a><span id="l19.1929" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l19.1930"></a><span id="l19.1930">     rv = wwatch-&gt;GetNewPrompter(nullptr, getter_AddRefs(prompt));</span>
<a href="#l19.1931"></a><span id="l19.1931" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1932"></a><span id="l19.1932" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1933"></a><span id="l19.1933">   }</span>
<a href="#l19.1934"></a><span id="l19.1934"> </span>
<a href="#l19.1935"></a><span id="l19.1935" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l19.1936"></a><span id="l19.1936" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l19.1937"></a><span id="l19.1937" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l19.1938"></a><span id="l19.1938" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l19.1939"></a><span id="l19.1939">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l19.1940"></a><span id="l19.1940"> </span>
<a href="#l19.1941"></a><span id="l19.1941" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.1942"></a><span id="l19.1942" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.1943"></a><span id="l19.1943">   rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l19.1944"></a><span id="l19.1944" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1945"></a><span id="l19.1945" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1946"></a><span id="l19.1946"> </span>
<a href="#l19.1947"></a><span id="l19.1947">   nsCString hostname;</span>
<a href="#l19.1948"></a><span id="l19.1948">   rv = GetRealHostName(hostname);</span>
<a href="#l19.1949"></a><span id="l19.1949" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1950"></a><span id="l19.1950" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1951"></a><span id="l19.1951"> </span>
<a href="#l19.1952"></a><span id="l19.1952">   NS_ConvertUTF8toUTF16 hostStr(hostname);</span>
<a href="#l19.1953"></a><span id="l19.1953"> </span>
<a href="#l19.1954"></a><span id="l19.1954">   nsString groupName(aName);</span>
<a href="#l19.1955"></a><span id="l19.1955" class="difflineminus">-  const char16_t *formatStrings[2] = { groupName.get(), hostStr.get() };</span>
<a href="#l19.1956"></a><span id="l19.1956" class="difflineplus">+  const char16_t *formatStrings[2] = {groupName.get(), hostStr.get()};</span>
<a href="#l19.1957"></a><span id="l19.1957">   nsString confirmText;</span>
<a href="#l19.1958"></a><span id="l19.1958" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l19.1959"></a><span id="l19.1959" class="difflineminus">-                    &quot;autoUnsubscribeText&quot;,</span>
<a href="#l19.1960"></a><span id="l19.1960" class="difflineminus">-                    formatStrings, 2,</span>
<a href="#l19.1961"></a><span id="l19.1961" class="difflineminus">-                    confirmText);</span>
<a href="#l19.1962"></a><span id="l19.1962" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1963"></a><span id="l19.1963" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(&quot;autoUnsubscribeText&quot;, formatStrings, 2,</span>
<a href="#l19.1964"></a><span id="l19.1964" class="difflineplus">+                                    confirmText);</span>
<a href="#l19.1965"></a><span id="l19.1965" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1966"></a><span id="l19.1966"> </span>
<a href="#l19.1967"></a><span id="l19.1967">   bool confirmResult = false;</span>
<a href="#l19.1968"></a><span id="l19.1968">   rv = prompt-&gt;Confirm(nullptr, confirmText.get(), &amp;confirmResult);</span>
<a href="#l19.1969"></a><span id="l19.1969" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1970"></a><span id="l19.1970" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1971"></a><span id="l19.1971"> </span>
<a href="#l19.1972"></a><span id="l19.1972">   if (confirmResult) {</span>
<a href="#l19.1973"></a><span id="l19.1973">     rv = Unsubscribe(groupName.get());</span>
<a href="#l19.1974"></a><span id="l19.1974" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.1975"></a><span id="l19.1975" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1976"></a><span id="l19.1976">   }</span>
<a href="#l19.1977"></a><span id="l19.1977"> </span>
<a href="#l19.1978"></a><span id="l19.1978">   return rv;</span>
<a href="#l19.1979"></a><span id="l19.1979"> }</span>
<a href="#l19.1980"></a><span id="l19.1980"> </span>
<a href="#l19.1981"></a><span id="l19.1981"> NS_IMETHODIMP</span>
<a href="#l19.1982"></a><span id="l19.1982"> nsNntpIncomingServer::SetPrettyNameForGroup(const nsAString &amp;name,</span>
<a href="#l19.1983"></a><span id="l19.1983" class="difflineminus">-                                            const nsAString &amp;prettyName)</span>
<a href="#l19.1984"></a><span id="l19.1984" class="difflineminus">-{</span>
<a href="#l19.1985"></a><span id="l19.1985" class="difflineplus">+                                            const nsAString &amp;prettyName) {</span>
<a href="#l19.1986"></a><span id="l19.1986">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.1987"></a><span id="l19.1987"> }</span>
<a href="#l19.1988"></a><span id="l19.1988"> </span>
<a href="#l19.1989"></a><span id="l19.1989"> NS_IMETHODIMP</span>
<a href="#l19.1990"></a><span id="l19.1990" class="difflineminus">-nsNntpIncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l19.1991"></a><span id="l19.1991" class="difflineminus">-{</span>
<a href="#l19.1992"></a><span id="l19.1992" class="difflineplus">+nsNntpIncomingServer::GetCanSearchMessages(bool *canSearchMessages) {</span>
<a href="#l19.1993"></a><span id="l19.1993">   NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l19.1994"></a><span id="l19.1994">   *canSearchMessages = true;</span>
<a href="#l19.1995"></a><span id="l19.1995">   return NS_OK;</span>
<a href="#l19.1996"></a><span id="l19.1996"> }</span>
<a href="#l19.1997"></a><span id="l19.1997"> </span>
<a href="#l19.1998"></a><span id="l19.1998"> NS_IMETHODIMP</span>
<a href="#l19.1999"></a><span id="l19.1999" class="difflineminus">-nsNntpIncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel)</span>
<a href="#l19.2000"></a><span id="l19.2000" class="difflineminus">-{</span>
<a href="#l19.2001"></a><span id="l19.2001" class="difflineplus">+nsNntpIncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel) {</span>
<a href="#l19.2002"></a><span id="l19.2002">   NS_ENSURE_ARG_POINTER(aSupportLevel);</span>
<a href="#l19.2003"></a><span id="l19.2003">   nsresult rv;</span>
<a href="#l19.2004"></a><span id="l19.2004"> </span>
<a href="#l19.2005"></a><span id="l19.2005">   rv = GetIntValue(&quot;offline_support_level&quot;, aSupportLevel);</span>
<a href="#l19.2006"></a><span id="l19.2006">   if (*aSupportLevel != OFFLINE_SUPPORT_LEVEL_UNDEFINED) return rv;</span>
<a href="#l19.2007"></a><span id="l19.2007"> </span>
<a href="#l19.2008"></a><span id="l19.2008">   // set default value</span>
<a href="#l19.2009"></a><span id="l19.2009">   *aSupportLevel = OFFLINE_SUPPORT_LEVEL_EXTENDED;</span>
<a href="#l19.2010"></a><span id="l19.2010">   return NS_OK;</span>
<a href="#l19.2011"></a><span id="l19.2011"> }</span>
<a href="#l19.2012"></a><span id="l19.2012"> </span>
<a href="#l19.2013"></a><span id="l19.2013"> NS_IMETHODIMP</span>
<a href="#l19.2014"></a><span id="l19.2014" class="difflineminus">-nsNntpIncomingServer::GetDefaultCopiesAndFoldersPrefsToServer(bool *aCopiesAndFoldersOnServer)</span>
<a href="#l19.2015"></a><span id="l19.2015" class="difflineminus">-{</span>
<a href="#l19.2016"></a><span id="l19.2016" class="difflineplus">+nsNntpIncomingServer::GetDefaultCopiesAndFoldersPrefsToServer(</span>
<a href="#l19.2017"></a><span id="l19.2017" class="difflineplus">+    bool *aCopiesAndFoldersOnServer) {</span>
<a href="#l19.2018"></a><span id="l19.2018">   NS_ENSURE_ARG_POINTER(aCopiesAndFoldersOnServer);</span>
<a href="#l19.2019"></a><span id="l19.2019"> </span>
<a href="#l19.2020"></a><span id="l19.2020">   /**</span>
<a href="#l19.2021"></a><span id="l19.2021">    * When a news account is created, the copies and folder prefs for the</span>
<a href="#l19.2022"></a><span id="l19.2022">    * associated identity don't point to folders on the server.</span>
<a href="#l19.2023"></a><span id="l19.2023">    * This makes sense, since there is no &quot;Drafts&quot; folder on a news server.</span>
<a href="#l19.2024"></a><span id="l19.2024">    * They'll point to the ones on &quot;Local Folders&quot;</span>
<a href="#l19.2025"></a><span id="l19.2025">    */</span>
<a href="#l19.2026"></a><span id="l19.2026"> </span>
<a href="#l19.2027"></a><span id="l19.2027">   *aCopiesAndFoldersOnServer = false;</span>
<a href="#l19.2028"></a><span id="l19.2028">   return NS_OK;</span>
<a href="#l19.2029"></a><span id="l19.2029"> }</span>
<a href="#l19.2030"></a><span id="l19.2030"> </span>
<a href="#l19.2031"></a><span id="l19.2031"> NS_IMETHODIMP</span>
<a href="#l19.2032"></a><span id="l19.2032" class="difflineminus">-nsNntpIncomingServer::GetCanCreateFoldersOnServer(bool *aCanCreateFoldersOnServer)</span>
<a href="#l19.2033"></a><span id="l19.2033" class="difflineminus">-{</span>
<a href="#l19.2034"></a><span id="l19.2034" class="difflineplus">+nsNntpIncomingServer::GetCanCreateFoldersOnServer(</span>
<a href="#l19.2035"></a><span id="l19.2035" class="difflineplus">+    bool *aCanCreateFoldersOnServer) {</span>
<a href="#l19.2036"></a><span id="l19.2036">   NS_ENSURE_ARG_POINTER(aCanCreateFoldersOnServer);</span>
<a href="#l19.2037"></a><span id="l19.2037"> </span>
<a href="#l19.2038"></a><span id="l19.2038">   // No folder creation on news servers. Return false.</span>
<a href="#l19.2039"></a><span id="l19.2039">   *aCanCreateFoldersOnServer = false;</span>
<a href="#l19.2040"></a><span id="l19.2040">   return NS_OK;</span>
<a href="#l19.2041"></a><span id="l19.2041"> }</span>
<a href="#l19.2042"></a><span id="l19.2042"> </span>
<a href="#l19.2043"></a><span id="l19.2043"> NS_IMETHODIMP</span>
<a href="#l19.2044"></a><span id="l19.2044" class="difflineminus">-nsNntpIncomingServer::SetSearchValue(const nsAString &amp;aSearchValue)</span>
<a href="#l19.2045"></a><span id="l19.2045" class="difflineminus">-{</span>
<a href="#l19.2046"></a><span id="l19.2046" class="difflineplus">+nsNntpIncomingServer::SetSearchValue(const nsAString &amp;aSearchValue) {</span>
<a href="#l19.2047"></a><span id="l19.2047">   nsCString searchValue = NS_ConvertUTF16toUTF8(aSearchValue);</span>
<a href="#l19.2048"></a><span id="l19.2048">   MsgCompressWhitespace(searchValue);</span>
<a href="#l19.2049"></a><span id="l19.2049"> </span>
<a href="#l19.2050"></a><span id="l19.2050">   if (mTree) {</span>
<a href="#l19.2051"></a><span id="l19.2051">     mTree-&gt;BeginUpdateBatch();</span>
<a href="#l19.2052"></a><span id="l19.2052" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -static_cast&lt;int32_t&gt;(mSubscribeSearchResult.Length()));</span>
<a href="#l19.2053"></a><span id="l19.2053" class="difflineplus">+    mTree-&gt;RowCountChanged(</span>
<a href="#l19.2054"></a><span id="l19.2054" class="difflineplus">+        0, -static_cast&lt;int32_t&gt;(mSubscribeSearchResult.Length()));</span>
<a href="#l19.2055"></a><span id="l19.2055">   }</span>
<a href="#l19.2056"></a><span id="l19.2056"> </span>
<a href="#l19.2057"></a><span id="l19.2057">   nsTArray&lt;nsCString&gt; searchStringParts;</span>
<a href="#l19.2058"></a><span id="l19.2058" class="difflineminus">-  if (!searchValue.IsEmpty())</span>
<a href="#l19.2059"></a><span id="l19.2059" class="difflineminus">-    ParseString(searchValue, ' ', searchStringParts);</span>
<a href="#l19.2060"></a><span id="l19.2060" class="difflineplus">+  if (!searchValue.IsEmpty()) ParseString(searchValue, ' ', searchStringParts);</span>
<a href="#l19.2061"></a><span id="l19.2061"> </span>
<a href="#l19.2062"></a><span id="l19.2062">   mSubscribeSearchResult.Clear();</span>
<a href="#l19.2063"></a><span id="l19.2063">   uint32_t length = mGroupsOnServer.Length();</span>
<a href="#l19.2064"></a><span id="l19.2064" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; i++)</span>
<a href="#l19.2065"></a><span id="l19.2065" class="difflineminus">-  {</span>
<a href="#l19.2066"></a><span id="l19.2066" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; i++) {</span>
<a href="#l19.2067"></a><span id="l19.2067">     // check that all parts of the search string occur</span>
<a href="#l19.2068"></a><span id="l19.2068">     bool found = true;</span>
<a href="#l19.2069"></a><span id="l19.2069">     for (uint32_t j = 0; j &lt; searchStringParts.Length(); ++j) {</span>
<a href="#l19.2070"></a><span id="l19.2070" class="difflineminus">-      if (MsgFind(mGroupsOnServer[i], searchStringParts[j], true, 0) == kNotFound) {</span>
<a href="#l19.2071"></a><span id="l19.2071" class="difflineplus">+      if (MsgFind(mGroupsOnServer[i], searchStringParts[j], true, 0) ==</span>
<a href="#l19.2072"></a><span id="l19.2072" class="difflineplus">+          kNotFound) {</span>
<a href="#l19.2073"></a><span id="l19.2073">         found = false;</span>
<a href="#l19.2074"></a><span id="l19.2074">         break;</span>
<a href="#l19.2075"></a><span id="l19.2075">       }</span>
<a href="#l19.2076"></a><span id="l19.2076">     }</span>
<a href="#l19.2077"></a><span id="l19.2077"> </span>
<a href="#l19.2078"></a><span id="l19.2078" class="difflineminus">-    if (found)</span>
<a href="#l19.2079"></a><span id="l19.2079" class="difflineminus">-      mSubscribeSearchResult.AppendElement(mGroupsOnServer[i]);</span>
<a href="#l19.2080"></a><span id="l19.2080" class="difflineplus">+    if (found) mSubscribeSearchResult.AppendElement(mGroupsOnServer[i]);</span>
<a href="#l19.2081"></a><span id="l19.2081">   }</span>
<a href="#l19.2082"></a><span id="l19.2082"> </span>
<a href="#l19.2083"></a><span id="l19.2083">   nsCStringLowerCaseComparator comparator;</span>
<a href="#l19.2084"></a><span id="l19.2084">   mSubscribeSearchResult.Sort(comparator);</span>
<a href="#l19.2085"></a><span id="l19.2085"> </span>
<a href="#l19.2086"></a><span id="l19.2086" class="difflineminus">-  if (mTree)</span>
<a href="#l19.2087"></a><span id="l19.2087" class="difflineminus">-  {</span>
<a href="#l19.2088"></a><span id="l19.2088" class="difflineplus">+  if (mTree) {</span>
<a href="#l19.2089"></a><span id="l19.2089">     mTree-&gt;RowCountChanged(0, mSubscribeSearchResult.Length());</span>
<a href="#l19.2090"></a><span id="l19.2090">     mTree-&gt;EndUpdateBatch();</span>
<a href="#l19.2091"></a><span id="l19.2091">   }</span>
<a href="#l19.2092"></a><span id="l19.2092"> </span>
<a href="#l19.2093"></a><span id="l19.2093">   return NS_OK;</span>
<a href="#l19.2094"></a><span id="l19.2094"> }</span>
<a href="#l19.2095"></a><span id="l19.2095"> </span>
<a href="#l19.2096"></a><span id="l19.2096"> NS_IMETHODIMP</span>
<a href="#l19.2097"></a><span id="l19.2097" class="difflineminus">-nsNntpIncomingServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l19.2098"></a><span id="l19.2098" class="difflineminus">-{</span>
<a href="#l19.2099"></a><span id="l19.2099" class="difflineplus">+nsNntpIncomingServer::GetSupportsSubscribeSearch(bool *retVal) {</span>
<a href="#l19.2100"></a><span id="l19.2100">   *retVal = true;</span>
<a href="#l19.2101"></a><span id="l19.2101">   return NS_OK;</span>
<a href="#l19.2102"></a><span id="l19.2102"> }</span>
<a href="#l19.2103"></a><span id="l19.2103"> </span>
<a href="#l19.2104"></a><span id="l19.2104"> NS_IMETHODIMP</span>
<a href="#l19.2105"></a><span id="l19.2105" class="difflineminus">-nsNntpIncomingServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l19.2106"></a><span id="l19.2106" class="difflineminus">-{</span>
<a href="#l19.2107"></a><span id="l19.2107" class="difflineplus">+nsNntpIncomingServer::GetFolderView(nsITreeView **aView) {</span>
<a href="#l19.2108"></a><span id="l19.2108">   nsresult rv = EnsureInner();</span>
<a href="#l19.2109"></a><span id="l19.2109" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2110"></a><span id="l19.2110" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2111"></a><span id="l19.2111">   return mInner-&gt;GetFolderView(aView);</span>
<a href="#l19.2112"></a><span id="l19.2112"> }</span>
<a href="#l19.2113"></a><span id="l19.2113"> </span>
<a href="#l19.2114"></a><span id="l19.2114"> NS_IMETHODIMP</span>
<a href="#l19.2115"></a><span id="l19.2115" class="difflineminus">-nsNntpIncomingServer::GetRowCount(int32_t *aRowCount)</span>
<a href="#l19.2116"></a><span id="l19.2116" class="difflineminus">-{</span>
<a href="#l19.2117"></a><span id="l19.2117" class="difflineplus">+nsNntpIncomingServer::GetRowCount(int32_t *aRowCount) {</span>
<a href="#l19.2118"></a><span id="l19.2118">   *aRowCount = mSubscribeSearchResult.Length();</span>
<a href="#l19.2119"></a><span id="l19.2119">   return NS_OK;</span>
<a href="#l19.2120"></a><span id="l19.2120"> }</span>
<a href="#l19.2121"></a><span id="l19.2121"> </span>
<a href="#l19.2122"></a><span id="l19.2122"> NS_IMETHODIMP</span>
<a href="#l19.2123"></a><span id="l19.2123" class="difflineminus">-nsNntpIncomingServer::GetSelection(nsITreeSelection * *aSelection)</span>
<a href="#l19.2124"></a><span id="l19.2124" class="difflineminus">-{</span>
<a href="#l19.2125"></a><span id="l19.2125" class="difflineplus">+nsNntpIncomingServer::GetSelection(nsITreeSelection **aSelection) {</span>
<a href="#l19.2126"></a><span id="l19.2126">   NS_IF_ADDREF(*aSelection = mTreeSelection);</span>
<a href="#l19.2127"></a><span id="l19.2127">   return NS_OK;</span>
<a href="#l19.2128"></a><span id="l19.2128"> }</span>
<a href="#l19.2129"></a><span id="l19.2129"> </span>
<a href="#l19.2130"></a><span id="l19.2130"> NS_IMETHODIMP</span>
<a href="#l19.2131"></a><span id="l19.2131" class="difflineminus">-nsNntpIncomingServer::SetSelection(nsITreeSelection * aSelection)</span>
<a href="#l19.2132"></a><span id="l19.2132" class="difflineminus">-{</span>
<a href="#l19.2133"></a><span id="l19.2133" class="difflineplus">+nsNntpIncomingServer::SetSelection(nsITreeSelection *aSelection) {</span>
<a href="#l19.2134"></a><span id="l19.2134">   mTreeSelection = aSelection;</span>
<a href="#l19.2135"></a><span id="l19.2135">   return NS_OK;</span>
<a href="#l19.2136"></a><span id="l19.2136"> }</span>
<a href="#l19.2137"></a><span id="l19.2137"> </span>
<a href="#l19.2138"></a><span id="l19.2138"> NS_IMETHODIMP</span>
<a href="#l19.2139"></a><span id="l19.2139" class="difflineminus">-nsNntpIncomingServer::GetRowProperties(int32_t index, nsAString&amp; properties)</span>
<a href="#l19.2140"></a><span id="l19.2140" class="difflineminus">-{</span>
<a href="#l19.2141"></a><span id="l19.2141" class="difflineplus">+nsNntpIncomingServer::GetRowProperties(int32_t index, nsAString &amp;properties) {</span>
<a href="#l19.2142"></a><span id="l19.2142">   return NS_OK;</span>
<a href="#l19.2143"></a><span id="l19.2143"> }</span>
<a href="#l19.2144"></a><span id="l19.2144"> </span>
<a href="#l19.2145"></a><span id="l19.2145"> NS_IMETHODIMP</span>
<a href="#l19.2146"></a><span id="l19.2146" class="difflineminus">-nsNntpIncomingServer::GetCellProperties(int32_t row, nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l19.2147"></a><span id="l19.2147" class="difflineminus">-{</span>
<a href="#l19.2148"></a><span id="l19.2148" class="difflineminus">-  if (!IsValidRow(row))</span>
<a href="#l19.2149"></a><span id="l19.2149" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.2150"></a><span id="l19.2150" class="difflineplus">+nsNntpIncomingServer::GetCellProperties(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2151"></a><span id="l19.2151" class="difflineplus">+                                        nsAString &amp;properties) {</span>
<a href="#l19.2152"></a><span id="l19.2152" class="difflineplus">+  if (!IsValidRow(row)) return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.2153"></a><span id="l19.2153"> </span>
<a href="#l19.2154"></a><span id="l19.2154">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l19.2155"></a><span id="l19.2155"> </span>
<a href="#l19.2156"></a><span id="l19.2156" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l19.2157"></a><span id="l19.2157" class="difflineminus">-  if (colID.IsEmpty())</span>
<a href="#l19.2158"></a><span id="l19.2158" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.2159"></a><span id="l19.2159" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l19.2160"></a><span id="l19.2160" class="difflineplus">+  if (colID.IsEmpty()) return NS_OK;</span>
<a href="#l19.2161"></a><span id="l19.2161"> </span>
<a href="#l19.2162"></a><span id="l19.2162">   if (colID.First() == 's') {</span>
<a href="#l19.2163"></a><span id="l19.2163">     // if &lt;name&gt; is in our temporary list of subscribed groups</span>
<a href="#l19.2164"></a><span id="l19.2164">     // add the &quot;subscribed-true&quot; property so the check mark shows up</span>
<a href="#l19.2165"></a><span id="l19.2165">     // in the &quot;subscribedColumn2&quot;</span>
<a href="#l19.2166"></a><span id="l19.2166">     if (mSearchResultSortDescending)</span>
<a href="#l19.2167"></a><span id="l19.2167">       row = mSubscribeSearchResult.Length() - 1 - row;</span>
<a href="#l19.2168"></a><span id="l19.2168">     if (mTempSubscribed.Contains(mSubscribeSearchResult.ElementAt(row))) {</span>
<a href="#l19.2169"></a><span id="l19.2169">       properties.AssignLiteral(&quot;subscribed-true&quot;);</span>
<a href="#l19.2170"></a><span id="l19.2170">     }</span>
<a href="#l19.2171"></a><span id="l19.2171" class="difflineminus">-  }</span>
<a href="#l19.2172"></a><span id="l19.2172" class="difflineminus">-  else if (colID.First() == 'n') {</span>
<a href="#l19.2173"></a><span id="l19.2173" class="difflineplus">+  } else if (colID.First() == 'n') {</span>
<a href="#l19.2174"></a><span id="l19.2174">     // add the &quot;serverType-nntp&quot; property to the &quot;nameColumn2&quot;</span>
<a href="#l19.2175"></a><span id="l19.2175">     // so we get the news folder icon in the search view</span>
<a href="#l19.2176"></a><span id="l19.2176">     properties.AssignLiteral(&quot;serverType-nntp&quot;);</span>
<a href="#l19.2177"></a><span id="l19.2177">   }</span>
<a href="#l19.2178"></a><span id="l19.2178">   return NS_OK;</span>
<a href="#l19.2179"></a><span id="l19.2179"> }</span>
<a href="#l19.2180"></a><span id="l19.2180"> </span>
<a href="#l19.2181"></a><span id="l19.2181"> NS_IMETHODIMP</span>
<a href="#l19.2182"></a><span id="l19.2182" class="difflineminus">-nsNntpIncomingServer::GetColumnProperties(nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l19.2183"></a><span id="l19.2183" class="difflineminus">-{</span>
<a href="#l19.2184"></a><span id="l19.2184" class="difflineplus">+nsNntpIncomingServer::GetColumnProperties(nsTreeColumn *col,</span>
<a href="#l19.2185"></a><span id="l19.2185" class="difflineplus">+                                          nsAString &amp;properties) {</span>
<a href="#l19.2186"></a><span id="l19.2186">   return NS_OK;</span>
<a href="#l19.2187"></a><span id="l19.2187"> }</span>
<a href="#l19.2188"></a><span id="l19.2188"> </span>
<a href="#l19.2189"></a><span id="l19.2189"> NS_IMETHODIMP</span>
<a href="#l19.2190"></a><span id="l19.2190" class="difflineminus">-nsNntpIncomingServer::IsContainer(int32_t index, bool *_retval)</span>
<a href="#l19.2191"></a><span id="l19.2191" class="difflineminus">-{</span>
<a href="#l19.2192"></a><span id="l19.2192" class="difflineplus">+nsNntpIncomingServer::IsContainer(int32_t index, bool *_retval) {</span>
<a href="#l19.2193"></a><span id="l19.2193">   *_retval = false;</span>
<a href="#l19.2194"></a><span id="l19.2194">   return NS_OK;</span>
<a href="#l19.2195"></a><span id="l19.2195"> }</span>
<a href="#l19.2196"></a><span id="l19.2196"> </span>
<a href="#l19.2197"></a><span id="l19.2197"> NS_IMETHODIMP</span>
<a href="#l19.2198"></a><span id="l19.2198" class="difflineminus">-nsNntpIncomingServer::IsContainerOpen(int32_t index, bool *_retval)</span>
<a href="#l19.2199"></a><span id="l19.2199" class="difflineminus">-{</span>
<a href="#l19.2200"></a><span id="l19.2200" class="difflineplus">+nsNntpIncomingServer::IsContainerOpen(int32_t index, bool *_retval) {</span>
<a href="#l19.2201"></a><span id="l19.2201">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2202"></a><span id="l19.2202"> }</span>
<a href="#l19.2203"></a><span id="l19.2203"> </span>
<a href="#l19.2204"></a><span id="l19.2204"> NS_IMETHODIMP</span>
<a href="#l19.2205"></a><span id="l19.2205" class="difflineminus">-nsNntpIncomingServer::IsContainerEmpty(int32_t index, bool *_retval)</span>
<a href="#l19.2206"></a><span id="l19.2206" class="difflineminus">-{</span>
<a href="#l19.2207"></a><span id="l19.2207" class="difflineplus">+nsNntpIncomingServer::IsContainerEmpty(int32_t index, bool *_retval) {</span>
<a href="#l19.2208"></a><span id="l19.2208">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2209"></a><span id="l19.2209"> }</span>
<a href="#l19.2210"></a><span id="l19.2210"> </span>
<a href="#l19.2211"></a><span id="l19.2211"> NS_IMETHODIMP</span>
<a href="#l19.2212"></a><span id="l19.2212" class="difflineminus">-nsNntpIncomingServer::IsSeparator(int32_t index, bool *_retval)</span>
<a href="#l19.2213"></a><span id="l19.2213" class="difflineminus">-{</span>
<a href="#l19.2214"></a><span id="l19.2214" class="difflineplus">+nsNntpIncomingServer::IsSeparator(int32_t index, bool *_retval) {</span>
<a href="#l19.2215"></a><span id="l19.2215">   *_retval = false;</span>
<a href="#l19.2216"></a><span id="l19.2216">   return NS_OK;</span>
<a href="#l19.2217"></a><span id="l19.2217"> }</span>
<a href="#l19.2218"></a><span id="l19.2218"> </span>
<a href="#l19.2219"></a><span id="l19.2219"> NS_IMETHODIMP</span>
<a href="#l19.2220"></a><span id="l19.2220" class="difflineminus">-nsNntpIncomingServer::IsSorted(bool *_retval)</span>
<a href="#l19.2221"></a><span id="l19.2221" class="difflineminus">-{</span>
<a href="#l19.2222"></a><span id="l19.2222" class="difflineplus">+nsNntpIncomingServer::IsSorted(bool *_retval) {</span>
<a href="#l19.2223"></a><span id="l19.2223">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2224"></a><span id="l19.2224"> }</span>
<a href="#l19.2225"></a><span id="l19.2225"> </span>
<a href="#l19.2226"></a><span id="l19.2226"> NS_IMETHODIMP</span>
<a href="#l19.2227"></a><span id="l19.2227" class="difflineminus">-nsNntpIncomingServer::CanDrop(int32_t index,</span>
<a href="#l19.2228"></a><span id="l19.2228" class="difflineminus">-                              int32_t orientation,</span>
<a href="#l19.2229"></a><span id="l19.2229" class="difflineplus">+nsNntpIncomingServer::CanDrop(int32_t index, int32_t orientation,</span>
<a href="#l19.2230"></a><span id="l19.2230">                               mozilla::dom::DataTransfer *dataTransfer,</span>
<a href="#l19.2231"></a><span id="l19.2231" class="difflineminus">-                              bool *_retval)</span>
<a href="#l19.2232"></a><span id="l19.2232" class="difflineminus">-{</span>
<a href="#l19.2233"></a><span id="l19.2233" class="difflineplus">+                              bool *_retval) {</span>
<a href="#l19.2234"></a><span id="l19.2234">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2235"></a><span id="l19.2235"> }</span>
<a href="#l19.2236"></a><span id="l19.2236"> </span>
<a href="#l19.2237"></a><span id="l19.2237"> NS_IMETHODIMP</span>
<a href="#l19.2238"></a><span id="l19.2238" class="difflineminus">-nsNntpIncomingServer::Drop(int32_t row,</span>
<a href="#l19.2239"></a><span id="l19.2239" class="difflineminus">-                           int32_t orientation,</span>
<a href="#l19.2240"></a><span id="l19.2240" class="difflineminus">-                           mozilla::dom::DataTransfer *dataTransfer)</span>
<a href="#l19.2241"></a><span id="l19.2241" class="difflineminus">-{</span>
<a href="#l19.2242"></a><span id="l19.2242" class="difflineplus">+nsNntpIncomingServer::Drop(int32_t row, int32_t orientation,</span>
<a href="#l19.2243"></a><span id="l19.2243" class="difflineplus">+                           mozilla::dom::DataTransfer *dataTransfer) {</span>
<a href="#l19.2244"></a><span id="l19.2244">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2245"></a><span id="l19.2245"> }</span>
<a href="#l19.2246"></a><span id="l19.2246"> </span>
<a href="#l19.2247"></a><span id="l19.2247"> NS_IMETHODIMP</span>
<a href="#l19.2248"></a><span id="l19.2248" class="difflineminus">-nsNntpIncomingServer::GetParentIndex(int32_t rowIndex, int32_t *_retval)</span>
<a href="#l19.2249"></a><span id="l19.2249" class="difflineminus">-{</span>
<a href="#l19.2250"></a><span id="l19.2250" class="difflineplus">+nsNntpIncomingServer::GetParentIndex(int32_t rowIndex, int32_t *_retval) {</span>
<a href="#l19.2251"></a><span id="l19.2251">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2252"></a><span id="l19.2252"> }</span>
<a href="#l19.2253"></a><span id="l19.2253"> </span>
<a href="#l19.2254"></a><span id="l19.2254"> NS_IMETHODIMP</span>
<a href="#l19.2255"></a><span id="l19.2255" class="difflineminus">-nsNntpIncomingServer::HasNextSibling(int32_t rowIndex, int32_t afterIndex, bool *_retval)</span>
<a href="#l19.2256"></a><span id="l19.2256" class="difflineminus">-{</span>
<a href="#l19.2257"></a><span id="l19.2257" class="difflineplus">+nsNntpIncomingServer::HasNextSibling(int32_t rowIndex, int32_t afterIndex,</span>
<a href="#l19.2258"></a><span id="l19.2258" class="difflineplus">+                                     bool *_retval) {</span>
<a href="#l19.2259"></a><span id="l19.2259">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2260"></a><span id="l19.2260"> }</span>
<a href="#l19.2261"></a><span id="l19.2261"> </span>
<a href="#l19.2262"></a><span id="l19.2262"> NS_IMETHODIMP</span>
<a href="#l19.2263"></a><span id="l19.2263" class="difflineminus">-nsNntpIncomingServer::GetLevel(int32_t index, int32_t *_retval)</span>
<a href="#l19.2264"></a><span id="l19.2264" class="difflineminus">-{</span>
<a href="#l19.2265"></a><span id="l19.2265" class="difflineplus">+nsNntpIncomingServer::GetLevel(int32_t index, int32_t *_retval) {</span>
<a href="#l19.2266"></a><span id="l19.2266">   *_retval = 0;</span>
<a href="#l19.2267"></a><span id="l19.2267">   return NS_OK;</span>
<a href="#l19.2268"></a><span id="l19.2268"> }</span>
<a href="#l19.2269"></a><span id="l19.2269"> </span>
<a href="#l19.2270"></a><span id="l19.2270" class="difflineminus">-bool</span>
<a href="#l19.2271"></a><span id="l19.2271" class="difflineminus">-nsNntpIncomingServer::IsValidRow(int32_t row)</span>
<a href="#l19.2272"></a><span id="l19.2272" class="difflineminus">-{</span>
<a href="#l19.2273"></a><span id="l19.2273" class="difflineplus">+bool nsNntpIncomingServer::IsValidRow(int32_t row) {</span>
<a href="#l19.2274"></a><span id="l19.2274">   return ((row &gt;= 0) &amp;&amp; (row &lt; (int32_t)mSubscribeSearchResult.Length()));</span>
<a href="#l19.2275"></a><span id="l19.2275"> }</span>
<a href="#l19.2276"></a><span id="l19.2276"> </span>
<a href="#l19.2277"></a><span id="l19.2277"> NS_IMETHODIMP</span>
<a href="#l19.2278"></a><span id="l19.2278" class="difflineminus">-nsNntpIncomingServer::GetImageSrc(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l19.2279"></a><span id="l19.2279" class="difflineminus">-{</span>
<a href="#l19.2280"></a><span id="l19.2280" class="difflineplus">+nsNntpIncomingServer::GetImageSrc(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2281"></a><span id="l19.2281" class="difflineplus">+                                  nsAString &amp;_retval) {</span>
<a href="#l19.2282"></a><span id="l19.2282">   return NS_OK;</span>
<a href="#l19.2283"></a><span id="l19.2283"> }</span>
<a href="#l19.2284"></a><span id="l19.2284"> </span>
<a href="#l19.2285"></a><span id="l19.2285"> NS_IMETHODIMP</span>
<a href="#l19.2286"></a><span id="l19.2286" class="difflineminus">-nsNntpIncomingServer::GetCellValue(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l19.2287"></a><span id="l19.2287" class="difflineminus">-{</span>
<a href="#l19.2288"></a><span id="l19.2288" class="difflineminus">-  if (!IsValidRow(row))</span>
<a href="#l19.2289"></a><span id="l19.2289" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.2290"></a><span id="l19.2290" class="difflineplus">+nsNntpIncomingServer::GetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2291"></a><span id="l19.2291" class="difflineplus">+                                   nsAString &amp;_retval) {</span>
<a href="#l19.2292"></a><span id="l19.2292" class="difflineplus">+  if (!IsValidRow(row)) return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.2293"></a><span id="l19.2293"> </span>
<a href="#l19.2294"></a><span id="l19.2294">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l19.2295"></a><span id="l19.2295"> </span>
<a href="#l19.2296"></a><span id="l19.2296" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l19.2297"></a><span id="l19.2297" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l19.2298"></a><span id="l19.2298">   nsresult rv = NS_OK;</span>
<a href="#l19.2299"></a><span id="l19.2299">   if (!colID.IsEmpty() &amp;&amp; colID.First() == 'n') {</span>
<a href="#l19.2300"></a><span id="l19.2300">     nsAutoCString str;</span>
<a href="#l19.2301"></a><span id="l19.2301">     if (mSearchResultSortDescending)</span>
<a href="#l19.2302"></a><span id="l19.2302">       row = mSubscribeSearchResult.Length() - 1 - row;</span>
<a href="#l19.2303"></a><span id="l19.2303" class="difflineminus">-    _retval.Assign(NS_ConvertASCIItoUTF16(mSubscribeSearchResult.ElementAt(row)));</span>
<a href="#l19.2304"></a><span id="l19.2304" class="difflineplus">+    _retval.Assign(</span>
<a href="#l19.2305"></a><span id="l19.2305" class="difflineplus">+        NS_ConvertASCIItoUTF16(mSubscribeSearchResult.ElementAt(row)));</span>
<a href="#l19.2306"></a><span id="l19.2306">   }</span>
<a href="#l19.2307"></a><span id="l19.2307">   return rv;</span>
<a href="#l19.2308"></a><span id="l19.2308"> }</span>
<a href="#l19.2309"></a><span id="l19.2309"> </span>
<a href="#l19.2310"></a><span id="l19.2310"> NS_IMETHODIMP</span>
<a href="#l19.2311"></a><span id="l19.2311" class="difflineminus">-nsNntpIncomingServer::GetCellText(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l19.2312"></a><span id="l19.2312" class="difflineminus">-{</span>
<a href="#l19.2313"></a><span id="l19.2313" class="difflineminus">-  if (!IsValidRow(row))</span>
<a href="#l19.2314"></a><span id="l19.2314" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.2315"></a><span id="l19.2315" class="difflineplus">+nsNntpIncomingServer::GetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2316"></a><span id="l19.2316" class="difflineplus">+                                  nsAString &amp;_retval) {</span>
<a href="#l19.2317"></a><span id="l19.2317" class="difflineplus">+  if (!IsValidRow(row)) return NS_ERROR_UNEXPECTED;</span>
<a href="#l19.2318"></a><span id="l19.2318"> </span>
<a href="#l19.2319"></a><span id="l19.2319">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l19.2320"></a><span id="l19.2320"> </span>
<a href="#l19.2321"></a><span id="l19.2321" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l19.2322"></a><span id="l19.2322" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l19.2323"></a><span id="l19.2323">   nsresult rv = NS_OK;</span>
<a href="#l19.2324"></a><span id="l19.2324">   if (!colID.IsEmpty() &amp;&amp; colID.First() == 'n') {</span>
<a href="#l19.2325"></a><span id="l19.2325">     nsAutoCString str;</span>
<a href="#l19.2326"></a><span id="l19.2326">     if (mSearchResultSortDescending)</span>
<a href="#l19.2327"></a><span id="l19.2327">       row = mSubscribeSearchResult.Length() - 1 - row;</span>
<a href="#l19.2328"></a><span id="l19.2328">     // some servers have newsgroup names that are non ASCII.  we store</span>
<a href="#l19.2329"></a><span id="l19.2329">     // those as escaped. unescape here so the UI is consistent</span>
<a href="#l19.2330"></a><span id="l19.2330" class="difflineminus">-    rv = NS_MsgDecodeUnescapeURLPath(mSubscribeSearchResult.ElementAt(row), _retval);</span>
<a href="#l19.2331"></a><span id="l19.2331" class="difflineplus">+    rv = NS_MsgDecodeUnescapeURLPath(mSubscribeSearchResult.ElementAt(row),</span>
<a href="#l19.2332"></a><span id="l19.2332" class="difflineplus">+                                     _retval);</span>
<a href="#l19.2333"></a><span id="l19.2333">   }</span>
<a href="#l19.2334"></a><span id="l19.2334">   return rv;</span>
<a href="#l19.2335"></a><span id="l19.2335"> }</span>
<a href="#l19.2336"></a><span id="l19.2336"> </span>
<a href="#l19.2337"></a><span id="l19.2337"> NS_IMETHODIMP</span>
<a href="#l19.2338"></a><span id="l19.2338" class="difflineminus">-nsNntpIncomingServer::SetTree(mozilla::dom::XULTreeElement *tree)</span>
<a href="#l19.2339"></a><span id="l19.2339" class="difflineminus">-{</span>
<a href="#l19.2340"></a><span id="l19.2340" class="difflineplus">+nsNntpIncomingServer::SetTree(mozilla::dom::XULTreeElement *tree) {</span>
<a href="#l19.2341"></a><span id="l19.2341">   mTree = tree;</span>
<a href="#l19.2342"></a><span id="l19.2342" class="difflineminus">-  if (!tree)</span>
<a href="#l19.2343"></a><span id="l19.2343" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.2344"></a><span id="l19.2344" class="difflineplus">+  if (!tree) return NS_OK;</span>
<a href="#l19.2345"></a><span id="l19.2345"> </span>
<a href="#l19.2346"></a><span id="l19.2346">   RefPtr&lt;nsTreeColumns&gt; cols = tree-&gt;GetColumns();</span>
<a href="#l19.2347"></a><span id="l19.2347" class="difflineminus">-  if (!cols)</span>
<a href="#l19.2348"></a><span id="l19.2348" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.2349"></a><span id="l19.2349" class="difflineplus">+  if (!cols) return NS_OK;</span>
<a href="#l19.2350"></a><span id="l19.2350"> </span>
<a href="#l19.2351"></a><span id="l19.2351">   RefPtr&lt;nsTreeColumn&gt; col = cols-&gt;GetKeyColumn();</span>
<a href="#l19.2352"></a><span id="l19.2352" class="difflineminus">-  if (!col)</span>
<a href="#l19.2353"></a><span id="l19.2353" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.2354"></a><span id="l19.2354" class="difflineplus">+  if (!col) return NS_OK;</span>
<a href="#l19.2355"></a><span id="l19.2355"> </span>
<a href="#l19.2356"></a><span id="l19.2356">   RefPtr&lt;mozilla::dom::Element&gt; element = col-&gt;Element();</span>
<a href="#l19.2357"></a><span id="l19.2357" class="difflineminus">-  if (!element)</span>
<a href="#l19.2358"></a><span id="l19.2358" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.2359"></a><span id="l19.2359" class="difflineplus">+  if (!element) return NS_OK;</span>
<a href="#l19.2360"></a><span id="l19.2360"> </span>
<a href="#l19.2361"></a><span id="l19.2361">   nsAutoString dir;</span>
<a href="#l19.2362"></a><span id="l19.2362">   element-&gt;GetAttribute(NS_LITERAL_STRING(&quot;sortDirection&quot;), dir);</span>
<a href="#l19.2363"></a><span id="l19.2363">   mSearchResultSortDescending = dir.EqualsLiteral(&quot;descending&quot;);</span>
<a href="#l19.2364"></a><span id="l19.2364">   return NS_OK;</span>
<a href="#l19.2365"></a><span id="l19.2365"> }</span>
<a href="#l19.2366"></a><span id="l19.2366"> </span>
<a href="#l19.2367"></a><span id="l19.2367"> NS_IMETHODIMP</span>
<a href="#l19.2368"></a><span id="l19.2368" class="difflineminus">-nsNntpIncomingServer::ToggleOpenState(int32_t index)</span>
<a href="#l19.2369"></a><span id="l19.2369" class="difflineminus">-{</span>
<a href="#l19.2370"></a><span id="l19.2370" class="difflineplus">+nsNntpIncomingServer::ToggleOpenState(int32_t index) {</span>
<a href="#l19.2371"></a><span id="l19.2371">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2372"></a><span id="l19.2372"> }</span>
<a href="#l19.2373"></a><span id="l19.2373"> </span>
<a href="#l19.2374"></a><span id="l19.2374"> NS_IMETHODIMP</span>
<a href="#l19.2375"></a><span id="l19.2375" class="difflineminus">-nsNntpIncomingServer::CycleHeader(nsTreeColumn* col)</span>
<a href="#l19.2376"></a><span id="l19.2376" class="difflineminus">-{</span>
<a href="#l19.2377"></a><span id="l19.2377" class="difflineplus">+nsNntpIncomingServer::CycleHeader(nsTreeColumn *col) {</span>
<a href="#l19.2378"></a><span id="l19.2378">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l19.2379"></a><span id="l19.2379"> </span>
<a href="#l19.2380"></a><span id="l19.2380">   bool cycler = col-&gt;Cycler();</span>
<a href="#l19.2381"></a><span id="l19.2381">   if (!cycler) {</span>
<a href="#l19.2382"></a><span id="l19.2382">     NS_NAMED_LITERAL_STRING(dir, &quot;sortDirection&quot;);</span>
<a href="#l19.2383"></a><span id="l19.2383">     RefPtr&lt;mozilla::dom::Element&gt; element = col-&gt;Element();</span>
<a href="#l19.2384"></a><span id="l19.2384">     mSearchResultSortDescending = !mSearchResultSortDescending;</span>
<a href="#l19.2385"></a><span id="l19.2385">     mozilla::IgnoredErrorResult rv2;</span>
<a href="#l19.2386"></a><span id="l19.2386">     element-&gt;SetAttribute(dir,</span>
<a href="#l19.2387"></a><span id="l19.2387" class="difflineminus">-                          mSearchResultSortDescending ?</span>
<a href="#l19.2388"></a><span id="l19.2388" class="difflineminus">-                            NS_LITERAL_STRING(&quot;descending&quot;) :</span>
<a href="#l19.2389"></a><span id="l19.2389" class="difflineminus">-                            NS_LITERAL_STRING(&quot;ascending&quot;),</span>
<a href="#l19.2390"></a><span id="l19.2390" class="difflineplus">+                          mSearchResultSortDescending</span>
<a href="#l19.2391"></a><span id="l19.2391" class="difflineplus">+                              ? NS_LITERAL_STRING(&quot;descending&quot;)</span>
<a href="#l19.2392"></a><span id="l19.2392" class="difflineplus">+                              : NS_LITERAL_STRING(&quot;ascending&quot;),</span>
<a href="#l19.2393"></a><span id="l19.2393">                           rv2);</span>
<a href="#l19.2394"></a><span id="l19.2394">     mTree-&gt;Invalidate();</span>
<a href="#l19.2395"></a><span id="l19.2395">   }</span>
<a href="#l19.2396"></a><span id="l19.2396">   return NS_OK;</span>
<a href="#l19.2397"></a><span id="l19.2397"> }</span>
<a href="#l19.2398"></a><span id="l19.2398"> </span>
<a href="#l19.2399"></a><span id="l19.2399"> NS_IMETHODIMP</span>
<a href="#l19.2400"></a><span id="l19.2400" class="difflineminus">-nsNntpIncomingServer::SelectionChangedXPCOM()</span>
<a href="#l19.2401"></a><span id="l19.2401" class="difflineminus">-{</span>
<a href="#l19.2402"></a><span id="l19.2402" class="difflineplus">+nsNntpIncomingServer::SelectionChangedXPCOM() {</span>
<a href="#l19.2403"></a><span id="l19.2403">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2404"></a><span id="l19.2404"> }</span>
<a href="#l19.2405"></a><span id="l19.2405"> </span>
<a href="#l19.2406"></a><span id="l19.2406"> NS_IMETHODIMP</span>
<a href="#l19.2407"></a><span id="l19.2407" class="difflineminus">-nsNntpIncomingServer::CycleCell(int32_t row, nsTreeColumn* col)</span>
<a href="#l19.2408"></a><span id="l19.2408" class="difflineminus">-{</span>
<a href="#l19.2409"></a><span id="l19.2409" class="difflineplus">+nsNntpIncomingServer::CycleCell(int32_t row, nsTreeColumn *col) {</span>
<a href="#l19.2410"></a><span id="l19.2410">   return NS_OK;</span>
<a href="#l19.2411"></a><span id="l19.2411"> }</span>
<a href="#l19.2412"></a><span id="l19.2412"> </span>
<a href="#l19.2413"></a><span id="l19.2413"> NS_IMETHODIMP</span>
<a href="#l19.2414"></a><span id="l19.2414" class="difflineminus">-nsNntpIncomingServer::IsEditable(int32_t row, nsTreeColumn* col, bool *_retval)</span>
<a href="#l19.2415"></a><span id="l19.2415" class="difflineminus">-{</span>
<a href="#l19.2416"></a><span id="l19.2416" class="difflineplus">+nsNntpIncomingServer::IsEditable(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2417"></a><span id="l19.2417" class="difflineplus">+                                 bool *_retval) {</span>
<a href="#l19.2418"></a><span id="l19.2418">   *_retval = false;</span>
<a href="#l19.2419"></a><span id="l19.2419">   return NS_OK;</span>
<a href="#l19.2420"></a><span id="l19.2420"> }</span>
<a href="#l19.2421"></a><span id="l19.2421"> </span>
<a href="#l19.2422"></a><span id="l19.2422"> NS_IMETHODIMP</span>
<a href="#l19.2423"></a><span id="l19.2423" class="difflineminus">-nsNntpIncomingServer::SetCellValue(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l19.2424"></a><span id="l19.2424" class="difflineminus">-{</span>
<a href="#l19.2425"></a><span id="l19.2425" class="difflineplus">+nsNntpIncomingServer::SetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2426"></a><span id="l19.2426" class="difflineplus">+                                   const nsAString &amp;value) {</span>
<a href="#l19.2427"></a><span id="l19.2427">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2428"></a><span id="l19.2428"> }</span>
<a href="#l19.2429"></a><span id="l19.2429"> </span>
<a href="#l19.2430"></a><span id="l19.2430"> NS_IMETHODIMP</span>
<a href="#l19.2431"></a><span id="l19.2431" class="difflineminus">-nsNntpIncomingServer::SetCellText(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l19.2432"></a><span id="l19.2432" class="difflineminus">-{</span>
<a href="#l19.2433"></a><span id="l19.2433" class="difflineplus">+nsNntpIncomingServer::SetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l19.2434"></a><span id="l19.2434" class="difflineplus">+                                  const nsAString &amp;value) {</span>
<a href="#l19.2435"></a><span id="l19.2435">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2436"></a><span id="l19.2436"> }</span>
<a href="#l19.2437"></a><span id="l19.2437"> </span>
<a href="#l19.2438"></a><span id="l19.2438"> NS_IMETHODIMP</span>
<a href="#l19.2439"></a><span id="l19.2439" class="difflineminus">-nsNntpIncomingServer::PerformAction(const char16_t *action)</span>
<a href="#l19.2440"></a><span id="l19.2440" class="difflineminus">-{</span>
<a href="#l19.2441"></a><span id="l19.2441" class="difflineplus">+nsNntpIncomingServer::PerformAction(const char16_t *action) {</span>
<a href="#l19.2442"></a><span id="l19.2442">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2443"></a><span id="l19.2443"> }</span>
<a href="#l19.2444"></a><span id="l19.2444"> </span>
<a href="#l19.2445"></a><span id="l19.2445"> NS_IMETHODIMP</span>
<a href="#l19.2446"></a><span id="l19.2446" class="difflineminus">-nsNntpIncomingServer::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l19.2447"></a><span id="l19.2447" class="difflineminus">-{</span>
<a href="#l19.2448"></a><span id="l19.2448" class="difflineplus">+nsNntpIncomingServer::PerformActionOnRow(const char16_t *action, int32_t row) {</span>
<a href="#l19.2449"></a><span id="l19.2449">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2450"></a><span id="l19.2450"> }</span>
<a href="#l19.2451"></a><span id="l19.2451"> </span>
<a href="#l19.2452"></a><span id="l19.2452"> NS_IMETHODIMP</span>
<a href="#l19.2453"></a><span id="l19.2453" class="difflineminus">-nsNntpIncomingServer::PerformActionOnCell(const char16_t *action, int32_t row, nsTreeColumn* col)</span>
<a href="#l19.2454"></a><span id="l19.2454" class="difflineminus">-{</span>
<a href="#l19.2455"></a><span id="l19.2455" class="difflineplus">+nsNntpIncomingServer::PerformActionOnCell(const char16_t *action, int32_t row,</span>
<a href="#l19.2456"></a><span id="l19.2456" class="difflineplus">+                                          nsTreeColumn *col) {</span>
<a href="#l19.2457"></a><span id="l19.2457">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.2458"></a><span id="l19.2458"> }</span>
<a href="#l19.2459"></a><span id="l19.2459"> </span>
<a href="#l19.2460"></a><span id="l19.2460"> NS_IMETHODIMP</span>
<a href="#l19.2461"></a><span id="l19.2461" class="difflineminus">-nsNntpIncomingServer::GetCanFileMessagesOnServer(bool *aCanFileMessagesOnServer)</span>
<a href="#l19.2462"></a><span id="l19.2462" class="difflineminus">-{</span>
<a href="#l19.2463"></a><span id="l19.2463" class="difflineplus">+nsNntpIncomingServer::GetCanFileMessagesOnServer(</span>
<a href="#l19.2464"></a><span id="l19.2464" class="difflineplus">+    bool *aCanFileMessagesOnServer) {</span>
<a href="#l19.2465"></a><span id="l19.2465">   NS_ENSURE_ARG_POINTER(aCanFileMessagesOnServer);</span>
<a href="#l19.2466"></a><span id="l19.2466"> </span>
<a href="#l19.2467"></a><span id="l19.2467">   // No folder creation on news servers. Return false.</span>
<a href="#l19.2468"></a><span id="l19.2468">   *aCanFileMessagesOnServer = false;</span>
<a href="#l19.2469"></a><span id="l19.2469">   return NS_OK;</span>
<a href="#l19.2470"></a><span id="l19.2470"> }</span>
<a href="#l19.2471"></a><span id="l19.2471"> </span>
<a href="#l19.2472"></a><span id="l19.2472"> NS_IMETHODIMP</span>
<a href="#l19.2473"></a><span id="l19.2473" class="difflineminus">-nsNntpIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l19.2474"></a><span id="l19.2474" class="difflineminus">-{</span>
<a href="#l19.2475"></a><span id="l19.2475" class="difflineplus">+nsNntpIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope) {</span>
<a href="#l19.2476"></a><span id="l19.2476">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l19.2477"></a><span id="l19.2477"> </span>
<a href="#l19.2478"></a><span id="l19.2478">   *filterScope = nsMsgSearchScope::newsFilter;</span>
<a href="#l19.2479"></a><span id="l19.2479">   return NS_OK;</span>
<a href="#l19.2480"></a><span id="l19.2480"> }</span>
<a href="#l19.2481"></a><span id="l19.2481"> </span>
<a href="#l19.2482"></a><span id="l19.2482"> NS_IMETHODIMP</span>
<a href="#l19.2483"></a><span id="l19.2483" class="difflineminus">-nsNntpIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope)</span>
<a href="#l19.2484"></a><span id="l19.2484" class="difflineminus">-{</span>
<a href="#l19.2485"></a><span id="l19.2485" class="difflineplus">+nsNntpIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope) {</span>
<a href="#l19.2486"></a><span id="l19.2486">   NS_ENSURE_ARG_POINTER(searchScope);</span>
<a href="#l19.2487"></a><span id="l19.2487"> </span>
<a href="#l19.2488"></a><span id="l19.2488">   if (WeAreOffline()) {</span>
<a href="#l19.2489"></a><span id="l19.2489">     // This value is set to the localNewsBody scope to be compatible with</span>
<a href="#l19.2490"></a><span id="l19.2490">     // the legacy default value.</span>
<a href="#l19.2491"></a><span id="l19.2491">     *searchScope = nsMsgSearchScope::localNewsBody;</span>
<a href="#l19.2492"></a><span id="l19.2492" class="difflineminus">-  }</span>
<a href="#l19.2493"></a><span id="l19.2493" class="difflineminus">-  else {</span>
<a href="#l19.2494"></a><span id="l19.2494" class="difflineplus">+  } else {</span>
<a href="#l19.2495"></a><span id="l19.2495">     *searchScope = nsMsgSearchScope::news;</span>
<a href="#l19.2496"></a><span id="l19.2496">   }</span>
<a href="#l19.2497"></a><span id="l19.2497">   return NS_OK;</span>
<a href="#l19.2498"></a><span id="l19.2498"> }</span>
<a href="#l19.2499"></a><span id="l19.2499"> </span>
<a href="#l19.2500"></a><span id="l19.2500"> NS_IMETHODIMP</span>
<a href="#l19.2501"></a><span id="l19.2501" class="difflineminus">-nsNntpIncomingServer::GetSocketType(int32_t *aSocketType)</span>
<a href="#l19.2502"></a><span id="l19.2502" class="difflineminus">-{</span>
<a href="#l19.2503"></a><span id="l19.2503" class="difflineplus">+nsNntpIncomingServer::GetSocketType(int32_t *aSocketType) {</span>
<a href="#l19.2504"></a><span id="l19.2504">   NS_ENSURE_ARG_POINTER(aSocketType);</span>
<a href="#l19.2505"></a><span id="l19.2505" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l19.2506"></a><span id="l19.2506" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l19.2507"></a><span id="l19.2507" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l19.2508"></a><span id="l19.2508"> </span>
<a href="#l19.2509"></a><span id="l19.2509">   nsresult rv = mPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l19.2510"></a><span id="l19.2510" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l19.2511"></a><span id="l19.2511" class="difflineminus">-  {</span>
<a href="#l19.2512"></a><span id="l19.2512" class="difflineminus">-    if (!mDefPrefBranch)</span>
<a href="#l19.2513"></a><span id="l19.2513" class="difflineminus">-      return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l19.2514"></a><span id="l19.2514" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l19.2515"></a><span id="l19.2515" class="difflineplus">+    if (!mDefPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l19.2516"></a><span id="l19.2516">     rv = mDefPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l19.2517"></a><span id="l19.2517" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l19.2518"></a><span id="l19.2518" class="difflineminus">-      *aSocketType = nsMsgSocketType::plain;</span>
<a href="#l19.2519"></a><span id="l19.2519" class="difflineplus">+    if (NS_FAILED(rv)) *aSocketType = nsMsgSocketType::plain;</span>
<a href="#l19.2520"></a><span id="l19.2520">   }</span>
<a href="#l19.2521"></a><span id="l19.2521"> </span>
<a href="#l19.2522"></a><span id="l19.2522">   // nsMsgIncomingServer::GetSocketType migrates old isSecure to socketType</span>
<a href="#l19.2523"></a><span id="l19.2523">   // style for mail. Unfortunately, a bug caused news socketType 0 to be stored</span>
<a href="#l19.2524"></a><span id="l19.2524">   // in the prefs even for isSecure true, so the migration wouldn't happen :(</span>
<a href="#l19.2525"></a><span id="l19.2525"> </span>
<a href="#l19.2526"></a><span id="l19.2526">   // Now that we know the socket, make sure isSecure true + socketType 0</span>
<a href="#l19.2527"></a><span id="l19.2527">   // doesn't mix. Migrate if that's the case here.</span>
<a href="#l19.2528"></a><span id="l19.2528" class="difflineminus">-  if (*aSocketType == nsMsgSocketType::plain)</span>
<a href="#l19.2529"></a><span id="l19.2529" class="difflineminus">-  {</span>
<a href="#l19.2530"></a><span id="l19.2530" class="difflineplus">+  if (*aSocketType == nsMsgSocketType::plain) {</span>
<a href="#l19.2531"></a><span id="l19.2531">     bool isSecure = false;</span>
<a href="#l19.2532"></a><span id="l19.2532">     nsresult rv2 = mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure);</span>
<a href="#l19.2533"></a><span id="l19.2533" class="difflineminus">-    if (NS_SUCCEEDED(rv2) &amp;&amp; isSecure)</span>
<a href="#l19.2534"></a><span id="l19.2534" class="difflineminus">-    {</span>
<a href="#l19.2535"></a><span id="l19.2535" class="difflineplus">+    if (NS_SUCCEEDED(rv2) &amp;&amp; isSecure) {</span>
<a href="#l19.2536"></a><span id="l19.2536">       *aSocketType = nsMsgSocketType::SSL;</span>
<a href="#l19.2537"></a><span id="l19.2537">       // Don't call virtual method in case overrides call GetSocketType.</span>
<a href="#l19.2538"></a><span id="l19.2538">       nsMsgIncomingServer::SetSocketType(*aSocketType);</span>
<a href="#l19.2539"></a><span id="l19.2539">     }</span>
<a href="#l19.2540"></a><span id="l19.2540">   }</span>
<a href="#l19.2541"></a><span id="l19.2541">   return rv;</span>
<a href="#l19.2542"></a><span id="l19.2542"> }</span>
<a href="#l19.2543"></a><span id="l19.2543"> </span>
<a href="#l19.2544"></a><span id="l19.2544"> NS_IMETHODIMP</span>
<a href="#l19.2545"></a><span id="l19.2545" class="difflineminus">-nsNntpIncomingServer::SetSocketType(int32_t aSocketType)</span>
<a href="#l19.2546"></a><span id="l19.2546" class="difflineminus">-{</span>
<a href="#l19.2547"></a><span id="l19.2547" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l19.2548"></a><span id="l19.2548" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l19.2549"></a><span id="l19.2549" class="difflineplus">+nsNntpIncomingServer::SetSocketType(int32_t aSocketType) {</span>
<a href="#l19.2550"></a><span id="l19.2550" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l19.2551"></a><span id="l19.2551">   nsresult rv = nsMsgIncomingServer::SetSocketType(aSocketType);</span>
<a href="#l19.2552"></a><span id="l19.2552" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l19.2553"></a><span id="l19.2553" class="difflineminus">-  {</span>
<a href="#l19.2554"></a><span id="l19.2554" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.2555"></a><span id="l19.2555">     bool isSecure = false;</span>
<a href="#l19.2556"></a><span id="l19.2556" class="difflineminus">-    if (NS_SUCCEEDED(mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure)))</span>
<a href="#l19.2557"></a><span id="l19.2557" class="difflineminus">-    {</span>
<a href="#l19.2558"></a><span id="l19.2558" class="difflineplus">+    if (NS_SUCCEEDED(mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure))) {</span>
<a href="#l19.2559"></a><span id="l19.2559">       // Must keep isSecure in sync since we migrate based on it... if it's set.</span>
<a href="#l19.2560"></a><span id="l19.2560">       rv = mPrefBranch-&gt;SetBoolPref(&quot;isSecure&quot;,</span>
<a href="#l19.2561"></a><span id="l19.2561">                                     aSocketType == nsMsgSocketType::SSL);</span>
<a href="#l19.2562"></a><span id="l19.2562">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2563"></a><span id="l19.2563">     }</span>
<a href="#l19.2564"></a><span id="l19.2564">   }</span>
<a href="#l19.2565"></a><span id="l19.2565">   return rv;</span>
<a href="#l19.2566"></a><span id="l19.2566"> }</span>
<a href="#l19.2567"></a><span id="l19.2567"> </span>
<a href="#l19.2568"></a><span id="l19.2568"> NS_IMETHODIMP</span>
<a href="#l19.2569"></a><span id="l19.2569" class="difflineminus">-nsNntpIncomingServer::OnUserOrHostNameChanged(const nsACString&amp; oldName,</span>
<a href="#l19.2570"></a><span id="l19.2570" class="difflineminus">-                                              const nsACString&amp; newName,</span>
<a href="#l19.2571"></a><span id="l19.2571" class="difflineminus">-                                              bool hostnameChanged)</span>
<a href="#l19.2572"></a><span id="l19.2572" class="difflineminus">-{</span>
<a href="#l19.2573"></a><span id="l19.2573" class="difflineplus">+nsNntpIncomingServer::OnUserOrHostNameChanged(const nsACString &amp;oldName,</span>
<a href="#l19.2574"></a><span id="l19.2574" class="difflineplus">+                                              const nsACString &amp;newName,</span>
<a href="#l19.2575"></a><span id="l19.2575" class="difflineplus">+                                              bool hostnameChanged) {</span>
<a href="#l19.2576"></a><span id="l19.2576">   nsresult rv;</span>
<a href="#l19.2577"></a><span id="l19.2577">   // 1. Do common things in the base class.</span>
<a href="#l19.2578"></a><span id="l19.2578" class="difflineminus">-  rv = nsMsgIncomingServer::OnUserOrHostNameChanged(oldName, newName, hostnameChanged);</span>
<a href="#l19.2579"></a><span id="l19.2579" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2580"></a><span id="l19.2580" class="difflineplus">+  rv = nsMsgIncomingServer::OnUserOrHostNameChanged(oldName, newName,</span>
<a href="#l19.2581"></a><span id="l19.2581" class="difflineplus">+                                                    hostnameChanged);</span>
<a href="#l19.2582"></a><span id="l19.2582" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2583"></a><span id="l19.2583"> </span>
<a href="#l19.2584"></a><span id="l19.2584">   // 2. Remove file hostinfo.dat so that the new subscribe</span>
<a href="#l19.2585"></a><span id="l19.2585">   //    list will be reloaded from the new server.</span>
<a href="#l19.2586"></a><span id="l19.2586" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; hostInfoFile;</span>
<a href="#l19.2587"></a><span id="l19.2587" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; hostInfoFile;</span>
<a href="#l19.2588"></a><span id="l19.2588">   rv = GetLocalPath(getter_AddRefs(hostInfoFile));</span>
<a href="#l19.2589"></a><span id="l19.2589">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2590"></a><span id="l19.2590">   rv = hostInfoFile-&gt;AppendNative(NS_LITERAL_CSTRING(HOSTINFO_FILE_NAME));</span>
<a href="#l19.2591"></a><span id="l19.2591">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2592"></a><span id="l19.2592">   hostInfoFile-&gt;Remove(false);</span>
<a href="#l19.2593"></a><span id="l19.2593"> </span>
<a href="#l19.2594"></a><span id="l19.2594" class="difflineminus">-  // 3.Unsubscribe and then subscribe the existing groups to clean up the article numbers</span>
<a href="#l19.2595"></a><span id="l19.2595" class="difflineminus">-  //   in the rc file (this is because the old and new servers may maintain different</span>
<a href="#l19.2596"></a><span id="l19.2596" class="difflineminus">-  //   numbers for the same articles if both servers handle the same groups).</span>
<a href="#l19.2597"></a><span id="l19.2597" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l19.2598"></a><span id="l19.2598" class="difflineplus">+  // 3.Unsubscribe and then subscribe the existing groups to clean up the</span>
<a href="#l19.2599"></a><span id="l19.2599" class="difflineplus">+  // article numbers</span>
<a href="#l19.2600"></a><span id="l19.2600" class="difflineplus">+  //   in the rc file (this is because the old and new servers may maintain</span>
<a href="#l19.2601"></a><span id="l19.2601" class="difflineplus">+  //   different numbers for the same articles if both servers handle the same</span>
<a href="#l19.2602"></a><span id="l19.2602" class="difflineplus">+  //   groups).</span>
<a href="#l19.2603"></a><span id="l19.2603" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l19.2604"></a><span id="l19.2604">   rv = GetRootMsgFolder(getter_AddRefs(serverFolder));</span>
<a href="#l19.2605"></a><span id="l19.2605" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2606"></a><span id="l19.2606" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2607"></a><span id="l19.2607"> </span>
<a href="#l19.2608"></a><span id="l19.2608">   nsCOMPtr&lt;nsISimpleEnumerator&gt; subFolders;</span>
<a href="#l19.2609"></a><span id="l19.2609">   rv = serverFolder-&gt;GetSubFolders(getter_AddRefs(subFolders));</span>
<a href="#l19.2610"></a><span id="l19.2610" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2611"></a><span id="l19.2611" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2612"></a><span id="l19.2612"> </span>
<a href="#l19.2613"></a><span id="l19.2613">   nsTArray&lt;nsString&gt; groupList;</span>
<a href="#l19.2614"></a><span id="l19.2614">   nsString folderName;</span>
<a href="#l19.2615"></a><span id="l19.2615"> </span>
<a href="#l19.2616"></a><span id="l19.2616">   // Prepare the group list</span>
<a href="#l19.2617"></a><span id="l19.2617">   bool hasMore;</span>
<a href="#l19.2618"></a><span id="l19.2618" class="difflineminus">-  while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l19.2619"></a><span id="l19.2619" class="difflineminus">-  {</span>
<a href="#l19.2620"></a><span id="l19.2620" class="difflineplus">+  while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l19.2621"></a><span id="l19.2621">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l19.2622"></a><span id="l19.2622">     subFolders-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l19.2623"></a><span id="l19.2623">     nsCOMPtr&lt;nsIMsgFolder&gt; newsgroupFolder(do_QueryInterface(item));</span>
<a href="#l19.2624"></a><span id="l19.2624" class="difflineminus">-    if (!newsgroupFolder)</span>
<a href="#l19.2625"></a><span id="l19.2625" class="difflineminus">-      continue;</span>
<a href="#l19.2626"></a><span id="l19.2626" class="difflineplus">+    if (!newsgroupFolder) continue;</span>
<a href="#l19.2627"></a><span id="l19.2627"> </span>
<a href="#l19.2628"></a><span id="l19.2628">     rv = newsgroupFolder-&gt;GetName(folderName);</span>
<a href="#l19.2629"></a><span id="l19.2629" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2630"></a><span id="l19.2630" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2631"></a><span id="l19.2631">     groupList.AppendElement(folderName);</span>
<a href="#l19.2632"></a><span id="l19.2632">   }</span>
<a href="#l19.2633"></a><span id="l19.2633"> </span>
<a href="#l19.2634"></a><span id="l19.2634">   // If nothing subscribed then we're done.</span>
<a href="#l19.2635"></a><span id="l19.2635" class="difflineminus">-  if (groupList.Length() == 0)</span>
<a href="#l19.2636"></a><span id="l19.2636" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.2637"></a><span id="l19.2637" class="difflineplus">+  if (groupList.Length() == 0) return NS_OK;</span>
<a href="#l19.2638"></a><span id="l19.2638"> </span>
<a href="#l19.2639"></a><span id="l19.2639">   // Now unsubscribe &amp; subscribe.</span>
<a href="#l19.2640"></a><span id="l19.2640">   uint32_t i;</span>
<a href="#l19.2641"></a><span id="l19.2641">   uint32_t cnt = groupList.Length();</span>
<a href="#l19.2642"></a><span id="l19.2642">   nsAutoCString cname;</span>
<a href="#l19.2643"></a><span id="l19.2643" class="difflineminus">-  for (i = 0; i &lt; cnt; i++)</span>
<a href="#l19.2644"></a><span id="l19.2644" class="difflineminus">-  {</span>
<a href="#l19.2645"></a><span id="l19.2645" class="difflineplus">+  for (i = 0; i &lt; cnt; i++) {</span>
<a href="#l19.2646"></a><span id="l19.2646">     // unsubscribe.</span>
<a href="#l19.2647"></a><span id="l19.2647">     rv = Unsubscribe(groupList[i].get());</span>
<a href="#l19.2648"></a><span id="l19.2648" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2649"></a><span id="l19.2649" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2650"></a><span id="l19.2650">   }</span>
<a href="#l19.2651"></a><span id="l19.2651"> </span>
<a href="#l19.2652"></a><span id="l19.2652" class="difflineminus">-  for (i = 0; i &lt; cnt; i++)</span>
<a href="#l19.2653"></a><span id="l19.2653" class="difflineminus">-  {</span>
<a href="#l19.2654"></a><span id="l19.2654" class="difflineplus">+  for (i = 0; i &lt; cnt; i++) {</span>
<a href="#l19.2655"></a><span id="l19.2655">     // subscribe.</span>
<a href="#l19.2656"></a><span id="l19.2656">     rv = SubscribeToNewsgroup(NS_ConvertUTF16toUTF8(groupList[i]));</span>
<a href="#l19.2657"></a><span id="l19.2657" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.2658"></a><span id="l19.2658" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.2659"></a><span id="l19.2659">   }</span>
<a href="#l19.2660"></a><span id="l19.2660"> </span>
<a href="#l19.2661"></a><span id="l19.2661">   // Force updating the rc file.</span>
<a href="#l19.2662"></a><span id="l19.2662">   return CommitSubscribeChanges();</span>
<a href="#l19.2663"></a><span id="l19.2663"> }</span>
<a href="#l19.2664"></a><span id="l19.2664"> </span>
<a href="#l19.2665"></a><span id="l19.2665"> NS_IMETHODIMP</span>
<a href="#l19.2666"></a><span id="l19.2666" class="difflineminus">-nsNntpIncomingServer::GetSortOrder(int32_t* aSortOrder)</span>
<a href="#l19.2667"></a><span id="l19.2667" class="difflineminus">-{</span>
<a href="#l19.2668"></a><span id="l19.2668" class="difflineplus">+nsNntpIncomingServer::GetSortOrder(int32_t *aSortOrder) {</span>
<a href="#l19.2669"></a><span id="l19.2669">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l19.2670"></a><span id="l19.2670">   *aSortOrder = 500000000;</span>
<a href="#l19.2671"></a><span id="l19.2671">   return NS_OK;</span>
<a href="#l19.2672"></a><span id="l19.2672"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -31,107 +31,113 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* get some implementation from nsMsgIncomingServer */</span>
<a href="#l20.5"></a><span id="l20.5"> class nsNntpIncomingServer : public nsMsgIncomingServer,</span>
<a href="#l20.6"></a><span id="l20.6">                              public nsINntpIncomingServer,</span>
<a href="#l20.7"></a><span id="l20.7">                              public nsIUrlListener,</span>
<a href="#l20.8"></a><span id="l20.8">                              public nsISubscribableServer,</span>
<a href="#l20.9"></a><span id="l20.9">                              public nsITreeView</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-public:</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-    NS_DECL_NSINNTPINCOMINGSERVER</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-    NS_DECL_NSIURLLISTENER</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-    NS_DECL_NSISUBSCRIBABLESERVER</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-    NS_DECL_NSITREEVIEW</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+ public:</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+  NS_DECL_NSINNTPINCOMINGSERVER</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+  NS_DECL_NSIURLLISTENER</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+  NS_DECL_NSISUBSCRIBABLESERVER</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+  NS_DECL_NSITREEVIEW</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-    nsNntpIncomingServer();</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+  nsNntpIncomingServer();</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-    NS_IMETHOD GetLocalStoreType(nsACString&amp; type) override;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-    NS_IMETHOD GetLocalDatabaseType(nsACString&amp; type) override;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-    NS_IMETHOD CloseCachedConnections() override;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-    NS_IMETHOD PerformExpand(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-    NS_IMETHOD OnUserOrHostNameChanged(const nsACString&amp; oldName,</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-                                       const nsACString&amp; newName,</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-                                       bool hostnameChanged) override;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-    // for nsMsgLineBuffer</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    virtual nsresult HandleLine(const char *line, uint32_t line_size);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  NS_IMETHOD GetLocalStoreType(nsACString &amp;type) override;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  NS_IMETHOD GetLocalDatabaseType(nsACString &amp;type) override;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  NS_IMETHOD CloseCachedConnections() override;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  NS_IMETHOD PerformExpand(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  NS_IMETHOD OnUserOrHostNameChanged(const nsACString &amp;oldName,</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+                                     const nsACString &amp;newName,</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+                                     bool hostnameChanged) override;</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-    // override to clear all passwords associated with server</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-    NS_IMETHODIMP ForgetPassword() override;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-    NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-    NS_IMETHOD GetOfflineSupportLevel(int32_t *aSupportLevel) override;</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-    NS_IMETHOD GetDefaultCopiesAndFoldersPrefsToServer(bool *aCopiesAndFoldersOnServer) override;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-    NS_IMETHOD GetCanCreateFoldersOnServer(bool *aCanCreateFoldersOnServer) override;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-    NS_IMETHOD GetCanFileMessagesOnServer(bool *aCanFileMessagesOnServer) override;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-    NS_IMETHOD GetFilterScope(nsMsgSearchScopeValue *filterScope) override;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-    NS_IMETHOD GetSearchScope(nsMsgSearchScopeValue *searchScope) override;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  // for nsMsgLineBuffer</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  virtual nsresult HandleLine(const char *line, uint32_t line_size);</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-    NS_IMETHOD GetSocketType(int32_t *aSocketType) override; // override nsMsgIncomingServer impl</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-    NS_IMETHOD SetSocketType(int32_t aSocketType) override; // override nsMsgIncomingServer impl</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-    NS_IMETHOD GetSortOrder(int32_t* aSortOrder) override;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  // override to clear all passwords associated with server</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+  NS_IMETHODIMP ForgetPassword() override;</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  NS_IMETHOD GetOfflineSupportLevel(int32_t *aSupportLevel) override;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+  NS_IMETHOD GetDefaultCopiesAndFoldersPrefsToServer(</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+      bool *aCopiesAndFoldersOnServer) override;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+  NS_IMETHOD GetCanCreateFoldersOnServer(</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+      bool *aCanCreateFoldersOnServer) override;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+  NS_IMETHOD GetCanFileMessagesOnServer(</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+      bool *aCanFileMessagesOnServer) override;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  NS_IMETHOD GetFilterScope(nsMsgSearchScopeValue *filterScope) override;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+  NS_IMETHOD GetSearchScope(nsMsgSearchScopeValue *searchScope) override;</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-protected:</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-    virtual ~nsNntpIncomingServer();</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-   virtual nsresult CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-                                            nsIMsgFolder **rootFolder) override;</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-    nsresult GetNntpConnection(nsIURI *url, nsIMsgWindow *window,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-                               nsINNTPProtocol **aNntpConnection);</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-    nsresult CreateProtocolInstance(nsINNTPProtocol **aNntpConnection,</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-                                    nsIURI *url, nsIMsgWindow *window);</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-    bool ConnectionTimeOut(nsINNTPProtocol* aNntpConnection);</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-    nsCOMArray&lt;nsINNTPProtocol&gt; mConnectionCache;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-    nsTArray&lt;RefPtr&lt;nsNntpMockChannel&gt; &gt; m_queuedChannels;</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  NS_IMETHOD GetSocketType(</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+      int32_t *aSocketType) override;  // override nsMsgIncomingServer impl</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  NS_IMETHOD SetSocketType(</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+      int32_t aSocketType) override;  // override nsMsgIncomingServer impl</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+  NS_IMETHOD GetSortOrder(int32_t *aSortOrder) override;</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-    /**</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-     * Downloads the newsgroup headers.</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-     */</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-    nsresult DownloadMail(nsIMsgWindow *aMsgWindow);</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-    NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-    nsresult SetupNewsrcSaveTimer();</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-    static void OnNewsrcSaveTimer(nsITimer *timer, void *voidIncomingServer);</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    void WriteLine(nsIOutputStream *stream, nsCString &amp;str);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+ protected:</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+  virtual ~nsNntpIncomingServer();</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  virtual nsresult CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+                                           nsIMsgFolder **rootFolder) override;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  nsresult GetNntpConnection(nsIURI *url, nsIMsgWindow *window,</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+                             nsINNTPProtocol **aNntpConnection);</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+  nsresult CreateProtocolInstance(nsINNTPProtocol **aNntpConnection,</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+                                  nsIURI *url, nsIMsgWindow *window);</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+  bool ConnectionTimeOut(nsINNTPProtocol *aNntpConnection);</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+  nsCOMArray&lt;nsINNTPProtocol&gt; mConnectionCache;</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsNntpMockChannel&gt; &gt; m_queuedChannels;</span>
<a href="#l20.113"></a><span id="l20.113"> </span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-private:</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-    nsTArray&lt;nsCString&gt; mSubscribedNewsgroups;</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-    nsTArray&lt;nsCString&gt; mGroupsOnServer;</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-    nsTArray&lt;nsCString&gt; mSubscribeSearchResult;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-    bool mSearchResultSortDescending;</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-    // the list of of subscribed newsgroups within a given</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-    // subscribed dialog session.</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-    // we need to keep track of them so we know what to show as &quot;checked&quot;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-    // in the search view</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-    nsTArray&lt;nsCString&gt; mTempSubscribed;</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+  /**</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+   * Downloads the newsgroup headers.</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+   */</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+  nsresult DownloadMail(nsIMsgWindow *aMsgWindow);</span>
<a href="#l20.128"></a><span id="l20.128"> </span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-    RefPtr&lt;mozilla::dom::XULTreeElement&gt; mTree;</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-    nsCOMPtr&lt;nsITreeSelection&gt; mTreeSelection;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+  NS_IMETHOD GetServerRequiresPasswordForBiff(</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+      bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+  nsresult SetupNewsrcSaveTimer();</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+  static void OnNewsrcSaveTimer(nsITimer *timer, void *voidIncomingServer);</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+  void WriteLine(nsIOutputStream *stream, nsCString &amp;str);</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-    bool     mHasSeenBeginGroups;</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-    bool     mGetOnlyNew;</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-    nsresult WriteHostInfoFile();</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-    nsresult LoadHostInfoFile();</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-    nsresult AddGroupOnServer(const nsACString &amp;name);</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+ private:</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+  nsTArray&lt;nsCString&gt; mSubscribedNewsgroups;</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+  nsTArray&lt;nsCString&gt; mGroupsOnServer;</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+  nsTArray&lt;nsCString&gt; mSubscribeSearchResult;</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+  bool mSearchResultSortDescending;</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+  // the list of of subscribed newsgroups within a given</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+  // subscribed dialog session.</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+  // we need to keep track of them so we know what to show as &quot;checked&quot;</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+  // in the search view</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+  nsTArray&lt;nsCString&gt; mTempSubscribed;</span>
<a href="#l20.152"></a><span id="l20.152"> </span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-    bool mNewsrcHasChanged;</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-    bool mHostInfoLoaded;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-    bool mHostInfoHasChanged;</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; mHostInfoFile;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+  RefPtr&lt;mozilla::dom::XULTreeElement&gt; mTree;</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+  nsCOMPtr&lt;nsITreeSelection&gt; mTreeSelection;</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+  bool mHasSeenBeginGroups;</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+  bool mGetOnlyNew;</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+  nsresult WriteHostInfoFile();</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+  nsresult LoadHostInfoFile();</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+  nsresult AddGroupOnServer(const nsACString &amp;name);</span>
<a href="#l20.165"></a><span id="l20.165"> </span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-    uint32_t mLastGroupDate;</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-    int32_t mUniqueId;</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-    uint32_t mLastUpdatedTime;</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-    int32_t mVersion;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-    bool mPostingAllowed;</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+  bool mNewsrcHasChanged;</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+  bool mHostInfoLoaded;</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+  bool mHostInfoHasChanged;</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mHostInfoFile;</span>
<a href="#l20.175"></a><span id="l20.175"> </span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-    nsCOMPtr&lt;nsITimer&gt; mNewsrcSaveTimer;</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-    nsCOMPtr &lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+  uint32_t mLastGroupDate;</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+  int32_t mUniqueId;</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+  uint32_t mLastUpdatedTime;</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+  int32_t mVersion;</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+  bool mPostingAllowed;</span>
<a href="#l20.183"></a><span id="l20.183"> </span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-    nsCOMPtr &lt;nsISubscribableServer&gt; mInner;</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-    nsresult EnsureInner();</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-    nsresult ClearInner();</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-    bool IsValidRow(int32_t row);</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; mNewsrcFilePath;</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+  nsCOMPtr&lt;nsITimer&gt; mNewsrcSaveTimer;</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+  nsCOMPtr&lt;nsISubscribableServer&gt; mInner;</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+  nsresult EnsureInner();</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+  nsresult ClearInner();</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+  bool IsValidRow(int32_t row);</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mNewsrcFilePath;</span>
<a href="#l20.197"></a><span id="l20.197"> };</span>
<a href="#l20.198"></a><span id="l20.198"> </span>
<a href="#l20.199"></a><span id="l20.199"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/news/src/nsNntpMockChannel.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpMockChannel.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -10,310 +10,273 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsNNTPProtocol.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsContentSecurityManager.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> NS_IMPL_ISUPPORTS(nsNntpMockChannel, nsIChannel, nsIRequest)</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> nsNntpMockChannel::nsNntpMockChannel(nsIURI *aUri, nsIMsgWindow *aMsgWindow)</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-: m_url(aUri),</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  m_msgWindow(aMsgWindow),</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  m_channelState(CHANNEL_UNOPENED),</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-  m_protocol(nullptr),</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-  m_cancelStatus(NS_OK),</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-  m_loadFlags(0),</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-  m_contentLength(-1)</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-{</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-}</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+    : m_url(aUri),</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+      m_msgWindow(aMsgWindow),</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+      m_channelState(CHANNEL_UNOPENED),</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+      m_protocol(nullptr),</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+      m_cancelStatus(NS_OK),</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+      m_loadFlags(0),</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+      m_contentLength(-1) {}</span>
<a href="#l21.28"></a><span id="l21.28"> </span>
<a href="#l21.29"></a><span id="l21.29"> nsNntpMockChannel::nsNntpMockChannel(nsIURI *aUri, nsIMsgWindow *aMsgWindow,</span>
<a href="#l21.30"></a><span id="l21.30">                                      nsISupports *aConsumer)</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-: m_url(aUri),</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-  m_context(aConsumer),</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-  m_msgWindow(aMsgWindow),</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-  m_channelState(CHANNEL_OPEN_WITH_LOAD),</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  m_protocol(nullptr),</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-  m_cancelStatus(NS_OK),</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  m_loadFlags(0),</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  m_contentLength(-1)</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-{</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-}</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+    : m_url(aUri),</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+      m_context(aConsumer),</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+      m_msgWindow(aMsgWindow),</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+      m_channelState(CHANNEL_OPEN_WITH_LOAD),</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+      m_protocol(nullptr),</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+      m_cancelStatus(NS_OK),</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+      m_loadFlags(0),</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+      m_contentLength(-1) {}</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-nsNntpMockChannel::~nsNntpMockChannel()</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-{</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-}</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+nsNntpMockChannel::~nsNntpMockChannel() {}</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55"> #define FORWARD_CALL(function, argument) \</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  if (m_protocol) \</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-    return m_protocol-&gt;function(argument);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+  if (m_protocol) return m_protocol-&gt;function(argument);</span>
<a href="#l21.59"></a><span id="l21.59"> </span>
<a href="#l21.60"></a><span id="l21.60"> ////////////////////////</span>
<a href="#l21.61"></a><span id="l21.61"> // nsIRequest methods //</span>
<a href="#l21.62"></a><span id="l21.62"> ////////////////////////</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetName(nsACString &amp;result)</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-{</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetName(nsACString &amp;result) {</span>
<a href="#l21.67"></a><span id="l21.67">   FORWARD_CALL(GetName, result)</span>
<a href="#l21.68"></a><span id="l21.68">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.69"></a><span id="l21.69"> }</span>
<a href="#l21.70"></a><span id="l21.70"> </span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::IsPending(bool *result)</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-{</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::IsPending(bool *result) {</span>
<a href="#l21.74"></a><span id="l21.74">   FORWARD_CALL(IsPending, result)</span>
<a href="#l21.75"></a><span id="l21.75">   // We haven't been loaded yet, so we're still pending.</span>
<a href="#l21.76"></a><span id="l21.76">   *result = true;</span>
<a href="#l21.77"></a><span id="l21.77">   return NS_OK;</span>
<a href="#l21.78"></a><span id="l21.78"> }</span>
<a href="#l21.79"></a><span id="l21.79"> </span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetStatus(nsresult *status)</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-{</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetStatus(nsresult *status) {</span>
<a href="#l21.83"></a><span id="l21.83">   FORWARD_CALL(GetStatus, status)</span>
<a href="#l21.84"></a><span id="l21.84">   *status = m_cancelStatus;</span>
<a href="#l21.85"></a><span id="l21.85">   return NS_OK;</span>
<a href="#l21.86"></a><span id="l21.86"> }</span>
<a href="#l21.87"></a><span id="l21.87"> </span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::Cancel(nsresult status)</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-{</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::Cancel(nsresult status) {</span>
<a href="#l21.91"></a><span id="l21.91">   m_cancelStatus = status;</span>
<a href="#l21.92"></a><span id="l21.92">   m_channelState = CHANNEL_CLOSED;</span>
<a href="#l21.93"></a><span id="l21.93">   return NS_OK;</span>
<a href="#l21.94"></a><span id="l21.94"> }</span>
<a href="#l21.95"></a><span id="l21.95"> </span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::Suspend()</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-{</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::Suspend() {</span>
<a href="#l21.99"></a><span id="l21.99">   MOZ_ASSERT_UNREACHABLE(&quot;nsNntpMockChannel::Suspend&quot;);</span>
<a href="#l21.100"></a><span id="l21.100">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.101"></a><span id="l21.101"> }</span>
<a href="#l21.102"></a><span id="l21.102"> </span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::Resume()</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-{</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::Resume() {</span>
<a href="#l21.106"></a><span id="l21.106">   MOZ_ASSERT_UNREACHABLE(&quot;nsNntpMockChannel::Resume&quot;);</span>
<a href="#l21.107"></a><span id="l21.107">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.108"></a><span id="l21.108"> }</span>
<a href="#l21.109"></a><span id="l21.109"> </span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetLoadGroup(nsILoadGroup *aLoadGroup)</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-{</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetLoadGroup(nsILoadGroup *aLoadGroup) {</span>
<a href="#l21.113"></a><span id="l21.113">   FORWARD_CALL(SetLoadGroup, aLoadGroup)</span>
<a href="#l21.114"></a><span id="l21.114">   m_loadGroup = aLoadGroup;</span>
<a href="#l21.115"></a><span id="l21.115">   return NS_OK;</span>
<a href="#l21.116"></a><span id="l21.116"> }</span>
<a href="#l21.117"></a><span id="l21.117"> </span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetLoadGroup(nsILoadGroup **aLoadGroup)</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-{</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetLoadGroup(nsILoadGroup **aLoadGroup) {</span>
<a href="#l21.121"></a><span id="l21.121">   FORWARD_CALL(GetLoadGroup, aLoadGroup)</span>
<a href="#l21.122"></a><span id="l21.122">   NS_IF_ADDREF(*aLoadGroup = m_loadGroup);</span>
<a href="#l21.123"></a><span id="l21.123">   return NS_OK;</span>
<a href="#l21.124"></a><span id="l21.124"> }</span>
<a href="#l21.125"></a><span id="l21.125"> </span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetLoadFlags(nsLoadFlags *aLoadFlags)</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-{</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetLoadFlags(nsLoadFlags *aLoadFlags) {</span>
<a href="#l21.129"></a><span id="l21.129">   FORWARD_CALL(GetLoadFlags, aLoadFlags)</span>
<a href="#l21.130"></a><span id="l21.130">   *aLoadFlags = m_loadFlags;</span>
<a href="#l21.131"></a><span id="l21.131">   return NS_OK;</span>
<a href="#l21.132"></a><span id="l21.132"> }</span>
<a href="#l21.133"></a><span id="l21.133"> </span>
<a href="#l21.134"></a><span id="l21.134" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetLoadFlags(nsLoadFlags aLoadFlags)</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-{</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetLoadFlags(nsLoadFlags aLoadFlags) {</span>
<a href="#l21.137"></a><span id="l21.137">   FORWARD_CALL(SetLoadFlags, aLoadFlags)</span>
<a href="#l21.138"></a><span id="l21.138">   m_loadFlags = aLoadFlags;</span>
<a href="#l21.139"></a><span id="l21.139">   return NS_OK;</span>
<a href="#l21.140"></a><span id="l21.140"> }</span>
<a href="#l21.141"></a><span id="l21.141"> </span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetLoadInfo(nsILoadInfo **aLoadInfo)</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-{</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetLoadInfo(nsILoadInfo **aLoadInfo) {</span>
<a href="#l21.145"></a><span id="l21.145">   FORWARD_CALL(GetLoadInfo, aLoadInfo)</span>
<a href="#l21.146"></a><span id="l21.146">   NS_IF_ADDREF(*aLoadInfo = m_loadInfo);</span>
<a href="#l21.147"></a><span id="l21.147">   return NS_OK;</span>
<a href="#l21.148"></a><span id="l21.148"> }</span>
<a href="#l21.149"></a><span id="l21.149"> </span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetLoadInfo(nsILoadInfo *aLoadInfo)</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-{</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetLoadInfo(nsILoadInfo *aLoadInfo) {</span>
<a href="#l21.153"></a><span id="l21.153">   FORWARD_CALL(SetLoadInfo, aLoadInfo)</span>
<a href="#l21.154"></a><span id="l21.154">   m_loadInfo = aLoadInfo;</span>
<a href="#l21.155"></a><span id="l21.155">   return NS_OK;</span>
<a href="#l21.156"></a><span id="l21.156"> }</span>
<a href="#l21.157"></a><span id="l21.157"> </span>
<a href="#l21.158"></a><span id="l21.158"> ////////////////////////</span>
<a href="#l21.159"></a><span id="l21.159"> // nsIChannel methods //</span>
<a href="#l21.160"></a><span id="l21.160"> ////////////////////////</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetOriginalURI(nsIURI **aURI)</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-{</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetOriginalURI(nsIURI **aURI) {</span>
<a href="#l21.165"></a><span id="l21.165">   FORWARD_CALL(GetOriginalURI, aURI)</span>
<a href="#l21.166"></a><span id="l21.166">   NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l21.167"></a><span id="l21.167">   return NS_OK;</span>
<a href="#l21.168"></a><span id="l21.168"> }</span>
<a href="#l21.169"></a><span id="l21.169"> </span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetOriginalURI(nsIURI *aURI)</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-{</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetOriginalURI(nsIURI *aURI) {</span>
<a href="#l21.173"></a><span id="l21.173">   FORWARD_CALL(SetOriginalURI, aURI)</span>
<a href="#l21.174"></a><span id="l21.174">   // News does not seem to have the notion of an original URI.</span>
<a href="#l21.175"></a><span id="l21.175">   // (See bug 193317 and bug 1312314.)</span>
<a href="#l21.176"></a><span id="l21.176">   return NS_OK;</span>
<a href="#l21.177"></a><span id="l21.177"> }</span>
<a href="#l21.178"></a><span id="l21.178"> </span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetURI(nsIURI **aURI)</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-{</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetURI(nsIURI **aURI) {</span>
<a href="#l21.182"></a><span id="l21.182">   NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l21.183"></a><span id="l21.183">   return NS_OK;</span>
<a href="#l21.184"></a><span id="l21.184"> }</span>
<a href="#l21.185"></a><span id="l21.185"> </span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetOwner(nsISupports **owner)</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-{</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetOwner(nsISupports **owner) {</span>
<a href="#l21.189"></a><span id="l21.189">   FORWARD_CALL(GetOwner, owner)</span>
<a href="#l21.190"></a><span id="l21.190">   NS_IF_ADDREF(*owner = m_owner);</span>
<a href="#l21.191"></a><span id="l21.191">   return NS_OK;</span>
<a href="#l21.192"></a><span id="l21.192"> }</span>
<a href="#l21.193"></a><span id="l21.193"> </span>
<a href="#l21.194"></a><span id="l21.194" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetOwner(nsISupports *aOwner)</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-{</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetOwner(nsISupports *aOwner) {</span>
<a href="#l21.197"></a><span id="l21.197">   FORWARD_CALL(SetOwner, aOwner)</span>
<a href="#l21.198"></a><span id="l21.198">   m_owner = aOwner;</span>
<a href="#l21.199"></a><span id="l21.199">   return NS_OK;</span>
<a href="#l21.200"></a><span id="l21.200"> }</span>
<a href="#l21.201"></a><span id="l21.201"> </span>
<a href="#l21.202"></a><span id="l21.202"> NS_IMETHODIMP</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineminus">-nsNntpMockChannel::GetNotificationCallbacks(nsIInterfaceRequestor **callbacks)</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineminus">-{</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineplus">+nsNntpMockChannel::GetNotificationCallbacks(nsIInterfaceRequestor **callbacks) {</span>
<a href="#l21.206"></a><span id="l21.206">   FORWARD_CALL(GetNotificationCallbacks, callbacks)</span>
<a href="#l21.207"></a><span id="l21.207">   NS_IF_ADDREF(*callbacks = m_notificationCallbacks);</span>
<a href="#l21.208"></a><span id="l21.208">   return NS_OK;</span>
<a href="#l21.209"></a><span id="l21.209"> }</span>
<a href="#l21.210"></a><span id="l21.210"> </span>
<a href="#l21.211"></a><span id="l21.211"> NS_IMETHODIMP</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-nsNntpMockChannel::SetNotificationCallbacks(nsIInterfaceRequestor *aCallbacks)</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-{</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineplus">+nsNntpMockChannel::SetNotificationCallbacks(nsIInterfaceRequestor *aCallbacks) {</span>
<a href="#l21.215"></a><span id="l21.215">   FORWARD_CALL(SetNotificationCallbacks, aCallbacks)</span>
<a href="#l21.216"></a><span id="l21.216">   m_notificationCallbacks = aCallbacks;</span>
<a href="#l21.217"></a><span id="l21.217">   return NS_OK;</span>
<a href="#l21.218"></a><span id="l21.218"> }</span>
<a href="#l21.219"></a><span id="l21.219"> </span>
<a href="#l21.220"></a><span id="l21.220" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetSecurityInfo(nsISupports **securityInfo)</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineminus">-{</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetSecurityInfo(nsISupports **securityInfo) {</span>
<a href="#l21.223"></a><span id="l21.223">   FORWARD_CALL(GetSecurityInfo, securityInfo)</span>
<a href="#l21.224"></a><span id="l21.224">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.225"></a><span id="l21.225"> }</span>
<a href="#l21.226"></a><span id="l21.226"> </span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetContentType(nsACString &amp;aContentType)</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineminus">-{</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetContentType(nsACString &amp;aContentType) {</span>
<a href="#l21.230"></a><span id="l21.230">   FORWARD_CALL(GetContentType, aContentType)</span>
<a href="#l21.231"></a><span id="l21.231">   aContentType = m_contentType;</span>
<a href="#l21.232"></a><span id="l21.232">   return NS_OK;</span>
<a href="#l21.233"></a><span id="l21.233"> }</span>
<a href="#l21.234"></a><span id="l21.234"> </span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetContentType(const nsACString &amp;aContentType)</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineminus">-{</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetContentType(</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineplus">+    const nsACString &amp;aContentType) {</span>
<a href="#l21.239"></a><span id="l21.239">   FORWARD_CALL(SetContentType, aContentType)</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineminus">-  return NS_ParseResponseContentType(aContentType, m_contentType, m_contentCharset);</span>
<a href="#l21.241"></a><span id="l21.241" class="difflineplus">+  return NS_ParseResponseContentType(aContentType, m_contentType,</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineplus">+                                     m_contentCharset);</span>
<a href="#l21.243"></a><span id="l21.243"> }</span>
<a href="#l21.244"></a><span id="l21.244"> </span>
<a href="#l21.245"></a><span id="l21.245" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetContentCharset(nsACString &amp;aCharset)</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineminus">-{</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetContentCharset(nsACString &amp;aCharset) {</span>
<a href="#l21.248"></a><span id="l21.248">   FORWARD_CALL(GetContentCharset, aCharset)</span>
<a href="#l21.249"></a><span id="l21.249">   aCharset = m_contentCharset;</span>
<a href="#l21.250"></a><span id="l21.250">   return NS_OK;</span>
<a href="#l21.251"></a><span id="l21.251"> }</span>
<a href="#l21.252"></a><span id="l21.252"> </span>
<a href="#l21.253"></a><span id="l21.253" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::SetContentCharset(const nsACString &amp;aCharset)</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineminus">-{</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::SetContentCharset(const nsACString &amp;aCharset) {</span>
<a href="#l21.256"></a><span id="l21.256">   FORWARD_CALL(SetContentCharset, aCharset)</span>
<a href="#l21.257"></a><span id="l21.257">   m_contentCharset = aCharset;</span>
<a href="#l21.258"></a><span id="l21.258">   return NS_OK;</span>
<a href="#l21.259"></a><span id="l21.259"> }</span>
<a href="#l21.260"></a><span id="l21.260"> </span>
<a href="#l21.261"></a><span id="l21.261"> NS_IMETHODIMP</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineminus">-nsNntpMockChannel::GetContentDisposition(uint32_t *aContentDisposition)</span>
<a href="#l21.263"></a><span id="l21.263" class="difflineminus">-{</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineplus">+nsNntpMockChannel::GetContentDisposition(uint32_t *aContentDisposition) {</span>
<a href="#l21.265"></a><span id="l21.265">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l21.266"></a><span id="l21.266"> }</span>
<a href="#l21.267"></a><span id="l21.267"> </span>
<a href="#l21.268"></a><span id="l21.268"> NS_IMETHODIMP</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-nsNntpMockChannel::SetContentDisposition(uint32_t aContentDisposition)</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineminus">-{</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineplus">+nsNntpMockChannel::SetContentDisposition(uint32_t aContentDisposition) {</span>
<a href="#l21.272"></a><span id="l21.272">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l21.273"></a><span id="l21.273"> }</span>
<a href="#l21.274"></a><span id="l21.274"> </span>
<a href="#l21.275"></a><span id="l21.275"> NS_IMETHODIMP</span>
<a href="#l21.276"></a><span id="l21.276" class="difflineminus">-nsNntpMockChannel::GetContentDispositionFilename(nsAString &amp;aContentDispositionFilename)</span>
<a href="#l21.277"></a><span id="l21.277" class="difflineminus">-{</span>
<a href="#l21.278"></a><span id="l21.278" class="difflineplus">+nsNntpMockChannel::GetContentDispositionFilename(</span>
<a href="#l21.279"></a><span id="l21.279" class="difflineplus">+    nsAString &amp;aContentDispositionFilename) {</span>
<a href="#l21.280"></a><span id="l21.280">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l21.281"></a><span id="l21.281"> }</span>
<a href="#l21.282"></a><span id="l21.282"> </span>
<a href="#l21.283"></a><span id="l21.283"> NS_IMETHODIMP</span>
<a href="#l21.284"></a><span id="l21.284" class="difflineminus">-nsNntpMockChannel::SetContentDispositionFilename(const nsAString &amp;aContentDispositionFilename)</span>
<a href="#l21.285"></a><span id="l21.285" class="difflineminus">-{</span>
<a href="#l21.286"></a><span id="l21.286" class="difflineplus">+nsNntpMockChannel::SetContentDispositionFilename(</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineplus">+    const nsAString &amp;aContentDispositionFilename) {</span>
<a href="#l21.288"></a><span id="l21.288">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l21.289"></a><span id="l21.289"> }</span>
<a href="#l21.290"></a><span id="l21.290"> </span>
<a href="#l21.291"></a><span id="l21.291"> NS_IMETHODIMP</span>
<a href="#l21.292"></a><span id="l21.292" class="difflineminus">-nsNntpMockChannel::GetContentDispositionHeader(nsACString &amp;aContentDispositionHeader)</span>
<a href="#l21.293"></a><span id="l21.293" class="difflineminus">-{</span>
<a href="#l21.294"></a><span id="l21.294" class="difflineplus">+nsNntpMockChannel::GetContentDispositionHeader(</span>
<a href="#l21.295"></a><span id="l21.295" class="difflineplus">+    nsACString &amp;aContentDispositionHeader) {</span>
<a href="#l21.296"></a><span id="l21.296">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l21.297"></a><span id="l21.297"> }</span>
<a href="#l21.298"></a><span id="l21.298"> </span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::GetContentLength(int64_t *length)</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineminus">-{</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::GetContentLength(int64_t *length) {</span>
<a href="#l21.302"></a><span id="l21.302">   FORWARD_CALL(GetContentLength, length)</span>
<a href="#l21.303"></a><span id="l21.303">   *length = m_contentLength;</span>
<a href="#l21.304"></a><span id="l21.304">   return NS_OK;</span>
<a href="#l21.305"></a><span id="l21.305"> }</span>
<a href="#l21.306"></a><span id="l21.306"> </span>
<a href="#l21.307"></a><span id="l21.307"> NS_IMETHODIMP</span>
<a href="#l21.308"></a><span id="l21.308" class="difflineminus">-nsNntpMockChannel::SetContentLength(int64_t aLength)</span>
<a href="#l21.309"></a><span id="l21.309" class="difflineminus">-{</span>
<a href="#l21.310"></a><span id="l21.310" class="difflineplus">+nsNntpMockChannel::SetContentLength(int64_t aLength) {</span>
<a href="#l21.311"></a><span id="l21.311">   FORWARD_CALL(SetContentLength, aLength)</span>
<a href="#l21.312"></a><span id="l21.312">   m_contentLength = aLength;</span>
<a href="#l21.313"></a><span id="l21.313">   return NS_OK;</span>
<a href="#l21.314"></a><span id="l21.314"> }</span>
<a href="#l21.315"></a><span id="l21.315"> </span>
<a href="#l21.316"></a><span id="l21.316"> NS_IMETHODIMP</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineminus">-nsNntpMockChannel::GetIsDocument(bool *aIsDocument)</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-{</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineplus">+nsNntpMockChannel::GetIsDocument(bool *aIsDocument) {</span>
<a href="#l21.320"></a><span id="l21.320">   return NS_GetIsDocumentChannel(this, aIsDocument);</span>
<a href="#l21.321"></a><span id="l21.321"> }</span>
<a href="#l21.322"></a><span id="l21.322"> </span>
<a href="#l21.323"></a><span id="l21.323"> ////////////////////////////////////////</span>
<a href="#l21.324"></a><span id="l21.324"> // nsIChannel and nsNNTPProtocol glue //</span>
<a href="#l21.325"></a><span id="l21.325"> ////////////////////////////////////////</span>
<a href="#l21.326"></a><span id="l21.326"> </span>
<a href="#l21.327"></a><span id="l21.327" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::Open(nsIInputStream **_retval)</span>
<a href="#l21.328"></a><span id="l21.328" class="difflineminus">-{</span>
<a href="#l21.329"></a><span id="l21.329" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::Open(nsIInputStream **_retval) {</span>
<a href="#l21.330"></a><span id="l21.330">   nsCOMPtr&lt;nsIStreamListener&gt; listener;</span>
<a href="#l21.331"></a><span id="l21.331" class="difflineminus">-  nsresult rv = nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineplus">+  nsresult rv =</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineplus">+      nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l21.334"></a><span id="l21.334">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.335"></a><span id="l21.335">   return NS_ImplementChannelOpen(this, _retval);</span>
<a href="#l21.336"></a><span id="l21.336"> }</span>
<a href="#l21.337"></a><span id="l21.337"> </span>
<a href="#l21.338"></a><span id="l21.338" class="difflineminus">-NS_IMETHODIMP nsNntpMockChannel::AsyncOpen(nsIStreamListener *aListener)</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineminus">-{</span>
<a href="#l21.340"></a><span id="l21.340" class="difflineplus">+NS_IMETHODIMP nsNntpMockChannel::AsyncOpen(nsIStreamListener *aListener) {</span>
<a href="#l21.341"></a><span id="l21.341">   nsCOMPtr&lt;nsIStreamListener&gt; listener = aListener;</span>
<a href="#l21.342"></a><span id="l21.342" class="difflineminus">-  nsresult rv = nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l21.343"></a><span id="l21.343" class="difflineplus">+  nsresult rv =</span>
<a href="#l21.344"></a><span id="l21.344" class="difflineplus">+      nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l21.345"></a><span id="l21.345">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.346"></a><span id="l21.346">   m_channelState = CHANNEL_OPEN_WITH_ASYNC;</span>
<a href="#l21.347"></a><span id="l21.347">   m_channelListener = listener;</span>
<a href="#l21.348"></a><span id="l21.348">   m_context = nullptr;</span>
<a href="#l21.349"></a><span id="l21.349" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l21.351"></a><span id="l21.351">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l21.352"></a><span id="l21.352">   QueryInterface(NS_GET_IID(nsIChannel), getter_AddRefs(channel));</span>
<a href="#l21.353"></a><span id="l21.353">   if (channel) {</span>
<a href="#l21.354"></a><span id="l21.354">     channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l21.355"></a><span id="l21.355">     m_context = uri;</span>
<a href="#l21.356"></a><span id="l21.356">   }</span>
<a href="#l21.357"></a><span id="l21.357">   return NS_OK;</span>
<a href="#l21.358"></a><span id="l21.358"> }</span>
<a href="#l21.359"></a><span id="l21.359"> </span>
<a href="#l21.360"></a><span id="l21.360" class="difflineminus">-nsresult</span>
<a href="#l21.361"></a><span id="l21.361" class="difflineminus">-nsNntpMockChannel::AttachNNTPConnection(nsNNTPProtocol &amp;protocol)</span>
<a href="#l21.362"></a><span id="l21.362" class="difflineminus">-{</span>
<a href="#l21.363"></a><span id="l21.363" class="difflineplus">+nsresult nsNntpMockChannel::AttachNNTPConnection(nsNNTPProtocol &amp;protocol) {</span>
<a href="#l21.364"></a><span id="l21.364">   // First things first. Were we canceled? If so, tell the protocol.</span>
<a href="#l21.365"></a><span id="l21.365">   if (m_channelState == CHANNEL_CLOSED || m_channelState == CHANNEL_UNOPENED)</span>
<a href="#l21.366"></a><span id="l21.366">     return NS_ERROR_FAILURE;</span>
<a href="#l21.367"></a><span id="l21.367"> </span>
<a href="#l21.368"></a><span id="l21.368" class="difflineminus">-</span>
<a href="#l21.369"></a><span id="l21.369">   // We're going to active the protocol now. Note that if the user has</span>
<a href="#l21.370"></a><span id="l21.370">   // interacted with us through the nsIChannel API, we need to pass it to the</span>
<a href="#l21.371"></a><span id="l21.371">   // protocol instance. We also need to initialize it. For best results, we're</span>
<a href="#l21.372"></a><span id="l21.372">   // going to initialize the code and then set the values.</span>
<a href="#l21.373"></a><span id="l21.373">   nsresult rv = protocol.Initialize(m_url, m_msgWindow);</span>
<a href="#l21.374"></a><span id="l21.374">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.375"></a><span id="l21.375"> </span>
<a href="#l21.376"></a><span id="l21.376">   // Variable fun</span>
<a href="#l21.377"></a><span id="l21.377" class="difflineat">@@ -325,27 +288,26 @@ nsNntpMockChannel::AttachNNTPConnection(</span>
<a href="#l21.378"></a><span id="l21.378">   protocol.SetContentType(m_contentType);</span>
<a href="#l21.379"></a><span id="l21.379"> </span>
<a href="#l21.380"></a><span id="l21.380">   // Now that we've set up the protocol, attach it to ourselves so that we can</span>
<a href="#l21.381"></a><span id="l21.381">   // forward all future calls to the protocol instance. We do not refcount this</span>
<a href="#l21.382"></a><span id="l21.382">   // instance, since the server will be owning all of them: once the server</span>
<a href="#l21.383"></a><span id="l21.383">   // releases its reference, the protocol instance is no longer usable anyways.</span>
<a href="#l21.384"></a><span id="l21.384">   m_protocol = &amp;protocol;</span>
<a href="#l21.385"></a><span id="l21.385"> </span>
<a href="#l21.386"></a><span id="l21.386" class="difflineminus">-  switch (m_channelState)</span>
<a href="#l21.387"></a><span id="l21.387" class="difflineminus">-  {</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineminus">-  case CHANNEL_OPEN_WITH_LOAD:</span>
<a href="#l21.389"></a><span id="l21.389" class="difflineminus">-    rv = protocol.LoadNewsUrl(m_url, m_context);</span>
<a href="#l21.390"></a><span id="l21.390" class="difflineminus">-    break;</span>
<a href="#l21.391"></a><span id="l21.391" class="difflineminus">-  case CHANNEL_OPEN_WITH_ASYNC:</span>
<a href="#l21.392"></a><span id="l21.392" class="difflineminus">-    rv = protocol.AsyncOpen(m_channelListener);</span>
<a href="#l21.393"></a><span id="l21.393" class="difflineminus">-    break;</span>
<a href="#l21.394"></a><span id="l21.394" class="difflineminus">-  default:</span>
<a href="#l21.395"></a><span id="l21.395" class="difflineminus">-    MOZ_ASSERT_UNREACHABLE(&quot;Unknown channel state got us here.&quot;);</span>
<a href="#l21.396"></a><span id="l21.396" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l21.397"></a><span id="l21.397" class="difflineplus">+  switch (m_channelState) {</span>
<a href="#l21.398"></a><span id="l21.398" class="difflineplus">+    case CHANNEL_OPEN_WITH_LOAD:</span>
<a href="#l21.399"></a><span id="l21.399" class="difflineplus">+      rv = protocol.LoadNewsUrl(m_url, m_context);</span>
<a href="#l21.400"></a><span id="l21.400" class="difflineplus">+      break;</span>
<a href="#l21.401"></a><span id="l21.401" class="difflineplus">+    case CHANNEL_OPEN_WITH_ASYNC:</span>
<a href="#l21.402"></a><span id="l21.402" class="difflineplus">+      rv = protocol.AsyncOpen(m_channelListener);</span>
<a href="#l21.403"></a><span id="l21.403" class="difflineplus">+      break;</span>
<a href="#l21.404"></a><span id="l21.404" class="difflineplus">+    default:</span>
<a href="#l21.405"></a><span id="l21.405" class="difflineplus">+      MOZ_ASSERT_UNREACHABLE(&quot;Unknown channel state got us here.&quot;);</span>
<a href="#l21.406"></a><span id="l21.406" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l21.407"></a><span id="l21.407">   }</span>
<a href="#l21.408"></a><span id="l21.408"> </span>
<a href="#l21.409"></a><span id="l21.409">   // If we fail, that means that loading the NNTP protocol failed. Since we</span>
<a href="#l21.410"></a><span id="l21.410">   // essentially promised that we would load (by virtue of returning NS_OK to</span>
<a href="#l21.411"></a><span id="l21.411">   // AsyncOpen), we must now tell our listener the bad news.</span>
<a href="#l21.412"></a><span id="l21.412">   if (NS_FAILED(rv) &amp;&amp; m_channelListener)</span>
<a href="#l21.413"></a><span id="l21.413">     m_channelListener-&gt;OnStopRequest(this, rv);</span>
<a href="#l21.414"></a><span id="l21.414"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/news/src/nsNntpMockChannel.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpMockChannel.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -9,46 +9,45 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsString.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> class nsNNTPProtocol;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-class nsNntpMockChannel : public nsIChannel</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-public:</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+class nsNntpMockChannel : public nsIChannel {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+ public:</span>
<a href="#l22.17"></a><span id="l22.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l22.18"></a><span id="l22.18">   NS_DECL_NSICHANNEL</span>
<a href="#l22.19"></a><span id="l22.19">   NS_DECL_NSIREQUEST</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">   nsNntpMockChannel(nsIURI *aUri, nsIMsgWindow *aMsgWindow);</span>
<a href="#l22.22"></a><span id="l22.22">   nsNntpMockChannel(nsIURI *aUri, nsIMsgWindow *aMsgWindow,</span>
<a href="#l22.23"></a><span id="l22.23">                     nsISupports *aConsumer);</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">   nsresult AttachNNTPConnection(nsNNTPProtocol &amp;protocol);</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-protected:</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+ protected:</span>
<a href="#l22.29"></a><span id="l22.29">   virtual ~nsNntpMockChannel();</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31">   // The URL we will be running</span>
<a href="#l22.32"></a><span id="l22.32">   nsCOMPtr&lt;nsIURI&gt; m_url;</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">   // Variables for arguments to pass into the opening phase.</span>
<a href="#l22.35"></a><span id="l22.35">   nsCOMPtr&lt;nsIStreamListener&gt; m_channelListener;</span>
<a href="#l22.36"></a><span id="l22.36">   nsCOMPtr&lt;nsISupports&gt; m_context;</span>
<a href="#l22.37"></a><span id="l22.37">   nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39">   // The state we're in</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-  enum</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  {</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-    CHANNEL_UNOPENED,        //!&lt; No one bothered to open this yet</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-    CHANNEL_OPEN_WITH_LOAD,  //!&lt; We should open with LoadNewsUrl</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-    CHANNEL_OPEN_WITH_ASYNC, //!&lt; We should open with AsyncOpen</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    CHANNEL_CLOSED           //!&lt; We were closed and should not open</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+  enum {</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+    CHANNEL_UNOPENED,         //!&lt; No one bothered to open this yet</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    CHANNEL_OPEN_WITH_LOAD,   //!&lt; We should open with LoadNewsUrl</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+    CHANNEL_OPEN_WITH_ASYNC,  //!&lt; We should open with AsyncOpen</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+    CHANNEL_CLOSED            //!&lt; We were closed and should not open</span>
<a href="#l22.51"></a><span id="l22.51">   } m_channelState;</span>
<a href="#l22.52"></a><span id="l22.52"> </span>
<a href="#l22.53"></a><span id="l22.53">   // The protocol instance</span>
<a href="#l22.54"></a><span id="l22.54">   nsNNTPProtocol *m_protocol;</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">   // Temporary variables for accessors before we get to the actual instance.</span>
<a href="#l22.57"></a><span id="l22.57">   nsresult m_cancelStatus;</span>
<a href="#l22.58"></a><span id="l22.58">   nsCOMPtr&lt;nsILoadGroup&gt; m_loadGroup;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l23.5"></a><span id="l23.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.6"></a><span id="l23.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.7"></a><span id="l23.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l23.11"></a><span id="l23.11"> #include &quot;nntpCore.h&quot;</span>
<a href="#l23.12"></a><span id="l23.12"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13"> #include &quot;nsINntpUrl.h&quot;</span>
<a href="#l23.14"></a><span id="l23.14"> #include &quot;nsIMsgNewsFolder.h&quot;</span>
<a href="#l23.15"></a><span id="l23.15"> #include &quot;nsNNTPNewsgroupPost.h&quot;</span>
<a href="#l23.16"></a><span id="l23.16"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l23.17"></a><span id="l23.17"> #include &quot;nsString.h&quot;</span>
<a href="#l23.18"></a><span id="l23.18"> #include &quot;nsNewsUtils.h&quot;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineat">@@ -47,679 +47,647 @@</span>
<a href="#l23.20"></a><span id="l23.20"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l23.21"></a><span id="l23.21"> #include &quot;mozilla/LoadInfo.h&quot;</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23"> #include &quot;../../base/src/MailnewsLoadContextInfo.h&quot;</span>
<a href="#l23.24"></a><span id="l23.24"> </span>
<a href="#l23.25"></a><span id="l23.25"> #undef GetPort  // XXX Windows!</span>
<a href="#l23.26"></a><span id="l23.26"> #undef SetPort  // XXX Windows!</span>
<a href="#l23.27"></a><span id="l23.27"> </span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-#define PREF_MAIL_ROOT_NNTP   &quot;mail.root.nntp&quot;        // old - for backward compatibility only</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-#define PREF_MAIL_ROOT_NNTP_REL   &quot;mail.root.nntp-rel&quot;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+#define PREF_MAIL_ROOT_NNTP \</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  &quot;mail.root.nntp&quot;  // old - for backward compatibility only</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+#define PREF_MAIL_ROOT_NNTP_REL &quot;mail.root.nntp-rel&quot;</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-nsNntpService::nsNntpService()</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-{</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+nsNntpService::nsNntpService() {</span>
<a href="#l23.37"></a><span id="l23.37">   mPrintingOperation = false;</span>
<a href="#l23.38"></a><span id="l23.38">   mOpenAttachmentOperation = false;</span>
<a href="#l23.39"></a><span id="l23.39"> }</span>
<a href="#l23.40"></a><span id="l23.40"> </span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-nsNntpService::~nsNntpService()</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-{</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+nsNntpService::~nsNntpService() {</span>
<a href="#l23.44"></a><span id="l23.44">   // do nothing</span>
<a href="#l23.45"></a><span id="l23.45"> }</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47"> NS_IMPL_ISUPPORTS(nsNntpService, nsINntpService, nsIMsgMessageService,</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-  nsIProtocolHandler, nsIMsgProtocolInfo, nsICommandLineHandler,</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-  nsIMsgMessageFetchPartService, nsIContentHandler)</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+                  nsIProtocolHandler, nsIMsgProtocolInfo, nsICommandLineHandler,</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+                  nsIMsgMessageFetchPartService, nsIContentHandler)</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.54"></a><span id="l23.54"> // nsIMsgMessageService support</span>
<a href="#l23.55"></a><span id="l23.55"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57"> NS_IMETHODIMP</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-nsNntpService::SaveMessageToDisk(const char *aMessageURI,</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-                                 nsIFile *aFile,</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+nsNntpService::SaveMessageToDisk(const char *aMessageURI, nsIFile *aFile,</span>
<a href="#l23.61"></a><span id="l23.61">                                  bool aAddDummyEnvelope,</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-                                 nsIUrlListener *aUrlListener,</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-                                 nsIURI **aURL,</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+                                 nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l23.65"></a><span id="l23.65">                                  bool canonicalLineEnding,</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-                                 nsIMsgWindow *aMsgWindow)</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-{</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+                                 nsIMsgWindow *aMsgWindow) {</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-    // double check it is a news-message:/ uri</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-    if (PL_strncmp(aMessageURI, kNewsMessageRootURI, kNewsMessageRootURILen))</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-    {</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-    }</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+  // double check it is a news-message:/ uri</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+  if (PL_strncmp(aMessageURI, kNewsMessageRootURI, kNewsMessageRootURILen)) {</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+    rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+  }</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-    nsMsgKey key = nsMsgKey_None;</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-    rv = DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+  nsMsgKey key = nsMsgKey_None;</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+  rv = DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+  nsCString messageIdURL;</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+  rv = CreateMessageIDURL(folder, key, getter_Copies(messageIdURL));</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-    nsCString messageIdURL;</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-    rv = CreateMessageIDURL(folder, key, getter_Copies(messageIdURL));</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-    rv = ConstructNntpUrl(messageIdURL.get(), aUrlListener, aMsgWindow, aMessageURI, nsINntpUrl::ActionSaveMessageToDisk, getter_AddRefs(url));</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+  rv = ConstructNntpUrl(messageIdURL.get(), aUrlListener, aMsgWindow,</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+                        aMessageURI, nsINntpUrl::ActionSaveMessageToDisk,</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+                        getter_AddRefs(url));</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.111"></a><span id="l23.111"> </span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(url);</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-    if (msgUrl) {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-//        msgUrl-&gt;SetMessageFile(aFile);</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-        msgUrl-&gt;SetAddDummyEnvelope(aAddDummyEnvelope);</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-        msgUrl-&gt;SetCanonicalLineEnding(canonicalLineEnding);</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-    }</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-    bool hasMsgOffline = false;</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(url);</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+  if (msgUrl) {</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+    //        msgUrl-&gt;SetMessageFile(aFile);</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+    msgUrl-&gt;SetAddDummyEnvelope(aAddDummyEnvelope);</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+    msgUrl-&gt;SetCanonicalLineEnding(canonicalLineEnding);</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+  }</span>
<a href="#l23.126"></a><span id="l23.126"> </span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(url);</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-    if (folder)</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-    {</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-      nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(folder);</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-      if (newsFolder)</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-      {</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-        if (mailNewsUrl)</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-        {</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-          folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-          mailNewsUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-        }</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+  bool hasMsgOffline = false;</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(url);</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+  if (folder) {</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+    nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(folder);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+    if (newsFolder) {</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+      if (mailNewsUrl) {</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+        folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineplus">+        mailNewsUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l23.147"></a><span id="l23.147">       }</span>
<a href="#l23.148"></a><span id="l23.148">     }</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+  }</span>
<a href="#l23.150"></a><span id="l23.150"> </span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-    if (mailNewsUrl)</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-    {</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-      nsCOMPtr &lt;nsIStreamListener&gt; saveAsListener;</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-      mailNewsUrl-&gt;GetSaveAsListener(aAddDummyEnvelope, aFile, getter_AddRefs(saveAsListener));</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+  if (mailNewsUrl) {</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; saveAsListener;</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+    mailNewsUrl-&gt;GetSaveAsListener(aAddDummyEnvelope, aFile,</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+                                   getter_AddRefs(saveAsListener));</span>
<a href="#l23.159"></a><span id="l23.159"> </span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-      rv = DisplayMessage(aMessageURI, saveAsListener, /* nsIMsgWindow *aMsgWindow */nullptr, aUrlListener, nullptr /*aCharsetOverride */, aURL);</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-    }</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-    return rv;</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+    rv = DisplayMessage(aMessageURI, saveAsListener,</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+                        /* nsIMsgWindow *aMsgWindow */ nullptr, aUrlListener,</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+                        nullptr /*aCharsetOverride */, aURL);</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+  }</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineplus">+  return rv;</span>
<a href="#l23.168"></a><span id="l23.168"> }</span>
<a href="#l23.169"></a><span id="l23.169"> </span>
<a href="#l23.170"></a><span id="l23.170" class="difflineplus">+nsresult nsNntpService::CreateMessageIDURL(nsIMsgFolder *folder, nsMsgKey key,</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+                                           char **url) {</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineplus">+  NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+  NS_ENSURE_ARG_POINTER(url);</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineplus">+  if (key == nsMsgKey_None) return NS_ERROR_INVALID_ARG;</span>
<a href="#l23.175"></a><span id="l23.175"> </span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-nsresult</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-nsNntpService::CreateMessageIDURL(nsIMsgFolder *folder, nsMsgKey key, char **url)</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-{</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-    NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-    NS_ENSURE_ARG_POINTER(url);</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-    if (key == nsMsgKey_None) return NS_ERROR_INVALID_ARG;</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineplus">+  nsresult rv;</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineplus">+  nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.185"></a><span id="l23.185"> </span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-    nsresult rv;</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-    nsCOMPtr &lt;nsIMsgNewsFolder&gt; newsFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineplus">+  nsCString messageID;</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+  rv = newsFolder-&gt;GetMessageIdForKey(key, messageID);</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.192"></a><span id="l23.192"> </span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-    nsCString messageID;</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-    rv = newsFolder-&gt;GetMessageIdForKey(key, messageID);</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-    // we need to escape the message ID,</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-    // it might contain characters which will mess us up later, like #</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-    // see bug #120502</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-    nsCString escapedMessageID;</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-    MsgEscapeString(messageID, nsINetUtil::ESCAPE_URL_PATH, escapedMessageID);</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+  // we need to escape the message ID,</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineplus">+  // it might contain characters which will mess us up later, like #</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineplus">+  // see bug #120502</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineplus">+  nsCString escapedMessageID;</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineplus">+  MsgEscapeString(messageID, nsINetUtil::ESCAPE_URL_PATH, escapedMessageID);</span>
<a href="#l23.207"></a><span id="l23.207"> </span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-    rv = folder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineplus">+  rv = folder-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.214"></a><span id="l23.214"> </span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-    nsCString rootFolderURI;</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineminus">-    rv = rootFolder-&gt;GetURI(rootFolderURI);</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+  nsCString rootFolderURI;</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+  rv = rootFolder-&gt;GetURI(rootFolderURI);</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.221"></a><span id="l23.221"> </span>
<a href="#l23.222"></a><span id="l23.222" class="difflineminus">-    nsString groupName;</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineminus">-    rv = folder-&gt;GetName(groupName);</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineplus">+  nsString groupName;</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineplus">+  rv = folder-&gt;GetName(groupName);</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.228"></a><span id="l23.228"> </span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-    nsAutoCString uri;</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-    uri = rootFolderURI.get();</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-    uri += '/';</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-    uri += escapedMessageID;</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-    uri += kNewsURIGroupQuery; // ?group=</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-    AppendUTF16toUTF8(groupName, uri);</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-    uri += kNewsURIKeyQuery; // &amp;key=</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-    uri.AppendInt(key);</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-    *url = ToNewCString(uri);</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+  nsAutoCString uri;</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineplus">+  uri = rootFolderURI.get();</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineplus">+  uri += '/';</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineplus">+  uri += escapedMessageID;</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+  uri += kNewsURIGroupQuery;  // ?group=</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+  AppendUTF16toUTF8(groupName, uri);</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+  uri += kNewsURIKeyQuery;  // &amp;key=</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+  uri.AppendInt(key);</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineplus">+  *url = ToNewCString(uri);</span>
<a href="#l23.247"></a><span id="l23.247"> </span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-    if (!*url)</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineplus">+  if (!*url) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.251"></a><span id="l23.251"> </span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.254"></a><span id="l23.254"> }</span>
<a href="#l23.255"></a><span id="l23.255"> </span>
<a href="#l23.256"></a><span id="l23.256"> NS_IMETHODIMP</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-nsNntpService::DisplayMessage(const char* aMessageURI, nsISupports * aDisplayConsumer,</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-                                       nsIMsgWindow *aMsgWindow, nsIUrlListener * aUrlListener, const char * aCharsetOverride, nsIURI ** aURL)</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-{</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+nsNntpService::DisplayMessage(const char *aMessageURI,</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineplus">+                              nsISupports *aDisplayConsumer,</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+                              nsIUrlListener *aUrlListener,</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+                              const char *aCharsetOverride, nsIURI **aURL) {</span>
<a href="#l23.265"></a><span id="l23.265">   nsresult rv = NS_OK;</span>
<a href="#l23.266"></a><span id="l23.266">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l23.267"></a><span id="l23.267"> </span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.270"></a><span id="l23.270">   nsMsgKey key = nsMsgKey_None;</span>
<a href="#l23.271"></a><span id="l23.271">   rv = DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.274"></a><span id="l23.274"> </span>
<a href="#l23.275"></a><span id="l23.275">   nsAutoCString urlStr;</span>
<a href="#l23.276"></a><span id="l23.276">   // if we are displaying (or printing), we want the news://host/message-id url</span>
<a href="#l23.277"></a><span id="l23.277">   // we keep the original uri around, for cancelling and so we can get to the</span>
<a href="#l23.278"></a><span id="l23.278">   // articles by doing GROUP and then ARTICLE &lt;n&gt;.</span>
<a href="#l23.279"></a><span id="l23.279">   //</span>
<a href="#l23.280"></a><span id="l23.280">   // using news://host/message-id has an extra benefit.</span>
<a href="#l23.281"></a><span id="l23.281">   // we'll use that to look up in the cache, so if</span>
<a href="#l23.282"></a><span id="l23.282">   // you are reading a message that you've already read, you</span>
<a href="#l23.283"></a><span id="l23.283">   // (from a cross post) it would be in your cache.</span>
<a href="#l23.284"></a><span id="l23.284">   rv = CreateMessageIDURL(folder, key, getter_Copies(urlStr));</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.287"></a><span id="l23.287"> </span>
<a href="#l23.288"></a><span id="l23.288">   // rhp: If we are displaying this message for the purposes of printing, append</span>
<a href="#l23.289"></a><span id="l23.289">   // the magic operand.</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-  if (mPrintingOperation)</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-    urlStr.AppendLiteral(&quot;?header=print&quot;);</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineplus">+  if (mPrintingOperation) urlStr.AppendLiteral(&quot;?header=print&quot;);</span>
<a href="#l23.293"></a><span id="l23.293"> </span>
<a href="#l23.294"></a><span id="l23.294">   nsNewsAction action = nsINntpUrl::ActionFetchArticle;</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-  if (mOpenAttachmentOperation)</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineminus">-    action = nsINntpUrl::ActionFetchPart;</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineplus">+  if (mOpenAttachmentOperation) action = nsINntpUrl::ActionFetchPart;</span>
<a href="#l23.298"></a><span id="l23.298"> </span>
<a href="#l23.299"></a><span id="l23.299">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineminus">-  rv = ConstructNntpUrl(urlStr.get(), aUrlListener, aMsgWindow, aMessageURI, action, getter_AddRefs(url));</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineplus">+  rv = ConstructNntpUrl(urlStr.get(), aUrlListener, aMsgWindow, aMessageURI,</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineplus">+                        action, getter_AddRefs(url));</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.305"></a><span id="l23.305"> </span>
<a href="#l23.306"></a><span id="l23.306">   nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl = do_QueryInterface(url, &amp;rv);</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.309"></a><span id="l23.309"> </span>
<a href="#l23.310"></a><span id="l23.310">   i18nurl-&gt;SetCharsetOverRide(aCharsetOverride);</span>
<a href="#l23.311"></a><span id="l23.311"> </span>
<a href="#l23.312"></a><span id="l23.312">   bool shouldStoreMsgOffline = false;</span>
<a href="#l23.313"></a><span id="l23.313"> </span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">-  if (folder)</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineminus">-  {</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineplus">+  if (folder) {</span>
<a href="#l23.317"></a><span id="l23.317">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.318"></a><span id="l23.318">     // We need to set the port on the url, just like</span>
<a href="#l23.319"></a><span id="l23.319">     // nsNNTPProtocol::Initialize does, so the specs will be the same.</span>
<a href="#l23.320"></a><span id="l23.320">     // we can ignore errors here - worst case, we'll display the</span>
<a href="#l23.321"></a><span id="l23.321">     // &quot;message not available&quot; message.</span>
<a href="#l23.322"></a><span id="l23.322">     rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l23.323"></a><span id="l23.323">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.324"></a><span id="l23.324"> </span>
<a href="#l23.325"></a><span id="l23.325">     int32_t port = 0;</span>
<a href="#l23.326"></a><span id="l23.326">     rv = url-&gt;GetPort(&amp;port);</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-    if (NS_FAILED(rv) || (port &lt;= 0))</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineminus">-    {</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineplus">+    if (NS_FAILED(rv) || (port &lt;= 0)) {</span>
<a href="#l23.330"></a><span id="l23.330">       rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-      if (NS_FAILED(rv) || (port &lt;= 0))</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-      {</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineplus">+      if (NS_FAILED(rv) || (port &lt;= 0)) {</span>
<a href="#l23.334"></a><span id="l23.334">         int32_t socketType;</span>
<a href="#l23.335"></a><span id="l23.335">         rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l23.336"></a><span id="l23.336">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.337"></a><span id="l23.337"> </span>
<a href="#l23.338"></a><span id="l23.338" class="difflineminus">-        port = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineminus">-               nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineplus">+        port = (socketType == nsMsgSocketType::SSL)</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineplus">+                   ? nsINntpUrl::DEFAULT_NNTPS_PORT</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineplus">+                   : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l23.343"></a><span id="l23.343">       }</span>
<a href="#l23.344"></a><span id="l23.344"> </span>
<a href="#l23.345"></a><span id="l23.345">       // Don't mutate/clone here.</span>
<a href="#l23.346"></a><span id="l23.346">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url);</span>
<a href="#l23.347"></a><span id="l23.347">       rv = mailnewsurl-&gt;SetPortInternal(port);</span>
<a href="#l23.348"></a><span id="l23.348">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.349"></a><span id="l23.349">     }</span>
<a href="#l23.350"></a><span id="l23.350"> </span>
<a href="#l23.351"></a><span id="l23.351">     folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l23.352"></a><span id="l23.352"> </span>
<a href="#l23.353"></a><span id="l23.353">     // Look for the message in the offline cache</span>
<a href="#l23.354"></a><span id="l23.354">     bool hasMsgOffline = false;</span>
<a href="#l23.355"></a><span id="l23.355">     folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.356"></a><span id="l23.356"> </span>
<a href="#l23.357"></a><span id="l23.357">     // Now look in the memory cache</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineminus">-    if (!hasMsgOffline)</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineminus">-    {</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineplus">+    if (!hasMsgOffline) {</span>
<a href="#l23.361"></a><span id="l23.361">       rv = IsMsgInMemCache(url, folder, &amp;hasMsgOffline);</span>
<a href="#l23.362"></a><span id="l23.362">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.363"></a><span id="l23.363">     }</span>
<a href="#l23.364"></a><span id="l23.364"> </span>
<a href="#l23.365"></a><span id="l23.365">     // If the message is not found in either, then we might need to return</span>
<a href="#l23.366"></a><span id="l23.366">     if (!hasMsgOffline &amp;&amp; WeAreOffline())</span>
<a href="#l23.367"></a><span id="l23.367">       return server-&gt;DisplayOfflineMsg(aMsgWindow);</span>
<a href="#l23.368"></a><span id="l23.368"> </span>
<a href="#l23.369"></a><span id="l23.369" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url,&amp;rv);</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url, &amp;rv);</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.373"></a><span id="l23.373">     mailnewsurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l23.374"></a><span id="l23.374"> </span>
<a href="#l23.375"></a><span id="l23.375">     nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l23.376"></a><span id="l23.376">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.377"></a><span id="l23.377">     newsFolder-&gt;SetSaveArticleOffline(shouldStoreMsgOffline);</span>
<a href="#l23.378"></a><span id="l23.378">   }</span>
<a href="#l23.379"></a><span id="l23.379"> </span>
<a href="#l23.380"></a><span id="l23.380">   rv = GetMessageFromUrl(url, aMsgWindow, aDisplayConsumer);</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineminus">-  if (aURL)</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-    url.forget(aURL);</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineplus">+  if (aURL) url.forget(aURL);</span>
<a href="#l23.384"></a><span id="l23.384">   return rv;</span>
<a href="#l23.385"></a><span id="l23.385"> }</span>
<a href="#l23.386"></a><span id="l23.386"> </span>
<a href="#l23.387"></a><span id="l23.387"> nsresult nsNntpService::GetMessageFromUrl(nsIURI *aUrl,</span>
<a href="#l23.388"></a><span id="l23.388">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineminus">-                                          nsISupports *aDisplayConsumer)</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineminus">-{</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineplus">+                                          nsISupports *aDisplayConsumer) {</span>
<a href="#l23.392"></a><span id="l23.392">   nsresult rv;</span>
<a href="#l23.393"></a><span id="l23.393">   // if the consumer is the docshell then we want to run the url in the webshell</span>
<a href="#l23.394"></a><span id="l23.394">   // in order to display it. If it isn't a docshell then just run the news url</span>
<a href="#l23.395"></a><span id="l23.395">   // like we would any other news url.</span>
<a href="#l23.396"></a><span id="l23.396">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineminus">-  {</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineminus">-    // DIRTY LITTLE HACK --&gt; if we are opening an attachment we want the docshell to</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineminus">-    // treat this load as if it were a user click event. Then the dispatching stuff will be much</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineminus">-    // happier.</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineplus">+    // DIRTY LITTLE HACK --&gt; if we are opening an attachment we want the</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineplus">+    // docshell to treat this load as if it were a user click event. Then the</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineplus">+    // dispatching stuff will be much happier.</span>
<a href="#l23.406"></a><span id="l23.406">     RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(aUrl);</span>
<a href="#l23.407"></a><span id="l23.407">     loadState-&gt;SetLoadFlags(mOpenAttachmentOperation</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineminus">-                              ? nsIWebNavigation::LOAD_FLAGS_IS_LINK</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineminus">-                              : nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-    if (mOpenAttachmentOperation)</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-      loadState-&gt;SetLoadType(LOAD_LINK);</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineplus">+                                ? nsIWebNavigation::LOAD_FLAGS_IS_LINK</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineplus">+                                : nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineplus">+    if (mOpenAttachmentOperation) loadState-&gt;SetLoadType(LOAD_LINK);</span>
<a href="#l23.415"></a><span id="l23.415">     loadState-&gt;SetFirstParty(false);</span>
<a href="#l23.416"></a><span id="l23.416">     loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l23.417"></a><span id="l23.417">     rv = docShell-&gt;LoadURI(loadState);</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineminus">-  }</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineminus">-  else</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineminus">-  {</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; aStreamListener(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l23.422"></a><span id="l23.422" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineminus">-    {</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineplus">+  } else {</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; aStreamListener(</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineplus">+        do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.428"></a><span id="l23.428">       nsCOMPtr&lt;nsIChannel&gt; aChannel;</span>
<a href="#l23.429"></a><span id="l23.429">       nsCOMPtr&lt;nsILoadGroup&gt; aLoadGroup;</span>
<a href="#l23.430"></a><span id="l23.430">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl)</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineminus">-      {</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineminus">-        if (aMsgWindow)</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineminus">-          mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl) {</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+        if (aMsgWindow) mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l23.437"></a><span id="l23.437">         mailnewsUrl-&gt;GetLoadGroup(getter_AddRefs(aLoadGroup));</span>
<a href="#l23.438"></a><span id="l23.438">       }</span>
<a href="#l23.439"></a><span id="l23.439">       nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = new mozilla::net::LoadInfo(</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineminus">-        nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineminus">-        nullptr,</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineminus">-        nullptr,</span>
<a href="#l23.443"></a><span id="l23.443" class="difflineminus">-        nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-        nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineplus">+          nsContentUtils::GetSystemPrincipal(), nullptr, nullptr,</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineplus">+          nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineplus">+          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l23.448"></a><span id="l23.448">       rv = NewChannel(aUrl, loadInfo, getter_AddRefs(aChannel));</span>
<a href="#l23.449"></a><span id="l23.449">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.450"></a><span id="l23.450"> </span>
<a href="#l23.451"></a><span id="l23.451">       rv = aChannel-&gt;SetLoadGroup(aLoadGroup);</span>
<a href="#l23.452"></a><span id="l23.452">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.453"></a><span id="l23.453"> </span>
<a href="#l23.454"></a><span id="l23.454" class="difflineminus">-      //  now try to open the channel passing in our display consumer as the listener</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineplus">+      //  now try to open the channel passing in our display consumer as the</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineplus">+      //  listener</span>
<a href="#l23.457"></a><span id="l23.457">       rv = aChannel-&gt;AsyncOpen(aStreamListener);</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineminus">-    }</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineminus">-    else</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineplus">+    } else</span>
<a href="#l23.461"></a><span id="l23.461">       rv = RunNewsUrl(aUrl, aMsgWindow, aDisplayConsumer);</span>
<a href="#l23.462"></a><span id="l23.462">   }</span>
<a href="#l23.463"></a><span id="l23.463">   return rv;</span>
<a href="#l23.464"></a><span id="l23.464"> }</span>
<a href="#l23.465"></a><span id="l23.465"> </span>
<a href="#l23.466"></a><span id="l23.466"> NS_IMETHODIMP</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineminus">-nsNntpService::FetchMessage(nsIMsgFolder *folder, nsMsgKey key, nsIMsgWindow *aMsgWindow, nsISupports * aConsumer, nsIUrlListener * aUrlListener, nsIURI ** aURL)</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineminus">-{</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineplus">+nsNntpService::FetchMessage(nsIMsgFolder *folder, nsMsgKey key,</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineplus">+                            nsIMsgWindow *aMsgWindow, nsISupports *aConsumer,</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineplus">+                            nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l23.472"></a><span id="l23.472">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l23.473"></a><span id="l23.473">   nsresult rv;</span>
<a href="#l23.474"></a><span id="l23.474">   nsCOMPtr&lt;nsIMsgNewsFolder&gt; msgNewsFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l23.475"></a><span id="l23.475">   mozilla::Unused &lt;&lt; msgNewsFolder;</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.478"></a><span id="l23.478"> </span>
<a href="#l23.479"></a><span id="l23.479" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l23.481"></a><span id="l23.481">   rv = folder-&gt;GetMessageHeader(key, getter_AddRefs(hdr));</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.483"></a><span id="l23.483" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.484"></a><span id="l23.484"> </span>
<a href="#l23.485"></a><span id="l23.485">   nsCString originalMessageUri;</span>
<a href="#l23.486"></a><span id="l23.486">   rv = folder-&gt;GetUriForMsg(hdr, originalMessageUri);</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.489"></a><span id="l23.489"> </span>
<a href="#l23.490"></a><span id="l23.490">   nsCString messageIdURL;</span>
<a href="#l23.491"></a><span id="l23.491">   rv = CreateMessageIDURL(folder, key, getter_Copies(messageIdURL));</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.493"></a><span id="l23.493" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.494"></a><span id="l23.494"> </span>
<a href="#l23.495"></a><span id="l23.495">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineminus">-  rv = ConstructNntpUrl(messageIdURL.get(), aUrlListener, aMsgWindow, originalMessageUri.get(),</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineplus">+  rv = ConstructNntpUrl(messageIdURL.get(), aUrlListener, aMsgWindow,</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineplus">+                        originalMessageUri.get(),</span>
<a href="#l23.499"></a><span id="l23.499">                         nsINntpUrl::ActionFetchArticle, getter_AddRefs(url));</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.502"></a><span id="l23.502"> </span>
<a href="#l23.503"></a><span id="l23.503">   rv = RunNewsUrl(url, aMsgWindow, aConsumer);</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.506"></a><span id="l23.506"> </span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-  if (aURL)</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineminus">-    url.forget(aURL);</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineplus">+  if (aURL) url.forget(aURL);</span>
<a href="#l23.510"></a><span id="l23.510">   return rv;</span>
<a href="#l23.511"></a><span id="l23.511"> }</span>
<a href="#l23.512"></a><span id="l23.512"> </span>
<a href="#l23.513"></a><span id="l23.513" class="difflineminus">-NS_IMETHODIMP nsNntpService::FetchMimePart(nsIURI *aURI, const char *aMessageURI, nsISupports *aDisplayConsumer, nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL)</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineminus">-{</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineplus">+NS_IMETHODIMP nsNntpService::FetchMimePart(</span>
<a href="#l23.516"></a><span id="l23.516" class="difflineplus">+    nsIURI *aURI, const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l23.518"></a><span id="l23.518">   nsresult rv;</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(aURI, &amp;rv));</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(aURI, &amp;rv));</span>
<a href="#l23.521"></a><span id="l23.521">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.522"></a><span id="l23.522"> </span>
<a href="#l23.523"></a><span id="l23.523">   msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l23.524"></a><span id="l23.524"> </span>
<a href="#l23.525"></a><span id="l23.525">   // set up the url listener</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineminus">-  if (aUrlListener)</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineminus">-    msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineplus">+  if (aUrlListener) msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l23.529"></a><span id="l23.529"> </span>
<a href="#l23.530"></a><span id="l23.530" class="difflineminus">-// this code isn't ready yet, but it helps getting opening attachments</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineminus">-// while offline working</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineminus">-//    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgMessageUrl = do_QueryInterface(aURI);</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineminus">-//    if (msgMessageUrl)</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineminus">-//    {</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineminus">-//      nsAutoCString spec;</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineminus">-//      rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineminus">-//      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineminus">-//      msgMessageUrl-&gt;SetOriginalSpec(spec.get());</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineminus">-//    }</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineplus">+  // this code isn't ready yet, but it helps getting opening attachments</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineplus">+  // while offline working</span>
<a href="#l23.542"></a><span id="l23.542" class="difflineplus">+  //    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgMessageUrl = do_QueryInterface(aURI);</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineplus">+  //    if (msgMessageUrl)</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineplus">+  //    {</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineplus">+  //      nsAutoCString spec;</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineplus">+  //      rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineplus">+  //      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineplus">+  //      msgMessageUrl-&gt;SetOriginalSpec(spec.get());</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineplus">+  //    }</span>
<a href="#l23.550"></a><span id="l23.550">   return RunNewsUrl(msgUrl, aMsgWindow, aDisplayConsumer);</span>
<a href="#l23.551"></a><span id="l23.551"> }</span>
<a href="#l23.552"></a><span id="l23.552"> </span>
<a href="#l23.553"></a><span id="l23.553" class="difflineminus">-NS_IMETHODIMP nsNntpService::OpenAttachment(const char *aContentType,</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineminus">-                                            const char *aFileName,</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineminus">-                                            const char *aUrl,</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineminus">-                                            const char *aMessageUri,</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineminus">-                                            nsISupports *aDisplayConsumer,</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineminus">-                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineminus">-                                            nsIUrlListener *aUrlListener)</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineminus">-{</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineplus">+NS_IMETHODIMP nsNntpService::OpenAttachment(</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineplus">+    const char *aContentType, const char *aFileName, const char *aUrl,</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineplus">+    const char *aMessageUri, nsISupports *aDisplayConsumer,</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener) {</span>
<a href="#l23.565"></a><span id="l23.565">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l23.566"></a><span id="l23.566">   NS_ENSURE_ARG_POINTER(aFileName);</span>
<a href="#l23.567"></a><span id="l23.567"> </span>
<a href="#l23.568"></a><span id="l23.568">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.569"></a><span id="l23.569">   nsresult rv = NS_OK;</span>
<a href="#l23.570"></a><span id="l23.570">   nsAutoCString newsUrl;</span>
<a href="#l23.571"></a><span id="l23.571">   newsUrl = aUrl;</span>
<a href="#l23.572"></a><span id="l23.572">   newsUrl += &quot;&amp;type=&quot;;</span>
<a href="#l23.573"></a><span id="l23.573">   newsUrl += aContentType;</span>
<a href="#l23.574"></a><span id="l23.574">   newsUrl += &quot;&amp;filename=&quot;;</span>
<a href="#l23.575"></a><span id="l23.575">   newsUrl += aFileName;</span>
<a href="#l23.576"></a><span id="l23.576"> </span>
<a href="#l23.577"></a><span id="l23.577">   NewURI(newsUrl, nullptr, nullptr, getter_AddRefs(url));</span>
<a href="#l23.578"></a><span id="l23.578"> </span>
<a href="#l23.579"></a><span id="l23.579" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineminus">-  {</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(url, &amp;rv));</span>
<a href="#l23.582"></a><span id="l23.582" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; url) {</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(url, &amp;rv));</span>
<a href="#l23.584"></a><span id="l23.584">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.585"></a><span id="l23.585"> </span>
<a href="#l23.586"></a><span id="l23.586">     msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l23.587"></a><span id="l23.587">     msgUrl-&gt;SetFileNameInternal(nsDependentCString(aFileName));</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineminus">-// this code isn't ready yet, but it helps getting opening attachments</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineminus">-// while offline working</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineminus">-//   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgMessageUrl = do_QueryInterface(url);</span>
<a href="#l23.591"></a><span id="l23.591" class="difflineminus">-//    if (msgMessageUrl)</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineminus">-//      msgMessageUrl-&gt;SetOriginalSpec(newsUrl.get());</span>
<a href="#l23.593"></a><span id="l23.593" class="difflineplus">+    // this code isn't ready yet, but it helps getting opening attachments</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineplus">+    // while offline working</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineplus">+    //   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgMessageUrl = do_QueryInterface(url);</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineplus">+    //    if (msgMessageUrl)</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineplus">+    //      msgMessageUrl-&gt;SetOriginalSpec(newsUrl.get());</span>
<a href="#l23.598"></a><span id="l23.598">     // set up the url listener</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineminus">-    if (aUrlListener)</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineminus">-      msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l23.601"></a><span id="l23.601" class="difflineplus">+    if (aUrlListener) msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l23.602"></a><span id="l23.602"> </span>
<a href="#l23.603"></a><span id="l23.603">     nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l23.604"></a><span id="l23.604">     if (NS_SUCCEEDED(rv) &amp;&amp; docShell) {</span>
<a href="#l23.605"></a><span id="l23.605">       RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(url);</span>
<a href="#l23.606"></a><span id="l23.606">       loadState-&gt;SetLoadFlags(nsIWebNavigation::LOAD_FLAGS_IS_LINK);</span>
<a href="#l23.607"></a><span id="l23.607">       loadState-&gt;SetLoadType(LOAD_LINK);</span>
<a href="#l23.608"></a><span id="l23.608">       loadState-&gt;SetFirstParty(false);</span>
<a href="#l23.609"></a><span id="l23.609">       loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l23.610"></a><span id="l23.610">       return docShell-&gt;LoadURI(loadState);</span>
<a href="#l23.611"></a><span id="l23.611">     } else {</span>
<a href="#l23.612"></a><span id="l23.612">       return RunNewsUrl(url, aMsgWindow, aDisplayConsumer);</span>
<a href="#l23.613"></a><span id="l23.613">     }</span>
<a href="#l23.614"></a><span id="l23.614">   }</span>
<a href="#l23.615"></a><span id="l23.615">   return NS_OK;</span>
<a href="#l23.616"></a><span id="l23.616"> }</span>
<a href="#l23.617"></a><span id="l23.617"> </span>
<a href="#l23.618"></a><span id="l23.618" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetUrlForUri(const char *aMessageURI, nsIURI **aURL, nsIMsgWindow *aMsgWindow)</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineminus">-{</span>
<a href="#l23.620"></a><span id="l23.620" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetUrlForUri(const char *aMessageURI,</span>
<a href="#l23.621"></a><span id="l23.621" class="difflineplus">+                                          nsIURI **aURL,</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineplus">+                                          nsIMsgWindow *aMsgWindow) {</span>
<a href="#l23.623"></a><span id="l23.623">   nsresult rv = NS_OK;</span>
<a href="#l23.624"></a><span id="l23.624"> </span>
<a href="#l23.625"></a><span id="l23.625">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l23.626"></a><span id="l23.626"> </span>
<a href="#l23.627"></a><span id="l23.627">   // double check that it is a news-message:/ uri</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineminus">-  if (PL_strncmp(aMessageURI, kNewsMessageRootURI, kNewsMessageRootURILen))</span>
<a href="#l23.629"></a><span id="l23.629" class="difflineminus">-  {</span>
<a href="#l23.630"></a><span id="l23.630" class="difflineplus">+  if (PL_strncmp(aMessageURI, kNewsMessageRootURI, kNewsMessageRootURILen)) {</span>
<a href="#l23.631"></a><span id="l23.631">     rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.634"></a><span id="l23.634">   }</span>
<a href="#l23.635"></a><span id="l23.635"> </span>
<a href="#l23.636"></a><span id="l23.636" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.637"></a><span id="l23.637" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.638"></a><span id="l23.638">   nsMsgKey key = nsMsgKey_None;</span>
<a href="#l23.639"></a><span id="l23.639">   rv = DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.642"></a><span id="l23.642"> </span>
<a href="#l23.643"></a><span id="l23.643">   nsCString messageIdURL;</span>
<a href="#l23.644"></a><span id="l23.644">   rv = CreateMessageIDURL(folder, key, getter_Copies(messageIdURL));</span>
<a href="#l23.645"></a><span id="l23.645" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.647"></a><span id="l23.647"> </span>
<a href="#l23.648"></a><span id="l23.648">   // this is only called by view message source</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineminus">-  rv = ConstructNntpUrl(messageIdURL.get(), nullptr, aMsgWindow, aMessageURI, nsINntpUrl::ActionFetchArticle, aURL);</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.651"></a><span id="l23.651" class="difflineminus">-  if (folder &amp;&amp; *aURL)</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineminus">-  {</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(*aURL);</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l23.655"></a><span id="l23.655" class="difflineminus">-    {</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineplus">+  rv = ConstructNntpUrl(messageIdURL.get(), nullptr, aMsgWindow, aMessageURI,</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineplus">+                        nsINntpUrl::ActionFetchArticle, aURL);</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineplus">+  if (folder &amp;&amp; *aURL) {</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(*aURL);</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineplus">+    if (mailnewsUrl) {</span>
<a href="#l23.662"></a><span id="l23.662">       bool useLocalCache = false;</span>
<a href="#l23.663"></a><span id="l23.663">       folder-&gt;HasMsgOffline(key, &amp;useLocalCache);</span>
<a href="#l23.664"></a><span id="l23.664">       mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l23.665"></a><span id="l23.665">     }</span>
<a href="#l23.666"></a><span id="l23.666">   }</span>
<a href="#l23.667"></a><span id="l23.667">   return rv;</span>
<a href="#l23.668"></a><span id="l23.668" class="difflineminus">-</span>
<a href="#l23.669"></a><span id="l23.669"> }</span>
<a href="#l23.670"></a><span id="l23.670"> </span>
<a href="#l23.671"></a><span id="l23.671"> NS_IMETHODIMP</span>
<a href="#l23.672"></a><span id="l23.672" class="difflineminus">-nsNntpService::DecomposeNewsURI(const char *uri, nsIMsgFolder **folder, nsMsgKey *aMsgKey)</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineminus">-{</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineplus">+nsNntpService::DecomposeNewsURI(const char *uri, nsIMsgFolder **folder,</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineplus">+                                nsMsgKey *aMsgKey) {</span>
<a href="#l23.676"></a><span id="l23.676">   nsresult rv;</span>
<a href="#l23.677"></a><span id="l23.677"> </span>
<a href="#l23.678"></a><span id="l23.678">   rv = DecomposeNewsMessageURI(uri, folder, aMsgKey);</span>
<a href="#l23.679"></a><span id="l23.679"> </span>
<a href="#l23.680"></a><span id="l23.680">   return rv;</span>
<a href="#l23.681"></a><span id="l23.681"> }</span>
<a href="#l23.682"></a><span id="l23.682"> </span>
<a href="#l23.683"></a><span id="l23.683" class="difflineminus">-nsresult</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineminus">-nsNntpService::DecomposeNewsMessageURI(const char * aMessageURI, nsIMsgFolder ** aFolder, nsMsgKey *aMsgKey)</span>
<a href="#l23.685"></a><span id="l23.685" class="difflineminus">-{</span>
<a href="#l23.686"></a><span id="l23.686" class="difflineplus">+nsresult nsNntpService::DecomposeNewsMessageURI(const char *aMessageURI,</span>
<a href="#l23.687"></a><span id="l23.687" class="difflineplus">+                                                nsIMsgFolder **aFolder,</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineplus">+                                                nsMsgKey *aMsgKey) {</span>
<a href="#l23.689"></a><span id="l23.689">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l23.690"></a><span id="l23.690">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l23.691"></a><span id="l23.691">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l23.692"></a><span id="l23.692"> </span>
<a href="#l23.693"></a><span id="l23.693">   nsresult rv = NS_OK;</span>
<a href="#l23.694"></a><span id="l23.694"> </span>
<a href="#l23.695"></a><span id="l23.695">   // Construct the news URL</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_CreateInstance(NS_NNTPURL_CONTRACTID,&amp;rv);</span>
<a href="#l23.697"></a><span id="l23.697" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl =</span>
<a href="#l23.698"></a><span id="l23.698" class="difflineplus">+      do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l23.699"></a><span id="l23.699">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.700"></a><span id="l23.700">   nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl = do_QueryInterface(mailnewsurl, &amp;rv);</span>
<a href="#l23.701"></a><span id="l23.701">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.702"></a><span id="l23.702">   rv = mailnewsurl-&gt;SetSpecInternal(nsDependentCString(aMessageURI));</span>
<a href="#l23.703"></a><span id="l23.703">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.704"></a><span id="l23.704"> </span>
<a href="#l23.705"></a><span id="l23.705">   // Get the group name and key from the url</span>
<a href="#l23.706"></a><span id="l23.706">   nsAutoCString groupName;</span>
<a href="#l23.707"></a><span id="l23.707">   rv = nntpUrl-&gt;GetGroup(groupName);</span>
<a href="#l23.708"></a><span id="l23.708">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.709"></a><span id="l23.709"> </span>
<a href="#l23.710"></a><span id="l23.710">   rv = nntpUrl-&gt;GetKey(aMsgKey);</span>
<a href="#l23.711"></a><span id="l23.711">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.712"></a><span id="l23.712"> </span>
<a href="#l23.713"></a><span id="l23.713">   // If there is no group, try the harder way.</span>
<a href="#l23.714"></a><span id="l23.714" class="difflineminus">-  if (groupName.IsEmpty())</span>
<a href="#l23.715"></a><span id="l23.715" class="difflineminus">-  {</span>
<a href="#l23.716"></a><span id="l23.716" class="difflineplus">+  if (groupName.IsEmpty()) {</span>
<a href="#l23.717"></a><span id="l23.717">     *aMsgKey = nsMsgKey_None;</span>
<a href="#l23.718"></a><span id="l23.718">     return GetFolderFromUri(aMessageURI, aFolder);</span>
<a href="#l23.719"></a><span id="l23.719">   }</span>
<a href="#l23.720"></a><span id="l23.720"> </span>
<a href="#l23.721"></a><span id="l23.721">   return mailnewsurl-&gt;GetFolder(aFolder);</span>
<a href="#l23.722"></a><span id="l23.722"> }</span>
<a href="#l23.723"></a><span id="l23.723"> </span>
<a href="#l23.724"></a><span id="l23.724" class="difflineminus">-nsresult</span>
<a href="#l23.725"></a><span id="l23.725" class="difflineminus">-nsNntpService::GetFolderFromUri(const char *aUri, nsIMsgFolder **aFolder)</span>
<a href="#l23.726"></a><span id="l23.726" class="difflineminus">-{</span>
<a href="#l23.727"></a><span id="l23.727" class="difflineplus">+nsresult nsNntpService::GetFolderFromUri(const char *aUri,</span>
<a href="#l23.728"></a><span id="l23.728" class="difflineplus">+                                         nsIMsgFolder **aFolder) {</span>
<a href="#l23.729"></a><span id="l23.729">   NS_ENSURE_ARG_POINTER(aUri);</span>
<a href="#l23.730"></a><span id="l23.730">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l23.731"></a><span id="l23.731"> </span>
<a href="#l23.732"></a><span id="l23.732">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l23.733"></a><span id="l23.733">   nsresult rv = NS_NewURI(getter_AddRefs(uri), nsDependentCString(aUri));</span>
<a href="#l23.734"></a><span id="l23.734" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.735"></a><span id="l23.735" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.736"></a><span id="l23.736"> </span>
<a href="#l23.737"></a><span id="l23.737">   nsAutoCString path;</span>
<a href="#l23.738"></a><span id="l23.738">   rv = uri-&gt;GetPathQueryRef(path);</span>
<a href="#l23.739"></a><span id="l23.739" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.740"></a><span id="l23.740" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.741"></a><span id="l23.741"> </span>
<a href="#l23.742"></a><span id="l23.742" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.743"></a><span id="l23.743" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.744"></a><span id="l23.744" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.745"></a><span id="l23.745" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.746"></a><span id="l23.746" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.747"></a><span id="l23.747"> </span>
<a href="#l23.748"></a><span id="l23.748" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.749"></a><span id="l23.749" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.750"></a><span id="l23.750">   rv = accountManager-&gt;FindServerByURI(uri, false, getter_AddRefs(server));</span>
<a href="#l23.751"></a><span id="l23.751" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.752"></a><span id="l23.752" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.753"></a><span id="l23.753"> </span>
<a href="#l23.754"></a><span id="l23.754" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l23.756"></a><span id="l23.756">   rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l23.757"></a><span id="l23.757" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.758"></a><span id="l23.758" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.759"></a><span id="l23.759"> </span>
<a href="#l23.760"></a><span id="l23.760">   // check if path is &quot;/&quot;</span>
<a href="#l23.761"></a><span id="l23.761">   // if so, use the root folder</span>
<a href="#l23.762"></a><span id="l23.762" class="difflineminus">-  if (path.Length() == 1)</span>
<a href="#l23.763"></a><span id="l23.763" class="difflineminus">-  {</span>
<a href="#l23.764"></a><span id="l23.764" class="difflineplus">+  if (path.Length() == 1) {</span>
<a href="#l23.765"></a><span id="l23.765">     rootFolder.forget(aFolder);</span>
<a href="#l23.766"></a><span id="l23.766">     return NS_OK;</span>
<a href="#l23.767"></a><span id="l23.767">   }</span>
<a href="#l23.768"></a><span id="l23.768"> </span>
<a href="#l23.769"></a><span id="l23.769">   // the URI is news://host/(escaped group)</span>
<a href="#l23.770"></a><span id="l23.770">   // but the *name* of the newsgroup (we are calling ::GetChildNamed())</span>
<a href="#l23.771"></a><span id="l23.771">   // is unescaped.  see http://bugzilla.mozilla.org/show_bug.cgi?id=210089#c17</span>
<a href="#l23.772"></a><span id="l23.772">   // for more about this</span>
<a href="#l23.773"></a><span id="l23.773">   nsCString unescapedPath;</span>
<a href="#l23.774"></a><span id="l23.774" class="difflineminus">-  MsgUnescapeString(Substring(path, 1), 0, unescapedPath); /* skip the leading slash */</span>
<a href="#l23.775"></a><span id="l23.775" class="difflineplus">+  MsgUnescapeString(Substring(path, 1), 0,</span>
<a href="#l23.776"></a><span id="l23.776" class="difflineplus">+                    unescapedPath); /* skip the leading slash */</span>
<a href="#l23.777"></a><span id="l23.777"> </span>
<a href="#l23.778"></a><span id="l23.778">   nsCOMPtr&lt;nsIMsgFolder&gt; subFolder;</span>
<a href="#l23.779"></a><span id="l23.779">   rv = rootFolder-&gt;GetChildNamed(NS_ConvertUTF8toUTF16(unescapedPath),</span>
<a href="#l23.780"></a><span id="l23.780">                                  getter_AddRefs(subFolder));</span>
<a href="#l23.781"></a><span id="l23.781" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.782"></a><span id="l23.782" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.783"></a><span id="l23.783"> </span>
<a href="#l23.784"></a><span id="l23.784">   subFolder.forget(aFolder);</span>
<a href="#l23.785"></a><span id="l23.785">   return NS_OK;</span>
<a href="#l23.786"></a><span id="l23.786"> }</span>
<a href="#l23.787"></a><span id="l23.787"> </span>
<a href="#l23.788"></a><span id="l23.788"> NS_IMETHODIMP</span>
<a href="#l23.789"></a><span id="l23.789" class="difflineminus">-nsNntpService::CopyMessage(const char * aSrcMessageURI, nsIStreamListener * aMailboxCopyHandler, bool moveMessage,</span>
<a href="#l23.790"></a><span id="l23.790" class="difflineminus">-                           nsIUrlListener * aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l23.791"></a><span id="l23.791" class="difflineminus">-{</span>
<a href="#l23.792"></a><span id="l23.792" class="difflineplus">+nsNntpService::CopyMessage(const char *aSrcMessageURI,</span>
<a href="#l23.793"></a><span id="l23.793" class="difflineplus">+                           nsIStreamListener *aMailboxCopyHandler,</span>
<a href="#l23.794"></a><span id="l23.794" class="difflineplus">+                           bool moveMessage, nsIUrlListener *aUrlListener,</span>
<a href="#l23.795"></a><span id="l23.795" class="difflineplus">+                           nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l23.796"></a><span id="l23.796">   NS_ENSURE_ARG_POINTER(aSrcMessageURI);</span>
<a href="#l23.797"></a><span id="l23.797">   NS_ENSURE_ARG_POINTER(aMailboxCopyHandler);</span>
<a href="#l23.798"></a><span id="l23.798"> </span>
<a href="#l23.799"></a><span id="l23.799">   nsresult rv;</span>
<a href="#l23.800"></a><span id="l23.800" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; streamSupport = do_QueryInterface(aMailboxCopyHandler, &amp;rv);</span>
<a href="#l23.801"></a><span id="l23.801" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.802"></a><span id="l23.802" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; streamSupport =</span>
<a href="#l23.803"></a><span id="l23.803" class="difflineplus">+      do_QueryInterface(aMailboxCopyHandler, &amp;rv);</span>
<a href="#l23.804"></a><span id="l23.804" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.805"></a><span id="l23.805"> </span>
<a href="#l23.806"></a><span id="l23.806" class="difflineminus">-  rv = DisplayMessage(aSrcMessageURI, streamSupport, aMsgWindow, aUrlListener, nullptr, aURL);</span>
<a href="#l23.807"></a><span id="l23.807" class="difflineplus">+  rv = DisplayMessage(aSrcMessageURI, streamSupport, aMsgWindow, aUrlListener,</span>
<a href="#l23.808"></a><span id="l23.808" class="difflineplus">+                      nullptr, aURL);</span>
<a href="#l23.809"></a><span id="l23.809">   return rv;</span>
<a href="#l23.810"></a><span id="l23.810"> }</span>
<a href="#l23.811"></a><span id="l23.811"> </span>
<a href="#l23.812"></a><span id="l23.812"> NS_IMETHODIMP</span>
<a href="#l23.813"></a><span id="l23.813"> nsNntpService::CopyMessages(uint32_t aNumKeys, nsMsgKey *akeys,</span>
<a href="#l23.814"></a><span id="l23.814">                             nsIMsgFolder *srcFolder,</span>
<a href="#l23.815"></a><span id="l23.815" class="difflineminus">-                            nsIStreamListener * aMailboxCopyHandler,</span>
<a href="#l23.816"></a><span id="l23.816" class="difflineminus">-                            bool moveMessage,</span>
<a href="#l23.817"></a><span id="l23.817" class="difflineminus">-                            nsIUrlListener * aUrlListener,</span>
<a href="#l23.818"></a><span id="l23.818" class="difflineminus">-                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.819"></a><span id="l23.819" class="difflineminus">-                            nsIURI **aURL)</span>
<a href="#l23.820"></a><span id="l23.820" class="difflineminus">-{</span>
<a href="#l23.821"></a><span id="l23.821" class="difflineplus">+                            nsIStreamListener *aMailboxCopyHandler,</span>
<a href="#l23.822"></a><span id="l23.822" class="difflineplus">+                            bool moveMessage, nsIUrlListener *aUrlListener,</span>
<a href="#l23.823"></a><span id="l23.823" class="difflineplus">+                            nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l23.824"></a><span id="l23.824">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l23.825"></a><span id="l23.825"> }</span>
<a href="#l23.826"></a><span id="l23.826"> </span>
<a href="#l23.827"></a><span id="l23.827" class="difflineminus">-nsresult</span>
<a href="#l23.828"></a><span id="l23.828" class="difflineminus">-nsNntpService::FindServerWithNewsgroup(nsCString &amp;host, nsCString &amp;groupName)</span>
<a href="#l23.829"></a><span id="l23.829" class="difflineminus">-{</span>
<a href="#l23.830"></a><span id="l23.830" class="difflineplus">+nsresult nsNntpService::FindServerWithNewsgroup(nsCString &amp;host,</span>
<a href="#l23.831"></a><span id="l23.831" class="difflineplus">+                                                nsCString &amp;groupName) {</span>
<a href="#l23.832"></a><span id="l23.832">   nsresult rv;</span>
<a href="#l23.833"></a><span id="l23.833"> </span>
<a href="#l23.834"></a><span id="l23.834" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.835"></a><span id="l23.835" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.836"></a><span id="l23.836" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.837"></a><span id="l23.837" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.838"></a><span id="l23.838" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.839"></a><span id="l23.839"> </span>
<a href="#l23.840"></a><span id="l23.840">   nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l23.841"></a><span id="l23.841">   rv = accountManager-&gt;GetAllServers(getter_AddRefs(servers));</span>
<a href="#l23.842"></a><span id="l23.842" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.843"></a><span id="l23.843" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.844"></a><span id="l23.844"> </span>
<a href="#l23.845"></a><span id="l23.845" class="difflineminus">-  NS_ASSERTION(MsgIsUTF8(groupName),</span>
<a href="#l23.846"></a><span id="l23.846" class="difflineminus">-               &quot;newsgroup is not in UTF-8&quot;);</span>
<a href="#l23.847"></a><span id="l23.847" class="difflineplus">+  NS_ASSERTION(MsgIsUTF8(groupName), &quot;newsgroup is not in UTF-8&quot;);</span>
<a href="#l23.848"></a><span id="l23.848"> </span>
<a href="#l23.849"></a><span id="l23.849">   // XXX TODO</span>
<a href="#l23.850"></a><span id="l23.850">   // this only looks at the list of subscribed newsgroups.</span>
<a href="#l23.851"></a><span id="l23.851">   // fix to use the hostinfo.dat information</span>
<a href="#l23.852"></a><span id="l23.852"> </span>
<a href="#l23.853"></a><span id="l23.853">   uint32_t length;</span>
<a href="#l23.854"></a><span id="l23.854">   rv = servers-&gt;GetLength(&amp;length);</span>
<a href="#l23.855"></a><span id="l23.855">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.856"></a><span id="l23.856"> </span>
<a href="#l23.857"></a><span id="l23.857" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l23.858"></a><span id="l23.858" class="difflineminus">-  {</span>
<a href="#l23.859"></a><span id="l23.859" class="difflineminus">-    nsCOMPtr&lt;nsINntpIncomingServer&gt; newsserver(do_QueryElementAt(servers, i, &amp;rv));</span>
<a href="#l23.860"></a><span id="l23.860" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l23.861"></a><span id="l23.861" class="difflineminus">-      continue;</span>
<a href="#l23.862"></a><span id="l23.862" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l23.863"></a><span id="l23.863" class="difflineplus">+    nsCOMPtr&lt;nsINntpIncomingServer&gt; newsserver(</span>
<a href="#l23.864"></a><span id="l23.864" class="difflineplus">+        do_QueryElementAt(servers, i, &amp;rv));</span>
<a href="#l23.865"></a><span id="l23.865" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l23.866"></a><span id="l23.866"> </span>
<a href="#l23.867"></a><span id="l23.867">     bool containsGroup = false;</span>
<a href="#l23.868"></a><span id="l23.868" class="difflineminus">-    rv = newsserver-&gt;ContainsNewsgroup(groupName,</span>
<a href="#l23.869"></a><span id="l23.869" class="difflineminus">-                                       &amp;containsGroup);</span>
<a href="#l23.870"></a><span id="l23.870" class="difflineminus">-    if (containsGroup)</span>
<a href="#l23.871"></a><span id="l23.871" class="difflineminus">-    {</span>
<a href="#l23.872"></a><span id="l23.872" class="difflineplus">+    rv = newsserver-&gt;ContainsNewsgroup(groupName, &amp;containsGroup);</span>
<a href="#l23.873"></a><span id="l23.873" class="difflineplus">+    if (containsGroup) {</span>
<a href="#l23.874"></a><span id="l23.874">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryInterface(newsserver, &amp;rv));</span>
<a href="#l23.875"></a><span id="l23.875">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.876"></a><span id="l23.876"> </span>
<a href="#l23.877"></a><span id="l23.877">       return server-&gt;GetHostName(host);</span>
<a href="#l23.878"></a><span id="l23.878">     }</span>
<a href="#l23.879"></a><span id="l23.879">   }</span>
<a href="#l23.880"></a><span id="l23.880">   return NS_OK;</span>
<a href="#l23.881"></a><span id="l23.881"> }</span>
<a href="#l23.882"></a><span id="l23.882"> </span>
<a href="#l23.883"></a><span id="l23.883" class="difflineminus">-nsresult nsNntpService::FindHostFromGroup(nsCString &amp;host, nsCString &amp;groupName)</span>
<a href="#l23.884"></a><span id="l23.884" class="difflineminus">-{</span>
<a href="#l23.885"></a><span id="l23.885" class="difflineplus">+nsresult nsNntpService::FindHostFromGroup(nsCString &amp;host,</span>
<a href="#l23.886"></a><span id="l23.886" class="difflineplus">+                                          nsCString &amp;groupName) {</span>
<a href="#l23.887"></a><span id="l23.887">   nsresult rv = NS_OK;</span>
<a href="#l23.888"></a><span id="l23.888">   // host always comes in as &quot;&quot;</span>
<a href="#l23.889"></a><span id="l23.889">   NS_ASSERTION(host.IsEmpty(), &quot;host is not empty&quot;);</span>
<a href="#l23.890"></a><span id="l23.890">   if (!host.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l23.891"></a><span id="l23.891"> </span>
<a href="#l23.892"></a><span id="l23.892">   rv = FindServerWithNewsgroup(host, groupName);</span>
<a href="#l23.893"></a><span id="l23.893" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.894"></a><span id="l23.894" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.895"></a><span id="l23.895"> </span>
<a href="#l23.896"></a><span id="l23.896">   // host can be empty</span>
<a href="#l23.897"></a><span id="l23.897">   return NS_OK;</span>
<a href="#l23.898"></a><span id="l23.898"> }</span>
<a href="#l23.899"></a><span id="l23.899"> </span>
<a href="#l23.900"></a><span id="l23.900" class="difflineminus">-nsresult</span>
<a href="#l23.901"></a><span id="l23.901" class="difflineminus">-nsNntpService::SetUpNntpUrlForPosting(const char *aAccountKey, char **newsUrlSpec)</span>
<a href="#l23.902"></a><span id="l23.902" class="difflineminus">-{</span>
<a href="#l23.903"></a><span id="l23.903" class="difflineplus">+nsresult nsNntpService::SetUpNntpUrlForPosting(const char *aAccountKey,</span>
<a href="#l23.904"></a><span id="l23.904" class="difflineplus">+                                               char **newsUrlSpec) {</span>
<a href="#l23.905"></a><span id="l23.905">   nsresult rv = NS_OK;</span>
<a href="#l23.906"></a><span id="l23.906"> </span>
<a href="#l23.907"></a><span id="l23.907">   nsCString host;</span>
<a href="#l23.908"></a><span id="l23.908">   int32_t port = -1;</span>
<a href="#l23.909"></a><span id="l23.909"> </span>
<a href="#l23.910"></a><span id="l23.910">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; nntpServer;</span>
<a href="#l23.911"></a><span id="l23.911">   rv = GetNntpServerByAccount(aAccountKey, getter_AddRefs(nntpServer));</span>
<a href="#l23.912"></a><span id="l23.912" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; nntpServer)</span>
<a href="#l23.913"></a><span id="l23.913" class="difflineminus">-  {</span>
<a href="#l23.914"></a><span id="l23.914" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; nntpServer) {</span>
<a href="#l23.915"></a><span id="l23.915">     nntpServer-&gt;GetHostName(host);</span>
<a href="#l23.916"></a><span id="l23.916">     nntpServer-&gt;GetPort(&amp;port);</span>
<a href="#l23.917"></a><span id="l23.917" class="difflineminus">-  }</span>
<a href="#l23.918"></a><span id="l23.918" class="difflineminus">-  else</span>
<a href="#l23.919"></a><span id="l23.919" class="difflineminus">-  {</span>
<a href="#l23.920"></a><span id="l23.920" class="difflineplus">+  } else {</span>
<a href="#l23.921"></a><span id="l23.921">     NS_WARNING(&quot;Failure to obtain host and port&quot;);</span>
<a href="#l23.922"></a><span id="l23.922">   }</span>
<a href="#l23.923"></a><span id="l23.923"> </span>
<a href="#l23.924"></a><span id="l23.924" class="difflineminus">-  *newsUrlSpec = PR_smprintf(&quot;%s/%s:%d&quot;,kNewsRootURI, host.IsEmpty() ? &quot;news&quot; : host.get(), port);</span>
<a href="#l23.925"></a><span id="l23.925" class="difflineplus">+  *newsUrlSpec = PR_smprintf(&quot;%s/%s:%d&quot;, kNewsRootURI,</span>
<a href="#l23.926"></a><span id="l23.926" class="difflineplus">+                             host.IsEmpty() ? &quot;news&quot; : host.get(), port);</span>
<a href="#l23.927"></a><span id="l23.927">   if (!*newsUrlSpec) return NS_ERROR_FAILURE;</span>
<a href="#l23.928"></a><span id="l23.928">   return NS_OK;</span>
<a href="#l23.929"></a><span id="l23.929"> }</span>
<a href="#l23.930"></a><span id="l23.930"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.931"></a><span id="l23.931"> // nsINntpService support</span>
<a href="#l23.932"></a><span id="l23.932"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.933"></a><span id="l23.933"> // XXX : may not work with non-ASCII newsgroup names and IDN hostnames</span>
<a href="#l23.934"></a><span id="l23.934"> NS_IMETHODIMP</span>
<a href="#l23.935"></a><span id="l23.935" class="difflineminus">-nsNntpService::GenerateNewsHeaderValsForPosting(const nsACString&amp; newsgroupsList, char **newsgroupsHeaderVal, char **newshostHeaderVal)</span>
<a href="#l23.936"></a><span id="l23.936" class="difflineminus">-{</span>
<a href="#l23.937"></a><span id="l23.937" class="difflineplus">+nsNntpService::GenerateNewsHeaderValsForPosting(</span>
<a href="#l23.938"></a><span id="l23.938" class="difflineplus">+    const nsACString &amp;newsgroupsList, char **newsgroupsHeaderVal,</span>
<a href="#l23.939"></a><span id="l23.939" class="difflineplus">+    char **newshostHeaderVal) {</span>
<a href="#l23.940"></a><span id="l23.940">   nsresult rv = NS_OK;</span>
<a href="#l23.941"></a><span id="l23.941"> </span>
<a href="#l23.942"></a><span id="l23.942">   NS_ENSURE_ARG_POINTER(newsgroupsHeaderVal);</span>
<a href="#l23.943"></a><span id="l23.943">   NS_ENSURE_ARG_POINTER(newshostHeaderVal);</span>
<a href="#l23.944"></a><span id="l23.944"> </span>
<a href="#l23.945"></a><span id="l23.945">   // newsgroupsList can be a comma separated list of these:</span>
<a href="#l23.946"></a><span id="l23.946">   // news://host/group</span>
<a href="#l23.947"></a><span id="l23.947">   // news://group</span>
<a href="#l23.948"></a><span id="l23.948" class="difflineat">@@ -729,231 +697,221 @@ nsNntpService::GenerateNewsHeaderValsFor</span>
<a href="#l23.949"></a><span id="l23.949">   // we are not going to allow the user to cross post to multiple hosts.</span>
<a href="#l23.950"></a><span id="l23.950">   // if we detect that, we stop and return error.</span>
<a href="#l23.951"></a><span id="l23.951"> </span>
<a href="#l23.952"></a><span id="l23.952">   nsAutoCString host;</span>
<a href="#l23.953"></a><span id="l23.953">   nsAutoCString newsgroups;</span>
<a href="#l23.954"></a><span id="l23.954"> </span>
<a href="#l23.955"></a><span id="l23.955">   nsTArray&lt;nsCString&gt; list;</span>
<a href="#l23.956"></a><span id="l23.956">   ParseString(newsgroupsList, ',', list);</span>
<a href="#l23.957"></a><span id="l23.957" class="difflineminus">-  for (uint32_t index = 0; index &lt; list.Length(); index++)</span>
<a href="#l23.958"></a><span id="l23.958" class="difflineminus">-  {</span>
<a href="#l23.959"></a><span id="l23.959" class="difflineplus">+  for (uint32_t index = 0; index &lt; list.Length(); index++) {</span>
<a href="#l23.960"></a><span id="l23.960">     list[index].StripWhitespace();</span>
<a href="#l23.961"></a><span id="l23.961" class="difflineminus">-    if (!list[index].IsEmpty())</span>
<a href="#l23.962"></a><span id="l23.962" class="difflineminus">-    {</span>
<a href="#l23.963"></a><span id="l23.963" class="difflineplus">+    if (!list[index].IsEmpty()) {</span>
<a href="#l23.964"></a><span id="l23.964">       nsAutoCString currentHost;</span>
<a href="#l23.965"></a><span id="l23.965">       nsAutoCString theRest;</span>
<a href="#l23.966"></a><span id="l23.966">       // does list[index] start with &quot;news:/&quot;?</span>
<a href="#l23.967"></a><span id="l23.967" class="difflineminus">-      if (StringBeginsWith(list[index], NS_LITERAL_CSTRING(kNewsRootURI)))</span>
<a href="#l23.968"></a><span id="l23.968" class="difflineminus">-      {</span>
<a href="#l23.969"></a><span id="l23.969" class="difflineplus">+      if (StringBeginsWith(list[index], NS_LITERAL_CSTRING(kNewsRootURI))) {</span>
<a href="#l23.970"></a><span id="l23.970">         // we have news://group or news://host/group</span>
<a href="#l23.971"></a><span id="l23.971">         // set theRest to what's after news://</span>
<a href="#l23.972"></a><span id="l23.972" class="difflineminus">-        theRest = Substring(list[index], kNewsRootURILen /* for news:/ */ + 1 /* for the slash */);</span>
<a href="#l23.973"></a><span id="l23.973" class="difflineminus">-      }</span>
<a href="#l23.974"></a><span id="l23.974" class="difflineminus">-      else if (list[index].Find(&quot;:/&quot;) != -1)</span>
<a href="#l23.975"></a><span id="l23.975" class="difflineminus">-      {</span>
<a href="#l23.976"></a><span id="l23.976" class="difflineplus">+        theRest = Substring(list[index], kNewsRootURILen /* for news:/ */ +</span>
<a href="#l23.977"></a><span id="l23.977" class="difflineplus">+                                             1 /* for the slash */);</span>
<a href="#l23.978"></a><span id="l23.978" class="difflineplus">+      } else if (list[index].Find(&quot;:/&quot;) != -1) {</span>
<a href="#l23.979"></a><span id="l23.979">         // we have x:/y where x != news. this is bad, return failure</span>
<a href="#l23.980"></a><span id="l23.980">         return NS_ERROR_FAILURE;</span>
<a href="#l23.981"></a><span id="l23.981" class="difflineminus">-      }</span>
<a href="#l23.982"></a><span id="l23.982" class="difflineminus">-      else</span>
<a href="#l23.983"></a><span id="l23.983" class="difflineplus">+      } else</span>
<a href="#l23.984"></a><span id="l23.984">         theRest = list[index];</span>
<a href="#l23.985"></a><span id="l23.985"> </span>
<a href="#l23.986"></a><span id="l23.986">       // theRest is &quot;group&quot; or &quot;host/group&quot;</span>
<a href="#l23.987"></a><span id="l23.987">       int32_t slashpos = theRest.FindChar('/');</span>
<a href="#l23.988"></a><span id="l23.988" class="difflineminus">-      if (slashpos &gt; 0 )</span>
<a href="#l23.989"></a><span id="l23.989" class="difflineminus">-      {</span>
<a href="#l23.990"></a><span id="l23.990" class="difflineplus">+      if (slashpos &gt; 0) {</span>
<a href="#l23.991"></a><span id="l23.991">         nsAutoCString currentGroup;</span>
<a href="#l23.992"></a><span id="l23.992"> </span>
<a href="#l23.993"></a><span id="l23.993">         // theRest is &quot;host/group&quot;</span>
<a href="#l23.994"></a><span id="l23.994">         currentHost = StringHead(theRest, slashpos);</span>
<a href="#l23.995"></a><span id="l23.995"> </span>
<a href="#l23.996"></a><span id="l23.996">         // from &quot;host/group&quot;, put &quot;group&quot; into currentGroup;</span>
<a href="#l23.997"></a><span id="l23.997">         currentGroup = Substring(theRest, slashpos + 1);</span>
<a href="#l23.998"></a><span id="l23.998"> </span>
<a href="#l23.999"></a><span id="l23.999">         NS_ASSERTION(!currentGroup.IsEmpty(), &quot;currentGroup is empty&quot;);</span>
<a href="#l23.1000"></a><span id="l23.1000" class="difflineminus">-        if (currentGroup.IsEmpty())</span>
<a href="#l23.1001"></a><span id="l23.1001" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l23.1002"></a><span id="l23.1002" class="difflineplus">+        if (currentGroup.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l23.1003"></a><span id="l23.1003"> </span>
<a href="#l23.1004"></a><span id="l23.1004">         // build up the newsgroups</span>
<a href="#l23.1005"></a><span id="l23.1005" class="difflineminus">-        if (!newsgroups.IsEmpty())</span>
<a href="#l23.1006"></a><span id="l23.1006" class="difflineminus">-          newsgroups += &quot;,&quot;;</span>
<a href="#l23.1007"></a><span id="l23.1007" class="difflineplus">+        if (!newsgroups.IsEmpty()) newsgroups += &quot;,&quot;;</span>
<a href="#l23.1008"></a><span id="l23.1008">         newsgroups += currentGroup;</span>
<a href="#l23.1009"></a><span id="l23.1009" class="difflineminus">-      }</span>
<a href="#l23.1010"></a><span id="l23.1010" class="difflineminus">-      else</span>
<a href="#l23.1011"></a><span id="l23.1011" class="difflineminus">-      {</span>
<a href="#l23.1012"></a><span id="l23.1012" class="difflineplus">+      } else {</span>
<a href="#l23.1013"></a><span id="l23.1013">         // theRest is &quot;group&quot;</span>
<a href="#l23.1014"></a><span id="l23.1014">         rv = FindHostFromGroup(currentHost, theRest);</span>
<a href="#l23.1015"></a><span id="l23.1015" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l23.1016"></a><span id="l23.1016" class="difflineminus">-          return rv;</span>
<a href="#l23.1017"></a><span id="l23.1017" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1018"></a><span id="l23.1018">         // build up the newsgroups</span>
<a href="#l23.1019"></a><span id="l23.1019" class="difflineminus">-        if (!newsgroups.IsEmpty())</span>
<a href="#l23.1020"></a><span id="l23.1020" class="difflineminus">-          newsgroups += &quot;,&quot;;</span>
<a href="#l23.1021"></a><span id="l23.1021" class="difflineplus">+        if (!newsgroups.IsEmpty()) newsgroups += &quot;,&quot;;</span>
<a href="#l23.1022"></a><span id="l23.1022">         newsgroups += theRest;</span>
<a href="#l23.1023"></a><span id="l23.1023">       }</span>
<a href="#l23.1024"></a><span id="l23.1024"> </span>
<a href="#l23.1025"></a><span id="l23.1025" class="difflineminus">-      if (!currentHost.IsEmpty())</span>
<a href="#l23.1026"></a><span id="l23.1026" class="difflineminus">-      {</span>
<a href="#l23.1027"></a><span id="l23.1027" class="difflineplus">+      if (!currentHost.IsEmpty()) {</span>
<a href="#l23.1028"></a><span id="l23.1028">         if (host.IsEmpty())</span>
<a href="#l23.1029"></a><span id="l23.1029">           host = currentHost;</span>
<a href="#l23.1030"></a><span id="l23.1030" class="difflineminus">-        else</span>
<a href="#l23.1031"></a><span id="l23.1031" class="difflineminus">-        {</span>
<a href="#l23.1032"></a><span id="l23.1032" class="difflineminus">-          if (!host.Equals(currentHost))</span>
<a href="#l23.1033"></a><span id="l23.1033" class="difflineminus">-            return NS_ERROR_NNTP_NO_CROSS_POSTING;</span>
<a href="#l23.1034"></a><span id="l23.1034" class="difflineplus">+        else {</span>
<a href="#l23.1035"></a><span id="l23.1035" class="difflineplus">+          if (!host.Equals(currentHost)) return NS_ERROR_NNTP_NO_CROSS_POSTING;</span>
<a href="#l23.1036"></a><span id="l23.1036">         }</span>
<a href="#l23.1037"></a><span id="l23.1037">       }</span>
<a href="#l23.1038"></a><span id="l23.1038">       currentHost = &quot;&quot;;</span>
<a href="#l23.1039"></a><span id="l23.1039">     }</span>
<a href="#l23.1040"></a><span id="l23.1040">   }</span>
<a href="#l23.1041"></a><span id="l23.1041"> </span>
<a href="#l23.1042"></a><span id="l23.1042">   *newshostHeaderVal = ToNewCString(host);</span>
<a href="#l23.1043"></a><span id="l23.1043">   if (!*newshostHeaderVal) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.1044"></a><span id="l23.1044"> </span>
<a href="#l23.1045"></a><span id="l23.1045">   *newsgroupsHeaderVal = ToNewCString(newsgroups);</span>
<a href="#l23.1046"></a><span id="l23.1046">   if (!*newsgroupsHeaderVal) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.1047"></a><span id="l23.1047"> </span>
<a href="#l23.1048"></a><span id="l23.1048">   return NS_OK;</span>
<a href="#l23.1049"></a><span id="l23.1049"> }</span>
<a href="#l23.1050"></a><span id="l23.1050"> </span>
<a href="#l23.1051"></a><span id="l23.1051" class="difflineminus">-nsresult</span>
<a href="#l23.1052"></a><span id="l23.1052" class="difflineminus">-nsNntpService::GetNntpServerByAccount(const char *aAccountKey, nsIMsgIncomingServer **aNntpServer)</span>
<a href="#l23.1053"></a><span id="l23.1053" class="difflineminus">-{</span>
<a href="#l23.1054"></a><span id="l23.1054" class="difflineplus">+nsresult nsNntpService::GetNntpServerByAccount(</span>
<a href="#l23.1055"></a><span id="l23.1055" class="difflineplus">+    const char *aAccountKey, nsIMsgIncomingServer **aNntpServer) {</span>
<a href="#l23.1056"></a><span id="l23.1056">   NS_ENSURE_ARG_POINTER(aNntpServer);</span>
<a href="#l23.1057"></a><span id="l23.1057">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1058"></a><span id="l23.1058"> </span>
<a href="#l23.1059"></a><span id="l23.1059" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1060"></a><span id="l23.1060" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1061"></a><span id="l23.1061" class="difflineminus">-  if (aAccountKey)</span>
<a href="#l23.1062"></a><span id="l23.1062" class="difflineminus">-  {</span>
<a href="#l23.1063"></a><span id="l23.1063" class="difflineminus">-    nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l23.1064"></a><span id="l23.1064" class="difflineminus">-    rv = accountManager-&gt;GetAccount(nsDependentCString(aAccountKey), getter_AddRefs(account));</span>
<a href="#l23.1065"></a><span id="l23.1065" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.1066"></a><span id="l23.1066" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1067"></a><span id="l23.1067" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1068"></a><span id="l23.1068" class="difflineplus">+  if (aAccountKey) {</span>
<a href="#l23.1069"></a><span id="l23.1069" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l23.1070"></a><span id="l23.1070" class="difflineplus">+    rv = accountManager-&gt;GetAccount(nsDependentCString(aAccountKey),</span>
<a href="#l23.1071"></a><span id="l23.1071" class="difflineplus">+                                    getter_AddRefs(account));</span>
<a href="#l23.1072"></a><span id="l23.1072">     if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l23.1073"></a><span id="l23.1073">       rv = account-&gt;GetIncomingServer(aNntpServer);</span>
<a href="#l23.1074"></a><span id="l23.1074">   }</span>
<a href="#l23.1075"></a><span id="l23.1075"> </span>
<a href="#l23.1076"></a><span id="l23.1076">   // if we don't have a news host, find the first news server and use it</span>
<a href="#l23.1077"></a><span id="l23.1077">   if (NS_FAILED(rv) || !*aNntpServer)</span>
<a href="#l23.1078"></a><span id="l23.1078" class="difflineminus">-    rv = accountManager-&gt;FindServer(EmptyCString(), EmptyCString(), NS_LITERAL_CSTRING(&quot;nntp&quot;), aNntpServer);</span>
<a href="#l23.1079"></a><span id="l23.1079" class="difflineplus">+    rv = accountManager-&gt;FindServer(EmptyCString(), EmptyCString(),</span>
<a href="#l23.1080"></a><span id="l23.1080" class="difflineplus">+                                    NS_LITERAL_CSTRING(&quot;nntp&quot;), aNntpServer);</span>
<a href="#l23.1081"></a><span id="l23.1081"> </span>
<a href="#l23.1082"></a><span id="l23.1082">   return rv;</span>
<a href="#l23.1083"></a><span id="l23.1083"> }</span>
<a href="#l23.1084"></a><span id="l23.1084"> </span>
<a href="#l23.1085"></a><span id="l23.1085"> NS_IMETHODIMP</span>
<a href="#l23.1086"></a><span id="l23.1086" class="difflineminus">-nsNntpService::PostMessage(nsIFile *aFileToPost, const char *newsgroupsNames, const char *aAccountKey, nsIUrlListener * aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI **_retval)</span>
<a href="#l23.1087"></a><span id="l23.1087" class="difflineminus">-{</span>
<a href="#l23.1088"></a><span id="l23.1088" class="difflineplus">+nsNntpService::PostMessage(nsIFile *aFileToPost, const char *newsgroupsNames,</span>
<a href="#l23.1089"></a><span id="l23.1089" class="difflineplus">+                           const char *aAccountKey,</span>
<a href="#l23.1090"></a><span id="l23.1090" class="difflineplus">+                           nsIUrlListener *aUrlListener,</span>
<a href="#l23.1091"></a><span id="l23.1091" class="difflineplus">+                           nsIMsgWindow *aMsgWindow, nsIURI **_retval) {</span>
<a href="#l23.1092"></a><span id="l23.1092">   // aMsgWindow might be null</span>
<a href="#l23.1093"></a><span id="l23.1093">   NS_ENSURE_ARG_POINTER(newsgroupsNames);</span>
<a href="#l23.1094"></a><span id="l23.1094"> </span>
<a href="#l23.1095"></a><span id="l23.1095">   NS_ENSURE_ARG(*newsgroupsNames);</span>
<a href="#l23.1096"></a><span id="l23.1096"> </span>
<a href="#l23.1097"></a><span id="l23.1097">   nsresult rv;</span>
<a href="#l23.1098"></a><span id="l23.1098"> </span>
<a href="#l23.1099"></a><span id="l23.1099" class="difflineminus">-  nsCOMPtr &lt;nsINntpUrl&gt; nntpUrl = do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l23.1100"></a><span id="l23.1100" class="difflineplus">+  nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl = do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l23.1101"></a><span id="l23.1101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1102"></a><span id="l23.1102"> </span>
<a href="#l23.1103"></a><span id="l23.1103">   rv = nntpUrl-&gt;SetNewsAction(nsINntpUrl::ActionPostArticle);</span>
<a href="#l23.1104"></a><span id="l23.1104">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1105"></a><span id="l23.1105"> </span>
<a href="#l23.1106"></a><span id="l23.1106">   nsCString newsUrlSpec;</span>
<a href="#l23.1107"></a><span id="l23.1107">   rv = SetUpNntpUrlForPosting(aAccountKey, getter_Copies(newsUrlSpec));</span>
<a href="#l23.1108"></a><span id="l23.1108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1109"></a><span id="l23.1109"> </span>
<a href="#l23.1110"></a><span id="l23.1110">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(nntpUrl, &amp;rv);</span>
<a href="#l23.1111"></a><span id="l23.1111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1112"></a><span id="l23.1112"> </span>
<a href="#l23.1113"></a><span id="l23.1113">   rv = mailnewsurl-&gt;SetSpecInternal(newsUrlSpec);</span>
<a href="#l23.1114"></a><span id="l23.1114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1115"></a><span id="l23.1115"> </span>
<a href="#l23.1116"></a><span id="l23.1116" class="difflineminus">-  if (aUrlListener) // register listener if there is one...</span>
<a href="#l23.1117"></a><span id="l23.1117" class="difflineplus">+  if (aUrlListener)  // register listener if there is one...</span>
<a href="#l23.1118"></a><span id="l23.1118">     mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l23.1119"></a><span id="l23.1119"> </span>
<a href="#l23.1120"></a><span id="l23.1120" class="difflineminus">-  nsCOMPtr&lt;nsINNTPNewsgroupPost&gt; post = do_CreateInstance(NS_NNTPNEWSGROUPPOST_CONTRACTID, &amp;rv);</span>
<a href="#l23.1121"></a><span id="l23.1121" class="difflineplus">+  nsCOMPtr&lt;nsINNTPNewsgroupPost&gt; post =</span>
<a href="#l23.1122"></a><span id="l23.1122" class="difflineplus">+      do_CreateInstance(NS_NNTPNEWSGROUPPOST_CONTRACTID, &amp;rv);</span>
<a href="#l23.1123"></a><span id="l23.1123">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1124"></a><span id="l23.1124"> </span>
<a href="#l23.1125"></a><span id="l23.1125">   rv = post-&gt;SetPostMessageFile(aFileToPost);</span>
<a href="#l23.1126"></a><span id="l23.1126">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1127"></a><span id="l23.1127"> </span>
<a href="#l23.1128"></a><span id="l23.1128">   rv = nntpUrl-&gt;SetMessageToPost(post);</span>
<a href="#l23.1129"></a><span id="l23.1129">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1130"></a><span id="l23.1130"> </span>
<a href="#l23.1131"></a><span id="l23.1131">   nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(nntpUrl);</span>
<a href="#l23.1132"></a><span id="l23.1132">   rv = RunNewsUrl(url, aMsgWindow, nullptr /* consumer */);</span>
<a href="#l23.1133"></a><span id="l23.1133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1134"></a><span id="l23.1134"> </span>
<a href="#l23.1135"></a><span id="l23.1135" class="difflineminus">-  if (_retval)</span>
<a href="#l23.1136"></a><span id="l23.1136" class="difflineminus">-    rv = CallQueryInterface(nntpUrl, _retval);</span>
<a href="#l23.1137"></a><span id="l23.1137" class="difflineplus">+  if (_retval) rv = CallQueryInterface(nntpUrl, _retval);</span>
<a href="#l23.1138"></a><span id="l23.1138"> </span>
<a href="#l23.1139"></a><span id="l23.1139">   return rv;</span>
<a href="#l23.1140"></a><span id="l23.1140"> }</span>
<a href="#l23.1141"></a><span id="l23.1141"> </span>
<a href="#l23.1142"></a><span id="l23.1142" class="difflineminus">-nsresult</span>
<a href="#l23.1143"></a><span id="l23.1143" class="difflineminus">-nsNntpService::ConstructNntpUrl(const char *urlString, nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow, const char *originalMessageUri, int32_t action, nsIURI ** aUrl)</span>
<a href="#l23.1144"></a><span id="l23.1144" class="difflineminus">-{</span>
<a href="#l23.1145"></a><span id="l23.1145" class="difflineplus">+nsresult nsNntpService::ConstructNntpUrl(const char *urlString,</span>
<a href="#l23.1146"></a><span id="l23.1146" class="difflineplus">+                                         nsIUrlListener *aUrlListener,</span>
<a href="#l23.1147"></a><span id="l23.1147" class="difflineplus">+                                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.1148"></a><span id="l23.1148" class="difflineplus">+                                         const char *originalMessageUri,</span>
<a href="#l23.1149"></a><span id="l23.1149" class="difflineplus">+                                         int32_t action, nsIURI **aUrl) {</span>
<a href="#l23.1150"></a><span id="l23.1150">   nsresult rv = NS_OK;</span>
<a href="#l23.1151"></a><span id="l23.1151"> </span>
<a href="#l23.1152"></a><span id="l23.1152">   nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl = do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l23.1153"></a><span id="l23.1153" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1154"></a><span id="l23.1154" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1155"></a><span id="l23.1155"> </span>
<a href="#l23.1156"></a><span id="l23.1156">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(nntpUrl);</span>
<a href="#l23.1157"></a><span id="l23.1157">   mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l23.1158"></a><span id="l23.1158">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(nntpUrl);</span>
<a href="#l23.1159"></a><span id="l23.1159">   msgUrl-&gt;SetUri(originalMessageUri);</span>
<a href="#l23.1160"></a><span id="l23.1160">   rv = mailnewsurl-&gt;SetSpecInternal(nsDependentCString(urlString));</span>
<a href="#l23.1161"></a><span id="l23.1161">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1162"></a><span id="l23.1162">   nntpUrl-&gt;SetNewsAction(action);</span>
<a href="#l23.1163"></a><span id="l23.1163"> </span>
<a href="#l23.1164"></a><span id="l23.1164" class="difflineminus">-  if (originalMessageUri)</span>
<a href="#l23.1165"></a><span id="l23.1165" class="difflineminus">-  {</span>
<a href="#l23.1166"></a><span id="l23.1166" class="difflineplus">+  if (originalMessageUri) {</span>
<a href="#l23.1167"></a><span id="l23.1167">     // we'll use this later in nsNNTPProtocol::ParseURL()</span>
<a href="#l23.1168"></a><span id="l23.1168">     rv = msgUrl-&gt;SetOriginalSpec(originalMessageUri);</span>
<a href="#l23.1169"></a><span id="l23.1169" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1170"></a><span id="l23.1170" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1171"></a><span id="l23.1171">   }</span>
<a href="#l23.1172"></a><span id="l23.1172"> </span>
<a href="#l23.1173"></a><span id="l23.1173" class="difflineminus">-  if (aUrlListener) // register listener if there is one...</span>
<a href="#l23.1174"></a><span id="l23.1174" class="difflineplus">+  if (aUrlListener)  // register listener if there is one...</span>
<a href="#l23.1175"></a><span id="l23.1175">     mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l23.1176"></a><span id="l23.1176"> </span>
<a href="#l23.1177"></a><span id="l23.1177">   mailnewsurl.forget(aUrl);</span>
<a href="#l23.1178"></a><span id="l23.1178">   return rv;</span>
<a href="#l23.1179"></a><span id="l23.1179"> }</span>
<a href="#l23.1180"></a><span id="l23.1180"> </span>
<a href="#l23.1181"></a><span id="l23.1181" class="difflineminus">-nsresult</span>
<a href="#l23.1182"></a><span id="l23.1182" class="difflineminus">-nsNntpService::CreateNewsAccount(const char *aHostname, bool aUseSSL,</span>
<a href="#l23.1183"></a><span id="l23.1183" class="difflineminus">-                                 int32_t aPort, nsIMsgIncomingServer **aServer)</span>
<a href="#l23.1184"></a><span id="l23.1184" class="difflineminus">-{</span>
<a href="#l23.1185"></a><span id="l23.1185" class="difflineplus">+nsresult nsNntpService::CreateNewsAccount(const char *aHostname, bool aUseSSL,</span>
<a href="#l23.1186"></a><span id="l23.1186" class="difflineplus">+                                          int32_t aPort,</span>
<a href="#l23.1187"></a><span id="l23.1187" class="difflineplus">+                                          nsIMsgIncomingServer **aServer) {</span>
<a href="#l23.1188"></a><span id="l23.1188">   NS_ENSURE_ARG_POINTER(aHostname);</span>
<a href="#l23.1189"></a><span id="l23.1189">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l23.1190"></a><span id="l23.1190"> </span>
<a href="#l23.1191"></a><span id="l23.1191">   nsresult rv;</span>
<a href="#l23.1192"></a><span id="l23.1192" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1193"></a><span id="l23.1193" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1194"></a><span id="l23.1194" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.1195"></a><span id="l23.1195" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1196"></a><span id="l23.1196" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1197"></a><span id="l23.1197"> </span>
<a href="#l23.1198"></a><span id="l23.1198" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l23.1199"></a><span id="l23.1199" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l23.1200"></a><span id="l23.1200">   rv = accountManager-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l23.1201"></a><span id="l23.1201">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1202"></a><span id="l23.1202"> </span>
<a href="#l23.1203"></a><span id="l23.1203">   // for news, username is always null</span>
<a href="#l23.1204"></a><span id="l23.1204" class="difflineminus">-  rv = accountManager-&gt;CreateIncomingServer(EmptyCString(), nsDependentCString(aHostname), NS_LITERAL_CSTRING(&quot;nntp&quot;), aServer);</span>
<a href="#l23.1205"></a><span id="l23.1205" class="difflineplus">+  rv = accountManager-&gt;CreateIncomingServer(</span>
<a href="#l23.1206"></a><span id="l23.1206" class="difflineplus">+      EmptyCString(), nsDependentCString(aHostname), NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l23.1207"></a><span id="l23.1207" class="difflineplus">+      aServer);</span>
<a href="#l23.1208"></a><span id="l23.1208">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1209"></a><span id="l23.1209"> </span>
<a href="#l23.1210"></a><span id="l23.1210" class="difflineminus">-  if (aUseSSL)</span>
<a href="#l23.1211"></a><span id="l23.1211" class="difflineminus">-  {</span>
<a href="#l23.1212"></a><span id="l23.1212" class="difflineplus">+  if (aUseSSL) {</span>
<a href="#l23.1213"></a><span id="l23.1213">     rv = (*aServer)-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l23.1214"></a><span id="l23.1214">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1215"></a><span id="l23.1215">   }</span>
<a href="#l23.1216"></a><span id="l23.1216"> </span>
<a href="#l23.1217"></a><span id="l23.1217">   rv = (*aServer)-&gt;SetPort(aPort);</span>
<a href="#l23.1218"></a><span id="l23.1218">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1219"></a><span id="l23.1219"> </span>
<a href="#l23.1220"></a><span id="l23.1220" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l23.1221"></a><span id="l23.1221" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l23.1222"></a><span id="l23.1222">   rv = accountManager-&gt;CreateIdentity(getter_AddRefs(identity));</span>
<a href="#l23.1223"></a><span id="l23.1223">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1224"></a><span id="l23.1224">   if (!identity) return NS_ERROR_FAILURE;</span>
<a href="#l23.1225"></a><span id="l23.1225"> </span>
<a href="#l23.1226"></a><span id="l23.1226">   // by default, news accounts should be composing in plain text</span>
<a href="#l23.1227"></a><span id="l23.1227">   rv = identity-&gt;SetComposeHtml(false);</span>
<a href="#l23.1228"></a><span id="l23.1228" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1229"></a><span id="l23.1229" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1230"></a><span id="l23.1230"> </span>
<a href="#l23.1231"></a><span id="l23.1231">   // the identity isn't filled in, so it is not valid.</span>
<a href="#l23.1232"></a><span id="l23.1232">   rv = (*aServer)-&gt;SetValid(false);</span>
<a href="#l23.1233"></a><span id="l23.1233">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1234"></a><span id="l23.1234"> </span>
<a href="#l23.1235"></a><span id="l23.1235">   // hook them together</span>
<a href="#l23.1236"></a><span id="l23.1236">   rv = account-&gt;SetIncomingServer(*aServer);</span>
<a href="#l23.1237"></a><span id="l23.1237">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1238"></a><span id="l23.1238" class="difflineat">@@ -962,85 +920,82 @@ nsNntpService::CreateNewsAccount(const c</span>
<a href="#l23.1239"></a><span id="l23.1239"> </span>
<a href="#l23.1240"></a><span id="l23.1240">   // Now save the new acct info to pref file.</span>
<a href="#l23.1241"></a><span id="l23.1241">   rv = accountManager-&gt;SaveAccountInfo();</span>
<a href="#l23.1242"></a><span id="l23.1242">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1243"></a><span id="l23.1243"> </span>
<a href="#l23.1244"></a><span id="l23.1244">   return NS_OK;</span>
<a href="#l23.1245"></a><span id="l23.1245"> }</span>
<a href="#l23.1246"></a><span id="l23.1246"> </span>
<a href="#l23.1247"></a><span id="l23.1247" class="difflineminus">-nsresult</span>
<a href="#l23.1248"></a><span id="l23.1248" class="difflineminus">-nsNntpService::GetServerForUri(nsIURI *aUri, nsINntpIncomingServer **aServer)</span>
<a href="#l23.1249"></a><span id="l23.1249" class="difflineminus">-{</span>
<a href="#l23.1250"></a><span id="l23.1250" class="difflineplus">+nsresult nsNntpService::GetServerForUri(nsIURI *aUri,</span>
<a href="#l23.1251"></a><span id="l23.1251" class="difflineplus">+                                        nsINntpIncomingServer **aServer) {</span>
<a href="#l23.1252"></a><span id="l23.1252">   nsAutoCString hostName;</span>
<a href="#l23.1253"></a><span id="l23.1253">   nsAutoCString scheme;</span>
<a href="#l23.1254"></a><span id="l23.1254">   nsAutoCString path;</span>
<a href="#l23.1255"></a><span id="l23.1255">   int32_t port = 0;</span>
<a href="#l23.1256"></a><span id="l23.1256">   nsresult rv;</span>
<a href="#l23.1257"></a><span id="l23.1257"> </span>
<a href="#l23.1258"></a><span id="l23.1258">   rv = aUri-&gt;GetAsciiHost(hostName);</span>
<a href="#l23.1259"></a><span id="l23.1259">   rv = aUri-&gt;GetScheme(scheme);</span>
<a href="#l23.1260"></a><span id="l23.1260">   rv = aUri-&gt;GetPort(&amp;port);</span>
<a href="#l23.1261"></a><span id="l23.1261">   rv = aUri-&gt;GetPathQueryRef(path);</span>
<a href="#l23.1262"></a><span id="l23.1262"> </span>
<a href="#l23.1263"></a><span id="l23.1263" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1264"></a><span id="l23.1264" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1265"></a><span id="l23.1265" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.1266"></a><span id="l23.1266" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1267"></a><span id="l23.1267" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1268"></a><span id="l23.1268"> </span>
<a href="#l23.1269"></a><span id="l23.1269">   // find the incoming server, it if exists.</span>
<a href="#l23.1270"></a><span id="l23.1270">   // migrate if necessary, before searching for it.</span>
<a href="#l23.1271"></a><span id="l23.1271">   // if it doesn't exist, create it.</span>
<a href="#l23.1272"></a><span id="l23.1272">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.1273"></a><span id="l23.1273"> </span>
<a href="#l23.1274"></a><span id="l23.1274">   // Grab all servers for if this is a no-authority URL. This also loads</span>
<a href="#l23.1275"></a><span id="l23.1275">   // accounts if they haven't been loaded, i.e., we're running this straight</span>
<a href="#l23.1276"></a><span id="l23.1276">   // from the command line</span>
<a href="#l23.1277"></a><span id="l23.1277" class="difflineminus">-  nsCOMPtr &lt;nsIArray&gt; servers;</span>
<a href="#l23.1278"></a><span id="l23.1278" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l23.1279"></a><span id="l23.1279">   rv = accountManager-&gt;GetAllServers(getter_AddRefs(servers));</span>
<a href="#l23.1280"></a><span id="l23.1280">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1281"></a><span id="l23.1281"> </span>
<a href="#l23.1282"></a><span id="l23.1282">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUri, &amp;rv);</span>
<a href="#l23.1283"></a><span id="l23.1283">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1284"></a><span id="l23.1284"> </span>
<a href="#l23.1285"></a><span id="l23.1285">   rv = mailUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l23.1286"></a><span id="l23.1286">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1287"></a><span id="l23.1287"> </span>
<a href="#l23.1288"></a><span id="l23.1288" class="difflineminus">-  if (!server &amp;&amp; !hostName.IsEmpty())</span>
<a href="#l23.1289"></a><span id="l23.1289" class="difflineminus">-  {</span>
<a href="#l23.1290"></a><span id="l23.1290" class="difflineplus">+  if (!server &amp;&amp; !hostName.IsEmpty()) {</span>
<a href="#l23.1291"></a><span id="l23.1291">     // If we don't have this server but it isn't no-auth, add it.</span>
<a href="#l23.1292"></a><span id="l23.1292">     // Ideally, we should remove this account quickly (see bug 41133)</span>
<a href="#l23.1293"></a><span id="l23.1293">     bool useSSL = false;</span>
<a href="#l23.1294"></a><span id="l23.1294" class="difflineminus">-    if (scheme.EqualsLiteral(&quot;snews&quot;) || scheme.EqualsLiteral(&quot;nntps&quot;))</span>
<a href="#l23.1295"></a><span id="l23.1295" class="difflineminus">-    {</span>
<a href="#l23.1296"></a><span id="l23.1296" class="difflineplus">+    if (scheme.EqualsLiteral(&quot;snews&quot;) || scheme.EqualsLiteral(&quot;nntps&quot;)) {</span>
<a href="#l23.1297"></a><span id="l23.1297">       useSSL = true;</span>
<a href="#l23.1298"></a><span id="l23.1298" class="difflineminus">-      if ((port == 0) || (port == -1))</span>
<a href="#l23.1299"></a><span id="l23.1299" class="difflineminus">-          port = nsINntpUrl::DEFAULT_NNTPS_PORT;</span>
<a href="#l23.1300"></a><span id="l23.1300" class="difflineplus">+      if ((port == 0) || (port == -1)) port = nsINntpUrl::DEFAULT_NNTPS_PORT;</span>
<a href="#l23.1301"></a><span id="l23.1301">     }</span>
<a href="#l23.1302"></a><span id="l23.1302" class="difflineminus">-    rv = CreateNewsAccount(hostName.get(), useSSL, port, getter_AddRefs(server));</span>
<a href="#l23.1303"></a><span id="l23.1303" class="difflineplus">+    rv =</span>
<a href="#l23.1304"></a><span id="l23.1304" class="difflineplus">+        CreateNewsAccount(hostName.get(), useSSL, port, getter_AddRefs(server));</span>
<a href="#l23.1305"></a><span id="l23.1305">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1306"></a><span id="l23.1306">   }</span>
<a href="#l23.1307"></a><span id="l23.1307"> </span>
<a href="#l23.1308"></a><span id="l23.1308">   if (!server &amp;&amp; hostName.IsEmpty())</span>
<a href="#l23.1309"></a><span id="l23.1309">     // XXX: Until we support no-auth uris, bail</span>
<a href="#l23.1310"></a><span id="l23.1310">     return NS_ERROR_FAILURE;</span>
<a href="#l23.1311"></a><span id="l23.1311"> </span>
<a href="#l23.1312"></a><span id="l23.1312">   if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l23.1313"></a><span id="l23.1313"> </span>
<a href="#l23.1314"></a><span id="l23.1314">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l23.1315"></a><span id="l23.1315">   nntpServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l23.1316"></a><span id="l23.1316"> </span>
<a href="#l23.1317"></a><span id="l23.1317" class="difflineminus">-  if (!nntpServer || NS_FAILED(rv))</span>
<a href="#l23.1318"></a><span id="l23.1318" class="difflineminus">-    return rv;</span>
<a href="#l23.1319"></a><span id="l23.1319" class="difflineplus">+  if (!nntpServer || NS_FAILED(rv)) return rv;</span>
<a href="#l23.1320"></a><span id="l23.1320"> </span>
<a href="#l23.1321"></a><span id="l23.1321">   nntpServer.forget(aServer);</span>
<a href="#l23.1322"></a><span id="l23.1322"> </span>
<a href="#l23.1323"></a><span id="l23.1323">   nsAutoCString spec;</span>
<a href="#l23.1324"></a><span id="l23.1324">   rv = aUri-&gt;GetSpec(spec);</span>
<a href="#l23.1325"></a><span id="l23.1325" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1326"></a><span id="l23.1326" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1327"></a><span id="l23.1327"> </span>
<a href="#l23.1328"></a><span id="l23.1328" class="difflineminus">-#if 0 // this not ready yet.</span>
<a href="#l23.1329"></a><span id="l23.1329" class="difflineplus">+#if 0  // this not ready yet.</span>
<a href="#l23.1330"></a><span id="l23.1330">   nsNewsAction action = nsINntpUrl::ActionUnknown;</span>
<a href="#l23.1331"></a><span id="l23.1331">   nsCOMPtr &lt;nsINntpUrl&gt; nntpUrl = do_QueryInterface(aUri);</span>
<a href="#l23.1332"></a><span id="l23.1332">   if (nntpUrl) {</span>
<a href="#l23.1333"></a><span id="l23.1333">     rv = nntpUrl-&gt;GetNewsAction(&amp;action);</span>
<a href="#l23.1334"></a><span id="l23.1334">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1335"></a><span id="l23.1335">   }</span>
<a href="#l23.1336"></a><span id="l23.1336"> </span>
<a href="#l23.1337"></a><span id="l23.1337">   // if this is a news-message:/ uri, decompose it and set hasMsgOffline on the uri</span>
<a href="#l23.1338"></a><span id="l23.1338" class="difflineat">@@ -1048,199 +1003,185 @@ nsNntpService::GetServerForUri(nsIURI *a</span>
<a href="#l23.1339"></a><span id="l23.1339">   // &quot;news://news.mozilla.org:119/3D612B96.1050301%40netscape.com?part=1.2&amp;type=image/gif&amp;filename=hp_icon_logo.gif&quot;</span>
<a href="#l23.1340"></a><span id="l23.1340"> </span>
<a href="#l23.1341"></a><span id="l23.1341">   // XXX todo, or do we want to check if it is a news-message:// uri or</span>
<a href="#l23.1342"></a><span id="l23.1342">   // a news:// uri (but action is not a fetch related action?)</span>
<a href="#l23.1343"></a><span id="l23.1343">   if (!PL_strncmp(spec.get(), kNewsMessageRootURI, kNewsMessageRootURILen) ||</span>
<a href="#l23.1344"></a><span id="l23.1344">       (action == nsINntpUrl::ActionFetchPart || action == nsINntpUrl::ActionFetchArticle))</span>
<a href="#l23.1345"></a><span id="l23.1345">   {</span>
<a href="#l23.1346"></a><span id="l23.1346"> #else</span>
<a href="#l23.1347"></a><span id="l23.1347" class="difflineminus">-  // if this is a news-message:/ uri, decompose it and set hasMsgOffline on the uri</span>
<a href="#l23.1348"></a><span id="l23.1348" class="difflineminus">-  if (!PL_strncmp(spec.get(), kNewsMessageRootURI, kNewsMessageRootURILen))</span>
<a href="#l23.1349"></a><span id="l23.1349" class="difflineminus">-  {</span>
<a href="#l23.1350"></a><span id="l23.1350" class="difflineplus">+  // if this is a news-message:/ uri, decompose it and set hasMsgOffline on the</span>
<a href="#l23.1351"></a><span id="l23.1351" class="difflineplus">+  // uri</span>
<a href="#l23.1352"></a><span id="l23.1352" class="difflineplus">+  if (!PL_strncmp(spec.get(), kNewsMessageRootURI, kNewsMessageRootURILen)) {</span>
<a href="#l23.1353"></a><span id="l23.1353"> #endif</span>
<a href="#l23.1354"></a><span id="l23.1354" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.1355"></a><span id="l23.1355" class="difflineminus">-    nsMsgKey key = nsMsgKey_None;</span>
<a href="#l23.1356"></a><span id="l23.1356" class="difflineminus">-    rv = DecomposeNewsMessageURI(spec.get(), getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.1357"></a><span id="l23.1357" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l23.1358"></a><span id="l23.1358" class="difflineminus">-    {</span>
<a href="#l23.1359"></a><span id="l23.1359" class="difflineminus">-      bool hasMsgOffline = false;</span>
<a href="#l23.1360"></a><span id="l23.1360" class="difflineminus">-      folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.1361"></a><span id="l23.1361" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(aUri));</span>
<a href="#l23.1362"></a><span id="l23.1362" class="difflineminus">-      if (msgUrl)</span>
<a href="#l23.1363"></a><span id="l23.1363" class="difflineminus">-        msgUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l23.1364"></a><span id="l23.1364" class="difflineminus">-    }</span>
<a href="#l23.1365"></a><span id="l23.1365" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.1366"></a><span id="l23.1366" class="difflineplus">+  nsMsgKey key = nsMsgKey_None;</span>
<a href="#l23.1367"></a><span id="l23.1367" class="difflineplus">+  rv = DecomposeNewsMessageURI(spec.get(), getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.1368"></a><span id="l23.1368" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l23.1369"></a><span id="l23.1369" class="difflineplus">+    bool hasMsgOffline = false;</span>
<a href="#l23.1370"></a><span id="l23.1370" class="difflineplus">+    folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.1371"></a><span id="l23.1371" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(aUri));</span>
<a href="#l23.1372"></a><span id="l23.1372" class="difflineplus">+    if (msgUrl) msgUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l23.1373"></a><span id="l23.1373">   }</span>
<a href="#l23.1374"></a><span id="l23.1374" class="difflineminus">-</span>
<a href="#l23.1375"></a><span id="l23.1375" class="difflineminus">-  return NS_OK;</span>
<a href="#l23.1376"></a><span id="l23.1376"> }</span>
<a href="#l23.1377"></a><span id="l23.1377"> </span>
<a href="#l23.1378"></a><span id="l23.1378" class="difflineminus">-nsresult</span>
<a href="#l23.1379"></a><span id="l23.1379" class="difflineminus">-nsNntpService::RunNewsUrl(nsIURI * aUri, nsIMsgWindow *aMsgWindow, nsISupports * aConsumer)</span>
<a href="#l23.1380"></a><span id="l23.1380" class="difflineminus">-{</span>
<a href="#l23.1381"></a><span id="l23.1381" class="difflineplus">+return NS_OK;</span>
<a href="#l23.1382"></a><span id="l23.1382" class="difflineplus">+}</span>
<a href="#l23.1383"></a><span id="l23.1383" class="difflineplus">+</span>
<a href="#l23.1384"></a><span id="l23.1384" class="difflineplus">+nsresult nsNntpService::RunNewsUrl(nsIURI *aUri, nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.1385"></a><span id="l23.1385" class="difflineplus">+                                   nsISupports *aConsumer) {</span>
<a href="#l23.1386"></a><span id="l23.1386">   nsresult rv;</span>
<a href="#l23.1387"></a><span id="l23.1387"> </span>
<a href="#l23.1388"></a><span id="l23.1388" class="difflineminus">-  if (WeAreOffline())</span>
<a href="#l23.1389"></a><span id="l23.1389" class="difflineminus">-    return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l23.1390"></a><span id="l23.1390" class="difflineplus">+  if (WeAreOffline()) return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l23.1391"></a><span id="l23.1391"> </span>
<a href="#l23.1392"></a><span id="l23.1392">   // almost there...now create a nntp protocol instance to run the url in...</span>
<a href="#l23.1393"></a><span id="l23.1393">   nsCOMPtr&lt;nsINntpIncomingServer&gt; server;</span>
<a href="#l23.1394"></a><span id="l23.1394">   rv = GetServerForUri(aUri, getter_AddRefs(server));</span>
<a href="#l23.1395"></a><span id="l23.1395">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1396"></a><span id="l23.1396"> </span>
<a href="#l23.1397"></a><span id="l23.1397">   return server-&gt;LoadNewsUrl(aUri, aMsgWindow, aConsumer);</span>
<a href="#l23.1398"></a><span id="l23.1398"> }</span>
<a href="#l23.1399"></a><span id="l23.1399"> </span>
<a href="#l23.1400"></a><span id="l23.1400" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetNewNews(nsINntpIncomingServer *nntpServer, const char *uri, bool aGetOld, nsIUrlListener * aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI **_retval)</span>
<a href="#l23.1401"></a><span id="l23.1401" class="difflineminus">-{</span>
<a href="#l23.1402"></a><span id="l23.1402" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetNewNews(nsINntpIncomingServer *nntpServer,</span>
<a href="#l23.1403"></a><span id="l23.1403" class="difflineplus">+                                        const char *uri, bool aGetOld,</span>
<a href="#l23.1404"></a><span id="l23.1404" class="difflineplus">+                                        nsIUrlListener *aUrlListener,</span>
<a href="#l23.1405"></a><span id="l23.1405" class="difflineplus">+                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.1406"></a><span id="l23.1406" class="difflineplus">+                                        nsIURI **_retval) {</span>
<a href="#l23.1407"></a><span id="l23.1407">   NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l23.1408"></a><span id="l23.1408"> </span>
<a href="#l23.1409"></a><span id="l23.1409">   nsresult rv = NS_OK;</span>
<a href="#l23.1410"></a><span id="l23.1410"> </span>
<a href="#l23.1411"></a><span id="l23.1411">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.1412"></a><span id="l23.1412">   server = do_QueryInterface(nntpServer);</span>
<a href="#l23.1413"></a><span id="l23.1413"> </span>
<a href="#l23.1414"></a><span id="l23.1414">   /* double check that it is a &quot;news:/&quot; url */</span>
<a href="#l23.1415"></a><span id="l23.1415" class="difflineminus">-  if (strncmp(uri, kNewsRootURI, kNewsRootURILen) == 0)</span>
<a href="#l23.1416"></a><span id="l23.1416" class="difflineminus">-  {</span>
<a href="#l23.1417"></a><span id="l23.1417" class="difflineplus">+  if (strncmp(uri, kNewsRootURI, kNewsRootURILen) == 0) {</span>
<a href="#l23.1418"></a><span id="l23.1418">     nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.1419"></a><span id="l23.1419" class="difflineminus">-    rv = ConstructNntpUrl(uri, aUrlListener, aMsgWindow, nullptr, nsINntpUrl::ActionGetNewNews, getter_AddRefs(url));</span>
<a href="#l23.1420"></a><span id="l23.1420" class="difflineplus">+    rv = ConstructNntpUrl(uri, aUrlListener, aMsgWindow, nullptr,</span>
<a href="#l23.1421"></a><span id="l23.1421" class="difflineplus">+                          nsINntpUrl::ActionGetNewNews, getter_AddRefs(url));</span>
<a href="#l23.1422"></a><span id="l23.1422">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1423"></a><span id="l23.1423"> </span>
<a href="#l23.1424"></a><span id="l23.1424">     nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl = do_QueryInterface(url);</span>
<a href="#l23.1425"></a><span id="l23.1425" class="difflineminus">-    if (nntpUrl)</span>
<a href="#l23.1426"></a><span id="l23.1426" class="difflineminus">-    {</span>
<a href="#l23.1427"></a><span id="l23.1427" class="difflineplus">+    if (nntpUrl) {</span>
<a href="#l23.1428"></a><span id="l23.1428">       rv = nntpUrl-&gt;SetGetOldMessages(aGetOld);</span>
<a href="#l23.1429"></a><span id="l23.1429">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1430"></a><span id="l23.1430">     }</span>
<a href="#l23.1431"></a><span id="l23.1431"> </span>
<a href="#l23.1432"></a><span id="l23.1432">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(url);</span>
<a href="#l23.1433"></a><span id="l23.1433" class="difflineminus">-    if (mailNewsUrl)</span>
<a href="#l23.1434"></a><span id="l23.1434" class="difflineminus">-      mailNewsUrl-&gt;SetUpdatingFolder(true);</span>
<a href="#l23.1435"></a><span id="l23.1435" class="difflineplus">+    if (mailNewsUrl) mailNewsUrl-&gt;SetUpdatingFolder(true);</span>
<a href="#l23.1436"></a><span id="l23.1436"> </span>
<a href="#l23.1437"></a><span id="l23.1437">     rv = RunNewsUrl(url, aMsgWindow, nullptr);</span>
<a href="#l23.1438"></a><span id="l23.1438"> </span>
<a href="#l23.1439"></a><span id="l23.1439" class="difflineminus">-    if (_retval)</span>
<a href="#l23.1440"></a><span id="l23.1440" class="difflineminus">-      url.forget(_retval);</span>
<a href="#l23.1441"></a><span id="l23.1441" class="difflineminus">-  }</span>
<a href="#l23.1442"></a><span id="l23.1442" class="difflineminus">-  else</span>
<a href="#l23.1443"></a><span id="l23.1443" class="difflineminus">-  {</span>
<a href="#l23.1444"></a><span id="l23.1444" class="difflineplus">+    if (_retval) url.forget(_retval);</span>
<a href="#l23.1445"></a><span id="l23.1445" class="difflineplus">+  } else {</span>
<a href="#l23.1446"></a><span id="l23.1446">     NS_ERROR(&quot;not a news:/ url&quot;);</span>
<a href="#l23.1447"></a><span id="l23.1447">     rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1448"></a><span id="l23.1448">   }</span>
<a href="#l23.1449"></a><span id="l23.1449"> </span>
<a href="#l23.1450"></a><span id="l23.1450">   return rv;</span>
<a href="#l23.1451"></a><span id="l23.1451"> }</span>
<a href="#l23.1452"></a><span id="l23.1452"> </span>
<a href="#l23.1453"></a><span id="l23.1453"> NS_IMETHODIMP</span>
<a href="#l23.1454"></a><span id="l23.1454" class="difflineminus">-nsNntpService::CancelMessage(const char *cancelURL, const char *messageURI, nsISupports * aConsumer, nsIUrlListener * aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI ** aURL)</span>
<a href="#l23.1455"></a><span id="l23.1455" class="difflineminus">-{</span>
<a href="#l23.1456"></a><span id="l23.1456" class="difflineplus">+nsNntpService::CancelMessage(const char *cancelURL, const char *messageURI,</span>
<a href="#l23.1457"></a><span id="l23.1457" class="difflineplus">+                             nsISupports *aConsumer,</span>
<a href="#l23.1458"></a><span id="l23.1458" class="difflineplus">+                             nsIUrlListener *aUrlListener,</span>
<a href="#l23.1459"></a><span id="l23.1459" class="difflineplus">+                             nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l23.1460"></a><span id="l23.1460">   nsresult rv;</span>
<a href="#l23.1461"></a><span id="l23.1461">   NS_ENSURE_ARG_POINTER(cancelURL);</span>
<a href="#l23.1462"></a><span id="l23.1462">   NS_ENSURE_ARG_POINTER(messageURI);</span>
<a href="#l23.1463"></a><span id="l23.1463"> </span>
<a href="#l23.1464"></a><span id="l23.1464">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.1465"></a><span id="l23.1465">   // the url should be &quot;news://host/message-id?cancel&quot;</span>
<a href="#l23.1466"></a><span id="l23.1466" class="difflineminus">-  rv = ConstructNntpUrl(cancelURL, aUrlListener,  aMsgWindow, messageURI, nsINntpUrl::ActionCancelArticle, getter_AddRefs(url));</span>
<a href="#l23.1467"></a><span id="l23.1467" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1468"></a><span id="l23.1468" class="difflineplus">+  rv = ConstructNntpUrl(cancelURL, aUrlListener, aMsgWindow, messageURI,</span>
<a href="#l23.1469"></a><span id="l23.1469" class="difflineplus">+                        nsINntpUrl::ActionCancelArticle, getter_AddRefs(url));</span>
<a href="#l23.1470"></a><span id="l23.1470" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1471"></a><span id="l23.1471"> </span>
<a href="#l23.1472"></a><span id="l23.1472">   rv = RunNewsUrl(url, aMsgWindow, aConsumer);</span>
<a href="#l23.1473"></a><span id="l23.1473" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1474"></a><span id="l23.1474" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1475"></a><span id="l23.1475"> </span>
<a href="#l23.1476"></a><span id="l23.1476" class="difflineminus">-  if (aURL)</span>
<a href="#l23.1477"></a><span id="l23.1477" class="difflineminus">-    url.forget(aURL);</span>
<a href="#l23.1478"></a><span id="l23.1478" class="difflineplus">+  if (aURL) url.forget(aURL);</span>
<a href="#l23.1479"></a><span id="l23.1479"> </span>
<a href="#l23.1480"></a><span id="l23.1480">   return rv;</span>
<a href="#l23.1481"></a><span id="l23.1481"> }</span>
<a href="#l23.1482"></a><span id="l23.1482"> </span>
<a href="#l23.1483"></a><span id="l23.1483" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l23.1484"></a><span id="l23.1484" class="difflineminus">-{</span>
<a href="#l23.1485"></a><span id="l23.1485" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l23.1486"></a><span id="l23.1486">   aScheme = &quot;news&quot;;</span>
<a href="#l23.1487"></a><span id="l23.1487">   return NS_OK;</span>
<a href="#l23.1488"></a><span id="l23.1488"> }</span>
<a href="#l23.1489"></a><span id="l23.1489"> </span>
<a href="#l23.1490"></a><span id="l23.1490" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetDefaultDoBiff(bool *aDoBiff)</span>
<a href="#l23.1491"></a><span id="l23.1491" class="difflineminus">-{</span>
<a href="#l23.1492"></a><span id="l23.1492" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l23.1493"></a><span id="l23.1493" class="difflineminus">-    // by default, don't do biff for NNTP servers</span>
<a href="#l23.1494"></a><span id="l23.1494" class="difflineminus">-    *aDoBiff = false;</span>
<a href="#l23.1495"></a><span id="l23.1495" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1496"></a><span id="l23.1496" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetDefaultDoBiff(bool *aDoBiff) {</span>
<a href="#l23.1497"></a><span id="l23.1497" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l23.1498"></a><span id="l23.1498" class="difflineplus">+  // by default, don't do biff for NNTP servers</span>
<a href="#l23.1499"></a><span id="l23.1499" class="difflineplus">+  *aDoBiff = false;</span>
<a href="#l23.1500"></a><span id="l23.1500" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1501"></a><span id="l23.1501"> }</span>
<a href="#l23.1502"></a><span id="l23.1502"> </span>
<a href="#l23.1503"></a><span id="l23.1503" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l23.1504"></a><span id="l23.1504" class="difflineminus">-{</span>
<a href="#l23.1505"></a><span id="l23.1505" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l23.1506"></a><span id="l23.1506" class="difflineminus">-    *aDefaultPort = nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l23.1507"></a><span id="l23.1507" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1508"></a><span id="l23.1508" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l23.1509"></a><span id="l23.1509" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l23.1510"></a><span id="l23.1510" class="difflineplus">+  *aDefaultPort = nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l23.1511"></a><span id="l23.1511" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1512"></a><span id="l23.1512"> }</span>
<a href="#l23.1513"></a><span id="l23.1513"> </span>
<a href="#l23.1514"></a><span id="l23.1514" class="difflineminus">-NS_IMETHODIMP nsNntpService::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l23.1515"></a><span id="l23.1515" class="difflineminus">-{</span>
<a href="#l23.1516"></a><span id="l23.1516" class="difflineminus">-    *_retval = true; // allow news on any port</span>
<a href="#l23.1517"></a><span id="l23.1517" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1518"></a><span id="l23.1518" class="difflineplus">+NS_IMETHODIMP nsNntpService::AllowPort(int32_t port, const char *scheme,</span>
<a href="#l23.1519"></a><span id="l23.1519" class="difflineplus">+                                       bool *_retval) {</span>
<a href="#l23.1520"></a><span id="l23.1520" class="difflineplus">+  *_retval = true;  // allow news on any port</span>
<a href="#l23.1521"></a><span id="l23.1521" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1522"></a><span id="l23.1522"> }</span>
<a href="#l23.1523"></a><span id="l23.1523"> </span>
<a href="#l23.1524"></a><span id="l23.1524"> NS_IMETHODIMP</span>
<a href="#l23.1525"></a><span id="l23.1525" class="difflineminus">-nsNntpService::GetDefaultServerPort(bool aUseSSL, int32_t *aDefaultPort)</span>
<a href="#l23.1526"></a><span id="l23.1526" class="difflineminus">-{</span>
<a href="#l23.1527"></a><span id="l23.1527" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l23.1528"></a><span id="l23.1528" class="difflineplus">+nsNntpService::GetDefaultServerPort(bool aUseSSL, int32_t *aDefaultPort) {</span>
<a href="#l23.1529"></a><span id="l23.1529" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l23.1530"></a><span id="l23.1530"> </span>
<a href="#l23.1531"></a><span id="l23.1531" class="difflineminus">-    // Return Secure NNTP Port if secure option chosen i.e., if useSSL is TRUE.</span>
<a href="#l23.1532"></a><span id="l23.1532" class="difflineminus">-    if (aUseSSL)</span>
<a href="#l23.1533"></a><span id="l23.1533" class="difflineminus">-        *aDefaultPort = nsINntpUrl::DEFAULT_NNTPS_PORT;</span>
<a href="#l23.1534"></a><span id="l23.1534" class="difflineminus">-    else</span>
<a href="#l23.1535"></a><span id="l23.1535" class="difflineminus">-        rv = GetDefaultPort(aDefaultPort);</span>
<a href="#l23.1536"></a><span id="l23.1536" class="difflineplus">+  // Return Secure NNTP Port if secure option chosen i.e., if useSSL is TRUE.</span>
<a href="#l23.1537"></a><span id="l23.1537" class="difflineplus">+  if (aUseSSL)</span>
<a href="#l23.1538"></a><span id="l23.1538" class="difflineplus">+    *aDefaultPort = nsINntpUrl::DEFAULT_NNTPS_PORT;</span>
<a href="#l23.1539"></a><span id="l23.1539" class="difflineplus">+  else</span>
<a href="#l23.1540"></a><span id="l23.1540" class="difflineplus">+    rv = GetDefaultPort(aDefaultPort);</span>
<a href="#l23.1541"></a><span id="l23.1541"> </span>
<a href="#l23.1542"></a><span id="l23.1542" class="difflineminus">-    return rv;</span>
<a href="#l23.1543"></a><span id="l23.1543" class="difflineplus">+  return rv;</span>
<a href="#l23.1544"></a><span id="l23.1544"> }</span>
<a href="#l23.1545"></a><span id="l23.1545"> </span>
<a href="#l23.1546"></a><span id="l23.1546" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetProtocolFlags(uint32_t *aUritype)</span>
<a href="#l23.1547"></a><span id="l23.1547" class="difflineminus">-{</span>
<a href="#l23.1548"></a><span id="l23.1548" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aUritype);</span>
<a href="#l23.1549"></a><span id="l23.1549" class="difflineminus">-    *aUritype = URI_NORELATIVE | URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT |</span>
<a href="#l23.1550"></a><span id="l23.1550" class="difflineminus">-      URI_LOADABLE_BY_ANYONE | ALLOWS_PROXY</span>
<a href="#l23.1551"></a><span id="l23.1551" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetProtocolFlags(uint32_t *aUritype) {</span>
<a href="#l23.1552"></a><span id="l23.1552" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aUritype);</span>
<a href="#l23.1553"></a><span id="l23.1553" class="difflineplus">+  *aUritype = URI_NORELATIVE | URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT |</span>
<a href="#l23.1554"></a><span id="l23.1554" class="difflineplus">+              URI_LOADABLE_BY_ANYONE | ALLOWS_PROXY</span>
<a href="#l23.1555"></a><span id="l23.1555"> #ifdef IS_ORIGIN_IS_FULL_SPEC_DEFINED</span>
<a href="#l23.1556"></a><span id="l23.1556" class="difflineminus">-      | ORIGIN_IS_FULL_SPEC</span>
<a href="#l23.1557"></a><span id="l23.1557" class="difflineplus">+              | ORIGIN_IS_FULL_SPEC</span>
<a href="#l23.1558"></a><span id="l23.1558"> #endif</span>
<a href="#l23.1559"></a><span id="l23.1559" class="difflineminus">-    ;</span>
<a href="#l23.1560"></a><span id="l23.1560" class="difflineplus">+      ;</span>
<a href="#l23.1561"></a><span id="l23.1561"> </span>
<a href="#l23.1562"></a><span id="l23.1562" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1563"></a><span id="l23.1563" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1564"></a><span id="l23.1564"> }</span>
<a href="#l23.1565"></a><span id="l23.1565"> </span>
<a href="#l23.1566"></a><span id="l23.1566"> NS_IMETHODIMP nsNntpService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l23.1567"></a><span id="l23.1567" class="difflineminus">-                                    const char *aCharset, // ignored</span>
<a href="#l23.1568"></a><span id="l23.1568" class="difflineminus">-                                    nsIURI *aBaseURI,</span>
<a href="#l23.1569"></a><span id="l23.1569" class="difflineminus">-                                    nsIURI **_retval)</span>
<a href="#l23.1570"></a><span id="l23.1570" class="difflineminus">-{</span>
<a href="#l23.1571"></a><span id="l23.1571" class="difflineminus">-    nsresult rv;</span>
<a href="#l23.1572"></a><span id="l23.1572" class="difflineplus">+                                    const char *aCharset,  // ignored</span>
<a href="#l23.1573"></a><span id="l23.1573" class="difflineplus">+                                    nsIURI *aBaseURI, nsIURI **_retval) {</span>
<a href="#l23.1574"></a><span id="l23.1574" class="difflineplus">+  nsresult rv;</span>
<a href="#l23.1575"></a><span id="l23.1575"> </span>
<a href="#l23.1576"></a><span id="l23.1576" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; nntpUri = do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l23.1577"></a><span id="l23.1577" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1578"></a><span id="l23.1578" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; nntpUri =</span>
<a href="#l23.1579"></a><span id="l23.1579" class="difflineplus">+      do_CreateInstance(NS_NNTPURL_CONTRACTID, &amp;rv);</span>
<a href="#l23.1580"></a><span id="l23.1580" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1581"></a><span id="l23.1581"> </span>
<a href="#l23.1582"></a><span id="l23.1582" class="difflineminus">-    if (aBaseURI)</span>
<a href="#l23.1583"></a><span id="l23.1583" class="difflineminus">-    {</span>
<a href="#l23.1584"></a><span id="l23.1584" class="difflineminus">-      nsAutoCString newSpec;</span>
<a href="#l23.1585"></a><span id="l23.1585" class="difflineminus">-      aBaseURI-&gt;Resolve(aSpec, newSpec);</span>
<a href="#l23.1586"></a><span id="l23.1586" class="difflineminus">-      rv = nntpUri-&gt;SetSpecInternal(newSpec);</span>
<a href="#l23.1587"></a><span id="l23.1587" class="difflineminus">-      // XXX Consider: rv = NS_MutateURI(new nsNntpUrl::Mutator()).SetSpec(newSpec).Finalize(nntpUri);</span>
<a href="#l23.1588"></a><span id="l23.1588" class="difflineminus">-    }</span>
<a href="#l23.1589"></a><span id="l23.1589" class="difflineminus">-    else</span>
<a href="#l23.1590"></a><span id="l23.1590" class="difflineminus">-    {</span>
<a href="#l23.1591"></a><span id="l23.1591" class="difflineminus">-      rv = nntpUri-&gt;SetSpecInternal(aSpec);</span>
<a href="#l23.1592"></a><span id="l23.1592" class="difflineminus">-    }</span>
<a href="#l23.1593"></a><span id="l23.1593" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.1594"></a><span id="l23.1594" class="difflineplus">+  if (aBaseURI) {</span>
<a href="#l23.1595"></a><span id="l23.1595" class="difflineplus">+    nsAutoCString newSpec;</span>
<a href="#l23.1596"></a><span id="l23.1596" class="difflineplus">+    aBaseURI-&gt;Resolve(aSpec, newSpec);</span>
<a href="#l23.1597"></a><span id="l23.1597" class="difflineplus">+    rv = nntpUri-&gt;SetSpecInternal(newSpec);</span>
<a href="#l23.1598"></a><span id="l23.1598" class="difflineplus">+    // XXX Consider: rv = NS_MutateURI(new</span>
<a href="#l23.1599"></a><span id="l23.1599" class="difflineplus">+    // nsNntpUrl::Mutator()).SetSpec(newSpec).Finalize(nntpUri);</span>
<a href="#l23.1600"></a><span id="l23.1600" class="difflineplus">+  } else {</span>
<a href="#l23.1601"></a><span id="l23.1601" class="difflineplus">+    rv = nntpUri-&gt;SetSpecInternal(aSpec);</span>
<a href="#l23.1602"></a><span id="l23.1602" class="difflineplus">+  }</span>
<a href="#l23.1603"></a><span id="l23.1603" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1604"></a><span id="l23.1604"> </span>
<a href="#l23.1605"></a><span id="l23.1605" class="difflineminus">-    nntpUri.forget(_retval);</span>
<a href="#l23.1606"></a><span id="l23.1606" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1607"></a><span id="l23.1607" class="difflineplus">+  nntpUri.forget(_retval);</span>
<a href="#l23.1608"></a><span id="l23.1608" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1609"></a><span id="l23.1609"> }</span>
<a href="#l23.1610"></a><span id="l23.1610"> </span>
<a href="#l23.1611"></a><span id="l23.1611" class="difflineminus">-NS_IMETHODIMP nsNntpService::NewChannel(nsIURI *aURI,</span>
<a href="#l23.1612"></a><span id="l23.1612" class="difflineminus">-                                        nsILoadInfo *aLoadInfo,</span>
<a href="#l23.1613"></a><span id="l23.1613" class="difflineminus">-                                        nsIChannel **_retval)</span>
<a href="#l23.1614"></a><span id="l23.1614" class="difflineminus">-{</span>
<a href="#l23.1615"></a><span id="l23.1615" class="difflineplus">+NS_IMETHODIMP nsNntpService::NewChannel(nsIURI *aURI, nsILoadInfo *aLoadInfo,</span>
<a href="#l23.1616"></a><span id="l23.1616" class="difflineplus">+                                        nsIChannel **_retval) {</span>
<a href="#l23.1617"></a><span id="l23.1617">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l23.1618"></a><span id="l23.1618">   nsresult rv = NS_OK;</span>
<a href="#l23.1619"></a><span id="l23.1619">   nsCOMPtr&lt;nsINntpIncomingServer&gt; server;</span>
<a href="#l23.1620"></a><span id="l23.1620">   rv = GetServerForUri(aURI, getter_AddRefs(server));</span>
<a href="#l23.1621"></a><span id="l23.1621">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1622"></a><span id="l23.1622"> </span>
<a href="#l23.1623"></a><span id="l23.1623">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l23.1624"></a><span id="l23.1624">   rv = server-&gt;GetNntpChannel(aURI, nullptr, getter_AddRefs(channel));</span>
<a href="#l23.1625"></a><span id="l23.1625" class="difflineat">@@ -1249,273 +1190,252 @@ NS_IMETHODIMP nsNntpService::NewChannel(</span>
<a href="#l23.1626"></a><span id="l23.1626">   rv = channel-&gt;SetLoadInfo(aLoadInfo);</span>
<a href="#l23.1627"></a><span id="l23.1627">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1628"></a><span id="l23.1628"> </span>
<a href="#l23.1629"></a><span id="l23.1629">   channel.forget(_retval);</span>
<a href="#l23.1630"></a><span id="l23.1630">   return NS_OK;</span>
<a href="#l23.1631"></a><span id="l23.1631"> }</span>
<a href="#l23.1632"></a><span id="l23.1632"> </span>
<a href="#l23.1633"></a><span id="l23.1633"> NS_IMETHODIMP</span>
<a href="#l23.1634"></a><span id="l23.1634" class="difflineminus">-nsNntpService::SetDefaultLocalPath(nsIFile *aPath)</span>
<a href="#l23.1635"></a><span id="l23.1635" class="difflineminus">-{</span>
<a href="#l23.1636"></a><span id="l23.1636" class="difflineminus">-    NS_ENSURE_ARG(aPath);</span>
<a href="#l23.1637"></a><span id="l23.1637" class="difflineminus">-    return NS_SetPersistentFile(PREF_MAIL_ROOT_NNTP_REL, PREF_MAIL_ROOT_NNTP, aPath);</span>
<a href="#l23.1638"></a><span id="l23.1638" class="difflineplus">+nsNntpService::SetDefaultLocalPath(nsIFile *aPath) {</span>
<a href="#l23.1639"></a><span id="l23.1639" class="difflineplus">+  NS_ENSURE_ARG(aPath);</span>
<a href="#l23.1640"></a><span id="l23.1640" class="difflineplus">+  return NS_SetPersistentFile(PREF_MAIL_ROOT_NNTP_REL, PREF_MAIL_ROOT_NNTP,</span>
<a href="#l23.1641"></a><span id="l23.1641" class="difflineplus">+                              aPath);</span>
<a href="#l23.1642"></a><span id="l23.1642"> }</span>
<a href="#l23.1643"></a><span id="l23.1643"> </span>
<a href="#l23.1644"></a><span id="l23.1644"> NS_IMETHODIMP</span>
<a href="#l23.1645"></a><span id="l23.1645" class="difflineminus">-nsNntpService::GetDefaultLocalPath(nsIFile ** aResult)</span>
<a href="#l23.1646"></a><span id="l23.1646" class="difflineminus">-{</span>
<a href="#l23.1647"></a><span id="l23.1647" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.1648"></a><span id="l23.1648" class="difflineminus">-    *aResult = nullptr;</span>
<a href="#l23.1649"></a><span id="l23.1649" class="difflineplus">+nsNntpService::GetDefaultLocalPath(nsIFile **aResult) {</span>
<a href="#l23.1650"></a><span id="l23.1650" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.1651"></a><span id="l23.1651" class="difflineplus">+  *aResult = nullptr;</span>
<a href="#l23.1652"></a><span id="l23.1652"> </span>
<a href="#l23.1653"></a><span id="l23.1653" class="difflineminus">-    bool havePref;</span>
<a href="#l23.1654"></a><span id="l23.1654" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l23.1655"></a><span id="l23.1655" class="difflineminus">-    nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_NNTP_REL,</span>
<a href="#l23.1656"></a><span id="l23.1656" class="difflineminus">-                              PREF_MAIL_ROOT_NNTP,</span>
<a href="#l23.1657"></a><span id="l23.1657" class="difflineminus">-                              NS_APP_NEWS_50_DIR,</span>
<a href="#l23.1658"></a><span id="l23.1658" class="difflineminus">-                              havePref,</span>
<a href="#l23.1659"></a><span id="l23.1659" class="difflineminus">-                              getter_AddRefs(localFile));</span>
<a href="#l23.1660"></a><span id="l23.1660" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1661"></a><span id="l23.1661" class="difflineplus">+  bool havePref;</span>
<a href="#l23.1662"></a><span id="l23.1662" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l23.1663"></a><span id="l23.1663" class="difflineplus">+  nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_NNTP_REL,</span>
<a href="#l23.1664"></a><span id="l23.1664" class="difflineplus">+                                     PREF_MAIL_ROOT_NNTP, NS_APP_NEWS_50_DIR,</span>
<a href="#l23.1665"></a><span id="l23.1665" class="difflineplus">+                                     havePref, getter_AddRefs(localFile));</span>
<a href="#l23.1666"></a><span id="l23.1666" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1667"></a><span id="l23.1667"> </span>
<a href="#l23.1668"></a><span id="l23.1668" class="difflineminus">-    bool exists;</span>
<a href="#l23.1669"></a><span id="l23.1669" class="difflineminus">-    rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l23.1670"></a><span id="l23.1670" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l23.1671"></a><span id="l23.1671" class="difflineminus">-        rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l23.1672"></a><span id="l23.1672" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1673"></a><span id="l23.1673" class="difflineplus">+  bool exists;</span>
<a href="#l23.1674"></a><span id="l23.1674" class="difflineplus">+  rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l23.1675"></a><span id="l23.1675" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l23.1676"></a><span id="l23.1676" class="difflineplus">+    rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l23.1677"></a><span id="l23.1677" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1678"></a><span id="l23.1678"> </span>
<a href="#l23.1679"></a><span id="l23.1679" class="difflineminus">-    if (!havePref || !exists)</span>
<a href="#l23.1680"></a><span id="l23.1680" class="difflineminus">-    {</span>
<a href="#l23.1681"></a><span id="l23.1681" class="difflineminus">-        rv = NS_SetPersistentFile(PREF_MAIL_ROOT_NNTP_REL, PREF_MAIL_ROOT_NNTP, localFile);</span>
<a href="#l23.1682"></a><span id="l23.1682" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l23.1683"></a><span id="l23.1683" class="difflineminus">-    }</span>
<a href="#l23.1684"></a><span id="l23.1684" class="difflineplus">+  if (!havePref || !exists) {</span>
<a href="#l23.1685"></a><span id="l23.1685" class="difflineplus">+    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_NNTP_REL, PREF_MAIL_ROOT_NNTP,</span>
<a href="#l23.1686"></a><span id="l23.1686" class="difflineplus">+                              localFile);</span>
<a href="#l23.1687"></a><span id="l23.1687" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l23.1688"></a><span id="l23.1688" class="difflineplus">+  }</span>
<a href="#l23.1689"></a><span id="l23.1689"> </span>
<a href="#l23.1690"></a><span id="l23.1690" class="difflineminus">-    localFile.forget(aResult);</span>
<a href="#l23.1691"></a><span id="l23.1691" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1692"></a><span id="l23.1692" class="difflineplus">+  localFile.forget(aResult);</span>
<a href="#l23.1693"></a><span id="l23.1693" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1694"></a><span id="l23.1694"> }</span>
<a href="#l23.1695"></a><span id="l23.1695"> </span>
<a href="#l23.1696"></a><span id="l23.1696"> NS_IMETHODIMP</span>
<a href="#l23.1697"></a><span id="l23.1697" class="difflineminus">-nsNntpService::GetServerIID(nsIID* *aServerIID)</span>
<a href="#l23.1698"></a><span id="l23.1698" class="difflineminus">-{</span>
<a href="#l23.1699"></a><span id="l23.1699" class="difflineminus">-    *aServerIID = new nsIID(NS_GET_IID(nsINntpIncomingServer));</span>
<a href="#l23.1700"></a><span id="l23.1700" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1701"></a><span id="l23.1701" class="difflineplus">+nsNntpService::GetServerIID(nsIID **aServerIID) {</span>
<a href="#l23.1702"></a><span id="l23.1702" class="difflineplus">+  *aServerIID = new nsIID(NS_GET_IID(nsINntpIncomingServer));</span>
<a href="#l23.1703"></a><span id="l23.1703" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1704"></a><span id="l23.1704"> }</span>
<a href="#l23.1705"></a><span id="l23.1705"> </span>
<a href="#l23.1706"></a><span id="l23.1706"> NS_IMETHODIMP</span>
<a href="#l23.1707"></a><span id="l23.1707" class="difflineminus">-nsNntpService::GetRequiresUsername(bool *aRequiresUsername)</span>
<a href="#l23.1708"></a><span id="l23.1708" class="difflineminus">-{</span>
<a href="#l23.1709"></a><span id="l23.1709" class="difflineplus">+nsNntpService::GetRequiresUsername(bool *aRequiresUsername) {</span>
<a href="#l23.1710"></a><span id="l23.1710">   NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l23.1711"></a><span id="l23.1711">   *aRequiresUsername = false;</span>
<a href="#l23.1712"></a><span id="l23.1712">   return NS_OK;</span>
<a href="#l23.1713"></a><span id="l23.1713"> }</span>
<a href="#l23.1714"></a><span id="l23.1714"> </span>
<a href="#l23.1715"></a><span id="l23.1715"> NS_IMETHODIMP</span>
<a href="#l23.1716"></a><span id="l23.1716" class="difflineminus">-nsNntpService::GetPreflightPrettyNameWithEmailAddress(bool *aPreflightPrettyNameWithEmailAddress)</span>
<a href="#l23.1717"></a><span id="l23.1717" class="difflineminus">-{</span>
<a href="#l23.1718"></a><span id="l23.1718" class="difflineplus">+nsNntpService::GetPreflightPrettyNameWithEmailAddress(</span>
<a href="#l23.1719"></a><span id="l23.1719" class="difflineplus">+    bool *aPreflightPrettyNameWithEmailAddress) {</span>
<a href="#l23.1720"></a><span id="l23.1720">   NS_ENSURE_ARG_POINTER(aPreflightPrettyNameWithEmailAddress);</span>
<a href="#l23.1721"></a><span id="l23.1721">   *aPreflightPrettyNameWithEmailAddress = false;</span>
<a href="#l23.1722"></a><span id="l23.1722">   return NS_OK;</span>
<a href="#l23.1723"></a><span id="l23.1723"> }</span>
<a href="#l23.1724"></a><span id="l23.1724"> </span>
<a href="#l23.1725"></a><span id="l23.1725"> NS_IMETHODIMP</span>
<a href="#l23.1726"></a><span id="l23.1726" class="difflineminus">-nsNntpService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp)</span>
<a href="#l23.1727"></a><span id="l23.1727" class="difflineminus">-{</span>
<a href="#l23.1728"></a><span id="l23.1728" class="difflineplus">+nsNntpService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp) {</span>
<a href="#l23.1729"></a><span id="l23.1729">   NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l23.1730"></a><span id="l23.1730">   *aCanLoginAtStartUp = true;</span>
<a href="#l23.1731"></a><span id="l23.1731">   return NS_OK;</span>
<a href="#l23.1732"></a><span id="l23.1732"> }</span>
<a href="#l23.1733"></a><span id="l23.1733"> </span>
<a href="#l23.1734"></a><span id="l23.1734"> NS_IMETHODIMP</span>
<a href="#l23.1735"></a><span id="l23.1735" class="difflineminus">-nsNntpService::GetCanDelete(bool *aCanDelete)</span>
<a href="#l23.1736"></a><span id="l23.1736" class="difflineminus">-{</span>
<a href="#l23.1737"></a><span id="l23.1737" class="difflineplus">+nsNntpService::GetCanDelete(bool *aCanDelete) {</span>
<a href="#l23.1738"></a><span id="l23.1738">   NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l23.1739"></a><span id="l23.1739">   *aCanDelete = true;</span>
<a href="#l23.1740"></a><span id="l23.1740">   return NS_OK;</span>
<a href="#l23.1741"></a><span id="l23.1741"> }</span>
<a href="#l23.1742"></a><span id="l23.1742"> </span>
<a href="#l23.1743"></a><span id="l23.1743"> NS_IMETHODIMP</span>
<a href="#l23.1744"></a><span id="l23.1744" class="difflineminus">-nsNntpService::GetCanDuplicate(bool *aCanDuplicate)</span>
<a href="#l23.1745"></a><span id="l23.1745" class="difflineminus">-{</span>
<a href="#l23.1746"></a><span id="l23.1746" class="difflineplus">+nsNntpService::GetCanDuplicate(bool *aCanDuplicate) {</span>
<a href="#l23.1747"></a><span id="l23.1747">   NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l23.1748"></a><span id="l23.1748">   *aCanDuplicate = true;</span>
<a href="#l23.1749"></a><span id="l23.1749">   return NS_OK;</span>
<a href="#l23.1750"></a><span id="l23.1750"> }</span>
<a href="#l23.1751"></a><span id="l23.1751"> </span>
<a href="#l23.1752"></a><span id="l23.1752"> NS_IMETHODIMP</span>
<a href="#l23.1753"></a><span id="l23.1753" class="difflineminus">-nsNntpService::GetCanGetMessages(bool *aCanGetMessages)</span>
<a href="#l23.1754"></a><span id="l23.1754" class="difflineminus">-{</span>
<a href="#l23.1755"></a><span id="l23.1755" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l23.1756"></a><span id="l23.1756" class="difflineminus">-    *aCanGetMessages = false;  // poorly named, this just means we don't have an inbox.</span>
<a href="#l23.1757"></a><span id="l23.1757" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1758"></a><span id="l23.1758" class="difflineplus">+nsNntpService::GetCanGetMessages(bool *aCanGetMessages) {</span>
<a href="#l23.1759"></a><span id="l23.1759" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l23.1760"></a><span id="l23.1760" class="difflineplus">+  *aCanGetMessages =</span>
<a href="#l23.1761"></a><span id="l23.1761" class="difflineplus">+      false;  // poorly named, this just means we don't have an inbox.</span>
<a href="#l23.1762"></a><span id="l23.1762" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1763"></a><span id="l23.1763"> }</span>
<a href="#l23.1764"></a><span id="l23.1764"> </span>
<a href="#l23.1765"></a><span id="l23.1765"> NS_IMETHODIMP</span>
<a href="#l23.1766"></a><span id="l23.1766" class="difflineminus">-nsNntpService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages)</span>
<a href="#l23.1767"></a><span id="l23.1767" class="difflineminus">-{</span>
<a href="#l23.1768"></a><span id="l23.1768" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l23.1769"></a><span id="l23.1769" class="difflineminus">-    // temporarily returns false because we don't yet support spam</span>
<a href="#l23.1770"></a><span id="l23.1770" class="difflineminus">-    // filtering in news.  this will change.</span>
<a href="#l23.1771"></a><span id="l23.1771" class="difflineminus">-    *aCanGetIncomingMessages = false;</span>
<a href="#l23.1772"></a><span id="l23.1772" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1773"></a><span id="l23.1773" class="difflineplus">+nsNntpService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages) {</span>
<a href="#l23.1774"></a><span id="l23.1774" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l23.1775"></a><span id="l23.1775" class="difflineplus">+  // temporarily returns false because we don't yet support spam</span>
<a href="#l23.1776"></a><span id="l23.1776" class="difflineplus">+  // filtering in news.  this will change.</span>
<a href="#l23.1777"></a><span id="l23.1777" class="difflineplus">+  *aCanGetIncomingMessages = false;</span>
<a href="#l23.1778"></a><span id="l23.1778" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1779"></a><span id="l23.1779"> }</span>
<a href="#l23.1780"></a><span id="l23.1780"> </span>
<a href="#l23.1781"></a><span id="l23.1781"> NS_IMETHODIMP</span>
<a href="#l23.1782"></a><span id="l23.1782" class="difflineminus">-nsNntpService::GetShowComposeMsgLink(bool *showComposeMsgLink)</span>
<a href="#l23.1783"></a><span id="l23.1783" class="difflineminus">-{</span>
<a href="#l23.1784"></a><span id="l23.1784" class="difflineminus">-    NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l23.1785"></a><span id="l23.1785" class="difflineminus">-    *showComposeMsgLink = false;</span>
<a href="#l23.1786"></a><span id="l23.1786" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.1787"></a><span id="l23.1787" class="difflineplus">+nsNntpService::GetShowComposeMsgLink(bool *showComposeMsgLink) {</span>
<a href="#l23.1788"></a><span id="l23.1788" class="difflineplus">+  NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l23.1789"></a><span id="l23.1789" class="difflineplus">+  *showComposeMsgLink = false;</span>
<a href="#l23.1790"></a><span id="l23.1790" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.1791"></a><span id="l23.1791"> }</span>
<a href="#l23.1792"></a><span id="l23.1792"> </span>
<a href="#l23.1793"></a><span id="l23.1793"> NS_IMETHODIMP</span>
<a href="#l23.1794"></a><span id="l23.1794" class="difflineminus">-nsNntpService::GetFoldersCreatedAsync(bool *aAsyncCreation)</span>
<a href="#l23.1795"></a><span id="l23.1795" class="difflineminus">-{</span>
<a href="#l23.1796"></a><span id="l23.1796" class="difflineplus">+nsNntpService::GetFoldersCreatedAsync(bool *aAsyncCreation) {</span>
<a href="#l23.1797"></a><span id="l23.1797">   NS_ENSURE_ARG_POINTER(aAsyncCreation);</span>
<a href="#l23.1798"></a><span id="l23.1798">   *aAsyncCreation = false;</span>
<a href="#l23.1799"></a><span id="l23.1799">   return NS_OK;</span>
<a href="#l23.1800"></a><span id="l23.1800"> }</span>
<a href="#l23.1801"></a><span id="l23.1801"> </span>
<a href="#l23.1802"></a><span id="l23.1802"> //</span>
<a href="#l23.1803"></a><span id="l23.1803"> // rhp: Right now, this is the same as simple DisplayMessage, but it will change</span>
<a href="#l23.1804"></a><span id="l23.1804"> // to support print rendering.</span>
<a href="#l23.1805"></a><span id="l23.1805"> //</span>
<a href="#l23.1806"></a><span id="l23.1806" class="difflineminus">-NS_IMETHODIMP nsNntpService::DisplayMessageForPrinting(const char* aMessageURI, nsISupports * aDisplayConsumer,</span>
<a href="#l23.1807"></a><span id="l23.1807" class="difflineminus">-                                                  nsIMsgWindow *aMsgWindow, nsIUrlListener * aUrlListener, nsIURI ** aURL)</span>
<a href="#l23.1808"></a><span id="l23.1808" class="difflineminus">-{</span>
<a href="#l23.1809"></a><span id="l23.1809" class="difflineplus">+NS_IMETHODIMP nsNntpService::DisplayMessageForPrinting(</span>
<a href="#l23.1810"></a><span id="l23.1810" class="difflineplus">+    const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l23.1811"></a><span id="l23.1811" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l23.1812"></a><span id="l23.1812">   mPrintingOperation = true;</span>
<a href="#l23.1813"></a><span id="l23.1813" class="difflineminus">-  nsresult rv = DisplayMessage(aMessageURI, aDisplayConsumer, aMsgWindow, aUrlListener, nullptr, aURL);</span>
<a href="#l23.1814"></a><span id="l23.1814" class="difflineplus">+  nsresult rv = DisplayMessage(aMessageURI, aDisplayConsumer, aMsgWindow,</span>
<a href="#l23.1815"></a><span id="l23.1815" class="difflineplus">+                               aUrlListener, nullptr, aURL);</span>
<a href="#l23.1816"></a><span id="l23.1816">   mPrintingOperation = false;</span>
<a href="#l23.1817"></a><span id="l23.1817">   return rv;</span>
<a href="#l23.1818"></a><span id="l23.1818"> }</span>
<a href="#l23.1819"></a><span id="l23.1819"> </span>
<a href="#l23.1820"></a><span id="l23.1820"> NS_IMETHODIMP</span>
<a href="#l23.1821"></a><span id="l23.1821"> nsNntpService::StreamMessage(const char *aMessageURI, nsISupports *aConsumer,</span>
<a href="#l23.1822"></a><span id="l23.1822" class="difflineminus">-                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.1823"></a><span id="l23.1823" class="difflineminus">-                              nsIUrlListener *aUrlListener,</span>
<a href="#l23.1824"></a><span id="l23.1824" class="difflineminus">-                              bool /* convertData */,</span>
<a href="#l23.1825"></a><span id="l23.1825" class="difflineminus">-                              const nsACString &amp;aAdditionalHeader,</span>
<a href="#l23.1826"></a><span id="l23.1826" class="difflineminus">-                              bool aLocalOnly,</span>
<a href="#l23.1827"></a><span id="l23.1827" class="difflineminus">-                              nsIURI **aURL)</span>
<a href="#l23.1828"></a><span id="l23.1828" class="difflineminus">-{</span>
<a href="#l23.1829"></a><span id="l23.1829" class="difflineminus">-    // The nntp protocol object will look for &quot;header=filter&quot; to decide if it wants to convert</span>
<a href="#l23.1830"></a><span id="l23.1830" class="difflineminus">-    // the data instead of using aConvertData. It turns out to be way too hard to pass aConvertData</span>
<a href="#l23.1831"></a><span id="l23.1831" class="difflineminus">-    // all the way over to the nntp protocol object.</span>
<a href="#l23.1832"></a><span id="l23.1832" class="difflineminus">-    nsAutoCString aURIString(aMessageURI);</span>
<a href="#l23.1833"></a><span id="l23.1833" class="difflineplus">+                             nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.1834"></a><span id="l23.1834" class="difflineplus">+                             nsIUrlListener *aUrlListener,</span>
<a href="#l23.1835"></a><span id="l23.1835" class="difflineplus">+                             bool /* convertData */,</span>
<a href="#l23.1836"></a><span id="l23.1836" class="difflineplus">+                             const nsACString &amp;aAdditionalHeader,</span>
<a href="#l23.1837"></a><span id="l23.1837" class="difflineplus">+                             bool aLocalOnly, nsIURI **aURL) {</span>
<a href="#l23.1838"></a><span id="l23.1838" class="difflineplus">+  // The nntp protocol object will look for &quot;header=filter&quot; to decide if it</span>
<a href="#l23.1839"></a><span id="l23.1839" class="difflineplus">+  // wants to convert the data instead of using aConvertData. It turns out to be</span>
<a href="#l23.1840"></a><span id="l23.1840" class="difflineplus">+  // way too hard to pass aConvertData all the way over to the nntp protocol</span>
<a href="#l23.1841"></a><span id="l23.1841" class="difflineplus">+  // object.</span>
<a href="#l23.1842"></a><span id="l23.1842" class="difflineplus">+  nsAutoCString aURIString(aMessageURI);</span>
<a href="#l23.1843"></a><span id="l23.1843" class="difflineplus">+</span>
<a href="#l23.1844"></a><span id="l23.1844" class="difflineplus">+  if (!aAdditionalHeader.IsEmpty()) {</span>
<a href="#l23.1845"></a><span id="l23.1845" class="difflineplus">+    aURIString.FindChar('?') == kNotFound ? aURIString += &quot;?&quot;</span>
<a href="#l23.1846"></a><span id="l23.1846" class="difflineplus">+                                          : aURIString += &quot;&amp;&quot;;</span>
<a href="#l23.1847"></a><span id="l23.1847" class="difflineplus">+    aURIString += &quot;header=&quot;;</span>
<a href="#l23.1848"></a><span id="l23.1848" class="difflineplus">+    aURIString += aAdditionalHeader;</span>
<a href="#l23.1849"></a><span id="l23.1849" class="difflineplus">+  }</span>
<a href="#l23.1850"></a><span id="l23.1850" class="difflineplus">+</span>
<a href="#l23.1851"></a><span id="l23.1851" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.1852"></a><span id="l23.1852" class="difflineplus">+  nsMsgKey key;</span>
<a href="#l23.1853"></a><span id="l23.1853" class="difflineplus">+  nsresult rv =</span>
<a href="#l23.1854"></a><span id="l23.1854" class="difflineplus">+      DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.1855"></a><span id="l23.1855" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1856"></a><span id="l23.1856" class="difflineplus">+</span>
<a href="#l23.1857"></a><span id="l23.1857" class="difflineplus">+  nsAutoCString urlStr;</span>
<a href="#l23.1858"></a><span id="l23.1858" class="difflineplus">+  rv = CreateMessageIDURL(folder, key, getter_Copies(urlStr));</span>
<a href="#l23.1859"></a><span id="l23.1859" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1860"></a><span id="l23.1860"> </span>
<a href="#l23.1861"></a><span id="l23.1861" class="difflineminus">-    if (!aAdditionalHeader.IsEmpty())</span>
<a href="#l23.1862"></a><span id="l23.1862" class="difflineminus">-    {</span>
<a href="#l23.1863"></a><span id="l23.1863" class="difflineminus">-      aURIString.FindChar('?') == kNotFound ? aURIString += &quot;?&quot; : aURIString += &quot;&amp;&quot;;</span>
<a href="#l23.1864"></a><span id="l23.1864" class="difflineminus">-      aURIString += &quot;header=&quot;;</span>
<a href="#l23.1865"></a><span id="l23.1865" class="difflineminus">-      aURIString += aAdditionalHeader;</span>
<a href="#l23.1866"></a><span id="l23.1866" class="difflineplus">+  nsNewsAction action = nsINntpUrl::ActionFetchArticle;</span>
<a href="#l23.1867"></a><span id="l23.1867" class="difflineplus">+  if (mOpenAttachmentOperation) action = nsINntpUrl::ActionFetchPart;</span>
<a href="#l23.1868"></a><span id="l23.1868" class="difflineplus">+</span>
<a href="#l23.1869"></a><span id="l23.1869" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.1870"></a><span id="l23.1870" class="difflineplus">+  rv = ConstructNntpUrl(urlStr.get(), aUrlListener, aMsgWindow,</span>
<a href="#l23.1871"></a><span id="l23.1871" class="difflineplus">+                        aURIString.get(), action, getter_AddRefs(url));</span>
<a href="#l23.1872"></a><span id="l23.1872" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1873"></a><span id="l23.1873" class="difflineplus">+</span>
<a href="#l23.1874"></a><span id="l23.1874" class="difflineplus">+  if (aLocalOnly || WeAreOffline()) {</span>
<a href="#l23.1875"></a><span id="l23.1875" class="difflineplus">+    // Check in the offline cache, then in the mem cache</span>
<a href="#l23.1876"></a><span id="l23.1876" class="difflineplus">+    bool hasMsgOffline = false;</span>
<a href="#l23.1877"></a><span id="l23.1877" class="difflineplus">+    folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.1878"></a><span id="l23.1878" class="difflineplus">+    if (!hasMsgOffline) {</span>
<a href="#l23.1879"></a><span id="l23.1879" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.1880"></a><span id="l23.1880" class="difflineplus">+      rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l23.1881"></a><span id="l23.1881" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1882"></a><span id="l23.1882" class="difflineplus">+</span>
<a href="#l23.1883"></a><span id="l23.1883" class="difflineplus">+      int32_t socketType;</span>
<a href="#l23.1884"></a><span id="l23.1884" class="difflineplus">+      rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l23.1885"></a><span id="l23.1885" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1886"></a><span id="l23.1886" class="difflineplus">+</span>
<a href="#l23.1887"></a><span id="l23.1887" class="difflineplus">+      // Don't mutate/clone here.</span>
<a href="#l23.1888"></a><span id="l23.1888" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url);</span>
<a href="#l23.1889"></a><span id="l23.1889" class="difflineplus">+      rv = mailnewsurl-&gt;SetPortInternal(socketType == nsMsgSocketType::SSL</span>
<a href="#l23.1890"></a><span id="l23.1890" class="difflineplus">+                                            ? nsINntpUrl::DEFAULT_NNTPS_PORT</span>
<a href="#l23.1891"></a><span id="l23.1891" class="difflineplus">+                                            : nsINntpUrl::DEFAULT_NNTP_PORT);</span>
<a href="#l23.1892"></a><span id="l23.1892" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1893"></a><span id="l23.1893" class="difflineplus">+</span>
<a href="#l23.1894"></a><span id="l23.1894" class="difflineplus">+      rv = IsMsgInMemCache(url, folder, &amp;hasMsgOffline);</span>
<a href="#l23.1895"></a><span id="l23.1895" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1896"></a><span id="l23.1896">     }</span>
<a href="#l23.1897"></a><span id="l23.1897"> </span>
<a href="#l23.1898"></a><span id="l23.1898" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.1899"></a><span id="l23.1899" class="difflineminus">-    nsMsgKey key;</span>
<a href="#l23.1900"></a><span id="l23.1900" class="difflineminus">-    nsresult rv = DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.1901"></a><span id="l23.1901" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1902"></a><span id="l23.1902" class="difflineminus">-</span>
<a href="#l23.1903"></a><span id="l23.1903" class="difflineminus">-    nsAutoCString urlStr;</span>
<a href="#l23.1904"></a><span id="l23.1904" class="difflineminus">-    rv = CreateMessageIDURL(folder, key, getter_Copies(urlStr));</span>
<a href="#l23.1905"></a><span id="l23.1905" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1906"></a><span id="l23.1906" class="difflineminus">-</span>
<a href="#l23.1907"></a><span id="l23.1907" class="difflineminus">-    nsNewsAction action = nsINntpUrl::ActionFetchArticle;</span>
<a href="#l23.1908"></a><span id="l23.1908" class="difflineminus">-    if (mOpenAttachmentOperation)</span>
<a href="#l23.1909"></a><span id="l23.1909" class="difflineminus">-      action = nsINntpUrl::ActionFetchPart;</span>
<a href="#l23.1910"></a><span id="l23.1910" class="difflineminus">-</span>
<a href="#l23.1911"></a><span id="l23.1911" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.1912"></a><span id="l23.1912" class="difflineminus">-    rv = ConstructNntpUrl(urlStr.get(), aUrlListener, aMsgWindow, aURIString.get(),</span>
<a href="#l23.1913"></a><span id="l23.1913" class="difflineminus">-                          action, getter_AddRefs(url));</span>
<a href="#l23.1914"></a><span id="l23.1914" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1915"></a><span id="l23.1915" class="difflineplus">+    // Return with an error if we didn't find it in the memory cache either</span>
<a href="#l23.1916"></a><span id="l23.1916" class="difflineplus">+    if (!hasMsgOffline) return NS_ERROR_FAILURE;</span>
<a href="#l23.1917"></a><span id="l23.1917"> </span>
<a href="#l23.1918"></a><span id="l23.1918" class="difflineminus">-    if (aLocalOnly || WeAreOffline())</span>
<a href="#l23.1919"></a><span id="l23.1919" class="difflineminus">-    {</span>
<a href="#l23.1920"></a><span id="l23.1920" class="difflineminus">-      // Check in the offline cache, then in the mem cache</span>
<a href="#l23.1921"></a><span id="l23.1921" class="difflineminus">-      bool hasMsgOffline = false;</span>
<a href="#l23.1922"></a><span id="l23.1922" class="difflineminus">-      folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.1923"></a><span id="l23.1923" class="difflineminus">-      if (!hasMsgOffline)</span>
<a href="#l23.1924"></a><span id="l23.1924" class="difflineminus">-      {</span>
<a href="#l23.1925"></a><span id="l23.1925" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l23.1926"></a><span id="l23.1926" class="difflineminus">-        rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l23.1927"></a><span id="l23.1927" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1928"></a><span id="l23.1928" class="difflineminus">-</span>
<a href="#l23.1929"></a><span id="l23.1929" class="difflineminus">-        int32_t socketType;</span>
<a href="#l23.1930"></a><span id="l23.1930" class="difflineminus">-        rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l23.1931"></a><span id="l23.1931" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1932"></a><span id="l23.1932" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(url, &amp;rv));</span>
<a href="#l23.1933"></a><span id="l23.1933" class="difflineplus">+    msgUrl-&gt;SetMsgIsInLocalCache(true);</span>
<a href="#l23.1934"></a><span id="l23.1934" class="difflineplus">+  }</span>
<a href="#l23.1935"></a><span id="l23.1935"> </span>
<a href="#l23.1936"></a><span id="l23.1936" class="difflineminus">-        // Don't mutate/clone here.</span>
<a href="#l23.1937"></a><span id="l23.1937" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url);</span>
<a href="#l23.1938"></a><span id="l23.1938" class="difflineminus">-        rv = mailnewsurl-&gt;SetPortInternal(socketType == nsMsgSocketType::SSL ?</span>
<a href="#l23.1939"></a><span id="l23.1939" class="difflineminus">-                                            nsINntpUrl::DEFAULT_NNTPS_PORT :</span>
<a href="#l23.1940"></a><span id="l23.1940" class="difflineminus">-                                            nsINntpUrl::DEFAULT_NNTP_PORT);</span>
<a href="#l23.1941"></a><span id="l23.1941" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1942"></a><span id="l23.1942" class="difflineminus">-</span>
<a href="#l23.1943"></a><span id="l23.1943" class="difflineminus">-        rv = IsMsgInMemCache(url, folder, &amp;hasMsgOffline);</span>
<a href="#l23.1944"></a><span id="l23.1944" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1945"></a><span id="l23.1945" class="difflineminus">-      }</span>
<a href="#l23.1946"></a><span id="l23.1946" class="difflineminus">-</span>
<a href="#l23.1947"></a><span id="l23.1947" class="difflineminus">-      // Return with an error if we didn't find it in the memory cache either</span>
<a href="#l23.1948"></a><span id="l23.1948" class="difflineminus">-      if (!hasMsgOffline)</span>
<a href="#l23.1949"></a><span id="l23.1949" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l23.1950"></a><span id="l23.1950" class="difflineminus">-</span>
<a href="#l23.1951"></a><span id="l23.1951" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(url, &amp;rv));</span>
<a href="#l23.1952"></a><span id="l23.1952" class="difflineminus">-      msgUrl-&gt;SetMsgIsInLocalCache(true);</span>
<a href="#l23.1953"></a><span id="l23.1953" class="difflineminus">-    }</span>
<a href="#l23.1954"></a><span id="l23.1954" class="difflineminus">-</span>
<a href="#l23.1955"></a><span id="l23.1955" class="difflineminus">-    rv = GetMessageFromUrl(url, aMsgWindow, aConsumer);</span>
<a href="#l23.1956"></a><span id="l23.1956" class="difflineminus">-    if (aURL)</span>
<a href="#l23.1957"></a><span id="l23.1957" class="difflineminus">-      url.forget(aURL);</span>
<a href="#l23.1958"></a><span id="l23.1958" class="difflineminus">-    return rv;</span>
<a href="#l23.1959"></a><span id="l23.1959" class="difflineplus">+  rv = GetMessageFromUrl(url, aMsgWindow, aConsumer);</span>
<a href="#l23.1960"></a><span id="l23.1960" class="difflineplus">+  if (aURL) url.forget(aURL);</span>
<a href="#l23.1961"></a><span id="l23.1961" class="difflineplus">+  return rv;</span>
<a href="#l23.1962"></a><span id="l23.1962"> }</span>
<a href="#l23.1963"></a><span id="l23.1963"> </span>
<a href="#l23.1964"></a><span id="l23.1964"> NS_IMETHODIMP nsNntpService::StreamHeaders(const char *aMessageURI,</span>
<a href="#l23.1965"></a><span id="l23.1965">                                            nsIStreamListener *aConsumer,</span>
<a href="#l23.1966"></a><span id="l23.1966">                                            nsIUrlListener *aUrlListener,</span>
<a href="#l23.1967"></a><span id="l23.1967" class="difflineminus">-                                           bool aLocalOnly,</span>
<a href="#l23.1968"></a><span id="l23.1968" class="difflineminus">-                                           nsIURI **aURL)</span>
<a href="#l23.1969"></a><span id="l23.1969" class="difflineminus">-{</span>
<a href="#l23.1970"></a><span id="l23.1970" class="difflineplus">+                                           bool aLocalOnly, nsIURI **aURL) {</span>
<a href="#l23.1971"></a><span id="l23.1971">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l23.1972"></a><span id="l23.1972">   NS_ENSURE_ARG_POINTER(aConsumer);</span>
<a href="#l23.1973"></a><span id="l23.1973">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.1974"></a><span id="l23.1974">   nsMsgKey key;</span>
<a href="#l23.1975"></a><span id="l23.1975"> </span>
<a href="#l23.1976"></a><span id="l23.1976" class="difflineminus">-  nsresult rv = DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.1977"></a><span id="l23.1977" class="difflineplus">+  nsresult rv =</span>
<a href="#l23.1978"></a><span id="l23.1978" class="difflineplus">+      DecomposeNewsMessageURI(aMessageURI, getter_AddRefs(folder), &amp;key);</span>
<a href="#l23.1979"></a><span id="l23.1979">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1980"></a><span id="l23.1980"> </span>
<a href="#l23.1981"></a><span id="l23.1981" class="difflineminus">-  if (key == nsMsgKey_None)</span>
<a href="#l23.1982"></a><span id="l23.1982" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l23.1983"></a><span id="l23.1983" class="difflineplus">+  if (key == nsMsgKey_None) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l23.1984"></a><span id="l23.1984"> </span>
<a href="#l23.1985"></a><span id="l23.1985">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l23.1986"></a><span id="l23.1986">   bool hasMsgOffline = false;</span>
<a href="#l23.1987"></a><span id="l23.1987">   folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l23.1988"></a><span id="l23.1988" class="difflineminus">-  if (hasMsgOffline)</span>
<a href="#l23.1989"></a><span id="l23.1989" class="difflineminus">-  {</span>
<a href="#l23.1990"></a><span id="l23.1990" class="difflineplus">+  if (hasMsgOffline) {</span>
<a href="#l23.1991"></a><span id="l23.1991">     int64_t messageOffset;</span>
<a href="#l23.1992"></a><span id="l23.1992">     uint32_t messageSize;</span>
<a href="#l23.1993"></a><span id="l23.1993" class="difflineminus">-    folder-&gt;GetOfflineFileStream(key, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l23.1994"></a><span id="l23.1994" class="difflineminus">-    if (inputStream)</span>
<a href="#l23.1995"></a><span id="l23.1995" class="difflineminus">-      return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l23.1996"></a><span id="l23.1996" class="difflineplus">+    folder-&gt;GetOfflineFileStream(key, &amp;messageOffset, &amp;messageSize,</span>
<a href="#l23.1997"></a><span id="l23.1997" class="difflineplus">+                                 getter_AddRefs(inputStream));</span>
<a href="#l23.1998"></a><span id="l23.1998" class="difflineplus">+    if (inputStream) return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l23.1999"></a><span id="l23.1999">   }</span>
<a href="#l23.2000"></a><span id="l23.2000">   nsAutoCString urlStr;</span>
<a href="#l23.2001"></a><span id="l23.2001">   rv = CreateMessageIDURL(folder, key, getter_Copies(urlStr));</span>
<a href="#l23.2002"></a><span id="l23.2002">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2003"></a><span id="l23.2003"> </span>
<a href="#l23.2004"></a><span id="l23.2004" class="difflineminus">-  if (aLocalOnly)</span>
<a href="#l23.2005"></a><span id="l23.2005" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l23.2006"></a><span id="l23.2006" class="difflineplus">+  if (aLocalOnly) return NS_ERROR_FAILURE;</span>
<a href="#l23.2007"></a><span id="l23.2007">   return rv;</span>
<a href="#l23.2008"></a><span id="l23.2008"> }</span>
<a href="#l23.2009"></a><span id="l23.2009"> </span>
<a href="#l23.2010"></a><span id="l23.2010"> NS_IMETHODIMP nsNntpService::IsMsgInMemCache(nsIURI *aUrl,</span>
<a href="#l23.2011"></a><span id="l23.2011">                                              nsIMsgFolder *aFolder,</span>
<a href="#l23.2012"></a><span id="l23.2012" class="difflineminus">-                                             bool *aResult)</span>
<a href="#l23.2013"></a><span id="l23.2013" class="difflineminus">-{</span>
<a href="#l23.2014"></a><span id="l23.2014" class="difflineplus">+                                             bool *aResult) {</span>
<a href="#l23.2015"></a><span id="l23.2015">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l23.2016"></a><span id="l23.2016">   *aResult = false;</span>
<a href="#l23.2017"></a><span id="l23.2017">   nsresult rv;</span>
<a href="#l23.2018"></a><span id="l23.2018"> </span>
<a href="#l23.2019"></a><span id="l23.2019" class="difflineminus">-  if (mCacheStorage)</span>
<a href="#l23.2020"></a><span id="l23.2020" class="difflineminus">-  {</span>
<a href="#l23.2021"></a><span id="l23.2021" class="difflineplus">+  if (mCacheStorage) {</span>
<a href="#l23.2022"></a><span id="l23.2022">     // NNTP urls are truncated at the query part when used as cache keys.</span>
<a href="#l23.2023"></a><span id="l23.2023">     nsAutoCString path;</span>
<a href="#l23.2024"></a><span id="l23.2024">     aUrl-&gt;GetPathQueryRef(path);</span>
<a href="#l23.2025"></a><span id="l23.2025">     int32_t pos = path.FindChar('?');</span>
<a href="#l23.2026"></a><span id="l23.2026">     nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l23.2027"></a><span id="l23.2027">     if (pos != kNotFound) {</span>
<a href="#l23.2028"></a><span id="l23.2028">       path.SetLength(pos);</span>
<a href="#l23.2029"></a><span id="l23.2029">       rv = NS_MutateURI(aUrl).SetPathQueryRef(path).Finalize(newUri);</span>
<a href="#l23.2030"></a><span id="l23.2030" class="difflineat">@@ -1529,225 +1449,217 @@ NS_IMETHODIMP nsNntpService::IsMsgInMemC</span>
<a href="#l23.2031"></a><span id="l23.2031">     if (NS_SUCCEEDED(rv) &amp;&amp; exists) {</span>
<a href="#l23.2032"></a><span id="l23.2032">       *aResult = true;</span>
<a href="#l23.2033"></a><span id="l23.2033">     }</span>
<a href="#l23.2034"></a><span id="l23.2034">   }</span>
<a href="#l23.2035"></a><span id="l23.2035"> </span>
<a href="#l23.2036"></a><span id="l23.2036">   return NS_OK;</span>
<a href="#l23.2037"></a><span id="l23.2037"> }</span>
<a href="#l23.2038"></a><span id="l23.2038"> </span>
<a href="#l23.2039"></a><span id="l23.2039" class="difflineminus">-NS_IMETHODIMP nsNntpService::Search(nsIMsgSearchSession *aSearchSession, nsIMsgWindow *aMsgWindow, nsIMsgFolder *aMsgFolder, const char *aSearchUri)</span>
<a href="#l23.2040"></a><span id="l23.2040" class="difflineminus">-{</span>
<a href="#l23.2041"></a><span id="l23.2041" class="difflineplus">+NS_IMETHODIMP nsNntpService::Search(nsIMsgSearchSession *aSearchSession,</span>
<a href="#l23.2042"></a><span id="l23.2042" class="difflineplus">+                                    nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.2043"></a><span id="l23.2043" class="difflineplus">+                                    nsIMsgFolder *aMsgFolder,</span>
<a href="#l23.2044"></a><span id="l23.2044" class="difflineplus">+                                    const char *aSearchUri) {</span>
<a href="#l23.2045"></a><span id="l23.2045">   NS_ENSURE_ARG(aMsgFolder);</span>
<a href="#l23.2046"></a><span id="l23.2046">   NS_ENSURE_ARG(aSearchUri);</span>
<a href="#l23.2047"></a><span id="l23.2047"> </span>
<a href="#l23.2048"></a><span id="l23.2048">   nsresult rv;</span>
<a href="#l23.2049"></a><span id="l23.2049"> </span>
<a href="#l23.2050"></a><span id="l23.2050">   nsCString searchUrl;</span>
<a href="#l23.2051"></a><span id="l23.2051">   rv = aMsgFolder-&gt;GetURI(searchUrl);</span>
<a href="#l23.2052"></a><span id="l23.2052" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.2053"></a><span id="l23.2053" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2054"></a><span id="l23.2054"> </span>
<a href="#l23.2055"></a><span id="l23.2055">   searchUrl.Append(aSearchUri);</span>
<a href="#l23.2056"></a><span id="l23.2056"> </span>
<a href="#l23.2057"></a><span id="l23.2057" class="difflineminus">-  nsCOMPtr &lt;nsIUrlListener&gt; urlListener = do_QueryInterface(aSearchSession);</span>
<a href="#l23.2058"></a><span id="l23.2058" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(aSearchSession);</span>
<a href="#l23.2059"></a><span id="l23.2059">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.2060"></a><span id="l23.2060" class="difflineminus">-  rv = ConstructNntpUrl(searchUrl.get(), urlListener, aMsgWindow, nullptr, nsINntpUrl::ActionSearch, getter_AddRefs(url));</span>
<a href="#l23.2061"></a><span id="l23.2061" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.2062"></a><span id="l23.2062" class="difflineplus">+  rv = ConstructNntpUrl(searchUrl.get(), urlListener, aMsgWindow, nullptr,</span>
<a href="#l23.2063"></a><span id="l23.2063" class="difflineplus">+                        nsINntpUrl::ActionSearch, getter_AddRefs(url));</span>
<a href="#l23.2064"></a><span id="l23.2064" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2065"></a><span id="l23.2065"> </span>
<a href="#l23.2066"></a><span id="l23.2066" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(url));</span>
<a href="#l23.2067"></a><span id="l23.2067" class="difflineminus">-  if (msgurl)</span>
<a href="#l23.2068"></a><span id="l23.2068" class="difflineminus">-    msgurl-&gt;SetSearchSession(aSearchSession);</span>
<a href="#l23.2069"></a><span id="l23.2069" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(url));</span>
<a href="#l23.2070"></a><span id="l23.2070" class="difflineplus">+  if (msgurl) msgurl-&gt;SetSearchSession(aSearchSession);</span>
<a href="#l23.2071"></a><span id="l23.2071"> </span>
<a href="#l23.2072"></a><span id="l23.2072">   // run the url to update the counts</span>
<a href="#l23.2073"></a><span id="l23.2073">   return RunNewsUrl(url, nullptr, nullptr);</span>
<a href="#l23.2074"></a><span id="l23.2074"> }</span>
<a href="#l23.2075"></a><span id="l23.2075"> </span>
<a href="#l23.2076"></a><span id="l23.2076"> NS_IMETHODIMP</span>
<a href="#l23.2077"></a><span id="l23.2077" class="difflineminus">-nsNntpService::GetListOfGroupsOnServer(nsINntpIncomingServer *aNntpServer, nsIMsgWindow *aMsgWindow, bool aGetOnlyNew)</span>
<a href="#l23.2078"></a><span id="l23.2078" class="difflineminus">-{</span>
<a href="#l23.2079"></a><span id="l23.2079" class="difflineplus">+nsNntpService::GetListOfGroupsOnServer(nsINntpIncomingServer *aNntpServer,</span>
<a href="#l23.2080"></a><span id="l23.2080" class="difflineplus">+                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.2081"></a><span id="l23.2081" class="difflineplus">+                                       bool aGetOnlyNew) {</span>
<a href="#l23.2082"></a><span id="l23.2082">   nsresult rv;</span>
<a href="#l23.2083"></a><span id="l23.2083"> </span>
<a href="#l23.2084"></a><span id="l23.2084">   NS_ENSURE_ARG_POINTER(aNntpServer);</span>
<a href="#l23.2085"></a><span id="l23.2085"> </span>
<a href="#l23.2086"></a><span id="l23.2086">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aNntpServer, &amp;rv);</span>
<a href="#l23.2087"></a><span id="l23.2087">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.2088"></a><span id="l23.2088">   if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l23.2089"></a><span id="l23.2089"> </span>
<a href="#l23.2090"></a><span id="l23.2090">   nsCString serverUri;</span>
<a href="#l23.2091"></a><span id="l23.2091">   rv = server-&gt;GetServerURI(serverUri);</span>
<a href="#l23.2092"></a><span id="l23.2092">   nsNewsAction newsAction;</span>
<a href="#l23.2093"></a><span id="l23.2093" class="difflineminus">-  if (aGetOnlyNew)</span>
<a href="#l23.2094"></a><span id="l23.2094" class="difflineminus">-  {</span>
<a href="#l23.2095"></a><span id="l23.2095" class="difflineplus">+  if (aGetOnlyNew) {</span>
<a href="#l23.2096"></a><span id="l23.2096">     serverUri.AppendLiteral(&quot;/?newgroups&quot;);</span>
<a href="#l23.2097"></a><span id="l23.2097">     newsAction = nsINntpUrl::ActionListNewGroups;</span>
<a href="#l23.2098"></a><span id="l23.2098" class="difflineminus">-  }</span>
<a href="#l23.2099"></a><span id="l23.2099" class="difflineminus">-  else</span>
<a href="#l23.2100"></a><span id="l23.2100" class="difflineminus">-  {</span>
<a href="#l23.2101"></a><span id="l23.2101" class="difflineplus">+  } else {</span>
<a href="#l23.2102"></a><span id="l23.2102">     serverUri.AppendLiteral(&quot;/*&quot;);</span>
<a href="#l23.2103"></a><span id="l23.2103">     newsAction = nsINntpUrl::ActionListGroups;</span>
<a href="#l23.2104"></a><span id="l23.2104">   }</span>
<a href="#l23.2105"></a><span id="l23.2105"> </span>
<a href="#l23.2106"></a><span id="l23.2106" class="difflineminus">-  nsCOMPtr &lt;nsIUrlListener&gt; listener = do_QueryInterface(aNntpServer, &amp;rv);</span>
<a href="#l23.2107"></a><span id="l23.2107" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; listener = do_QueryInterface(aNntpServer, &amp;rv);</span>
<a href="#l23.2108"></a><span id="l23.2108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2109"></a><span id="l23.2109"> </span>
<a href="#l23.2110"></a><span id="l23.2110">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l23.2111"></a><span id="l23.2111" class="difflineminus">-  rv = ConstructNntpUrl(serverUri.get(), listener, aMsgWindow, nullptr, newsAction, getter_AddRefs(url));</span>
<a href="#l23.2112"></a><span id="l23.2112" class="difflineplus">+  rv = ConstructNntpUrl(serverUri.get(), listener, aMsgWindow, nullptr,</span>
<a href="#l23.2113"></a><span id="l23.2113" class="difflineplus">+                        newsAction, getter_AddRefs(url));</span>
<a href="#l23.2114"></a><span id="l23.2114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2115"></a><span id="l23.2115"> </span>
<a href="#l23.2116"></a><span id="l23.2116">   // now run the url to add the rest of the groups</span>
<a href="#l23.2117"></a><span id="l23.2117">   return RunNewsUrl(url, aMsgWindow, nullptr);</span>
<a href="#l23.2118"></a><span id="l23.2118"> }</span>
<a href="#l23.2119"></a><span id="l23.2119"> </span>
<a href="#l23.2120"></a><span id="l23.2120" class="difflineminus">-</span>
<a href="#l23.2121"></a><span id="l23.2121"> NS_IMETHODIMP</span>
<a href="#l23.2122"></a><span id="l23.2122" class="difflineminus">-nsNntpService::Handle(nsICommandLine* aCmdLine)</span>
<a href="#l23.2123"></a><span id="l23.2123" class="difflineminus">-{</span>
<a href="#l23.2124"></a><span id="l23.2124" class="difflineplus">+nsNntpService::Handle(nsICommandLine *aCmdLine) {</span>
<a href="#l23.2125"></a><span id="l23.2125">   NS_ENSURE_ARG_POINTER(aCmdLine);</span>
<a href="#l23.2126"></a><span id="l23.2126"> </span>
<a href="#l23.2127"></a><span id="l23.2127">   nsresult rv;</span>
<a href="#l23.2128"></a><span id="l23.2128">   bool found;</span>
<a href="#l23.2129"></a><span id="l23.2129"> </span>
<a href="#l23.2130"></a><span id="l23.2130">   rv = aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(&quot;news&quot;), false, &amp;found);</span>
<a href="#l23.2131"></a><span id="l23.2131">   if (NS_SUCCEEDED(rv) &amp;&amp; found) {</span>
<a href="#l23.2132"></a><span id="l23.2132" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch (do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l23.2133"></a><span id="l23.2133" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l23.2134"></a><span id="l23.2134" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l23.2135"></a><span id="l23.2135">     NS_ENSURE_TRUE(wwatch, NS_ERROR_FAILURE);</span>
<a href="#l23.2136"></a><span id="l23.2136"> </span>
<a href="#l23.2137"></a><span id="l23.2137">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; opened;</span>
<a href="#l23.2138"></a><span id="l23.2138" class="difflineminus">-    wwatch-&gt;OpenWindow(nullptr, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l23.2139"></a><span id="l23.2139" class="difflineminus">-                       &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;,</span>
<a href="#l23.2140"></a><span id="l23.2140" class="difflineminus">-                       nullptr, getter_AddRefs(opened));</span>
<a href="#l23.2141"></a><span id="l23.2141" class="difflineplus">+    wwatch-&gt;OpenWindow(</span>
<a href="#l23.2142"></a><span id="l23.2142" class="difflineplus">+        nullptr, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l23.2143"></a><span id="l23.2143" class="difflineplus">+        &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;,</span>
<a href="#l23.2144"></a><span id="l23.2144" class="difflineplus">+        nullptr, getter_AddRefs(opened));</span>
<a href="#l23.2145"></a><span id="l23.2145">     aCmdLine-&gt;SetPreventDefault(true);</span>
<a href="#l23.2146"></a><span id="l23.2146">   }</span>
<a href="#l23.2147"></a><span id="l23.2147"> </span>
<a href="#l23.2148"></a><span id="l23.2148">   return NS_OK;</span>
<a href="#l23.2149"></a><span id="l23.2149"> }</span>
<a href="#l23.2150"></a><span id="l23.2150"> </span>
<a href="#l23.2151"></a><span id="l23.2151"> NS_IMETHODIMP</span>
<a href="#l23.2152"></a><span id="l23.2152" class="difflineminus">-nsNntpService::GetHelpInfo(nsACString&amp; aResult)</span>
<a href="#l23.2153"></a><span id="l23.2153" class="difflineminus">-{</span>
<a href="#l23.2154"></a><span id="l23.2154" class="difflineplus">+nsNntpService::GetHelpInfo(nsACString &amp;aResult) {</span>
<a href="#l23.2155"></a><span id="l23.2155">   aResult.AssignLiteral(&quot;  -news              Open the news client.\n&quot;);</span>
<a href="#l23.2156"></a><span id="l23.2156">   return NS_OK;</span>
<a href="#l23.2157"></a><span id="l23.2157"> }</span>
<a href="#l23.2158"></a><span id="l23.2158"> </span>
<a href="#l23.2159"></a><span id="l23.2159"> NS_IMETHODIMP</span>
<a href="#l23.2160"></a><span id="l23.2160" class="difflineminus">-nsNntpService::HandleContent(const char * aContentType, nsIInterfaceRequestor* aWindowContext, nsIRequest *request)</span>
<a href="#l23.2161"></a><span id="l23.2161" class="difflineminus">-{</span>
<a href="#l23.2162"></a><span id="l23.2162" class="difflineplus">+nsNntpService::HandleContent(const char *aContentType,</span>
<a href="#l23.2163"></a><span id="l23.2163" class="difflineplus">+                             nsIInterfaceRequestor *aWindowContext,</span>
<a href="#l23.2164"></a><span id="l23.2164" class="difflineplus">+                             nsIRequest *request) {</span>
<a href="#l23.2165"></a><span id="l23.2165">   nsresult rv;</span>
<a href="#l23.2166"></a><span id="l23.2166">   NS_ENSURE_ARG_POINTER(request);</span>
<a href="#l23.2167"></a><span id="l23.2167"> </span>
<a href="#l23.2168"></a><span id="l23.2168">   nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l23.2169"></a><span id="l23.2169">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2170"></a><span id="l23.2170"> </span>
<a href="#l23.2171"></a><span id="l23.2171">   // check for x-application-newsgroup or x-application-newsgroup-listids</span>
<a href="#l23.2172"></a><span id="l23.2172" class="difflineminus">-  if (PL_strncasecmp(aContentType, &quot;x-application-newsgroup&quot;, 23) == 0)</span>
<a href="#l23.2173"></a><span id="l23.2173" class="difflineminus">-  {</span>
<a href="#l23.2174"></a><span id="l23.2174" class="difflineplus">+  if (PL_strncasecmp(aContentType, &quot;x-application-newsgroup&quot;, 23) == 0) {</span>
<a href="#l23.2175"></a><span id="l23.2175">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l23.2176"></a><span id="l23.2176">     rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l23.2177"></a><span id="l23.2177">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2178"></a><span id="l23.2178"> </span>
<a href="#l23.2179"></a><span id="l23.2179">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(uri);</span>
<a href="#l23.2180"></a><span id="l23.2180" class="difflineminus">-    if (mailUrl)</span>
<a href="#l23.2181"></a><span id="l23.2181" class="difflineminus">-    {</span>
<a href="#l23.2182"></a><span id="l23.2182" class="difflineplus">+    if (mailUrl) {</span>
<a href="#l23.2183"></a><span id="l23.2183">       nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l23.2184"></a><span id="l23.2184">       rv = mailUrl-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l23.2185"></a><span id="l23.2185">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2186"></a><span id="l23.2186"> </span>
<a href="#l23.2187"></a><span id="l23.2187">       // No folder means we can't handle this</span>
<a href="#l23.2188"></a><span id="l23.2188" class="difflineminus">-      if (!msgFolder)</span>
<a href="#l23.2189"></a><span id="l23.2189" class="difflineminus">-        return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l23.2190"></a><span id="l23.2190" class="difflineplus">+      if (!msgFolder) return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l23.2191"></a><span id="l23.2191"> </span>
<a href="#l23.2192"></a><span id="l23.2192">       nsCString folderURL;</span>
<a href="#l23.2193"></a><span id="l23.2193">       rv = msgFolder-&gt;GetURI(folderURL);</span>
<a href="#l23.2194"></a><span id="l23.2194">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2195"></a><span id="l23.2195"> </span>
<a href="#l23.2196"></a><span id="l23.2196">       // this is all we need for listing newsgroup ids.</span>
<a href="#l23.2197"></a><span id="l23.2197">       if (!PL_strcasecmp(aContentType, &quot;x-application-newsgroup-listids&quot;))</span>
<a href="#l23.2198"></a><span id="l23.2198">         return NS_OK;</span>
<a href="#l23.2199"></a><span id="l23.2199"> </span>
<a href="#l23.2200"></a><span id="l23.2200">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l23.2201"></a><span id="l23.2201">       mailUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l23.2202"></a><span id="l23.2202" class="difflineminus">-      if (!msgWindow)</span>
<a href="#l23.2203"></a><span id="l23.2203" class="difflineminus">-      {</span>
<a href="#l23.2204"></a><span id="l23.2204" class="difflineplus">+      if (!msgWindow) {</span>
<a href="#l23.2205"></a><span id="l23.2205">         // This came from a docshell that didn't set msgWindow, so find one</span>
<a href="#l23.2206"></a><span id="l23.2206">         nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l23.2207"></a><span id="l23.2207" class="difflineminus">-          do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l23.2208"></a><span id="l23.2208" class="difflineplus">+            do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l23.2209"></a><span id="l23.2209">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2210"></a><span id="l23.2210"> </span>
<a href="#l23.2211"></a><span id="l23.2211">         mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l23.2212"></a><span id="l23.2212"> </span>
<a href="#l23.2213"></a><span id="l23.2213" class="difflineminus">-        if (!msgWindow)</span>
<a href="#l23.2214"></a><span id="l23.2214" class="difflineminus">-        {</span>
<a href="#l23.2215"></a><span id="l23.2215" class="difflineplus">+        if (!msgWindow) {</span>
<a href="#l23.2216"></a><span id="l23.2216">           // We need to create a 3-pane window, then</span>
<a href="#l23.2217"></a><span id="l23.2217">           nsCOMPtr&lt;nsIWindowWatcher&gt; wwatcher =</span>
<a href="#l23.2218"></a><span id="l23.2218" class="difflineminus">-            do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l23.2219"></a><span id="l23.2219" class="difflineplus">+              do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l23.2220"></a><span id="l23.2220">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2221"></a><span id="l23.2221"> </span>
<a href="#l23.2222"></a><span id="l23.2222">           nsCOMPtr&lt;nsISupportsCString&gt; arg =</span>
<a href="#l23.2223"></a><span id="l23.2223" class="difflineminus">-            do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID);</span>
<a href="#l23.2224"></a><span id="l23.2224" class="difflineplus">+              do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID);</span>
<a href="#l23.2225"></a><span id="l23.2225">           arg-&gt;SetData(folderURL);</span>
<a href="#l23.2226"></a><span id="l23.2226"> </span>
<a href="#l23.2227"></a><span id="l23.2227">           nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l23.2228"></a><span id="l23.2228">           rv = wwatcher-&gt;OpenWindow(nullptr, &quot;chrome://messenger/content/&quot;,</span>
<a href="#l23.2229"></a><span id="l23.2229" class="difflineminus">-            &quot;_blank&quot;, &quot;chome,all,dialog=no&quot;, arg, getter_AddRefs(newWindow));</span>
<a href="#l23.2230"></a><span id="l23.2230" class="difflineplus">+                                    &quot;_blank&quot;, &quot;chome,all,dialog=no&quot;, arg,</span>
<a href="#l23.2231"></a><span id="l23.2231" class="difflineplus">+                                    getter_AddRefs(newWindow));</span>
<a href="#l23.2232"></a><span id="l23.2232">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2233"></a><span id="l23.2233">         }</span>
<a href="#l23.2234"></a><span id="l23.2234">       }</span>
<a href="#l23.2235"></a><span id="l23.2235" class="difflineminus">-      if (msgWindow)</span>
<a href="#l23.2236"></a><span id="l23.2236" class="difflineminus">-      {</span>
<a href="#l23.2237"></a><span id="l23.2237" class="difflineplus">+      if (msgWindow) {</span>
<a href="#l23.2238"></a><span id="l23.2238">         nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l23.2239"></a><span id="l23.2239">         msgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l23.2240"></a><span id="l23.2240" class="difflineminus">-        if (windowCommands)</span>
<a href="#l23.2241"></a><span id="l23.2241" class="difflineminus">-          windowCommands-&gt;SelectFolder(folderURL);</span>
<a href="#l23.2242"></a><span id="l23.2242" class="difflineplus">+        if (windowCommands) windowCommands-&gt;SelectFolder(folderURL);</span>
<a href="#l23.2243"></a><span id="l23.2243">       }</span>
<a href="#l23.2244"></a><span id="l23.2244">       request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l23.2245"></a><span id="l23.2245">     }</span>
<a href="#l23.2246"></a><span id="l23.2246" class="difflineminus">-  } else // The content-type was not x-application-newsgroup.</span>
<a href="#l23.2247"></a><span id="l23.2247" class="difflineplus">+  } else  // The content-type was not x-application-newsgroup.</span>
<a href="#l23.2248"></a><span id="l23.2248">     rv = NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l23.2249"></a><span id="l23.2249">   return rv;</span>
<a href="#l23.2250"></a><span id="l23.2250"> }</span>
<a href="#l23.2251"></a><span id="l23.2251"> </span>
<a href="#l23.2252"></a><span id="l23.2252"> NS_IMETHODIMP</span>
<a href="#l23.2253"></a><span id="l23.2253" class="difflineminus">-nsNntpService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **_retval)</span>
<a href="#l23.2254"></a><span id="l23.2254" class="difflineminus">-{</span>
<a href="#l23.2255"></a><span id="l23.2255" class="difflineplus">+nsNntpService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **_retval) {</span>
<a href="#l23.2256"></a><span id="l23.2256">   NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l23.2257"></a><span id="l23.2257">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l23.2258"></a><span id="l23.2258">   nsresult rv = NS_OK;</span>
<a href="#l23.2259"></a><span id="l23.2259"> </span>
<a href="#l23.2260"></a><span id="l23.2260" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.2261"></a><span id="l23.2261" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l23.2262"></a><span id="l23.2262">   nsMsgKey msgKey;</span>
<a href="#l23.2263"></a><span id="l23.2263"> </span>
<a href="#l23.2264"></a><span id="l23.2264">   rv = DecomposeNewsMessageURI(uri, getter_AddRefs(folder), &amp;msgKey);</span>
<a href="#l23.2265"></a><span id="l23.2265" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.2266"></a><span id="l23.2266" class="difflineminus">-  if (!folder)</span>
<a href="#l23.2267"></a><span id="l23.2267" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.2268"></a><span id="l23.2268" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2269"></a><span id="l23.2269" class="difflineplus">+  if (!folder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.2270"></a><span id="l23.2270"> </span>
<a href="#l23.2271"></a><span id="l23.2271">   rv = folder-&gt;GetMessageHeader(msgKey, _retval);</span>
<a href="#l23.2272"></a><span id="l23.2272" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.2273"></a><span id="l23.2273" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2274"></a><span id="l23.2274">   return NS_OK;</span>
<a href="#l23.2275"></a><span id="l23.2275"> }</span>
<a href="#l23.2276"></a><span id="l23.2276"> </span>
<a href="#l23.2277"></a><span id="l23.2277"> NS_IMETHODIMP</span>
<a href="#l23.2278"></a><span id="l23.2278" class="difflineminus">-nsNntpService::DownloadNewsgroupsForOffline(nsIMsgWindow *aMsgWindow, nsIUrlListener *aListener)</span>
<a href="#l23.2279"></a><span id="l23.2279" class="difflineminus">-{</span>
<a href="#l23.2280"></a><span id="l23.2280" class="difflineplus">+nsNntpService::DownloadNewsgroupsForOffline(nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.2281"></a><span id="l23.2281" class="difflineplus">+                                            nsIUrlListener *aListener) {</span>
<a href="#l23.2282"></a><span id="l23.2282">   RefPtr&lt;nsMsgDownloadAllNewsgroups&gt; newsgroupDownloader =</span>
<a href="#l23.2283"></a><span id="l23.2283" class="difflineminus">-    new nsMsgDownloadAllNewsgroups(aMsgWindow, aListener);</span>
<a href="#l23.2284"></a><span id="l23.2284" class="difflineplus">+      new nsMsgDownloadAllNewsgroups(aMsgWindow, aListener);</span>
<a href="#l23.2285"></a><span id="l23.2285">   return newsgroupDownloader-&gt;ProcessNextGroup();</span>
<a href="#l23.2286"></a><span id="l23.2286"> }</span>
<a href="#l23.2287"></a><span id="l23.2287"> </span>
<a href="#l23.2288"></a><span id="l23.2288" class="difflineminus">-NS_IMETHODIMP nsNntpService::GetCacheStorage(nsICacheStorage **result)</span>
<a href="#l23.2289"></a><span id="l23.2289" class="difflineminus">-{</span>
<a href="#l23.2290"></a><span id="l23.2290" class="difflineplus">+NS_IMETHODIMP nsNntpService::GetCacheStorage(nsICacheStorage **result) {</span>
<a href="#l23.2291"></a><span id="l23.2291">   nsresult rv = NS_OK;</span>
<a href="#l23.2292"></a><span id="l23.2292" class="difflineminus">-  if (!mCacheStorage)</span>
<a href="#l23.2293"></a><span id="l23.2293" class="difflineminus">-  {</span>
<a href="#l23.2294"></a><span id="l23.2294" class="difflineplus">+  if (!mCacheStorage) {</span>
<a href="#l23.2295"></a><span id="l23.2295">     nsCOMPtr&lt;nsICacheStorageService&gt; cacheStorageService =</span>
<a href="#l23.2296"></a><span id="l23.2296" class="difflineminus">-      do_GetService(&quot;@mozilla.org/netwerk/cache-storage-service;1&quot;, &amp;rv);</span>
<a href="#l23.2297"></a><span id="l23.2297" class="difflineplus">+        do_GetService(&quot;@mozilla.org/netwerk/cache-storage-service;1&quot;, &amp;rv);</span>
<a href="#l23.2298"></a><span id="l23.2298">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2299"></a><span id="l23.2299"> </span>
<a href="#l23.2300"></a><span id="l23.2300">     RefPtr&lt;MailnewsLoadContextInfo&gt; lci =</span>
<a href="#l23.2301"></a><span id="l23.2301" class="difflineminus">-      new MailnewsLoadContextInfo(false, false, mozilla::OriginAttributes());</span>
<a href="#l23.2302"></a><span id="l23.2302" class="difflineplus">+        new MailnewsLoadContextInfo(false, false, mozilla::OriginAttributes());</span>
<a href="#l23.2303"></a><span id="l23.2303"> </span>
<a href="#l23.2304"></a><span id="l23.2304" class="difflineminus">-    rv = cacheStorageService-&gt;MemoryCacheStorage(lci, getter_AddRefs(mCacheStorage));</span>
<a href="#l23.2305"></a><span id="l23.2305" class="difflineplus">+    rv = cacheStorageService-&gt;MemoryCacheStorage(lci,</span>
<a href="#l23.2306"></a><span id="l23.2306" class="difflineplus">+                                                 getter_AddRefs(mCacheStorage));</span>
<a href="#l23.2307"></a><span id="l23.2307">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2308"></a><span id="l23.2308">   }</span>
<a href="#l23.2309"></a><span id="l23.2309"> </span>
<a href="#l23.2310"></a><span id="l23.2310">   NS_IF_ADDREF(*result = mCacheStorage);</span>
<a href="#l23.2311"></a><span id="l23.2311">   return rv;</span>
<a href="#l23.2312"></a><span id="l23.2312"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -24,51 +24,57 @@ class nsIURI;</span>
<a href="#l24.4"></a><span id="l24.4"> class nsIUrlListener;</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> class nsNntpService : public nsINntpService,</span>
<a href="#l24.7"></a><span id="l24.7">                       public nsIMsgMessageService,</span>
<a href="#l24.8"></a><span id="l24.8">                       public nsIMsgMessageFetchPartService,</span>
<a href="#l24.9"></a><span id="l24.9">                       public nsIProtocolHandler,</span>
<a href="#l24.10"></a><span id="l24.10">                       public nsIMsgProtocolInfo,</span>
<a href="#l24.11"></a><span id="l24.11">                       public nsICommandLineHandler,</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-                      public nsIContentHandler</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-public:</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+                      public nsIContentHandler {</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+ public:</span>
<a href="#l24.18"></a><span id="l24.18">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l24.19"></a><span id="l24.19">   NS_DECL_NSINNTPSERVICE</span>
<a href="#l24.20"></a><span id="l24.20">   NS_DECL_NSIMSGMESSAGESERVICE</span>
<a href="#l24.21"></a><span id="l24.21">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l24.22"></a><span id="l24.22">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l24.23"></a><span id="l24.23">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l24.24"></a><span id="l24.24">   NS_DECL_NSIMSGMESSAGEFETCHPARTSERVICE</span>
<a href="#l24.25"></a><span id="l24.25">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l24.26"></a><span id="l24.26"> </span>
<a href="#l24.27"></a><span id="l24.27">   // nsNntpService</span>
<a href="#l24.28"></a><span id="l24.28">   nsNntpService();</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-protected:</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+ protected:</span>
<a href="#l24.32"></a><span id="l24.32">   virtual ~nsNntpService();</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  nsresult GetNntpServerByAccount(const char *aAccountKey, nsIMsgIncomingServer **aNntpServer);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  nsresult GetNntpServerByAccount(const char *aAccountKey,</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+                                  nsIMsgIncomingServer **aNntpServer);</span>
<a href="#l24.37"></a><span id="l24.37">   nsresult SetUpNntpUrlForPosting(const char *aAccountKey, char **newsUrlSpec);</span>
<a href="#l24.38"></a><span id="l24.38">   nsresult FindHostFromGroup(nsCString &amp;host, nsCString &amp;groupName);</span>
<a href="#l24.39"></a><span id="l24.39">   nsresult FindServerWithNewsgroup(nsCString &amp;host, nsCString &amp;groupName);</span>
<a href="#l24.40"></a><span id="l24.40"> </span>
<a href="#l24.41"></a><span id="l24.41">   nsresult CreateMessageIDURL(nsIMsgFolder *folder, nsMsgKey key, char **url);</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-  nsresult GetMessageFromUrl(nsIURI *aUrl, nsIMsgWindow *aMsgWindow, nsISupports *aDisplayConsumer);</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+  nsresult GetMessageFromUrl(nsIURI *aUrl, nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+                             nsISupports *aDisplayConsumer);</span>
<a href="#l24.45"></a><span id="l24.45">   // a convenience routine used to put together news urls</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-  nsresult ConstructNntpUrl(const char * urlString, nsIUrlListener *aUrlListener,  nsIMsgWindow * aMsgWindow, const char *originalMessageUri, int32_t action, nsIURI ** aUrl);</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-  nsresult CreateNewsAccount(const char *aHostname, bool aIsSecure, int32_t aPort, nsIMsgIncomingServer **aServer);</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+  nsresult ConstructNntpUrl(const char *urlString, nsIUrlListener *aUrlListener,</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+                            const char *originalMessageUri, int32_t action,</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+                            nsIURI **aUrl);</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+  nsresult CreateNewsAccount(const char *aHostname, bool aIsSecure,</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+                             int32_t aPort, nsIMsgIncomingServer **aServer);</span>
<a href="#l24.54"></a><span id="l24.54">   nsresult GetServerForUri(nsIURI *aUri, nsINntpIncomingServer **aProtocol);</span>
<a href="#l24.55"></a><span id="l24.55">   // a convenience routine to run news urls</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-  nsresult RunNewsUrl (nsIURI * aUrl, nsIMsgWindow *aMsgWindow, nsISupports * aConsumer);</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+  nsresult RunNewsUrl(nsIURI *aUrl, nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+                      nsISupports *aConsumer);</span>
<a href="#l24.59"></a><span id="l24.59">   // a convenience routine to go from folder uri to msg folder</span>
<a href="#l24.60"></a><span id="l24.60">   nsresult GetFolderFromUri(const char *uri, nsIMsgFolder **folder);</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-  nsresult DecomposeNewsMessageURI(const char * aMessageURI, nsIMsgFolder ** aFolder, nsMsgKey *aMsgKey);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+  nsresult DecomposeNewsMessageURI(const char *aMessageURI,</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+                                   nsIMsgFolder **aFolder, nsMsgKey *aMsgKey);</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-  bool              mPrintingOperation; // Flag for printing operations</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-  bool        mOpenAttachmentOperation; // Flag for opening attachments</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+  bool mPrintingOperation;        // Flag for printing operations</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+  bool mOpenAttachmentOperation;  // Flag for opening attachments</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  nsCOMPtr&lt;nsICacheStorage&gt; mCacheStorage; // the cache storage used by news</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+  nsCOMPtr&lt;nsICacheStorage&gt; mCacheStorage;  // the cache storage used by news</span>
<a href="#l24.72"></a><span id="l24.72"> };</span>
<a href="#l24.73"></a><span id="l24.73"> </span>
<a href="#l24.74"></a><span id="l24.74"> #endif /* nsNntpService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l25.5"></a><span id="l25.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12"> #include &quot;nsNntpUrl.h&quot;</span>
<a href="#l25.13"></a><span id="l25.13"> </span>
<a href="#l25.14"></a><span id="l25.14"> #include &quot;nsString.h&quot;</span>
<a href="#l25.15"></a><span id="l25.15"> #include &quot;nsNewsUtils.h&quot;</span>
<a href="#l25.16"></a><span id="l25.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> #include &quot;nntpCore.h&quot;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineat">@@ -18,40 +18,36 @@</span>
<a href="#l25.20"></a><span id="l25.20"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l25.21"></a><span id="l25.21"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l25.22"></a><span id="l25.22"> #include &quot;nsIMsgNewsFolder.h&quot;</span>
<a href="#l25.23"></a><span id="l25.23"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l25.24"></a><span id="l25.24"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l25.25"></a><span id="l25.25"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l25.26"></a><span id="l25.26"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-nsNntpUrl::nsNntpUrl()</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-{</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+nsNntpUrl::nsNntpUrl() {</span>
<a href="#l25.32"></a><span id="l25.32">   m_newsgroupPost = nullptr;</span>
<a href="#l25.33"></a><span id="l25.33">   m_newsAction = nsINntpUrl::ActionUnknown;</span>
<a href="#l25.34"></a><span id="l25.34">   m_addDummyEnvelope = false;</span>
<a href="#l25.35"></a><span id="l25.35">   m_canonicalLineEnding = false;</span>
<a href="#l25.36"></a><span id="l25.36">   m_filePath = nullptr;</span>
<a href="#l25.37"></a><span id="l25.37">   m_getOldMessages = false;</span>
<a href="#l25.38"></a><span id="l25.38">   m_key = nsMsgKey_None;</span>
<a href="#l25.39"></a><span id="l25.39"> }</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-nsNntpUrl::~nsNntpUrl()</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-{</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-}</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+nsNntpUrl::~nsNntpUrl() {}</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46"> NS_IMPL_ADDREF_INHERITED(nsNntpUrl, nsMsgMailNewsUrl)</span>
<a href="#l25.47"></a><span id="l25.47"> NS_IMPL_RELEASE_INHERITED(nsNntpUrl, nsMsgMailNewsUrl)</span>
<a href="#l25.48"></a><span id="l25.48"> </span>
<a href="#l25.49"></a><span id="l25.49"> NS_INTERFACE_MAP_BEGIN(nsNntpUrl)</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsINntpUrl)</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsINntpUrl)</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMsgMessageUrl)</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMsgI18NUrl)</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsINntpUrl)</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsINntpUrl)</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMsgMessageUrl)</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMsgI18NUrl)</span>
<a href="#l25.58"></a><span id="l25.58"> NS_INTERFACE_MAP_END_INHERITING(nsMsgMailNewsUrl)</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l25.61"></a><span id="l25.61"> // Begin nsINntpUrl specific support</span>
<a href="#l25.62"></a><span id="l25.62"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l25.63"></a><span id="l25.63"> </span>
<a href="#l25.64"></a><span id="l25.64"> /* News URI parsing explanation:</span>
<a href="#l25.65"></a><span id="l25.65">  * We support 3 different news URI schemes, essentially boiling down to 8</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineat">@@ -65,510 +61,449 @@ NS_INTERFACE_MAP_END_INHERITING(nsMsgMai</span>
<a href="#l25.67"></a><span id="l25.67">  * nntp://host/group/key</span>
<a href="#l25.68"></a><span id="l25.68">  * news-message://host/group#key</span>
<a href="#l25.69"></a><span id="l25.69">  *</span>
<a href="#l25.70"></a><span id="l25.70">  * In addition, we use queries on the news URIs with authorities for internal</span>
<a href="#l25.71"></a><span id="l25.71">  * NNTP processing. The most important one is ?group=group&amp;key=key, for cache</span>
<a href="#l25.72"></a><span id="l25.72">  * canonicalization.</span>
<a href="#l25.73"></a><span id="l25.73">  */</span>
<a href="#l25.74"></a><span id="l25.74"> </span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-nsresult nsNntpUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-{</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+nsresult nsNntpUrl::SetSpecInternal(const nsACString &amp;aSpec) {</span>
<a href="#l25.78"></a><span id="l25.78">   // For [s]news: URIs, we need to munge the spec if it is no authority, because</span>
<a href="#l25.79"></a><span id="l25.79">   // the URI parser guesses the wrong thing otherwise</span>
<a href="#l25.80"></a><span id="l25.80">   nsCString parseSpec(aSpec);</span>
<a href="#l25.81"></a><span id="l25.81">   int32_t colon = parseSpec.Find(&quot;:&quot;);</span>
<a href="#l25.82"></a><span id="l25.82"> </span>
<a href="#l25.83"></a><span id="l25.83">   // Our smallest scheme is 4 characters long, so colon must be at least 4</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-  if (colon &lt; 4 || colon + 1 == (int32_t) parseSpec.Length())</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+  if (colon &lt; 4 || colon + 1 == (int32_t)parseSpec.Length())</span>
<a href="#l25.86"></a><span id="l25.86">     return NS_ERROR_MALFORMED_URI;</span>
<a href="#l25.87"></a><span id="l25.87"> </span>
<a href="#l25.88"></a><span id="l25.88">   if (Substring(parseSpec, colon - 4, 4).EqualsLiteral(&quot;news&quot;) &amp;&amp;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-      parseSpec[colon + 1] != '/')</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-  {</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+      parseSpec[colon + 1] != '/') {</span>
<a href="#l25.92"></a><span id="l25.92">     // To make this parse properly, we add in three slashes, which convinces the</span>
<a href="#l25.93"></a><span id="l25.93">     // parser that the authority component is empty.</span>
<a href="#l25.94"></a><span id="l25.94">     parseSpec = Substring(aSpec, 0, colon + 1);</span>
<a href="#l25.95"></a><span id="l25.95">     parseSpec.AppendLiteral(&quot;///&quot;);</span>
<a href="#l25.96"></a><span id="l25.96">     parseSpec += Substring(aSpec, colon + 1);</span>
<a href="#l25.97"></a><span id="l25.97">   }</span>
<a href="#l25.98"></a><span id="l25.98"> </span>
<a href="#l25.99"></a><span id="l25.99">   nsresult rv = nsMsgMailNewsUrl::SetSpecInternal(parseSpec);</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.102"></a><span id="l25.102"> </span>
<a href="#l25.103"></a><span id="l25.103">   nsAutoCString scheme;</span>
<a href="#l25.104"></a><span id="l25.104">   rv = GetScheme(scheme);</span>
<a href="#l25.105"></a><span id="l25.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.106"></a><span id="l25.106"> </span>
<a href="#l25.107"></a><span id="l25.107">   if (scheme.EqualsLiteral(&quot;news&quot;) || scheme.EqualsLiteral(&quot;snews&quot;))</span>
<a href="#l25.108"></a><span id="l25.108">     rv = ParseNewsURL();</span>
<a href="#l25.109"></a><span id="l25.109">   else if (scheme.EqualsLiteral(&quot;nntp&quot;) || scheme.EqualsLiteral(&quot;nntps&quot;))</span>
<a href="#l25.110"></a><span id="l25.110">     rv = ParseNntpURL();</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-  else if (scheme.EqualsLiteral(&quot;news-message&quot;))</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-  {</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+  else if (scheme.EqualsLiteral(&quot;news-message&quot;)) {</span>
<a href="#l25.114"></a><span id="l25.114">     nsAutoCString spec;</span>
<a href="#l25.115"></a><span id="l25.115">     rv = GetSpec(spec);</span>
<a href="#l25.116"></a><span id="l25.116">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.117"></a><span id="l25.117">     rv = nsParseNewsMessageURI(spec.get(), m_group, &amp;m_key);</span>
<a href="#l25.118"></a><span id="l25.118">     NS_ENSURE_SUCCESS(rv, NS_ERROR_MALFORMED_URI);</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-  }</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-  else</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+  } else</span>
<a href="#l25.122"></a><span id="l25.122">     return NS_ERROR_MALFORMED_URI;</span>
<a href="#l25.123"></a><span id="l25.123">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.124"></a><span id="l25.124"> </span>
<a href="#l25.125"></a><span id="l25.125">   rv = DetermineNewsAction();</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.128"></a><span id="l25.128">   return rv;</span>
<a href="#l25.129"></a><span id="l25.129"> }</span>
<a href="#l25.130"></a><span id="l25.130"> </span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-nsresult nsNntpUrl::ParseNewsURL()</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-{</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+nsresult nsNntpUrl::ParseNewsURL() {</span>
<a href="#l25.134"></a><span id="l25.134">   // The path here is the group/msgid portion</span>
<a href="#l25.135"></a><span id="l25.135">   nsAutoCString path;</span>
<a href="#l25.136"></a><span id="l25.136">   nsresult rv = GetFilePath(path);</span>
<a href="#l25.137"></a><span id="l25.137">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.138"></a><span id="l25.138"> </span>
<a href="#l25.139"></a><span id="l25.139">   // Drop the potential beginning from the path</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-  if (path.Length() &amp;&amp; path[0] == '/')</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-    path = Substring(path, 1);</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+  if (path.Length() &amp;&amp; path[0] == '/') path = Substring(path, 1);</span>
<a href="#l25.143"></a><span id="l25.143"> </span>
<a href="#l25.144"></a><span id="l25.144">   // The presence of an `@' is a sign we have a msgid</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineminus">-  if (path.Find(&quot;@&quot;) != -1 || path.Find(&quot;%40&quot;) != -1)</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-  {</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+  if (path.Find(&quot;@&quot;) != -1 || path.Find(&quot;%40&quot;) != -1) {</span>
<a href="#l25.148"></a><span id="l25.148">     MsgUnescapeString(path, 0, m_messageID);</span>
<a href="#l25.149"></a><span id="l25.149"> </span>
<a href="#l25.150"></a><span id="l25.150">     // Set group, key for ?group=foo&amp;key=123 uris</span>
<a href="#l25.151"></a><span id="l25.151">     nsAutoCString spec;</span>
<a href="#l25.152"></a><span id="l25.152">     rv = GetSpec(spec);</span>
<a href="#l25.153"></a><span id="l25.153">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineminus">-    int32_t groupPos = spec.Find(kNewsURIGroupQuery); // find ?group=</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-    int32_t keyPos   = spec.Find(kNewsURIKeyQuery);   // find &amp;key=</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-    if (groupPos != kNotFound &amp;&amp; keyPos != kNotFound)</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-    {</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+    int32_t groupPos = spec.Find(kNewsURIGroupQuery);  // find ?group=</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+    int32_t keyPos = spec.Find(kNewsURIKeyQuery);      // find &amp;key=</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+    if (groupPos != kNotFound &amp;&amp; keyPos != kNotFound) {</span>
<a href="#l25.161"></a><span id="l25.161">       // get group name and message key</span>
<a href="#l25.162"></a><span id="l25.162">       m_group = Substring(spec, groupPos + kNewsURIGroupQueryLen,</span>
<a href="#l25.163"></a><span id="l25.163">                           keyPos - groupPos - kNewsURIGroupQueryLen);</span>
<a href="#l25.164"></a><span id="l25.164">       nsCString keyStr(Substring(spec, keyPos + kNewsURIKeyQueryLen));</span>
<a href="#l25.165"></a><span id="l25.165">       m_key = keyStr.ToInteger(&amp;rv, 10);</span>
<a href="#l25.166"></a><span id="l25.166">       NS_ENSURE_SUCCESS(rv, NS_ERROR_MALFORMED_URI);</span>
<a href="#l25.167"></a><span id="l25.167">     }</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineminus">-  }</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-  else</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineplus">+  } else</span>
<a href="#l25.171"></a><span id="l25.171">     MsgUnescapeString(path, 0, m_group);</span>
<a href="#l25.172"></a><span id="l25.172"> </span>
<a href="#l25.173"></a><span id="l25.173">   return NS_OK;</span>
<a href="#l25.174"></a><span id="l25.174"> }</span>
<a href="#l25.175"></a><span id="l25.175"> </span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-nsresult nsNntpUrl::ParseNntpURL()</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-{</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+nsresult nsNntpUrl::ParseNntpURL() {</span>
<a href="#l25.179"></a><span id="l25.179">   nsAutoCString path;</span>
<a href="#l25.180"></a><span id="l25.180">   nsresult rv = GetFilePath(path);</span>
<a href="#l25.181"></a><span id="l25.181">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.182"></a><span id="l25.182"> </span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-  if (path.Length() &gt; 0 &amp;&amp; path[0] == '/')</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-    path = Substring(path, 1);</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+  if (path.Length() &gt; 0 &amp;&amp; path[0] == '/') path = Substring(path, 1);</span>
<a href="#l25.186"></a><span id="l25.186"> </span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-  if (path.IsEmpty())</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-    return NS_ERROR_MALFORMED_URI;</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineplus">+  if (path.IsEmpty()) return NS_ERROR_MALFORMED_URI;</span>
<a href="#l25.190"></a><span id="l25.190"> </span>
<a href="#l25.191"></a><span id="l25.191">   int32_t slash = path.FindChar('/');</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineminus">-  if (slash == -1)</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineminus">-  {</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+  if (slash == -1) {</span>
<a href="#l25.195"></a><span id="l25.195">     m_group = path;</span>
<a href="#l25.196"></a><span id="l25.196">     m_key = nsMsgKey_None;</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-  }</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-  else</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineminus">-  {</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineplus">+  } else {</span>
<a href="#l25.201"></a><span id="l25.201">     m_group = Substring(path, 0, slash);</span>
<a href="#l25.202"></a><span id="l25.202">     nsAutoCString keyStr;</span>
<a href="#l25.203"></a><span id="l25.203">     keyStr = Substring(path, slash + 1);</span>
<a href="#l25.204"></a><span id="l25.204">     m_key = keyStr.ToInteger(&amp;rv, 10);</span>
<a href="#l25.205"></a><span id="l25.205">     NS_ENSURE_SUCCESS(rv, NS_ERROR_MALFORMED_URI);</span>
<a href="#l25.206"></a><span id="l25.206"> </span>
<a href="#l25.207"></a><span id="l25.207">     // Keys must be at least one</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineminus">-    if (m_key == 0)</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-      return NS_ERROR_MALFORMED_URI;</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineplus">+    if (m_key == 0) return NS_ERROR_MALFORMED_URI;</span>
<a href="#l25.211"></a><span id="l25.211">   }</span>
<a href="#l25.212"></a><span id="l25.212"> </span>
<a href="#l25.213"></a><span id="l25.213">   return NS_OK;</span>
<a href="#l25.214"></a><span id="l25.214"> }</span>
<a href="#l25.215"></a><span id="l25.215"> </span>
<a href="#l25.216"></a><span id="l25.216" class="difflineminus">-nsresult nsNntpUrl::DetermineNewsAction()</span>
<a href="#l25.217"></a><span id="l25.217" class="difflineminus">-{</span>
<a href="#l25.218"></a><span id="l25.218" class="difflineplus">+nsresult nsNntpUrl::DetermineNewsAction() {</span>
<a href="#l25.219"></a><span id="l25.219">   nsAutoCString path;</span>
<a href="#l25.220"></a><span id="l25.220">   nsresult rv = nsMsgMailNewsUrl::GetPathQueryRef(path);</span>
<a href="#l25.221"></a><span id="l25.221" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.222"></a><span id="l25.222" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.223"></a><span id="l25.223"> </span>
<a href="#l25.224"></a><span id="l25.224">   nsAutoCString query;</span>
<a href="#l25.225"></a><span id="l25.225">   rv = GetQuery(query);</span>
<a href="#l25.226"></a><span id="l25.226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.227"></a><span id="l25.227"> </span>
<a href="#l25.228"></a><span id="l25.228" class="difflineminus">-  if (query.EqualsLiteral(&quot;cancel&quot;))</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineminus">-  {</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineplus">+  if (query.EqualsLiteral(&quot;cancel&quot;)) {</span>
<a href="#l25.231"></a><span id="l25.231">     m_newsAction = nsINntpUrl::ActionCancelArticle;</span>
<a href="#l25.232"></a><span id="l25.232">     return NS_OK;</span>
<a href="#l25.233"></a><span id="l25.233">   }</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineminus">-  if (query.EqualsLiteral(&quot;list-ids&quot;))</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineminus">-  {</span>
<a href="#l25.236"></a><span id="l25.236" class="difflineplus">+  if (query.EqualsLiteral(&quot;list-ids&quot;)) {</span>
<a href="#l25.237"></a><span id="l25.237">     m_newsAction = nsINntpUrl::ActionListIds;</span>
<a href="#l25.238"></a><span id="l25.238">     return NS_OK;</span>
<a href="#l25.239"></a><span id="l25.239">   }</span>
<a href="#l25.240"></a><span id="l25.240" class="difflineminus">-  if (query.EqualsLiteral(&quot;newgroups&quot;))</span>
<a href="#l25.241"></a><span id="l25.241" class="difflineminus">-  {</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineplus">+  if (query.EqualsLiteral(&quot;newgroups&quot;)) {</span>
<a href="#l25.243"></a><span id="l25.243">     m_newsAction = nsINntpUrl::ActionListNewGroups;</span>
<a href="#l25.244"></a><span id="l25.244">     return NS_OK;</span>
<a href="#l25.245"></a><span id="l25.245">   }</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineminus">-  if (StringBeginsWith(query, NS_LITERAL_CSTRING(&quot;search&quot;)))</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineminus">-  {</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineplus">+  if (StringBeginsWith(query, NS_LITERAL_CSTRING(&quot;search&quot;))) {</span>
<a href="#l25.249"></a><span id="l25.249">     m_newsAction = nsINntpUrl::ActionSearch;</span>
<a href="#l25.250"></a><span id="l25.250">     return NS_OK;</span>
<a href="#l25.251"></a><span id="l25.251">   }</span>
<a href="#l25.252"></a><span id="l25.252">   if (StringBeginsWith(query, NS_LITERAL_CSTRING(&quot;part=&quot;)) ||</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineminus">-      query.Find(&quot;&amp;part=&quot;) &gt; 0)</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-  {</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineplus">+      query.Find(&quot;&amp;part=&quot;) &gt; 0) {</span>
<a href="#l25.256"></a><span id="l25.256">     // news://news.mozilla.org:119/3B98D201.3020100%40cs.com?part=1</span>
<a href="#l25.257"></a><span id="l25.257">     // news://news.mozilla.org:119/b58dme%24aia2%40ripley.netscape.com?header=print&amp;part=1.2&amp;type=image/jpeg&amp;filename=Pole.jpg</span>
<a href="#l25.258"></a><span id="l25.258">     m_newsAction = nsINntpUrl::ActionFetchPart;</span>
<a href="#l25.259"></a><span id="l25.259">     return NS_OK;</span>
<a href="#l25.260"></a><span id="l25.260">   }</span>
<a href="#l25.261"></a><span id="l25.261"> </span>
<a href="#l25.262"></a><span id="l25.262" class="difflineminus">-  if (!m_messageID.IsEmpty() || m_key != nsMsgKey_None)</span>
<a href="#l25.263"></a><span id="l25.263" class="difflineminus">-  {</span>
<a href="#l25.264"></a><span id="l25.264" class="difflineplus">+  if (!m_messageID.IsEmpty() || m_key != nsMsgKey_None) {</span>
<a href="#l25.265"></a><span id="l25.265">     m_newsAction = nsINntpUrl::ActionFetchArticle;</span>
<a href="#l25.266"></a><span id="l25.266">     return NS_OK;</span>
<a href="#l25.267"></a><span id="l25.267">   }</span>
<a href="#l25.268"></a><span id="l25.268"> </span>
<a href="#l25.269"></a><span id="l25.269" class="difflineminus">-  if (m_group.Find(&quot;*&quot;) &gt;= 0)</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineminus">-  {</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineplus">+  if (m_group.Find(&quot;*&quot;) &gt;= 0) {</span>
<a href="#l25.272"></a><span id="l25.272">     // If the group is a wildmat, list groups instead of grabbing a group.</span>
<a href="#l25.273"></a><span id="l25.273">     m_newsAction = nsINntpUrl::ActionListGroups;</span>
<a href="#l25.274"></a><span id="l25.274">     return NS_OK;</span>
<a href="#l25.275"></a><span id="l25.275">   }</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-  if (!m_group.IsEmpty())</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineminus">-  {</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineplus">+  if (!m_group.IsEmpty()) {</span>
<a href="#l25.279"></a><span id="l25.279">     m_newsAction = nsINntpUrl::ActionGetNewNews;</span>
<a href="#l25.280"></a><span id="l25.280">     return NS_OK;</span>
<a href="#l25.281"></a><span id="l25.281">   }</span>
<a href="#l25.282"></a><span id="l25.282"> </span>
<a href="#l25.283"></a><span id="l25.283">   // At this point, we have a URI that contains neither a query, a group, nor a</span>
<a href="#l25.284"></a><span id="l25.284">   // message ID. Ergo, we don't know what it is.</span>
<a href="#l25.285"></a><span id="l25.285">   m_newsAction = nsINntpUrl::ActionUnknown;</span>
<a href="#l25.286"></a><span id="l25.286">   return NS_OK;</span>
<a href="#l25.287"></a><span id="l25.287"> }</span>
<a href="#l25.288"></a><span id="l25.288"> </span>
<a href="#l25.289"></a><span id="l25.289" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::SetGetOldMessages(bool aGetOldMessages)</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineminus">-{</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::SetGetOldMessages(bool aGetOldMessages) {</span>
<a href="#l25.292"></a><span id="l25.292">   m_getOldMessages = aGetOldMessages;</span>
<a href="#l25.293"></a><span id="l25.293">   return NS_OK;</span>
<a href="#l25.294"></a><span id="l25.294"> }</span>
<a href="#l25.295"></a><span id="l25.295"> </span>
<a href="#l25.296"></a><span id="l25.296" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetGetOldMessages(bool * aGetOldMessages)</span>
<a href="#l25.297"></a><span id="l25.297" class="difflineminus">-{</span>
<a href="#l25.298"></a><span id="l25.298" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetGetOldMessages(bool *aGetOldMessages) {</span>
<a href="#l25.299"></a><span id="l25.299">   NS_ENSURE_ARG(aGetOldMessages);</span>
<a href="#l25.300"></a><span id="l25.300">   *aGetOldMessages = m_getOldMessages;</span>
<a href="#l25.301"></a><span id="l25.301">   return NS_OK;</span>
<a href="#l25.302"></a><span id="l25.302"> }</span>
<a href="#l25.303"></a><span id="l25.303"> </span>
<a href="#l25.304"></a><span id="l25.304" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetNewsAction(nsNewsAction *aNewsAction)</span>
<a href="#l25.305"></a><span id="l25.305" class="difflineminus">-{</span>
<a href="#l25.306"></a><span id="l25.306" class="difflineminus">-  if (aNewsAction)</span>
<a href="#l25.307"></a><span id="l25.307" class="difflineminus">-    *aNewsAction = m_newsAction;</span>
<a href="#l25.308"></a><span id="l25.308" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetNewsAction(nsNewsAction *aNewsAction) {</span>
<a href="#l25.309"></a><span id="l25.309" class="difflineplus">+  if (aNewsAction) *aNewsAction = m_newsAction;</span>
<a href="#l25.310"></a><span id="l25.310">   return NS_OK;</span>
<a href="#l25.311"></a><span id="l25.311"> }</span>
<a href="#l25.312"></a><span id="l25.312"> </span>
<a href="#l25.313"></a><span id="l25.313" class="difflineminus">-</span>
<a href="#l25.314"></a><span id="l25.314" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::SetNewsAction(nsNewsAction aNewsAction)</span>
<a href="#l25.315"></a><span id="l25.315" class="difflineminus">-{</span>
<a href="#l25.316"></a><span id="l25.316" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::SetNewsAction(nsNewsAction aNewsAction) {</span>
<a href="#l25.317"></a><span id="l25.317">   m_newsAction = aNewsAction;</span>
<a href="#l25.318"></a><span id="l25.318">   return NS_OK;</span>
<a href="#l25.319"></a><span id="l25.319"> }</span>
<a href="#l25.320"></a><span id="l25.320"> </span>
<a href="#l25.321"></a><span id="l25.321" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetGroup(nsACString &amp;group)</span>
<a href="#l25.322"></a><span id="l25.322" class="difflineminus">-{</span>
<a href="#l25.323"></a><span id="l25.323" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetGroup(nsACString &amp;group) {</span>
<a href="#l25.324"></a><span id="l25.324">   group = m_group;</span>
<a href="#l25.325"></a><span id="l25.325">   return NS_OK;</span>
<a href="#l25.326"></a><span id="l25.326"> }</span>
<a href="#l25.327"></a><span id="l25.327"> </span>
<a href="#l25.328"></a><span id="l25.328" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetMessageID(nsACString &amp;messageID)</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineminus">-{</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetMessageID(nsACString &amp;messageID) {</span>
<a href="#l25.331"></a><span id="l25.331">   messageID = m_messageID;</span>
<a href="#l25.332"></a><span id="l25.332">   return NS_OK;</span>
<a href="#l25.333"></a><span id="l25.333"> }</span>
<a href="#l25.334"></a><span id="l25.334"> </span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetKey(nsMsgKey *key)</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineminus">-{</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetKey(nsMsgKey *key) {</span>
<a href="#l25.338"></a><span id="l25.338">   NS_ENSURE_ARG_POINTER(key);</span>
<a href="#l25.339"></a><span id="l25.339">   *key = m_key;</span>
<a href="#l25.340"></a><span id="l25.340">   return NS_OK;</span>
<a href="#l25.341"></a><span id="l25.341"> }</span>
<a href="#l25.342"></a><span id="l25.342"> </span>
<a href="#l25.343"></a><span id="l25.343" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetNormalizedSpec(nsACString&amp; aPrincipalSpec)</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineminus">-{</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetNormalizedSpec(nsACString &amp;aPrincipalSpec) {</span>
<a href="#l25.346"></a><span id="l25.346">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l25.347"></a><span id="l25.347"> }</span>
<a href="#l25.348"></a><span id="l25.348"> </span>
<a href="#l25.349"></a><span id="l25.349" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::SetUri(const char * aURI)</span>
<a href="#l25.350"></a><span id="l25.350" class="difflineminus">-{</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::SetUri(const char *aURI) {</span>
<a href="#l25.352"></a><span id="l25.352">   mURI = aURI;</span>
<a href="#l25.353"></a><span id="l25.353">   return NS_OK;</span>
<a href="#l25.354"></a><span id="l25.354"> }</span>
<a href="#l25.355"></a><span id="l25.355"> </span>
<a href="#l25.356"></a><span id="l25.356"> // from nsIMsgMessageUrl</span>
<a href="#l25.357"></a><span id="l25.357" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetUri(char ** aURI)</span>
<a href="#l25.358"></a><span id="l25.358" class="difflineminus">-{</span>
<a href="#l25.359"></a><span id="l25.359" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetUri(char **aURI) {</span>
<a href="#l25.360"></a><span id="l25.360">   nsresult rv = NS_OK;</span>
<a href="#l25.361"></a><span id="l25.361"> </span>
<a href="#l25.362"></a><span id="l25.362">   // if we have been given a uri to associate with this url, then use it</span>
<a href="#l25.363"></a><span id="l25.363">   // otherwise try to reconstruct a URI on the fly....</span>
<a href="#l25.364"></a><span id="l25.364">   if (mURI.IsEmpty()) {</span>
<a href="#l25.365"></a><span id="l25.365">     nsAutoCString spec;</span>
<a href="#l25.366"></a><span id="l25.366">     rv = GetSpec(spec);</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.368"></a><span id="l25.368" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.369"></a><span id="l25.369">     mURI = spec;</span>
<a href="#l25.370"></a><span id="l25.370">   }</span>
<a href="#l25.371"></a><span id="l25.371"> </span>
<a href="#l25.372"></a><span id="l25.372">   *aURI = ToNewCString(mURI);</span>
<a href="#l25.373"></a><span id="l25.373">   if (!*aURI) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.374"></a><span id="l25.374">   return rv;</span>
<a href="#l25.375"></a><span id="l25.375"> }</span>
<a href="#l25.376"></a><span id="l25.376"> </span>
<a href="#l25.377"></a><span id="l25.377" class="difflineminus">-</span>
<a href="#l25.378"></a><span id="l25.378"> NS_IMPL_GETSET(nsNntpUrl, AddDummyEnvelope, bool, m_addDummyEnvelope)</span>
<a href="#l25.379"></a><span id="l25.379"> NS_IMPL_GETSET(nsNntpUrl, CanonicalLineEnding, bool, m_canonicalLineEnding)</span>
<a href="#l25.380"></a><span id="l25.380"> </span>
<a href="#l25.381"></a><span id="l25.381" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::SetMessageFile(nsIFile * aFile)</span>
<a href="#l25.382"></a><span id="l25.382" class="difflineminus">-{</span>
<a href="#l25.383"></a><span id="l25.383" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::SetMessageFile(nsIFile *aFile) {</span>
<a href="#l25.384"></a><span id="l25.384">   m_messageFile = aFile;</span>
<a href="#l25.385"></a><span id="l25.385">   return NS_OK;</span>
<a href="#l25.386"></a><span id="l25.386"> }</span>
<a href="#l25.387"></a><span id="l25.387"> </span>
<a href="#l25.388"></a><span id="l25.388" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetMessageFile(nsIFile ** aFile)</span>
<a href="#l25.389"></a><span id="l25.389" class="difflineminus">-{</span>
<a href="#l25.390"></a><span id="l25.390" class="difflineminus">-  if (aFile)</span>
<a href="#l25.391"></a><span id="l25.391" class="difflineminus">-    NS_IF_ADDREF(*aFile = m_messageFile);</span>
<a href="#l25.392"></a><span id="l25.392" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetMessageFile(nsIFile **aFile) {</span>
<a href="#l25.393"></a><span id="l25.393" class="difflineplus">+  if (aFile) NS_IF_ADDREF(*aFile = m_messageFile);</span>
<a href="#l25.394"></a><span id="l25.394">   return NS_OK;</span>
<a href="#l25.395"></a><span id="l25.395"> }</span>
<a href="#l25.396"></a><span id="l25.396"> </span>
<a href="#l25.397"></a><span id="l25.397"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l25.398"></a><span id="l25.398"> // End nsINntpUrl specific support</span>
<a href="#l25.399"></a><span id="l25.399"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l25.400"></a><span id="l25.400"> </span>
<a href="#l25.401"></a><span id="l25.401" class="difflineminus">-nsresult nsNntpUrl::SetMessageToPost(nsINNTPNewsgroupPost *post)</span>
<a href="#l25.402"></a><span id="l25.402" class="difflineminus">-{</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineplus">+nsresult nsNntpUrl::SetMessageToPost(nsINNTPNewsgroupPost *post) {</span>
<a href="#l25.404"></a><span id="l25.404">   m_newsgroupPost = post;</span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-  if (post)</span>
<a href="#l25.406"></a><span id="l25.406" class="difflineminus">-    SetNewsAction(nsINntpUrl::ActionPostArticle);</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineplus">+  if (post) SetNewsAction(nsINntpUrl::ActionPostArticle);</span>
<a href="#l25.408"></a><span id="l25.408">   return NS_OK;</span>
<a href="#l25.409"></a><span id="l25.409"> }</span>
<a href="#l25.410"></a><span id="l25.410"> </span>
<a href="#l25.411"></a><span id="l25.411" class="difflineminus">-nsresult nsNntpUrl::GetMessageToPost(nsINNTPNewsgroupPost **aPost)</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-{</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineplus">+nsresult nsNntpUrl::GetMessageToPost(nsINNTPNewsgroupPost **aPost) {</span>
<a href="#l25.414"></a><span id="l25.414">   NS_ENSURE_ARG_POINTER(aPost);</span>
<a href="#l25.415"></a><span id="l25.415">   NS_IF_ADDREF(*aPost = m_newsgroupPost);</span>
<a href="#l25.416"></a><span id="l25.416">   return NS_OK;</span>
<a href="#l25.417"></a><span id="l25.417"> }</span>
<a href="#l25.418"></a><span id="l25.418"> </span>
<a href="#l25.419"></a><span id="l25.419" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::SetMessageHeader(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l25.420"></a><span id="l25.420" class="difflineminus">-{</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::SetMessageHeader(nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l25.422"></a><span id="l25.422">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l25.423"></a><span id="l25.423"> }</span>
<a href="#l25.424"></a><span id="l25.424"> </span>
<a href="#l25.425"></a><span id="l25.425" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetMessageHeader(nsIMsgDBHdr ** aMsgHdr)</span>
<a href="#l25.426"></a><span id="l25.426" class="difflineminus">-{</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetMessageHeader(nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l25.428"></a><span id="l25.428">   nsresult rv;</span>
<a href="#l25.429"></a><span id="l25.429"> </span>
<a href="#l25.430"></a><span id="l25.430" class="difflineminus">-  nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l25.431"></a><span id="l25.431" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.432"></a><span id="l25.432" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l25.433"></a><span id="l25.433" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l25.434"></a><span id="l25.434" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.435"></a><span id="l25.435"> </span>
<a href="#l25.436"></a><span id="l25.436" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgService = do_QueryInterface(nntpService, &amp;rv);</span>
<a href="#l25.437"></a><span id="l25.437" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.438"></a><span id="l25.438" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService =</span>
<a href="#l25.439"></a><span id="l25.439" class="difflineplus">+      do_QueryInterface(nntpService, &amp;rv);</span>
<a href="#l25.440"></a><span id="l25.440" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.441"></a><span id="l25.441"> </span>
<a href="#l25.442"></a><span id="l25.442">   nsAutoCString spec(mOriginalSpec);</span>
<a href="#l25.443"></a><span id="l25.443">   if (spec.IsEmpty()) {</span>
<a href="#l25.444"></a><span id="l25.444">     // Handle the case where necko directly runs an internal news:// URL,</span>
<a href="#l25.445"></a><span id="l25.445">     // one that looks like news://host/message-id?group=mozilla.announce&amp;key=15</span>
<a href="#l25.446"></a><span id="l25.446">     // Other sorts of URLs -- e.g. news://host/message-id -- will not succeed.</span>
<a href="#l25.447"></a><span id="l25.447">     rv = GetSpec(spec);</span>
<a href="#l25.448"></a><span id="l25.448">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.449"></a><span id="l25.449">   }</span>
<a href="#l25.450"></a><span id="l25.450"> </span>
<a href="#l25.451"></a><span id="l25.451">   return msgService-&gt;MessageURIToMsgHdr(spec.get(), aMsgHdr);</span>
<a href="#l25.452"></a><span id="l25.452"> }</span>
<a href="#l25.453"></a><span id="l25.453"> </span>
<a href="#l25.454"></a><span id="l25.454" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::IsUrlType(uint32_t type, bool *isType)</span>
<a href="#l25.455"></a><span id="l25.455" class="difflineminus">-{</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::IsUrlType(uint32_t type, bool *isType) {</span>
<a href="#l25.457"></a><span id="l25.457">   NS_ENSURE_ARG(isType);</span>
<a href="#l25.458"></a><span id="l25.458"> </span>
<a href="#l25.459"></a><span id="l25.459" class="difflineminus">-  switch(type)</span>
<a href="#l25.460"></a><span id="l25.460" class="difflineminus">-  {</span>
<a href="#l25.461"></a><span id="l25.461" class="difflineplus">+  switch (type) {</span>
<a href="#l25.462"></a><span id="l25.462">     case nsIMsgMailNewsUrl::eDisplay:</span>
<a href="#l25.463"></a><span id="l25.463">       *isType = (m_newsAction == nsINntpUrl::ActionFetchArticle);</span>
<a href="#l25.464"></a><span id="l25.464">       break;</span>
<a href="#l25.465"></a><span id="l25.465">     default:</span>
<a href="#l25.466"></a><span id="l25.466">       *isType = false;</span>
<a href="#l25.467"></a><span id="l25.467">   };</span>
<a href="#l25.468"></a><span id="l25.468"> </span>
<a href="#l25.469"></a><span id="l25.469">   return NS_OK;</span>
<a href="#l25.470"></a><span id="l25.470" class="difflineminus">-</span>
<a href="#l25.471"></a><span id="l25.471"> }</span>
<a href="#l25.472"></a><span id="l25.472"> </span>
<a href="#l25.473"></a><span id="l25.473"> NS_IMETHODIMP</span>
<a href="#l25.474"></a><span id="l25.474" class="difflineminus">-nsNntpUrl::GetOriginalSpec(char **aSpec)</span>
<a href="#l25.475"></a><span id="l25.475" class="difflineminus">-{</span>
<a href="#l25.476"></a><span id="l25.476" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSpec);</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineminus">-    *aSpec = ToNewCString(mOriginalSpec);</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineminus">-    if (!*aSpec) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.479"></a><span id="l25.479" class="difflineminus">-    return NS_OK;</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineplus">+nsNntpUrl::GetOriginalSpec(char **aSpec) {</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSpec);</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineplus">+  *aSpec = ToNewCString(mOriginalSpec);</span>
<a href="#l25.483"></a><span id="l25.483" class="difflineplus">+  if (!*aSpec) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.484"></a><span id="l25.484" class="difflineplus">+  return NS_OK;</span>
<a href="#l25.485"></a><span id="l25.485"> }</span>
<a href="#l25.486"></a><span id="l25.486"> </span>
<a href="#l25.487"></a><span id="l25.487"> NS_IMETHODIMP</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineminus">-nsNntpUrl::SetOriginalSpec(const char *aSpec)</span>
<a href="#l25.489"></a><span id="l25.489" class="difflineminus">-{</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineminus">-    mOriginalSpec = aSpec;</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineminus">-    return NS_OK;</span>
<a href="#l25.492"></a><span id="l25.492" class="difflineplus">+nsNntpUrl::SetOriginalSpec(const char *aSpec) {</span>
<a href="#l25.493"></a><span id="l25.493" class="difflineplus">+  mOriginalSpec = aSpec;</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineplus">+  return NS_OK;</span>
<a href="#l25.495"></a><span id="l25.495"> }</span>
<a href="#l25.496"></a><span id="l25.496"> </span>
<a href="#l25.497"></a><span id="l25.497"> NS_IMETHODIMP</span>
<a href="#l25.498"></a><span id="l25.498" class="difflineminus">-nsNntpUrl::GetServer(nsIMsgIncomingServer **aServer)</span>
<a href="#l25.499"></a><span id="l25.499" class="difflineminus">-{</span>
<a href="#l25.500"></a><span id="l25.500" class="difflineplus">+nsNntpUrl::GetServer(nsIMsgIncomingServer **aServer) {</span>
<a href="#l25.501"></a><span id="l25.501">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l25.502"></a><span id="l25.502"> </span>
<a href="#l25.503"></a><span id="l25.503">   nsresult rv;</span>
<a href="#l25.504"></a><span id="l25.504">   nsAutoCString scheme, user, host;</span>
<a href="#l25.505"></a><span id="l25.505"> </span>
<a href="#l25.506"></a><span id="l25.506">   GetScheme(scheme);</span>
<a href="#l25.507"></a><span id="l25.507">   GetUsername(user);</span>
<a href="#l25.508"></a><span id="l25.508">   GetHost(host);</span>
<a href="#l25.509"></a><span id="l25.509"> </span>
<a href="#l25.510"></a><span id="l25.510">   // No authority -&gt; no server</span>
<a href="#l25.511"></a><span id="l25.511" class="difflineminus">-  if (host.IsEmpty())</span>
<a href="#l25.512"></a><span id="l25.512" class="difflineminus">-  {</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineplus">+  if (host.IsEmpty()) {</span>
<a href="#l25.514"></a><span id="l25.514">     *aServer = nullptr;</span>
<a href="#l25.515"></a><span id="l25.515">     return NS_OK;</span>
<a href="#l25.516"></a><span id="l25.516">   }</span>
<a href="#l25.517"></a><span id="l25.517"> </span>
<a href="#l25.518"></a><span id="l25.518">   // Looking up the server...</span>
<a href="#l25.519"></a><span id="l25.519">   // news-message is used purely internally, so it can never refer to the real</span>
<a href="#l25.520"></a><span id="l25.520">   // attribute. nntp is never used internally, so it probably refers to the real</span>
<a href="#l25.521"></a><span id="l25.521">   // one. news is used both internally and externally, so it could refer to</span>
<a href="#l25.522"></a><span id="l25.522">   // either one. We'll assume it's an internal one first, though.</span>
<a href="#l25.523"></a><span id="l25.523">   bool isNews = scheme.EqualsLiteral(&quot;news&quot;) || scheme.EqualsLiteral(&quot;snews&quot;);</span>
<a href="#l25.524"></a><span id="l25.524">   bool isNntp = scheme.EqualsLiteral(&quot;nntp&quot;) || scheme.EqualsLiteral(&quot;nntps&quot;);</span>
<a href="#l25.525"></a><span id="l25.525"> </span>
<a href="#l25.526"></a><span id="l25.526">   bool tryReal = isNntp;</span>
<a href="#l25.527"></a><span id="l25.527"> </span>
<a href="#l25.528"></a><span id="l25.528">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l25.529"></a><span id="l25.529" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.530"></a><span id="l25.530" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.531"></a><span id="l25.531">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.532"></a><span id="l25.532"> </span>
<a href="#l25.533"></a><span id="l25.533">   // Ignoring return results: it is perfectly acceptable for the server to not</span>
<a href="#l25.534"></a><span id="l25.534">   // exist, but FindServer (and not FindRealServer) throws NS_ERROR_UNEXPECTED</span>
<a href="#l25.535"></a><span id="l25.535">   // in this case.</span>
<a href="#l25.536"></a><span id="l25.536">   *aServer = nullptr;</span>
<a href="#l25.537"></a><span id="l25.537">   if (tryReal)</span>
<a href="#l25.538"></a><span id="l25.538">     accountManager-&gt;FindRealServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;), 0,</span>
<a href="#l25.539"></a><span id="l25.539" class="difflineminus">-      aServer);</span>
<a href="#l25.540"></a><span id="l25.540" class="difflineplus">+                                   aServer);</span>
<a href="#l25.541"></a><span id="l25.541">   else</span>
<a href="#l25.542"></a><span id="l25.542">     accountManager-&gt;FindServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;), aServer);</span>
<a href="#l25.543"></a><span id="l25.543" class="difflineminus">-  if (!*aServer &amp;&amp; (isNews || isNntp))</span>
<a href="#l25.544"></a><span id="l25.544" class="difflineminus">-  {</span>
<a href="#l25.545"></a><span id="l25.545" class="difflineplus">+  if (!*aServer &amp;&amp; (isNews || isNntp)) {</span>
<a href="#l25.546"></a><span id="l25.546">     // Didn't find it, try the other option</span>
<a href="#l25.547"></a><span id="l25.547">     if (tryReal)</span>
<a href="#l25.548"></a><span id="l25.548">       accountManager-&gt;FindServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l25.549"></a><span id="l25.549" class="difflineminus">-        aServer);</span>
<a href="#l25.550"></a><span id="l25.550" class="difflineplus">+                                 aServer);</span>
<a href="#l25.551"></a><span id="l25.551">     else</span>
<a href="#l25.552"></a><span id="l25.552">       accountManager-&gt;FindRealServer(user, host, NS_LITERAL_CSTRING(&quot;nntp&quot;), 0,</span>
<a href="#l25.553"></a><span id="l25.553" class="difflineminus">-        aServer);</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineplus">+                                     aServer);</span>
<a href="#l25.555"></a><span id="l25.555">   }</span>
<a href="#l25.556"></a><span id="l25.556">   return NS_OK;</span>
<a href="#l25.557"></a><span id="l25.557"> }</span>
<a href="#l25.558"></a><span id="l25.558"> </span>
<a href="#l25.559"></a><span id="l25.559" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetFolder(nsIMsgFolder **msgFolder)</span>
<a href="#l25.560"></a><span id="l25.560" class="difflineminus">-{</span>
<a href="#l25.561"></a><span id="l25.561" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetFolder(nsIMsgFolder **msgFolder) {</span>
<a href="#l25.562"></a><span id="l25.562">   NS_ENSURE_ARG_POINTER(msgFolder);</span>
<a href="#l25.563"></a><span id="l25.563"> </span>
<a href="#l25.564"></a><span id="l25.564">   nsresult rv;</span>
<a href="#l25.565"></a><span id="l25.565"> </span>
<a href="#l25.566"></a><span id="l25.566">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l25.567"></a><span id="l25.567">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l25.568"></a><span id="l25.568">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.569"></a><span id="l25.569"> </span>
<a href="#l25.570"></a><span id="l25.570">   // Need a server and a group to get the folder</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineminus">-  if (!server || m_group.IsEmpty())</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineminus">-  {</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineplus">+  if (!server || m_group.IsEmpty()) {</span>
<a href="#l25.574"></a><span id="l25.574">     *msgFolder = nullptr;</span>
<a href="#l25.575"></a><span id="l25.575">     return NS_OK;</span>
<a href="#l25.576"></a><span id="l25.576">   }</span>
<a href="#l25.577"></a><span id="l25.577"> </span>
<a href="#l25.578"></a><span id="l25.578">   // Find the group on the server</span>
<a href="#l25.579"></a><span id="l25.579">   nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l25.580"></a><span id="l25.580">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.581"></a><span id="l25.581"> </span>
<a href="#l25.582"></a><span id="l25.582">   bool hasGroup = false;</span>
<a href="#l25.583"></a><span id="l25.583">   rv = nntpServer-&gt;ContainsNewsgroup(m_group, &amp;hasGroup);</span>
<a href="#l25.584"></a><span id="l25.584">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.585"></a><span id="l25.585"> </span>
<a href="#l25.586"></a><span id="l25.586" class="difflineminus">-  if (!hasGroup)</span>
<a href="#l25.587"></a><span id="l25.587" class="difflineminus">-  {</span>
<a href="#l25.588"></a><span id="l25.588" class="difflineplus">+  if (!hasGroup) {</span>
<a href="#l25.589"></a><span id="l25.589">     *msgFolder = nullptr;</span>
<a href="#l25.590"></a><span id="l25.590">     return NS_OK;</span>
<a href="#l25.591"></a><span id="l25.591">   }</span>
<a href="#l25.592"></a><span id="l25.592"> </span>
<a href="#l25.593"></a><span id="l25.593">   nsCOMPtr&lt;nsIMsgNewsFolder&gt; newsFolder;</span>
<a href="#l25.594"></a><span id="l25.594">   rv = nntpServer-&gt;FindGroup(m_group, getter_AddRefs(newsFolder));</span>
<a href="#l25.595"></a><span id="l25.595">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.596"></a><span id="l25.596"> </span>
<a href="#l25.597"></a><span id="l25.597" class="difflineminus">-  return newsFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder), (void**)msgFolder);</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineplus">+  return newsFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder),</span>
<a href="#l25.599"></a><span id="l25.599" class="difflineplus">+                                    (void **)msgFolder);</span>
<a href="#l25.600"></a><span id="l25.600"> }</span>
<a href="#l25.601"></a><span id="l25.601"> </span>
<a href="#l25.602"></a><span id="l25.602"> NS_IMETHODIMP</span>
<a href="#l25.603"></a><span id="l25.603" class="difflineminus">-nsNntpUrl::GetFolderCharset(char **aCharacterSet)</span>
<a href="#l25.604"></a><span id="l25.604" class="difflineminus">-{</span>
<a href="#l25.605"></a><span id="l25.605" class="difflineplus">+nsNntpUrl::GetFolderCharset(char **aCharacterSet) {</span>
<a href="#l25.606"></a><span id="l25.606">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l25.607"></a><span id="l25.607">   nsresult rv = GetFolder(getter_AddRefs(folder));</span>
<a href="#l25.608"></a><span id="l25.608">   // don't assert here.  this can happen if there is no message folder</span>
<a href="#l25.609"></a><span id="l25.609">   // like when we display a news://host/message-id url</span>
<a href="#l25.610"></a><span id="l25.610" class="difflineminus">-  if (NS_FAILED(rv) || !folder)</span>
<a href="#l25.611"></a><span id="l25.611" class="difflineminus">-    return rv;</span>
<a href="#l25.612"></a><span id="l25.612" class="difflineplus">+  if (NS_FAILED(rv) || !folder) return rv;</span>
<a href="#l25.613"></a><span id="l25.613">   nsCString tmpStr;</span>
<a href="#l25.614"></a><span id="l25.614">   rv = folder-&gt;GetCharset(tmpStr);</span>
<a href="#l25.615"></a><span id="l25.615">   *aCharacterSet = ToNewCString(tmpStr);</span>
<a href="#l25.616"></a><span id="l25.616">   return rv;</span>
<a href="#l25.617"></a><span id="l25.617"> }</span>
<a href="#l25.618"></a><span id="l25.618"> </span>
<a href="#l25.619"></a><span id="l25.619" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetFolderCharsetOverride(bool * aCharacterSetOverride)</span>
<a href="#l25.620"></a><span id="l25.620" class="difflineminus">-{</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetFolderCharsetOverride(bool *aCharacterSetOverride) {</span>
<a href="#l25.622"></a><span id="l25.622">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l25.623"></a><span id="l25.623">   nsresult rv = GetFolder(getter_AddRefs(folder));</span>
<a href="#l25.624"></a><span id="l25.624" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.626"></a><span id="l25.626">   NS_ENSURE_TRUE(folder, NS_ERROR_FAILURE);</span>
<a href="#l25.627"></a><span id="l25.627">   rv = folder-&gt;GetCharsetOverride(aCharacterSetOverride);</span>
<a href="#l25.628"></a><span id="l25.628" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.629"></a><span id="l25.629" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.630"></a><span id="l25.630">   return rv;</span>
<a href="#l25.631"></a><span id="l25.631"> }</span>
<a href="#l25.632"></a><span id="l25.632"> </span>
<a href="#l25.633"></a><span id="l25.633" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::GetCharsetOverRide(char ** aCharacterSet)</span>
<a href="#l25.634"></a><span id="l25.634" class="difflineminus">-{</span>
<a href="#l25.635"></a><span id="l25.635" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::GetCharsetOverRide(char **aCharacterSet) {</span>
<a href="#l25.636"></a><span id="l25.636">   if (!mCharsetOverride.IsEmpty())</span>
<a href="#l25.637"></a><span id="l25.637">     *aCharacterSet = ToNewCString(mCharsetOverride);</span>
<a href="#l25.638"></a><span id="l25.638">   else</span>
<a href="#l25.639"></a><span id="l25.639">     *aCharacterSet = nullptr;</span>
<a href="#l25.640"></a><span id="l25.640">   return NS_OK;</span>
<a href="#l25.641"></a><span id="l25.641"> }</span>
<a href="#l25.642"></a><span id="l25.642"> </span>
<a href="#l25.643"></a><span id="l25.643" class="difflineminus">-NS_IMETHODIMP nsNntpUrl::SetCharsetOverRide(const char * aCharacterSet)</span>
<a href="#l25.644"></a><span id="l25.644" class="difflineminus">-{</span>
<a href="#l25.645"></a><span id="l25.645" class="difflineplus">+NS_IMETHODIMP nsNntpUrl::SetCharsetOverRide(const char *aCharacterSet) {</span>
<a href="#l25.646"></a><span id="l25.646">   mCharsetOverride = aCharacterSet;</span>
<a href="#l25.647"></a><span id="l25.647">   return NS_OK;</span>
<a href="#l25.648"></a><span id="l25.648"> }</span>
<a href="#l25.649"></a><span id="l25.649"> </span>
<a href="#l25.650"></a><span id="l25.650" class="difflineminus">-nsresult nsNntpUrl::Clone(nsIURI **_retval)</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineminus">-{</span>
<a href="#l25.652"></a><span id="l25.652" class="difflineplus">+nsresult nsNntpUrl::Clone(nsIURI **_retval) {</span>
<a href="#l25.653"></a><span id="l25.653">   nsresult rv;</span>
<a href="#l25.654"></a><span id="l25.654">   rv = nsMsgMailNewsUrl::Clone(_retval);</span>
<a href="#l25.655"></a><span id="l25.655">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.656"></a><span id="l25.656"> </span>
<a href="#l25.657"></a><span id="l25.657">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; newsurl = do_QueryInterface(*_retval, &amp;rv);</span>
<a href="#l25.658"></a><span id="l25.658">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.659"></a><span id="l25.659"> </span>
<a href="#l25.660"></a><span id="l25.660">   return newsurl-&gt;SetUri(mURI.get());</span>
<a href="#l25.661"></a><span id="l25.661"> }</span>
<a href="#l25.662"></a><span id="l25.662" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/news/src/nsNntpUrl.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpUrl.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -6,19 +6,21 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #ifndef nsNntpUrl_h__</span>
<a href="#l26.5"></a><span id="l26.5"> #define nsNntpUrl_h__</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> #include &quot;nsINntpUrl.h&quot;</span>
<a href="#l26.8"></a><span id="l26.8"> #include &quot;nsMsgMailNewsUrl.h&quot;</span>
<a href="#l26.9"></a><span id="l26.9"> #include &quot;nsINNTPNewsgroupPost.h&quot;</span>
<a href="#l26.10"></a><span id="l26.10"> #include &quot;nsIFile.h&quot;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-class nsNntpUrl : public nsINntpUrl, public nsMsgMailNewsUrl, public nsIMsgMessageUrl, public nsIMsgI18NUrl</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-public:</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+class nsNntpUrl : public nsINntpUrl,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+                  public nsMsgMailNewsUrl,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+                  public nsIMsgMessageUrl,</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+                  public nsIMsgI18NUrl {</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+ public:</span>
<a href="#l26.20"></a><span id="l26.20">   NS_DECL_NSINNTPURL</span>
<a href="#l26.21"></a><span id="l26.21">   NS_DECL_NSIMSGMESSAGEURL</span>
<a href="#l26.22"></a><span id="l26.22">   NS_DECL_NSIMSGI18NURL</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24">   // nsMsgMailNewsUrl overrides</span>
<a href="#l26.25"></a><span id="l26.25">   nsresult SetSpecInternal(const nsACString &amp;aSpec) override;</span>
<a href="#l26.26"></a><span id="l26.26">   nsresult Clone(nsIURI **_retval) override;</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28" class="difflineat">@@ -28,36 +30,37 @@ public:</span>
<a href="#l26.29"></a><span id="l26.29">   NS_IMETHOD GetServer(nsIMsgIncomingServer **server) override;</span>
<a href="#l26.30"></a><span id="l26.30">   NS_IMETHOD GetFolder(nsIMsgFolder **msgFolder) override;</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32">   // nsNntpUrl</span>
<a href="#l26.33"></a><span id="l26.33">   nsNntpUrl();</span>
<a href="#l26.34"></a><span id="l26.34"> </span>
<a href="#l26.35"></a><span id="l26.35">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l26.36"></a><span id="l26.36"> </span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-private:</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+ private:</span>
<a href="#l26.39"></a><span id="l26.39">   virtual ~nsNntpUrl();</span>
<a href="#l26.40"></a><span id="l26.40">   nsresult DetermineNewsAction();</span>
<a href="#l26.41"></a><span id="l26.41">   nsresult ParseNewsURL();</span>
<a href="#l26.42"></a><span id="l26.42">   nsresult ParseNntpURL();</span>
<a href="#l26.43"></a><span id="l26.43"> </span>
<a href="#l26.44"></a><span id="l26.44">   nsCOMPtr&lt;nsINNTPNewsgroupPost&gt; m_newsgroupPost;</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-  nsNewsAction m_newsAction; // the action this url represents...parse mailbox, display messages, etc.</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+  nsNewsAction m_newsAction;  // the action this url represents...parse mailbox,</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+                              // display messages, etc.</span>
<a href="#l26.48"></a><span id="l26.48"> </span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  nsCString mURI; // the RDF URI associated with this url.</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  nsCString mCharsetOverride; // used by nsIMsgI18NUrl...</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+  nsCString mURI;              // the RDF URI associated with this url.</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+  nsCString mCharsetOverride;  // used by nsIMsgI18NUrl...</span>
<a href="#l26.53"></a><span id="l26.53"> </span>
<a href="#l26.54"></a><span id="l26.54">   nsCString mOriginalSpec;</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  m_filePath;</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_filePath;</span>
<a href="#l26.57"></a><span id="l26.57"> </span>
<a href="#l26.58"></a><span id="l26.58">   // used by save message to disk</span>
<a href="#l26.59"></a><span id="l26.59">   nsCOMPtr&lt;nsIFile&gt; m_messageFile;</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-  bool          m_addDummyEnvelope;</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-  bool          m_canonicalLineEnding;</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  bool          m_getOldMessages;</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+  bool m_addDummyEnvelope;</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+  bool m_canonicalLineEnding;</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  bool m_getOldMessages;</span>
<a href="#l26.67"></a><span id="l26.67"> </span>
<a href="#l26.68"></a><span id="l26.68">   nsCString m_group;</span>
<a href="#l26.69"></a><span id="l26.69">   nsCString m_messageID;</span>
<a href="#l26.70"></a><span id="l26.70">   nsMsgKey m_key;</span>
<a href="#l26.71"></a><span id="l26.71"> };</span>
<a href="#l26.72"></a><span id="l26.72"> </span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-#endif // nsNntpUrl_h__</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+#endif  // nsNntpUrl_h__</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

