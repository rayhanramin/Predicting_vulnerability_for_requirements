<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12125:93e89494abfdb6f7589fffc5e204c315fa87f60d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 93e89494abfdb6f7589fffc5e204c315fa87f60d" />
<meta property="og:url" content="/comm-central/rev/93e89494abfdb6f7589fffc5e204c315fa87f60d" />
<meta property="og:description" content="Bug 834757 - Remove [noscript] from nsIMimeConverter, part 2: remove the last method. r=irving, sr=Neil." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 93e89494abfdb6f7589fffc5e204c315fa87f60d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/93e89494abfdb6f7589fffc5e204c315fa87f60d">shortlog</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/93e89494abfdb6f7589fffc5e204c315fa87f60d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d">files</a> |
changeset |
<a href="/comm-central/raw-rev/93e89494abfdb6f7589fffc5e204c315fa87f60d">raw</a>  | <a href="/comm-central/archive/93e89494abfdb6f7589fffc5e204c315fa87f60d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834757">Bug 834757</a> - Remove [noscript] from nsIMimeConverter, part 2: remove the last method. r=irving, sr=Neil.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 15 Mar 2013 12:10:48 -0500</td></tr>

<tr>
 <td>changeset 12125</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/93e89494abfdb6f7589fffc5e204c315fa87f60d">93e89494abfdb6f7589fffc5e204c315fa87f60d</a></td>
</tr>



<tr>
<td>parent 12124</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457</a>
</td>
</tr>

<tr>
<td>child 12126</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bf49737b12dcda93bd8a1d63888b6badfbc5b288">bf49737b12dcda93bd8a1d63888b6badfbc5b288</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=93e89494abfdb6f7589fffc5e204c315fa87f60d">8999</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 15 Mar 2013 18:19:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@93e89494abfd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=93e89494abfdb6f7589fffc5e204c315fa87f60d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=93e89494abfdb6f7589fffc5e204c315fa87f60d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93e89494abfdb6f7589fffc5e204c315fa87f60d&newProject=comm-central&newRevision=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93e89494abfdb6f7589fffc5e204c315fa87f60d&newProject=comm-central&newRevision=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93e89494abfdb6f7589fffc5e204c315fa87f60d&newProject=comm-central&newRevision=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834757">834757</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834757">Bug 834757</a> - Remove [noscript] from nsIMimeConverter, part 2: remove the last method. r=irving, sr=Neil.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsIMsgSearchTerm.idl">mailnews/base/search/public/nsIMsgSearchTerm.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsIMsgSearchTerm.idl">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsIMsgSearchTerm.idl">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsIMsgSearchTerm.idl">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsIMsgSearchTerm.idl">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsIMsgSearchTerm.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsMsgSearchTerm.h">mailnews/base/search/public/nsMsgSearchTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsMsgSearchTerm.h">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsMsgSearchTerm.h">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsMsgSearchTerm.h">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsMsgSearchTerm.h">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/public/nsMsgSearchTerm.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgLocalSearch.cpp">mailnews/base/search/src/nsMsgLocalSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgLocalSearch.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgLocalSearch.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgLocalSearch.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgLocalSearch.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgLocalSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsSmtpUrl.cpp">mailnews/compose/src/nsSmtpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsSmtpUrl.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsSmtpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsSmtpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsSmtpUrl.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/compose/src/nsSmtpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/extensions/newsblog/content/FeedItem.js">mailnews/extensions/newsblog/content/FeedItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/extensions/newsblog/content/FeedItem.js">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/extensions/newsblog/content/FeedItem.js">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/extensions/newsblog/content/FeedItem.js">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/extensions/newsblog/content/FeedItem.js">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/extensions/newsblog/content/FeedItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/public/nsIMimeConverter.idl">mailnews/mime/public/nsIMimeConverter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/public/nsIMimeConverter.idl">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/public/nsIMimeConverter.idl">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/public/nsIMimeConverter.idl">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/public/nsIMimeConverter.idl">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/public/nsIMimeConverter.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.cpp">mailnews/mime/src/comi18n.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.h">mailnews/mime/src/comi18n.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.h">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.h">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.h">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.h">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/comi18n.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimehdrs.cpp">mailnews/mime/src/mimehdrs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimehdrs.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimehdrs.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimehdrs.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimehdrs.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/mimehdrs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMimeConverter.cpp">mailnews/mime/src/nsMimeConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMimeConverter.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMimeConverter.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMimeConverter.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMimeConverter.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMimeConverter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMsgHeaderParser.cpp">mailnews/mime/src/nsMsgHeaderParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMsgHeaderParser.cpp">file</a> |
<a href="/comm-central/annotate/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMsgHeaderParser.cpp">annotate</a> |
<a href="/comm-central/diff/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMsgHeaderParser.cpp">diff</a> |
<a href="/comm-central/comparison/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMsgHeaderParser.cpp">comparison</a> |
<a href="/comm-central/log/93e89494abfdb6f7589fffc5e204c315fa87f60d/mailnews/mime/src/nsMsgHeaderParser.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchTerm.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchTerm.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsMsgSearchCore.idl&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIMsgSearchValue.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> interface nsIMsgDBHdr;</span>
<a href="#l1.9"></a><span id="l1.9"> interface nsIMsgDatabase;</span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIMsgSearchScopeTerm;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(dfd25cbe-2e86-4ff0-b78e-494bc65d344e)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(87bb55b0-fbd5-4f02-a0df-bd6f5519eba0)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgSearchTerm : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15">     attribute nsMsgSearchAttribValue attrib;</span>
<a href="#l1.16"></a><span id="l1.16">     attribute nsMsgSearchOpValue op;</span>
<a href="#l1.17"></a><span id="l1.17">     attribute nsIMsgSearchValue value;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">     attribute boolean booleanAnd;</span>
<a href="#l1.20"></a><span id="l1.20">     attribute ACString arbitraryHeader;</span>
<a href="#l1.21"></a><span id="l1.21">     /**</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -29,17 +29,24 @@ interface nsIMsgSearchTerm : nsISupports</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">     /// identifier for a custom id used for this term, if any.</span>
<a href="#l1.25"></a><span id="l1.25">     attribute ACString customId;</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">     attribute boolean beginsGrouping;</span>
<a href="#l1.28"></a><span id="l1.28">     attribute boolean endsGrouping;</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30">     boolean matchRfc822String(in string aString, in string charset, in boolean charsetOverride);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    boolean matchRfc2047String(in string aString, in string charset, in boolean charsetOverride);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    /**</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+     * Match the current header value against the incoming 2047-encoded string.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+     *</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+     * This method will first apply the nsIMimeConverter decoding to the string</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+     * (using the supplied parameters) and will then match the value against the</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+     * decoded result.</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+     */</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    boolean matchRfc2047String(in ACString aString, in string charset, in boolean charsetOverride);</span>
<a href="#l1.40"></a><span id="l1.40">     boolean matchDate(in PRTime aTime);</span>
<a href="#l1.41"></a><span id="l1.41">     boolean matchStatus(in unsigned long aStatus);</span>
<a href="#l1.42"></a><span id="l1.42">     boolean matchPriority(in nsMsgPriorityValue priority);</span>
<a href="#l1.43"></a><span id="l1.43">     boolean matchAge(in PRTime days);</span>
<a href="#l1.44"></a><span id="l1.44">     boolean matchSize(in unsigned long size);</span>
<a href="#l1.45"></a><span id="l1.45">     boolean matchLabel(in nsMsgLabelValue aLabelValue);</span>
<a href="#l1.46"></a><span id="l1.46">     boolean matchJunkStatus(in string aJunkScore);</span>
<a href="#l1.47"></a><span id="l1.47">     /*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -56,32 +56,32 @@ public:</span>
<a href="#l2.4"></a><span id="l2.4">   nsCString m_arbitraryHeader;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   // db hdr property name to use - used when m_attribute = HdrProperty.</span>
<a href="#l2.7"></a><span id="l2.7">   nsCString m_hdrProperty;</span>
<a href="#l2.8"></a><span id="l2.8">   bool m_matchAll; // does this term match all headers?</span>
<a href="#l2.9"></a><span id="l2.9">   nsCString m_customId; // id of custom search term</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> protected:</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  nsresult MatchString (const char *stringToMatch, const char *charset,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                          bool *pResult);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  nsresult MatchString(const nsACString &amp;stringToMatch, const char *charset,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                       bool *pResult);</span>
<a href="#l2.16"></a><span id="l2.16">   nsresult OutputValue(nsCString &amp;outputStr);</span>
<a href="#l2.17"></a><span id="l2.17">   nsresult ParseAttribute(char *inStream, nsMsgSearchAttribValue *attrib);</span>
<a href="#l2.18"></a><span id="l2.18">   nsresult ParseOperator(char *inStream, nsMsgSearchOpValue *value);</span>
<a href="#l2.19"></a><span id="l2.19">   nsresult ParseValue(char *inStream);</span>
<a href="#l2.20"></a><span id="l2.20">   nsresult InitHeaderAddressParser();</span>
<a href="#l2.21"></a><span id="l2.21">   /**</span>
<a href="#l2.22"></a><span id="l2.22">    * Switch a string to lower case, except for special database rows</span>
<a href="#l2.23"></a><span id="l2.23">    * that are not headers, but could be headers</span>
<a href="#l2.24"></a><span id="l2.24">    *</span>
<a href="#l2.25"></a><span id="l2.25">    * @param aValue  the string to switch</span>
<a href="#l2.26"></a><span id="l2.26">    */</span>
<a href="#l2.27"></a><span id="l2.27">   void ToLowerCaseExceptSpecials(nsACString &amp;aValue);</span>
<a href="#l2.28"></a><span id="l2.28">     nsresult InitializeAddressBook();</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-    nsresult MatchInAddressBook(const char * aAddress, bool *pResult);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  nsresult MatchInAddressBook(const nsACString &amp;aAddress, bool *pResult);</span>
<a href="#l2.31"></a><span id="l2.31">     // fields used by search in address book</span>
<a href="#l2.32"></a><span id="l2.32">     nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">     bool mBeginsGrouping;</span>
<a href="#l2.35"></a><span id="l2.35">     bool mEndsGrouping;</span>
<a href="#l2.36"></a><span id="l2.36"> };</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -440,20 +440,20 @@ nsresult nsMsgSearchOfflineMail::Process</span>
<a href="#l3.4"></a><span id="l3.4">       {</span>
<a href="#l3.5"></a><span id="l3.5">         msgToMatch-&gt;GetSubject(getter_Copies(matchString) /* , true */);</span>
<a href="#l3.6"></a><span id="l3.6">         if (msgFlags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l3.7"></a><span id="l3.7">         {</span>
<a href="#l3.8"></a><span id="l3.8">           // Make sure we pass along the &quot;Re: &quot; part of the subject if this is a reply.</span>
<a href="#l3.9"></a><span id="l3.9">           nsCString reString;</span>
<a href="#l3.10"></a><span id="l3.10">           reString.Assign(&quot;Re: &quot;);</span>
<a href="#l3.11"></a><span id="l3.11">           reString.Append(matchString);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          err = aTerm-&gt;MatchRfc2047String(reString.get(), charset, charsetOverride, &amp;result);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+          err = aTerm-&gt;MatchRfc2047String(reString, charset, charsetOverride, &amp;result);</span>
<a href="#l3.14"></a><span id="l3.14">         }</span>
<a href="#l3.15"></a><span id="l3.15">         else</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-          err = aTerm-&gt;MatchRfc2047String (matchString.get(), charset, charsetOverride, &amp;result);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+          err = aTerm-&gt;MatchRfc2047String(matchString, charset, charsetOverride, &amp;result);</span>
<a href="#l3.18"></a><span id="l3.18">         break;</span>
<a href="#l3.19"></a><span id="l3.19">       }</span>
<a href="#l3.20"></a><span id="l3.20">       case nsMsgSearchAttrib::ToOrCC:</span>
<a href="#l3.21"></a><span id="l3.21">       {</span>
<a href="#l3.22"></a><span id="l3.22">         bool boolKeepGoing;</span>
<a href="#l3.23"></a><span id="l3.23">         aTerm-&gt;GetMatchAllBeforeDeciding(&amp;boolKeepGoing);</span>
<a href="#l3.24"></a><span id="l3.24">         msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l3.25"></a><span id="l3.25">         err = aTerm-&gt;MatchRfc822String (recipients.get(), charset, charsetOverride, &amp;result);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -749,17 +749,17 @@ nsresult nsMsgSearchTerm::MatchArbitrary</span>
<a href="#l4.4"></a><span id="l4.4">                          m_operator == nsMsgSearchOp::EndsWith;</span>
<a href="#l4.5"></a><span id="l4.5">   // init result to what we want if we don't find the header at all</span>
<a href="#l4.6"></a><span id="l4.6">   bool result = !matchExpected;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   nsCString dbHdrValue;</span>
<a href="#l4.9"></a><span id="l4.9">   msg-&gt;GetStringProperty(m_arbitraryHeader.get(), getter_Copies(dbHdrValue));</span>
<a href="#l4.10"></a><span id="l4.10">   if (!dbHdrValue.IsEmpty())</span>
<a href="#l4.11"></a><span id="l4.11">     // match value with the other info.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    return MatchRfc2047String(dbHdrValue.get(), charset, charsetOverride, pResult);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    return MatchRfc2047String(dbHdrValue, charset, charsetOverride, pResult);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">   nsMsgBodyHandler * bodyHandler =</span>
<a href="#l4.16"></a><span id="l4.16">     new nsMsgBodyHandler (scope, length, msg, db, headers, headersSize,</span>
<a href="#l4.17"></a><span id="l4.17">                           ForFiltering);</span>
<a href="#l4.18"></a><span id="l4.18">   if (!bodyHandler)</span>
<a href="#l4.19"></a><span id="l4.19">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   bodyHandler-&gt;SetStripHeaders (false);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -786,17 +786,17 @@ nsresult nsMsgSearchTerm::MatchArbitrary</span>
<a href="#l4.23"></a><span id="l4.23">          (!headerFullValue.IsEmpty() &amp;&amp; !isReceivedHeader)))</span>
<a href="#l4.24"></a><span id="l4.24">     {</span>
<a href="#l4.25"></a><span id="l4.25">       // Make sure buf has info besides just the header.</span>
<a href="#l4.26"></a><span id="l4.26">       // Otherwise, it's either an empty header, or header not found.</span>
<a href="#l4.27"></a><span id="l4.27">       if (!headerFullValue.IsEmpty())</span>
<a href="#l4.28"></a><span id="l4.28">       {</span>
<a href="#l4.29"></a><span id="l4.29">         bool stringMatches;</span>
<a href="#l4.30"></a><span id="l4.30">         // match value with the other info.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-        err = MatchRfc2047String(headerFullValue.get(), charset, charsetOverride, &amp;stringMatches);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+        err = MatchRfc2047String(headerFullValue, charset, charsetOverride, &amp;stringMatches);</span>
<a href="#l4.33"></a><span id="l4.33">         if (matchExpected == stringMatches) // if we found a match</span>
<a href="#l4.34"></a><span id="l4.34">         {</span>
<a href="#l4.35"></a><span id="l4.35">           searchingHeaders = false;   // then stop examining the headers</span>
<a href="#l4.36"></a><span id="l4.36">           result = stringMatches;</span>
<a href="#l4.37"></a><span id="l4.37">         }</span>
<a href="#l4.38"></a><span id="l4.38">       }</span>
<a href="#l4.39"></a><span id="l4.39">       break;</span>
<a href="#l4.40"></a><span id="l4.40">     }</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -846,17 +846,17 @@ nsresult nsMsgSearchTerm::MatchArbitrary</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43"> NS_IMETHODIMP nsMsgSearchTerm::MatchHdrProperty(nsIMsgDBHdr *aHdr, bool *aResult)</span>
<a href="#l4.44"></a><span id="l4.44"> {</span>
<a href="#l4.45"></a><span id="l4.45">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l4.46"></a><span id="l4.46">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">   nsCString dbHdrValue;</span>
<a href="#l4.49"></a><span id="l4.49">   aHdr-&gt;GetStringProperty(m_hdrProperty.get(), getter_Copies(dbHdrValue));</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  nsresult rv = MatchString(dbHdrValue.get(), nullptr, aResult);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  nsresult rv = MatchString(dbHdrValue, nullptr, aResult);</span>
<a href="#l4.52"></a><span id="l4.52">   return rv;</span>
<a href="#l4.53"></a><span id="l4.53"> }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55"> NS_IMETHODIMP nsMsgSearchTerm::MatchFolderFlag(nsIMsgDBHdr *aMsgToMatch, bool *aResult)</span>
<a href="#l4.56"></a><span id="l4.56"> {</span>
<a href="#l4.57"></a><span id="l4.57">   NS_ENSURE_ARG_POINTER(aMsgToMatch);</span>
<a href="#l4.58"></a><span id="l4.58">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l4.59"></a><span id="l4.59">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -965,17 +965,17 @@ nsresult nsMsgSearchTerm::MatchBody (nsI</span>
<a href="#l4.61"></a><span id="l4.61">       // That seems like a pretty safe assumption.</span>
<a href="#l4.62"></a><span id="l4.62">       if (softLineBreak)</span>
<a href="#l4.63"></a><span id="l4.63">         continue;</span>
<a href="#l4.64"></a><span id="l4.64">       if (!compare.IsEmpty())</span>
<a href="#l4.65"></a><span id="l4.65">       {</span>
<a href="#l4.66"></a><span id="l4.66">         char startChar = (char) compare.CharAt(0);</span>
<a href="#l4.67"></a><span id="l4.67">         if (startChar != '\r' &amp;&amp; startChar != '\n')</span>
<a href="#l4.68"></a><span id="l4.68">         {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-          err = MatchString (compare.get(), folderCharset, &amp;result);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+          err = MatchString(compare, folderCharset, &amp;result);</span>
<a href="#l4.71"></a><span id="l4.71">           lines++;</span>
<a href="#l4.72"></a><span id="l4.72">         }</span>
<a href="#l4.73"></a><span id="l4.73">         compare.Truncate();</span>
<a href="#l4.74"></a><span id="l4.74">       }</span>
<a href="#l4.75"></a><span id="l4.75">     }</span>
<a href="#l4.76"></a><span id="l4.76">     else</span>
<a href="#l4.77"></a><span id="l4.77">       endOfFile = true;</span>
<a href="#l4.78"></a><span id="l4.78">   }</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineat">@@ -1011,72 +1011,68 @@ nsresult nsMsgSearchTerm::InitializeAddr</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">     rv = abManager-&gt;GetDirectory(nsDependentCString(m_value.string), getter_AddRefs(mDirectory));</span>
<a href="#l4.82"></a><span id="l4.82">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.83"></a><span id="l4.83">   }</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85">   return NS_OK;</span>
<a href="#l4.86"></a><span id="l4.86"> }</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-nsresult nsMsgSearchTerm::MatchInAddressBook(const char * aAddress, bool *pResult)</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+nsresult nsMsgSearchTerm::MatchInAddressBook(const nsACString &amp;aAddress,</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+                                             bool *pResult)</span>
<a href="#l4.91"></a><span id="l4.91"> {</span>
<a href="#l4.92"></a><span id="l4.92">   nsresult rv = InitializeAddressBook();</span>
<a href="#l4.93"></a><span id="l4.93">   *pResult = false;</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">   // Some junkmails have empty From: fields.</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-  if (aAddress == NULL || strlen(aAddress) == 0)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  if (aAddress.IsEmpty())</span>
<a href="#l4.98"></a><span id="l4.98">     return rv;</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">   if (mDirectory)</span>
<a href="#l4.101"></a><span id="l4.101">   {</span>
<a href="#l4.102"></a><span id="l4.102">     nsIAbCard* cardForAddress = nullptr;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-    rv = mDirectory-&gt;CardForEmailAddress(nsDependentCString(aAddress),</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-                                         &amp;cardForAddress);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    rv = mDirectory-&gt;CardForEmailAddress(aAddress, &amp;cardForAddress);</span>
<a href="#l4.106"></a><span id="l4.106">     if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l4.107"></a><span id="l4.107">       return rv;</span>
<a href="#l4.108"></a><span id="l4.108">     if ((m_operator == nsMsgSearchOp::IsInAB &amp;&amp; cardForAddress) || (m_operator == nsMsgSearchOp::IsntInAB &amp;&amp; !cardForAddress))</span>
<a href="#l4.109"></a><span id="l4.109">       *pResult = true;</span>
<a href="#l4.110"></a><span id="l4.110">     NS_IF_RELEASE(cardForAddress);</span>
<a href="#l4.111"></a><span id="l4.111">   }</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">   return rv;</span>
<a href="#l4.114"></a><span id="l4.114"> }</span>
<a href="#l4.115"></a><span id="l4.115"> </span>
<a href="#l4.116"></a><span id="l4.116"> // *pResult is false when strings don't match, true if they do.</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-nsresult nsMsgSearchTerm::MatchRfc2047String (const char * rfc2047string,</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-                                       const char *charset,</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-                                       bool charsetOverride,</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-                                       bool *pResult)</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+nsresult nsMsgSearchTerm::MatchRfc2047String(const nsACString &amp;rfc2047string,</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+                                             const char *charset,</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+                                             bool charsetOverride,</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+                                             bool *pResult)</span>
<a href="#l4.125"></a><span id="l4.125"> {</span>
<a href="#l4.126"></a><span id="l4.126">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-  NS_ENSURE_ARG_POINTER(rfc2047string);</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-    nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-  char *stringToMatch = 0;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-    nsresult res = mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-        rfc2047string, charset, charsetOverride, false, &amp;stringToMatch);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+  nsAutoCString stringToMatch;</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  nsresult rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    rfc2047string, charset, charsetOverride, false, stringToMatch);</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-    if ( m_operator == nsMsgSearchOp::IsInAB ||</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-         m_operator == nsMsgSearchOp::IsntInAB)</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-    {</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-      res = MatchInAddressBook(stringToMatch ? stringToMatch : rfc2047string, pResult);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-    }</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-    else</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-    res = MatchString(stringToMatch ? stringToMatch : rfc2047string,</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-                      nullptr, pResult);</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+  if (m_operator == nsMsgSearchOp::IsInAB ||</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+      m_operator == nsMsgSearchOp::IsntInAB)</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    rv = MatchInAddressBook(</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+      stringToMatch.IsEmpty() ? rfc2047string : stringToMatch, pResult);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  else</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+    rv = MatchString(stringToMatch.IsEmpty() ? rfc2047string : stringToMatch,</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+      nullptr, pResult);</span>
<a href="#l4.153"></a><span id="l4.153"> </span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    PR_Free(stringToMatch);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-  return res;</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  return rv;</span>
<a href="#l4.158"></a><span id="l4.158"> }</span>
<a href="#l4.159"></a><span id="l4.159"> </span>
<a href="#l4.160"></a><span id="l4.160"> // *pResult is false when strings don't match, true if they do.</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-nsresult nsMsgSearchTerm::MatchString (const char *stringToMatch,</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-                                       const char *charset,</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-                                       bool *pResult)</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+nsresult nsMsgSearchTerm::MatchString(const nsACString &amp;stringToMatch,</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+                                      const char *charset,</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+                                      bool *pResult)</span>
<a href="#l4.167"></a><span id="l4.167"> {</span>
<a href="#l4.168"></a><span id="l4.168">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l4.169"></a><span id="l4.169">   bool result = false;</span>
<a href="#l4.170"></a><span id="l4.170"> </span>
<a href="#l4.171"></a><span id="l4.171">   nsresult err = NS_OK;</span>
<a href="#l4.172"></a><span id="l4.172">   nsAutoString utf16StrToMatch;</span>
<a href="#l4.173"></a><span id="l4.173">   nsAutoString needle;</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175" class="difflineat">@@ -1084,23 +1080,21 @@ nsresult nsMsgSearchTerm::MatchString (c</span>
<a href="#l4.176"></a><span id="l4.176">   if(nsMsgSearchOp::IsEmpty != m_operator &amp;&amp; nsMsgSearchOp::IsntEmpty != m_operator)</span>
<a href="#l4.177"></a><span id="l4.177">   {</span>
<a href="#l4.178"></a><span id="l4.178">     NS_ASSERTION(MsgIsUTF8(nsDependentCString(m_value.string)),</span>
<a href="#l4.179"></a><span id="l4.179">                  &quot;m_value.string is not UTF-8&quot;);</span>
<a href="#l4.180"></a><span id="l4.180">     CopyUTF8toUTF16(nsDependentCString(m_value.string), needle);</span>
<a href="#l4.181"></a><span id="l4.181"> </span>
<a href="#l4.182"></a><span id="l4.182">     if (charset != nullptr)</span>
<a href="#l4.183"></a><span id="l4.183">     {</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-      ConvertToUnicode(charset, stringToMatch ? stringToMatch : &quot;&quot;,</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-                       utf16StrToMatch);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+      ConvertToUnicode(charset, nsCString(stringToMatch), utf16StrToMatch);</span>
<a href="#l4.187"></a><span id="l4.187">     }</span>
<a href="#l4.188"></a><span id="l4.188">     else {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-      NS_ASSERTION(MsgIsUTF8(nsDependentCString(stringToMatch)),</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-                   &quot;stringToMatch is not UTF-8&quot;);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-      CopyUTF8toUTF16(nsDependentCString(stringToMatch), utf16StrToMatch);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+      NS_ASSERTION(MsgIsUTF8(stringToMatch), &quot;stringToMatch is not UTF-8&quot;);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+      CopyUTF8toUTF16(stringToMatch, utf16StrToMatch);</span>
<a href="#l4.194"></a><span id="l4.194">     }</span>
<a href="#l4.195"></a><span id="l4.195">   }</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197">   switch (m_operator)</span>
<a href="#l4.198"></a><span id="l4.198">   {</span>
<a href="#l4.199"></a><span id="l4.199">   case nsMsgSearchOp::Contains:</span>
<a href="#l4.200"></a><span id="l4.200">     if (CaseInsensitiveFindInReadable(needle, utf16StrToMatch))</span>
<a href="#l4.201"></a><span id="l4.201">       result = true;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineat">@@ -1114,22 +1108,22 @@ nsresult nsMsgSearchTerm::MatchString (c</span>
<a href="#l4.203"></a><span id="l4.203">       result = true;</span>
<a href="#l4.204"></a><span id="l4.204">     break;</span>
<a href="#l4.205"></a><span id="l4.205">   case nsMsgSearchOp::Isnt:</span>
<a href="#l4.206"></a><span id="l4.206">     if(!needle.Equals(utf16StrToMatch, nsCaseInsensitiveStringComparator()))</span>
<a href="#l4.207"></a><span id="l4.207">       result = true;</span>
<a href="#l4.208"></a><span id="l4.208">     break;</span>
<a href="#l4.209"></a><span id="l4.209">   case nsMsgSearchOp::IsEmpty:</span>
<a href="#l4.210"></a><span id="l4.210">     // For IsEmpty, we didn't copy stringToMatch to utf16StrToMatch.</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-    if (!PL_strlen(stringToMatch))</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+    if (stringToMatch.IsEmpty())</span>
<a href="#l4.213"></a><span id="l4.213">       result = true;</span>
<a href="#l4.214"></a><span id="l4.214">     break;</span>
<a href="#l4.215"></a><span id="l4.215">   case nsMsgSearchOp::IsntEmpty:</span>
<a href="#l4.216"></a><span id="l4.216">     // For IsntEmpty, we didn't copy stringToMatch to utf16StrToMatch.</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-    if (PL_strlen(stringToMatch))</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+    if (!stringToMatch.IsEmpty())</span>
<a href="#l4.219"></a><span id="l4.219">       result = true;</span>
<a href="#l4.220"></a><span id="l4.220">     break;</span>
<a href="#l4.221"></a><span id="l4.221">   case nsMsgSearchOp::BeginsWith:</span>
<a href="#l4.222"></a><span id="l4.222">     if (StringBeginsWith(utf16StrToMatch, needle,</span>
<a href="#l4.223"></a><span id="l4.223">                          nsCaseInsensitiveStringComparator()))</span>
<a href="#l4.224"></a><span id="l4.224">       result = true;</span>
<a href="#l4.225"></a><span id="l4.225">     break;</span>
<a href="#l4.226"></a><span id="l4.226">   case nsMsgSearchOp::EndsWith:</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineat">@@ -1190,23 +1184,23 @@ NS_IMETHODIMP nsMsgSearchTerm::GetMatchA</span>
<a href="#l4.228"></a><span id="l4.228">      int32_t addressPos = 0;</span>
<a href="#l4.229"></a><span id="l4.229">      for (uint32_t i = 0; i &lt; count &amp;&amp; result == boolContinueLoop; i++)</span>
<a href="#l4.230"></a><span id="l4.230">      {</span>
<a href="#l4.231"></a><span id="l4.231">        walkNames = names + namePos;</span>
<a href="#l4.232"></a><span id="l4.232">        walkAddresses = addresses + addressPos;</span>
<a href="#l4.233"></a><span id="l4.233">        if ( m_operator == nsMsgSearchOp::IsInAB ||</span>
<a href="#l4.234"></a><span id="l4.234">             m_operator == nsMsgSearchOp::IsntInAB)</span>
<a href="#l4.235"></a><span id="l4.235">        {</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-         err = MatchRfc2047String (walkAddresses.get(), charset, charsetOverride, &amp;result);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+         err = MatchRfc2047String(walkAddresses, charset, charsetOverride, &amp;result);</span>
<a href="#l4.238"></a><span id="l4.238">        }</span>
<a href="#l4.239"></a><span id="l4.239">        else</span>
<a href="#l4.240"></a><span id="l4.240">        {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-         err = MatchRfc2047String (walkNames.get(), charset, charsetOverride, &amp;result);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+         err = MatchRfc2047String(walkNames, charset, charsetOverride, &amp;result);</span>
<a href="#l4.243"></a><span id="l4.243">          if (boolContinueLoop == result)</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-           err = MatchRfc2047String (walkAddresses.get(), charset, charsetOverride, &amp;result);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+           err = MatchRfc2047String(walkAddresses, charset, charsetOverride, &amp;result);</span>
<a href="#l4.246"></a><span id="l4.246">        }</span>
<a href="#l4.247"></a><span id="l4.247"> </span>
<a href="#l4.248"></a><span id="l4.248">        namePos += walkNames.Length() + 1;</span>
<a href="#l4.249"></a><span id="l4.249">        addressPos += walkAddresses.Length() + 1;</span>
<a href="#l4.250"></a><span id="l4.250">      }</span>
<a href="#l4.251"></a><span id="l4.251"> </span>
<a href="#l4.252"></a><span id="l4.252">      PR_Free(names);</span>
<a href="#l4.253"></a><span id="l4.253">      PR_Free(addresses);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -644,18 +644,18 @@ bool NS_MsgStripRE(const char **stringP,</span>
<a href="#l5.4"></a><span id="l5.4">   // decode the string</span>
<a href="#l5.5"></a><span id="l5.5">   nsCString decodedString;</span>
<a href="#l5.6"></a><span id="l5.6">   nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter;</span>
<a href="#l5.7"></a><span id="l5.7">   // we cannot strip &quot;Re:&quot; for MIME encoded subject without modifying the original</span>
<a href="#l5.8"></a><span id="l5.8">   if (modifiedSubject &amp;&amp; strstr(*stringP, &quot;=?&quot;))</span>
<a href="#l5.9"></a><span id="l5.9">   {</span>
<a href="#l5.10"></a><span id="l5.10">     mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l5.11"></a><span id="l5.11">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-      rv = mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-        *stringP, nullptr, false, true, getter_Copies(decodedString));</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+      rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(*stringP),</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+        nullptr, false, true, decodedString);</span>
<a href="#l5.16"></a><span id="l5.16">   }</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   s = !decodedString.IsEmpty() ? decodedString.get() : *stringP;</span>
<a href="#l5.19"></a><span id="l5.19">   L = lengthP ? *lengthP : strlen(s);</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   s_end = s + L;</span>
<a href="#l5.22"></a><span id="l5.22">   last = s;</span>
<a href="#l5.23"></a><span id="l5.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -529,19 +529,19 @@ nsMsgCompFields::SplitRecipients(const n</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">     for (i = 0; i &lt; numAddresses; ++i)</span>
<a href="#l6.6"></a><span id="l6.6">     {</span>
<a href="#l6.7"></a><span id="l6.7">       nsCString fullAddress;</span>
<a href="#l6.8"></a><span id="l6.8">       nsAutoString recipient;</span>
<a href="#l6.9"></a><span id="l6.9">       if (!aEmailAddressOnly)</span>
<a href="#l6.10"></a><span id="l6.10">       {</span>
<a href="#l6.11"></a><span id="l6.11">         nsCString decodedName;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        converter-&gt;DecodeMimeHeaderToCharPtr(pNames, GetCharacterSet(),</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                             false, true,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-                                             getter_Copies(decodedName));</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+        converter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(pNames),</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+                                          GetCharacterSet(), false, true,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+                                          decodedName);</span>
<a href="#l6.18"></a><span id="l6.18">         rv = parser-&gt;MakeFullAddressString((!decodedName.IsEmpty() ?</span>
<a href="#l6.19"></a><span id="l6.19">                                             decodedName.get() : pNames),</span>
<a href="#l6.20"></a><span id="l6.20">                                            pAddresses,</span>
<a href="#l6.21"></a><span id="l6.21">                                            getter_Copies(fullAddress));</span>
<a href="#l6.22"></a><span id="l6.22">       }</span>
<a href="#l6.23"></a><span id="l6.23">       if (NS_SUCCEEDED(rv) &amp;&amp; !aEmailAddressOnly)</span>
<a href="#l6.24"></a><span id="l6.24">         rv = ConvertToUnicode(&quot;UTF-8&quot;, fullAddress, recipient);</span>
<a href="#l6.25"></a><span id="l6.25">       else</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -602,18 +602,19 @@ nsresult nsMsgCompFields::SplitRecipient</span>
<a href="#l6.27"></a><span id="l6.27">   {</span>
<a href="#l6.28"></a><span id="l6.28">     char *pNames = names;</span>
<a href="#l6.29"></a><span id="l6.29">     char *pAddresses = addresses;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">     for (uint32_t i = 0; i &lt; numAddresses; ++i)</span>
<a href="#l6.32"></a><span id="l6.32">     {</span>
<a href="#l6.33"></a><span id="l6.33">       nsCString fullAddress;</span>
<a href="#l6.34"></a><span id="l6.34">       nsCString decodedName;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-      converter-&gt;DecodeMimeHeaderToCharPtr(pNames, GetCharacterSet(), false, true,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                                           getter_Copies(decodedName));</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+      converter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(pNames),</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                                        GetCharacterSet(), false, true,</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+                                        decodedName);</span>
<a href="#l6.40"></a><span id="l6.40">       rv = parser-&gt;MakeFullAddressString((!decodedName.IsEmpty() ?</span>
<a href="#l6.41"></a><span id="l6.41">                                           decodedName.get() : pNames),</span>
<a href="#l6.42"></a><span id="l6.42">                                          pAddresses,</span>
<a href="#l6.43"></a><span id="l6.43">                                          getter_Copies(fullAddress));</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">       nsMsgRecipient msgRecipient;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">       rv = ConvertToUnicode(&quot;UTF-8&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2190,17 +2190,17 @@ QuotingOutputStreamListener::~QuotingOut</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> QuotingOutputStreamListener::QuotingOutputStreamListener(const char * originalMsgURI,</span>
<a href="#l7.7"></a><span id="l7.7">                                                          nsIMsgDBHdr *originalMsgHdr,</span>
<a href="#l7.8"></a><span id="l7.8">                                                          bool quoteHeaders,</span>
<a href="#l7.9"></a><span id="l7.9">                                                          bool headersOnly,</span>
<a href="#l7.10"></a><span id="l7.10">                                                          nsIMsgIdentity *identity,</span>
<a href="#l7.11"></a><span id="l7.11">                                                          const char *charset,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-                                                         bool charetOverride,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                                                         bool charsetOverride,</span>
<a href="#l7.14"></a><span id="l7.14">                                                          bool quoteOriginal,</span>
<a href="#l7.15"></a><span id="l7.15">                                                          const nsACString&amp; htmlToQuote)</span>
<a href="#l7.16"></a><span id="l7.16"> {</span>
<a href="#l7.17"></a><span id="l7.17">   nsresult rv;</span>
<a href="#l7.18"></a><span id="l7.18">   mQuoteHeaders = quoteHeaders;</span>
<a href="#l7.19"></a><span id="l7.19">   mHeadersOnly = headersOnly;</span>
<a href="#l7.20"></a><span id="l7.20">   mIdentity = identity;</span>
<a href="#l7.21"></a><span id="l7.21">   mOrigMsgHdr = originalMsgHdr;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -2333,21 +2333,19 @@ QuotingOutputStreamListener::QuotingOutp</span>
<a href="#l7.23"></a><span id="l7.23">           // take care &quot;%s wrote&quot;</span>
<a href="#l7.24"></a><span id="l7.24">           PRUnichar *formattedString = nullptr;</span>
<a href="#l7.25"></a><span id="l7.25">           if (NS_SUCCEEDED(rv) &amp;&amp; !authorName.IsEmpty())</span>
<a href="#l7.26"></a><span id="l7.26">           {</span>
<a href="#l7.27"></a><span id="l7.27">             nsCString decodedAuthor;</span>
<a href="#l7.28"></a><span id="l7.28">             // Decode header, the result string is null</span>
<a href="#l7.29"></a><span id="l7.29">             // if the input is not MIME encoded ASCII.</span>
<a href="#l7.30"></a><span id="l7.30">             if (mMimeConverter)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-              mMimeConverter-&gt;DecodeMimeHeaderToCharPtr(authorName.get(),</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                                                        charset,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-                                                        charetOverride,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                                                        true,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-                                                        getter_Copies(decodedAuthor));</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+              mMimeConverter-&gt;DecodeMimeHeaderToUTF8(authorName, charset,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+                                                     charsetOverride, true,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+                                                     decodedAuthor);</span>
<a href="#l7.39"></a><span id="l7.39">             formattedString = nsTextFormatter::smprintf(replyHeaderAuthorwrote.get(),</span>
<a href="#l7.40"></a><span id="l7.40">                                                         (!decodedAuthor.IsEmpty() ?</span>
<a href="#l7.41"></a><span id="l7.41">                                                          decodedAuthor.get() : authorName.get()));</span>
<a href="#l7.42"></a><span id="l7.42">           }</span>
<a href="#l7.43"></a><span id="l7.43">           else</span>
<a href="#l7.44"></a><span id="l7.44">           {</span>
<a href="#l7.45"></a><span id="l7.45">             formattedString = nsTextFormatter::smprintf(replyHeaderAuthorwrote.get(),</span>
<a href="#l7.46"></a><span id="l7.46">                                                         author.get());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -539,40 +539,39 @@ nsMsgSendLater::CompleteMailFileSend()</span>
<a href="#l8.4"></a><span id="l8.4">   //</span>
<a href="#l8.5"></a><span id="l8.5">   nsCString author;</span>
<a href="#l8.6"></a><span id="l8.6">   mMessage-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   nsMsgCompFields * fields = (nsMsgCompFields *)compFields.get();</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   nsCString decodedString;</span>
<a href="#l8.11"></a><span id="l8.11">   // decoded string is null if the input is not MIME encoded</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  mimeConverter-&gt;DecodeMimeHeaderToCharPtr(author.get(), nullptr, false,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                                           true,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                                           getter_Copies(decodedString));</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  mimeConverter-&gt;DecodeMimeHeaderToUTF8(author, nullptr, false, true,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                                        decodedString);</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   fields-&gt;SetFrom(decodedString.IsEmpty() ? author.get() : decodedString.get());</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   if (m_to)</span>
<a href="#l8.21"></a><span id="l8.21">   {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-    mimeConverter-&gt;DecodeMimeHeaderToCharPtr(m_to, nullptr, false, true,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-                                             getter_Copies(decodedString));</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    mimeConverter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(m_to), nullptr,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+                                          false, true, decodedString);</span>
<a href="#l8.26"></a><span id="l8.26">     fields-&gt;SetTo(decodedString.IsEmpty() ? m_to : decodedString.get());</span>
<a href="#l8.27"></a><span id="l8.27">   }</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">   if (m_bcc)</span>
<a href="#l8.30"></a><span id="l8.30">   {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    mimeConverter-&gt;DecodeMimeHeaderToCharPtr(m_bcc, nullptr, false, true,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-                                             getter_Copies(decodedString));</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+    mimeConverter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(m_bcc), nullptr,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+                                          false, true, decodedString);</span>
<a href="#l8.35"></a><span id="l8.35">     fields-&gt;SetBcc(decodedString.IsEmpty() ? m_bcc : decodedString.get());</span>
<a href="#l8.36"></a><span id="l8.36">   }</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   if (m_fcc)</span>
<a href="#l8.39"></a><span id="l8.39">   {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-    mimeConverter-&gt;DecodeMimeHeaderToCharPtr(m_fcc, nullptr, false, true,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-                                             getter_Copies(decodedString));</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+    mimeConverter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(m_fcc), nullptr,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+                                          false, true, decodedString);</span>
<a href="#l8.44"></a><span id="l8.44">     fields-&gt;SetFcc(decodedString.IsEmpty() ? m_fcc : decodedString.get());</span>
<a href="#l8.45"></a><span id="l8.45">   }</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">   if (m_newsgroups)</span>
<a href="#l8.48"></a><span id="l8.48">     fields-&gt;SetNewsgroups(m_newsgroups);</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50"> #if 0</span>
<a href="#l8.51"></a><span id="l8.51">   // needs cleanup. Is this needed?</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -28,16 +28,32 @@ nsMailtoUrl::nsMailtoUrl()</span>
<a href="#l9.4"></a><span id="l9.4"> }</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> nsMailtoUrl::~nsMailtoUrl()</span>
<a href="#l9.7"></a><span id="l9.7"> {</span>
<a href="#l9.8"></a><span id="l9.8"> }</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> NS_IMPL_ISUPPORTS2(nsMailtoUrl, nsIMailtoUrl, nsIURI)</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+static void UnescapeAndConvert(nsIMimeConverter *mimeConverter,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                               const nsACString &amp;escaped, nsACString &amp;out)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+{</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  NS_ASSERTION(mimeConverter, &quot;Set mimeConverter before calling!&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  // If the string is empty, do absolutely nothing.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  if (escaped.IsEmpty())</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    return;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  MsgUnescapeString(escaped, 0, out);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  nsAutoCString decodedString;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  nsresult rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(out, &quot;UTF_8&quot;, false,</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+    true, decodedString);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !decodedString.IsEmpty())</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+    out = decodedString;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+}</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+</span>
<a href="#l9.28"></a><span id="l9.28"> nsresult nsMailtoUrl::ParseMailtoUrl(char * searchPart)</span>
<a href="#l9.29"></a><span id="l9.29"> {</span>
<a href="#l9.30"></a><span id="l9.30">   char *rest = searchPart;</span>
<a href="#l9.31"></a><span id="l9.31">   nsCString escapedInReplyToPart;</span>
<a href="#l9.32"></a><span id="l9.32">   nsCString escapedToPart;</span>
<a href="#l9.33"></a><span id="l9.33">   nsCString escapedCcPart;</span>
<a href="#l9.34"></a><span id="l9.34">   nsCString escapedSubjectPart;</span>
<a href="#l9.35"></a><span id="l9.35">   nsCString escapedNewsgroupPart;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineat">@@ -183,171 +199,40 @@ nsresult nsMailtoUrl::ParseMailtoUrl(cha</span>
<a href="#l9.37"></a><span id="l9.37">       } // end of switch statement...</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">       if (eq)</span>
<a href="#l9.40"></a><span id="l9.40">         *eq = '='; /* put it back */</span>
<a href="#l9.41"></a><span id="l9.41">       token = NS_strtok(&quot;&amp;&quot;, &amp;rest);</span>
<a href="#l9.42"></a><span id="l9.42">     } // while we still have part of the url to parse...</span>
<a href="#l9.43"></a><span id="l9.43">   } // if rest &amp;&amp; *rest</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-  char *decodedString;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  // Get a global converter</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter =</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   // Now unescape everything, and mime-decode the things that can be encoded.</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  if (!escapedToPart.IsEmpty())</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    MsgUnescapeString(escapedToPart, 0, m_toPart);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-    {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-                           m_toPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-                           &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-        m_toPart.Adopt(decodedString);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    }</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  }</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  if (!escapedCcPart.IsEmpty())</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    MsgUnescapeString(escapedCcPart, 0, m_ccPart);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    {</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-                           m_ccPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-                           &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-        m_ccPart.Adopt(decodedString);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    }</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  }</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  if (!escapedBccPart.IsEmpty())</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  {</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-    MsgUnescapeString(escapedBccPart, 0, m_bccPart);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    {</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-                           m_bccPart.get(),&quot;UTF-8&quot;, false, true,</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-                           &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-        m_bccPart.Adopt(decodedString);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-    }</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  }</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  if (!escapedSubjectPart.IsEmpty())</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    MsgUnescapeString(escapedSubjectPart, 0, m_subjectPart);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    {</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-                           m_subjectPart.get(),&quot;UTF-8&quot;, false, true,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-                           &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-        m_subjectPart.Adopt(decodedString);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    }</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  }</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  if (!escapedNewsgroupPart.IsEmpty())</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    MsgUnescapeString(escapedNewsgroupPart, 0, m_newsgroupPart);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-    {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-                         m_newsgroupPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-        m_newsgroupPart.Adopt(decodedString);</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-    }</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  }</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-  if (!escapedReferencePart.IsEmpty())</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-  {</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    MsgUnescapeString(escapedReferencePart, 0, m_referencePart);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    // Mime encoding allowed, but only useless such (only ascii allowed).</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    {</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-                         m_referencePart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-        m_referencePart.Adopt(decodedString);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    }</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  }</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedToPart, m_toPart);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedCcPart, m_ccPart);</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedBccPart, m_bccPart);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedSubjectPart, m_subjectPart);</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedNewsgroupPart, m_newsgroupPart);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedReferencePart, m_referencePart);</span>
<a href="#l9.125"></a><span id="l9.125">   if (!escapedBodyPart.IsEmpty())</span>
<a href="#l9.126"></a><span id="l9.126">     MsgUnescapeString(escapedBodyPart, 0, m_bodyPart);</span>
<a href="#l9.127"></a><span id="l9.127">   if (!escapedHtmlPart.IsEmpty())</span>
<a href="#l9.128"></a><span id="l9.128">     MsgUnescapeString(escapedHtmlPart, 0, m_htmlPart);</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  if (!escapedNewsHostPart.IsEmpty())</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-  {</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-    MsgUnescapeString(escapedNewsHostPart, 0, m_newsHostPart);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-    {</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-                         m_newsHostPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-        m_newsHostPart.Adopt(decodedString);</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-    }</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-  }</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-  if (!escapedFollowUpToPart.IsEmpty())</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-  {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-    MsgUnescapeString(escapedFollowUpToPart, 0, m_followUpToPart);</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-    {</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-                         m_followUpToPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-        m_followUpToPart.Adopt(decodedString);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-    }</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-  }</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-  if (!escapedFromPart.IsEmpty())</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  {</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    MsgUnescapeString(escapedFromPart, 0, m_fromPart);</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-                         m_fromPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-        m_fromPart.Adopt(decodedString);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-    }</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  }</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-  if (!escapedOrganizationPart.IsEmpty())</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-  {</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-    MsgUnescapeString(escapedOrganizationPart, 0, m_organizationPart);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-    {</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-                         m_organizationPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-        m_organizationPart.Adopt(decodedString);</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-    }</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-  }</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-  if (!escapedReplyToPart.IsEmpty())</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-  {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-    MsgUnescapeString(escapedReplyToPart, 0, m_replyToPart);</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-    {</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-                         m_replyToPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-        m_replyToPart.Adopt(decodedString);</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-    }</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  }</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-  if (!escapedPriorityPart.IsEmpty())</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-  {</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-    MsgUnescapeString(escapedPriorityPart, 0, m_priorityPart);</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-    {</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-                         m_priorityPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-        m_priorityPart.Adopt(decodedString);</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-    }</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-  }</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedNewsHostPart, m_newsHostPart);</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedFollowUpToPart, m_followUpToPart);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedFromPart, m_fromPart);</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedOrganizationPart, m_organizationPart);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedReplyToPart, m_replyToPart);</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedPriorityPart, m_priorityPart);</span>
<a href="#l9.201"></a><span id="l9.201"> </span>
<a href="#l9.202"></a><span id="l9.202">   nsCString inReplyToPart; // Not a member like the others...</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-  if (!escapedInReplyToPart.IsEmpty())</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-  {</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-    MsgUnescapeString(escapedInReplyToPart, 0, inReplyToPart);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-    // Mime encoding allowed, but only useless such (non ascii not allowed).</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-    if (mimeConverter)</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-    {</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-      if (NS_SUCCEEDED(mimeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-                         inReplyToPart.get(), &quot;UTF-8&quot;, false, true,</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-                         &amp;decodedString)) &amp;&amp; decodedString)</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-        inReplyToPart.Adopt(decodedString);</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-    }</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-  }</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedInReplyToPart, inReplyToPart);</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217">   if (!inReplyToPart.IsEmpty())</span>
<a href="#l9.218"></a><span id="l9.218">   {</span>
<a href="#l9.219"></a><span id="l9.219">     // Ensure that References and In-Reply-To are consistent... The last</span>
<a href="#l9.220"></a><span id="l9.220">     // reference will be used as In-Reply-To header.</span>
<a href="#l9.221"></a><span id="l9.221">     if (m_referencePart.IsEmpty())</span>
<a href="#l9.222"></a><span id="l9.222">     {</span>
<a href="#l9.223"></a><span id="l9.223">       // If References is not set, set it to be the In-Reply-To.</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineat">@@ -366,16 +251,17 @@ nsresult nsMailtoUrl::ParseMailtoUrl(cha</span>
<a href="#l9.225"></a><span id="l9.225"> </span>
<a href="#l9.226"></a><span id="l9.226">       if (lastReference != inReplyToPart)</span>
<a href="#l9.227"></a><span id="l9.227">       {</span>
<a href="#l9.228"></a><span id="l9.228">         m_referencePart += &quot; &quot;;</span>
<a href="#l9.229"></a><span id="l9.229">         m_referencePart += inReplyToPart;</span>
<a href="#l9.230"></a><span id="l9.230">       }</span>
<a href="#l9.231"></a><span id="l9.231">     }</span>
<a href="#l9.232"></a><span id="l9.232">   }</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+</span>
<a href="#l9.234"></a><span id="l9.234">   return NS_OK;</span>
<a href="#l9.235"></a><span id="l9.235"> }</span>
<a href="#l9.236"></a><span id="l9.236"> </span>
<a href="#l9.237"></a><span id="l9.237"> NS_IMETHODIMP nsMailtoUrl::SetSpec(const nsACString &amp;aSpec)</span>
<a href="#l9.238"></a><span id="l9.238"> {</span>
<a href="#l9.239"></a><span id="l9.239">   nsresult rv = m_baseURL-&gt;SetSpec(aSpec);</span>
<a href="#l9.240"></a><span id="l9.240">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.241"></a><span id="l9.241">   return ParseUrl();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -3566,19 +3566,19 @@ nsresult nsMsgDatabase::RowCellColumnToA</span>
<a href="#l10.4"></a><span id="l10.4">   m_dbFolderInfo-&gt;GetCharacterSetOverride(&amp;characterSetOverride);</span>
<a href="#l10.5"></a><span id="l10.5">   rv = RowCellColumnToCharPtr(row, m_messageCharSetColumnToken, getter_Copies(charset));</span>
<a href="#l10.6"></a><span id="l10.6">   if (NS_FAILED(rv) || charset.IsEmpty() || charset.Equals(&quot;us-ascii&quot;) ||</span>
<a href="#l10.7"></a><span id="l10.7">       characterSetOverride)</span>
<a href="#l10.8"></a><span id="l10.8">   {</span>
<a href="#l10.9"></a><span id="l10.9">     m_dbFolderInfo-&gt;GetEffectiveCharacterSet(charset);</span>
<a href="#l10.10"></a><span id="l10.10">   }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  rv = converter-&gt;DecodeMimeHeaderToCharPtr(cSender, charset.get(),</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                                            characterSetOverride, true,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-                                            getter_Copies(resultStr));</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  rv = converter-&gt;DecodeMimeHeaderToUTF8(nsDependentCString(cSender),</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+                                         charset.get(), characterSetOverride,</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+                                         true, resultStr);</span>
<a href="#l10.18"></a><span id="l10.18">   if (NS_SUCCEEDED(rv) &amp;&amp; !resultStr.IsEmpty())</span>
<a href="#l10.19"></a><span id="l10.19">     rv = headerParser-&gt;ExtractHeaderAddressName(resultStr, name);</span>
<a href="#l10.20"></a><span id="l10.20">   else</span>
<a href="#l10.21"></a><span id="l10.21">     rv = headerParser-&gt;ExtractHeaderAddressName(nsDependentCString(cSender),</span>
<a href="#l10.22"></a><span id="l10.22">                                                      name);</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.25"></a><span id="l10.25">     return CreateCollationKey(NS_ConvertUTF8toUTF16(name), len, result);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineat">@@ -3635,19 +3635,19 @@ nsresult nsMsgDatabase::RowCellColumnToC</span>
<a href="#l10.27"></a><span id="l10.27">       m_dbFolderInfo-&gt;GetCharacterSetOverride(&amp;characterSetOverride);</span>
<a href="#l10.28"></a><span id="l10.28">       err = RowCellColumnToCharPtr(row, m_messageCharSetColumnToken, getter_Copies(charSet));</span>
<a href="#l10.29"></a><span id="l10.29">       if (NS_FAILED(err) || charSet.IsEmpty() || charSet.Equals(&quot;us-ascii&quot;) ||</span>
<a href="#l10.30"></a><span id="l10.30">           characterSetOverride)</span>
<a href="#l10.31"></a><span id="l10.31">       {</span>
<a href="#l10.32"></a><span id="l10.32">         m_dbFolderInfo-&gt;GetEffectiveCharacterSet(charSet);</span>
<a href="#l10.33"></a><span id="l10.33">       }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-      err = m_mimeConverter-&gt;DecodeMimeHeaderToCharPtr(nakedString,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-        charSet.get(), characterSetOverride, true,</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-        getter_Copies(decodedStr));</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+      err = m_mimeConverter-&gt;DecodeMimeHeaderToUTF8(</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+        nsDependentCString(nakedString), charSet.get(), characterSetOverride,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+        true, decodedStr);</span>
<a href="#l10.41"></a><span id="l10.41">       if (NS_SUCCEEDED(err))</span>
<a href="#l10.42"></a><span id="l10.42">         err = CreateCollationKey(NS_ConvertUTF8toUTF16(decodedStr), len, result);</span>
<a href="#l10.43"></a><span id="l10.43">     }</span>
<a href="#l10.44"></a><span id="l10.44">   }</span>
<a href="#l10.45"></a><span id="l10.45">   return err;</span>
<a href="#l10.46"></a><span id="l10.46"> }</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -275,18 +275,17 @@ FeedItem.prototype =</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">   mimeEncodeSubject: function(aSubject, aCharset)</span>
<a href="#l11.6"></a><span id="l11.6">   {</span>
<a href="#l11.7"></a><span id="l11.7">     // This routine sometimes throws exceptions for mis-encoded data so</span>
<a href="#l11.8"></a><span id="l11.8">     // wrap it with a try catch for now.</span>
<a href="#l11.9"></a><span id="l11.9">     let newSubject;</span>
<a href="#l11.10"></a><span id="l11.10">     try</span>
<a href="#l11.11"></a><span id="l11.11">     {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      newSubject = mailServices.mimeConverter.encodeMimePartIIStr(</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                     this.mUnicodeConverter.ConvertFromUnicode(aSubject),</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+      newSubject = mailServices.mimeConverter.encodeMimePartIIStr_UTF8(aSubject,</span>
<a href="#l11.15"></a><span id="l11.15">                      false,</span>
<a href="#l11.16"></a><span id="l11.16">                      aCharset, 9, 72);</span>
<a href="#l11.17"></a><span id="l11.17">     }</span>
<a href="#l11.18"></a><span id="l11.18">     catch (ex)</span>
<a href="#l11.19"></a><span id="l11.19">     {</span>
<a href="#l11.20"></a><span id="l11.20">       newSubject = aSubject;</span>
<a href="#l11.21"></a><span id="l11.21">     }</span>
<a href="#l11.22"></a><span id="l11.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -817,18 +817,18 @@ nsMimeBaseEmitter::WriteHeaderFieldHTML(</span>
<a href="#l12.4"></a><span id="l12.4">   else</span>
<a href="#l12.5"></a><span id="l12.5">     i18nValue = strdup(value);</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7">   if ( (mUnicodeConverter) &amp;&amp; (mFormat != nsMimeOutput::nsMimeMessageSaveAs) )</span>
<a href="#l12.8"></a><span id="l12.8">   {</span>
<a href="#l12.9"></a><span id="l12.9">     nsCString tValue;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">     // we're going to need a converter to convert</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    nsresult rv = mUnicodeConverter-&gt;DecodeMimeHeaderToCharPtr(</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-      i18nValue, nullptr, false, true, getter_Copies(tValue));</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    nsresult rv = mUnicodeConverter-&gt;DecodeMimeHeaderToUTF8(</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+      nsDependentCString(i18nValue), nullptr, false, true, tValue);</span>
<a href="#l12.16"></a><span id="l12.16">     if (NS_SUCCEEDED(rv) &amp;&amp; !tValue.IsEmpty())</span>
<a href="#l12.17"></a><span id="l12.17">       newValue = MsgEscapeHTML(tValue.get());</span>
<a href="#l12.18"></a><span id="l12.18">     else</span>
<a href="#l12.19"></a><span id="l12.19">       newValue = MsgEscapeHTML(i18nValue);</span>
<a href="#l12.20"></a><span id="l12.20">   }</span>
<a href="#l12.21"></a><span id="l12.21">   else</span>
<a href="#l12.22"></a><span id="l12.22">   {</span>
<a href="#l12.23"></a><span id="l12.23">     newValue = MsgEscapeHTML(i18nValue);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeConverter.idl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeConverter.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -3,40 +3,26 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.5"></a><span id="l13.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> /**</span>
<a href="#l13.10"></a><span id="l13.10">  * Encode/decode mail headers (via libmime).</span>
<a href="#l13.11"></a><span id="l13.11">  */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-[scriptable, uuid(a2f56836-0de6-41b9-8902-ac33e4993e6b)]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+[scriptable, uuid(1f685c2d-5ac6-40a9-8415-655b408a7d42)]</span>
<a href="#l13.14"></a><span id="l13.14"> interface nsIMimeConverter : nsISupports {</span>
<a href="#l13.15"></a><span id="l13.15">   /**</span>
<a href="#l13.16"></a><span id="l13.16">    * Suggested byte length limit for use when calling</span>
<a href="#l13.17"></a><span id="l13.17">    * encodeMimePartIIStr(_UTF8).</span>
<a href="#l13.18"></a><span id="l13.18">    */</span>
<a href="#l13.19"></a><span id="l13.19">   const long MIME_ENCODED_WORD_SIZE = 72;</span>
<a href="#l13.20"></a><span id="l13.20">   const long MAX_CHARSET_NAME_LENGTH = 64;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">   /**</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-   * Encode an ASCII string into RFC2047 form, but don't use this...</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-   * use encodeMimePartIIStr_UTF8 for scripting purposes.</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-   * (The header argument could easily contain non-ASCII characters.)</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-   *</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-   * All this routine does is convert header to unicode, then call the</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-   * UTF8 version anyways.</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-   */</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  string encodeMimePartIIStr(in string  header, </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                             in boolean structured, </span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                             in string  mailCharset, </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-                             in long    fieldnamelen,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-                             in long    encodedWordSize);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  /**</span>
<a href="#l13.37"></a><span id="l13.37">    * Encode a UTF-8 CString into RFC 2047 form (&quot;=?&quot; charset &quot;?&quot; encoding &quot;?&quot;</span>
<a href="#l13.38"></a><span id="l13.38">    * encoded-text &quot;?=&quot;, where encoding is either &quot;B&quot; for BASE64 (RFC 2045) or</span>
<a href="#l13.39"></a><span id="l13.39">    * &quot;Q&quot; for quoted-printable-ish (RFC 2045)).</span>
<a href="#l13.40"></a><span id="l13.40">    *</span>
<a href="#l13.41"></a><span id="l13.41">    * @param header UTF-8 header to encode.</span>
<a href="#l13.42"></a><span id="l13.42">    * @param structured Is the header's field-body a &quot;structured&quot; field?</span>
<a href="#l13.43"></a><span id="l13.43">    *     (Encoded words are only allowed in comment/phrase portions of</span>
<a href="#l13.44"></a><span id="l13.44">    *     structured field bodies.)</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineat">@@ -61,21 +47,20 @@ interface nsIMimeConverter : nsISupports</span>
<a href="#l13.46"></a><span id="l13.46">    * @param default_charset The charset to apply to un-labeled non-UTF-8 data.</span>
<a href="#l13.47"></a><span id="l13.47">    * @param override_charset If true, default_charset is used instead of any</span>
<a href="#l13.48"></a><span id="l13.48">    *     charset labeling other than UTF-8.</span>
<a href="#l13.49"></a><span id="l13.49">    * @param eatContinuations If true, unfold headers.</span>
<a href="#l13.50"></a><span id="l13.50">    *</span>
<a href="#l13.51"></a><span id="l13.51">    * @return UTF-8 encoded value if conversion was required, nullptr if no</span>
<a href="#l13.52"></a><span id="l13.52">    *     conversion was required.</span>
<a href="#l13.53"></a><span id="l13.53">    */</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  [noscript]</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-  string decodeMimeHeaderToCharPtr(in string header,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-                                   in string default_charset,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-                                   in boolean override_charset,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-                                   in boolean eatContinuations);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  AUTF8String decodeMimeHeaderToUTF8(in ACString header,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+                                     in string default_charset,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+                                     in boolean override_charset,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+                                     in boolean eatContinuations);</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64">   /**</span>
<a href="#l13.65"></a><span id="l13.65">    * Decode a MIME header to UTF-16.</span>
<a href="#l13.66"></a><span id="l13.66">    *</span>
<a href="#l13.67"></a><span id="l13.67">    * @param header A (possibly encoded) header to decode.</span>
<a href="#l13.68"></a><span id="l13.68">    * @param default_charset The charset to apply to un-labeled non-UTF-8 data.</span>
<a href="#l13.69"></a><span id="l13.69">    * @param override_charset If true, default_charset is used instead of any</span>
<a href="#l13.70"></a><span id="l13.70">    *     charset labeling other than UTF-8.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/mime/src/comi18n.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/mime/src/comi18n.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -674,34 +674,31 @@ char * apply_rfc2047_encoding(const char</span>
<a href="#l14.4"></a><span id="l14.4">   PR_Free(src_head);</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">   return output;</span>
<a href="#l14.7"></a><span id="l14.7"> }</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.10"></a><span id="l14.10"> // BEGIN PUBLIC INTERFACE</span>
<a href="#l14.11"></a><span id="l14.11"> extern &quot;C&quot; {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#define PUBLIC</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-extern &quot;C&quot; char *MIME_DecodeMimeHeader(const char *header,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-                                       const char *default_charset,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-                                       bool override_charset,</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-                                       bool eatContinuations)</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+void MIME_DecodeMimeHeader(const char *header, const char *default_charset,</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+                           bool override_charset, bool eatContinuations,</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+                           nsACString &amp;result)</span>
<a href="#l14.22"></a><span id="l14.22"> {</span>
<a href="#l14.23"></a><span id="l14.23">   nsresult rv;</span>
<a href="#l14.24"></a><span id="l14.24">   nsCOMPtr &lt;nsIMIMEHeaderParam&gt; mimehdrpar = do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l14.25"></a><span id="l14.25">   if (NS_FAILED(rv))</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    return nullptr;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-  nsAutoCString result;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  rv = mimehdrpar-&gt;DecodeRFC2047Header(header, default_charset, override_charset,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-                                       eatContinuations, result);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    return ToNewCString(result);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  return nullptr;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    result.Truncate();</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    return;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  }</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  mimehdrpar-&gt;DecodeRFC2047Header(header, default_charset, override_charset,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+                                  eatContinuations, result);</span>
<a href="#l14.39"></a><span id="l14.39"> }</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41"> char *MIME_EncodeMimePartIIStr(const char* header, bool structured, const char* mailCharset, const int32_t fieldNameLen, const int32_t encodedWordSize)</span>
<a href="#l14.42"></a><span id="l14.42"> {</span>
<a href="#l14.43"></a><span id="l14.43">   return apply_rfc2047_encoding(header, structured, mailCharset, fieldNameLen, encodedWordSize);</span>
<a href="#l14.44"></a><span id="l14.44"> }</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46"> // UTF-8 utility functions.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/mime/src/comi18n.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/mime/src/comi18n.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -20,22 +20,21 @@ extern &quot;C&quot; {</span>
<a href="#l15.4"></a><span id="l15.4">  * Decode MIME header to UTF-8.</span>
<a href="#l15.5"></a><span id="l15.5">  * Uses MIME_ConvertCharset if the decoded string needs a conversion.</span>
<a href="#l15.6"></a><span id="l15.6">  *</span>
<a href="#l15.7"></a><span id="l15.7">  *</span>
<a href="#l15.8"></a><span id="l15.8">  * @param header      [IN] A header to decode.</span>
<a href="#l15.9"></a><span id="l15.9">  * @param default_charset     [IN] Default charset to apply to ulabeled non-UTF-8 8bit data</span>
<a href="#l15.10"></a><span id="l15.10">  * @param override_charset    [IN] If true, default_charset used instead of any charset labeling other than UTF-8</span>
<a href="#l15.11"></a><span id="l15.11">  * @param eatContinuations    [IN] If true, unfold headers</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">- * @return            Decoded buffer (in C string) or return NULL if the header needs no conversion</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * @param result      [OUT] Decoded buffer</span>
<a href="#l15.14"></a><span id="l15.14">  */</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-extern &quot;C&quot; char *MIME_DecodeMimeHeader(const char *header, </span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-                                       const char *default_charset,</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-                                       bool override_charset,</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-                                       bool eatContinuations);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+void MIME_DecodeMimeHeader(const char *header, const char *default_charset,</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+                           bool override_charset, bool eatContinuations,</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+                           nsACString &amp;result);</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> /**</span>
<a href="#l15.24"></a><span id="l15.24">  * Encode an input string into RFC 2047 form.</span>
<a href="#l15.25"></a><span id="l15.25">  * This is a replacement for INTL_EncodeMimePartIIStr.</span>
<a href="#l15.26"></a><span id="l15.26">  * Unlike INTL_EncodeMimePartIIStr, this does not apply any charset conversion.</span>
<a href="#l15.27"></a><span id="l15.27">  * Use MIME_ConvertCharset in advance if the encoding string needs a conversion.</span>
<a href="#l15.28"></a><span id="l15.28">  *</span>
<a href="#l15.29"></a><span id="l15.29">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -337,28 +337,27 @@ CreateCompositionFields(const char      </span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">   nsCOMPtr&lt;nsIMsgCompFields&gt; cFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l16.6"></a><span id="l16.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.7"></a><span id="l16.7">   NS_ENSURE_TRUE(cFields, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   // Now set all of the passed in stuff...</span>
<a href="#l16.10"></a><span id="l16.10">   cFields-&gt;SetCharacterSet(!PL_strcasecmp(&quot;us-ascii&quot;, charset) ? &quot;ISO-8859-1&quot; : charset);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  char *val;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  nsAutoCString val;</span>
<a href="#l16.14"></a><span id="l16.14">   nsAutoString outString;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16">   if (from) {</span>
<a href="#l16.17"></a><span id="l16.17">     ConvertRawBytesToUTF16(from, charset, outString);</span>
<a href="#l16.18"></a><span id="l16.18">     cFields-&gt;SetFrom(outString);</span>
<a href="#l16.19"></a><span id="l16.19">   }</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21">   if (subject) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-    val = MIME_DecodeMimeHeader(subject, charset, false, true);</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-    cFields-&gt;SetSubject(NS_ConvertUTF8toUTF16(val ? val : subject));</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+    MIME_DecodeMimeHeader(subject, charset, false, true, val);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+    cFields-&gt;SetSubject(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : subject));</span>
<a href="#l16.27"></a><span id="l16.27">   }</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">   if (reply_to) {</span>
<a href="#l16.30"></a><span id="l16.30">     ConvertRawBytesToUTF16(reply_to, charset, outString);</span>
<a href="#l16.31"></a><span id="l16.31">     cFields-&gt;SetReplyTo(outString);</span>
<a href="#l16.32"></a><span id="l16.32">   }</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">   if (to) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineat">@@ -372,67 +371,59 @@ CreateCompositionFields(const char      </span>
<a href="#l16.36"></a><span id="l16.36">   }</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38">   if (bcc) {</span>
<a href="#l16.39"></a><span id="l16.39">     ConvertRawBytesToUTF16(bcc, charset, outString);</span>
<a href="#l16.40"></a><span id="l16.40">     cFields-&gt;SetBcc(outString);</span>
<a href="#l16.41"></a><span id="l16.41">   }</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43">   if (fcc) {</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-    val = MIME_DecodeMimeHeader(fcc, charset, false, true);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-    cFields-&gt;SetFcc(NS_ConvertUTF8toUTF16(val ? val : fcc));</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+    MIME_DecodeMimeHeader(fcc, charset, false, true, val);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+    cFields-&gt;SetFcc(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : fcc));</span>
<a href="#l16.49"></a><span id="l16.49">   }</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51">   if (newsgroups) {</span>
<a href="#l16.52"></a><span id="l16.52">     // fixme: the newsgroups header had better be decoded using the server-side</span>
<a href="#l16.53"></a><span id="l16.53">     // character encoding,but this |charset| might be different from it.</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-    val = MIME_DecodeMimeHeader(newsgroups, charset, false, true);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-    cFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(val ? val : newsgroups));</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+    MIME_DecodeMimeHeader(newsgroups, charset, false, true, val);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+    cFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : newsgroups));</span>
<a href="#l16.59"></a><span id="l16.59">   }</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61">   if (followup_to) {</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-    val = MIME_DecodeMimeHeader(followup_to, charset, false, true);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-    cFields-&gt;SetFollowupTo(NS_ConvertUTF8toUTF16(val ? val : followup_to));</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+    MIME_DecodeMimeHeader(followup_to, charset, false, true, val);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+    cFields-&gt;SetFollowupTo(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : followup_to));</span>
<a href="#l16.67"></a><span id="l16.67">   }</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69">   if (organization) {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-    val = MIME_DecodeMimeHeader(organization, charset, false, true);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-    cFields-&gt;SetOrganization(NS_ConvertUTF8toUTF16(val ? val : organization));</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+    MIME_DecodeMimeHeader(organization, charset, false, true, val);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    cFields-&gt;SetOrganization(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : organization));</span>
<a href="#l16.75"></a><span id="l16.75">   }</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77">   if (references) {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-    val = MIME_DecodeMimeHeader(references, charset, false, true);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-    cFields-&gt;SetReferences(val ? val : references);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+    MIME_DecodeMimeHeader(references, charset, false, true, val);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+    cFields-&gt;SetReferences(!val.IsEmpty() ? val.get() : references);</span>
<a href="#l16.83"></a><span id="l16.83">   }</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85">   if (other_random_headers) {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-    val = MIME_DecodeMimeHeader(other_random_headers, charset, false, true);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    cFields-&gt;SetOtherRandomHeaders(NS_ConvertUTF8toUTF16(val ? val : other_random_headers));</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    MIME_DecodeMimeHeader(other_random_headers, charset, false, true, val);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    cFields-&gt;SetOtherRandomHeaders(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : other_random_headers));</span>
<a href="#l16.91"></a><span id="l16.91">   }</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93">   if (priority) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-    val = MIME_DecodeMimeHeader(priority, charset, false, true);</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    MIME_DecodeMimeHeader(priority, charset, false, true, val);</span>
<a href="#l16.96"></a><span id="l16.96">     nsMsgPriorityValue priorityValue;</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-    NS_MsgGetPriorityFromString(val ? val : priority, priorityValue);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    NS_MsgGetPriorityFromString(!val.IsEmpty() ? val.get() : priority, priorityValue);</span>
<a href="#l16.100"></a><span id="l16.100">     nsAutoCString priorityName;</span>
<a href="#l16.101"></a><span id="l16.101">     NS_MsgGetUntranslatedPriorityName(priorityValue, priorityName);</span>
<a href="#l16.102"></a><span id="l16.102">     cFields-&gt;SetPriority(priorityName.get());</span>
<a href="#l16.103"></a><span id="l16.103">   }</span>
<a href="#l16.104"></a><span id="l16.104"> </span>
<a href="#l16.105"></a><span id="l16.105">   if (newspost_url) {</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-    val = MIME_DecodeMimeHeader(newspost_url, charset, false, true);</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-    cFields-&gt;SetNewspostUrl(val ? val : newspost_url);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-    PR_FREEIF(val);</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+    MIME_DecodeMimeHeader(newspost_url, charset, false, true, val);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+    cFields-&gt;SetNewspostUrl(!val.IsEmpty() ? val.get() : newspost_url);</span>
<a href="#l16.111"></a><span id="l16.111">   }</span>
<a href="#l16.112"></a><span id="l16.112"> </span>
<a href="#l16.113"></a><span id="l16.113">   *_retval = cFields;</span>
<a href="#l16.114"></a><span id="l16.114">   NS_IF_ADDREF(*_retval);</span>
<a href="#l16.115"></a><span id="l16.115"> </span>
<a href="#l16.116"></a><span id="l16.116">   return rv;</span>
<a href="#l16.117"></a><span id="l16.117"> }</span>
<a href="#l16.118"></a><span id="l16.118"> </span>
<a href="#l16.119"></a><span id="l16.119" class="difflineat">@@ -582,25 +573,24 @@ mime_intl_insert_message_header_1(char  </span>
<a href="#l16.120"></a><span id="l16.120">   if (htmlEdit)</span>
<a href="#l16.121"></a><span id="l16.121">   {</span>
<a href="#l16.122"></a><span id="l16.122">     NS_MsgSACat(body, HEADER_MIDDLE_JUNK);</span>
<a href="#l16.123"></a><span id="l16.123">   }</span>
<a href="#l16.124"></a><span id="l16.124">   else</span>
<a href="#l16.125"></a><span id="l16.125">     NS_MsgSACat(body, &quot;: &quot;);</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127">     // MIME decode header</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-    char* utf8 = MIME_DecodeMimeHeader(*hdr_value, mailcharset, false,</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-                                       true);</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-    if (NULL != utf8) {</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+    nsAutoCString utf8Value;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+    MIME_DecodeMimeHeader(*hdr_value, mailcharset, false, true, utf8Value);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+    if (!utf8Value.IsEmpty()) {</span>
<a href="#l16.134"></a><span id="l16.134">       char *escaped = nullptr;</span>
<a href="#l16.135"></a><span id="l16.135">       if (htmlEdit)</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-        escaped = MsgEscapeHTML(utf8);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-      NS_MsgSACat(body, escaped ? escaped : utf8);</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+        escaped = MsgEscapeHTML(utf8Value.get());</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+      NS_MsgSACat(body, escaped ? escaped : utf8Value.get());</span>
<a href="#l16.140"></a><span id="l16.140">       NS_Free(escaped);</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-      PR_Free(utf8);</span>
<a href="#l16.142"></a><span id="l16.142">     } else {</span>
<a href="#l16.143"></a><span id="l16.143">         NS_MsgSACat(body, *hdr_value); // raw MIME encoded string</span>
<a href="#l16.144"></a><span id="l16.144">     }</span>
<a href="#l16.145"></a><span id="l16.145"> </span>
<a href="#l16.146"></a><span id="l16.146">   if (htmlEdit)</span>
<a href="#l16.147"></a><span id="l16.147">     NS_MsgSACat(body, HEADER_END_JUNK);</span>
<a href="#l16.148"></a><span id="l16.148"> }</span>
<a href="#l16.149"></a><span id="l16.149"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -28,37 +28,36 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> // Forward declares...</span>
<a href="#l17.6"></a><span id="l17.6"> int32_t MimeHeaders_build_heads_list(MimeHeaders *hdrs);</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> void</span>
<a href="#l17.9"></a><span id="l17.9"> MimeHeaders_convert_header_value(MimeDisplayOptions *opt, nsCString &amp;value,</span>
<a href="#l17.10"></a><span id="l17.10">                                  bool convert_charset_only)</span>
<a href="#l17.11"></a><span id="l17.11"> {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  char        *converted;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14">   if (value.IsEmpty())</span>
<a href="#l17.15"></a><span id="l17.15">     return;</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17">   if (convert_charset_only)</span>
<a href="#l17.18"></a><span id="l17.18">   {</span>
<a href="#l17.19"></a><span id="l17.19">     nsAutoCString output;</span>
<a href="#l17.20"></a><span id="l17.20">     ConvertRawBytesToUTF8(value, opt-&gt;default_charset, output);</span>
<a href="#l17.21"></a><span id="l17.21">     value.Assign(output);</span>
<a href="#l17.22"></a><span id="l17.22">     return;</span>
<a href="#l17.23"></a><span id="l17.23">   }</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">   if (opt &amp;&amp; opt-&gt;rfc1522_conversion_p)</span>
<a href="#l17.26"></a><span id="l17.26">   {</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    converted = MIME_DecodeMimeHeader(value.get(), opt-&gt;default_charset,</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-                                      opt-&gt;override_charset, true);</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+    nsAutoCString temporary;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+    MIME_DecodeMimeHeader(value.get(), opt-&gt;default_charset,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+                          opt-&gt;override_charset, true, temporary);</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    if (converted)</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    if (!temporary.IsEmpty())</span>
<a href="#l17.35"></a><span id="l17.35">     {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-      value.Adopt(converted);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+      value = temporary;</span>
<a href="#l17.38"></a><span id="l17.38">     }</span>
<a href="#l17.39"></a><span id="l17.39">   }</span>
<a href="#l17.40"></a><span id="l17.40">   else</span>
<a href="#l17.41"></a><span id="l17.41">   {</span>
<a href="#l17.42"></a><span id="l17.42">     // This behavior, though highly unusual, was carefully preserved</span>
<a href="#l17.43"></a><span id="l17.43">     // from the previous implementation.  It may be that this is dead</span>
<a href="#l17.44"></a><span id="l17.44">     // code, in which case opt-&gt;rfc1522_conversion_p is no longer</span>
<a href="#l17.45"></a><span id="l17.45">     // needed.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/src/nsMimeConverter.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/src/nsMimeConverter.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -31,73 +31,48 @@ nsMimeConverter::nsMimeConverter()</span>
<a href="#l18.4"></a><span id="l18.4"> {</span>
<a href="#l18.5"></a><span id="l18.5"> }</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> nsMimeConverter::~nsMimeConverter()</span>
<a href="#l18.8"></a><span id="l18.8"> {</span>
<a href="#l18.9"></a><span id="l18.9"> }</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> nsresult</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-nsMimeConverter::DecodeMimeHeaderToCharPtr(const char *header,</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-                                           const char *default_charset,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-                                           bool override_charset,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-                                           bool eatContinuations,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-                                           char **decodedString)</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+nsMimeConverter::DecodeMimeHeaderToUTF8(const nsACString &amp;header,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+                                        const char *default_charset,</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+                                        bool override_charset,</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+                                        bool eatContinuations,</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+                                        nsACString &amp;result)</span>
<a href="#l18.22"></a><span id="l18.22"> {</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-  NS_ENSURE_ARG_POINTER(decodedString);</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-  *decodedString = MIME_DecodeMimeHeader(header, default_charset,</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-                                         override_charset,</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-                                         eatContinuations);</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  MIME_DecodeMimeHeader(PromiseFlatCString(header).get(), default_charset,</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+                        override_charset, eatContinuations, result);</span>
<a href="#l18.30"></a><span id="l18.30">   return NS_OK;</span>
<a href="#l18.31"></a><span id="l18.31"> }</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33"> // Decode routine (also converts output to unicode)</span>
<a href="#l18.34"></a><span id="l18.34"> nsresult</span>
<a href="#l18.35"></a><span id="l18.35"> nsMimeConverter::DecodeMimeHeader(const char *header,</span>
<a href="#l18.36"></a><span id="l18.36">                                   const char *default_charset,</span>
<a href="#l18.37"></a><span id="l18.37">                                   bool override_charset,</span>
<a href="#l18.38"></a><span id="l18.38">                                   bool eatContinuations,</span>
<a href="#l18.39"></a><span id="l18.39">                                   nsAString&amp; decodedString)</span>
<a href="#l18.40"></a><span id="l18.40"> {</span>
<a href="#l18.41"></a><span id="l18.41">   NS_ENSURE_ARG_POINTER(header);</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43">   // apply MIME decode.</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-  char *decodedCstr = MIME_DecodeMimeHeader(header, default_charset,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-                                            override_charset, eatContinuations);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-  if (!decodedCstr) {</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-    CopyUTF8toUTF16(nsDependentCString(header), decodedString);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-  } else {</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-    CopyUTF8toUTF16(nsDependentCString(decodedCstr), decodedString);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    PR_FREEIF(decodedCstr);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-  }</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  nsCString decodedCString;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+  MIME_DecodeMimeHeader(header, default_charset, override_charset,</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                        eatContinuations, decodedCString);</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  CopyUTF8toUTF16(decodedCString.IsEmpty() ? nsDependentCString(header)</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+                                           : decodedCString,</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+                  decodedString);</span>
<a href="#l18.59"></a><span id="l18.59">   return NS_OK;</span>
<a href="#l18.60"></a><span id="l18.60"> }</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62"> nsresult</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-nsMimeConverter::EncodeMimePartIIStr(const char       *header,</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-                                           bool       structured,</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-                                           const char *mailCharset,</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-                                           int32_t    fieldnamelen,</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-                                           int32_t    encodedWordSize,</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-                                           char       **encodedString)</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-{</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-  NS_ENSURE_ARG_POINTER(encodedString);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  // Encoder needs utf-8 string.</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-  nsAutoString tempUnicodeString;</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-  nsresult rv = ConvertToUnicode(mailCharset, header, tempUnicodeString);</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-  return EncodeMimePartIIStr_UTF8(NS_ConvertUTF16toUTF8(tempUnicodeString),</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-                                  structured, mailCharset, fieldnamelen,</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-                                  encodedWordSize, encodedString);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-}</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-nsresult</span>
<a href="#l18.82"></a><span id="l18.82"> nsMimeConverter::EncodeMimePartIIStr_UTF8(const nsACString &amp;header,</span>
<a href="#l18.83"></a><span id="l18.83">                                           bool             structured,</span>
<a href="#l18.84"></a><span id="l18.84">                                           const char       *mailCharset,</span>
<a href="#l18.85"></a><span id="l18.85">                                           int32_t          fieldnamelen,</span>
<a href="#l18.86"></a><span id="l18.86">                                           int32_t          encodedWordSize,</span>
<a href="#l18.87"></a><span id="l18.87">                                           char             **encodedString)</span>
<a href="#l18.88"></a><span id="l18.88"> {</span>
<a href="#l18.89"></a><span id="l18.89">   NS_ENSURE_ARG_POINTER(encodedString);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/src/nsMsgHeaderParser.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/src/nsMsgHeaderParser.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -70,40 +70,38 @@ nsresult FillResultsArray(const char * a</span>
<a href="#l19.4"></a><span id="l19.4"> {</span>
<a href="#l19.5"></a><span id="l19.5">   NS_ENSURE_ARG(aParser);</span>
<a href="#l19.6"></a><span id="l19.6">   nsresult rv = NS_OK;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">   *aOutgoingFullName = nullptr;</span>
<a href="#l19.9"></a><span id="l19.9">   *aOutgoingEmailAddress = nullptr;</span>
<a href="#l19.10"></a><span id="l19.10">   *aOutgoingName = nullptr;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  char * result = nullptr;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  nsAutoCString result;</span>
<a href="#l19.14"></a><span id="l19.14">   if (aAddress &amp;&amp; aAddress[0])</span>
<a href="#l19.15"></a><span id="l19.15">   {</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-    result = MIME_DecodeMimeHeader(aAddress, NULL, false, true);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-    *aOutgoingEmailAddress = ToNewUnicode(NS_ConvertUTF8toUTF16(result ? result : aAddress));</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-    PR_FREEIF(result);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+    MIME_DecodeMimeHeader(aAddress, NULL, false, true, result);</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+    *aOutgoingEmailAddress = ToNewUnicode(NS_ConvertUTF8toUTF16(!result.IsEmpty() ? result.get() : aAddress));</span>
<a href="#l19.21"></a><span id="l19.21">   }</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23">   if (aName &amp;&amp; aName[0])</span>
<a href="#l19.24"></a><span id="l19.24">   {</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-    result = MIME_DecodeMimeHeader(aName, NULL, false, true);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-    *aOutgoingName = ToNewUnicode(NS_ConvertUTF8toUTF16(result ? result : aName));</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-    PR_FREEIF(result);</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+    MIME_DecodeMimeHeader(aName, NULL, false, true, result);</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+    *aOutgoingName = ToNewUnicode(NS_ConvertUTF8toUTF16(!result.IsEmpty() ? result.get() : aName));</span>
<a href="#l19.30"></a><span id="l19.30">   }</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">   nsCString fullAddress;</span>
<a href="#l19.33"></a><span id="l19.33">   nsCString unquotedAddress;</span>
<a href="#l19.34"></a><span id="l19.34">   rv = aParser-&gt;MakeFullAddressString(aName, aAddress,</span>
<a href="#l19.35"></a><span id="l19.35">                                       getter_Copies(fullAddress));</span>
<a href="#l19.36"></a><span id="l19.36">   if (NS_SUCCEEDED(rv) &amp;&amp; !fullAddress.IsEmpty())</span>
<a href="#l19.37"></a><span id="l19.37">   {</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-    result = MIME_DecodeMimeHeader(fullAddress.get(), nullptr, false, true);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-    if (result)</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-      fullAddress.Adopt(result);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+    MIME_DecodeMimeHeader(fullAddress.get(), nullptr, false, true, result);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+    if (!result.IsEmpty())</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+      fullAddress = result;</span>
<a href="#l19.44"></a><span id="l19.44">     aParser-&gt;UnquotePhraseOrAddr(fullAddress.get(), true, getter_Copies(unquotedAddress));</span>
<a href="#l19.45"></a><span id="l19.45">     if (!unquotedAddress.IsEmpty())</span>
<a href="#l19.46"></a><span id="l19.46">       fullAddress = unquotedAddress;</span>
<a href="#l19.47"></a><span id="l19.47">     *aOutgoingFullName = ToNewUnicode(NS_ConvertUTF8toUTF16(fullAddress));</span>
<a href="#l19.48"></a><span id="l19.48">   }</span>
<a href="#l19.49"></a><span id="l19.49">   else</span>
<a href="#l19.50"></a><span id="l19.50">     *aOutgoingFullName = nullptr;</span>
<a href="#l19.51"></a><span id="l19.51"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

