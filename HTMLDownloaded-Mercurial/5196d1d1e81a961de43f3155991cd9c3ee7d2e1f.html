<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26291:5196d1d1e81a961de43f3155991cd9c3ee7d2e1f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5196d1d1e81a961de43f3155991cd9c3ee7d2e1f" />
<meta property="og:url" content="/comm-central/rev/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f" />
<meta property="og:description" content="Bug 971347 - Add pref for setting the autoconfiguration guess timeout. r=BenB" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5196d1d1e81a961de43f3155991cd9c3ee7d2e1f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">shortlog</a> |
<a href="/comm-central/log/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">files</a> |
changeset |
<a href="/comm-central/raw-rev/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">raw</a>  | <a href="/comm-central/archive/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=971347">Bug 971347</a> - Add pref for setting the autoconfiguration guess timeout. r=BenB
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#117;&#64;&#52;&#53;&#49;&#102;&#46;&#111;&#114;&#103;</td></tr>
<tr><td></td><td class="date age">Wed, 10 Apr 2019 18:07:37 +0200</td></tr>

<tr>
 <td>changeset 26291</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">5196d1d1e81a961de43f3155991cd9c3ee7d2e1f</a></td>
</tr>



<tr>
<td>parent 26290</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ee9a9a89e349007bf2f58e06184fc2500f0ce80e">ee9a9a89e349007bf2f58e06184fc2500f0ce80e</a>
</td>
</tr>

<tr>
<td>child 26292</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b796a9af14c738ac7201979b1a6e2300b8364543">b796a9af14c738ac7201979b1a6e2300b8364543</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5196d1d1e81a961de43f3155991cd9c3ee7d2e1f">15773</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 10 Apr 2019 16:24:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b796a9af14c7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b796a9af14c738ac7201979b1a6e2300b8364543">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b796a9af14c738ac7201979b1a6e2300b8364543&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b796a9af14c738ac7201979b1a6e2300b8364543&newProject=comm-central&newRevision=55dab518e79a124e76e2c0d0d8be08485b5f23ad&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b796a9af14c738ac7201979b1a6e2300b8364543&newProject=comm-central&newRevision=55dab518e79a124e76e2c0d0d8be08485b5f23ad&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b796a9af14c738ac7201979b1a6e2300b8364543&newProject=comm-central&newRevision=55dab518e79a124e76e2c0d0d8be08485b5f23ad&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28BenB%29&revcount=50">BenB</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=971347">971347</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=971347">Bug 971347</a> - Add pref for setting the autoconfiguration guess timeout. r=BenB

The static 10 seconds is not enough for Tor users (delay spikes of 10
seconds is not uncommon), so let's make it possible for the TorBirdy
extension to override this timeout.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mail/components/accountcreation/content/guessConfig.js">mail/components/accountcreation/content/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mail/components/accountcreation/content/guessConfig.js">file</a> |
<a href="/comm-central/annotate/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mail/components/accountcreation/content/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mail/components/accountcreation/content/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mail/components/accountcreation/content/guessConfig.js">comparison</a> |
<a href="/comm-central/log/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mail/components/accountcreation/content/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/5196d1d1e81a961de43f3155991cd9c3ee7d2e1f/mailnews/mailnews.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/accountcreation/content/guessConfig.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/accountcreation/content/guessConfig.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,18 +3,16 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> /* import-globals-from emailWizard.js */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> var { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l1.10"></a><span id="l1.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var TIMEOUT = 10; // in seconds</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14"> // This is a bit ugly - we set outgoingDone to false</span>
<a href="#l1.15"></a><span id="l1.15"> // when emailWizard.js cancels the outgoing probe because the user picked</span>
<a href="#l1.16"></a><span id="l1.16"> // an outoing server. It does this by poking the probeAbortable object,</span>
<a href="#l1.17"></a><span id="l1.17"> // so we need outgoingDone to have global scope.</span>
<a href="#l1.18"></a><span id="l1.18"> var outgoingDone = false;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> /**</span>
<a href="#l1.21"></a><span id="l1.21">  * Try to guess the config, by:</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -420,29 +418,30 @@ HostDetector.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">   // We make all host/port combinations run in parallel, store their</span>
<a href="#l1.24"></a><span id="l1.24">   // results in an array, and as soon as one finishes successfully and all</span>
<a href="#l1.25"></a><span id="l1.25">   // higher-priority ones have failed, we abort all lower-priority ones.</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">   _tryAll() {</span>
<a href="#l1.28"></a><span id="l1.28">     if (this._cancel)</span>
<a href="#l1.29"></a><span id="l1.29">       return;</span>
<a href="#l1.30"></a><span id="l1.30">     var me = this;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    var timeout = Services.prefs.getIntPref(&quot;mailnews.auto_config.guess.timeout&quot;);</span>
<a href="#l1.32"></a><span id="l1.32">     for (let i = 0; i &lt; this._hostsToTry.length; i++) {</span>
<a href="#l1.33"></a><span id="l1.33">       let thisTry = this._hostsToTry[i]; // {HostTry}</span>
<a href="#l1.34"></a><span id="l1.34">       if (thisTry.status != kNotTried)</span>
<a href="#l1.35"></a><span id="l1.35">         continue;</span>
<a href="#l1.36"></a><span id="l1.36">       this._log.info(&quot;poking at &quot; + thisTry.hostname + &quot; port &quot; +</span>
<a href="#l1.37"></a><span id="l1.37">           thisTry.port + &quot; ssl &quot; + thisTry.ssl + &quot; protocol &quot; +</span>
<a href="#l1.38"></a><span id="l1.38">           protocolToString(thisTry.protocol));</span>
<a href="#l1.39"></a><span id="l1.39">       if (i == 0) // showing 50 servers at once is pointless</span>
<a href="#l1.40"></a><span id="l1.40">         this.mProgressCallback(thisTry);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">       thisTry.abortable = SocketUtil(</span>
<a href="#l1.43"></a><span id="l1.43">           thisTry.hostname, thisTry.port, thisTry.ssl,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-          thisTry.commands, TIMEOUT,</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+          thisTry.commands, timeout,</span>
<a href="#l1.46"></a><span id="l1.46">           new SSLErrorHandler(thisTry, this._log),</span>
<a href="#l1.47"></a><span id="l1.47">           function(wiredata) { // result callback</span>
<a href="#l1.48"></a><span id="l1.48">             if (me._cancel)</span>
<a href="#l1.49"></a><span id="l1.49">               return; // don't use response anymore</span>
<a href="#l1.50"></a><span id="l1.50">             me.mProgressCallback(thisTry);</span>
<a href="#l1.51"></a><span id="l1.51">             me._processResult(thisTry, wiredata);</span>
<a href="#l1.52"></a><span id="l1.52">             me._checkFinished();</span>
<a href="#l1.53"></a><span id="l1.53">           },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -922,16 +922,18 @@ pref(&quot;mailnews.auto_config.fetchFromISP.</span>
<a href="#l2.4"></a><span id="l2.4"> // Allow the Microsoft Exchange AutoDiscover protocol.</span>
<a href="#l2.5"></a><span id="l2.5"> // This also sends the email address and password to the server,</span>
<a href="#l2.6"></a><span id="l2.6"> // which the protocol unfortunately requires in practice.</span>
<a href="#l2.7"></a><span id="l2.7"> pref(&quot;mailnews.auto_config.fetchFromExchange.enabled&quot;, true);</span>
<a href="#l2.8"></a><span id="l2.8"> // Whether we will attempt to guess the account configuration based on</span>
<a href="#l2.9"></a><span id="l2.9"> // protocol default ports and common domain practices</span>
<a href="#l2.10"></a><span id="l2.10"> // (e.g. {mail,pop,imap,smtp}.&lt;email-domain&gt;).</span>
<a href="#l2.11"></a><span id="l2.11"> pref(&quot;mailnews.auto_config.guess.enabled&quot;, true);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+// The timeout (in seconds) for each guess</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+pref(&quot;mailnews.auto_config.guess.timeout&quot;, 10);</span>
<a href="#l2.14"></a><span id="l2.14"> // Work around bug 1454325 by disabling mimetype mungling in XmlHttpRequest</span>
<a href="#l2.15"></a><span id="l2.15"> pref(&quot;dom.xhr.standard_content_type_normalization&quot;, false);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> // -- Summary Database options</span>
<a href="#l2.18"></a><span id="l2.18"> // dontPreserveOnCopy: a space separated list of properties that are not</span>
<a href="#l2.19"></a><span id="l2.19"> //                     copied to the new nsIMsgHdr when a message is copied.</span>
<a href="#l2.20"></a><span id="l2.20"> //                     Allows extensions to control preservation of properties.</span>
<a href="#l2.21"></a><span id="l2.21"> pref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

