<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 903:9428198987203b368b40bdd0d1df35942712fde0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9428198987203b368b40bdd0d1df35942712fde0" />
<meta property="og:url" content="/comm-central/rev/9428198987203b368b40bdd0d1df35942712fde0" />
<meta property="og:description" content="* make gloda initialize itself / have no chrome dependencies where things need to be passed in externally.  (use nsITimer instead of setTimeout, create our own messenger instance, and more.)" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9428198987203b368b40bdd0d1df35942712fde0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9428198987203b368b40bdd0d1df35942712fde0">shortlog</a> |
<a href="/comm-central/log/9428198987203b368b40bdd0d1df35942712fde0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9428198987203b368b40bdd0d1df35942712fde0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9428198987203b368b40bdd0d1df35942712fde0">files</a> |
changeset |
<a href="/comm-central/raw-rev/9428198987203b368b40bdd0d1df35942712fde0">raw</a>  | <a href="/comm-central/archive/9428198987203b368b40bdd0d1df35942712fde0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
* make gloda initialize itself / have no chrome dependencies where things need to be passed in externally.  (use nsITimer instead of setTimeout, create our own messenger instance, and more.)
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 02 Sep 2008 23:33:45 -0700</td></tr>

<tr>
 <td>changeset 903</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9428198987203b368b40bdd0d1df35942712fde0">9428198987203b368b40bdd0d1df35942712fde0</a></td>
</tr>



<tr>
<td>parent 902</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5c202694b25c4515ce735d3c560495cb158d1ccc">5c202694b25c4515ce735d3c560495cb158d1ccc</a>
</td>
</tr>

<tr>
<td>child 904</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c823a3026e957437c5bbb25682e728a6aefb12a1">c823a3026e957437c5bbb25682e728a6aefb12a1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9428198987203b368b40bdd0d1df35942712fde0">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">* make gloda initialize itself / have no chrome dependencies where things need to be passed in externally.  (use nsITimer instead of setTimeout, create our own messenger instance, and more.)
 * define public.js as the public face of gloda.  just import that and you're good.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/content/overlay.js">content/overlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9428198987203b368b40bdd0d1df35942712fde0/content/overlay.js">file</a> |
<a href="/comm-central/annotate/9428198987203b368b40bdd0d1df35942712fde0/content/overlay.js">annotate</a> |
<a href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/content/overlay.js">diff</a> |
<a href="/comm-central/comparison/9428198987203b368b40bdd0d1df35942712fde0/content/overlay.js">comparison</a> |
<a href="/comm-central/log/9428198987203b368b40bdd0d1df35942712fde0/content/overlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/modules/gloda.js">modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9428198987203b368b40bdd0d1df35942712fde0/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/9428198987203b368b40bdd0d1df35942712fde0/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/9428198987203b368b40bdd0d1df35942712fde0/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/9428198987203b368b40bdd0d1df35942712fde0/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9428198987203b368b40bdd0d1df35942712fde0/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/9428198987203b368b40bdd0d1df35942712fde0/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/9428198987203b368b40bdd0d1df35942712fde0/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/9428198987203b368b40bdd0d1df35942712fde0/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/modules/public.js">modules/public.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9428198987203b368b40bdd0d1df35942712fde0/modules/public.js">file</a> |
<a href="/comm-central/annotate/9428198987203b368b40bdd0d1df35942712fde0/modules/public.js">annotate</a> |
<a href="/comm-central/diff/9428198987203b368b40bdd0d1df35942712fde0/modules/public.js">diff</a> |
<a href="/comm-central/comparison/9428198987203b368b40bdd0d1df35942712fde0/modules/public.js">comparison</a> |
<a href="/comm-central/log/9428198987203b368b40bdd0d1df35942712fde0/modules/public.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/content/overlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/content/overlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -31,37 +31,30 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.5"></a><span id="l1.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.6"></a><span id="l1.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.7"></a><span id="l1.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.8"></a><span id="l1.8">  * </span>
<a href="#l1.9"></a><span id="l1.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> // get the core</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-Components.utils.import(&quot;resource://gloda/modules/gloda.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// make all the built-in plugins join the party</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-Components.utils.import(&quot;resource://gloda/modules/everybody.js&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-Components.utils.import(&quot;resource://gloda/modules/indexer.js&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+Components.utils.import(&quot;resource://gloda/modules/public.js&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> var gloda = {</span>
<a href="#l1.20"></a><span id="l1.20">   _mimeMsg: {},</span>
<a href="#l1.21"></a><span id="l1.21">   </span>
<a href="#l1.22"></a><span id="l1.22">   onLoad: function() {</span>
<a href="#l1.23"></a><span id="l1.23">     // initialization code</span>
<a href="#l1.24"></a><span id="l1.24">     this.initialized = true;</span>
<a href="#l1.25"></a><span id="l1.25">     this.strings = document.getElementById(&quot;gloda-strings&quot;);</span>
<a href="#l1.26"></a><span id="l1.26">     </span>
<a href="#l1.27"></a><span id="l1.27">     // initialize the globals required for the JS Mime representation</span>
<a href="#l1.28"></a><span id="l1.28">     Components.utils.import(&quot;resource://gloda/modules/mimemsg.js&quot;,</span>
<a href="#l1.29"></a><span id="l1.29">                             this._mimeMsg);</span>
<a href="#l1.30"></a><span id="l1.30">     this._mimeMsg.MsgHdrToMimeMessage.initGlobals(messenger, msgWindow);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    GlodaIndexer.init(window, msgWindow, this.strings, messenger);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    GlodaIndexer.enabled = true;</span>
<a href="#l1.34"></a><span id="l1.34">   },</span>
<a href="#l1.35"></a><span id="l1.35">   onIndexEverythingCommand: function(e) {</span>
<a href="#l1.36"></a><span id="l1.36">     GlodaIndexer.indexEverything();</span>
<a href="#l1.37"></a><span id="l1.37">   },</span>
<a href="#l1.38"></a><span id="l1.38">   onIndexAddressBookCommand: function(e) {</span>
<a href="#l1.39"></a><span id="l1.39">     // TODO support address-book indexing or something.</span>
<a href="#l1.40"></a><span id="l1.40">   },  </span>
<a href="#l1.41"></a><span id="l1.41">   indexSelectedMessages: function () {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/gloda.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/gloda.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -172,16 +172,21 @@ let Gloda = {</span>
<a href="#l2.4"></a><span id="l2.4">     let dapp = new Log4Moz.DumpAppender(formatter);</span>
<a href="#l2.5"></a><span id="l2.5">     dapp.level = Log4Moz.Level.All;</span>
<a href="#l2.6"></a><span id="l2.6">     root.addAppender(dapp);</span>
<a href="#l2.7"></a><span id="l2.7">     </span>
<a href="#l2.8"></a><span id="l2.8">     this._log = Log4Moz.Service.getLogger(&quot;gloda.NS&quot;);</span>
<a href="#l2.9"></a><span id="l2.9">     this._log.info(&quot;Logging Initialized&quot;);</span>
<a href="#l2.10"></a><span id="l2.10">   },</span>
<a href="#l2.11"></a><span id="l2.11">   </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  kIndexerIdle: 0,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  kIndexerIndexing: 1,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  kIndexerMoving: 2,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  kIndexerRemoving: 3,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  </span>
<a href="#l2.17"></a><span id="l2.17">   /**</span>
<a href="#l2.18"></a><span id="l2.18">    * Given an nsIMsgDBHdr, return the gloda message object that corresponds to</span>
<a href="#l2.19"></a><span id="l2.19">    *  it.  If no such message exists, null is returned.</span>
<a href="#l2.20"></a><span id="l2.20">    *</span>
<a href="#l2.21"></a><span id="l2.21">    * Ideally, if gloda is unable to locate a gloda message corresponding to the</span>
<a href="#l2.22"></a><span id="l2.22">    *  header, and it has not been told to avoid indexing the message (based on</span>
<a href="#l2.23"></a><span id="l2.23">    *  folder or other criteria), and the message is not currently queued for</span>
<a href="#l2.24"></a><span id="l2.24">    *  indexing, it should take some action to resolve the issue.  Either by</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -203,53 +203,57 @@ let GlodaIndexer = {</span>
<a href="#l3.4"></a><span id="l3.4">   /**</span>
<a href="#l3.5"></a><span id="l3.5">    * A partial attempt to generalize to support multiple databases.  Each</span>
<a href="#l3.6"></a><span id="l3.6">    *  database would have its own datastore would have its own indexer.  But</span>
<a href="#l3.7"></a><span id="l3.7">    *  we rather inter-mingle our use of this field with the singleton global</span>
<a href="#l3.8"></a><span id="l3.8">    *  GlodaDatastore.</span>
<a href="#l3.9"></a><span id="l3.9">    */</span>
<a href="#l3.10"></a><span id="l3.10">   _datastore: GlodaDatastore,</span>
<a href="#l3.11"></a><span id="l3.11">   _log: Log4Moz.Service.getLogger(&quot;gloda.indexer&quot;),</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  _strBundle: null,</span>
<a href="#l3.13"></a><span id="l3.13">   _messenger: null,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  _msgwindow: null,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  _domWindow: null,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  /**</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+   * Our nsITimer that we use to schedule ourselves on the main thread</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+   *  intermittently.  The timer always exists but may not always be active.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+   */</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  _timer: null,</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">   _inited: false,</span>
<a href="#l3.23"></a><span id="l3.23">   /**</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-   * Initialize the indexer, passing in a number of things that either should</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-   *  not be needed or should be retrieved by the code directly for XPCOM.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-   *  This means that some chrome code somewhere (generally gloda) needs to</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-   *  intitialize us.  In theory this might cause sequencing problems, in</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-   *  practice it doesn't.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+   * Initialize the indexer.</span>
<a href="#l3.30"></a><span id="l3.30">    */</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  init: function gloda_index_init(aDOMWindow, aMsgWindow, aStrBundle,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-                                  aMessenger) {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  _init: function gloda_index_init() {</span>
<a href="#l3.34"></a><span id="l3.34">     if (this._inited)</span>
<a href="#l3.35"></a><span id="l3.35">       return;</span>
<a href="#l3.36"></a><span id="l3.36">     </span>
<a href="#l3.37"></a><span id="l3.37">     this._inited = true;</span>
<a href="#l3.38"></a><span id="l3.38">     </span>
<a href="#l3.39"></a><span id="l3.39">     // we need this for setTimeout... what to do about this?</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    this._domWindow = aDOMWindow;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-    // not sure we actually need this to pass around?</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    this._msgWindow = aMsgWindow;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    // XXX we can XPCOM this up instead...</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    this._strBundle = aStrBundle;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    // XXX we can XPCOM up a messenger instance of our own</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-    this._messenger = aMessenger;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    this._messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+                        createInstance(Ci.nsIMessenger);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+    </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    this._timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l3.51"></a><span id="l3.51">     </span>
<a href="#l3.52"></a><span id="l3.52">     // topmostMsgWindow explodes for un-clear reasons if we have multiple</span>
<a href="#l3.53"></a><span id="l3.53">     //  windows open.  very sad.</span>
<a href="#l3.54"></a><span id="l3.54">     let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l3.55"></a><span id="l3.55">                         getService(Ci.nsIMsgMailSession);</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">     this._folderListener._init(this);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    // register for folder loaded events...</span>
<a href="#l3.59"></a><span id="l3.59">     mailSession.AddFolderListener(this._folderListener,</span>
<a href="#l3.60"></a><span id="l3.60">                                   Ci.nsIFolderListener.event);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    // figure out if event-driven indexing should be enabled...</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    let prefService = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+                        getService(Ci.nsIPrefService);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    let branch = prefService.getBranch(&quot;mailnews.database.global.indexer&quot;);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    let eventDrivenEnabled = true; // default</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    if (branch.prefHasUserValue(&quot;enabled&quot;))</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+      eventDrivenEnabled = branch.getBoolPref(&quot;enabled&quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    this.enabled = eventDrivenEnabled;</span>
<a href="#l3.70"></a><span id="l3.70">   },</span>
<a href="#l3.71"></a><span id="l3.71">   </span>
<a href="#l3.72"></a><span id="l3.72">   /**</span>
<a href="#l3.73"></a><span id="l3.73">    * Are we enabled, read: are we processing change events?</span>
<a href="#l3.74"></a><span id="l3.74">    */</span>
<a href="#l3.75"></a><span id="l3.75">   _enabled: false,</span>
<a href="#l3.76"></a><span id="l3.76">   get enabled() { return this._enabled; },</span>
<a href="#l3.77"></a><span id="l3.77">   set enabled(aEnable) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineat">@@ -280,19 +284,19 @@ let GlodaIndexer = {</span>
<a href="#l3.79"></a><span id="l3.79">   _indexingActive: false,</span>
<a href="#l3.80"></a><span id="l3.80">   /** Indicates whether indexing is active or not. */</span>
<a href="#l3.81"></a><span id="l3.81">   get indexing() { return this._indexingActive; },</span>
<a href="#l3.82"></a><span id="l3.82">   /** You can turn on indexing, but you can't turn it off! */</span>
<a href="#l3.83"></a><span id="l3.83">   set indexing(aShouldIndex) {</span>
<a href="#l3.84"></a><span id="l3.84">     if (!this._indexingActive &amp;&amp; aShouldIndex) {</span>
<a href="#l3.85"></a><span id="l3.85">       this._log.info(&quot;+++ Indexing Queue Processing Commencing&quot;);</span>
<a href="#l3.86"></a><span id="l3.86">       this._indexingActive = true;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-      this._domWindow.setTimeout(this._wrapCallbackDriver,</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-                                 this._indexInterval,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-                                 this);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+      this._timer.initWithCallback(this._wrapCallbackDriver,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+                                   this._indexInterval,</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+                                   Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l3.93"></a><span id="l3.93">     }  </span>
<a href="#l3.94"></a><span id="l3.94">   },</span>
<a href="#l3.95"></a><span id="l3.95">   </span>
<a href="#l3.96"></a><span id="l3.96">   /**</span>
<a href="#l3.97"></a><span id="l3.97">    * Our current job number, out of _indexingJobGoal.  Although our jobs comes</span>
<a href="#l3.98"></a><span id="l3.98">    *  from _indexQueue, this is not an offset into that list because we forget</span>
<a href="#l3.99"></a><span id="l3.99">    *  jobs once we complete them.  As such, this value is strictly for progress</span>
<a href="#l3.100"></a><span id="l3.100">    *  tracking.</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineat">@@ -349,34 +353,33 @@ let GlodaIndexer = {</span>
<a href="#l3.102"></a><span id="l3.102">   _indexListeners: [],</span>
<a href="#l3.103"></a><span id="l3.103">   /**</span>
<a href="#l3.104"></a><span id="l3.104">    * Add an indexing progress listener.  The listener will be notified of at</span>
<a href="#l3.105"></a><span id="l3.105">    *  least all major status changes (idle -&gt; indexing, indexing -&gt; idle), plus</span>
<a href="#l3.106"></a><span id="l3.106">    *  arbitrary progress updates during the indexing process.</span>
<a href="#l3.107"></a><span id="l3.107">    * If indexing is not active when the listener is added, a synthetic idle</span>
<a href="#l3.108"></a><span id="l3.108">    *  notification will be generated.</span>
<a href="#l3.109"></a><span id="l3.109">    *</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-   * @param aListener A listener function, taking arguments: status (string),</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-   *     folder name being indexed (string or null), current zero-based folder</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-   *     number being indexed (int), total number of folders to index (int),</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-   *     current message number being indexed in this folder (int), total number</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-   *     of messages in this folder to be indexed (int).</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+   * @param aListener A listener function, taking arguments: status (Gloda.</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+   *     kIndexer*), the folder name if a folder is involved (string or null),</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+   *     current zero-based job number (int), total number of jobs (int),</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+   *     current item number being indexed in this job (int), total number</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+   *     of items in this job to be indexed (int).</span>
<a href="#l3.120"></a><span id="l3.120">    *</span>
<a href="#l3.121"></a><span id="l3.121">    * @TODO should probably allow for a 'this' value to be provided</span>
<a href="#l3.122"></a><span id="l3.122">    * @TODO generalize to not be folder/message specific.  use nouns!</span>
<a href="#l3.123"></a><span id="l3.123">    */</span>
<a href="#l3.124"></a><span id="l3.124">   addListener: function gloda_index_addListener(aListener) {</span>
<a href="#l3.125"></a><span id="l3.125">     // should we weakify?</span>
<a href="#l3.126"></a><span id="l3.126">     if (this._indexListeners.indexOf(aListener) == -1)</span>
<a href="#l3.127"></a><span id="l3.127">       this._indexListeners.push(aListener);</span>
<a href="#l3.128"></a><span id="l3.128">     // if we aren't indexing, give them an idle indicator, otherwise they can</span>
<a href="#l3.129"></a><span id="l3.129">     //  just be happy when we hit the next actual status point.</span>
<a href="#l3.130"></a><span id="l3.130">     if (!this.indexing)</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-      aListener(this._strBundle ? this._strBundle.getString(&quot;actionIdle&quot;) : &quot;&quot;,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-                null, 0, 1, 0, 1);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+      aListener(Gloda.kIndexerIdle, null, 0, 1, 0, 1);</span>
<a href="#l3.134"></a><span id="l3.134">     return aListener;</span>
<a href="#l3.135"></a><span id="l3.135">   },</span>
<a href="#l3.136"></a><span id="l3.136">   /**</span>
<a href="#l3.137"></a><span id="l3.137">    * Remove the given listener so that it no longer receives indexing progress</span>
<a href="#l3.138"></a><span id="l3.138">    *  updates.</span>
<a href="#l3.139"></a><span id="l3.139">    */</span>
<a href="#l3.140"></a><span id="l3.140">   removeListener: function gloda_index_removeListener(aListener) {</span>
<a href="#l3.141"></a><span id="l3.141">     let index = this._indexListeners.indexOf(aListener);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineat">@@ -390,38 +393,33 @@ let GlodaIndexer = {</span>
<a href="#l3.143"></a><span id="l3.143">    *  state... we figure that out ourselves.</span>
<a href="#l3.144"></a><span id="l3.144">    */</span>
<a href="#l3.145"></a><span id="l3.145">   _notifyListeners: function gloda_index_notifyListeners() {</span>
<a href="#l3.146"></a><span id="l3.146">     let status, prettyName, jobIndex, jobTotal, jobItemIndex, jobItemGoal;</span>
<a href="#l3.147"></a><span id="l3.147">     </span>
<a href="#l3.148"></a><span id="l3.148">     if (this._indexingActive &amp;&amp; this._curIndexingJob) {</span>
<a href="#l3.149"></a><span id="l3.149">       let job = this._curIndexingJob;</span>
<a href="#l3.150"></a><span id="l3.150">       if (job.deltaType &gt; 0)</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-        status = this._strBundle.getString(&quot;actionIndexing&quot;);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+        status = Gloda.kIndexerIndexing;</span>
<a href="#l3.153"></a><span id="l3.153">       else if (job.deltaType == 0)</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-        status = this._strBundle.getString(&quot;actionMoving&quot;);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+        status = Gloda.kIndexerMoving;</span>
<a href="#l3.156"></a><span id="l3.156">       else</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-        status = this._strBundle.getString(&quot;actionDeindexing&quot;);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+        status = Gloda.kIndexerRemoving;</span>
<a href="#l3.159"></a><span id="l3.159">         </span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-      let prettyName;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-      if (this._indexingFolder !== null)</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-        prettyName = this._indexingFolder.prettiestName;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-      else</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-        prettyName =</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-          this._strBundle.getString(&quot;messageIndexingExplanation&quot;);</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+      let prettyName = (this._indexingFolder !== null) ?</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+                       this._indexingFolder.prettiestName : null;</span>
<a href="#l3.169"></a><span id="l3.169">       status = status + &quot; &quot; + prettyName;</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171">       jobIndex = this._indexingJobCount-1;</span>
<a href="#l3.172"></a><span id="l3.172">       jobTotal = this._indexingJobGoal;</span>
<a href="#l3.173"></a><span id="l3.173">       jobItemIndex = job.offset;</span>
<a href="#l3.174"></a><span id="l3.174">       jobItemGoal  = job.goal;</span>
<a href="#l3.175"></a><span id="l3.175">     }</span>
<a href="#l3.176"></a><span id="l3.176">     else {</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-      status = this._strBundle.getString(&quot;actionIdle&quot;);</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+      status = Gloda.kIndexerIdle;</span>
<a href="#l3.179"></a><span id="l3.179">       prettyName = null;</span>
<a href="#l3.180"></a><span id="l3.180">       jobIndex = 0;</span>
<a href="#l3.181"></a><span id="l3.181">       jobTotal = 1;</span>
<a href="#l3.182"></a><span id="l3.182">       jobItemIndex = 0;</span>
<a href="#l3.183"></a><span id="l3.183">       jobItemGoal = 1;</span>
<a href="#l3.184"></a><span id="l3.184">     }</span>
<a href="#l3.185"></a><span id="l3.185">       </span>
<a href="#l3.186"></a><span id="l3.186">     for (let iListener=this._indexListeners.length-1; iListener &gt;= 0; </span>
<a href="#l3.187"></a><span id="l3.187" class="difflineat">@@ -473,35 +471,35 @@ let GlodaIndexer = {</span>
<a href="#l3.188"></a><span id="l3.188">     // The msf may need to be created or otherwise updated, updateFolder will</span>
<a href="#l3.189"></a><span id="l3.189">     //  do this for us.  (GetNewMessages would also do it, but we would be</span>
<a href="#l3.190"></a><span id="l3.190">     //  triggering new message retrieval in that case, which we don't actually</span>
<a href="#l3.191"></a><span id="l3.191">     //  desire.</span>
<a href="#l3.192"></a><span id="l3.192">     // TODO: handle password-protected local cache potentially triggering a</span>
<a href="#l3.193"></a><span id="l3.193">     //  password prompt here...</span>
<a href="#l3.194"></a><span id="l3.194">     try {</span>
<a href="#l3.195"></a><span id="l3.195">       try {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-        this._indexingFolder.updateFolder(this._msgWindow);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+        this._indexingFolder.updateFolder(null);</span>
<a href="#l3.198"></a><span id="l3.198">       }</span>
<a href="#l3.199"></a><span id="l3.199">       catch ( e if e.result == 0xc1f30001) {</span>
<a href="#l3.200"></a><span id="l3.200">         // this means that we need to pend on the update.</span>
<a href="#l3.201"></a><span id="l3.201">         this._log.debug(&quot;Pending on folder load...&quot;);</span>
<a href="#l3.202"></a><span id="l3.202">         this._pendingFolderEntry = this._indexingFolder;</span>
<a href="#l3.203"></a><span id="l3.203">         this._indexingFolder = null;</span>
<a href="#l3.204"></a><span id="l3.204">         this._indexingFolderID = null;</span>
<a href="#l3.205"></a><span id="l3.205">         this._indexingDatabase = null;</span>
<a href="#l3.206"></a><span id="l3.206">         this._indexingIterator = null;</span>
<a href="#l3.207"></a><span id="l3.207">         return kWorkAsync;</span>
<a href="#l3.208"></a><span id="l3.208">       }</span>
<a href="#l3.209"></a><span id="l3.209">       // we get an nsIMsgDatabase out of this (unsurprisingly) which</span>
<a href="#l3.210"></a><span id="l3.210">       //  explicitly inherits from nsIDBChangeAnnouncer, which has the</span>
<a href="#l3.211"></a><span id="l3.211">       //  AddListener call we want.</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-      this._indexingDatabase = folder.getMsgDatabase(this._msgWindow);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+      this._indexingDatabase = folder.getMsgDatabase(null);</span>
<a href="#l3.214"></a><span id="l3.214">       if (aNeedIterator)</span>
<a href="#l3.215"></a><span id="l3.215">         this._indexingIterator = fixIterator(</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-                                   //folder.getMessages(this._msgWindow),</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+                                   //folder.getMessages(null),</span>
<a href="#l3.218"></a><span id="l3.218">                                    this._indexingDatabase.EnumerateMessages(),</span>
<a href="#l3.219"></a><span id="l3.219">                                    Ci.nsIMsgDBHdr);</span>
<a href="#l3.220"></a><span id="l3.220">       this._databaseAnnouncerListener.indexer = this;</span>
<a href="#l3.221"></a><span id="l3.221">       this._indexingDatabase.AddListener(this._databaseAnnouncerListener);</span>
<a href="#l3.222"></a><span id="l3.222">     }</span>
<a href="#l3.223"></a><span id="l3.223">     catch (ex) {</span>
<a href="#l3.224"></a><span id="l3.224">       this._log.error(&quot;Problem entering folder: &quot; +</span>
<a href="#l3.225"></a><span id="l3.225">                       folder.prettiestName + &quot;, skipping.&quot;);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineat">@@ -551,42 +549,45 @@ let GlodaIndexer = {</span>
<a href="#l3.227"></a><span id="l3.227">       this._pendingFolderEntry = null;</span>
<a href="#l3.228"></a><span id="l3.228">       this.callbackDriver();</span>
<a href="#l3.229"></a><span id="l3.229">     }</span>
<a href="#l3.230"></a><span id="l3.230">   },</span>
<a href="#l3.231"></a><span id="l3.231">   </span>
<a href="#l3.232"></a><span id="l3.232">   /**</span>
<a href="#l3.233"></a><span id="l3.233">    * A simple wrapper to make 'this' be right for incrementalIndex.</span>
<a href="#l3.234"></a><span id="l3.234">    */</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-  _wrapCallbackDriver: function gloda_index_wrapCallbackDriver(aThis) {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    aThis.callbackDriver();</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+  _wrapCallbackDriver: function gloda_index_wrapCallbackDriver() {</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+    GlodaIndexer.callbackDriver();</span>
<a href="#l3.239"></a><span id="l3.239">   },</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241">   /**</span>
<a href="#l3.242"></a><span id="l3.242">    * The current processing 'batch' generator, produced by a call to workBatch()</span>
<a href="#l3.243"></a><span id="l3.243">    *  and used by callbackDriver to drive execution.</span>
<a href="#l3.244"></a><span id="l3.244">    */</span>
<a href="#l3.245"></a><span id="l3.245">   _batch: null,</span>
<a href="#l3.246"></a><span id="l3.246">   _inCallback: false,</span>
<a href="#l3.247"></a><span id="l3.247">   /**</span>
<a href="#l3.248"></a><span id="l3.248">    * The root work-driver.  callbackDriver creates workBatch generator instances</span>
<a href="#l3.249"></a><span id="l3.249">    *  (stored in _batch) which run until they are done (kWorkDone) or they</span>
<a href="#l3.250"></a><span id="l3.250">    *  (really the embedded _actualWorker) encounter something asynchronous.</span>
<a href="#l3.251"></a><span id="l3.251">    *  The convention is that all the callback handlers end up calling us,</span>
<a href="#l3.252"></a><span id="l3.252">    *  ensuring that control-flow properly resumes.  If the batch completes,</span>
<a href="#l3.253"></a><span id="l3.253">    *  we re-schedule ourselves after a time delay (controlled by _indexInterval)</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-   *  and return.</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+   *  and return.  (We use one-shot timers because repeating-slack does not</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+   *  know enough to deal with our (current) asynchronous nature.)</span>
<a href="#l3.257"></a><span id="l3.257">    */</span>
<a href="#l3.258"></a><span id="l3.258">   callbackDriver: function gloda_index_callbackDriver() {</span>
<a href="#l3.259"></a><span id="l3.259">     // it is conceivable that someone we call will call something that in some</span>
<a href="#l3.260"></a><span id="l3.260">     //  cases might be asynchronous, and in other cases immediately generate</span>
<a href="#l3.261"></a><span id="l3.261">     //  events without returning.  In the interest of (stack-depth) sanity,</span>
<a href="#l3.262"></a><span id="l3.262">     //  let's handle this by performing a minimal time-delay callback.</span>
<a href="#l3.263"></a><span id="l3.263">     if (this._inCallback) {</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-      this._domWindow.setTimeout(this._wrapCallbackDriver, 0, this);</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+      this._timer.initWithCallback(this._wrapCallbackDriver,</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+                                   0,</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+                                   Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l3.268"></a><span id="l3.268">       return;</span>
<a href="#l3.269"></a><span id="l3.269">     }</span>
<a href="#l3.270"></a><span id="l3.270">     this._inCallback = true;</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272">     try {</span>
<a href="#l3.273"></a><span id="l3.273">       if (this._batch === null)</span>
<a href="#l3.274"></a><span id="l3.274">         this._batch = this.workBatch();</span>
<a href="#l3.275"></a><span id="l3.275">       </span>
<a href="#l3.276"></a><span id="l3.276" class="difflineat">@@ -595,19 +596,19 @@ let GlodaIndexer = {</span>
<a href="#l3.277"></a><span id="l3.277">       //  not done indexing.  (On kWorkAsync, we don't care what happens, because</span>
<a href="#l3.278"></a><span id="l3.278">       //  someone else will be receiving the callback, and they will call us when</span>
<a href="#l3.279"></a><span id="l3.279">       //  they are done doing their thing.</span>
<a href="#l3.280"></a><span id="l3.280">       if (this._batch.next() == kWorkDone) {</span>
<a href="#l3.281"></a><span id="l3.281">         this._batch.close();</span>
<a href="#l3.282"></a><span id="l3.282">         this._batch = null;</span>
<a href="#l3.283"></a><span id="l3.283"> </span>
<a href="#l3.284"></a><span id="l3.284">         if (this.indexing)</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-          this._domWindow.setTimeout(this._wrapCallbackDriver,</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-                                     this._indexInterval,</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-                                     this);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+          this._timer.initWithCallback(this._wrapCallbackDriver,</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+                                       this._indexInterval,</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+                                       Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l3.291"></a><span id="l3.291">       }</span>
<a href="#l3.292"></a><span id="l3.292">     }</span>
<a href="#l3.293"></a><span id="l3.293">     finally {    </span>
<a href="#l3.294"></a><span id="l3.294">       this._inCallback = false;</span>
<a href="#l3.295"></a><span id="l3.295">     }</span>
<a href="#l3.296"></a><span id="l3.296">   },</span>
<a href="#l3.297"></a><span id="l3.297"> </span>
<a href="#l3.298"></a><span id="l3.298">   /**</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineat">@@ -1193,17 +1194,17 @@ let GlodaIndexer = {</span>
<a href="#l3.300"></a><span id="l3.300">     onHdrPropertyChanged: function (aHdrToChange, aPreChange, aStatus,</span>
<a href="#l3.301"></a><span id="l3.301">                                     aInstigator) {},</span>
<a href="#l3.302"></a><span id="l3.302">   },</span>
<a href="#l3.303"></a><span id="l3.303">   </span>
<a href="#l3.304"></a><span id="l3.304">   /* ***** MailNews Shutdown ***** */</span>
<a href="#l3.305"></a><span id="l3.305">   // TODO: implement a shutdown/pre-shutdown listener that attempts to either</span>
<a href="#l3.306"></a><span id="l3.306">   //  drain the indexing queue or persist it.</span>
<a href="#l3.307"></a><span id="l3.307">   /**</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-   * Shutdown task.</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+   * Shutdown task.  THIS IS NOT HOOKED UP TO ANYTHING YET.</span>
<a href="#l3.310"></a><span id="l3.310">    *</span>
<a href="#l3.311"></a><span id="l3.311">    * We implement nsIMsgShutdownTask, served up by nsIMsgShutdownService.  We</span>
<a href="#l3.312"></a><span id="l3.312">    *  offer our services by registering ourselves as a &quot;msg-shutdown&quot; observer</span>
<a href="#l3.313"></a><span id="l3.313">    *  with the observer service.</span>
<a href="#l3.314"></a><span id="l3.314">    */</span>
<a href="#l3.315"></a><span id="l3.315">   _shutdownTask: {</span>
<a href="#l3.316"></a><span id="l3.316">     indexer: null,</span>
<a href="#l3.317"></a><span id="l3.317">     </span>
<a href="#l3.318"></a><span id="l3.318" class="difflineat">@@ -1226,17 +1227,18 @@ let GlodaIndexer = {</span>
<a href="#l3.319"></a><span id="l3.319">     doShutdownTask: function gloda_indexer_doShutdownTask(aUrlListener,</span>
<a href="#l3.320"></a><span id="l3.320">                                                           aMsgWingow) {</span>
<a href="#l3.321"></a><span id="l3.321">       this.indexer._onStopIndexingUrlListener = aUrlListener;</span>
<a href="#l3.322"></a><span id="l3.322">       </span>
<a href="#l3.323"></a><span id="l3.323">       return true;</span>
<a href="#l3.324"></a><span id="l3.324">     },</span>
<a href="#l3.325"></a><span id="l3.325">     </span>
<a href="#l3.326"></a><span id="l3.326">     getCurrentTaskName: function gloda_indexer_getCurrentTaskName() {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-      return this.indexer.strBundle.getString(&quot;shutdownTaskName&quot;);</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+      // if we hook this up, we will probably need to L10n this after all...</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+      return &quot;Global Database Indexer&quot;; // L10n me</span>
<a href="#l3.330"></a><span id="l3.330">     },</span>
<a href="#l3.331"></a><span id="l3.331">   }, </span>
<a href="#l3.332"></a><span id="l3.332">   </span>
<a href="#l3.333"></a><span id="l3.333">   /**</span>
<a href="#l3.334"></a><span id="l3.334">    * Attempt to extract the original subject from a message.  For replies, this</span>
<a href="#l3.335"></a><span id="l3.335">    *  means either taking off the 're[#]:' (or variant, including other language</span>
<a href="#l3.336"></a><span id="l3.336">    *  variants), or in a Microsoft specific-ism, from the Thread-Topic header.</span>
<a href="#l3.337"></a><span id="l3.337">    * Since we are using the nsIMsgDBHdr's subject field, this is already done</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineat">@@ -1489,8 +1491,9 @@ let GlodaIndexer = {</span>
<a href="#l3.339"></a><span id="l3.339">    *  referencing the conversation.</span>
<a href="#l3.340"></a><span id="l3.340">    */</span>
<a href="#l3.341"></a><span id="l3.341">   _deleteConversationOfMessage:</span>
<a href="#l3.342"></a><span id="l3.342">       function gloda_index_deleteConversationOfMessage(aMessage) {</span>
<a href="#l3.343"></a><span id="l3.343">     aMessage._datastore.deleteMessagesByConversationID(aMessage.conversationID);</span>
<a href="#l3.344"></a><span id="l3.344">     aMessage._datastore.deleteConversationByID(aMessage.conversationID);</span>
<a href="#l3.345"></a><span id="l3.345">   },</span>
<a href="#l3.346"></a><span id="l3.346"> };</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+GlodaIndexer._init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/modules/public.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,24 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+EXPORTED_SYMBOLS = ['Gloda'];</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+Cu.import(&quot;resource://gloda/modules/gloda.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+Cu.import(&quot;resource://gloda/modules/everybody.js&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+Cu.import(&quot;resource://gloda/modules/indexer.js&quot;);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+/**</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ * Expose some junk </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ */</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+function proxy(aSourceObj, aSourceAttr, aDestObj, aDestAttr) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  aDestObj[aDestAttr] = function() {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    return aSourceObj[aSourceAttr].apply(aSourceObj, arguments);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  };</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+}</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+proxy(GlodaIndexer, &quot;addListener&quot;, Gloda, &quot;addIndexerListener&quot;);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+proxy(GlodaIndexer, &quot;removeListener&quot;, Gloda, &quot;removeIndexerListener&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

