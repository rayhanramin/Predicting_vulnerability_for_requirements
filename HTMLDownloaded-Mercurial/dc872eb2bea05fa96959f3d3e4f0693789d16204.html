<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24579:dc872eb2bea05fa96959f3d3e4f0693789d16204</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dc872eb2bea05fa96959f3d3e4f0693789d16204" />
<meta property="og:url" content="/comm-central/rev/dc872eb2bea05fa96959f3d3e4f0693789d16204" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/addrbook; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dc872eb2bea05fa96959f3d3e4f0693789d16204 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dc872eb2bea05fa96959f3d3e4f0693789d16204">shortlog</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dc872eb2bea05fa96959f3d3e4f0693789d16204">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204">files</a> |
changeset |
<a href="/comm-central/raw-rev/dc872eb2bea05fa96959f3d3e4f0693789d16204">raw</a>  | <a href="/comm-central/archive/dc872eb2bea05fa96959f3d3e4f0693789d16204.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/addrbook; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 27 Aug 2018 21:49:35 +1200</td></tr>

<tr>
 <td>changeset 24579</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dc872eb2bea05fa96959f3d3e4f0693789d16204">dc872eb2bea05fa96959f3d3e4f0693789d16204</a></td>
</tr>



<tr>
<td>parent 24578</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9289d8a37eb2dae82f2ecc0076ec8396126a5526">9289d8a37eb2dae82f2ecc0076ec8396126a5526</a>
</td>
</tr>

<tr>
<td>child 24580</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1cf799b1afa82d114fbb543925074d1f754543d4">1cf799b1afa82d114fbb543925074d1f754543d4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dc872eb2bea05fa96959f3d3e4f0693789d16204">14794</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 27 Aug 2018 09:50:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dc872eb2bea0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dc872eb2bea05fa96959f3d3e4f0693789d16204">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dc872eb2bea05fa96959f3d3e4f0693789d16204&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dc872eb2bea05fa96959f3d3e4f0693789d16204&newProject=comm-central&newRevision=dc872eb2bea05fa96959f3d3e4f0693789d16204&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dc872eb2bea05fa96959f3d3e4f0693789d16204&newProject=comm-central&newRevision=dc872eb2bea05fa96959f3d3e4f0693789d16204&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dc872eb2bea05fa96959f3d3e4f0693789d16204&newProject=comm-central&newRevision=dc872eb2bea05fa96959f3d3e4f0693789d16204&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/addrbook; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/.eslintignore">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/.eslintignore">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/.eslintignore">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/.eslintignore">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/.eslintrc.js">mail/components/addrbook/content/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCard.js">mail/components/addrbook/content/abCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCard.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCard.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCard.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCard.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCardView.js">mail/components/addrbook/content/abCardView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCardView.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCardView.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCardView.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCardView.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCardView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCommon.js">mail/components/addrbook/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abContactsPanel.js">mail/components/addrbook/content/abContactsPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abContactsPanel.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abContactsPanel.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abContactsPanel.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abContactsPanel.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abContactsPanel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abTrees.js">mail/components/addrbook/content/abTrees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abTrees.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abTrees.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abTrees.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abTrees.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/abTrees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/addressbook.js">mail/components/addrbook/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/dc872eb2bea05fa96959f3d3e4f0693789d16204/mail/components/addrbook/content/addressbook.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -37,16 +37,17 @@ mail/installer/**</span>
<a href="#l1.4"></a><span id="l1.4"> mail/locales/**</span>
<a href="#l1.5"></a><span id="l1.5"> mail/test/**</span>
<a href="#l1.6"></a><span id="l1.6"> mail/themes/**</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # mail/components exclusions</span>
<a href="#l1.9"></a><span id="l1.9"> mail/components/*</span>
<a href="#l1.10"></a><span id="l1.10"> !mail/components/about-support</span>
<a href="#l1.11"></a><span id="l1.11"> !mail/components/accountcreation</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+!mail/components/addrbook</span>
<a href="#l1.13"></a><span id="l1.13"> !mail/components/devtools</span>
<a href="#l1.14"></a><span id="l1.14"> !mail/components/downloads</span>
<a href="#l1.15"></a><span id="l1.15"> !mail/components/extensions</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> # calendar/ exclusions</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> # prefs files</span>
<a href="#l1.20"></a><span id="l1.20"> calendar/lightning/content/lightning.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/components/addrbook/content/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+module.exports = { // eslint-disable-line no-undef</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+  &quot;globals&quot;: {</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+    // abCommon.js</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+    &quot;AbEditCard&quot;: true,</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    &quot;AbNewMessage&quot;: true,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    &quot;ChangeDirectoryByURI&quot;: true,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &quot;DirPaneController&quot;: true,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    &quot;GenerateAddressFromCard&quot;: true,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    &quot;GetDirectoryFromURI&quot;: true,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    &quot;GetParentDirectoryFromMailingListURI&quot;: true,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    &quot;InitCommonJS&quot;: true,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    &quot;SelectFirstAddressBook&quot;: true,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    &quot;abList&quot;: true,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    &quot;defaultPhotoURI&quot;: true,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    &quot;gAbResultsTree&quot;: true,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    &quot;gAbView&quot;: true,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    &quot;gAddressBookBundle&quot;: true,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    &quot;gDirTree&quot;: true,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    &quot;gImageDownloader&quot;: true,</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    &quot;gShowAbColumnInComposeSidebar&quot;: true,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    &quot;getPhotoURI&quot;: true,</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+    &quot;getPhotosDir&quot;: true,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    &quot;getSelectedDirectory&quot;: true,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    &quot;getSelectedDirectoryURI&quot;: true,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    &quot;goNewCardDialog&quot;: true,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    &quot;goNewListDialog&quot;: true,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    &quot;kAllDirectoryRoot&quot;: true,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    &quot;kCollectedAddressbookURI&quot;: true,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    &quot;kDefaultAscending&quot;: true,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    &quot;kDefaultDescending&quot;: true,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    &quot;kDefaultSortColumn&quot;: true,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    &quot;kDefaultYear&quot;: true,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    &quot;kLdapUrlPrefix&quot;: true,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    &quot;kMaxYear&quot;: true,</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    &quot;kMinYear&quot;: true,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    &quot;kPersonalAddressbookURI&quot;: true,</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    &quot;saneBirthYear&quot;: true,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    &quot;selectStartupViewDirectory&quot;: true,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+    // mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    &quot;AbEditSelectedCard&quot;: true,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    &quot;CloseAbView&quot;: true,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    &quot;GetSelectedAbCards&quot;: true,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    &quot;GetSelectedAddresses&quot;: true,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    &quot;GetSelectedCardIndex&quot;: true,</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    &quot;GetSelectedCardTypes&quot;: true,</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    &quot;ResultsPaneController&quot;: true,</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    &quot;SelectFirstCard&quot;: true,</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    &quot;SetAbView&quot;: true,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    &quot;SortAndUpdateIndicators&quot;: true,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  }</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/abCard.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCard.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l3.5"></a><span id="l3.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+var { MailServices } = ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;, null);</span>
<a href="#l3.12"></a><span id="l3.12"> </span>
<a href="#l3.13"></a><span id="l3.13"> var kNonVcardFields =</span>
<a href="#l3.14"></a><span id="l3.14">         [&quot;NickNameContainer&quot;, &quot;SecondaryEmailContainer&quot;, &quot;ScreenNameContainer&quot;,</span>
<a href="#l3.15"></a><span id="l3.15">          &quot;customFields&quot;, &quot;preferDisplayName&quot;];</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> var kPhoneticFields =</span>
<a href="#l3.18"></a><span id="l3.18">         [&quot;PhoneticLastName&quot;, &quot;PhoneticLabel1&quot;, &quot;PhoneticSpacer1&quot;,</span>
<a href="#l3.19"></a><span id="l3.19">          &quot;PhoneticFirstName&quot;, &quot;PhoneticLabel2&quot;, &quot;PhoneticSpacer2&quot;];</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineat">@@ -64,58 +64,56 @@ var kVcardFields =</span>
<a href="#l3.21"></a><span id="l3.21">          [&quot;QQ&quot;, &quot;_QQ&quot;],</span>
<a href="#l3.22"></a><span id="l3.22">          [&quot;MSN&quot;, &quot;_MSN&quot;],</span>
<a href="#l3.23"></a><span id="l3.23">          [&quot;ICQ&quot;, &quot;_ICQ&quot;],</span>
<a href="#l3.24"></a><span id="l3.24">          [&quot;XMPP&quot;, &quot;_JabberId&quot;],</span>
<a href="#l3.25"></a><span id="l3.25">          [&quot;IRC&quot;, &quot;_IRC&quot;]</span>
<a href="#l3.26"></a><span id="l3.26">         ];</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> var gEditCard;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-var gOnSaveListeners = new Array();</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-var gOnLoadListeners = new Array();</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+var gOnSaveListeners = [];</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+var gOnLoadListeners = [];</span>
<a href="#l3.33"></a><span id="l3.33"> var gOkCallback = null;</span>
<a href="#l3.34"></a><span id="l3.34"> var gHideABPicker = false;</span>
<a href="#l3.35"></a><span id="l3.35"> var gPhotoHandlers = {};</span>
<a href="#l3.36"></a><span id="l3.36"> // If any new photos were added to the card, this stores the name of the original</span>
<a href="#l3.37"></a><span id="l3.37"> // and any temporary new filenames used to store photos of the card.</span>
<a href="#l3.38"></a><span id="l3.38"> // 'null' is a valid value when there was no photo (e.g. the generic photo).</span>
<a href="#l3.39"></a><span id="l3.39"> var gOldPhotos = [];</span>
<a href="#l3.40"></a><span id="l3.40"> // If a new photo was added, the name is stored here.</span>
<a href="#l3.41"></a><span id="l3.41"> var gNewPhoto = null;</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-function OnLoadNewCard()</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-{</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+function OnLoadNewCard() {</span>
<a href="#l3.46"></a><span id="l3.46">   InitEditCard();</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   gEditCard.card =</span>
<a href="#l3.49"></a><span id="l3.49">     ((&quot;arguments&quot; in window) &amp;&amp; (window.arguments.length &gt; 0) &amp;&amp;</span>
<a href="#l3.50"></a><span id="l3.50">      (window.arguments[0] instanceof Ci.nsIAbCard))</span>
<a href="#l3.51"></a><span id="l3.51">     ? window.arguments[0]</span>
<a href="#l3.52"></a><span id="l3.52">     : Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l3.53"></a><span id="l3.53">         .createInstance(Ci.nsIAbCard);</span>
<a href="#l3.54"></a><span id="l3.54">   gEditCard.titleProperty = &quot;newContactTitle&quot;;</span>
<a href="#l3.55"></a><span id="l3.55">   gEditCard.selectedAB = &quot;&quot;;</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l3.60"></a><span id="l3.60">     gEditCard.selectedAB = kPersonalAddressbookURI;</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62">     if (&quot;selectedAB&quot; in window.arguments[0] &amp;&amp;</span>
<a href="#l3.63"></a><span id="l3.63">         (window.arguments[0].selectedAB != kAllDirectoryRoot + &quot;?&quot;)) {</span>
<a href="#l3.64"></a><span id="l3.64">       // check if selected ab is a mailing list</span>
<a href="#l3.65"></a><span id="l3.65">       var abURI = window.arguments[0].selectedAB;</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">       var directory = GetDirectoryFromURI(abURI);</span>
<a href="#l3.68"></a><span id="l3.68">       if (directory.isMailList) {</span>
<a href="#l3.69"></a><span id="l3.69">         var parentURI = GetParentDirectoryFromMailingListURI(abURI);</span>
<a href="#l3.70"></a><span id="l3.70">         if (parentURI)</span>
<a href="#l3.71"></a><span id="l3.71">           gEditCard.selectedAB = parentURI;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+      } else if (!directory.readOnly) {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+        gEditCard.selectedAB = window.arguments[0].selectedAB;</span>
<a href="#l3.74"></a><span id="l3.74">       }</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-      else if (!directory.readOnly)</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-        gEditCard.selectedAB = window.arguments[0].selectedAB;</span>
<a href="#l3.77"></a><span id="l3.77">     }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">     // we may have been given properties to pre-initialize the window with....</span>
<a href="#l3.80"></a><span id="l3.80">     // we'll fill these in here...</span>
<a href="#l3.81"></a><span id="l3.81">     if (&quot;primaryEmail&quot; in window.arguments[0])</span>
<a href="#l3.82"></a><span id="l3.82">       gEditCard.card.primaryEmail = window.arguments[0].primaryEmail;</span>
<a href="#l3.83"></a><span id="l3.83">     if (&quot;displayName&quot; in window.arguments[0]) {</span>
<a href="#l3.84"></a><span id="l3.84">       gEditCard.card.displayName = window.arguments[0].displayName;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineat">@@ -142,17 +140,17 @@ function OnLoadNewCard()</span>
<a href="#l3.86"></a><span id="l3.86">     if (&quot;titleProperty&quot; in window.arguments[0])</span>
<a href="#l3.87"></a><span id="l3.87">       gEditCard.titleProperty = window.arguments[0].titleProperty;</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">     if (&quot;hideABPicker&quot; in window.arguments[0])</span>
<a href="#l3.90"></a><span id="l3.90">       gHideABPicker = window.arguments[0].hideABPicker;</span>
<a href="#l3.91"></a><span id="l3.91">   }</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">   // set popup with address book names</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  var abPopup = document.getElementById('abPopup');</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  var abPopup = document.getElementById(&quot;abPopup&quot;);</span>
<a href="#l3.96"></a><span id="l3.96">   abPopup.value = gEditCard.selectedAB || kPersonalAddressbookURI;</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98">   if (gHideABPicker &amp;&amp; abPopup) {</span>
<a href="#l3.99"></a><span id="l3.99">     abPopup.hidden = true;</span>
<a href="#l3.100"></a><span id="l3.100">     document.getElementById(&quot;abPopupLabel&quot;).hidden = true;</span>
<a href="#l3.101"></a><span id="l3.101">   }</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103">   SetCardDialogTitle(gEditCard.card.displayName);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineat">@@ -182,18 +180,17 @@ function getContainingDirectory() {</span>
<a href="#l3.105"></a><span id="l3.105">     let dirId =</span>
<a href="#l3.106"></a><span id="l3.106">       gEditCard.card.directoryId</span>
<a href="#l3.107"></a><span id="l3.107">                     .substring(0, gEditCard.card.directoryId.indexOf(&quot;&amp;&quot;));</span>
<a href="#l3.108"></a><span id="l3.108">     directory = MailServices.ab.getDirectoryFromId(dirId);</span>
<a href="#l3.109"></a><span id="l3.109">   }</span>
<a href="#l3.110"></a><span id="l3.110">   return directory;</span>
<a href="#l3.111"></a><span id="l3.111"> }</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-function EditCardOKButton()</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-{</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+function EditCardOKButton() {</span>
<a href="#l3.116"></a><span id="l3.116">   if (!CheckCardRequiredDataPresence(document))</span>
<a href="#l3.117"></a><span id="l3.117">     return false;  // don't close window</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119">   // See if this card is in any mailing list</span>
<a href="#l3.120"></a><span id="l3.120">   // if so then we need to update the addresslists of those mailing lists</span>
<a href="#l3.121"></a><span id="l3.121">   let directory = getContainingDirectory();</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">   // if the directory is a mailing list we need to search all the mailing lists</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineat">@@ -214,17 +211,17 @@ function EditCardOKButton()</span>
<a href="#l3.125"></a><span id="l3.125">       // See if any card in this list is the one we edited.</span>
<a href="#l3.126"></a><span id="l3.126">       // Must compare card contents using .equals() instead of .indexOf()</span>
<a href="#l3.127"></a><span id="l3.127">       // because gEditCard is not really a member of the .addressLists array.</span>
<a href="#l3.128"></a><span id="l3.128">       let listCardsCount = subdir.addressLists.length;</span>
<a href="#l3.129"></a><span id="l3.129">       for (let index = 0; index &lt; listCardsCount; index++) {</span>
<a href="#l3.130"></a><span id="l3.130">         let card = subdir.addressLists</span>
<a href="#l3.131"></a><span id="l3.131">                          .queryElementAt(index, Ci.nsIAbCard);</span>
<a href="#l3.132"></a><span id="l3.132">         if (card.equals(gEditCard.card))</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-          foundDirectories.push({directory:subdir, cardIndex:index});</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+          foundDirectories.push({directory: subdir, cardIndex: index});</span>
<a href="#l3.135"></a><span id="l3.135">       }</span>
<a href="#l3.136"></a><span id="l3.136">     }</span>
<a href="#l3.137"></a><span id="l3.137">   }</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139">   CheckAndSetCardValues(gEditCard.card, document, false);</span>
<a href="#l3.140"></a><span id="l3.140"> </span>
<a href="#l3.141"></a><span id="l3.141">   directory.modifyCard(gEditCard.card);</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143" class="difflineat">@@ -240,62 +237,56 @@ function EditCardOKButton()</span>
<a href="#l3.144"></a><span id="l3.144"> </span>
<a href="#l3.145"></a><span id="l3.145">   // callback to allow caller to update</span>
<a href="#l3.146"></a><span id="l3.146">   if (gOkCallback)</span>
<a href="#l3.147"></a><span id="l3.147">     gOkCallback();</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149">   return true;  // close the window</span>
<a href="#l3.150"></a><span id="l3.150"> }</span>
<a href="#l3.151"></a><span id="l3.151"> </span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-function EditCardCancelButton()</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-{</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+function EditCardCancelButton() {</span>
<a href="#l3.155"></a><span id="l3.155">   // If a new photo was created, remove it now as it won't be used.</span>
<a href="#l3.156"></a><span id="l3.156">   purgeOldPhotos(false);</span>
<a href="#l3.157"></a><span id="l3.157"> }</span>
<a href="#l3.158"></a><span id="l3.158"> </span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-function OnLoadEditCard()</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-{</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+function OnLoadEditCard() {</span>
<a href="#l3.162"></a><span id="l3.162">   InitEditCard();</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164">   gEditCard.titleProperty = &quot;editContactTitle&quot;;</span>
<a href="#l3.165"></a><span id="l3.165"> </span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-  if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-  {</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l3.169"></a><span id="l3.169">     if (window.arguments[0].card)</span>
<a href="#l3.170"></a><span id="l3.170">       gEditCard.card = window.arguments[0].card;</span>
<a href="#l3.171"></a><span id="l3.171">     if (window.arguments[0].okCallback)</span>
<a href="#l3.172"></a><span id="l3.172">       gOkCallback = window.arguments[0].okCallback;</span>
<a href="#l3.173"></a><span id="l3.173">     if (window.arguments[0].abURI)</span>
<a href="#l3.174"></a><span id="l3.174">       gEditCard.abURI = window.arguments[0].abURI;</span>
<a href="#l3.175"></a><span id="l3.175">   }</span>
<a href="#l3.176"></a><span id="l3.176"> </span>
<a href="#l3.177"></a><span id="l3.177">   // set global state variables</span>
<a href="#l3.178"></a><span id="l3.178">   // if first or last name entered, disable generateDisplayName</span>
<a href="#l3.179"></a><span id="l3.179">   if (gEditCard.generateDisplayName &amp;&amp;</span>
<a href="#l3.180"></a><span id="l3.180">       (gEditCard.card.firstName.length +</span>
<a href="#l3.181"></a><span id="l3.181">        gEditCard.card.lastName.length +</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-       gEditCard.card.displayName.length &gt; 0))</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  {</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+       gEditCard.card.displayName.length &gt; 0)) {</span>
<a href="#l3.185"></a><span id="l3.185">     gEditCard.generateDisplayName = false;</span>
<a href="#l3.186"></a><span id="l3.186">   }</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188">   GetCardValues(gEditCard.card, document);</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">   SetCardDialogTitle(gEditCard.card.displayName);</span>
<a href="#l3.191"></a><span id="l3.191"> </span>
<a href="#l3.192"></a><span id="l3.192">   // check if selectedAB is a writeable</span>
<a href="#l3.193"></a><span id="l3.193">   // if not disable all the fields</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l3.197"></a><span id="l3.197">     if (&quot;abURI&quot; in window.arguments[0]) {</span>
<a href="#l3.198"></a><span id="l3.198">       var abURI = window.arguments[0].abURI;</span>
<a href="#l3.199"></a><span id="l3.199">       var directory = GetDirectoryFromURI(abURI);</span>
<a href="#l3.200"></a><span id="l3.200"> </span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-      if (directory.readOnly)</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-      {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+      if (directory.readOnly) {</span>
<a href="#l3.204"></a><span id="l3.204">         // Set all the editable vcard fields to read only</span>
<a href="#l3.205"></a><span id="l3.205">         for (var i = kVcardFields.length; i-- &gt; 0; )</span>
<a href="#l3.206"></a><span id="l3.206">           document.getElementById(kVcardFields[i][0]).readOnly = true;</span>
<a href="#l3.207"></a><span id="l3.207"> </span>
<a href="#l3.208"></a><span id="l3.208">         // the birthday fields</span>
<a href="#l3.209"></a><span id="l3.209">         document.getElementById(&quot;Birthday&quot;).readOnly = true;</span>
<a href="#l3.210"></a><span id="l3.210">         document.getElementById(&quot;BirthYear&quot;).readOnly = true;</span>
<a href="#l3.211"></a><span id="l3.211">         document.getElementById(&quot;Age&quot;).readOnly = true;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineat">@@ -325,155 +316,139 @@ function OnLoadEditCard()</span>
<a href="#l3.213"></a><span id="l3.213">   }</span>
<a href="#l3.214"></a><span id="l3.214"> }</span>
<a href="#l3.215"></a><span id="l3.215"> </span>
<a href="#l3.216"></a><span id="l3.216"> /* Registers functions that are called when loading the card</span>
<a href="#l3.217"></a><span id="l3.217">  * values into the contact editor dialog.  This is useful if</span>
<a href="#l3.218"></a><span id="l3.218">  * extensions have added extra fields to the nsIAbCard, and</span>
<a href="#l3.219"></a><span id="l3.219">  * need to display them in the contact editor.</span>
<a href="#l3.220"></a><span id="l3.220">  */</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-function RegisterLoadListener(aFunc)</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-{</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+function RegisterLoadListener(aFunc) {</span>
<a href="#l3.224"></a><span id="l3.224">   gOnLoadListeners[gOnLoadListeners.length] = aFunc;</span>
<a href="#l3.225"></a><span id="l3.225"> }</span>
<a href="#l3.226"></a><span id="l3.226"> </span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-function UnregisterLoadListener(aFunc)</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-{</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+function UnregisterLoadListener(aFunc) {</span>
<a href="#l3.230"></a><span id="l3.230">   var fIndex = gOnLoadListeners.indexOf(aFunc);</span>
<a href="#l3.231"></a><span id="l3.231">   if (fIndex != -1)</span>
<a href="#l3.232"></a><span id="l3.232">     gOnLoadListeners.splice(fIndex, 1);</span>
<a href="#l3.233"></a><span id="l3.233"> }</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235"> // Notifies load listeners that an nsIAbCard is being loaded.</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-function NotifyLoadListeners(aCard, aDoc)</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-{</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+function NotifyLoadListeners(aCard, aDoc) {</span>
<a href="#l3.239"></a><span id="l3.239">   if (!gOnLoadListeners.length)</span>
<a href="#l3.240"></a><span id="l3.240">     return;</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242">   for (var i = 0; i &lt; gOnLoadListeners.length; i++)</span>
<a href="#l3.243"></a><span id="l3.243">     gOnLoadListeners[i](aCard, aDoc);</span>
<a href="#l3.244"></a><span id="l3.244"> }</span>
<a href="#l3.245"></a><span id="l3.245"> </span>
<a href="#l3.246"></a><span id="l3.246"> /* Registers functions that are called when saving the card</span>
<a href="#l3.247"></a><span id="l3.247">  * values.  This is useful if extensions have added extra</span>
<a href="#l3.248"></a><span id="l3.248">  * fields to the user interface, and need to set those values</span>
<a href="#l3.249"></a><span id="l3.249">  * in their nsIAbCard.</span>
<a href="#l3.250"></a><span id="l3.250">  */</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-function RegisterSaveListener(func)</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-{</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+function RegisterSaveListener(func) {</span>
<a href="#l3.254"></a><span id="l3.254">   gOnSaveListeners[gOnSaveListeners.length] = func;</span>
<a href="#l3.255"></a><span id="l3.255"> }</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-function UnregisterSaveListener(aFunc)</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-{</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+function UnregisterSaveListener(aFunc) {</span>
<a href="#l3.260"></a><span id="l3.260">   var fIndex = gOnSaveListeners.indexOf(aFunc);</span>
<a href="#l3.261"></a><span id="l3.261">   if (fIndex != -1)</span>
<a href="#l3.262"></a><span id="l3.262">     gOnSaveListeners.splice(fIndex, 1);</span>
<a href="#l3.263"></a><span id="l3.263"> }</span>
<a href="#l3.264"></a><span id="l3.264"> </span>
<a href="#l3.265"></a><span id="l3.265"> // Notifies save listeners that an nsIAbCard is being saved.</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-function NotifySaveListeners(directory)</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-{</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+function NotifySaveListeners(directory) {</span>
<a href="#l3.269"></a><span id="l3.269">   if (!gOnSaveListeners.length)</span>
<a href="#l3.270"></a><span id="l3.270">     return;</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272">   for (var i = 0; i &lt; gOnSaveListeners.length; i++)</span>
<a href="#l3.273"></a><span id="l3.273">     gOnSaveListeners[i](gEditCard.card, document);</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275">   // the save listeners might have tweaked the card</span>
<a href="#l3.276"></a><span id="l3.276">   // in which case we need to commit it.</span>
<a href="#l3.277"></a><span id="l3.277">   directory.modifyCard(gEditCard.card);</span>
<a href="#l3.278"></a><span id="l3.278"> }</span>
<a href="#l3.279"></a><span id="l3.279"> </span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-function InitPhoneticFields()</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-{</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+function InitPhoneticFields() {</span>
<a href="#l3.283"></a><span id="l3.283">   var showPhoneticFields =</span>
<a href="#l3.284"></a><span id="l3.284">     Services.prefs.getComplexValue(&quot;mail.addr_book.show_phonetic_fields&quot;,</span>
<a href="#l3.285"></a><span id="l3.285">       Ci.nsIPrefLocalizedString).data;</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287">   // show phonetic fields if indicated by the pref</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-  if (showPhoneticFields == &quot;true&quot;)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-  {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+  if (showPhoneticFields == &quot;true&quot;) {</span>
<a href="#l3.291"></a><span id="l3.291">     for (var i = kPhoneticFields.length; i-- &gt; 0; )</span>
<a href="#l3.292"></a><span id="l3.292">       document.getElementById(kPhoneticFields[i]).hidden = false;</span>
<a href="#l3.293"></a><span id="l3.293">   }</span>
<a href="#l3.294"></a><span id="l3.294"> }</span>
<a href="#l3.295"></a><span id="l3.295"> </span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-function InitEditCard()</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-{</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+function InitEditCard() {</span>
<a href="#l3.299"></a><span id="l3.299">   InitPhoneticFields();</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301">   InitCommonJS();</span>
<a href="#l3.302"></a><span id="l3.302"> </span>
<a href="#l3.303"></a><span id="l3.303">   // Create gEditCard object that contains global variables for the current js</span>
<a href="#l3.304"></a><span id="l3.304">   //   file.</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-  gEditCard = new Object();</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  gEditCard = {};</span>
<a href="#l3.307"></a><span id="l3.307"> </span>
<a href="#l3.308"></a><span id="l3.308">   // get specific prefs that gEditCard will need</span>
<a href="#l3.309"></a><span id="l3.309">   try {</span>
<a href="#l3.310"></a><span id="l3.310">     var displayLastNameFirst =</span>
<a href="#l3.311"></a><span id="l3.311">       Services.prefs.getComplexValue(&quot;mail.addr_book.displayName.lastnamefirst&quot;,</span>
<a href="#l3.312"></a><span id="l3.312">         Ci.nsIPrefLocalizedString).data;</span>
<a href="#l3.313"></a><span id="l3.313">     gEditCard.displayLastNameFirst = (displayLastNameFirst == &quot;true&quot;);</span>
<a href="#l3.314"></a><span id="l3.314">     gEditCard.generateDisplayName =</span>
<a href="#l3.315"></a><span id="l3.315">       Services.prefs.getBoolPref(&quot;mail.addr_book.displayName.autoGeneration&quot;);</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-  }</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.319"></a><span id="l3.319">     dump(&quot;ex: failed to get pref&quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.320"></a><span id="l3.320">   }</span>
<a href="#l3.321"></a><span id="l3.321"> }</span>
<a href="#l3.322"></a><span id="l3.322"> </span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-function NewCardOKButton()</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-{</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-  if (gOkCallback)</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-  {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+function NewCardOKButton() {</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+  if (gOkCallback) {</span>
<a href="#l3.329"></a><span id="l3.329">     if (!CheckAndSetCardValues(gEditCard.card, document, true))</span>
<a href="#l3.330"></a><span id="l3.330">       return false;  // don't close window</span>
<a href="#l3.331"></a><span id="l3.331"> </span>
<a href="#l3.332"></a><span id="l3.332">     gOkCallback(gEditCard.card.translateTo(&quot;vcard&quot;));</span>
<a href="#l3.333"></a><span id="l3.333">     return true;  // close the window</span>
<a href="#l3.334"></a><span id="l3.334">   }</span>
<a href="#l3.335"></a><span id="l3.335"> </span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-  var popup = document.getElementById('abPopup');</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-  if (popup)</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-  {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+  var popup = document.getElementById(&quot;abPopup&quot;);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+  if (popup) {</span>
<a href="#l3.341"></a><span id="l3.341">     var uri = popup.value;</span>
<a href="#l3.342"></a><span id="l3.342"> </span>
<a href="#l3.343"></a><span id="l3.343">     // FIX ME - hack to avoid crashing if no ab selected because of blank option bug from template</span>
<a href="#l3.344"></a><span id="l3.344">     // should be able to just remove this if we are not seeing blank lines in the ab popup</span>
<a href="#l3.345"></a><span id="l3.345">     if (!uri)</span>
<a href="#l3.346"></a><span id="l3.346">       return false;  // don't close window</span>
<a href="#l3.347"></a><span id="l3.347">     // -----</span>
<a href="#l3.348"></a><span id="l3.348"> </span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-    if (gEditCard.card)</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-    {</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+    if (gEditCard.card) {</span>
<a href="#l3.352"></a><span id="l3.352">       if (!CheckAndSetCardValues(gEditCard.card, document, true))</span>
<a href="#l3.353"></a><span id="l3.353">         return false;  // don't close window</span>
<a href="#l3.354"></a><span id="l3.354"> </span>
<a href="#l3.355"></a><span id="l3.355">       // replace gEditCard.card with the card we added</span>
<a href="#l3.356"></a><span id="l3.356">       // so that save listeners can get / set attributes on</span>
<a href="#l3.357"></a><span id="l3.357">       // the card that got created.</span>
<a href="#l3.358"></a><span id="l3.358">       var directory = GetDirectoryFromURI(uri);</span>
<a href="#l3.359"></a><span id="l3.359">       gEditCard.card = directory.addCard(gEditCard.card);</span>
<a href="#l3.360"></a><span id="l3.360">       NotifySaveListeners(directory);</span>
<a href="#l3.361"></a><span id="l3.361">     }</span>
<a href="#l3.362"></a><span id="l3.362">   }</span>
<a href="#l3.363"></a><span id="l3.363"> </span>
<a href="#l3.364"></a><span id="l3.364">   return true;  // close the window</span>
<a href="#l3.365"></a><span id="l3.365"> }</span>
<a href="#l3.366"></a><span id="l3.366"> </span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-function NewCardCancelButton()</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-{</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+function NewCardCancelButton() {</span>
<a href="#l3.370"></a><span id="l3.370">   // If a new photo was created, remove it now as it won't be used.</span>
<a href="#l3.371"></a><span id="l3.371">   purgeOldPhotos(false);</span>
<a href="#l3.372"></a><span id="l3.372"> }</span>
<a href="#l3.373"></a><span id="l3.373"> </span>
<a href="#l3.374"></a><span id="l3.374"> // Move the data from the cardproperty to the dialog</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-function GetCardValues(cardproperty, doc)</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-{</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+function GetCardValues(cardproperty, doc) {</span>
<a href="#l3.378"></a><span id="l3.378">   if (!cardproperty)</span>
<a href="#l3.379"></a><span id="l3.379">     return;</span>
<a href="#l3.380"></a><span id="l3.380"> </span>
<a href="#l3.381"></a><span id="l3.381">   // Pass the nsIAbCard and the Document through the listeners</span>
<a href="#l3.382"></a><span id="l3.382">   // to give extensions a chance to populate custom fields.</span>
<a href="#l3.383"></a><span id="l3.383">   NotifyLoadListeners(cardproperty, doc);</span>
<a href="#l3.384"></a><span id="l3.384"> </span>
<a href="#l3.385"></a><span id="l3.385">   for (var i = kVcardFields.length; i-- &gt; 0; ) {</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineat">@@ -518,52 +493,49 @@ function GetCardValues(cardproperty, doc</span>
<a href="#l3.387"></a><span id="l3.387"> </span>
<a href="#l3.388"></a><span id="l3.388">   var popup = document.getElementById(&quot;PreferMailFormatPopup&quot;);</span>
<a href="#l3.389"></a><span id="l3.389">   if (popup)</span>
<a href="#l3.390"></a><span id="l3.390">     popup.value = cardproperty.getProperty(&quot;PreferMailFormat&quot;, &quot;&quot;);</span>
<a href="#l3.391"></a><span id="l3.391"> </span>
<a href="#l3.392"></a><span id="l3.392">   var preferDisplayNameEl = document.getElementById(&quot;preferDisplayName&quot;);</span>
<a href="#l3.393"></a><span id="l3.393">   if (preferDisplayNameEl)</span>
<a href="#l3.394"></a><span id="l3.394">     // getProperty may return a &quot;1&quot; or &quot;0&quot; string, we want a boolean</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-    preferDisplayNameEl.checked = cardproperty.getProperty(&quot;PreferDisplayName&quot;, true) != false;</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+    preferDisplayNameEl.checked = !cardproperty.getProperty(&quot;PreferDisplayName&quot;, true);</span>
<a href="#l3.397"></a><span id="l3.397"> </span>
<a href="#l3.398"></a><span id="l3.398">   // get phonetic fields if exist</span>
<a href="#l3.399"></a><span id="l3.399">   try {</span>
<a href="#l3.400"></a><span id="l3.400">     doc.getElementById(&quot;PhoneticFirstName&quot;).value = cardproperty.getProperty(&quot;PhoneticFirstName&quot;, &quot;&quot;);</span>
<a href="#l3.401"></a><span id="l3.401">     doc.getElementById(&quot;PhoneticLastName&quot;).value = cardproperty.getProperty(&quot;PhoneticLastName&quot;, &quot;&quot;);</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-  }</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-  catch (ex) {}</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.405"></a><span id="l3.405"> </span>
<a href="#l3.406"></a><span id="l3.406">   // Select the type if there is a valid value stored for that type, otherwise</span>
<a href="#l3.407"></a><span id="l3.407">   // select the generic photo</span>
<a href="#l3.408"></a><span id="l3.408">   loadPhoto(cardproperty);</span>
<a href="#l3.409"></a><span id="l3.409"> </span>
<a href="#l3.410"></a><span id="l3.410">   updateChatName();</span>
<a href="#l3.411"></a><span id="l3.411"> }</span>
<a href="#l3.412"></a><span id="l3.412"> </span>
<a href="#l3.413"></a><span id="l3.413"> // when the ab card dialog is being loaded to show a vCard,</span>
<a href="#l3.414"></a><span id="l3.414"> // hide the fields which aren't supported</span>
<a href="#l3.415"></a><span id="l3.415"> // by vCard so the user does not try to edit them.</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-function HideNonVcardFields()</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-{</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+function HideNonVcardFields() {</span>
<a href="#l3.419"></a><span id="l3.419">   document.getElementById(&quot;homeTabButton&quot;).hidden = true;</span>
<a href="#l3.420"></a><span id="l3.420">   document.getElementById(&quot;chatTabButton&quot;).hidden = true;</span>
<a href="#l3.421"></a><span id="l3.421">   document.getElementById(&quot;photoTabButton&quot;).hidden = true;</span>
<a href="#l3.422"></a><span id="l3.422">   var i;</span>
<a href="#l3.423"></a><span id="l3.423">   for (i = kNonVcardFields.length; i-- &gt; 0; )</span>
<a href="#l3.424"></a><span id="l3.424">     document.getElementById(kNonVcardFields[i]).collapsed = true;</span>
<a href="#l3.425"></a><span id="l3.425">   for (i = kPhoneticFields.length; i-- &gt; 0; )</span>
<a href="#l3.426"></a><span id="l3.426">     document.getElementById(kPhoneticFields[i]).collapsed = true;</span>
<a href="#l3.427"></a><span id="l3.427"> }</span>
<a href="#l3.428"></a><span id="l3.428"> </span>
<a href="#l3.429"></a><span id="l3.429"> // Move the data from the dialog to the cardproperty to be stored in the database</span>
<a href="#l3.430"></a><span id="l3.430"> // @Returns false - Some required data are missing (card values were not set);</span>
<a href="#l3.431"></a><span id="l3.431"> //          true - Card values were set, or there is no card to set values on.</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-function CheckAndSetCardValues(cardproperty, doc, check)</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-{</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+function CheckAndSetCardValues(cardproperty, doc, check) {</span>
<a href="#l3.435"></a><span id="l3.435">   // If requested, check the required data presence.</span>
<a href="#l3.436"></a><span id="l3.436">   if (check &amp;&amp; !CheckCardRequiredDataPresence(document))</span>
<a href="#l3.437"></a><span id="l3.437">     return false;</span>
<a href="#l3.438"></a><span id="l3.438"> </span>
<a href="#l3.439"></a><span id="l3.439">   if (!cardproperty)</span>
<a href="#l3.440"></a><span id="l3.440">     return true;</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442">   for (var i = kVcardFields.length; i-- &gt; 0; )</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineat">@@ -588,124 +560,112 @@ function CheckAndSetCardValues(cardprope</span>
<a href="#l3.444"></a><span id="l3.444">   var preferDisplayNameEl = document.getElementById(&quot;preferDisplayName&quot;);</span>
<a href="#l3.445"></a><span id="l3.445">   if (preferDisplayNameEl)</span>
<a href="#l3.446"></a><span id="l3.446">     cardproperty.setProperty(&quot;PreferDisplayName&quot;, preferDisplayNameEl.checked);</span>
<a href="#l3.447"></a><span id="l3.447"> </span>
<a href="#l3.448"></a><span id="l3.448">   // set phonetic fields if exist</span>
<a href="#l3.449"></a><span id="l3.449">   try {</span>
<a href="#l3.450"></a><span id="l3.450">     cardproperty.setProperty(&quot;PhoneticFirstName&quot;, doc.getElementById(&quot;PhoneticFirstName&quot;).value);</span>
<a href="#l3.451"></a><span id="l3.451">     cardproperty.setProperty(&quot;PhoneticLastName&quot;, doc.getElementById(&quot;PhoneticLastName&quot;).value);</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-  }</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-  catch (ex) {}</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.455"></a><span id="l3.455"> </span>
<a href="#l3.456"></a><span id="l3.456">   let photoType = doc.getElementById(&quot;PhotoType&quot;).value;</span>
<a href="#l3.457"></a><span id="l3.457">   if (gPhotoHandlers[photoType]) {</span>
<a href="#l3.458"></a><span id="l3.458">     if (!gPhotoHandlers[photoType].onSave(cardproperty, doc)) {</span>
<a href="#l3.459"></a><span id="l3.459">       photoType = &quot;generic&quot;;</span>
<a href="#l3.460"></a><span id="l3.460">       onSwitchPhotoType(&quot;generic&quot;);</span>
<a href="#l3.461"></a><span id="l3.461">       gPhotoHandlers[photoType].onSave(cardproperty, doc);</span>
<a href="#l3.462"></a><span id="l3.462">     }</span>
<a href="#l3.463"></a><span id="l3.463">   }</span>
<a href="#l3.464"></a><span id="l3.464">   cardproperty.setProperty(&quot;PhotoType&quot;, photoType);</span>
<a href="#l3.465"></a><span id="l3.465">   purgeOldPhotos(true);</span>
<a href="#l3.466"></a><span id="l3.466"> </span>
<a href="#l3.467"></a><span id="l3.467">   return true;</span>
<a href="#l3.468"></a><span id="l3.468"> }</span>
<a href="#l3.469"></a><span id="l3.469"> </span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-function CleanUpWebPage(webPage)</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-{</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+function CleanUpWebPage(webPage) {</span>
<a href="#l3.473"></a><span id="l3.473">   // no :// yet so we should add something</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-  if (webPage.length &amp;&amp; !webPage.includes(&quot;://&quot;))</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-  {</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+  if (webPage.length &amp;&amp; !webPage.includes(&quot;://&quot;)) {</span>
<a href="#l3.477"></a><span id="l3.477">     // check for missing / on http://</span>
<a href="#l3.478"></a><span id="l3.478">     if (webPage.startsWith(&quot;http:/&quot;))</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-      return(&quot;http://&quot; + webPage.substr(6));</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-    else</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-      return(&quot;http://&quot; + webPage);</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+      return (&quot;http://&quot; + webPage.substr(6));</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+    return (&quot;http://&quot; + webPage);</span>
<a href="#l3.484"></a><span id="l3.484">   }</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-  else</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    return(webPage);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+  return (webPage);</span>
<a href="#l3.488"></a><span id="l3.488"> }</span>
<a href="#l3.489"></a><span id="l3.489"> </span>
<a href="#l3.490"></a><span id="l3.490"> // @Returns false - Some required data are missing;</span>
<a href="#l3.491"></a><span id="l3.491"> //          true - All required data are present.</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-function CheckCardRequiredDataPresence(doc)</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-{</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+function CheckCardRequiredDataPresence(doc) {</span>
<a href="#l3.495"></a><span id="l3.495">   // Bug 314995 We require at least one of the following fields to be</span>
<a href="#l3.496"></a><span id="l3.496">   // filled in: email address, first name, last name, display name,</span>
<a href="#l3.497"></a><span id="l3.497">   //            organization (company name).</span>
<a href="#l3.498"></a><span id="l3.498">   var primaryEmail = doc.getElementById(&quot;PrimaryEmail&quot;);</span>
<a href="#l3.499"></a><span id="l3.499">   if (primaryEmail.textLength == 0 &amp;&amp;</span>
<a href="#l3.500"></a><span id="l3.500">     doc.getElementById(&quot;FirstName&quot;).textLength == 0 &amp;&amp;</span>
<a href="#l3.501"></a><span id="l3.501">     doc.getElementById(&quot;LastName&quot;).textLength == 0 &amp;&amp;</span>
<a href="#l3.502"></a><span id="l3.502">     doc.getElementById(&quot;DisplayName&quot;).textLength == 0 &amp;&amp;</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-    doc.getElementById(&quot;Company&quot;).textLength == 0)</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-  {</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+    doc.getElementById(&quot;Company&quot;).textLength == 0) {</span>
<a href="#l3.506"></a><span id="l3.506">     Services.prompt.alert(</span>
<a href="#l3.507"></a><span id="l3.507">       window,</span>
<a href="#l3.508"></a><span id="l3.508">       gAddressBookBundle.getString(&quot;cardRequiredDataMissingTitle&quot;),</span>
<a href="#l3.509"></a><span id="l3.509">       gAddressBookBundle.getString(&quot;cardRequiredDataMissingMessage&quot;));</span>
<a href="#l3.510"></a><span id="l3.510"> </span>
<a href="#l3.511"></a><span id="l3.511">     return false;</span>
<a href="#l3.512"></a><span id="l3.512">   }</span>
<a href="#l3.513"></a><span id="l3.513"> </span>
<a href="#l3.514"></a><span id="l3.514">   // Simple checks that the primary email should be of the form |user@host|.</span>
<a href="#l3.515"></a><span id="l3.515">   // Note: if the length of the primary email is 0 then we skip the check</span>
<a href="#l3.516"></a><span id="l3.516">   // as some other field must have something as per the check above.</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-  if (primaryEmail.textLength != 0 &amp;&amp; !/.@./.test(primaryEmail.value))</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-  {</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+  if (primaryEmail.textLength != 0 &amp;&amp; !/.@./.test(primaryEmail.value)) {</span>
<a href="#l3.520"></a><span id="l3.520">     Services.prompt.alert(</span>
<a href="#l3.521"></a><span id="l3.521">       window,</span>
<a href="#l3.522"></a><span id="l3.522">       gAddressBookBundle.getString(&quot;incorrectEmailAddressFormatTitle&quot;),</span>
<a href="#l3.523"></a><span id="l3.523">       gAddressBookBundle.getString(&quot;incorrectEmailAddressFormatMessage&quot;));</span>
<a href="#l3.524"></a><span id="l3.524"> </span>
<a href="#l3.525"></a><span id="l3.525">     // Focus the dialog field, to help the user.</span>
<a href="#l3.526"></a><span id="l3.526">     document.getElementById(&quot;abTabs&quot;).selectedIndex = 0;</span>
<a href="#l3.527"></a><span id="l3.527">     primaryEmail.focus();</span>
<a href="#l3.528"></a><span id="l3.528"> </span>
<a href="#l3.529"></a><span id="l3.529">     return false;</span>
<a href="#l3.530"></a><span id="l3.530">   }</span>
<a href="#l3.531"></a><span id="l3.531"> </span>
<a href="#l3.532"></a><span id="l3.532">   return true;</span>
<a href="#l3.533"></a><span id="l3.533"> }</span>
<a href="#l3.534"></a><span id="l3.534"> </span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-function GenerateDisplayName()</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-{</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+function GenerateDisplayName() {</span>
<a href="#l3.538"></a><span id="l3.538">   if (!gEditCard.generateDisplayName)</span>
<a href="#l3.539"></a><span id="l3.539">     return;</span>
<a href="#l3.540"></a><span id="l3.540"> </span>
<a href="#l3.541"></a><span id="l3.541">   var displayName;</span>
<a href="#l3.542"></a><span id="l3.542"> </span>
<a href="#l3.543"></a><span id="l3.543">   var firstNameValue = document.getElementById(&quot;FirstName&quot;).value;</span>
<a href="#l3.544"></a><span id="l3.544">   var lastNameValue = document.getElementById(&quot;LastName&quot;).value;</span>
<a href="#l3.545"></a><span id="l3.545">   if (lastNameValue &amp;&amp; firstNameValue) {</span>
<a href="#l3.546"></a><span id="l3.546">     displayName = (gEditCard.displayLastNameFirst)</span>
<a href="#l3.547"></a><span id="l3.547">       ? gAddressBookBundle.getFormattedString(&quot;lastFirstFormat&quot;, [lastNameValue, firstNameValue])</span>
<a href="#l3.548"></a><span id="l3.548">       : gAddressBookBundle.getFormattedString(&quot;firstLastFormat&quot;, [firstNameValue, lastNameValue]);</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-  }</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-  else {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+  } else {</span>
<a href="#l3.552"></a><span id="l3.552">     // one (or both) of these is empty, so this works.</span>
<a href="#l3.553"></a><span id="l3.553">     displayName = firstNameValue + lastNameValue;</span>
<a href="#l3.554"></a><span id="l3.554">   }</span>
<a href="#l3.555"></a><span id="l3.555"> </span>
<a href="#l3.556"></a><span id="l3.556">   document.getElementById(&quot;DisplayName&quot;).value = displayName;</span>
<a href="#l3.557"></a><span id="l3.557"> </span>
<a href="#l3.558"></a><span id="l3.558">   SetCardDialogTitle(displayName);</span>
<a href="#l3.559"></a><span id="l3.559"> }</span>
<a href="#l3.560"></a><span id="l3.560"> </span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-function DisplayNameChanged()</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-{</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+function DisplayNameChanged() {</span>
<a href="#l3.564"></a><span id="l3.564">   // turn off generateDisplayName if the user changes the display name</span>
<a href="#l3.565"></a><span id="l3.565">   gEditCard.generateDisplayName = false;</span>
<a href="#l3.566"></a><span id="l3.566"> </span>
<a href="#l3.567"></a><span id="l3.567">   SetCardDialogTitle(document.getElementById(&quot;DisplayName&quot;).value);</span>
<a href="#l3.568"></a><span id="l3.568"> }</span>
<a href="#l3.569"></a><span id="l3.569"> </span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-function SetCardDialogTitle(displayName)</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-{</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+function SetCardDialogTitle(displayName) {</span>
<a href="#l3.573"></a><span id="l3.573">   document.title = displayName</span>
<a href="#l3.574"></a><span id="l3.574">     ? gAddressBookBundle.getFormattedString(gEditCard.titleProperty + &quot;WithDisplayName&quot;, [displayName])</span>
<a href="#l3.575"></a><span id="l3.575">     : gAddressBookBundle.getString(gEditCard.titleProperty);</span>
<a href="#l3.576"></a><span id="l3.576"> }</span>
<a href="#l3.577"></a><span id="l3.577"> </span>
<a href="#l3.578"></a><span id="l3.578"> /**</span>
<a href="#l3.579"></a><span id="l3.579">  * Calculates the duration of time between an event and now and updates the year</span>
<a href="#l3.580"></a><span id="l3.580">  * of whichever element did not call this function.</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineat">@@ -731,31 +691,29 @@ function calculateAge(aEvent, aElement) </span>
<a href="#l3.582"></a><span id="l3.582"> </span>
<a href="#l3.583"></a><span id="l3.583">   var year = yearElem.value;</span>
<a href="#l3.584"></a><span id="l3.584">   // if the year element's value is invalid set the year and age elements to null</span>
<a href="#l3.585"></a><span id="l3.585">   if (isNaN(year) || year &lt; kMinYear || year &gt; kMaxYear) {</span>
<a href="#l3.586"></a><span id="l3.586">     yearElem.value = null;</span>
<a href="#l3.587"></a><span id="l3.587">     ageElem.value = null;</span>
<a href="#l3.588"></a><span id="l3.588">     datepicker.year = kDefaultYear;</span>
<a href="#l3.589"></a><span id="l3.589">     return;</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-  }</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-  else if (aElement == yearElem)</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+  } else if (aElement == yearElem)</span>
<a href="#l3.593"></a><span id="l3.593">     datepicker.year = year;</span>
<a href="#l3.594"></a><span id="l3.594">   // calculate the length of time between the event and now</span>
<a href="#l3.595"></a><span id="l3.595">   try {</span>
<a href="#l3.596"></a><span id="l3.596">     var event = new Date(datepicker.year, datepicker.month, datepicker.date);</span>
<a href="#l3.597"></a><span id="l3.597">     // if the year is only 2 digits, then the year won't be set correctly</span>
<a href="#l3.598"></a><span id="l3.598">     // using setFullYear fixes this issue</span>
<a href="#l3.599"></a><span id="l3.599">     event.setFullYear(datepicker.year);</span>
<a href="#l3.600"></a><span id="l3.600">     // get the difference between today and the event</span>
<a href="#l3.601"></a><span id="l3.601">     var age = new Date(new Date() - event);</span>
<a href="#l3.602"></a><span id="l3.602">     // get the number of years of the difference and subtract 1970 (epoch)</span>
<a href="#l3.603"></a><span id="l3.603">     ageElem.value = age.getFullYear() - 1970;</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-  }</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-  catch(e) {</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.607"></a><span id="l3.607">     datepicker.year = kDefaultYear;</span>
<a href="#l3.608"></a><span id="l3.608">     // if there was an error (like invalid year) set the year and age to null</span>
<a href="#l3.609"></a><span id="l3.609">     yearElem.value = null;</span>
<a href="#l3.610"></a><span id="l3.610">     ageElem.value = null;</span>
<a href="#l3.611"></a><span id="l3.611">   }</span>
<a href="#l3.612"></a><span id="l3.612"> }</span>
<a href="#l3.613"></a><span id="l3.613"> </span>
<a href="#l3.614"></a><span id="l3.614"> /**</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineat">@@ -785,20 +743,19 @@ function calculateYear(aEvent, aElement)</span>
<a href="#l3.616"></a><span id="l3.616">   }</span>
<a href="#l3.617"></a><span id="l3.617">   var today = new Date();</span>
<a href="#l3.618"></a><span id="l3.618">   try {</span>
<a href="#l3.619"></a><span id="l3.619">     var date = new Date(aElement.value, datepicker.month, datepicker.date);</span>
<a href="#l3.620"></a><span id="l3.620">     date.setFullYear(aElement.value);</span>
<a href="#l3.621"></a><span id="l3.621">     // get the difference between today and the age (the year is offset by 1970)</span>
<a href="#l3.622"></a><span id="l3.622">     var difference = new Date(today - date);</span>
<a href="#l3.623"></a><span id="l3.623">     datepicker.year = yearElem.value = difference.getFullYear() - 1970;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-  }</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-  // the above code may throw an invalid year exception.  If that happens, set</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-  // the year to kDefaultYear and set the year element's value to 0</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-  catch (e) {</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+    // The above code may throw an invalid year exception. If that happens, set</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+    // the year to kDefaultYear and set the year element's value to 0.</span>
<a href="#l3.631"></a><span id="l3.631">     datepicker.year = kDefaultYear;</span>
<a href="#l3.632"></a><span id="l3.632">     // if there was an error (like invalid year) set the year and age to null</span>
<a href="#l3.633"></a><span id="l3.633">     yearElem.value = null;</span>
<a href="#l3.634"></a><span id="l3.634">     let ageElem = document.getElementById(&quot;Age&quot;);</span>
<a href="#l3.635"></a><span id="l3.635">     if (ageElem)</span>
<a href="#l3.636"></a><span id="l3.636">       ageElem.value = null;</span>
<a href="#l3.637"></a><span id="l3.637">   }</span>
<a href="#l3.638"></a><span id="l3.638"> }</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineat">@@ -844,96 +801,93 @@ function modifyDatepicker(aDatepicker) {</span>
<a href="#l3.640"></a><span id="l3.640">     if (aNoWrap &amp;&amp; aField == this.monthField)</span>
<a href="#l3.641"></a><span id="l3.641">       aValue--;</span>
<a href="#l3.642"></a><span id="l3.642">     // make sure the date is valid for the given month</span>
<a href="#l3.643"></a><span id="l3.643">     if (aField == this.dateField) {</span>
<a href="#l3.644"></a><span id="l3.644">       var currentMonth = this.month;</span>
<a href="#l3.645"></a><span id="l3.645">       var dt = new Date(this.year, currentMonth, aValue);</span>
<a href="#l3.646"></a><span id="l3.646">       return dt.getMonth() != currentMonth ? 1 : aValue;</span>
<a href="#l3.647"></a><span id="l3.647">     }</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+    var min = (aField == this.monthField) ? 0 : 1;</span>
<a href="#l3.649"></a><span id="l3.649">     var max = (aField == this.monthField) ? 11 : kMaxYear;</span>
<a href="#l3.650"></a><span id="l3.650">     // make sure the value isn't too high</span>
<a href="#l3.651"></a><span id="l3.651">     if (aValue &gt; max)</span>
<a href="#l3.652"></a><span id="l3.652">       return aNoWrap ? max : min;</span>
<a href="#l3.653"></a><span id="l3.653">     return aValue;</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-  }</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+  };</span>
<a href="#l3.656"></a><span id="l3.656">   // sets the specified field to the given value, but allows blank fields</span>
<a href="#l3.657"></a><span id="l3.657">   // from: mozilla/toolkit/content/widgets/datetimepicker.xml#698</span>
<a href="#l3.658"></a><span id="l3.658">   aDatepicker._setFieldValue = function setValue(aField, aValue) {</span>
<a href="#l3.659"></a><span id="l3.659">     if (aField == this.yearField &amp;&amp; aValue &gt;= kMinYear &amp;&amp; aValue &lt;= kMaxYear) {</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-      var oldDate = this._dateValue;</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+      let oldDate = this._dateValue;</span>
<a href="#l3.662"></a><span id="l3.662">       this._dateValue.setFullYear(aValue);</span>
<a href="#l3.663"></a><span id="l3.663">       if (oldDate != this._dateValue) {</span>
<a href="#l3.664"></a><span id="l3.664">         this._dateValue.setDate(0);</span>
<a href="#l3.665"></a><span id="l3.665">         this._updateUI(this.dateField, this.date);</span>
<a href="#l3.666"></a><span id="l3.666">       }</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-    }</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-    // update the month if the value isn't null</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-    else if (aField == this.monthField &amp;&amp; aValue != null) {</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-      var oldDate = this.date;</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+    } else if (aField == this.monthField &amp;&amp; aValue != null) {</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+      // update the month if the value isn't null</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+      let oldDate = this.date;</span>
<a href="#l3.674"></a><span id="l3.674">       this._dateValue.setMonth(aValue);</span>
<a href="#l3.675"></a><span id="l3.675">       if (oldDate != this.date)</span>
<a href="#l3.676"></a><span id="l3.676">         this._dateValue.setDate(0);</span>
<a href="#l3.677"></a><span id="l3.677">       this._updateUI(this.dateField, this.date);</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-      var date = this._dateValue.getDate();</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+      let date = this._dateValue.getDate();</span>
<a href="#l3.680"></a><span id="l3.680">       this.dateField.value = date &lt; 10 &amp;&amp; this.dateLeadingZero ? &quot;0&quot; + date : date;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-      var month = this._dateValue.getMonth() + 1;</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+      let month = this._dateValue.getMonth() + 1;</span>
<a href="#l3.683"></a><span id="l3.683">       this.monthField.value = month &lt; 10 &amp;&amp; this.monthLeadingZero ? &quot;0&quot; + month : month;</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-    }</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-    // update the date if the value isn't null</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-    else if (aField == this.dateField &amp;&amp; aValue != null) {</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+    } else if (aField == this.dateField &amp;&amp; aValue != null) {</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+      // update the date if the value isn't null</span>
<a href="#l3.689"></a><span id="l3.689">       this._dateValue.setDate(aValue);</span>
<a href="#l3.690"></a><span id="l3.690">       this._updateUI(this.dateField, this.date);</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-      var date = this._dateValue.getDate();</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+      let date = this._dateValue.getDate();</span>
<a href="#l3.693"></a><span id="l3.693">       this.dateField.value = date &lt; 10 &amp;&amp; this.dateLeadingZero ? &quot;0&quot; + date : date;</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-      var month = this._dateValue.getMonth() + 1;</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+      let month = this._dateValue.getMonth() + 1;</span>
<a href="#l3.696"></a><span id="l3.696">       this.monthField.value = month &lt; 10 &amp;&amp; this.monthLeadingZero ? &quot;0&quot; + month : month;</span>
<a href="#l3.697"></a><span id="l3.697">     }</span>
<a href="#l3.698"></a><span id="l3.698">     this.setAttribute(&quot;value&quot;, this.value);</span>
<a href="#l3.699"></a><span id="l3.699"> </span>
<a href="#l3.700"></a><span id="l3.700">     if (this.attachedControl)</span>
<a href="#l3.701"></a><span id="l3.701">       this.attachedControl._setValueNoSync(this._dateValue);</span>
<a href="#l3.702"></a><span id="l3.702">     // if the aField's value is null or 0, set both field's values to null</span>
<a href="#l3.703"></a><span id="l3.703">     if (!aField.value &amp;&amp; aField != this.yearField) {</span>
<a href="#l3.704"></a><span id="l3.704">       this.dateField.value = null;</span>
<a href="#l3.705"></a><span id="l3.705">       this.monthField.value = null;</span>
<a href="#l3.706"></a><span id="l3.706">     }</span>
<a href="#l3.707"></a><span id="l3.707">     // make the field's value null if aValue is null and the field's value isn't</span>
<a href="#l3.708"></a><span id="l3.708">     if (aValue == null &amp;&amp; aField.value != null)</span>
<a href="#l3.709"></a><span id="l3.709">       aField.value = null;</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-  }</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+  };</span>
<a href="#l3.712"></a><span id="l3.712"> }</span>
<a href="#l3.713"></a><span id="l3.713"> </span>
<a href="#l3.714"></a><span id="l3.714"> var chatNameFieldIds =</span>
<a href="#l3.715"></a><span id="l3.715">   [&quot;Gtalk&quot;, &quot;AIM&quot;, &quot;Yahoo&quot;, &quot;Skype&quot;, &quot;QQ&quot;, &quot;MSN&quot;, &quot;ICQ&quot;, &quot;XMPP&quot;, &quot;IRC&quot;];</span>
<a href="#l3.716"></a><span id="l3.716"> </span>
<a href="#l3.717"></a><span id="l3.717"> /**</span>
<a href="#l3.718"></a><span id="l3.718">  * Show the 'Chat' tab and focus the first field that has a value, or</span>
<a href="#l3.719"></a><span id="l3.719">  * the first field if none of them has a value.</span>
<a href="#l3.720"></a><span id="l3.720">  */</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-function showChat()</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-{</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-  document.getElementById('abTabPanels').parentNode.selectedTab =</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-    document.getElementById('chatTabButton');</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+function showChat() {</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+  document.getElementById(&quot;abTabPanels&quot;).parentNode.selectedTab =</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+    document.getElementById(&quot;chatTabButton&quot;);</span>
<a href="#l3.728"></a><span id="l3.728">   for (let id of chatNameFieldIds) {</span>
<a href="#l3.729"></a><span id="l3.729">     let elt = document.getElementById(id);</span>
<a href="#l3.730"></a><span id="l3.730">     if (elt.value) {</span>
<a href="#l3.731"></a><span id="l3.731">       elt.focus();</span>
<a href="#l3.732"></a><span id="l3.732">       return;</span>
<a href="#l3.733"></a><span id="l3.733">     }</span>
<a href="#l3.734"></a><span id="l3.734">   }</span>
<a href="#l3.735"></a><span id="l3.735">   document.getElementById(chatNameFieldIds[0]).focus();</span>
<a href="#l3.736"></a><span id="l3.736"> }</span>
<a href="#l3.737"></a><span id="l3.737"> </span>
<a href="#l3.738"></a><span id="l3.738"> /**</span>
<a href="#l3.739"></a><span id="l3.739">  * Fill in the value of the ChatName readonly field with the first</span>
<a href="#l3.740"></a><span id="l3.740">  * value of the fields in the Chat tab.</span>
<a href="#l3.741"></a><span id="l3.741">  */</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-function updateChatName()</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-{</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+function updateChatName() {</span>
<a href="#l3.745"></a><span id="l3.745">   let value = &quot;&quot;;</span>
<a href="#l3.746"></a><span id="l3.746">   for (let id of chatNameFieldIds) {</span>
<a href="#l3.747"></a><span id="l3.747">     let val = document.getElementById(id).value;</span>
<a href="#l3.748"></a><span id="l3.748">     if (val) {</span>
<a href="#l3.749"></a><span id="l3.749">       value = val;</span>
<a href="#l3.750"></a><span id="l3.750">       break;</span>
<a href="#l3.751"></a><span id="l3.751">     }</span>
<a href="#l3.752"></a><span id="l3.752">   }</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineat">@@ -1007,18 +961,17 @@ function removePhoto(aName) {</span>
<a href="#l3.754"></a><span id="l3.754">     return false;</span>
<a href="#l3.755"></a><span id="l3.755">   // Get the directory with all the photos</span>
<a href="#l3.756"></a><span id="l3.756">   var file = getPhotosDir();</span>
<a href="#l3.757"></a><span id="l3.757">   // Get the photo (throws an exception for invalid names)</span>
<a href="#l3.758"></a><span id="l3.758">   try {</span>
<a href="#l3.759"></a><span id="l3.759">     file.append(aName);</span>
<a href="#l3.760"></a><span id="l3.760">     file.remove(false);</span>
<a href="#l3.761"></a><span id="l3.761">     return true;</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-  }</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-  catch (e) {}</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.765"></a><span id="l3.765">   return false;</span>
<a href="#l3.766"></a><span id="l3.766"> }</span>
<a href="#l3.767"></a><span id="l3.767"> </span>
<a href="#l3.768"></a><span id="l3.768"> /**</span>
<a href="#l3.769"></a><span id="l3.769">  * Remove previous and temporary photo files from the Photos directory.</span>
<a href="#l3.770"></a><span id="l3.770">  *</span>
<a href="#l3.771"></a><span id="l3.771">  * @param aSaved {boolean}  Whether the new card is going to be saved/committed.</span>
<a href="#l3.772"></a><span id="l3.772">  */</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineat">@@ -1056,17 +1009,17 @@ function browsePhoto(aEvent) {</span>
<a href="#l3.774"></a><span id="l3.774">   if (aEvent)</span>
<a href="#l3.775"></a><span id="l3.775">     aEvent.stopPropagation();</span>
<a href="#l3.776"></a><span id="l3.776"> </span>
<a href="#l3.777"></a><span id="l3.777">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.778"></a><span id="l3.778">              .createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.779"></a><span id="l3.779">   fp.init(window, gAddressBookBundle.getString(&quot;browsePhoto&quot;), Ci.nsIFilePicker.modeOpen);</span>
<a href="#l3.780"></a><span id="l3.780"> </span>
<a href="#l3.781"></a><span id="l3.781">   // Open the directory of the currently chosen photo (if any)</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-  let currentPhotoFile = document.getElementById(&quot;PhotoFile&quot;).file</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+  let currentPhotoFile = document.getElementById(&quot;PhotoFile&quot;).file;</span>
<a href="#l3.784"></a><span id="l3.784">   if (currentPhotoFile) {</span>
<a href="#l3.785"></a><span id="l3.785">     fp.displayDirectory = currentPhotoFile.parent;</span>
<a href="#l3.786"></a><span id="l3.786">   }</span>
<a href="#l3.787"></a><span id="l3.787"> </span>
<a href="#l3.788"></a><span id="l3.788">   // Add All Files &amp; Image Files filters and select the latter</span>
<a href="#l3.789"></a><span id="l3.789">   fp.appendFilters(Ci.nsIFilePicker.filterImages);</span>
<a href="#l3.790"></a><span id="l3.790">   fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l3.791"></a><span id="l3.791"> </span>
<a href="#l3.792"></a><span id="l3.792" class="difflineat">@@ -1132,17 +1085,17 @@ var gPhotoDownloadUI = (function() {</span>
<a href="#l3.793"></a><span id="l3.793">     if (!elProgressbar)</span>
<a href="#l3.794"></a><span id="l3.794">       elProgressbar = document.getElementById(&quot;PhotoDownloadProgress&quot;);</span>
<a href="#l3.795"></a><span id="l3.795">     if (!elProgressLabel)</span>
<a href="#l3.796"></a><span id="l3.796">       elProgressLabel = document.getElementById(&quot;PhotoStatus&quot;);</span>
<a href="#l3.797"></a><span id="l3.797">     if (!elPhotoType)</span>
<a href="#l3.798"></a><span id="l3.798">       elPhotoType = document.getElementById(&quot;PhotoType&quot;);</span>
<a href="#l3.799"></a><span id="l3.799">     if (!elProgressContainer)</span>
<a href="#l3.800"></a><span id="l3.800">       elProgressContainer = document.getElementById(&quot;ProgressContainer&quot;);</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-  }, false);</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+  });</span>
<a href="#l3.803"></a><span id="l3.803"> </span>
<a href="#l3.804"></a><span id="l3.804">   function onStart() {</span>
<a href="#l3.805"></a><span id="l3.805">     elProgressContainer.setAttribute(&quot;class&quot;, &quot;expanded&quot;);</span>
<a href="#l3.806"></a><span id="l3.806">     elProgressLabel.value = &quot;&quot;;</span>
<a href="#l3.807"></a><span id="l3.807">     elProgressbar.hidden = false;</span>
<a href="#l3.808"></a><span id="l3.808">     elProgressbar.value = 3; // Start with a tiny visible progress</span>
<a href="#l3.809"></a><span id="l3.809">   }</span>
<a href="#l3.810"></a><span id="l3.810"> </span>
<a href="#l3.811"></a><span id="l3.811" class="difflineat">@@ -1175,21 +1128,21 @@ var gPhotoDownloadUI = (function() {</span>
<a href="#l3.812"></a><span id="l3.812">   }</span>
<a href="#l3.813"></a><span id="l3.813"> </span>
<a href="#l3.814"></a><span id="l3.814">   function onProgress(state, percent) {</span>
<a href="#l3.815"></a><span id="l3.815">     elProgressbar.value = percent;</span>
<a href="#l3.816"></a><span id="l3.816">     elProgressLabel.value = gAddressBookBundle.getString(&quot;stateImageSave&quot;);</span>
<a href="#l3.817"></a><span id="l3.817">   }</span>
<a href="#l3.818"></a><span id="l3.818"> </span>
<a href="#l3.819"></a><span id="l3.819">   return {</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-    onStart: onStart,</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-    onSuccess: onSuccess,</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-    onError: onError,</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-    onProgress: onProgress</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-  }</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+    onStart,</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+    onSuccess,</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+    onError,</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+    onProgress</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+  };</span>
<a href="#l3.830"></a><span id="l3.830"> })();</span>
<a href="#l3.831"></a><span id="l3.831"> </span>
<a href="#l3.832"></a><span id="l3.832"> /* A photo handler defines the behaviour of the contact editor</span>
<a href="#l3.833"></a><span id="l3.833">  * for a particular photo type. Each photo handler must implement</span>
<a href="#l3.834"></a><span id="l3.834">  * the following interface:</span>
<a href="#l3.835"></a><span id="l3.835">  *</span>
<a href="#l3.836"></a><span id="l3.836">  * onLoad: function(aCard, aDocument):</span>
<a href="#l3.837"></a><span id="l3.837">  *   Called when the editor wants to populate the contact editor</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineat">@@ -1218,50 +1171,50 @@ var gPhotoDownloadUI = (function() {</span>
<a href="#l3.839"></a><span id="l3.839">  *   be called.</span>
<a href="#l3.840"></a><span id="l3.840">  *</span>
<a href="#l3.841"></a><span id="l3.841">  * onSave: function(aCard, aDocument)</span>
<a href="#l3.842"></a><span id="l3.842">  *   Called when the editor wants to save this photo type to the card.</span>
<a href="#l3.843"></a><span id="l3.843">  *   Returns true on success.</span>
<a href="#l3.844"></a><span id="l3.844">  */</span>
<a href="#l3.845"></a><span id="l3.845"> </span>
<a href="#l3.846"></a><span id="l3.846"> var genericPhotoHandler = {</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-  onLoad: function(aCard, aDocument) {</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+  onLoad(aCard, aDocument) {</span>
<a href="#l3.849"></a><span id="l3.849">     return true;</span>
<a href="#l3.850"></a><span id="l3.850">   },</span>
<a href="#l3.851"></a><span id="l3.851"> </span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-  onShow: function(aCard, aDocument, aTargetID) {</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+  onShow(aCard, aDocument, aTargetID) {</span>
<a href="#l3.854"></a><span id="l3.854">     // XXX TODO: this ignores any other value from the generic photos</span>
<a href="#l3.855"></a><span id="l3.855">     // menulist than &quot;default&quot;.</span>
<a href="#l3.856"></a><span id="l3.856">     aDocument.getElementById(aTargetID)</span>
<a href="#l3.857"></a><span id="l3.857">              .setAttribute(&quot;src&quot;, defaultPhotoURI);</span>
<a href="#l3.858"></a><span id="l3.858">     return true;</span>
<a href="#l3.859"></a><span id="l3.859">   },</span>
<a href="#l3.860"></a><span id="l3.860"> </span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-  onRead: function(aCard, aDocument) {</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  onRead(aCard, aDocument) {</span>
<a href="#l3.863"></a><span id="l3.863">     gPhotoDownloadUI.onSuccess();</span>
<a href="#l3.864"></a><span id="l3.864"> </span>
<a href="#l3.865"></a><span id="l3.865">     newPhotoAdded(&quot;&quot;, aCard);</span>
<a href="#l3.866"></a><span id="l3.866"> </span>
<a href="#l3.867"></a><span id="l3.867">     genericPhotoHandler.onShow(aCard, aDocument, &quot;photo&quot;);</span>
<a href="#l3.868"></a><span id="l3.868">     return true;</span>
<a href="#l3.869"></a><span id="l3.869">   },</span>
<a href="#l3.870"></a><span id="l3.870"> </span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-  onSave: function(aCard, aDocument) {</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+  onSave(aCard, aDocument) {</span>
<a href="#l3.873"></a><span id="l3.873">     // XXX TODO: this ignores any other value from the generic photos</span>
<a href="#l3.874"></a><span id="l3.874">     // menulist than &quot;default&quot;.</span>
<a href="#l3.875"></a><span id="l3.875"> </span>
<a href="#l3.876"></a><span id="l3.876">     // Update contact</span>
<a href="#l3.877"></a><span id="l3.877">     aCard.setProperty(&quot;PhotoName&quot;, &quot;&quot;);</span>
<a href="#l3.878"></a><span id="l3.878">     aCard.setProperty(&quot;PhotoURI&quot;, &quot;&quot;);</span>
<a href="#l3.879"></a><span id="l3.879">     return true;</span>
<a href="#l3.880"></a><span id="l3.880">   }</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-}</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+};</span>
<a href="#l3.883"></a><span id="l3.883"> </span>
<a href="#l3.884"></a><span id="l3.884"> var filePhotoHandler = {</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-  onLoad: function(aCard, aDocument) {</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+  onLoad(aCard, aDocument) {</span>
<a href="#l3.887"></a><span id="l3.887">     let photoURI = aCard.getProperty(&quot;PhotoURI&quot;, &quot;&quot;);</span>
<a href="#l3.888"></a><span id="l3.888">     let file;</span>
<a href="#l3.889"></a><span id="l3.889">     try {</span>
<a href="#l3.890"></a><span id="l3.890">       // The original file may not exist anymore, but we still display it.</span>
<a href="#l3.891"></a><span id="l3.891">       file = Services.io.newURI(photoURI)</span>
<a href="#l3.892"></a><span id="l3.892">                         .QueryInterface(Ci.nsIFileURL)</span>
<a href="#l3.893"></a><span id="l3.893">                         .file;</span>
<a href="#l3.894"></a><span id="l3.894">     } catch (e) {}</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineat">@@ -1269,24 +1222,24 @@ var filePhotoHandler = {</span>
<a href="#l3.896"></a><span id="l3.896">     if (!file)</span>
<a href="#l3.897"></a><span id="l3.897">       return false;</span>
<a href="#l3.898"></a><span id="l3.898"> </span>
<a href="#l3.899"></a><span id="l3.899">     aDocument.getElementById(&quot;PhotoFile&quot;).file = file;</span>
<a href="#l3.900"></a><span id="l3.900">     this._showFilename(aCard, aDocument);</span>
<a href="#l3.901"></a><span id="l3.901">     return true;</span>
<a href="#l3.902"></a><span id="l3.902">   },</span>
<a href="#l3.903"></a><span id="l3.903"> </span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-  onShow: function(aCard, aDocument, aTargetID) {</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+  onShow(aCard, aDocument, aTargetID) {</span>
<a href="#l3.906"></a><span id="l3.906">     let photoName = gNewPhoto || aCard.getProperty(&quot;PhotoName&quot;, null);</span>
<a href="#l3.907"></a><span id="l3.907">     let photoURI = getPhotoURI(photoName);</span>
<a href="#l3.908"></a><span id="l3.908">     aDocument.getElementById(aTargetID).setAttribute(&quot;src&quot;, photoURI);</span>
<a href="#l3.909"></a><span id="l3.909">     return true;</span>
<a href="#l3.910"></a><span id="l3.910">   },</span>
<a href="#l3.911"></a><span id="l3.911"> </span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-  onRead: function(aCard, aDocument) {</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+  onRead(aCard, aDocument) {</span>
<a href="#l3.914"></a><span id="l3.914">     let file = aDocument.getElementById(&quot;PhotoFile&quot;).file;</span>
<a href="#l3.915"></a><span id="l3.915">     filePhotoHandler._showFilename(aCard, aDocument);</span>
<a href="#l3.916"></a><span id="l3.916">     if (!file)</span>
<a href="#l3.917"></a><span id="l3.917">       return false;</span>
<a href="#l3.918"></a><span id="l3.918"> </span>
<a href="#l3.919"></a><span id="l3.919">     // If the local file has been removed/renamed, keep the current photo as is.</span>
<a href="#l3.920"></a><span id="l3.920">     if (!file.exists() || !file.isFile())</span>
<a href="#l3.921"></a><span id="l3.921">       return false;</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineat">@@ -1306,109 +1259,108 @@ var filePhotoHandler = {</span>
<a href="#l3.923"></a><span id="l3.923">     };</span>
<a href="#l3.924"></a><span id="l3.924"> </span>
<a href="#l3.925"></a><span id="l3.925">     gImageDownloader.savePhoto(photoURI, cbSuccess,</span>
<a href="#l3.926"></a><span id="l3.926">                                gPhotoDownloadUI.onError,</span>
<a href="#l3.927"></a><span id="l3.927">                                gPhotoDownloadUI.onProgress);</span>
<a href="#l3.928"></a><span id="l3.928">     return true;</span>
<a href="#l3.929"></a><span id="l3.929">   },</span>
<a href="#l3.930"></a><span id="l3.930"> </span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-  onSave: function(aCard, aDocument) {</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+  onSave(aCard, aDocument) {</span>
<a href="#l3.933"></a><span id="l3.933">     // Update contact</span>
<a href="#l3.934"></a><span id="l3.934">     if (gNewPhoto) {</span>
<a href="#l3.935"></a><span id="l3.935">       // The file may not be valid unless the photo has changed.</span>
<a href="#l3.936"></a><span id="l3.936">       let photoURI = aDocument.getElementById(&quot;PhotoFile&quot;).getAttribute(&quot;PhotoURI&quot;);</span>
<a href="#l3.937"></a><span id="l3.937">       aCard.setProperty(&quot;PhotoName&quot;, gNewPhoto);</span>
<a href="#l3.938"></a><span id="l3.938">       aCard.setProperty(&quot;PhotoURI&quot;, photoURI);</span>
<a href="#l3.939"></a><span id="l3.939">     }</span>
<a href="#l3.940"></a><span id="l3.940">     return true;</span>
<a href="#l3.941"></a><span id="l3.941">   },</span>
<a href="#l3.942"></a><span id="l3.942"> </span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-  _showFilename: function(aCard, aDocument) {</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+  _showFilename(aCard, aDocument) {</span>
<a href="#l3.945"></a><span id="l3.945">     let photoElem = aDocument.getElementById(&quot;PhotoFile&quot;);</span>
<a href="#l3.946"></a><span id="l3.946">     let photoFile = photoElem.file ? photoElem.file : null;</span>
<a href="#l3.947"></a><span id="l3.947">     let photoSpec = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.948"></a><span id="l3.948">                             .QueryInterface(Ci.nsIFileProtocolHandler)</span>
<a href="#l3.949"></a><span id="l3.949">                             .getURLSpecFromFile(photoFile);</span>
<a href="#l3.950"></a><span id="l3.950">     if (photoFile) {</span>
<a href="#l3.951"></a><span id="l3.951">       photoElem.style.backgroundImage = &quot;url(moz-icon://&quot; + photoSpec + &quot;?size=16)&quot;;</span>
<a href="#l3.952"></a><span id="l3.952">       photoElem.value = photoFile.leafName;</span>
<a href="#l3.953"></a><span id="l3.953">     } else {</span>
<a href="#l3.954"></a><span id="l3.954">       photoElem.value = &quot;&quot;;</span>
<a href="#l3.955"></a><span id="l3.955">     }</span>
<a href="#l3.956"></a><span id="l3.956">   }</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-}</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+};</span>
<a href="#l3.959"></a><span id="l3.959"> </span>
<a href="#l3.960"></a><span id="l3.960"> var webPhotoHandler = {</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-  onLoad: function(aCard, aDocument) {</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+  onLoad(aCard, aDocument) {</span>
<a href="#l3.963"></a><span id="l3.963">     let photoURI = aCard.getProperty(&quot;PhotoURI&quot;, null);</span>
<a href="#l3.964"></a><span id="l3.964"> </span>
<a href="#l3.965"></a><span id="l3.965">     if (!photoURI)</span>
<a href="#l3.966"></a><span id="l3.966">       return false;</span>
<a href="#l3.967"></a><span id="l3.967"> </span>
<a href="#l3.968"></a><span id="l3.968">     aDocument.getElementById(&quot;PhotoURI&quot;).value = photoURI;</span>
<a href="#l3.969"></a><span id="l3.969">     return true;</span>
<a href="#l3.970"></a><span id="l3.970">   },</span>
<a href="#l3.971"></a><span id="l3.971"> </span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-  onShow: function(aCard, aDocument, aTargetID) {</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+  onShow(aCard, aDocument, aTargetID) {</span>
<a href="#l3.974"></a><span id="l3.974">     let photoName = gNewPhoto || aCard.getProperty(&quot;PhotoName&quot;, null);</span>
<a href="#l3.975"></a><span id="l3.975">     if (!photoName)</span>
<a href="#l3.976"></a><span id="l3.976">       return false;</span>
<a href="#l3.977"></a><span id="l3.977"> </span>
<a href="#l3.978"></a><span id="l3.978">     let photoURI = getPhotoURI(photoName);</span>
<a href="#l3.979"></a><span id="l3.979"> </span>
<a href="#l3.980"></a><span id="l3.980">     aDocument.getElementById(aTargetID).setAttribute(&quot;src&quot;, photoURI);</span>
<a href="#l3.981"></a><span id="l3.981">     return true;</span>
<a href="#l3.982"></a><span id="l3.982">   },</span>
<a href="#l3.983"></a><span id="l3.983"> </span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-  onRead: function(aCard, aDocument) {</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+  onRead(aCard, aDocument) {</span>
<a href="#l3.986"></a><span id="l3.986">     let photoURI = aDocument.getElementById(&quot;PhotoURI&quot;).value;</span>
<a href="#l3.987"></a><span id="l3.987">     if (!photoURI)</span>
<a href="#l3.988"></a><span id="l3.988">       return false;</span>
<a href="#l3.989"></a><span id="l3.989"> </span>
<a href="#l3.990"></a><span id="l3.990">     gPhotoDownloadUI.onStart();</span>
<a href="#l3.991"></a><span id="l3.991"> </span>
<a href="#l3.992"></a><span id="l3.992">     let cbSuccess = function(newPhotoName) {</span>
<a href="#l3.993"></a><span id="l3.993">       gPhotoDownloadUI.onSuccess();</span>
<a href="#l3.994"></a><span id="l3.994"> </span>
<a href="#l3.995"></a><span id="l3.995">       newPhotoAdded(newPhotoName, aCard);</span>
<a href="#l3.996"></a><span id="l3.996"> </span>
<a href="#l3.997"></a><span id="l3.997">       webPhotoHandler.onShow(aCard, aDocument, &quot;photo&quot;);</span>
<a href="#l3.998"></a><span id="l3.998"> </span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-    }</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+    };</span>
<a href="#l3.1001"></a><span id="l3.1001"> </span>
<a href="#l3.1002"></a><span id="l3.1002">     gImageDownloader.savePhoto(photoURI, cbSuccess,</span>
<a href="#l3.1003"></a><span id="l3.1003">                                gPhotoDownloadUI.onError,</span>
<a href="#l3.1004"></a><span id="l3.1004">                                gPhotoDownloadUI.onProgress);</span>
<a href="#l3.1005"></a><span id="l3.1005">     return true;</span>
<a href="#l3.1006"></a><span id="l3.1006">   },</span>
<a href="#l3.1007"></a><span id="l3.1007"> </span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-  onSave: function(aCard, aDocument) {</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineplus">+  onSave(aCard, aDocument) {</span>
<a href="#l3.1010"></a><span id="l3.1010">     // Update contact</span>
<a href="#l3.1011"></a><span id="l3.1011">     if (gNewPhoto) {</span>
<a href="#l3.1012"></a><span id="l3.1012">       let photoURI = aDocument.getElementById(&quot;PhotoURI&quot;).value;</span>
<a href="#l3.1013"></a><span id="l3.1013">       aCard.setProperty(&quot;PhotoName&quot;, gNewPhoto);</span>
<a href="#l3.1014"></a><span id="l3.1014">       aCard.setProperty(&quot;PhotoURI&quot;, photoURI);</span>
<a href="#l3.1015"></a><span id="l3.1015">     }</span>
<a href="#l3.1016"></a><span id="l3.1016">     return true;</span>
<a href="#l3.1017"></a><span id="l3.1017">   }</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-}</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineplus">+};</span>
<a href="#l3.1020"></a><span id="l3.1020"> </span>
<a href="#l3.1021"></a><span id="l3.1021"> function newPhotoAdded(aPhotoName, aCard) {</span>
<a href="#l3.1022"></a><span id="l3.1022">   // If we had the photo saved locally, shedule it for removal if card is saved.</span>
<a href="#l3.1023"></a><span id="l3.1023">   gOldPhotos.push(gNewPhoto !== null ? gNewPhoto : aCard.getProperty(&quot;PhotoName&quot;, null));</span>
<a href="#l3.1024"></a><span id="l3.1024">   gNewPhoto = aPhotoName;</span>
<a href="#l3.1025"></a><span id="l3.1025"> }</span>
<a href="#l3.1026"></a><span id="l3.1026"> </span>
<a href="#l3.1027"></a><span id="l3.1027"> /* In order for other photo handlers to be recognized for</span>
<a href="#l3.1028"></a><span id="l3.1028">  * a particular type, they must be registered through this</span>
<a href="#l3.1029"></a><span id="l3.1029">  * function.</span>
<a href="#l3.1030"></a><span id="l3.1030">  * @param aType the type of photo to handle</span>
<a href="#l3.1031"></a><span id="l3.1031">  * @param aPhotoHandler the photo handler to register</span>
<a href="#l3.1032"></a><span id="l3.1032">  */</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-function registerPhotoHandler(aType, aPhotoHandler)</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-{</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+function registerPhotoHandler(aType, aPhotoHandler) {</span>
<a href="#l3.1036"></a><span id="l3.1036">   gPhotoHandlers[aType] = aPhotoHandler;</span>
<a href="#l3.1037"></a><span id="l3.1037"> }</span>
<a href="#l3.1038"></a><span id="l3.1038"> </span>
<a href="#l3.1039"></a><span id="l3.1039"> registerPhotoHandler(&quot;generic&quot;, genericPhotoHandler);</span>
<a href="#l3.1040"></a><span id="l3.1040"> registerPhotoHandler(&quot;web&quot;, webPhotoHandler);</span>
<a href="#l3.1041"></a><span id="l3.1041"> registerPhotoHandler(&quot;file&quot;, filePhotoHandler);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/addrbook/content/abCardView.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCardView.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l4.5"></a><span id="l4.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-//NOTE: gAddressBookBundle must be defined and set or this Overlay won't work</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+// NOTE: gAddressBookBundle must be defined and set or this Overlay won't work</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12"> ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> var gProfileDirURL;</span>
<a href="#l4.16"></a><span id="l4.16"> var gFileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l4.17"></a><span id="l4.17">   .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l4.18"></a><span id="l4.18"> var gPhotoDisplayHandlers = {};</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineat">@@ -35,18 +35,17 @@ var zSkype;</span>
<a href="#l4.20"></a><span id="l4.20"> var zQQ;</span>
<a href="#l4.21"></a><span id="l4.21"> var zMSN;</span>
<a href="#l4.22"></a><span id="l4.22"> var zICQ;</span>
<a href="#l4.23"></a><span id="l4.23"> var zXMPP;</span>
<a href="#l4.24"></a><span id="l4.24"> var zIRC;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> var cvData;</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-function OnLoadCardView()</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-{</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+function OnLoadCardView() {</span>
<a href="#l4.31"></a><span id="l4.31">   zPrimaryEmail = gAddressBookBundle.getString(&quot;propertyPrimaryEmail&quot;);</span>
<a href="#l4.32"></a><span id="l4.32">   zSecondaryEmail = gAddressBookBundle.getString(&quot;propertySecondaryEmail&quot;);</span>
<a href="#l4.33"></a><span id="l4.33">   zNickname = gAddressBookBundle.getString(&quot;propertyNickname&quot;);</span>
<a href="#l4.34"></a><span id="l4.34">   zDisplayName = gAddressBookBundle.getString(&quot;propertyDisplayName&quot;);</span>
<a href="#l4.35"></a><span id="l4.35">   zListName = gAddressBookBundle.getString(&quot;propertyListName&quot;);</span>
<a href="#l4.36"></a><span id="l4.36">   zWork = gAddressBookBundle.getString(&quot;propertyWork&quot;);</span>
<a href="#l4.37"></a><span id="l4.37">   zHome = gAddressBookBundle.getString(&quot;propertyHome&quot;);</span>
<a href="#l4.38"></a><span id="l4.38">   zFax = gAddressBookBundle.getString(&quot;propertyFax&quot;);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineat">@@ -67,17 +66,17 @@ function OnLoadCardView()</span>
<a href="#l4.40"></a><span id="l4.40">   zXMPP = gAddressBookBundle.getString(&quot;propertyXMPP&quot;);</span>
<a href="#l4.41"></a><span id="l4.41">   zIRC = gAddressBookBundle.getString(&quot;propertyIRC&quot;);</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   var doc = document;</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">   /* data for address book, prefixes: &quot;cvb&quot; = card view box</span>
<a href="#l4.46"></a><span id="l4.46">                     &quot;cvh&quot; = crad view header</span>
<a href="#l4.47"></a><span id="l4.47">                     &quot;cv&quot;  = card view (normal fields) */</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-  cvData = new Object;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  cvData = {};</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">   // Card View Box</span>
<a href="#l4.52"></a><span id="l4.52">   cvData.CardViewBox    = doc.getElementById(&quot;CardViewInnerBox&quot;);</span>
<a href="#l4.53"></a><span id="l4.53">   // Title</span>
<a href="#l4.54"></a><span id="l4.54">   cvData.CardTitle    = doc.getElementById(&quot;CardTitle&quot;);</span>
<a href="#l4.55"></a><span id="l4.55">   // Name section</span>
<a href="#l4.56"></a><span id="l4.56">   cvData.cvbContact = doc.getElementById(&quot;cvbContact&quot;);</span>
<a href="#l4.57"></a><span id="l4.57">   cvData.cvhContact = doc.getElementById(&quot;cvhContact&quot;);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineat">@@ -154,47 +153,46 @@ function OnLoadCardView()</span>
<a href="#l4.59"></a><span id="l4.59">   cvData.cvICQ        = doc.getElementById(&quot;cvICQ&quot;);</span>
<a href="#l4.60"></a><span id="l4.60">   cvData.cvXMPP       = doc.getElementById(&quot;cvXMPP&quot;);</span>
<a href="#l4.61"></a><span id="l4.61">   cvData.cvIRC        = doc.getElementById(&quot;cvIRC&quot;);</span>
<a href="#l4.62"></a><span id="l4.62"> }</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64"> // XXX todo</span>
<a href="#l4.65"></a><span id="l4.65"> // some similar code (in spirit) already exists, see OnLoadEditList()</span>
<a href="#l4.66"></a><span id="l4.66"> // perhaps we could combine and put in abCommon.js?</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-function GetAddressesFromURI(uri)</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-{</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+function GetAddressesFromURI(uri) {</span>
<a href="#l4.70"></a><span id="l4.70">   var addresses = &quot;&quot;;</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">   var editList = GetDirectoryFromURI(uri);</span>
<a href="#l4.73"></a><span id="l4.73">   var addressList = editList.addressLists;</span>
<a href="#l4.74"></a><span id="l4.74">   if (addressList) {</span>
<a href="#l4.75"></a><span id="l4.75">     var total = addressList.length;</span>
<a href="#l4.76"></a><span id="l4.76">     if (total &gt; 0)</span>
<a href="#l4.77"></a><span id="l4.77">       addresses = addressList.queryElementAt(0, Ci.nsIAbCard).primaryEmail;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    for (var i = 1;  i &lt; total; i++ ) {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    for (let i = 1; i &lt; total; i++) {</span>
<a href="#l4.80"></a><span id="l4.80">       addresses += &quot;, &quot; + addressList.queryElementAt(i, Ci.nsIAbCard).primaryEmail;</span>
<a href="#l4.81"></a><span id="l4.81">     }</span>
<a href="#l4.82"></a><span id="l4.82">   }</span>
<a href="#l4.83"></a><span id="l4.83">   return addresses;</span>
<a href="#l4.84"></a><span id="l4.84"> }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-function DisplayCardViewPane(realCard)</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-{</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+function DisplayCardViewPane(realCard) {</span>
<a href="#l4.90"></a><span id="l4.90">   let generatedName = realCard.generateName(</span>
<a href="#l4.91"></a><span id="l4.91">     Services.prefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;));</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93">   // This will become neater when bug 312116 is fixed...</span>
<a href="#l4.94"></a><span id="l4.94">   // (card.property instead of card.getProperty(&quot;Property&quot;))</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-  var card = { getProperty : function (prop) {</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  var card = { getProperty(prop) {</span>
<a href="#l4.97"></a><span id="l4.97">                  return realCard.getProperty(prop, &quot;&quot;);</span>
<a href="#l4.98"></a><span id="l4.98">                },</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-               primaryEmail : realCard.primaryEmail,</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-               displayName : realCard.displayName,</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-               isMailList : realCard.isMailList,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-               mailListURI : realCard.mailListURI</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+               primaryEmail: realCard.primaryEmail,</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+               displayName: realCard.displayName,</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+               isMailList: realCard.isMailList,</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+               mailListURI: realCard.mailListURI</span>
<a href="#l4.107"></a><span id="l4.107">   };</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109">   var data = top.cvData;</span>
<a href="#l4.110"></a><span id="l4.110">   var visible;</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112">   // Contact photo</span>
<a href="#l4.113"></a><span id="l4.113">   displayPhoto(card, cvData.cvPhoto);</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115" class="difflineat">@@ -214,18 +212,17 @@ function DisplayCardViewPane(realCard)</span>
<a href="#l4.116"></a><span id="l4.116">   cvSetNodeWithLabel(data.cvNickname, zNickname, card.getProperty(&quot;NickName&quot;));</span>
<a href="#l4.117"></a><span id="l4.117"> </span>
<a href="#l4.118"></a><span id="l4.118">   if (card.isMailList) {</span>
<a href="#l4.119"></a><span id="l4.119">     // email1 and display name always hidden when a mailing list.</span>
<a href="#l4.120"></a><span id="l4.120">     cvSetVisible(data.cvDisplayName, false);</span>
<a href="#l4.121"></a><span id="l4.121">     cvSetVisible(data.cvEmail1Box, false);</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">     visible = HandleLink(data.cvListName, zListName, card.displayName, data.cvListNameBox, &quot;mailto:&quot; + encodeURIComponent(GenerateAddressFromCard(card))) || visible;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-  }</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-  else {</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+  } else {</span>
<a href="#l4.127"></a><span id="l4.127">     // listname always hidden if not a mailing list</span>
<a href="#l4.128"></a><span id="l4.128">     cvSetVisible(data.cvListNameBox, false);</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">     cvSetNodeWithLabel(data.cvDisplayName, zDisplayName, card.displayName);</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">     visible = HandleLink(data.cvEmail1, zPrimaryEmail, card.primaryEmail, data.cvEmail1Box, &quot;mailto:&quot; + card.primaryEmail) || visible;</span>
<a href="#l4.133"></a><span id="l4.133">   }</span>
<a href="#l4.134"></a><span id="l4.134"> </span>
<a href="#l4.135"></a><span id="l4.135" class="difflineat">@@ -253,55 +250,53 @@ function DisplayCardViewPane(realCard)</span>
<a href="#l4.136"></a><span id="l4.136">   visible = HandleLink(data.cvHomeWebPage, &quot;&quot;, card.getProperty(&quot;WebPage2&quot;),</span>
<a href="#l4.137"></a><span id="l4.137">                        data.cvHomeWebPageBox, card.getProperty(&quot;WebPage2&quot;)) ||</span>
<a href="#l4.138"></a><span id="l4.138">             visible;</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140">   cvSetVisible(data.cvhHome, visible);</span>
<a href="#l4.141"></a><span id="l4.141">   cvSetVisible(data.cvbHome, visible);</span>
<a href="#l4.142"></a><span id="l4.142">   if (card.isMailList) {</span>
<a href="#l4.143"></a><span id="l4.143">     // Description section</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-    visible = cvSetNode(data.cvDescription, card.getProperty(&quot;Notes&quot;))</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+    visible = cvSetNode(data.cvDescription, card.getProperty(&quot;Notes&quot;));</span>
<a href="#l4.146"></a><span id="l4.146">     cvSetVisible(data.cvbDescription, visible);</span>
<a href="#l4.147"></a><span id="l4.147"> </span>
<a href="#l4.148"></a><span id="l4.148">     // Addresses section</span>
<a href="#l4.149"></a><span id="l4.149">     visible = cvAddAddressNodes(data.cvAddresses, card.mailListURI);</span>
<a href="#l4.150"></a><span id="l4.150">     cvSetVisible(data.cvbAddresses, visible);</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152">     // Other and Chat sections, not shown for mailing lists.</span>
<a href="#l4.153"></a><span id="l4.153">     cvSetVisible(data.cvbOther, false);</span>
<a href="#l4.154"></a><span id="l4.154">     cvSetVisible(data.cvbChat, false);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-  }</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-  else {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  } else {</span>
<a href="#l4.158"></a><span id="l4.158">     // Other section</span>
<a href="#l4.159"></a><span id="l4.159">     // setup the birthday information</span>
<a href="#l4.160"></a><span id="l4.160">     var day = card.getProperty(&quot;BirthDay&quot;, null);</span>
<a href="#l4.161"></a><span id="l4.161">     var month = card.getProperty(&quot;BirthMonth&quot;, null);</span>
<a href="#l4.162"></a><span id="l4.162">     var year = card.getProperty(&quot;BirthYear&quot;, null);</span>
<a href="#l4.163"></a><span id="l4.163">     var dateStr;</span>
<a href="#l4.164"></a><span id="l4.164">     if (day &gt; 0 &amp;&amp; day &lt; 32 &amp;&amp; month &gt; 0 &amp;&amp; month &lt; 13) {</span>
<a href="#l4.165"></a><span id="l4.165">       var date;</span>
<a href="#l4.166"></a><span id="l4.166">       var formatter;</span>
<a href="#l4.167"></a><span id="l4.167">       if (year) {</span>
<a href="#l4.168"></a><span id="l4.168">         // use UTC-based calculations to avoid off-by-one day</span>
<a href="#l4.169"></a><span id="l4.169">         // due to time zone/dst discontinuity</span>
<a href="#l4.170"></a><span id="l4.170">         date = new Date(Date.UTC(year, month - 1, day));</span>
<a href="#l4.171"></a><span id="l4.171">         date.setUTCFullYear(year); // to handle two-digit years properly</span>
<a href="#l4.172"></a><span id="l4.172">         formatter = new Services.intl.DateTimeFormat(undefined,</span>
<a href="#l4.173"></a><span id="l4.173">                       { dateStyle: &quot;long&quot;, timeZone: &quot;UTC&quot; });</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-      }</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-      // if the year doesn't exist, display Month DD (ex. January 01)</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-      else {</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+      } else {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+        // if the year doesn't exist, display Month DD (ex. January 01)</span>
<a href="#l4.179"></a><span id="l4.179">         date = new Date(Date.UTC(saneBirthYear(year), month - 1, day));</span>
<a href="#l4.180"></a><span id="l4.180">         formatter = new Services.intl.DateTimeFormat(undefined,</span>
<a href="#l4.181"></a><span id="l4.181">                       { month: &quot;long&quot;, day: &quot;numeric&quot;, timeZone: &quot;UTC&quot; });</span>
<a href="#l4.182"></a><span id="l4.182">       }</span>
<a href="#l4.183"></a><span id="l4.183">       dateStr = formatter.format(date);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    } else if (year) {</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+      dateStr = year;</span>
<a href="#l4.186"></a><span id="l4.186">     }</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-    else if (year)</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-      dateStr = year;</span>
<a href="#l4.189"></a><span id="l4.189">     visible = cvSetNodeWithLabel(data.cvBirthday, zBirthday, dateStr);</span>
<a href="#l4.190"></a><span id="l4.190"> </span>
<a href="#l4.191"></a><span id="l4.191">     visible = cvSetNodeWithLabel(data.cvCustom1, zCustom1,</span>
<a href="#l4.192"></a><span id="l4.192">                                  card.getProperty(&quot;Custom1&quot;)) || visible;</span>
<a href="#l4.193"></a><span id="l4.193">     visible = cvSetNodeWithLabel(data.cvCustom2, zCustom2,</span>
<a href="#l4.194"></a><span id="l4.194">                                  card.getProperty(&quot;Custom2&quot;)) || visible;</span>
<a href="#l4.195"></a><span id="l4.195">     visible = cvSetNodeWithLabel(data.cvCustom3, zCustom3,</span>
<a href="#l4.196"></a><span id="l4.196">                                  card.getProperty(&quot;Custom3&quot;)) || visible;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineat">@@ -387,19 +382,19 @@ function DisplayCardViewPane(realCard)</span>
<a href="#l4.198"></a><span id="l4.198">                              visible;</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200">   cvSetVisible(data.cvhWork, visible);</span>
<a href="#l4.201"></a><span id="l4.201">   cvSetVisible(data.cvbWork, visible);</span>
<a href="#l4.202"></a><span id="l4.202"> </span>
<a href="#l4.203"></a><span id="l4.203">   // make the card view box visible</span>
<a href="#l4.204"></a><span id="l4.204">   cvSetVisible(top.cvData.CardViewBox, true);</span>
<a href="#l4.205"></a><span id="l4.205"> }</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l4.207"></a><span id="l4.207"> </span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-function setBuddyIcon(card, buddyIcon)</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-{</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+function setBuddyIcon(card, buddyIcon) {</span>
<a href="#l4.211"></a><span id="l4.211">   try {</span>
<a href="#l4.212"></a><span id="l4.212">     let myScreenName = Services.prefs.getCharPref(&quot;aim.session.screenname&quot;);</span>
<a href="#l4.213"></a><span id="l4.213">     if (myScreenName &amp;&amp; card.primaryEmail) {</span>
<a href="#l4.214"></a><span id="l4.214">       if (!gProfileDirURL) {</span>
<a href="#l4.215"></a><span id="l4.215">         // lazily create these file urls, and keep them around</span>
<a href="#l4.216"></a><span id="l4.216">         let profileDir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l4.217"></a><span id="l4.217">         gProfileDirURL = Services.io.newFileURI(profileDir);</span>
<a href="#l4.218"></a><span id="l4.218">       }</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineat">@@ -412,44 +407,38 @@ function setBuddyIcon(card, buddyIcon)</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221">       // check if the file exists</span>
<a href="#l4.222"></a><span id="l4.222">       // is this a perf hit?  (how expensive is stat()?)</span>
<a href="#l4.223"></a><span id="l4.223">       if (file.exists()) {</span>
<a href="#l4.224"></a><span id="l4.224">         buddyIcon.setAttribute(&quot;src&quot;, iconURLStr);</span>
<a href="#l4.225"></a><span id="l4.225">         return true;</span>
<a href="#l4.226"></a><span id="l4.226">       }</span>
<a href="#l4.227"></a><span id="l4.227">     }</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-  }</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-  catch (ex) {</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+  } catch (ex) {</span>
<a href="#l4.231"></a><span id="l4.231">     // can get here if no screenname</span>
<a href="#l4.232"></a><span id="l4.232">   }</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234">   buddyIcon.setAttribute(&quot;src&quot;, &quot;&quot;);</span>
<a href="#l4.235"></a><span id="l4.235">   return false;</span>
<a href="#l4.236"></a><span id="l4.236"> }</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-function ClearCardViewPane()</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-{</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+function ClearCardViewPane() {</span>
<a href="#l4.241"></a><span id="l4.241">   cvSetVisible(top.cvData.CardViewBox, false);</span>
<a href="#l4.242"></a><span id="l4.242"> }</span>
<a href="#l4.243"></a><span id="l4.243"> </span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-function cvSetNodeWithLabel(node, label, text)</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-{</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+function cvSetNodeWithLabel(node, label, text) {</span>
<a href="#l4.247"></a><span id="l4.247">   if (text) {</span>
<a href="#l4.248"></a><span id="l4.248">     if (label)</span>
<a href="#l4.249"></a><span id="l4.249">       return cvSetNode(node, label + &quot;: &quot; + text);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    else</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-      return cvSetNode(node, text);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+    return cvSetNode(node, text);</span>
<a href="#l4.253"></a><span id="l4.253">   }</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-  else</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-    return cvSetNode(node, &quot;&quot;);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  return cvSetNode(node, &quot;&quot;);</span>
<a href="#l4.257"></a><span id="l4.257"> }</span>
<a href="#l4.258"></a><span id="l4.258"> </span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-function cvSetCityStateZip(node, city, state, zip)</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-{</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+function cvSetCityStateZip(node, city, state, zip) {</span>
<a href="#l4.262"></a><span id="l4.262">   let text = &quot;&quot;;</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264">   if (city &amp;&amp; state &amp;&amp; zip)</span>
<a href="#l4.265"></a><span id="l4.265">     text = gAddressBookBundle.getFormattedString(&quot;cityAndStateAndZip&quot;,</span>
<a href="#l4.266"></a><span id="l4.266">                                                  [city, state, zip]);</span>
<a href="#l4.267"></a><span id="l4.267">   else if (city &amp;&amp; state &amp;&amp; !zip)</span>
<a href="#l4.268"></a><span id="l4.268">     text = gAddressBookBundle.getFormattedString(&quot;cityAndStateNoZip&quot;,</span>
<a href="#l4.269"></a><span id="l4.269">                                                  [city, state]);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineat">@@ -459,43 +448,41 @@ function cvSetCityStateZip(node, city, s</span>
<a href="#l4.271"></a><span id="l4.271">   else {</span>
<a href="#l4.272"></a><span id="l4.272">     // Only one of the strings is non-empty so contatenating them produces that string.</span>
<a href="#l4.273"></a><span id="l4.273">     text = city + state + zip;</span>
<a href="#l4.274"></a><span id="l4.274">   }</span>
<a href="#l4.275"></a><span id="l4.275"> </span>
<a href="#l4.276"></a><span id="l4.276">   return cvSetNode(node, text);</span>
<a href="#l4.277"></a><span id="l4.277"> }</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-function cvSetNode(node, text)</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-{</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+function cvSetNode(node, text) {</span>
<a href="#l4.282"></a><span id="l4.282">   if (!node)</span>
<a href="#l4.283"></a><span id="l4.283">     return false;</span>
<a href="#l4.284"></a><span id="l4.284"> </span>
<a href="#l4.285"></a><span id="l4.285">   node.textContent = text;</span>
<a href="#l4.286"></a><span id="l4.286">   let visible = !!text;</span>
<a href="#l4.287"></a><span id="l4.287">   cvSetVisible(node, visible);</span>
<a href="#l4.288"></a><span id="l4.288"> </span>
<a href="#l4.289"></a><span id="l4.289">   return visible;</span>
<a href="#l4.290"></a><span id="l4.290"> }</span>
<a href="#l4.291"></a><span id="l4.291"> </span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-function cvAddAddressNodes(node, uri)</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-{</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+function cvAddAddressNodes(node, uri) {</span>
<a href="#l4.295"></a><span id="l4.295">   var visible = false;</span>
<a href="#l4.296"></a><span id="l4.296"> </span>
<a href="#l4.297"></a><span id="l4.297">   if (node) {</span>
<a href="#l4.298"></a><span id="l4.298">     var editList = GetDirectoryFromURI(uri);</span>
<a href="#l4.299"></a><span id="l4.299">     var addressList = editList.addressLists;</span>
<a href="#l4.300"></a><span id="l4.300"> </span>
<a href="#l4.301"></a><span id="l4.301">     if (addressList) {</span>
<a href="#l4.302"></a><span id="l4.302">       var total = addressList.length;</span>
<a href="#l4.303"></a><span id="l4.303">       if (total &gt; 0) {</span>
<a href="#l4.304"></a><span id="l4.304">         while (node.hasChildNodes()) {</span>
<a href="#l4.305"></a><span id="l4.305">           node.lastChild.remove();</span>
<a href="#l4.306"></a><span id="l4.306">         }</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-        for (i = 0;  i &lt; total; i++ ) {</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+        for (let i = 0; i &lt; total; i++) {</span>
<a href="#l4.309"></a><span id="l4.309">           var descNode = document.createElement(&quot;description&quot;);</span>
<a href="#l4.310"></a><span id="l4.310">           var card = addressList.queryElementAt(i, Ci.nsIAbCard);</span>
<a href="#l4.311"></a><span id="l4.311"> </span>
<a href="#l4.312"></a><span id="l4.312">           descNode.setAttribute(&quot;class&quot;, &quot;CardViewLink&quot;);</span>
<a href="#l4.313"></a><span id="l4.313">           node.appendChild(descNode);</span>
<a href="#l4.314"></a><span id="l4.314"> </span>
<a href="#l4.315"></a><span id="l4.315">           var linkNode = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;a&quot;);</span>
<a href="#l4.316"></a><span id="l4.316">           linkNode.setAttribute(&quot;id&quot;, &quot;addr#&quot; + i);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineat">@@ -508,76 +495,70 @@ function cvAddAddressNodes(node, uri)</span>
<a href="#l4.318"></a><span id="l4.318">         visible = true;</span>
<a href="#l4.319"></a><span id="l4.319">       }</span>
<a href="#l4.320"></a><span id="l4.320">     }</span>
<a href="#l4.321"></a><span id="l4.321">     cvSetVisible(node, visible);</span>
<a href="#l4.322"></a><span id="l4.322">   }</span>
<a href="#l4.323"></a><span id="l4.323">   return visible;</span>
<a href="#l4.324"></a><span id="l4.324"> }</span>
<a href="#l4.325"></a><span id="l4.325"> </span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-function cvSetVisible(node, visible)</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-{</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-  if ( visible )</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+function cvSetVisible(node, visible) {</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+  if (visible)</span>
<a href="#l4.331"></a><span id="l4.331">     node.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l4.332"></a><span id="l4.332">   else</span>
<a href="#l4.333"></a><span id="l4.333">     node.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l4.334"></a><span id="l4.334"> }</span>
<a href="#l4.335"></a><span id="l4.335"> </span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-function HandleLink(node, label, value, box, link)</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-{</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+function HandleLink(node, label, value, box, link) {</span>
<a href="#l4.339"></a><span id="l4.339">   var visible = cvSetNodeWithLabel(node, label, value);</span>
<a href="#l4.340"></a><span id="l4.340">   if (visible)</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-    node.setAttribute('href', link);</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+    node.setAttribute(&quot;href&quot;, link);</span>
<a href="#l4.343"></a><span id="l4.343">   cvSetVisible(box, visible);</span>
<a href="#l4.344"></a><span id="l4.344"> </span>
<a href="#l4.345"></a><span id="l4.345">   return visible;</span>
<a href="#l4.346"></a><span id="l4.346"> }</span>
<a href="#l4.347"></a><span id="l4.347"> </span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-function OpenURLWithHistory(url)</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-{</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+function OpenURLWithHistory(url) {</span>
<a href="#l4.351"></a><span id="l4.351">   PlacesUtils.history.insert({</span>
<a href="#l4.352"></a><span id="l4.352">     url,</span>
<a href="#l4.353"></a><span id="l4.353">     visits: [{</span>
<a href="#l4.354"></a><span id="l4.354">       date: new Date()</span>
<a href="#l4.355"></a><span id="l4.355">     }]</span>
<a href="#l4.356"></a><span id="l4.356">   }).catch(Cu.reportError);</span>
<a href="#l4.357"></a><span id="l4.357">   try {</span>
<a href="#l4.358"></a><span id="l4.358">     var messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance();</span>
<a href="#l4.359"></a><span id="l4.359">     messenger = messenger.QueryInterface(Ci.nsIMessenger);</span>
<a href="#l4.360"></a><span id="l4.360">     messenger.launchExternalURL(url);</span>
<a href="#l4.361"></a><span id="l4.361">   } catch (ex) {}</span>
<a href="#l4.362"></a><span id="l4.362"> }</span>
<a href="#l4.363"></a><span id="l4.363"> </span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-function openLink(id)</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-{</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+function openLink(id) {</span>
<a href="#l4.367"></a><span id="l4.367">   OpenURLWithHistory(document.getElementById(id).getAttribute(&quot;href&quot;));</span>
<a href="#l4.368"></a><span id="l4.368"> </span>
<a href="#l4.369"></a><span id="l4.369">   // return false, so we don't load the href in the addressbook window</span>
<a href="#l4.370"></a><span id="l4.370">   return false;</span>
<a href="#l4.371"></a><span id="l4.371"> }</span>
<a href="#l4.372"></a><span id="l4.372"> </span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-function openLinkWithUrl(aUrl)</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-{</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+function openLinkWithUrl(aUrl) {</span>
<a href="#l4.376"></a><span id="l4.376">   if (aUrl)</span>
<a href="#l4.377"></a><span id="l4.377">     OpenURLWithHistory(aUrl);</span>
<a href="#l4.378"></a><span id="l4.378"> </span>
<a href="#l4.379"></a><span id="l4.379">   // return false, so we don't load the href in the addressbook window</span>
<a href="#l4.380"></a><span id="l4.380">   return false;</span>
<a href="#l4.381"></a><span id="l4.381"> }</span>
<a href="#l4.382"></a><span id="l4.382"> </span>
<a href="#l4.383"></a><span id="l4.383"> /* Display the contact photo from the nsIAbCard in the IMG element.</span>
<a href="#l4.384"></a><span id="l4.384">  * If the photo cannot be displayed, show the generic contact</span>
<a href="#l4.385"></a><span id="l4.385">  * photo.</span>
<a href="#l4.386"></a><span id="l4.386">  */</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-function displayPhoto(aCard, aImg)</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-{</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+function displayPhoto(aCard, aImg) {</span>
<a href="#l4.390"></a><span id="l4.390">   var type = aCard.getProperty(&quot;PhotoType&quot;, &quot;&quot;);</span>
<a href="#l4.391"></a><span id="l4.391">   if (!gPhotoDisplayHandlers[type] ||</span>
<a href="#l4.392"></a><span id="l4.392">       !gPhotoDisplayHandlers[type](aCard, aImg))</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-    gPhotoDisplayHandlers[&quot;generic&quot;](aCard, aImg);</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+    gPhotoDisplayHandlers.generic(aCard, aImg);</span>
<a href="#l4.395"></a><span id="l4.395"> }</span>
<a href="#l4.396"></a><span id="l4.396"> </span>
<a href="#l4.397"></a><span id="l4.397"> /* In order to display the contact photos in the card view, there</span>
<a href="#l4.398"></a><span id="l4.398">  * must be a registered photo display handler for the card photo</span>
<a href="#l4.399"></a><span id="l4.399">  * type.  The generic, file, and web photo types are handled</span>
<a href="#l4.400"></a><span id="l4.400">  * by default.</span>
<a href="#l4.401"></a><span id="l4.401">  *</span>
<a href="#l4.402"></a><span id="l4.402">  * A photo display handler is a function that behaves as follows:</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineat">@@ -587,34 +568,31 @@ function displayPhoto(aCard, aImg)</span>
<a href="#l4.404"></a><span id="l4.404">  *    the photo from nsIAbCard aCard, and for displaying it in img</span>
<a href="#l4.405"></a><span id="l4.405">  *    img element aImg.  Returns true if successful.  If it returns</span>
<a href="#l4.406"></a><span id="l4.406">  *    false, the generic photo display handler will be called.</span>
<a href="#l4.407"></a><span id="l4.407">  *</span>
<a href="#l4.408"></a><span id="l4.408">  * The following display handlers are for the generic, file and</span>
<a href="#l4.409"></a><span id="l4.409">  * web photo types.</span>
<a href="#l4.410"></a><span id="l4.410">  */</span>
<a href="#l4.411"></a><span id="l4.411"> </span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-var genericPhotoDisplayHandler = function(aCard, aImg)</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-{</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+function genericPhotoDisplayHandler(aCard, aImg) {</span>
<a href="#l4.415"></a><span id="l4.415">   aImg.setAttribute(&quot;src&quot;, defaultPhotoURI);</span>
<a href="#l4.416"></a><span id="l4.416">   return true;</span>
<a href="#l4.417"></a><span id="l4.417"> }</span>
<a href="#l4.418"></a><span id="l4.418"> </span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-var photoNameDisplayHandler = function(aCard, aImg)</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-{</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+function photoNameDisplayHandler(aCard, aImg) {</span>
<a href="#l4.422"></a><span id="l4.422">   var photoSrc = getPhotoURI(aCard.getProperty(&quot;PhotoName&quot;));</span>
<a href="#l4.423"></a><span id="l4.423">   aImg.setAttribute(&quot;src&quot;, photoSrc);</span>
<a href="#l4.424"></a><span id="l4.424">   return true;</span>
<a href="#l4.425"></a><span id="l4.425"> }</span>
<a href="#l4.426"></a><span id="l4.426"> </span>
<a href="#l4.427"></a><span id="l4.427"> /* In order for a photo display handler to be registered for</span>
<a href="#l4.428"></a><span id="l4.428">  * a particular photo type, it must be registered here.</span>
<a href="#l4.429"></a><span id="l4.429">  */</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-function registerPhotoDisplayHandler(aType, aPhotoDisplayHandler)</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-{</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+function registerPhotoDisplayHandler(aType, aPhotoDisplayHandler) {</span>
<a href="#l4.433"></a><span id="l4.433">   if (!gPhotoDisplayHandlers[aType])</span>
<a href="#l4.434"></a><span id="l4.434">     gPhotoDisplayHandlers[aType] = aPhotoDisplayHandler;</span>
<a href="#l4.435"></a><span id="l4.435"> }</span>
<a href="#l4.436"></a><span id="l4.436"> </span>
<a href="#l4.437"></a><span id="l4.437"> registerPhotoDisplayHandler(&quot;generic&quot;, genericPhotoDisplayHandler);</span>
<a href="#l4.438"></a><span id="l4.438"> // File and Web are treated the same, and therefore use the</span>
<a href="#l4.439"></a><span id="l4.439"> // same handler.</span>
<a href="#l4.440"></a><span id="l4.440"> registerPhotoDisplayHandler(&quot;file&quot;, photoNameDisplayHandler);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/addrbook/content/abCommon.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCommon.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,15 +1,29 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: javascript; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 ; js-indent-level: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l5.6"></a><span id="l5.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+// addressbook.js</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+/* globals PluralForm, ResultsPaneSelectionChanged, gPreviousDirTreeIndex, onEnterInSearchBar */</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+// abTrees.js</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+/* globals gDirectoryTreeView */</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+// mail/base/content/utilityOverlay.js</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+/* globals goSetMenuValue */</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+// mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+/* globals kCardsOnly, kListsAndCards, kMultipleListsOnly, kNothingSelected, kSingleListOnly */</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+// toolkit/content/globalOverlay.js</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+/* globals goUpdateCommand */</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+var { MailServices } = ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;, null);</span>
<a href="#l5.26"></a><span id="l5.26"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l5.27"></a><span id="l5.27"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.28"></a><span id="l5.28"> ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l5.29"></a><span id="l5.29"> ChromeUtils.import(&quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31"> var gDirTree;</span>
<a href="#l5.32"></a><span id="l5.32"> var abList = null;</span>
<a href="#l5.33"></a><span id="l5.33"> var gAbResultsTree = null;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineat">@@ -35,36 +49,34 @@ var kCollectedAddressbookURI = &quot;moz-abmd</span>
<a href="#l5.35"></a><span id="l5.35"> // blank.</span>
<a href="#l5.36"></a><span id="l5.36"> var defaultPhotoURI = &quot;&quot;;</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38"> var PERMS_DIRECTORY = parseInt(&quot;0755&quot;, 8);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40"> // Controller object for Dir Pane</span>
<a href="#l5.41"></a><span id="l5.41"> var DirPaneController =</span>
<a href="#l5.42"></a><span id="l5.42"> {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  supportsCommand: function(command)</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  supportsCommand(command) {</span>
<a href="#l5.46"></a><span id="l5.46">     switch (command) {</span>
<a href="#l5.47"></a><span id="l5.47">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.48"></a><span id="l5.48">       case &quot;cmd_delete&quot;:</span>
<a href="#l5.49"></a><span id="l5.49">       case &quot;button_delete&quot;:</span>
<a href="#l5.50"></a><span id="l5.50">       case &quot;cmd_properties&quot;:</span>
<a href="#l5.51"></a><span id="l5.51">       case &quot;cmd_abToggleStartupDir&quot;:</span>
<a href="#l5.52"></a><span id="l5.52">       case &quot;cmd_printcard&quot;:</span>
<a href="#l5.53"></a><span id="l5.53">       case &quot;cmd_printcardpreview&quot;:</span>
<a href="#l5.54"></a><span id="l5.54">       case &quot;cmd_newlist&quot;:</span>
<a href="#l5.55"></a><span id="l5.55">       case &quot;cmd_newCard&quot;:</span>
<a href="#l5.56"></a><span id="l5.56">         return true;</span>
<a href="#l5.57"></a><span id="l5.57">       default:</span>
<a href="#l5.58"></a><span id="l5.58">         return false;</span>
<a href="#l5.59"></a><span id="l5.59">     }</span>
<a href="#l5.60"></a><span id="l5.60">   },</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-  isCommandEnabled: function(command)</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-  {</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  isCommandEnabled(command) {</span>
<a href="#l5.65"></a><span id="l5.65">     switch (command) {</span>
<a href="#l5.66"></a><span id="l5.66">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.67"></a><span id="l5.67">         // The gDirTree pane only handles single selection, but normally we</span>
<a href="#l5.68"></a><span id="l5.68">         // enable cmd_selectAll as it will get forwarded to the results pane.</span>
<a href="#l5.69"></a><span id="l5.69">         // But if there is no gAbView, disable as we can't forward to anywhere.</span>
<a href="#l5.70"></a><span id="l5.70">         return (gAbView != null);</span>
<a href="#l5.71"></a><span id="l5.71">       case &quot;cmd_delete&quot;:</span>
<a href="#l5.72"></a><span id="l5.72">       case &quot;button_delete&quot;: {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineat">@@ -91,24 +103,22 @@ var DirPaneController =</span>
<a href="#l5.74"></a><span id="l5.74">         // If the directory is a mailing list, and it is read-only,</span>
<a href="#l5.75"></a><span id="l5.75">         // return false to disable deletion.</span>
<a href="#l5.76"></a><span id="l5.76">         if (selectedDir.isMailList &amp;&amp; selectedDir.readOnly)</span>
<a href="#l5.77"></a><span id="l5.77">           return false;</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">         // If the selected directory is an ldap directory,</span>
<a href="#l5.80"></a><span id="l5.80">         // and if the prefs for this directory are locked,</span>
<a href="#l5.81"></a><span id="l5.81">         // return false to disable deletion.</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-        if (selectedDirURI.startsWith(kLdapUrlPrefix))</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-        {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+        if (selectedDirURI.startsWith(kLdapUrlPrefix)) {</span>
<a href="#l5.85"></a><span id="l5.85">           let disable = false;</span>
<a href="#l5.86"></a><span id="l5.86">           try {</span>
<a href="#l5.87"></a><span id="l5.87">             let prefName = selectedDirURI.substr(kLdapUrlPrefix.length);</span>
<a href="#l5.88"></a><span id="l5.88">             disable = Services.prefs.getBoolPref(prefName + &quot;.disable_delete&quot;);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-          }</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-          catch(ex) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+          } catch (ex) {</span>
<a href="#l5.92"></a><span id="l5.92">             // If this preference is not set, that's ok.</span>
<a href="#l5.93"></a><span id="l5.93">           }</span>
<a href="#l5.94"></a><span id="l5.94">           if (disable)</span>
<a href="#l5.95"></a><span id="l5.95">             return false;</span>
<a href="#l5.96"></a><span id="l5.96">         }</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">         // Else return true to enable deletion (default).</span>
<a href="#l5.99"></a><span id="l5.99">         return true;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineat">@@ -144,18 +154,17 @@ var DirPaneController =</span>
<a href="#l5.101"></a><span id="l5.101">       case &quot;cmd_newlist&quot;:</span>
<a href="#l5.102"></a><span id="l5.102">       case &quot;cmd_newCard&quot;:</span>
<a href="#l5.103"></a><span id="l5.103">         return true;</span>
<a href="#l5.104"></a><span id="l5.104">       default:</span>
<a href="#l5.105"></a><span id="l5.105">         return false;</span>
<a href="#l5.106"></a><span id="l5.106">     }</span>
<a href="#l5.107"></a><span id="l5.107">   },</span>
<a href="#l5.108"></a><span id="l5.108"> </span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-  doCommand: function(command)</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-  {</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+  doCommand(command) {</span>
<a href="#l5.112"></a><span id="l5.112">     switch (command) {</span>
<a href="#l5.113"></a><span id="l5.113">       case &quot;cmd_printcard&quot;:</span>
<a href="#l5.114"></a><span id="l5.114">       case &quot;cmd_printcardpreview&quot;:</span>
<a href="#l5.115"></a><span id="l5.115">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.116"></a><span id="l5.116">         SendCommandToResultsPane(command);</span>
<a href="#l5.117"></a><span id="l5.117">         break;</span>
<a href="#l5.118"></a><span id="l5.118">       case &quot;cmd_delete&quot;:</span>
<a href="#l5.119"></a><span id="l5.119">       case &quot;button_delete&quot;:</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineat">@@ -172,51 +181,46 @@ var DirPaneController =</span>
<a href="#l5.121"></a><span id="l5.121">         AbNewList();</span>
<a href="#l5.122"></a><span id="l5.122">         break;</span>
<a href="#l5.123"></a><span id="l5.123">       case &quot;cmd_newCard&quot;:</span>
<a href="#l5.124"></a><span id="l5.124">         AbNewCard();</span>
<a href="#l5.125"></a><span id="l5.125">         break;</span>
<a href="#l5.126"></a><span id="l5.126">     }</span>
<a href="#l5.127"></a><span id="l5.127">   },</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-  onEvent: function(event)</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-  {</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+  onEvent(event) {</span>
<a href="#l5.132"></a><span id="l5.132">     // on blur events set the menu item texts back to the normal values</span>
<a href="#l5.133"></a><span id="l5.133">     if (event == &quot;blur&quot;)</span>
<a href="#l5.134"></a><span id="l5.134">       goSetMenuValue(&quot;cmd_delete&quot;, &quot;valueDefault&quot;);</span>
<a href="#l5.135"></a><span id="l5.135">   }</span>
<a href="#l5.136"></a><span id="l5.136"> };</span>
<a href="#l5.137"></a><span id="l5.137"> </span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-function SendCommandToResultsPane(command)</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-{</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+function SendCommandToResultsPane(command) {</span>
<a href="#l5.141"></a><span id="l5.141">   ResultsPaneController.doCommand(command);</span>
<a href="#l5.142"></a><span id="l5.142"> </span>
<a href="#l5.143"></a><span id="l5.143">   // if we are sending the command so the results pane</span>
<a href="#l5.144"></a><span id="l5.144">   // we should focus the results pane</span>
<a href="#l5.145"></a><span id="l5.145">   gAbResultsTree.focus();</span>
<a href="#l5.146"></a><span id="l5.146"> }</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-function AbNewLDAPDirectory()</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-{</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+function AbNewLDAPDirectory() {</span>
<a href="#l5.151"></a><span id="l5.151">   window.openDialog(&quot;chrome://messenger/content/addressbook/pref-directory-add.xul&quot;,</span>
<a href="#l5.152"></a><span id="l5.152">                     &quot;&quot;,</span>
<a href="#l5.153"></a><span id="l5.153">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l5.154"></a><span id="l5.154">                     null);</span>
<a href="#l5.155"></a><span id="l5.155"> }</span>
<a href="#l5.156"></a><span id="l5.156"> </span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-function AbNewAddressBook()</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-{</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+function AbNewAddressBook() {</span>
<a href="#l5.160"></a><span id="l5.160">   window.openDialog(&quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xul&quot;,</span>
<a href="#l5.161"></a><span id="l5.161">                     &quot;&quot;,</span>
<a href="#l5.162"></a><span id="l5.162">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l5.163"></a><span id="l5.163">                     null);</span>
<a href="#l5.164"></a><span id="l5.164"> }</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-function AbEditSelectedDirectory()</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-{</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+function AbEditSelectedDirectory() {</span>
<a href="#l5.169"></a><span id="l5.169">   let selectedDir = getSelectedDirectory();</span>
<a href="#l5.170"></a><span id="l5.170">   if (!selectedDir)</span>
<a href="#l5.171"></a><span id="l5.171">     return;</span>
<a href="#l5.172"></a><span id="l5.172"> </span>
<a href="#l5.173"></a><span id="l5.173">   if (selectedDir.isMailList) {</span>
<a href="#l5.174"></a><span id="l5.174">     goEditListDialog(null, selectedDir.URI);</span>
<a href="#l5.175"></a><span id="l5.175">   } else {</span>
<a href="#l5.176"></a><span id="l5.176">     window.openDialog(selectedDir.propertiesChromeURI,</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineat">@@ -232,18 +236,17 @@ function updateDirTreeContext() {</span>
<a href="#l5.178"></a><span id="l5.178">     let startupURI = Services.prefs.getCharPref(&quot;mail.addr_book.view.startupURI&quot;);</span>
<a href="#l5.179"></a><span id="l5.179">     let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l5.180"></a><span id="l5.180">     startupItem.setAttribute(&quot;checked&quot;, (startupURI == selectedDirURI));</span>
<a href="#l5.181"></a><span id="l5.181">   } else {</span>
<a href="#l5.182"></a><span id="l5.182">     startupItem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l5.183"></a><span id="l5.183">   }</span>
<a href="#l5.184"></a><span id="l5.184"> }</span>
<a href="#l5.185"></a><span id="l5.185"> </span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-function abToggleSelectedDirStartup()</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-{</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+function abToggleSelectedDirStartup() {</span>
<a href="#l5.189"></a><span id="l5.189">   let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l5.190"></a><span id="l5.190">   if (!selectedDirURI)</span>
<a href="#l5.191"></a><span id="l5.191">     return;</span>
<a href="#l5.192"></a><span id="l5.192"> </span>
<a href="#l5.193"></a><span id="l5.193">   let isDefault = Services.prefs.getBoolPref(&quot;mail.addr_book.view.startupURIisDefault&quot;);</span>
<a href="#l5.194"></a><span id="l5.194">   let startupURI = Services.prefs.getCharPref(&quot;mail.addr_book.view.startupURI&quot;);</span>
<a href="#l5.195"></a><span id="l5.195"> </span>
<a href="#l5.196"></a><span id="l5.196">   if (isDefault &amp;&amp; (startupURI == selectedDirURI)) {</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineat">@@ -256,59 +259,54 @@ function abToggleSelectedDirStartup()</span>
<a href="#l5.198"></a><span id="l5.198">     Services.prefs.setCharPref(&quot;mail.addr_book.view.startupURI&quot;, selectedDirURI);</span>
<a href="#l5.199"></a><span id="l5.199">     Services.prefs.setBoolPref(&quot;mail.addr_book.view.startupURIisDefault&quot;, true);</span>
<a href="#l5.200"></a><span id="l5.200">   }</span>
<a href="#l5.201"></a><span id="l5.201"> </span>
<a href="#l5.202"></a><span id="l5.202">   // Update the checkbox in the menuitem.</span>
<a href="#l5.203"></a><span id="l5.203">   goUpdateCommand(&quot;cmd_abToggleStartupDir&quot;);</span>
<a href="#l5.204"></a><span id="l5.204"> }</span>
<a href="#l5.205"></a><span id="l5.205"> </span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-function AbDeleteSelectedDirectory()</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-{</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+function AbDeleteSelectedDirectory() {</span>
<a href="#l5.209"></a><span id="l5.209">   let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l5.210"></a><span id="l5.210">   if (!selectedDirURI)</span>
<a href="#l5.211"></a><span id="l5.211">     return;</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213">   AbDeleteDirectory(selectedDirURI);</span>
<a href="#l5.214"></a><span id="l5.214"> }</span>
<a href="#l5.215"></a><span id="l5.215"> </span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-function AbDeleteDirectory(aURI)</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-{</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+function AbDeleteDirectory(aURI) {</span>
<a href="#l5.219"></a><span id="l5.219">   // Determine strings for smart and context-sensitive user prompts</span>
<a href="#l5.220"></a><span id="l5.220">   // for confirming deletion.</span>
<a href="#l5.221"></a><span id="l5.221">   let directory = GetDirectoryFromURI(aURI);</span>
<a href="#l5.222"></a><span id="l5.222">   let confirmDeleteTitleID;</span>
<a href="#l5.223"></a><span id="l5.223">   let confirmDeleteTitle;</span>
<a href="#l5.224"></a><span id="l5.224">   let confirmDeleteMessageID;</span>
<a href="#l5.225"></a><span id="l5.225">   let confirmDeleteMessage;</span>
<a href="#l5.226"></a><span id="l5.226">   let brandShortName;</span>
<a href="#l5.227"></a><span id="l5.227">   let clearCollectionPrefs = false;</span>
<a href="#l5.228"></a><span id="l5.228"> </span>
<a href="#l5.229"></a><span id="l5.229">   if (directory.isMailList) {</span>
<a href="#l5.230"></a><span id="l5.230">     // It's a mailing list.</span>
<a href="#l5.231"></a><span id="l5.231">     confirmDeleteMessageID = &quot;confirmDeleteThisMailingList&quot;;</span>
<a href="#l5.232"></a><span id="l5.232">     confirmDeleteTitleID = &quot;confirmDeleteThisMailingListTitle&quot;;</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+  } else if (Services.prefs.getCharPref(&quot;mail.collect_addressbook&quot;) == aURI &amp;&amp;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+      Services.prefs.getBoolPref(&quot;mail.collect_email_address_outgoing&quot;)) {</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+    // It's a collection address book: let's be clear about the consequences.</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+    brandShortName = document.getElementById(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+    confirmDeleteMessageID = &quot;confirmDeleteThisCollectionAddressbook&quot;;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+    confirmDeleteTitleID = &quot;confirmDeleteThisCollectionAddressbookTitle&quot;;</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+    clearCollectionPrefs = true;</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  } else if (directory.URI.startsWith(kLdapUrlPrefix)) {</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+    // It's an LDAP directory, so we only delete our offline copy.</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+    confirmDeleteMessageID = &quot;confirmDeleteThisLDAPDir&quot;;</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+    confirmDeleteTitleID = &quot;confirmDeleteThisLDAPDirTitle&quot;;</span>
<a href="#l5.244"></a><span id="l5.244">   } else {</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-    // It's an address book: check which type.</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-    if (Services.prefs.getCharPref(&quot;mail.collect_addressbook&quot;) == aURI &amp;&amp;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-        Services.prefs.getBoolPref(&quot;mail.collect_email_address_outgoing&quot;)) {</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-      // It's a collection address book: let's be clear about the consequences.</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-      brandShortName = document.getElementById(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-      confirmDeleteMessageID = &quot;confirmDeleteThisCollectionAddressbook&quot;;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-      confirmDeleteTitleID = &quot;confirmDeleteThisCollectionAddressbookTitle&quot;;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-      clearCollectionPrefs = true;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-    } else if (directory.URI.startsWith(kLdapUrlPrefix)) {</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-      // It's an LDAP directory, so we only delete our offline copy.</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-      confirmDeleteMessageID = &quot;confirmDeleteThisLDAPDir&quot;;</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-      confirmDeleteTitleID = &quot;confirmDeleteThisLDAPDirTitle&quot;;</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-    } else {</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-      // It's a normal personal address book: we'll delete its contacts, too.</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-      confirmDeleteMessageID = &quot;confirmDeleteThisAddressbook&quot;;</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-      confirmDeleteTitleID = &quot;confirmDeleteThisAddressbookTitle&quot;;</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-    }</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+    // It's a normal personal address book: we'll delete its contacts, too.</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+    confirmDeleteMessageID = &quot;confirmDeleteThisAddressbook&quot;;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+    confirmDeleteTitleID = &quot;confirmDeleteThisAddressbookTitle&quot;;</span>
<a href="#l5.265"></a><span id="l5.265">   }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267">   // Get the raw strings with placeholders.</span>
<a href="#l5.268"></a><span id="l5.268">   confirmDeleteTitle   = gAddressBookBundle.getString(confirmDeleteTitleID);</span>
<a href="#l5.269"></a><span id="l5.269">   confirmDeleteMessage = gAddressBookBundle.getString(confirmDeleteMessageID);</span>
<a href="#l5.270"></a><span id="l5.270"> </span>
<a href="#l5.271"></a><span id="l5.271">   // Substitute placeholders as required.</span>
<a href="#l5.272"></a><span id="l5.272">   // Replace #1 with the name of the selected address book or mailing list.</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineat">@@ -332,55 +330,52 @@ function AbDeleteDirectory(aURI)</span>
<a href="#l5.274"></a><span id="l5.274">     // Change the collection AB pref to &quot;Personal Address Book&quot; so that we</span>
<a href="#l5.275"></a><span id="l5.275">     // don't get a blank item in prefs dialog when collection is re-enabled.</span>
<a href="#l5.276"></a><span id="l5.276">     Services.prefs.setCharPref(&quot;mail.collect_addressbook&quot;, kPersonalAddressbookURI);</span>
<a href="#l5.277"></a><span id="l5.277">   }</span>
<a href="#l5.278"></a><span id="l5.278"> </span>
<a href="#l5.279"></a><span id="l5.279">   MailServices.ab.deleteAddressBook(aURI);</span>
<a href="#l5.280"></a><span id="l5.280"> }</span>
<a href="#l5.281"></a><span id="l5.281"> </span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-function GetParentRow(aTree, aRow)</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-{</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+function GetParentRow(aTree, aRow) {</span>
<a href="#l5.285"></a><span id="l5.285">   var row = aRow;</span>
<a href="#l5.286"></a><span id="l5.286">   var level = aTree.view.getLevel(row);</span>
<a href="#l5.287"></a><span id="l5.287">   var parentLevel = level;</span>
<a href="#l5.288"></a><span id="l5.288">   while (parentLevel &gt;= level) {</span>
<a href="#l5.289"></a><span id="l5.289">     row--;</span>
<a href="#l5.290"></a><span id="l5.290">     if (row == -1)</span>
<a href="#l5.291"></a><span id="l5.291">       return row;</span>
<a href="#l5.292"></a><span id="l5.292">     parentLevel = aTree.view.getLevel(row);</span>
<a href="#l5.293"></a><span id="l5.293">   }</span>
<a href="#l5.294"></a><span id="l5.294">   return row;</span>
<a href="#l5.295"></a><span id="l5.295"> }</span>
<a href="#l5.296"></a><span id="l5.296"> </span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-function InitCommonJS()</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-{</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+function InitCommonJS() {</span>
<a href="#l5.300"></a><span id="l5.300">   gDirTree = document.getElementById(&quot;dirTree&quot;);</span>
<a href="#l5.301"></a><span id="l5.301">   abList = document.getElementById(&quot;addressbookList&quot;);</span>
<a href="#l5.302"></a><span id="l5.302">   gAddressBookBundle = document.getElementById(&quot;bundle_addressBook&quot;);</span>
<a href="#l5.303"></a><span id="l5.303"> }</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-function AbDelete()</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-{</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+function AbDelete() {</span>
<a href="#l5.308"></a><span id="l5.308">   let types = GetSelectedCardTypes();</span>
<a href="#l5.309"></a><span id="l5.309">   if (types == kNothingSelected)</span>
<a href="#l5.310"></a><span id="l5.310">     return;</span>
<a href="#l5.311"></a><span id="l5.311"> </span>
<a href="#l5.312"></a><span id="l5.312">   // Determine strings for smart and context-sensitive user prompts</span>
<a href="#l5.313"></a><span id="l5.313">   // for confirming deletion.</span>
<a href="#l5.314"></a><span id="l5.314">   let confirmDeleteTitleID;</span>
<a href="#l5.315"></a><span id="l5.315">   let confirmDeleteTitle;</span>
<a href="#l5.316"></a><span id="l5.316">   let confirmDeleteMessageID;</span>
<a href="#l5.317"></a><span id="l5.317">   let confirmDeleteMessage;</span>
<a href="#l5.318"></a><span id="l5.318">   let itemName;</span>
<a href="#l5.319"></a><span id="l5.319">   let containingListName;</span>
<a href="#l5.320"></a><span id="l5.320">   let selectedDir = getSelectedDirectory();</span>
<a href="#l5.321"></a><span id="l5.321">   let numSelectedItems = gAbView.selection.count;</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  switch(types) {</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+  switch (types) {</span>
<a href="#l5.325"></a><span id="l5.325">     case kListsAndCards:</span>
<a href="#l5.326"></a><span id="l5.326">       confirmDeleteMessageID = &quot;confirmDelete2orMoreContactsAndLists&quot;;</span>
<a href="#l5.327"></a><span id="l5.327">       confirmDeleteTitleID   = &quot;confirmDelete2orMoreContactsAndListsTitle&quot;;</span>
<a href="#l5.328"></a><span id="l5.328">       break;</span>
<a href="#l5.329"></a><span id="l5.329">     case kSingleListOnly:</span>
<a href="#l5.330"></a><span id="l5.330">       // Set item name for single mailing list.</span>
<a href="#l5.331"></a><span id="l5.331">       let theCard = GetSelectedAbCards()[0];</span>
<a href="#l5.332"></a><span id="l5.332">       itemName = theCard.displayName;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineat">@@ -398,25 +393,23 @@ function AbDelete()</span>
<a href="#l5.334"></a><span id="l5.334">           confirmDeleteMessageID = &quot;confirmRemoveThisContact&quot;;</span>
<a href="#l5.335"></a><span id="l5.335">           confirmDeleteTitleID = &quot;confirmRemoveThisContactTitle&quot;;</span>
<a href="#l5.336"></a><span id="l5.336">         } else {</span>
<a href="#l5.337"></a><span id="l5.337">           confirmDeleteMessageID = &quot;confirmRemove2orMoreContacts&quot;;</span>
<a href="#l5.338"></a><span id="l5.338">           confirmDeleteTitleID   = &quot;confirmRemove2orMoreContactsTitle&quot;;</span>
<a href="#l5.339"></a><span id="l5.339">         }</span>
<a href="#l5.340"></a><span id="l5.340">         // For removing contacts from mailing list, set placeholder value</span>
<a href="#l5.341"></a><span id="l5.341">         containingListName = selectedDir.dirName;</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-      } else {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+      } else if (numSelectedItems == 1) {</span>
<a href="#l5.344"></a><span id="l5.344">         // Contact(s) in address books will be deleted.</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-        if (numSelectedItems == 1) {</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-          confirmDeleteMessageID = &quot;confirmDeleteThisContact&quot;;</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-          confirmDeleteTitleID   = &quot;confirmDeleteThisContactTitle&quot;;</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-        } else {</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-          confirmDeleteMessageID = &quot;confirmDelete2orMoreContacts&quot;;</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-          confirmDeleteTitleID   = &quot;confirmDelete2orMoreContactsTitle&quot;;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-        }</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+        confirmDeleteMessageID = &quot;confirmDeleteThisContact&quot;;</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+        confirmDeleteTitleID   = &quot;confirmDeleteThisContactTitle&quot;;</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+      } else {</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+        confirmDeleteMessageID = &quot;confirmDelete2orMoreContacts&quot;;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+        confirmDeleteTitleID   = &quot;confirmDelete2orMoreContactsTitle&quot;;</span>
<a href="#l5.357"></a><span id="l5.357">       }</span>
<a href="#l5.358"></a><span id="l5.358">       if (numSelectedItems == 1) {</span>
<a href="#l5.359"></a><span id="l5.359">         // Set item name for single contact.</span>
<a href="#l5.360"></a><span id="l5.360">         let theCard = GetSelectedAbCards()[0];</span>
<a href="#l5.361"></a><span id="l5.361">         let nameFormatFromPref = Services.prefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;);</span>
<a href="#l5.362"></a><span id="l5.362">         itemName = theCard.generateName(nameFormatFromPref);</span>
<a href="#l5.363"></a><span id="l5.363">       }</span>
<a href="#l5.364"></a><span id="l5.364">       break;</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineat">@@ -467,55 +460,51 @@ function AbDelete()</span>
<a href="#l5.366"></a><span id="l5.366">     }</span>
<a href="#l5.367"></a><span id="l5.367">     SetAbView(kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l5.368"></a><span id="l5.368">   } else {</span>
<a href="#l5.369"></a><span id="l5.369">     // Delete cards from address books or mailing lists.</span>
<a href="#l5.370"></a><span id="l5.370">     gAbView.deleteSelectedCards();</span>
<a href="#l5.371"></a><span id="l5.371">   }</span>
<a href="#l5.372"></a><span id="l5.372"> }</span>
<a href="#l5.373"></a><span id="l5.373"> </span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-function AbNewCard()</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-{</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+function AbNewCard() {</span>
<a href="#l5.377"></a><span id="l5.377">   goNewCardDialog(getSelectedDirectoryURI());</span>
<a href="#l5.378"></a><span id="l5.378"> }</span>
<a href="#l5.379"></a><span id="l5.379"> </span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-function AbEditCard(card)</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-{</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+function AbEditCard(card) {</span>
<a href="#l5.383"></a><span id="l5.383">   // Need a card,</span>
<a href="#l5.384"></a><span id="l5.384">   // but not allowing AOL special groups to be edited.</span>
<a href="#l5.385"></a><span id="l5.385">   if (!card)</span>
<a href="#l5.386"></a><span id="l5.386">     return;</span>
<a href="#l5.387"></a><span id="l5.387"> </span>
<a href="#l5.388"></a><span id="l5.388">   if (card.isMailList) {</span>
<a href="#l5.389"></a><span id="l5.389">     goEditListDialog(card, card.mailListURI);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-  }</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-  else {</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+  } else {</span>
<a href="#l5.393"></a><span id="l5.393">     goEditCardDialog(getSelectedDirectoryURI(), card);</span>
<a href="#l5.394"></a><span id="l5.394">   }</span>
<a href="#l5.395"></a><span id="l5.395"> }</span>
<a href="#l5.396"></a><span id="l5.396"> </span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-function AbNewMessage()</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-{</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+function AbNewMessage() {</span>
<a href="#l5.400"></a><span id="l5.400">   let msgComposeType = Ci.nsIMsgCompType;</span>
<a href="#l5.401"></a><span id="l5.401">   let msgComposeFormat = Ci.nsIMsgCompFormat;</span>
<a href="#l5.402"></a><span id="l5.402"> </span>
<a href="#l5.403"></a><span id="l5.403">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l5.404"></a><span id="l5.404">   if (params) {</span>
<a href="#l5.405"></a><span id="l5.405">     params.type = msgComposeType.New;</span>
<a href="#l5.406"></a><span id="l5.406">     params.format = msgComposeFormat.Default;</span>
<a href="#l5.407"></a><span id="l5.407">     let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l5.408"></a><span id="l5.408">     if (composeFields) {</span>
<a href="#l5.409"></a><span id="l5.409">       if (DirPaneHasFocus()) {</span>
<a href="#l5.410"></a><span id="l5.410">         let selectedDir = getSelectedDirectory();</span>
<a href="#l5.411"></a><span id="l5.411">         let hidesRecipients = false;</span>
<a href="#l5.412"></a><span id="l5.412">         try {</span>
<a href="#l5.413"></a><span id="l5.413">           // This is a bit of hackery so that extensions can have mailing lists</span>
<a href="#l5.414"></a><span id="l5.414">           // where recipients are sent messages via BCC.</span>
<a href="#l5.415"></a><span id="l5.415">           hidesRecipients = selectedDir.getBoolValue(&quot;HidesRecipients&quot;, false);</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-        } catch(e) {</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+        } catch (e) {</span>
<a href="#l5.418"></a><span id="l5.418">           // Standard Thunderbird mailing lists do not have preferences</span>
<a href="#l5.419"></a><span id="l5.419">           // associated with them, so we'll silently eat the error.</span>
<a href="#l5.420"></a><span id="l5.420">         }</span>
<a href="#l5.421"></a><span id="l5.421"> </span>
<a href="#l5.422"></a><span id="l5.422">         if (selectedDir &amp;&amp; selectedDir.isMailList &amp;&amp; hidesRecipients)</span>
<a href="#l5.423"></a><span id="l5.423">           // Bug 669301 (https://bugzilla.mozilla.org/show_bug.cgi?id=669301)</span>
<a href="#l5.424"></a><span id="l5.424">           // We're using BCC right now to hide recipients from one another.</span>
<a href="#l5.425"></a><span id="l5.425">           // We should probably use group syntax, but that's broken</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineat">@@ -547,259 +536,237 @@ function InitViewLayoutMenuPopup(event) </span>
<a href="#l5.427"></a><span id="l5.427">   cardPaneMenuItem.setAttribute(&quot;checked&quot;, document.getElementById(</span>
<a href="#l5.428"></a><span id="l5.428">     &quot;results-splitter&quot;).getAttribute(&quot;state&quot;) != &quot;collapsed&quot;);</span>
<a href="#l5.429"></a><span id="l5.429"> }</span>
<a href="#l5.430"></a><span id="l5.430"> </span>
<a href="#l5.431"></a><span id="l5.431"> // Generate a list of cards from the selected mailing list</span>
<a href="#l5.432"></a><span id="l5.432"> // and get a comma separated list of card addresses. If the</span>
<a href="#l5.433"></a><span id="l5.433"> // item selected in the directory pane is not a mailing list,</span>
<a href="#l5.434"></a><span id="l5.434"> // an empty string is returned.</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-function GetSelectedAddressesFromDirTree()</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-{</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+function GetSelectedAddressesFromDirTree() {</span>
<a href="#l5.438"></a><span id="l5.438">   let selectedDir = getSelectedDirectory();</span>
<a href="#l5.439"></a><span id="l5.439"> </span>
<a href="#l5.440"></a><span id="l5.440">   if (!selectedDir || !selectedDir.isMailList)</span>
<a href="#l5.441"></a><span id="l5.441">     return &quot;&quot;;</span>
<a href="#l5.442"></a><span id="l5.442"> </span>
<a href="#l5.443"></a><span id="l5.443">   let listCardsCount = selectedDir.addressLists.length;</span>
<a href="#l5.444"></a><span id="l5.444">   let cards = new Array(listCardsCount);</span>
<a href="#l5.445"></a><span id="l5.445">   for (let i = 0; i &lt; listCardsCount; ++i)</span>
<a href="#l5.446"></a><span id="l5.446">     cards[i] = selectedDir.addressLists</span>
<a href="#l5.447"></a><span id="l5.447">                  .queryElementAt(i, Ci.nsIAbCard);</span>
<a href="#l5.448"></a><span id="l5.448">   return GetAddressesForCards(cards);</span>
<a href="#l5.449"></a><span id="l5.449"> }</span>
<a href="#l5.450"></a><span id="l5.450"> </span>
<a href="#l5.451"></a><span id="l5.451"> // Generate a comma separated list of addresses from a given</span>
<a href="#l5.452"></a><span id="l5.452"> // set of cards.</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-function GetAddressesForCards(cards)</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-{</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+function GetAddressesForCards(cards) {</span>
<a href="#l5.456"></a><span id="l5.456">   var addresses = &quot;&quot;;</span>
<a href="#l5.457"></a><span id="l5.457"> </span>
<a href="#l5.458"></a><span id="l5.458">   if (!cards) {</span>
<a href="#l5.459"></a><span id="l5.459">     Cu.reportError(&quot;GetAddressesForCards: |cards| is null.&quot;);</span>
<a href="#l5.460"></a><span id="l5.460">     return addresses;</span>
<a href="#l5.461"></a><span id="l5.461">   }</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-  var count = cards.length;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-</span>
<a href="#l5.465"></a><span id="l5.465">   // We do not handle the case where there is one or more null-ish</span>
<a href="#l5.466"></a><span id="l5.466">   // element in the Array.  Always non-null element is pushed into</span>
<a href="#l5.467"></a><span id="l5.467">   // cards[] array.</span>
<a href="#l5.468"></a><span id="l5.468"> </span>
<a href="#l5.469"></a><span id="l5.469">   let generatedAddresses = cards.map(GenerateAddressFromCard)</span>
<a href="#l5.470"></a><span id="l5.470">     .filter(function(aAddress) {</span>
<a href="#l5.471"></a><span id="l5.471">       return aAddress;</span>
<a href="#l5.472"></a><span id="l5.472">     });</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-  return generatedAddresses.join(',');</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+  return generatedAddresses.join(&quot;,&quot;);</span>
<a href="#l5.475"></a><span id="l5.475"> }</span>
<a href="#l5.476"></a><span id="l5.476"> </span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-function SelectFirstAddressBook()</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-{</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+function SelectFirstAddressBook() {</span>
<a href="#l5.480"></a><span id="l5.480">   if (gDirTree.view.selection.currentIndex != 0) {</span>
<a href="#l5.481"></a><span id="l5.481">     gDirTree.view.selection.select(0);</span>
<a href="#l5.482"></a><span id="l5.482">     // If gPreviousDirTreeIndex == 0 then DirPaneSelectionChange() and</span>
<a href="#l5.483"></a><span id="l5.483">     // ChangeDirectoryByURI() have already been run</span>
<a href="#l5.484"></a><span id="l5.484">     // (e.g. by the onselect event on the tree) so skip the call.</span>
<a href="#l5.485"></a><span id="l5.485">     if (gPreviousDirTreeIndex != 0)</span>
<a href="#l5.486"></a><span id="l5.486">       ChangeDirectoryByURI(getSelectedDirectoryURI());</span>
<a href="#l5.487"></a><span id="l5.487">   }</span>
<a href="#l5.488"></a><span id="l5.488">   gAbResultsTree.focus();</span>
<a href="#l5.489"></a><span id="l5.489"> }</span>
<a href="#l5.490"></a><span id="l5.490"> </span>
<a href="#l5.491"></a><span id="l5.491"> /**</span>
<a href="#l5.492"></a><span id="l5.492">  * Get the startup view directory from pref and select it in the</span>
<a href="#l5.493"></a><span id="l5.493">  * directory tree so that it gets shown.</span>
<a href="#l5.494"></a><span id="l5.494">  */</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-function selectStartupViewDirectory()</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineminus">-{</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+function selectStartupViewDirectory() {</span>
<a href="#l5.498"></a><span id="l5.498">   let startupURI = Services.prefs.getCharPref(&quot;mail.addr_book.view.startupURI&quot;);</span>
<a href="#l5.499"></a><span id="l5.499">   if (!startupURI) {</span>
<a href="#l5.500"></a><span id="l5.500">     // If pref is empty, fall back to &quot;All Address Books&quot; root directory.</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineminus">-    startupURI = kAllDirectoryRoot + &quot;?&quot;</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+    startupURI = kAllDirectoryRoot + &quot;?&quot;;</span>
<a href="#l5.503"></a><span id="l5.503">   }</span>
<a href="#l5.504"></a><span id="l5.504">   let startupDirTreeIndex = gDirectoryTreeView.getIndexForId(startupURI);</span>
<a href="#l5.505"></a><span id="l5.505">   // XXX TODO: If directory of startupURI is collapsed, we fail to find and</span>
<a href="#l5.506"></a><span id="l5.506">   // select it, so getIndexForId returns -1; for now, fall back to &quot;All Address</span>
<a href="#l5.507"></a><span id="l5.507">   // Books&quot; root directory.</span>
<a href="#l5.508"></a><span id="l5.508">   // We also end up here and redirect to &quot;All ABs&quot; root when default directory</span>
<a href="#l5.509"></a><span id="l5.509">   // is not found because it has been deleted; after fixing the collapsed case,</span>
<a href="#l5.510"></a><span id="l5.510">   // deletion will be the only case to end up here, then we could reset the pref</span>
<a href="#l5.511"></a><span id="l5.511">   // here (somewhat lazy and fuzzy).</span>
<a href="#l5.512"></a><span id="l5.512">   if (startupDirTreeIndex == -1) {</span>
<a href="#l5.513"></a><span id="l5.513">     startupDirTreeIndex = gDirectoryTreeView.getIndexForId(kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l5.514"></a><span id="l5.514">   }</span>
<a href="#l5.515"></a><span id="l5.515">   gDirectoryTreeView.selection.select(startupDirTreeIndex);</span>
<a href="#l5.516"></a><span id="l5.516"> }</span>
<a href="#l5.517"></a><span id="l5.517"> </span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-function DirPaneClick(event)</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-{</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+function DirPaneClick(event) {</span>
<a href="#l5.521"></a><span id="l5.521">   // we only care about left button events</span>
<a href="#l5.522"></a><span id="l5.522">   if (event.button != 0)</span>
<a href="#l5.523"></a><span id="l5.523">     return;</span>
<a href="#l5.524"></a><span id="l5.524"> </span>
<a href="#l5.525"></a><span id="l5.525">   // if the user clicks on the header / trecol, do nothing</span>
<a href="#l5.526"></a><span id="l5.526">   if (event.originalTarget.localName == &quot;treecol&quot;) {</span>
<a href="#l5.527"></a><span id="l5.527">     event.stopPropagation();</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-    return;</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+</span>
<a href="#l5.530"></a><span id="l5.530">   }</span>
<a href="#l5.531"></a><span id="l5.531"> }</span>
<a href="#l5.532"></a><span id="l5.532"> </span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-function DirPaneDoubleClick(event)</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-{</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+function DirPaneDoubleClick(event) {</span>
<a href="#l5.536"></a><span id="l5.536">   // We only care about left button events.</span>
<a href="#l5.537"></a><span id="l5.537">   if (event.button != 0)</span>
<a href="#l5.538"></a><span id="l5.538">     return;</span>
<a href="#l5.539"></a><span id="l5.539"> </span>
<a href="#l5.540"></a><span id="l5.540">   // Ignore double clicking on invalid rows.</span>
<a href="#l5.541"></a><span id="l5.541">   let row = gDirTree.treeBoxObject.getRowAt(event.clientX, event.clientY);</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-  if (row == -1 || row &gt; gDirTree.view.rowCount-1)</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+  if (row == -1 || row &gt; gDirTree.view.rowCount - 1)</span>
<a href="#l5.544"></a><span id="l5.544">     return;</span>
<a href="#l5.545"></a><span id="l5.545"> </span>
<a href="#l5.546"></a><span id="l5.546">   // Default action for double click is expand/collapse which ships with the tree.</span>
<a href="#l5.547"></a><span id="l5.547">   // For convenience, allow double-click to edit the properties of mailing</span>
<a href="#l5.548"></a><span id="l5.548">   // lists in directory tree.</span>
<a href="#l5.549"></a><span id="l5.549">   if (gDirTree &amp;&amp; gDirTree.view.selection &amp;&amp;</span>
<a href="#l5.550"></a><span id="l5.550">       gDirTree.view.selection.count == 1 &amp;&amp;</span>
<a href="#l5.551"></a><span id="l5.551">       getSelectedDirectory().isMailList) {</span>
<a href="#l5.552"></a><span id="l5.552">     AbEditSelectedDirectory();</span>
<a href="#l5.553"></a><span id="l5.553">   }</span>
<a href="#l5.554"></a><span id="l5.554"> }</span>
<a href="#l5.555"></a><span id="l5.555"> </span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-function DirPaneSelectionChange()</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineminus">-{</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+function DirPaneSelectionChange() {</span>
<a href="#l5.559"></a><span id="l5.559">   let uri = getSelectedDirectoryURI();</span>
<a href="#l5.560"></a><span id="l5.560">   // clear out the search box when changing folders...</span>
<a href="#l5.561"></a><span id="l5.561">   onAbClearSearch(false);</span>
<a href="#l5.562"></a><span id="l5.562">   if (gDirTree &amp;&amp; gDirTree.view.selection &amp;&amp; gDirTree.view.selection.count == 1) {</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineminus">-    gPreviousDirTreeIndex = gDirTree.currentIndex;</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+    gPreviousDirTreeIndex = gDirTree.currentIndex; // eslint-disable-line no-native-reassign</span>
<a href="#l5.565"></a><span id="l5.565">     ChangeDirectoryByURI(uri);</span>
<a href="#l5.566"></a><span id="l5.566">     document.getElementById(&quot;localResultsOnlyMessage&quot;)</span>
<a href="#l5.567"></a><span id="l5.567">             .setAttribute(&quot;hidden&quot;,</span>
<a href="#l5.568"></a><span id="l5.568">                           !gDirectoryTreeView.hasRemoteAB ||</span>
<a href="#l5.569"></a><span id="l5.569">                           uri != kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l5.570"></a><span id="l5.570">   }</span>
<a href="#l5.571"></a><span id="l5.571"> </span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-  goUpdateCommand('cmd_newlist');</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineminus">-  goUpdateCommand('cmd_newCard');</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+  goUpdateCommand(&quot;cmd_newlist&quot;);</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+  goUpdateCommand(&quot;cmd_newCard&quot;);</span>
<a href="#l5.576"></a><span id="l5.576"> }</span>
<a href="#l5.577"></a><span id="l5.577"> </span>
<a href="#l5.578"></a><span id="l5.578" class="difflineminus">-function ChangeDirectoryByURI(uri = kPersonalAddressbookURI)</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-{</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+function ChangeDirectoryByURI(uri = kPersonalAddressbookURI) {</span>
<a href="#l5.581"></a><span id="l5.581">   SetAbView(uri);</span>
<a href="#l5.582"></a><span id="l5.582"> </span>
<a href="#l5.583"></a><span id="l5.583">   // Actively de-selecting if there are any pre-existing selections</span>
<a href="#l5.584"></a><span id="l5.584">   // in the results list.</span>
<a href="#l5.585"></a><span id="l5.585">   if (gAbView &amp;&amp; gAbView.getCardFromRow(0))</span>
<a href="#l5.586"></a><span id="l5.586">     gAbView.selection.clearSelection();</span>
<a href="#l5.587"></a><span id="l5.587">   else</span>
<a href="#l5.588"></a><span id="l5.588">     // the selection changes if we were switching directories.</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-    ResultsPaneSelectionChanged()</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+    ResultsPaneSelectionChanged();</span>
<a href="#l5.591"></a><span id="l5.591"> }</span>
<a href="#l5.592"></a><span id="l5.592"> </span>
<a href="#l5.593"></a><span id="l5.593" class="difflineminus">-function AbNewList()</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineminus">-{</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+function AbNewList() {</span>
<a href="#l5.596"></a><span id="l5.596">   goNewListDialog(getSelectedDirectoryURI());</span>
<a href="#l5.597"></a><span id="l5.597"> }</span>
<a href="#l5.598"></a><span id="l5.598"> </span>
<a href="#l5.599"></a><span id="l5.599" class="difflineminus">-function goNewListDialog(selectedAB)</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineminus">-{</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+function goNewListDialog(selectedAB) {</span>
<a href="#l5.602"></a><span id="l5.602">   window.openDialog(&quot;chrome://messenger/content/addressbook/abMailListDialog.xul&quot;,</span>
<a href="#l5.603"></a><span id="l5.603">                     &quot;&quot;,</span>
<a href="#l5.604"></a><span id="l5.604">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineminus">-                    {selectedAB:selectedAB});</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+                    {selectedAB});</span>
<a href="#l5.607"></a><span id="l5.607"> }</span>
<a href="#l5.608"></a><span id="l5.608"> </span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-function goEditListDialog(abCard, listURI)</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-{</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+function goEditListDialog(abCard, listURI) {</span>
<a href="#l5.612"></a><span id="l5.612">   let params = {</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-    abCard: abCard,</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-    listURI: listURI,</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+    abCard,</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+    listURI,</span>
<a href="#l5.617"></a><span id="l5.617">     refresh: false, // This is an out param, true if OK in dialog is clicked.</span>
<a href="#l5.618"></a><span id="l5.618">   };</span>
<a href="#l5.619"></a><span id="l5.619">   window.openDialog(&quot;chrome://messenger/content/addressbook/abEditListDialog.xul&quot;,</span>
<a href="#l5.620"></a><span id="l5.620">                     &quot;&quot;,</span>
<a href="#l5.621"></a><span id="l5.621">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l5.622"></a><span id="l5.622">                     params);</span>
<a href="#l5.623"></a><span id="l5.623">   if (params.refresh) {</span>
<a href="#l5.624"></a><span id="l5.624">     ChangeDirectoryByURI(listURI); // force refresh</span>
<a href="#l5.625"></a><span id="l5.625">   }</span>
<a href="#l5.626"></a><span id="l5.626"> }</span>
<a href="#l5.627"></a><span id="l5.627"> </span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-function goNewCardDialog(selectedAB)</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-{</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+function goNewCardDialog(selectedAB) {</span>
<a href="#l5.631"></a><span id="l5.631">   window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l5.632"></a><span id="l5.632">                     &quot;&quot;,</span>
<a href="#l5.633"></a><span id="l5.633">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-                    {selectedAB:selectedAB});</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+                    {selectedAB});</span>
<a href="#l5.636"></a><span id="l5.636"> }</span>
<a href="#l5.637"></a><span id="l5.637"> </span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-function goEditCardDialog(abURI, card)</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-{</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+function goEditCardDialog(abURI, card) {</span>
<a href="#l5.641"></a><span id="l5.641">   window.openDialog(&quot;chrome://messenger/content/addressbook/abEditCardDialog.xul&quot;,</span>
<a href="#l5.642"></a><span id="l5.642">                     &quot;&quot;,</span>
<a href="#l5.643"></a><span id="l5.643">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineminus">-                    {abURI:abURI, card:card});</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+                    {abURI, card});</span>
<a href="#l5.646"></a><span id="l5.646"> }</span>
<a href="#l5.647"></a><span id="l5.647"> </span>
<a href="#l5.648"></a><span id="l5.648" class="difflineminus">-function setSortByMenuItemCheckState(id, value)</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineminus">-{</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineminus">-    var menuitem = document.getElementById(id);</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-    if (menuitem) {</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-      menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineminus">-    }</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+function setSortByMenuItemCheckState(id, value) {</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+  var menuitem = document.getElementById(id);</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+  if (menuitem)</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+    menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l5.658"></a><span id="l5.658"> }</span>
<a href="#l5.659"></a><span id="l5.659"> </span>
<a href="#l5.660"></a><span id="l5.660" class="difflineminus">-function InitViewSortByMenu()</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-{</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-    var sortColumn = kDefaultSortColumn;</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-    var sortDirection = kDefaultAscending;</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+function InitViewSortByMenu() {</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+  var sortColumn = kDefaultSortColumn;</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+  var sortDirection = kDefaultAscending;</span>
<a href="#l5.667"></a><span id="l5.667"> </span>
<a href="#l5.668"></a><span id="l5.668" class="difflineminus">-    if (gAbView) {</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineminus">-      sortColumn = gAbView.sortColumn;</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineminus">-      sortDirection = gAbView.sortDirection;</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineminus">-    }</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+  if (gAbView) {</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+    sortColumn = gAbView.sortColumn;</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+    sortDirection = gAbView.sortDirection;</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+  }</span>
<a href="#l5.676"></a><span id="l5.676"> </span>
<a href="#l5.677"></a><span id="l5.677" class="difflineminus">-    // this approach is necessary to support generic columns that get overlaid.</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineminus">-    let elements = document.querySelectorAll('[name=&quot;sortas&quot;]');</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineminus">-    for (let i = 0; i &lt; elements.length; i++) {</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-      let cmd = elements[i].id;</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-      let columnForCmd = cmd.substr(10); // everything right of cmd_SortBy</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-      setSortByMenuItemCheckState(cmd, (sortColumn == columnForCmd));</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineminus">-    }</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+  // this approach is necessary to support generic columns that get overlaid.</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+  let elements = document.querySelectorAll('[name=&quot;sortas&quot;]');</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+  for (let i = 0; i &lt; elements.length; i++) {</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+    let cmd = elements[i].id;</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+    let columnForCmd = cmd.substr(10); // everything right of cmd_SortBy</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+    setSortByMenuItemCheckState(cmd, (sortColumn == columnForCmd));</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+  }</span>
<a href="#l5.691"></a><span id="l5.691"> </span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-    setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortDirection == kDefaultAscending));</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-    setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortDirection == kDefaultDescending));</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+  setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortDirection == kDefaultAscending));</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+  setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortDirection == kDefaultDescending));</span>
<a href="#l5.696"></a><span id="l5.696"> }</span>
<a href="#l5.697"></a><span id="l5.697"> </span>
<a href="#l5.698"></a><span id="l5.698" class="difflineminus">-function GenerateAddressFromCard(card)</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineminus">-{</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+function GenerateAddressFromCard(card) {</span>
<a href="#l5.701"></a><span id="l5.701">   if (!card)</span>
<a href="#l5.702"></a><span id="l5.702">     return &quot;&quot;;</span>
<a href="#l5.703"></a><span id="l5.703"> </span>
<a href="#l5.704"></a><span id="l5.704">   var email;</span>
<a href="#l5.705"></a><span id="l5.705"> </span>
<a href="#l5.706"></a><span id="l5.706" class="difflineminus">-  if (card.isMailList)</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineminus">-  {</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+  if (card.isMailList) {</span>
<a href="#l5.709"></a><span id="l5.709">     var directory = GetDirectoryFromURI(card.mailListURI);</span>
<a href="#l5.710"></a><span id="l5.710">     email = directory.description || card.displayName;</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+  } else {</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+    email = card.primaryEmail;</span>
<a href="#l5.713"></a><span id="l5.713">   }</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-  else</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-    email = card.primaryEmail;</span>
<a href="#l5.716"></a><span id="l5.716"> </span>
<a href="#l5.717"></a><span id="l5.717">   return MailServices.headerParser.makeMimeAddress(card.displayName, email);</span>
<a href="#l5.718"></a><span id="l5.718"> }</span>
<a href="#l5.719"></a><span id="l5.719"> </span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-function GetDirectoryFromURI(uri)</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineminus">-{</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+function GetDirectoryFromURI(uri) {</span>
<a href="#l5.723"></a><span id="l5.723">   return MailServices.ab.getDirectory(uri);</span>
<a href="#l5.724"></a><span id="l5.724"> }</span>
<a href="#l5.725"></a><span id="l5.725"> </span>
<a href="#l5.726"></a><span id="l5.726"> // returns null if abURI is not a mailing list URI</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineminus">-function GetParentDirectoryFromMailingListURI(abURI)</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineminus">-{</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+function GetParentDirectoryFromMailingListURI(abURI) {</span>
<a href="#l5.730"></a><span id="l5.730">   var abURIArr = abURI.split(&quot;/&quot;);</span>
<a href="#l5.731"></a><span id="l5.731">   /*</span>
<a href="#l5.732"></a><span id="l5.732">    turn turn &quot;moz-abmdbdirectory://abook.mab/MailList6&quot;</span>
<a href="#l5.733"></a><span id="l5.733">    into [&quot;moz-abmdbdirectory:&quot;,&quot;&quot;,&quot;abook.mab&quot;,&quot;MailList6&quot;]</span>
<a href="#l5.734"></a><span id="l5.734">    then, turn [&quot;moz-abmdbdirectory:&quot;,&quot;&quot;,&quot;abook.mab&quot;,&quot;MailList6&quot;]</span>
<a href="#l5.735"></a><span id="l5.735">    into &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l5.736"></a><span id="l5.736">   */</span>
<a href="#l5.737"></a><span id="l5.737">   if (abURIArr.length == 4 &amp;&amp; abURIArr[0] == &quot;moz-abmdbdirectory:&quot; &amp;&amp; abURIArr[3] != &quot;&quot;) {</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineat">@@ -807,86 +774,80 @@ function GetParentDirectoryFromMailingLi</span>
<a href="#l5.739"></a><span id="l5.739">   }</span>
<a href="#l5.740"></a><span id="l5.740"> </span>
<a href="#l5.741"></a><span id="l5.741">   return null;</span>
<a href="#l5.742"></a><span id="l5.742"> }</span>
<a href="#l5.743"></a><span id="l5.743"> </span>
<a href="#l5.744"></a><span id="l5.744"> /**</span>
<a href="#l5.745"></a><span id="l5.745">  * Return true if the directory pane has focus, otherwise false.</span>
<a href="#l5.746"></a><span id="l5.746">  */</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineminus">-function DirPaneHasFocus()</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-{</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+function DirPaneHasFocus() {</span>
<a href="#l5.750"></a><span id="l5.750">   return (top.document.commandDispatcher.focusedElement == gDirTree);</span>
<a href="#l5.751"></a><span id="l5.751"> }</span>
<a href="#l5.752"></a><span id="l5.752"> </span>
<a href="#l5.753"></a><span id="l5.753"> /**</span>
<a href="#l5.754"></a><span id="l5.754">  * Get the selected directory object.</span>
<a href="#l5.755"></a><span id="l5.755">  *</span>
<a href="#l5.756"></a><span id="l5.756">  * @return The object of the currently selected directory</span>
<a href="#l5.757"></a><span id="l5.757">  */</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineminus">-function getSelectedDirectory()</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineminus">-{</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+function getSelectedDirectory() {</span>
<a href="#l5.761"></a><span id="l5.761">   // Contacts Sidebar</span>
<a href="#l5.762"></a><span id="l5.762">   if (abList)</span>
<a href="#l5.763"></a><span id="l5.763">     return MailServices.ab.getDirectory(abList.value);</span>
<a href="#l5.764"></a><span id="l5.764"> </span>
<a href="#l5.765"></a><span id="l5.765">   // Main Address Book</span>
<a href="#l5.766"></a><span id="l5.766">   if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l5.767"></a><span id="l5.767">     return null;</span>
<a href="#l5.768"></a><span id="l5.768">   return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex);</span>
<a href="#l5.769"></a><span id="l5.769"> }</span>
<a href="#l5.770"></a><span id="l5.770"> </span>
<a href="#l5.771"></a><span id="l5.771"> /**</span>
<a href="#l5.772"></a><span id="l5.772">  * Get the URI of the selected directory.</span>
<a href="#l5.773"></a><span id="l5.773">  *</span>
<a href="#l5.774"></a><span id="l5.774">  * @return The URI of the currently selected directory</span>
<a href="#l5.775"></a><span id="l5.775">  */</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineminus">-function getSelectedDirectoryURI()</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineminus">-{</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+function getSelectedDirectoryURI() {</span>
<a href="#l5.779"></a><span id="l5.779">   // Contacts Sidebar</span>
<a href="#l5.780"></a><span id="l5.780">   if (abList)</span>
<a href="#l5.781"></a><span id="l5.781">     return abList.value;</span>
<a href="#l5.782"></a><span id="l5.782"> </span>
<a href="#l5.783"></a><span id="l5.783">   // Main Address Book</span>
<a href="#l5.784"></a><span id="l5.784">   if (gDirTree.currentIndex &lt; 0)</span>
<a href="#l5.785"></a><span id="l5.785">     return null;</span>
<a href="#l5.786"></a><span id="l5.786">   return gDirectoryTreeView.getDirectoryAtIndex(gDirTree.currentIndex).URI;</span>
<a href="#l5.787"></a><span id="l5.787"> }</span>
<a href="#l5.788"></a><span id="l5.788"> </span>
<a href="#l5.789"></a><span id="l5.789"> /**</span>
<a href="#l5.790"></a><span id="l5.790">  * DEPRECATED legacy function wrapper for addon compatibility;</span>
<a href="#l5.791"></a><span id="l5.791">  * use getSelectedDirectoryURI() instead!</span>
<a href="#l5.792"></a><span id="l5.792">  * Return the URI of the selected directory.</span>
<a href="#l5.793"></a><span id="l5.793">  */</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-function GetSelectedDirectory()</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineminus">-{</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+function GetSelectedDirectory() {</span>
<a href="#l5.797"></a><span id="l5.797">   return getSelectedDirectoryURI();</span>
<a href="#l5.798"></a><span id="l5.798"> }</span>
<a href="#l5.799"></a><span id="l5.799"> </span>
<a href="#l5.800"></a><span id="l5.800"> /**</span>
<a href="#l5.801"></a><span id="l5.801">  * Clears the contents of the search input field,</span>
<a href="#l5.802"></a><span id="l5.802">  * possibly causing refresh of results.</span>
<a href="#l5.803"></a><span id="l5.803">  *</span>
<a href="#l5.804"></a><span id="l5.804">  * @param aRefresh  Set to false if the refresh isn't needed,</span>
<a href="#l5.805"></a><span id="l5.805">  *                  e.g. window/AB is going away so user will not see anything.</span>
<a href="#l5.806"></a><span id="l5.806">  */</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineminus">-function onAbClearSearch(aRefresh = true)</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineminus">-{</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+function onAbClearSearch(aRefresh = true) {</span>
<a href="#l5.810"></a><span id="l5.810">   let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l5.811"></a><span id="l5.811">   if (!searchInput || !searchInput.value)</span>
<a href="#l5.812"></a><span id="l5.812">     return;</span>
<a href="#l5.813"></a><span id="l5.813"> </span>
<a href="#l5.814"></a><span id="l5.814">   searchInput.value = &quot;&quot;;</span>
<a href="#l5.815"></a><span id="l5.815">   if (aRefresh)</span>
<a href="#l5.816"></a><span id="l5.816">     onEnterInSearchBar();</span>
<a href="#l5.817"></a><span id="l5.817"> }</span>
<a href="#l5.818"></a><span id="l5.818"> </span>
<a href="#l5.819"></a><span id="l5.819"> // sets focus into the quick search box</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineminus">-function QuickSearchFocus()</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineminus">-{</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+function QuickSearchFocus() {</span>
<a href="#l5.823"></a><span id="l5.823">   let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l5.824"></a><span id="l5.824">   if (searchInput) {</span>
<a href="#l5.825"></a><span id="l5.825">     searchInput.focus();</span>
<a href="#l5.826"></a><span id="l5.826">     searchInput.select();</span>
<a href="#l5.827"></a><span id="l5.827">   }</span>
<a href="#l5.828"></a><span id="l5.828"> }</span>
<a href="#l5.829"></a><span id="l5.829"> </span>
<a href="#l5.830"></a><span id="l5.830"> /**</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineat">@@ -912,18 +873,17 @@ function getPhotosDir() {</span>
<a href="#l5.832"></a><span id="l5.832">  * @return A URI pointing to a photo.</span>
<a href="#l5.833"></a><span id="l5.833">  */</span>
<a href="#l5.834"></a><span id="l5.834"> function getPhotoURI(aPhotoName) {</span>
<a href="#l5.835"></a><span id="l5.835">   if (!aPhotoName)</span>
<a href="#l5.836"></a><span id="l5.836">     return defaultPhotoURI;</span>
<a href="#l5.837"></a><span id="l5.837">   var file = getPhotosDir();</span>
<a href="#l5.838"></a><span id="l5.838">   try {</span>
<a href="#l5.839"></a><span id="l5.839">     file.append(aPhotoName);</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineminus">-  }</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineminus">-  catch (e) {</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+  } catch (e) {</span>
<a href="#l5.843"></a><span id="l5.843">     return defaultPhotoURI;</span>
<a href="#l5.844"></a><span id="l5.844">   }</span>
<a href="#l5.845"></a><span id="l5.845">   if (!file.exists())</span>
<a href="#l5.846"></a><span id="l5.846">     return defaultPhotoURI;</span>
<a href="#l5.847"></a><span id="l5.847">   return Services.io.newFileURI(file).spec;</span>
<a href="#l5.848"></a><span id="l5.848"> }</span>
<a href="#l5.849"></a><span id="l5.849"> </span>
<a href="#l5.850"></a><span id="l5.850"> /**</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineat">@@ -933,17 +893,17 @@ function getPhotoURI(aPhotoName) {</span>
<a href="#l5.852"></a><span id="l5.852">  * @param aExtension The file extension of the photo.</span>
<a href="#l5.853"></a><span id="l5.853">  *</span>
<a href="#l5.854"></a><span id="l5.854">  * @return A unique filename in the given path.</span>
<a href="#l5.855"></a><span id="l5.855">  */</span>
<a href="#l5.856"></a><span id="l5.856"> function makePhotoFile(aDir, aExtension) {</span>
<a href="#l5.857"></a><span id="l5.857">   var filename, newFile;</span>
<a href="#l5.858"></a><span id="l5.858">   // Find a random filename for the photo that doesn't exist yet</span>
<a href="#l5.859"></a><span id="l5.859">   do {</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-    filename = new String(Math.random()).replace(&quot;0.&quot;, &quot;&quot;) + &quot;.&quot; + aExtension;</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineplus">+    filename = Math.random().toString().replace(&quot;0.&quot;, &quot;&quot;) + &quot;.&quot; + aExtension;</span>
<a href="#l5.862"></a><span id="l5.862">     newFile = aDir.clone();</span>
<a href="#l5.863"></a><span id="l5.863">     newFile.append(filename);</span>
<a href="#l5.864"></a><span id="l5.864">   } while (newFile.exists());</span>
<a href="#l5.865"></a><span id="l5.865">   return newFile;</span>
<a href="#l5.866"></a><span id="l5.866"> }</span>
<a href="#l5.867"></a><span id="l5.867"> </span>
<a href="#l5.868"></a><span id="l5.868"> /**</span>
<a href="#l5.869"></a><span id="l5.869">  * Public self-contained object for image transfers.</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineat">@@ -1014,49 +974,47 @@ var gImageDownloader = (function() {</span>
<a href="#l5.871"></a><span id="l5.871">     }</span>
<a href="#l5.872"></a><span id="l5.872"> </span>
<a href="#l5.873"></a><span id="l5.873">     downloader = Cc[&quot;@mozilla.org/embedding/browser/nsWebBrowserPersist;1&quot;]</span>
<a href="#l5.874"></a><span id="l5.874">                    .createInstance(Ci.nsIWebBrowserPersist);</span>
<a href="#l5.875"></a><span id="l5.875">     downloader.persistFlags = Ci.nsIWebBrowserPersist.PERSIST_FLAGS_BYPASS_CACHE</span>
<a href="#l5.876"></a><span id="l5.876">                             | Ci.nsIWebBrowserPersist.PERSIST_FLAGS_REPLACE_EXISTING_FILES</span>
<a href="#l5.877"></a><span id="l5.877">                             | Ci.nsIWebBrowserPersist.PERSIST_FLAGS_CLEANUP_ON_FAILURE;</span>
<a href="#l5.878"></a><span id="l5.878">     downloader.progressListener = {</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineminus">-      onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+      onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l5.881"></a><span id="l5.881">                                  aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l5.882"></a><span id="l5.882">         if (aMaxTotalProgress &gt; -1 &amp;&amp; callbackProgress) {</span>
<a href="#l5.883"></a><span id="l5.883">           // Download progress is 0-90%, 90-100% is verifying and scaling the image.</span>
<a href="#l5.884"></a><span id="l5.884">           let percent = Math.round(initProgress + (aCurTotalProgress / aMaxTotalProgress) * (90 - initProgress));</span>
<a href="#l5.885"></a><span id="l5.885">           callbackProgress(STATE_TRANSFERRING, percent);</span>
<a href="#l5.886"></a><span id="l5.886">         }</span>
<a href="#l5.887"></a><span id="l5.887">       },</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineminus">-      onStateChange: function(aWebProgress, aRequest, aStateFlag, aStatus) {</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineplus">+      onStateChange(aWebProgress, aRequest, aStateFlag, aStatus) {</span>
<a href="#l5.890"></a><span id="l5.890">         // Check if the download successfully finished.</span>
<a href="#l5.891"></a><span id="l5.891">         if ((aStateFlag &amp; Ci.nsIWebProgressListener.STATE_STOP) &amp;&amp;</span>
<a href="#l5.892"></a><span id="l5.892">             !(aStateFlag &amp; Ci.nsIWebProgressListener.STATE_IS_REQUEST)) {</span>
<a href="#l5.893"></a><span id="l5.893">           try {</span>
<a href="#l5.894"></a><span id="l5.894">             // Check the response code in case of an HTTP request to catch 4xx errors</span>
<a href="#l5.895"></a><span id="l5.895">             let http = aRequest.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l5.896"></a><span id="l5.896">             if (http.responseStatus == 200) {</span>
<a href="#l5.897"></a><span id="l5.897">               verifyImage();</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineminus">-            } else {</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineminus">-              if (callbackError) {</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineminus">-                callbackError(ERROR_UNAVAILABLE);</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineminus">-              }</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineplus">+            } else if (callbackError) {</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineplus">+              callbackError(ERROR_UNAVAILABLE);</span>
<a href="#l5.904"></a><span id="l5.904">             }</span>
<a href="#l5.905"></a><span id="l5.905">           } catch (err) {</span>
<a href="#l5.906"></a><span id="l5.906">             // The nsIHttpChannel interface is not available - just proceed</span>
<a href="#l5.907"></a><span id="l5.907">             verifyImage();</span>
<a href="#l5.908"></a><span id="l5.908">           }</span>
<a href="#l5.909"></a><span id="l5.909">         }</span>
<a href="#l5.910"></a><span id="l5.910">       }</span>
<a href="#l5.911"></a><span id="l5.911">     };</span>
<a href="#l5.912"></a><span id="l5.912"> </span>
<a href="#l5.913"></a><span id="l5.913">     let source;</span>
<a href="#l5.914"></a><span id="l5.914">     try {</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-      source = Services.io.newURI(aURI, null, null);</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineplus">+      source = Services.io.newURI(aURI);</span>
<a href="#l5.917"></a><span id="l5.917">     } catch (err) {</span>
<a href="#l5.918"></a><span id="l5.918">       if (callbackError) {</span>
<a href="#l5.919"></a><span id="l5.919">         callbackError(ERROR_INVALID_URI);</span>
<a href="#l5.920"></a><span id="l5.920">       }</span>
<a href="#l5.921"></a><span id="l5.921">       return;</span>
<a href="#l5.922"></a><span id="l5.922">     }</span>
<a href="#l5.923"></a><span id="l5.923"> </span>
<a href="#l5.924"></a><span id="l5.924">     // Start the transfer to a temporary file.</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineat">@@ -1082,17 +1040,17 @@ var gImageDownloader = (function() {</span>
<a href="#l5.926"></a><span id="l5.926">    */</span>
<a href="#l5.927"></a><span id="l5.927">   function verifyImage() {</span>
<a href="#l5.928"></a><span id="l5.928">     let img = new Image();</span>
<a href="#l5.929"></a><span id="l5.929">     img.onerror = function() {</span>
<a href="#l5.930"></a><span id="l5.930">       cleanup();</span>
<a href="#l5.931"></a><span id="l5.931">       if (callbackError) {</span>
<a href="#l5.932"></a><span id="l5.932">         callbackError(ERROR_INVALID_IMG);</span>
<a href="#l5.933"></a><span id="l5.933">       }</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineminus">-    }</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+    };</span>
<a href="#l5.936"></a><span id="l5.936">     img.onload = function() {</span>
<a href="#l5.937"></a><span id="l5.937">       if (callbackProgress) {</span>
<a href="#l5.938"></a><span id="l5.938">         callbackProgress(STATE_RESIZING, 95);</span>
<a href="#l5.939"></a><span id="l5.939">       }</span>
<a href="#l5.940"></a><span id="l5.940"> </span>
<a href="#l5.941"></a><span id="l5.941">       // Images are scaled down in two steps to improve quality. Resizing ratios</span>
<a href="#l5.942"></a><span id="l5.942">       // larger than 2 use a different interpolation algorithm than small ratios.</span>
<a href="#l5.943"></a><span id="l5.943">       // Resize three times (instead of just two steps) to improve the final quality.</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineat">@@ -1103,17 +1061,17 @@ var gImageDownloader = (function() {</span>
<a href="#l5.945"></a><span id="l5.945">       saveCanvas(canvas);</span>
<a href="#l5.946"></a><span id="l5.946"> </span>
<a href="#l5.947"></a><span id="l5.947">       if (callbackProgress) {</span>
<a href="#l5.948"></a><span id="l5.948">         callbackProgress(STATE_OK, 100);</span>
<a href="#l5.949"></a><span id="l5.949">       }</span>
<a href="#l5.950"></a><span id="l5.950"> </span>
<a href="#l5.951"></a><span id="l5.951">       // Remove the temporary file.</span>
<a href="#l5.952"></a><span id="l5.952">       cleanup();</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineminus">-    }</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineplus">+    };</span>
<a href="#l5.955"></a><span id="l5.955"> </span>
<a href="#l5.956"></a><span id="l5.956">     if (callbackProgress) {</span>
<a href="#l5.957"></a><span id="l5.957">       callbackProgress(92);</span>
<a href="#l5.958"></a><span id="l5.958">     }</span>
<a href="#l5.959"></a><span id="l5.959"> </span>
<a href="#l5.960"></a><span id="l5.960">     img.src = Services.io.newFileURI(tempFile).spec;</span>
<a href="#l5.961"></a><span id="l5.961">   }</span>
<a href="#l5.962"></a><span id="l5.962"> </span>
<a href="#l5.963"></a><span id="l5.963" class="difflineat">@@ -1182,26 +1140,26 @@ var gImageDownloader = (function() {</span>
<a href="#l5.964"></a><span id="l5.964">    * Save the contents of a canvas to the photos directory of the profile.</span>
<a href="#l5.965"></a><span id="l5.965">    */</span>
<a href="#l5.966"></a><span id="l5.966">   function saveCanvas(aCanvas) {</span>
<a href="#l5.967"></a><span id="l5.967">     // Get the photos directory and check that it exists</span>
<a href="#l5.968"></a><span id="l5.968">     let file = getPhotosDir();</span>
<a href="#l5.969"></a><span id="l5.969">     file = makePhotoFile(file, &quot;png&quot;);</span>
<a href="#l5.970"></a><span id="l5.970"> </span>
<a href="#l5.971"></a><span id="l5.971">     // Create a data url from the canvas and then create URIs of the source and targets</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineminus">-    let source = Services.io.newURI(aCanvas.toDataURL(&quot;image/png&quot;, &quot;&quot;), &quot;UTF8&quot;, null);</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineplus">+    let source = Services.io.newURI(aCanvas.toDataURL(&quot;image/png&quot;, &quot;&quot;), &quot;UTF8&quot;);</span>
<a href="#l5.974"></a><span id="l5.974">     let target = Services.io.newFileURI(file);</span>
<a href="#l5.975"></a><span id="l5.975"> </span>
<a href="#l5.976"></a><span id="l5.976">     downloader = Cc[&quot;@mozilla.org/embedding/browser/nsWebBrowserPersist;1&quot;]</span>
<a href="#l5.977"></a><span id="l5.977">                    .createInstance(Ci.nsIWebBrowserPersist);</span>
<a href="#l5.978"></a><span id="l5.978">     downloader.persistFlags = Ci.nsIWebBrowserPersist.PERSIST_FLAGS_BYPASS_CACHE</span>
<a href="#l5.979"></a><span id="l5.979">                             | Ci.nsIWebBrowserPersist.PERSIST_FLAGS_REPLACE_EXISTING_FILES</span>
<a href="#l5.980"></a><span id="l5.980">                             | Ci.nsIWebBrowserPersist.PERSIST_FLAGS_CLEANUP_ON_FAILURE;</span>
<a href="#l5.981"></a><span id="l5.981">     downloader.progressListener = {</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineminus">-      onStateChange: function(aWebProgress, aRequest, aFlag, aStatus) {</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineplus">+      onStateChange(aWebProgress, aRequest, aFlag, aStatus) {</span>
<a href="#l5.984"></a><span id="l5.984">         if ((aFlag &amp; Ci.nsIWebProgressListener.STATE_STOP) &amp;&amp;</span>
<a href="#l5.985"></a><span id="l5.985">             !(aFlag &amp; Ci.nsIWebProgressListener.STATE_IS_REQUEST)) {</span>
<a href="#l5.986"></a><span id="l5.986">           if (callbackSuccess) {</span>
<a href="#l5.987"></a><span id="l5.987">             callbackSuccess(file.leafName);</span>
<a href="#l5.988"></a><span id="l5.988">           }</span>
<a href="#l5.989"></a><span id="l5.989">         }</span>
<a href="#l5.990"></a><span id="l5.990">       }</span>
<a href="#l5.991"></a><span id="l5.991">     };</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineat">@@ -1210,26 +1168,26 @@ var gImageDownloader = (function() {</span>
<a href="#l5.993"></a><span id="l5.993">     // we are downloading comes from. If, and only if, the URL is not</span>
<a href="#l5.994"></a><span id="l5.994">     // related to a window, null should be used instead.</span>
<a href="#l5.995"></a><span id="l5.995">     let privacy = PrivateBrowsingUtils.privacyContextFromWindow(window);</span>
<a href="#l5.996"></a><span id="l5.996">     downloader.saveURI(source, null, null, null, null, null, target, privacy);</span>
<a href="#l5.997"></a><span id="l5.997">   }</span>
<a href="#l5.998"></a><span id="l5.998"> </span>
<a href="#l5.999"></a><span id="l5.999">   // Publicly accessible methods.</span>
<a href="#l5.1000"></a><span id="l5.1000">   return {</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineminus">-    cancelSave: cancelSave,</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineminus">-    savePhoto: savePhoto,</span>
<a href="#l5.1003"></a><span id="l5.1003" class="difflineminus">-    STATE_TRANSFERRING: STATE_TRANSFERRING,</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineminus">-    STATE_RESIZING: STATE_RESIZING,</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineminus">-    STATE_OK: STATE_OK,</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineminus">-    ERROR_UNAVAILABLE: ERROR_UNAVAILABLE,</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineminus">-    ERROR_INVALID_URI: ERROR_INVALID_URI,</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineminus">-    ERROR_INVALID_IMG: ERROR_INVALID_IMG,</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineminus">-    ERROR_SAVE: ERROR_SAVE</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineminus">-  }</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineplus">+    cancelSave,</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineplus">+    savePhoto,</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+    STATE_TRANSFERRING,</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineplus">+    STATE_RESIZING,</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineplus">+    STATE_OK,</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineplus">+    ERROR_UNAVAILABLE,</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineplus">+    ERROR_INVALID_URI,</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineplus">+    ERROR_INVALID_IMG,</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+    ERROR_SAVE</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineplus">+  };</span>
<a href="#l5.1021"></a><span id="l5.1021"> })();</span>
<a href="#l5.1022"></a><span id="l5.1022"> </span>
<a href="#l5.1023"></a><span id="l5.1023"> </span>
<a href="#l5.1024"></a><span id="l5.1024"> /**</span>
<a href="#l5.1025"></a><span id="l5.1025">  * Validates the given year and returns it, if it looks sane.</span>
<a href="#l5.1026"></a><span id="l5.1026">  * Returns kDefaultYear (a leap year), if no valid date is given.</span>
<a href="#l5.1027"></a><span id="l5.1027">  * This ensures that month/day calculations still work.</span>
<a href="#l5.1028"></a><span id="l5.1028">  */</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineat">@@ -1266,18 +1224,17 @@ function nearestLeap(aYear) {</span>
<a href="#l5.1030"></a><span id="l5.1030">  * goSetLabelAccesskeyTooltiptext(&quot;cmd_foo&quot;, &quot;&quot;, &quot;&quot;, &quot;valueFlavorTooltiptext&quot;);</span>
<a href="#l5.1031"></a><span id="l5.1031">  *</span>
<a href="#l5.1032"></a><span id="l5.1032">  * @param aID                    the ID of an XUL element (attribute source and target)</span>
<a href="#l5.1033"></a><span id="l5.1033">  * @param aLabelAttribute        (optional) the name of a custom label attribute of aID, or &quot;&quot;</span>
<a href="#l5.1034"></a><span id="l5.1034">  * @param aAccessKeyAttribute    (optional) the name of a custom accesskey attribute of aID, or &quot;&quot;</span>
<a href="#l5.1035"></a><span id="l5.1035">  * @param aTooltipTextAttribute  (optional) the name of a custom tooltiptext attribute of aID, or &quot;&quot;</span>
<a href="#l5.1036"></a><span id="l5.1036">  */</span>
<a href="#l5.1037"></a><span id="l5.1037"> function goSetLabelAccesskeyTooltiptext(aID, aLabelAttribute, aAccessKeyAttribute,</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineminus">-                                             aTooltipTextAttribute)</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineminus">-{</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+                                             aTooltipTextAttribute) {</span>
<a href="#l5.1041"></a><span id="l5.1041">   let node = top.document.getElementById(aID);</span>
<a href="#l5.1042"></a><span id="l5.1042">   if (!node) {</span>
<a href="#l5.1043"></a><span id="l5.1043">     // tweak for composition's abContactsPanel</span>
<a href="#l5.1044"></a><span id="l5.1044">     node = document.getElementById(aID);</span>
<a href="#l5.1045"></a><span id="l5.1045">   }</span>
<a href="#l5.1046"></a><span id="l5.1046">   if (!node)</span>
<a href="#l5.1047"></a><span id="l5.1047">     return;</span>
<a href="#l5.1048"></a><span id="l5.1048"> </span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineat">@@ -1288,15 +1245,15 @@ function goSetLabelAccesskeyTooltiptext(</span>
<a href="#l5.1050"></a><span id="l5.1050">       // In XUL (DOM Level 3), getAttribute() on non-existing attributes returns</span>
<a href="#l5.1051"></a><span id="l5.1051">       // &quot;&quot; (instead of null), which is indistinguishable from existing valid</span>
<a href="#l5.1052"></a><span id="l5.1052">       // attributes with value=&quot;&quot;, so we have to check using hasAttribute().</span>
<a href="#l5.1053"></a><span id="l5.1053">       if (node.hasAttribute(customAttr)) {</span>
<a href="#l5.1054"></a><span id="l5.1054">         let value = node.getAttribute(customAttr);</span>
<a href="#l5.1055"></a><span id="l5.1055">         node.setAttribute(attr, value);</span>
<a href="#l5.1056"></a><span id="l5.1056">       } else {  // missing custom attribute</span>
<a href="#l5.1057"></a><span id="l5.1057">         dump('Something wrong here: goSetLabelAccesskeyTooltiptext(&quot;' + aID + '&quot;, ...): ' +</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineminus">-             'Missing custom attribute: ' + customAttr + '\n');</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineplus">+             &quot;Missing custom attribute: &quot; + customAttr + &quot;\n&quot;);</span>
<a href="#l5.1060"></a><span id="l5.1060">       }</span>
<a href="#l5.1061"></a><span id="l5.1061">     } else if (customAttr === &quot;&quot;) {</span>
<a href="#l5.1062"></a><span id="l5.1062">       node.removeAttribute(attr);</span>
<a href="#l5.1063"></a><span id="l5.1063">     }</span>
<a href="#l5.1064"></a><span id="l5.1064">   }</span>
<a href="#l5.1065"></a><span id="l5.1065"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,18 +1,28 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: javascript; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 ; js-indent-level: 2 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l6.6"></a><span id="l6.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+// addressbook.js</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+/* globals gQueryURIFormat */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+// mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+/* globals GetNumSelectedCards */</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+// mailnews/base/util/ABQueryUtils.jsm</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+/* globals getModelQuery, getSearchTokens, generateQueryURI */</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+// toolkit/content/globalOverlay.js</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+/* globals goUpdateCommand */</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+</span>
<a href="#l6.21"></a><span id="l6.21"> ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;);</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-function GetAbViewListener()</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-{</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+function GetAbViewListener() {</span>
<a href="#l6.26"></a><span id="l6.26">   // the ab panel doesn't care if the total changes, or if the selection changes</span>
<a href="#l6.27"></a><span id="l6.27">   return null;</span>
<a href="#l6.28"></a><span id="l6.28"> }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> /**</span>
<a href="#l6.31"></a><span id="l6.31">  * Handle the context menu event of results tree (right-click, context menu key</span>
<a href="#l6.32"></a><span id="l6.32">  * press, etc.). Show the respective context menu for selected contact(s) or</span>
<a href="#l6.33"></a><span id="l6.33">  * results tree blank space (work around for XUL tree bug 1331377).</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineat">@@ -46,18 +56,17 @@ function contactsListOnContextMenu(aEven</span>
<a href="#l6.35"></a><span id="l6.35"> }</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37"> /**</span>
<a href="#l6.38"></a><span id="l6.38">  * Handle the click event of the results tree (workaround for XUL tree</span>
<a href="#l6.39"></a><span id="l6.39">  * bug 1331377).</span>
<a href="#l6.40"></a><span id="l6.40">  *</span>
<a href="#l6.41"></a><span id="l6.41">  * @param aEvent  a click event</span>
<a href="#l6.42"></a><span id="l6.42">  */</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-function contactsListOnClick(aEvent)</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-{</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+function contactsListOnClick(aEvent) {</span>
<a href="#l6.46"></a><span id="l6.46">   CommandUpdate_AddressBook();</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   let target = aEvent.originalTarget;</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50">   // Left click on column header: Change sort direction.</span>
<a href="#l6.51"></a><span id="l6.51">   if (target.localName == &quot;treecol&quot; &amp;&amp; aEvent.button == 0) {</span>
<a href="#l6.52"></a><span id="l6.52">     let sortDirection = target.getAttribute(&quot;sortDirection&quot;) == kDefaultDescending ?</span>
<a href="#l6.53"></a><span id="l6.53">                         kDefaultAscending : kDefaultDescending;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineat">@@ -71,50 +80,45 @@ function contactsListOnClick(aEvent)</span>
<a href="#l6.55"></a><span id="l6.55">       // Any click on results tree whitespace.</span>
<a href="#l6.56"></a><span id="l6.56">       if ((aEvent.detail == 1 &amp;&amp; aEvent.button == 0) || aEvent.button == 2) {</span>
<a href="#l6.57"></a><span id="l6.57">         // Single left click or any right click on results tree blank space:</span>
<a href="#l6.58"></a><span id="l6.58">         // Clear selection. This also triggers on the first click of any</span>
<a href="#l6.59"></a><span id="l6.59">         // double-click, but that's ok. MAC OS X doesn't return event.detail==1</span>
<a href="#l6.60"></a><span id="l6.60">         // for single right click, so we also let this trigger for the second</span>
<a href="#l6.61"></a><span id="l6.61">         // click of right double-click.</span>
<a href="#l6.62"></a><span id="l6.62">         gAbView.selection.clearSelection();</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-        return;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+</span>
<a href="#l6.65"></a><span id="l6.65">       }</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    } else {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    } else if (aEvent.button == 0 &amp;&amp; aEvent.detail == 2) {</span>
<a href="#l6.68"></a><span id="l6.68">       // Any click on results tree rows.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-      if (aEvent.button == 0 &amp;&amp; aEvent.detail == 2) {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-        // Double-click on a row: Go ahead and add the entry.</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-        addSelectedAddresses(&quot;addr_to&quot;);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-        return;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-      }</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+      // Double-click on a row: Go ahead and add the entry.</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+      addSelectedAddresses(&quot;addr_to&quot;);</span>
<a href="#l6.76"></a><span id="l6.76">     }</span>
<a href="#l6.77"></a><span id="l6.77">   }</span>
<a href="#l6.78"></a><span id="l6.78"> }</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80"> /**</span>
<a href="#l6.81"></a><span id="l6.81">  * Appends the currently selected cards as new recipients in the composed message.</span>
<a href="#l6.82"></a><span id="l6.82">  *</span>
<a href="#l6.83"></a><span id="l6.83">  * @param aRecipientType  Type of recipient, e.g. &quot;addr_to&quot;.</span>
<a href="#l6.84"></a><span id="l6.84">  */</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-function addSelectedAddresses(aRecipientType)</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-{</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+function addSelectedAddresses(aRecipientType) {</span>
<a href="#l6.88"></a><span id="l6.88">   var cards = GetSelectedAbCards();</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   // Turn each card into a properly formatted address.</span>
<a href="#l6.91"></a><span id="l6.91">   var addressArray = cards.map(GenerateAddressFromCard).filter(addr =&gt; (addr != &quot;&quot;));</span>
<a href="#l6.92"></a><span id="l6.92">   parent.AddRecipientsArray(aRecipientType, addressArray);</span>
<a href="#l6.93"></a><span id="l6.93"> }</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-function AddressBookMenuListChange()</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-{</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+function AddressBookMenuListChange() {</span>
<a href="#l6.98"></a><span id="l6.98">   let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l6.99"></a><span id="l6.99">   if (searchInput.value &amp;&amp; !searchInput.showingSearchCriteria)</span>
<a href="#l6.100"></a><span id="l6.100">     onEnterInSearchBar();</span>
<a href="#l6.101"></a><span id="l6.101">   else</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-    ChangeDirectoryByURI(document.getElementById('addressbookList').value);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+    ChangeDirectoryByURI(document.getElementById(&quot;addressbookList&quot;).value);</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105">   // Hide the addressbook column if the selected addressbook isn't</span>
<a href="#l6.106"></a><span id="l6.106">   // &quot;All address books&quot;. Since the column is redundant in all other cases.</span>
<a href="#l6.107"></a><span id="l6.107">   let addrbookColumn = document.getElementById(&quot;addrbook&quot;);</span>
<a href="#l6.108"></a><span id="l6.108">   if (abList.value.startsWith(kAllDirectoryRoot + &quot;?&quot;)) {</span>
<a href="#l6.109"></a><span id="l6.109">     addrbookColumn.hidden = !gShowAbColumnInComposeSidebar;</span>
<a href="#l6.110"></a><span id="l6.110">     addrbookColumn.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l6.111"></a><span id="l6.111">   } else {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineat">@@ -122,23 +126,22 @@ function AddressBookMenuListChange()</span>
<a href="#l6.113"></a><span id="l6.113">     addrbookColumn.setAttribute(&quot;ignoreincolumnpicker&quot;, &quot;true&quot;);</span>
<a href="#l6.114"></a><span id="l6.114">   }</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">   CommandUpdate_AddressBook();</span>
<a href="#l6.117"></a><span id="l6.117"> }</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119"> var mutationObs = null;</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-function AbPanelLoad()</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-{</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+function AbPanelLoad() {</span>
<a href="#l6.124"></a><span id="l6.124">   InitCommonJS();</span>
<a href="#l6.125"></a><span id="l6.125"> </span>
<a href="#l6.126"></a><span id="l6.126">   document.title = parent.document.getElementById(&quot;sidebar-title&quot;).value;</span>
<a href="#l6.127"></a><span id="l6.127"> </span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-  var abPopup = document.getElementById('addressbookList');</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  var abPopup = document.getElementById(&quot;addressbookList&quot;);</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131">   // Reselect the persisted address book if possible, if not just select the</span>
<a href="#l6.132"></a><span id="l6.132">   // first in the list.</span>
<a href="#l6.133"></a><span id="l6.133">   var temp = abPopup.value;</span>
<a href="#l6.134"></a><span id="l6.134">   abPopup.selectedItem = null;</span>
<a href="#l6.135"></a><span id="l6.135">   abPopup.value = temp;</span>
<a href="#l6.136"></a><span id="l6.136">   if (!abPopup.selectedItem)</span>
<a href="#l6.137"></a><span id="l6.137">     abPopup.selectedIndex = 0;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineat">@@ -157,72 +160,65 @@ function AbPanelLoad()</span>
<a href="#l6.139"></a><span id="l6.139">   });</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141">   document.getElementById(&quot;addrbook&quot;).hidden = !gShowAbColumnInComposeSidebar;</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143">   mutationObs.observe(document.getElementById(&quot;addrbook&quot;),</span>
<a href="#l6.144"></a><span id="l6.144">                       { attributes: true, childList: true });</span>
<a href="#l6.145"></a><span id="l6.145"> }</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-function AbPanelUnload()</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-{</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+function AbPanelUnload() {</span>
<a href="#l6.150"></a><span id="l6.150">   mutationObs.disconnect();</span>
<a href="#l6.151"></a><span id="l6.151"> </span>
<a href="#l6.152"></a><span id="l6.152">   CloseAbView();</span>
<a href="#l6.153"></a><span id="l6.153"> }</span>
<a href="#l6.154"></a><span id="l6.154"> </span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-function AbPanelNewCard()</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-{</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+function AbPanelNewCard() {</span>
<a href="#l6.158"></a><span id="l6.158">   goNewCardDialog(abList.value);</span>
<a href="#l6.159"></a><span id="l6.159"> }</span>
<a href="#l6.160"></a><span id="l6.160"> </span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-function AbPanelNewList()</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-{</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+function AbPanelNewList() {</span>
<a href="#l6.164"></a><span id="l6.164">   goNewListDialog(abList.value);</span>
<a href="#l6.165"></a><span id="l6.165"> }</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-function ResultsPaneSelectionChanged()</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-{</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+function ResultsPaneSelectionChanged() {</span>
<a href="#l6.170"></a><span id="l6.170">   // do nothing for ab panel</span>
<a href="#l6.171"></a><span id="l6.171"> }</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-function OnClickedCard()</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-{</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+function OnClickedCard() {</span>
<a href="#l6.176"></a><span id="l6.176">   // do nothing for ab panel</span>
<a href="#l6.177"></a><span id="l6.177"> }</span>
<a href="#l6.178"></a><span id="l6.178"> </span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-function AbResultsPaneDoubleClick(card)</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-{</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+function AbResultsPaneDoubleClick(card) {</span>
<a href="#l6.182"></a><span id="l6.182">   // double click for ab panel means &quot;send mail to this person / list&quot;</span>
<a href="#l6.183"></a><span id="l6.183">   AbNewMessage();</span>
<a href="#l6.184"></a><span id="l6.184"> }</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-function UpdateCardView()</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-{</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+function UpdateCardView() {</span>
<a href="#l6.189"></a><span id="l6.189">   // do nothing for ab panel</span>
<a href="#l6.190"></a><span id="l6.190"> }</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-function CommandUpdate_AddressBook()</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-{</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+function CommandUpdate_AddressBook() {</span>
<a href="#l6.195"></a><span id="l6.195">   // Toggle disable state of to,cc,bcc buttons.</span>
<a href="#l6.196"></a><span id="l6.196">   let disabled = (GetNumSelectedCards() == 0) ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l6.197"></a><span id="l6.197">   document.getElementById(&quot;cmd_addrTo&quot;).setAttribute(&quot;disabled&quot;, disabled);</span>
<a href="#l6.198"></a><span id="l6.198">   document.getElementById(&quot;cmd_addrCc&quot;).setAttribute(&quot;disabled&quot;, disabled);</span>
<a href="#l6.199"></a><span id="l6.199">   document.getElementById(&quot;cmd_addrBcc&quot;).setAttribute(&quot;disabled&quot;, disabled);</span>
<a href="#l6.200"></a><span id="l6.200"> </span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  goUpdateCommand('cmd_delete');</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-  goUpdateCommand('cmd_properties');</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+  goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  goUpdateCommand(&quot;cmd_properties&quot;);</span>
<a href="#l6.205"></a><span id="l6.205"> }</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-function onEnterInSearchBar()</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-{</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+function onEnterInSearchBar() {</span>
<a href="#l6.210"></a><span id="l6.210">   if (!gQueryURIFormat) {</span>
<a href="#l6.211"></a><span id="l6.211">     // Get model query from pref. We don't want the query starting with &quot;?&quot;</span>
<a href="#l6.212"></a><span id="l6.212">     // as we have to prefix &quot;?and&quot; to this format.</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    /* eslint-disable no-native-reassign */</span>
<a href="#l6.214"></a><span id="l6.214">     gQueryURIFormat = getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+    /* eslint-enable no-native-reassign */</span>
<a href="#l6.216"></a><span id="l6.216">   }</span>
<a href="#l6.217"></a><span id="l6.217"> </span>
<a href="#l6.218"></a><span id="l6.218">   let searchURI = getSelectedDirectoryURI();</span>
<a href="#l6.219"></a><span id="l6.219">   let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l6.220"></a><span id="l6.220"> </span>
<a href="#l6.221"></a><span id="l6.221">   // Use helper method to split up search query to multi-word search</span>
<a href="#l6.222"></a><span id="l6.222">   // query against multiple fields.</span>
<a href="#l6.223"></a><span id="l6.223">   if (searchInput) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/addrbook/content/abTrees.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/addrbook/content/abTrees.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,19 +1,24 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+// mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+/* globals abDirTreeObserver */</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+// mailnews/base/content/jsTreeView.js</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+/* globals PROTO_TREE_VIEW */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13"> /**</span>
<a href="#l7.14"></a><span id="l7.14">  * This file contains our implementation for various addressbook trees.  It</span>
<a href="#l7.15"></a><span id="l7.15">  * depends on jsTreeView.js being loaded before this script is loaded.</span>
<a href="#l7.16"></a><span id="l7.16">  */</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+var { MailServices } = ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;, null);</span>
<a href="#l7.21"></a><span id="l7.21"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> // Tree Sort helper methods.</span>
<a href="#l7.24"></a><span id="l7.24"> var AB_ORDER = [&quot;aab&quot;, &quot;pab&quot;, &quot;mork&quot;, &quot;ldap&quot;, &quot;mapi+other&quot;, &quot;anyab&quot;, &quot;cab&quot;];</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26"> function getDirectoryValue(aDir, aKey) {</span>
<a href="#l7.27"></a><span id="l7.27">   if (aKey == &quot;ab_type&quot;) {</span>
<a href="#l7.28"></a><span id="l7.28">     if (aDir._directory.URI == kAllDirectoryRoot + &quot;?&quot;)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineat">@@ -104,17 +109,17 @@ abDirTreeItem.prototype = {</span>
<a href="#l7.30"></a><span id="l7.30">       if (this._directory.URI == (kAllDirectoryRoot + &quot;?&quot;))</span>
<a href="#l7.31"></a><span id="l7.31">         myEnum = MailServices.ab.directories;</span>
<a href="#l7.32"></a><span id="l7.32">       else</span>
<a href="#l7.33"></a><span id="l7.33">         myEnum = this._directory.childNodes;</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">       while (myEnum.hasMoreElements()) {</span>
<a href="#l7.36"></a><span id="l7.36">         var abItem = new abDirTreeItem(myEnum.getNext()</span>
<a href="#l7.37"></a><span id="l7.37">                                        .QueryInterface(Ci.nsIAbDirectory));</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-        if (gDirectoryTreeView&amp;&amp;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+        if (gDirectoryTreeView &amp;&amp;</span>
<a href="#l7.40"></a><span id="l7.40">             this.id == kAllDirectoryRoot + &quot;?&quot; &amp;&amp;</span>
<a href="#l7.41"></a><span id="l7.41">             getDirectoryValue(abItem, &quot;ab_type&quot;) == &quot;ldap&quot;)</span>
<a href="#l7.42"></a><span id="l7.42">           gDirectoryTreeView.hasRemoteAB = true;</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">         this._children.push(abItem);</span>
<a href="#l7.45"></a><span id="l7.45">         this._children[this._children.length - 1]._level = this._level + 1;</span>
<a href="#l7.46"></a><span id="l7.46">         this._children[this._children.length - 1]._parent = this;</span>
<a href="#l7.47"></a><span id="l7.47">       }</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineat">@@ -190,46 +195,44 @@ directoryTreeView.prototype = {</span>
<a href="#l7.49"></a><span id="l7.49">    * NOTE: This function will result in indeterminate rows being selected.</span>
<a href="#l7.50"></a><span id="l7.50">    *       Callers should take care to re-select a desired row after calling</span>
<a href="#l7.51"></a><span id="l7.51">    *       this function.</span>
<a href="#l7.52"></a><span id="l7.52">    */</span>
<a href="#l7.53"></a><span id="l7.53">   _rebuild: function dtv__rebuild() {</span>
<a href="#l7.54"></a><span id="l7.54">     var oldCount = this._rowMap.length;</span>
<a href="#l7.55"></a><span id="l7.55">     this._rowMap = [];</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    var dirEnum = MailServices.ab.directories;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-</span>
<a href="#l7.59"></a><span id="l7.59">     // Make an entry for All Address Books.</span>
<a href="#l7.60"></a><span id="l7.60">     let rootAB = MailServices.ab.getDirectory(kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l7.61"></a><span id="l7.61">     rootAB.dirName = gAddressBookBundle.getString(&quot;allAddressBooks&quot;);</span>
<a href="#l7.62"></a><span id="l7.62">     this._rowMap.push(new abDirTreeItem(rootAB));</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64">     // Sort our addressbooks now</span>
<a href="#l7.65"></a><span id="l7.65">     this._rowMap.sort(abSort);</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">     if (this._tree)</span>
<a href="#l7.68"></a><span id="l7.68">       this._tree.rowCountChanged(0, this._rowMap.length - oldCount);</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">     this._restoreOpenStates();</span>
<a href="#l7.71"></a><span id="l7.71">   },</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  getIndexForId: function(aId) {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  getIndexForId(aId) {</span>
<a href="#l7.75"></a><span id="l7.75">     for (let i = 0; i &lt; this._rowMap.length; i++) {</span>
<a href="#l7.76"></a><span id="l7.76">       if (this._rowMap[i].id == aId)</span>
<a href="#l7.77"></a><span id="l7.77">         return i;</span>
<a href="#l7.78"></a><span id="l7.78">     }</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     return -1;</span>
<a href="#l7.81"></a><span id="l7.81">   },</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">   // nsIAbListener interfaces</span>
<a href="#l7.84"></a><span id="l7.84">   onItemAdded: function dtv_onItemAdded(aParent, aItem) {</span>
<a href="#l7.85"></a><span id="l7.85">     if (!(aItem instanceof Ci.nsIAbDirectory))</span>
<a href="#l7.86"></a><span id="l7.86">       return;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    //xxx we can optimize this later</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    // XXX we can optimize this later</span>
<a href="#l7.89"></a><span id="l7.89">     this._rebuild();</span>
<a href="#l7.90"></a><span id="l7.90"> </span>
<a href="#l7.91"></a><span id="l7.91">     if (!this._tree)</span>
<a href="#l7.92"></a><span id="l7.92">       return;</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">     // Now select this new item</span>
<a href="#l7.95"></a><span id="l7.95">     for (var [i, row] of this._rowMap.entries()) {</span>
<a href="#l7.96"></a><span id="l7.96">       if (row.id == aItem.URI) {</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineat">@@ -237,17 +240,17 @@ directoryTreeView.prototype = {</span>
<a href="#l7.98"></a><span id="l7.98">         break;</span>
<a href="#l7.99"></a><span id="l7.99">       }</span>
<a href="#l7.100"></a><span id="l7.100">     }</span>
<a href="#l7.101"></a><span id="l7.101">   },</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">   onItemRemoved: function dtv_onItemRemoved(aParent, aItem) {</span>
<a href="#l7.104"></a><span id="l7.104">     if (!(aItem instanceof Ci.nsIAbDirectory))</span>
<a href="#l7.105"></a><span id="l7.105">       return;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    //xxx we can optimize this later</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+    // XXX we can optimize this later</span>
<a href="#l7.108"></a><span id="l7.108">     this._rebuild();</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110">     if (!this._tree)</span>
<a href="#l7.111"></a><span id="l7.111">       return;</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">     // If we're deleting a top-level address-book, just select the first book</span>
<a href="#l7.114"></a><span id="l7.114">     if (aParent.URI == kAllDirectoryRoot ||</span>
<a href="#l7.115"></a><span id="l7.115">         aParent.URI == kAllDirectoryRoot + &quot;?&quot;) {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineat">@@ -263,17 +266,17 @@ directoryTreeView.prototype = {</span>
<a href="#l7.117"></a><span id="l7.117">       }</span>
<a href="#l7.118"></a><span id="l7.118">     }</span>
<a href="#l7.119"></a><span id="l7.119">   },</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121">   onItemPropertyChanged: function dtv_onItemProp(aItem, aProp, aOld, aNew) {</span>
<a href="#l7.122"></a><span id="l7.122">     if (!(aItem instanceof Ci.nsIAbDirectory))</span>
<a href="#l7.123"></a><span id="l7.123">       return;</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-    for (var i in this._rowMap)  {</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    for (let i in this._rowMap) {</span>
<a href="#l7.127"></a><span id="l7.127">       if (this._rowMap[i]._directory == aItem) {</span>
<a href="#l7.128"></a><span id="l7.128">         this._tree.invalidateRow(i);</span>
<a href="#l7.129"></a><span id="l7.129">         break;</span>
<a href="#l7.130"></a><span id="l7.130">       }</span>
<a href="#l7.131"></a><span id="l7.131">     }</span>
<a href="#l7.132"></a><span id="l7.132">   }</span>
<a href="#l7.133"></a><span id="l7.133"> };</span>
<a href="#l7.134"></a><span id="l7.134"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,20 +1,40 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: javascript; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 ; js-indent-level: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l8.6"></a><span id="l8.6"> /*</span>
<a href="#l8.7"></a><span id="l8.7">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.8"></a><span id="l8.8">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.9"></a><span id="l8.9">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+// abCardView.js</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/* globals ClearCardViewPane, DisplayCardViewPane, OnLoadCardView */</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+// abTrees.js</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+/* globals gDirectoryTreeView */</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+// mail/base/content/mail-compacttheme.js</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+/* globals CompactTheme */</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+// mail/base/content/mailCore.js</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+/* globals MailToolboxCustomizeDone */</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+// mail/base/content/toolbarIconColor.js</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+/* globals ToolbarIconColor */</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+// mailnews/base/content/msgPrintEngine.js</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+/* globals printEngineWindow */</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+// mailnews/base/util/ABQueryUtils.jsm</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+/* globals getModelQuery, getSearchTokens, generateQueryURI */</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+// toolkit/content/globalOverlay.js</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+/* globals goUpdateCommand */</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+</span>
<a href="#l8.30"></a><span id="l8.30"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l8.31"></a><span id="l8.31"> ChromeUtils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l8.32"></a><span id="l8.32"> ChromeUtils.import(&quot;resource:///modules/ABQueryUtils.jsm&quot;);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+var { MailServices } = ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;, null);</span>
<a href="#l8.35"></a><span id="l8.35"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l8.37"></a><span id="l8.37"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.38"></a><span id="l8.38"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40"> XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l8.41"></a><span id="l8.41">   LightweightThemeManager: &quot;resource://gre/modules/LightweightThemeManager.jsm&quot;,</span>
<a href="#l8.42"></a><span id="l8.42"> });</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44"> var nsIAbListener = Ci.nsIAbListener;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineat">@@ -47,70 +67,65 @@ var kPABDirectory  = 2; // defined in ns</span>
<a href="#l8.46"></a><span id="l8.46"> // that contact (assuming that the user has added that value to their list</span>
<a href="#l8.47"></a><span id="l8.47"> // of IM contacts).</span>
<a href="#l8.48"></a><span id="l8.48"> var kChatProperties = [&quot;_GoogleTalk&quot;, &quot;_JabberId&quot;];</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50"> // Note: We need to keep this listener as it does not just handle dir</span>
<a href="#l8.51"></a><span id="l8.51"> // pane deletes but also deletes of address books and lists from places like</span>
<a href="#l8.52"></a><span id="l8.52"> // the sidebar and LDAP preference pane.</span>
<a href="#l8.53"></a><span id="l8.53"> var gAddressBookAbListener = {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  onItemAdded: function(parentDir, item) {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  onItemAdded(parentDir, item) {</span>
<a href="#l8.56"></a><span id="l8.56">     // will not be called</span>
<a href="#l8.57"></a><span id="l8.57">   },</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-  onItemRemoved: function(parentDir, item) {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  onItemRemoved(parentDir, item) {</span>
<a href="#l8.60"></a><span id="l8.60">     // will only be called when an addressbook is deleted</span>
<a href="#l8.61"></a><span id="l8.61">     try {</span>
<a href="#l8.62"></a><span id="l8.62">       // If we don't have a record of the previous selection, the only</span>
<a href="#l8.63"></a><span id="l8.63">       // option is to select the first.</span>
<a href="#l8.64"></a><span id="l8.64">       if (gPreviousDirTreeIndex == -1) {</span>
<a href="#l8.65"></a><span id="l8.65">         SelectFirstAddressBook();</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-      }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-      else {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+      } else if (gDirTree.currentIndex == -1) {</span>
<a href="#l8.69"></a><span id="l8.69">         // Don't reselect if we already have a valid selection, this may be</span>
<a href="#l8.70"></a><span id="l8.70">         // the case if items are being removed via other methods, e.g. sidebar,</span>
<a href="#l8.71"></a><span id="l8.71">         // LDAP preference pane etc.</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-        if (gDirTree.currentIndex == -1) {</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-          var directory = item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+        var directory = item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-          // If we are a mail list, move the selection up the list before</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-          // trying to find the parent. This way we'll end up selecting the</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-          // parent address book when we remove a mailing list.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-          //</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-          // For simple address books we don't need to move up the list, as</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-          // we want to select the next one upon removal.</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-          if (directory.isMailList &amp;&amp; gPreviousDirTreeIndex &gt; 0)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-            --gPreviousDirTreeIndex;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+        // If we are a mail list, move the selection up the list before</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+        // trying to find the parent. This way we'll end up selecting the</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+        // parent address book when we remove a mailing list.</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        //</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+        // For simple address books we don't need to move up the list, as</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+        // we want to select the next one upon removal.</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+        if (directory.isMailList &amp;&amp; gPreviousDirTreeIndex &gt; 0)</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+          --gPreviousDirTreeIndex;</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-          // Now get the parent of the row.</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-          var newRow = gDirTree.view.getParentIndex(gPreviousDirTreeIndex);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+        // Now get the parent of the row.</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+        var newRow = gDirTree.view.getParentIndex(gPreviousDirTreeIndex);</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-          // if we have no parent (i.e. we are an address book), use the</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-          // previous index.</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-          if (newRow == -1)</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-            newRow = gPreviousDirTreeIndex;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+        // if we have no parent (i.e. we are an address book), use the</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+        // previous index.</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+        if (newRow == -1)</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+          newRow = gPreviousDirTreeIndex;</span>
<a href="#l8.106"></a><span id="l8.106"> </span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-          // Fall back to the first address book if we're not in a valid range</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-          if (newRow &gt;= gDirTree.view.rowCount)</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-            newRow = 0;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+        // Fall back to the first address book if we're not in a valid range</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+        if (newRow &gt;= gDirTree.view.rowCount)</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+          newRow = 0;</span>
<a href="#l8.113"></a><span id="l8.113"> </span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-          // Now select the new item.</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-          gDirTree.view.selection.select(newRow);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-        }</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+        // Now select the new item.</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+        gDirTree.view.selection.select(newRow);</span>
<a href="#l8.119"></a><span id="l8.119">       }</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-    }</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-    catch (ex) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    } catch (ex) {</span>
<a href="#l8.123"></a><span id="l8.123">     }</span>
<a href="#l8.124"></a><span id="l8.124">   },</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-  onItemPropertyChanged: function(item, property, oldValue, newValue) {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l8.127"></a><span id="l8.127">     // will not be called</span>
<a href="#l8.128"></a><span id="l8.128">   }</span>
<a href="#l8.129"></a><span id="l8.129"> };</span>
<a href="#l8.130"></a><span id="l8.130"> </span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-function OnUnloadAddressBook()</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-{</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+function OnUnloadAddressBook() {</span>
<a href="#l8.134"></a><span id="l8.134">   // If there's no default startupURI, save the last used URI as new startupURI.</span>
<a href="#l8.135"></a><span id="l8.135">   let saveLastURIasStartupURI = !Services.prefs.getBoolPref(&quot;mail.addr_book.view.startupURIisDefault&quot;);</span>
<a href="#l8.136"></a><span id="l8.136">   if (saveLastURIasStartupURI) {</span>
<a href="#l8.137"></a><span id="l8.137">     let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l8.138"></a><span id="l8.138">     Services.prefs.setCharPref(&quot;mail.addr_book.view.startupURI&quot;, selectedDirURI);</span>
<a href="#l8.139"></a><span id="l8.139">   }</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141">   MailServices.ab.removeAddressBookListener(gAddressBookAbListener);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineat">@@ -124,37 +139,34 @@ function OnUnloadAddressBook()</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144">   ToolbarIconColor.uninit();</span>
<a href="#l8.145"></a><span id="l8.145">   CompactTheme.uninit();</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147">   CloseAbView();</span>
<a href="#l8.148"></a><span id="l8.148"> }</span>
<a href="#l8.149"></a><span id="l8.149"> </span>
<a href="#l8.150"></a><span id="l8.150"> var gAddressBookAbViewListener = {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-  onSelectionChanged: function() {</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+  onSelectionChanged() {</span>
<a href="#l8.153"></a><span id="l8.153">     ResultsPaneSelectionChanged();</span>
<a href="#l8.154"></a><span id="l8.154">   },</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-  onCountChanged: function(total) {</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+  onCountChanged(total) {</span>
<a href="#l8.157"></a><span id="l8.157">     SetStatusText(total);</span>
<a href="#l8.158"></a><span id="l8.158">   }</span>
<a href="#l8.159"></a><span id="l8.159"> };</span>
<a href="#l8.160"></a><span id="l8.160"> </span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-function GetAbViewListener()</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-{</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+function GetAbViewListener() {</span>
<a href="#l8.164"></a><span id="l8.164">   return gAddressBookAbViewListener;</span>
<a href="#l8.165"></a><span id="l8.165"> }</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167"> // we won't show the window until the onload() handler is finished</span>
<a href="#l8.168"></a><span id="l8.168"> // so we do this trick (suggested by hyatt / blaker)</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-function OnLoadAddressBook()</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-{</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+function OnLoadAddressBook() {</span>
<a href="#l8.172"></a><span id="l8.172">   // Set a sane starting width/height for all resolutions on new profiles.</span>
<a href="#l8.173"></a><span id="l8.173">   // Do this before the window loads.</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-  if (!document.documentElement.hasAttribute(&quot;width&quot;))</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-  {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  if (!document.documentElement.hasAttribute(&quot;width&quot;)) {</span>
<a href="#l8.177"></a><span id="l8.177">     // Prefer 860xfull height.</span>
<a href="#l8.178"></a><span id="l8.178">     let defaultHeight = screen.availHeight;</span>
<a href="#l8.179"></a><span id="l8.179">     let defaultWidth = (screen.availWidth &gt;= 860) ? 860 : screen.availWidth;</span>
<a href="#l8.180"></a><span id="l8.180"> </span>
<a href="#l8.181"></a><span id="l8.181">     // On small screens, default to maximized state.</span>
<a href="#l8.182"></a><span id="l8.182">     if (defaultHeight &lt;= 600)</span>
<a href="#l8.183"></a><span id="l8.183">       document.documentElement.setAttribute(&quot;sizemode&quot;, &quot;maximized&quot;);</span>
<a href="#l8.184"></a><span id="l8.184"> </span>
<a href="#l8.185"></a><span id="l8.185" class="difflineat">@@ -169,18 +181,17 @@ function OnLoadAddressBook()</span>
<a href="#l8.186"></a><span id="l8.186">   ToolbarIconColor.init();</span>
<a href="#l8.187"></a><span id="l8.187"> </span>
<a href="#l8.188"></a><span id="l8.188">   if (!chatHandler.ChatCore.initialized)</span>
<a href="#l8.189"></a><span id="l8.189">     chatHandler.ChatCore.init();</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191">   setTimeout(delayedOnLoadAddressBook, 0); // when debugging, set this to 5000, so you can see what happens after the window comes up.</span>
<a href="#l8.192"></a><span id="l8.192"> }</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-function delayedOnLoadAddressBook()</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-{</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+function delayedOnLoadAddressBook() {</span>
<a href="#l8.197"></a><span id="l8.197">   InitCommonJS();</span>
<a href="#l8.198"></a><span id="l8.198"> </span>
<a href="#l8.199"></a><span id="l8.199">   GetCurrentPrefs();</span>
<a href="#l8.200"></a><span id="l8.200"> </span>
<a href="#l8.201"></a><span id="l8.201">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l8.202"></a><span id="l8.202">   OnLoadCardView();</span>
<a href="#l8.203"></a><span id="l8.203"> </span>
<a href="#l8.204"></a><span id="l8.204">   // Initialize the Address Book tree view</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineat">@@ -213,142 +224,131 @@ function delayedOnLoadAddressBook()</span>
<a href="#l8.206"></a><span id="l8.206">   // Force command update for the benefit of DirPaneController and</span>
<a href="#l8.207"></a><span id="l8.207">   // abResultsController</span>
<a href="#l8.208"></a><span id="l8.208">   CommandUpdate_AddressBook();</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l8.211"></a><span id="l8.211">   var toolbox = document.getElementById(&quot;ab-toolbox&quot;);</span>
<a href="#l8.212"></a><span id="l8.212">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeABToolbar&quot;); };</span>
<a href="#l8.213"></a><span id="l8.213"> </span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-  var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  var toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l8.216"></a><span id="l8.216">   toolbox.toolbarset = toolbarset;</span>
<a href="#l8.217"></a><span id="l8.217"> </span>
<a href="#l8.218"></a><span id="l8.218">   // Ensure we don't load xul error pages into the main window</span>
<a href="#l8.219"></a><span id="l8.219">   window.docShell.useErrorPages = false;</span>
<a href="#l8.220"></a><span id="l8.220"> </span>
<a href="#l8.221"></a><span id="l8.221">   MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l8.222"></a><span id="l8.222"> </span>
<a href="#l8.223"></a><span id="l8.223">   // Focus the searchbox as we think the user will want to do that</span>
<a href="#l8.224"></a><span id="l8.224">   // with the highest probability.</span>
<a href="#l8.225"></a><span id="l8.225">   // Bug 1143812: This is disabled for now to keep the New Contact command enabled.</span>
<a href="#l8.226"></a><span id="l8.226">   // QuickSearchFocus();</span>
<a href="#l8.227"></a><span id="l8.227"> }</span>
<a href="#l8.228"></a><span id="l8.228"> </span>
<a href="#l8.229"></a><span id="l8.229"> </span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-function GetCurrentPrefs()</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-{</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+function GetCurrentPrefs() {</span>
<a href="#l8.233"></a><span id="l8.233">   // check &quot;Show Name As&quot; menu item based on pref</span>
<a href="#l8.234"></a><span id="l8.234">   var menuitemID;</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-  switch (Services.prefs.getIntPref(kPrefMailAddrBookLastNameFirst))</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-  {</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+  switch (Services.prefs.getIntPref(kPrefMailAddrBookLastNameFirst)) {</span>
<a href="#l8.238"></a><span id="l8.238">     case kFirstNameFirst:</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-      menuitemID = 'firstLastCmd';</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+      menuitemID = &quot;firstLastCmd&quot;;</span>
<a href="#l8.241"></a><span id="l8.241">       break;</span>
<a href="#l8.242"></a><span id="l8.242">     case kLastNameFirst:</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-      menuitemID = 'lastFirstCmd';</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+      menuitemID = &quot;lastFirstCmd&quot;;</span>
<a href="#l8.245"></a><span id="l8.245">       break;</span>
<a href="#l8.246"></a><span id="l8.246">     case kDisplayName:</span>
<a href="#l8.247"></a><span id="l8.247">     default:</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-      menuitemID = 'displayNameCmd';</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      menuitemID = &quot;displayNameCmd&quot;;</span>
<a href="#l8.250"></a><span id="l8.250">       break;</span>
<a href="#l8.251"></a><span id="l8.251">   }</span>
<a href="#l8.252"></a><span id="l8.252"> </span>
<a href="#l8.253"></a><span id="l8.253">   var menuitem = top.document.getElementById(menuitemID);</span>
<a href="#l8.254"></a><span id="l8.254">   if (menuitem)</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-    menuitem.setAttribute('checked', 'true');</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+    menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l8.257"></a><span id="l8.257"> </span>
<a href="#l8.258"></a><span id="l8.258">   // initialize phonetic</span>
<a href="#l8.259"></a><span id="l8.259">   var showPhoneticFields =</span>
<a href="#l8.260"></a><span id="l8.260">     Services.prefs.getComplexValue(&quot;mail.addr_book.show_phonetic_fields&quot;,</span>
<a href="#l8.261"></a><span id="l8.261">       Ci.nsIPrefLocalizedString).data;</span>
<a href="#l8.262"></a><span id="l8.262">   // show phonetic fields if indicated by the pref</span>
<a href="#l8.263"></a><span id="l8.263">   if (showPhoneticFields == &quot;true&quot;)</span>
<a href="#l8.264"></a><span id="l8.264">     document.getElementById(&quot;cmd_SortBy_PhoneticName&quot;)</span>
<a href="#l8.265"></a><span id="l8.265">             .setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l8.266"></a><span id="l8.266"> </span>
<a href="#l8.267"></a><span id="l8.267"> }</span>
<a href="#l8.268"></a><span id="l8.268"> </span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-function SetNameColumn(cmd)</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-{</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+function SetNameColumn(cmd) {</span>
<a href="#l8.272"></a><span id="l8.272">   var prefValue;</span>
<a href="#l8.273"></a><span id="l8.273"> </span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-  switch ( cmd )</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-  {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-    case 'firstLastCmd':</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+  switch (cmd) {</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+    case &quot;firstLastCmd&quot;:</span>
<a href="#l8.279"></a><span id="l8.279">       prefValue = kFirstNameFirst;</span>
<a href="#l8.280"></a><span id="l8.280">       break;</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-    case 'lastFirstCmd':</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+    case &quot;lastFirstCmd&quot;:</span>
<a href="#l8.283"></a><span id="l8.283">       prefValue = kLastNameFirst;</span>
<a href="#l8.284"></a><span id="l8.284">       break;</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-    case 'displayNameCmd':</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+    case &quot;displayNameCmd&quot;:</span>
<a href="#l8.287"></a><span id="l8.287">       prefValue = kDisplayName;</span>
<a href="#l8.288"></a><span id="l8.288">       break;</span>
<a href="#l8.289"></a><span id="l8.289">   }</span>
<a href="#l8.290"></a><span id="l8.290"> </span>
<a href="#l8.291"></a><span id="l8.291">   Services.prefs.setIntPref(kPrefMailAddrBookLastNameFirst, prefValue);</span>
<a href="#l8.292"></a><span id="l8.292"> }</span>
<a href="#l8.293"></a><span id="l8.293"> </span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-function onOSXFileMenuInit()</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-{</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-  document.getElementById('menu_osxAddressBook')</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+function onOSXFileMenuInit() {</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+  document.getElementById(&quot;menu_osxAddressBook&quot;)</span>
<a href="#l8.299"></a><span id="l8.299">           .setAttribute(&quot;checked&quot;, AbOSXAddressBookExists());</span>
<a href="#l8.300"></a><span id="l8.300"> }</span>
<a href="#l8.301"></a><span id="l8.301"> </span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-function CommandUpdate_AddressBook()</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-{</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-  goUpdateCommand('cmd_delete');</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-  goUpdateCommand('button_delete');</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-  goUpdateCommand('cmd_printcardpreview');</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-  goUpdateCommand('cmd_printcard');</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-  goUpdateCommand('cmd_properties');</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+function CommandUpdate_AddressBook() {</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+  goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  goUpdateCommand(&quot;button_delete&quot;);</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+  goUpdateCommand(&quot;cmd_printcardpreview&quot;);</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+  goUpdateCommand(&quot;cmd_printcard&quot;);</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+  goUpdateCommand(&quot;cmd_properties&quot;);</span>
<a href="#l8.315"></a><span id="l8.315">   goUpdateCommand(&quot;cmd_abToggleStartupDir&quot;);</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-  goUpdateCommand('cmd_newlist');</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-  goUpdateCommand('cmd_newCard');</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-  goUpdateCommand('cmd_chatWithCard');</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+  goUpdateCommand(&quot;cmd_newlist&quot;);</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+  goUpdateCommand(&quot;cmd_newCard&quot;);</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+  goUpdateCommand(&quot;cmd_chatWithCard&quot;);</span>
<a href="#l8.322"></a><span id="l8.322"> }</span>
<a href="#l8.323"></a><span id="l8.323"> </span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-function ResultsPaneSelectionChanged()</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-{</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+function ResultsPaneSelectionChanged() {</span>
<a href="#l8.327"></a><span id="l8.327">   UpdateCardView();</span>
<a href="#l8.328"></a><span id="l8.328"> }</span>
<a href="#l8.329"></a><span id="l8.329"> </span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-function UpdateCardView()</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-{</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+function UpdateCardView() {</span>
<a href="#l8.333"></a><span id="l8.333">   var cards = GetSelectedAbCards();</span>
<a href="#l8.334"></a><span id="l8.334"> </span>
<a href="#l8.335"></a><span id="l8.335">   if (!cards) {</span>
<a href="#l8.336"></a><span id="l8.336">     ClearCardViewPane();</span>
<a href="#l8.337"></a><span id="l8.337">     return;</span>
<a href="#l8.338"></a><span id="l8.338">   }</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340">   // display the selected card, if exactly one card is selected.</span>
<a href="#l8.341"></a><span id="l8.341">   // either no cards, or more than one card is selected, clear the pane.</span>
<a href="#l8.342"></a><span id="l8.342">   // We do not need to check cards[0] any more since GetSelectedAbCards() only</span>
<a href="#l8.343"></a><span id="l8.343">   // push non-null entity to the list.</span>
<a href="#l8.344"></a><span id="l8.344">   if (cards.length == 1)</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-    OnClickedCard(cards[0])</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+    OnClickedCard(cards[0]);</span>
<a href="#l8.347"></a><span id="l8.347">   else</span>
<a href="#l8.348"></a><span id="l8.348">     ClearCardViewPane();</span>
<a href="#l8.349"></a><span id="l8.349"> }</span>
<a href="#l8.350"></a><span id="l8.350"> </span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-function OnClickedCard(card)</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-{</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+function OnClickedCard(card) {</span>
<a href="#l8.354"></a><span id="l8.354">   if (card)</span>
<a href="#l8.355"></a><span id="l8.355">     DisplayCardViewPane(card);</span>
<a href="#l8.356"></a><span id="l8.356">   else</span>
<a href="#l8.357"></a><span id="l8.357">     ClearCardViewPane();</span>
<a href="#l8.358"></a><span id="l8.358"> }</span>
<a href="#l8.359"></a><span id="l8.359"> </span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-function AbClose()</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-{</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+function AbClose() {</span>
<a href="#l8.363"></a><span id="l8.363">   top.close();</span>
<a href="#l8.364"></a><span id="l8.364"> }</span>
<a href="#l8.365"></a><span id="l8.365"> </span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-function AbPrintCardInternal(doPrintPreview, msgType)</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-{</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+function AbPrintCardInternal(doPrintPreview, msgType) {</span>
<a href="#l8.369"></a><span id="l8.369">   var selectedItems = GetSelectedAbCards();</span>
<a href="#l8.370"></a><span id="l8.370">   var numSelected = selectedItems.length;</span>
<a href="#l8.371"></a><span id="l8.371"> </span>
<a href="#l8.372"></a><span id="l8.372">   if (!numSelected)</span>
<a href="#l8.373"></a><span id="l8.373">     return;</span>
<a href="#l8.374"></a><span id="l8.374"> </span>
<a href="#l8.375"></a><span id="l8.375">   let statusFeedback;</span>
<a href="#l8.376"></a><span id="l8.376">   statusFeedback = Cc[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineat">@@ -359,120 +359,113 @@ function AbPrintCardInternal(doPrintPrev</span>
<a href="#l8.378"></a><span id="l8.378">   for (let i = 0; i &lt; numSelected; i++) {</span>
<a href="#l8.379"></a><span id="l8.379">     let card = selectedItems[i];</span>
<a href="#l8.380"></a><span id="l8.380">     let printCardUrl = CreatePrintCardUrl(card);</span>
<a href="#l8.381"></a><span id="l8.381">     if (printCardUrl) {</span>
<a href="#l8.382"></a><span id="l8.382">       selectionArray.push(printCardUrl);</span>
<a href="#l8.383"></a><span id="l8.383">     }</span>
<a href="#l8.384"></a><span id="l8.384">   }</span>
<a href="#l8.385"></a><span id="l8.385"> </span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+  /* eslint-disable no-native-reassign */</span>
<a href="#l8.387"></a><span id="l8.387">   printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;,</span>
<a href="#l8.388"></a><span id="l8.388">                                          &quot;&quot;,</span>
<a href="#l8.389"></a><span id="l8.389">                                          &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l8.390"></a><span id="l8.390">                                          selectionArray.length, selectionArray,</span>
<a href="#l8.391"></a><span id="l8.391">                                          statusFeedback, doPrintPreview, msgType);</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-  return;</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+  /* eslint-enable no-native-reassign */</span>
<a href="#l8.395"></a><span id="l8.395"> }</span>
<a href="#l8.396"></a><span id="l8.396"> </span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-function AbPrintCard()</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-{</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+function AbPrintCard() {</span>
<a href="#l8.400"></a><span id="l8.400">   AbPrintCardInternal(false, Ci.nsIMsgPrintEngine.MNAB_PRINT_AB_CARD);</span>
<a href="#l8.401"></a><span id="l8.401"> }</span>
<a href="#l8.402"></a><span id="l8.402"> </span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-function AbPrintPreviewCard()</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-{</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+function AbPrintPreviewCard() {</span>
<a href="#l8.406"></a><span id="l8.406">   AbPrintCardInternal(true, Ci.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_AB_CARD);</span>
<a href="#l8.407"></a><span id="l8.407"> }</span>
<a href="#l8.408"></a><span id="l8.408"> </span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-function CreatePrintCardUrl(card)</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-{</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+function CreatePrintCardUrl(card) {</span>
<a href="#l8.412"></a><span id="l8.412">   return &quot;data:application/xml;base64,&quot; + card.translateTo(&quot;base64xml&quot;);</span>
<a href="#l8.413"></a><span id="l8.413"> }</span>
<a href="#l8.414"></a><span id="l8.414"> </span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-function AbPrintAddressBookInternal(doPrintPreview, msgType)</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-{</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+function AbPrintAddressBookInternal(doPrintPreview, msgType) {</span>
<a href="#l8.418"></a><span id="l8.418">   let uri = getSelectedDirectoryURI();</span>
<a href="#l8.419"></a><span id="l8.419">   if (!uri)</span>
<a href="#l8.420"></a><span id="l8.420">     return;</span>
<a href="#l8.421"></a><span id="l8.421"> </span>
<a href="#l8.422"></a><span id="l8.422">   var statusFeedback;</span>
<a href="#l8.423"></a><span id="l8.423">   statusFeedback = Cc[&quot;@mozilla.org/messenger/statusfeedback;1&quot;].createInstance();</span>
<a href="#l8.424"></a><span id="l8.424">   statusFeedback = statusFeedback.QueryInterface(Ci.nsIMsgStatusFeedback);</span>
<a href="#l8.425"></a><span id="l8.425"> </span>
<a href="#l8.426"></a><span id="l8.426">   /*</span>
<a href="#l8.427"></a><span id="l8.427">     turn &quot;moz-abmdbdirectory://abook.mab&quot; into</span>
<a href="#l8.428"></a><span id="l8.428">     &quot;addbook://moz-abmdbdirectory/abook.mab?action=print&quot;</span>
<a href="#l8.429"></a><span id="l8.429">    */</span>
<a href="#l8.430"></a><span id="l8.430"> </span>
<a href="#l8.431"></a><span id="l8.431">   var abURIArr = uri.split(&quot;://&quot;);</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-  var printUrl = &quot;addbook://&quot; + abURIArr[0] + &quot;/&quot; + abURIArr[1] + &quot;?action=print&quot;</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+  var printUrl = &quot;addbook://&quot; + abURIArr[0] + &quot;/&quot; + abURIArr[1] + &quot;?action=print&quot;;</span>
<a href="#l8.434"></a><span id="l8.434"> </span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+  /* eslint-disable no-native-reassign */</span>
<a href="#l8.436"></a><span id="l8.436">   printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;,</span>
<a href="#l8.437"></a><span id="l8.437">                     &quot;&quot;,</span>
<a href="#l8.438"></a><span id="l8.438">                     &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l8.439"></a><span id="l8.439">                     1, [printUrl], statusFeedback, doPrintPreview, msgType);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-  return;</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+  /* eslint-enable no-native-reassign */</span>
<a href="#l8.443"></a><span id="l8.443"> }</span>
<a href="#l8.444"></a><span id="l8.444"> </span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-function AbPrintAddressBook()</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-{</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+function AbPrintAddressBook() {</span>
<a href="#l8.448"></a><span id="l8.448">   AbPrintAddressBookInternal(false, Ci.nsIMsgPrintEngine.MNAB_PRINT_ADDRBOOK);</span>
<a href="#l8.449"></a><span id="l8.449"> }</span>
<a href="#l8.450"></a><span id="l8.450"> </span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-function AbPrintPreviewAddressBook()</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-{</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+function AbPrintPreviewAddressBook() {</span>
<a href="#l8.454"></a><span id="l8.454">   AbPrintAddressBookInternal(true, Ci.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_ADDRBOOK);</span>
<a href="#l8.455"></a><span id="l8.455"> }</span>
<a href="#l8.456"></a><span id="l8.456"> </span>
<a href="#l8.457"></a><span id="l8.457"> /**</span>
<a href="#l8.458"></a><span id="l8.458">  * Export the currently selected addressbook.</span>
<a href="#l8.459"></a><span id="l8.459">  */</span>
<a href="#l8.460"></a><span id="l8.460"> function AbExportSelection() {</span>
<a href="#l8.461"></a><span id="l8.461">   let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l8.462"></a><span id="l8.462">   if (!selectedDirURI)</span>
<a href="#l8.463"></a><span id="l8.463">     return;</span>
<a href="#l8.464"></a><span id="l8.464"> </span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">- if (selectedDirURI == (kAllDirectoryRoot + &quot;?&quot;))</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-   return AbExportAll();</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+  if (selectedDirURI == (kAllDirectoryRoot + &quot;?&quot;)) {</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+    AbExportAll();</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+    return;</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+  }</span>
<a href="#l8.471"></a><span id="l8.471"> </span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">- return AbExport(selectedDirURI);</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+  AbExport(selectedDirURI);</span>
<a href="#l8.474"></a><span id="l8.474"> }</span>
<a href="#l8.475"></a><span id="l8.475"> </span>
<a href="#l8.476"></a><span id="l8.476"> /**</span>
<a href="#l8.477"></a><span id="l8.477">  * Export all found addressbooks, each in a separate file.</span>
<a href="#l8.478"></a><span id="l8.478">  */</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-function AbExportAll()</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-{</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+function AbExportAll() {</span>
<a href="#l8.482"></a><span id="l8.482">   let directories = MailServices.ab.directories;</span>
<a href="#l8.483"></a><span id="l8.483"> </span>
<a href="#l8.484"></a><span id="l8.484">   while (directories.hasMoreElements()) {</span>
<a href="#l8.485"></a><span id="l8.485">     let directory = directories.getNext();</span>
<a href="#l8.486"></a><span id="l8.486">     // Do not export LDAP ABs.</span>
<a href="#l8.487"></a><span id="l8.487">     if (!directory.URI.startsWith(kLdapUrlPrefix))</span>
<a href="#l8.488"></a><span id="l8.488">       AbExport(directory.URI);</span>
<a href="#l8.489"></a><span id="l8.489">   }</span>
<a href="#l8.490"></a><span id="l8.490"> }</span>
<a href="#l8.491"></a><span id="l8.491"> </span>
<a href="#l8.492"></a><span id="l8.492"> /**</span>
<a href="#l8.493"></a><span id="l8.493">  * Export the specified addressbook to a file.</span>
<a href="#l8.494"></a><span id="l8.494">  *</span>
<a href="#l8.495"></a><span id="l8.495">  * @param aSelectedDirURI  The URI of the addressbook to export.</span>
<a href="#l8.496"></a><span id="l8.496">  */</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-function AbExport(aSelectedDirURI)</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-{</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+function AbExport(aSelectedDirURI) {</span>
<a href="#l8.500"></a><span id="l8.500">   if (!aSelectedDirURI)</span>
<a href="#l8.501"></a><span id="l8.501">     return;</span>
<a href="#l8.502"></a><span id="l8.502"> </span>
<a href="#l8.503"></a><span id="l8.503">   try {</span>
<a href="#l8.504"></a><span id="l8.504">     let directory = GetDirectoryFromURI(aSelectedDirURI);</span>
<a href="#l8.505"></a><span id="l8.505">     MailServices.ab.exportAddressBook(window, directory);</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-  }</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-  catch (ex) {</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+  } catch (ex) {</span>
<a href="#l8.509"></a><span id="l8.509">     let message;</span>
<a href="#l8.510"></a><span id="l8.510">     switch (ex.result) {</span>
<a href="#l8.511"></a><span id="l8.511">       case Cr.NS_ERROR_FILE_ACCESS_DENIED:</span>
<a href="#l8.512"></a><span id="l8.512">         message = gAddressBookBundle.getString(&quot;failedToExportMessageFileAccessDenied&quot;);</span>
<a href="#l8.513"></a><span id="l8.513">         break;</span>
<a href="#l8.514"></a><span id="l8.514">       case Cr.NS_ERROR_FILE_NO_DEVICE_SPACE:</span>
<a href="#l8.515"></a><span id="l8.515">         message = gAddressBookBundle.getString(&quot;failedToExportMessageNoDeviceSpace&quot;);</span>
<a href="#l8.516"></a><span id="l8.516">         break;</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineat">@@ -482,75 +475,68 @@ function AbExport(aSelectedDirURI)</span>
<a href="#l8.518"></a><span id="l8.518">     }</span>
<a href="#l8.519"></a><span id="l8.519"> </span>
<a href="#l8.520"></a><span id="l8.520">     Services.prompt.alert(window,</span>
<a href="#l8.521"></a><span id="l8.521">       gAddressBookBundle.getString(&quot;failedToExportTitle&quot;),</span>
<a href="#l8.522"></a><span id="l8.522">       message);</span>
<a href="#l8.523"></a><span id="l8.523">   }</span>
<a href="#l8.524"></a><span id="l8.524"> }</span>
<a href="#l8.525"></a><span id="l8.525"> </span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-function SetStatusText(total)</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-{</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+function SetStatusText(total) {</span>
<a href="#l8.529"></a><span id="l8.529">   if (!gStatusText)</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-    gStatusText = document.getElementById('statusText');</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+    gStatusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l8.532"></a><span id="l8.532"> </span>
<a href="#l8.533"></a><span id="l8.533">   try {</span>
<a href="#l8.534"></a><span id="l8.534">     let statusText;</span>
<a href="#l8.535"></a><span id="l8.535"> </span>
<a href="#l8.536"></a><span id="l8.536">     let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l8.537"></a><span id="l8.537">     if (searchInput &amp;&amp; searchInput.value) {</span>
<a href="#l8.538"></a><span id="l8.538">       if (total == 0) {</span>
<a href="#l8.539"></a><span id="l8.539">         statusText = gAddressBookBundle.getString(&quot;noMatchFound&quot;);</span>
<a href="#l8.540"></a><span id="l8.540">       } else {</span>
<a href="#l8.541"></a><span id="l8.541">         statusText = PluralForm</span>
<a href="#l8.542"></a><span id="l8.542">           .get(total, gAddressBookBundle.getString(&quot;matchesFound1&quot;))</span>
<a href="#l8.543"></a><span id="l8.543">           .replace(&quot;#1&quot;, total);</span>
<a href="#l8.544"></a><span id="l8.544">       }</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-    }</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-    else</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+    } else</span>
<a href="#l8.548"></a><span id="l8.548">       statusText =</span>
<a href="#l8.549"></a><span id="l8.549">         gAddressBookBundle.getFormattedString(</span>
<a href="#l8.550"></a><span id="l8.550">           &quot;totalContactStatus&quot;,</span>
<a href="#l8.551"></a><span id="l8.551">           [getSelectedDirectory().dirName, total]);</span>
<a href="#l8.552"></a><span id="l8.552"> </span>
<a href="#l8.553"></a><span id="l8.553">     gStatusText.setAttribute(&quot;label&quot;, statusText);</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-  }</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-  catch(ex) {</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+  } catch (ex) {</span>
<a href="#l8.557"></a><span id="l8.557">     Cu.reportError(&quot;ERROR: failed to set status text:  &quot; + ex );</span>
<a href="#l8.558"></a><span id="l8.558">   }</span>
<a href="#l8.559"></a><span id="l8.559"> }</span>
<a href="#l8.560"></a><span id="l8.560"> </span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-function AbResultsPaneKeyPress(event)</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-{</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+function AbResultsPaneKeyPress(event) {</span>
<a href="#l8.564"></a><span id="l8.564">   if (event.keyCode == 13)</span>
<a href="#l8.565"></a><span id="l8.565">     AbEditSelectedCard();</span>
<a href="#l8.566"></a><span id="l8.566"> }</span>
<a href="#l8.567"></a><span id="l8.567"> </span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-function AbResultsPaneDoubleClick(card)</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-{</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+function AbResultsPaneDoubleClick(card) {</span>
<a href="#l8.571"></a><span id="l8.571">   AbEditCard(card);</span>
<a href="#l8.572"></a><span id="l8.572"> }</span>
<a href="#l8.573"></a><span id="l8.573"> </span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-function onAdvancedAbSearch()</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-{</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+function onAdvancedAbSearch() {</span>
<a href="#l8.577"></a><span id="l8.577">   let selectedDirURI = getSelectedDirectoryURI();</span>
<a href="#l8.578"></a><span id="l8.578">   if (!selectedDirURI)</span>
<a href="#l8.579"></a><span id="l8.579">     return;</span>
<a href="#l8.580"></a><span id="l8.580"> </span>
<a href="#l8.581"></a><span id="l8.581">   let existingSearchWindow = Services.wm.getMostRecentWindow(&quot;mailnews:absearch&quot;);</span>
<a href="#l8.582"></a><span id="l8.582">   if (existingSearchWindow)</span>
<a href="#l8.583"></a><span id="l8.583">     existingSearchWindow.focus();</span>
<a href="#l8.584"></a><span id="l8.584">   else</span>
<a href="#l8.585"></a><span id="l8.585">     window.openDialog(&quot;chrome://messenger/content/ABSearchDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l8.586"></a><span id="l8.586">                       &quot;chrome,resizable,status,centerscreen,dialog=no&quot;,</span>
<a href="#l8.587"></a><span id="l8.587">                       {directory: selectedDirURI});</span>
<a href="#l8.588"></a><span id="l8.588"> }</span>
<a href="#l8.589"></a><span id="l8.589"> </span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-function onEnterInSearchBar()</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-{</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+function onEnterInSearchBar() {</span>
<a href="#l8.593"></a><span id="l8.593">   ClearCardViewPane();</span>
<a href="#l8.594"></a><span id="l8.594">   if (!gQueryURIFormat) {</span>
<a href="#l8.595"></a><span id="l8.595">     // Get model query from pref. We don't want the query starting with &quot;?&quot;</span>
<a href="#l8.596"></a><span id="l8.596">     // as we have to prefix &quot;?and&quot; to this format.</span>
<a href="#l8.597"></a><span id="l8.597">     gQueryURIFormat = getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l8.598"></a><span id="l8.598">   }</span>
<a href="#l8.599"></a><span id="l8.599"> </span>
<a href="#l8.600"></a><span id="l8.600">   let searchURI = getSelectedDirectoryURI();</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineat">@@ -580,141 +566,120 @@ function onEnterInSearchBar()</span>
<a href="#l8.602"></a><span id="l8.602">   SetAbView(searchURI);</span>
<a href="#l8.603"></a><span id="l8.603"> </span>
<a href="#l8.604"></a><span id="l8.604">   // XXX todo</span>
<a href="#l8.605"></a><span id="l8.605">   // this works for synchronous searches of local addressbooks,</span>
<a href="#l8.606"></a><span id="l8.606">   // but not for LDAP searches</span>
<a href="#l8.607"></a><span id="l8.607">   SelectFirstCard();</span>
<a href="#l8.608"></a><span id="l8.608"> }</span>
<a href="#l8.609"></a><span id="l8.609"> </span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-function SwitchPaneFocus(event)</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-{</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+function SwitchPaneFocus(event) {</span>
<a href="#l8.613"></a><span id="l8.613">   var focusedElement    = WhichPaneHasFocus();</span>
<a href="#l8.614"></a><span id="l8.614">   var cardViewBox       = GetCardViewBox();</span>
<a href="#l8.615"></a><span id="l8.615">   var cardViewBoxEmail1 = GetCardViewBoxEmail1();</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-  var searchBox         = document.getElementById('search-container');</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+  var searchBox         = document.getElementById(&quot;search-container&quot;);</span>
<a href="#l8.618"></a><span id="l8.618">   var dirTree           = GetDirTree();</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-  var searchInput       = document.getElementById('peopleSearchInput');</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+  var searchInput       = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l8.621"></a><span id="l8.621"> </span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-  if (event &amp;&amp; event.shiftKey)</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-  {</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-    if (focusedElement == gAbResultsTree &amp;&amp; searchBox)</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+  if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+    if (focusedElement == gAbResultsTree &amp;&amp; searchBox) {</span>
<a href="#l8.627"></a><span id="l8.627">       searchInput.focus();</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-    else if ((focusedElement == gAbResultsTree || focusedElement == searchBox) &amp;&amp; !IsDirPaneCollapsed())</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+    } else if ((focusedElement == gAbResultsTree || focusedElement == searchBox) &amp;&amp; !IsDirPaneCollapsed()) {</span>
<a href="#l8.630"></a><span id="l8.630">       dirTree.focus();</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineminus">-    else if (focusedElement != cardViewBox &amp;&amp; !IsCardViewAndAbResultsPaneSplitterCollapsed())</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-    {</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineminus">-      if (cardViewBoxEmail1)</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+    } else if (focusedElement != cardViewBox &amp;&amp; !IsCardViewAndAbResultsPaneSplitterCollapsed()) {</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+      if (cardViewBoxEmail1) {</span>
<a href="#l8.636"></a><span id="l8.636">         cardViewBoxEmail1.focus();</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-      else</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+      } else {</span>
<a href="#l8.639"></a><span id="l8.639">         cardViewBox.focus();</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-    }</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-    else</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+      }</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+    } else {</span>
<a href="#l8.644"></a><span id="l8.644">       gAbResultsTree.focus();</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-  }</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-  else</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-  {</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-    if (focusedElement == searchBox)</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-      gAbResultsTree.focus();</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-    else if (focusedElement == gAbResultsTree &amp;&amp; !IsCardViewAndAbResultsPaneSplitterCollapsed())</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-    {</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-      if (cardViewBoxEmail1)</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-        cardViewBoxEmail1.focus();</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-      else</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-        cardViewBox.focus();</span>
<a href="#l8.656"></a><span id="l8.656">     }</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-    else if (focusedElement != dirTree &amp;&amp; !IsDirPaneCollapsed())</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-      dirTree.focus();</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-    else if (searchBox &amp;&amp; searchInput)</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-      searchInput.focus();</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-    else</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-      gAbResultsTree.focus();</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+  } else if (focusedElement == searchBox) {</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+    gAbResultsTree.focus();</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+  } else if (focusedElement == gAbResultsTree &amp;&amp; !IsCardViewAndAbResultsPaneSplitterCollapsed()) {</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+    if (cardViewBoxEmail1) {</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+      cardViewBoxEmail1.focus();</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+    } else {</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+      cardViewBox.focus();</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+    }</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+  } else if (focusedElement != dirTree &amp;&amp; !IsDirPaneCollapsed()) {</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+    dirTree.focus();</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+  } else if (searchBox &amp;&amp; searchInput) {</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+    searchInput.focus();</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+  } else {</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+    gAbResultsTree.focus();</span>
<a href="#l8.677"></a><span id="l8.677">   }</span>
<a href="#l8.678"></a><span id="l8.678"> }</span>
<a href="#l8.679"></a><span id="l8.679"> </span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-function WhichPaneHasFocus()</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-{</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+function WhichPaneHasFocus() {</span>
<a href="#l8.683"></a><span id="l8.683">   var cardViewBox       = GetCardViewBox();</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-  var searchBox         = document.getElementById('search-container');</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+  var searchBox         = document.getElementById(&quot;search-container&quot;);</span>
<a href="#l8.686"></a><span id="l8.686">   var dirTree           = GetDirTree();</span>
<a href="#l8.687"></a><span id="l8.687"> </span>
<a href="#l8.688"></a><span id="l8.688">   var currentNode = top.document.commandDispatcher.focusedElement;</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-  while (currentNode)</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-  {</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-    var nodeId = currentNode.getAttribute('id');</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+  while (currentNode) {</span>
<a href="#l8.694"></a><span id="l8.694">     if (currentNode == gAbResultsTree ||</span>
<a href="#l8.695"></a><span id="l8.695">         currentNode == cardViewBox ||</span>
<a href="#l8.696"></a><span id="l8.696">         currentNode == searchBox ||</span>
<a href="#l8.697"></a><span id="l8.697">         currentNode == dirTree)</span>
<a href="#l8.698"></a><span id="l8.698">       return currentNode;</span>
<a href="#l8.699"></a><span id="l8.699"> </span>
<a href="#l8.700"></a><span id="l8.700">     currentNode = currentNode.parentNode;</span>
<a href="#l8.701"></a><span id="l8.701">   }</span>
<a href="#l8.702"></a><span id="l8.702"> </span>
<a href="#l8.703"></a><span id="l8.703">   return null;</span>
<a href="#l8.704"></a><span id="l8.704"> }</span>
<a href="#l8.705"></a><span id="l8.705"> </span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-function GetDirTree()</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-{</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+function GetDirTree() {</span>
<a href="#l8.709"></a><span id="l8.709">   if (!gDirTree)</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-    gDirTree = document.getElementById('dirTree');</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+    gDirTree = document.getElementById(&quot;dirTree&quot;);</span>
<a href="#l8.712"></a><span id="l8.712">   return gDirTree;</span>
<a href="#l8.713"></a><span id="l8.713"> }</span>
<a href="#l8.714"></a><span id="l8.714"> </span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-function GetCardViewBox()</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-{</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+function GetCardViewBox() {</span>
<a href="#l8.718"></a><span id="l8.718">   if (!gCardViewBox)</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-    gCardViewBox = document.getElementById('CardViewBox');</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+    gCardViewBox = document.getElementById(&quot;CardViewBox&quot;);</span>
<a href="#l8.721"></a><span id="l8.721">   return gCardViewBox;</span>
<a href="#l8.722"></a><span id="l8.722"> }</span>
<a href="#l8.723"></a><span id="l8.723"> </span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-function GetCardViewBoxEmail1()</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-{</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-  if (!gCardViewBoxEmail1)</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-  {</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+function GetCardViewBoxEmail1() {</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+  if (!gCardViewBoxEmail1) {</span>
<a href="#l8.730"></a><span id="l8.730">     try {</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-      gCardViewBoxEmail1 = document.getElementById('cvEmail1');</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-    }</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-    catch (ex) {</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+      gCardViewBoxEmail1 = document.getElementById(&quot;cvEmail1&quot;);</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+    } catch (ex) {</span>
<a href="#l8.736"></a><span id="l8.736">       gCardViewBoxEmail1 = null;</span>
<a href="#l8.737"></a><span id="l8.737">     }</span>
<a href="#l8.738"></a><span id="l8.738">   }</span>
<a href="#l8.739"></a><span id="l8.739">   return gCardViewBoxEmail1;</span>
<a href="#l8.740"></a><span id="l8.740"> }</span>
<a href="#l8.741"></a><span id="l8.741"> </span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-function IsDirPaneCollapsed()</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-{</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+function IsDirPaneCollapsed() {</span>
<a href="#l8.745"></a><span id="l8.745">   var dirPaneBox = GetDirTree().parentNode;</span>
<a href="#l8.746"></a><span id="l8.746">   return dirPaneBox.getAttribute(&quot;collapsed&quot;) == &quot;true&quot; ||</span>
<a href="#l8.747"></a><span id="l8.747">          dirPaneBox.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l8.748"></a><span id="l8.748"> }</span>
<a href="#l8.749"></a><span id="l8.749"> </span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-function IsCardViewAndAbResultsPaneSplitterCollapsed()</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-{</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-  var cardViewBox = document.getElementById('CardViewOuterBox');</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+function IsCardViewAndAbResultsPaneSplitterCollapsed() {</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+  var cardViewBox = document.getElementById(&quot;CardViewOuterBox&quot;);</span>
<a href="#l8.755"></a><span id="l8.755">   try {</span>
<a href="#l8.756"></a><span id="l8.756">     return (cardViewBox.getAttribute(&quot;collapsed&quot;) == &quot;true&quot;);</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-  }</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-  catch (ex) {</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+  } catch (ex) {</span>
<a href="#l8.760"></a><span id="l8.760">     return false;</span>
<a href="#l8.761"></a><span id="l8.761">   }</span>
<a href="#l8.762"></a><span id="l8.762"> }</span>
<a href="#l8.763"></a><span id="l8.763"> </span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-function LaunchUrl(url)</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-{</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+function LaunchUrl(url) {</span>
<a href="#l8.767"></a><span id="l8.767">   // Doesn't matter if this bit fails, window.location contains its own prompts</span>
<a href="#l8.768"></a><span id="l8.768">   try {</span>
<a href="#l8.769"></a><span id="l8.769">     window.location = url;</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-  }</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-  catch (ex) {}</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l8.773"></a><span id="l8.773"> }</span>
<a href="#l8.774"></a><span id="l8.774"> </span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-function AbIMSelected()</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-{</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+function AbIMSelected() {</span>
<a href="#l8.778"></a><span id="l8.778">   let cards = GetSelectedAbCards();</span>
<a href="#l8.779"></a><span id="l8.779"> </span>
<a href="#l8.780"></a><span id="l8.780">   if (!cards) {</span>
<a href="#l8.781"></a><span id="l8.781">     Cu.reportError(&quot;ERROR: AbIMSelected: |cards| is null.&quot;);</span>
<a href="#l8.782"></a><span id="l8.782">     return;</span>
<a href="#l8.783"></a><span id="l8.783">   }</span>
<a href="#l8.784"></a><span id="l8.784"> </span>
<a href="#l8.785"></a><span id="l8.785">   if (cards.length != 1) {</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineat">@@ -768,18 +733,17 @@ function AbIMSelected()</span>
<a href="#l8.787"></a><span id="l8.787">     let prplConv = selectedContact.createConversation();</span>
<a href="#l8.788"></a><span id="l8.788">     let uiConv = Services.conversations.getUIConversation(prplConv);</span>
<a href="#l8.789"></a><span id="l8.789">     let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l8.790"></a><span id="l8.790"> </span>
<a href="#l8.791"></a><span id="l8.791">     if (win) {</span>
<a href="#l8.792"></a><span id="l8.792">       win.focus();</span>
<a href="#l8.793"></a><span id="l8.793">       win.showChatTab();</span>
<a href="#l8.794"></a><span id="l8.794">       win.chatHandler.focusConversation(uiConv);</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-    }</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineminus">-    else {</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+    } else {</span>
<a href="#l8.798"></a><span id="l8.798">       window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l8.799"></a><span id="l8.799">                         &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;,</span>
<a href="#l8.800"></a><span id="l8.800">                         null, {tabType: &quot;chat&quot;,</span>
<a href="#l8.801"></a><span id="l8.801">                                tabParams: {convType: &quot;focus&quot;, conv: uiConv}});</span>
<a href="#l8.802"></a><span id="l8.802">     }</span>
<a href="#l8.803"></a><span id="l8.803"> </span>
<a href="#l8.804"></a><span id="l8.804">     return;</span>
<a href="#l8.805"></a><span id="l8.805">   }</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineat">@@ -793,61 +757,49 @@ function AbIMSelected()</span>
<a href="#l8.807"></a><span id="l8.807"> </span>
<a href="#l8.808"></a><span id="l8.808">   // And if we got here, that means we couldn't find *any* usernames we could</span>
<a href="#l8.809"></a><span id="l8.809">   // chat with. That really shouldn't be possible, since the isEnabled for</span>
<a href="#l8.810"></a><span id="l8.810">   // cmd_chatWithCard makes checks for this sort of thing, but we'll throw</span>
<a href="#l8.811"></a><span id="l8.811">   // an exception for good measure.</span>
<a href="#l8.812"></a><span id="l8.812">   throw new Error(&quot;Couldn't find any usernames to chat with for this card.&quot;);</span>
<a href="#l8.813"></a><span id="l8.813"> }</span>
<a href="#l8.814"></a><span id="l8.814"> </span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-function getMailToolbox()</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-{</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+function getMailToolbox() {</span>
<a href="#l8.818"></a><span id="l8.818">   return document.getElementById(&quot;ab-toolbox&quot;);</span>
<a href="#l8.819"></a><span id="l8.819"> }</span>
<a href="#l8.820"></a><span id="l8.820"> </span>
<a href="#l8.821"></a><span id="l8.821"> var kOSXDirectoryURI = &quot;moz-abosxdirectory:///&quot;;</span>
<a href="#l8.822"></a><span id="l8.822"> var kOSXPrefBase = &quot;ldap_2.servers.osx&quot;;</span>
<a href="#l8.823"></a><span id="l8.823"> </span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-function AbOSXAddressBookExists()</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-{</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+function AbOSXAddressBookExists() {</span>
<a href="#l8.827"></a><span id="l8.827">   // I hate doing it this way - until we redo how we manage address books</span>
<a href="#l8.828"></a><span id="l8.828">   // I can't think of a better way though.</span>
<a href="#l8.829"></a><span id="l8.829"> </span>
<a href="#l8.830"></a><span id="l8.830">   // See if the pref exists, if so, then we need to delete the address book</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-  var uriPresent = false;</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-  var position = 1;</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-  try {</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-    uriPresent = Services.prefs.getCharPref(kOSXPrefBase + &quot;.uri&quot;) == kOSXDirectoryURI;</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">-  }</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">-  catch (e) { }</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-  try {</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-    position = Services.prefs.getIntPref(kOSXPrefBase + &quot;.position&quot;);</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-  }</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-  catch (e) { }</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+  var uriPresent = Preferences.get(kOSXPrefBase + &quot;.uri&quot;, null) == kOSXDirectoryURI;</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineplus">+  var position = Preferences.get(kOSXPrefBase + &quot;.position&quot;, 1);</span>
<a href="#l8.844"></a><span id="l8.844"> </span>
<a href="#l8.845"></a><span id="l8.845">   // Address book exists if the uri is correct and the position is not zero.</span>
<a href="#l8.846"></a><span id="l8.846">   return uriPresent &amp;&amp; position != 0;</span>
<a href="#l8.847"></a><span id="l8.847"> }</span>
<a href="#l8.848"></a><span id="l8.848"> </span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-function AbShowHideOSXAddressBook()</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-{</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+function AbShowHideOSXAddressBook() {</span>
<a href="#l8.852"></a><span id="l8.852">   if (AbOSXAddressBookExists())</span>
<a href="#l8.853"></a><span id="l8.853">     MailServices.ab.deleteAddressBook(kOSXDirectoryURI);</span>
<a href="#l8.854"></a><span id="l8.854">   else {</span>
<a href="#l8.855"></a><span id="l8.855">     MailServices.ab.newAddressBook(</span>
<a href="#l8.856"></a><span id="l8.856">       gAddressBookBundle.getString(kOSXPrefBase + &quot;.description&quot;),</span>
<a href="#l8.857"></a><span id="l8.857">       kOSXDirectoryURI, 3, kOSXPrefBase);</span>
<a href="#l8.858"></a><span id="l8.858">   }</span>
<a href="#l8.859"></a><span id="l8.859"> }</span>
<a href="#l8.860"></a><span id="l8.860"> </span>
<a href="#l8.861"></a><span id="l8.861"> var abResultsController = {</span>
<a href="#l8.862"></a><span id="l8.862">   commands: {</span>
<a href="#l8.863"></a><span id="l8.863">     cmd_chatWithCard: {</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+      isEnabled() {</span>
<a href="#l8.866"></a><span id="l8.866">         let selected = GetSelectedAbCards();</span>
<a href="#l8.867"></a><span id="l8.867"> </span>
<a href="#l8.868"></a><span id="l8.868">         if (selected.length != 1)</span>
<a href="#l8.869"></a><span id="l8.869">           return false;</span>
<a href="#l8.870"></a><span id="l8.870"> </span>
<a href="#l8.871"></a><span id="l8.871">         let selectedCard = selected[0];</span>
<a href="#l8.872"></a><span id="l8.872">         if (!selectedCard)</span>
<a href="#l8.873"></a><span id="l8.873">           return false;</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineat">@@ -862,36 +814,36 @@ var abResultsController = {</span>
<a href="#l8.875"></a><span id="l8.875">                   &amp;&amp; chatHandler.allContacts[contactName].canSendMessage);</span>
<a href="#l8.876"></a><span id="l8.876">         });</span>
<a href="#l8.877"></a><span id="l8.877"> </span>
<a href="#l8.878"></a><span id="l8.878">         let hasAIM = selectedCard.getProperty(&quot;_AimScreenName&quot;, &quot;&quot;);</span>
<a href="#l8.879"></a><span id="l8.879"> </span>
<a href="#l8.880"></a><span id="l8.880">         return isIMContact || hasAIM;</span>
<a href="#l8.881"></a><span id="l8.881">       },</span>
<a href="#l8.882"></a><span id="l8.882"> </span>
<a href="#l8.883"></a><span id="l8.883" class="difflineminus">-      doCommand: function() {</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+      doCommand() {</span>
<a href="#l8.885"></a><span id="l8.885">         AbIMSelected();</span>
<a href="#l8.886"></a><span id="l8.886">       },</span>
<a href="#l8.887"></a><span id="l8.887">     }</span>
<a href="#l8.888"></a><span id="l8.888">   },</span>
<a href="#l8.889"></a><span id="l8.889"> </span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-  supportsCommand: function(aCommand) {</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+  supportsCommand(aCommand) {</span>
<a href="#l8.892"></a><span id="l8.892">     return (aCommand in this.commands);</span>
<a href="#l8.893"></a><span id="l8.893">   },</span>
<a href="#l8.894"></a><span id="l8.894"> </span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-  isCommandEnabled: function(aCommand) {</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+  isCommandEnabled(aCommand) {</span>
<a href="#l8.897"></a><span id="l8.897">     if (!this.supportsCommand(aCommand))</span>
<a href="#l8.898"></a><span id="l8.898">       return false;</span>
<a href="#l8.899"></a><span id="l8.899"> </span>
<a href="#l8.900"></a><span id="l8.900">     return this.commands[aCommand].isEnabled();</span>
<a href="#l8.901"></a><span id="l8.901">   },</span>
<a href="#l8.902"></a><span id="l8.902"> </span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-  doCommand: function(aCommand) {</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l8.905"></a><span id="l8.905">     if (!this.supportsCommand(aCommand))</span>
<a href="#l8.906"></a><span id="l8.906">       return;</span>
<a href="#l8.907"></a><span id="l8.907">     let cmd = this.commands[aCommand];</span>
<a href="#l8.908"></a><span id="l8.908">     if (!cmd.isEnabled())</span>
<a href="#l8.909"></a><span id="l8.909">       return;</span>
<a href="#l8.910"></a><span id="l8.910">     cmd.doCommand();</span>
<a href="#l8.911"></a><span id="l8.911">   },</span>
<a href="#l8.912"></a><span id="l8.912"> </span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-  onEvent: function(aEvent) {}</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-}</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineplus">+  onEvent(aEvent) {}</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineplus">+};</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

