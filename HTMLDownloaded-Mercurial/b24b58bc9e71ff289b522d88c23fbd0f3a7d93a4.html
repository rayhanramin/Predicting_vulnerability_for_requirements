<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 222:b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4" />
<meta property="og:url" content="/comm-central/rev/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4" />
<meta property="og:description" content="maintain kewyords on imap detach/delete if server supports keywords, r=standard8, sr=neil, 440366" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">shortlog</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">files</a> |
changeset |
<a href="/comm-central/raw-rev/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">raw</a>  | <a href="/comm-central/archive/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
maintain kewyords on imap detach/delete if server supports keywords, r=standard8, sr=neil, 440366
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 29 Aug 2008 07:36:50 -0700</td></tr>

<tr>
 <td>changeset 222</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4</a></td>
</tr>



<tr>
<td>parent 221</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/92b407424302a753422875a38e1e14900f7b522c">92b407424302a753422875a38e1e14900f7b522c</a>
</td>
</tr>

<tr>
<td>child 223</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/abb590b3397d5b030efcee393e4f7633c884fcb0">abb590b3397d5b030efcee393e4f7633c884fcb0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">197</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 29 Aug 2008 14:36:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b24b58bc9e71 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&newProject=comm-central&newRevision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&newProject=comm-central&newRevision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&newProject=comm-central&newRevision=b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28440366%29&revcount=50">440366</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=440366">440366</a></td></tr>




</table></div>

<div class="page_body description">maintain kewyords on imap detach/delete if server supports keywords, r=standard8, sr=neil, 440366</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgCopyService.idl">mailnews/base/public/nsIMsgCopyService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgCopyService.idl">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgCopyService.idl">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgCopyService.idl">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgCopyService.idl">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgCopyService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.cpp">mailnews/base/src/nsMsgCopyService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.h">mailnews/base/src/nsMsgCopyService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.h">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.h">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.h">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.h">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/src/nsMsgCopyService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_bug428427.js">mailnews/base/test/unit/test_bug428427.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_bug428427.js">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_bug428427.js">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_bug428427.js">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_bug428427.js">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_bug428427.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchAddressInAb.js">mailnews/base/test/unit/test_searchAddressInAb.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchAddressInAb.js">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchAddressInAb.js">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchAddressInAb.js">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchAddressInAb.js">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchAddressInAb.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchJunk.js">mailnews/base/test/unit/test_searchJunk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchJunk.js">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchJunk.js">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchJunk.js">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchJunk.js">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchJunk.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchTag.js">mailnews/base/test/unit/test_searchTag.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchTag.js">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchTag.js">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchTag.js">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchTag.js">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/test/unit/test_searchTag.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/compose/src/nsMsgCopy.cpp">mailnews/compose/src/nsMsgCopy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/compose/src/nsMsgCopy.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/compose/src/nsMsgCopy.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/compose/src/nsMsgCopy.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/compose/src/nsMsgCopy.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/compose/src/nsMsgCopy.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/test/unit/test_msgCopy.js">mailnews/local/test/unit/test_msgCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/test/unit/test_msgCopy.js">file</a> |
<a href="/comm-central/annotate/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/test/unit/test_msgCopy.js">annotate</a> |
<a href="/comm-central/diff/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/test/unit/test_msgCopy.js">diff</a> |
<a href="/comm-central/comparison/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/test/unit/test_msgCopy.js">comparison</a> |
<a href="/comm-central/log/b24b58bc9e71ff289b522d88c23fbd0f3a7d93a4/mailnews/local/test/unit/test_msgCopy.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgCopyService.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgCopyService.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -45,17 +45,17 @@ interface nsIMsgDBHdr;</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsITransactionManager.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> %}</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> interface nsITransactionManager;</span>
<a href="#l1.8"></a><span id="l1.8"> interface nsIMsgWindow;</span>
<a href="#l1.9"></a><span id="l1.9"> interface nsIFile;</span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIArray;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(4010d881-6c83-4f8d-9332-d44564cee14a)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(f21e428b-73c5-4607-993b-d37325b33722)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgCopyService : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">     /**</span>
<a href="#l1.17"></a><span id="l1.17">      *</span>
<a href="#l1.18"></a><span id="l1.18">      */</span>
<a href="#l1.19"></a><span id="l1.19">     void CopyMessages(in nsIMsgFolder srcFolder,</span>
<a href="#l1.20"></a><span id="l1.20">                       in nsIArray messages,</span>
<a href="#l1.21"></a><span id="l1.21">                       in nsIMsgFolder dstFolder,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -73,16 +73,17 @@ interface nsIMsgCopyService : nsISupport</span>
<a href="#l1.23"></a><span id="l1.23">                      in nsIMsgCopyServiceListener listener,</span>
<a href="#l1.24"></a><span id="l1.24">                      in nsIMsgWindow msgWindow);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     void CopyFileMessage(in nsIFile aFile,</span>
<a href="#l1.27"></a><span id="l1.27">                          in nsIMsgFolder dstFolder,</span>
<a href="#l1.28"></a><span id="l1.28">                          in nsIMsgDBHdr msgToReplace,</span>
<a href="#l1.29"></a><span id="l1.29">                          in boolean isDraftOrTemplate,</span>
<a href="#l1.30"></a><span id="l1.30">                          in unsigned long aMsgFlags,</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                         in ACString aMsgKeywords,</span>
<a href="#l1.32"></a><span id="l1.32">                          in nsIMsgCopyServiceListener listener,</span>
<a href="#l1.33"></a><span id="l1.33">                          in nsIMsgWindow msgWindow);</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">     /**</span>
<a href="#l1.36"></a><span id="l1.36">      * Notify the message copy service that the destination folder has finished</span>
<a href="#l1.37"></a><span id="l1.37">      * it's messages copying operation so that the copy service can continue</span>
<a href="#l1.38"></a><span id="l1.38">      * copying the rest of the messages if there are more to copy with.</span>
<a href="#l1.39"></a><span id="l1.39">      * aSupport and dstFolder uniquely identify a copy service request.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -63,17 +63,17 @@ interface nsIMsgIdentity;</span>
<a href="#l2.4"></a><span id="l2.4"> interface nsIArray;</span>
<a href="#l2.5"></a><span id="l2.5"> interface nsIMutableArray;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> typedef long nsMsgBiffState;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l2.10"></a><span id="l2.10"> typedef long nsMsgDispositionState;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(68b5b459-bb89-4ea1-9513-60e763770908)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(ecf2bf05-f08f-4c4b-8b52-41a37292e9d3)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l2.17"></a><span id="l2.17">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l2.18"></a><span id="l2.18">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   nsISimpleEnumerator getMessages(in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -348,16 +348,17 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.23"></a><span id="l2.23">                     in nsIMsgCopyServiceListener listener, in boolean isFolder,</span>
<a href="#l2.24"></a><span id="l2.24">                     in boolean allowUndo);</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   void copyFolder(in nsIMsgFolder srcFolder, in boolean isMoveFolder,</span>
<a href="#l2.27"></a><span id="l2.27">                   in nsIMsgWindow msgWindow, in nsIMsgCopyServiceListener listener );</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   void copyFileMessage(in nsIFile file, in nsIMsgDBHdr msgToReplace,</span>
<a href="#l2.30"></a><span id="l2.30">                        in boolean isDraft, in unsigned long newMsgFlags,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+                       in ACString aKeywords,</span>
<a href="#l2.32"></a><span id="l2.32">                        in nsIMsgWindow msgWindow,</span>
<a href="#l2.33"></a><span id="l2.33">                        in nsIMsgCopyServiceListener listener);</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   void acquireSemaphore (in nsISupports semHolder);</span>
<a href="#l2.36"></a><span id="l2.36">   void releaseSemaphore (in nsISupports semHolder);</span>
<a href="#l2.37"></a><span id="l2.37">   boolean testSemaphore (in nsISupports semHolder);</span>
<a href="#l2.38"></a><span id="l2.38">   readonly attribute boolean locked;</span>
<a href="#l2.39"></a><span id="l2.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1629,17 +1629,17 @@ nsSaveMsgListener::OnStopRunningUrl(nsIU</span>
<a href="#l3.4"></a><span id="l3.4">       templateFolder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l3.5"></a><span id="l3.5">       if (NS_FAILED(rv)) goto done;</span>
<a href="#l3.6"></a><span id="l3.6">       nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l3.7"></a><span id="l3.7">       if (copyService)</span>
<a href="#l3.8"></a><span id="l3.8">       {</span>
<a href="#l3.9"></a><span id="l3.9">         nsCOMPtr &lt;nsIFile&gt; clone;</span>
<a href="#l3.10"></a><span id="l3.10">         m_file-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l3.11"></a><span id="l3.11">         rv = copyService-&gt;CopyFileMessage(clone, templateFolder, nsnull,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                                          PR_TRUE, MSG_FLAG_READ, this, nsnull);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                                          PR_TRUE, MSG_FLAG_READ, EmptyCString(), this, nsnull);</span>
<a href="#l3.14"></a><span id="l3.14">       }</span>
<a href="#l3.15"></a><span id="l3.15">       killSelf = PR_FALSE;</span>
<a href="#l3.16"></a><span id="l3.16">     }</span>
<a href="#l3.17"></a><span id="l3.17">   }</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> done:</span>
<a href="#l3.20"></a><span id="l3.20">   if (NS_FAILED(rv))</span>
<a href="#l3.21"></a><span id="l3.21">   {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -2559,18 +2559,20 @@ nsDelAttachListener::OnStopRequest(nsIRe</span>
<a href="#l3.23"></a><span id="l3.23">   mNewMessageKey = PR_UINT32_MAX;</span>
<a href="#l3.24"></a><span id="l3.24">   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l3.25"></a><span id="l3.25">   m_state = eCopyingNewMsg;</span>
<a href="#l3.26"></a><span id="l3.26">   // clone file because nsIFile on Windows caches the wrong file size.</span>
<a href="#l3.27"></a><span id="l3.27">   nsCOMPtr &lt;nsIFile&gt; clone;</span>
<a href="#l3.28"></a><span id="l3.28">   mMsgFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l3.29"></a><span id="l3.29">   if (copyService)</span>
<a href="#l3.30"></a><span id="l3.30">   {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    nsCString originalKeys;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    mOriginalMessage-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(originalKeys));</span>
<a href="#l3.33"></a><span id="l3.33">     rv = copyService-&gt;CopyFileMessage(clone, mMessageFolder, nsnull, PR_FALSE,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                                      mOrigMsgFlags, listenerCopyService, mMsgWindow);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+                                      mOrigMsgFlags, originalKeys, listenerCopyService, mMsgWindow);</span>
<a href="#l3.36"></a><span id="l3.36">   }</span>
<a href="#l3.37"></a><span id="l3.37">   return rv;</span>
<a href="#l3.38"></a><span id="l3.38"> }</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40"> //</span>
<a href="#l3.41"></a><span id="l3.41"> // nsIStreamListener</span>
<a href="#l3.42"></a><span id="l3.42"> //</span>
<a href="#l3.43"></a><span id="l3.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -97,26 +97,30 @@ nsCopyRequest::~nsCopyRequest()</span>
<a href="#l4.4"></a><span id="l4.4">       ncs = (nsCopySource*) m_copySourceArray.ElementAt(j);</span>
<a href="#l4.5"></a><span id="l4.5">       delete ncs;</span>
<a href="#l4.6"></a><span id="l4.6">   }</span>
<a href="#l4.7"></a><span id="l4.7"> }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> nsresult</span>
<a href="#l4.10"></a><span id="l4.10"> nsCopyRequest::Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l4.11"></a><span id="l4.11">                     nsIMsgFolder* dstFolder,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                    PRBool bVal, PRUint32 newMsgFlags, nsIMsgCopyServiceListener* listener,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                    PRBool bVal, PRUint32 newMsgFlags, </span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+                    const nsACString &amp;newMsgKeywords,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                    nsIMsgCopyServiceListener* listener,</span>
<a href="#l4.16"></a><span id="l4.16">                     nsIMsgWindow* msgWindow, PRBool allowUndo)</span>
<a href="#l4.17"></a><span id="l4.17"> {</span>
<a href="#l4.18"></a><span id="l4.18">   nsresult rv = NS_OK;</span>
<a href="#l4.19"></a><span id="l4.19">   m_requestType = type;</span>
<a href="#l4.20"></a><span id="l4.20">   m_srcSupport = aSupport;</span>
<a href="#l4.21"></a><span id="l4.21">   m_dstFolder = dstFolder;</span>
<a href="#l4.22"></a><span id="l4.22">   m_isMoveOrDraftOrTemplate = bVal;</span>
<a href="#l4.23"></a><span id="l4.23">   m_allowUndo = allowUndo;</span>
<a href="#l4.24"></a><span id="l4.24">   m_newMsgFlags = newMsgFlags;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  m_newMsgKeywords = newMsgKeywords;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27">   if (listener)</span>
<a href="#l4.28"></a><span id="l4.28">       m_listener = listener;</span>
<a href="#l4.29"></a><span id="l4.29">   if (msgWindow)</span>
<a href="#l4.30"></a><span id="l4.30">   {</span>
<a href="#l4.31"></a><span id="l4.31">     m_msgWindow = msgWindow;</span>
<a href="#l4.32"></a><span id="l4.32">     if (m_allowUndo)</span>
<a href="#l4.33"></a><span id="l4.33">       msgWindow-&gt;GetTransactionManager(getter_AddRefs(m_txnMgr));</span>
<a href="#l4.34"></a><span id="l4.34">   }</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineat">@@ -346,16 +350,17 @@ nsMsgCopyService::DoNextCopy()</span>
<a href="#l4.36"></a><span id="l4.36">                                                  0, &amp;rv);</span>
<a href="#l4.37"></a><span id="l4.37">                     copySource-&gt;m_processed = PR_TRUE;</span>
<a href="#l4.38"></a><span id="l4.38">                 }</span>
<a href="#l4.39"></a><span id="l4.39">                 copyRequest-&gt;m_processed = PR_TRUE;</span>
<a href="#l4.40"></a><span id="l4.40">                 rv = copyRequest-&gt;m_dstFolder-&gt;CopyFileMessage</span>
<a href="#l4.41"></a><span id="l4.41">                     (aFile, aMessage,</span>
<a href="#l4.42"></a><span id="l4.42">                      copyRequest-&gt;m_isMoveOrDraftOrTemplate,</span>
<a href="#l4.43"></a><span id="l4.43">                      copyRequest-&gt;m_newMsgFlags,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+                     copyRequest-&gt;m_newMsgKeywords,</span>
<a href="#l4.45"></a><span id="l4.45">                      copyRequest-&gt;m_msgWindow,</span>
<a href="#l4.46"></a><span id="l4.46">                      copyRequest-&gt;m_listener);</span>
<a href="#l4.47"></a><span id="l4.47">             }</span>
<a href="#l4.48"></a><span id="l4.48">           }</span>
<a href="#l4.49"></a><span id="l4.49">       }</span>
<a href="#l4.50"></a><span id="l4.50">     }</span>
<a href="#l4.51"></a><span id="l4.51">     return rv;</span>
<a href="#l4.52"></a><span id="l4.52"> }</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineat">@@ -447,18 +452,18 @@ nsMsgCopyService::CopyMessages(nsIMsgFol</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   copyRequest = new nsCopyRequest();</span>
<a href="#l4.56"></a><span id="l4.56">   if (!copyRequest)</span>
<a href="#l4.57"></a><span id="l4.57">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59">   aSupport = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">   rv = copyRequest-&gt;Init(nsCopyMessagesType, aSupport, dstFolder, isMove,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-                        0 /* new msg flags, not used */, listener,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-                         window, allowUndo);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+                        0 /* new msg flags, not used */, EmptyCString(), </span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+                        listener, window, allowUndo);</span>
<a href="#l4.66"></a><span id="l4.66">   if (NS_FAILED(rv))</span>
<a href="#l4.67"></a><span id="l4.67">     goto done;</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69">   messages-&gt;GetLength(&amp;cnt);</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">   // duplicate the message array so we could sort the messages by it's</span>
<a href="#l4.72"></a><span id="l4.72">   // folder easily</span>
<a href="#l4.73"></a><span id="l4.73">   for (PRUint32 i = 0; i &lt; cnt; i++)</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineat">@@ -537,17 +542,17 @@ nsMsgCopyService::CopyFolders(nsIArray* </span>
<a href="#l4.75"></a><span id="l4.75">     NS_ASSERTION((NS_SUCCEEDED(rv)),&quot;More than one folders to copy&quot;);</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">   support = do_QueryElementAt(folders, 0);</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79">   copyRequest = new nsCopyRequest();</span>
<a href="#l4.80"></a><span id="l4.80">   if (!copyRequest) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">   rv = copyRequest-&gt;Init(nsCopyFoldersType, support, dstFolder,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-    isMove, 0 /* new msg flags, not used */ , listener, window, PR_FALSE);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+    isMove, 0 /* new msg flags, not used */ , EmptyCString(), listener, window, PR_FALSE);</span>
<a href="#l4.85"></a><span id="l4.85">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87">   curFolder = do_QueryInterface(support, &amp;rv);</span>
<a href="#l4.88"></a><span id="l4.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">   copySource = copyRequest-&gt;AddNewCopySource(curFolder);</span>
<a href="#l4.91"></a><span id="l4.91">   if (!copySource)</span>
<a href="#l4.92"></a><span id="l4.92">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineat">@@ -564,16 +569,17 @@ nsMsgCopyService::CopyFolders(nsIArray* </span>
<a href="#l4.94"></a><span id="l4.94"> }</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96"> NS_IMETHODIMP</span>
<a href="#l4.97"></a><span id="l4.97"> nsMsgCopyService::CopyFileMessage(nsIFile* file,</span>
<a href="#l4.98"></a><span id="l4.98">                                   nsIMsgFolder* dstFolder,</span>
<a href="#l4.99"></a><span id="l4.99">                                   nsIMsgDBHdr* msgToReplace,</span>
<a href="#l4.100"></a><span id="l4.100">                                   PRBool isDraft,</span>
<a href="#l4.101"></a><span id="l4.101">                                   PRUint32 aMsgFlags,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+                                  const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l4.103"></a><span id="l4.103">                                   nsIMsgCopyServiceListener* listener,</span>
<a href="#l4.104"></a><span id="l4.104">                                   nsIMsgWindow* window)</span>
<a href="#l4.105"></a><span id="l4.105"> {</span>
<a href="#l4.106"></a><span id="l4.106">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l4.107"></a><span id="l4.107">   nsCopyRequest* copyRequest;</span>
<a href="#l4.108"></a><span id="l4.108">   nsCopySource* copySource = nsnull;</span>
<a href="#l4.109"></a><span id="l4.109">   nsCOMPtr&lt;nsISupports&gt; fileSupport;</span>
<a href="#l4.110"></a><span id="l4.110">   nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineat">@@ -584,17 +590,17 @@ nsMsgCopyService::CopyFileMessage(nsIFil</span>
<a href="#l4.112"></a><span id="l4.112">   if (window)</span>
<a href="#l4.113"></a><span id="l4.113">     window-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l4.114"></a><span id="l4.114">   copyRequest = new nsCopyRequest();</span>
<a href="#l4.115"></a><span id="l4.115">   if (!copyRequest) return rv;</span>
<a href="#l4.116"></a><span id="l4.116">   fileSupport = do_QueryInterface(file, &amp;rv);</span>
<a href="#l4.117"></a><span id="l4.117">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119">   rv = copyRequest-&gt;Init(nsCopyFileMessageType, fileSupport, dstFolder,</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-                         isDraft, aMsgFlags, listener, window, PR_FALSE);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+                         isDraft, aMsgFlags, aNewMsgKeywords, listener, window, PR_FALSE);</span>
<a href="#l4.122"></a><span id="l4.122">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l4.123"></a><span id="l4.123"> </span>
<a href="#l4.124"></a><span id="l4.124">   if (msgToReplace)</span>
<a href="#l4.125"></a><span id="l4.125">   {</span>
<a href="#l4.126"></a><span id="l4.126">     copySource = copyRequest-&gt;AddNewCopySource(dstFolder);</span>
<a href="#l4.127"></a><span id="l4.127">     if (!copySource)</span>
<a href="#l4.128"></a><span id="l4.128">     {</span>
<a href="#l4.129"></a><span id="l4.129">         rv = NS_ERROR_OUT_OF_MEMORY;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -72,30 +72,32 @@ class nsCopyRequest</span>
<a href="#l5.4"></a><span id="l5.4"> {</span>
<a href="#l5.5"></a><span id="l5.5"> public:</span>
<a href="#l5.6"></a><span id="l5.6">     nsCopyRequest();</span>
<a href="#l5.7"></a><span id="l5.7">     ~nsCopyRequest();</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">     nsresult Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l5.10"></a><span id="l5.10">                   nsIMsgFolder* dstFolder,</span>
<a href="#l5.11"></a><span id="l5.11">                   PRBool bVal, PRUint32 newMsgFlags, </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+                  const nsACString &amp;newMsgKeywords,</span>
<a href="#l5.13"></a><span id="l5.13">                   nsIMsgCopyServiceListener* listener,</span>
<a href="#l5.14"></a><span id="l5.14">                   nsIMsgWindow *msgWindow, PRBool allowUndo);</span>
<a href="#l5.15"></a><span id="l5.15">     nsCopySource* AddNewCopySource(nsIMsgFolder* srcFolder);</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">     nsCOMPtr&lt;nsISupports&gt; m_srcSupport; // ui source folder or file spec</span>
<a href="#l5.18"></a><span id="l5.18">     nsCOMPtr&lt;nsIMsgFolder&gt; m_dstFolder;</span>
<a href="#l5.19"></a><span id="l5.19">     nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l5.20"></a><span id="l5.20">     nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; m_listener;</span>
<a href="#l5.21"></a><span id="l5.21"> 	nsCOMPtr&lt;nsITransactionManager&gt; m_txnMgr;</span>
<a href="#l5.22"></a><span id="l5.22">     nsCopyRequestType m_requestType;</span>
<a href="#l5.23"></a><span id="l5.23">     PRBool m_isMoveOrDraftOrTemplate;</span>
<a href="#l5.24"></a><span id="l5.24">     PRBool m_allowUndo;</span>
<a href="#l5.25"></a><span id="l5.25">     PRBool m_processed;</span>
<a href="#l5.26"></a><span id="l5.26">     PRUint32 m_newMsgFlags;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+    nsCString m_newMsgKeywords;</span>
<a href="#l5.28"></a><span id="l5.28">     nsString m_dstFolderName;      // used for copy folder.</span>
<a href="#l5.29"></a><span id="l5.29">     nsVoidArray m_copySourceArray; // array of nsCopySource</span>
<a href="#l5.30"></a><span id="l5.30"> };</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32"> class nsMsgCopyService : public nsIMsgCopyService</span>
<a href="#l5.33"></a><span id="l5.33"> {</span>
<a href="#l5.34"></a><span id="l5.34"> public:</span>
<a href="#l5.35"></a><span id="l5.35"> 	nsMsgCopyService();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -64,17 +64,17 @@ function run_test()</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   loadLocalMailAccount();</span>
<a href="#l6.6"></a><span id="l6.6">     </span>
<a href="#l6.7"></a><span id="l6.7">   // Get messageCount messages into the local filestore.</span>
<a href="#l6.8"></a><span id="l6.8">   do_test_pending();</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   // function setupVirtualFolder() continues the testing after CopyFileMessage.</span>
<a href="#l6.11"></a><span id="l6.11">   copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                              copyListener, null);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                              &quot;&quot;, copyListener, null);</span>
<a href="#l6.14"></a><span id="l6.14">   return true;</span>
<a href="#l6.15"></a><span id="l6.15"> }</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l6.18"></a><span id="l6.18"> var copyListener = </span>
<a href="#l6.19"></a><span id="l6.19"> {</span>
<a href="#l6.20"></a><span id="l6.20">   OnStartCopy: function() {},</span>
<a href="#l6.21"></a><span id="l6.21">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -82,17 +82,17 @@ var copyListener =</span>
<a href="#l6.23"></a><span id="l6.23">   {</span>
<a href="#l6.24"></a><span id="l6.24">     hdrs.push(gLocalInboxFolder.GetMessageHeader(aKey));</span>
<a href="#l6.25"></a><span id="l6.25">   },</span>
<a href="#l6.26"></a><span id="l6.26">   SetMessageId: function(aMessageId) {},</span>
<a href="#l6.27"></a><span id="l6.27">   OnStopCopy: function(aStatus)</span>
<a href="#l6.28"></a><span id="l6.28">   {</span>
<a href="#l6.29"></a><span id="l6.29">     if (--messageCount)</span>
<a href="#l6.30"></a><span id="l6.30">       copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                                  copyListener, null);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+                                  &quot;&quot;, copyListener, null);</span>
<a href="#l6.33"></a><span id="l6.33">     else</span>
<a href="#l6.34"></a><span id="l6.34">       setupVirtualFolder();</span>
<a href="#l6.35"></a><span id="l6.35">   }</span>
<a href="#l6.36"></a><span id="l6.36"> };</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> var virtualFolder;</span>
<a href="#l6.39"></a><span id="l6.39"> var numTotalMessages; </span>
<a href="#l6.40"></a><span id="l6.40"> var numUnreadMessages;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -25,17 +25,17 @@ var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l7.4"></a><span id="l7.4"> var gLocalFolder2;</span>
<a href="#l7.5"></a><span id="l7.5"> var gLocalFolder3;</span>
<a href="#l7.6"></a><span id="l7.6"> var gLocalTrashFolder;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l7.9"></a><span id="l7.9"> {</span>
<a href="#l7.10"></a><span id="l7.10">   copyListener.mFolderStoredIn = destFolder;</span>
<a href="#l7.11"></a><span id="l7.11">   gExpectedEvents = [[gMFNService.msgAdded, gHdrsReceived]];</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, copyListener, null);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l7.14"></a><span id="l7.14">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l7.15"></a><span id="l7.15">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l7.16"></a><span id="l7.16">     resetStatusAndProceed();</span>
<a href="#l7.17"></a><span id="l7.17"> }</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> function copyMessages(items, isMove, srcFolder, destFolder)</span>
<a href="#l7.20"></a><span id="l7.20"> {</span>
<a href="#l7.21"></a><span id="l7.21">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchAddressInAb.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchAddressInAb.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -243,17 +243,17 @@ var copyListener =</span>
<a href="#l8.4"></a><span id="l8.4">   SetMessageId: function(aMessageId) {},</span>
<a href="#l8.5"></a><span id="l8.5">   OnStopCopy: function(aStatus) </span>
<a href="#l8.6"></a><span id="l8.6">   {</span>
<a href="#l8.7"></a><span id="l8.7">     var fileName = Files.shift();</span>
<a href="#l8.8"></a><span id="l8.8">     if (fileName)</span>
<a href="#l8.9"></a><span id="l8.9">     { </span>
<a href="#l8.10"></a><span id="l8.10">       var file = do_get_file(fileName);</span>
<a href="#l8.11"></a><span id="l8.11">       copyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                              copyListener, null);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                              &quot;&quot;, copyListener, null);</span>
<a href="#l8.14"></a><span id="l8.14">     }</span>
<a href="#l8.15"></a><span id="l8.15">     else</span>
<a href="#l8.16"></a><span id="l8.16">       testAbSearch();</span>
<a href="#l8.17"></a><span id="l8.17">   }</span>
<a href="#l8.18"></a><span id="l8.18"> };</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> // Runs at completion of copy</span>
<a href="#l8.21"></a><span id="l8.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchJunk.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchJunk.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -216,17 +216,17 @@ function run_test()</span>
<a href="#l9.4"></a><span id="l9.4">   testValidityTable(offlineMail, Isnt, JunkScoreOrigin, true);</span>
<a href="#l9.5"></a><span id="l9.5">   testValidityTable(offlineMail, IsGreaterThan, JunkScoreOrigin, false);</span>
<a href="#l9.6"></a><span id="l9.6">   testValidityTable(offlineMail, IsLessThan, JunkScoreOrigin, false);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">   // Get a message into the local filestore. function testJunkSearch() continues the testing after the copy.</span>
<a href="#l9.9"></a><span id="l9.9">   do_test_pending();</span>
<a href="#l9.10"></a><span id="l9.10">   var file = do_get_file(fileName);</span>
<a href="#l9.11"></a><span id="l9.11">   copyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                              copyListener, null);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                              &quot;&quot;, copyListener, null);</span>
<a href="#l9.14"></a><span id="l9.14">   return true;</span>
<a href="#l9.15"></a><span id="l9.15"> }</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> var hdr;</span>
<a href="#l9.18"></a><span id="l9.18"> var copyListener = </span>
<a href="#l9.19"></a><span id="l9.19"> {</span>
<a href="#l9.20"></a><span id="l9.20">   OnStartCopy: function() {},</span>
<a href="#l9.21"></a><span id="l9.21">   OnProgress: function(aProgress, aProgressMax) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchTag.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchTag.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -339,17 +339,17 @@ function run_test()</span>
<a href="#l10.4"></a><span id="l10.4">     SetMessageId: function(aMessageId) {},</span>
<a href="#l10.5"></a><span id="l10.5">     OnStopCopy: function(aStatus) { testKeywordSearch();}</span>
<a href="#l10.6"></a><span id="l10.6">   };</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   // Get a message into the local filestore. function testKeywordSearch() continues the testing after the copy.</span>
<a href="#l10.9"></a><span id="l10.9">   var bugmail1 = do_get_file(&quot;../mailnews/test/data/bugmail1&quot;);</span>
<a href="#l10.10"></a><span id="l10.10">   do_test_pending();</span>
<a href="#l10.11"></a><span id="l10.11">   copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-                              copyListener, null);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+                              &quot;&quot;, copyListener, null);</span>
<a href="#l10.14"></a><span id="l10.14"> }</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l10.17"></a><span id="l10.17"> var testObject;</span>
<a href="#l10.18"></a><span id="l10.18"> function testKeywordSearch()</span>
<a href="#l10.19"></a><span id="l10.19"> {</span>
<a href="#l10.20"></a><span id="l10.20">   var test = Tests.shift();</span>
<a href="#l10.21"></a><span id="l10.21">   if (test)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4045,16 +4045,17 @@ nsMsgDBFolder::CopyFolder(nsIMsgFolder* </span>
<a href="#l11.4"></a><span id="l11.4">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.5"></a><span id="l11.5"> }</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> NS_IMETHODIMP</span>
<a href="#l11.8"></a><span id="l11.8"> nsMsgDBFolder::CopyFileMessage(nsIFile* aFile,</span>
<a href="#l11.9"></a><span id="l11.9">                              nsIMsgDBHdr* messageToReplace,</span>
<a href="#l11.10"></a><span id="l11.10">                              PRBool isDraftOrTemplate,</span>
<a href="#l11.11"></a><span id="l11.11">                              PRUint32 aNewMsgFlags,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+                             const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l11.13"></a><span id="l11.13">                              nsIMsgWindow *window,</span>
<a href="#l11.14"></a><span id="l11.14">                              nsIMsgCopyServiceListener* listener)</span>
<a href="#l11.15"></a><span id="l11.15"> {</span>
<a href="#l11.16"></a><span id="l11.16">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.17"></a><span id="l11.17"> }</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> NS_IMETHODIMP nsMsgDBFolder::CopyDataToOutputStreamForAppend(nsIInputStream *aInStream,</span>
<a href="#l11.20"></a><span id="l11.20">                      PRInt32 aLength, nsIOutputStream *aOutputStream)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -302,17 +302,18 @@ nsMsgCopy::DoCopy(nsIFile *aDiskFile, ns</span>
<a href="#l12.4"></a><span id="l12.4">             copyListener-&gt;mCopyInProgress = PR_TRUE;</span>
<a href="#l12.5"></a><span id="l12.5">             NS_GetCurrentThread(getter_AddRefs(thread));</span>
<a href="#l12.6"></a><span id="l12.6">         }</span>
<a href="#l12.7"></a><span id="l12.7">     }</span>
<a href="#l12.8"></a><span id="l12.8">     nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.9"></a><span id="l12.9">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">     rv = copyService-&gt;CopyFileMessage(aDiskFile, dstFolder, aMsgToReplace,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                                      aIsDraft, MSG_FLAG_READ, copyListener, msgWindow);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+                                      aIsDraft, MSG_FLAG_READ, EmptyCString(),</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+                                      copyListener, msgWindow);</span>
<a href="#l12.15"></a><span id="l12.15">     // copyListener-&gt;mCopyInProgress can only be set when we are in the</span>
<a href="#l12.16"></a><span id="l12.16">     // middle of the shutdown process</span>
<a href="#l12.17"></a><span id="l12.17">     while (copyListener-&gt;mCopyInProgress)</span>
<a href="#l12.18"></a><span id="l12.18">     {</span>
<a href="#l12.19"></a><span id="l12.19">         PR_CEnterMonitor(copyListener);</span>
<a href="#l12.20"></a><span id="l12.20">         PR_CWait(copyListener, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l12.21"></a><span id="l12.21">         PR_CExitMonitor(copyListener);</span>
<a href="#l12.22"></a><span id="l12.22">         if (thread)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -4287,38 +4287,42 @@ nsImapMailFolder::SetImageCacheSessionFo</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> NS_IMETHODIMP nsImapMailFolder::GetCurMoveCopyMessageInfo(nsIImapUrl *runningUrl, PRTime *aDate, char **aKeywords, PRUint32 *aResult)</span>
<a href="#l13.6"></a><span id="l13.6"> {</span>
<a href="#l13.7"></a><span id="l13.7">   nsCOMPtr &lt;nsISupports&gt; copyState;</span>
<a href="#l13.8"></a><span id="l13.8">   runningUrl-&gt;GetCopyState(getter_AddRefs(copyState));</span>
<a href="#l13.9"></a><span id="l13.9">   if (copyState)</span>
<a href="#l13.10"></a><span id="l13.10">   {</span>
<a href="#l13.11"></a><span id="l13.11">     nsCOMPtr&lt;nsImapMailCopyState&gt; mailCopyState = do_QueryInterface(copyState);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    PRUint32 supportedFlags = 0;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    GetSupportedUserFlags(&amp;supportedFlags);</span>
<a href="#l13.14"></a><span id="l13.14">     if (mailCopyState &amp;&amp; mailCopyState-&gt;m_message)</span>
<a href="#l13.15"></a><span id="l13.15">     {</span>
<a href="#l13.16"></a><span id="l13.16">       nsMsgLabelValue label;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-      PRUint32 supportedFlags = 0;</span>
<a href="#l13.18"></a><span id="l13.18">       mailCopyState-&gt;m_message-&gt;GetFlags(aResult);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-      GetSupportedUserFlags(&amp;supportedFlags);</span>
<a href="#l13.20"></a><span id="l13.20">       if (supportedFlags &amp; (kImapMsgSupportUserFlag | kImapMsgLabelFlags))</span>
<a href="#l13.21"></a><span id="l13.21">       {</span>
<a href="#l13.22"></a><span id="l13.22">         mailCopyState-&gt;m_message-&gt;GetLabel(&amp;label);</span>
<a href="#l13.23"></a><span id="l13.23">         if (label != 0)</span>
<a href="#l13.24"></a><span id="l13.24">           *aResult |= label &lt;&lt; 25;</span>
<a href="#l13.25"></a><span id="l13.25">       }</span>
<a href="#l13.26"></a><span id="l13.26">       if (aDate)</span>
<a href="#l13.27"></a><span id="l13.27">         mailCopyState-&gt;m_message-&gt;GetDate(aDate);</span>
<a href="#l13.28"></a><span id="l13.28">       if (aKeywords &amp;&amp; (supportedFlags &amp; (kImapMsgSupportUserFlag)))</span>
<a href="#l13.29"></a><span id="l13.29">         mailCopyState-&gt;m_message-&gt;GetStringProperty(&quot;keywords&quot;, aKeywords);</span>
<a href="#l13.30"></a><span id="l13.30">     }</span>
<a href="#l13.31"></a><span id="l13.31">     // if we don't have a source header, and it's not the drafts folder,</span>
<a href="#l13.32"></a><span id="l13.32">     // then mark the message read, since it must be an append to the</span>
<a href="#l13.33"></a><span id="l13.33">     // fcc or templates folder.</span>
<a href="#l13.34"></a><span id="l13.34">     else if (mailCopyState)</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    {</span>
<a href="#l13.36"></a><span id="l13.36">       *aResult = mailCopyState-&gt;m_newMsgFlags;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+      if (aKeywords  &amp;&amp; (supportedFlags &amp; kImapMsgSupportUserFlag))</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+        *aKeywords = ToNewCString(mailCopyState-&gt;m_newMsgKeywords);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    }</span>
<a href="#l13.40"></a><span id="l13.40">   }</span>
<a href="#l13.41"></a><span id="l13.41">   return NS_OK;</span>
<a href="#l13.42"></a><span id="l13.42"> }</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44"> NS_IMETHODIMP nsImapMailFolder::OnStartRequest(nsIRequest *request, nsISupports *ctxt)</span>
<a href="#l13.45"></a><span id="l13.45"> {</span>
<a href="#l13.46"></a><span id="l13.46">   return NS_OK;</span>
<a href="#l13.47"></a><span id="l13.47"> }</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineat">@@ -5888,17 +5892,17 @@ nsImapMailFolder::CopyMessagesWithStream</span>
<a href="#l13.49"></a><span id="l13.49">                                 PRBool allowUndo)</span>
<a href="#l13.50"></a><span id="l13.50"> {</span>
<a href="#l13.51"></a><span id="l13.51">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l13.52"></a><span id="l13.52">   NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l13.53"></a><span id="l13.53">   nsresult rv;</span>
<a href="#l13.54"></a><span id="l13.54">   nsCOMPtr&lt;nsISupports&gt; aSupport(do_QueryInterface(srcFolder, &amp;rv));</span>
<a href="#l13.55"></a><span id="l13.55">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.56"></a><span id="l13.56">   rv = InitCopyState(aSupport, messages, isMove, PR_FALSE, isCrossServerOp,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    /* new message flags, not used */0, listener, msgWindow, allowUndo);</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+                    0, EmptyCString(), listener, msgWindow, allowUndo);</span>
<a href="#l13.59"></a><span id="l13.59">   if(NS_FAILED(rv))</span>
<a href="#l13.60"></a><span id="l13.60">     return rv;</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62">   m_copyState-&gt;m_streamCopy = PR_TRUE;</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64">   // ** jt - needs to create server to server move/copy undo msg txn</span>
<a href="#l13.65"></a><span id="l13.65">   if (m_copyState-&gt;m_allowUndo)</span>
<a href="#l13.66"></a><span id="l13.66">   {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineat">@@ -6515,17 +6519,17 @@ nsImapMailFolder::CopyMessages(nsIMsgFol</span>
<a href="#l13.68"></a><span id="l13.68">     goto done;</span>
<a href="#l13.69"></a><span id="l13.69">   }</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71">   rv = BuildIdsAndKeyArray(messages, messageIds, srcKeyArray);</span>
<a href="#l13.72"></a><span id="l13.72">   if(NS_FAILED(rv)) goto done;</span>
<a href="#l13.73"></a><span id="l13.73"> </span>
<a href="#l13.74"></a><span id="l13.74">   rv = QueryInterface(NS_GET_IID(nsIUrlListener), getter_AddRefs(urlListener));</span>
<a href="#l13.75"></a><span id="l13.75">   rv = InitCopyState(srcSupport, messages, isMove, PR_TRUE, PR_FALSE,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-    /* newMsgFlags, not used */0, listener, msgWindow, allowUndo);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+                     0, EmptyCString(), listener, msgWindow, allowUndo);</span>
<a href="#l13.78"></a><span id="l13.78">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">   m_copyState-&gt;m_curIndex = m_copyState-&gt;m_totalCount;</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82">   if (isMove)</span>
<a href="#l13.83"></a><span id="l13.83">     srcFolder-&gt;EnableNotifications(allMessageCountNotifications, PR_FALSE, PR_TRUE/* dbBatching*/);  //disable message count notification</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">   copySupport = do_QueryInterface(m_copyState);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineat">@@ -6912,16 +6916,17 @@ nsImapMailFolder::CopyFolder(nsIMsgFolde</span>
<a href="#l13.87"></a><span id="l13.87">   return rv;</span>
<a href="#l13.88"></a><span id="l13.88"> }</span>
<a href="#l13.89"></a><span id="l13.89"> </span>
<a href="#l13.90"></a><span id="l13.90"> NS_IMETHODIMP</span>
<a href="#l13.91"></a><span id="l13.91"> nsImapMailFolder::CopyFileMessage(nsIFile* file,</span>
<a href="#l13.92"></a><span id="l13.92">                                   nsIMsgDBHdr* msgToReplace,</span>
<a href="#l13.93"></a><span id="l13.93">                                   PRBool isDraftOrTemplate,</span>
<a href="#l13.94"></a><span id="l13.94">                                   PRUint32 aNewMsgFlags,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+                                  const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l13.96"></a><span id="l13.96">                                   nsIMsgWindow *msgWindow,</span>
<a href="#l13.97"></a><span id="l13.97">                                   nsIMsgCopyServiceListener* listener)</span>
<a href="#l13.98"></a><span id="l13.98"> {</span>
<a href="#l13.99"></a><span id="l13.99">     nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l13.100"></a><span id="l13.100">     nsMsgKey key = 0xffffffff;</span>
<a href="#l13.101"></a><span id="l13.101">     nsCAutoString messageId;</span>
<a href="#l13.102"></a><span id="l13.102">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l13.103"></a><span id="l13.103">     nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineat">@@ -6939,22 +6944,22 @@ nsImapMailFolder::CopyFileMessage(nsIFil</span>
<a href="#l13.105"></a><span id="l13.105">     if (msgToReplace)</span>
<a href="#l13.106"></a><span id="l13.106">     {</span>
<a href="#l13.107"></a><span id="l13.107">         rv = msgToReplace-&gt;GetMessageKey(&amp;key);</span>
<a href="#l13.108"></a><span id="l13.108">         if (NS_SUCCEEDED(rv))</span>
<a href="#l13.109"></a><span id="l13.109">             messageId.AppendInt((PRInt32) key);</span>
<a href="#l13.110"></a><span id="l13.110">     }</span>
<a href="#l13.111"></a><span id="l13.111"> </span>
<a href="#l13.112"></a><span id="l13.112">     rv = InitCopyState(srcSupport, messages, PR_FALSE, isDraftOrTemplate,</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-                       PR_FALSE, aNewMsgFlags, listener, msgWindow, PR_FALSE);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+                       PR_FALSE, aNewMsgFlags, aNewMsgKeywords, listener, </span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+                       msgWindow, PR_FALSE);</span>
<a href="#l13.116"></a><span id="l13.116">     if (NS_FAILED(rv))</span>
<a href="#l13.117"></a><span id="l13.117">       return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l13.118"></a><span id="l13.118"> </span>
<a href="#l13.119"></a><span id="l13.119">     m_copyState-&gt;m_streamCopy = PR_TRUE;</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-</span>
<a href="#l13.121"></a><span id="l13.121">     nsCOMPtr&lt;nsISupports&gt; copySupport;</span>
<a href="#l13.122"></a><span id="l13.122">     if( m_copyState )</span>
<a href="#l13.123"></a><span id="l13.123">       copySupport = do_QueryInterface(m_copyState);</span>
<a href="#l13.124"></a><span id="l13.124">     if (!isDraftOrTemplate)</span>
<a href="#l13.125"></a><span id="l13.125">       m_copyState-&gt;m_totalCount = 1;</span>
<a href="#l13.126"></a><span id="l13.126">     rv = imapService-&gt;AppendMessageFromFile(m_thread, file, this,</span>
<a href="#l13.127"></a><span id="l13.127">                                             messageId,</span>
<a href="#l13.128"></a><span id="l13.128">                                             PR_TRUE, isDraftOrTemplate,</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineat">@@ -7068,16 +7073,17 @@ NS_IMPL_THREADSAFE_ISUPPORTS1(nsImapMail</span>
<a href="#l13.130"></a><span id="l13.130"> </span>
<a href="#l13.131"></a><span id="l13.131"> nsresult</span>
<a href="#l13.132"></a><span id="l13.132"> nsImapMailFolder::InitCopyState(nsISupports* srcSupport,</span>
<a href="#l13.133"></a><span id="l13.133">                                 nsIArray* messages,</span>
<a href="#l13.134"></a><span id="l13.134">                                 PRBool isMove,</span>
<a href="#l13.135"></a><span id="l13.135">                                 PRBool selectedState,</span>
<a href="#l13.136"></a><span id="l13.136">                                 PRBool acrossServers,</span>
<a href="#l13.137"></a><span id="l13.137">                                 PRUint32 newMsgFlags,</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+                                const nsACString &amp;newMsgKeywords,</span>
<a href="#l13.139"></a><span id="l13.139">                                 nsIMsgCopyServiceListener* listener,</span>
<a href="#l13.140"></a><span id="l13.140">                                 nsIMsgWindow *msgWindow,</span>
<a href="#l13.141"></a><span id="l13.141">                                 PRBool allowUndo)</span>
<a href="#l13.142"></a><span id="l13.142"> {</span>
<a href="#l13.143"></a><span id="l13.143">   NS_ENSURE_ARG_POINTER(srcSupport);</span>
<a href="#l13.144"></a><span id="l13.144">   NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l13.145"></a><span id="l13.145">   NS_ENSURE_TRUE(!m_copyState, NS_ERROR_FAILURE);</span>
<a href="#l13.146"></a><span id="l13.146">   nsresult rv;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineat">@@ -7127,16 +7133,17 @@ nsImapMailFolder::InitCopyState(nsISuppo</span>
<a href="#l13.148"></a><span id="l13.148">       message-&gt;GetFlags(&amp;flags);</span>
<a href="#l13.149"></a><span id="l13.149">       isRead = flags &amp; MSG_FLAG_READ;</span>
<a href="#l13.150"></a><span id="l13.150">     }</span>
<a href="#l13.151"></a><span id="l13.151">     m_copyState-&gt;m_unreadCount = (isRead) ? 0 : 1;</span>
<a href="#l13.152"></a><span id="l13.152">   }</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154">   m_copyState-&gt;m_isMove = isMove;</span>
<a href="#l13.155"></a><span id="l13.155">   m_copyState-&gt;m_newMsgFlags = newMsgFlags;</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+  m_copyState-&gt;m_newMsgKeywords = newMsgKeywords;</span>
<a href="#l13.157"></a><span id="l13.157">   m_copyState-&gt;m_allowUndo = allowUndo;</span>
<a href="#l13.158"></a><span id="l13.158">   m_copyState-&gt;m_selectedState = selectedState;</span>
<a href="#l13.159"></a><span id="l13.159">   m_copyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l13.160"></a><span id="l13.160">   if (listener)</span>
<a href="#l13.161"></a><span id="l13.161">     m_copyState-&gt;m_listener = do_QueryInterface(listener, &amp;rv);</span>
<a href="#l13.162"></a><span id="l13.162">   return rv;</span>
<a href="#l13.163"></a><span id="l13.163"> }</span>
<a href="#l13.164"></a><span id="l13.164"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -109,16 +109,17 @@ public:</span>
<a href="#l14.4"></a><span id="l14.4">     PRBool m_streamCopy;</span>
<a href="#l14.5"></a><span id="l14.5">     char *m_dataBuffer; // temporary buffer for this copy operation</span>
<a href="#l14.6"></a><span id="l14.6">     nsCOMPtr&lt;nsIOutputStream&gt; m_msgFileStream;         // temporary file (processed mail)</span>
<a href="#l14.7"></a><span id="l14.7">     PRUint32 m_dataBufferSize;</span>
<a href="#l14.8"></a><span id="l14.8">     PRUint32 m_leftOver;</span>
<a href="#l14.9"></a><span id="l14.9">     PRBool m_allowUndo;</span>
<a href="#l14.10"></a><span id="l14.10">     PRBool m_eatLF;</span>
<a href="#l14.11"></a><span id="l14.11">     PRBool m_newMsgFlags; // only used if there's no m_message</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    nsCString m_newMsgKeywords; // ditto </span>
<a href="#l14.13"></a><span id="l14.13"> };</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> NS_DEFINE_STATIC_IID_ACCESSOR(nsImapMailCopyState, NS_IMAPMAILCOPYSTATE_IID)</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> // ACLs for this folder.</span>
<a href="#l14.18"></a><span id="l14.18"> // Generally, we will try to always query this class when performing</span>
<a href="#l14.19"></a><span id="l14.19"> // an operation on the folder.</span>
<a href="#l14.20"></a><span id="l14.20"> // If the server doesn't support ACLs, none of this data will be filled in.</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -286,16 +287,17 @@ public:</span>
<a href="#l14.22"></a><span id="l14.22">                           nsIMsgCopyServiceListener* listener, PRBool isFolder,</span>
<a href="#l14.23"></a><span id="l14.23">                           PRBool allowUndo);</span>
<a href="#l14.24"></a><span id="l14.24">   NS_IMETHOD CopyFolder(nsIMsgFolder *srcFolder, PRBool isMove, nsIMsgWindow *msgWindow,</span>
<a href="#l14.25"></a><span id="l14.25">                         nsIMsgCopyServiceListener* listener);</span>
<a href="#l14.26"></a><span id="l14.26">   NS_IMETHOD CopyFileMessage(nsIFile* file,</span>
<a href="#l14.27"></a><span id="l14.27">                               nsIMsgDBHdr* msgToReplace,</span>
<a href="#l14.28"></a><span id="l14.28">                               PRBool isDraftOrTemplate,</span>
<a href="#l14.29"></a><span id="l14.29">                               PRUint32 aNewMsgFlags,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+                              const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l14.31"></a><span id="l14.31">                               nsIMsgWindow *msgWindow,</span>
<a href="#l14.32"></a><span id="l14.32">                               nsIMsgCopyServiceListener* listener);</span>
<a href="#l14.33"></a><span id="l14.33">   NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow, nsIUrlListener *aListener);</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35">   NS_IMETHOD GetFilePath(nsILocalFile** aPathName);</span>
<a href="#l14.36"></a><span id="l14.36">   NS_IMETHOD SetFilePath(nsILocalFile * aPath);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">   NS_IMETHOD Shutdown(PRBool shutdownChildren);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineat">@@ -400,16 +402,17 @@ protected:</span>
<a href="#l14.40"></a><span id="l14.40">   nsresult CopyStreamMessage(nsIMsgDBHdr* message, nsIMsgFolder* dstFolder,</span>
<a href="#l14.41"></a><span id="l14.41">                             nsIMsgWindow *msgWindow, PRBool isMove);</span>
<a href="#l14.42"></a><span id="l14.42">   nsresult InitCopyState(nsISupports* srcSupport,</span>
<a href="#l14.43"></a><span id="l14.43">                           nsIArray* messages,</span>
<a href="#l14.44"></a><span id="l14.44">                           PRBool isMove,</span>
<a href="#l14.45"></a><span id="l14.45">                           PRBool selectedState,</span>
<a href="#l14.46"></a><span id="l14.46">                           PRBool acrossServers,</span>
<a href="#l14.47"></a><span id="l14.47">                           PRUint32 newMsgFlags,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                          const nsACString &amp;newMsgKeywords,</span>
<a href="#l14.49"></a><span id="l14.49">                           nsIMsgCopyServiceListener* listener,</span>
<a href="#l14.50"></a><span id="l14.50">                           nsIMsgWindow *msgWindow,</span>
<a href="#l14.51"></a><span id="l14.51">                           PRBool allowUndo);</span>
<a href="#l14.52"></a><span id="l14.52">   nsresult OnCopyCompleted(nsISupports *srcSupport, nsresult exitCode);</span>
<a href="#l14.53"></a><span id="l14.53">   nsresult BuildIdsAndKeyArray(nsIArray* messages, nsCString&amp; msgIds, nsTArray&lt;nsMsgKey&gt;&amp; keyArray);</span>
<a href="#l14.54"></a><span id="l14.54">   nsresult GetMoveCoalescer();</span>
<a href="#l14.55"></a><span id="l14.55">   nsresult PlaybackCoalescedOperations();</span>
<a href="#l14.56"></a><span id="l14.56">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -458,16 +458,17 @@ nsImapOfflineSync::ProcessAppendMsgOpera</span>
<a href="#l15.4"></a><span id="l15.4">                 {</span>
<a href="#l15.5"></a><span id="l15.5">                   m_curTempFile = do_QueryInterface(tmpFile);</span>
<a href="#l15.6"></a><span id="l15.6">                   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l15.7"></a><span id="l15.7">                   if (copyService)</span>
<a href="#l15.8"></a><span id="l15.8">                     rv = copyService-&gt;CopyFileMessage(tmpFile, destFolder,</span>
<a href="#l15.9"></a><span id="l15.9">                     /* nsIMsgDBHdr* msgToReplace */ nsnull,</span>
<a href="#l15.10"></a><span id="l15.10">                     PR_TRUE /* isDraftOrTemplate */,</span>
<a href="#l15.11"></a><span id="l15.11">                     0, // new msg flags - are there interesting flags here?</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+                    EmptyCString(), /* are there keywords we should get? */</span>
<a href="#l15.13"></a><span id="l15.13">                       this,</span>
<a href="#l15.14"></a><span id="l15.14">                       m_window);</span>
<a href="#l15.15"></a><span id="l15.15">                 }</span>
<a href="#l15.16"></a><span id="l15.16">                 else</span>
<a href="#l15.17"></a><span id="l15.17">                   tmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l15.18"></a><span id="l15.18">               }</span>
<a href="#l15.19"></a><span id="l15.19">               currentOp-&gt;SetPlayingBack(PR_TRUE);</span>
<a href="#l15.20"></a><span id="l15.20">               m_currentOpsToClear.AppendObject(currentOp);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1515,31 +1515,38 @@ NS_IMETHODIMP nsMsgLocalMailFolder::OnAn</span>
<a href="#l16.4"></a><span id="l16.4"> }</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> NS_IMETHODIMP</span>
<a href="#l16.7"></a><span id="l16.7"> nsMsgLocalMailFolder::OnCopyCompleted(nsISupports *srcSupport, PRBool moveCopySucceeded)</span>
<a href="#l16.8"></a><span id="l16.8"> {</span>
<a href="#l16.9"></a><span id="l16.9">   if (mCopyState &amp;&amp; mCopyState-&gt;m_notifyFolderLoaded)</span>
<a href="#l16.10"></a><span id="l16.10">     NotifyFolderEvent(mFolderLoadedAtom);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  delete mCopyState;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  mCopyState = nsnull;</span>
<a href="#l16.14"></a><span id="l16.14">   (void) RefreshSizeOnDisk();</span>
<a href="#l16.15"></a><span id="l16.15">   // we are the destination folder for a move/copy</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  PRBool haveSemaphore;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  nsresult rv = TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this), &amp;haveSemaphore);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; haveSemaphore)</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+    ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+  if (mCopyState &amp;&amp; !mCopyState-&gt;m_newMsgKeywords.IsEmpty() &amp;&amp; mCopyState-&gt;newHdr)</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  {</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+    NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+    messageArray-&gt;AppendElement(mCopyState-&gt;newHdr, PR_FALSE);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+    AddKeywordsToMessages(messageArray, mCopyState-&gt;m_newMsgKeywords);</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  }</span>
<a href="#l16.28"></a><span id="l16.28">   if (moveCopySucceeded &amp;&amp; mDatabase)</span>
<a href="#l16.29"></a><span id="l16.29">   {</span>
<a href="#l16.30"></a><span id="l16.30">     mDatabase-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l16.31"></a><span id="l16.31">     (void) CloseDBIfFolderNotOpen();</span>
<a href="#l16.32"></a><span id="l16.32">   }</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  PRBool haveSemaphore;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-  nsresult rv = TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this), &amp;haveSemaphore);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; haveSemaphore)</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-    ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  delete mCopyState;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  mCopyState = nsnull;</span>
<a href="#l16.41"></a><span id="l16.41">   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l16.42"></a><span id="l16.42">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.43"></a><span id="l16.43">   return copyService-&gt;NotifyCompletion(srcSupport, this, moveCopySucceeded ? NS_OK : NS_ERROR_FAILURE);</span>
<a href="#l16.44"></a><span id="l16.44"> }</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46"> nsresult</span>
<a href="#l16.47"></a><span id="l16.47"> nsMsgLocalMailFolder::SortMessagesBasedOnKey(nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray, nsIMsgFolder *srcFolder, nsIMutableArray* messages)</span>
<a href="#l16.48"></a><span id="l16.48"> {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineat">@@ -2052,36 +2059,41 @@ nsMsgLocalMailFolder::CopyFolderLocal(ns</span>
<a href="#l16.50"></a><span id="l16.50">       }</span>
<a href="#l16.51"></a><span id="l16.51">       return NS_ERROR_FAILURE;</span>
<a href="#l16.52"></a><span id="l16.52">     }</span>
<a href="#l16.53"></a><span id="l16.53">   }</span>
<a href="#l16.54"></a><span id="l16.54">   return NS_OK;</span>
<a href="#l16.55"></a><span id="l16.55"> }</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57"> NS_IMETHODIMP</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-nsMsgLocalMailFolder::CopyFileMessage(nsIFile* aFile, nsIMsgDBHdr*</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-                                      msgToReplace, PRBool isDraftOrTemplate,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+nsMsgLocalMailFolder::CopyFileMessage(nsIFile* aFile, </span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+                                      nsIMsgDBHdr *msgToReplace,</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+                                      PRBool isDraftOrTemplate,</span>
<a href="#l16.63"></a><span id="l16.63">                                       PRUint32 newMsgFlags,</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+                                      const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l16.65"></a><span id="l16.65">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l16.66"></a><span id="l16.66">                                       nsIMsgCopyServiceListener* listener)</span>
<a href="#l16.67"></a><span id="l16.67"> {</span>
<a href="#l16.68"></a><span id="l16.68">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l16.69"></a><span id="l16.69">   nsParseMailMessageState* parseMsgState = nsnull;</span>
<a href="#l16.70"></a><span id="l16.70">   PRUint32 fileSize = 0;</span>
<a href="#l16.71"></a><span id="l16.71">   nsCOMPtr&lt;nsISupports&gt; fileSupport(do_QueryInterface(aFile, &amp;rv));</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73">   nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l16.74"></a><span id="l16.74"> </span>
<a href="#l16.75"></a><span id="l16.75">   if (msgToReplace)</span>
<a href="#l16.76"></a><span id="l16.76">     messages-&gt;AppendElement(msgToReplace, PR_FALSE);</span>
<a href="#l16.77"></a><span id="l16.77"> </span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-  rv = InitCopyState(fileSupport, messages, msgToReplace ? PR_TRUE:PR_FALSE,</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  rv = InitCopyState(fileSupport, messages, msgToReplace ? PR_TRUE : PR_FALSE,</span>
<a href="#l16.80"></a><span id="l16.80">                      listener, msgWindow, PR_FALSE, PR_FALSE);</span>
<a href="#l16.81"></a><span id="l16.81">   if (NS_SUCCEEDED(rv))</span>
<a href="#l16.82"></a><span id="l16.82">   {</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+    if (mCopyState)</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+      mCopyState-&gt;m_newMsgKeywords = aNewMsgKeywords;</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+</span>
<a href="#l16.86"></a><span id="l16.86">     parseMsgState = new nsParseMailMessageState();</span>
<a href="#l16.87"></a><span id="l16.87">     if (parseMsgState)</span>
<a href="#l16.88"></a><span id="l16.88">     {</span>
<a href="#l16.89"></a><span id="l16.89">       nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l16.90"></a><span id="l16.90">       mCopyState-&gt;m_parseMsgState = do_QueryInterface(parseMsgState, &amp;rv);</span>
<a href="#l16.91"></a><span id="l16.91">       GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l16.92"></a><span id="l16.92">       if (msgDb)</span>
<a href="#l16.93"></a><span id="l16.93">         parseMsgState-&gt;SetMailDB(msgDb);</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineat">@@ -2375,19 +2387,20 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l16.95"></a><span id="l16.95">     nsCOMPtr &lt;nsILocalFile&gt; pathFile;</span>
<a href="#l16.96"></a><span id="l16.96">     rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98">     if (NS_SUCCEEDED(rv) &amp;&amp; pathFile &amp;&amp; mCopyState-&gt;m_curDstKey != nsMsgKey_None)</span>
<a href="#l16.99"></a><span id="l16.99">       pathFile-&gt;SetFileSize(mCopyState-&gt;m_curDstKey);</span>
<a href="#l16.100"></a><span id="l16.100"> </span>
<a href="#l16.101"></a><span id="l16.101">     if (!mCopyState-&gt;m_isMove)</span>
<a href="#l16.102"></a><span id="l16.102">     {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-      /* passing PR_TRUE because the messages that have been successfully copied have their corresponding</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-                     hdrs in place. The message that has failed has been truncated so the msf file and berkeley mailbox</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-                    are in sync */</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+      // passing PR_TRUE because the messages that have been successfully </span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+      // copied have their corresponding hdrs in place. The message that has </span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+      // failed has been truncated so the msf file and berkeley mailbox </span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+      // are in sync.</span>
<a href="#l16.110"></a><span id="l16.110">       (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l16.111"></a><span id="l16.111">       // enable the dest folder</span>
<a href="#l16.112"></a><span id="l16.112">       EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l16.113"></a><span id="l16.113">     }</span>
<a href="#l16.114"></a><span id="l16.114">     return NS_OK;</span>
<a href="#l16.115"></a><span id="l16.115">   }</span>
<a href="#l16.116"></a><span id="l16.116"> </span>
<a href="#l16.117"></a><span id="l16.117">   nsRefPtr&lt;nsLocalMoveCopyMsgTxn&gt; localUndoTxn;</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineat">@@ -2465,16 +2478,21 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l16.119"></a><span id="l16.119">   if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l16.120"></a><span id="l16.120">   {</span>
<a href="#l16.121"></a><span id="l16.121">     nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l16.122"></a><span id="l16.122">     mCopyState-&gt;m_parseMsgState-&gt;FinishHeader();</span>
<a href="#l16.123"></a><span id="l16.123">     GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l16.124"></a><span id="l16.124">     if (msgDb)</span>
<a href="#l16.125"></a><span id="l16.125">     {</span>
<a href="#l16.126"></a><span id="l16.126">       nsresult result = mCopyState-&gt;m_parseMsgState-&gt;GetNewMsgHdr(getter_AddRefs(newHdr));</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+      // we need to copy newHdr because mCopyState will get cleared </span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+      // in OnCopyCompleted, but we need OnCopyCompleted to know about</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+      // the newHdr, via mCopyState. And we send a notification about newHdr</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+      // after OnCopyCompleted.</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+      mCopyState-&gt;newHdr = newHdr;</span>
<a href="#l16.132"></a><span id="l16.132">       if (NS_SUCCEEDED(result) &amp;&amp; newHdr)</span>
<a href="#l16.133"></a><span id="l16.133">       {</span>
<a href="#l16.134"></a><span id="l16.134">         // need to copy junk score and label from mCopyState-&gt;m_message to newHdr.</span>
<a href="#l16.135"></a><span id="l16.135">         if (mCopyState-&gt;m_message)</span>
<a href="#l16.136"></a><span id="l16.136">         {</span>
<a href="#l16.137"></a><span id="l16.137">           // deal with propagating the new flag on an imap to local folder filter action</span>
<a href="#l16.138"></a><span id="l16.138">           PRUint32 msgFlags;</span>
<a href="#l16.139"></a><span id="l16.139">           mCopyState-&gt;m_message-&gt;GetFlags(&amp;msgFlags);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -88,16 +88,18 @@ struct nsLocalMailCopyState</span>
<a href="#l17.4"></a><span id="l17.4">   PRPackedBool m_isMove;</span>
<a href="#l17.5"></a><span id="l17.5">   PRPackedBool m_isFolder;   // isFolder move/copy</span>
<a href="#l17.6"></a><span id="l17.6">   PRPackedBool m_dummyEnvelopeNeeded;</span>
<a href="#l17.7"></a><span id="l17.7">   PRPackedBool m_copyingMultipleMessages;</span>
<a href="#l17.8"></a><span id="l17.8">   PRPackedBool m_fromLineSeen;</span>
<a href="#l17.9"></a><span id="l17.9">   PRPackedBool m_allowUndo;</span>
<a href="#l17.10"></a><span id="l17.10">   PRPackedBool m_writeFailed;</span>
<a href="#l17.11"></a><span id="l17.11">   PRPackedBool m_notifyFolderLoaded;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  nsCString    m_newMsgKeywords;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l17.14"></a><span id="l17.14"> };</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> struct nsLocalFolderScanState</span>
<a href="#l17.17"></a><span id="l17.17"> {</span>
<a href="#l17.18"></a><span id="l17.18">   nsLocalFolderScanState();</span>
<a href="#l17.19"></a><span id="l17.19">   ~nsLocalFolderScanState();</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">   nsCOMPtr&lt;nsILocalFile&gt; m_localFile;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -170,16 +172,17 @@ public:</span>
<a href="#l17.23"></a><span id="l17.23">   NS_IMETHOD CopyMessages(nsIMsgFolder *srcFolder, nsIArray* messages,</span>
<a href="#l17.24"></a><span id="l17.24">                           PRBool isMove, nsIMsgWindow *msgWindow,</span>
<a href="#l17.25"></a><span id="l17.25">                           nsIMsgCopyServiceListener* listener, PRBool isFolder, PRBool allowUndo);</span>
<a href="#l17.26"></a><span id="l17.26">   NS_IMETHOD CopyFolder(nsIMsgFolder *srcFolder, PRBool isMoveFolder, nsIMsgWindow *msgWindow,</span>
<a href="#l17.27"></a><span id="l17.27">                           nsIMsgCopyServiceListener* listener);</span>
<a href="#l17.28"></a><span id="l17.28">   NS_IMETHOD CopyFileMessage(nsIFile* aFile, nsIMsgDBHdr* msgToReplace,</span>
<a href="#l17.29"></a><span id="l17.29">                              PRBool isDraftOrTemplate, </span>
<a href="#l17.30"></a><span id="l17.30">                              PRUint32 newMsgFlags,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+                             const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l17.32"></a><span id="l17.32">                              nsIMsgWindow *msgWindow,</span>
<a href="#l17.33"></a><span id="l17.33">                              nsIMsgCopyServiceListener* listener);</span>
<a href="#l17.34"></a><span id="l17.34">   NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow, nsIUrlListener *aListener);</span>
<a href="#l17.35"></a><span id="l17.35">   NS_IMETHOD NotifyCompactCompleted();</span>
<a href="#l17.36"></a><span id="l17.36">   NS_IMETHOD Shutdown(PRBool shutdownChildren);</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   NS_IMETHOD WriteToFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l17.39"></a><span id="l17.39">   NS_IMETHOD ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,79 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ *</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ *</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ * License.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+ *</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+ *</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+ * David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ *</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+ *</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+ *</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+// Test of setting keywords with CopyFileMessage</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+const bugmail11 = do_get_file(&quot;../mailnews/test/data/bugmail11&quot;);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+                     </span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+// main test</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+var hdrs = [];</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+// tag used with test messages</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+var tag1 = &quot;istag&quot;;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+function run_test()</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+{</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+  // CopyFileMessage is sync in this case, but in case that changes...</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  do_test_pending();</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  // bugmail11 has no keywords.    </span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+  copyService.CopyFileMessage(bugmail11, gLocalInboxFolder, null, false, 0, tag1,</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+                              copyListener, null);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+  return true;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+}</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+// nsIMsgCopyServiceListener implementation</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+var copyListener = </span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+{</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  OnStartCopy: function() {},</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  SetMessageKey: function(aKey)</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  {</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+    hdrs.push(gLocalInboxFolder.GetMessageHeader(aKey));</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  },</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  SetMessageId: function(aMessageId) {},</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+  OnStopCopy: function(aStatus)</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+  {</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+    var copiedMessage = gLocalInboxFolder.GetMessageHeader(hdrs[0]);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+    do_check_eq(copiedMessage.getStringProperty(&quot;keywords&quot;), tag1);    </span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+    do_test_finished();</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  }</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+};</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

