<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27931:7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b" />
<meta property="og:url" content="/comm-central/rev/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b" />
<meta property="og:description" content="Bug 1463266 - remove \n in MOZ_LOG and NS_ERROR. r=me DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">shortlog</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">files</a> |
changeset |
<a href="/comm-central/raw-rev/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">raw</a>  | <a href="/comm-central/archive/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - remove \n in MOZ_LOG and NS_ERROR. r=me DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 13 Oct 2019 00:42:32 +0200</td></tr>

<tr>
 <td>changeset 27931</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b</a></td>
</tr>



<tr>
<td>parent 27930</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2738f47944c5e1ef169777a72805baae12568dc8">2738f47944c5e1ef169777a72805baae12568dc8</a>
</td>
</tr>

<tr>
<td>child 27932</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3d3db48e3d46f1a18cfc5901efa4b29383ab2f94">3d3db48e3d46f1a18cfc5901efa4b29383ab2f94</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">16559</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 15 Oct 2019 08:04:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7d63ed41d20c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&newProject=comm-central&newRevision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&newProject=comm-central&newRevision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&newProject=comm-central&newRevision=7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28me%29&revcount=50">me</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">1463266</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - remove \n in MOZ_LOG and NS_ERROR. r=me DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPProtocolModule.cpp">ldap/xpcom/src/nsLDAPProtocolModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPProtocolModule.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPProtocolModule.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPProtocolModule.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPProtocolModule.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPProtocolModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">ldap/xpcom/src/nsLDAPSecurityGlue.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSyncQuery.cpp">ldap/xpcom/src/nsLDAPSyncQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSyncQuery.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSyncQuery.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSyncQuery.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSyncQuery.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/ldap/xpcom/src/nsLDAPSyncQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/addrbook/src/nsDirPrefs.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/addrbook/src/nsDirPrefs.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/mime/src/nsCMS.cpp">mailnews/mime/src/nsCMS.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/mime/src/nsCMS.cpp">file</a> |
<a href="/comm-central/annotate/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/mime/src/nsCMS.cpp">annotate</a> |
<a href="/comm-central/diff/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/mime/src/nsCMS.cpp">diff</a> |
<a href="/comm-central/comparison/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/mime/src/nsCMS.cpp">comparison</a> |
<a href="/comm-central/log/7d63ed41d20c46fbbc7bce5ed33b30d7a15e924b/mailnews/mime/src/nsCMS.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPProtocolModule.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPProtocolModule.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -90,29 +90,28 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> static nsresult nsLDAPInitialize() {</span>
<a href="#l1.6"></a><span id="l1.6">   // use NSPR under the hood for all networking</span>
<a href="#l1.7"></a><span id="l1.7">   //</span>
<a href="#l1.8"></a><span id="l1.8">   int rv = prldap_install_routines(NULL, 1 /* shared */);</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   if (rv != LDAP_SUCCESS) {</span>
<a href="#l1.11"></a><span id="l1.11">     MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-            (&quot;nsLDAPInitialize(): pr_ldap_install_routines() failed: %s\n&quot;,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+            (&quot;nsLDAPInitialize(): pr_ldap_install_routines() failed: %s&quot;,</span>
<a href="#l1.14"></a><span id="l1.14">              ldap_err2string(rv)));</span>
<a href="#l1.15"></a><span id="l1.15">     return NS_ERROR_FAILURE;</span>
<a href="#l1.16"></a><span id="l1.16">   }</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">   // Never block for more than 10000 milliseconds (ie 10 seconds) doing any</span>
<a href="#l1.19"></a><span id="l1.19">   // sort of I/O operation.</span>
<a href="#l1.20"></a><span id="l1.20">   //</span>
<a href="#l1.21"></a><span id="l1.21">   rv = prldap_set_session_option(0, 0, PRLDAP_OPT_IO_MAX_TIMEOUT, 10000);</span>
<a href="#l1.22"></a><span id="l1.22">   if (rv != LDAP_SUCCESS) {</span>
<a href="#l1.23"></a><span id="l1.23">     MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-            (&quot;nsLDAPInitialize(): error setting PRLDAP_OPT_IO_MAX_TIMEOUT:&quot;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-             &quot; %s\n&quot;,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+            (&quot;nsLDAPInitialize(): error setting PRLDAP_OPT_IO_MAX_TIMEOUT: %s&quot;,</span>
<a href="#l1.27"></a><span id="l1.27">              ldap_err2string(rv)));</span>
<a href="#l1.28"></a><span id="l1.28">     return NS_ERROR_FAILURE;</span>
<a href="#l1.29"></a><span id="l1.29">   }</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">   return NS_OK;</span>
<a href="#l1.32"></a><span id="l1.32"> }</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34"> extern const mozilla::Module kLDAPProtocolModule = {mozilla::Module::kVersion,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPSecurityGlue.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPSecurityGlue.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -53,17 +53,17 @@ nsLDAPSSLClose(int s, struct lextiof_soc</span>
<a href="#l2.4"></a><span id="l2.4">   nsLDAPSSLSocketClosure *socketClosure;</span>
<a href="#l2.5"></a><span id="l2.5">   nsLDAPSSLSessionClosure *sessionClosure;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   // get the socketInfo associated with this socket</span>
<a href="#l2.8"></a><span id="l2.8">   //</span>
<a href="#l2.9"></a><span id="l2.9">   memset(&amp;socketInfo, 0, sizeof(socketInfo));</span>
<a href="#l2.10"></a><span id="l2.10">   socketInfo.soinfo_size = PRLDAP_SOCKETINFO_SIZE;</span>
<a href="#l2.11"></a><span id="l2.11">   if (prldap_get_socket_info(s, socketarg, &amp;socketInfo) != LDAP_SUCCESS) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    NS_ERROR(&quot;nsLDAPSSLClose(): prldap_get_socket_info() failed\n&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    NS_ERROR(&quot;nsLDAPSSLClose(): prldap_get_socket_info() failed&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">     return -1;</span>
<a href="#l2.15"></a><span id="l2.15">   }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   // save off the session closure data in an automatic, since we're going to</span>
<a href="#l2.18"></a><span id="l2.18">   // need to call through it</span>
<a href="#l2.19"></a><span id="l2.19">   //</span>
<a href="#l2.20"></a><span id="l2.20">   socketClosure =</span>
<a href="#l2.21"></a><span id="l2.21">       reinterpret_cast&lt;nsLDAPSSLSocketClosure *&gt;(socketInfo.soinfo_appdata);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -286,17 +286,17 @@ nsresult nsLDAPInstallSSL(LDAP *ld, cons</span>
<a href="#l2.23"></a><span id="l2.23">     nsLDAPSSLFreeSessionClosure(&amp;sessionClosure);</span>
<a href="#l2.24"></a><span id="l2.24">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.25"></a><span id="l2.25">   }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   // Make a copy of the hostname to pass to AddToSocket later</span>
<a href="#l2.28"></a><span id="l2.28">   //</span>
<a href="#l2.29"></a><span id="l2.29">   sessionClosure-&gt;hostname = PL_strdup(aHostName);</span>
<a href="#l2.30"></a><span id="l2.30">   if (!sessionClosure-&gt;hostname) {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    NS_ERROR(&quot;nsLDAPInstallSSL(): PL_strdup failed\n&quot;);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    NS_ERROR(&quot;nsLDAPInstallSSL(): PL_strdup failed&quot;);</span>
<a href="#l2.33"></a><span id="l2.33">     nsLDAPSSLFreeSessionClosure(&amp;sessionClosure);</span>
<a href="#l2.34"></a><span id="l2.34">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.35"></a><span id="l2.35">   }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   // Override functions</span>
<a href="#l2.38"></a><span id="l2.38">   //</span>
<a href="#l2.39"></a><span id="l2.39">   sessionClosure-&gt;realClose = iofns.lextiof_close;</span>
<a href="#l2.40"></a><span id="l2.40">   iofns.lextiof_close = nsLDAPSSLClose;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPSyncQuery.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPSyncQuery.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -159,17 +159,17 @@ nsresult nsLDAPSyncQuery::OnLDAPSearchEn</span>
<a href="#l3.4"></a><span id="l3.4">   for (uint32_t i = 0; i &lt; attributes.Length(); i++) {</span>
<a href="#l3.5"></a><span id="l3.5">     // Get the values of this attribute.</span>
<a href="#l3.6"></a><span id="l3.6">     // XXX better failure handling</span>
<a href="#l3.7"></a><span id="l3.7">     nsTArray&lt;nsString&gt; vals;</span>
<a href="#l3.8"></a><span id="l3.8">     rv = aMessage-&gt;GetValues(&quot;objectClass&quot;, vals);</span>
<a href="#l3.9"></a><span id="l3.9">     if (NS_FAILED(rv)) {</span>
<a href="#l3.10"></a><span id="l3.10">       NS_WARNING(</span>
<a href="#l3.11"></a><span id="l3.11">           &quot;nsLDAPSyncQuery:OnLDAPSearchEntry(): &quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          &quot;aMessage-&gt;GetValues() failed\n&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+          &quot;aMessage-&gt;GetValues() failed&quot;);</span>
<a href="#l3.14"></a><span id="l3.14">       FinishLDAPQuery();</span>
<a href="#l3.15"></a><span id="l3.15">       break;</span>
<a href="#l3.16"></a><span id="l3.16">     }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     // Store all values of this attribute in the mResults.</span>
<a href="#l3.19"></a><span id="l3.19">     for (uint32_t j = 0; j &lt; vals.Length(); j++) {</span>
<a href="#l3.20"></a><span id="l3.20">       mResults.Append(char16_t('\n'));</span>
<a href="#l3.21"></a><span id="l3.21">       mResults.Append(NS_ConvertUTF8toUTF16(attributes[i]));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/migration/src/nsSeamonkeyProfileMigrator.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -617,17 +617,17 @@ void nsSeamonkeyProfileMigrator::ReadBra</span>
<a href="#l4.4"></a><span id="l4.4">         rv = branch-&gt;GetBoolPref(currPref, &amp;prefBranch-&gt;boolValue);</span>
<a href="#l4.5"></a><span id="l4.5">         break;</span>
<a href="#l4.6"></a><span id="l4.6">       case nsIPrefBranch::PREF_INT:</span>
<a href="#l4.7"></a><span id="l4.7">         rv = branch-&gt;GetIntPref(currPref, &amp;prefBranch-&gt;intValue);</span>
<a href="#l4.8"></a><span id="l4.8">         break;</span>
<a href="#l4.9"></a><span id="l4.9">       default:</span>
<a href="#l4.10"></a><span id="l4.10">         NS_WARNING(</span>
<a href="#l4.11"></a><span id="l4.11">             &quot;Invalid Pref Type in &quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            &quot;nsNetscapeProfileMigratorBase::ReadBranch\n&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+            &quot;nsNetscapeProfileMigratorBase::ReadBranch&quot;);</span>
<a href="#l4.14"></a><span id="l4.14">         break;</span>
<a href="#l4.15"></a><span id="l4.15">     }</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">     if (NS_SUCCEEDED(rv)) aPrefs.AppendElement(prefBranch);</span>
<a href="#l4.18"></a><span id="l4.18">   }</span>
<a href="#l4.19"></a><span id="l4.19"> }</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> void nsSeamonkeyProfileMigrator::WriteBranch(const char* branchName,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -651,17 +651,17 @@ void nsSeamonkeyProfileMigrator::WriteBr</span>
<a href="#l4.23"></a><span id="l4.23">         (void)branch-&gt;SetBoolPref(pref-&gt;prefName, pref-&gt;boolValue);</span>
<a href="#l4.24"></a><span id="l4.24">         break;</span>
<a href="#l4.25"></a><span id="l4.25">       case nsIPrefBranch::PREF_INT:</span>
<a href="#l4.26"></a><span id="l4.26">         (void)branch-&gt;SetIntPref(pref-&gt;prefName, pref-&gt;intValue);</span>
<a href="#l4.27"></a><span id="l4.27">         break;</span>
<a href="#l4.28"></a><span id="l4.28">       default:</span>
<a href="#l4.29"></a><span id="l4.29">         NS_WARNING(</span>
<a href="#l4.30"></a><span id="l4.30">             &quot;Invalid Pref Type in &quot;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-            &quot;nsNetscapeProfileMigratorBase::WriteBranch\n&quot;);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+            &quot;nsNetscapeProfileMigratorBase::WriteBranch&quot;);</span>
<a href="#l4.33"></a><span id="l4.33">         break;</span>
<a href="#l4.34"></a><span id="l4.34">     }</span>
<a href="#l4.35"></a><span id="l4.35">     free(pref-&gt;prefName);</span>
<a href="#l4.36"></a><span id="l4.36">     pref-&gt;prefName = nullptr;</span>
<a href="#l4.37"></a><span id="l4.37">     delete pref;</span>
<a href="#l4.38"></a><span id="l4.38">     pref = nullptr;</span>
<a href="#l4.39"></a><span id="l4.39">   }</span>
<a href="#l4.40"></a><span id="l4.40">   aPrefs.Clear();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1325,17 +1325,17 @@ void DIR_SavePrefsForOneServer(DIR_Serve</span>
<a href="#l5.4"></a><span id="l5.4"> }</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server *&gt; *wholeList) {</span>
<a href="#l5.7"></a><span id="l5.7">   if (wholeList) {</span>
<a href="#l5.8"></a><span id="l5.8">     nsresult rv;</span>
<a href="#l5.9"></a><span id="l5.9">     nsCOMPtr&lt;nsIPrefBranch&gt; pPref(</span>
<a href="#l5.10"></a><span id="l5.10">         do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.11"></a><span id="l5.11">     if (NS_FAILED(rv)) {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-      NS_WARNING(&quot;DIR_SaveServerPreferences: Failed to get the pref service\n&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      NS_WARNING(&quot;DIR_SaveServerPreferences: Failed to get the pref service&quot;);</span>
<a href="#l5.14"></a><span id="l5.14">       return;</span>
<a href="#l5.15"></a><span id="l5.15">     }</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">     int32_t i;</span>
<a href="#l5.18"></a><span id="l5.18">     int32_t count = wholeList-&gt;Length();</span>
<a href="#l5.19"></a><span id="l5.19">     DIR_Server *server;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">     for (i = 0; i &lt; count; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -423,17 +423,17 @@ SendOperationListener::OnProgress(uint32</span>
<a href="#l6.4"></a><span id="l6.4"> NS_IMETHODIMP</span>
<a href="#l6.5"></a><span id="l6.5"> SendOperationListener::SetMessageKey(nsMsgKey aKey) {</span>
<a href="#l6.6"></a><span id="l6.6">   MOZ_ASSERT_UNREACHABLE(&quot;SendOperationListener::SetMessageKey()&quot;);</span>
<a href="#l6.7"></a><span id="l6.7">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> NS_IMETHODIMP</span>
<a href="#l6.11"></a><span id="l6.11"> SendOperationListener::GetMessageId(nsACString &amp;messageId) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  MOZ_ASSERT_UNREACHABLE(&quot;SendOperationListener::GetMessageId()\n&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  MOZ_ASSERT_UNREACHABLE(&quot;SendOperationListener::GetMessageId()&quot;);</span>
<a href="#l6.14"></a><span id="l6.14">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.15"></a><span id="l6.15"> }</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> NS_IMETHODIMP</span>
<a href="#l6.18"></a><span id="l6.18"> SendOperationListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l6.19"></a><span id="l6.19">   if (mSendLater) {</span>
<a href="#l6.20"></a><span id="l6.20">     mSendLater-&gt;OnCopyStepFinished(aStatus);</span>
<a href="#l6.21"></a><span id="l6.21">     mSendLater = nullptr;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -686,17 +686,17 @@ nsresult nsMsgSendLater::ReparseDBIfNeed</span>
<a href="#l6.23"></a><span id="l6.23"> }</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> nsresult nsMsgSendLater::InternalSendMessages(bool aUserInitiated,</span>
<a href="#l6.26"></a><span id="l6.26">                                               nsIMsgIdentity *aIdentity) {</span>
<a href="#l6.27"></a><span id="l6.27">   if (WeAreOffline()) return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   // Protect against being called whilst we're already sending.</span>
<a href="#l6.30"></a><span id="l6.30">   if (mSendingMessages) {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    NS_ERROR(&quot;nsMsgSendLater is already sending messages\n&quot;);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    NS_ERROR(&quot;nsMsgSendLater is already sending messages&quot;);</span>
<a href="#l6.33"></a><span id="l6.33">     return NS_ERROR_FAILURE;</span>
<a href="#l6.34"></a><span id="l6.34">   }</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">   nsresult rv;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   // XXX This code should be set up for multiple unsent folders, however we</span>
<a href="#l6.39"></a><span id="l6.39">   // don't support that at the moment, so for now just assume one folder.</span>
<a href="#l6.40"></a><span id="l6.40">   if (!mMessageFolder) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -38,17 +38,17 @@ nsMailDatabase::~nsMailDatabase() {}</span>
<a href="#l7.4"></a><span id="l7.4"> // it, delete it, and then try to open the db again, prior to reparsing.</span>
<a href="#l7.5"></a><span id="l7.5"> nsresult nsMailDatabase::Open(nsMsgDBService *aDBService, nsIFile *aSummaryFile,</span>
<a href="#l7.6"></a><span id="l7.6">                               bool aCreate, bool aUpgrading) {</span>
<a href="#l7.7"></a><span id="l7.7"> #ifdef DEBUG</span>
<a href="#l7.8"></a><span id="l7.8">   nsString leafName;</span>
<a href="#l7.9"></a><span id="l7.9">   aSummaryFile-&gt;GetLeafName(leafName);</span>
<a href="#l7.10"></a><span id="l7.10">   if (!StringEndsWith(leafName, NS_LITERAL_STRING(SUMMARY_SUFFIX),</span>
<a href="#l7.11"></a><span id="l7.11">                       nsCaseInsensitiveStringComparator()))</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    NS_ERROR(&quot;non summary file passed into open\n&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    NS_ERROR(&quot;non summary file passed into open&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> #endif</span>
<a href="#l7.15"></a><span id="l7.15">   return nsMsgDatabase::Open(aDBService, aSummaryFile, aCreate, aUpgrading);</span>
<a href="#l7.16"></a><span id="l7.16"> }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> NS_IMETHODIMP nsMailDatabase::ForceClosed() {</span>
<a href="#l7.19"></a><span id="l7.19">   m_mdbAllOfflineOpsTable = nullptr;</span>
<a href="#l7.20"></a><span id="l7.20">   return nsMsgDatabase::ForceClosed();</span>
<a href="#l7.21"></a><span id="l7.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -69,79 +69,78 @@ NSSCMSSignerInfo *nsCMSMessage::GetTopLe</span>
<a href="#l8.4"></a><span id="l8.4">       (NSSCMSSignedData *)NSS_CMSContentInfo_GetContent(cinfo);</span>
<a href="#l8.5"></a><span id="l8.5">   if (!sigd) return nullptr;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   PR_ASSERT(NSS_CMSSignedData_SignerInfoCount(sigd) &gt; 0);</span>
<a href="#l8.8"></a><span id="l8.8">   return NSS_CMSSignedData_GetSignerInfo(sigd, 0);</span>
<a href="#l8.9"></a><span id="l8.9"> }</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> NS_IMETHODIMP nsCMSMessage::GetSignerEmailAddress(char **aEmail) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-          (&quot;nsCMSMessage::GetSignerEmailAddress\n&quot;));</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerEmailAddress&quot;));</span>
<a href="#l8.15"></a><span id="l8.15">   NS_ENSURE_ARG(aEmail);</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l8.18"></a><span id="l8.18">   if (!si) return NS_ERROR_FAILURE;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   *aEmail = NSS_CMSSignerInfo_GetSignerEmailAddress(si);</span>
<a href="#l8.21"></a><span id="l8.21">   return NS_OK;</span>
<a href="#l8.22"></a><span id="l8.22"> }</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> NS_IMETHODIMP nsCMSMessage::GetSignerCommonName(char **aName) {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCommonName\n&quot;));</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCommonName&quot;));</span>
<a href="#l8.27"></a><span id="l8.27">   NS_ENSURE_ARG(aName);</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l8.30"></a><span id="l8.30">   if (!si) return NS_ERROR_FAILURE;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   *aName = NSS_CMSSignerInfo_GetSignerCommonName(si);</span>
<a href="#l8.33"></a><span id="l8.33">   return NS_OK;</span>
<a href="#l8.34"></a><span id="l8.34"> }</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> NS_IMETHODIMP nsCMSMessage::ContentIsEncrypted(bool *isEncrypted) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsEncrypted\n&quot;));</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsEncrypted&quot;));</span>
<a href="#l8.39"></a><span id="l8.39">   NS_ENSURE_ARG(isEncrypted);</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   if (!m_cmsMsg) return NS_ERROR_FAILURE;</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   *isEncrypted = NSS_CMSMessage_IsEncrypted(m_cmsMsg);</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   return NS_OK;</span>
<a href="#l8.46"></a><span id="l8.46"> }</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48"> NS_IMETHODIMP nsCMSMessage::ContentIsSigned(bool *isSigned) {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsSigned\n&quot;));</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsSigned&quot;));</span>
<a href="#l8.51"></a><span id="l8.51">   NS_ENSURE_ARG(isSigned);</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">   if (!m_cmsMsg) return NS_ERROR_FAILURE;</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55">   *isSigned = NSS_CMSMessage_IsSigned(m_cmsMsg);</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   return NS_OK;</span>
<a href="#l8.58"></a><span id="l8.58"> }</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60"> NS_IMETHODIMP nsCMSMessage::GetSignerCert(nsIX509Cert **scert) {</span>
<a href="#l8.61"></a><span id="l8.61">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l8.62"></a><span id="l8.62">   if (!si) return NS_ERROR_FAILURE;</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">   nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l8.65"></a><span id="l8.65">   if (si-&gt;cert) {</span>
<a href="#l8.66"></a><span id="l8.66">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-            (&quot;nsCMSMessage::GetSignerCert got signer cert\n&quot;));</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+            (&quot;nsCMSMessage::GetSignerCert got signer cert&quot;));</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70">     nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(NS_X509CERTDB_CONTRACTID);</span>
<a href="#l8.71"></a><span id="l8.71">     nsDependentCSubstring certDER(</span>
<a href="#l8.72"></a><span id="l8.72">         reinterpret_cast&lt;char *&gt;(si-&gt;cert-&gt;derCert.data),</span>
<a href="#l8.73"></a><span id="l8.73">         si-&gt;cert-&gt;derCert.len);</span>
<a href="#l8.74"></a><span id="l8.74">     nsresult rv = certdb-&gt;ConstructX509(certDER, getter_AddRefs(cert));</span>
<a href="#l8.75"></a><span id="l8.75">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.76"></a><span id="l8.76">   } else {</span>
<a href="#l8.77"></a><span id="l8.77">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.78"></a><span id="l8.78">             (&quot;nsCMSMessage::GetSignerCert no signer cert, do we have a cert &quot;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-             &quot;list? %s\n&quot;,</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+             &quot;list? %s&quot;,</span>
<a href="#l8.81"></a><span id="l8.81">              (si-&gt;certList ? &quot;yes&quot; : &quot;no&quot;)));</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83">     *scert = nullptr;</span>
<a href="#l8.84"></a><span id="l8.84">   }</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86">   cert.forget(scert);</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88">   return NS_OK;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineat">@@ -159,28 +158,28 @@ nsCMSMessage::VerifyDetachedSignature(un</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91">   return CommonVerifySignature(aDigestData, aDigestDataLen, aDigestType);</span>
<a href="#l8.92"></a><span id="l8.92"> }</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94"> nsresult nsCMSMessage::CommonVerifySignature(unsigned char *aDigestData,</span>
<a href="#l8.95"></a><span id="l8.95">                                              uint32_t aDigestDataLen,</span>
<a href="#l8.96"></a><span id="l8.96">                                              int16_t aDigestType) {</span>
<a href="#l8.97"></a><span id="l8.97">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-          (&quot;nsCMSMessage::CommonVerifySignature, content level count %d\n&quot;,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+          (&quot;nsCMSMessage::CommonVerifySignature, content level count %d&quot;,</span>
<a href="#l8.100"></a><span id="l8.100">            NSS_CMSMessage_ContentLevelCount(m_cmsMsg)));</span>
<a href="#l8.101"></a><span id="l8.101">   NSSCMSContentInfo *cinfo = nullptr;</span>
<a href="#l8.102"></a><span id="l8.102">   NSSCMSSignedData *sigd = nullptr;</span>
<a href="#l8.103"></a><span id="l8.103">   NSSCMSSignerInfo *si;</span>
<a href="#l8.104"></a><span id="l8.104">   int32_t nsigners;</span>
<a href="#l8.105"></a><span id="l8.105">   RefPtr&lt;SharedCertVerifier&gt; certVerifier;</span>
<a href="#l8.106"></a><span id="l8.106">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">   if (!NSS_CMSMessage_IsSigned(m_cmsMsg)) {</span>
<a href="#l8.109"></a><span id="l8.109">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-            (&quot;nsCMSMessage::CommonVerifySignature - not signed\n&quot;));</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - not signed&quot;));</span>
<a href="#l8.112"></a><span id="l8.112">     return NS_ERROR_CMS_VERIFY_NOT_SIGNED;</span>
<a href="#l8.113"></a><span id="l8.113">   }</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   cinfo = NSS_CMSMessage_ContentLevel(m_cmsMsg, 0);</span>
<a href="#l8.116"></a><span id="l8.116">   if (cinfo) {</span>
<a href="#l8.117"></a><span id="l8.117">     switch (NSS_CMSContentInfo_GetContentTypeTag(cinfo)) {</span>
<a href="#l8.118"></a><span id="l8.118">       case SEC_OID_PKCS7_SIGNED_DATA:</span>
<a href="#l8.119"></a><span id="l8.119">         sigd = reinterpret_cast&lt;NSSCMSSignedData *&gt;(</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineat">@@ -188,26 +187,26 @@ nsresult nsCMSMessage::CommonVerifySigna</span>
<a href="#l8.121"></a><span id="l8.121">         break;</span>
<a href="#l8.122"></a><span id="l8.122"> </span>
<a href="#l8.123"></a><span id="l8.123">       case SEC_OID_PKCS7_ENVELOPED_DATA:</span>
<a href="#l8.124"></a><span id="l8.124">       case SEC_OID_PKCS7_ENCRYPTED_DATA:</span>
<a href="#l8.125"></a><span id="l8.125">       case SEC_OID_PKCS7_DIGESTED_DATA:</span>
<a href="#l8.126"></a><span id="l8.126">       default: {</span>
<a href="#l8.127"></a><span id="l8.127">         MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.128"></a><span id="l8.128">                 (&quot;nsCMSMessage::CommonVerifySignature - unexpected &quot;</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-                 &quot;ContentTypeTag\n&quot;));</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+                 &quot;ContentTypeTag&quot;));</span>
<a href="#l8.131"></a><span id="l8.131">         rv = NS_ERROR_CMS_VERIFY_NO_CONTENT_INFO;</span>
<a href="#l8.132"></a><span id="l8.132">         goto loser;</span>
<a href="#l8.133"></a><span id="l8.133">       }</span>
<a href="#l8.134"></a><span id="l8.134">     }</span>
<a href="#l8.135"></a><span id="l8.135">   }</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137">   if (!sigd) {</span>
<a href="#l8.138"></a><span id="l8.138">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-            (&quot;nsCMSMessage::CommonVerifySignature - no content info\n&quot;));</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - no content info&quot;));</span>
<a href="#l8.141"></a><span id="l8.141">     rv = NS_ERROR_CMS_VERIFY_NO_CONTENT_INFO;</span>
<a href="#l8.142"></a><span id="l8.142">     goto loser;</span>
<a href="#l8.143"></a><span id="l8.143">   }</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145">   if (aDigestData &amp;&amp; aDigestDataLen) {</span>
<a href="#l8.146"></a><span id="l8.146">     SECOidTag oidTag;</span>
<a href="#l8.147"></a><span id="l8.147">     SECItem digest;</span>
<a href="#l8.148"></a><span id="l8.148">     digest.data = aDigestData;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineat">@@ -229,29 +228,29 @@ nsresult nsCMSMessage::CommonVerifySigna</span>
<a href="#l8.150"></a><span id="l8.150">         HASH_GetHashOidTagByHashType(static_cast&lt;HASH_HashType&gt;(aDigestType));</span>
<a href="#l8.151"></a><span id="l8.151">     if (oidTag == SEC_OID_UNKNOWN) {</span>
<a href="#l8.152"></a><span id="l8.152">       rv = NS_ERROR_CMS_VERIFY_BAD_DIGEST;</span>
<a href="#l8.153"></a><span id="l8.153">       goto loser;</span>
<a href="#l8.154"></a><span id="l8.154">     }</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156">     if (NSS_CMSSignedData_SetDigestValue(sigd, oidTag, &amp;digest)) {</span>
<a href="#l8.157"></a><span id="l8.157">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - bad digest\n&quot;));</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - bad digest&quot;));</span>
<a href="#l8.160"></a><span id="l8.160">       rv = NS_ERROR_CMS_VERIFY_BAD_DIGEST;</span>
<a href="#l8.161"></a><span id="l8.161">       goto loser;</span>
<a href="#l8.162"></a><span id="l8.162">     }</span>
<a href="#l8.163"></a><span id="l8.163">   }</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165">   // Import certs. Note that import failure is not a signature verification</span>
<a href="#l8.166"></a><span id="l8.166">   // failure. //</span>
<a href="#l8.167"></a><span id="l8.167">   if (NSS_CMSSignedData_ImportCerts(sigd, CERT_GetDefaultCertDB(),</span>
<a href="#l8.168"></a><span id="l8.168">                                     certUsageEmailRecipient,</span>
<a href="#l8.169"></a><span id="l8.169">                                     true) != SECSuccess) {</span>
<a href="#l8.170"></a><span id="l8.170">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-            (&quot;nsCMSMessage::CommonVerifySignature - can not import certs\n&quot;));</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+            (&quot;nsCMSMessage::CommonVerifySignature - can not import certs&quot;));</span>
<a href="#l8.173"></a><span id="l8.173">   }</span>
<a href="#l8.174"></a><span id="l8.174"> </span>
<a href="#l8.175"></a><span id="l8.175">   nsigners = NSS_CMSSignedData_SignerInfoCount(sigd);</span>
<a href="#l8.176"></a><span id="l8.176">   PR_ASSERT(nsigners &gt; 0);</span>
<a href="#l8.177"></a><span id="l8.177">   NS_ENSURE_TRUE(nsigners &gt; 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l8.178"></a><span id="l8.178">   si = NSS_CMSSignedData_GetSignerInfo(sigd, 0);</span>
<a href="#l8.179"></a><span id="l8.179"> </span>
<a href="#l8.180"></a><span id="l8.180">   // See bug 324474. We want to make sure the signing cert is</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineat">@@ -265,84 +264,83 @@ nsresult nsCMSMessage::CommonVerifySigna</span>
<a href="#l8.182"></a><span id="l8.182">     mozilla::pkix::Result result = certVerifier-&gt;VerifyCert(</span>
<a href="#l8.183"></a><span id="l8.183">         si-&gt;cert, certificateUsageEmailSigner, Now(), nullptr /*XXX pinarg*/,</span>
<a href="#l8.184"></a><span id="l8.184">         nullptr /*hostname*/, builtChain,</span>
<a href="#l8.185"></a><span id="l8.185">         // Only local checks can run on the main thread.</span>
<a href="#l8.186"></a><span id="l8.186">         CertVerifier::FLAG_LOCAL_ONLY);</span>
<a href="#l8.187"></a><span id="l8.187">     if (result != mozilla::pkix::Success) {</span>
<a href="#l8.188"></a><span id="l8.188">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.189"></a><span id="l8.189">               (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted &quot;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-               &quot;now\n&quot;));</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+               &quot;now&quot;));</span>
<a href="#l8.192"></a><span id="l8.192">       rv = NS_ERROR_CMS_VERIFY_UNTRUSTED;</span>
<a href="#l8.193"></a><span id="l8.193">       goto loser;</span>
<a href="#l8.194"></a><span id="l8.194">     }</span>
<a href="#l8.195"></a><span id="l8.195">   }</span>
<a href="#l8.196"></a><span id="l8.196"> </span>
<a href="#l8.197"></a><span id="l8.197">   // We verify the first signer info,  only //</span>
<a href="#l8.198"></a><span id="l8.198">   // XXX: NSS_CMSSignedData_VerifySignerInfo calls CERT_VerifyCert, which</span>
<a href="#l8.199"></a><span id="l8.199">   // requires NSS's certificate verification configuration to be done in</span>
<a href="#l8.200"></a><span id="l8.200">   // order to work well (e.g. honoring OCSP preferences and proxy settings</span>
<a href="#l8.201"></a><span id="l8.201">   // for OCSP requests), but Gecko stopped doing that configuration. Something</span>
<a href="#l8.202"></a><span id="l8.202">   // similar to what was done for Gecko bug 1028643 needs to be done here too.</span>
<a href="#l8.203"></a><span id="l8.203">   if (NSS_CMSSignedData_VerifySignerInfo(sigd, 0, CERT_GetDefaultCertDB(),</span>
<a href="#l8.204"></a><span id="l8.204">                                          certUsageEmailSigner) != SECSuccess) {</span>
<a href="#l8.205"></a><span id="l8.205">     MOZ_LOG(</span>
<a href="#l8.206"></a><span id="l8.206">         gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-        (&quot;nsCMSMessage::CommonVerifySignature - unable to verify signature\n&quot;));</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+        (&quot;nsCMSMessage::CommonVerifySignature - unable to verify signature&quot;));</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">     if (NSSCMSVS_SigningCertNotFound == si-&gt;verificationStatus) {</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-      MOZ_LOG(</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-          gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-          (&quot;nsCMSMessage::CommonVerifySignature - signing cert not found\n&quot;));</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - signing cert not found&quot;));</span>
<a href="#l8.216"></a><span id="l8.216">       rv = NS_ERROR_CMS_VERIFY_NOCERT;</span>
<a href="#l8.217"></a><span id="l8.217">     } else if (NSSCMSVS_SigningCertNotTrusted == si-&gt;verificationStatus) {</span>
<a href="#l8.218"></a><span id="l8.218">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.219"></a><span id="l8.219">               (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted &quot;</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-               &quot;at signing time\n&quot;));</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+               &quot;at signing time&quot;));</span>
<a href="#l8.222"></a><span id="l8.222">       rv = NS_ERROR_CMS_VERIFY_UNTRUSTED;</span>
<a href="#l8.223"></a><span id="l8.223">     } else if (NSSCMSVS_Unverified == si-&gt;verificationStatus) {</span>
<a href="#l8.224"></a><span id="l8.224">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - can not verify\n&quot;));</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - can not verify&quot;));</span>
<a href="#l8.227"></a><span id="l8.227">       rv = NS_ERROR_CMS_VERIFY_ERROR_UNVERIFIED;</span>
<a href="#l8.228"></a><span id="l8.228">     } else if (NSSCMSVS_ProcessingError == si-&gt;verificationStatus) {</span>
<a href="#l8.229"></a><span id="l8.229">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - processing error\n&quot;));</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - processing error&quot;));</span>
<a href="#l8.232"></a><span id="l8.232">       rv = NS_ERROR_CMS_VERIFY_ERROR_PROCESSING;</span>
<a href="#l8.233"></a><span id="l8.233">     } else if (NSSCMSVS_BadSignature == si-&gt;verificationStatus) {</span>
<a href="#l8.234"></a><span id="l8.234">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - bad signature\n&quot;));</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - bad signature&quot;));</span>
<a href="#l8.237"></a><span id="l8.237">       rv = NS_ERROR_CMS_VERIFY_BAD_SIGNATURE;</span>
<a href="#l8.238"></a><span id="l8.238">     } else if (NSSCMSVS_DigestMismatch == si-&gt;verificationStatus) {</span>
<a href="#l8.239"></a><span id="l8.239">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - digest mismatch\n&quot;));</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - digest mismatch&quot;));</span>
<a href="#l8.242"></a><span id="l8.242">       rv = NS_ERROR_CMS_VERIFY_DIGEST_MISMATCH;</span>
<a href="#l8.243"></a><span id="l8.243">     } else if (NSSCMSVS_SignatureAlgorithmUnknown == si-&gt;verificationStatus) {</span>
<a href="#l8.244"></a><span id="l8.244">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - algo unknown\n&quot;));</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - algo unknown&quot;));</span>
<a href="#l8.247"></a><span id="l8.247">       rv = NS_ERROR_CMS_VERIFY_UNKNOWN_ALGO;</span>
<a href="#l8.248"></a><span id="l8.248">     } else if (NSSCMSVS_SignatureAlgorithmUnsupported ==</span>
<a href="#l8.249"></a><span id="l8.249">                si-&gt;verificationStatus) {</span>
<a href="#l8.250"></a><span id="l8.250">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - algo not supported\n&quot;));</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - algo not supported&quot;));</span>
<a href="#l8.253"></a><span id="l8.253">       rv = NS_ERROR_CMS_VERIFY_UNSUPPORTED_ALGO;</span>
<a href="#l8.254"></a><span id="l8.254">     } else if (NSSCMSVS_MalformedSignature == si-&gt;verificationStatus) {</span>
<a href="#l8.255"></a><span id="l8.255">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-              (&quot;nsCMSMessage::CommonVerifySignature - malformed signature\n&quot;));</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+              (&quot;nsCMSMessage::CommonVerifySignature - malformed signature&quot;));</span>
<a href="#l8.258"></a><span id="l8.258">       rv = NS_ERROR_CMS_VERIFY_MALFORMED_SIGNATURE;</span>
<a href="#l8.259"></a><span id="l8.259">     }</span>
<a href="#l8.260"></a><span id="l8.260"> </span>
<a href="#l8.261"></a><span id="l8.261">     goto loser;</span>
<a href="#l8.262"></a><span id="l8.262">   }</span>
<a href="#l8.263"></a><span id="l8.263"> </span>
<a href="#l8.264"></a><span id="l8.264">   // Save the profile. Note that save import failure is not a signature</span>
<a href="#l8.265"></a><span id="l8.265">   // verification failure. //</span>
<a href="#l8.266"></a><span id="l8.266">   if (NSS_SMIMESignerInfo_SaveSMIMEProfile(si) != SECSuccess) {</span>
<a href="#l8.267"></a><span id="l8.267">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.268"></a><span id="l8.268">             (&quot;nsCMSMessage::CommonVerifySignature - unable to save smime &quot;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-             &quot;profile\n&quot;));</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+             &quot;profile&quot;));</span>
<a href="#l8.271"></a><span id="l8.271">   }</span>
<a href="#l8.272"></a><span id="l8.272"> </span>
<a href="#l8.273"></a><span id="l8.273">   rv = NS_OK;</span>
<a href="#l8.274"></a><span id="l8.274"> loser:</span>
<a href="#l8.275"></a><span id="l8.275">   return rv;</span>
<a href="#l8.276"></a><span id="l8.276"> }</span>
<a href="#l8.277"></a><span id="l8.277"> </span>
<a href="#l8.278"></a><span id="l8.278"> NS_IMETHODIMP nsCMSMessage::AsyncVerifySignature(</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineat">@@ -473,17 +471,17 @@ class nsZeroTerminatedCertArray {</span>
<a href="#l8.280"></a><span id="l8.280"> </span>
<a href="#l8.281"></a><span id="l8.281">  private:</span>
<a href="#l8.282"></a><span id="l8.282">   CERTCertificate **mCerts;</span>
<a href="#l8.283"></a><span id="l8.283">   PLArenaPool *mPoolp;</span>
<a href="#l8.284"></a><span id="l8.284">   uint32_t mSize;</span>
<a href="#l8.285"></a><span id="l8.285"> };</span>
<a href="#l8.286"></a><span id="l8.286"> </span>
<a href="#l8.287"></a><span id="l8.287"> NS_IMETHODIMP nsCMSMessage::CreateEncrypted(nsIArray *aRecipientCerts) {</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted\n&quot;));</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted&quot;));</span>
<a href="#l8.290"></a><span id="l8.290">   NSSCMSContentInfo *cinfo;</span>
<a href="#l8.291"></a><span id="l8.291">   NSSCMSEnvelopedData *envd;</span>
<a href="#l8.292"></a><span id="l8.292">   NSSCMSRecipientInfo *recipientInfo;</span>
<a href="#l8.293"></a><span id="l8.293">   nsZeroTerminatedCertArray recipientCerts;</span>
<a href="#l8.294"></a><span id="l8.294">   SECOidTag bulkAlgTag;</span>
<a href="#l8.295"></a><span id="l8.295">   int keySize;</span>
<a href="#l8.296"></a><span id="l8.296">   uint32_t i;</span>
<a href="#l8.297"></a><span id="l8.297">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineat">@@ -506,66 +504,65 @@ NS_IMETHODIMP nsCMSMessage::CreateEncryp</span>
<a href="#l8.299"></a><span id="l8.299">     recipientCerts.set(i, c.get());</span>
<a href="#l8.300"></a><span id="l8.300">   }</span>
<a href="#l8.301"></a><span id="l8.301"> </span>
<a href="#l8.302"></a><span id="l8.302">   // Find a bulk key algorithm //</span>
<a href="#l8.303"></a><span id="l8.303">   if (NSS_SMIMEUtil_FindBulkAlgForRecipients(</span>
<a href="#l8.304"></a><span id="l8.304">           recipientCerts.getRawArray(), &amp;bulkAlgTag, &amp;keySize) != SECSuccess) {</span>
<a href="#l8.305"></a><span id="l8.305">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.306"></a><span id="l8.306">             (&quot;nsCMSMessage::CreateEncrypted - can't find bulk alg for &quot;</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-             &quot;recipients\n&quot;));</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+             &quot;recipients&quot;));</span>
<a href="#l8.309"></a><span id="l8.309">     rv = NS_ERROR_CMS_ENCRYPT_NO_BULK_ALG;</span>
<a href="#l8.310"></a><span id="l8.310">     goto loser;</span>
<a href="#l8.311"></a><span id="l8.311">   }</span>
<a href="#l8.312"></a><span id="l8.312"> </span>
<a href="#l8.313"></a><span id="l8.313">   m_cmsMsg = NSS_CMSMessage_Create(nullptr);</span>
<a href="#l8.314"></a><span id="l8.314">   if (!m_cmsMsg) {</span>
<a href="#l8.315"></a><span id="l8.315">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-            (&quot;nsCMSMessage::CreateEncrypted - can't create new cms message\n&quot;));</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't create new cms message&quot;));</span>
<a href="#l8.318"></a><span id="l8.318">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.319"></a><span id="l8.319">     goto loser;</span>
<a href="#l8.320"></a><span id="l8.320">   }</span>
<a href="#l8.321"></a><span id="l8.321"> </span>
<a href="#l8.322"></a><span id="l8.322">   if ((envd = NSS_CMSEnvelopedData_Create(m_cmsMsg, bulkAlgTag, keySize)) ==</span>
<a href="#l8.323"></a><span id="l8.323">       nullptr) {</span>
<a href="#l8.324"></a><span id="l8.324">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-            (&quot;nsCMSMessage::CreateEncrypted - can't create enveloped data\n&quot;));</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't create enveloped data&quot;));</span>
<a href="#l8.327"></a><span id="l8.327">     goto loser;</span>
<a href="#l8.328"></a><span id="l8.328">   }</span>
<a href="#l8.329"></a><span id="l8.329"> </span>
<a href="#l8.330"></a><span id="l8.330">   cinfo = NSS_CMSMessage_GetContentInfo(m_cmsMsg);</span>
<a href="#l8.331"></a><span id="l8.331">   if (NSS_CMSContentInfo_SetContent_EnvelopedData(m_cmsMsg, cinfo, envd) !=</span>
<a href="#l8.332"></a><span id="l8.332">       SECSuccess) {</span>
<a href="#l8.333"></a><span id="l8.333">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.334"></a><span id="l8.334">             (&quot;nsCMSMessage::CreateEncrypted - can't create content enveloped &quot;</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-             &quot;data\n&quot;));</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+             &quot;data&quot;));</span>
<a href="#l8.337"></a><span id="l8.337">     goto loser;</span>
<a href="#l8.338"></a><span id="l8.338">   }</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340">   cinfo = NSS_CMSEnvelopedData_GetContentInfo(envd);</span>
<a href="#l8.341"></a><span id="l8.341">   if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, false) !=</span>
<a href="#l8.342"></a><span id="l8.342">       SECSuccess) {</span>
<a href="#l8.343"></a><span id="l8.343">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-            (&quot;nsCMSMessage::CreateEncrypted - can't set content data\n&quot;));</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+            (&quot;nsCMSMessage::CreateEncrypted - can't set content data&quot;));</span>
<a href="#l8.346"></a><span id="l8.346">     goto loser;</span>
<a href="#l8.347"></a><span id="l8.347">   }</span>
<a href="#l8.348"></a><span id="l8.348"> </span>
<a href="#l8.349"></a><span id="l8.349">   // Create and attach recipient information //</span>
<a href="#l8.350"></a><span id="l8.350">   for (i = 0; i &lt; recipientCertCount; i++) {</span>
<a href="#l8.351"></a><span id="l8.351">     UniqueCERTCertificate rc(recipientCerts.get(i));</span>
<a href="#l8.352"></a><span id="l8.352">     if ((recipientInfo = NSS_CMSRecipientInfo_Create(m_cmsMsg, rc.get())) ==</span>
<a href="#l8.353"></a><span id="l8.353">         nullptr) {</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-      MOZ_LOG(</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-          gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-          (&quot;nsCMSMessage::CreateEncrypted - can't create recipient info\n&quot;));</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+              (&quot;nsCMSMessage::CreateEncrypted - can't create recipient info&quot;));</span>
<a href="#l8.359"></a><span id="l8.359">       goto loser;</span>
<a href="#l8.360"></a><span id="l8.360">     }</span>
<a href="#l8.361"></a><span id="l8.361">     if (NSS_CMSEnvelopedData_AddRecipient(envd, recipientInfo) != SECSuccess) {</span>
<a href="#l8.362"></a><span id="l8.362">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-              (&quot;nsCMSMessage::CreateEncrypted - can't add recipient info\n&quot;));</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+              (&quot;nsCMSMessage::CreateEncrypted - can't add recipient info&quot;));</span>
<a href="#l8.365"></a><span id="l8.365">       goto loser;</span>
<a href="#l8.366"></a><span id="l8.366">     }</span>
<a href="#l8.367"></a><span id="l8.367">   }</span>
<a href="#l8.368"></a><span id="l8.368"> </span>
<a href="#l8.369"></a><span id="l8.369">   return NS_OK;</span>
<a href="#l8.370"></a><span id="l8.370"> loser:</span>
<a href="#l8.371"></a><span id="l8.371">   if (m_cmsMsg) {</span>
<a href="#l8.372"></a><span id="l8.372">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineat">@@ -587,17 +584,17 @@ bool nsCMSMessage::IsAllowedHash(const i</span>
<a href="#l8.374"></a><span id="l8.374">   }</span>
<a href="#l8.375"></a><span id="l8.375"> }</span>
<a href="#l8.376"></a><span id="l8.376"> </span>
<a href="#l8.377"></a><span id="l8.377"> NS_IMETHODIMP</span>
<a href="#l8.378"></a><span id="l8.378"> nsCMSMessage::CreateSigned(nsIX509Cert *aSigningCert, nsIX509Cert *aEncryptCert,</span>
<a href="#l8.379"></a><span id="l8.379">                            unsigned char *aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l8.380"></a><span id="l8.380">                            int16_t aDigestType) {</span>
<a href="#l8.381"></a><span id="l8.381">   NS_ENSURE_ARG(aSigningCert);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned\n&quot;));</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned&quot;));</span>
<a href="#l8.384"></a><span id="l8.384">   NSSCMSContentInfo *cinfo;</span>
<a href="#l8.385"></a><span id="l8.385">   NSSCMSSignedData *sigd;</span>
<a href="#l8.386"></a><span id="l8.386">   NSSCMSSignerInfo *signerinfo;</span>
<a href="#l8.387"></a><span id="l8.387">   UniqueCERTCertificate scert(aSigningCert-&gt;GetCert());</span>
<a href="#l8.388"></a><span id="l8.388">   UniqueCERTCertificate ecert;</span>
<a href="#l8.389"></a><span id="l8.389">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l8.390"></a><span id="l8.390"> </span>
<a href="#l8.391"></a><span id="l8.391">   if (!scert) {</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineat">@@ -620,123 +617,123 @@ nsCMSMessage::CreateSigned(nsIX509Cert *</span>
<a href="#l8.393"></a><span id="l8.393"> </span>
<a href="#l8.394"></a><span id="l8.394">   /*</span>
<a href="#l8.395"></a><span id="l8.395">    * create the message object</span>
<a href="#l8.396"></a><span id="l8.396">    */</span>
<a href="#l8.397"></a><span id="l8.397">   m_cmsMsg =</span>
<a href="#l8.398"></a><span id="l8.398">       NSS_CMSMessage_Create(nullptr); /* create a message on its own pool */</span>
<a href="#l8.399"></a><span id="l8.399">   if (!m_cmsMsg) {</span>
<a href="#l8.400"></a><span id="l8.400">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't create new message\n&quot;));</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't create new message&quot;));</span>
<a href="#l8.403"></a><span id="l8.403">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.404"></a><span id="l8.404">     goto loser;</span>
<a href="#l8.405"></a><span id="l8.405">   }</span>
<a href="#l8.406"></a><span id="l8.406"> </span>
<a href="#l8.407"></a><span id="l8.407">   /*</span>
<a href="#l8.408"></a><span id="l8.408">    * build chain of objects: message-&gt;signedData-&gt;data</span>
<a href="#l8.409"></a><span id="l8.409">    */</span>
<a href="#l8.410"></a><span id="l8.410">   if ((sigd = NSS_CMSSignedData_Create(m_cmsMsg)) == nullptr) {</span>
<a href="#l8.411"></a><span id="l8.411">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't create signed data\n&quot;));</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't create signed data&quot;));</span>
<a href="#l8.414"></a><span id="l8.414">     goto loser;</span>
<a href="#l8.415"></a><span id="l8.415">   }</span>
<a href="#l8.416"></a><span id="l8.416">   cinfo = NSS_CMSMessage_GetContentInfo(m_cmsMsg);</span>
<a href="#l8.417"></a><span id="l8.417">   if (NSS_CMSContentInfo_SetContent_SignedData(m_cmsMsg, cinfo, sigd) !=</span>
<a href="#l8.418"></a><span id="l8.418">       SECSuccess) {</span>
<a href="#l8.419"></a><span id="l8.419">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't set content signed data\n&quot;));</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't set content signed data&quot;));</span>
<a href="#l8.422"></a><span id="l8.422">     goto loser;</span>
<a href="#l8.423"></a><span id="l8.423">   }</span>
<a href="#l8.424"></a><span id="l8.424"> </span>
<a href="#l8.425"></a><span id="l8.425">   cinfo = NSS_CMSSignedData_GetContentInfo(sigd);</span>
<a href="#l8.426"></a><span id="l8.426"> </span>
<a href="#l8.427"></a><span id="l8.427">   /* we're always passing data in and detaching optionally */</span>
<a href="#l8.428"></a><span id="l8.428">   if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, true) !=</span>
<a href="#l8.429"></a><span id="l8.429">       SECSuccess) {</span>
<a href="#l8.430"></a><span id="l8.430">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't set content data\n&quot;));</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't set content data&quot;));</span>
<a href="#l8.433"></a><span id="l8.433">     goto loser;</span>
<a href="#l8.434"></a><span id="l8.434">   }</span>
<a href="#l8.435"></a><span id="l8.435"> </span>
<a href="#l8.436"></a><span id="l8.436">   /*</span>
<a href="#l8.437"></a><span id="l8.437">    * create &amp; attach signer information</span>
<a href="#l8.438"></a><span id="l8.438">    */</span>
<a href="#l8.439"></a><span id="l8.439">   signerinfo = NSS_CMSSignerInfo_Create(m_cmsMsg, scert.get(), digestType);</span>
<a href="#l8.440"></a><span id="l8.440">   if (!signerinfo) {</span>
<a href="#l8.441"></a><span id="l8.441">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't create signer info\n&quot;));</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't create signer info&quot;));</span>
<a href="#l8.444"></a><span id="l8.444">     goto loser;</span>
<a href="#l8.445"></a><span id="l8.445">   }</span>
<a href="#l8.446"></a><span id="l8.446"> </span>
<a href="#l8.447"></a><span id="l8.447">   /* we want the cert chain included for this one */</span>
<a href="#l8.448"></a><span id="l8.448">   if (NSS_CMSSignerInfo_IncludeCerts(signerinfo, NSSCMSCM_CertChain,</span>
<a href="#l8.449"></a><span id="l8.449">                                      certUsageEmailSigner) != SECSuccess) {</span>
<a href="#l8.450"></a><span id="l8.450">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't include signer cert chain\n&quot;));</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't include signer cert chain&quot;));</span>
<a href="#l8.453"></a><span id="l8.453">     goto loser;</span>
<a href="#l8.454"></a><span id="l8.454">   }</span>
<a href="#l8.455"></a><span id="l8.455"> </span>
<a href="#l8.456"></a><span id="l8.456">   if (NSS_CMSSignerInfo_AddSigningTime(signerinfo, PR_Now()) != SECSuccess) {</span>
<a href="#l8.457"></a><span id="l8.457">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't add signing time\n&quot;));</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't add signing time&quot;));</span>
<a href="#l8.460"></a><span id="l8.460">     goto loser;</span>
<a href="#l8.461"></a><span id="l8.461">   }</span>
<a href="#l8.462"></a><span id="l8.462"> </span>
<a href="#l8.463"></a><span id="l8.463">   if (NSS_CMSSignerInfo_AddSMIMECaps(signerinfo) != SECSuccess) {</span>
<a href="#l8.464"></a><span id="l8.464">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't add smime caps\n&quot;));</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't add smime caps&quot;));</span>
<a href="#l8.467"></a><span id="l8.467">     goto loser;</span>
<a href="#l8.468"></a><span id="l8.468">   }</span>
<a href="#l8.469"></a><span id="l8.469"> </span>
<a href="#l8.470"></a><span id="l8.470">   if (ecert) {</span>
<a href="#l8.471"></a><span id="l8.471">     if (NSS_CMSSignerInfo_AddSMIMEEncKeyPrefs(</span>
<a href="#l8.472"></a><span id="l8.472">             signerinfo, ecert.get(), CERT_GetDefaultCertDB()) != SECSuccess) {</span>
<a href="#l8.473"></a><span id="l8.473">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-              (&quot;nsCMSMessage::CreateSigned - can't add smime enc key prefs\n&quot;));</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+              (&quot;nsCMSMessage::CreateSigned - can't add smime enc key prefs&quot;));</span>
<a href="#l8.476"></a><span id="l8.476">       goto loser;</span>
<a href="#l8.477"></a><span id="l8.477">     }</span>
<a href="#l8.478"></a><span id="l8.478"> </span>
<a href="#l8.479"></a><span id="l8.479">     if (NSS_CMSSignerInfo_AddMSSMIMEEncKeyPrefs(</span>
<a href="#l8.480"></a><span id="l8.480">             signerinfo, ecert.get(), CERT_GetDefaultCertDB()) != SECSuccess) {</span>
<a href="#l8.481"></a><span id="l8.481">       MOZ_LOG(</span>
<a href="#l8.482"></a><span id="l8.482">           gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-          (&quot;nsCMSMessage::CreateSigned - can't add MS smime enc key prefs\n&quot;));</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+          (&quot;nsCMSMessage::CreateSigned - can't add MS smime enc key prefs&quot;));</span>
<a href="#l8.485"></a><span id="l8.485">       goto loser;</span>
<a href="#l8.486"></a><span id="l8.486">     }</span>
<a href="#l8.487"></a><span id="l8.487"> </span>
<a href="#l8.488"></a><span id="l8.488">     // If signing and encryption cert are identical, don't add it twice.</span>
<a href="#l8.489"></a><span id="l8.489">     bool addEncryptionCert =</span>
<a href="#l8.490"></a><span id="l8.490">         (ecert &amp;&amp; (!scert || !CERT_CompareCerts(ecert.get(), scert.get())));</span>
<a href="#l8.491"></a><span id="l8.491"> </span>
<a href="#l8.492"></a><span id="l8.492">     if (addEncryptionCert &amp;&amp;</span>
<a href="#l8.493"></a><span id="l8.493">         NSS_CMSSignedData_AddCertificate(sigd, ecert.get()) != SECSuccess) {</span>
<a href="#l8.494"></a><span id="l8.494">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.495"></a><span id="l8.495">               (&quot;nsCMSMessage::CreateSigned - can't add own encryption &quot;</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-               &quot;certificate\n&quot;));</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+               &quot;certificate&quot;));</span>
<a href="#l8.498"></a><span id="l8.498">       goto loser;</span>
<a href="#l8.499"></a><span id="l8.499">     }</span>
<a href="#l8.500"></a><span id="l8.500">   }</span>
<a href="#l8.501"></a><span id="l8.501"> </span>
<a href="#l8.502"></a><span id="l8.502">   if (NSS_CMSSignedData_AddSignerInfo(sigd, signerinfo) != SECSuccess) {</span>
<a href="#l8.503"></a><span id="l8.503">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-            (&quot;nsCMSMessage::CreateSigned - can't add signer info\n&quot;));</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+            (&quot;nsCMSMessage::CreateSigned - can't add signer info&quot;));</span>
<a href="#l8.506"></a><span id="l8.506">     goto loser;</span>
<a href="#l8.507"></a><span id="l8.507">   }</span>
<a href="#l8.508"></a><span id="l8.508"> </span>
<a href="#l8.509"></a><span id="l8.509">   // Finally, add the pre-computed digest if passed in</span>
<a href="#l8.510"></a><span id="l8.510">   if (aDigestData) {</span>
<a href="#l8.511"></a><span id="l8.511">     SECItem digest;</span>
<a href="#l8.512"></a><span id="l8.512"> </span>
<a href="#l8.513"></a><span id="l8.513">     digest.data = aDigestData;</span>
<a href="#l8.514"></a><span id="l8.514">     digest.len = aDigestDataLen;</span>
<a href="#l8.515"></a><span id="l8.515"> </span>
<a href="#l8.516"></a><span id="l8.516">     if (NSS_CMSSignedData_SetDigestValue(sigd, digestType, &amp;digest) !=</span>
<a href="#l8.517"></a><span id="l8.517">         SECSuccess) {</span>
<a href="#l8.518"></a><span id="l8.518">       MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-              (&quot;nsCMSMessage::CreateSigned - can't set digest value\n&quot;));</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+              (&quot;nsCMSMessage::CreateSigned - can't set digest value&quot;));</span>
<a href="#l8.521"></a><span id="l8.521">       goto loser;</span>
<a href="#l8.522"></a><span id="l8.522">     }</span>
<a href="#l8.523"></a><span id="l8.523">   }</span>
<a href="#l8.524"></a><span id="l8.524"> </span>
<a href="#l8.525"></a><span id="l8.525">   return NS_OK;</span>
<a href="#l8.526"></a><span id="l8.526"> loser:</span>
<a href="#l8.527"></a><span id="l8.527">   if (m_cmsMsg) {</span>
<a href="#l8.528"></a><span id="l8.528">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineat">@@ -762,38 +759,38 @@ void nsCMSDecoder::destructorSafeDestroy</span>
<a href="#l8.530"></a><span id="l8.530">   if (m_dcx) {</span>
<a href="#l8.531"></a><span id="l8.531">     NSS_CMSDecoder_Cancel(m_dcx);</span>
<a href="#l8.532"></a><span id="l8.532">     m_dcx = nullptr;</span>
<a href="#l8.533"></a><span id="l8.533">   }</span>
<a href="#l8.534"></a><span id="l8.534"> }</span>
<a href="#l8.535"></a><span id="l8.535"> </span>
<a href="#l8.536"></a><span id="l8.536"> /* void start (in NSSCMSContentCallback cb, in voidPtr arg); */</span>
<a href="#l8.537"></a><span id="l8.537"> NS_IMETHODIMP nsCMSDecoder::Start(NSSCMSContentCallback cb, void *arg) {</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start\n&quot;));</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start&quot;));</span>
<a href="#l8.540"></a><span id="l8.540">   m_ctx = new PipUIContext();</span>
<a href="#l8.541"></a><span id="l8.541"> </span>
<a href="#l8.542"></a><span id="l8.542">   m_dcx = NSS_CMSDecoder_Start(0, cb, arg, 0, m_ctx, 0, 0);</span>
<a href="#l8.543"></a><span id="l8.543">   if (!m_dcx) {</span>
<a href="#l8.544"></a><span id="l8.544">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-            (&quot;nsCMSDecoder::Start - can't start decoder\n&quot;));</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+            (&quot;nsCMSDecoder::Start - can't start decoder&quot;));</span>
<a href="#l8.547"></a><span id="l8.547">     return NS_ERROR_FAILURE;</span>
<a href="#l8.548"></a><span id="l8.548">   }</span>
<a href="#l8.549"></a><span id="l8.549">   return NS_OK;</span>
<a href="#l8.550"></a><span id="l8.550"> }</span>
<a href="#l8.551"></a><span id="l8.551"> </span>
<a href="#l8.552"></a><span id="l8.552"> /* void update (in string bug, in long len); */</span>
<a href="#l8.553"></a><span id="l8.553"> NS_IMETHODIMP nsCMSDecoder::Update(const char *buf, int32_t len) {</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Update\n&quot;));</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Update&quot;));</span>
<a href="#l8.556"></a><span id="l8.556">   NSS_CMSDecoder_Update(m_dcx, (char *)buf, len);</span>
<a href="#l8.557"></a><span id="l8.557">   return NS_OK;</span>
<a href="#l8.558"></a><span id="l8.558"> }</span>
<a href="#l8.559"></a><span id="l8.559"> </span>
<a href="#l8.560"></a><span id="l8.560"> /* void finish (); */</span>
<a href="#l8.561"></a><span id="l8.561"> NS_IMETHODIMP nsCMSDecoder::Finish(nsICMSMessage **aCMSMsg) {</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Finish\n&quot;));</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Finish&quot;));</span>
<a href="#l8.564"></a><span id="l8.564">   NSSCMSMessage *cmsMsg;</span>
<a href="#l8.565"></a><span id="l8.565">   cmsMsg = NSS_CMSDecoder_Finish(m_dcx);</span>
<a href="#l8.566"></a><span id="l8.566">   m_dcx = nullptr;</span>
<a href="#l8.567"></a><span id="l8.567">   if (cmsMsg) {</span>
<a href="#l8.568"></a><span id="l8.568">     nsCMSMessage *obj = new nsCMSMessage(cmsMsg);</span>
<a href="#l8.569"></a><span id="l8.569">     // The NSS object cmsMsg still carries a reference to the context</span>
<a href="#l8.570"></a><span id="l8.570">     // we gave it on construction.</span>
<a href="#l8.571"></a><span id="l8.571">     // Make sure the context will live long enough.</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineat">@@ -818,51 +815,51 @@ nsresult nsCMSEncoder::Init() {</span>
<a href="#l8.573"></a><span id="l8.573"> </span>
<a href="#l8.574"></a><span id="l8.574"> void nsCMSEncoder::destructorSafeDestroyNSSReference() {</span>
<a href="#l8.575"></a><span id="l8.575">   if (m_ecx) NSS_CMSEncoder_Cancel(m_ecx);</span>
<a href="#l8.576"></a><span id="l8.576"> }</span>
<a href="#l8.577"></a><span id="l8.577"> </span>
<a href="#l8.578"></a><span id="l8.578"> /* void start (); */</span>
<a href="#l8.579"></a><span id="l8.579"> NS_IMETHODIMP nsCMSEncoder::Start(nsICMSMessage *aMsg, NSSCMSContentCallback cb,</span>
<a href="#l8.580"></a><span id="l8.580">                                   void *arg) {</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start\n&quot;));</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start&quot;));</span>
<a href="#l8.583"></a><span id="l8.583">   nsCMSMessage *cmsMsg = static_cast&lt;nsCMSMessage *&gt;(aMsg);</span>
<a href="#l8.584"></a><span id="l8.584">   m_ctx = new PipUIContext();</span>
<a href="#l8.585"></a><span id="l8.585"> </span>
<a href="#l8.586"></a><span id="l8.586">   m_ecx = NSS_CMSEncoder_Start(cmsMsg-&gt;getCMS(), cb, arg, 0, 0, 0, m_ctx, 0, 0,</span>
<a href="#l8.587"></a><span id="l8.587">                                0, 0);</span>
<a href="#l8.588"></a><span id="l8.588">   if (!m_ecx) {</span>
<a href="#l8.589"></a><span id="l8.589">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-            (&quot;nsCMSEncoder::Start - can't start encoder\n&quot;));</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+            (&quot;nsCMSEncoder::Start - can't start encoder&quot;));</span>
<a href="#l8.592"></a><span id="l8.592">     return NS_ERROR_FAILURE;</span>
<a href="#l8.593"></a><span id="l8.593">   }</span>
<a href="#l8.594"></a><span id="l8.594">   return NS_OK;</span>
<a href="#l8.595"></a><span id="l8.595"> }</span>
<a href="#l8.596"></a><span id="l8.596"> </span>
<a href="#l8.597"></a><span id="l8.597"> /* void update (in string aBuf, in long aLen); */</span>
<a href="#l8.598"></a><span id="l8.598"> NS_IMETHODIMP nsCMSEncoder::Update(const char *aBuf, int32_t aLen) {</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update\n&quot;));</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update&quot;));</span>
<a href="#l8.601"></a><span id="l8.601">   if (!m_ecx || NSS_CMSEncoder_Update(m_ecx, aBuf, aLen) != SECSuccess) {</span>
<a href="#l8.602"></a><span id="l8.602">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-            (&quot;nsCMSEncoder::Update - can't update encoder\n&quot;));</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+            (&quot;nsCMSEncoder::Update - can't update encoder&quot;));</span>
<a href="#l8.605"></a><span id="l8.605">     return NS_ERROR_FAILURE;</span>
<a href="#l8.606"></a><span id="l8.606">   }</span>
<a href="#l8.607"></a><span id="l8.607">   return NS_OK;</span>
<a href="#l8.608"></a><span id="l8.608"> }</span>
<a href="#l8.609"></a><span id="l8.609"> </span>
<a href="#l8.610"></a><span id="l8.610"> /* void finish (); */</span>
<a href="#l8.611"></a><span id="l8.611"> NS_IMETHODIMP nsCMSEncoder::Finish() {</span>
<a href="#l8.612"></a><span id="l8.612">   nsresult rv = NS_OK;</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish\n&quot;));</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish&quot;));</span>
<a href="#l8.615"></a><span id="l8.615">   if (!m_ecx || NSS_CMSEncoder_Finish(m_ecx) != SECSuccess) {</span>
<a href="#l8.616"></a><span id="l8.616">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-            (&quot;nsCMSEncoder::Finish - can't finish encoder\n&quot;));</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+            (&quot;nsCMSEncoder::Finish - can't finish encoder&quot;));</span>
<a href="#l8.619"></a><span id="l8.619">     rv = NS_ERROR_FAILURE;</span>
<a href="#l8.620"></a><span id="l8.620">   }</span>
<a href="#l8.621"></a><span id="l8.621">   m_ecx = nullptr;</span>
<a href="#l8.622"></a><span id="l8.622">   return rv;</span>
<a href="#l8.623"></a><span id="l8.623"> }</span>
<a href="#l8.624"></a><span id="l8.624"> </span>
<a href="#l8.625"></a><span id="l8.625"> /* void encode (in nsICMSMessage aMsg); */</span>
<a href="#l8.626"></a><span id="l8.626"> NS_IMETHODIMP nsCMSEncoder::Encode(nsICMSMessage *aMsg) {</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Encode\n&quot;));</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Encode&quot;));</span>
<a href="#l8.629"></a><span id="l8.629">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.630"></a><span id="l8.630"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

