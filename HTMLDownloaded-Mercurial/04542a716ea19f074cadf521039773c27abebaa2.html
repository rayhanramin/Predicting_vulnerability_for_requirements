<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3777:04542a716ea19f074cadf521039773c27abebaa2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 04542a716ea19f074cadf521039773c27abebaa2" />
<meta property="og:url" content="/comm-central/rev/04542a716ea19f074cadf521039773c27abebaa2" />
<meta property="og:description" content="Bug 493060 - Installer default mail client option doesn't set it correctly on Windows XP, r=rs, rs=philor, a=blocker" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 04542a716ea19f074cadf521039773c27abebaa2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/04542a716ea19f074cadf521039773c27abebaa2">shortlog</a> |
<a href="/comm-central/log/04542a716ea19f074cadf521039773c27abebaa2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/04542a716ea19f074cadf521039773c27abebaa2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/04542a716ea19f074cadf521039773c27abebaa2">files</a> |
changeset |
<a href="/comm-central/raw-rev/04542a716ea19f074cadf521039773c27abebaa2">raw</a>  | <a href="/comm-central/archive/04542a716ea19f074cadf521039773c27abebaa2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=493060">Bug 493060</a> - Installer default mail client option doesn't set it correctly on Windows XP, r=rs, rs=philor, a=blocker
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#32;&#87;&#101;&#105;&#110;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#109;&#99;&#115;&#109;&#117;&#114;&#102;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 11 Sep 2009 22:04:29 -0700</td></tr>

<tr>
 <td>changeset 3777</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/04542a716ea19f074cadf521039773c27abebaa2">04542a716ea19f074cadf521039773c27abebaa2</a></td>
</tr>



<tr>
<td>parent 3776</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bf357314fc7b3d9ef4e7cc7e0419ea343f9e49e2">bf357314fc7b3d9ef4e7cc7e0419ea343f9e49e2</a>
</td>
</tr>

<tr>
<td>child 3778</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e010e16d7983eadb67704b88c68d25a5db52b63c">e010e16d7983eadb67704b88c68d25a5db52b63c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=04542a716ea19f074cadf521039773c27abebaa2">2958</a></td></tr>
<tr><td>push user</td><td>philringnalda@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 12 Sep 2009 05:05:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@04542a716ea1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=04542a716ea19f074cadf521039773c27abebaa2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=04542a716ea19f074cadf521039773c27abebaa2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=04542a716ea19f074cadf521039773c27abebaa2&newProject=comm-central&newRevision=bf357314fc7b3d9ef4e7cc7e0419ea343f9e49e2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=04542a716ea19f074cadf521039773c27abebaa2&newProject=comm-central&newRevision=bf357314fc7b3d9ef4e7cc7e0419ea343f9e49e2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=04542a716ea19f074cadf521039773c27abebaa2&newProject=comm-central&newRevision=bf357314fc7b3d9ef4e7cc7e0419ea343f9e49e2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rs%29&revcount=50">rs</a>, <a href="/comm-central/log?rev=reviewer%28philor%29&revcount=50">philor</a>, <a href="/comm-central/log?rev=reviewer%28blocker%29&revcount=50">blocker</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=493060">493060</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=493060">Bug 493060</a> - Installer default mail client option doesn't set it correctly on Windows XP, r=rs, rs=philor, a=blocker</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/installer.nsi">mail/installer/windows/nsis/installer.nsi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/installer.nsi">file</a> |
<a href="/comm-central/annotate/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/installer.nsi">annotate</a> |
<a href="/comm-central/diff/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/installer.nsi">diff</a> |
<a href="/comm-central/comparison/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/installer.nsi">comparison</a> |
<a href="/comm-central/log/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/installer.nsi">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/shared.nsh">mail/installer/windows/nsis/shared.nsh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/shared.nsh">file</a> |
<a href="/comm-central/annotate/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/shared.nsh">annotate</a> |
<a href="/comm-central/diff/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/shared.nsh">diff</a> |
<a href="/comm-central/comparison/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/shared.nsh">comparison</a> |
<a href="/comm-central/log/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/shared.nsh">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/uninstaller.nsi">mail/installer/windows/nsis/uninstaller.nsi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/uninstaller.nsi">file</a> |
<a href="/comm-central/annotate/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/uninstaller.nsi">annotate</a> |
<a href="/comm-central/diff/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/uninstaller.nsi">diff</a> |
<a href="/comm-central/comparison/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/uninstaller.nsi">comparison</a> |
<a href="/comm-central/log/04542a716ea19f074cadf521039773c27abebaa2/mail/installer/windows/nsis/uninstaller.nsi">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/installer/windows/nsis/installer.nsi</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/installer/windows/nsis/installer.nsi</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -55,16 +55,24 @@ RequestExecutionLevel user</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> Var TmpVal</span>
<a href="#l1.6"></a><span id="l1.6"> Var StartMenuDir</span>
<a href="#l1.7"></a><span id="l1.7"> Var InstallType</span>
<a href="#l1.8"></a><span id="l1.8"> Var AddStartMenuSC</span>
<a href="#l1.9"></a><span id="l1.9"> Var AddQuickLaunchSC</span>
<a href="#l1.10"></a><span id="l1.10"> Var AddDesktopSC</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+; On Vista and above attempt to elevate Standard Users in addition to users that</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+; are a member of the Administrators group.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+!define NONADMIN_ELEVATE</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+; Don't use the PreDirectoryCommon macro's code for finding a pre-existing</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+; installation directory.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+!define NO_INSTDIR_PREDIRCOMMON</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20"> ; Other included files may depend upon these includes!</span>
<a href="#l1.21"></a><span id="l1.21"> ; The following includes are provided by NSIS.</span>
<a href="#l1.22"></a><span id="l1.22"> !include FileFunc.nsh</span>
<a href="#l1.23"></a><span id="l1.23"> !include LogicLib.nsh</span>
<a href="#l1.24"></a><span id="l1.24"> !include MUI.nsh</span>
<a href="#l1.25"></a><span id="l1.25"> !include WinMessages.nsh</span>
<a href="#l1.26"></a><span id="l1.26"> !include WinVer.nsh</span>
<a href="#l1.27"></a><span id="l1.27"> !include WordFunc.nsh</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -86,16 +94,17 @@ VIAddVersionKey &quot;OriginalFilename&quot; &quot;setu</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> ; Must be inserted before other macros that use logging</span>
<a href="#l1.31"></a><span id="l1.31"> !insertmacro _LoggingCommon</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> ; Most commonly used macros for managing shortcuts</span>
<a href="#l1.34"></a><span id="l1.34"> !insertmacro _LoggingShortcutsCommon</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> !insertmacro AddHandlerValues</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+!insertmacro CanWriteToInstallDir</span>
<a href="#l1.38"></a><span id="l1.38"> !insertmacro ChangeMUIHeaderImage</span>
<a href="#l1.39"></a><span id="l1.39"> !insertmacro CheckForFilesInUse</span>
<a href="#l1.40"></a><span id="l1.40"> !insertmacro CleanUpdatesDir</span>
<a href="#l1.41"></a><span id="l1.41"> !insertmacro CopyFilesFromDir</span>
<a href="#l1.42"></a><span id="l1.42"> !insertmacro FindSMProgramsDir</span>
<a href="#l1.43"></a><span id="l1.43"> !insertmacro GetPathFromString</span>
<a href="#l1.44"></a><span id="l1.44"> !insertmacro GetParent</span>
<a href="#l1.45"></a><span id="l1.45"> !insertmacro IsHandlerForInstallDir</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineat">@@ -330,16 +339,20 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">   ; The order that reg keys and values are added is important if you use the</span>
<a href="#l1.49"></a><span id="l1.49">   ; uninstall log to remove them on uninstall. When using the uninstall log you</span>
<a href="#l1.50"></a><span id="l1.50">   ; MUST add children first so they will be removed first on uninstall so they</span>
<a href="#l1.51"></a><span id="l1.51">   ; will be empty when the key is deleted. This allows the uninstaller to</span>
<a href="#l1.52"></a><span id="l1.52">   ; specify that only empty keys will be deleted.</span>
<a href="#l1.53"></a><span id="l1.53">   ${SetAppKeys}</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  ; Uninstall keys can only exist under HKLM on some versions of windows. Since</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  ; it doesn't cause problems always add them.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  ${SetUninstallKeys}</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+</span>
<a href="#l1.59"></a><span id="l1.59">   ; On install always add the ThunderbirdEML, Thunderbird.Url.mailto, and</span>
<a href="#l1.60"></a><span id="l1.60">   ; Thunderbird.Url.news keys.</span>
<a href="#l1.61"></a><span id="l1.61">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l1.62"></a><span id="l1.62">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l1.63"></a><span id="l1.63">   StrCpy $1 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l1.64"></a><span id="l1.64">   StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l1.65"></a><span id="l1.65">   StrCpy $3 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineat">@@ -349,19 +362,16 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l1.68"></a><span id="l1.68">                       &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l1.69"></a><span id="l1.69">   ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot;  &quot;$2&quot; &quot;$8,0&quot; \</span>
<a href="#l1.70"></a><span id="l1.70">                       &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l1.71"></a><span id="l1.71">   ${AddHandlerValues} &quot;$0\Thunderbird.Url.news&quot; &quot;$3&quot; &quot;$8,0&quot; \</span>
<a href="#l1.72"></a><span id="l1.72">                       &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">   ; The following keys should only be set if we can write to HKLM</span>
<a href="#l1.75"></a><span id="l1.75">   ${If} $TmpVal == &quot;HKLM&quot;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    ; Uninstall keys can only exist under HKLM on some versions of windows.</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-    ${SetUninstallKeys}</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-</span>
<a href="#l1.79"></a><span id="l1.79">     ; Set the Start Menu Internet and Vista Registered App HKLM registry keys.</span>
<a href="#l1.80"></a><span id="l1.80">     ${SetClientsMail}</span>
<a href="#l1.81"></a><span id="l1.81">     ${SetClientsNews}</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">     ; If we are writing to HKLM and create the quick launch and the desktop</span>
<a href="#l1.84"></a><span id="l1.84">     ; shortcuts set IconsVisible to 1 otherwise to 0.</span>
<a href="#l1.85"></a><span id="l1.85">     StrCpy $0 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l1.86"></a><span id="l1.86">     ${If} $AddQuickLaunchSC == 1</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineat">@@ -373,109 +383,139 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l1.88"></a><span id="l1.88">   ${EndIf}</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90">   ; These need special handling on uninstall since they may be overwritten by</span>
<a href="#l1.91"></a><span id="l1.91">   ; an install into a different location.</span>
<a href="#l1.92"></a><span id="l1.92">   StrCpy $0 &quot;Software\Microsoft\Windows\CurrentVersion\App Paths\${FileMainEXE}&quot;</span>
<a href="#l1.93"></a><span id="l1.93">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l1.94"></a><span id="l1.94">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Path&quot; &quot;$INSTDIR&quot; 0</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-</span>
<a href="#l1.98"></a><span id="l1.98">   ; Create shortcuts</span>
<a href="#l1.99"></a><span id="l1.99">   ${LogHeader} &quot;Adding Shortcuts&quot;</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103">   ; Always add the relative path to the application's Start Menu directory and</span>
<a href="#l1.104"></a><span id="l1.104">   ; the application's shortcuts to the shortcuts log ini file. The</span>
<a href="#l1.105"></a><span id="l1.105">   ; DeleteShortcuts macro will do the right thing on uninstall if they don't</span>
<a href="#l1.106"></a><span id="l1.106">   ; exist.</span>
<a href="#l1.107"></a><span id="l1.107">   ${LogSMProgramsDirRelPath} &quot;$StartMenuDir&quot;</span>
<a href="#l1.108"></a><span id="l1.108">   ${LogSMProgramsShortcut} &quot;${BrandFullName}.lnk&quot;</span>
<a href="#l1.109"></a><span id="l1.109">   ${LogSMProgramsShortcut} &quot;${BrandFullName} ($(SAFE_MODE)).lnk&quot;</span>
<a href="#l1.110"></a><span id="l1.110">   ${LogQuickLaunchShortcut} &quot;${BrandFullName}.lnk&quot;</span>
<a href="#l1.111"></a><span id="l1.111">   ${LogDesktopShortcut} &quot;${BrandFullName}.lnk&quot;</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  ; UAC only allows elevating to an Admin account so there is no need to add</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  ; the Start Menu or Desktop shortcuts from the original unelevated process</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+  ; since this will either add it for the user if unelevated or All Users if</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  ; elevated.</span>
<a href="#l1.117"></a><span id="l1.117">   ${If} $AddStartMenuSC == 1</span>
<a href="#l1.118"></a><span id="l1.118">     ${Unless} ${FileExists} &quot;$SMPROGRAMS\$StartMenuDir&quot;</span>
<a href="#l1.119"></a><span id="l1.119">       CreateDirectory &quot;$SMPROGRAMS\$StartMenuDir&quot;</span>
<a href="#l1.120"></a><span id="l1.120">       ${LogMsg} &quot;Added Start Menu Directory: $SMPROGRAMS\$StartMenuDir&quot;</span>
<a href="#l1.121"></a><span id="l1.121">     ${EndUnless}</span>
<a href="#l1.122"></a><span id="l1.122">     CreateShortCut &quot;$SMPROGRAMS\$StartMenuDir\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l1.123"></a><span id="l1.123">     ${LogMsg} &quot;Added Shortcut: $SMPROGRAMS\$StartMenuDir\${BrandFullName}.lnk&quot;</span>
<a href="#l1.124"></a><span id="l1.124">     CreateShortCut &quot;$SMPROGRAMS\$StartMenuDir\${BrandFullName} ($(SAFE_MODE)).lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;-safe-mode&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l1.125"></a><span id="l1.125">     ${LogMsg} &quot;Added Shortcut: $SMPROGRAMS\$StartMenuDir\${BrandFullName} ($(SAFE_MODE)).lnk&quot;</span>
<a href="#l1.126"></a><span id="l1.126">   ${EndIf}</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  ${If} $AddQuickLaunchSC == 1</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    CreateShortCut &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-    ${LogMsg} &quot;Added Shortcut: $QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  ${EndIf}</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  !insertmacro MUI_STARTMENU_WRITE_END</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">   ${If} $AddDesktopSC == 1</span>
<a href="#l1.135"></a><span id="l1.135">     CreateShortCut &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l1.136"></a><span id="l1.136">     ${LogMsg} &quot;Added Shortcut: $DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l1.137"></a><span id="l1.137">   ${EndIf}</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  !insertmacro MUI_STARTMENU_WRITE_END</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+  ; If elevated the Quick Launch shortcut must be added from the unelevated</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  ; original process.</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  ${If} $AddQuickLaunchSC == 1</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+    ClearErrors</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    ${GetParameters} $0</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+    ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+    ${If} ${Errors}</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+      Call AddQuickLaunchShortcut</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+      ${LogMsg} &quot;Added Shortcut: $QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    ${Else}</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+      ; It is not possible to add a log entry from the unelevated process so</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+      ; add the log entry without the path since there is no simple way to know</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+      ; the correct full path.</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+      ${LogMsg} &quot;Added Quick Launch Shortcut: ${BrandFullName}.lnk&quot;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+      GetFunctionAddress $0 AddQuickLaunchShortcut</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+      UAC::ExecCodeSegment $0</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+    ${EndIf}</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.158"></a><span id="l1.158"> SectionEnd</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160"> ; Cleanup operations to perform at the end of the installation.</span>
<a href="#l1.161"></a><span id="l1.161"> Section &quot;-InstallEndCleanup&quot;</span>
<a href="#l1.162"></a><span id="l1.162">   SetDetailsPrint both</span>
<a href="#l1.163"></a><span id="l1.163">   DetailPrint &quot;$(STATUS_CLEANUP)&quot;</span>
<a href="#l1.164"></a><span id="l1.164">   SetDetailsPrint none</span>
<a href="#l1.165"></a><span id="l1.165"> </span>
<a href="#l1.166"></a><span id="l1.166">   ${Unless} ${Silent}</span>
<a href="#l1.167"></a><span id="l1.167">     ${MUI_INSTALLOPTIONS_READ} $0 &quot;options.ini&quot; &quot;Field 6&quot; &quot;State&quot;</span>
<a href="#l1.168"></a><span id="l1.168">     ${If} &quot;$0&quot; == &quot;1&quot;</span>
<a href="#l1.169"></a><span id="l1.169">       ${LogHeader} &quot;Setting as the default mail application&quot;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-      Call SetAsDefaultMailAppUser</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+      ClearErrors</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+      ${GetParameters} $0</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+      ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+      ${If} ${Errors}</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+        Call SetAsDefaultMailAppUserHKCU</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+      ${Else}</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+        GetFunctionAddress $0 SetAsDefaultMailAppUserHKCU</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+        UAC::ExecCodeSegment $0</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+      ${EndIf}</span>
<a href="#l1.180"></a><span id="l1.180">     ${EndIf}</span>
<a href="#l1.181"></a><span id="l1.181">   ${EndUnless}</span>
<a href="#l1.182"></a><span id="l1.182"> </span>
<a href="#l1.183"></a><span id="l1.183">   ${LogHeader} &quot;Updating Uninstall Log With Previous Uninstall Log&quot;</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185">   ; Refresh desktop icons</span>
<a href="#l1.186"></a><span id="l1.186">   System::Call &quot;shell32::SHChangeNotify(i, i, i, i) v (0x08000000, 0, 0, 0)&quot;</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188">   ${InstallEndCleanupCommon}</span>
<a href="#l1.189"></a><span id="l1.189"> </span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-  ; If we have to reboot give SHChangeNotify time to finish the refreshing</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-  ; the icons so the OS doesn't display the icons from helper.exe</span>
<a href="#l1.192"></a><span id="l1.192">   ${If} ${RebootFlag}</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+    ; If we have to reboot give SHChangeNotify time to finish refreshing</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+    ; the icons so the OS doesn't display the icons from helper.exe</span>
<a href="#l1.195"></a><span id="l1.195">     Sleep 10000</span>
<a href="#l1.196"></a><span id="l1.196">     ${LogHeader} &quot;Reboot Required To Finish Installation&quot;</span>
<a href="#l1.197"></a><span id="l1.197">     ; ${FileMainEXE}.moz-upgrade should never exist but just in case...</span>
<a href="#l1.198"></a><span id="l1.198">     ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l1.199"></a><span id="l1.199">       Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l1.200"></a><span id="l1.200">     ${EndUnless}</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202">     ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.203"></a><span id="l1.203">       ClearErrors</span>
<a href="#l1.204"></a><span id="l1.204">       Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l1.205"></a><span id="l1.205">       ${Unless} ${Errors}</span>
<a href="#l1.206"></a><span id="l1.206">         Delete /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l1.207"></a><span id="l1.207">       ${EndUnless}</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-    ${EndUnless}</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+    ${EndIf}</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211">     ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.212"></a><span id="l1.212">       CopyFiles /SILENT &quot;$INSTDIR\uninstall\helper.exe&quot; &quot;$INSTDIR&quot;</span>
<a href="#l1.213"></a><span id="l1.213">       FileOpen $0 &quot;$INSTDIR\${FileMainEXE}&quot; w</span>
<a href="#l1.214"></a><span id="l1.214">       FileWrite $0 &quot;Will be deleted on restart&quot;</span>
<a href="#l1.215"></a><span id="l1.215">       Rename /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.216"></a><span id="l1.216">       FileClose $0</span>
<a href="#l1.217"></a><span id="l1.217">       Delete &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.218"></a><span id="l1.218">       Rename &quot;$INSTDIR\helper.exe&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.219"></a><span id="l1.219">     ${EndUnless}</span>
<a href="#l1.220"></a><span id="l1.220">   ${EndIf}</span>
<a href="#l1.221"></a><span id="l1.221"> SectionEnd</span>
<a href="#l1.222"></a><span id="l1.222"> </span>
<a href="#l1.223"></a><span id="l1.223"> ################################################################################</span>
<a href="#l1.224"></a><span id="l1.224"> # Helper Functions</span>
<a href="#l1.225"></a><span id="l1.225"> </span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+Function AddQuickLaunchShortcut</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+  CreateShortCut &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+FunctionEnd</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+</span>
<a href="#l1.230"></a><span id="l1.230"> Function CheckExistingInstall</span>
<a href="#l1.231"></a><span id="l1.231">   ; If there is a pending file copy from a previous uninstall don't allow</span>
<a href="#l1.232"></a><span id="l1.232">   ; installing until after the system has rebooted.</span>
<a href="#l1.233"></a><span id="l1.233">   IfFileExists &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; +1 +4</span>
<a href="#l1.234"></a><span id="l1.234">   MessageBox MB_YESNO &quot;$(WARN_RESTART_REQUIRED_UPGRADE)&quot; IDNO +2</span>
<a href="#l1.235"></a><span id="l1.235">   Reboot</span>
<a href="#l1.236"></a><span id="l1.236">   Quit</span>
<a href="#l1.237"></a><span id="l1.237"> </span>
<a href="#l1.238"></a><span id="l1.238" class="difflineat">@@ -579,41 +619,59 @@ Function leaveOptions</span>
<a href="#l1.239"></a><span id="l1.239">   ${EndIf}</span>
<a href="#l1.240"></a><span id="l1.240">   ${MUI_INSTALLOPTIONS_READ} $R0 &quot;options.ini&quot; &quot;Field 2&quot; &quot;State&quot;</span>
<a href="#l1.241"></a><span id="l1.241">   StrCmp $R0 &quot;1&quot; +1 +2</span>
<a href="#l1.242"></a><span id="l1.242">   StrCpy $InstallType ${INSTALLTYPE_BASIC}</span>
<a href="#l1.243"></a><span id="l1.243">   ${MUI_INSTALLOPTIONS_READ} $R0 &quot;options.ini&quot; &quot;Field 3&quot; &quot;State&quot;</span>
<a href="#l1.244"></a><span id="l1.244">   StrCmp $R0 &quot;1&quot; +1 +2</span>
<a href="#l1.245"></a><span id="l1.245">   StrCpy $InstallType ${INSTALLTYPE_CUSTOM}</span>
<a href="#l1.246"></a><span id="l1.246"> </span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-  ${If} $InstallType != ${INSTALLTYPE_CUSTOM}</span>
<a href="#l1.248"></a><span id="l1.248"> !ifndef NO_INSTDIR_FROM_REG</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-    SetShellVarContext all      ; Set SHCTX to HKLM</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-    ${GetSingleInstallPath} &quot;Software\Mozilla\${BrandFullNameInternal}&quot; $R9</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  SetShellVarContext all      ; Set SHCTX to HKLM</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+  ${GetSingleInstallPath} &quot;Software\Mozilla\${BrandFullNameInternal}&quot; $R9</span>
<a href="#l1.253"></a><span id="l1.253"> </span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-    StrCmp &quot;$R9&quot; &quot;false&quot; +1 fix_install_dir</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  StrCmp &quot;$R9&quot; &quot;false&quot; +1 fix_install_dir</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-    SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-    ${GetSingleInstallPath} &quot;Software\Mozilla\${BrandFullNameInternal}&quot; $R9</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  ${GetSingleInstallPath} &quot;Software\Mozilla\${BrandFullNameInternal}&quot; $R9</span>
<a href="#l1.261"></a><span id="l1.261"> </span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-    fix_install_dir:</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-    StrCmp &quot;$R9&quot; &quot;false&quot; +2 +1</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-    StrCpy $INSTDIR &quot;$R9&quot;</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+  fix_install_dir:</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+  StrCmp &quot;$R9&quot; &quot;false&quot; +2 +1</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+  StrCpy $INSTDIR &quot;$R9&quot;</span>
<a href="#l1.268"></a><span id="l1.268"> !endif</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-    Call CheckExistingInstall</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+  ; If the user doesn't have write access to the installation directory set</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+  ; the installation directory to a subdirectory of the All Users application</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  ; directory and if the user can't write to that location set the installation</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+  ; directory to a subdirectory of the users local application directory</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+  ; (e.g. non-roaming).</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+  ${CanWriteToInstallDir} $R8</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+  ${If} &quot;$R8&quot; == &quot;false&quot;</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+    SetShellVarContext all      ; Set SHCTX to All Users</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+    StrCpy $INSTDIR &quot;$APPDATA\${BrandFullName}\&quot;</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+    ${If} ${FileExists} &quot;$INSTDIR&quot;</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+      ; Always display the long path if the path already exists.</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+      ${GetLongPath} &quot;$INSTDIR&quot; $INSTDIR</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+    ${EndIf}</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+    ${CanWriteToInstallDir} $R8</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+    ${If} &quot;$R8&quot; == &quot;false&quot;</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+      StrCpy $INSTDIR &quot;$LOCALAPPDATA\${BrandFullName}\&quot;</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+    ${EndIf}</span>
<a href="#l1.288"></a><span id="l1.288">   ${EndIf}</span>
<a href="#l1.289"></a><span id="l1.289"> FunctionEnd</span>
<a href="#l1.290"></a><span id="l1.290"> </span>
<a href="#l1.291"></a><span id="l1.291"> Function preDirectory</span>
<a href="#l1.292"></a><span id="l1.292">   ${PreDirectoryCommon}</span>
<a href="#l1.293"></a><span id="l1.293"> FunctionEnd</span>
<a href="#l1.294"></a><span id="l1.294"> </span>
<a href="#l1.295"></a><span id="l1.295"> Function leaveDirectory</span>
<a href="#l1.296"></a><span id="l1.296">   ${LeaveDirectoryCommon} &quot;$(WARN_DISK_SPACE)&quot; &quot;$(WARN_WRITE_ACCESS)&quot;</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  ${If} $InstallType != ${INSTALLTYPE_CUSTOM}</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+    Call CheckExistingInstall</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.300"></a><span id="l1.300"> FunctionEnd</span>
<a href="#l1.301"></a><span id="l1.301"> </span>
<a href="#l1.302"></a><span id="l1.302"> Function preShortcuts</span>
<a href="#l1.303"></a><span id="l1.303">   ${CheckCustomCommon}</span>
<a href="#l1.304"></a><span id="l1.304">   !insertmacro MUI_HEADER_TEXT &quot;$(SHORTCUTS_PAGE_TITLE)&quot; &quot;$(SHORTCUTS_PAGE_SUBTITLE)&quot;</span>
<a href="#l1.305"></a><span id="l1.305">   !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;shortcuts.ini&quot;</span>
<a href="#l1.306"></a><span id="l1.306"> FunctionEnd</span>
<a href="#l1.307"></a><span id="l1.307"> </span>
<a href="#l1.308"></a><span id="l1.308" class="difflineat">@@ -767,18 +825,39 @@ Function .onInit</span>
<a href="#l1.309"></a><span id="l1.309">   ${SetBrandNameVars} &quot;$EXEDIR\localized\distribution\setup.ini&quot;</span>
<a href="#l1.310"></a><span id="l1.310"> </span>
<a href="#l1.311"></a><span id="l1.311">   ${InstallOnInitCommon} &quot;$(WARN_MIN_SUPPORTED_OS_MSG)&quot;</span>
<a href="#l1.312"></a><span id="l1.312"> </span>
<a href="#l1.313"></a><span id="l1.313">   !insertmacro InitInstallOptionsFile &quot;options.ini&quot;</span>
<a href="#l1.314"></a><span id="l1.314">   !insertmacro InitInstallOptionsFile &quot;shortcuts.ini&quot;</span>
<a href="#l1.315"></a><span id="l1.315">   !insertmacro InitInstallOptionsFile &quot;summary.ini&quot;</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  ; Setup the options.ini file for the Custom Options Page</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Settings&quot; NumFields &quot;6&quot;</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+  ClearErrors</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+  ${If} ${AtLeastWinVista}</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+    WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+    ; Setup the options.ini file for the Custom Options Page without the option</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+    ; to set as default for Vista and above since the installer is unable to</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+    ; write to HKLM.</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Settings&quot; NumFields &quot;5&quot;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+  ${Else}</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+    DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+    ; Setup the options.ini file for the Custom Options Page with the option</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+    ; to set as default</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Settings&quot; NumFields &quot;6&quot;</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Type   &quot;checkbox&quot;</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Text   &quot;$(OPTIONS_MAKE_DEFAULT)&quot;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Left   &quot;0&quot;</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Right  &quot;-1&quot;</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Top    &quot;124&quot;</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Bottom &quot;145&quot;</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; State  &quot;1&quot;</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.342"></a><span id="l1.342"> </span>
<a href="#l1.343"></a><span id="l1.343">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 1&quot; Type   &quot;label&quot;</span>
<a href="#l1.344"></a><span id="l1.344">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 1&quot; Text   &quot;$(OPTIONS_SUMMARY)&quot;</span>
<a href="#l1.345"></a><span id="l1.345">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 1&quot; Left   &quot;0&quot;</span>
<a href="#l1.346"></a><span id="l1.346">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 1&quot; Right  &quot;-1&quot;</span>
<a href="#l1.347"></a><span id="l1.347">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 1&quot; Top    &quot;0&quot;</span>
<a href="#l1.348"></a><span id="l1.348">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 1&quot; Bottom &quot;10&quot;</span>
<a href="#l1.349"></a><span id="l1.349"> </span>
<a href="#l1.350"></a><span id="l1.350" class="difflineat">@@ -808,24 +887,16 @@ Function .onInit</span>
<a href="#l1.351"></a><span id="l1.351"> </span>
<a href="#l1.352"></a><span id="l1.352">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 5&quot; Type   &quot;label&quot;</span>
<a href="#l1.353"></a><span id="l1.353">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 5&quot; Text   &quot;$(OPTION_CUSTOM_DESC)&quot;</span>
<a href="#l1.354"></a><span id="l1.354">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 5&quot; Left   &quot;30&quot;</span>
<a href="#l1.355"></a><span id="l1.355">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 5&quot; Right  &quot;-1&quot;</span>
<a href="#l1.356"></a><span id="l1.356">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 5&quot; Top    &quot;67&quot;</span>
<a href="#l1.357"></a><span id="l1.357">   WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 5&quot; Bottom &quot;87&quot;</span>
<a href="#l1.358"></a><span id="l1.358"> </span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Type   &quot;checkbox&quot;</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Text   &quot;$(OPTIONS_MAKE_DEFAULT)&quot;</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Left   &quot;0&quot;</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Right  &quot;-1&quot;</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Top    &quot;124&quot;</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; Bottom &quot;145&quot;</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\options.ini&quot; &quot;Field 6&quot; State  &quot;1&quot;</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-</span>
<a href="#l1.367"></a><span id="l1.367">   ; Setup the shortcuts.ini file for the Custom Shortcuts Page</span>
<a href="#l1.368"></a><span id="l1.368">   WriteINIStr &quot;$PLUGINSDIR\shortcuts.ini&quot; &quot;Settings&quot; NumFields &quot;4&quot;</span>
<a href="#l1.369"></a><span id="l1.369"> </span>
<a href="#l1.370"></a><span id="l1.370">   WriteINIStr &quot;$PLUGINSDIR\shortcuts.ini&quot; &quot;Field 1&quot; Type   &quot;label&quot;</span>
<a href="#l1.371"></a><span id="l1.371">   WriteINIStr &quot;$PLUGINSDIR\shortcuts.ini&quot; &quot;Field 1&quot; Text   &quot;$(CREATE_ICONS_DESC)&quot;</span>
<a href="#l1.372"></a><span id="l1.372">   WriteINIStr &quot;$PLUGINSDIR\shortcuts.ini&quot; &quot;Field 1&quot; Left   &quot;0&quot;</span>
<a href="#l1.373"></a><span id="l1.373">   WriteINIStr &quot;$PLUGINSDIR\shortcuts.ini&quot; &quot;Field 1&quot; Right  &quot;-1&quot;</span>
<a href="#l1.374"></a><span id="l1.374">   WriteINIStr &quot;$PLUGINSDIR\shortcuts.ini&quot; &quot;Field 1&quot; Top    &quot;5&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/installer/windows/nsis/shared.nsh</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/installer/windows/nsis/shared.nsh</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -79,123 +79,34 @@</span>
<a href="#l2.4"></a><span id="l2.4">     ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.5"></a><span id="l2.5">     ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.6"></a><span id="l2.6">     ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.7"></a><span id="l2.7">       ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.8"></a><span id="l2.8">     ${EndIf}</span>
<a href="#l2.9"></a><span id="l2.9">     ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.10"></a><span id="l2.10">       ${SetClientsNews}</span>
<a href="#l2.11"></a><span id="l2.11">     ${EndIf}</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    ${SetUninstallKeys}</span>
<a href="#l2.14"></a><span id="l2.14">   ${EndIf}</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   ${RemoveDeprecatedKeys}</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  ; Add Software\Mozilla\ registry entries</span>
<a href="#l2.19"></a><span id="l2.19">   ${SetAppKeys}</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  ${SetUninstallKeys}</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   ; Remove files that may be left behind by the application in the</span>
<a href="#l2.23"></a><span id="l2.23">   ; VirtualStore directory.</span>
<a href="#l2.24"></a><span id="l2.24">   ${CleanVirtualStore}</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   ; Remove talkback if it is present (remove after bug 386760 is fixed)</span>
<a href="#l2.27"></a><span id="l2.27">   ${If} ${FileExists} &quot;$INSTDIR\extensions\talkback@mozilla.org\&quot;</span>
<a href="#l2.28"></a><span id="l2.28">     RmDir /r &quot;$INSTDIR\extensions\talkback@mozilla.org\&quot;</span>
<a href="#l2.29"></a><span id="l2.29">   ${EndIf}</span>
<a href="#l2.30"></a><span id="l2.30"> !macroend</span>
<a href="#l2.31"></a><span id="l2.31"> !define PostUpdate &quot;!insertmacro PostUpdate&quot;</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-!macro SetAsDefaultAppUser</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  ; It is only possible to set this installation of the application as the</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  ; Start Menu Mail handler if it was added to the HKLM Clients\Mail registry</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  ; keys.</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  ; http://support.microsoft.com/kb/297878</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  ${GetParameters} $R0</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  ClearErrors</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  ${GetOptions} &quot;$R0&quot; &quot;Mail&quot; $R1</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    ${EndIf}</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    ${If} &quot;$0&quot; != &quot;$INSTDIR&quot;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-      ClearErrors</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-      ${If} ${Errors}</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-        ; Prevent multiple elevation requests</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-        ClearErrors</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-        ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-        ${Unless} ${Errors}</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-          Quit</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-        ${EndUnless}</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-        ${ElevateUAC}</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-      ${EndIf}</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-      SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-      ${SetClientsMail}</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    ${EndIf}</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    WriteRegStr HKCU &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    ClearErrors</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    ${If} ${Errors}</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-      Call SetAsDefaultMailAppUser</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    ${Else}</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-      GetFunctionAddress $0 SetAsDefaultMailAppUser</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-      UAC::ExecCodeSegment $0</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-    ${EndIf}</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  ${EndUnless}</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-  ClearErrors</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  ${GetOptions} &quot;$R0&quot; &quot;News&quot; $R1</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-    ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-    ${EndIf}</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    ${If} &quot;$0&quot; != &quot;$INSTDIR&quot;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-      ClearErrors</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-      WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      ${If} ${Errors}</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-        ; Prevent multiple elevation requests</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-        ClearErrors</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-        ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-        ${Unless} ${Errors}</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-          DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-          Quit</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-        ${EndUnless}</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-        ${ElevateUAC}</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-      ${EndIf}</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-      SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-      ${SetClientsNews}</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    ${EndIf}</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    WriteRegStr HKCU &quot;Software\Clients\News&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-    ClearErrors</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-    ${If} ${Errors}</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-      Call SetAsDefaultNewsAppUser</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    ${Else}</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-      GetFunctionAddress $0 SetAsDefaultNewsAppUser</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-      UAC::ExecCodeSegment $0</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-    ${EndIf}</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  ${EndUnless}</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-  ${RemoveDeprecatedKeys}</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-!macroend</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-!define SetAsDefaultAppUser &quot;!insertmacro SetAsDefaultAppUser&quot;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-</span>
<a href="#l2.120"></a><span id="l2.120"> !macro SetAsDefaultAppGlobal</span>
<a href="#l2.121"></a><span id="l2.121">   ${RemoveDeprecatedKeys}</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">   SetShellVarContext all      ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.124"></a><span id="l2.124">   ${SetHandlersMail}</span>
<a href="#l2.125"></a><span id="l2.125">   ${SetHandlersNews}</span>
<a href="#l2.126"></a><span id="l2.126">   ${SetClientsMail}</span>
<a href="#l2.127"></a><span id="l2.127">   ${SetClientsNews}</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineat">@@ -271,17 +182,17 @@</span>
<a href="#l2.129"></a><span id="l2.129">   ; An empty string is used for the 5th param because ThunderbirdEML is not a</span>
<a href="#l2.130"></a><span id="l2.130">   ; protocol handler</span>
<a href="#l2.131"></a><span id="l2.131">   ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot;  &quot;$1&quot; &quot;$8,0&quot; \</span>
<a href="#l2.132"></a><span id="l2.132">                       &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l2.133"></a><span id="l2.133">   ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot;  &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.134"></a><span id="l2.134">   ${AddHandlerValues} &quot;$0\mailto&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.135"></a><span id="l2.135"> </span>
<a href="#l2.136"></a><span id="l2.136">   ; Associate the file handlers with ThunderbirdEML</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-  ReadRegStr $6 HKCR &quot;.eml&quot; &quot;&quot;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+  ReadRegStr $6 SHCTX &quot;.eml&quot; &quot;&quot;</span>
<a href="#l2.139"></a><span id="l2.139">   ${If} &quot;$6&quot; != &quot;ThunderbirdEML&quot;</span>
<a href="#l2.140"></a><span id="l2.140">     WriteRegStr SHCTX &quot;$0\.eml&quot;   &quot;&quot; &quot;ThunderbirdEML&quot;</span>
<a href="#l2.141"></a><span id="l2.141">   ${EndIf}</span>
<a href="#l2.142"></a><span id="l2.142"> !macroend</span>
<a href="#l2.143"></a><span id="l2.143"> !define SetHandlersMail &quot;!insertmacro SetHandlersMail&quot;</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145"> !macro SetHandlersNews</span>
<a href="#l2.146"></a><span id="l2.146">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineat">@@ -478,37 +389,56 @@</span>
<a href="#l2.148"></a><span id="l2.148">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;GeckoVer&quot; &quot;${GREVersion}&quot; 0</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}&quot;</span>
<a href="#l2.151"></a><span id="l2.151">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;&quot; &quot;${GREVersion}&quot; 0</span>
<a href="#l2.152"></a><span id="l2.152">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;CurrentVersion&quot; &quot;${AppVersion} (${AB_CD})&quot; 0</span>
<a href="#l2.153"></a><span id="l2.153"> !macroend</span>
<a href="#l2.154"></a><span id="l2.154"> !define SetAppKeys &quot;!insertmacro SetAppKeys&quot;</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+; Add uninstall registry entries. This macro tests for write access to determine</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+; if the uninstall keys should be added to HKLM or HKCU.</span>
<a href="#l2.158"></a><span id="l2.158"> !macro SetUninstallKeys</span>
<a href="#l2.159"></a><span id="l2.159">   StrCpy $0 &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${BrandFullNameInternal} (${AppVersion})&quot;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  WriteRegStr HKLM &quot;$0&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    StrCpy $1 &quot;HKCU&quot;</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  ${Else}</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    StrCpy $1 &quot;HKLM&quot;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+    SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    DeleteRegValue HKLM &quot;$0&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+</span>
<a href="#l2.171"></a><span id="l2.171">   ${GetLongPath} &quot;$INSTDIR&quot; $8</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">   ; Write the uninstall registry keys</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Comments&quot; &quot;${BrandFullNameInternal}&quot; 0</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayIcon&quot; &quot;$8\${FileMainEXE},0&quot; 0</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayName&quot; &quot;${BrandFullNameInternal} (${AppVersion})&quot; 0</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayVersion&quot; &quot;${AppVersion} (${AB_CD})&quot; 0</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;InstallLocation&quot; &quot;$8&quot; 0</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Publisher&quot; &quot;Mozilla&quot; 0</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;UninstallString&quot; &quot;$8\uninstall\helper.exe&quot; 0</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;URLInfoAbout&quot; &quot;${URLInfoAbout}&quot; 0</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;URLUpdateInfo&quot; &quot;${URLUpdateInfo}&quot; 0</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-  ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;NoModify&quot; 1 0</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-  ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;NoRepair&quot; 1 0</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;Comments&quot; &quot;${BrandFullNameInternal}&quot; 0</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;DisplayIcon&quot; &quot;$8\${FileMainEXE},0&quot; 0</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;DisplayName&quot; &quot;${BrandFullNameInternal} (${AppVersion})&quot; 0</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;DisplayVersion&quot; &quot;${AppVersion} (${AB_CD})&quot; 0</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;InstallLocation&quot; &quot;$8&quot; 0</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;Publisher&quot; &quot;Mozilla&quot; 0</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;UninstallString&quot; &quot;$8\uninstall\helper.exe&quot; 0</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;URLInfoAbout&quot; &quot;${URLInfoAbout}&quot; 0</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+  ${WriteRegStr2} $1 &quot;$0&quot; &quot;URLUpdateInfo&quot; &quot;${URLUpdateInfo}&quot; 0</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+  ${WriteRegDWORD2} $1 &quot;$0&quot; &quot;NoModify&quot; 1 0</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+  ${WriteRegDWORD2} $1 &quot;$0&quot; &quot;NoRepair&quot; 1 0</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+  ${If} &quot;$TmpVal&quot; == &quot;HKLM&quot;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  ${Else}</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+    SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.202"></a><span id="l2.202"> !macroend</span>
<a href="#l2.203"></a><span id="l2.203"> !define SetUninstallKeys &quot;!insertmacro SetUninstallKeys&quot;</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205"> ; Updates protocol handlers if their registry open command value is for this</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-; install location</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+; install location (uses SHCTX)</span>
<a href="#l2.208"></a><span id="l2.208"> !macro UpdateProtocolHandlers</span>
<a href="#l2.209"></a><span id="l2.209">   ; Store the command to open the app with an url in a register for easy access.</span>
<a href="#l2.210"></a><span id="l2.210">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l2.211"></a><span id="l2.211">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l2.212"></a><span id="l2.212">   StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.213"></a><span id="l2.213">   StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.214"></a><span id="l2.214">   StrCpy $3 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.215"></a><span id="l2.215"> </span>
<a href="#l2.216"></a><span id="l2.216" class="difflineat">@@ -549,16 +479,17 @@</span>
<a href="#l2.217"></a><span id="l2.217"> </span>
<a href="#l2.218"></a><span id="l2.218">   ${IsHandlerForInstallDir} &quot;nntp&quot; $R9</span>
<a href="#l2.219"></a><span id="l2.219">   ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l2.220"></a><span id="l2.220">     ${AddHandlerValues} &quot;SOFTWARE\Classes\nntp&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l2.221"></a><span id="l2.221">   ${EndIf}</span>
<a href="#l2.222"></a><span id="l2.222"> !macroend</span>
<a href="#l2.223"></a><span id="l2.223"> !define UpdateProtocolHandlers &quot;!insertmacro UpdateProtocolHandlers&quot;</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+; Removes various registry entries for reasons noted below (does not use SHCTX).</span>
<a href="#l2.226"></a><span id="l2.226"> !macro RemoveDeprecatedKeys</span>
<a href="#l2.227"></a><span id="l2.227">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l2.228"></a><span id="l2.228"> </span>
<a href="#l2.229"></a><span id="l2.229">   ; remove DI and SOC from the .eml class if it exists and contains</span>
<a href="#l2.230"></a><span id="l2.230">   ; thunderbird.exe</span>
<a href="#l2.231"></a><span id="l2.231">   ClearErrors</span>
<a href="#l2.232"></a><span id="l2.232">   ReadRegStr $1 HKLM &quot;$0\.eml\shell\open\command&quot; &quot;&quot;</span>
<a href="#l2.233"></a><span id="l2.233">   ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineat">@@ -602,16 +533,22 @@</span>
<a href="#l2.235"></a><span id="l2.235">     DeleteRegKey HKLM &quot;SOFTWARE\clients\news\Shredder&quot;</span>
<a href="#l2.236"></a><span id="l2.236">   ${EndUnless}</span>
<a href="#l2.237"></a><span id="l2.237"> </span>
<a href="#l2.238"></a><span id="l2.238">   ; The Vista shim for 1.5.0.10 writes out a set of bogus keys which we need to</span>
<a href="#l2.239"></a><span id="l2.239">   ; cleanup. Intentionally hard coding Mozilla Thunderbird here</span>
<a href="#l2.240"></a><span id="l2.240">   ; as this is the string used by the vista shim.</span>
<a href="#l2.241"></a><span id="l2.241">   DeleteRegKey HKLM &quot;$0\Mozilla Thunderbird.Url.mailto&quot;</span>
<a href="#l2.242"></a><span id="l2.242">   DeleteRegValue HKLM &quot;Software\RegisteredApplications&quot; &quot;Mozilla Thunderbird&quot;</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+  ; Remove the app compatibility registry key</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+  StrCpy $0 &quot;Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers&quot;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  DeleteRegValue HKLM &quot;$0&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+  DeleteRegValue HKCU &quot;$0&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+</span>
<a href="#l2.249"></a><span id="l2.249"> !macroend</span>
<a href="#l2.250"></a><span id="l2.250"> !define RemoveDeprecatedKeys &quot;!insertmacro RemoveDeprecatedKeys&quot;</span>
<a href="#l2.251"></a><span id="l2.251"> </span>
<a href="#l2.252"></a><span id="l2.252"> ; Creates the shortcuts log ini file with the appropriate entries if it doesn't</span>
<a href="#l2.253"></a><span id="l2.253"> ; already exist.</span>
<a href="#l2.254"></a><span id="l2.254"> !macro CreateShortcutsLog</span>
<a href="#l2.255"></a><span id="l2.255">   ${GetShortcutsLogPath} $0</span>
<a href="#l2.256"></a><span id="l2.256">   ${Unless} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineat">@@ -684,39 +621,184 @@</span>
<a href="#l2.258"></a><span id="l2.258">   Push &quot;MapiProxy.dll&quot;</span>
<a href="#l2.259"></a><span id="l2.259">   Push &quot;MapiProxy_InUse.dll&quot;</span>
<a href="#l2.260"></a><span id="l2.260">   Push &quot;mozMapi32.dll&quot;</span>
<a href="#l2.261"></a><span id="l2.261">   Push &quot;mozMapi32_InUse.dll&quot;</span>
<a href="#l2.262"></a><span id="l2.262">   Push &quot;${FileMainEXE}&quot;</span>
<a href="#l2.263"></a><span id="l2.263"> !macroend</span>
<a href="#l2.264"></a><span id="l2.264"> !define PushFilesToCheck &quot;!insertmacro PushFilesToCheck&quot;</span>
<a href="#l2.265"></a><span id="l2.265"> </span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-; The !ifdef NO_LOG prevents warnings when compiling the installer since these</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-; functions are currently only used by the uninstaller.</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-Function SetAsDefaultMailAppUser</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+; The !ifdef NO_LOG prevents warnings when compiling the installer.nsi due to</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+; this function only being used by the uninstaller.nsi.</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+!ifdef NO_LOG</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+Function SetAsDefaultAppUser</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+  ; It is only possible to set this installation of the application as the</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+  ; Mail handler if it was added to the HKLM Mail</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+  ; registry keys.</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+  ; http://support.microsoft.com/kb/297878</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+  ${GetParameters} $R0</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  ClearErrors</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+  ${GetOptions} &quot;$R0&quot; &quot;Mail&quot; $R1</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+    ; Check if this install location registered as the Mail client</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+    ClearErrors</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+        ; Check if this is running in an elevated process</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+        ClearErrors</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+        ${GetParameters} $0</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+        ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+        ${If} ${Errors} ; Not elevated</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+          Call SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+        ${Else} ; Elevated - execute the function in the unelevated process</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+          GetFunctionAddress $0 SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+          UAC::ExecCodeSegment $0</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+        ${EndIf}</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+        ; Do we also set TB as default News client? If not we can return</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+        ClearErrors</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+        ${GetOptions} &quot;$R0&quot; &quot;News&quot; $R1</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+        ${If} ${Errors}</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+          Return</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+        ${EndIf}</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+      ${EndIf}</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+  ${EndUnless}</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+  ClearErrors</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+  ${GetOptions} &quot;$R0&quot; &quot;News&quot; $R1</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+    ; Check if this install location registered as the News client</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+    ClearErrors</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+        ; Check if this is running in an elevated process</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+        ClearErrors</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+        ${GetParameters} $0</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+        ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+        ${If} ${Errors} ; Not elevated</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+          Call SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+        ${Else} ; Elevated - execute the function in the unelevated process</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+          GetFunctionAddress $0 SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+          UAC::ExecCodeSegment $0</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+        ${EndIf}</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+        Return ; Nothing more needs to be done</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+      ${EndIf}</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+  ${EndUnless}</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+  ; The code after ElevateUAC won't be executed on Vista and above when the</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+  ; user:</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+  ; a) is a member of the administrators group (e.g. elevation is required)</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+  ; b) is not a member of the administrators group and chooses to elevate</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+  ${ElevateUAC}</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+  ${SetClientsMail}</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+  ${SetClientsNews}</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+  SetShellVarContext all  ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+  ${RemoveDeprecatedKeys}</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+  ClearErrors</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+  ${GetParameters} $0</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+  ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    ClearErrors</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+    ${GetOptions} &quot;$R0&quot; &quot;Mail&quot; $R1</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+      Call SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+    ${EndUnless}</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+    ClearErrors</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+    ${GetOptions} &quot;$R0&quot; &quot;News&quot; $R1</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+      Call SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+    ${EndUnless}</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+  ${Else}</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+    ${GetOptions} &quot;$R0&quot; &quot;Mail&quot; $R1</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+      GetFunctionAddress $0 SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+      UAC::ExecCodeSegment $0</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+    ${EndUnless}</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+    ClearErrors</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+    ${GetOptions} &quot;$R0&quot; &quot;News&quot; $R1</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+      GetFunctionAddress $0 SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+      UAC::ExecCodeSegment $0</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    ${EndUnless}</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+FunctionEnd</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+!define SetAsDefaultAppUser &quot;Call SetAsDefaultAppUser&quot;</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+!endif</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+Function SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+  ; Only set as the user's Mail client if the StartMenuInternet</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+  ; registry keys are for this install.</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+  ClearErrors</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+  ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+        WriteRegStr HKCU &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      ${EndIf}</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+  ${EndUnless}</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+</span>
<a href="#l2.398"></a><span id="l2.398">   SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.399"></a><span id="l2.399">   ${SetHandlersMail}</span>
<a href="#l2.400"></a><span id="l2.400">   ${If} ${AtLeastWinVista}</span>
<a href="#l2.401"></a><span id="l2.401">     ClearErrors</span>
<a href="#l2.402"></a><span id="l2.402">     ReadRegStr $0 HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l2.403"></a><span id="l2.403">     ; Only register as the handler on Vista if the app registry name exists</span>
<a href="#l2.404"></a><span id="l2.404">     ; under the RegisteredApplications registry key.</span>
<a href="#l2.405"></a><span id="l2.405">     ${Unless} ${Errors}</span>
<a href="#l2.406"></a><span id="l2.406">       AppAssocReg::SetAppAsDefaultAll &quot;${AppRegNameMail}&quot;</span>
<a href="#l2.407"></a><span id="l2.407">     ${EndUnless}</span>
<a href="#l2.408"></a><span id="l2.408">   ${EndIf}</span>
<a href="#l2.409"></a><span id="l2.409"> FunctionEnd</span>
<a href="#l2.410"></a><span id="l2.410"> </span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+; The !ifdef NO_LOG prevents warnings when compiling the installer.nsi due to</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+; this function only being used by SetAsDefaultAppUser.</span>
<a href="#l2.413"></a><span id="l2.413"> !ifdef NO_LOG</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-Function SetAsDefaultNewsAppUser</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+Function SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+  ; Only set as the user's News client if the StartMenuInternet</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+  ; registry keys are for this install.</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+  ClearErrors</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+  ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+        WriteRegStr HKCU &quot;Software\Clients\News&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+      ${EndIf}</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+  ${EndUnless}</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+</span>
<a href="#l2.432"></a><span id="l2.432">   SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.433"></a><span id="l2.433">   ${SetHandlersNews}</span>
<a href="#l2.434"></a><span id="l2.434">   ${If} ${AtLeastWinVista}</span>
<a href="#l2.435"></a><span id="l2.435">     ClearErrors</span>
<a href="#l2.436"></a><span id="l2.436">     ReadRegStr $0 HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l2.437"></a><span id="l2.437">     ; Only register as the handler on Vista if the app registry name exists</span>
<a href="#l2.438"></a><span id="l2.438">     ; under the RegisteredApplications registry key.</span>
<a href="#l2.439"></a><span id="l2.439">     ${Unless} ${Errors}</span>
<a href="#l2.440"></a><span id="l2.440">       AppAssocReg::SetAppAsDefaultAll &quot;${AppRegNameNews}&quot;</span>
<a href="#l2.441"></a><span id="l2.441">     ${EndUnless}</span>
<a href="#l2.442"></a><span id="l2.442">   ${EndIf}</span>
<a href="#l2.443"></a><span id="l2.443"> FunctionEnd</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+</span>
<a href="#l2.445"></a><span id="l2.445"> !endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/installer/windows/nsis/uninstaller.nsi</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/installer/windows/nsis/uninstaller.nsi</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -48,16 +48,20 @@</span>
<a href="#l3.4"></a><span id="l3.4"> SetDatablockOptimize on</span>
<a href="#l3.5"></a><span id="l3.5"> SetCompress off</span>
<a href="#l3.6"></a><span id="l3.6"> CRCCheck on</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> RequestExecutionLevel user</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> !addplugindir ./</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+; On Vista and above attempt to elevate Standard Users in addition to users that</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+; are a member of the Administrators group.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+!define NONADMIN_ELEVATE</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16"> ; prevents compiling of the reg write logging.</span>
<a href="#l3.17"></a><span id="l3.17"> !define NO_LOG</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> Var TmpVal</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> ; Other included files may depend upon these includes!</span>
<a href="#l3.22"></a><span id="l3.22"> ; The following includes are provided by NSIS.</span>
<a href="#l3.23"></a><span id="l3.23"> !include FileFunc.nsh</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -86,16 +90,17 @@ Var TmpVal</span>
<a href="#l3.25"></a><span id="l3.25"> VIAddVersionKey &quot;FileDescription&quot;  &quot;${BrandShortName} Helper&quot;</span>
<a href="#l3.26"></a><span id="l3.26"> VIAddVersionKey &quot;OriginalFilename&quot; &quot;helper.exe&quot;</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> ; Most commonly used macros for managing shortcuts</span>
<a href="#l3.29"></a><span id="l3.29"> !insertmacro _LoggingShortcutsCommon</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31"> !insertmacro AddHandlerValues</span>
<a href="#l3.32"></a><span id="l3.32"> !insertmacro CleanVirtualStore</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+!insertmacro ElevateUAC</span>
<a href="#l3.34"></a><span id="l3.34"> !insertmacro FindSMProgramsDir</span>
<a href="#l3.35"></a><span id="l3.35"> !insertmacro GetLongPath</span>
<a href="#l3.36"></a><span id="l3.36"> !insertmacro GetPathFromString</span>
<a href="#l3.37"></a><span id="l3.37"> !insertmacro IsHandlerForInstallDir</span>
<a href="#l3.38"></a><span id="l3.38"> !insertmacro RegCleanMain</span>
<a href="#l3.39"></a><span id="l3.39"> !insertmacro RegCleanUninstall</span>
<a href="#l3.40"></a><span id="l3.40"> !insertmacro SetBrandNameVars</span>
<a href="#l3.41"></a><span id="l3.41"> !insertmacro UnloadUAC</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

