<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27454:ab9b63f9d2266b4607b926ba227d89ae117bb3f9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ab9b63f9d2266b4607b926ba227d89ae117bb3f9" />
<meta property="og:url" content="/comm-central/rev/ab9b63f9d2266b4607b926ba227d89ae117bb3f9" />
<meta property="og:description" content="Bug 1577835 - Reformat common/ and ldap/ code. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ab9b63f9d2266b4607b926ba227d89ae117bb3f9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">shortlog</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">files</a> |
changeset |
<a href="/comm-central/raw-rev/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">raw</a>  | <a href="/comm-central/archive/ab9b63f9d2266b4607b926ba227d89ae117bb3f9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">Bug 1577835</a> - Reformat common/ and ldap/ code. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 30 Aug 2019 15:15:33 -0400</td></tr>

<tr>
 <td>changeset 27454</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">ab9b63f9d2266b4607b926ba227d89ae117bb3f9</a></td>
</tr>



<tr>
<td>parent 27453</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/23725f0afc965c077f70a3cab7c75245c8e34189">23725f0afc965c077f70a3cab7c75245c8e34189</a>
</td>
</tr>

<tr>
<td>child 27455</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8d3544b6352837c58cc4984fdd0412800f863e7c">8d3544b6352837c58cc4984fdd0412800f863e7c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ab9b63f9d2266b4607b926ba227d89ae117bb3f9">16348</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 01 Sep 2019 21:02:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8177b85d18db [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8177b85d18db77c4787461cd6db9575ef9935aea">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8177b85d18db77c4787461cd6db9575ef9935aea&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">1577835</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">Bug 1577835</a> - Reformat common/ and ldap/ code. r=mkmelin
# ignore-this-changeset

These changes were achieved by:

1. Using eslint to add curly brackets to control
statements that did not have them (if, else, etc.),
thanks to the eslint rule: &quot;curly&quot;: [&quot;error&quot;, &quot;all&quot;]

Done by running |mach eslint common/ --fix|

2. Reformatting the code using Prettier.

Done by deleting the common/ and ldap/ lines from
the .prettierignore file and running:
|mach eslint chat/ --fix|</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/.prettierignore">.prettierignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/.prettierignore">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/.prettierignore">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/.prettierignore">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/.prettierignore">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/.prettierignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/bindings/customizable-toolbar.js">common/bindings/customizable-toolbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/bindings/customizable-toolbar.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/bindings/customizable-toolbar.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/bindings/customizable-toolbar.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/bindings/customizable-toolbar.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/bindings/customizable-toolbar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/saxparser/test/unit/test_parser.js">common/saxparser/test/unit/test_parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/saxparser/test/unit/test_parser.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/saxparser/test/unit/test_parser.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/saxparser/test/unit/test_parser.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/saxparser/test/unit/test_parser.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/saxparser/test/unit/test_parser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ChromeManifest.jsm">common/src/ChromeManifest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ChromeManifest.jsm">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ChromeManifest.jsm">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ChromeManifest.jsm">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ChromeManifest.jsm">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ChromeManifest.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ExtensionSupport.jsm">common/src/ExtensionSupport.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ExtensionSupport.jsm">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ExtensionSupport.jsm">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ExtensionSupport.jsm">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ExtensionSupport.jsm">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/ExtensionSupport.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/Overlays.jsm">common/src/Overlays.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/Overlays.jsm">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/Overlays.jsm">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/Overlays.jsm">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/Overlays.jsm">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/Overlays.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/browser-development-helpers.js">common/src/browser-development-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/browser-development-helpers.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/browser-development-helpers.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/browser-development-helpers.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/browser-development-helpers.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/browser-development-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/customizeToolbar.js">common/src/customizeToolbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/customizeToolbar.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/customizeToolbar.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/customizeToolbar.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/customizeToolbar.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/customizeToolbar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewSource.js">common/src/viewSource.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewSource.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewSource.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewSource.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewSource.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewSource.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewZoomOverlay.js">common/src/viewZoomOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewZoomOverlay.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewZoomOverlay.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewZoomOverlay.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewZoomOverlay.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/src/viewZoomOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/data/BootstrapMonitor.jsm">common/test/xpcshell/data/BootstrapMonitor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/data/BootstrapMonitor.jsm">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/data/BootstrapMonitor.jsm">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/data/BootstrapMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/data/BootstrapMonitor.jsm">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/data/BootstrapMonitor.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/head_addons.js">common/test/xpcshell/head_addons.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/head_addons.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/head_addons.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/head_addons.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/head_addons.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/head_addons.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap.js">common/test/xpcshell/test_bootstrap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_const.js">common/test/xpcshell/test_bootstrap_const.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_const.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_const.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_const.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_const.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_const.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_globals.js">common/test/xpcshell/test_bootstrap_globals.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_globals.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_globals.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_globals.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_globals.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrap_globals.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">common/test/xpcshell/test_bootstrapped_chrome_manifest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/src/nsLDAPProtocolHandler.js">ldap/xpcom/src/nsLDAPProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/src/nsLDAPProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/src/nsLDAPProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/src/nsLDAPProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/src/nsLDAPProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/src/nsLDAPProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/tests/unit/test_nsLDAPURL.js">ldap/xpcom/tests/unit/test_nsLDAPURL.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/tests/unit/test_nsLDAPURL.js">file</a> |
<a href="/comm-central/annotate/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/tests/unit/test_nsLDAPURL.js">annotate</a> |
<a href="/comm-central/diff/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/tests/unit/test_nsLDAPURL.js">diff</a> |
<a href="/comm-central/comparison/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/tests/unit/test_nsLDAPURL.js">comparison</a> |
<a href="/comm-central/log/ab9b63f9d2266b4607b926ba227d89ae117bb3f9/ldap/xpcom/tests/unit/test_nsLDAPURL.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.prettierignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.prettierignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,14 +6,12 @@</span>
<a href="#l1.4"></a><span id="l1.4"> *.xhtml</span>
<a href="#l1.5"></a><span id="l1.5"> *.xul</span>
<a href="#l1.6"></a><span id="l1.6"> *.xml</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # Ignore .eslintrc.js for now.</span>
<a href="#l1.9"></a><span id="l1.9"> .eslintrc.js</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # Ignore all top-level directories that contain JS files (for now).</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-common/**</span>
<a href="#l1.13"></a><span id="l1.13"> editor/**</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-ldap/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/**</span>
<a href="#l1.16"></a><span id="l1.16"> mailnews/**</span>
<a href="#l1.17"></a><span id="l1.17"> suite/**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/common/bindings/customizable-toolbar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/common/bindings/customizable-toolbar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">-  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> &quot;use strict&quot;;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12"> /* globals MozXULElement */</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> // Wrap in a block to prevent leaking to window scope.</span>
<a href="#l2.15"></a><span id="l2.15"> {</span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineat">@@ -45,18 +45,18 @@</span>
<a href="#l2.18"></a><span id="l2.18">         }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">         // Hold on to the palette but remove it from the document.</span>
<a href="#l2.21"></a><span id="l2.21">         toolbox.palette = node;</span>
<a href="#l2.22"></a><span id="l2.22">         toolbox.removeChild(node);</span>
<a href="#l2.23"></a><span id="l2.23">       }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">       // Build up our contents from the palette.</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      let currentSet = this.getAttribute(&quot;currentset&quot;) ||</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-        this.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+      let currentSet =</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+        this.getAttribute(&quot;currentset&quot;) || this.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31">       if (currentSet) {</span>
<a href="#l2.32"></a><span id="l2.32">         this.currentSet = currentSet;</span>
<a href="#l2.33"></a><span id="l2.33">       }</span>
<a href="#l2.34"></a><span id="l2.34">     }</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">     /**</span>
<a href="#l2.37"></a><span id="l2.37">      * Get the toolbox element connected to this toolbar.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineat">@@ -67,28 +67,34 @@</span>
<a href="#l2.39"></a><span id="l2.39">       if (this._toolbox) {</span>
<a href="#l2.40"></a><span id="l2.40">         return this._toolbox;</span>
<a href="#l2.41"></a><span id="l2.41">       }</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">       let toolboxId = this.getAttribute(&quot;toolboxid&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">       if (toolboxId) {</span>
<a href="#l2.45"></a><span id="l2.45">         let toolbox = document.getElementById(toolboxId);</span>
<a href="#l2.46"></a><span id="l2.46">         if (!toolbox) {</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-          let tbName = this.hasAttribute(&quot;toolbarname&quot;) ?</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-            ` (${this.getAttribute(&quot;toolbarname&quot;)})` : &quot;&quot;;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+          let tbName = this.hasAttribute(&quot;toolbarname&quot;)</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+            ? ` (${this.getAttribute(&quot;toolbarname&quot;)})`</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+            : &quot;&quot;;</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-          throw new Error(`toolbar ID ${this.id}${tbName}: toolboxid attribute '${toolboxId}' points to a toolbox that doesn't exist`);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+          throw new Error(</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+            `toolbar ID ${</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+              this.id</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+            }${tbName}: toolboxid attribute '${toolboxId}' points to a toolbox that doesn't exist`</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+          );</span>
<a href="#l2.59"></a><span id="l2.59">         }</span>
<a href="#l2.60"></a><span id="l2.60">         this._toolbox = toolbox;</span>
<a href="#l2.61"></a><span id="l2.61">         return this._toolbox;</span>
<a href="#l2.62"></a><span id="l2.62">       }</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-      this._toolbox = (this.parentNode &amp;&amp;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-          this.parentNode.localName == &quot;toolbox&quot;) ?</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-        this.parentNode : null;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+      this._toolbox =</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        this.parentNode &amp;&amp; this.parentNode.localName == &quot;toolbox&quot;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+          ? this.parentNode</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+          : null;</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72">       return this._toolbox;</span>
<a href="#l2.73"></a><span id="l2.73">     }</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">     /**</span>
<a href="#l2.76"></a><span id="l2.76">      * Sets the current set of items in the toolbar.</span>
<a href="#l2.77"></a><span id="l2.77">      *</span>
<a href="#l2.78"></a><span id="l2.78">      * @param {string} val  Comma-separated list of IDs or &quot;__empty&quot;.</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineat">@@ -104,17 +110,17 @@</span>
<a href="#l2.80"></a><span id="l2.80">       let paletteChildren = palette ? palette.childNodes : [];</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">       let paletteItems = {};</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84">       for (let item of paletteChildren) {</span>
<a href="#l2.85"></a><span id="l2.85">         paletteItems[item.id] = item;</span>
<a href="#l2.86"></a><span id="l2.86">       }</span>
<a href="#l2.87"></a><span id="l2.87"> </span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-      let ids = (val == &quot;__empty&quot;) ? [] : val.split(&quot;,&quot;);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      let ids = val == &quot;__empty&quot; ? [] : val.split(&quot;,&quot;);</span>
<a href="#l2.90"></a><span id="l2.90">       let children = this.childNodes;</span>
<a href="#l2.91"></a><span id="l2.91">       let nodeidx = 0;</span>
<a href="#l2.92"></a><span id="l2.92">       let added = {};</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">       // Iterate over the ids to use on the toolbar.</span>
<a href="#l2.95"></a><span id="l2.95">       for (let id of ids) {</span>
<a href="#l2.96"></a><span id="l2.96">         // Iterate over the existing nodes on the toolbar. nodeidx is the</span>
<a href="#l2.97"></a><span id="l2.97">         // spot where we want to insert items.</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineat">@@ -194,19 +200,19 @@</span>
<a href="#l2.99"></a><span id="l2.99">      * @param {Element} node  Return the ID of this node.</span>
<a href="#l2.100"></a><span id="l2.100">      * @return {string}  The ID of the node.</span>
<a href="#l2.101"></a><span id="l2.101">      */</span>
<a href="#l2.102"></a><span id="l2.102">     _idFromNode(node) {</span>
<a href="#l2.103"></a><span id="l2.103">       if (node.getAttribute(&quot;skipintoolbarset&quot;) == &quot;true&quot;) {</span>
<a href="#l2.104"></a><span id="l2.104">         return &quot;&quot;;</span>
<a href="#l2.105"></a><span id="l2.105">       }</span>
<a href="#l2.106"></a><span id="l2.106">       const specialItems = {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-        &quot;toolbarseparator&quot;: &quot;separator&quot;,</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-        &quot;toolbarspring&quot;: &quot;spring&quot;,</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-        &quot;toolbarspacer&quot;: &quot;spacer&quot;,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+        toolbarseparator: &quot;separator&quot;,</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+        toolbarspring: &quot;spring&quot;,</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+        toolbarspacer: &quot;spacer&quot;,</span>
<a href="#l2.113"></a><span id="l2.113">       };</span>
<a href="#l2.114"></a><span id="l2.114">       return specialItems[node.localName] || node.id;</span>
<a href="#l2.115"></a><span id="l2.115">     }</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">     /**</span>
<a href="#l2.118"></a><span id="l2.118">      * Returns a toolbar item based on the given ID.</span>
<a href="#l2.119"></a><span id="l2.119">      *</span>
<a href="#l2.120"></a><span id="l2.120">      * @param {string} id  The ID for the new toolbar item.</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineat">@@ -214,34 +220,37 @@</span>
<a href="#l2.122"></a><span id="l2.122">      */</span>
<a href="#l2.123"></a><span id="l2.123">     _getToolbarItem(id) {</span>
<a href="#l2.124"></a><span id="l2.124">       // Handle special cases.</span>
<a href="#l2.125"></a><span id="l2.125">       if ([&quot;separator&quot;, &quot;spring&quot;, &quot;spacer&quot;].includes(id)) {</span>
<a href="#l2.126"></a><span id="l2.126">         let newItem = document.createXULElement(&quot;toolbar&quot; + id);</span>
<a href="#l2.127"></a><span id="l2.127">         // Due to timers resolution Date.now() can be the same for</span>
<a href="#l2.128"></a><span id="l2.128">         // elements created in small timeframes.  So ids are</span>
<a href="#l2.129"></a><span id="l2.129">         // differentiated through a unique count suffix.</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-        newItem.id = id + Date.now() + (++this._newElementCount);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+        newItem.id = id + Date.now() + ++this._newElementCount;</span>
<a href="#l2.132"></a><span id="l2.132">         if (id == &quot;spring&quot;) {</span>
<a href="#l2.133"></a><span id="l2.133">           newItem.flex = 1;</span>
<a href="#l2.134"></a><span id="l2.134">         }</span>
<a href="#l2.135"></a><span id="l2.135">         return newItem;</span>
<a href="#l2.136"></a><span id="l2.136">       }</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">       let toolbox = this.toolbox;</span>
<a href="#l2.139"></a><span id="l2.139">       if (!toolbox) {</span>
<a href="#l2.140"></a><span id="l2.140">         return null;</span>
<a href="#l2.141"></a><span id="l2.141">       }</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143">       // Look for an item with the same id, as the item may be</span>
<a href="#l2.144"></a><span id="l2.144">       // in a different toolbar.</span>
<a href="#l2.145"></a><span id="l2.145">       let item = document.getElementById(id);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-      if (item &amp;&amp; item.parentNode &amp;&amp;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-          item.parentNode.localName == &quot;toolbar&quot; &amp;&amp;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-          item.parentNode.toolbox == toolbox) {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+      if (</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+        item &amp;&amp;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+        item.parentNode &amp;&amp;</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+        item.parentNode.localName == &quot;toolbar&quot; &amp;&amp;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+        item.parentNode.toolbox == toolbox</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      ) {</span>
<a href="#l2.155"></a><span id="l2.155">         return item;</span>
<a href="#l2.156"></a><span id="l2.156">       }</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158">       if (toolbox.palette) {</span>
<a href="#l2.159"></a><span id="l2.159">         // Attempt to locate an item with a matching ID within the palette.</span>
<a href="#l2.160"></a><span id="l2.160">         let paletteItem = toolbox.palette.firstChild;</span>
<a href="#l2.161"></a><span id="l2.161">         while (paletteItem) {</span>
<a href="#l2.162"></a><span id="l2.162">           if (paletteItem.id == id) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineat">@@ -297,16 +306,18 @@</span>
<a href="#l2.164"></a><span id="l2.164">       if (currentSet == &quot;__empty&quot;) {</span>
<a href="#l2.165"></a><span id="l2.165">         return false;</span>
<a href="#l2.166"></a><span id="l2.166">       }</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168">       let defaultOrNoninteractive = (this.getAttribute(&quot;defaultset&quot;) || &quot;&quot;)</span>
<a href="#l2.169"></a><span id="l2.169">         .split(&quot;,&quot;)</span>
<a href="#l2.170"></a><span id="l2.170">         .concat([&quot;separator&quot;, &quot;spacer&quot;, &quot;spring&quot;]);</span>
<a href="#l2.171"></a><span id="l2.171"> </span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-      return currentSet.split(&quot;,&quot;)</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+      return currentSet</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l2.175"></a><span id="l2.175">         .some(item =&gt; !defaultOrNoninteractive.includes(item));</span>
<a href="#l2.176"></a><span id="l2.176">     }</span>
<a href="#l2.177"></a><span id="l2.177">   }</span>
<a href="#l2.178"></a><span id="l2.178"> </span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-  customElements.define(&quot;customizable-toolbar&quot;, CustomizableToolbar,</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-    { extends: &quot;toolbar&quot; });</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+  customElements.define(&quot;customizable-toolbar&quot;, CustomizableToolbar, {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    extends: &quot;toolbar&quot;,</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+  });</span>
<a href="#l2.184"></a><span id="l2.184"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/common/saxparser/test/unit/test_parser.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/common/saxparser/test/unit/test_parser.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,36 +1,39 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-var {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+var { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> function updateDocumentSourceMaps(src) {</span>
<a href="#l3.8"></a><span id="l3.8">   const nsISAXXMLReader = Ci.nsISAXXMLReader;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-  const saxReader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-                      .createInstance(nsISAXXMLReader);</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+  const saxReader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    nsISAXXMLReader</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  );</span>
<a href="#l3.14"></a><span id="l3.14">   try {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    saxReader.setFeature(&quot;http://xml.org/sax/features/namespace-prefixes&quot;, true);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    saxReader.setFeature(</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      &quot;http://xml.org/sax/features/namespace-prefixes&quot;,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      true</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    );</span>
<a href="#l3.20"></a><span id="l3.20">     saxReader.setFeature(&quot;http://xml.org/sax/features/namespace&quot;, true);</span>
<a href="#l3.21"></a><span id="l3.21">   } catch (e) {</span>
<a href="#l3.22"></a><span id="l3.22">     // do nothing, we'll accept it as it is.</span>
<a href="#l3.23"></a><span id="l3.23">   }</span>
<a href="#l3.24"></a><span id="l3.24">   var parseErrorLog = [];</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   /* XXX ajvincent Because throwing an exception doesn't stop parsing, we need</span>
<a href="#l3.27"></a><span id="l3.27">    * to record errors and handle them after the parsing is finished.</span>
<a href="#l3.28"></a><span id="l3.28">    */</span>
<a href="#l3.29"></a><span id="l3.29">   function do_parse_check(aCondition, aMsg) {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    if (!aCondition)</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    if (!aCondition) {</span>
<a href="#l3.32"></a><span id="l3.32">       parseErrorLog[parseErrorLog.length] = aMsg;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    }</span>
<a href="#l3.34"></a><span id="l3.34">   }</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36">   var contentHandler = {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-    startDocument() {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-    },</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    startDocument() {},</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-    endDocument() {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    },</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    endDocument() {},</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">     handleAttributes(aAttributes) {</span>
<a href="#l3.46"></a><span id="l3.46">       for (var i = 0; i &lt; aAttributes.length; i++) {</span>
<a href="#l3.47"></a><span id="l3.47">         var attrLocalName = aAttributes.getLocalName(i);</span>
<a href="#l3.48"></a><span id="l3.48">         var attrNodeName = aAttributes.getQName(i);</span>
<a href="#l3.49"></a><span id="l3.49">         do_parse_check(attrLocalName, &quot;Missing attribute local name&quot;);</span>
<a href="#l3.50"></a><span id="l3.50">         do_parse_check(attrNodeName, &quot;Missing attribute node name&quot;);</span>
<a href="#l3.51"></a><span id="l3.51">       }</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineat">@@ -43,18 +46,17 @@ function updateDocumentSourceMaps(src) {</span>
<a href="#l3.53"></a><span id="l3.53">       this.handleAttributes(aAttributes);</span>
<a href="#l3.54"></a><span id="l3.54">     },</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">     endElement(aNamespaceURI, aLocalName, aNodeName) {</span>
<a href="#l3.57"></a><span id="l3.57">       do_parse_check(aLocalName, &quot;Missing element local name (endElement)&quot;);</span>
<a href="#l3.58"></a><span id="l3.58">       do_parse_check(aNodeName, &quot;Missing element node name (endElement)&quot;);</span>
<a href="#l3.59"></a><span id="l3.59">     },</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-    characters(aData) {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    },</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    characters(aData) {},</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65">     processingInstruction(aTarget, aData) {</span>
<a href="#l3.66"></a><span id="l3.66">       do_parse_check(aTarget, &quot;Missing processing instruction target&quot;);</span>
<a href="#l3.67"></a><span id="l3.67">     },</span>
<a href="#l3.68"></a><span id="l3.68">   };</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">   var errorHandler = {</span>
<a href="#l3.71"></a><span id="l3.71">     error(aError) {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineat">@@ -66,30 +68,33 @@ function updateDocumentSourceMaps(src) {</span>
<a href="#l3.73"></a><span id="l3.73">     },</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">     ignorableWarning(aError) {</span>
<a href="#l3.76"></a><span id="l3.76">       do_parse_check(!aError, &quot;XML ignorable warning&quot;);</span>
<a href="#l3.77"></a><span id="l3.77">     },</span>
<a href="#l3.78"></a><span id="l3.78">   };</span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80">   saxReader.contentHandler = contentHandler;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-  saxReader.errorHandler   = errorHandler;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  saxReader.errorHandler = errorHandler;</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84">   let type = &quot;application/xml&quot;;</span>
<a href="#l3.85"></a><span id="l3.85">   let uri = NetUtil.newURI(&quot;http://example.org/&quot;);</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  let sStream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-               .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  let sStream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    Ci.nsIStringInputStream</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  );</span>
<a href="#l3.92"></a><span id="l3.92">   sStream.setData(src, src.length);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-  var bStream = Cc[&quot;@mozilla.org/network/buffered-input-stream;1&quot;]</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-                .createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  var bStream = Cc[</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    &quot;@mozilla.org/network/buffered-input-stream;1&quot;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  ].createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l3.98"></a><span id="l3.98">   bStream.init(sStream, 4096);</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  let channel = Cc[&quot;@mozilla.org/network/input-stream-channel;1&quot;].</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    createInstance(Ci.nsIInputStreamChannel);</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  let channel = Cc[</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+    &quot;@mozilla.org/network/input-stream-channel;1&quot;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  ].createInstance(Ci.nsIInputStreamChannel);</span>
<a href="#l3.105"></a><span id="l3.105">   channel.setURI(uri);</span>
<a href="#l3.106"></a><span id="l3.106">   channel.contentStream = bStream;</span>
<a href="#l3.107"></a><span id="l3.107">   channel.QueryInterface(Ci.nsIChannel);</span>
<a href="#l3.108"></a><span id="l3.108">   channel.contentType = type;</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">   saxReader.parseAsync(null, uri);</span>
<a href="#l3.111"></a><span id="l3.111">   saxReader.onStartRequest(channel);</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -99,17 +104,17 @@ function updateDocumentSourceMaps(src) {</span>
<a href="#l3.114"></a><span id="l3.114">     saxReader.onDataAvailable(channel, bStream, pos, count);</span>
<a href="#l3.115"></a><span id="l3.115">     pos += count;</span>
<a href="#l3.116"></a><span id="l3.116">     count = bStream.available();</span>
<a href="#l3.117"></a><span id="l3.117">   }</span>
<a href="#l3.118"></a><span id="l3.118">   saxReader.onStopRequest(channel, Cr.NS_OK);</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120">   // Just in case it leaks.</span>
<a href="#l3.121"></a><span id="l3.121">   saxReader.contentHandler = null;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-  saxReader.errorHandler   = null;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+  saxReader.errorHandler = null;</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125">   return parseErrorLog;</span>
<a href="#l3.126"></a><span id="l3.126"> }</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128"> function do_check_true_with_dump(aCondition, aParseLog) {</span>
<a href="#l3.129"></a><span id="l3.129">   if (!aCondition) {</span>
<a href="#l3.130"></a><span id="l3.130">     dump(aParseLog.join(&quot;\n&quot;));</span>
<a href="#l3.131"></a><span id="l3.131">   }</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineat">@@ -131,10 +136,13 @@ function run_test() {</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134">   // End tag isn't well-formed.</span>
<a href="#l3.135"></a><span id="l3.135">   src = &quot;&lt;!DOCTYPE foo&gt;\n&lt;!-- all your foo are belong to bar --&gt;&quot;;</span>
<a href="#l3.136"></a><span id="l3.136">   src += &quot;&lt;foo id='foo'&gt;\n&lt;?foo wooly bully?&gt;\nfoo&quot;;</span>
<a href="#l3.137"></a><span id="l3.137">   src += &quot;&lt;![CDATA[foo fighters]]&gt;&lt;/foo\n&quot;;</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139">   parseErrorLog = updateDocumentSourceMaps(src);</span>
<a href="#l3.140"></a><span id="l3.140"> </span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  do_check_true_with_dump(parseErrorLog.length == 1 &amp;&amp; parseErrorLog[0] == &quot;XML fatal error&quot;, parseErrorLog);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+  do_check_true_with_dump(</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+    parseErrorLog.length == 1 &amp;&amp; parseErrorLog[0] == &quot;XML fatal error&quot;,</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    parseErrorLog</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  );</span>
<a href="#l3.146"></a><span id="l3.146"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/common/src/ChromeManifest.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/common/src/ChromeManifest.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> this.EXPORTED_SYMBOLS = [&quot;ChromeManifest&quot;];</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> /**</span>
<a href="#l4.14"></a><span id="l4.14">  * A parser for chrome.manifest files. Implements a subset of</span>
<a href="#l4.15"></a><span id="l4.15">  * https://developer.mozilla.org/en-US/docs/Mozilla/Chrome_Registration</span>
<a href="#l4.16"></a><span id="l4.16">  */</span>
<a href="#l4.17"></a><span id="l4.17"> class ChromeManifest {</span>
<a href="#l4.18"></a><span id="l4.18">   /**</span>
<a href="#l4.19"></a><span id="l4.19">    * Constucts the chrome.manifest parser</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineat">@@ -34,17 +34,16 @@ class ChromeManifest {</span>
<a href="#l4.21"></a><span id="l4.21">     this.contract = new Map();</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">     this.content = new Map();</span>
<a href="#l4.24"></a><span id="l4.24">     this.skin = new Map();</span>
<a href="#l4.25"></a><span id="l4.25">     this.resource = new Map();</span>
<a href="#l4.26"></a><span id="l4.26">     this.override = new Map();</span>
<a href="#l4.27"></a><span id="l4.27">   }</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-</span>
<a href="#l4.30"></a><span id="l4.30">   /**</span>
<a href="#l4.31"></a><span id="l4.31">    * Parse the given file.</span>
<a href="#l4.32"></a><span id="l4.32">    *</span>
<a href="#l4.33"></a><span id="l4.33">    * @param {String} filename           The filename to load</span>
<a href="#l4.34"></a><span id="l4.34">    * @param {String} base               The relative directory this file is expected to be in.</span>
<a href="#l4.35"></a><span id="l4.35">    * @return {Promise}                  Resolved when loading completes</span>
<a href="#l4.36"></a><span id="l4.36">    */</span>
<a href="#l4.37"></a><span id="l4.37">   async parse(filename = &quot;chrome.manifest&quot;, base = &quot;&quot;) {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineat">@@ -63,28 +62,48 @@ class ChromeManifest {</span>
<a href="#l4.39"></a><span id="l4.39">     let extraManifests = [];</span>
<a href="#l4.40"></a><span id="l4.40">     for (let line of lines) {</span>
<a href="#l4.41"></a><span id="l4.41">       let parts = line.trim().split(/\s+/);</span>
<a href="#l4.42"></a><span id="l4.42">       let directive = parts.shift();</span>
<a href="#l4.43"></a><span id="l4.43">       switch (directive) {</span>
<a href="#l4.44"></a><span id="l4.44">         case &quot;manifest&quot;:</span>
<a href="#l4.45"></a><span id="l4.45">           extraManifests.push(this._parseManifest(base, ...parts));</span>
<a href="#l4.46"></a><span id="l4.46">           break;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-        case &quot;component&quot;: this._parseComponent(...parts); break;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-        case &quot;contract&quot;: this._parseContract(...parts); break;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+        case &quot;component&quot;:</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+          this._parseComponent(...parts);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+          break;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+        case &quot;contract&quot;:</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+          this._parseContract(...parts);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+          break;</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-        case &quot;category&quot;: this._parseCategory(...parts); break;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-        case &quot;content&quot;: this._parseContent(...parts); break;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-        case &quot;locale&quot;: this._parseLocale(...parts); break;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-        case &quot;skin&quot;: this._parseSkin(...parts); break;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-        case &quot;resource&quot;: this._parseResource(...parts); break;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        case &quot;category&quot;:</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+          this._parseCategory(...parts);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+          break;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+        case &quot;content&quot;:</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+          this._parseContent(...parts);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+          break;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+        case &quot;locale&quot;:</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+          this._parseLocale(...parts);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+          break;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+        case &quot;skin&quot;:</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+          this._parseSkin(...parts);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+          break;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+        case &quot;resource&quot;:</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+          this._parseResource(...parts);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+          break;</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-        case &quot;overlay&quot;: this._parseOverlay(...parts); break;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-        case &quot;style&quot;: this._parseStyle(...parts); break;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-        case &quot;override&quot;: this._parseOverride(...parts); break;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+        case &quot;overlay&quot;:</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+          this._parseOverlay(...parts);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+          break;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+        case &quot;style&quot;:</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+          this._parseStyle(...parts);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+          break;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+        case &quot;override&quot;:</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+          this._parseOverride(...parts);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+          break;</span>
<a href="#l4.89"></a><span id="l4.89">       }</span>
<a href="#l4.90"></a><span id="l4.90">     }</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">     await Promise.all(extraManifests);</span>
<a href="#l4.93"></a><span id="l4.93">   }</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">   /**</span>
<a href="#l4.96"></a><span id="l4.96">    * Ensure the flags provided for the instruction match our options</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineat">@@ -94,56 +113,70 @@ class ChromeManifest {</span>
<a href="#l4.98"></a><span id="l4.98">    */</span>
<a href="#l4.99"></a><span id="l4.99">   _parseFlags(flags) {</span>
<a href="#l4.100"></a><span id="l4.100">     if (flags.length == 0) {</span>
<a href="#l4.101"></a><span id="l4.101">       return true;</span>
<a href="#l4.102"></a><span id="l4.102">     }</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">     let matchString = (a, sign, b) =&gt; {</span>
<a href="#l4.105"></a><span id="l4.105">       if (sign != &quot;=&quot;) {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-        console.warn(`Invalid sign ${sign} in ${a}${sign}${b}, dropping manifest instruction`);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+        console.warn(</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+          `Invalid sign ${sign} in ${a}${sign}${b}, dropping manifest instruction`</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        );</span>
<a href="#l4.110"></a><span id="l4.110">         return false;</span>
<a href="#l4.111"></a><span id="l4.111">       }</span>
<a href="#l4.112"></a><span id="l4.112">       return a == b;</span>
<a href="#l4.113"></a><span id="l4.113">     };</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115">     let matchVersion = (a, sign, b) =&gt; {</span>
<a href="#l4.116"></a><span id="l4.116">       switch (sign) {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-        case &quot;=&quot;: return Services.vc.compare(a, b) == 0;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-        case &quot;&gt;&quot;: return Services.vc.compare(a, b) &gt; 0;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-        case &quot;&lt;&quot;: return Services.vc.compare(a, b) &lt; 0;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-        case &quot;&gt;=&quot;: return Services.vc.compare(a, b) &gt;= 0;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-        case &quot;&lt;=&quot;: return Services.vc.compare(a, b) &lt;= 0;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+        case &quot;=&quot;:</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+          return Services.vc.compare(a, b) == 0;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+        case &quot;&gt;&quot;:</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+          return Services.vc.compare(a, b) &gt; 0;</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+        case &quot;&lt;&quot;:</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+          return Services.vc.compare(a, b) &lt; 0;</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+        case &quot;&gt;=&quot;:</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+          return Services.vc.compare(a, b) &gt;= 0;</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+        case &quot;&lt;=&quot;:</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+          return Services.vc.compare(a, b) &lt;= 0;</span>
<a href="#l4.132"></a><span id="l4.132">         default:</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-          console.warn(`Invalid sign ${sign} in ${a}${sign}${b}, dropping manifest instruction`);</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+          console.warn(</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+            `Invalid sign ${sign} in ${a}${sign}${b}, dropping manifest instruction`</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+          );</span>
<a href="#l4.137"></a><span id="l4.137">           return false;</span>
<a href="#l4.138"></a><span id="l4.138">       }</span>
<a href="#l4.139"></a><span id="l4.139">     };</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">     let flagMatches = (key, typeMatch) =&gt; {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-      return !flagdata.has(key) || flagdata.get(key).some(val =&gt; typeMatch(this.options[key], ...val));</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+      return (</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+        !flagdata.has(key) ||</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+        flagdata.get(key).some(val =&gt; typeMatch(this.options[key], ...val))</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+      );</span>
<a href="#l4.147"></a><span id="l4.147">     };</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">     let flagdata = new DefaultMap(() =&gt; []);</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151">     for (let flag of flags) {</span>
<a href="#l4.152"></a><span id="l4.152">       let match = flag.match(/(\w+)(&gt;=|&lt;=|&lt;|&gt;|=)(.*)/);</span>
<a href="#l4.153"></a><span id="l4.153">       if (match) {</span>
<a href="#l4.154"></a><span id="l4.154">         flagdata.get(match[1]).push([match[2], match[3]]);</span>
<a href="#l4.155"></a><span id="l4.155">       } else {</span>
<a href="#l4.156"></a><span id="l4.156">         console.warn(`Invalid flag ${flag}, dropping manifest instruction`);</span>
<a href="#l4.157"></a><span id="l4.157">       }</span>
<a href="#l4.158"></a><span id="l4.158">     }</span>
<a href="#l4.159"></a><span id="l4.159"> </span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-    return flagMatches(&quot;application&quot;, matchString) &amp;&amp;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-           flagMatches(&quot;appversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-           flagMatches(&quot;platformversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-           flagMatches(&quot;os&quot;, matchString) &amp;&amp;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-           flagMatches(&quot;osversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-           flagMatches(&quot;abi&quot;, matchString);</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    return (</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+      flagMatches(&quot;application&quot;, matchString) &amp;&amp;</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+      flagMatches(&quot;appversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+      flagMatches(&quot;platformversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+      flagMatches(&quot;os&quot;, matchString) &amp;&amp;</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+      flagMatches(&quot;osversion&quot;, matchVersion) &amp;&amp;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+      flagMatches(&quot;abi&quot;, matchString)</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+    );</span>
<a href="#l4.174"></a><span id="l4.174">   }</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176">   /**</span>
<a href="#l4.177"></a><span id="l4.177">    * Parse the manifest instruction, to load other files</span>
<a href="#l4.178"></a><span id="l4.178">    *</span>
<a href="#l4.179"></a><span id="l4.179">    * @param {String} base       The base directory the manifest file is in</span>
<a href="#l4.180"></a><span id="l4.180">    * @param {String} filename   The file and path to load</span>
<a href="#l4.181"></a><span id="l4.181">    * @param {...String} flags   The flags for this instruction</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/common/src/ExtensionSupport.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/common/src/ExtensionSupport.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -4,23 +4,27 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> /**</span>
<a href="#l5.6"></a><span id="l5.6">  * Helper functions for use by extensions that should ease them plug</span>
<a href="#l5.7"></a><span id="l5.7">  * into the application.</span>
<a href="#l5.8"></a><span id="l5.8">  */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> this.EXPORTED_SYMBOLS = [&quot;ExtensionSupport&quot;];</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-const {AddonManager} = ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+const { AddonManager } = ChromeUtils.import(</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  &quot;resource://gre/modules/AddonManager.jsm&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.18"></a><span id="l5.18"> // ChromeUtils.import(&quot;resource://gre/modules/Deprecated.jsm&quot;) - needed for warning.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-const {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+const { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-const {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+var { fixIterator } = ChromeUtils.import(</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+const { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> var extensionHooks = new Map();</span>
<a href="#l5.30"></a><span id="l5.30"> var legacyExtensions = new Map();</span>
<a href="#l5.31"></a><span id="l5.31"> var bootstrapExtensions = new Set();</span>
<a href="#l5.32"></a><span id="l5.32"> var openWindowList;</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34"> var ExtensionSupport = {</span>
<a href="#l5.35"></a><span id="l5.35">   /**</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineat">@@ -30,34 +34,42 @@ var ExtensionSupport = {</span>
<a href="#l5.37"></a><span id="l5.37">   loadedLegacyExtensions: {</span>
<a href="#l5.38"></a><span id="l5.38">     set(id, state) {</span>
<a href="#l5.39"></a><span id="l5.39">       legacyExtensions.set(id, state);</span>
<a href="#l5.40"></a><span id="l5.40">     },</span>
<a href="#l5.41"></a><span id="l5.41">     get(id) {</span>
<a href="#l5.42"></a><span id="l5.42">       return legacyExtensions.get(id);</span>
<a href="#l5.43"></a><span id="l5.43">     },</span>
<a href="#l5.44"></a><span id="l5.44">     has(id) {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-      if (!legacyExtensions.has(id))</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+      if (!legacyExtensions.has(id)) {</span>
<a href="#l5.47"></a><span id="l5.47">         return false;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+      }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">       let state = legacyExtensions.get(id);</span>
<a href="#l5.51"></a><span id="l5.51">       return ![&quot;install&quot;, &quot;enable&quot;].includes(state.pendingOperation);</span>
<a href="#l5.52"></a><span id="l5.52">     },</span>
<a href="#l5.53"></a><span id="l5.53">     hasAnyState(id) {</span>
<a href="#l5.54"></a><span id="l5.54">       return legacyExtensions.has(id);</span>
<a href="#l5.55"></a><span id="l5.55">     },</span>
<a href="#l5.56"></a><span id="l5.56">     _maybeDelete(id, newPendingOperation) {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-      if (!legacyExtensions.has(id))</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      if (!legacyExtensions.has(id)) {</span>
<a href="#l5.59"></a><span id="l5.59">         return;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      }</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">       let state = legacyExtensions.get(id);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-      if (state.pendingOperation == &quot;enable&quot; &amp;&amp; newPendingOperation == &quot;disable&quot;) {</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      if (</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+        state.pendingOperation == &quot;enable&quot; &amp;&amp;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+        newPendingOperation == &quot;disable&quot;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      ) {</span>
<a href="#l5.68"></a><span id="l5.68">         legacyExtensions.delete(id);</span>
<a href="#l5.69"></a><span id="l5.69">         this.notifyObservers(state);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-      } else if (state.pendingOperation == &quot;install&quot; &amp;&amp; newPendingOperation == &quot;uninstall&quot;) {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+      } else if (</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+        state.pendingOperation == &quot;install&quot; &amp;&amp;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+        newPendingOperation == &quot;uninstall&quot;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+      ) {</span>
<a href="#l5.75"></a><span id="l5.75">         legacyExtensions.delete(id);</span>
<a href="#l5.76"></a><span id="l5.76">         this.notifyObservers(state);</span>
<a href="#l5.77"></a><span id="l5.77">       }</span>
<a href="#l5.78"></a><span id="l5.78">     },</span>
<a href="#l5.79"></a><span id="l5.79">     notifyObservers(state) {</span>
<a href="#l5.80"></a><span id="l5.80">       let wrappedState = { wrappedJSObject: state };</span>
<a href="#l5.81"></a><span id="l5.81">       Services.obs.notifyObservers(wrappedState, &quot;legacy-addon-status-changed&quot;);</span>
<a href="#l5.82"></a><span id="l5.82">     },</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineat">@@ -80,74 +92,85 @@ var ExtensionSupport = {</span>
<a href="#l5.84"></a><span id="l5.84">       return runningButNotInstalled;</span>
<a href="#l5.85"></a><span id="l5.85">     },</span>
<a href="#l5.86"></a><span id="l5.86">   },</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88">   loadedBootstrapExtensions: bootstrapExtensions,</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90">   loadAddonPrefs(addonFile) {</span>
<a href="#l5.91"></a><span id="l5.91">     function setPref(preferDefault, name, value) {</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-      let branch = preferDefault ? Services.prefs.getDefaultBranch(&quot;&quot;) : Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+      let branch = preferDefault</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+        ? Services.prefs.getDefaultBranch(&quot;&quot;)</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+        : Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97">       if (typeof value == &quot;boolean&quot;) {</span>
<a href="#l5.98"></a><span id="l5.98">         branch.setBoolPref(name, value);</span>
<a href="#l5.99"></a><span id="l5.99">       } else if (typeof value == &quot;string&quot;) {</span>
<a href="#l5.100"></a><span id="l5.100">         if (value.startsWith(&quot;chrome://&quot;) &amp;&amp; value.endsWith(&quot;.properties&quot;)) {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-          let valueLocal = Cc[&quot;@mozilla.org/pref-localizedstring;1&quot;]</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-                           .createInstance(Ci.nsIPrefLocalizedString);</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+          let valueLocal = Cc[</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+            &quot;@mozilla.org/pref-localizedstring;1&quot;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+          ].createInstance(Ci.nsIPrefLocalizedString);</span>
<a href="#l5.106"></a><span id="l5.106">           valueLocal.data = value;</span>
<a href="#l5.107"></a><span id="l5.107">           branch.setComplexValue(name, Ci.nsIPrefLocalizedString, valueLocal);</span>
<a href="#l5.108"></a><span id="l5.108">         } else {</span>
<a href="#l5.109"></a><span id="l5.109">           branch.setStringPref(name, value);</span>
<a href="#l5.110"></a><span id="l5.110">         }</span>
<a href="#l5.111"></a><span id="l5.111">       } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isInteger(value)) {</span>
<a href="#l5.112"></a><span id="l5.112">         branch.setIntPref(name, value);</span>
<a href="#l5.113"></a><span id="l5.113">       } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isFloat(value)) {</span>
<a href="#l5.114"></a><span id="l5.114">         // Floats are set as char prefs, then retrieved using getFloatPref</span>
<a href="#l5.115"></a><span id="l5.115">         branch.setCharPref(name, value);</span>
<a href="#l5.116"></a><span id="l5.116">       }</span>
<a href="#l5.117"></a><span id="l5.117">     }</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119">     function walkExtensionPrefs(extensionRoot) {</span>
<a href="#l5.120"></a><span id="l5.120">       let prefFile = extensionRoot.clone();</span>
<a href="#l5.121"></a><span id="l5.121">       let foundPrefStrings = [];</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-      if (!prefFile.exists())</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      if (!prefFile.exists()) {</span>
<a href="#l5.124"></a><span id="l5.124">         return [];</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+      }</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127">       if (prefFile.isDirectory()) {</span>
<a href="#l5.128"></a><span id="l5.128">         prefFile.append(&quot;defaults&quot;);</span>
<a href="#l5.129"></a><span id="l5.129">         prefFile.append(&quot;preferences&quot;);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-        if (!prefFile.exists() || !prefFile.isDirectory())</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+        if (!prefFile.exists() || !prefFile.isDirectory()) {</span>
<a href="#l5.132"></a><span id="l5.132">           return [];</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+        }</span>
<a href="#l5.134"></a><span id="l5.134"> </span>
<a href="#l5.135"></a><span id="l5.135">         let unsortedFiles = [];</span>
<a href="#l5.136"></a><span id="l5.136">         for (let file of fixIterator(prefFile.directoryEntries, Ci.nsIFile)) {</span>
<a href="#l5.137"></a><span id="l5.137">           if (file.isFile() &amp;&amp; file.leafName.toLowerCase().endsWith(&quot;.js&quot;)) {</span>
<a href="#l5.138"></a><span id="l5.138">             unsortedFiles.push(file);</span>
<a href="#l5.139"></a><span id="l5.139">           }</span>
<a href="#l5.140"></a><span id="l5.140">         }</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-        for (let file of unsortedFiles.sort((a, b) =&gt; a.path &lt; b.path ? 1 : -1)) {</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+        for (let file of unsortedFiles.sort((a, b) =&gt;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+          a.path &lt; b.path ? 1 : -1</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+        )) {</span>
<a href="#l5.146"></a><span id="l5.146">           foundPrefStrings.push(IOUtils.loadFileToString(file));</span>
<a href="#l5.147"></a><span id="l5.147">         }</span>
<a href="#l5.148"></a><span id="l5.148">       } else if (prefFile.isFile() &amp;&amp; prefFile.leafName.endsWith(&quot;xpi&quot;)) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-        let zipReader = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-                          .createInstance(Ci.nsIZipReader);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+        let zipReader = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;].createInstance(</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+          Ci.nsIZipReader</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+        );</span>
<a href="#l5.154"></a><span id="l5.154">         zipReader.open(prefFile);</span>
<a href="#l5.155"></a><span id="l5.155">         let entries = zipReader.findEntries(&quot;defaults/preferences/*.js&quot;);</span>
<a href="#l5.156"></a><span id="l5.156">         let unsortedEntries = [];</span>
<a href="#l5.157"></a><span id="l5.157">         while (entries.hasMore()) {</span>
<a href="#l5.158"></a><span id="l5.158">           unsortedEntries.push(entries.getNext());</span>
<a href="#l5.159"></a><span id="l5.159">         }</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161">         for (let entryName of unsortedEntries.sort().reverse()) {</span>
<a href="#l5.162"></a><span id="l5.162">           let stream = zipReader.getInputStream(entryName);</span>
<a href="#l5.163"></a><span id="l5.163">           let entrySize = zipReader.getEntry(entryName).realSize;</span>
<a href="#l5.164"></a><span id="l5.164">           if (entrySize &gt; 0) {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-            let content = NetUtil.readInputStreamToString(stream, entrySize, { charset: &quot;utf-8&quot;, replacement: &quot;?&quot; });</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+            let content = NetUtil.readInputStreamToString(stream, entrySize, {</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+              charset: &quot;utf-8&quot;,</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+              replacement: &quot;?&quot;,</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+            });</span>
<a href="#l5.170"></a><span id="l5.170">             foundPrefStrings.push(content);</span>
<a href="#l5.171"></a><span id="l5.171">           }</span>
<a href="#l5.172"></a><span id="l5.172">         }</span>
<a href="#l5.173"></a><span id="l5.173">       }</span>
<a href="#l5.174"></a><span id="l5.174"> </span>
<a href="#l5.175"></a><span id="l5.175">       return foundPrefStrings;</span>
<a href="#l5.176"></a><span id="l5.176">     }</span>
<a href="#l5.177"></a><span id="l5.177"> </span>
<a href="#l5.178"></a><span id="l5.178" class="difflineat">@@ -155,17 +178,22 @@ var ExtensionSupport = {</span>
<a href="#l5.179"></a><span id="l5.179">     sandbox.pref = setPref.bind(undefined, true);</span>
<a href="#l5.180"></a><span id="l5.180">     sandbox.user_pref = setPref.bind(undefined, false);</span>
<a href="#l5.181"></a><span id="l5.181"> </span>
<a href="#l5.182"></a><span id="l5.182">     let prefDataStrings = walkExtensionPrefs(addonFile);</span>
<a href="#l5.183"></a><span id="l5.183">     for (let prefDataString of prefDataStrings) {</span>
<a href="#l5.184"></a><span id="l5.184">       try {</span>
<a href="#l5.185"></a><span id="l5.185">         Cu.evalInSandbox(prefDataString, sandbox);</span>
<a href="#l5.186"></a><span id="l5.186">       } catch (e) {</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-        Cu.reportError(&quot;Error reading default prefs of addon &quot; + addonFile.leafName + &quot;: &quot; + e);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+        Cu.reportError(</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+          &quot;Error reading default prefs of addon &quot; +</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+            addonFile.leafName +</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+            &quot;: &quot; +</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+            e</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+        );</span>
<a href="#l5.194"></a><span id="l5.194">       }</span>
<a href="#l5.195"></a><span id="l5.195">     }</span>
<a href="#l5.196"></a><span id="l5.196"> </span>
<a href="#l5.197"></a><span id="l5.197">     /*</span>
<a href="#l5.198"></a><span id="l5.198">     TODO: decide whether we need to warn the user/make addon authors to migrate away from these pref files.</span>
<a href="#l5.199"></a><span id="l5.199">     if (prefDataStrings.length &gt; 0) {</span>
<a href="#l5.200"></a><span id="l5.200">       Deprecated.warning(addon.defaultLocale.name + &quot; uses defaults/preferences/*.js files to load prefs&quot;,</span>
<a href="#l5.201"></a><span id="l5.201">                          &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=1414398&quot;);</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineat">@@ -194,37 +222,45 @@ var ExtensionSupport = {</span>
<a href="#l5.203"></a><span id="l5.203">    */</span>
<a href="#l5.204"></a><span id="l5.204">   registerWindowListener(aID, aExtensionHook) {</span>
<a href="#l5.205"></a><span id="l5.205">     if (!aID) {</span>
<a href="#l5.206"></a><span id="l5.206">       Cu.reportError(&quot;No extension ID provided for the window listener&quot;);</span>
<a href="#l5.207"></a><span id="l5.207">       return false;</span>
<a href="#l5.208"></a><span id="l5.208">     }</span>
<a href="#l5.209"></a><span id="l5.209"> </span>
<a href="#l5.210"></a><span id="l5.210">     if (extensionHooks.has(aID)) {</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-      Cu.reportError(&quot;Window listener for extension + '&quot; + aID + &quot;' already registered&quot;);</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+      Cu.reportError(</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+        &quot;Window listener for extension + '&quot; + aID + &quot;' already registered&quot;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+      );</span>
<a href="#l5.215"></a><span id="l5.215">       return false;</span>
<a href="#l5.216"></a><span id="l5.216">     }</span>
<a href="#l5.217"></a><span id="l5.217"> </span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-    if (!(&quot;onLoadWindow&quot; in aExtensionHook) &amp;&amp; !(&quot;onUnloadWindow&quot; in aExtensionHook)) {</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-      Cu.reportError(&quot;The extension + '&quot; + aID + &quot;' does not provide any callbacks&quot;);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+    if (</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+      !(&quot;onLoadWindow&quot; in aExtensionHook) &amp;&amp;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+      !(&quot;onUnloadWindow&quot; in aExtensionHook)</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+    ) {</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+      Cu.reportError(</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+        &quot;The extension + '&quot; + aID + &quot;' does not provide any callbacks&quot;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+      );</span>
<a href="#l5.227"></a><span id="l5.227">       return false;</span>
<a href="#l5.228"></a><span id="l5.228">     }</span>
<a href="#l5.229"></a><span id="l5.229"> </span>
<a href="#l5.230"></a><span id="l5.230">     extensionHooks.set(aID, aExtensionHook);</span>
<a href="#l5.231"></a><span id="l5.231"> </span>
<a href="#l5.232"></a><span id="l5.232">     // Add our global listener if there isn't one already</span>
<a href="#l5.233"></a><span id="l5.233">     // (only when we have first caller).</span>
<a href="#l5.234"></a><span id="l5.234">     if (extensionHooks.size == 1) {</span>
<a href="#l5.235"></a><span id="l5.235">       Services.wm.addListener(this._windowListener);</span>
<a href="#l5.236"></a><span id="l5.236">     }</span>
<a href="#l5.237"></a><span id="l5.237"> </span>
<a href="#l5.238"></a><span id="l5.238">     if (openWindowList) {</span>
<a href="#l5.239"></a><span id="l5.239">       // We already have a list of open windows, notify the caller about them.</span>
<a href="#l5.240"></a><span id="l5.240">       openWindowList.forEach(domWindow =&gt;</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-        ExtensionSupport._checkAndRunMatchingExtensions(domWindow, &quot;load&quot;, aID));</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+        ExtensionSupport._checkAndRunMatchingExtensions(domWindow, &quot;load&quot;, aID)</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+      );</span>
<a href="#l5.244"></a><span id="l5.244">     } else {</span>
<a href="#l5.245"></a><span id="l5.245">       openWindowList = new Set();</span>
<a href="#l5.246"></a><span id="l5.246">       // Get the list of windows already open.</span>
<a href="#l5.247"></a><span id="l5.247">       let windows = Services.wm.getEnumerator(null);</span>
<a href="#l5.248"></a><span id="l5.248">       while (windows.hasMoreElements()) {</span>
<a href="#l5.249"></a><span id="l5.249">         let domWindow = windows.getNext();</span>
<a href="#l5.250"></a><span id="l5.250">         if (domWindow.document.location.href === &quot;about:blank&quot;) {</span>
<a href="#l5.251"></a><span id="l5.251">           ExtensionSupport._waitForLoad(domWindow, aID);</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineat">@@ -248,17 +284,19 @@ var ExtensionSupport = {</span>
<a href="#l5.253"></a><span id="l5.253">   unregisterWindowListener(aID) {</span>
<a href="#l5.254"></a><span id="l5.254">     if (!aID) {</span>
<a href="#l5.255"></a><span id="l5.255">       Cu.reportError(&quot;No extension ID provided for the window listener&quot;);</span>
<a href="#l5.256"></a><span id="l5.256">       return false;</span>
<a href="#l5.257"></a><span id="l5.257">     }</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259">     let windowListener = extensionHooks.get(aID);</span>
<a href="#l5.260"></a><span id="l5.260">     if (!windowListener) {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-      Cu.reportError(&quot;Couldn't remove window listener for extension + '&quot; + aID + &quot;'&quot;);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+      Cu.reportError(</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+        &quot;Couldn't remove window listener for extension + '&quot; + aID + &quot;'&quot;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+      );</span>
<a href="#l5.265"></a><span id="l5.265">       return false;</span>
<a href="#l5.266"></a><span id="l5.266">     }</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268">     extensionHooks.delete(aID);</span>
<a href="#l5.269"></a><span id="l5.269">     // Remove our global listener if there are no callers registered anymore.</span>
<a href="#l5.270"></a><span id="l5.270">     if (extensionHooks.size == 0) {</span>
<a href="#l5.271"></a><span id="l5.271">       Services.wm.removeListener(this._windowListener);</span>
<a href="#l5.272"></a><span id="l5.272">       openWindowList.clear();</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineat">@@ -293,34 +331,42 @@ var ExtensionSupport = {</span>
<a href="#l5.274"></a><span id="l5.274">    * Set up listeners to run the callbacks on the given window.</span>
<a href="#l5.275"></a><span id="l5.275">    *</span>
<a href="#l5.276"></a><span id="l5.276">    * @param aWindow {nsIDOMWindow}  The window to set up.</span>
<a href="#l5.277"></a><span id="l5.277">    * @param aID {String} Optional.  ID of the new caller that has registered right now.</span>
<a href="#l5.278"></a><span id="l5.278">    */</span>
<a href="#l5.279"></a><span id="l5.279">   _waitForLoad(aWindow, aID) {</span>
<a href="#l5.280"></a><span id="l5.280">     // Wait for the load event of the window. At that point</span>
<a href="#l5.281"></a><span id="l5.281">     // aWindow.document.location.href will not be &quot;about:blank&quot; any more.</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-    aWindow.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-      ExtensionSupport._addToListAndNotify(aWindow, aID);</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-    }, { once: true });</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+    aWindow.addEventListener(</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+      &quot;load&quot;,</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+      function() {</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+        ExtensionSupport._addToListAndNotify(aWindow, aID);</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+      },</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+      { once: true }</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+    );</span>
<a href="#l5.292"></a><span id="l5.292">   },</span>
<a href="#l5.293"></a><span id="l5.293"> </span>
<a href="#l5.294"></a><span id="l5.294">   /**</span>
<a href="#l5.295"></a><span id="l5.295">    * Once the window is fully loaded with the href referring to the XUL document,</span>
<a href="#l5.296"></a><span id="l5.296">    * add it to our list, attach the &quot;unload&quot; listener to it and notify interested</span>
<a href="#l5.297"></a><span id="l5.297">    * callers.</span>
<a href="#l5.298"></a><span id="l5.298">    *</span>
<a href="#l5.299"></a><span id="l5.299">    * @param aWindow {nsIDOMWindow}  The window to process.</span>
<a href="#l5.300"></a><span id="l5.300">    * @param aID {String} Optional.  ID of the new caller that has registered right now.</span>
<a href="#l5.301"></a><span id="l5.301">    */</span>
<a href="#l5.302"></a><span id="l5.302">   _addToListAndNotify(aWindow, aID) {</span>
<a href="#l5.303"></a><span id="l5.303">     openWindowList.add(aWindow);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-    aWindow.addEventListener(&quot;unload&quot;, function() {</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-      ExtensionSupport._checkAndRunMatchingExtensions(aWindow, &quot;unload&quot;);</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-    }, { once: true });</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+    aWindow.addEventListener(</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+      &quot;unload&quot;,</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+      function() {</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+        ExtensionSupport._checkAndRunMatchingExtensions(aWindow, &quot;unload&quot;);</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+      },</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+      { once: true }</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+    );</span>
<a href="#l5.314"></a><span id="l5.314">     ExtensionSupport._checkAndRunMatchingExtensions(aWindow, &quot;load&quot;, aID);</span>
<a href="#l5.315"></a><span id="l5.315">   },</span>
<a href="#l5.316"></a><span id="l5.316"> </span>
<a href="#l5.317"></a><span id="l5.317">   /**</span>
<a href="#l5.318"></a><span id="l5.318">    * Check if the caller matches the given window and run its callback function.</span>
<a href="#l5.319"></a><span id="l5.319">    *</span>
<a href="#l5.320"></a><span id="l5.320">    * @param aWindow {nsIDOMWindow}  The window to run the callbacks on.</span>
<a href="#l5.321"></a><span id="l5.321">    * @param aEventType {String}     Which callback to run if caller matches (load/unload).</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineat">@@ -341,29 +387,34 @@ var ExtensionSupport = {</span>
<a href="#l5.323"></a><span id="l5.323">      * and run its callback function.</span>
<a href="#l5.324"></a><span id="l5.324">      *</span>
<a href="#l5.325"></a><span id="l5.325">      * @param aExtensionHook {Object}  The object describing the hook the caller</span>
<a href="#l5.326"></a><span id="l5.326">      *                                 has registered.</span>
<a href="#l5.327"></a><span id="l5.327">      */</span>
<a href="#l5.328"></a><span id="l5.328">     function checkAndRunExtensionCode(aExtensionHook) {</span>
<a href="#l5.329"></a><span id="l5.329">       let windowChromeURL = aWindow.document.location.href;</span>
<a href="#l5.330"></a><span id="l5.330">       // Check if extension applies to this document URL.</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      if ((&quot;chromeURLs&quot; in aExtensionHook) &amp;&amp;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-          (!aExtensionHook.chromeURLs.some(url =&gt; url == windowChromeURL)))</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+      if (</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+        &quot;chromeURLs&quot; in aExtensionHook &amp;&amp;</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+        !aExtensionHook.chromeURLs.some(url =&gt; url == windowChromeURL)</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+      ) {</span>
<a href="#l5.337"></a><span id="l5.337">         return;</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+      }</span>
<a href="#l5.339"></a><span id="l5.339"> </span>
<a href="#l5.340"></a><span id="l5.340">       // Run the relevant callback.</span>
<a href="#l5.341"></a><span id="l5.341">       switch (aEventType) {</span>
<a href="#l5.342"></a><span id="l5.342">         case &quot;load&quot;:</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-          if (&quot;onLoadWindow&quot; in aExtensionHook)</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+          if (&quot;onLoadWindow&quot; in aExtensionHook) {</span>
<a href="#l5.345"></a><span id="l5.345">             aExtensionHook.onLoadWindow(aWindow);</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+          }</span>
<a href="#l5.347"></a><span id="l5.347">           break;</span>
<a href="#l5.348"></a><span id="l5.348">         case &quot;unload&quot;:</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-          if (&quot;onUnloadWindow&quot; in aExtensionHook)</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+          if (&quot;onUnloadWindow&quot; in aExtensionHook) {</span>
<a href="#l5.351"></a><span id="l5.351">             aExtensionHook.onUnloadWindow(aWindow);</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+          }</span>
<a href="#l5.353"></a><span id="l5.353">           break;</span>
<a href="#l5.354"></a><span id="l5.354">       }</span>
<a href="#l5.355"></a><span id="l5.355">     }</span>
<a href="#l5.356"></a><span id="l5.356">   },</span>
<a href="#l5.357"></a><span id="l5.357"> </span>
<a href="#l5.358"></a><span id="l5.358">   get registeredWindowListenerCount() {</span>
<a href="#l5.359"></a><span id="l5.359">     return extensionHooks.size;</span>
<a href="#l5.360"></a><span id="l5.360">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/common/src/Overlays.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/common/src/Overlays.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -6,18 +6,26 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * Load overlays in a similar way as XUL did for legacy XUL add-ons.</span>
<a href="#l6.5"></a><span id="l6.5">  */</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> &quot;use strict&quot;;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> this.EXPORTED_SYMBOLS = [&quot;Overlays&quot;];</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> const { ConsoleAPI } = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;Services&quot;, &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;setTimeout&quot;, &quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  this,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  &quot;Services&quot;,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  &quot;resource://gre/modules/Services.jsm&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  this,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  &quot;setTimeout&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &quot;resource://gre/modules/Timer.jsm&quot;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+);</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> let oconsole = new ConsoleAPI({</span>
<a href="#l6.26"></a><span id="l6.26">   prefix: &quot;Overlays.jsm&quot;,</span>
<a href="#l6.27"></a><span id="l6.27">   consoleID: &quot;overlays-jsm&quot;,</span>
<a href="#l6.28"></a><span id="l6.28">   maxLogLevelPref: &quot;extensions.overlayloader.loglevel&quot;,</span>
<a href="#l6.29"></a><span id="l6.29"> });</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31"> /**</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineat">@@ -91,43 +99,55 @@ class Overlays {</span>
<a href="#l6.33"></a><span id="l6.33">     while (unloadedOverlays.length) {</span>
<a href="#l6.34"></a><span id="l6.34">       let url = unloadedOverlays.shift();</span>
<a href="#l6.35"></a><span id="l6.35">       let xhr = this.fetchOverlay(url);</span>
<a href="#l6.36"></a><span id="l6.36">       let doc = xhr.responseXML;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">       oconsole.debug(`Applying ${url} to ${this.location}`);</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">       // clean the document a bit</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-      let emptyNodes = doc.evaluate(&quot;//text()[normalize-space(.) = '']&quot;, doc, null, 7, null);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+      let emptyNodes = doc.evaluate(</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+        &quot;//text()[normalize-space(.) = '']&quot;,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+        doc,</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+        null,</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+        7,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        null</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+      );</span>
<a href="#l6.49"></a><span id="l6.49">       for (let i = 0, len = emptyNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l6.50"></a><span id="l6.50">         let node = emptyNodes.snapshotItem(i);</span>
<a href="#l6.51"></a><span id="l6.51">         node.remove();</span>
<a href="#l6.52"></a><span id="l6.52">       }</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">       let commentNodes = doc.evaluate(&quot;//comment()&quot;, doc, null, 7, null);</span>
<a href="#l6.55"></a><span id="l6.55">       for (let i = 0, len = commentNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l6.56"></a><span id="l6.56">         let node = commentNodes.snapshotItem(i);</span>
<a href="#l6.57"></a><span id="l6.57">         node.remove();</span>
<a href="#l6.58"></a><span id="l6.58">       }</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">       // Force a re-evaluation of inline styles to work around an issue</span>
<a href="#l6.61"></a><span id="l6.61">       // causing inline styles to be initially ignored.</span>
<a href="#l6.62"></a><span id="l6.62">       let styledNodes = doc.evaluate(&quot;//*[@style]&quot;, doc, null, 7, null);</span>
<a href="#l6.63"></a><span id="l6.63">       for (let i = 0, len = styledNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l6.64"></a><span id="l6.64">         let node = styledNodes.snapshotItem(i);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-        node.style.display = node.style.display;  // eslint-disable-line no-self-assign</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+        node.style.display = node.style.display; // eslint-disable-line no-self-assign</span>
<a href="#l6.67"></a><span id="l6.67">       }</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69">       // Load css styles from the registry</span>
<a href="#l6.70"></a><span id="l6.70">       for (let sheet of this.overlayProvider.style.get(url, false)) {</span>
<a href="#l6.71"></a><span id="l6.71">         unloadedSheets.push(sheet);</span>
<a href="#l6.72"></a><span id="l6.72">       }</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">       // Load css processing instructions from the overlay</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-      let stylesheets = doc.evaluate(&quot;/processing-instruction('xml-stylesheet')&quot;, doc, null, 7, null);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+      let stylesheets = doc.evaluate(</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+        &quot;/processing-instruction('xml-stylesheet')&quot;,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+        doc,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+        null,</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+        7,</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+        null</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+      );</span>
<a href="#l6.83"></a><span id="l6.83">       for (let i = 0, len = stylesheets.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l6.84"></a><span id="l6.84">         let node = stylesheets.snapshotItem(i);</span>
<a href="#l6.85"></a><span id="l6.85">         let match = node.nodeValue.match(/href=[&quot;']([^&quot;']*)[&quot;']/);</span>
<a href="#l6.86"></a><span id="l6.86">         if (match) {</span>
<a href="#l6.87"></a><span id="l6.87">           unloadedSheets.push(new URL(match[1], node.baseURI).href);</span>
<a href="#l6.88"></a><span id="l6.88">         }</span>
<a href="#l6.89"></a><span id="l6.89">       }</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91" class="difflineat">@@ -167,17 +187,20 @@ class Overlays {</span>
<a href="#l6.92"></a><span id="l6.92">           unresolved.push(ref);</span>
<a href="#l6.93"></a><span id="l6.93">         }</span>
<a href="#l6.94"></a><span id="l6.94">       }</span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96">       forwardReferences = unresolved;</span>
<a href="#l6.97"></a><span id="l6.97">     }</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99">     if (forwardReferences.length) {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-      oconsole.warn(`Could not resolve ${forwardReferences.length} references`, forwardReferences);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+      oconsole.warn(</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+        `Could not resolve ${forwardReferences.length} references`,</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+        forwardReferences</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+      );</span>
<a href="#l6.105"></a><span id="l6.105">     }</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">     // Loading the sheets now to avoid race conditions with xbl bindings</span>
<a href="#l6.108"></a><span id="l6.108">     for (let sheet of unloadedSheets) {</span>
<a href="#l6.109"></a><span id="l6.109">       this.loadCSS(sheet);</span>
<a href="#l6.110"></a><span id="l6.110">     }</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112">     this._decksToResolve = new Map();</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineat">@@ -217,44 +240,58 @@ class Overlays {</span>
<a href="#l6.114"></a><span id="l6.114">           }</span>
<a href="#l6.115"></a><span id="l6.115">         }</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117">         for (let listener of bubbles) {</span>
<a href="#l6.118"></a><span id="l6.118">           this._fireEventListener(listener);</span>
<a href="#l6.119"></a><span id="l6.119">         }</span>
<a href="#l6.120"></a><span id="l6.120">       });</span>
<a href="#l6.121"></a><span id="l6.121">     } else {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-      this.document.defaultView.addEventListener(&quot;load&quot;, this._finish.bind(this), { once: true });</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+      this.document.defaultView.addEventListener(</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+        &quot;load&quot;,</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+        this._finish.bind(this),</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+        { once: true }</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+      );</span>
<a href="#l6.128"></a><span id="l6.128">     }</span>
<a href="#l6.129"></a><span id="l6.129">   }</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131">   _finish() {</span>
<a href="#l6.132"></a><span id="l6.132">     for (let [deck, selectedIndex] of this._decksToResolve.entries()) {</span>
<a href="#l6.133"></a><span id="l6.133">       deck.setAttribute(&quot;selectedIndex&quot;, selectedIndex);</span>
<a href="#l6.134"></a><span id="l6.134">     }</span>
<a href="#l6.135"></a><span id="l6.135"> </span>
<a href="#l6.136"></a><span id="l6.136">     for (let bar of this._toolbarsToResolve) {</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-      let currentset = Services.xulStore.getValue(this.location, bar.id, &quot;currentset&quot;);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+      let currentset = Services.xulStore.getValue(</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+        this.location,</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+        bar.id,</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+        &quot;currentset&quot;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+      );</span>
<a href="#l6.143"></a><span id="l6.143">       if (currentset) {</span>
<a href="#l6.144"></a><span id="l6.144">         bar.currentSet = currentset;</span>
<a href="#l6.145"></a><span id="l6.145">       } else if (bar.getAttribute(&quot;defaultset&quot;)) {</span>
<a href="#l6.146"></a><span id="l6.146">         bar.currentSet = bar.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l6.147"></a><span id="l6.147">       }</span>
<a href="#l6.148"></a><span id="l6.148">     }</span>
<a href="#l6.149"></a><span id="l6.149">   }</span>
<a href="#l6.150"></a><span id="l6.150"> </span>
<a href="#l6.151"></a><span id="l6.151">   /**</span>
<a href="#l6.152"></a><span id="l6.152">    * Gets the overlays referenced by processing instruction on a document.</span>
<a href="#l6.153"></a><span id="l6.153">    *</span>
<a href="#l6.154"></a><span id="l6.154">    * @param {DOMDocument} document  The document to read instuctions from</span>
<a href="#l6.155"></a><span id="l6.155">    * @return {String[]}             URLs of the overlays from the document</span>
<a href="#l6.156"></a><span id="l6.156">    */</span>
<a href="#l6.157"></a><span id="l6.157">   _collectOverlays(doc) {</span>
<a href="#l6.158"></a><span id="l6.158">     let urls = [];</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-    let instructions = doc.evaluate(&quot;/processing-instruction('xul-overlay')&quot;, doc, null, 7, null);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+    let instructions = doc.evaluate(</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+      &quot;/processing-instruction('xul-overlay')&quot;,</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+      doc,</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+      null,</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+      7,</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+      null</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+    );</span>
<a href="#l6.167"></a><span id="l6.167">     for (let i = 0, len = instructions.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l6.168"></a><span id="l6.168">       let node = instructions.snapshotItem(i);</span>
<a href="#l6.169"></a><span id="l6.169">       let match = node.nodeValue.match(/href=[&quot;']([^&quot;']*)[&quot;']/);</span>
<a href="#l6.170"></a><span id="l6.170">       if (match) {</span>
<a href="#l6.171"></a><span id="l6.171">         urls.push(match[1]);</span>
<a href="#l6.172"></a><span id="l6.172">       }</span>
<a href="#l6.173"></a><span id="l6.173">     }</span>
<a href="#l6.174"></a><span id="l6.174">     return urls;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineat">@@ -293,75 +330,89 @@ class Overlays {</span>
<a href="#l6.176"></a><span id="l6.176">           box = target.closest(&quot;toolbox&quot;);</span>
<a href="#l6.177"></a><span id="l6.177">         } else {</span>
<a href="#l6.178"></a><span id="l6.178">           // These vanish from the document but still exist via the palette property</span>
<a href="#l6.179"></a><span id="l6.179">           let boxes = [...this.document.getElementsByTagName(&quot;toolbox&quot;)];</span>
<a href="#l6.180"></a><span id="l6.180">           box = boxes.find(box =&gt; box.palette &amp;&amp; box.palette.id == node.id);</span>
<a href="#l6.181"></a><span id="l6.181">           let palette = box ? box.palette : null;</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183">           if (!palette) {</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-            oconsole.debug(`The palette for ${node.id} could not be found, deferring to later`);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+            oconsole.debug(</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+              `The palette for ${</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+                node.id</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+              } could not be found, deferring to later`</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+            );</span>
<a href="#l6.190"></a><span id="l6.190">             return false;</span>
<a href="#l6.191"></a><span id="l6.191">           }</span>
<a href="#l6.192"></a><span id="l6.192"> </span>
<a href="#l6.193"></a><span id="l6.193">           target = palette;</span>
<a href="#l6.194"></a><span id="l6.194">         }</span>
<a href="#l6.195"></a><span id="l6.195"> </span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-        this._toolbarsToResolve.push(...box.querySelectorAll(&quot;toolbar:not([type=\&quot;menubar\&quot;])&quot;));</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+        this._toolbarsToResolve.push(</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+          ...box.querySelectorAll('toolbar:not([type=&quot;menubar&quot;])')</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+        );</span>
<a href="#l6.200"></a><span id="l6.200">       } else if (!target) {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-        oconsole.debug(`The node ${node.id} could not be found, deferring to later`);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+        oconsole.debug(</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+          `The node ${node.id} could not be found, deferring to later`</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+        );</span>
<a href="#l6.205"></a><span id="l6.205">         return false;</span>
<a href="#l6.206"></a><span id="l6.206">       }</span>
<a href="#l6.207"></a><span id="l6.207"> </span>
<a href="#l6.208"></a><span id="l6.208">       this._mergeElement(target, node);</span>
<a href="#l6.209"></a><span id="l6.209">     } else {</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-       this._insertElement(this.document.documentElement, node);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+      this._insertElement(this.document.documentElement, node);</span>
<a href="#l6.212"></a><span id="l6.212">     }</span>
<a href="#l6.213"></a><span id="l6.213">     return true;</span>
<a href="#l6.214"></a><span id="l6.214">   }</span>
<a href="#l6.215"></a><span id="l6.215"> </span>
<a href="#l6.216"></a><span id="l6.216">   /**</span>
<a href="#l6.217"></a><span id="l6.217">    * Insert the node in the given parent, observing the insertbefore/insertafter/position attributes</span>
<a href="#l6.218"></a><span id="l6.218">    *</span>
<a href="#l6.219"></a><span id="l6.219">    * @param {Element} parent        The parent element to insert the node into.</span>
<a href="#l6.220"></a><span id="l6.220">    * @param {Element} node          The node to insert.</span>
<a href="#l6.221"></a><span id="l6.221">    */</span>
<a href="#l6.222"></a><span id="l6.222">   _insertElement(parent, node) {</span>
<a href="#l6.223"></a><span id="l6.223">     // These elements need their values set before they are added to</span>
<a href="#l6.224"></a><span id="l6.224">     // the document, or bad things happen.</span>
<a href="#l6.225"></a><span id="l6.225">     for (let element of node.querySelectorAll(&quot;menulist&quot;)) {</span>
<a href="#l6.226"></a><span id="l6.226">       if (element.id &amp;&amp; this.persistedIDs.has(element.id)) {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-        element.setAttribute(&quot;value&quot;, Services.xulStore.getValue(this.location, element.id, &quot;value&quot;));</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+        element.setAttribute(</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+          &quot;value&quot;,</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+          Services.xulStore.getValue(this.location, element.id, &quot;value&quot;)</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+        );</span>
<a href="#l6.232"></a><span id="l6.232">       }</span>
<a href="#l6.233"></a><span id="l6.233">     }</span>
<a href="#l6.234"></a><span id="l6.234"> </span>
<a href="#l6.235"></a><span id="l6.235">     let wasInserted = false;</span>
<a href="#l6.236"></a><span id="l6.236">     let pos = node.getAttribute(&quot;insertafter&quot;);</span>
<a href="#l6.237"></a><span id="l6.237">     let after = true;</span>
<a href="#l6.238"></a><span id="l6.238"> </span>
<a href="#l6.239"></a><span id="l6.239">     if (!pos) {</span>
<a href="#l6.240"></a><span id="l6.240">       pos = node.getAttribute(&quot;insertbefore&quot;);</span>
<a href="#l6.241"></a><span id="l6.241">       after = false;</span>
<a href="#l6.242"></a><span id="l6.242">     }</span>
<a href="#l6.243"></a><span id="l6.243"> </span>
<a href="#l6.244"></a><span id="l6.244">     if (pos) {</span>
<a href="#l6.245"></a><span id="l6.245">       for (let id of pos.split(&quot;,&quot;)) {</span>
<a href="#l6.246"></a><span id="l6.246">         let targetchild = this.document.getElementById(id);</span>
<a href="#l6.247"></a><span id="l6.247">         if (targetchild &amp;&amp; targetchild.parentNode == parent) {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-          parent.insertBefore(node, after ? targetchild.nextSibling : targetchild);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+          parent.insertBefore(</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+            node,</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+            after ? targetchild.nextSibling : targetchild</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+          );</span>
<a href="#l6.253"></a><span id="l6.253">           wasInserted = true;</span>
<a href="#l6.254"></a><span id="l6.254">           break;</span>
<a href="#l6.255"></a><span id="l6.255">         }</span>
<a href="#l6.256"></a><span id="l6.256">       }</span>
<a href="#l6.257"></a><span id="l6.257">     }</span>
<a href="#l6.258"></a><span id="l6.258"> </span>
<a href="#l6.259"></a><span id="l6.259">     if (!wasInserted) {</span>
<a href="#l6.260"></a><span id="l6.260">       // position is 1-based</span>
<a href="#l6.261"></a><span id="l6.261">       let position = parseInt(node.getAttribute(&quot;position&quot;), 10);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-      if (position &gt; 0 &amp;&amp; (position - 1) &lt;= parent.childNodes.length) {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+      if (position &gt; 0 &amp;&amp; position - 1 &lt;= parent.childNodes.length) {</span>
<a href="#l6.264"></a><span id="l6.264">         parent.insertBefore(node, parent.childNodes[position - 1]);</span>
<a href="#l6.265"></a><span id="l6.265">         wasInserted = true;</span>
<a href="#l6.266"></a><span id="l6.266">       }</span>
<a href="#l6.267"></a><span id="l6.267">     }</span>
<a href="#l6.268"></a><span id="l6.268"> </span>
<a href="#l6.269"></a><span id="l6.269">     if (!wasInserted) {</span>
<a href="#l6.270"></a><span id="l6.270">       parent.appendChild(node);</span>
<a href="#l6.271"></a><span id="l6.271">     }</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineat">@@ -381,24 +432,30 @@ class Overlays {</span>
<a href="#l6.273"></a><span id="l6.273">         continue;</span>
<a href="#l6.274"></a><span id="l6.274">       }</span>
<a href="#l6.275"></a><span id="l6.275"> </span>
<a href="#l6.276"></a><span id="l6.276">       if (attribute.name == &quot;removeelement&quot; &amp;&amp; attribute.value == &quot;true&quot;) {</span>
<a href="#l6.277"></a><span id="l6.277">         target.remove();</span>
<a href="#l6.278"></a><span id="l6.278">         return;</span>
<a href="#l6.279"></a><span id="l6.279">       }</span>
<a href="#l6.280"></a><span id="l6.280"> </span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-      target.setAttributeNS(attribute.namespaceURI, attribute.name, attribute.value);</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+      target.setAttributeNS(</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+        attribute.namespaceURI,</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+        attribute.name,</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+        attribute.value</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+      );</span>
<a href="#l6.287"></a><span id="l6.287">     }</span>
<a href="#l6.288"></a><span id="l6.288"> </span>
<a href="#l6.289"></a><span id="l6.289">     for (let i = 0, len = node.childElementCount; i &lt; len; i++) {</span>
<a href="#l6.290"></a><span id="l6.290">       let child = node.firstElementChild;</span>
<a href="#l6.291"></a><span id="l6.291">       child.remove();</span>
<a href="#l6.292"></a><span id="l6.292"> </span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-      let elementInDocument = child.id ? this.document.getElementById(child.id) : null;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+      let elementInDocument = child.id</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+        ? this.document.getElementById(child.id)</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+        : null;</span>
<a href="#l6.297"></a><span id="l6.297">       let parentId = elementInDocument ? elementInDocument.parentNode.id : null;</span>
<a href="#l6.298"></a><span id="l6.298"> </span>
<a href="#l6.299"></a><span id="l6.299">       if (parentId &amp;&amp; parentId == target.id) {</span>
<a href="#l6.300"></a><span id="l6.300">         this._mergeElement(elementInDocument, child);</span>
<a href="#l6.301"></a><span id="l6.301">       } else {</span>
<a href="#l6.302"></a><span id="l6.302">         this._insertElement(target, child);</span>
<a href="#l6.303"></a><span id="l6.303">       }</span>
<a href="#l6.304"></a><span id="l6.304">     }</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineat">@@ -408,29 +465,33 @@ class Overlays {</span>
<a href="#l6.306"></a><span id="l6.306">    * Fetches the overlay from the given chrome:// or resource:// URL. This happen synchronously so</span>
<a href="#l6.307"></a><span id="l6.307">    * we have a chance to complete before the load event.</span>
<a href="#l6.308"></a><span id="l6.308">    *</span>
<a href="#l6.309"></a><span id="l6.309">    * @param {String} srcUrl                         The URL to load</span>
<a href="#l6.310"></a><span id="l6.310">    * @return {XMLHttpRequest}                       The completed XHR.</span>
<a href="#l6.311"></a><span id="l6.311">    */</span>
<a href="#l6.312"></a><span id="l6.312">   fetchOverlay(srcUrl) {</span>
<a href="#l6.313"></a><span id="l6.313">     if (!srcUrl.startsWith(&quot;chrome://&quot;) &amp;&amp; !srcUrl.startsWith(&quot;resource://&quot;)) {</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-      throw new Error(&quot;May only load overlays from chrome:// or resource:// uris&quot;);</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+      throw new Error(</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+        &quot;May only load overlays from chrome:// or resource:// uris&quot;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+      );</span>
<a href="#l6.318"></a><span id="l6.318">     }</span>
<a href="#l6.319"></a><span id="l6.319"> </span>
<a href="#l6.320"></a><span id="l6.320">     let xhr = new XMLHttpRequest();</span>
<a href="#l6.321"></a><span id="l6.321">     xhr.overrideMimeType(&quot;application/xml&quot;);</span>
<a href="#l6.322"></a><span id="l6.322">     xhr.open(&quot;GET&quot;, srcUrl, false);</span>
<a href="#l6.323"></a><span id="l6.323"> </span>
<a href="#l6.324"></a><span id="l6.324">     // Elevate the request, so DTDs will work. Should not be a security issue since we</span>
<a href="#l6.325"></a><span id="l6.325">     // only load chrome, resource and file URLs, and that is our privileged chrome package.</span>
<a href="#l6.326"></a><span id="l6.326">     try {</span>
<a href="#l6.327"></a><span id="l6.327">       xhr.channel.owner = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l6.328"></a><span id="l6.328">     } catch (ex) {</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-      oconsole.error(&quot;Failed to set system principal while fetching overlay &quot; + srcUrl);</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+      oconsole.error(</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+        &quot;Failed to set system principal while fetching overlay &quot; + srcUrl</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+      );</span>
<a href="#l6.333"></a><span id="l6.333">       xhr.close();</span>
<a href="#l6.334"></a><span id="l6.334">       throw new Error(&quot;Failed to set system principal&quot;);</span>
<a href="#l6.335"></a><span id="l6.335">     }</span>
<a href="#l6.336"></a><span id="l6.336"> </span>
<a href="#l6.337"></a><span id="l6.337">     xhr.send(null);</span>
<a href="#l6.338"></a><span id="l6.338">     return xhr;</span>
<a href="#l6.339"></a><span id="l6.339">   }</span>
<a href="#l6.340"></a><span id="l6.340"> </span>
<a href="#l6.341"></a><span id="l6.341" class="difflineat">@@ -443,44 +504,56 @@ class Overlays {</span>
<a href="#l6.342"></a><span id="l6.342">    *                                                  describing load handlers the script creates</span>
<a href="#l6.343"></a><span id="l6.343">    *                                                  when first run.</span>
<a href="#l6.344"></a><span id="l6.344">    */</span>
<a href="#l6.345"></a><span id="l6.345">   loadScript(node) {</span>
<a href="#l6.346"></a><span id="l6.346">     let deferredLoad = [];</span>
<a href="#l6.347"></a><span id="l6.347"> </span>
<a href="#l6.348"></a><span id="l6.348">     let oldAddEventListener = this.window.addEventListener;</span>
<a href="#l6.349"></a><span id="l6.349">     if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-      this.window.addEventListener = function(type, listener, useCapture, ...args) {</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+      this.window.addEventListener = function(</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+        type,</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+        listener,</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+        useCapture,</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+        ...args</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+      ) {</span>
<a href="#l6.357"></a><span id="l6.357">         if (type == &quot;load&quot;) {</span>
<a href="#l6.358"></a><span id="l6.358">           if (typeof useCapture == &quot;object&quot;) {</span>
<a href="#l6.359"></a><span id="l6.359">             useCapture = useCapture.capture;</span>
<a href="#l6.360"></a><span id="l6.360">           }</span>
<a href="#l6.361"></a><span id="l6.361"> </span>
<a href="#l6.362"></a><span id="l6.362">           if (typeof useCapture == &quot;undefined&quot;) {</span>
<a href="#l6.363"></a><span id="l6.363">             useCapture = true;</span>
<a href="#l6.364"></a><span id="l6.364">           }</span>
<a href="#l6.365"></a><span id="l6.365">           deferredLoad.push({ listener, useCapture });</span>
<a href="#l6.366"></a><span id="l6.366">           return null;</span>
<a href="#l6.367"></a><span id="l6.367">         }</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-        return oldAddEventListener.call(this, type, listener, useCapture, ...args);</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+        return oldAddEventListener.call(</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+          this,</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+          type,</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+          listener,</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+          useCapture,</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+          ...args</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+        );</span>
<a href="#l6.376"></a><span id="l6.376">       };</span>
<a href="#l6.377"></a><span id="l6.377">     }</span>
<a href="#l6.378"></a><span id="l6.378"> </span>
<a href="#l6.379"></a><span id="l6.379">     if (node.hasAttribute(&quot;src&quot;)) {</span>
<a href="#l6.380"></a><span id="l6.380">       let url = new URL(node.getAttribute(&quot;src&quot;), node.baseURI).href;</span>
<a href="#l6.381"></a><span id="l6.381">       oconsole.debug(`Loading script ${url} into ${this.window.location}`);</span>
<a href="#l6.382"></a><span id="l6.382">       try {</span>
<a href="#l6.383"></a><span id="l6.383">         Services.scriptloader.loadSubScript(url, this.window);</span>
<a href="#l6.384"></a><span id="l6.384">       } catch (ex) {</span>
<a href="#l6.385"></a><span id="l6.385">         Cu.reportError(ex);</span>
<a href="#l6.386"></a><span id="l6.386">       }</span>
<a href="#l6.387"></a><span id="l6.387">     } else if (node.textContent) {</span>
<a href="#l6.388"></a><span id="l6.388">       oconsole.debug(`Loading eval'd script into ${this.window.location}`);</span>
<a href="#l6.389"></a><span id="l6.389">       try {</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-        let dataURL = &quot;data:application/javascript,&quot; + encodeURIComponent(node.textContent);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+        let dataURL =</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+          &quot;data:application/javascript,&quot; + encodeURIComponent(node.textContent);</span>
<a href="#l6.393"></a><span id="l6.393">         // It would be great if we could have script errors show the right url, but for now</span>
<a href="#l6.394"></a><span id="l6.394">         // loadSubScript will have to do.</span>
<a href="#l6.395"></a><span id="l6.395">         Services.scriptloader.loadSubScript(dataURL, this.window);</span>
<a href="#l6.396"></a><span id="l6.396">       } catch (ex) {</span>
<a href="#l6.397"></a><span id="l6.397">         Cu.reportError(ex);</span>
<a href="#l6.398"></a><span id="l6.398">       }</span>
<a href="#l6.399"></a><span id="l6.399">     }</span>
<a href="#l6.400"></a><span id="l6.400"> </span>
<a href="#l6.401"></a><span id="l6.401" class="difflineat">@@ -499,17 +572,20 @@ class Overlays {</span>
<a href="#l6.402"></a><span id="l6.402">    * @param {String} url        The url to load from</span>
<a href="#l6.403"></a><span id="l6.403">    * @return {Element}          An HTML link element for this stylesheet</span>
<a href="#l6.404"></a><span id="l6.404">    */</span>
<a href="#l6.405"></a><span id="l6.405">   loadCSS(url) {</span>
<a href="#l6.406"></a><span id="l6.406">     oconsole.debug(`Loading ${url} into ${this.window.location}`);</span>
<a href="#l6.407"></a><span id="l6.407"> </span>
<a href="#l6.408"></a><span id="l6.408">     // domWindowUtils.loadSheetUsingURIString doesn't record the sheet in document.styleSheets,</span>
<a href="#l6.409"></a><span id="l6.409">     // adding a html link element seems to do so.</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-    let link = this.document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;link&quot;);</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+    let link = this.document.createElementNS(</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+      &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+      &quot;link&quot;</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+    );</span>
<a href="#l6.415"></a><span id="l6.415">     link.setAttribute(&quot;rel&quot;, &quot;stylesheet&quot;);</span>
<a href="#l6.416"></a><span id="l6.416">     link.setAttribute(&quot;type&quot;, &quot;text/css&quot;);</span>
<a href="#l6.417"></a><span id="l6.417">     link.setAttribute(&quot;href&quot;, url);</span>
<a href="#l6.418"></a><span id="l6.418"> </span>
<a href="#l6.419"></a><span id="l6.419">     this.document.documentElement.appendChild(link);</span>
<a href="#l6.420"></a><span id="l6.420">     return link;</span>
<a href="#l6.421"></a><span id="l6.421">   }</span>
<a href="#l6.422"></a><span id="l6.422"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/common/src/browser-development-helpers.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/common/src/browser-development-helpers.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -13,21 +13,24 @@ var DevelopmentHelpers = {</span>
<a href="#l7.4"></a><span id="l7.4">   init() {</span>
<a href="#l7.5"></a><span id="l7.5">     this.quickRestart = this.quickRestart.bind(this);</span>
<a href="#l7.6"></a><span id="l7.6">     this.addRestartShortcut();</span>
<a href="#l7.7"></a><span id="l7.7">   },</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   quickRestart() {</span>
<a href="#l7.10"></a><span id="l7.10">     Services.obs.notifyObservers(null, &quot;startupcache-invalidate&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    let env = Cc[&quot;@mozilla.org/process/environment;1&quot;].</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-              getService(Ci.nsIEnvironment);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    let env = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+      Ci.nsIEnvironment</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    );</span>
<a href="#l7.17"></a><span id="l7.17">     env.set(&quot;MOZ_DISABLE_SAFE_MODE_KEY&quot;, &quot;1&quot;);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-    Services.startup.quit(Ci.nsIAppStartup.eAttemptQuit | Ci.nsIAppStartup.eRestart);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    Services.startup.quit(</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+      Ci.nsIAppStartup.eAttemptQuit | Ci.nsIAppStartup.eRestart</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    );</span>
<a href="#l7.23"></a><span id="l7.23">   },</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   addRestartShortcut() {</span>
<a href="#l7.26"></a><span id="l7.26">     let command = document.createXULElement(&quot;command&quot;);</span>
<a href="#l7.27"></a><span id="l7.27">     command.setAttribute(&quot;id&quot;, &quot;cmd_quickRestart&quot;);</span>
<a href="#l7.28"></a><span id="l7.28">     command.addEventListener(&quot;command&quot;, this.quickRestart, true);</span>
<a href="#l7.29"></a><span id="l7.29">     command.setAttribute(&quot;oncommand&quot;, &quot;void 0;&quot;); // Needed - bug 371900</span>
<a href="#l7.30"></a><span id="l7.30">     document.getElementById(&quot;mainCommandSet&quot;).prepend(command);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/common/src/customizeToolbar.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/common/src/customizeToolbar.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -4,25 +4,26 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> var gToolboxDocument = null;</span>
<a href="#l8.6"></a><span id="l8.6"> var gToolbox = null;</span>
<a href="#l8.7"></a><span id="l8.7"> var gCurrentDragOverItem = null;</span>
<a href="#l8.8"></a><span id="l8.8"> var gToolboxChanged = false;</span>
<a href="#l8.9"></a><span id="l8.9"> var gToolboxSheet = false;</span>
<a href="#l8.10"></a><span id="l8.10"> var gPaletteBox = null;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+var { AppConstants } = ChromeUtils.import(</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> function onLoad() {</span>
<a href="#l8.20"></a><span id="l8.20">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l8.21"></a><span id="l8.21">     InitWithToolbox(window.arguments[0]);</span>
<a href="#l8.22"></a><span id="l8.22">     repositionDialog(window);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  } else if (window.frameElement &amp;&amp;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-           &quot;toolbox&quot; in window.frameElement) {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  } else if (window.frameElement &amp;&amp; &quot;toolbox&quot; in window.frameElement) {</span>
<a href="#l8.26"></a><span id="l8.26">     gToolboxSheet = true;</span>
<a href="#l8.27"></a><span id="l8.27">     InitWithToolbox(window.frameElement.toolbox);</span>
<a href="#l8.28"></a><span id="l8.28">     repositionDialog(window.frameElement.panel);</span>
<a href="#l8.29"></a><span id="l8.29">   }</span>
<a href="#l8.30"></a><span id="l8.30"> }</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> function InitWithToolbox(aToolbox) {</span>
<a href="#l8.33"></a><span id="l8.33">   gToolbox = aToolbox;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -41,25 +42,27 @@ function InitWithToolbox(aToolbox) {</span>
<a href="#l8.35"></a><span id="l8.35">     elts[i].addEventListener(&quot;dragexit&quot;, onToolbarDragExit, true);</span>
<a href="#l8.36"></a><span id="l8.36">     elts[i].addEventListener(&quot;drop&quot;, onToolbarDrop, true);</span>
<a href="#l8.37"></a><span id="l8.37">   }</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   initDialog();</span>
<a href="#l8.40"></a><span id="l8.40"> }</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42"> function onClose() {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  if (!gToolboxSheet)</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  if (!gToolboxSheet) {</span>
<a href="#l8.45"></a><span id="l8.45">     window.close();</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  else</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  } else {</span>
<a href="#l8.48"></a><span id="l8.48">     finishToolbarCustomization();</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  }</span>
<a href="#l8.50"></a><span id="l8.50"> }</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52"> function onUnload() {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  if (!gToolboxSheet)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  if (!gToolboxSheet) {</span>
<a href="#l8.55"></a><span id="l8.55">     finishToolbarCustomization();</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  }</span>
<a href="#l8.57"></a><span id="l8.57"> }</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59"> function finishToolbarCustomization() {</span>
<a href="#l8.60"></a><span id="l8.60">   removeToolboxListeners();</span>
<a href="#l8.61"></a><span id="l8.61">   unwrapToolbarItems();</span>
<a href="#l8.62"></a><span id="l8.62">   persistCurrentSets();</span>
<a href="#l8.63"></a><span id="l8.63">   gToolbox.customizing = false;</span>
<a href="#l8.64"></a><span id="l8.64">   forEachCustomizableToolbar(function(toolbar) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -69,54 +72,60 @@ function finishToolbarCustomization() {</span>
<a href="#l8.66"></a><span id="l8.66">   notifyParentComplete();</span>
<a href="#l8.67"></a><span id="l8.67"> }</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69"> function initDialog() {</span>
<a href="#l8.70"></a><span id="l8.70">   var mode = gToolbox.getAttribute(&quot;mode&quot;);</span>
<a href="#l8.71"></a><span id="l8.71">   document.getElementById(&quot;modelist&quot;).value = mode;</span>
<a href="#l8.72"></a><span id="l8.72">   var smallIconsCheckbox = document.getElementById(&quot;smallicons&quot;);</span>
<a href="#l8.73"></a><span id="l8.73">   smallIconsCheckbox.checked = gToolbox.getAttribute(&quot;iconsize&quot;) == &quot;small&quot;;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  if (mode == &quot;text&quot;)</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  if (mode == &quot;text&quot;) {</span>
<a href="#l8.76"></a><span id="l8.76">     smallIconsCheckbox.disabled = true;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  }</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79">   if (AppConstants.MOZ_APP_NAME == &quot;thunderbird&quot;) {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-      document.getElementById(&quot;showTitlebar&quot;).checked =</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-        !Services.prefs.getBoolPref(&quot;mail.tabs.drawInTitlebar&quot;);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-      document.getElementById(&quot;showDragSpace&quot;).checked =</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-        Services.prefs.getBoolPref(&quot;mail.tabs.extraDragSpace&quot;);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-    if (window.opener &amp;&amp;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-       (window.opener.document.documentElement.getAttribute(&quot;windowtype&quot;) ==</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-        &quot;mail:3pane&quot;)) {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    document.getElementById(</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+      &quot;showTitlebar&quot;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    ).checked = !Services.prefs.getBoolPref(&quot;mail.tabs.drawInTitlebar&quot;);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    document.getElementById(</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+      &quot;showDragSpace&quot;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    ).checked = Services.prefs.getBoolPref(&quot;mail.tabs.extraDragSpace&quot;);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    if (</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+      window.opener &amp;&amp;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+      window.opener.document.documentElement.getAttribute(&quot;windowtype&quot;) ==</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+        &quot;mail:3pane&quot;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    ) {</span>
<a href="#l8.98"></a><span id="l8.98">       document.getElementById(&quot;titlebarSettings&quot;).hidden = false;</span>
<a href="#l8.99"></a><span id="l8.99">     }</span>
<a href="#l8.100"></a><span id="l8.100">   }</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">   // Build up the palette of other items.</span>
<a href="#l8.103"></a><span id="l8.103">   buildPalette();</span>
<a href="#l8.104"></a><span id="l8.104"> </span>
<a href="#l8.105"></a><span id="l8.105">   // Wrap all the items on the toolbar in toolbarpaletteitems.</span>
<a href="#l8.106"></a><span id="l8.106">   wrapToolbarItems();</span>
<a href="#l8.107"></a><span id="l8.107"> }</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109"> function repositionDialog(aWindow) {</span>
<a href="#l8.110"></a><span id="l8.110">   // Position the dialog touching the bottom of the toolbox and centered with</span>
<a href="#l8.111"></a><span id="l8.111">   // it.</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-  if (!aWindow)</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  if (!aWindow) {</span>
<a href="#l8.114"></a><span id="l8.114">     return;</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  }</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">   var width;</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-  if (aWindow != window)</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  if (aWindow != window) {</span>
<a href="#l8.120"></a><span id="l8.120">     width = aWindow.getBoundingClientRect().width;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-  else if (document.documentElement.hasAttribute(&quot;width&quot;))</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  } else if (document.documentElement.hasAttribute(&quot;width&quot;)) {</span>
<a href="#l8.123"></a><span id="l8.123">     width = document.documentElement.getAttribute(&quot;width&quot;);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  else</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  } else {</span>
<a href="#l8.126"></a><span id="l8.126">     width = parseInt(document.documentElement.style.width);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  }</span>
<a href="#l8.128"></a><span id="l8.128">   var boundingRect = gToolbox.getBoundingClientRect();</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  var screenX = gToolbox.screenX</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-                + ((boundingRect.width - width) / 2);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  var screenX = gToolbox.screenX + (boundingRect.width - width) / 2;</span>
<a href="#l8.132"></a><span id="l8.132">   var screenY = gToolbox.screenY + boundingRect.height;</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134">   aWindow.moveTo(screenX, screenY);</span>
<a href="#l8.135"></a><span id="l8.135"> }</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137"> function removeToolboxListeners() {</span>
<a href="#l8.138"></a><span id="l8.138">   var elts = getRootElements();</span>
<a href="#l8.139"></a><span id="l8.139">   for (let i = 0; i &lt; elts.length; i++) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineat">@@ -127,59 +136,63 @@ function removeToolboxListeners() {</span>
<a href="#l8.141"></a><span id="l8.141">   }</span>
<a href="#l8.142"></a><span id="l8.142"> }</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144"> /**</span>
<a href="#l8.145"></a><span id="l8.145">  * Invoke a callback on the toolbox to notify it that the dialog is done</span>
<a href="#l8.146"></a><span id="l8.146">  * and going away.</span>
<a href="#l8.147"></a><span id="l8.147">  */</span>
<a href="#l8.148"></a><span id="l8.148"> function notifyParentComplete() {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-  if (&quot;customizeDone&quot; in gToolbox)</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  if (&quot;customizeDone&quot; in gToolbox) {</span>
<a href="#l8.151"></a><span id="l8.151">     gToolbox.customizeDone(gToolboxChanged);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+  }</span>
<a href="#l8.153"></a><span id="l8.153">   dispatchCustomizationEvent(&quot;aftercustomization&quot;);</span>
<a href="#l8.154"></a><span id="l8.154"> }</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156"> function toolboxChanged(aType) {</span>
<a href="#l8.157"></a><span id="l8.157">   gToolboxChanged = true;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-  if (&quot;customizeChange&quot; in gToolbox)</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  if (&quot;customizeChange&quot; in gToolbox) {</span>
<a href="#l8.160"></a><span id="l8.160">     gToolbox.customizeChange(aType);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  }</span>
<a href="#l8.162"></a><span id="l8.162">   dispatchCustomizationEvent(&quot;customizationchange&quot;);</span>
<a href="#l8.163"></a><span id="l8.163"> }</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165"> function dispatchCustomizationEvent(aEventName) {</span>
<a href="#l8.166"></a><span id="l8.166">   var evt = document.createEvent(&quot;Events&quot;);</span>
<a href="#l8.167"></a><span id="l8.167">   evt.initEvent(aEventName, true, true);</span>
<a href="#l8.168"></a><span id="l8.168">   gToolbox.dispatchEvent(evt);</span>
<a href="#l8.169"></a><span id="l8.169"> }</span>
<a href="#l8.170"></a><span id="l8.170"> </span>
<a href="#l8.171"></a><span id="l8.171"> /**</span>
<a href="#l8.172"></a><span id="l8.172">  * Persist the current set of buttons in all customizable toolbars to</span>
<a href="#l8.173"></a><span id="l8.173">  * localstore.</span>
<a href="#l8.174"></a><span id="l8.174">  */</span>
<a href="#l8.175"></a><span id="l8.175"> function persistCurrentSets() {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-  if (!gToolboxChanged || gToolboxDocument.defaultView.closed)</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+  if (!gToolboxChanged || gToolboxDocument.defaultView.closed) {</span>
<a href="#l8.178"></a><span id="l8.178">     return;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+  }</span>
<a href="#l8.180"></a><span id="l8.180"> </span>
<a href="#l8.181"></a><span id="l8.181">   forEachCustomizableToolbar(function(toolbar) {</span>
<a href="#l8.182"></a><span id="l8.182">     // Calculate currentset and store it in the attribute.</span>
<a href="#l8.183"></a><span id="l8.183">     var currentSet = toolbar.currentSet;</span>
<a href="#l8.184"></a><span id="l8.184">     toolbar.setAttribute(&quot;currentset&quot;, currentSet);</span>
<a href="#l8.185"></a><span id="l8.185">     Services.xulStore.persist(toolbar, &quot;currentset&quot;);</span>
<a href="#l8.186"></a><span id="l8.186">   });</span>
<a href="#l8.187"></a><span id="l8.187"> }</span>
<a href="#l8.188"></a><span id="l8.188"> </span>
<a href="#l8.189"></a><span id="l8.189"> /**</span>
<a href="#l8.190"></a><span id="l8.190">  * Wraps all items in all customizable toolbars in a toolbox.</span>
<a href="#l8.191"></a><span id="l8.191">  */</span>
<a href="#l8.192"></a><span id="l8.192"> function wrapToolbarItems() {</span>
<a href="#l8.193"></a><span id="l8.193">   forEachCustomizableToolbar(function(toolbar) {</span>
<a href="#l8.194"></a><span id="l8.194">     for (let item of toolbar.childNodes) {</span>
<a href="#l8.195"></a><span id="l8.195">       if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-        if (item.firstChild &amp;&amp; item.firstChild.localName == &quot;menubar&quot;)</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+        if (item.firstChild &amp;&amp; item.firstChild.localName == &quot;menubar&quot;) {</span>
<a href="#l8.198"></a><span id="l8.198">           return;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+        }</span>
<a href="#l8.200"></a><span id="l8.200">       }</span>
<a href="#l8.201"></a><span id="l8.201">       if (isToolbarItem(item)) {</span>
<a href="#l8.202"></a><span id="l8.202">         let wrapper = wrapToolbarItem(item);</span>
<a href="#l8.203"></a><span id="l8.203">         cleanupItemForToolbar(item, wrapper);</span>
<a href="#l8.204"></a><span id="l8.204">       }</span>
<a href="#l8.205"></a><span id="l8.205">     }</span>
<a href="#l8.206"></a><span id="l8.206">   });</span>
<a href="#l8.207"></a><span id="l8.207"> }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineat">@@ -258,31 +271,33 @@ function wrapToolbarItem(aToolbarItem) {</span>
<a href="#l8.209"></a><span id="l8.209"> /**</span>
<a href="#l8.210"></a><span id="l8.210">  * Get the list of ids for the current set of items on each toolbar.</span>
<a href="#l8.211"></a><span id="l8.211">  */</span>
<a href="#l8.212"></a><span id="l8.212"> function getCurrentItemIds() {</span>
<a href="#l8.213"></a><span id="l8.213">   var currentItems = {};</span>
<a href="#l8.214"></a><span id="l8.214">   forEachCustomizableToolbar(function(toolbar) {</span>
<a href="#l8.215"></a><span id="l8.215">     var child = toolbar.firstChild;</span>
<a href="#l8.216"></a><span id="l8.216">     while (child) {</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-      if (isToolbarItem(child))</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+      if (isToolbarItem(child)) {</span>
<a href="#l8.219"></a><span id="l8.219">         currentItems[child.id] = 1;</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+      }</span>
<a href="#l8.221"></a><span id="l8.221">       child = child.nextSibling;</span>
<a href="#l8.222"></a><span id="l8.222">     }</span>
<a href="#l8.223"></a><span id="l8.223">   });</span>
<a href="#l8.224"></a><span id="l8.224">   return currentItems;</span>
<a href="#l8.225"></a><span id="l8.225"> }</span>
<a href="#l8.226"></a><span id="l8.226"> </span>
<a href="#l8.227"></a><span id="l8.227"> /**</span>
<a href="#l8.228"></a><span id="l8.228">  * Builds the palette of draggable items that are not yet in a toolbar.</span>
<a href="#l8.229"></a><span id="l8.229">  */</span>
<a href="#l8.230"></a><span id="l8.230"> function buildPalette() {</span>
<a href="#l8.231"></a><span id="l8.231">   // Empty the palette first.</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-  while (gPaletteBox.lastChild)</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  while (gPaletteBox.lastChild) {</span>
<a href="#l8.234"></a><span id="l8.234">     gPaletteBox.removeChild(gPaletteBox.lastChild);</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+  }</span>
<a href="#l8.236"></a><span id="l8.236"> </span>
<a href="#l8.237"></a><span id="l8.237">   // Add the toolbar separator item.</span>
<a href="#l8.238"></a><span id="l8.238">   var templateNode = document.createXULElement(&quot;toolbarseparator&quot;);</span>
<a href="#l8.239"></a><span id="l8.239">   templateNode.id = &quot;separator&quot;;</span>
<a href="#l8.240"></a><span id="l8.240">   wrapPaletteItem(templateNode);</span>
<a href="#l8.241"></a><span id="l8.241"> </span>
<a href="#l8.242"></a><span id="l8.242">   // Add the toolbar spring item.</span>
<a href="#l8.243"></a><span id="l8.243">   templateNode = document.createXULElement(&quot;toolbarspring&quot;);</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineat">@@ -366,30 +381,33 @@ function cleanupItemForToolbar(aItem, aW</span>
<a href="#l8.245"></a><span id="l8.245">     aItem.disabled = false;</span>
<a href="#l8.246"></a><span id="l8.246">   }</span>
<a href="#l8.247"></a><span id="l8.247"> }</span>
<a href="#l8.248"></a><span id="l8.248"> </span>
<a href="#l8.249"></a><span id="l8.249"> /**</span>
<a href="#l8.250"></a><span id="l8.250">  * Restore all the properties that we stripped off above.</span>
<a href="#l8.251"></a><span id="l8.251">  */</span>
<a href="#l8.252"></a><span id="l8.252"> function restoreItemForToolbar(aItem, aWrapper) {</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-  if (aWrapper.hasAttribute(&quot;itemdisabled&quot;))</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+  if (aWrapper.hasAttribute(&quot;itemdisabled&quot;)) {</span>
<a href="#l8.255"></a><span id="l8.255">     aItem.disabled = true;</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+  }</span>
<a href="#l8.257"></a><span id="l8.257"> </span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-  if (aWrapper.hasAttribute(&quot;itemchecked&quot;))</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+  if (aWrapper.hasAttribute(&quot;itemchecked&quot;)) {</span>
<a href="#l8.260"></a><span id="l8.260">     aItem.checked = true;</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+  }</span>
<a href="#l8.262"></a><span id="l8.262"> </span>
<a href="#l8.263"></a><span id="l8.263">   if (aWrapper.hasAttribute(&quot;itemcommand&quot;)) {</span>
<a href="#l8.264"></a><span id="l8.264">     let commandID = aWrapper.getAttribute(&quot;itemcommand&quot;);</span>
<a href="#l8.265"></a><span id="l8.265">     aItem.setAttribute(&quot;command&quot;, commandID);</span>
<a href="#l8.266"></a><span id="l8.266"> </span>
<a href="#l8.267"></a><span id="l8.267">     // XXX Bug 309953 - toolbarbuttons aren't in sync with their commands after customizing</span>
<a href="#l8.268"></a><span id="l8.268">     let command = gToolboxDocument.getElementById(commandID);</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-    if (command &amp;&amp; command.hasAttribute(&quot;disabled&quot;))</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+    if (command &amp;&amp; command.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l8.271"></a><span id="l8.271">       aItem.setAttribute(&quot;disabled&quot;, command.getAttribute(&quot;disabled&quot;));</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    }</span>
<a href="#l8.273"></a><span id="l8.273">   }</span>
<a href="#l8.274"></a><span id="l8.274"> }</span>
<a href="#l8.275"></a><span id="l8.275"> </span>
<a href="#l8.276"></a><span id="l8.276"> function setWrapperType(aItem, aWrapper) {</span>
<a href="#l8.277"></a><span id="l8.277">   if (aItem.localName == &quot;toolbarseparator&quot;) {</span>
<a href="#l8.278"></a><span id="l8.278">     aWrapper.setAttribute(&quot;type&quot;, &quot;separator&quot;);</span>
<a href="#l8.279"></a><span id="l8.279">   } else if (aItem.localName == &quot;toolbarspring&quot;) {</span>
<a href="#l8.280"></a><span id="l8.280">     aWrapper.setAttribute(&quot;type&quot;, &quot;spring&quot;);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineat">@@ -404,22 +422,24 @@ function setDragActive(aItem, aValue) {</span>
<a href="#l8.282"></a><span id="l8.282">   var node = aItem;</span>
<a href="#l8.283"></a><span id="l8.283">   var direction = window.getComputedStyle(aItem).direction;</span>
<a href="#l8.284"></a><span id="l8.284">   var value = direction == &quot;ltr&quot; ? &quot;left&quot; : &quot;right&quot;;</span>
<a href="#l8.285"></a><span id="l8.285">   if (aItem.localName == &quot;toolbar&quot;) {</span>
<a href="#l8.286"></a><span id="l8.286">     node = aItem.lastChild;</span>
<a href="#l8.287"></a><span id="l8.287">     value = direction == &quot;ltr&quot; ? &quot;right&quot; : &quot;left&quot;;</span>
<a href="#l8.288"></a><span id="l8.288">   }</span>
<a href="#l8.289"></a><span id="l8.289"> </span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-  if (!node)</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+  if (!node) {</span>
<a href="#l8.292"></a><span id="l8.292">     return;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+  }</span>
<a href="#l8.294"></a><span id="l8.294"> </span>
<a href="#l8.295"></a><span id="l8.295">   if (aValue) {</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-    if (!node.hasAttribute(&quot;dragover&quot;))</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+    if (!node.hasAttribute(&quot;dragover&quot;)) {</span>
<a href="#l8.298"></a><span id="l8.298">       node.setAttribute(&quot;dragover&quot;, value);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+    }</span>
<a href="#l8.300"></a><span id="l8.300">   } else {</span>
<a href="#l8.301"></a><span id="l8.301">     node.removeAttribute(&quot;dragover&quot;);</span>
<a href="#l8.302"></a><span id="l8.302">   }</span>
<a href="#l8.303"></a><span id="l8.303"> }</span>
<a href="#l8.304"></a><span id="l8.304"> </span>
<a href="#l8.305"></a><span id="l8.305"> /**</span>
<a href="#l8.306"></a><span id="l8.306">  * Restore the default set of buttons to fixed toolbars,</span>
<a href="#l8.307"></a><span id="l8.307">  * remove all custom toolbars, and rebuild the palette.</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineat">@@ -439,22 +459,23 @@ function restoreDefaultSet() {</span>
<a href="#l8.309"></a><span id="l8.309">     } else {</span>
<a href="#l8.310"></a><span id="l8.310">       child = child.previousSibling;</span>
<a href="#l8.311"></a><span id="l8.311">     }</span>
<a href="#l8.312"></a><span id="l8.312">   }</span>
<a href="#l8.313"></a><span id="l8.313"> </span>
<a href="#l8.314"></a><span id="l8.314">   // Restore the defaultset for fixed toolbars.</span>
<a href="#l8.315"></a><span id="l8.315">   forEachCustomizableToolbar(function(toolbar) {</span>
<a href="#l8.316"></a><span id="l8.316">     var defaultSet = toolbar.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-    if (defaultSet)</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+    if (defaultSet) {</span>
<a href="#l8.319"></a><span id="l8.319">       toolbar.currentSet = defaultSet;</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+    }</span>
<a href="#l8.321"></a><span id="l8.321">   });</span>
<a href="#l8.322"></a><span id="l8.322"> </span>
<a href="#l8.323"></a><span id="l8.323">   // Restore the default icon size and mode.</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-  document.getElementById(&quot;smallicons&quot;).checked = (updateIconSize() == &quot;small&quot;);</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+  document.getElementById(&quot;smallicons&quot;).checked = updateIconSize() == &quot;small&quot;;</span>
<a href="#l8.326"></a><span id="l8.326">   document.getElementById(&quot;modelist&quot;).value = updateToolbarMode();</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328">   // Now rebuild the palette.</span>
<a href="#l8.329"></a><span id="l8.329">   buildPalette();</span>
<a href="#l8.330"></a><span id="l8.330"> </span>
<a href="#l8.331"></a><span id="l8.331">   // Now re-wrap the items on the toolbar.</span>
<a href="#l8.332"></a><span id="l8.332">   wrapToolbarItems();</span>
<a href="#l8.333"></a><span id="l8.333"> </span>
<a href="#l8.334"></a><span id="l8.334" class="difflineat">@@ -462,109 +483,130 @@ function restoreDefaultSet() {</span>
<a href="#l8.335"></a><span id="l8.335"> }</span>
<a href="#l8.336"></a><span id="l8.336"> </span>
<a href="#l8.337"></a><span id="l8.337"> function updateIconSize(aSize) {</span>
<a href="#l8.338"></a><span id="l8.338">   return updateToolboxProperty(&quot;iconsize&quot;, aSize, &quot;large&quot;);</span>
<a href="#l8.339"></a><span id="l8.339"> }</span>
<a href="#l8.340"></a><span id="l8.340"> </span>
<a href="#l8.341"></a><span id="l8.341"> function updateTitlebar() {</span>
<a href="#l8.342"></a><span id="l8.342">   let titlebarCheckbox = document.getElementById(&quot;showTitlebar&quot;);</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.tabs.drawInTitlebar&quot;, !titlebarCheckbox.checked);</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+  Services.prefs.setBoolPref(</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+    &quot;mail.tabs.drawInTitlebar&quot;,</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+    !titlebarCheckbox.checked</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+  );</span>
<a href="#l8.348"></a><span id="l8.348"> </span>
<a href="#l8.349"></a><span id="l8.349">   // Bring the customizeToolbar window to front (on linux it's behind the main</span>
<a href="#l8.350"></a><span id="l8.350">   // window). Otherwise the customization window gets left in the background.</span>
<a href="#l8.351"></a><span id="l8.351">   setTimeout(() =&gt; window.focus(), 100);</span>
<a href="#l8.352"></a><span id="l8.352"> }</span>
<a href="#l8.353"></a><span id="l8.353"> </span>
<a href="#l8.354"></a><span id="l8.354"> function updateDragSpace() {</span>
<a href="#l8.355"></a><span id="l8.355">   let dragSpaceCheckbox = document.getElementById(&quot;showDragSpace&quot;);</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.tabs.extraDragSpace&quot;, dragSpaceCheckbox.checked);</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+  Services.prefs.setBoolPref(</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    &quot;mail.tabs.extraDragSpace&quot;,</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+    dragSpaceCheckbox.checked</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+  );</span>
<a href="#l8.361"></a><span id="l8.361"> </span>
<a href="#l8.362"></a><span id="l8.362">   // Bring the customizeToolbar window to front (on linux it's behind the main</span>
<a href="#l8.363"></a><span id="l8.363">   // window). Otherwise the customization window gets left in the background.</span>
<a href="#l8.364"></a><span id="l8.364">   setTimeout(() =&gt; window.focus(), 100);</span>
<a href="#l8.365"></a><span id="l8.365"> }</span>
<a href="#l8.366"></a><span id="l8.366"> </span>
<a href="#l8.367"></a><span id="l8.367"> function updateToolbarMode(aModeValue) {</span>
<a href="#l8.368"></a><span id="l8.368">   var mode = updateToolboxProperty(&quot;mode&quot;, aModeValue, &quot;icons&quot;);</span>
<a href="#l8.369"></a><span id="l8.369"> </span>
<a href="#l8.370"></a><span id="l8.370">   var iconSizeCheckbox = document.getElementById(&quot;smallicons&quot;);</span>
<a href="#l8.371"></a><span id="l8.371">   iconSizeCheckbox.disabled = mode == &quot;text&quot;;</span>
<a href="#l8.372"></a><span id="l8.372"> </span>
<a href="#l8.373"></a><span id="l8.373">   return mode;</span>
<a href="#l8.374"></a><span id="l8.374"> }</span>
<a href="#l8.375"></a><span id="l8.375"> </span>
<a href="#l8.376"></a><span id="l8.376"> function updateToolboxProperty(aProp, aValue, aToolkitDefault) {</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-  var toolboxDefault = gToolbox.getAttribute(&quot;default&quot; + aProp) ||</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-                       aToolkitDefault;</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+  var toolboxDefault =</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    gToolbox.getAttribute(&quot;default&quot; + aProp) || aToolkitDefault;</span>
<a href="#l8.381"></a><span id="l8.381"> </span>
<a href="#l8.382"></a><span id="l8.382">   gToolbox.setAttribute(aProp, aValue || toolboxDefault);</span>
<a href="#l8.383"></a><span id="l8.383">   Services.xulStore.persist(gToolbox, aProp);</span>
<a href="#l8.384"></a><span id="l8.384"> </span>
<a href="#l8.385"></a><span id="l8.385">   forEachCustomizableToolbar(function(toolbar) {</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-    var toolbarDefault = toolbar.getAttribute(&quot;default&quot; + aProp) ||</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-                         toolboxDefault;</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-    if (toolbar.getAttribute(&quot;lock&quot; + aProp) == &quot;true&quot; &amp;&amp;</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-        toolbar.getAttribute(aProp) == toolbarDefault)</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+    var toolbarDefault =</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+      toolbar.getAttribute(&quot;default&quot; + aProp) || toolboxDefault;</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+    if (</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+      toolbar.getAttribute(&quot;lock&quot; + aProp) == &quot;true&quot; &amp;&amp;</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+      toolbar.getAttribute(aProp) == toolbarDefault</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+    ) {</span>
<a href="#l8.396"></a><span id="l8.396">       return;</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+    }</span>
<a href="#l8.398"></a><span id="l8.398"> </span>
<a href="#l8.399"></a><span id="l8.399">     toolbar.setAttribute(aProp, aValue || toolbarDefault);</span>
<a href="#l8.400"></a><span id="l8.400">     Services.xulStore.persist(toolbar, aProp);</span>
<a href="#l8.401"></a><span id="l8.401">   });</span>
<a href="#l8.402"></a><span id="l8.402"> </span>
<a href="#l8.403"></a><span id="l8.403">   toolboxChanged(aProp);</span>
<a href="#l8.404"></a><span id="l8.404"> </span>
<a href="#l8.405"></a><span id="l8.405">   return aValue || toolboxDefault;</span>
<a href="#l8.406"></a><span id="l8.406"> }</span>
<a href="#l8.407"></a><span id="l8.407"> </span>
<a href="#l8.408"></a><span id="l8.408"> function forEachCustomizableToolbar(callback) {</span>
<a href="#l8.409"></a><span id="l8.409">   if (window.frameElement &amp;&amp; &quot;externalToolbars&quot; in window.frameElement) {</span>
<a href="#l8.410"></a><span id="l8.410">     Array.from(window.frameElement.externalToolbars)</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-      .filter(isCustomizableToolbar).forEach(callback);</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+      .filter(isCustomizableToolbar)</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+      .forEach(callback);</span>
<a href="#l8.414"></a><span id="l8.414">   } else if (&quot;arguments&quot; in window &amp;&amp; window.arguments[1].length &gt; 0) {</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-    Array.from(window.arguments[1]).filter(isCustomizableToolbar).forEach(callback);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+    Array.from(window.arguments[1])</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+      .filter(isCustomizableToolbar)</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+      .forEach(callback);</span>
<a href="#l8.419"></a><span id="l8.419">   }</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-  Array.from(gToolbox.childNodes).filter(isCustomizableToolbar).forEach(callback);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+  Array.from(gToolbox.childNodes)</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+    .filter(isCustomizableToolbar)</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+    .forEach(callback);</span>
<a href="#l8.424"></a><span id="l8.424"> }</span>
<a href="#l8.425"></a><span id="l8.425"> </span>
<a href="#l8.426"></a><span id="l8.426"> function isCustomizableToolbar(aElt) {</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-  return aElt.localName == &quot;toolbar&quot; &amp;&amp;</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-         aElt.getAttribute(&quot;customizable&quot;) == &quot;true&quot;;</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+  return (</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+    aElt.localName == &quot;toolbar&quot; &amp;&amp; aElt.getAttribute(&quot;customizable&quot;) == &quot;true&quot;</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+  );</span>
<a href="#l8.432"></a><span id="l8.432"> }</span>
<a href="#l8.433"></a><span id="l8.433"> </span>
<a href="#l8.434"></a><span id="l8.434"> function isSpecialItem(aElt) {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-  return aElt.localName == &quot;toolbarseparator&quot; ||</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-         aElt.localName == &quot;toolbarspring&quot; ||</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-         aElt.localName == &quot;toolbarspacer&quot;;</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+  return (</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+    aElt.localName == &quot;toolbarseparator&quot; ||</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+    aElt.localName == &quot;toolbarspring&quot; ||</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+    aElt.localName == &quot;toolbarspacer&quot;</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+  );</span>
<a href="#l8.443"></a><span id="l8.443"> }</span>
<a href="#l8.444"></a><span id="l8.444"> </span>
<a href="#l8.445"></a><span id="l8.445"> function isToolbarItem(aElt) {</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-  return aElt.localName == &quot;toolbarbutton&quot; ||</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-         aElt.localName == &quot;toolbaritem&quot; ||</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-         aElt.localName == &quot;toolbarseparator&quot; ||</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-         aElt.localName == &quot;toolbarspring&quot; ||</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-         aElt.localName == &quot;toolbarspacer&quot;;</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+  return (</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+    aElt.localName == &quot;toolbarbutton&quot; ||</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+    aElt.localName == &quot;toolbaritem&quot; ||</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+    aElt.localName == &quot;toolbarseparator&quot; ||</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+    aElt.localName == &quot;toolbarspring&quot; ||</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+    aElt.localName == &quot;toolbarspacer&quot;</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+  );</span>
<a href="#l8.458"></a><span id="l8.458"> }</span>
<a href="#l8.459"></a><span id="l8.459"> </span>
<a href="#l8.460"></a><span id="l8.460"> // Drag and Drop observers</span>
<a href="#l8.461"></a><span id="l8.461"> </span>
<a href="#l8.462"></a><span id="l8.462"> function onToolbarDragExit(aEvent) {</span>
<a href="#l8.463"></a><span id="l8.463">   if (isUnwantedDragEvent(aEvent)) {</span>
<a href="#l8.464"></a><span id="l8.464">     return;</span>
<a href="#l8.465"></a><span id="l8.465">   }</span>
<a href="#l8.466"></a><span id="l8.466"> </span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-  if (gCurrentDragOverItem)</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+  if (gCurrentDragOverItem) {</span>
<a href="#l8.469"></a><span id="l8.469">     setDragActive(gCurrentDragOverItem, false);</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+  }</span>
<a href="#l8.471"></a><span id="l8.471"> }</span>
<a href="#l8.472"></a><span id="l8.472"> </span>
<a href="#l8.473"></a><span id="l8.473"> function onToolbarDragStart(aEvent) {</span>
<a href="#l8.474"></a><span id="l8.474">   var item = aEvent.target;</span>
<a href="#l8.475"></a><span id="l8.475">   while (item &amp;&amp; item.localName != &quot;toolbarpaletteitem&quot;) {</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-    if (item.localName == &quot;toolbar&quot;)</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+    if (item.localName == &quot;toolbar&quot;) {</span>
<a href="#l8.478"></a><span id="l8.478">       return;</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+    }</span>
<a href="#l8.480"></a><span id="l8.480">     item = item.parentNode;</span>
<a href="#l8.481"></a><span id="l8.481">   }</span>
<a href="#l8.482"></a><span id="l8.482"> </span>
<a href="#l8.483"></a><span id="l8.483">   item.setAttribute(&quot;dragactive&quot;, &quot;true&quot;);</span>
<a href="#l8.484"></a><span id="l8.484"> </span>
<a href="#l8.485"></a><span id="l8.485">   var dt = aEvent.dataTransfer;</span>
<a href="#l8.486"></a><span id="l8.486">   var documentId = gToolboxDocument.documentElement.id;</span>
<a href="#l8.487"></a><span id="l8.487">   dt.setData(&quot;text/toolbarwrapper-id/&quot; + documentId, item.firstChild.id);</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineat">@@ -572,18 +614,23 @@ function onToolbarDragStart(aEvent) {</span>
<a href="#l8.489"></a><span id="l8.489"> }</span>
<a href="#l8.490"></a><span id="l8.490"> </span>
<a href="#l8.491"></a><span id="l8.491"> function onToolbarDragOver(aEvent) {</span>
<a href="#l8.492"></a><span id="l8.492">   if (isUnwantedDragEvent(aEvent)) {</span>
<a href="#l8.493"></a><span id="l8.493">     return;</span>
<a href="#l8.494"></a><span id="l8.494">   }</span>
<a href="#l8.495"></a><span id="l8.495"> </span>
<a href="#l8.496"></a><span id="l8.496">   var documentId = gToolboxDocument.documentElement.id;</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-  if (!aEvent.dataTransfer.types.includes(&quot;text/toolbarwrapper-id/&quot; + documentId.toLowerCase()))</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+  if (</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+    !aEvent.dataTransfer.types.includes(</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+      &quot;text/toolbarwrapper-id/&quot; + documentId.toLowerCase()</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+    )</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+  ) {</span>
<a href="#l8.503"></a><span id="l8.503">     return;</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+  }</span>
<a href="#l8.505"></a><span id="l8.505"> </span>
<a href="#l8.506"></a><span id="l8.506">   var toolbar = aEvent.target;</span>
<a href="#l8.507"></a><span id="l8.507">   var dropTarget = aEvent.target;</span>
<a href="#l8.508"></a><span id="l8.508">   while (toolbar &amp;&amp; toolbar.localName != &quot;toolbar&quot;) {</span>
<a href="#l8.509"></a><span id="l8.509">     dropTarget = toolbar;</span>
<a href="#l8.510"></a><span id="l8.510">     toolbar = toolbar.parentNode;</span>
<a href="#l8.511"></a><span id="l8.511">   }</span>
<a href="#l8.512"></a><span id="l8.512"> </span>
<a href="#l8.513"></a><span id="l8.513" class="difflineat">@@ -597,27 +644,29 @@ function onToolbarDragOver(aEvent) {</span>
<a href="#l8.514"></a><span id="l8.514"> </span>
<a href="#l8.515"></a><span id="l8.515">   if (dropTarget.localName == &quot;toolbar&quot;) {</span>
<a href="#l8.516"></a><span id="l8.516">     gCurrentDragOverItem = dropTarget;</span>
<a href="#l8.517"></a><span id="l8.517">   } else {</span>
<a href="#l8.518"></a><span id="l8.518">     gCurrentDragOverItem = null;</span>
<a href="#l8.519"></a><span id="l8.519"> </span>
<a href="#l8.520"></a><span id="l8.520">     var direction = window.getComputedStyle(dropTarget.parentNode).direction;</span>
<a href="#l8.521"></a><span id="l8.521">     var boundingRect = dropTarget.getBoundingClientRect();</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-    var dropTargetCenter = boundingRect.x + (boundingRect.width / 2);</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+    var dropTargetCenter = boundingRect.x + boundingRect.width / 2;</span>
<a href="#l8.524"></a><span id="l8.524">     var dragAfter;</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-    if (direction == &quot;ltr&quot;)</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+    if (direction == &quot;ltr&quot;) {</span>
<a href="#l8.527"></a><span id="l8.527">       dragAfter = aEvent.clientX &gt; dropTargetCenter;</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-    else</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+    } else {</span>
<a href="#l8.530"></a><span id="l8.530">       dragAfter = aEvent.clientX &lt; dropTargetCenter;</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+    }</span>
<a href="#l8.532"></a><span id="l8.532"> </span>
<a href="#l8.533"></a><span id="l8.533">     if (dragAfter) {</span>
<a href="#l8.534"></a><span id="l8.534">       gCurrentDragOverItem = dropTarget.nextSibling;</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-      if (!gCurrentDragOverItem)</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+      if (!gCurrentDragOverItem) {</span>
<a href="#l8.537"></a><span id="l8.537">         gCurrentDragOverItem = toolbar;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+      }</span>
<a href="#l8.539"></a><span id="l8.539">     } else {</span>
<a href="#l8.540"></a><span id="l8.540">       gCurrentDragOverItem = dropTarget;</span>
<a href="#l8.541"></a><span id="l8.541">     }</span>
<a href="#l8.542"></a><span id="l8.542">   }</span>
<a href="#l8.543"></a><span id="l8.543"> </span>
<a href="#l8.544"></a><span id="l8.544">   if (previousDragItem &amp;&amp; gCurrentDragOverItem != previousDragItem) {</span>
<a href="#l8.545"></a><span id="l8.545">     setDragActive(previousDragItem, false);</span>
<a href="#l8.546"></a><span id="l8.546">   }</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineat">@@ -628,134 +677,162 @@ function onToolbarDragOver(aEvent) {</span>
<a href="#l8.548"></a><span id="l8.548">   aEvent.stopPropagation();</span>
<a href="#l8.549"></a><span id="l8.549"> }</span>
<a href="#l8.550"></a><span id="l8.550"> </span>
<a href="#l8.551"></a><span id="l8.551"> function onToolbarDrop(aEvent) {</span>
<a href="#l8.552"></a><span id="l8.552">   if (isUnwantedDragEvent(aEvent)) {</span>
<a href="#l8.553"></a><span id="l8.553">     return;</span>
<a href="#l8.554"></a><span id="l8.554">   }</span>
<a href="#l8.555"></a><span id="l8.555"> </span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-  if (!gCurrentDragOverItem)</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+  if (!gCurrentDragOverItem) {</span>
<a href="#l8.558"></a><span id="l8.558">     return;</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+  }</span>
<a href="#l8.560"></a><span id="l8.560"> </span>
<a href="#l8.561"></a><span id="l8.561">   setDragActive(gCurrentDragOverItem, false);</span>
<a href="#l8.562"></a><span id="l8.562"> </span>
<a href="#l8.563"></a><span id="l8.563">   var documentId = gToolboxDocument.documentElement.id;</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-  var draggedItemId = aEvent.dataTransfer.getData(&quot;text/toolbarwrapper-id/&quot; + documentId);</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-  if (gCurrentDragOverItem.id == draggedItemId)</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+  var draggedItemId = aEvent.dataTransfer.getData(</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+    &quot;text/toolbarwrapper-id/&quot; + documentId</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+  );</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+  if (gCurrentDragOverItem.id == draggedItemId) {</span>
<a href="#l8.570"></a><span id="l8.570">     return;</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+  }</span>
<a href="#l8.572"></a><span id="l8.572"> </span>
<a href="#l8.573"></a><span id="l8.573">   var toolbar = aEvent.target;</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-  while (toolbar.localName != &quot;toolbar&quot;)</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+  while (toolbar.localName != &quot;toolbar&quot;) {</span>
<a href="#l8.576"></a><span id="l8.576">     toolbar = toolbar.parentNode;</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+  }</span>
<a href="#l8.578"></a><span id="l8.578"> </span>
<a href="#l8.579"></a><span id="l8.579" class="difflineminus">-  var draggedPaletteWrapper = document.getElementById(&quot;wrapper-&quot; + draggedItemId);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+  var draggedPaletteWrapper = document.getElementById(</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+    &quot;wrapper-&quot; + draggedItemId</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+  );</span>
<a href="#l8.583"></a><span id="l8.583">   if (!draggedPaletteWrapper) {</span>
<a href="#l8.584"></a><span id="l8.584">     // The wrapper has been dragged from the toolbar.</span>
<a href="#l8.585"></a><span id="l8.585">     // Get the wrapper from the toolbar document and make sure that</span>
<a href="#l8.586"></a><span id="l8.586">     // it isn't being dropped on itself.</span>
<a href="#l8.587"></a><span id="l8.587">     let wrapper = gToolboxDocument.getElementById(&quot;wrapper-&quot; + draggedItemId);</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-    if (wrapper == gCurrentDragOverItem)</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-       return;</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+    if (wrapper == gCurrentDragOverItem) {</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+      return;</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+    }</span>
<a href="#l8.593"></a><span id="l8.593"> </span>
<a href="#l8.594"></a><span id="l8.594">     // Don't allow non-removable kids (e.g., the menubar) to move.</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineminus">-    if (wrapper.firstChild.getAttribute(&quot;removable&quot;) != &quot;true&quot;)</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+    if (wrapper.firstChild.getAttribute(&quot;removable&quot;) != &quot;true&quot;) {</span>
<a href="#l8.597"></a><span id="l8.597">       return;</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+    }</span>
<a href="#l8.599"></a><span id="l8.599"> </span>
<a href="#l8.600"></a><span id="l8.600">     // Remove the item from its place in the toolbar.</span>
<a href="#l8.601"></a><span id="l8.601">     wrapper.remove();</span>
<a href="#l8.602"></a><span id="l8.602"> </span>
<a href="#l8.603"></a><span id="l8.603">     // Determine which toolbar we are dropping on.</span>
<a href="#l8.604"></a><span id="l8.604">     var dropToolbar = null;</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-    if (gCurrentDragOverItem.localName == &quot;toolbar&quot;)</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+    if (gCurrentDragOverItem.localName == &quot;toolbar&quot;) {</span>
<a href="#l8.607"></a><span id="l8.607">       dropToolbar = gCurrentDragOverItem;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-    else</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+    } else {</span>
<a href="#l8.610"></a><span id="l8.610">       dropToolbar = gCurrentDragOverItem.parentNode;</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+    }</span>
<a href="#l8.612"></a><span id="l8.612"> </span>
<a href="#l8.613"></a><span id="l8.613">     // Insert the item into the toolbar.</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-    if (gCurrentDragOverItem != dropToolbar)</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+    if (gCurrentDragOverItem != dropToolbar) {</span>
<a href="#l8.616"></a><span id="l8.616">       dropToolbar.insertBefore(wrapper, gCurrentDragOverItem);</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-    else</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+    } else {</span>
<a href="#l8.619"></a><span id="l8.619">       dropToolbar.appendChild(wrapper);</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+    }</span>
<a href="#l8.621"></a><span id="l8.621">   } else {</span>
<a href="#l8.622"></a><span id="l8.622">     // The item has been dragged from the palette</span>
<a href="#l8.623"></a><span id="l8.623"> </span>
<a href="#l8.624"></a><span id="l8.624">     // Create a new wrapper for the item. We don't know the id yet.</span>
<a href="#l8.625"></a><span id="l8.625">     let wrapper = createWrapper(&quot;&quot;, gToolboxDocument);</span>
<a href="#l8.626"></a><span id="l8.626"> </span>
<a href="#l8.627"></a><span id="l8.627">     // Ask the toolbar to clone the item's template, place it inside the wrapper, and insert it in the toolbar.</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-    var newItem = toolbar.insertItem(draggedItemId, gCurrentDragOverItem == toolbar ? null : gCurrentDragOverItem, wrapper);</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+    var newItem = toolbar.insertItem(</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+      draggedItemId,</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+      gCurrentDragOverItem == toolbar ? null : gCurrentDragOverItem,</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+      wrapper</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+    );</span>
<a href="#l8.634"></a><span id="l8.634"> </span>
<a href="#l8.635"></a><span id="l8.635">     // Prepare the item and wrapper to look good on the toolbar.</span>
<a href="#l8.636"></a><span id="l8.636">     cleanupItemForToolbar(newItem, wrapper);</span>
<a href="#l8.637"></a><span id="l8.637">     wrapper.id = &quot;wrapper-&quot; + newItem.id;</span>
<a href="#l8.638"></a><span id="l8.638">     wrapper.flex = newItem.flex;</span>
<a href="#l8.639"></a><span id="l8.639"> </span>
<a href="#l8.640"></a><span id="l8.640">     // Remove the wrapper from the palette.</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-    if (draggedItemId != &quot;separator&quot; &amp;&amp;</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-        draggedItemId != &quot;spring&quot; &amp;&amp;</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-        draggedItemId != &quot;spacer&quot;)</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+    if (</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+      draggedItemId != &quot;separator&quot; &amp;&amp;</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+      draggedItemId != &quot;spring&quot; &amp;&amp;</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+      draggedItemId != &quot;spacer&quot;</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+    ) {</span>
<a href="#l8.649"></a><span id="l8.649">       gPaletteBox.removeChild(draggedPaletteWrapper);</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+    }</span>
<a href="#l8.651"></a><span id="l8.651">   }</span>
<a href="#l8.652"></a><span id="l8.652"> </span>
<a href="#l8.653"></a><span id="l8.653">   gCurrentDragOverItem = null;</span>
<a href="#l8.654"></a><span id="l8.654"> </span>
<a href="#l8.655"></a><span id="l8.655">   toolboxChanged();</span>
<a href="#l8.656"></a><span id="l8.656"> }</span>
<a href="#l8.657"></a><span id="l8.657"> </span>
<a href="#l8.658"></a><span id="l8.658"> function onPaletteDragOver(aEvent) {</span>
<a href="#l8.659"></a><span id="l8.659">   if (isUnwantedDragEvent(aEvent)) {</span>
<a href="#l8.660"></a><span id="l8.660">     return;</span>
<a href="#l8.661"></a><span id="l8.661">   }</span>
<a href="#l8.662"></a><span id="l8.662">   var documentId = gToolboxDocument.documentElement.id;</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-  if (aEvent.dataTransfer.types.includes(&quot;text/toolbarwrapper-id/&quot; + documentId.toLowerCase()))</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+  if (</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+    aEvent.dataTransfer.types.includes(</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+      &quot;text/toolbarwrapper-id/&quot; + documentId.toLowerCase()</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+    )</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+  ) {</span>
<a href="#l8.669"></a><span id="l8.669">     aEvent.preventDefault();</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+  }</span>
<a href="#l8.671"></a><span id="l8.671"> }</span>
<a href="#l8.672"></a><span id="l8.672"> </span>
<a href="#l8.673"></a><span id="l8.673"> function onPaletteDrop(aEvent) {</span>
<a href="#l8.674"></a><span id="l8.674">   if (isUnwantedDragEvent(aEvent)) {</span>
<a href="#l8.675"></a><span id="l8.675">     return;</span>
<a href="#l8.676"></a><span id="l8.676">   }</span>
<a href="#l8.677"></a><span id="l8.677">   var documentId = gToolboxDocument.documentElement.id;</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-  var itemId = aEvent.dataTransfer.getData(&quot;text/toolbarwrapper-id/&quot; + documentId);</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+  var itemId = aEvent.dataTransfer.getData(</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+    &quot;text/toolbarwrapper-id/&quot; + documentId</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+  );</span>
<a href="#l8.682"></a><span id="l8.682"> </span>
<a href="#l8.683"></a><span id="l8.683">   var wrapper = gToolboxDocument.getElementById(&quot;wrapper-&quot; + itemId);</span>
<a href="#l8.684"></a><span id="l8.684">   if (wrapper) {</span>
<a href="#l8.685"></a><span id="l8.685">     // Don't allow non-removable kids (e.g., the menubar) to move.</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-    if (wrapper.firstChild.getAttribute(&quot;removable&quot;) != &quot;true&quot;)</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+    if (wrapper.firstChild.getAttribute(&quot;removable&quot;) != &quot;true&quot;) {</span>
<a href="#l8.688"></a><span id="l8.688">       return;</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+    }</span>
<a href="#l8.690"></a><span id="l8.690"> </span>
<a href="#l8.691"></a><span id="l8.691">     var wrapperType = wrapper.getAttribute(&quot;type&quot;);</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-    if (wrapperType != &quot;separator&quot; &amp;&amp;</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-        wrapperType != &quot;spacer&quot; &amp;&amp;</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-        wrapperType != &quot;spring&quot;) {</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+    if (</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+      wrapperType != &quot;separator&quot; &amp;&amp;</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+      wrapperType != &quot;spacer&quot; &amp;&amp;</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+      wrapperType != &quot;spring&quot;</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+    ) {</span>
<a href="#l8.700"></a><span id="l8.700">       restoreItemForToolbar(wrapper.firstChild, wrapper);</span>
<a href="#l8.701"></a><span id="l8.701">       wrapPaletteItem(document.importNode(wrapper.firstChild, true));</span>
<a href="#l8.702"></a><span id="l8.702">       gToolbox.palette.appendChild(wrapper.firstChild);</span>
<a href="#l8.703"></a><span id="l8.703">     }</span>
<a href="#l8.704"></a><span id="l8.704"> </span>
<a href="#l8.705"></a><span id="l8.705">     // The item was dragged out of the toolbar.</span>
<a href="#l8.706"></a><span id="l8.706">     wrapper.remove();</span>
<a href="#l8.707"></a><span id="l8.707">   }</span>
<a href="#l8.708"></a><span id="l8.708"> </span>
<a href="#l8.709"></a><span id="l8.709">   toolboxChanged();</span>
<a href="#l8.710"></a><span id="l8.710"> }</span>
<a href="#l8.711"></a><span id="l8.711"> </span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-</span>
<a href="#l8.713"></a><span id="l8.713"> function isUnwantedDragEvent(aEvent) {</span>
<a href="#l8.714"></a><span id="l8.714">   try {</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;toolkit.customization.unsafe_drag_events&quot;)) {</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+    if (</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+      Services.prefs.getBoolPref(&quot;toolkit.customization.unsafe_drag_events&quot;)</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+    ) {</span>
<a href="#l8.719"></a><span id="l8.719">       return false;</span>
<a href="#l8.720"></a><span id="l8.720">     }</span>
<a href="#l8.721"></a><span id="l8.721">   } catch (ex) {}</span>
<a href="#l8.722"></a><span id="l8.722"> </span>
<a href="#l8.723"></a><span id="l8.723">   /* Discard drag events that originated from a separate window to</span>
<a href="#l8.724"></a><span id="l8.724">      prevent content-&gt;chrome privilege escalations. */</span>
<a href="#l8.725"></a><span id="l8.725">   let mozSourceNode = aEvent.dataTransfer.mozSourceNode;</span>
<a href="#l8.726"></a><span id="l8.726">   // mozSourceNode is null in the dragStart event handler or if</span>
<a href="#l8.727"></a><span id="l8.727">   // the drag event originated in an external application.</span>
<a href="#l8.728"></a><span id="l8.728">   if (!mozSourceNode) {</span>
<a href="#l8.729"></a><span id="l8.729">     return true;</span>
<a href="#l8.730"></a><span id="l8.730">   }</span>
<a href="#l8.731"></a><span id="l8.731">   let sourceWindow = mozSourceNode.ownerGlobal;</span>
<a href="#l8.732"></a><span id="l8.732">   return sourceWindow != window &amp;&amp; sourceWindow != gToolboxDocument.defaultView;</span>
<a href="#l8.733"></a><span id="l8.733"> }</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/common/src/viewSource.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/common/src/viewSource.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,38 +1,47 @@</span>
<a href="#l9.4"></a><span id="l9.4"> // -*- indent-tabs-mode: nil; js-indent-level: 2 -*-</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> /* globals internalSave, goDoCommand */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-var {ViewSourceBrowser} = ChromeUtils.import(&quot;resource://gre/modules/ViewSourceBrowser.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+var { ViewSourceBrowser } = ChromeUtils.import(</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  &quot;resource://gre/modules/ViewSourceBrowser.jsm&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-var {CharsetMenu} = ChromeUtils.import(&quot;resource://gre/modules/CharsetMenu.jsm&quot;);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-var {Deprecated} = ChromeUtils.import(&quot;resource://gre/modules/Deprecated.jsm&quot;);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+var { CharsetMenu } = ChromeUtils.import(</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  &quot;resource://gre/modules/CharsetMenu.jsm&quot;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+var { Deprecated } = ChromeUtils.import(</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  &quot;resource://gre/modules/Deprecated.jsm&quot;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+);</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32"> /* global gBrowser, gViewSourceBundle, gContextMenu */</span>
<a href="#l9.33"></a><span id="l9.33"> [</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  [&quot;gBrowser&quot;,          &quot;content&quot;],</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  [&quot;gBrowser&quot;, &quot;content&quot;],</span>
<a href="#l9.36"></a><span id="l9.36">   [&quot;gViewSourceBundle&quot;, &quot;viewSourceBundle&quot;],</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  [&quot;gContextMenu&quot;,      &quot;viewSourceContextMenu&quot;],</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  [&quot;gContextMenu&quot;, &quot;viewSourceContextMenu&quot;],</span>
<a href="#l9.39"></a><span id="l9.39"> ].forEach(function([name, id]) {</span>
<a href="#l9.40"></a><span id="l9.40">   Object.defineProperty(window, name, {</span>
<a href="#l9.41"></a><span id="l9.41">     configurable: true,</span>
<a href="#l9.42"></a><span id="l9.42">     enumerable: true,</span>
<a href="#l9.43"></a><span id="l9.43">     get() {</span>
<a href="#l9.44"></a><span id="l9.44">       var element = document.getElementById(id);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-      if (!element)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+      if (!element) {</span>
<a href="#l9.47"></a><span id="l9.47">         return null;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+      }</span>
<a href="#l9.49"></a><span id="l9.49">       delete window[name];</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-      return window[name] = element;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+      return (window[name] = element);</span>
<a href="#l9.52"></a><span id="l9.52">     },</span>
<a href="#l9.53"></a><span id="l9.53">   });</span>
<a href="#l9.54"></a><span id="l9.54"> });</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56"> /**</span>
<a href="#l9.57"></a><span id="l9.57">  * ViewSourceChrome is the primary interface for interacting with</span>
<a href="#l9.58"></a><span id="l9.58">  * the view source browser from a self-contained window.  It extends</span>
<a href="#l9.59"></a><span id="l9.59">  * ViewSourceBrowser with additional things needed inside the special window.</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineat">@@ -76,21 +85,25 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.61"></a><span id="l9.61">   ]),</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63">   /**</span>
<a href="#l9.64"></a><span id="l9.64">    * This called via ViewSourceBrowser's constructor.  This should be called as</span>
<a href="#l9.65"></a><span id="l9.65">    * soon as the script loads.  When this function executes, we can assume the</span>
<a href="#l9.66"></a><span id="l9.66">    * DOM content has not yet loaded.</span>
<a href="#l9.67"></a><span id="l9.67">    */</span>
<a href="#l9.68"></a><span id="l9.68">   init() {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    this.mm.loadFrameScript(&quot;chrome://global/content/viewSource-content.js&quot;, true);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    this.mm.loadFrameScript(</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+      &quot;chrome://global/content/viewSource-content.js&quot;,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+      true</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+    );</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">     this.shouldWrap = Services.prefs.getBoolPref(&quot;view_source.wrap_long_lines&quot;);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-    this.shouldHighlight =</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-      Services.prefs.getBoolPref(&quot;view_source.syntax_highlight&quot;);</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+    this.shouldHighlight = Services.prefs.getBoolPref(</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+      &quot;view_source.syntax_highlight&quot;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+    );</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82">     addEventListener(&quot;load&quot;, this);</span>
<a href="#l9.83"></a><span id="l9.83">     addEventListener(&quot;unload&quot;, this);</span>
<a href="#l9.84"></a><span id="l9.84">     addEventListener(&quot;AppCommand&quot;, this, true);</span>
<a href="#l9.85"></a><span id="l9.85">     addEventListener(&quot;MozSwipeGesture&quot;, this, true);</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87">     ViewSourceBrowser.prototype.init.call(this);</span>
<a href="#l9.88"></a><span id="l9.88">   },</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineat">@@ -104,18 +117,22 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91">     // &quot;load&quot; event listener is removed in its handler, to</span>
<a href="#l9.92"></a><span id="l9.92">     // ensure we only fire it once.</span>
<a href="#l9.93"></a><span id="l9.93">     removeEventListener(&quot;unload&quot;, this);</span>
<a href="#l9.94"></a><span id="l9.94">     removeEventListener(&quot;AppCommand&quot;, this, true);</span>
<a href="#l9.95"></a><span id="l9.95">     removeEventListener(&quot;MozSwipeGesture&quot;, this, true);</span>
<a href="#l9.96"></a><span id="l9.96">     gContextMenu.removeEventListener(&quot;popupshowing&quot;, this);</span>
<a href="#l9.97"></a><span id="l9.97">     gContextMenu.removeEventListener(&quot;popuphidden&quot;, this);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    Services.els.removeSystemEventListener(this.browser, &quot;dragover&quot;, this,</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-                                           true);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    Services.els.removeSystemEventListener(</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+      this.browser,</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+      &quot;dragover&quot;,</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+      this,</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+      true</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+    );</span>
<a href="#l9.106"></a><span id="l9.106">     Services.els.removeSystemEventListener(this.browser, &quot;drop&quot;, this, true);</span>
<a href="#l9.107"></a><span id="l9.107">   },</span>
<a href="#l9.108"></a><span id="l9.108"> </span>
<a href="#l9.109"></a><span id="l9.109">   /**</span>
<a href="#l9.110"></a><span id="l9.110">    * Anything added to the messages array will get handled here, and should</span>
<a href="#l9.111"></a><span id="l9.111">    * get dispatched to a specific function for the message name.</span>
<a href="#l9.112"></a><span id="l9.112">    */</span>
<a href="#l9.113"></a><span id="l9.113">   receiveMessage(message) {</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineat">@@ -320,49 +337,59 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.115"></a><span id="l9.115">   },</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117">   /**</span>
<a href="#l9.118"></a><span id="l9.118">    * This is the deprecated API for viewSource.xul, for old-timer consumers.</span>
<a href="#l9.119"></a><span id="l9.119">    * This API might eventually go away.</span>
<a href="#l9.120"></a><span id="l9.120">    */</span>
<a href="#l9.121"></a><span id="l9.121">   // NOT WORKING ANYMORE AFTER REMOVAL OF THE &quot;ViewSource:LoadSourceDeprecated&quot; MESSAGE IN BUG 1443371.</span>
<a href="#l9.122"></a><span id="l9.122">   _loadViewSourceDeprecated(aArguments) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    Deprecated.warning(&quot;The arguments you're passing to viewSource.xul &quot; +</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-                       &quot;are using an out-of-date API.&quot;,</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-                       &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    Deprecated.warning(</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+      &quot;The arguments you're passing to viewSource.xul &quot; +</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+        &quot;are using an out-of-date API.&quot;,</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+      &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    );</span>
<a href="#l9.131"></a><span id="l9.131">     // Parse the 'arguments' supplied with the dialog.</span>
<a href="#l9.132"></a><span id="l9.132">     //    arg[0] - URL string.</span>
<a href="#l9.133"></a><span id="l9.133">     //    arg[1] - Charset value in the form 'charset=xxx'.</span>
<a href="#l9.134"></a><span id="l9.134">     //    arg[2] - Page descriptor used to load content from the cache.</span>
<a href="#l9.135"></a><span id="l9.135">     //    arg[3] - Line number to go to.</span>
<a href="#l9.136"></a><span id="l9.136">     //    arg[4] - Whether charset was forced by the user</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138">     if (aArguments[2]) {</span>
<a href="#l9.139"></a><span id="l9.139">       let pageDescriptor = aArguments[2];</span>
<a href="#l9.140"></a><span id="l9.140">       if (Cu.isCrossProcessWrapper(pageDescriptor)) {</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-        throw new Error(&quot;Cannot pass a CPOW as the page descriptor to viewSource.xul.&quot;);</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+        throw new Error(</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+          &quot;Cannot pass a CPOW as the page descriptor to viewSource.xul.&quot;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+        );</span>
<a href="#l9.145"></a><span id="l9.145">       }</span>
<a href="#l9.146"></a><span id="l9.146">     }</span>
<a href="#l9.147"></a><span id="l9.147"> </span>
<a href="#l9.148"></a><span id="l9.148">     if (this.browser.isRemoteBrowser) {</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-      throw new Error(&quot;Deprecated view source API should not use a remote browser.&quot;);</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+      throw new Error(</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+        &quot;Deprecated view source API should not use a remote browser.&quot;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+      );</span>
<a href="#l9.153"></a><span id="l9.153">     }</span>
<a href="#l9.154"></a><span id="l9.154"> </span>
<a href="#l9.155"></a><span id="l9.155">     let forcedCharSet;</span>
<a href="#l9.156"></a><span id="l9.156">     if (aArguments[4] &amp;&amp; aArguments[1].startsWith(&quot;charset=&quot;)) {</span>
<a href="#l9.157"></a><span id="l9.157">       forcedCharSet = aArguments[1].split(&quot;=&quot;)[1];</span>
<a href="#l9.158"></a><span id="l9.158">     }</span>
<a href="#l9.159"></a><span id="l9.159"> </span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-    this.sendAsyncMessage(&quot;ViewSource:LoadSourceDeprecated&quot;, {</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-      URL: aArguments[0],</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-      lineNumber: aArguments[3],</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-      forcedCharSet,</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-    }, {</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-      pageDescriptor: aArguments[2],</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-    });</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+    this.sendAsyncMessage(</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+      &quot;ViewSource:LoadSourceDeprecated&quot;,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+      {</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        URL: aArguments[0],</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+        lineNumber: aArguments[3],</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+        forcedCharSet,</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+      },</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+      {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+        pageDescriptor: aArguments[2],</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+      }</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+    );</span>
<a href="#l9.178"></a><span id="l9.178">   },</span>
<a href="#l9.179"></a><span id="l9.179"> </span>
<a href="#l9.180"></a><span id="l9.180">   /**</span>
<a href="#l9.181"></a><span id="l9.181">    * Handler for the AppCommand event.</span>
<a href="#l9.182"></a><span id="l9.182">    *</span>
<a href="#l9.183"></a><span id="l9.183">    * @param event</span>
<a href="#l9.184"></a><span id="l9.184">    *        The AppCommand event being handled.</span>
<a href="#l9.185"></a><span id="l9.185">    */</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineat">@@ -437,18 +464,19 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.187"></a><span id="l9.187">     if (event.target.hasAttribute(&quot;charset&quot;)) {</span>
<a href="#l9.188"></a><span id="l9.188">       let charset = event.target.getAttribute(&quot;charset&quot;);</span>
<a href="#l9.189"></a><span id="l9.189">       // Replace generic Japanses with Shift_JIS which will also auto-detect</span>
<a href="#l9.190"></a><span id="l9.190">       // ISO-2022-JP and EUC-JP.</span>
<a href="#l9.191"></a><span id="l9.191">       if (charset == &quot;Japanese&quot;) {</span>
<a href="#l9.192"></a><span id="l9.192">         charset = &quot;Shift_JIS&quot;;</span>
<a href="#l9.193"></a><span id="l9.193">       }</span>
<a href="#l9.194"></a><span id="l9.194">       this.browser.docShell.charset = charset;</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-      this.browser</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-          .reloadWithFlags(Ci.nsIWebNavigation.LOAD_FLAGS_CHARSET_CHANGE);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+      this.browser.reloadWithFlags(</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+        Ci.nsIWebNavigation.LOAD_FLAGS_CHARSET_CHANGE</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+      );</span>
<a href="#l9.200"></a><span id="l9.200">     }</span>
<a href="#l9.201"></a><span id="l9.201">   },</span>
<a href="#l9.202"></a><span id="l9.202"> </span>
<a href="#l9.203"></a><span id="l9.203">   /**</span>
<a href="#l9.204"></a><span id="l9.204">    * Called from the frame script when the context menu is about to</span>
<a href="#l9.205"></a><span id="l9.205">    * open. This tells ViewSourceChrome things about the item that</span>
<a href="#l9.206"></a><span id="l9.206">    * the context menu is being opened on. This should be called before</span>
<a href="#l9.207"></a><span id="l9.207">    * the popupshowing event handler fires.</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineat">@@ -481,18 +509,19 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.209"></a><span id="l9.209">    */</span>
<a href="#l9.210"></a><span id="l9.210">   onContextMenuCopyLinkOrEmail() {</span>
<a href="#l9.211"></a><span id="l9.211">     // It doesn't make any sense to call this if the context menu</span>
<a href="#l9.212"></a><span id="l9.212">     // isn't open...</span>
<a href="#l9.213"></a><span id="l9.213">     if (!this.contextMenuData.isOpen) {</span>
<a href="#l9.214"></a><span id="l9.214">       return;</span>
<a href="#l9.215"></a><span id="l9.215">     }</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-    let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-                      .getService(Ci.nsIClipboardHelper);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+    let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;].getService(</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+      Ci.nsIClipboardHelper</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+    );</span>
<a href="#l9.222"></a><span id="l9.222">     clipboard.copyString(this.contextMenuData.href);</span>
<a href="#l9.223"></a><span id="l9.223">   },</span>
<a href="#l9.224"></a><span id="l9.224"> </span>
<a href="#l9.225"></a><span id="l9.225">   /**</span>
<a href="#l9.226"></a><span id="l9.226">    * Called when the context menu closes, and invalidates any data</span>
<a href="#l9.227"></a><span id="l9.227">    * that the frame script might have sent up about what the context</span>
<a href="#l9.228"></a><span id="l9.228">    * menu was opened on.</span>
<a href="#l9.229"></a><span id="l9.229">    */</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineat">@@ -505,35 +534,39 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.231"></a><span id="l9.231">   /**</span>
<a href="#l9.232"></a><span id="l9.232">    * Called when the user drags something over the content browser.</span>
<a href="#l9.233"></a><span id="l9.233">    */</span>
<a href="#l9.234"></a><span id="l9.234">   onDragOver(event) {</span>
<a href="#l9.235"></a><span id="l9.235">     // For drags that appear to be internal text (for example, tab drags),</span>
<a href="#l9.236"></a><span id="l9.236">     // set the dropEffect to 'none'. This prevents the drop even if some</span>
<a href="#l9.237"></a><span id="l9.237">     // other listener cancelled the event.</span>
<a href="#l9.238"></a><span id="l9.238">     let types = event.dataTransfer.types;</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-    if (types.includes(&quot;text/x-moz-text-internal&quot;) &amp;&amp; !types.includes(&quot;text/plain&quot;)) {</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-        event.dataTransfer.dropEffect = &quot;none&quot;;</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-        event.preventDefault();</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+    if (</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+      types.includes(&quot;text/x-moz-text-internal&quot;) &amp;&amp;</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+      !types.includes(&quot;text/plain&quot;)</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+    ) {</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+      event.dataTransfer.dropEffect = &quot;none&quot;;</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+      event.stopPropagation();</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+      event.preventDefault();</span>
<a href="#l9.250"></a><span id="l9.250">     }</span>
<a href="#l9.251"></a><span id="l9.251"> </span>
<a href="#l9.252"></a><span id="l9.252">     if (Services.droppedLinkHandler.canDropLink(event, false)) {</span>
<a href="#l9.253"></a><span id="l9.253">       event.preventDefault();</span>
<a href="#l9.254"></a><span id="l9.254">     }</span>
<a href="#l9.255"></a><span id="l9.255">   },</span>
<a href="#l9.256"></a><span id="l9.256"> </span>
<a href="#l9.257"></a><span id="l9.257">   /**</span>
<a href="#l9.258"></a><span id="l9.258">    * Called twhen the user drops something onto the content browser.</span>
<a href="#l9.259"></a><span id="l9.259">    */</span>
<a href="#l9.260"></a><span id="l9.260">   onDrop(event) {</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-    if (event.defaultPrevented)</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+    if (event.defaultPrevented) {</span>
<a href="#l9.263"></a><span id="l9.263">       return;</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+    }</span>
<a href="#l9.265"></a><span id="l9.265"> </span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-    let name = { };</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+    let name = {};</span>
<a href="#l9.268"></a><span id="l9.268">     let uri;</span>
<a href="#l9.269"></a><span id="l9.269">     try {</span>
<a href="#l9.270"></a><span id="l9.270">       // Pass true to prevent the dropping of javascript:/data: URIs</span>
<a href="#l9.271"></a><span id="l9.271">       uri = Services.droppedLinkHandler.dropLink(event, name, true);</span>
<a href="#l9.272"></a><span id="l9.272">     } catch (e) {</span>
<a href="#l9.273"></a><span id="l9.273">       return;</span>
<a href="#l9.274"></a><span id="l9.274">     }</span>
<a href="#l9.275"></a><span id="l9.275"> </span>
<a href="#l9.276"></a><span id="l9.276" class="difflineat">@@ -593,18 +626,20 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.277"></a><span id="l9.277">       }</span>
<a href="#l9.278"></a><span id="l9.278">     }</span>
<a href="#l9.279"></a><span id="l9.279">   },</span>
<a href="#l9.280"></a><span id="l9.280"> </span>
<a href="#l9.281"></a><span id="l9.281">   /**</span>
<a href="#l9.282"></a><span id="l9.282">    * Reloads the browser, bypassing the network cache.</span>
<a href="#l9.283"></a><span id="l9.283">    */</span>
<a href="#l9.284"></a><span id="l9.284">   reload() {</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-    this.browser.reloadWithFlags(Ci.nsIWebNavigation.LOAD_FLAGS_BYPASS_PROXY |</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-                                 Ci.nsIWebNavigation.LOAD_FLAGS_BYPASS_CACHE);</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+    this.browser.reloadWithFlags(</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+      Ci.nsIWebNavigation.LOAD_FLAGS_BYPASS_PROXY |</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+        Ci.nsIWebNavigation.LOAD_FLAGS_BYPASS_CACHE</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+    );</span>
<a href="#l9.291"></a><span id="l9.291">   },</span>
<a href="#l9.292"></a><span id="l9.292"> </span>
<a href="#l9.293"></a><span id="l9.293">   /**</span>
<a href="#l9.294"></a><span id="l9.294">    * Closes the view source window.</span>
<a href="#l9.295"></a><span id="l9.295">    */</span>
<a href="#l9.296"></a><span id="l9.296">   close() {</span>
<a href="#l9.297"></a><span id="l9.297">     window.close();</span>
<a href="#l9.298"></a><span id="l9.298">   },</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineat">@@ -635,18 +670,20 @@ ViewSourceChrome.prototype = {</span>
<a href="#l9.300"></a><span id="l9.300">    * @param shouldBeRemote</span>
<a href="#l9.301"></a><span id="l9.301">    *        True if the browser should be made remote. If the browsers</span>
<a href="#l9.302"></a><span id="l9.302">    *        remoteness already matches this value, this function does</span>
<a href="#l9.303"></a><span id="l9.303">    *        nothing.</span>
<a href="#l9.304"></a><span id="l9.304">    * @param remoteType</span>
<a href="#l9.305"></a><span id="l9.305">    *        The type of remote browser process.</span>
<a href="#l9.306"></a><span id="l9.306">    */</span>
<a href="#l9.307"></a><span id="l9.307">   updateBrowserRemoteness(shouldBeRemote, remoteType) {</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-    if (this.browser.isRemoteBrowser == shouldBeRemote &amp;&amp;</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-        this.browser.remoteType == remoteType) {</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+    if (</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineplus">+      this.browser.isRemoteBrowser == shouldBeRemote &amp;&amp;</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+      this.browser.remoteType == remoteType</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+    ) {</span>
<a href="#l9.314"></a><span id="l9.314">       return;</span>
<a href="#l9.315"></a><span id="l9.315">     }</span>
<a href="#l9.316"></a><span id="l9.316"> </span>
<a href="#l9.317"></a><span id="l9.317">     let parentNode = this.browser.parentNode;</span>
<a href="#l9.318"></a><span id="l9.318">     let nextSibling = this.browser.nextSibling;</span>
<a href="#l9.319"></a><span id="l9.319"> </span>
<a href="#l9.320"></a><span id="l9.320">     // Removing and re-adding the browser from and to the DOM strips its XBL</span>
<a href="#l9.321"></a><span id="l9.321">     // properties. Save and restore sameProcessAsFrameLoader. Note that when we</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineat">@@ -702,18 +739,19 @@ var PrintPreviewListener = {</span>
<a href="#l9.323"></a><span id="l9.323"> </span>
<a href="#l9.324"></a><span id="l9.324">     if (gBrowser.isRemoteBrowser) {</span>
<a href="#l9.325"></a><span id="l9.325">       this._ppBrowser.setAttribute(&quot;remote&quot;, &quot;true&quot;);</span>
<a href="#l9.326"></a><span id="l9.326">     } else {</span>
<a href="#l9.327"></a><span id="l9.327">       this._ppBrowser.removeAttribute(&quot;remote&quot;);</span>
<a href="#l9.328"></a><span id="l9.328">     }</span>
<a href="#l9.329"></a><span id="l9.329"> </span>
<a href="#l9.330"></a><span id="l9.330">     let findBar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-    document.getElementById(&quot;appcontent&quot;)</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-            .insertBefore(this._ppBrowser, findBar);</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+    document</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+      .getElementById(&quot;appcontent&quot;)</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+      .insertBefore(this._ppBrowser, findBar);</span>
<a href="#l9.336"></a><span id="l9.336"> </span>
<a href="#l9.337"></a><span id="l9.337">     return this._ppBrowser;</span>
<a href="#l9.338"></a><span id="l9.338">   },</span>
<a href="#l9.339"></a><span id="l9.339"> </span>
<a href="#l9.340"></a><span id="l9.340">   getSourceBrowser() {</span>
<a href="#l9.341"></a><span id="l9.341">     return gBrowser;</span>
<a href="#l9.342"></a><span id="l9.342">   },</span>
<a href="#l9.343"></a><span id="l9.343"> </span>
<a href="#l9.344"></a><span id="l9.344" class="difflineat">@@ -743,122 +781,158 @@ function getBrowser() {</span>
<a href="#l9.345"></a><span id="l9.345">   return gBrowser;</span>
<a href="#l9.346"></a><span id="l9.346"> }</span>
<a href="#l9.347"></a><span id="l9.347"> </span>
<a href="#l9.348"></a><span id="l9.348"> Object.defineProperty(this, &quot;gPageLoader&quot;, {</span>
<a href="#l9.349"></a><span id="l9.349">   configurable: true,</span>
<a href="#l9.350"></a><span id="l9.350">   enumerable: true,</span>
<a href="#l9.351"></a><span id="l9.351">   get() {</span>
<a href="#l9.352"></a><span id="l9.352">     var webnav = viewSourceChrome.webNav;</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-    if (!webnav)</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+    if (!webnav) {</span>
<a href="#l9.355"></a><span id="l9.355">       return null;</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+    }</span>
<a href="#l9.357"></a><span id="l9.357">     delete this.gPageLoader;</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-    this.gPageLoader = (webnav instanceof Ci.nsIWebPageDescriptor) ? webnav</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-                                                                   : null;</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+    this.gPageLoader =</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+      webnav instanceof Ci.nsIWebPageDescriptor ? webnav : null;</span>
<a href="#l9.362"></a><span id="l9.362">     return this.gPageLoader;</span>
<a href="#l9.363"></a><span id="l9.363">   },</span>
<a href="#l9.364"></a><span id="l9.364"> });</span>
<a href="#l9.365"></a><span id="l9.365"> </span>
<a href="#l9.366"></a><span id="l9.366"> // Strips the |view-source:| for internalSave()</span>
<a href="#l9.367"></a><span id="l9.367"> function ViewSourceSavePage() {</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-  internalSave(gBrowser.currentURI.spec.replace(/^view-source:/i, &quot;&quot;),</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-               null, null, null, null, null, &quot;SaveLinkTitle&quot;,</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-               null, null, gBrowser.contentDocument, null,</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-               gPageLoader, null,</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-               Services.scriptSecurityManager.getSystemPrincipal());</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+  internalSave(</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+    gBrowser.currentURI.spec.replace(/^view-source:/i, &quot;&quot;),</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+    null,</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+    null,</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+    null,</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+    null,</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+    null,</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+    &quot;SaveLinkTitle&quot;,</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+    null,</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+    null,</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineplus">+    gBrowser.contentDocument,</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineplus">+    null,</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+    gPageLoader,</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+    null,</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+    Services.scriptSecurityManager.getSystemPrincipal()</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+  );</span>
<a href="#l9.389"></a><span id="l9.389"> }</span>
<a href="#l9.390"></a><span id="l9.390"> </span>
<a href="#l9.391"></a><span id="l9.391"> // Below are old deprecated functions and variables left behind for</span>
<a href="#l9.392"></a><span id="l9.392"> // compatibility reasons. These will be removed soon via bug 1159293.</span>
<a href="#l9.393"></a><span id="l9.393"> </span>
<a href="#l9.394"></a><span id="l9.394"> Object.defineProperty(this, &quot;gLastLineFound&quot;, {</span>
<a href="#l9.395"></a><span id="l9.395">   configurable: true,</span>
<a href="#l9.396"></a><span id="l9.396">   enumerable: true,</span>
<a href="#l9.397"></a><span id="l9.397">   get() {</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-    Deprecated.warning(&quot;gLastLineFound is deprecated - please use &quot; +</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-                       &quot;viewSourceChrome.lastLineFound instead.&quot;,</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-                       &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+    Deprecated.warning(</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+      &quot;gLastLineFound is deprecated - please use &quot; +</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+        &quot;viewSourceChrome.lastLineFound instead.&quot;,</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+      &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+    );</span>
<a href="#l9.406"></a><span id="l9.406">     return viewSourceChrome.lastLineFound;</span>
<a href="#l9.407"></a><span id="l9.407">   },</span>
<a href="#l9.408"></a><span id="l9.408"> });</span>
<a href="#l9.409"></a><span id="l9.409"> </span>
<a href="#l9.410"></a><span id="l9.410"> function onLoadViewSource() {</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-  Deprecated.warning(&quot;onLoadViewSource() is deprecated - please use &quot; +</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-                     &quot;viewSourceChrome.onXULLoaded() instead.&quot;,</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+    &quot;onLoadViewSource() is deprecated - please use &quot; +</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+      &quot;viewSourceChrome.onXULLoaded() instead.&quot;,</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+  );</span>
<a href="#l9.419"></a><span id="l9.419">   viewSourceChrome.onXULLoaded();</span>
<a href="#l9.420"></a><span id="l9.420"> }</span>
<a href="#l9.421"></a><span id="l9.421"> </span>
<a href="#l9.422"></a><span id="l9.422"> function isHistoryEnabled() {</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-  Deprecated.warning(&quot;isHistoryEnabled() is deprecated - please use &quot; +</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-                     &quot;viewSourceChrome.historyEnabled instead.&quot;,</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+    &quot;isHistoryEnabled() is deprecated - please use &quot; +</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+      &quot;viewSourceChrome.historyEnabled instead.&quot;,</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+  );</span>
<a href="#l9.431"></a><span id="l9.431">   return viewSourceChrome.historyEnabled;</span>
<a href="#l9.432"></a><span id="l9.432"> }</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434"> function ViewSourceClose() {</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-  Deprecated.warning(&quot;ViewSourceClose() is deprecated - please use &quot; +</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-                     &quot;viewSourceChrome.close() instead.&quot;,</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+    &quot;ViewSourceClose() is deprecated - please use &quot; +</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+      &quot;viewSourceChrome.close() instead.&quot;,</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+  );</span>
<a href="#l9.443"></a><span id="l9.443">   viewSourceChrome.close();</span>
<a href="#l9.444"></a><span id="l9.444"> }</span>
<a href="#l9.445"></a><span id="l9.445"> </span>
<a href="#l9.446"></a><span id="l9.446"> function ViewSourceReload() {</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-  Deprecated.warning(&quot;ViewSourceReload() is deprecated - please use &quot; +</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-                     &quot;viewSourceChrome.reload() instead.&quot;,</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+    &quot;ViewSourceReload() is deprecated - please use &quot; +</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+      &quot;viewSourceChrome.reload() instead.&quot;,</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+  );</span>
<a href="#l9.455"></a><span id="l9.455">   viewSourceChrome.reload();</span>
<a href="#l9.456"></a><span id="l9.456"> }</span>
<a href="#l9.457"></a><span id="l9.457"> </span>
<a href="#l9.458"></a><span id="l9.458"> function getWebNavigation() {</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-  Deprecated.warning(&quot;getWebNavigation() is deprecated - please use &quot; +</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-                     &quot;viewSourceChrome.webNav instead.&quot;,</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+    &quot;getWebNavigation() is deprecated - please use &quot; +</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+      &quot;viewSourceChrome.webNav instead.&quot;,</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+  );</span>
<a href="#l9.467"></a><span id="l9.467">   // The original implementation returned null if anything threw during</span>
<a href="#l9.468"></a><span id="l9.468">   // the getting of the webNavigation.</span>
<a href="#l9.469"></a><span id="l9.469">   try {</span>
<a href="#l9.470"></a><span id="l9.470">     return viewSourceChrome.webNav;</span>
<a href="#l9.471"></a><span id="l9.471">   } catch (e) {</span>
<a href="#l9.472"></a><span id="l9.472">     return null;</span>
<a href="#l9.473"></a><span id="l9.473">   }</span>
<a href="#l9.474"></a><span id="l9.474"> }</span>
<a href="#l9.475"></a><span id="l9.475"> </span>
<a href="#l9.476"></a><span id="l9.476"> function viewSource(url) {</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-  Deprecated.warning(&quot;viewSource() is deprecated - please use &quot; +</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-                     &quot;viewSourceChrome.loadURL() instead.&quot;,</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+    &quot;viewSource() is deprecated - please use &quot; +</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+      &quot;viewSourceChrome.loadURL() instead.&quot;,</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineplus">+  );</span>
<a href="#l9.485"></a><span id="l9.485">   viewSourceChrome.loadURL(url);</span>
<a href="#l9.486"></a><span id="l9.486"> }</span>
<a href="#l9.487"></a><span id="l9.487"> </span>
<a href="#l9.488"></a><span id="l9.488"> function ViewSourceGoToLine() {</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-  Deprecated.warning(&quot;ViewSourceGoToLine() is deprecated - please use &quot; +</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-                     &quot;viewSourceChrome.promptAndGoToLine() instead.&quot;,</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+    &quot;ViewSourceGoToLine() is deprecated - please use &quot; +</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+      &quot;viewSourceChrome.promptAndGoToLine() instead.&quot;,</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+  );</span>
<a href="#l9.497"></a><span id="l9.497">   viewSourceChrome.promptAndGoToLine();</span>
<a href="#l9.498"></a><span id="l9.498"> }</span>
<a href="#l9.499"></a><span id="l9.499"> </span>
<a href="#l9.500"></a><span id="l9.500"> function goToLine(line) {</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-  Deprecated.warning(&quot;goToLine() is deprecated - please use &quot; +</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-                     &quot;viewSourceChrome.goToLine() instead.&quot;,</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+    &quot;goToLine() is deprecated - please use &quot; +</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+      &quot;viewSourceChrome.goToLine() instead.&quot;,</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+  );</span>
<a href="#l9.509"></a><span id="l9.509">   viewSourceChrome.goToLine(line);</span>
<a href="#l9.510"></a><span id="l9.510"> }</span>
<a href="#l9.511"></a><span id="l9.511"> </span>
<a href="#l9.512"></a><span id="l9.512"> function BrowserForward(aEvent) {</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-  Deprecated.warning(&quot;BrowserForward() is deprecated - please use &quot; +</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineminus">-                     &quot;viewSourceChrome.goForward() instead.&quot;,</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+    &quot;BrowserForward() is deprecated - please use &quot; +</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+      &quot;viewSourceChrome.goForward() instead.&quot;,</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineplus">+  );</span>
<a href="#l9.521"></a><span id="l9.521">   viewSourceChrome.goForward();</span>
<a href="#l9.522"></a><span id="l9.522"> }</span>
<a href="#l9.523"></a><span id="l9.523"> </span>
<a href="#l9.524"></a><span id="l9.524"> function BrowserBack(aEvent) {</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-  Deprecated.warning(&quot;BrowserBack() is deprecated - please use &quot; +</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-                     &quot;viewSourceChrome.goBack() instead.&quot;,</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+    &quot;BrowserBack() is deprecated - please use &quot; +</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+      &quot;viewSourceChrome.goBack() instead.&quot;,</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+  );</span>
<a href="#l9.533"></a><span id="l9.533">   viewSourceChrome.goBack();</span>
<a href="#l9.534"></a><span id="l9.534"> }</span>
<a href="#l9.535"></a><span id="l9.535"> </span>
<a href="#l9.536"></a><span id="l9.536"> function UpdateBackForwardCommands() {</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-  Deprecated.warning(&quot;UpdateBackForwardCommands() is deprecated - please use &quot; +</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-                     &quot;viewSourceChrome.updateCommands() instead.&quot;,</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-                     &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;);</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+  Deprecated.warning(</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+    &quot;UpdateBackForwardCommands() is deprecated - please use &quot; +</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+      &quot;viewSourceChrome.updateCommands() instead.&quot;,</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+    &quot;https://developer.mozilla.org/en-US/Add-ons/Code_snippets/View_Source_for_XUL_Applications&quot;</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+  );</span>
<a href="#l9.545"></a><span id="l9.545">   viewSourceChrome.updateCommands();</span>
<a href="#l9.546"></a><span id="l9.546"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/common/src/viewZoomOverlay.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/common/src/viewZoomOverlay.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -6,92 +6,101 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> /* globals getBrowser */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> /** Document Zoom Management Code</span>
<a href="#l10.8"></a><span id="l10.8">  *</span>
<a href="#l10.9"></a><span id="l10.9">  * Forked from M-C since we don't provide a global gBrowser variable.</span>
<a href="#l10.10"></a><span id="l10.10">  **/</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> var ZoomManager = {</span>
<a href="#l10.16"></a><span id="l10.16">   get MIN() {</span>
<a href="#l10.17"></a><span id="l10.17">     delete this.MIN;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-    return this.MIN = Services.prefs.getIntPref(&quot;zoom.minPercent&quot;) / 100;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    return (this.MIN = Services.prefs.getIntPref(&quot;zoom.minPercent&quot;) / 100);</span>
<a href="#l10.20"></a><span id="l10.20">   },</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22">   get MAX() {</span>
<a href="#l10.23"></a><span id="l10.23">     delete this.MAX;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    return this.MAX = Services.prefs.getIntPref(&quot;zoom.maxPercent&quot;) / 100;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    return (this.MAX = Services.prefs.getIntPref(&quot;zoom.maxPercent&quot;) / 100);</span>
<a href="#l10.26"></a><span id="l10.26">   },</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">   get useFullZoom() {</span>
<a href="#l10.29"></a><span id="l10.29">     return Services.prefs.getBoolPref(&quot;browser.zoom.full&quot;);</span>
<a href="#l10.30"></a><span id="l10.30">   },</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   set useFullZoom(aVal) {</span>
<a href="#l10.33"></a><span id="l10.33">     Services.prefs.setBoolPref(&quot;browser.zoom.full&quot;, aVal);</span>
<a href="#l10.34"></a><span id="l10.34">     return aVal;</span>
<a href="#l10.35"></a><span id="l10.35">   },</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">   get zoom() {</span>
<a href="#l10.38"></a><span id="l10.38">     return this.getZoomForBrowser(getBrowser());</span>
<a href="#l10.39"></a><span id="l10.39">   },</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41">   getZoomForBrowser(aBrowser) {</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-    let zoom = (this.useFullZoom || aBrowser.isSyntheticDocument)</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-               ? aBrowser.fullZoom : aBrowser.textZoom;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    let zoom =</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+      this.useFullZoom || aBrowser.isSyntheticDocument</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+        ? aBrowser.fullZoom</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+        : aBrowser.textZoom;</span>
<a href="#l10.48"></a><span id="l10.48">     // Round to remove any floating-point error.</span>
<a href="#l10.49"></a><span id="l10.49">     return Number(zoom ? zoom.toFixed(2) : 1);</span>
<a href="#l10.50"></a><span id="l10.50">   },</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52">   set zoom(aVal) {</span>
<a href="#l10.53"></a><span id="l10.53">     this.setZoomForBrowser(getBrowser(), aVal);</span>
<a href="#l10.54"></a><span id="l10.54">     return aVal;</span>
<a href="#l10.55"></a><span id="l10.55">   },</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">   setZoomForBrowser(aBrowser, aVal) {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    if (aVal &lt; this.MIN || aVal &gt; this.MAX)</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    if (aVal &lt; this.MIN || aVal &gt; this.MAX) {</span>
<a href="#l10.60"></a><span id="l10.60">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    }</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">     if (this.useFullZoom || aBrowser.isSyntheticDocument) {</span>
<a href="#l10.64"></a><span id="l10.64">       aBrowser.textZoom = 1;</span>
<a href="#l10.65"></a><span id="l10.65">       aBrowser.fullZoom = aVal;</span>
<a href="#l10.66"></a><span id="l10.66">     } else {</span>
<a href="#l10.67"></a><span id="l10.67">       aBrowser.textZoom = aVal;</span>
<a href="#l10.68"></a><span id="l10.68">       aBrowser.fullZoom = 1;</span>
<a href="#l10.69"></a><span id="l10.69">     }</span>
<a href="#l10.70"></a><span id="l10.70">   },</span>
<a href="#l10.71"></a><span id="l10.71"> </span>
<a href="#l10.72"></a><span id="l10.72">   get zoomValues() {</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    var zoomValues = Services.prefs.getCharPref(&quot;toolkit.zoomManager.zoomValues&quot;)</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-                                   .split(&quot;,&quot;).map(parseFloat);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    var zoomValues = Services.prefs</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+      .getCharPref(&quot;toolkit.zoomManager.zoomValues&quot;)</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+      .map(parseFloat);</span>
<a href="#l10.79"></a><span id="l10.79">     zoomValues.sort((a, b) =&gt; a - b);</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-    while (zoomValues[0] &lt; this.MIN)</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+    while (zoomValues[0] &lt; this.MIN) {</span>
<a href="#l10.83"></a><span id="l10.83">       zoomValues.shift();</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    }</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-    while (zoomValues[zoomValues.length - 1] &gt; this.MAX)</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+    while (zoomValues[zoomValues.length - 1] &gt; this.MAX) {</span>
<a href="#l10.88"></a><span id="l10.88">       zoomValues.pop();</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    }</span>
<a href="#l10.90"></a><span id="l10.90"> </span>
<a href="#l10.91"></a><span id="l10.91">     delete this.zoomValues;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-    return this.zoomValues = zoomValues;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    return (this.zoomValues = zoomValues);</span>
<a href="#l10.94"></a><span id="l10.94">   },</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96">   enlarge() {</span>
<a href="#l10.97"></a><span id="l10.97">     var i = this.zoomValues.indexOf(this.snap(this.zoom)) + 1;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-    if (i &lt; this.zoomValues.length)</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+    if (i &lt; this.zoomValues.length) {</span>
<a href="#l10.100"></a><span id="l10.100">       this.zoom = this.zoomValues[i];</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    }</span>
<a href="#l10.102"></a><span id="l10.102">   },</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104">   reduce() {</span>
<a href="#l10.105"></a><span id="l10.105">     var i = this.zoomValues.indexOf(this.snap(this.zoom)) - 1;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-    if (i &gt;= 0)</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    if (i &gt;= 0) {</span>
<a href="#l10.108"></a><span id="l10.108">       this.zoom = this.zoomValues[i];</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    }</span>
<a href="#l10.110"></a><span id="l10.110">   },</span>
<a href="#l10.111"></a><span id="l10.111"> </span>
<a href="#l10.112"></a><span id="l10.112">   reset() {</span>
<a href="#l10.113"></a><span id="l10.113">     this.zoom = 1;</span>
<a href="#l10.114"></a><span id="l10.114">   },</span>
<a href="#l10.115"></a><span id="l10.115"> </span>
<a href="#l10.116"></a><span id="l10.116">   toggleZoom() {</span>
<a href="#l10.117"></a><span id="l10.117">     var zoomLevel = this.zoom;</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineat">@@ -99,16 +108,17 @@ var ZoomManager = {</span>
<a href="#l10.119"></a><span id="l10.119">     this.useFullZoom = !this.useFullZoom;</span>
<a href="#l10.120"></a><span id="l10.120">     this.zoom = zoomLevel;</span>
<a href="#l10.121"></a><span id="l10.121">   },</span>
<a href="#l10.122"></a><span id="l10.122"> </span>
<a href="#l10.123"></a><span id="l10.123">   snap(aVal) {</span>
<a href="#l10.124"></a><span id="l10.124">     var values = this.zoomValues;</span>
<a href="#l10.125"></a><span id="l10.125">     for (var i = 0; i &lt; values.length; i++) {</span>
<a href="#l10.126"></a><span id="l10.126">       if (values[i] &gt;= aVal) {</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-        if (i &gt; 0 &amp;&amp; aVal - values[i - 1] &lt; values[i] - aVal)</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+        if (i &gt; 0 &amp;&amp; aVal - values[i - 1] &lt; values[i] - aVal) {</span>
<a href="#l10.129"></a><span id="l10.129">           i--;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+        }</span>
<a href="#l10.131"></a><span id="l10.131">         return values[i];</span>
<a href="#l10.132"></a><span id="l10.132">       }</span>
<a href="#l10.133"></a><span id="l10.133">     }</span>
<a href="#l10.134"></a><span id="l10.134">     return values[i - 1];</span>
<a href="#l10.135"></a><span id="l10.135">   },</span>
<a href="#l10.136"></a><span id="l10.136"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/common/test/xpcshell/data/BootstrapMonitor.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/common/test/xpcshell/data/BootstrapMonitor.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,33 +1,41 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-var EXPORTED_SYMBOLS = [ &quot;monitor&quot; ];</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;monitor&quot;];</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> function notify(event, originalMethod, data, reason) {</span>
<a href="#l11.15"></a><span id="l11.15">   let info = {</span>
<a href="#l11.16"></a><span id="l11.16">     event,</span>
<a href="#l11.17"></a><span id="l11.17">     data: Object.assign({}, data, {</span>
<a href="#l11.18"></a><span id="l11.18">       resourceURI: data.resourceURI.spec,</span>
<a href="#l11.19"></a><span id="l11.19">     }),</span>
<a href="#l11.20"></a><span id="l11.20">     reason,</span>
<a href="#l11.21"></a><span id="l11.21">   };</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  let subject = {wrappedJSObject: {data}};</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  let subject = { wrappedJSObject: { data } };</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  Services.obs.notifyObservers(subject, &quot;bootstrapmonitor-event&quot;, JSON.stringify(info));</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  Services.obs.notifyObservers(</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+    subject,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+    &quot;bootstrapmonitor-event&quot;,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+    JSON.stringify(info)</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  );</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   // If the bootstrap scope already declares a method call it</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  if (originalMethod)</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  if (originalMethod) {</span>
<a href="#l11.36"></a><span id="l11.36">     originalMethod(data, reason);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  }</span>
<a href="#l11.38"></a><span id="l11.38"> }</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> // Allows a simple one-line bootstrap script:</span>
<a href="#l11.41"></a><span id="l11.41"> // Components.utils.import(&quot;resource://xpcshelldata/bootstrapmonitor.jsm&quot;).monitor(this);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-var monitor = function(scope, methods = [&quot;install&quot;, &quot;startup&quot;, &quot;shutdown&quot;, &quot;uninstall&quot;]) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+var monitor = function(</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  scope,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  methods = [&quot;install&quot;, &quot;startup&quot;, &quot;shutdown&quot;, &quot;uninstall&quot;]</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+) {</span>
<a href="#l11.47"></a><span id="l11.47">   for (let event of methods) {</span>
<a href="#l11.48"></a><span id="l11.48">     scope[event] = notify.bind(null, event, scope[event]);</span>
<a href="#l11.49"></a><span id="l11.49">   }</span>
<a href="#l11.50"></a><span id="l11.50"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/common/test/xpcshell/head_addons.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/common/test/xpcshell/head_addons.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,62 +1,101 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l12.5"></a><span id="l12.5">  * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l12.6"></a><span id="l12.6">  */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-const PREF_EM_CHECK_UPDATE_SECURITY   = &quot;extensions.checkUpdateSecurity&quot;;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-const PREF_EM_STRICT_COMPATIBILITY    = &quot;extensions.strictCompatibility&quot;;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-const PREF_GETADDONS_BYIDS               = &quot;extensions.getAddons.get.url&quot;;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-const PREF_COMPAT_OVERRIDES              = &quot;extensions.getAddons.compatOverides.url&quot;;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-const PREF_XPI_SIGNATURES_REQUIRED    = &quot;xpinstall.signatures.required&quot;;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+const PREF_EM_CHECK_UPDATE_SECURITY = &quot;extensions.checkUpdateSecurity&quot;;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+const PREF_EM_STRICT_COMPATIBILITY = &quot;extensions.strictCompatibility&quot;;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+const PREF_GETADDONS_BYIDS = &quot;extensions.getAddons.get.url&quot;;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+const PREF_COMPAT_OVERRIDES = &quot;extensions.getAddons.compatOverides.url&quot;;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+const PREF_XPI_SIGNATURES_REQUIRED = &quot;xpinstall.signatures.required&quot;;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-const PREF_DISABLE_SECURITY = (&quot;security.turn_off_all_security_so_that_&quot; +</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-                               &quot;viruses_can_take_over_this_computer&quot;);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+const PREF_DISABLE_SECURITY =</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+  &quot;security.turn_off_all_security_so_that_&quot; +</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+  &quot;viruses_can_take_over_this_computer&quot;;</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25"> // Maximum error in file modification times. Some file systems don't store</span>
<a href="#l12.26"></a><span id="l12.26"> // modification times exactly. As long as we are closer than this then it</span>
<a href="#l12.27"></a><span id="l12.27"> // still passes.</span>
<a href="#l12.28"></a><span id="l12.28"> const MAX_TIME_DIFFERENCE = 3000;</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> // Time to reset file modified time relative to Date.now() so we can test that</span>
<a href="#l12.31"></a><span id="l12.31"> // times are modified (10 hours old).</span>
<a href="#l12.32"></a><span id="l12.32"> const MAKE_FILE_OLD_DIFFERENCE = 10 * 3600 * 1000;</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-var {FileUtils} = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-var {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-var {AddonRepository} = ChromeUtils.import(&quot;resource://gre/modules/addons/AddonRepository.jsm&quot;);</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+var { AppConstants } = ChromeUtils.import(</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+var { FileUtils } = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+var { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+var { AddonRepository } = ChromeUtils.import(</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  &quot;resource://gre/modules/addons/AddonRepository.jsm&quot;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-var {AddonTestUtils, MockAsyncShutdown} = ChromeUtils.import(&quot;resource://testing-common/AddonTestUtils.jsm&quot;);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+var { AddonTestUtils, MockAsyncShutdown } = ChromeUtils.import(</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  &quot;resource://testing-common/AddonTestUtils.jsm&quot;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+);</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;Blocklist&quot;,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-                               &quot;resource://gre/modules/Blocklist.jsm&quot;);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;Extension&quot;,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-                               &quot;resource://gre/modules/Extension.jsm&quot;);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;ExtensionTestUtils&quot;,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-                               &quot;resource://testing-common/ExtensionXPCShellUtils.jsm&quot;);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;ExtensionTestCommon&quot;,</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-                               &quot;resource://testing-common/ExtensionTestCommon.jsm&quot;);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;HttpServer&quot;,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-                               &quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;MockRegistrar&quot;,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-                               &quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;MockRegistry&quot;,</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-                               &quot;resource://testing-common/MockRegistry.jsm&quot;);</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PromiseTestUtils&quot;,</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-                               &quot;resource://testing-common/PromiseTestUtils.jsm&quot;);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;TestUtils&quot;,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-                               &quot;resource://testing-common/TestUtils.jsm&quot;);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  this,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  &quot;Blocklist&quot;,</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  &quot;resource://gre/modules/Blocklist.jsm&quot;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  this,</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  &quot;Extension&quot;,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  &quot;resource://gre/modules/Extension.jsm&quot;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  this,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  &quot;ExtensionTestUtils&quot;,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  &quot;resource://testing-common/ExtensionXPCShellUtils.jsm&quot;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  this,</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  &quot;ExtensionTestCommon&quot;,</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  &quot;resource://testing-common/ExtensionTestCommon.jsm&quot;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+);</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  this,</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  &quot;HttpServer&quot;,</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  &quot;resource://testing-common/httpd.js&quot;</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  this,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  &quot;MockRegistrar&quot;,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  &quot;resource://testing-common/MockRegistrar.jsm&quot;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+);</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+  this,</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  &quot;MockRegistry&quot;,</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  &quot;resource://testing-common/MockRegistry.jsm&quot;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  this,</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  &quot;PromiseTestUtils&quot;,</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  &quot;resource://testing-common/PromiseTestUtils.jsm&quot;</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  this,</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  &quot;TestUtils&quot;,</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  &quot;resource://testing-common/TestUtils.jsm&quot;</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+);</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;aomStartup&quot;,</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-                                   &quot;@mozilla.org/addons/addon-manager-startup;1&quot;,</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-                                   &quot;amIAddonManagerStartup&quot;);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+  this,</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  &quot;aomStartup&quot;,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+  &quot;@mozilla.org/addons/addon-manager-startup;1&quot;,</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  &quot;amIAddonManagerStartup&quot;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+);</span>
<a href="#l12.133"></a><span id="l12.133"> </span>
<a href="#l12.134"></a><span id="l12.134"> const {</span>
<a href="#l12.135"></a><span id="l12.135">   createAppInfo,</span>
<a href="#l12.136"></a><span id="l12.136">   createHttpServer,</span>
<a href="#l12.137"></a><span id="l12.137">   createTempWebExtensionFile,</span>
<a href="#l12.138"></a><span id="l12.138">   getFileForAddon,</span>
<a href="#l12.139"></a><span id="l12.139">   manuallyInstall,</span>
<a href="#l12.140"></a><span id="l12.140">   manuallyUninstall,</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineat">@@ -80,44 +119,48 @@ const {</span>
<a href="#l12.142"></a><span id="l12.142"> } = AddonTestUtils;</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144"> // WebExtension wrapper for ease of testing</span>
<a href="#l12.145"></a><span id="l12.145"> ExtensionTestUtils.init(this);</span>
<a href="#l12.146"></a><span id="l12.146"> </span>
<a href="#l12.147"></a><span id="l12.147"> AddonTestUtils.init(this, false);</span>
<a href="#l12.148"></a><span id="l12.148"> AddonTestUtils.overrideCertDB();</span>
<a href="#l12.149"></a><span id="l12.149"> </span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;,</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-                            () =&gt; AddonManagerPrivate.BOOTSTRAP_REASONS);</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+XPCOMUtils.defineLazyGetter(</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  this,</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  &quot;BOOTSTRAP_REASONS&quot;,</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+  () =&gt; AddonManagerPrivate.BOOTSTRAP_REASONS</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+);</span>
<a href="#l12.157"></a><span id="l12.157"> </span>
<a href="#l12.158"></a><span id="l12.158"> function getReasonName(reason) {</span>
<a href="#l12.159"></a><span id="l12.159">   for (let key of Object.keys(BOOTSTRAP_REASONS)) {</span>
<a href="#l12.160"></a><span id="l12.160">     if (BOOTSTRAP_REASONS[key] == reason) {</span>
<a href="#l12.161"></a><span id="l12.161">       return key;</span>
<a href="#l12.162"></a><span id="l12.162">     }</span>
<a href="#l12.163"></a><span id="l12.163">   }</span>
<a href="#l12.164"></a><span id="l12.164">   throw new Error(&quot;This shouldn't happen.&quot;);</span>
<a href="#l12.165"></a><span id="l12.165"> }</span>
<a href="#l12.166"></a><span id="l12.166"> </span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-</span>
<a href="#l12.168"></a><span id="l12.168"> Object.defineProperty(this, &quot;gAppInfo&quot;, {</span>
<a href="#l12.169"></a><span id="l12.169">   get() {</span>
<a href="#l12.170"></a><span id="l12.170">     return AddonTestUtils.appInfo;</span>
<a href="#l12.171"></a><span id="l12.171">   },</span>
<a href="#l12.172"></a><span id="l12.172"> });</span>
<a href="#l12.173"></a><span id="l12.173"> </span>
<a href="#l12.174"></a><span id="l12.174"> Object.defineProperty(this, &quot;gAddonStartup&quot;, {</span>
<a href="#l12.175"></a><span id="l12.175">   get() {</span>
<a href="#l12.176"></a><span id="l12.176">     return AddonTestUtils.addonStartup.clone();</span>
<a href="#l12.177"></a><span id="l12.177">   },</span>
<a href="#l12.178"></a><span id="l12.178"> });</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180"> Object.defineProperty(this, &quot;gInternalManager&quot;, {</span>
<a href="#l12.181"></a><span id="l12.181">   get() {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-    return AddonTestUtils.addonIntegrationService.QueryInterface(Ci.nsITimerCallback);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+    return AddonTestUtils.addonIntegrationService.QueryInterface(</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+      Ci.nsITimerCallback</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    );</span>
<a href="#l12.186"></a><span id="l12.186">   },</span>
<a href="#l12.187"></a><span id="l12.187"> });</span>
<a href="#l12.188"></a><span id="l12.188"> </span>
<a href="#l12.189"></a><span id="l12.189"> Object.defineProperty(this, &quot;gProfD&quot;, {</span>
<a href="#l12.190"></a><span id="l12.190">   get() {</span>
<a href="#l12.191"></a><span id="l12.191">     return AddonTestUtils.profileDir.clone();</span>
<a href="#l12.192"></a><span id="l12.192">   },</span>
<a href="#l12.193"></a><span id="l12.193"> });</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineat">@@ -128,42 +171,46 @@ Object.defineProperty(this, &quot;gTmpD&quot;, {</span>
<a href="#l12.195"></a><span id="l12.195">   },</span>
<a href="#l12.196"></a><span id="l12.196"> });</span>
<a href="#l12.197"></a><span id="l12.197"> </span>
<a href="#l12.198"></a><span id="l12.198"> Object.defineProperty(this, &quot;gUseRealCertChecks&quot;, {</span>
<a href="#l12.199"></a><span id="l12.199">   get() {</span>
<a href="#l12.200"></a><span id="l12.200">     return AddonTestUtils.useRealCertChecks;</span>
<a href="#l12.201"></a><span id="l12.201">   },</span>
<a href="#l12.202"></a><span id="l12.202">   set(val) {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-   return AddonTestUtils.useRealCertChecks = val;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+    return (AddonTestUtils.useRealCertChecks = val);</span>
<a href="#l12.205"></a><span id="l12.205">   },</span>
<a href="#l12.206"></a><span id="l12.206"> });</span>
<a href="#l12.207"></a><span id="l12.207"> </span>
<a href="#l12.208"></a><span id="l12.208"> Object.defineProperty(this, &quot;TEST_UNPACKED&quot;, {</span>
<a href="#l12.209"></a><span id="l12.209">   get() {</span>
<a href="#l12.210"></a><span id="l12.210">     return AddonTestUtils.testUnpacked;</span>
<a href="#l12.211"></a><span id="l12.211">   },</span>
<a href="#l12.212"></a><span id="l12.212">   set(val) {</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-   return AddonTestUtils.testUnpacked = val;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+    return (AddonTestUtils.testUnpacked = val);</span>
<a href="#l12.215"></a><span id="l12.215">   },</span>
<a href="#l12.216"></a><span id="l12.216"> });</span>
<a href="#l12.217"></a><span id="l12.217"> </span>
<a href="#l12.218"></a><span id="l12.218"> // We need some internal bits of AddonManager</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-var AMscope = ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;, null);</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+var AMscope = ChromeUtils.import(</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+  &quot;resource://gre/modules/AddonManager.jsm&quot;,</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+  null</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+);</span>
<a href="#l12.224"></a><span id="l12.224"> var { AddonManager, AddonManagerInternal, AddonManagerPrivate } = AMscope;</span>
<a href="#l12.225"></a><span id="l12.225"> </span>
<a href="#l12.226"></a><span id="l12.226"> const promiseAddonByID = AddonManager.getAddonByID;</span>
<a href="#l12.227"></a><span id="l12.227"> const promiseAddonsByIDs = AddonManager.getAddonsByIDs;</span>
<a href="#l12.228"></a><span id="l12.228"> </span>
<a href="#l12.229"></a><span id="l12.229"> var gPort = null;</span>
<a href="#l12.230"></a><span id="l12.230"> var gUrlToFileMap = {};</span>
<a href="#l12.231"></a><span id="l12.231"> </span>
<a href="#l12.232"></a><span id="l12.232"> // Map resource://xpcshell-data/ to the data directory</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-var resHandler = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-                         .QueryInterface(Ci.nsISubstitutingProtocolHandler);</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+var resHandler = Services.io</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+  .getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+  .QueryInterface(Ci.nsISubstitutingProtocolHandler);</span>
<a href="#l12.238"></a><span id="l12.238"> // Allow non-existent files because of bug 1207735</span>
<a href="#l12.239"></a><span id="l12.239"> var dataURI = NetUtil.newURI(do_get_file(&quot;data&quot;, true));</span>
<a href="#l12.240"></a><span id="l12.240"> resHandler.setSubstitution(&quot;xpcshell-data&quot;, dataURI);</span>
<a href="#l12.241"></a><span id="l12.241"> </span>
<a href="#l12.242"></a><span id="l12.242"> function isManifestRegistered(file) {</span>
<a href="#l12.243"></a><span id="l12.243">   let manifests = Components.manager.getManifestLocations();</span>
<a href="#l12.244"></a><span id="l12.244">   for (let i = 0; i &lt; manifests.length; i++) {</span>
<a href="#l12.245"></a><span id="l12.245">     let manifest = manifests.queryElementAt(i, Ci.nsIURI);</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineat">@@ -173,18 +220,19 @@ function isManifestRegistered(file) {</span>
<a href="#l12.247"></a><span id="l12.247">     if (manifest instanceof Ci.nsIJARURI) {</span>
<a href="#l12.248"></a><span id="l12.248">       manifest = manifest.JARFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l12.249"></a><span id="l12.249">     } else if (manifest instanceof Ci.nsIFileURL) {</span>
<a href="#l12.250"></a><span id="l12.250">       manifest = manifest.file.parent;</span>
<a href="#l12.251"></a><span id="l12.251">     } else {</span>
<a href="#l12.252"></a><span id="l12.252">       continue;</span>
<a href="#l12.253"></a><span id="l12.253">     }</span>
<a href="#l12.254"></a><span id="l12.254"> </span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-    if (manifest.equals(file))</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+    if (manifest.equals(file)) {</span>
<a href="#l12.257"></a><span id="l12.257">       return true;</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+    }</span>
<a href="#l12.259"></a><span id="l12.259">   }</span>
<a href="#l12.260"></a><span id="l12.260">   return false;</span>
<a href="#l12.261"></a><span id="l12.261"> }</span>
<a href="#l12.262"></a><span id="l12.262"> </span>
<a href="#l12.263"></a><span id="l12.263"> const BOOTSTRAP_MONITOR_BOOTSTRAP_JS = `</span>
<a href="#l12.264"></a><span id="l12.264">   ChromeUtils.import(&quot;resource://xpcshell-data/BootstrapMonitor.jsm&quot;).monitor(this);</span>
<a href="#l12.265"></a><span id="l12.265"> `;</span>
<a href="#l12.266"></a><span id="l12.266"> </span>
<a href="#l12.267"></a><span id="l12.267" class="difflineat">@@ -208,18 +256,19 @@ this.BootstrapMonitor = {</span>
<a href="#l12.268"></a><span id="l12.268">   restartfulIds: new Set(),</span>
<a href="#l12.269"></a><span id="l12.269"> </span>
<a href="#l12.270"></a><span id="l12.270">   init() {</span>
<a href="#l12.271"></a><span id="l12.271">     this.inited = true;</span>
<a href="#l12.272"></a><span id="l12.272">     Services.obs.addObserver(this, &quot;bootstrapmonitor-event&quot;);</span>
<a href="#l12.273"></a><span id="l12.273">   },</span>
<a href="#l12.274"></a><span id="l12.274"> </span>
<a href="#l12.275"></a><span id="l12.275">   shutdownCheck() {</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-    if (!this.inited)</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+    if (!this.inited) {</span>
<a href="#l12.278"></a><span id="l12.278">       return;</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+    }</span>
<a href="#l12.280"></a><span id="l12.280"> </span>
<a href="#l12.281"></a><span id="l12.281">     Assert.equal(this.started.size, 0);</span>
<a href="#l12.282"></a><span id="l12.282">   },</span>
<a href="#l12.283"></a><span id="l12.283"> </span>
<a href="#l12.284"></a><span id="l12.284">   clear(id) {</span>
<a href="#l12.285"></a><span id="l12.285">     this.installed.delete(id);</span>
<a href="#l12.286"></a><span id="l12.286">     this.started.delete(id);</span>
<a href="#l12.287"></a><span id="l12.287">     this.stopped.delete(id);</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineat">@@ -237,25 +286,32 @@ this.BootstrapMonitor = {</span>
<a href="#l12.289"></a><span id="l12.289">       this.installPromises.push(resolve);</span>
<a href="#l12.290"></a><span id="l12.290">     });</span>
<a href="#l12.291"></a><span id="l12.291">   },</span>
<a href="#l12.292"></a><span id="l12.292"> </span>
<a href="#l12.293"></a><span id="l12.293">   checkMatches(cached, current) {</span>
<a href="#l12.294"></a><span id="l12.294">     Assert.notEqual(cached, undefined);</span>
<a href="#l12.295"></a><span id="l12.295">     Assert.equal(current.data.version, cached.data.version);</span>
<a href="#l12.296"></a><span id="l12.296">     Assert.equal(current.data.installPath, cached.data.installPath);</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineminus">-    Assert.ok(Services.io.newURI(current.data.resourceURI).equals(Services.io.newURI(cached.data.resourceURI)),</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-              `Resource URIs match: &quot;${current.data.resourceURI}&quot; == &quot;${cached.data.resourceURI}&quot;`);</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+    Assert.ok(</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+      Services.io</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+        .newURI(current.data.resourceURI)</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+        .equals(Services.io.newURI(cached.data.resourceURI)),</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+      `Resource URIs match: &quot;${current.data.resourceURI}&quot; == &quot;${</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+        cached.data.resourceURI</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+      }&quot;`</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+    );</span>
<a href="#l12.307"></a><span id="l12.307">   },</span>
<a href="#l12.308"></a><span id="l12.308"> </span>
<a href="#l12.309"></a><span id="l12.309">   checkAddonStarted(id, version = undefined) {</span>
<a href="#l12.310"></a><span id="l12.310">     let started = this.started.get(id);</span>
<a href="#l12.311"></a><span id="l12.311">     Assert.notEqual(started, undefined);</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-    if (version != undefined)</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+    if (version != undefined) {</span>
<a href="#l12.314"></a><span id="l12.314">       Assert.equal(started.data.version, version);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+    }</span>
<a href="#l12.316"></a><span id="l12.316"> </span>
<a href="#l12.317"></a><span id="l12.317">     // Chrome should be registered by now</span>
<a href="#l12.318"></a><span id="l12.318">     // Get the install path from the resource URI, since it is not passed any longer.</span>
<a href="#l12.319"></a><span id="l12.319">     let uri = Services.io.newURI(started.data.resourceURI);</span>
<a href="#l12.320"></a><span id="l12.320">     let jarFile = uri.QueryInterface(Ci.nsIJARURI).JARFile;</span>
<a href="#l12.321"></a><span id="l12.321">     let installPath = jarFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l12.322"></a><span id="l12.322"> </span>
<a href="#l12.323"></a><span id="l12.323">     let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineat">@@ -299,18 +355,19 @@ this.BootstrapMonitor = {</span>
<a href="#l12.325"></a><span id="l12.325">     }</span>
<a href="#l12.326"></a><span id="l12.326"> </span>
<a href="#l12.327"></a><span id="l12.327">     // If this is the install event the add-ons shouldn't already be installed</span>
<a href="#l12.328"></a><span id="l12.328">     if (info.event == &quot;install&quot;) {</span>
<a href="#l12.329"></a><span id="l12.329">       this.checkAddonNotInstalled(id);</span>
<a href="#l12.330"></a><span id="l12.330"> </span>
<a href="#l12.331"></a><span id="l12.331">       this.installed.set(id, info);</span>
<a href="#l12.332"></a><span id="l12.332"> </span>
<a href="#l12.333"></a><span id="l12.333" class="difflineminus">-      for (let resolve of this.installPromises)</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+      for (let resolve of this.installPromises) {</span>
<a href="#l12.335"></a><span id="l12.335">         resolve();</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+      }</span>
<a href="#l12.337"></a><span id="l12.337">       this.installPromises = [];</span>
<a href="#l12.338"></a><span id="l12.338">     } else {</span>
<a href="#l12.339"></a><span id="l12.339">       this.checkMatches(this.installed.get(id), info);</span>
<a href="#l12.340"></a><span id="l12.340">     }</span>
<a href="#l12.341"></a><span id="l12.341"> </span>
<a href="#l12.342"></a><span id="l12.342">     // If this is the shutdown event than the add-on should already be started</span>
<a href="#l12.343"></a><span id="l12.343">     if (info.event == &quot;shutdown&quot;) {</span>
<a href="#l12.344"></a><span id="l12.344">       this.checkMatches(this.started.get(id), info);</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineat">@@ -320,18 +377,19 @@ this.BootstrapMonitor = {</span>
<a href="#l12.346"></a><span id="l12.346"> </span>
<a href="#l12.347"></a><span id="l12.347">       // Chrome should still be registered at this point</span>
<a href="#l12.348"></a><span id="l12.348">       let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l12.349"></a><span id="l12.349">       Assert.ok(isRegistered);</span>
<a href="#l12.350"></a><span id="l12.350"> </span>
<a href="#l12.351"></a><span id="l12.351">       // XPIProvider doesn't bother unregistering chrome on app shutdown but</span>
<a href="#l12.352"></a><span id="l12.352">       // since we simulate restarts we must do so manually to keep the registry</span>
<a href="#l12.353"></a><span id="l12.353">       // consistent.</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineminus">-      if (info.reason == 2 /* APP_SHUTDOWN */)</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+      if (info.reason == 2 /* APP_SHUTDOWN */) {</span>
<a href="#l12.356"></a><span id="l12.356">         Components.manager.removeBootstrappedManifestLocation(installPath);</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+      }</span>
<a href="#l12.358"></a><span id="l12.358">     } else {</span>
<a href="#l12.359"></a><span id="l12.359">       this.checkAddonNotStarted(id);</span>
<a href="#l12.360"></a><span id="l12.360">     }</span>
<a href="#l12.361"></a><span id="l12.361"> </span>
<a href="#l12.362"></a><span id="l12.362">     if (info.event == &quot;uninstall&quot;) {</span>
<a href="#l12.363"></a><span id="l12.363">       // We currently support registering, but not unregistering,</span>
<a href="#l12.364"></a><span id="l12.364">       // restartful add-on manifests during xpcshell AOM &quot;restarts&quot;.</span>
<a href="#l12.365"></a><span id="l12.365">       if (!this.restartfulIds.has(id)) {</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineat">@@ -344,18 +402,19 @@ this.BootstrapMonitor = {</span>
<a href="#l12.367"></a><span id="l12.367">       this.uninstalled.set(id, info);</span>
<a href="#l12.368"></a><span id="l12.368">     } else if (info.event == &quot;startup&quot;) {</span>
<a href="#l12.369"></a><span id="l12.369">       this.started.set(id, info);</span>
<a href="#l12.370"></a><span id="l12.370"> </span>
<a href="#l12.371"></a><span id="l12.371">       // Chrome should be registered at this point</span>
<a href="#l12.372"></a><span id="l12.372">       let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l12.373"></a><span id="l12.373">       Assert.ok(isRegistered);</span>
<a href="#l12.374"></a><span id="l12.374"> </span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-      for (let resolve of this.startupPromises)</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+      for (let resolve of this.startupPromises) {</span>
<a href="#l12.377"></a><span id="l12.377">         resolve();</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+      }</span>
<a href="#l12.379"></a><span id="l12.379">       this.startupPromises = [];</span>
<a href="#l12.380"></a><span id="l12.380">     }</span>
<a href="#l12.381"></a><span id="l12.381">   },</span>
<a href="#l12.382"></a><span id="l12.382"> };</span>
<a href="#l12.383"></a><span id="l12.383"> </span>
<a href="#l12.384"></a><span id="l12.384"> AddonTestUtils.on(&quot;addon-manager-shutdown&quot;, () =&gt; {</span>
<a href="#l12.385"></a><span id="l12.385">   BootstrapMonitor.shutdownCheck();</span>
<a href="#l12.386"></a><span id="l12.386">   Cu.unload(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineat">@@ -370,135 +429,170 @@ var SlightlyLessDodgyBootstrapMonitor = </span>
<a href="#l12.388"></a><span id="l12.388">   init() {</span>
<a href="#l12.389"></a><span id="l12.389">     this.onEvent = this.onEvent.bind(this);</span>
<a href="#l12.390"></a><span id="l12.390"> </span>
<a href="#l12.391"></a><span id="l12.391">     AddonTestUtils.on(&quot;addon-manager-shutdown&quot;, this.onEvent);</span>
<a href="#l12.392"></a><span id="l12.392">     AddonTestUtils.on(&quot;bootstrap-method&quot;, this.onEvent);</span>
<a href="#l12.393"></a><span id="l12.393">   },</span>
<a href="#l12.394"></a><span id="l12.394"> </span>
<a href="#l12.395"></a><span id="l12.395">   shutdownCheck() {</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineminus">-    equal(this.started.size, 0,</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineminus">-          &quot;Should have no add-ons that were started but not shutdown&quot;);</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+    equal(</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+      this.started.size,</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+      0,</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+      &quot;Should have no add-ons that were started but not shutdown&quot;</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+    );</span>
<a href="#l12.403"></a><span id="l12.403">   },</span>
<a href="#l12.404"></a><span id="l12.404"> </span>
<a href="#l12.405"></a><span id="l12.405">   onEvent(msg, data) {</span>
<a href="#l12.406"></a><span id="l12.406">     switch (msg) {</span>
<a href="#l12.407"></a><span id="l12.407">       case &quot;addon-manager-shutdown&quot;:</span>
<a href="#l12.408"></a><span id="l12.408">         this.shutdownCheck();</span>
<a href="#l12.409"></a><span id="l12.409">         break;</span>
<a href="#l12.410"></a><span id="l12.410">       case &quot;bootstrap-method&quot;:</span>
<a href="#l12.411"></a><span id="l12.411">         this.onBootstrapMethod(data.method, data.params, data.reason);</span>
<a href="#l12.412"></a><span id="l12.412">         break;</span>
<a href="#l12.413"></a><span id="l12.413">     }</span>
<a href="#l12.414"></a><span id="l12.414">   },</span>
<a href="#l12.415"></a><span id="l12.415"> </span>
<a href="#l12.416"></a><span id="l12.416">   onBootstrapMethod(method, params, reason) {</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-    let {id} = params;</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+    let { id } = params;</span>
<a href="#l12.419"></a><span id="l12.419"> </span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-    info(`Bootstrap method ${method} for ${params.id} version ${params.version}`);</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+    info(</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineplus">+      `Bootstrap method ${method} for ${params.id} version ${params.version}`</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+    );</span>
<a href="#l12.424"></a><span id="l12.424"> </span>
<a href="#l12.425"></a><span id="l12.425">     if (method !== &quot;install&quot;) {</span>
<a href="#l12.426"></a><span id="l12.426">       this.checkInstalled(id);</span>
<a href="#l12.427"></a><span id="l12.427">     }</span>
<a href="#l12.428"></a><span id="l12.428"> </span>
<a href="#l12.429"></a><span id="l12.429">     switch (method) {</span>
<a href="#l12.430"></a><span id="l12.430">       case &quot;install&quot;:</span>
<a href="#l12.431"></a><span id="l12.431">         this.checkNotInstalled(id);</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineminus">-        this.installed.set(id, {reason, params});</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+        this.installed.set(id, { reason, params });</span>
<a href="#l12.434"></a><span id="l12.434">         this.uninstalled.delete(id);</span>
<a href="#l12.435"></a><span id="l12.435">         break;</span>
<a href="#l12.436"></a><span id="l12.436">       case &quot;startup&quot;:</span>
<a href="#l12.437"></a><span id="l12.437">         this.checkNotStarted(id);</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineminus">-        this.started.set(id, {reason, params});</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+        this.started.set(id, { reason, params });</span>
<a href="#l12.440"></a><span id="l12.440">         this.stopped.delete(id);</span>
<a href="#l12.441"></a><span id="l12.441">         break;</span>
<a href="#l12.442"></a><span id="l12.442">       case &quot;shutdown&quot;:</span>
<a href="#l12.443"></a><span id="l12.443">         this.checkMatches(&quot;shutdown&quot;, &quot;startup&quot;, params, this.started.get(id));</span>
<a href="#l12.444"></a><span id="l12.444">         this.checkStarted(id);</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineminus">-        this.stopped.set(id, {reason, params});</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+        this.stopped.set(id, { reason, params });</span>
<a href="#l12.447"></a><span id="l12.447">         this.started.delete(id);</span>
<a href="#l12.448"></a><span id="l12.448">         break;</span>
<a href="#l12.449"></a><span id="l12.449">       case &quot;uninstall&quot;:</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineminus">-        this.checkMatches(&quot;uninstall&quot;, &quot;install&quot;, params, this.installed.get(id));</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-        this.uninstalled.set(id, {reason, params});</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+        this.checkMatches(</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineplus">+          &quot;uninstall&quot;,</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineplus">+          &quot;install&quot;,</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineplus">+          params,</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineplus">+          this.installed.get(id)</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineplus">+        );</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+        this.uninstalled.set(id, { reason, params });</span>
<a href="#l12.459"></a><span id="l12.459">         this.installed.delete(id);</span>
<a href="#l12.460"></a><span id="l12.460">         break;</span>
<a href="#l12.461"></a><span id="l12.461">       case &quot;update&quot;:</span>
<a href="#l12.462"></a><span id="l12.462">         this.checkMatches(&quot;update&quot;, &quot;install&quot;, params, this.installed.get(id));</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineminus">-        this.installed.set(id, {reason, params});</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineplus">+        this.installed.set(id, { reason, params });</span>
<a href="#l12.465"></a><span id="l12.465">         break;</span>
<a href="#l12.466"></a><span id="l12.466">     }</span>
<a href="#l12.467"></a><span id="l12.467">   },</span>
<a href="#l12.468"></a><span id="l12.468"> </span>
<a href="#l12.469"></a><span id="l12.469">   clear(id) {</span>
<a href="#l12.470"></a><span id="l12.470">     this.installed.delete(id);</span>
<a href="#l12.471"></a><span id="l12.471">     this.started.delete(id);</span>
<a href="#l12.472"></a><span id="l12.472">     this.stopped.delete(id);</span>
<a href="#l12.473"></a><span id="l12.473">     this.uninstalled.delete(id);</span>
<a href="#l12.474"></a><span id="l12.474">   },</span>
<a href="#l12.475"></a><span id="l12.475"> </span>
<a href="#l12.476"></a><span id="l12.476" class="difflineminus">-  checkMatches(method, lastMethod, params, {params: lastParams} = {}) {</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-    ok(lastParams,</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-       `Expecting matching ${lastMethod} call for add-on ${params.id} ${method} call`);</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineplus">+  checkMatches(method, lastMethod, params, { params: lastParams } = {}) {</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineplus">+    ok(</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+      lastParams,</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineplus">+      `Expecting matching ${lastMethod} call for add-on ${</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineplus">+        params.id</span>
<a href="#l12.484"></a><span id="l12.484" class="difflineplus">+      } ${method} call`</span>
<a href="#l12.485"></a><span id="l12.485" class="difflineplus">+    );</span>
<a href="#l12.486"></a><span id="l12.486"> </span>
<a href="#l12.487"></a><span id="l12.487">     if (method == &quot;update&quot;) {</span>
<a href="#l12.488"></a><span id="l12.488" class="difflineminus">-      equal(params.oldVersion, lastParams.version,</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineminus">-            &quot;params.version should match last call&quot;);</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineplus">+      equal(</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineplus">+        params.oldVersion,</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineplus">+        lastParams.version,</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+        &quot;params.version should match last call&quot;</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+      );</span>
<a href="#l12.495"></a><span id="l12.495">     } else {</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineminus">-      equal(params.version, lastParams.version,</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-            &quot;params.version should match last call&quot;);</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineplus">+      equal(</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineplus">+        params.version,</span>
<a href="#l12.500"></a><span id="l12.500" class="difflineplus">+        lastParams.version,</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineplus">+        &quot;params.version should match last call&quot;</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineplus">+      );</span>
<a href="#l12.503"></a><span id="l12.503">     }</span>
<a href="#l12.504"></a><span id="l12.504"> </span>
<a href="#l12.505"></a><span id="l12.505">     if (method !== &quot;update&quot; &amp;&amp; method !== &quot;uninstall&quot;) {</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-      equal(params.installPath.path, lastParams.installPath.path,</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineminus">-            `params.installPath should match last call`);</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineplus">+      equal(</span>
<a href="#l12.509"></a><span id="l12.509" class="difflineplus">+        params.installPath.path,</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineplus">+        lastParams.installPath.path,</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineplus">+        `params.installPath should match last call`</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineplus">+      );</span>
<a href="#l12.513"></a><span id="l12.513"> </span>
<a href="#l12.514"></a><span id="l12.514" class="difflineminus">-      ok(params.resourceURI.equals(lastParams.resourceURI),</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineminus">-         `params.resourceURI should match: &quot;${params.resourceURI.spec}&quot; == &quot;${lastParams.resourceURI.spec}&quot;`);</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineplus">+      ok(</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineplus">+        params.resourceURI.equals(lastParams.resourceURI),</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineplus">+        `params.resourceURI should match: &quot;${params.resourceURI.spec}&quot; == &quot;${</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineplus">+          lastParams.resourceURI.spec</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineplus">+        }&quot;`</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineplus">+      );</span>
<a href="#l12.522"></a><span id="l12.522">     }</span>
<a href="#l12.523"></a><span id="l12.523">   },</span>
<a href="#l12.524"></a><span id="l12.524"> </span>
<a href="#l12.525"></a><span id="l12.525">   checkStarted(id, version = undefined) {</span>
<a href="#l12.526"></a><span id="l12.526">     let started = this.started.get(id);</span>
<a href="#l12.527"></a><span id="l12.527">     ok(started, `Should have seen startup method call for ${id}`);</span>
<a href="#l12.528"></a><span id="l12.528"> </span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-    if (version !== undefined)</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineminus">-      equal(started.params.version, version,</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineminus">-            &quot;Expected version number&quot;);</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+    if (version !== undefined) {</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineplus">+      equal(started.params.version, version, &quot;Expected version number&quot;);</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineplus">+    }</span>
<a href="#l12.535"></a><span id="l12.535">   },</span>
<a href="#l12.536"></a><span id="l12.536"> </span>
<a href="#l12.537"></a><span id="l12.537">   checkNotStarted(id) {</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineminus">-    ok(!this.started.has(id),</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineminus">-       `Should not have seen startup method call for ${id}`);</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineplus">+    ok(</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineplus">+      !this.started.has(id),</span>
<a href="#l12.542"></a><span id="l12.542" class="difflineplus">+      `Should not have seen startup method call for ${id}`</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineplus">+    );</span>
<a href="#l12.544"></a><span id="l12.544">   },</span>
<a href="#l12.545"></a><span id="l12.545"> </span>
<a href="#l12.546"></a><span id="l12.546">   checkInstalled(id, version = undefined) {</span>
<a href="#l12.547"></a><span id="l12.547">     const installed = this.installed.get(id);</span>
<a href="#l12.548"></a><span id="l12.548">     ok(installed, `Should have seen install call for ${id}`);</span>
<a href="#l12.549"></a><span id="l12.549"> </span>
<a href="#l12.550"></a><span id="l12.550" class="difflineminus">-    if (version !== undefined)</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineminus">-      equal(installed.params.version, version,</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineminus">-            &quot;Expected version number&quot;);</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineplus">+    if (version !== undefined) {</span>
<a href="#l12.554"></a><span id="l12.554" class="difflineplus">+      equal(installed.params.version, version, &quot;Expected version number&quot;);</span>
<a href="#l12.555"></a><span id="l12.555" class="difflineplus">+    }</span>
<a href="#l12.556"></a><span id="l12.556"> </span>
<a href="#l12.557"></a><span id="l12.557">     return installed;</span>
<a href="#l12.558"></a><span id="l12.558">   },</span>
<a href="#l12.559"></a><span id="l12.559"> </span>
<a href="#l12.560"></a><span id="l12.560">   checkNotInstalled(id) {</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineminus">-    ok(!this.installed.has(id),</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineminus">-       `Should not have seen install method call for ${id}`);</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+    ok(</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineplus">+      !this.installed.has(id),</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineplus">+      `Should not have seen install method call for ${id}`</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+    );</span>
<a href="#l12.567"></a><span id="l12.567">   },</span>
<a href="#l12.568"></a><span id="l12.568"> };</span>
<a href="#l12.569"></a><span id="l12.569"> </span>
<a href="#l12.570"></a><span id="l12.570"> function isNightlyChannel() {</span>
<a href="#l12.571"></a><span id="l12.571">   var channel = Services.prefs.getCharPref(&quot;app.update.channel&quot;, &quot;default&quot;);</span>
<a href="#l12.572"></a><span id="l12.572"> </span>
<a href="#l12.573"></a><span id="l12.573" class="difflineminus">-  return channel != &quot;aurora&quot; &amp;&amp; channel != &quot;beta&quot; &amp;&amp; channel != &quot;release&quot; &amp;&amp; channel != &quot;esr&quot;;</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+  return (</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineplus">+    channel != &quot;aurora&quot; &amp;&amp;</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineplus">+    channel != &quot;beta&quot; &amp;&amp;</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+    channel != &quot;release&quot; &amp;&amp;</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineplus">+    channel != &quot;esr&quot;</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineplus">+  );</span>
<a href="#l12.580"></a><span id="l12.580"> }</span>
<a href="#l12.581"></a><span id="l12.581"> </span>
<a href="#l12.582"></a><span id="l12.582" class="difflineminus">-</span>
<a href="#l12.583"></a><span id="l12.583"> async function restartWithLocales(locales) {</span>
<a href="#l12.584"></a><span id="l12.584">   Services.locale.requestedLocales = locales;</span>
<a href="#l12.585"></a><span id="l12.585">   await promiseRestartManager();</span>
<a href="#l12.586"></a><span id="l12.586"> }</span>
<a href="#l12.587"></a><span id="l12.587"> </span>
<a href="#l12.588"></a><span id="l12.588"> /**</span>
<a href="#l12.589"></a><span id="l12.589">  * Returns a map of Addon objects for installed add-ons with the given</span>
<a href="#l12.590"></a><span id="l12.590">  * IDs. The returned map contains a key for the ID of each add-on that</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineat">@@ -535,17 +629,21 @@ function checkAddon(id, addon, expected)</span>
<a href="#l12.592"></a><span id="l12.592">   info(`Checking state of addon ${id}`);</span>
<a href="#l12.593"></a><span id="l12.593"> </span>
<a href="#l12.594"></a><span id="l12.594">   if (expected === null) {</span>
<a href="#l12.595"></a><span id="l12.595">     ok(!addon, `Addon ${id} should not exist`);</span>
<a href="#l12.596"></a><span id="l12.596">   } else {</span>
<a href="#l12.597"></a><span id="l12.597">     ok(addon, `Addon ${id} should exist`);</span>
<a href="#l12.598"></a><span id="l12.598">     for (let [key, value] of Object.entries(expected)) {</span>
<a href="#l12.599"></a><span id="l12.599">       if (value instanceof Ci.nsIURI) {</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineminus">-        equal(addon[key] &amp;&amp; addon[key].spec, value.spec, `Expected value of addon.${key}`);</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineplus">+        equal(</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineplus">+          addon[key] &amp;&amp; addon[key].spec,</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineplus">+          value.spec,</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineplus">+          `Expected value of addon.${key}`</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineplus">+        );</span>
<a href="#l12.606"></a><span id="l12.606">       } else {</span>
<a href="#l12.607"></a><span id="l12.607">         deepEqual(addon[key], value, `Expected value of addon.${key}`);</span>
<a href="#l12.608"></a><span id="l12.608">       }</span>
<a href="#l12.609"></a><span id="l12.609">     }</span>
<a href="#l12.610"></a><span id="l12.610">   }</span>
<a href="#l12.611"></a><span id="l12.611"> }</span>
<a href="#l12.612"></a><span id="l12.612"> </span>
<a href="#l12.613"></a><span id="l12.613"> /**</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineat">@@ -563,17 +661,21 @@ function do_check_in_crash_annotation(aI</span>
<a href="#l12.615"></a><span id="l12.615">   }</span>
<a href="#l12.616"></a><span id="l12.616"> </span>
<a href="#l12.617"></a><span id="l12.617">   if (!(&quot;Add-ons&quot; in gAppInfo.annotations)) {</span>
<a href="#l12.618"></a><span id="l12.618">     Assert.ok(false, &quot;Cannot find Add-ons entry in crash annotations&quot;);</span>
<a href="#l12.619"></a><span id="l12.619">     return;</span>
<a href="#l12.620"></a><span id="l12.620">   }</span>
<a href="#l12.621"></a><span id="l12.621"> </span>
<a href="#l12.622"></a><span id="l12.622">   let addons = gAppInfo.annotations[&quot;Add-ons&quot;].split(&quot;,&quot;);</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineminus">-  Assert.ok(addons.includes(`${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`));</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+  Assert.ok(</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineplus">+    addons.includes(</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineplus">+      `${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineplus">+    )</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineplus">+  );</span>
<a href="#l12.629"></a><span id="l12.629"> }</span>
<a href="#l12.630"></a><span id="l12.630"> </span>
<a href="#l12.631"></a><span id="l12.631"> /**</span>
<a href="#l12.632"></a><span id="l12.632">  * Tests that an add-on does not appear in the crash report annotations, if</span>
<a href="#l12.633"></a><span id="l12.633">  * crash reporting is enabled. The test will fail if the add-on is in the</span>
<a href="#l12.634"></a><span id="l12.634">  * annotation.</span>
<a href="#l12.635"></a><span id="l12.635">  * @param  aId</span>
<a href="#l12.636"></a><span id="l12.636">  *         The ID of the add-on</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineat">@@ -586,28 +688,35 @@ function do_check_not_in_crash_annotatio</span>
<a href="#l12.638"></a><span id="l12.638">   }</span>
<a href="#l12.639"></a><span id="l12.639"> </span>
<a href="#l12.640"></a><span id="l12.640">   if (!(&quot;Add-ons&quot; in gAppInfo.annotations)) {</span>
<a href="#l12.641"></a><span id="l12.641">     Assert.ok(true);</span>
<a href="#l12.642"></a><span id="l12.642">     return;</span>
<a href="#l12.643"></a><span id="l12.643">   }</span>
<a href="#l12.644"></a><span id="l12.644"> </span>
<a href="#l12.645"></a><span id="l12.645">   let addons = gAppInfo.annotations[&quot;Add-ons&quot;].split(&quot;,&quot;);</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineminus">-  Assert.ok(!addons.includes(`${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`));</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineplus">+  Assert.ok(</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+    !addons.includes(</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineplus">+      `${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineplus">+    )</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+  );</span>
<a href="#l12.652"></a><span id="l12.652"> }</span>
<a href="#l12.653"></a><span id="l12.653"> </span>
<a href="#l12.654"></a><span id="l12.654"> function do_get_file_hash(aFile, aAlgorithm) {</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineminus">-  if (!aAlgorithm)</span>
<a href="#l12.656"></a><span id="l12.656" class="difflineplus">+  if (!aAlgorithm) {</span>
<a href="#l12.657"></a><span id="l12.657">     aAlgorithm = &quot;sha1&quot;;</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineplus">+  }</span>
<a href="#l12.659"></a><span id="l12.659"> </span>
<a href="#l12.660"></a><span id="l12.660" class="difflineminus">-  let crypto = Cc[&quot;@mozilla.org/security/hash;1&quot;].</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineminus">-               createInstance(Ci.nsICryptoHash);</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineplus">+  let crypto = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineplus">+    Ci.nsICryptoHash</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineplus">+  );</span>
<a href="#l12.665"></a><span id="l12.665">   crypto.initWithString(aAlgorithm);</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-  let fis = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-            createInstance(Ci.nsIFileInputStream);</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+  let fis = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].createInstance(</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineplus">+    Ci.nsIFileInputStream</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineplus">+  );</span>
<a href="#l12.671"></a><span id="l12.671">   fis.init(aFile, -1, -1, false);</span>
<a href="#l12.672"></a><span id="l12.672">   crypto.updateFromStream(fis, aFile.fileSize);</span>
<a href="#l12.673"></a><span id="l12.673"> </span>
<a href="#l12.674"></a><span id="l12.674">   // return the two-digit hexadecimal code for a byte</span>
<a href="#l12.675"></a><span id="l12.675">   let toHexString = charCode =&gt; (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l12.676"></a><span id="l12.676"> </span>
<a href="#l12.677"></a><span id="l12.677">   let binary = crypto.finish(false);</span>
<a href="#l12.678"></a><span id="l12.678">   let hash = Array.from(binary, c =&gt; toHexString(c.charCodeAt(0)));</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineat">@@ -627,18 +736,19 @@ function do_get_addon_root_uri(aProfileD</span>
<a href="#l12.680"></a><span id="l12.680">   if (!path.exists()) {</span>
<a href="#l12.681"></a><span id="l12.681">     path.leafName += &quot;.xpi&quot;;</span>
<a href="#l12.682"></a><span id="l12.682">     return &quot;jar:&quot; + Services.io.newFileURI(path).spec + &quot;!/&quot;;</span>
<a href="#l12.683"></a><span id="l12.683">   }</span>
<a href="#l12.684"></a><span id="l12.684">   return Services.io.newFileURI(path).spec;</span>
<a href="#l12.685"></a><span id="l12.685"> }</span>
<a href="#l12.686"></a><span id="l12.686"> </span>
<a href="#l12.687"></a><span id="l12.687"> function do_get_expected_addon_name(aId) {</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineminus">-  if (TEST_UNPACKED)</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+  if (TEST_UNPACKED) {</span>
<a href="#l12.690"></a><span id="l12.690">     return aId;</span>
<a href="#l12.691"></a><span id="l12.691" class="difflineplus">+  }</span>
<a href="#l12.692"></a><span id="l12.692">   return aId + &quot;.xpi&quot;;</span>
<a href="#l12.693"></a><span id="l12.693"> }</span>
<a href="#l12.694"></a><span id="l12.694"> </span>
<a href="#l12.695"></a><span id="l12.695"> /**</span>
<a href="#l12.696"></a><span id="l12.696">  * Check that an array of actual add-ons is the same as an array of</span>
<a href="#l12.697"></a><span id="l12.697">  * expected add-ons.</span>
<a href="#l12.698"></a><span id="l12.698">  *</span>
<a href="#l12.699"></a><span id="l12.699">  * @param  aActualAddons</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineat">@@ -646,18 +756,19 @@ function do_get_expected_addon_name(aId)</span>
<a href="#l12.701"></a><span id="l12.701">  * @param  aExpectedAddons</span>
<a href="#l12.702"></a><span id="l12.702">  *         The array of expected add-ons to check against.</span>
<a href="#l12.703"></a><span id="l12.703">  * @param  aProperties</span>
<a href="#l12.704"></a><span id="l12.704">  *         An array of properties to check.</span>
<a href="#l12.705"></a><span id="l12.705">  */</span>
<a href="#l12.706"></a><span id="l12.706"> function do_check_addons(aActualAddons, aExpectedAddons, aProperties) {</span>
<a href="#l12.707"></a><span id="l12.707">   Assert.notEqual(aActualAddons, null);</span>
<a href="#l12.708"></a><span id="l12.708">   Assert.equal(aActualAddons.length, aExpectedAddons.length);</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineminus">-  for (let i = 0; i &lt; aActualAddons.length; i++)</span>
<a href="#l12.710"></a><span id="l12.710" class="difflineplus">+  for (let i = 0; i &lt; aActualAddons.length; i++) {</span>
<a href="#l12.711"></a><span id="l12.711">     do_check_addon(aActualAddons[i], aExpectedAddons[i], aProperties);</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineplus">+  }</span>
<a href="#l12.713"></a><span id="l12.713"> }</span>
<a href="#l12.714"></a><span id="l12.714"> </span>
<a href="#l12.715"></a><span id="l12.715"> /**</span>
<a href="#l12.716"></a><span id="l12.716">  * Check that the actual add-on is the same as the expected add-on.</span>
<a href="#l12.717"></a><span id="l12.717">  *</span>
<a href="#l12.718"></a><span id="l12.718">  * @param  aActualAddon</span>
<a href="#l12.719"></a><span id="l12.719">  *         The actual add-on to check.</span>
<a href="#l12.720"></a><span id="l12.720">  * @param  aExpectedAddon</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineat">@@ -670,68 +781,93 @@ function do_check_addon(aActualAddon, aE</span>
<a href="#l12.722"></a><span id="l12.722"> </span>
<a href="#l12.723"></a><span id="l12.723">   aProperties.forEach(function(aProperty) {</span>
<a href="#l12.724"></a><span id="l12.724">     let actualValue = aActualAddon[aProperty];</span>
<a href="#l12.725"></a><span id="l12.725">     let expectedValue = aExpectedAddon[aProperty];</span>
<a href="#l12.726"></a><span id="l12.726"> </span>
<a href="#l12.727"></a><span id="l12.727">     // Check that all undefined expected properties are null on actual add-on</span>
<a href="#l12.728"></a><span id="l12.728">     if (!(aProperty in aExpectedAddon)) {</span>
<a href="#l12.729"></a><span id="l12.729">       if (actualValue !== undefined &amp;&amp; actualValue !== null) {</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineminus">-        do_throw(&quot;Unexpected defined/non-null property for add-on &quot; +</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineminus">-                 aExpectedAddon.id + &quot; (addon[&quot; + aProperty + &quot;] = &quot; +</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineminus">-                 actualValue.toSource() + &quot;)&quot;);</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineplus">+        do_throw(</span>
<a href="#l12.734"></a><span id="l12.734" class="difflineplus">+          &quot;Unexpected defined/non-null property for add-on &quot; +</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineplus">+            aExpectedAddon.id +</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineplus">+            &quot; (addon[&quot; +</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineplus">+            aProperty +</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineplus">+            &quot;] = &quot; +</span>
<a href="#l12.739"></a><span id="l12.739" class="difflineplus">+            actualValue.toSource() +</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineplus">+            &quot;)&quot;</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineplus">+        );</span>
<a href="#l12.742"></a><span id="l12.742">       }</span>
<a href="#l12.743"></a><span id="l12.743"> </span>
<a href="#l12.744"></a><span id="l12.744">       return;</span>
<a href="#l12.745"></a><span id="l12.745">     }</span>
<a href="#l12.746"></a><span id="l12.746">     if (expectedValue &amp;&amp; !actualValue) {</span>
<a href="#l12.747"></a><span id="l12.747" class="difflineminus">-      do_throw(&quot;Missing property for add-on &quot; + aExpectedAddon.id +</span>
<a href="#l12.748"></a><span id="l12.748" class="difflineminus">-        &quot;: expected addon[&quot; + aProperty + &quot;] = &quot; + expectedValue);</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineplus">+      do_throw(</span>
<a href="#l12.750"></a><span id="l12.750" class="difflineplus">+        &quot;Missing property for add-on &quot; +</span>
<a href="#l12.751"></a><span id="l12.751" class="difflineplus">+          aExpectedAddon.id +</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineplus">+          &quot;: expected addon[&quot; +</span>
<a href="#l12.753"></a><span id="l12.753" class="difflineplus">+          aProperty +</span>
<a href="#l12.754"></a><span id="l12.754" class="difflineplus">+          &quot;] = &quot; +</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineplus">+          expectedValue</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineplus">+      );</span>
<a href="#l12.757"></a><span id="l12.757">       return;</span>
<a href="#l12.758"></a><span id="l12.758">     }</span>
<a href="#l12.759"></a><span id="l12.759"> </span>
<a href="#l12.760"></a><span id="l12.760">     switch (aProperty) {</span>
<a href="#l12.761"></a><span id="l12.761">       case &quot;creator&quot;:</span>
<a href="#l12.762"></a><span id="l12.762">         do_check_author(actualValue, expectedValue);</span>
<a href="#l12.763"></a><span id="l12.763">         break;</span>
<a href="#l12.764"></a><span id="l12.764"> </span>
<a href="#l12.765"></a><span id="l12.765">       case &quot;developers&quot;:</span>
<a href="#l12.766"></a><span id="l12.766">         Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineminus">-        for (let i = 0; i &lt; actualValue.length; i++)</span>
<a href="#l12.768"></a><span id="l12.768" class="difflineplus">+        for (let i = 0; i &lt; actualValue.length; i++) {</span>
<a href="#l12.769"></a><span id="l12.769">           do_check_author(actualValue[i], expectedValue[i]);</span>
<a href="#l12.770"></a><span id="l12.770" class="difflineplus">+        }</span>
<a href="#l12.771"></a><span id="l12.771">         break;</span>
<a href="#l12.772"></a><span id="l12.772"> </span>
<a href="#l12.773"></a><span id="l12.773">       case &quot;screenshots&quot;:</span>
<a href="#l12.774"></a><span id="l12.774">         Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l12.775"></a><span id="l12.775" class="difflineminus">-        for (let i = 0; i &lt; actualValue.length; i++)</span>
<a href="#l12.776"></a><span id="l12.776" class="difflineplus">+        for (let i = 0; i &lt; actualValue.length; i++) {</span>
<a href="#l12.777"></a><span id="l12.777">           do_check_screenshot(actualValue[i], expectedValue[i]);</span>
<a href="#l12.778"></a><span id="l12.778" class="difflineplus">+        }</span>
<a href="#l12.779"></a><span id="l12.779">         break;</span>
<a href="#l12.780"></a><span id="l12.780"> </span>
<a href="#l12.781"></a><span id="l12.781">       case &quot;sourceURI&quot;:</span>
<a href="#l12.782"></a><span id="l12.782">         Assert.equal(actualValue.spec, expectedValue);</span>
<a href="#l12.783"></a><span id="l12.783">         break;</span>
<a href="#l12.784"></a><span id="l12.784"> </span>
<a href="#l12.785"></a><span id="l12.785">       case &quot;updateDate&quot;:</span>
<a href="#l12.786"></a><span id="l12.786">         Assert.equal(actualValue.getTime(), expectedValue.getTime());</span>
<a href="#l12.787"></a><span id="l12.787">         break;</span>
<a href="#l12.788"></a><span id="l12.788"> </span>
<a href="#l12.789"></a><span id="l12.789">       case &quot;compatibilityOverrides&quot;:</span>
<a href="#l12.790"></a><span id="l12.790">         Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l12.791"></a><span id="l12.791" class="difflineminus">-        for (let i = 0; i &lt; actualValue.length; i++)</span>
<a href="#l12.792"></a><span id="l12.792" class="difflineplus">+        for (let i = 0; i &lt; actualValue.length; i++) {</span>
<a href="#l12.793"></a><span id="l12.793">           do_check_compatibilityoverride(actualValue[i], expectedValue[i]);</span>
<a href="#l12.794"></a><span id="l12.794" class="difflineplus">+        }</span>
<a href="#l12.795"></a><span id="l12.795">         break;</span>
<a href="#l12.796"></a><span id="l12.796"> </span>
<a href="#l12.797"></a><span id="l12.797">       case &quot;icons&quot;:</span>
<a href="#l12.798"></a><span id="l12.798">         do_check_icons(actualValue, expectedValue);</span>
<a href="#l12.799"></a><span id="l12.799">         break;</span>
<a href="#l12.800"></a><span id="l12.800"> </span>
<a href="#l12.801"></a><span id="l12.801">       default:</span>
<a href="#l12.802"></a><span id="l12.802" class="difflineminus">-        if (actualValue !== expectedValue)</span>
<a href="#l12.803"></a><span id="l12.803" class="difflineminus">-          do_throw(&quot;Failed for &quot; + aProperty + &quot; for add-on &quot; + aExpectedAddon.id +</span>
<a href="#l12.804"></a><span id="l12.804" class="difflineminus">-                   &quot; (&quot; + actualValue + &quot; === &quot; + expectedValue + &quot;)&quot;);</span>
<a href="#l12.805"></a><span id="l12.805" class="difflineplus">+        if (actualValue !== expectedValue) {</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineplus">+          do_throw(</span>
<a href="#l12.807"></a><span id="l12.807" class="difflineplus">+            &quot;Failed for &quot; +</span>
<a href="#l12.808"></a><span id="l12.808" class="difflineplus">+              aProperty +</span>
<a href="#l12.809"></a><span id="l12.809" class="difflineplus">+              &quot; for add-on &quot; +</span>
<a href="#l12.810"></a><span id="l12.810" class="difflineplus">+              aExpectedAddon.id +</span>
<a href="#l12.811"></a><span id="l12.811" class="difflineplus">+              &quot; (&quot; +</span>
<a href="#l12.812"></a><span id="l12.812" class="difflineplus">+              actualValue +</span>
<a href="#l12.813"></a><span id="l12.813" class="difflineplus">+              &quot; === &quot; +</span>
<a href="#l12.814"></a><span id="l12.814" class="difflineplus">+              expectedValue +</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineplus">+              &quot;)&quot;</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineplus">+          );</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineplus">+        }</span>
<a href="#l12.818"></a><span id="l12.818">     }</span>
<a href="#l12.819"></a><span id="l12.819">   });</span>
<a href="#l12.820"></a><span id="l12.820"> }</span>
<a href="#l12.821"></a><span id="l12.821"> </span>
<a href="#l12.822"></a><span id="l12.822"> /**</span>
<a href="#l12.823"></a><span id="l12.823">  * Check that the actual author is the same as the expected author.</span>
<a href="#l12.824"></a><span id="l12.824">  *</span>
<a href="#l12.825"></a><span id="l12.825">  * @param  aActual</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineat">@@ -803,17 +939,21 @@ function isExtensionInBootstrappedList(a</span>
<a href="#l12.827"></a><span id="l12.827">  * @param   aManifest</span>
<a href="#l12.828"></a><span id="l12.828">  *          The data to write</span>
<a href="#l12.829"></a><span id="l12.829">  * @param   aDir</span>
<a href="#l12.830"></a><span id="l12.830">  *          The install directory to add the extension to</span>
<a href="#l12.831"></a><span id="l12.831">  * @param   aId</span>
<a href="#l12.832"></a><span id="l12.832">  *          An optional string to override the default installation aId</span>
<a href="#l12.833"></a><span id="l12.833">  * @return  A file pointing to where the extension was installed</span>
<a href="#l12.834"></a><span id="l12.834">  */</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineminus">-function promiseWriteWebManifestForExtension(aData, aDir, aId = aData.applications.gecko.id) {</span>
<a href="#l12.836"></a><span id="l12.836" class="difflineplus">+function promiseWriteWebManifestForExtension(</span>
<a href="#l12.837"></a><span id="l12.837" class="difflineplus">+  aData,</span>
<a href="#l12.838"></a><span id="l12.838" class="difflineplus">+  aDir,</span>
<a href="#l12.839"></a><span id="l12.839" class="difflineplus">+  aId = aData.applications.gecko.id</span>
<a href="#l12.840"></a><span id="l12.840" class="difflineplus">+) {</span>
<a href="#l12.841"></a><span id="l12.841">   let files = {</span>
<a href="#l12.842"></a><span id="l12.842">     &quot;manifest.json&quot;: JSON.stringify(aData),</span>
<a href="#l12.843"></a><span id="l12.843">   };</span>
<a href="#l12.844"></a><span id="l12.844">   return AddonTestUtils.promiseWriteFilesToExtension(aDir.path, aId, files);</span>
<a href="#l12.845"></a><span id="l12.845"> }</span>
<a href="#l12.846"></a><span id="l12.846"> </span>
<a href="#l12.847"></a><span id="l12.847"> /**</span>
<a href="#l12.848"></a><span id="l12.848">  * Creates an XPI file for some manifest data in the temporary directory and</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineat">@@ -822,74 +962,84 @@ function promiseWriteWebManifestForExten</span>
<a href="#l12.850"></a><span id="l12.850">  * @param   aData</span>
<a href="#l12.851"></a><span id="l12.851">  *          The object holding data about the add-on</span>
<a href="#l12.852"></a><span id="l12.852">  * @return  A file pointing to the created XPI file</span>
<a href="#l12.853"></a><span id="l12.853">  */</span>
<a href="#l12.854"></a><span id="l12.854"> function createTempXPIFile(aData, aExtraFile) {</span>
<a href="#l12.855"></a><span id="l12.855">   let files = {</span>
<a href="#l12.856"></a><span id="l12.856">     &quot;install.rdf&quot;: aData,</span>
<a href="#l12.857"></a><span id="l12.857">   };</span>
<a href="#l12.858"></a><span id="l12.858" class="difflineminus">-  if (typeof aExtraFile == &quot;object&quot;)</span>
<a href="#l12.859"></a><span id="l12.859" class="difflineplus">+  if (typeof aExtraFile == &quot;object&quot;) {</span>
<a href="#l12.860"></a><span id="l12.860">     Object.assign(files, aExtraFile);</span>
<a href="#l12.861"></a><span id="l12.861" class="difflineminus">-  else if (aExtraFile)</span>
<a href="#l12.862"></a><span id="l12.862" class="difflineplus">+  } else if (aExtraFile) {</span>
<a href="#l12.863"></a><span id="l12.863">     files[aExtraFile] = &quot;&quot;;</span>
<a href="#l12.864"></a><span id="l12.864" class="difflineplus">+  }</span>
<a href="#l12.865"></a><span id="l12.865"> </span>
<a href="#l12.866"></a><span id="l12.866">   return AddonTestUtils.createTempXPIFile(files);</span>
<a href="#l12.867"></a><span id="l12.867"> }</span>
<a href="#l12.868"></a><span id="l12.868"> </span>
<a href="#l12.869"></a><span id="l12.869"> var gExpectedEvents = {};</span>
<a href="#l12.870"></a><span id="l12.870"> var gExpectedInstalls = [];</span>
<a href="#l12.871"></a><span id="l12.871"> var gNext = null;</span>
<a href="#l12.872"></a><span id="l12.872"> </span>
<a href="#l12.873"></a><span id="l12.873"> function getExpectedEvent(aId) {</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineminus">-  if (!(aId in gExpectedEvents))</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineplus">+  if (!(aId in gExpectedEvents)) {</span>
<a href="#l12.876"></a><span id="l12.876">     do_throw(&quot;Wasn't expecting events for &quot; + aId);</span>
<a href="#l12.877"></a><span id="l12.877" class="difflineminus">-  if (gExpectedEvents[aId].length == 0)</span>
<a href="#l12.878"></a><span id="l12.878" class="difflineplus">+  }</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineplus">+  if (gExpectedEvents[aId].length == 0) {</span>
<a href="#l12.880"></a><span id="l12.880">     do_throw(&quot;Too many events for &quot; + aId);</span>
<a href="#l12.881"></a><span id="l12.881" class="difflineplus">+  }</span>
<a href="#l12.882"></a><span id="l12.882">   let event = gExpectedEvents[aId].shift();</span>
<a href="#l12.883"></a><span id="l12.883" class="difflineminus">-  if (event instanceof Array)</span>
<a href="#l12.884"></a><span id="l12.884" class="difflineplus">+  if (event instanceof Array) {</span>
<a href="#l12.885"></a><span id="l12.885">     return event;</span>
<a href="#l12.886"></a><span id="l12.886" class="difflineplus">+  }</span>
<a href="#l12.887"></a><span id="l12.887">   return [event, true];</span>
<a href="#l12.888"></a><span id="l12.888"> }</span>
<a href="#l12.889"></a><span id="l12.889"> </span>
<a href="#l12.890"></a><span id="l12.890"> function getExpectedInstall(aAddon) {</span>
<a href="#l12.891"></a><span id="l12.891" class="difflineminus">-  if (gExpectedInstalls instanceof Array)</span>
<a href="#l12.892"></a><span id="l12.892" class="difflineplus">+  if (gExpectedInstalls instanceof Array) {</span>
<a href="#l12.893"></a><span id="l12.893">     return gExpectedInstalls.shift();</span>
<a href="#l12.894"></a><span id="l12.894" class="difflineminus">-  if (!aAddon || !aAddon.id)</span>
<a href="#l12.895"></a><span id="l12.895" class="difflineplus">+  }</span>
<a href="#l12.896"></a><span id="l12.896" class="difflineplus">+  if (!aAddon || !aAddon.id) {</span>
<a href="#l12.897"></a><span id="l12.897">     return gExpectedInstalls.NO_ID.shift();</span>
<a href="#l12.898"></a><span id="l12.898" class="difflineplus">+  }</span>
<a href="#l12.899"></a><span id="l12.899">   let id = aAddon.id;</span>
<a href="#l12.900"></a><span id="l12.900" class="difflineminus">-  if (!(id in gExpectedInstalls) || !(gExpectedInstalls[id] instanceof Array))</span>
<a href="#l12.901"></a><span id="l12.901" class="difflineplus">+  if (!(id in gExpectedInstalls) || !(gExpectedInstalls[id] instanceof Array)) {</span>
<a href="#l12.902"></a><span id="l12.902">     do_throw(&quot;Wasn't expecting events for &quot; + id);</span>
<a href="#l12.903"></a><span id="l12.903" class="difflineminus">-  if (gExpectedInstalls[id].length == 0)</span>
<a href="#l12.904"></a><span id="l12.904" class="difflineplus">+  }</span>
<a href="#l12.905"></a><span id="l12.905" class="difflineplus">+  if (gExpectedInstalls[id].length == 0) {</span>
<a href="#l12.906"></a><span id="l12.906">     do_throw(&quot;Too many events for &quot; + id);</span>
<a href="#l12.907"></a><span id="l12.907" class="difflineplus">+  }</span>
<a href="#l12.908"></a><span id="l12.908">   return gExpectedInstalls[id].shift();</span>
<a href="#l12.909"></a><span id="l12.909"> }</span>
<a href="#l12.910"></a><span id="l12.910"> </span>
<a href="#l12.911"></a><span id="l12.911"> const AddonListener = {</span>
<a href="#l12.912"></a><span id="l12.912">   onPropertyChanged(aAddon, aProperties) {</span>
<a href="#l12.913"></a><span id="l12.913">     info(`Got onPropertyChanged event for ${aAddon.id}`);</span>
<a href="#l12.914"></a><span id="l12.914">     let [event, properties] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.915"></a><span id="l12.915">     Assert.equal(&quot;onPropertyChanged&quot;, event);</span>
<a href="#l12.916"></a><span id="l12.916">     Assert.equal(aProperties.length, properties.length);</span>
<a href="#l12.917"></a><span id="l12.917">     properties.forEach(function(aProperty) {</span>
<a href="#l12.918"></a><span id="l12.918">       // Only test that the expected properties are listed, having additional</span>
<a href="#l12.919"></a><span id="l12.919">       // properties listed is not necessary a problem</span>
<a href="#l12.920"></a><span id="l12.920" class="difflineminus">-      if (!aProperties.includes(aProperty))</span>
<a href="#l12.921"></a><span id="l12.921" class="difflineplus">+      if (!aProperties.includes(aProperty)) {</span>
<a href="#l12.922"></a><span id="l12.922">         do_throw(&quot;Did not see property change for &quot; + aProperty);</span>
<a href="#l12.923"></a><span id="l12.923" class="difflineplus">+      }</span>
<a href="#l12.924"></a><span id="l12.924">     });</span>
<a href="#l12.925"></a><span id="l12.925">     return check_test_completed(arguments);</span>
<a href="#l12.926"></a><span id="l12.926">   },</span>
<a href="#l12.927"></a><span id="l12.927"> </span>
<a href="#l12.928"></a><span id="l12.928">   onEnabling(aAddon, aRequiresRestart) {</span>
<a href="#l12.929"></a><span id="l12.929">     info(`Got onEnabling event for ${aAddon.id}`);</span>
<a href="#l12.930"></a><span id="l12.930">     let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.931"></a><span id="l12.931">     Assert.equal(&quot;onEnabling&quot;, event);</span>
<a href="#l12.932"></a><span id="l12.932">     Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l12.933"></a><span id="l12.933" class="difflineminus">-    if (expectedRestart)</span>
<a href="#l12.934"></a><span id="l12.934" class="difflineplus">+    if (expectedRestart) {</span>
<a href="#l12.935"></a><span id="l12.935">       Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_ENABLE));</span>
<a href="#l12.936"></a><span id="l12.936" class="difflineplus">+    }</span>
<a href="#l12.937"></a><span id="l12.937">     Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_ENABLE));</span>
<a href="#l12.938"></a><span id="l12.938">     return check_test_completed(arguments);</span>
<a href="#l12.939"></a><span id="l12.939">   },</span>
<a href="#l12.940"></a><span id="l12.940"> </span>
<a href="#l12.941"></a><span id="l12.941">   onEnabled(aAddon) {</span>
<a href="#l12.942"></a><span id="l12.942">     info(`Got onEnabled event for ${aAddon.id}`);</span>
<a href="#l12.943"></a><span id="l12.943">     let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.944"></a><span id="l12.944">     Assert.equal(&quot;onEnabled&quot;, event);</span>
<a href="#l12.945"></a><span id="l12.945" class="difflineat">@@ -897,18 +1047,21 @@ const AddonListener = {</span>
<a href="#l12.946"></a><span id="l12.946">     return check_test_completed(arguments);</span>
<a href="#l12.947"></a><span id="l12.947">   },</span>
<a href="#l12.948"></a><span id="l12.948"> </span>
<a href="#l12.949"></a><span id="l12.949">   onDisabling(aAddon, aRequiresRestart) {</span>
<a href="#l12.950"></a><span id="l12.950">     info(`Got onDisabling event for ${aAddon.id}`);</span>
<a href="#l12.951"></a><span id="l12.951">     let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.952"></a><span id="l12.952">     Assert.equal(&quot;onDisabling&quot;, event);</span>
<a href="#l12.953"></a><span id="l12.953">     Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l12.954"></a><span id="l12.954" class="difflineminus">-    if (expectedRestart)</span>
<a href="#l12.955"></a><span id="l12.955" class="difflineminus">-      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_DISABLE));</span>
<a href="#l12.956"></a><span id="l12.956" class="difflineplus">+    if (expectedRestart) {</span>
<a href="#l12.957"></a><span id="l12.957" class="difflineplus">+      Assert.ok(</span>
<a href="#l12.958"></a><span id="l12.958" class="difflineplus">+        hasFlag(aAddon.pendingOperations, AddonManager.PENDING_DISABLE)</span>
<a href="#l12.959"></a><span id="l12.959" class="difflineplus">+      );</span>
<a href="#l12.960"></a><span id="l12.960" class="difflineplus">+    }</span>
<a href="#l12.961"></a><span id="l12.961">     Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_DISABLE));</span>
<a href="#l12.962"></a><span id="l12.962">     return check_test_completed(arguments);</span>
<a href="#l12.963"></a><span id="l12.963">   },</span>
<a href="#l12.964"></a><span id="l12.964"> </span>
<a href="#l12.965"></a><span id="l12.965">   onDisabled(aAddon) {</span>
<a href="#l12.966"></a><span id="l12.966">     info(`Got onDisabled event for ${aAddon.id}`);</span>
<a href="#l12.967"></a><span id="l12.967">     let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.968"></a><span id="l12.968">     Assert.equal(&quot;onDisabled&quot;, event);</span>
<a href="#l12.969"></a><span id="l12.969" class="difflineat">@@ -916,35 +1069,41 @@ const AddonListener = {</span>
<a href="#l12.970"></a><span id="l12.970">     return check_test_completed(arguments);</span>
<a href="#l12.971"></a><span id="l12.971">   },</span>
<a href="#l12.972"></a><span id="l12.972"> </span>
<a href="#l12.973"></a><span id="l12.973">   onInstalling(aAddon, aRequiresRestart) {</span>
<a href="#l12.974"></a><span id="l12.974">     info(`Got onInstalling event for ${aAddon.id}`);</span>
<a href="#l12.975"></a><span id="l12.975">     let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.976"></a><span id="l12.976">     Assert.equal(&quot;onInstalling&quot;, event);</span>
<a href="#l12.977"></a><span id="l12.977">     Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l12.978"></a><span id="l12.978" class="difflineminus">-    if (expectedRestart)</span>
<a href="#l12.979"></a><span id="l12.979" class="difflineminus">-      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_INSTALL));</span>
<a href="#l12.980"></a><span id="l12.980" class="difflineplus">+    if (expectedRestart) {</span>
<a href="#l12.981"></a><span id="l12.981" class="difflineplus">+      Assert.ok(</span>
<a href="#l12.982"></a><span id="l12.982" class="difflineplus">+        hasFlag(aAddon.pendingOperations, AddonManager.PENDING_INSTALL)</span>
<a href="#l12.983"></a><span id="l12.983" class="difflineplus">+      );</span>
<a href="#l12.984"></a><span id="l12.984" class="difflineplus">+    }</span>
<a href="#l12.985"></a><span id="l12.985">     return check_test_completed(arguments);</span>
<a href="#l12.986"></a><span id="l12.986">   },</span>
<a href="#l12.987"></a><span id="l12.987"> </span>
<a href="#l12.988"></a><span id="l12.988">   onInstalled(aAddon) {</span>
<a href="#l12.989"></a><span id="l12.989">     info(`Got onInstalled event for ${aAddon.id}`);</span>
<a href="#l12.990"></a><span id="l12.990">     let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.991"></a><span id="l12.991">     Assert.equal(&quot;onInstalled&quot;, event);</span>
<a href="#l12.992"></a><span id="l12.992">     return check_test_completed(arguments);</span>
<a href="#l12.993"></a><span id="l12.993">   },</span>
<a href="#l12.994"></a><span id="l12.994"> </span>
<a href="#l12.995"></a><span id="l12.995">   onUninstalling(aAddon, aRequiresRestart) {</span>
<a href="#l12.996"></a><span id="l12.996">     info(`Got onUninstalling event for ${aAddon.id}`);</span>
<a href="#l12.997"></a><span id="l12.997">     let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.998"></a><span id="l12.998">     Assert.equal(&quot;onUninstalling&quot;, event);</span>
<a href="#l12.999"></a><span id="l12.999">     Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l12.1000"></a><span id="l12.1000" class="difflineminus">-    if (expectedRestart)</span>
<a href="#l12.1001"></a><span id="l12.1001" class="difflineminus">-      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_UNINSTALL));</span>
<a href="#l12.1002"></a><span id="l12.1002" class="difflineplus">+    if (expectedRestart) {</span>
<a href="#l12.1003"></a><span id="l12.1003" class="difflineplus">+      Assert.ok(</span>
<a href="#l12.1004"></a><span id="l12.1004" class="difflineplus">+        hasFlag(aAddon.pendingOperations, AddonManager.PENDING_UNINSTALL)</span>
<a href="#l12.1005"></a><span id="l12.1005" class="difflineplus">+      );</span>
<a href="#l12.1006"></a><span id="l12.1006" class="difflineplus">+    }</span>
<a href="#l12.1007"></a><span id="l12.1007">     return check_test_completed(arguments);</span>
<a href="#l12.1008"></a><span id="l12.1008">   },</span>
<a href="#l12.1009"></a><span id="l12.1009"> </span>
<a href="#l12.1010"></a><span id="l12.1010">   onUninstalled(aAddon) {</span>
<a href="#l12.1011"></a><span id="l12.1011">     info(`Got onUninstalled event for ${aAddon.id}`);</span>
<a href="#l12.1012"></a><span id="l12.1012">     let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.1013"></a><span id="l12.1013">     Assert.equal(&quot;onUninstalled&quot;, event);</span>
<a href="#l12.1014"></a><span id="l12.1014">     return check_test_completed(arguments);</span>
<a href="#l12.1015"></a><span id="l12.1015" class="difflineat">@@ -955,24 +1114,28 @@ const AddonListener = {</span>
<a href="#l12.1016"></a><span id="l12.1016">     let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l12.1017"></a><span id="l12.1017">     Assert.equal(&quot;onOperationCancelled&quot;, event);</span>
<a href="#l12.1018"></a><span id="l12.1018">     return check_test_completed(arguments);</span>
<a href="#l12.1019"></a><span id="l12.1019">   },</span>
<a href="#l12.1020"></a><span id="l12.1020"> };</span>
<a href="#l12.1021"></a><span id="l12.1021"> </span>
<a href="#l12.1022"></a><span id="l12.1022"> const InstallListener = {</span>
<a href="#l12.1023"></a><span id="l12.1023">   onNewInstall(install) {</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineminus">-    if (install.state != AddonManager.STATE_DOWNLOADED &amp;&amp;</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineminus">-        install.state != AddonManager.STATE_DOWNLOAD_FAILED &amp;&amp;</span>
<a href="#l12.1026"></a><span id="l12.1026" class="difflineminus">-        install.state != AddonManager.STATE_AVAILABLE)</span>
<a href="#l12.1027"></a><span id="l12.1027" class="difflineplus">+    if (</span>
<a href="#l12.1028"></a><span id="l12.1028" class="difflineplus">+      install.state != AddonManager.STATE_DOWNLOADED &amp;&amp;</span>
<a href="#l12.1029"></a><span id="l12.1029" class="difflineplus">+      install.state != AddonManager.STATE_DOWNLOAD_FAILED &amp;&amp;</span>
<a href="#l12.1030"></a><span id="l12.1030" class="difflineplus">+      install.state != AddonManager.STATE_AVAILABLE</span>
<a href="#l12.1031"></a><span id="l12.1031" class="difflineplus">+    ) {</span>
<a href="#l12.1032"></a><span id="l12.1032">       do_throw(&quot;Bad install state &quot; + install.state);</span>
<a href="#l12.1033"></a><span id="l12.1033" class="difflineminus">-    if (install.state != AddonManager.STATE_DOWNLOAD_FAILED)</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineplus">+    }</span>
<a href="#l12.1035"></a><span id="l12.1035" class="difflineplus">+    if (install.state != AddonManager.STATE_DOWNLOAD_FAILED) {</span>
<a href="#l12.1036"></a><span id="l12.1036">       Assert.equal(install.error, 0);</span>
<a href="#l12.1037"></a><span id="l12.1037" class="difflineminus">-    else</span>
<a href="#l12.1038"></a><span id="l12.1038" class="difflineplus">+    } else {</span>
<a href="#l12.1039"></a><span id="l12.1039">       Assert.notEqual(install.error, 0);</span>
<a href="#l12.1040"></a><span id="l12.1040" class="difflineplus">+    }</span>
<a href="#l12.1041"></a><span id="l12.1041">     Assert.equal(&quot;onNewInstall&quot;, getExpectedInstall());</span>
<a href="#l12.1042"></a><span id="l12.1042">     return check_test_completed(arguments);</span>
<a href="#l12.1043"></a><span id="l12.1043">   },</span>
<a href="#l12.1044"></a><span id="l12.1044"> </span>
<a href="#l12.1045"></a><span id="l12.1045">   onDownloadStarted(install) {</span>
<a href="#l12.1046"></a><span id="l12.1046">     Assert.equal(install.state, AddonManager.STATE_DOWNLOADING);</span>
<a href="#l12.1047"></a><span id="l12.1047">     Assert.equal(install.error, 0);</span>
<a href="#l12.1048"></a><span id="l12.1048">     Assert.equal(&quot;onDownloadStarted&quot;, getExpectedInstall());</span>
<a href="#l12.1049"></a><span id="l12.1049" class="difflineat">@@ -1017,18 +1180,20 @@ const InstallListener = {</span>
<a href="#l12.1050"></a><span id="l12.1050">     Assert.equal(install.state, AddonManager.STATE_INSTALL_FAILED);</span>
<a href="#l12.1051"></a><span id="l12.1051">     Assert.equal(&quot;onInstallFailed&quot;, getExpectedInstall(install.addon));</span>
<a href="#l12.1052"></a><span id="l12.1052">     return check_test_completed(arguments);</span>
<a href="#l12.1053"></a><span id="l12.1053">   },</span>
<a href="#l12.1054"></a><span id="l12.1054"> </span>
<a href="#l12.1055"></a><span id="l12.1055">   onInstallCancelled(install) {</span>
<a href="#l12.1056"></a><span id="l12.1056">     // If the install was cancelled by a listener returning false from</span>
<a href="#l12.1057"></a><span id="l12.1057">     // onInstallStarted, then the state will revert to STATE_DOWNLOADED.</span>
<a href="#l12.1058"></a><span id="l12.1058" class="difflineminus">-    let possibleStates = [AddonManager.STATE_CANCELLED,</span>
<a href="#l12.1059"></a><span id="l12.1059" class="difflineminus">-                          AddonManager.STATE_DOWNLOADED];</span>
<a href="#l12.1060"></a><span id="l12.1060" class="difflineplus">+    let possibleStates = [</span>
<a href="#l12.1061"></a><span id="l12.1061" class="difflineplus">+      AddonManager.STATE_CANCELLED,</span>
<a href="#l12.1062"></a><span id="l12.1062" class="difflineplus">+      AddonManager.STATE_DOWNLOADED,</span>
<a href="#l12.1063"></a><span id="l12.1063" class="difflineplus">+    ];</span>
<a href="#l12.1064"></a><span id="l12.1064">     Assert.ok(possibleStates.includes(install.state));</span>
<a href="#l12.1065"></a><span id="l12.1065">     Assert.equal(install.error, 0);</span>
<a href="#l12.1066"></a><span id="l12.1066">     Assert.equal(&quot;onInstallCancelled&quot;, getExpectedInstall(install.addon));</span>
<a href="#l12.1067"></a><span id="l12.1067">     return check_test_completed(arguments);</span>
<a href="#l12.1068"></a><span id="l12.1068">   },</span>
<a href="#l12.1069"></a><span id="l12.1069"> </span>
<a href="#l12.1070"></a><span id="l12.1070">   onExternalInstall(aAddon, existingAddon, aRequiresRestart) {</span>
<a href="#l12.1071"></a><span id="l12.1071">     Assert.equal(&quot;onExternalInstall&quot;, getExpectedInstall(aAddon));</span>
<a href="#l12.1072"></a><span id="l12.1072" class="difflineat">@@ -1057,46 +1222,55 @@ function clearListeners() {</span>
<a href="#l12.1073"></a><span id="l12.1073"> }</span>
<a href="#l12.1074"></a><span id="l12.1074"> </span>
<a href="#l12.1075"></a><span id="l12.1075"> function end_test() {</span>
<a href="#l12.1076"></a><span id="l12.1076">   clearListeners();</span>
<a href="#l12.1077"></a><span id="l12.1077"> }</span>
<a href="#l12.1078"></a><span id="l12.1078"> </span>
<a href="#l12.1079"></a><span id="l12.1079"> // Checks if all expected events have been seen and if so calls the callback.</span>
<a href="#l12.1080"></a><span id="l12.1080"> function check_test_completed(aArgs) {</span>
<a href="#l12.1081"></a><span id="l12.1081" class="difflineminus">-  if (!gNext)</span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineplus">+  if (!gNext) {</span>
<a href="#l12.1083"></a><span id="l12.1083">     return undefined;</span>
<a href="#l12.1084"></a><span id="l12.1084" class="difflineplus">+  }</span>
<a href="#l12.1085"></a><span id="l12.1085"> </span>
<a href="#l12.1086"></a><span id="l12.1086" class="difflineminus">-  if (gExpectedInstalls instanceof Array &amp;&amp;</span>
<a href="#l12.1087"></a><span id="l12.1087" class="difflineminus">-      gExpectedInstalls.length &gt; 0)</span>
<a href="#l12.1088"></a><span id="l12.1088" class="difflineplus">+  if (gExpectedInstalls instanceof Array &amp;&amp; gExpectedInstalls.length &gt; 0) {</span>
<a href="#l12.1089"></a><span id="l12.1089">     return undefined;</span>
<a href="#l12.1090"></a><span id="l12.1090" class="difflineplus">+  }</span>
<a href="#l12.1091"></a><span id="l12.1091"> </span>
<a href="#l12.1092"></a><span id="l12.1092">   for (let id in gExpectedInstalls) {</span>
<a href="#l12.1093"></a><span id="l12.1093">     let installList = gExpectedInstalls[id];</span>
<a href="#l12.1094"></a><span id="l12.1094" class="difflineminus">-    if (installList.length &gt; 0)</span>
<a href="#l12.1095"></a><span id="l12.1095" class="difflineplus">+    if (installList.length &gt; 0) {</span>
<a href="#l12.1096"></a><span id="l12.1096">       return undefined;</span>
<a href="#l12.1097"></a><span id="l12.1097" class="difflineplus">+    }</span>
<a href="#l12.1098"></a><span id="l12.1098">   }</span>
<a href="#l12.1099"></a><span id="l12.1099"> </span>
<a href="#l12.1100"></a><span id="l12.1100">   for (let id in gExpectedEvents) {</span>
<a href="#l12.1101"></a><span id="l12.1101" class="difflineminus">-    if (gExpectedEvents[id].length &gt; 0)</span>
<a href="#l12.1102"></a><span id="l12.1102" class="difflineplus">+    if (gExpectedEvents[id].length &gt; 0) {</span>
<a href="#l12.1103"></a><span id="l12.1103">       return undefined;</span>
<a href="#l12.1104"></a><span id="l12.1104" class="difflineplus">+    }</span>
<a href="#l12.1105"></a><span id="l12.1105">   }</span>
<a href="#l12.1106"></a><span id="l12.1106"> </span>
<a href="#l12.1107"></a><span id="l12.1107">   return gNext.apply(null, aArgs);</span>
<a href="#l12.1108"></a><span id="l12.1108"> }</span>
<a href="#l12.1109"></a><span id="l12.1109"> </span>
<a href="#l12.1110"></a><span id="l12.1110"> // Verifies that all the expected events for all add-ons were seen.</span>
<a href="#l12.1111"></a><span id="l12.1111"> function ensure_test_completed() {</span>
<a href="#l12.1112"></a><span id="l12.1112">   for (let i in gExpectedEvents) {</span>
<a href="#l12.1113"></a><span id="l12.1113" class="difflineminus">-    if (gExpectedEvents[i].length &gt; 0)</span>
<a href="#l12.1114"></a><span id="l12.1114" class="difflineminus">-      do_throw(`Didn't see all the expected events for ${i}: Still expecting ${gExpectedEvents[i]}`);</span>
<a href="#l12.1115"></a><span id="l12.1115" class="difflineplus">+    if (gExpectedEvents[i].length &gt; 0) {</span>
<a href="#l12.1116"></a><span id="l12.1116" class="difflineplus">+      do_throw(</span>
<a href="#l12.1117"></a><span id="l12.1117" class="difflineplus">+        `Didn't see all the expected events for ${i}: Still expecting ${</span>
<a href="#l12.1118"></a><span id="l12.1118" class="difflineplus">+          gExpectedEvents[i]</span>
<a href="#l12.1119"></a><span id="l12.1119" class="difflineplus">+        }`</span>
<a href="#l12.1120"></a><span id="l12.1120" class="difflineplus">+      );</span>
<a href="#l12.1121"></a><span id="l12.1121" class="difflineplus">+    }</span>
<a href="#l12.1122"></a><span id="l12.1122">   }</span>
<a href="#l12.1123"></a><span id="l12.1123">   gExpectedEvents = {};</span>
<a href="#l12.1124"></a><span id="l12.1124" class="difflineminus">-  if (gExpectedInstalls)</span>
<a href="#l12.1125"></a><span id="l12.1125" class="difflineplus">+  if (gExpectedInstalls) {</span>
<a href="#l12.1126"></a><span id="l12.1126">     Assert.equal(gExpectedInstalls.length, 0);</span>
<a href="#l12.1127"></a><span id="l12.1127" class="difflineplus">+  }</span>
<a href="#l12.1128"></a><span id="l12.1128"> }</span>
<a href="#l12.1129"></a><span id="l12.1129"> </span>
<a href="#l12.1130"></a><span id="l12.1130"> /**</span>
<a href="#l12.1131"></a><span id="l12.1131">  * A helper method to install an array of AddonInstall to completion and then</span>
<a href="#l12.1132"></a><span id="l12.1132">  * call a provided callback.</span>
<a href="#l12.1133"></a><span id="l12.1133">  *</span>
<a href="#l12.1134"></a><span id="l12.1134">  * @param   aInstalls</span>
<a href="#l12.1135"></a><span id="l12.1135">  *          The array of AddonInstalls to install</span>
<a href="#l12.1136"></a><span id="l12.1136" class="difflineat">@@ -1125,34 +1299,35 @@ function installAllFiles(aFiles, aCallba</span>
<a href="#l12.1137"></a><span id="l12.1137"> </span>
<a href="#l12.1138"></a><span id="l12.1138"> const EXTENSIONS_DB = &quot;extensions.json&quot;;</span>
<a href="#l12.1139"></a><span id="l12.1139"> var gExtensionsJSON = gProfD.clone();</span>
<a href="#l12.1140"></a><span id="l12.1140"> gExtensionsJSON.append(EXTENSIONS_DB);</span>
<a href="#l12.1141"></a><span id="l12.1141"> </span>
<a href="#l12.1142"></a><span id="l12.1142"> async function promiseInstallWebExtension(aData) {</span>
<a href="#l12.1143"></a><span id="l12.1143">   let addonFile = createTempWebExtensionFile(aData);</span>
<a href="#l12.1144"></a><span id="l12.1144"> </span>
<a href="#l12.1145"></a><span id="l12.1145" class="difflineminus">-  let {addon} = await promiseInstallFile(addonFile);</span>
<a href="#l12.1146"></a><span id="l12.1146" class="difflineplus">+  let { addon } = await promiseInstallFile(addonFile);</span>
<a href="#l12.1147"></a><span id="l12.1147">   return addon;</span>
<a href="#l12.1148"></a><span id="l12.1148"> }</span>
<a href="#l12.1149"></a><span id="l12.1149"> </span>
<a href="#l12.1150"></a><span id="l12.1150"> // By default use strict compatibility.</span>
<a href="#l12.1151"></a><span id="l12.1151"> Services.prefs.setBoolPref(&quot;extensions.strictCompatibility&quot;, true);</span>
<a href="#l12.1152"></a><span id="l12.1152"> </span>
<a href="#l12.1153"></a><span id="l12.1153"> // Ensure signature checks are enabled by default.</span>
<a href="#l12.1154"></a><span id="l12.1154"> Services.prefs.setBoolPref(PREF_XPI_SIGNATURES_REQUIRED, false);</span>
<a href="#l12.1155"></a><span id="l12.1155"> </span>
<a href="#l12.1156"></a><span id="l12.1156"> Services.prefs.setBoolPref(&quot;extensions.legacy.enabled&quot;, true);</span>
<a href="#l12.1157"></a><span id="l12.1157"> </span>
<a href="#l12.1158"></a><span id="l12.1158"> // Copies blocklistFile (an nsIFile) to gProfD/blocklist.xml.</span>
<a href="#l12.1159"></a><span id="l12.1159"> function copyBlocklistToProfile(blocklistFile) {</span>
<a href="#l12.1160"></a><span id="l12.1160">   var dest = gProfD.clone();</span>
<a href="#l12.1161"></a><span id="l12.1161">   dest.append(&quot;blocklist.xml&quot;);</span>
<a href="#l12.1162"></a><span id="l12.1162" class="difflineminus">-  if (dest.exists())</span>
<a href="#l12.1163"></a><span id="l12.1163" class="difflineplus">+  if (dest.exists()) {</span>
<a href="#l12.1164"></a><span id="l12.1164">     dest.remove(false);</span>
<a href="#l12.1165"></a><span id="l12.1165" class="difflineplus">+  }</span>
<a href="#l12.1166"></a><span id="l12.1166">   blocklistFile.copyTo(gProfD, &quot;blocklist.xml&quot;);</span>
<a href="#l12.1167"></a><span id="l12.1167">   dest.lastModifiedTime = Date.now();</span>
<a href="#l12.1168"></a><span id="l12.1168"> }</span>
<a href="#l12.1169"></a><span id="l12.1169"> </span>
<a href="#l12.1170"></a><span id="l12.1170"> // Make sure that a given path does not exist.</span>
<a href="#l12.1171"></a><span id="l12.1171"> function pathShouldntExist(file) {</span>
<a href="#l12.1172"></a><span id="l12.1172">   if (file.exists()) {</span>
<a href="#l12.1173"></a><span id="l12.1173">     do_throw(`Test cleanup: path ${file.path} exists when it should not`);</span>
<a href="#l12.1174"></a><span id="l12.1174" class="difflineat">@@ -1196,56 +1371,67 @@ async function loadJSON(aFile) {</span>
<a href="#l12.1175"></a><span id="l12.1175">   return JSON.parse(data);</span>
<a href="#l12.1176"></a><span id="l12.1176"> }</span>
<a href="#l12.1177"></a><span id="l12.1177"> </span>
<a href="#l12.1178"></a><span id="l12.1178"> /**</span>
<a href="#l12.1179"></a><span id="l12.1179">  * Raw save of a JSON blob to file.</span>
<a href="#l12.1180"></a><span id="l12.1180">  */</span>
<a href="#l12.1181"></a><span id="l12.1181"> async function saveJSON(aData, aFile) {</span>
<a href="#l12.1182"></a><span id="l12.1182">   info(&quot;Starting to save JSON file &quot; + aFile);</span>
<a href="#l12.1183"></a><span id="l12.1183" class="difflineminus">-  await OS.File.writeAtomic(aFile, new TextEncoder().encode(JSON.stringify(aData, null, 2)));</span>
<a href="#l12.1184"></a><span id="l12.1184" class="difflineplus">+  await OS.File.writeAtomic(</span>
<a href="#l12.1185"></a><span id="l12.1185" class="difflineplus">+    aFile,</span>
<a href="#l12.1186"></a><span id="l12.1186" class="difflineplus">+    new TextEncoder().encode(JSON.stringify(aData, null, 2))</span>
<a href="#l12.1187"></a><span id="l12.1187" class="difflineplus">+  );</span>
<a href="#l12.1188"></a><span id="l12.1188">   info(&quot;Done saving JSON file &quot; + aFile.path);</span>
<a href="#l12.1189"></a><span id="l12.1189"> }</span>
<a href="#l12.1190"></a><span id="l12.1190"> </span>
<a href="#l12.1191"></a><span id="l12.1191"> /**</span>
<a href="#l12.1192"></a><span id="l12.1192">  * Create a callback function that calls do_execute_soon on an actual callback and arguments.</span>
<a href="#l12.1193"></a><span id="l12.1193">  */</span>
<a href="#l12.1194"></a><span id="l12.1194"> function callback_soon(aFunction) {</span>
<a href="#l12.1195"></a><span id="l12.1195">   return function(...args) {</span>
<a href="#l12.1196"></a><span id="l12.1196" class="difflineminus">-    executeSoon(function() {</span>
<a href="#l12.1197"></a><span id="l12.1197" class="difflineminus">-      aFunction.apply(null, args);</span>
<a href="#l12.1198"></a><span id="l12.1198" class="difflineminus">-    }, aFunction.name ? &quot;delayed callback &quot; + aFunction.name : &quot;delayed callback&quot;);</span>
<a href="#l12.1199"></a><span id="l12.1199" class="difflineplus">+    executeSoon(</span>
<a href="#l12.1200"></a><span id="l12.1200" class="difflineplus">+      function() {</span>
<a href="#l12.1201"></a><span id="l12.1201" class="difflineplus">+        aFunction.apply(null, args);</span>
<a href="#l12.1202"></a><span id="l12.1202" class="difflineplus">+      },</span>
<a href="#l12.1203"></a><span id="l12.1203" class="difflineplus">+      aFunction.name ? &quot;delayed callback &quot; + aFunction.name : &quot;delayed callback&quot;</span>
<a href="#l12.1204"></a><span id="l12.1204" class="difflineplus">+    );</span>
<a href="#l12.1205"></a><span id="l12.1205">   };</span>
<a href="#l12.1206"></a><span id="l12.1206"> }</span>
<a href="#l12.1207"></a><span id="l12.1207"> </span>
<a href="#l12.1208"></a><span id="l12.1208" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;pluginHost&quot;,</span>
<a href="#l12.1209"></a><span id="l12.1209" class="difflineminus">-                                  &quot;@mozilla.org/plugin/host;1&quot;, &quot;nsIPluginHost&quot;);</span>
<a href="#l12.1210"></a><span id="l12.1210" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l12.1211"></a><span id="l12.1211" class="difflineplus">+  this,</span>
<a href="#l12.1212"></a><span id="l12.1212" class="difflineplus">+  &quot;pluginHost&quot;,</span>
<a href="#l12.1213"></a><span id="l12.1213" class="difflineplus">+  &quot;@mozilla.org/plugin/host;1&quot;,</span>
<a href="#l12.1214"></a><span id="l12.1214" class="difflineplus">+  &quot;nsIPluginHost&quot;</span>
<a href="#l12.1215"></a><span id="l12.1215" class="difflineplus">+);</span>
<a href="#l12.1216"></a><span id="l12.1216"> </span>
<a href="#l12.1217"></a><span id="l12.1217"> class MockPluginTag {</span>
<a href="#l12.1218"></a><span id="l12.1218">   constructor(opts, enabledState = Ci.nsIPluginTag.STATE_ENABLED) {</span>
<a href="#l12.1219"></a><span id="l12.1219">     this.pluginTag = pluginHost.createFakePlugin({</span>
<a href="#l12.1220"></a><span id="l12.1220">       handlerURI: &quot;resource://fake-plugin/${Math.random()}.xhtml&quot;,</span>
<a href="#l12.1221"></a><span id="l12.1221" class="difflineminus">-      mimeEntries: [{type: &quot;application/x-fake-plugin&quot;}],</span>
<a href="#l12.1222"></a><span id="l12.1222" class="difflineplus">+      mimeEntries: [{ type: &quot;application/x-fake-plugin&quot; }],</span>
<a href="#l12.1223"></a><span id="l12.1223">       fileName: `${opts.name}.so`,</span>
<a href="#l12.1224"></a><span id="l12.1224">       ...opts,</span>
<a href="#l12.1225"></a><span id="l12.1225">     });</span>
<a href="#l12.1226"></a><span id="l12.1226">     this.pluginTag.enabledState = enabledState;</span>
<a href="#l12.1227"></a><span id="l12.1227"> </span>
<a href="#l12.1228"></a><span id="l12.1228">     this.name = opts.name;</span>
<a href="#l12.1229"></a><span id="l12.1229">     this.version = opts.version;</span>
<a href="#l12.1230"></a><span id="l12.1230">   }</span>
<a href="#l12.1231"></a><span id="l12.1231">   async isBlocklisted() {</span>
<a href="#l12.1232"></a><span id="l12.1232">     let state = await Blocklist.getPluginBlocklistState(this.pluginTag);</span>
<a href="#l12.1233"></a><span id="l12.1233">     return state == Services.blocklist.STATE_BLOCKED;</span>
<a href="#l12.1234"></a><span id="l12.1234">   }</span>
<a href="#l12.1235"></a><span id="l12.1235">   get disabled() {</span>
<a href="#l12.1236"></a><span id="l12.1236">     return this.pluginTag.enabledState == Ci.nsIPluginTag.STATE_DISABLED;</span>
<a href="#l12.1237"></a><span id="l12.1237">   }</span>
<a href="#l12.1238"></a><span id="l12.1238">   set disabled(val) {</span>
<a href="#l12.1239"></a><span id="l12.1239" class="difflineminus">-    this.enabledState = Ci.nsIPluginTag[val ? &quot;STATE_DISABLED&quot; : &quot;STATE_ENABLED&quot;];</span>
<a href="#l12.1240"></a><span id="l12.1240" class="difflineplus">+    this.enabledState =</span>
<a href="#l12.1241"></a><span id="l12.1241" class="difflineplus">+      Ci.nsIPluginTag[val ? &quot;STATE_DISABLED&quot; : &quot;STATE_ENABLED&quot;];</span>
<a href="#l12.1242"></a><span id="l12.1242">   }</span>
<a href="#l12.1243"></a><span id="l12.1243">   get enabledState() {</span>
<a href="#l12.1244"></a><span id="l12.1244">     return this.pluginTag.enabledState;</span>
<a href="#l12.1245"></a><span id="l12.1245">   }</span>
<a href="#l12.1246"></a><span id="l12.1246">   set enabledState(val) {</span>
<a href="#l12.1247"></a><span id="l12.1247">     this.pluginTag.enabledState = val;</span>
<a href="#l12.1248"></a><span id="l12.1248">   }</span>
<a href="#l12.1249"></a><span id="l12.1249"> }</span>
<a href="#l12.1250"></a><span id="l12.1250" class="difflineat">@@ -1274,17 +1460,23 @@ async function setInitialState(addon, in</span>
<a href="#l12.1251"></a><span id="l12.1251"> /**</span>
<a href="#l12.1252"></a><span id="l12.1252">  * Escapes any occurrences of &amp;, &quot;, &lt; or &gt; with XML entities.</span>
<a href="#l12.1253"></a><span id="l12.1253">  *</span>
<a href="#l12.1254"></a><span id="l12.1254">  * @param {string} str</span>
<a href="#l12.1255"></a><span id="l12.1255">  *        The string to escape.</span>
<a href="#l12.1256"></a><span id="l12.1256">  * @returns {string} The escaped string.</span>
<a href="#l12.1257"></a><span id="l12.1257">  */</span>
<a href="#l12.1258"></a><span id="l12.1258"> function escapeXML(str) {</span>
<a href="#l12.1259"></a><span id="l12.1259" class="difflineminus">-  let replacements = {&quot;&amp;&quot;: &quot;&amp;amp;&quot;, '&quot;': &quot;&amp;quot;&quot;, &quot;'&quot;: &quot;&amp;apos;&quot;, &quot;&lt;&quot;: &quot;&amp;lt;&quot;, &quot;&gt;&quot;: &quot;&amp;gt;&quot;};</span>
<a href="#l12.1260"></a><span id="l12.1260" class="difflineplus">+  let replacements = {</span>
<a href="#l12.1261"></a><span id="l12.1261" class="difflineplus">+    &quot;&amp;&quot;: &quot;&amp;amp;&quot;,</span>
<a href="#l12.1262"></a><span id="l12.1262" class="difflineplus">+    '&quot;': &quot;&amp;quot;&quot;,</span>
<a href="#l12.1263"></a><span id="l12.1263" class="difflineplus">+    &quot;'&quot;: &quot;&amp;apos;&quot;,</span>
<a href="#l12.1264"></a><span id="l12.1264" class="difflineplus">+    &quot;&lt;&quot;: &quot;&amp;lt;&quot;,</span>
<a href="#l12.1265"></a><span id="l12.1265" class="difflineplus">+    &quot;&gt;&quot;: &quot;&amp;gt;&quot;,</span>
<a href="#l12.1266"></a><span id="l12.1266" class="difflineplus">+  };</span>
<a href="#l12.1267"></a><span id="l12.1267">   return String(str).replace(/[&amp;&quot;''&lt;&gt;]/g, m =&gt; replacements[m]);</span>
<a href="#l12.1268"></a><span id="l12.1268"> }</span>
<a href="#l12.1269"></a><span id="l12.1269"> </span>
<a href="#l12.1270"></a><span id="l12.1270"> /**</span>
<a href="#l12.1271"></a><span id="l12.1271">  * A tagged template function which escapes any XML metacharacters in</span>
<a href="#l12.1272"></a><span id="l12.1272">  * interpolated values.</span>
<a href="#l12.1273"></a><span id="l12.1273">  *</span>
<a href="#l12.1274"></a><span id="l12.1274">  * @param {Array&lt;string&gt;} strings</span>
<a href="#l12.1275"></a><span id="l12.1275" class="difflineat">@@ -1306,31 +1498,37 @@ function escaped(strings, ...values) {</span>
<a href="#l12.1276"></a><span id="l12.1276">   }</span>
<a href="#l12.1277"></a><span id="l12.1277"> </span>
<a href="#l12.1278"></a><span id="l12.1278">   return result.join(&quot;&quot;);</span>
<a href="#l12.1279"></a><span id="l12.1279"> }</span>
<a href="#l12.1280"></a><span id="l12.1280"> </span>
<a href="#l12.1281"></a><span id="l12.1281"> function _writeProps(obj, props, indent = &quot;  &quot;) {</span>
<a href="#l12.1282"></a><span id="l12.1282">   let items = [];</span>
<a href="#l12.1283"></a><span id="l12.1283">   for (let prop of props) {</span>
<a href="#l12.1284"></a><span id="l12.1284" class="difflineminus">-    if (obj[prop] !== undefined)</span>
<a href="#l12.1285"></a><span id="l12.1285" class="difflineplus">+    if (obj[prop] !== undefined) {</span>
<a href="#l12.1286"></a><span id="l12.1286">       items.push(escaped`${indent}&lt;em:${prop}&gt;${obj[prop]}&lt;/em:${prop}&gt;\n`);</span>
<a href="#l12.1287"></a><span id="l12.1287" class="difflineplus">+    }</span>
<a href="#l12.1288"></a><span id="l12.1288">   }</span>
<a href="#l12.1289"></a><span id="l12.1289">   return items.join(&quot;&quot;);</span>
<a href="#l12.1290"></a><span id="l12.1290"> }</span>
<a href="#l12.1291"></a><span id="l12.1291"> </span>
<a href="#l12.1292"></a><span id="l12.1292"> function _writeArrayProps(obj, props, indent = &quot;  &quot;) {</span>
<a href="#l12.1293"></a><span id="l12.1293">   let items = [];</span>
<a href="#l12.1294"></a><span id="l12.1294">   for (let prop of props) {</span>
<a href="#l12.1295"></a><span id="l12.1295" class="difflineminus">-    for (let val of obj[prop] || [])</span>
<a href="#l12.1296"></a><span id="l12.1296" class="difflineplus">+    for (let val of obj[prop] || []) {</span>
<a href="#l12.1297"></a><span id="l12.1297">       items.push(escaped`${indent}&lt;em:${prop}&gt;${val}&lt;/em:${prop}&gt;\n`);</span>
<a href="#l12.1298"></a><span id="l12.1298" class="difflineplus">+    }</span>
<a href="#l12.1299"></a><span id="l12.1299">   }</span>
<a href="#l12.1300"></a><span id="l12.1300">   return items.join(&quot;&quot;);</span>
<a href="#l12.1301"></a><span id="l12.1301"> }</span>
<a href="#l12.1302"></a><span id="l12.1302"> </span>
<a href="#l12.1303"></a><span id="l12.1303"> function _writeLocaleStrings(data) {</span>
<a href="#l12.1304"></a><span id="l12.1304">   let items = [];</span>
<a href="#l12.1305"></a><span id="l12.1305"> </span>
<a href="#l12.1306"></a><span id="l12.1306" class="difflineminus">-  items.push(this._writeProps(data, [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;]));</span>
<a href="#l12.1307"></a><span id="l12.1307" class="difflineminus">-  items.push(this._writeArrayProps(data, [&quot;developer&quot;, &quot;translator&quot;, &quot;contributor&quot;]));</span>
<a href="#l12.1308"></a><span id="l12.1308" class="difflineplus">+  items.push(</span>
<a href="#l12.1309"></a><span id="l12.1309" class="difflineplus">+    this._writeProps(data, [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;])</span>
<a href="#l12.1310"></a><span id="l12.1310" class="difflineplus">+  );</span>
<a href="#l12.1311"></a><span id="l12.1311" class="difflineplus">+  items.push(</span>
<a href="#l12.1312"></a><span id="l12.1312" class="difflineplus">+    this._writeArrayProps(data, [&quot;developer&quot;, &quot;translator&quot;, &quot;contributor&quot;])</span>
<a href="#l12.1313"></a><span id="l12.1313" class="difflineplus">+  );</span>
<a href="#l12.1314"></a><span id="l12.1314"> </span>
<a href="#l12.1315"></a><span id="l12.1315">   return items.join(&quot;&quot;);</span>
<a href="#l12.1316"></a><span id="l12.1316"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,30 +1,32 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l13.5"></a><span id="l13.5">  * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l13.6"></a><span id="l13.6">  */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-const APP_STARTUP                     = 1;</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-const APP_SHUTDOWN                    = 2;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-const ADDON_ENABLE                    = 3;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-const ADDON_DISABLE                   = 4;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-const ADDON_INSTALL                   = 5;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-const ADDON_UNINSTALL                 = 6;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-const ADDON_UPGRADE                   = 7;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-const ADDON_DOWNGRADE                 = 8;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+const APP_STARTUP = 1;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+const APP_SHUTDOWN = 2;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+const ADDON_ENABLE = 3;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+const ADDON_DISABLE = 4;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+const ADDON_INSTALL = 5;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+const ADDON_UNINSTALL = 6;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+const ADDON_UPGRADE = 7;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+const ADDON_DOWNGRADE = 8;</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> const ID1 = &quot;bootstrap1@tests.mozilla.org&quot;;</span>
<a href="#l13.26"></a><span id="l13.26"> const ID2 = &quot;bootstrap2@tests.mozilla.org&quot;;</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> // This verifies that bootstrappable add-ons can be used without restarts.</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32"> // Enable loading extensions from the user scopes</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-Services.prefs.setIntPref(&quot;extensions.enabledScopes&quot;,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-                          AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_USER);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+Services.prefs.setIntPref(</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  &quot;extensions.enabledScopes&quot;,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_USER</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+);</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40"> BootstrapMonitor.init();</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42"> createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44"> const profileDir = gProfD.clone();</span>
<a href="#l13.45"></a><span id="l13.45"> profileDir.append(&quot;extensions&quot;);</span>
<a href="#l13.46"></a><span id="l13.46"> const userExtDir = gProfD.clone();</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineat">@@ -77,28 +79,31 @@ const ADDONS = {</span>
<a href="#l13.48"></a><span id="l13.48">       legacy: {</span>
<a href="#l13.49"></a><span id="l13.49">         type: &quot;bootstrap&quot;,</span>
<a href="#l13.50"></a><span id="l13.50">       },</span>
<a href="#l13.51"></a><span id="l13.51">       manifest_version: 2,</span>
<a href="#l13.52"></a><span id="l13.52">       version: &quot;3.0&quot;,</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">       name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-      targetApplications: [{</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-        applications: {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-          gecko: {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-            id: &quot;undefined&quot;,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      targetApplications: [</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+          applications: {</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+            gecko: {</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+              id: &quot;undefined&quot;,</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+            },</span>
<a href="#l13.66"></a><span id="l13.66">           },</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+          legacy: {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+            type: &quot;bootstrap&quot;,</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+          },</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+          manifest_version: 2,</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+          minVersion: &quot;1&quot;,</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+          maxVersion: &quot;1&quot;,</span>
<a href="#l13.73"></a><span id="l13.73">         },</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-        legacy: {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-          type: &quot;bootstrap&quot;,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-        },</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-        manifest_version: 2,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-        minVersion: &quot;1&quot;,</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-        maxVersion: &quot;1&quot;}],</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+      ],</span>
<a href="#l13.81"></a><span id="l13.81">     }),</span>
<a href="#l13.82"></a><span id="l13.82">     &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l13.83"></a><span id="l13.83">   },</span>
<a href="#l13.84"></a><span id="l13.84">   test_bootstrap2_1: {</span>
<a href="#l13.85"></a><span id="l13.85">     &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l13.86"></a><span id="l13.86">       applications: {</span>
<a href="#l13.87"></a><span id="l13.87">         gecko: {</span>
<a href="#l13.88"></a><span id="l13.88">           id: &quot;bootstrap2@tests.mozilla.org&quot;,</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineat">@@ -121,25 +126,24 @@ var startupCacheMonitor = {</span>
<a href="#l13.90"></a><span id="l13.90">   // Checks that the notification has been fired since the last time this was called.</span>
<a href="#l13.91"></a><span id="l13.91">   check(expected) {</span>
<a href="#l13.92"></a><span id="l13.92">     equal(this.notificationFired, expected);</span>
<a href="#l13.93"></a><span id="l13.93">     this.notificationFired = false;</span>
<a href="#l13.94"></a><span id="l13.94">   },</span>
<a href="#l13.95"></a><span id="l13.95"> };</span>
<a href="#l13.96"></a><span id="l13.96"> Services.obs.addObserver(startupCacheMonitor, &quot;startupcache-invalidate&quot;);</span>
<a href="#l13.97"></a><span id="l13.97"> </span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-var testserver = AddonTestUtils.createHttpServer({hosts: [&quot;example.com&quot;]});</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+var testserver = AddonTestUtils.createHttpServer({ hosts: [&quot;example.com&quot;] });</span>
<a href="#l13.100"></a><span id="l13.100"> </span>
<a href="#l13.101"></a><span id="l13.101"> const XPIS = {};</span>
<a href="#l13.102"></a><span id="l13.102"> for (let [name, addon] of Object.entries(ADDONS)) {</span>
<a href="#l13.103"></a><span id="l13.103">   XPIS[name] = AddonTestUtils.createTempXPIFile(addon);</span>
<a href="#l13.104"></a><span id="l13.104">   testserver.registerFile(`/addons/${name}.xpi`, XPIS[name]);</span>
<a href="#l13.105"></a><span id="l13.105"> }</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-</span>
<a href="#l13.108"></a><span id="l13.108"> function getStartupReason() {</span>
<a href="#l13.109"></a><span id="l13.109">   let info = BootstrapMonitor.started.get(ID1);</span>
<a href="#l13.110"></a><span id="l13.110">   return info ? info.reason : undefined;</span>
<a href="#l13.111"></a><span id="l13.111"> }</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113"> function getShutdownReason() {</span>
<a href="#l13.114"></a><span id="l13.114">   let info = BootstrapMonitor.stopped.get(ID1);</span>
<a href="#l13.115"></a><span id="l13.115">   return info ? info.reason : undefined;</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineat">@@ -171,31 +175,39 @@ function getInstallOldVersion() {</span>
<a href="#l13.117"></a><span id="l13.117"> }</span>
<a href="#l13.118"></a><span id="l13.118"> </span>
<a href="#l13.119"></a><span id="l13.119"> function getUninstallNewVersion() {</span>
<a href="#l13.120"></a><span id="l13.120">   let info = BootstrapMonitor.uninstalled.get(ID1);</span>
<a href="#l13.121"></a><span id="l13.121">   return info ? info.data.newVersion : undefined;</span>
<a href="#l13.122"></a><span id="l13.122"> }</span>
<a href="#l13.123"></a><span id="l13.123"> </span>
<a href="#l13.124"></a><span id="l13.124"> async function checkBootstrappedPref() {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  let XPIScope = ChromeUtils.import(&quot;resource://gre/modules/addons/XPIProvider.jsm&quot;, null);</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+  let XPIScope = ChromeUtils.import(</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+    &quot;resource://gre/modules/addons/XPIProvider.jsm&quot;,</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+    null</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+  );</span>
<a href="#l13.130"></a><span id="l13.130"> </span>
<a href="#l13.131"></a><span id="l13.131">   let data = new Map();</span>
<a href="#l13.132"></a><span id="l13.132">   for (let entry of XPIScope.XPIStates.enabledAddons()) {</span>
<a href="#l13.133"></a><span id="l13.133">     data.set(entry.id, entry);</span>
<a href="#l13.134"></a><span id="l13.134">   }</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136">   let addons = await AddonManager.getAddonsByTypes([&quot;extension&quot;]);</span>
<a href="#l13.137"></a><span id="l13.137">   for (let addon of addons) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-    if (!addon.id.endsWith(&quot;@tests.mozilla.org&quot;))</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+    if (!addon.id.endsWith(&quot;@tests.mozilla.org&quot;)) {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+      continue;</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+    }</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+    if (!addon.isActive) {</span>
<a href="#l13.143"></a><span id="l13.143">       continue;</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-    if (!addon.isActive)</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+    }</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    if (</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+      addon.operationsRequiringRestart != AddonManager.OP_NEEDS_RESTART_NONE</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+    ) {</span>
<a href="#l13.149"></a><span id="l13.149">       continue;</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-    if (addon.operationsRequiringRestart != AddonManager.OP_NEEDS_RESTART_NONE)</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-      continue;</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    }</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154">     ok(data.has(addon.id));</span>
<a href="#l13.155"></a><span id="l13.155">     let addonData = data.get(addon.id);</span>
<a href="#l13.156"></a><span id="l13.156">     data.delete(addon.id);</span>
<a href="#l13.157"></a><span id="l13.157"> </span>
<a href="#l13.158"></a><span id="l13.158">     equal(addonData.version, addon.version);</span>
<a href="#l13.159"></a><span id="l13.159">     equal(addonData.type, addon.type);</span>
<a href="#l13.160"></a><span id="l13.160"> </span>
<a href="#l13.161"></a><span id="l13.161" class="difflineat">@@ -213,51 +225,50 @@ add_task(async function run_test() {</span>
<a href="#l13.162"></a><span id="l13.162">   promiseStartupManager();</span>
<a href="#l13.163"></a><span id="l13.163"> </span>
<a href="#l13.164"></a><span id="l13.164">   ok(!gExtensionsJSON.exists());</span>
<a href="#l13.165"></a><span id="l13.165">   ok(!gAddonStartup.exists());</span>
<a href="#l13.166"></a><span id="l13.166"> });</span>
<a href="#l13.167"></a><span id="l13.167"> </span>
<a href="#l13.168"></a><span id="l13.168"> // Tests that installing doesn't require a restart</span>
<a href="#l13.169"></a><span id="l13.169"> add_task(async function test_1() {</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-  ]);</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l13.174"></a><span id="l13.174"> </span>
<a href="#l13.175"></a><span id="l13.175">   let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_1);</span>
<a href="#l13.176"></a><span id="l13.176">   ensure_test_completed();</span>
<a href="#l13.177"></a><span id="l13.177"> </span>
<a href="#l13.178"></a><span id="l13.178">   notEqual(install, null);</span>
<a href="#l13.179"></a><span id="l13.179">   equal(install.type, &quot;extension&quot;);</span>
<a href="#l13.180"></a><span id="l13.180">   equal(install.version, &quot;1.0&quot;);</span>
<a href="#l13.181"></a><span id="l13.181">   equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l13.182"></a><span id="l13.182">   equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l13.183"></a><span id="l13.183">   notEqual(install.addon.syncGUID, null);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-  equal(install.addon.operationsRequiringRestart &amp;</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-               AddonManager.OP_NEEDS_RESTART_INSTALL, 0);</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+  equal(</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+    install.addon.operationsRequiringRestart &amp;</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+      AddonManager.OP_NEEDS_RESTART_INSTALL,</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+    0</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+  );</span>
<a href="#l13.191"></a><span id="l13.191">   do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l13.192"></a><span id="l13.192"> </span>
<a href="#l13.193"></a><span id="l13.193">   let addon = install.addon;</span>
<a href="#l13.194"></a><span id="l13.194"> </span>
<a href="#l13.195"></a><span id="l13.195">   await Promise.all([</span>
<a href="#l13.196"></a><span id="l13.196">     BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l13.197"></a><span id="l13.197">     new Promise(resolve =&gt; {</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-      prepare_test({</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-        [ID1]: [</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-          [&quot;onInstalling&quot;, false],</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-          &quot;onInstalled&quot;,</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-        ],</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-      }, [</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-        &quot;onInstallStarted&quot;,</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-        &quot;onInstallEnded&quot;,</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-      ], function() {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-        // startup should not have been called yet.</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-        BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-        resolve();</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-      });</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+      prepare_test(</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+        {</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+        },</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+        function() {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+          // startup should not have been called yet.</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+          BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+          resolve();</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+        }</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+      );</span>
<a href="#l13.222"></a><span id="l13.222">       install.install();</span>
<a href="#l13.223"></a><span id="l13.223">     }),</span>
<a href="#l13.224"></a><span id="l13.224">   ]);</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226">   await checkBootstrappedPref();</span>
<a href="#l13.227"></a><span id="l13.227">   let installSyncGUID = addon.syncGUID;</span>
<a href="#l13.228"></a><span id="l13.228"> </span>
<a href="#l13.229"></a><span id="l13.229">   let installs = await AddonManager.getAllInstalls();</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineat">@@ -285,24 +296,23 @@ add_task(async function test_1() {</span>
<a href="#l13.231"></a><span id="l13.231"> </span>
<a href="#l13.232"></a><span id="l13.232">   startupCacheMonitor.check(false);</span>
<a href="#l13.233"></a><span id="l13.233"> });</span>
<a href="#l13.234"></a><span id="l13.234"> </span>
<a href="#l13.235"></a><span id="l13.235"> // Tests that disabling doesn't require a restart</span>
<a href="#l13.236"></a><span id="l13.236"> add_task(async function test_2() {</span>
<a href="#l13.237"></a><span id="l13.237">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.238"></a><span id="l13.238">   prepare_test({</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-    [ID1]: [</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-      [&quot;onDisabling&quot;, false],</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-      &quot;onDisabled&quot;,</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-    ],</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+    [ID1]: [[&quot;onDisabling&quot;, false], &quot;onDisabled&quot;],</span>
<a href="#l13.244"></a><span id="l13.244">   });</span>
<a href="#l13.245"></a><span id="l13.245"> </span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-  equal(b1.operationsRequiringRestart &amp;</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-        AddonManager.OP_NEEDS_RESTART_DISABLE, 0);</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+  equal(</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+    b1.operationsRequiringRestart &amp; AddonManager.OP_NEEDS_RESTART_DISABLE,</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+    0</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+  );</span>
<a href="#l13.252"></a><span id="l13.252">   await b1.disable();</span>
<a href="#l13.253"></a><span id="l13.253">   ensure_test_completed();</span>
<a href="#l13.254"></a><span id="l13.254"> </span>
<a href="#l13.255"></a><span id="l13.255">   await new Promise(executeSoon);</span>
<a href="#l13.256"></a><span id="l13.256"> </span>
<a href="#l13.257"></a><span id="l13.257">   notEqual(b1, null);</span>
<a href="#l13.258"></a><span id="l13.258">   equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l13.259"></a><span id="l13.259">   ok(!b1.appDisabled);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineat">@@ -354,24 +364,23 @@ add_task(async function test_3() {</span>
<a href="#l13.261"></a><span id="l13.261">   await checkBootstrappedPref();</span>
<a href="#l13.262"></a><span id="l13.262">   startupCacheMonitor.check(false);</span>
<a href="#l13.263"></a><span id="l13.263"> });</span>
<a href="#l13.264"></a><span id="l13.264"> </span>
<a href="#l13.265"></a><span id="l13.265"> // Tests that enabling doesn't require a restart</span>
<a href="#l13.266"></a><span id="l13.266"> add_task(async function test_4() {</span>
<a href="#l13.267"></a><span id="l13.267">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.268"></a><span id="l13.268">   prepare_test({</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-    [ID1]: [</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-      [&quot;onEnabling&quot;, false],</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-      &quot;onEnabled&quot;,</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-    ],</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+    [ID1]: [[&quot;onEnabling&quot;, false], &quot;onEnabled&quot;],</span>
<a href="#l13.274"></a><span id="l13.274">   });</span>
<a href="#l13.275"></a><span id="l13.275"> </span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-  equal(b1.operationsRequiringRestart &amp;</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-               AddonManager.OP_NEEDS_RESTART_ENABLE, 0);</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+  equal(</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+    b1.operationsRequiringRestart &amp; AddonManager.OP_NEEDS_RESTART_ENABLE,</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+    0</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+  );</span>
<a href="#l13.282"></a><span id="l13.282">   await b1.enable();</span>
<a href="#l13.283"></a><span id="l13.283">   ensure_test_completed();</span>
<a href="#l13.284"></a><span id="l13.284"> </span>
<a href="#l13.285"></a><span id="l13.285">   notEqual(b1, null);</span>
<a href="#l13.286"></a><span id="l13.286">   equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l13.287"></a><span id="l13.287">   ok(!b1.appDisabled);</span>
<a href="#l13.288"></a><span id="l13.288">   ok(!b1.userDisabled);</span>
<a href="#l13.289"></a><span id="l13.289">   ok(b1.isActive);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineat">@@ -420,41 +429,37 @@ add_task(async function test_5() {</span>
<a href="#l13.291"></a><span id="l13.291">   ok(!b1.isSystem);</span>
<a href="#l13.292"></a><span id="l13.292"> </span>
<a href="#l13.293"></a><span id="l13.293">   await checkBootstrappedPref();</span>
<a href="#l13.294"></a><span id="l13.294">   startupCacheMonitor.check(false);</span>
<a href="#l13.295"></a><span id="l13.295"> });</span>
<a href="#l13.296"></a><span id="l13.296"> </span>
<a href="#l13.297"></a><span id="l13.297"> // Tests that installing an upgrade doesn't require a restart</span>
<a href="#l13.298"></a><span id="l13.298"> add_task(async function test_6() {</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-  ]);</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l13.303"></a><span id="l13.303"> </span>
<a href="#l13.304"></a><span id="l13.304">   let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l13.305"></a><span id="l13.305">   ensure_test_completed();</span>
<a href="#l13.306"></a><span id="l13.306"> </span>
<a href="#l13.307"></a><span id="l13.307">   notEqual(install, null);</span>
<a href="#l13.308"></a><span id="l13.308">   equal(install.type, &quot;extension&quot;);</span>
<a href="#l13.309"></a><span id="l13.309">   equal(install.version, &quot;2.0&quot;);</span>
<a href="#l13.310"></a><span id="l13.310">   equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l13.311"></a><span id="l13.311">   equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l13.312"></a><span id="l13.312"> </span>
<a href="#l13.313"></a><span id="l13.313">   await Promise.all([</span>
<a href="#l13.314"></a><span id="l13.314">     BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l13.315"></a><span id="l13.315">     new Promise(resolve =&gt; {</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-      prepare_test({</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-        [ID1]: [</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-          [&quot;onInstalling&quot;, false],</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-          &quot;onInstalled&quot;,</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-        ],</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-      }, [</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-        &quot;onInstallStarted&quot;,</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-        &quot;onInstallEnded&quot;,</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-      ], resolve);</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+      prepare_test(</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+        {</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+        },</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+        resolve</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+      );</span>
<a href="#l13.332"></a><span id="l13.332">       install.install();</span>
<a href="#l13.333"></a><span id="l13.333">     }),</span>
<a href="#l13.334"></a><span id="l13.334">   ]);</span>
<a href="#l13.335"></a><span id="l13.335"> </span>
<a href="#l13.336"></a><span id="l13.336">   startupCacheMonitor.check(true);</span>
<a href="#l13.337"></a><span id="l13.337"> </span>
<a href="#l13.338"></a><span id="l13.338">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.339"></a><span id="l13.339">   notEqual(b1, null);</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineat">@@ -476,24 +481,23 @@ add_task(async function test_6() {</span>
<a href="#l13.341"></a><span id="l13.341"> </span>
<a href="#l13.342"></a><span id="l13.342">   await checkBootstrappedPref();</span>
<a href="#l13.343"></a><span id="l13.343"> });</span>
<a href="#l13.344"></a><span id="l13.344"> </span>
<a href="#l13.345"></a><span id="l13.345"> // Tests that uninstalling doesn't require a restart</span>
<a href="#l13.346"></a><span id="l13.346"> add_task(async function test_7() {</span>
<a href="#l13.347"></a><span id="l13.347">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.348"></a><span id="l13.348">   prepare_test({</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-    [ID1]: [</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-      [&quot;onUninstalling&quot;, false],</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-      &quot;onUninstalled&quot;,</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-    ],</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+    [ID1]: [[&quot;onUninstalling&quot;, false], &quot;onUninstalled&quot;],</span>
<a href="#l13.354"></a><span id="l13.354">   });</span>
<a href="#l13.355"></a><span id="l13.355"> </span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-  equal(b1.operationsRequiringRestart &amp;</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-        AddonManager.OP_NEEDS_RESTART_UNINSTALL, 0);</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+  equal(</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+    b1.operationsRequiringRestart &amp; AddonManager.OP_NEEDS_RESTART_UNINSTALL,</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+    0</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+  );</span>
<a href="#l13.362"></a><span id="l13.362">   await b1.uninstall();</span>
<a href="#l13.363"></a><span id="l13.363"> </span>
<a href="#l13.364"></a><span id="l13.364">   await checkBootstrappedPref();</span>
<a href="#l13.365"></a><span id="l13.365">   startupCacheMonitor.check(true);</span>
<a href="#l13.366"></a><span id="l13.366"> </span>
<a href="#l13.367"></a><span id="l13.367">   ensure_test_completed();</span>
<a href="#l13.368"></a><span id="l13.368">   BootstrapMonitor.checkAddonNotInstalled(ID1);</span>
<a href="#l13.369"></a><span id="l13.369">   BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineat">@@ -551,45 +555,40 @@ add_task(async function test_9() {</span>
<a href="#l13.371"></a><span id="l13.371">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.372"></a><span id="l13.372">   equal(b1, null);</span>
<a href="#l13.373"></a><span id="l13.373">   do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l13.374"></a><span id="l13.374"> </span>
<a href="#l13.375"></a><span id="l13.375">   await checkBootstrappedPref();</span>
<a href="#l13.376"></a><span id="l13.376">   startupCacheMonitor.check(false);</span>
<a href="#l13.377"></a><span id="l13.377"> });</span>
<a href="#l13.378"></a><span id="l13.378"> </span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-</span>
<a href="#l13.380"></a><span id="l13.380"> // Tests that installing a downgrade sends the right reason</span>
<a href="#l13.381"></a><span id="l13.381"> add_task(async function test_10() {</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-  ]);</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l13.386"></a><span id="l13.386"> </span>
<a href="#l13.387"></a><span id="l13.387">   let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l13.388"></a><span id="l13.388">   ensure_test_completed();</span>
<a href="#l13.389"></a><span id="l13.389"> </span>
<a href="#l13.390"></a><span id="l13.390">   notEqual(install, null);</span>
<a href="#l13.391"></a><span id="l13.391">   equal(install.type, &quot;extension&quot;);</span>
<a href="#l13.392"></a><span id="l13.392">   equal(install.version, &quot;2.0&quot;);</span>
<a href="#l13.393"></a><span id="l13.393">   equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l13.394"></a><span id="l13.394">   equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l13.395"></a><span id="l13.395">   do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l13.396"></a><span id="l13.396"> </span>
<a href="#l13.397"></a><span id="l13.397">   await Promise.all([</span>
<a href="#l13.398"></a><span id="l13.398">     BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l13.399"></a><span id="l13.399">     new Promise(resolve =&gt; {</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-      prepare_test({</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-        [ID1]: [</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-          [&quot;onInstalling&quot;, false],</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-          &quot;onInstalled&quot;,</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-        ],</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-      }, [</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineminus">-        &quot;onInstallStarted&quot;,</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineminus">-        &quot;onInstallEnded&quot;,</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-      ], resolve);</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+      prepare_test(</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+        {</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+        },</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+        resolve</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+      );</span>
<a href="#l13.416"></a><span id="l13.416">       install.install();</span>
<a href="#l13.417"></a><span id="l13.417">     }),</span>
<a href="#l13.418"></a><span id="l13.418">   ]);</span>
<a href="#l13.419"></a><span id="l13.419"> </span>
<a href="#l13.420"></a><span id="l13.420">   startupCacheMonitor.check(false);</span>
<a href="#l13.421"></a><span id="l13.421"> </span>
<a href="#l13.422"></a><span id="l13.422">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.423"></a><span id="l13.423">   notEqual(b1, null);</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineat">@@ -599,41 +598,37 @@ add_task(async function test_10() {</span>
<a href="#l13.425"></a><span id="l13.425">   ok(b1.isActive);</span>
<a href="#l13.426"></a><span id="l13.426">   ok(!b1.isSystem);</span>
<a href="#l13.427"></a><span id="l13.427">   BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l13.428"></a><span id="l13.428">   BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l13.429"></a><span id="l13.429">   equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l13.430"></a><span id="l13.430">   equal(getStartupOldVersion(), undefined);</span>
<a href="#l13.431"></a><span id="l13.431">   do_check_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l13.432"></a><span id="l13.432"> </span>
<a href="#l13.433"></a><span id="l13.433" class="difflineminus">-  prepare_test({}, [</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-    &quot;onNewInstall&quot;,</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-  ]);</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l13.437"></a><span id="l13.437"> </span>
<a href="#l13.438"></a><span id="l13.438">   install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_1);</span>
<a href="#l13.439"></a><span id="l13.439">   ensure_test_completed();</span>
<a href="#l13.440"></a><span id="l13.440"> </span>
<a href="#l13.441"></a><span id="l13.441">   notEqual(install, null);</span>
<a href="#l13.442"></a><span id="l13.442">   equal(install.type, &quot;extension&quot;);</span>
<a href="#l13.443"></a><span id="l13.443">   equal(install.version, &quot;1.0&quot;);</span>
<a href="#l13.444"></a><span id="l13.444">   equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l13.445"></a><span id="l13.445">   equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l13.446"></a><span id="l13.446"> </span>
<a href="#l13.447"></a><span id="l13.447">   await Promise.all([</span>
<a href="#l13.448"></a><span id="l13.448">     BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l13.449"></a><span id="l13.449">     new Promise(resolve =&gt; {</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineminus">-      prepare_test({</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineminus">-        [ID1]: [</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineminus">-          [&quot;onInstalling&quot;, false],</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-          &quot;onInstalled&quot;,</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-        ],</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-      }, [</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-        &quot;onInstallStarted&quot;,</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-        &quot;onInstallEnded&quot;,</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-      ], resolve);</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+      prepare_test(</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+        {</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineplus">+          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+        },</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+        resolve</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+      );</span>
<a href="#l13.466"></a><span id="l13.466">       install.install();</span>
<a href="#l13.467"></a><span id="l13.467">     }),</span>
<a href="#l13.468"></a><span id="l13.468">   ]);</span>
<a href="#l13.469"></a><span id="l13.469"> </span>
<a href="#l13.470"></a><span id="l13.470">   startupCacheMonitor.check(true);</span>
<a href="#l13.471"></a><span id="l13.471"> </span>
<a href="#l13.472"></a><span id="l13.472">   b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.473"></a><span id="l13.473">   notEqual(b1, null);</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineat">@@ -770,24 +765,28 @@ add_task(async function test_18() {</span>
<a href="#l13.475"></a><span id="l13.475">   startupCacheMonitor.check(false);</span>
<a href="#l13.476"></a><span id="l13.476"> });</span>
<a href="#l13.477"></a><span id="l13.477"> </span>
<a href="#l13.478"></a><span id="l13.478"> // Check that uninstalling the profile version reveals the non-profile one</span>
<a href="#l13.479"></a><span id="l13.479"> add_task(async function test_19() {</span>
<a href="#l13.480"></a><span id="l13.480">   let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.481"></a><span id="l13.481">   // The revealed add-on gets activated asynchronously</span>
<a href="#l13.482"></a><span id="l13.482">   await new Promise(resolve =&gt; {</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineminus">-    prepare_test({</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineminus">-      [ID1]: [</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineminus">-        [&quot;onUninstalling&quot;, false],</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineminus">-        &quot;onUninstalled&quot;,</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineminus">-        [&quot;onInstalling&quot;, false],</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineminus">-        &quot;onInstalled&quot;,</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineminus">-      ],</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineminus">-    }, [], resolve);</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+    prepare_test(</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+      {</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+        [ID1]: [</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+          [&quot;onUninstalling&quot;, false],</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+          &quot;onUninstalled&quot;,</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+          [&quot;onInstalling&quot;, false],</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineplus">+          &quot;onInstalled&quot;,</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+        ],</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+      },</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+      [],</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+      resolve</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+    );</span>
<a href="#l13.503"></a><span id="l13.503"> </span>
<a href="#l13.504"></a><span id="l13.504">     b1.uninstall();</span>
<a href="#l13.505"></a><span id="l13.505">   });</span>
<a href="#l13.506"></a><span id="l13.506"> </span>
<a href="#l13.507"></a><span id="l13.507">   startupCacheMonitor.check(true);</span>
<a href="#l13.508"></a><span id="l13.508"> </span>
<a href="#l13.509"></a><span id="l13.509">   b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l13.510"></a><span id="l13.510">   // Should have reverted to the older version</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap_const.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap_const.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -14,17 +14,18 @@ const ADDONS = {</span>
<a href="#l14.4"></a><span id="l14.4">       },</span>
<a href="#l14.5"></a><span id="l14.5">       legacy: {</span>
<a href="#l14.6"></a><span id="l14.6">         type: &quot;bootstrap&quot;,</span>
<a href="#l14.7"></a><span id="l14.7">       },</span>
<a href="#l14.8"></a><span id="l14.8">       manifest_version: 2,</span>
<a href="#l14.9"></a><span id="l14.9">       name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l14.10"></a><span id="l14.10">       version: &quot;1.0&quot;,</span>
<a href="#l14.11"></a><span id="l14.11">     }),</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    &quot;bootstrap.js&quot;: &quot;var {Services} = ChromeUtils.import(\&quot;resource://gre/modules/Services.jsm\&quot;);\n\nconst install = function() {\n  Services.obs.notifyObservers(null, \&quot;addon-install\&quot;);\n};\n&quot;,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    &quot;bootstrap.js&quot;:</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      'var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);\n\nconst install = function() {\n  Services.obs.notifyObservers(null, &quot;addon-install&quot;);\n};\n',</span>
<a href="#l14.15"></a><span id="l14.15">   },</span>
<a href="#l14.16"></a><span id="l14.16"> };</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> add_task(async function() {</span>
<a href="#l14.19"></a><span id="l14.19">   await promiseStartupManager();</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   let sawInstall = false;</span>
<a href="#l14.22"></a><span id="l14.22">   Services.obs.addObserver(function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap_globals.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrap_globals.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l15.5"></a><span id="l15.5">  * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l15.6"></a><span id="l15.6">  */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> // This verifies that bootstrap.js has the expected globals defined</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12"> createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> const ADDONS = {</span>
<a href="#l15.15"></a><span id="l15.15">   bootstrap_globals: {</span>
<a href="#l15.16"></a><span id="l15.16">     &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l15.17"></a><span id="l15.17">       applications: {</span>
<a href="#l15.18"></a><span id="l15.18">         gecko: {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineat">@@ -43,33 +43,31 @@ function startup(data, reason) {</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21"> function install(data, reason) {}</span>
<a href="#l15.22"></a><span id="l15.22"> function shutdown(data, reason) {}</span>
<a href="#l15.23"></a><span id="l15.23"> function uninstall(data, reason) {}</span>
<a href="#l15.24"></a><span id="l15.24"> `,</span>
<a href="#l15.25"></a><span id="l15.25">   },</span>
<a href="#l15.26"></a><span id="l15.26"> };</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-const EXPECTED_GLOBALS = [</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-  [&quot;console&quot;, &quot;object&quot;],</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-];</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+const EXPECTED_GLOBALS = [[&quot;console&quot;, &quot;object&quot;]];</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34"> async function run_test() {</span>
<a href="#l15.35"></a><span id="l15.35">   do_test_pending();</span>
<a href="#l15.36"></a><span id="l15.36">   await promiseStartupManager();</span>
<a href="#l15.37"></a><span id="l15.37">   let sawGlobals = false;</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">   Services.obs.addObserver(function(subject) {</span>
<a href="#l15.40"></a><span id="l15.40">     subject.wrappedJSObject.expectedGlobals = EXPECTED_GLOBALS;</span>
<a href="#l15.41"></a><span id="l15.41">   }, &quot;bootstrap-request-globals&quot;);</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43">   Services.obs.addObserver(function({ wrappedJSObject: seenGlobals }) {</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-    for (let [name ] of EXPECTED_GLOBALS)</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+    for (let [name] of EXPECTED_GLOBALS) {</span>
<a href="#l15.46"></a><span id="l15.46">       Assert.ok(seenGlobals.has(name));</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+    }</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">     sawGlobals = true;</span>
<a href="#l15.50"></a><span id="l15.50">   }, &quot;bootstrap-seen-globals&quot;);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52">   await AddonTestUtils.promiseInstallXPI(ADDONS.bootstrap_globals);</span>
<a href="#l15.53"></a><span id="l15.53">   Assert.ok(sawGlobals);</span>
<a href="#l15.54"></a><span id="l15.54">   await promiseShutdownManager();</span>
<a href="#l15.55"></a><span id="l15.55">   do_test_finished();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/common/test/xpcshell/test_bootstrapped_chrome_manifest.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/common/test/xpcshell/test_bootstrapped_chrome_manifest.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -23,29 +23,32 @@ const ADDON = {</span>
<a href="#l16.4"></a><span id="l16.4"> add_task(async function run_test() {</span>
<a href="#l16.5"></a><span id="l16.5">   createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l16.6"></a><span id="l16.6">   await promiseStartupManager();</span>
<a href="#l16.7"></a><span id="l16.7"> });</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> function checkActive(expected) {</span>
<a href="#l16.10"></a><span id="l16.10">   let target = { active: false };</span>
<a href="#l16.11"></a><span id="l16.11">   let load = () =&gt; {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    Services.scriptloader.loadSubScript(&quot;chrome://bug675371/content/test.js&quot;, target);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    Services.scriptloader.loadSubScript(</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+      &quot;chrome://bug675371/content/test.js&quot;,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+      target</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+    );</span>
<a href="#l16.17"></a><span id="l16.17">   };</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">   if (expected) {</span>
<a href="#l16.20"></a><span id="l16.20">     load();</span>
<a href="#l16.21"></a><span id="l16.21">   } else {</span>
<a href="#l16.22"></a><span id="l16.22">     Assert.throws(load, /Error opening input stream/);</span>
<a href="#l16.23"></a><span id="l16.23">   }</span>
<a href="#l16.24"></a><span id="l16.24">   equal(target.active, expected, &quot;Manifest is active?&quot;);</span>
<a href="#l16.25"></a><span id="l16.25"> }</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27"> add_task(async function test() {</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  let {addon} = await AddonTestUtils.promiseInstallXPI(ADDON);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  let { addon } = await AddonTestUtils.promiseInstallXPI(ADDON);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31">   Assert.ok(addon.isActive);</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">   // Tests that chrome.manifest is registered when the addon is installed.</span>
<a href="#l16.34"></a><span id="l16.34">   checkActive(true);</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   await addon.disable();</span>
<a href="#l16.37"></a><span id="l16.37">   checkActive(false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPProtocolHandler.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPProtocolHandler.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,48 +1,62 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+);</span>
<a href="#l17.12"></a><span id="l17.12"> </span>
<a href="#l17.13"></a><span id="l17.13"> const kNetworkProtocolCIDPrefix = &quot;@mozilla.org/network/protocol;1?name=&quot;;</span>
<a href="#l17.14"></a><span id="l17.14"> const nsIProtocolHandler = Ci.nsIProtocolHandler;</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> function makeProtocolHandler(aCID, aProtocol, aDefaultPort) {</span>
<a href="#l17.17"></a><span id="l17.17">   return {</span>
<a href="#l17.18"></a><span id="l17.18">     classID: Components.ID(aCID),</span>
<a href="#l17.19"></a><span id="l17.19">     QueryInterface: ChromeUtils.generateQI([nsIProtocolHandler]),</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">     scheme: aProtocol,</span>
<a href="#l17.22"></a><span id="l17.22">     defaultPort: aDefaultPort,</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-    protocolFlags: nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-                   nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-                   nsIProtocolHandler.ALLOWS_PROXY,</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+    protocolFlags:</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+      nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+      nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+      nsIProtocolHandler.ALLOWS_PROXY,</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31">     newChannel(aURI, aLoadInfo) {</span>
<a href="#l17.32"></a><span id="l17.32">       if (&quot;@mozilla.org/network/ldap-channel;1&quot; in Cc) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-        var channel = Cc[&quot;@mozilla.org/network/ldap-channel;1&quot;]</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-                        .createInstance(Ci.nsIChannel);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+        var channel = Cc[&quot;@mozilla.org/network/ldap-channel;1&quot;].createInstance(</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+          Ci.nsIChannel</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+        );</span>
<a href="#l17.38"></a><span id="l17.38">         channel.init(aURI);</span>
<a href="#l17.39"></a><span id="l17.39">         channel.loadInfo = aLoadInfo;</span>
<a href="#l17.40"></a><span id="l17.40">         return channel;</span>
<a href="#l17.41"></a><span id="l17.41">       }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">       throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.44"></a><span id="l17.44">     },</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">     allowPort(port, scheme) {</span>
<a href="#l17.47"></a><span id="l17.47">       return port == aDefaultPort;</span>
<a href="#l17.48"></a><span id="l17.48">     },</span>
<a href="#l17.49"></a><span id="l17.49">   };</span>
<a href="#l17.50"></a><span id="l17.50"> }</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52"> function nsLDAPProtocolHandler() {}</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-nsLDAPProtocolHandler.prototype = makeProtocolHandler(&quot;{b3de9249-b0e5-4c12-8d91-c9a434fd80f5}&quot;, &quot;ldap&quot;, 389);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+nsLDAPProtocolHandler.prototype = makeProtocolHandler(</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  &quot;{b3de9249-b0e5-4c12-8d91-c9a434fd80f5}&quot;,</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+  &quot;ldap&quot;,</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+  389</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+);</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61"> function nsLDAPSProtocolHandler() {}</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-nsLDAPSProtocolHandler.prototype = makeProtocolHandler(&quot;{c85a5ef2-9c56-445f-b029-76889f2dd29b}&quot;, &quot;ldaps&quot;, 636);</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+nsLDAPSProtocolHandler.prototype = makeProtocolHandler(</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  &quot;{c85a5ef2-9c56-445f-b029-76889f2dd29b}&quot;,</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+  &quot;ldaps&quot;,</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  636</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+);</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-const NSGetFactory = XPCOMUtils.generateNSGetFactory([nsLDAPProtocolHandler,</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-                                                      nsLDAPSProtocolHandler]);</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  nsLDAPProtocolHandler,</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  nsLDAPSProtocolHandler,</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/ldap/xpcom/tests/unit/test_nsLDAPURL.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/ldap/xpcom/tests/unit/test_nsLDAPURL.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /*</span>
<a href="#l18.6"></a><span id="l18.6">  * Test suite for nsLDAPURL functions.</span>
<a href="#l18.7"></a><span id="l18.7">  */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12"> // If we are still using the wallet service, then default port numbers</span>
<a href="#l18.13"></a><span id="l18.13"> // are still visible in the password manager, and therefore we need to have</span>
<a href="#l18.14"></a><span id="l18.14"> // them in the url. The toolkit login manager doesn't do this.</span>
<a href="#l18.15"></a><span id="l18.15"> const usingWallet = &quot;nsIWalletService&quot; in Ci;</span>
<a href="#l18.16"></a><span id="l18.16"> const portAdpt = usingWallet ? &quot;:389&quot; : &quot;&quot;;</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> const ldapURLs = [</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineat">@@ -26,55 +26,66 @@ const ldapURLs = [</span>
<a href="#l18.20"></a><span id="l18.20">     displaySpec: &quot;ldap://localhost/dc=test&quot;,</span>
<a href="#l18.21"></a><span id="l18.21">     displayPrePath: &quot;ldap://localhost&quot;,</span>
<a href="#l18.22"></a><span id="l18.22">     displayHost: &quot;localhost&quot;,</span>
<a href="#l18.23"></a><span id="l18.23">     displayHostPort: &quot;localhost&quot;,</span>
<a href="#l18.24"></a><span id="l18.24">     dn: &quot;dc=test&quot;,</span>
<a href="#l18.25"></a><span id="l18.25">     scope: Ci.nsILDAPURL.SCOPE_BASE,</span>
<a href="#l18.26"></a><span id="l18.26">     filter: &quot;(objectclass=*)&quot;,</span>
<a href="#l18.27"></a><span id="l18.27">     options: 0,</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-  }, {</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+  },</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  {</span>
<a href="#l18.31"></a><span id="l18.31">     url: &quot;ldap://localhost:389/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    spec: &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    asciiSpec: &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    spec:</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+      &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+    asciiSpec:</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+      &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.38"></a><span id="l18.38">     host: &quot;localhost&quot;,</span>
<a href="#l18.39"></a><span id="l18.39">     asciiHost: &quot;localhost&quot;,</span>
<a href="#l18.40"></a><span id="l18.40">     port: usingWallet ? 389 : -1,</span>
<a href="#l18.41"></a><span id="l18.41">     scheme: &quot;ldap&quot;,</span>
<a href="#l18.42"></a><span id="l18.42">     path: &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.43"></a><span id="l18.43">     prePath: &quot;ldap://localhost&quot; + portAdpt,</span>
<a href="#l18.44"></a><span id="l18.44">     hostPort: &quot;localhost&quot; + portAdpt,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-    displaySpec: &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    displaySpec:</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+      &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l18.48"></a><span id="l18.48">     displayPrePath: &quot;ldap://localhost&quot;,</span>
<a href="#l18.49"></a><span id="l18.49">     displayHost: &quot;localhost&quot;,</span>
<a href="#l18.50"></a><span id="l18.50">     displayHostPort: &quot;localhost&quot; + portAdpt,</span>
<a href="#l18.51"></a><span id="l18.51">     dn: &quot;dc=test,dc=abc&quot;,</span>
<a href="#l18.52"></a><span id="l18.52">     scope: Ci.nsILDAPURL.SCOPE_SUBTREE,</span>
<a href="#l18.53"></a><span id="l18.53">     filter: &quot;(objectclass=*)&quot;,</span>
<a href="#l18.54"></a><span id="l18.54">     options: 0,</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  }, {</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  },</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  {</span>
<a href="#l18.58"></a><span id="l18.58">     url: &quot;ldap://\u65e5\u672c\u8a93.jp:389/dc=tes\u65e5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-    spec: &quot;ldap://xn--wgv71a309e.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    asciiSpec: &quot;ldap://xn--wgv71a309e.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+    spec:</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+      &quot;ldap://xn--wgv71a309e.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+    asciiSpec:</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+      &quot;ldap://xn--wgv71a309e.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.65"></a><span id="l18.65">     host: &quot;xn--wgv71a309e.jp&quot;,</span>
<a href="#l18.66"></a><span id="l18.66">     asciiHost: &quot;xn--wgv71a309e.jp&quot;,</span>
<a href="#l18.67"></a><span id="l18.67">     port: usingWallet ? 389 : -1,</span>
<a href="#l18.68"></a><span id="l18.68">     scheme: &quot;ldap&quot;,</span>
<a href="#l18.69"></a><span id="l18.69">     path: &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.70"></a><span id="l18.70">     prePath: &quot;ldap://xn--wgv71a309e.jp&quot; + portAdpt,</span>
<a href="#l18.71"></a><span id="l18.71">     hostPort: &quot;xn--wgv71a309e.jp&quot; + portAdpt,</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-    displaySpec: &quot;ldap://\u65e5\u672c\u8a93.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+    displaySpec:</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+      &quot;ldap://\u65e5\u672c\u8a93.jp&quot; +</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+      portAdpt +</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+      &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l18.77"></a><span id="l18.77">     displayPrePath: &quot;ldap://\u65e5\u672c\u8a93.jp&quot; + portAdpt,</span>
<a href="#l18.78"></a><span id="l18.78">     displayHost: &quot;\u65e5\u672c\u8a93.jp&quot;,</span>
<a href="#l18.79"></a><span id="l18.79">     displayHostPort: &quot;\u65e5\u672c\u8a93.jp&quot; + portAdpt,</span>
<a href="#l18.80"></a><span id="l18.80">     dn: &quot;dc=tes\u65e5t&quot;,</span>
<a href="#l18.81"></a><span id="l18.81">     scope: Ci.nsILDAPURL.SCOPE_ONELEVEL,</span>
<a href="#l18.82"></a><span id="l18.82">     filter: &quot;(oc=xyz)&quot;,</span>
<a href="#l18.83"></a><span id="l18.83">     options: 0,</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-  }, {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+  },</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  {</span>
<a href="#l18.87"></a><span id="l18.87">     url: &quot;ldaps://localhost/dc=test&quot;,</span>
<a href="#l18.88"></a><span id="l18.88">     spec: &quot;ldaps://localhost/dc=test&quot;,</span>
<a href="#l18.89"></a><span id="l18.89">     asciiSpec: &quot;ldaps://localhost/dc=test&quot;,</span>
<a href="#l18.90"></a><span id="l18.90">     host: &quot;localhost&quot;,</span>
<a href="#l18.91"></a><span id="l18.91">     asciiHost: &quot;localhost&quot;,</span>
<a href="#l18.92"></a><span id="l18.92">     port: -1,</span>
<a href="#l18.93"></a><span id="l18.93">     scheme: &quot;ldaps&quot;,</span>
<a href="#l18.94"></a><span id="l18.94">     path: &quot;/dc=test&quot;,</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineat">@@ -129,116 +140,183 @@ function run_test() {</span>
<a href="#l18.96"></a><span id="l18.96"> </span>
<a href="#l18.97"></a><span id="l18.97">   url = Services.io.newURI(kBaseURL).QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.98"></a><span id="l18.98"> </span>
<a href="#l18.99"></a><span id="l18.99">   // Test - dn</span>
<a href="#l18.100"></a><span id="l18.100"> </span>
<a href="#l18.101"></a><span id="l18.101">   url.dn = &quot;dc=short&quot;;</span>
<a href="#l18.102"></a><span id="l18.102"> </span>
<a href="#l18.103"></a><span id="l18.103">   Assert.equal(url.dn, &quot;dc=short&quot;);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??sub?(objectclass=*)&quot;);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+    url.spec,</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??sub?(objectclass=*)&quot;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  );</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110">   // Test - scope</span>
<a href="#l18.111"></a><span id="l18.111"> </span>
<a href="#l18.112"></a><span id="l18.112">   url.scope = Ci.nsILDAPURL.SCOPE_BASE;</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114">   Assert.equal(url.scope, Ci.nsILDAPURL.SCOPE_BASE);</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short???(objectclass=*)&quot;);</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+    url.spec,</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short???(objectclass=*)&quot;</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+  );</span>
<a href="#l18.120"></a><span id="l18.120"> </span>
<a href="#l18.121"></a><span id="l18.121">   url.scope = Ci.nsILDAPURL.SCOPE_ONELEVEL;</span>
<a href="#l18.122"></a><span id="l18.122"> </span>
<a href="#l18.123"></a><span id="l18.123">   Assert.equal(url.scope, Ci.nsILDAPURL.SCOPE_ONELEVEL);</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+    url.spec,</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  );</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130">   // Test - filter</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132">   url.filter = &quot;(oc=ygh)&quot;;</span>
<a href="#l18.133"></a><span id="l18.133"> </span>
<a href="#l18.134"></a><span id="l18.134">   Assert.equal(url.filter, &quot;(oc=ygh)&quot;);</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(oc=ygh)&quot;);</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+    url.spec,</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(oc=ygh)&quot;</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  );</span>
<a href="#l18.140"></a><span id="l18.140"> </span>
<a href="#l18.141"></a><span id="l18.141">   url.filter = &quot;&quot;;</span>
<a href="#l18.142"></a><span id="l18.142"> </span>
<a href="#l18.143"></a><span id="l18.143">   Assert.equal(url.filter, &quot;(objectclass=*)&quot;);</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+    url.spec,</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+  );</span>
<a href="#l18.149"></a><span id="l18.149"> </span>
<a href="#l18.150"></a><span id="l18.150">   // Test - scheme</span>
<a href="#l18.151"></a><span id="l18.151"> </span>
<a href="#l18.152"></a><span id="l18.152">   // An old version used to have a bug whereby if you set the scheme to the</span>
<a href="#l18.153"></a><span id="l18.153">   // same thing twice, you'd get the options set wrongly.</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-  url = url.mutate().setScheme(&quot;ldaps&quot;).finalize().QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+  url = url</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+    .mutate()</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+    .setScheme(&quot;ldaps&quot;)</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+    .finalize()</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.160"></a><span id="l18.160">   Assert.equal(url.options, 1);</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-  Assert.equal(url.spec, &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-  url = url.mutate().setScheme(&quot;ldaps&quot;).finalize().QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+    url.spec,</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+    &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+  );</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+  url = url</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+    .mutate()</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+    .setScheme(&quot;ldaps&quot;)</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+    .finalize()</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.172"></a><span id="l18.172">   Assert.equal(url.options, 1);</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-  Assert.equal(url.spec, &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+    url.spec,</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+    &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+  );</span>
<a href="#l18.178"></a><span id="l18.178"> </span>
<a href="#l18.179"></a><span id="l18.179">   Assert.ok(url.schemeIs(&quot;ldaps&quot;));</span>
<a href="#l18.180"></a><span id="l18.180">   Assert.ok(!url.schemeIs(&quot;ldap&quot;));</span>
<a href="#l18.181"></a><span id="l18.181"> </span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-  url = url.mutate().setScheme(&quot;ldap&quot;).finalize().QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+  url = url</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+    .mutate()</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+    .setScheme(&quot;ldap&quot;)</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+    .finalize()</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.188"></a><span id="l18.188">   Assert.equal(url.options, 0);</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-  url = url.mutate().setScheme(&quot;ldap&quot;).finalize().QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+    url.spec,</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+  );</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+  url = url</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+    .mutate()</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+    .setScheme(&quot;ldap&quot;)</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+    .finalize()</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.200"></a><span id="l18.200">   Assert.equal(url.options, 0);</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+    url.spec,</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+  );</span>
<a href="#l18.206"></a><span id="l18.206"> </span>
<a href="#l18.207"></a><span id="l18.207">   Assert.ok(url.schemeIs(&quot;ldap&quot;));</span>
<a href="#l18.208"></a><span id="l18.208">   Assert.ok(!url.schemeIs(&quot;ldaps&quot;));</span>
<a href="#l18.209"></a><span id="l18.209"> </span>
<a href="#l18.210"></a><span id="l18.210">   // Test - Options</span>
<a href="#l18.211"></a><span id="l18.211"> </span>
<a href="#l18.212"></a><span id="l18.212">   url.options = Ci.nsILDAPURL.OPT_SECURE;</span>
<a href="#l18.213"></a><span id="l18.213"> </span>
<a href="#l18.214"></a><span id="l18.214">   Assert.equal(url.options, Ci.nsILDAPURL.OPT_SECURE);</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-  Assert.equal(url.spec, &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+    url.spec,</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+    &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+  );</span>
<a href="#l18.220"></a><span id="l18.220"> </span>
<a href="#l18.221"></a><span id="l18.221">   url.options = 0;</span>
<a href="#l18.222"></a><span id="l18.222"> </span>
<a href="#l18.223"></a><span id="l18.223">   Assert.equal(url.options, 0);</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+    url.spec,</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+  );</span>
<a href="#l18.229"></a><span id="l18.229"> </span>
<a href="#l18.230"></a><span id="l18.230">   // Test - Equals</span>
<a href="#l18.231"></a><span id="l18.231"> </span>
<a href="#l18.232"></a><span id="l18.232" class="difflineminus">-  var url2 = Services.io.newURI(&quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;)</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineminus">-                        .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+  var url2 = Services.io</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+    .newURI(&quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;)</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.237"></a><span id="l18.237"> </span>
<a href="#l18.238"></a><span id="l18.238">   Assert.ok(url.equals(url2));</span>
<a href="#l18.239"></a><span id="l18.239"> </span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-  url2 = url2.mutate().setSpec(&quot;ldap://localhost:389/dc=short??sub?(objectclass=*)&quot;).finalize();</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+  url2 = url2</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineplus">+    .mutate()</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineplus">+    .setSpec(&quot;ldap://localhost:389/dc=short??sub?(objectclass=*)&quot;)</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+    .finalize();</span>
<a href="#l18.245"></a><span id="l18.245"> </span>
<a href="#l18.246"></a><span id="l18.246">   Assert.ok(!url.equals(url2));</span>
<a href="#l18.247"></a><span id="l18.247"> </span>
<a href="#l18.248"></a><span id="l18.248">   // Test Attributes</span>
<a href="#l18.249"></a><span id="l18.249"> </span>
<a href="#l18.250"></a><span id="l18.250">   Assert.equal(url.attributes.length, 0);</span>
<a href="#l18.251"></a><span id="l18.251"> </span>
<a href="#l18.252"></a><span id="l18.252">   // Nothing should happen if the attribute doesn't exist</span>
<a href="#l18.253"></a><span id="l18.253">   url.removeAttribute(&quot;abc&quot;);</span>
<a href="#l18.254"></a><span id="l18.254"> </span>
<a href="#l18.255"></a><span id="l18.255">   Assert.equal(url.attributes.length, 0);</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineplus">+    url.spec,</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+  );</span>
<a href="#l18.261"></a><span id="l18.261"> </span>
<a href="#l18.262"></a><span id="l18.262">   url.addAttribute(&quot;dn&quot;);</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?dn?one?(objectclass=*)&quot;);</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineplus">+    url.spec,</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?dn?one?(objectclass=*)&quot;</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+  );</span>
<a href="#l18.268"></a><span id="l18.268"> </span>
<a href="#l18.269"></a><span id="l18.269">   Assert.equal(url.attributes, &quot;dn&quot;);</span>
<a href="#l18.270"></a><span id="l18.270"> </span>
<a href="#l18.271"></a><span id="l18.271">   url.removeAttribute(&quot;dn&quot;);</span>
<a href="#l18.272"></a><span id="l18.272"> </span>
<a href="#l18.273"></a><span id="l18.273">   Assert.equal(url.attributes.length, 0);</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+    url.spec,</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineplus">+  );</span>
<a href="#l18.279"></a><span id="l18.279"> </span>
<a href="#l18.280"></a><span id="l18.280">   var newAttrs = &quot;abc,def,ghi,jkl&quot;;</span>
<a href="#l18.281"></a><span id="l18.281">   url.attributes = newAttrs;</span>
<a href="#l18.282"></a><span id="l18.282"> </span>
<a href="#l18.283"></a><span id="l18.283">   Assert.equal(url.attributes, newAttrs);</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-  Assert.equal(url.spec,</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-               &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?&quot; +</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-               newAttrs + &quot;?one?(objectclass=*)&quot;);</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+    url.spec,</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineplus">+    &quot;ldap://localhost&quot; +</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+      portAdpt +</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+      &quot;/dc=short?&quot; +</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+      newAttrs +</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineplus">+      &quot;?one?(objectclass=*)&quot;</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+  );</span>
<a href="#l18.295"></a><span id="l18.295"> </span>
<a href="#l18.296"></a><span id="l18.296">   // Try adding an existing attribute - should do nothing</span>
<a href="#l18.297"></a><span id="l18.297">   url.addAttribute(&quot;def&quot;);</span>
<a href="#l18.298"></a><span id="l18.298">   Assert.equal(url.attributes, newAttrs);</span>
<a href="#l18.299"></a><span id="l18.299"> </span>
<a href="#l18.300"></a><span id="l18.300">   //  url.addAttribute(&quot;jk&quot;);</span>
<a href="#l18.301"></a><span id="l18.301"> </span>
<a href="#l18.302"></a><span id="l18.302">   Assert.ok(url.hasAttribute(&quot;jkl&quot;));</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineat">@@ -254,44 +332,65 @@ function run_test() {</span>
<a href="#l18.304"></a><span id="l18.304">   url.removeAttribute(&quot;jk&quot;);</span>
<a href="#l18.305"></a><span id="l18.305">   url.removeAttribute(&quot;ef&quot;);</span>
<a href="#l18.306"></a><span id="l18.306">   Assert.equal(url.attributes, newAttrs);</span>
<a href="#l18.307"></a><span id="l18.307"> </span>
<a href="#l18.308"></a><span id="l18.308">   url.removeAttribute(&quot;abc&quot;);</span>
<a href="#l18.309"></a><span id="l18.309">   newAttrs = newAttrs.substring(4);</span>
<a href="#l18.310"></a><span id="l18.310"> </span>
<a href="#l18.311"></a><span id="l18.311">   Assert.equal(url.attributes, newAttrs);</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-  Assert.equal(url.spec,</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineminus">-               &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?&quot; +</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineminus">-               newAttrs + &quot;?one?(objectclass=*)&quot;);</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineplus">+    url.spec,</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+    &quot;ldap://localhost&quot; +</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+      portAdpt +</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+      &quot;/dc=short?&quot; +</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+      newAttrs +</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineplus">+      &quot;?one?(objectclass=*)&quot;</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineplus">+  );</span>
<a href="#l18.323"></a><span id="l18.323"> </span>
<a href="#l18.324"></a><span id="l18.324">   // This shouldn't fail, just clear the list</span>
<a href="#l18.325"></a><span id="l18.325">   url.attributes = &quot;&quot;;</span>
<a href="#l18.326"></a><span id="l18.326"> </span>
<a href="#l18.327"></a><span id="l18.327">   Assert.equal(url.attributes.length, 0);</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineminus">-  Assert.equal(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineplus">+    url.spec,</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineplus">+    &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineplus">+  );</span>
<a href="#l18.333"></a><span id="l18.333"> </span>
<a href="#l18.334"></a><span id="l18.334">   // Set attributes via the url spec</span>
<a href="#l18.335"></a><span id="l18.335"> </span>
<a href="#l18.336"></a><span id="l18.336">   newAttrs = &quot;abc,def,ghi,jkl&quot;;</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineminus">-  url = url.mutate().setSpec(&quot;ldap://localhost/dc=short?&quot; + newAttrs + &quot;?one?(objectclass=*)&quot;)</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineminus">-                    .finalize().QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+  url = url</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineplus">+    .mutate()</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineplus">+    .setSpec(&quot;ldap://localhost/dc=short?&quot; + newAttrs + &quot;?one?(objectclass=*)&quot;)</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineplus">+    .finalize()</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.344"></a><span id="l18.344"> </span>
<a href="#l18.345"></a><span id="l18.345">   Assert.equal(url.attributes, newAttrs);</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineminus">-  Assert.equal(url.spec,</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-               &quot;ldap://localhost/dc=short?&quot; + newAttrs + &quot;?one?(objectclass=*)&quot;);</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineplus">+    url.spec,</span>
<a href="#l18.350"></a><span id="l18.350" class="difflineplus">+    &quot;ldap://localhost/dc=short?&quot; + newAttrs + &quot;?one?(objectclass=*)&quot;</span>
<a href="#l18.351"></a><span id="l18.351" class="difflineplus">+  );</span>
<a href="#l18.352"></a><span id="l18.352"> </span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-  url = url.mutate().setSpec(&quot;ldap://localhost/dc=short??one?(objectclass=*)&quot;)</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-                    .finalize().QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineplus">+  url = url</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineplus">+    .mutate()</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineplus">+    .setSpec(&quot;ldap://localhost/dc=short??one?(objectclass=*)&quot;)</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineplus">+    .finalize()</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineplus">+    .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l18.360"></a><span id="l18.360"> </span>
<a href="#l18.361"></a><span id="l18.361">   var attrs = url.attributes;</span>
<a href="#l18.362"></a><span id="l18.362">   Assert.equal(attrs.length, 0);</span>
<a href="#l18.363"></a><span id="l18.363">   Assert.equal(url.spec, &quot;ldap://localhost/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l18.364"></a><span id="l18.364"> </span>
<a href="#l18.365"></a><span id="l18.365">   // Test - clone</span>
<a href="#l18.366"></a><span id="l18.366"> </span>
<a href="#l18.367"></a><span id="l18.367" class="difflineminus">-  url = url.mutate().setSpec(&quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;).finalize();</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineplus">+  url = url</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineplus">+    .mutate()</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineplus">+    .setSpec(&quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;)</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineplus">+    .finalize();</span>
<a href="#l18.372"></a><span id="l18.372"> </span>
<a href="#l18.373"></a><span id="l18.373">   var newUrl = url.mutate().finalize();</span>
<a href="#l18.374"></a><span id="l18.374"> </span>
<a href="#l18.375"></a><span id="l18.375" class="difflineminus">-  Assert.equal(newUrl.spec,</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineminus">-               &quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;);</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineplus">+  Assert.equal(</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineplus">+    newUrl.spec,</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineplus">+    &quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineplus">+  );</span>
<a href="#l18.381"></a><span id="l18.381"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

