<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8686:9205412330a6d7e2456f98a5758567a6c718b5d2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9205412330a6d7e2456f98a5758567a6c718b5d2" />
<meta property="og:url" content="/comm-central/rev/9205412330a6d7e2456f98a5758567a6c718b5d2" />
<meta property="og:description" content="finish getting rid of our use of xpcom proxies, r=standard8, bug 675407" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9205412330a6d7e2456f98a5758567a6c718b5d2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9205412330a6d7e2456f98a5758567a6c718b5d2">shortlog</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9205412330a6d7e2456f98a5758567a6c718b5d2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2">files</a> |
changeset |
<a href="/comm-central/raw-rev/9205412330a6d7e2456f98a5758567a6c718b5d2">raw</a>  | <a href="/comm-central/archive/9205412330a6d7e2456f98a5758567a6c718b5d2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
finish getting rid of our use of xpcom proxies, r=standard8, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=675407">bug 675407</a>
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 21 Oct 2011 14:24:53 -0700</td></tr>

<tr>
 <td>changeset 8686</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9205412330a6d7e2456f98a5758567a6c718b5d2">9205412330a6d7e2456f98a5758567a6c718b5d2</a></td>
</tr>



<tr>
<td>parent 8685</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ee0587158a5de3918d48e0e9d92671e60790aa31">ee0587158a5de3918d48e0e9d92671e60790aa31</a>
</td>
</tr>

<tr>
<td>child 8687</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4c71825eecd2e547d8f95680e4899c12ad7c5888">4c71825eecd2e547d8f95680e4899c12ad7c5888</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9205412330a6d7e2456f98a5758567a6c718b5d2">6681</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 21 Oct 2011 21:24:06 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9205412330a6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9205412330a6d7e2456f98a5758567a6c718b5d2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9205412330a6d7e2456f98a5758567a6c718b5d2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9205412330a6d7e2456f98a5758567a6c718b5d2&newProject=comm-central&newRevision=9205412330a6d7e2456f98a5758567a6c718b5d2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9205412330a6d7e2456f98a5758567a6c718b5d2&newProject=comm-central&newRevision=9205412330a6d7e2456f98a5758567a6c718b5d2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9205412330a6d7e2456f98a5758567a6c718b5d2&newProject=comm-central&newRevision=9205412330a6d7e2456f98a5758567a6c718b5d2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28bug%29&revcount=50">bug</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=675407">675407</a></td></tr>




</table></div>

<div class="page_body description">finish getting rid of our use of xpcom proxies, r=standard8, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=675407">bug 675407</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/base/util/nsMsgUtils.h">mailnews/base/util/nsMsgUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/base/util/nsMsgUtils.h">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/base/util/nsMsgUtils.h">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/base/util/nsMsgUtils.h">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/base/util/nsMsgUtils.h">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/base/util/nsMsgUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/Makefile.in">mailnews/imap/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.cpp">mailnews/imap/src/nsSyncRunnableHelpers.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.h">mailnews/imap/src/nsSyncRunnableHelpers.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.h">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.h">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.h">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.h">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/imap/src/nsSyncRunnableHelpers.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.cpp">mailnews/import/eudora/src/nsEudoraCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.h">mailnews/import/eudora/src/nsEudoraCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.h">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.h">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.h">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.h">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraImport.cpp">mailnews/import/eudora/src/nsEudoraImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraImport.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraImport.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraImport.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraImport.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/eudora/src/nsEudoraImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.cpp">mailnews/import/outlook/src/MapiMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.h">mailnews/import/outlook/src/MapiMessage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.h">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.h">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.h">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.h">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/MapiMessage.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.h">mailnews/import/outlook/src/nsOutlookCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.h">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.h">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.h">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.h">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookImport.cpp">mailnews/import/outlook/src/nsOutlookImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookImport.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookImport.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookImport.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookImport.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">mailnews/import/outlook/src/nsOutlookStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportMail.cpp">mailnews/import/src/nsImportMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportMail.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportMail.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportMail.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportMail.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportStringBundle.cpp">mailnews/import/src/nsImportStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/import/src/nsImportStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/9205412330a6d7e2456f98a5758567a6c718b5d2/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -43,17 +43,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIAddrBookSession.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsProxiedService.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;plstr.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l1.19"></a><span id="l1.19"> #include &quot;prmem.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -45,17 +45,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsISupportsArray.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIAtom.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> class nsILocalFile;</span>
<a href="#l2.17"></a><span id="l2.17"> class nsIPrefBranch;</span>
<a href="#l2.18"></a><span id="l2.18"> class nsIMsgFolder;</span>
<a href="#l2.19"></a><span id="l2.19"> class nsIMsgMessageService;</span>
<a href="#l2.20"></a><span id="l2.20"> class nsIUrlListener;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -331,18 +330,16 @@ NS_MSG_BASE PRUint64 ParseUint64Str(cons</span>
<a href="#l2.22"></a><span id="l2.22"> #define MsgReplaceSubstring(str, what, replacement) \</span>
<a href="#l2.23"></a><span id="l2.23">         (str).ReplaceSubstring(what, replacement)</span>
<a href="#l2.24"></a><span id="l2.24"> #define MsgIsUTF8(str) \</span>
<a href="#l2.25"></a><span id="l2.25">         IsUTF8(str)</span>
<a href="#l2.26"></a><span id="l2.26"> #define MsgNewInterfaceRequestorAggregation(aFirst, aSecond, aResult) \</span>
<a href="#l2.27"></a><span id="l2.27">         NS_NewInterfaceRequestorAggregation(aFirst, aSecond, aResult)</span>
<a href="#l2.28"></a><span id="l2.28"> #define MsgNewNotificationCallbacksAggregation(aCallbacks, aLoadGroup, aResult) \</span>
<a href="#l2.29"></a><span id="l2.29">         NS_NewNotificationCallbacksAggregation(aCallbacks, aLoadGroup, aResult)</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-#define MsgGetProxyForObject(aTarget, aIID, aObj, aProxyType, aProxyObject) \</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        NS_GetProxyForObject(aTarget, aIID, aObj, aProxyType, aProxyObject)</span>
<a href="#l2.32"></a><span id="l2.32"> #define MsgGetAtom(aString) \</span>
<a href="#l2.33"></a><span id="l2.33">         do_GetAtom(aString)</span>
<a href="#l2.34"></a><span id="l2.34"> #define MsgNewAtom(aString) \</span>
<a href="#l2.35"></a><span id="l2.35">         NS_NewAtom(aString)</span>
<a href="#l2.36"></a><span id="l2.36"> #define MsgReplaceChar(aString, aNeedle, aReplacement) \</span>
<a href="#l2.37"></a><span id="l2.37">         (aString).ReplaceChar(aNeedle, aReplacement)</span>
<a href="#l2.38"></a><span id="l2.38"> #define MsgFind(str, what, ignore_case, offset) \</span>
<a href="#l2.39"></a><span id="l2.39">         (str).Find(what, ignore_case, offset)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -486,31 +483,11 @@ class NS_MSG_BASE MsgQueryElementAt : pu</span>
<a href="#l2.41"></a><span id="l2.41">  * internal API only accepts nsICollection* aCollection.</span>
<a href="#l2.42"></a><span id="l2.42">  */</span>
<a href="#l2.43"></a><span id="l2.43"> inline</span>
<a href="#l2.44"></a><span id="l2.44"> const MsgQueryElementAt</span>
<a href="#l2.45"></a><span id="l2.45"> do_QueryElementAt( nsISupportsArray* array, PRUint32 aIndex, nsresult* aErrorPtr = 0 )</span>
<a href="#l2.46"></a><span id="l2.46"> {</span>
<a href="#l2.47"></a><span id="l2.47">     return MsgQueryElementAt(array, aIndex, aErrorPtr);</span>
<a href="#l2.48"></a><span id="l2.48"> }</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-/// Equivalent of NS_GetProxyForObject(aTarget, aIID, aObj, aProxyType, aProxyObject)</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-inline</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-nsresult</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-MsgGetProxyForObject(nsIEventTarget *target,</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                     REFNSIID aIID,</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-                     nsISupports* aObj,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-                     PRInt32 proxyType,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-                     void** aProxyObject)</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-{</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-    // get the proxy object manager</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-    nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr = do_GetService(&quot;@mozilla.org/xpcomproxy;1&quot;, &amp;rv);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-        return rv;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    // and try to get the proxy object</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    return proxyObjMgr-&gt;GetProxyForObject(target, aIID, aObj,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                                          proxyType, aProxyObject);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-}</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-</span>
<a href="#l2.69"></a><span id="l2.69"> #endif</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/Makefile.in</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/Makefile.in</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -68,16 +68,17 @@ CPPSRCS		= \</span>
<a href="#l3.4"></a><span id="l3.4"> 		nsImapService.cpp \</span>
<a href="#l3.5"></a><span id="l3.5"> 		nsImapUrl.cpp \</span>
<a href="#l3.6"></a><span id="l3.6"> 		nsImapFlagAndUidState.cpp \</span>
<a href="#l3.7"></a><span id="l3.7"> 		nsImapUndoTxn.cpp \</span>
<a href="#l3.8"></a><span id="l3.8"> 		nsImapStringBundle.cpp \</span>
<a href="#l3.9"></a><span id="l3.9"> 		nsImapOfflineSync.cpp \</span>
<a href="#l3.10"></a><span id="l3.10"> 		nsAutoSyncState.cpp \</span>
<a href="#l3.11"></a><span id="l3.11"> 		nsAutoSyncManager.cpp \</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+		nsSyncRunnableHelpers.cpp \</span>
<a href="#l3.13"></a><span id="l3.13"> 		$(NULL)</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> include $(topsrcdir)/config/config.mk</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> # we don't want the shared lib, but we want to force the creation of a static lib.</span>
<a href="#l3.18"></a><span id="l3.18"> FORCE_STATIC_LIB = 1</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -64,17 +64,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsImapServerResponseParser.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nspr.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;plbase64.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsISocketTransportService.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIStreamListenerTee.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -89,28 +88,28 @@</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> #include &quot;nsIWindowMediator.h&quot;</span>
<a href="#l4.24"></a><span id="l4.24"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l4.25"></a><span id="l4.25"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l4.27"></a><span id="l4.27"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l4.29"></a><span id="l4.29"> #include &quot;nsIXULAppInfo.h&quot;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+#include &quot;nsSyncRunnableHelpers.h&quot;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32"> PRLogModuleInfo *IMAP;</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> // netlib required files</span>
<a href="#l4.35"></a><span id="l4.35"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l4.36"></a><span id="l4.36"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l4.37"></a><span id="l4.37"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l4.38"></a><span id="l4.38"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l4.39"></a><span id="l4.39"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l4.40"></a><span id="l4.40"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l4.41"></a><span id="l4.41"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l4.43"></a><span id="l4.43"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l4.44"></a><span id="l4.44"> #include &quot;nsIProxyInfo.h&quot;</span>
<a href="#l4.45"></a><span id="l4.45"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l4.46"></a><span id="l4.46"> #include &quot;nsProxyRelease.h&quot;</span>
<a href="#l4.47"></a><span id="l4.47"> #include &quot;nsDebug.h&quot;</span>
<a href="#l4.48"></a><span id="l4.48"> #include &quot;nsMsgCompressIStream.h&quot;</span>
<a href="#l4.49"></a><span id="l4.49"> #include &quot;nsMsgCompressOStream.h&quot;</span>
<a href="#l4.50"></a><span id="l4.50"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineat">@@ -605,76 +604,44 @@ nsImapProtocol::GetImapServerKey()</span>
<a href="#l4.52"></a><span id="l4.52">   if (m_serverKey.IsEmpty() &amp;&amp; server)</span>
<a href="#l4.53"></a><span id="l4.53">     server-&gt;GetKey(m_serverKey);</span>
<a href="#l4.54"></a><span id="l4.54">   return m_serverKey.get();</span>
<a href="#l4.55"></a><span id="l4.55"> }</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57"> void</span>
<a href="#l4.58"></a><span id="l4.58"> nsImapProtocol::SetupSinkProxy()</span>
<a href="#l4.59"></a><span id="l4.59"> {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  nsresult res = NS_ERROR_FAILURE;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  nsresult res;</span>
<a href="#l4.63"></a><span id="l4.63">   if (m_runningUrl)</span>
<a href="#l4.64"></a><span id="l4.64">   {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    NS_ASSERTION(m_sinkEventTarget &amp;&amp; m_thread, &quot;fatal... null sink event queue or thread&quot;);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyManager(do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;res));</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    if (proxyManager) // if we don't get one of these are as good as dead...</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-      if (!m_imapMailFolderSink)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-      {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-        nsCOMPtr&lt;nsIImapMailFolderSink&gt; aImapMailFolderSink;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-        res = m_runningUrl-&gt;GetImapMailFolderSink(getter_AddRefs(aImapMailFolderSink));</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-        if (NS_SUCCEEDED(res) &amp;&amp; aImapMailFolderSink)</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-          res = proxyManager-&gt;GetProxyForObject(m_sinkEventTarget,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-                                             NS_GET_IID(nsIImapMailFolderSink),</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-                                             aImapMailFolderSink,</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-                                             NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-                                             getter_AddRefs(m_imapMailFolderSink));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-      }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-      if (!m_imapMessageSink)</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-      {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-        nsCOMPtr&lt;nsIImapMessageSink&gt; aImapMessageSink;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-        res = m_runningUrl-&gt;GetImapMessageSink(getter_AddRefs(aImapMessageSink));</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-        if (NS_SUCCEEDED(res) &amp;&amp; aImapMessageSink)</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-          res = proxyManager-&gt;GetProxyForObject(m_sinkEventTarget,</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-                                             NS_GET_IID(nsIImapMessageSink),</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-                                             aImapMessageSink,</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-                                             NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-                                             getter_AddRefs(m_imapMessageSink));</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-      }</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-      if (!m_imapServerSink)</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-      {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-         nsCOMPtr&lt;nsIImapServerSink&gt; aImapServerSink;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-         res = m_runningUrl-&gt;GetImapServerSink(getter_AddRefs(aImapServerSink));</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-         if (NS_SUCCEEDED(res) &amp;&amp; aImapServerSink)</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-            res = proxyManager-&gt;GetProxyForObject(  m_sinkEventTarget,</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-                             NS_GET_IID(nsIImapServerSink),</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-                             aImapServerSink,</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-                             NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-                             getter_AddRefs(m_imapServerSink));</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(res), &quot;couldn't get proxies&quot;);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-      }</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-      if (!m_imapProtocolSink)</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-      {</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-        nsCOMPtr&lt;nsIImapProtocolSink&gt; anImapProxyHelper(do_QueryInterface(NS_ISUPPORTS_CAST(nsIImapProtocolSink*, this), &amp;res));</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-        if (NS_SUCCEEDED(res) &amp;&amp; anImapProxyHelper)</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-          res = proxyManager-&gt;GetProxyForObject(  m_sinkEventTarget,</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-                             NS_GET_IID(nsIImapProtocolSink),</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-                             anImapProxyHelper,</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-                             NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-                             getter_AddRefs(m_imapProtocolSink));</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(res), &quot;couldn't get proxies&quot;);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-      }</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    }</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-    else</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-      NS_ASSERTION(PR_FALSE, &quot;can't get proxy service&quot;);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-  }</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(res), &quot;couldn't get proxies&quot;);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    if (!m_imapMailFolderSink)</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    {</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+      nsCOMPtr&lt;nsIImapMailFolderSink&gt; aImapMailFolderSink;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+      (void) m_runningUrl-&gt;GetImapMailFolderSink(getter_AddRefs(aImapMailFolderSink));</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      m_imapMailFolderSink = new ImapMailFolderSinkProxy(aImapMailFolderSink);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    }</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    if (!m_imapMessageSink)</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+      nsCOMPtr&lt;nsIImapMessageSink&gt; aImapMessageSink;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+      (void) m_runningUrl-&gt;GetImapMessageSink(getter_AddRefs(aImapMessageSink));</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+      m_imapMessageSink = new ImapMessageSinkProxy(aImapMessageSink);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    }</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    if (!m_imapServerSink)</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+       nsCOMPtr&lt;nsIImapServerSink&gt; aImapServerSink;</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+       res = m_runningUrl-&gt;GetImapServerSink(getter_AddRefs(aImapServerSink));</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+       m_imapServerSink = new ImapServerSinkProxy(aImapServerSink);</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    }</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    if (!m_imapProtocolSink)</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+      nsCOMPtr&lt;nsIImapProtocolSink&gt; anImapProxyHelper(do_QueryInterface(NS_ISUPPORTS_CAST(nsIImapProtocolSink*, this), &amp;res));</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+      m_imapProtocolSink = new ImapProtocolSinkProxy(anImapProxyHelper);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    }</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  }</span>
<a href="#l4.146"></a><span id="l4.146"> }</span>
<a href="#l4.147"></a><span id="l4.147"> </span>
<a href="#l4.148"></a><span id="l4.148"> static void SetSecurityCallbacksFromChannel(nsISocketTransport* aTrans, nsIChannel* aChannel)</span>
<a href="#l4.149"></a><span id="l4.149"> {</span>
<a href="#l4.150"></a><span id="l4.150">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;</span>
<a href="#l4.151"></a><span id="l4.151">   aChannel-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153">   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineat">@@ -708,29 +675,31 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l4.155"></a><span id="l4.155">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.156"></a><span id="l4.156">       m_server = do_GetWeakReference(server);</span>
<a href="#l4.157"></a><span id="l4.157">     }</span>
<a href="#l4.158"></a><span id="l4.158">     nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l4.159"></a><span id="l4.159">     mailnewsUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l4.160"></a><span id="l4.160">     mFolderLastModSeq = 0;</span>
<a href="#l4.161"></a><span id="l4.161">     mFolderTotalMsgCount = 0;</span>
<a href="#l4.162"></a><span id="l4.162">     mFolderHighestUID = 0;</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    m_uidValidity = kUidUnknown;</span>
<a href="#l4.164"></a><span id="l4.164">     if (folder)</span>
<a href="#l4.165"></a><span id="l4.165">     {</span>
<a href="#l4.166"></a><span id="l4.166">       nsCOMPtr&lt;nsIMsgDatabase&gt; folderDB;</span>
<a href="#l4.167"></a><span id="l4.167">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l4.168"></a><span id="l4.168">       folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(folderDB));</span>
<a href="#l4.169"></a><span id="l4.169">       if (folderInfo)</span>
<a href="#l4.170"></a><span id="l4.170">       {</span>
<a href="#l4.171"></a><span id="l4.171">         nsCString modSeqStr;</span>
<a href="#l4.172"></a><span id="l4.172">         folderInfo-&gt;GetCharProperty(kModSeqPropertyName, modSeqStr);</span>
<a href="#l4.173"></a><span id="l4.173">         mFolderLastModSeq = ParseUint64Str(modSeqStr.get());</span>
<a href="#l4.174"></a><span id="l4.174">         folderInfo-&gt;GetNumMessages(&amp;mFolderTotalMsgCount);</span>
<a href="#l4.175"></a><span id="l4.175">         folderInfo-&gt;GetUint32Property(kHighestRecordedUIDPropertyName, 0, &amp;mFolderHighestUID);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-      } </span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+        folderInfo-&gt;GetImapUidValidity(&amp;m_uidValidity);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+      }</span>
<a href="#l4.179"></a><span id="l4.179">     }</span>
<a href="#l4.180"></a><span id="l4.180">     nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l4.181"></a><span id="l4.181">     nsCOMPtr&lt;nsIStreamListener&gt; aRealStreamListener = do_QueryInterface(aConsumer);</span>
<a href="#l4.182"></a><span id="l4.182">     m_runningUrl-&gt;GetMockChannel(getter_AddRefs(m_mockChannel));</span>
<a href="#l4.183"></a><span id="l4.183">     if (!m_mockChannel)</span>
<a href="#l4.184"></a><span id="l4.184">     {</span>
<a href="#l4.185"></a><span id="l4.185">       // there are several imap operations that aren't initiated via a nsIChannel::AsyncOpen call on the mock channel.</span>
<a href="#l4.186"></a><span id="l4.186">       // such as selecting a folder. nsImapProtocol now insists on a mock channel when processing a url.</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineat">@@ -775,22 +744,17 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l4.188"></a><span id="l4.188">     }</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190">     // since we'll be making calls directly from the imap thread to the channel listener,</span>
<a href="#l4.191"></a><span id="l4.191">     // we need to turn it into a proxy object....we'll assume that the listener is on the same thread</span>
<a href="#l4.192"></a><span id="l4.192">     // as the event sink queue</span>
<a href="#l4.193"></a><span id="l4.193">     if (aRealStreamListener)</span>
<a href="#l4.194"></a><span id="l4.194">     {</span>
<a href="#l4.195"></a><span id="l4.195">       NS_ASSERTION(!m_channelListener, &quot;shouldn't already have a channel listener&quot;);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-      rv = MsgGetProxyForObject(m_sinkEventTarget,</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-                                NS_GET_IID(nsIStreamListener),</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-                                aRealStreamListener,</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-                                NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-                                getter_AddRefs(m_channelListener));</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      m_channelListener = new StreamListenerProxy(aRealStreamListener);</span>
<a href="#l4.203"></a><span id="l4.203">     }</span>
<a href="#l4.204"></a><span id="l4.204"> </span>
<a href="#l4.205"></a><span id="l4.205">     PRUint32 capability = kCapabilityUndefined;</span>
<a href="#l4.206"></a><span id="l4.206"> </span>
<a href="#l4.207"></a><span id="l4.207">     m_hostSessionList-&gt;GetCapabilityForHost(GetImapServerKey(), capability);</span>
<a href="#l4.208"></a><span id="l4.208"> </span>
<a href="#l4.209"></a><span id="l4.209">     server-&gt;GetRealHostName(m_realHostName);</span>
<a href="#l4.210"></a><span id="l4.210">     PRInt32 authMethod;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineat">@@ -1811,17 +1775,17 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l4.212"></a><span id="l4.212">     m_runningUrl-&gt;GetCopyState(getter_AddRefs(copyState));</span>
<a href="#l4.213"></a><span id="l4.213">   // this is so hokey...we MUST clear any local references to the url</span>
<a href="#l4.214"></a><span id="l4.214">   // BEFORE calling ReleaseUrlState</span>
<a href="#l4.215"></a><span id="l4.215">   mailnewsurl = nsnull;</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217">   if (suspendUrl)</span>
<a href="#l4.218"></a><span id="l4.218">     m_imapServerSink-&gt;SuspendUrl(m_runningUrl);</span>
<a href="#l4.219"></a><span id="l4.219">   // save the imap folder sink since we need it to do the CopyNextStreamMessage</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-  nsCOMPtr&lt;nsIImapMailFolderSink&gt; imapMailFolderSink = m_imapMailFolderSink;</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  nsRefPtr&lt;ImapMailFolderSinkProxy&gt; imapMailFolderSink = m_imapMailFolderSink;</span>
<a href="#l4.222"></a><span id="l4.222">   // release the url as we are done with it...</span>
<a href="#l4.223"></a><span id="l4.223">   ReleaseUrlState(PR_FALSE);</span>
<a href="#l4.224"></a><span id="l4.224">   ResetProgressInfo();</span>
<a href="#l4.225"></a><span id="l4.225"> </span>
<a href="#l4.226"></a><span id="l4.226">   ClearFlag(IMAP_CLEAN_UP_URL_STATE);</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228">   if (imapMailFolderSink)</span>
<a href="#l4.229"></a><span id="l4.229">   {</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineat">@@ -2483,29 +2447,22 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l4.231"></a><span id="l4.231"> </span>
<a href="#l4.232"></a><span id="l4.232">     if (selectIssued)</span>
<a href="#l4.233"></a><span id="l4.233">       RefreshACLForFolderIfNecessary(mailboxName.get());</span>
<a href="#l4.234"></a><span id="l4.234"> </span>
<a href="#l4.235"></a><span id="l4.235">     bool uidValidityOk = true;</span>
<a href="#l4.236"></a><span id="l4.236">     if (GetServerStateParser().LastCommandSuccessful() &amp;&amp; selectIssued &amp;&amp;</span>
<a href="#l4.237"></a><span id="l4.237">       (m_imapAction != nsIImapUrl::nsImapSelectFolder) &amp;&amp; (m_imapAction != nsIImapUrl::nsImapLiteSelectFolder))</span>
<a href="#l4.238"></a><span id="l4.238">     {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-      if (m_imapMailFolderSink)</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-      {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-        PRInt32 uidValidity;</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-        m_imapMailFolderSink-&gt;GetUidValidity(&amp;uidValidity);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-        // error on the side of caution, if the fe event fails to set uidStruct-&gt;returnValidity, then assume that UIDVALIDITY</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-        // did not roll.  This is a common case event for attachments that are fetched within a browser context.</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-        if (!DeathSignalReceived())</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-          uidValidityOk = uidValidity == kUidUnknown ||</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-                          uidValidity == GetServerStateParser().FolderUID();</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-      }</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+      // error on the side of caution, if the fe event fails to set uidStruct-&gt;returnValidity, then assume that UIDVALIDITY</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+      // did not roll.  This is a common case event for attachments that are fetched within a browser context.</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+      if (!DeathSignalReceived())</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+        uidValidityOk = m_uidValidity == kUidUnknown ||</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+                        m_uidValidity == GetServerStateParser().FolderUID();</span>
<a href="#l4.258"></a><span id="l4.258">     }</span>
<a href="#l4.259"></a><span id="l4.259"> </span>
<a href="#l4.260"></a><span id="l4.260">     if (!uidValidityOk)</span>
<a href="#l4.261"></a><span id="l4.261">       Log(&quot;ProcessSelectedStateURL&quot;, nsnull, &quot;uid validity not ok&quot;);</span>
<a href="#l4.262"></a><span id="l4.262">     if (GetServerStateParser().LastCommandSuccessful() &amp;&amp; !DeathSignalReceived() &amp;&amp; (uidValidityOk || m_imapAction == nsIImapUrl::nsImapDeleteAllMsgs))</span>
<a href="#l4.263"></a><span id="l4.263">     {</span>
<a href="#l4.264"></a><span id="l4.264">       if (GetServerStateParser().CurrentFolderReadOnly())</span>
<a href="#l4.265"></a><span id="l4.265">       {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -84,16 +84,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIImapHeaderXferInfo.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsITimer.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIMsgAsyncPrompter.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;mozilla/ReentrantMonitor.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsSyncRunnableHelpers.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14"> class nsIMAPMessagePartIDArray;</span>
<a href="#l5.15"></a><span id="l5.15"> class nsIMsgIncomingServer;</span>
<a href="#l5.16"></a><span id="l5.16"> class nsIPrefBranch;</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> #define kDownLoadCacheSize 16000 // was 1536 - try making it bigger</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> typedef struct _msg_line_info {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -395,20 +397,20 @@ private:</span>
<a href="#l5.23"></a><span id="l5.23">   bool         m_imapThreadIsRunning;</span>
<a href="#l5.24"></a><span id="l5.24">   void ImapThreadMainLoop(void);</span>
<a href="#l5.25"></a><span id="l5.25">   nsresult    m_connectionStatus;</span>
<a href="#l5.26"></a><span id="l5.26">   nsCString   m_connectionType;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   bool        m_nextUrlReadyToRun;</span>
<a href="#l5.29"></a><span id="l5.29">   nsWeakPtr   m_server;</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  nsCOMPtr&lt;nsIImapMailFolderSink&gt;     m_imapMailFolderSink;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  nsCOMPtr&lt;nsIImapMessageSink&gt;        m_imapMessageSink;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  nsCOMPtr&lt;nsIImapServerSink&gt;         m_imapServerSink;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  nsCOMPtr&lt;nsIImapProtocolSink&gt;       m_imapProtocolSink;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  nsRefPtr&lt;ImapMailFolderSinkProxy&gt; m_imapMailFolderSink;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  nsRefPtr&lt;ImapMessageSinkProxy&gt;    m_imapMessageSink;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  nsRefPtr&lt;ImapServerSinkProxy&gt;     m_imapServerSink;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  nsRefPtr&lt;ImapProtocolSinkProxy&gt;   m_imapProtocolSink;</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   // helper function to setup imap sink interface proxies</span>
<a href="#l5.41"></a><span id="l5.41">   void SetupSinkProxy();</span>
<a href="#l5.42"></a><span id="l5.42">   // End thread support stuff</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">   bool GetDeleteIsMoveToTrash();</span>
<a href="#l5.45"></a><span id="l5.45">   bool GetShowDeletedMessages();</span>
<a href="#l5.46"></a><span id="l5.46">   nsCString m_currentCommand;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineat">@@ -664,16 +666,18 @@ private:</span>
<a href="#l5.48"></a><span id="l5.48">   bool m_idle;</span>
<a href="#l5.49"></a><span id="l5.49">   bool m_useIdle;</span>
<a href="#l5.50"></a><span id="l5.50">   PRInt32 m_noopCount;</span>
<a href="#l5.51"></a><span id="l5.51">   bool    m_autoSubscribe, m_autoUnsubscribe, m_autoSubscribeOnOpen;</span>
<a href="#l5.52"></a><span id="l5.52">   bool m_closeNeededBeforeSelect;</span>
<a href="#l5.53"></a><span id="l5.53">   bool m_retryUrlOnError;</span>
<a href="#l5.54"></a><span id="l5.54">   bool m_preferPlainText;</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  PRInt32 m_uidValidity; // stored uid validity for the selected folder.</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+</span>
<a href="#l5.58"></a><span id="l5.58">   enum EMailboxHierarchyNameState {</span>
<a href="#l5.59"></a><span id="l5.59">     kNoOperationInProgress,</span>
<a href="#l5.60"></a><span id="l5.60">       kDiscoverBaseFolderInProgress,</span>
<a href="#l5.61"></a><span id="l5.61">       kDiscoverTrashFolderInProgress,</span>
<a href="#l5.62"></a><span id="l5.62">       kDeleteSubFoldersInProgress,</span>
<a href="#l5.63"></a><span id="l5.63">       kListingForInfoOnly,</span>
<a href="#l5.64"></a><span id="l5.64">       kListingForInfoAndDiscovery,</span>
<a href="#l5.65"></a><span id="l5.65">       kDiscoveringNamespacesOnly,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,481 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ *</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * License.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ *</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ * The Original Code is Mozilla Thunderbird.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * the Mozilla Foundation &lt;http://www.mozilla.org/&gt;.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ *</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ *</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+#include &quot;nsSyncRunnableHelpers.h&quot;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+#include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+#include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+#include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+#include &quot;mozilla/Monitor.h&quot;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(StreamListenerProxy, nsIStreamListener)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(ImapMailFolderSinkProxy, nsIImapMailFolderSink)</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(ImapServerSinkProxy, nsIImapServerSink)</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(ImapMessageSinkProxy,</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+                              nsIImapMessageSink)</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(ImapProtocolSinkProxy,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+                              nsIImapProtocolSink)</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+namespace {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+// Traits class for a reference type, specialized for parameters which are</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+// already references.</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+template&lt;typename T&gt;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+struct RefType</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+{</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  typedef T&amp; type;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+};</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+template&lt;&gt;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+struct RefType&lt;nsAString&amp;&gt;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+{</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  typedef nsAString&amp; type;</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+};</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+template&lt;&gt;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+struct RefType&lt;const nsAString&amp;&gt;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+{</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  typedef const nsAString&amp; type;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+};</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+template&lt;&gt;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+struct RefType&lt;nsACString&amp;&gt;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+{</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  typedef nsACString&amp; type;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+};</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+template&lt;&gt;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+struct RefType&lt;const nsACString&amp;&gt;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+{</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  typedef const nsACString&amp; type;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+};</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+template&lt;&gt;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+struct RefType&lt;const nsIID&amp;&gt;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+{</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  typedef const nsIID&amp; type;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+};</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+class SyncRunnableBase : public nsRunnable</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+{</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+public:</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  nsresult Result() {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    return mResult;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  }</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  mozilla::Monitor&amp; Monitor() {</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+    return mMonitor;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  }</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+protected:</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  SyncRunnableBase()</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+    : mResult(NS_ERROR_UNEXPECTED)</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+    , mMonitor(&quot;SyncRunnableBase&quot;)</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  { }</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  nsresult mResult;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  mozilla::Monitor mMonitor;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+};</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+template&lt;typename Receiver&gt;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+class SyncRunnable0 : public SyncRunnableBase</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+{</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+public:</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)();</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  SyncRunnable0(Receiver* receiver, ReceiverMethod method)</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    , mMethod(method)</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  { }</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+    mResult = (mReceiver-&gt;*mMethod)();</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+    mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+  }</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+private:</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+  Receiver* mReceiver;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+  ReceiverMethod mMethod;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+};</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+template&lt;typename Receiver, typename Arg1&gt;</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+class SyncRunnable1 : public SyncRunnableBase</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+{</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+public:</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+  SyncRunnable1(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+                Arg1Ref arg1)</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    , mMethod(method)</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+    , mArg1(arg1)</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  { }</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    mResult = (mReceiver-&gt;*mMethod)(mArg1);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+    mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+  }</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+private:</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+  Receiver* mReceiver;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+  ReceiverMethod mMethod;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  Arg1Ref mArg1;</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+};</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+template&lt;typename Receiver, typename Arg1, typename Arg2&gt;</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+class SyncRunnable2 : public SyncRunnableBase</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+{</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+public:</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  SyncRunnable2(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+                Arg1Ref arg1, Arg2Ref arg2)</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+    , mMethod(method)</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+    , mArg1(arg1)</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+    , mArg2(arg2)</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  { }</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+    mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  }</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+private:</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  Receiver* mReceiver;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+  ReceiverMethod mMethod;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+  Arg1Ref mArg1;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+  Arg2Ref mArg2;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+};</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+template&lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3&gt;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+class SyncRunnable3 : public SyncRunnableBase</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+{</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+public:</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+  typedef typename RefType&lt;Arg3&gt;::type Arg3Ref;</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+  SyncRunnable3(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+                Arg1Ref arg1, Arg2Ref arg2, Arg3Ref arg3)</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    , mMethod(method)</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+    , mArg1(arg1)</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+    , mArg2(arg2)</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+    , mArg3(arg3)</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  { }</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2, mArg3);</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+  }</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+private:</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  Receiver* mReceiver;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+  ReceiverMethod mMethod;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+  Arg1Ref mArg1;</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+  Arg2Ref mArg2;</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+  Arg3Ref mArg3;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+};</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+template&lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3,</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+         typename Arg4&gt;</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+class SyncRunnable4 : public SyncRunnableBase</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+{</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+public:</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3, Arg4);</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+  typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+  typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+  typedef typename RefType&lt;Arg3&gt;::type Arg3Ref;</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+  typedef typename RefType&lt;Arg4&gt;::type Arg4Ref;</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+  SyncRunnable4(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+                Arg1Ref arg1, Arg2Ref arg2, Arg3Ref arg3, Arg4Ref arg4)</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    , mMethod(method)</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    , mArg1(arg1)</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    , mArg2(arg2)</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    , mArg3(arg3)</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+    , mArg4(arg4)</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+  { }</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+    mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2, mArg3, mArg4);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+    mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+  }</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+private:</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+  Receiver* mReceiver;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+  ReceiverMethod mMethod;</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+  Arg1Ref mArg1;</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+  Arg2Ref mArg2;</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  Arg3Ref mArg3;</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+  Arg4Ref mArg4;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+};</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+template&lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3,</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+         typename Arg4, typename Arg5&gt;</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+class SyncRunnable5 : public SyncRunnableBase</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+{</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+public:</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3, Arg4, Arg5);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+  typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+  typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+  typedef typename RefType&lt;Arg3&gt;::type Arg3Ref;</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+  typedef typename RefType&lt;Arg4&gt;::type Arg4Ref;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+  typedef typename RefType&lt;Arg5&gt;::type Arg5Ref;</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+  SyncRunnable5(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+                Arg1Ref arg1, Arg2Ref arg2, Arg3Ref arg3, Arg4Ref arg4, Arg5Ref arg5)</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+    , mMethod(method)</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+    , mArg1(arg1)</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    , mArg2(arg2)</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+    , mArg3(arg3)</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+    , mArg4(arg4)</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+    , mArg5(arg5)</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+  { }</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+    mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2, mArg3, mArg4, mArg5);</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+    mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+    return NS_OK;</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+  }</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+private:</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+  Receiver* mReceiver;</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+  ReceiverMethod mMethod;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+  Arg1Ref mArg1;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+  Arg2Ref mArg2;</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+  Arg3Ref mArg3;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+  Arg4Ref mArg4;</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+  Arg5Ref mArg5;</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+};</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+nsresult</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+DispatchSyncRunnable(SyncRunnableBase* r)</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+{</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+  if (NS_IsMainThread()) {</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+    r-&gt;Run();</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+  }</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+  else {</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+    mozilla::MonitorAutoLock lock(r-&gt;Monitor());</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+    nsresult rv = NS_DispatchToMainThread(r);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+      return rv;</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+    lock.Wait();</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+  }</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+  return r-&gt;Result();</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+}</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+} // anonymous namespace</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD0(iface, method)                       \</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method() {                     \</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+      new SyncRunnable0&lt;nsI##iface&gt;                           \</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+      (mReceiver, &amp;nsI##iface::method);                         \</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+  }</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD1(iface, method,                       \</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+                               arg1)                                \</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1) {                     \</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+      new SyncRunnable1&lt;nsI##iface, arg1&gt;                           \</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+      (mReceiver, &amp;nsI##iface::method, a1);                         \</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+  }</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD2(iface, method,                       \</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+                               arg1, arg2)                          \</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2) {            \</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+      new SyncRunnable2&lt;nsI##iface, arg1, arg2&gt;                     \</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+      (mReceiver, &amp;nsI##iface::method, a1, a2);                     \</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+  }</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD3(iface, method,                       \</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+                               arg1, arg2, arg3)                    \</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3) {   \</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+      new SyncRunnable3&lt;nsI##iface, arg1, arg2, arg3&gt;               \</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+      (mReceiver, &amp;nsI##iface::method,                              \</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+       a1, a2, a3);                                                 \</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+  }</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD4(iface, method,                       \</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+                               arg1, arg2, arg3, arg4)              \</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3, arg4 a4) { \</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+      new SyncRunnable4&lt;nsI##iface, arg1, arg2, arg3, arg4&gt;         \</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+      (mReceiver, &amp;nsI##iface::method,                              \</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+       a1, a2, a3, a4);                                             \</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+  }</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD5(iface, method,                       \</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+                               arg1, arg2, arg3, arg4, arg5)        \</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3, arg4 a4, arg5 a5) {   \</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+      new SyncRunnable5&lt;nsI##iface, arg1, arg2, arg3, arg4, arg5&gt;   \</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+      (mReceiver, &amp;nsI##iface::method,                              \</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+       a1, a2, a3, a4, a5);                                         \</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+  }</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+#define NS_SYNCRUNNABLEATTRIBUTE(iface, attribute,                       \</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+                                 type)                                \</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+NS_IMETHODIMP iface##Proxy::Get##attribute(type *a1) {                     \</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+      new SyncRunnable1&lt;nsI##iface, type *&gt;                           \</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+      (mReceiver, &amp;nsI##iface::Get##attribute, a1);                         \</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+  } \</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+NS_IMETHODIMP iface##Proxy::Set##attribute(type a1) {                     \</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+    nsRefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+      new SyncRunnable1&lt;nsI##iface, type&gt;                           \</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+      (mReceiver, &amp;nsI##iface::Set##attribute, a1);                         \</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+  }</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+#define NS_NOTIMPLEMENTED \</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+  { NS_RUNTIMEABORT(&quot;Not implemented&quot;); return NS_ERROR_UNEXPECTED; }</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+NS_SYNCRUNNABLEMETHOD5(StreamListener, OnDataAvailable,</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+                       nsIRequest *, nsISupports *, nsIInputStream *, PRUint32, PRUint32)</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(StreamListener, OnStartRequest,</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+                       nsIRequest *, nsISupports *)</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(StreamListener, OnStopRequest,</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+                       nsIRequest *, nsISupports *, nsresult)</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapProtocolSink, GetUrlWindow, nsIMsgMailNewsUrl *,</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+                       nsIMsgWindow **)</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapProtocolSink, CloseStreams)</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderNeedsACLListed, bool)</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderNeedsSubscribing, bool)</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderNeedsAdded, bool)</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, AclFlags, PRUint32)</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, UidValidity, PRInt32)</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderQuotaCommandIssued, bool)</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMailFolderSink, SetFolderQuotaData, const nsACString &amp;, PRUint32, PRUint32)</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, GetShouldDownloadAllHeaders, bool *)</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, GetOnlineDelimiter, char **)</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapMailFolderSink, OnNewIdleMessages)</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, UpdateImapMailboxStatus, nsIImapProtocol *, nsIMailboxSpec *)</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, UpdateImapMailboxInfo, nsIImapProtocol *, nsIMailboxSpec *)</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMailFolderSink, GetMsgHdrsToDownload, bool *, PRInt32 *, PRUint32 *, nsMsgKey **)</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, ParseMsgHdrs, nsIImapProtocol *, nsIImapHeaderXferInfo *)</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, AbortHeaderParseStream, nsIImapProtocol *)</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, OnlineCopyCompleted, nsIImapProtocol *, ImapOnlineCopyState)</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, StartMessage, nsIMsgMailNewsUrl *)</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, EndMessage, nsIMsgMailNewsUrl *, nsMsgKey)</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, NotifySearchHit, nsIMsgMailNewsUrl *, const char *)</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, CopyNextStreamMessage, bool, nsISupports *)</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, CloseMockChannel, nsIImapMockChannel *)</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+NS_SYNCRUNNABLEMETHOD5(ImapMailFolderSink, SetUrlState, nsIImapProtocol *, nsIMsgMailNewsUrl *,</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+                       bool, bool, nsresult)</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, ReleaseUrlCacheEntry, nsIMsgMailNewsUrl *)</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, HeaderFetchCompleted, nsIImapProtocol *)</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, SetBiffStateAndUpdate, PRInt32)</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMailFolderSink, ProgressStatus, nsIImapProtocol*, PRUint32, const PRUnichar *)</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMailFolderSink, PercentProgress, nsIImapProtocol*, const PRUnichar *, PRInt64, PRInt64)</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapMailFolderSink, ClearFolderRights)</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, SetCopyResponseUid, const char *, nsIImapUrl *)</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, SetAppendMsgUid, nsMsgKey, nsIImapUrl *)</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, GetMessageId, nsIImapUrl *, nsACString &amp;)</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, SetupMsgWriteStream, nsIFile *, bool)</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, ParseAdoptedMsgLine, const char *, nsMsgKey, PRInt32, nsIImapUrl *)</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, NormalEndMsgWriteStream, nsMsgKey, bool, nsIImapUrl *)</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapMessageSink, AbortMsgWriteStream)</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapMessageSink, BeginMessageUpload)</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, NotifyMessageFlags, PRUint32, nsMsgKey, PRUint64)</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, NotifyMessageDeleted, const char *, bool, const char *)</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, GetMessageSizeFromDB, const char *, PRUint32 *)</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, SetContentModified, nsIImapUrl *, nsImapContentModifiedType)</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMessageSink, SetImageCacheSessionForUrl, nsIMsgMailNewsUrl *)</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, GetCurMoveCopyMessageInfo, nsIImapUrl *, PRTime *, nsACString &amp;, PRUint32 *)</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapServerSink, PossibleImapMailbox, const nsACString &amp;, char, PRInt32, bool *)</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderNeedsACLInitialized, const nsACString &amp;, bool *)</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AddFolderRights, const nsACString &amp;, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, RefreshFolderRights, const nsACString &amp;)</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapServerSink, DiscoveryDone)</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, OnlineFolderDelete, const nsACString &amp;)</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, OnlineFolderCreateFailed, const nsACString &amp;)</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, OnlineFolderRename, nsIMsgWindow *, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderIsNoSelect, const nsACString &amp;, bool *)</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, SetFolderAdminURL, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderVerifiedOnline, const nsACString &amp;, bool *)</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetCapability, PRUint32)</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetServerID, const nsACString &amp;)</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, LoadNextQueuedUrl, nsIImapProtocol *, bool *)</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PrepareToRetryUrl, nsIImapUrl *, nsIImapMockChannel **)</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SuspendUrl, nsIImapUrl *)</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, RetryUrl, nsIImapUrl *, nsIImapMockChannel *)</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapServerSink, AbortQueuedUrls)</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, GetImapStringByID, PRInt32, nsAString &amp;)</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PromptLoginFailed, nsIMsgWindow *, PRInt32 *)</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlert, const nsAString &amp;, nsIMsgMailNewsUrl *)</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertWithID, PRInt32, nsIMsgMailNewsUrl *)</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertFromServer, const nsACString &amp;, nsIMsgMailNewsUrl *)</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapServerSink, CommitNamespaces)</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AsyncGetPassword, nsIImapProtocol *, bool, nsACString &amp;)</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+NS_SYNCRUNNABLEATTRIBUTE(ImapServerSink, UserAuthenticated, bool)</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, SetMailServerUrls, const nsACString &amp;, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetArbitraryHeaders, nsACString &amp;)</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+NS_SYNCRUNNABLEMETHOD0(ImapServerSink, ForgetPassword)</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetShowAttachmentsInline, bool *)</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, CramMD5Hash, const char *, const char *, char **)</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetLoginUsername, nsACString &amp;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/imap/src/nsSyncRunnableHelpers.h</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,124 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Mozilla Thunderbird.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * the Mozilla Foundation &lt;http://www.mozilla.org/&gt;.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ *</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+#ifndef nsSyncRunnableHelpers_h</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+#define nsSyncRunnableHelpers_h</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+#include &quot;nsIStreamListener.h&quot;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+#include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+#include &quot;nsIImapMailFolderSink.h&quot;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+#include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+#include &quot;nsIImapProtocolSink.h&quot;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+#include &quot;nsIImapMessageSink.h&quot;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+// The classes in this file proxy method calls to the main thread</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+// synchronously. The main thread must not block on this thread, or a</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+// deadlock condition can occur.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+class StreamListenerProxy : public nsIStreamListener</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+{</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+public:</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  StreamListenerProxy(nsIStreamListener* receiver)</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  { }</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  NS_DECL_NSISTREAMLISTENER</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+private:</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  nsCOMPtr&lt;nsIStreamListener&gt; mReceiver;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+};</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+class ImapMailFolderSinkProxy : public nsIImapMailFolderSink</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+{</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+public:</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  ImapMailFolderSinkProxy(nsIImapMailFolderSink* receiver)</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  { }</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  NS_DECL_NSIIMAPMAILFOLDERSINK</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+private:</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  nsCOMPtr&lt;nsIImapMailFolderSink&gt; mReceiver;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+};</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+class ImapServerSinkProxy : public nsIImapServerSink</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+{</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+public:</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  ImapServerSinkProxy(nsIImapServerSink* receiver)</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  { }</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  NS_DECL_NSIIMAPSERVERSINK</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+private:</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  nsCOMPtr&lt;nsIImapServerSink&gt; mReceiver;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+};</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+class ImapMessageSinkProxy: public nsIImapMessageSink</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+{</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+public:</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  ImapMessageSinkProxy(nsIImapMessageSink* receiver)</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  { }</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  NS_DECL_NSIIMAPMESSAGESINK</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+private:</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  nsCOMPtr&lt;nsIImapMessageSink&gt; mReceiver;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+};</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+class ImapProtocolSinkProxy : public nsIImapProtocolSink</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+{</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+public:</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  ImapProtocolSinkProxy(nsIImapProtocolSink* receiver)</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    : mReceiver(receiver)</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  { }</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  NS_DECL_NSIIMAPPROTOCOLSINK</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+private:</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  nsCOMPtr&lt;nsIImapProtocolSink&gt; mReceiver;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+};</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+#endif // nsSyncRunnableHelpers_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -42,19 +42,18 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsString.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIURI.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;nsProxiedService.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21"> #include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineat">@@ -186,17 +185,16 @@ nsresult EudoraSendListener::CreateSendL</span>
<a href="#l8.25"></a><span id="l8.25"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.26"></a><span id="l8.26"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.27"></a><span id="l8.27"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31"> nsEudoraCompose::nsEudoraCompose()</span>
<a href="#l8.32"></a><span id="l8.32"> {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  m_pIOService = nsnull;</span>
<a href="#l8.34"></a><span id="l8.34">   m_pAttachments = nsnull;</span>
<a href="#l8.35"></a><span id="l8.35">   m_pListener = nsnull;</span>
<a href="#l8.36"></a><span id="l8.36">   m_pMsgFields = nsnull;</span>
<a href="#l8.37"></a><span id="l8.37">   m_pHeaders = p_test_headers;</span>
<a href="#l8.38"></a><span id="l8.38">   if (m_pHeaders)</span>
<a href="#l8.39"></a><span id="l8.39">     m_headerLen = strlen( m_pHeaders);</span>
<a href="#l8.40"></a><span id="l8.40">   else</span>
<a href="#l8.41"></a><span id="l8.41">     m_headerLen = 0;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineat">@@ -207,29 +205,31 @@ nsEudoraCompose::nsEudoraCompose()</span>
<a href="#l8.43"></a><span id="l8.43">     m_bodyLen = 0;</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   m_readHeaders.m_convertCRs = PR_TRUE;</span>
<a href="#l8.46"></a><span id="l8.46"> }</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49"> nsEudoraCompose::~nsEudoraCompose()</span>
<a href="#l8.50"></a><span id="l8.50"> {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  NS_IF_RELEASE( m_pIOService);</span>
<a href="#l8.52"></a><span id="l8.52">   NS_IF_RELEASE( m_pListener);</span>
<a href="#l8.53"></a><span id="l8.53">   NS_IF_RELEASE( m_pMsgFields);</span>
<a href="#l8.54"></a><span id="l8.54"> }</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56"> nsresult nsEudoraCompose::CreateIdentity( void)</span>
<a href="#l8.57"></a><span id="l8.57"> {</span>
<a href="#l8.58"></a><span id="l8.58">   if (s_pIdentity)</span>
<a href="#l8.59"></a><span id="l8.59">     return( NS_OK);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  nsresult  rv;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  NS_WITH_PROXIED_SERVICE(nsIMsgAccountManager, accMgr, NS_MSGACCOUNTMANAGER_CONTRACTID, NS_PROXY_TO_MAIN_THREAD, &amp;rv);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  if (NS_FAILED(rv)) return( rv);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  // Should only create identity from main thread</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  NS_ENSURE_TRUE(NS_IsMainThread(), NS_ERROR_FAILURE);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+</span>
<a href="#l8.70"></a><span id="l8.70">   rv = accMgr-&gt;CreateIdentity( &amp;s_pIdentity);</span>
<a href="#l8.71"></a><span id="l8.71">   nsString name(NS_LITERAL_STRING(&quot;Import Identity&quot;));</span>
<a href="#l8.72"></a><span id="l8.72">   if (s_pIdentity) {</span>
<a href="#l8.73"></a><span id="l8.73">     s_pIdentity-&gt;SetFullName(name);</span>
<a href="#l8.74"></a><span id="l8.74">     s_pIdentity-&gt;SetIdentityName(name);</span>
<a href="#l8.75"></a><span id="l8.75">     s_pIdentity-&gt;SetEmail(NS_LITERAL_CSTRING(&quot;import@import.service&quot;));</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">     // SetDoFcc to PR_FALSE to save time when CreateAndSendMessage operates.</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineat">@@ -256,22 +256,19 @@ void nsEudoraCompose::ReleaseIdentity( v</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81"> nsresult nsEudoraCompose::CreateComponents( void)</span>
<a href="#l8.82"></a><span id="l8.82"> {</span>
<a href="#l8.83"></a><span id="l8.83">   nsresult  rv = NS_OK;</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85">   if (!m_pIOService) {</span>
<a href="#l8.86"></a><span id="l8.86">     IMPORT_LOG0( &quot;Creating nsIOService\n&quot;);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    NS_WITH_PROXIED_SERVICE(nsIIOService, service, NS_IOSERVICE_CONTRACTID, NS_PROXY_TO_MAIN_THREAD, &amp;rv);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-      return( rv);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-    m_pIOService = service;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-    NS_IF_ADDREF( m_pIOService);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    </span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    m_pIOService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.96"></a><span id="l8.96">   }</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98">   NS_IF_RELEASE( m_pMsgFields);</span>
<a href="#l8.99"></a><span id="l8.99">   if (!m_pListener &amp;&amp; NS_SUCCEEDED( rv))</span>
<a href="#l8.100"></a><span id="l8.100">     rv = EudoraSendListener::CreateSendListener( &amp;m_pListener);</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.103"></a><span id="l8.103">       rv = CallCreateInstance( kMsgCompFieldsCID, &amp;m_pMsgFields);</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineat">@@ -560,18 +557,16 @@ nsresult nsEudoraCompose::GetLocalAttach</span>
<a href="#l8.105"></a><span id="l8.105">   }</span>
<a href="#l8.106"></a><span id="l8.106">   return NS_OK;</span>
<a href="#l8.107"></a><span id="l8.107"> }</span>
<a href="#l8.108"></a><span id="l8.108"> </span>
<a href="#l8.109"></a><span id="l8.109"> // Test a message send????</span>
<a href="#l8.110"></a><span id="l8.110"> nsresult nsEudoraCompose::SendTheMessage(nsIFile *pMailImportLocation, nsIFile **pMsg)</span>
<a href="#l8.111"></a><span id="l8.111"> {</span>
<a href="#l8.112"></a><span id="l8.112">   nsresult rv = CreateComponents();</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-    rv = CreateIdentity();</span>
<a href="#l8.115"></a><span id="l8.115">   if (NS_FAILED( rv))</span>
<a href="#l8.116"></a><span id="l8.116">     return( rv);</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118">   // IMPORT_LOG0( &quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l8.119"></a><span id="l8.119"> </span>
<a href="#l8.120"></a><span id="l8.120">   nsString bodyType;</span>
<a href="#l8.121"></a><span id="l8.121">   nsString charSet;</span>
<a href="#l8.122"></a><span id="l8.122">   nsString headerVal;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -138,21 +138,21 @@ public:</span>
<a href="#l9.4"></a><span id="l9.4">   void    SetBody( const char *pBody, PRInt32 len, nsCString &amp;bodyType) { m_pBody = pBody; m_bodyLen = len; m_bodyType = bodyType;}</span>
<a href="#l9.5"></a><span id="l9.5">   void    SetHeaders( const char *pHeaders, PRInt32 len) { m_pHeaders = pHeaders; m_headerLen = len;}</span>
<a href="#l9.6"></a><span id="l9.6">   void    SetAttachments( nsVoidArray *pAttachments) { m_pAttachments = pAttachments;}</span>
<a href="#l9.7"></a><span id="l9.7">   void    SetDefaultDate( nsCString date) { m_defaultDate = date;}</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   nsresult  CopyComposedMessage( nsCString&amp; fromLine, nsIFile *pSrc, nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; copy);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   static nsresult  FillMailBuffer( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  static void    ReleaseIdentity( void);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  static nsresult CreateIdentity(void);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  static void    ReleaseIdentity(void);</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> private:</span>
<a href="#l9.17"></a><span id="l9.17">   nsresult  CreateComponents( void);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  static nsresult    CreateIdentity( void);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   void    GetNthHeader( const char *pData, PRInt32 dataLen, PRInt32 n, nsCString&amp; header, nsCString&amp; val, bool unwrap);</span>
<a href="#l9.21"></a><span id="l9.21">   void    GetHeaderValue( const char *pData, PRInt32 dataLen, const char *pHeader, nsCString&amp; val, bool unwrap = true);</span>
<a href="#l9.22"></a><span id="l9.22">   void    GetHeaderValue( const char *pData, PRInt32 dataLen, const char *pHeader, nsString&amp; val) {</span>
<a href="#l9.23"></a><span id="l9.23">     val.Truncate();</span>
<a href="#l9.24"></a><span id="l9.24">     nsCString  hVal;</span>
<a href="#l9.25"></a><span id="l9.25">     GetHeaderValue( pData, dataLen, pHeader, hVal, PR_TRUE);</span>
<a href="#l9.26"></a><span id="l9.26">     NS_CopyNativeToUnicode( hVal, val);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineat">@@ -170,17 +170,17 @@ private:</span>
<a href="#l9.28"></a><span id="l9.28">   bool      IsReplaceHeader( const char *pHeader);</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> private:</span>
<a href="#l9.31"></a><span id="l9.31">   static nsIMsgIdentity *    s_pIdentity;</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">   nsVoidArray *      m_pAttachments;</span>
<a href="#l9.34"></a><span id="l9.34">   nsIMsgSendListener *  m_pListener;</span>
<a href="#l9.35"></a><span id="l9.35">   nsIMsgCompFields *    m_pMsgFields;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  nsIIOService *      m_pIOService;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; m_pIOService;</span>
<a href="#l9.38"></a><span id="l9.38">   PRInt32          m_headerLen;</span>
<a href="#l9.39"></a><span id="l9.39">   const char *      m_pHeaders;</span>
<a href="#l9.40"></a><span id="l9.40">   PRInt32          m_bodyLen;</span>
<a href="#l9.41"></a><span id="l9.41">   const char *      m_pBody;</span>
<a href="#l9.42"></a><span id="l9.42">   nsCString        m_bodyType;</span>
<a href="#l9.43"></a><span id="l9.43">   nsString        m_defCharset;</span>
<a href="#l9.44"></a><span id="l9.44">   SimpleBufferTonyRCopiedOnce      m_readHeaders;</span>
<a href="#l9.45"></a><span id="l9.45">   nsCOMPtr&lt;nsIImportService&gt;  m_pImportService;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -364,16 +364,17 @@ nsresult ImportEudoraMailImpl::Create(ns</span>
<a href="#l10.4"></a><span id="l10.4">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   NS_ADDREF(*aImport);</span>
<a href="#l10.7"></a><span id="l10.7">   return NS_OK;</span>
<a href="#l10.8"></a><span id="l10.8"> }</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> ImportEudoraMailImpl::ImportEudoraMailImpl()</span>
<a href="#l10.11"></a><span id="l10.11"> {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  nsEudoraCompose::CreateIdentity();</span>
<a href="#l10.13"></a><span id="l10.13">   // Create keys to support the default Eudora label colors.</span>
<a href="#l10.14"></a><span id="l10.14">   // Ideally importing the settings will have already created these,</span>
<a href="#l10.15"></a><span id="l10.15">   // in which case we won't bother (we'll detect that each key already</span>
<a href="#l10.16"></a><span id="l10.16">   // exists). But to be sure we need to create the keys here, at</span>
<a href="#l10.17"></a><span id="l10.17">   // least until the infrastructure is improved in some fashion so</span>
<a href="#l10.18"></a><span id="l10.18">   // that we can rely on settings *always* being imported before mail.</span>
<a href="#l10.19"></a><span id="l10.19">   nsresult            rv;</span>
<a href="#l10.20"></a><span id="l10.20">   nsCOMPtr&lt;nsIMsgTagService&gt;    pTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -81,24 +81,22 @@ static const char * sDaysOfWeek[7] = {</span>
<a href="#l11.4"></a><span id="l11.4">   &quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> };</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> static const char *sMonths[12] = {</span>
<a href="#l11.8"></a><span id="l11.8">   &quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> };</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> CMapiMessage::CMapiMessage( LPMESSAGE lpMsg)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  : m_lpMsg(lpMsg), m_pIOService(0), m_dldStateHeadersOnly(false), m_msgFlags(0)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  : m_lpMsg(lpMsg), m_dldStateHeadersOnly(false), m_msgFlags(0)</span>
<a href="#l11.14"></a><span id="l11.14"> {</span>
<a href="#l11.15"></a><span id="l11.15">   nsresult rv;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  NS_WITH_PROXIED_SERVICE(nsIIOService, service, NS_IOSERVICE_CONTRACTID,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-                          NS_PROXY_TO_MAIN_THREAD, &amp;rv);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  m_pIOService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.19"></a><span id="l11.19">   if (NS_FAILED(rv))</span>
<a href="#l11.20"></a><span id="l11.20">     return;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  NS_IF_ADDREF(m_pIOService = service);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">   FetchHeaders();</span>
<a href="#l11.24"></a><span id="l11.24">   if (ValidState()) {</span>
<a href="#l11.25"></a><span id="l11.25">     BuildFromLine();</span>
<a href="#l11.26"></a><span id="l11.26">     FetchFlags();</span>
<a href="#l11.27"></a><span id="l11.27">     GetDownloadState();</span>
<a href="#l11.28"></a><span id="l11.28">     if (FullMessageDownloaded()) {</span>
<a href="#l11.29"></a><span id="l11.29">       FetchBody();</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineat">@@ -107,17 +105,16 @@ CMapiMessage::CMapiMessage( LPMESSAGE lp</span>
<a href="#l11.31"></a><span id="l11.31">   }</span>
<a href="#l11.32"></a><span id="l11.32"> }</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> CMapiMessage::~CMapiMessage()</span>
<a href="#l11.35"></a><span id="l11.35"> {</span>
<a href="#l11.36"></a><span id="l11.36">   ClearAttachments();</span>
<a href="#l11.37"></a><span id="l11.37">   if (m_lpMsg)</span>
<a href="#l11.38"></a><span id="l11.38">     m_lpMsg-&gt;Release();</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  NS_IF_RELEASE(m_pIOService);</span>
<a href="#l11.40"></a><span id="l11.40"> }</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42"> void CMapiMessage::FormatDateTime(SYSTEMTIME&amp; tm, nsCString&amp; s, bool includeTZ)</span>
<a href="#l11.43"></a><span id="l11.43"> {</span>
<a href="#l11.44"></a><span id="l11.44">   long offset = _timezone;</span>
<a href="#l11.45"></a><span id="l11.45">   s += sDaysOfWeek[tm.wDayOfWeek];</span>
<a href="#l11.46"></a><span id="l11.46">   s += &quot;, &quot;;</span>
<a href="#l11.47"></a><span id="l11.47">   s.AppendInt((PRInt32) tm.wDay);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -38,18 +38,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #define MapiMessage_h___</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsString.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;MapiApi.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsProxiedService.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-</span>
<a href="#l12.14"></a><span id="l12.14"> #include &lt;vector&gt;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> #ifndef PR_LAST_VERB_EXECUTED</span>
<a href="#l12.17"></a><span id="l12.17"> #define PR_LAST_VERB_EXECUTED PROP_TAG( PT_LONG, 0x1081)</span>
<a href="#l12.18"></a><span id="l12.18"> #endif</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> #define EXCHIVERB_REPLYTOSENDER (102)</span>
<a href="#l12.21"></a><span id="l12.21"> #define EXCHIVERB_REPLYTOALL    (103)</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -258,18 +256,18 @@ private:</span>
<a href="#l12.23"></a><span id="l12.23">   std::vector&lt;attach_data*&gt; m_stdattachments;</span>
<a href="#l12.24"></a><span id="l12.24">   std::vector&lt;attach_data*&gt; m_embattachments; // Embedded</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">   nsString     m_body; // to be converted from UTF-16 using m_mimeCharset</span>
<a href="#l12.27"></a><span id="l12.27">   bool         m_bodyIsHtml;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">   PRUint32 m_msgFlags;</span>
<a href="#l12.30"></a><span id="l12.30">   PRUint32 m_msgLastVerb;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  </span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  nsIIOService *      m_pIOService;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; m_pIOService;</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">   void    GetDownloadState();</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   // Headers - fetch will get PR_TRANSPORT_MESSAGE_HEADERS</span>
<a href="#l12.39"></a><span id="l12.39">   // or if they do not exist will build a header from</span>
<a href="#l12.40"></a><span id="l12.40">   //  PR_DISPLAY_TO, _CC, _BCC</span>
<a href="#l12.41"></a><span id="l12.41">   //  PR_SUBJECT</span>
<a href="#l12.42"></a><span id="l12.42">   //  PR_MESSAGE_RECIPIENTS</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -42,18 +42,16 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIURI.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-#include &quot;nsProxiedService.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsIArray.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21"> #include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -246,36 +244,41 @@ nsOutlookCompose::~nsOutlookCompose()</span>
<a href="#l13.23"></a><span id="l13.23"> }</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> void nsOutlookCompose::ClearReplaceCids()</span>
<a href="#l13.26"></a><span id="l13.26"> {</span>
<a href="#l13.27"></a><span id="l13.27">   std::for_each(m_replacedCids.begin(), m_replacedCids.end(), ClearReplaceCid);</span>
<a href="#l13.28"></a><span id="l13.28">   m_replacedCids.clear();</span>
<a href="#l13.29"></a><span id="l13.29"> }</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+nsIMsgIdentity * nsOutlookCompose::m_pIdentity = nsnull;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+</span>
<a href="#l13.33"></a><span id="l13.33"> nsresult nsOutlookCompose::CreateIdentity( void)</span>
<a href="#l13.34"></a><span id="l13.34"> {</span>
<a href="#l13.35"></a><span id="l13.35">   if (m_pIdentity)</span>
<a href="#l13.36"></a><span id="l13.36">     return NS_OK;</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38">   nsresult rv;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  NS_WITH_PROXIED_SERVICE(nsIMsgAccountManager, accMgr,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-                          NS_MSGACCOUNTMANAGER_CONTRACTID,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-                          NS_PROXY_TO_MAIN_THREAD, &amp;rv);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.44"></a><span id="l13.44">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.45"></a><span id="l13.45">   rv = accMgr-&gt;CreateIdentity(&amp;m_pIdentity);</span>
<a href="#l13.46"></a><span id="l13.46">   nsString name;</span>
<a href="#l13.47"></a><span id="l13.47">   name.AssignLiteral(&quot;Import Identity&quot;);</span>
<a href="#l13.48"></a><span id="l13.48">   if (m_pIdentity) {</span>
<a href="#l13.49"></a><span id="l13.49">     m_pIdentity-&gt;SetFullName(name);</span>
<a href="#l13.50"></a><span id="l13.50">     m_pIdentity-&gt;SetIdentityName(name);</span>
<a href="#l13.51"></a><span id="l13.51">     m_pIdentity-&gt;SetEmail(NS_LITERAL_CSTRING(&quot;import@import.service&quot;));</span>
<a href="#l13.52"></a><span id="l13.52">   }</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  return rv;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+}</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-  return rv;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+void nsOutlookCompose::ReleaseIdentity()</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+{</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  NS_IF_RELEASE(m_pIdentity);</span>
<a href="#l13.60"></a><span id="l13.60"> }</span>
<a href="#l13.61"></a><span id="l13.61"> </span>
<a href="#l13.62"></a><span id="l13.62"> nsresult nsOutlookCompose::CreateComponents( void)</span>
<a href="#l13.63"></a><span id="l13.63"> {</span>
<a href="#l13.64"></a><span id="l13.64">   nsresult rv = NS_OK;</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">   NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l13.67"></a><span id="l13.67">   if (!m_pListener &amp;&amp; NS_SUCCEEDED( rv))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -61,24 +61,25 @@ class nsIIOService;</span>
<a href="#l14.4"></a><span id="l14.4"> ///////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> class nsOutlookCompose {</span>
<a href="#l14.7"></a><span id="l14.7"> public:</span>
<a href="#l14.8"></a><span id="l14.8">   nsOutlookCompose();</span>
<a href="#l14.9"></a><span id="l14.9">   ~nsOutlookCompose();</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   nsresult ProcessMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIOutputStream *pDst);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  static nsresult CreateIdentity(void);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  static void ReleaseIdentity(void);</span>
<a href="#l14.14"></a><span id="l14.14"> private:</span>
<a href="#l14.15"></a><span id="l14.15">   struct CidReplacePair {</span>
<a href="#l14.16"></a><span id="l14.16">     nsCString cidOrig;</span>
<a href="#l14.17"></a><span id="l14.17">     nsCString cidNew;</span>
<a href="#l14.18"></a><span id="l14.18">   };</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   nsresult  CreateComponents( void);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-  nsresult  CreateIdentity( void);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23">   void      UpdateHeader(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders, CMapiMessageHeaders::SpecialHeader header, bool addIfAbsent = true);</span>
<a href="#l14.24"></a><span id="l14.24">   void      UpdateHeaders(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders);</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   nsresult  ComposeTheMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIFile **pMsg);</span>
<a href="#l14.27"></a><span id="l14.27">   nsresult  CopyComposedMessage( nsIFile *pSrc, nsIOutputStream *pDst, CMapiMessage&amp; origMsg);</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   // Bug 593907</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineat">@@ -99,17 +100,17 @@ private:</span>
<a href="#l14.31"></a><span id="l14.31">   private:</span>
<a href="#l14.32"></a><span id="l14.32">     nsCString&amp; m_line;</span>
<a href="#l14.33"></a><span id="l14.33">     bool m_finishedReplacing;</span>
<a href="#l14.34"></a><span id="l14.34">   };</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   nsIMsgSendListener *  m_pListener;</span>
<a href="#l14.38"></a><span id="l14.38">   nsIMsgCompFields *    m_pMsgFields;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-  nsIMsgIdentity *    m_pIdentity;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  static nsIMsgIdentity *    m_pIdentity;</span>
<a href="#l14.41"></a><span id="l14.41">   char* m_optimizationBuffer;</span>
<a href="#l14.42"></a><span id="l14.42">   unsigned int m_optimizationBufferSize;</span>
<a href="#l14.43"></a><span id="l14.43">   nsCOMPtr&lt;nsIImportService&gt;  m_pImportService;</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">   // Bug 593907</span>
<a href="#l14.46"></a><span id="l14.46">   nsString m_hackedPostfix;</span>
<a href="#l14.47"></a><span id="l14.47">   // End Bug 593907</span>
<a href="#l14.48"></a><span id="l14.48"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -224,17 +224,17 @@ NS_IMETHODIMP nsOutlookImport::GetSuppor</span>
<a href="#l15.4"></a><span id="l15.4"> }</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> NS_IMETHODIMP nsOutlookImport::GetSupportsUpgrade( bool *pUpgrade)</span>
<a href="#l15.7"></a><span id="l15.7"> {</span>
<a href="#l15.8"></a><span id="l15.8">   NS_PRECONDITION(pUpgrade != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.9"></a><span id="l15.9">   if (! pUpgrade)</span>
<a href="#l15.10"></a><span id="l15.10">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  *pUpgrade = PR_TRUE;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  *pUpgrade = true;</span>
<a href="#l15.14"></a><span id="l15.14">   return( NS_OK);</span>
<a href="#l15.15"></a><span id="l15.15"> }</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> NS_IMETHODIMP nsOutlookImport::GetImportInterface( const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l15.18"></a><span id="l15.18"> {</span>
<a href="#l15.19"></a><span id="l15.19">   NS_PRECONDITION(pImportType != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.20"></a><span id="l15.20">   if (! pImportType)</span>
<a href="#l15.21"></a><span id="l15.21">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -315,35 +315,37 @@ nsresult ImportOutlookMailImpl::Create(n</span>
<a href="#l15.23"></a><span id="l15.23">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">   NS_ADDREF(*aImport);</span>
<a href="#l15.26"></a><span id="l15.26">   return NS_OK;</span>
<a href="#l15.27"></a><span id="l15.27"> }</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29"> ImportOutlookMailImpl::ImportOutlookMailImpl()</span>
<a href="#l15.30"></a><span id="l15.30"> {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  nsOutlookCompose::CreateIdentity();</span>
<a href="#l15.32"></a><span id="l15.32"> }</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34"> ImportOutlookMailImpl::~ImportOutlookMailImpl()</span>
<a href="#l15.35"></a><span id="l15.35"> {</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  nsOutlookCompose::ReleaseIdentity();</span>
<a href="#l15.37"></a><span id="l15.37"> }</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39"> NS_IMPL_THREADSAFE_ISUPPORTS1(ImportOutlookMailImpl, nsIImportMail)</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41"> NS_IMETHODIMP ImportOutlookMailImpl::GetDefaultLocation( nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l15.42"></a><span id="l15.42"> {</span>
<a href="#l15.43"></a><span id="l15.43">   NS_PRECONDITION(ppLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.44"></a><span id="l15.44">   NS_PRECONDITION(found != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.45"></a><span id="l15.45">   NS_PRECONDITION(userVerify != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.46"></a><span id="l15.46">   if (!ppLoc || !found || !userVerify)</span>
<a href="#l15.47"></a><span id="l15.47">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  *found = PR_FALSE;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  *found = false;</span>
<a href="#l15.51"></a><span id="l15.51">   *ppLoc = nsnull;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  *userVerify = PR_FALSE;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+  *userVerify = false;</span>
<a href="#l15.54"></a><span id="l15.54">   // We need to verify here that we can get the mail, if true then</span>
<a href="#l15.55"></a><span id="l15.55">   // return a dummy location, otherwise return no location</span>
<a href="#l15.56"></a><span id="l15.56">   CMapiApi  mapi;</span>
<a href="#l15.57"></a><span id="l15.57">   if (!mapi.Initialize())</span>
<a href="#l15.58"></a><span id="l15.58">     return( NS_OK);</span>
<a href="#l15.59"></a><span id="l15.59">   if (!mapi.LogOn())</span>
<a href="#l15.60"></a><span id="l15.60">     return( NS_OK);</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62" class="difflineat">@@ -355,19 +357,19 @@ NS_IMETHODIMP ImportOutlookMailImpl::Get</span>
<a href="#l15.63"></a><span id="l15.63">     return( NS_OK);</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66">   nsresult  rv;</span>
<a href="#l15.67"></a><span id="l15.67">   nsCOMPtr &lt;nsILocalFile&gt; resultFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l15.68"></a><span id="l15.68">   if (NS_FAILED(rv))</span>
<a href="#l15.69"></a><span id="l15.69">     return(rv);</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  *found = PR_TRUE;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  *found = true;</span>
<a href="#l15.73"></a><span id="l15.73">   NS_IF_ADDREF(*ppLoc = resultFile);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-  *userVerify = PR_FALSE;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  *userVerify = false;</span>
<a href="#l15.76"></a><span id="l15.76"> </span>
<a href="#l15.77"></a><span id="l15.77">   return( NS_OK);</span>
<a href="#l15.78"></a><span id="l15.78"> }</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81"> NS_IMETHODIMP ImportOutlookMailImpl::FindMailboxes( nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l15.82"></a><span id="l15.82"> {</span>
<a href="#l15.83"></a><span id="l15.83">   NS_PRECONDITION(pLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineat">@@ -428,17 +430,17 @@ NS_IMETHODIMP ImportOutlookMailImpl::Imp</span>
<a href="#l15.85"></a><span id="l15.85">   NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.86"></a><span id="l15.86">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88">   nsString  success;</span>
<a href="#l15.89"></a><span id="l15.89">   nsString  error;</span>
<a href="#l15.90"></a><span id="l15.90">   if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l15.91"></a><span id="l15.91">     nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l15.92"></a><span id="l15.92">     if (fatalError)</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-      *fatalError = PR_TRUE;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+      *fatalError = true;</span>
<a href="#l15.95"></a><span id="l15.95">     SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l15.96"></a><span id="l15.96">       return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.97"></a><span id="l15.97">   }</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99">     bool      abort = false;</span>
<a href="#l15.100"></a><span id="l15.100">     nsString  name;</span>
<a href="#l15.101"></a><span id="l15.101">     PRUnichar *  pName;</span>
<a href="#l15.102"></a><span id="l15.102">     if (NS_SUCCEEDED( pSource-&gt;GetDisplayName( &amp;pName))) {</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineat">@@ -525,17 +527,17 @@ NS_IMPL_THREADSAFE_ISUPPORTS1(ImportOutl</span>
<a href="#l15.104"></a><span id="l15.104"> </span>
<a href="#l15.105"></a><span id="l15.105"> NS_IMETHODIMP ImportOutlookAddressImpl::GetAutoFind(PRUnichar **description, bool *_retval)</span>
<a href="#l15.106"></a><span id="l15.106"> {</span>
<a href="#l15.107"></a><span id="l15.107">   NS_PRECONDITION(description != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.108"></a><span id="l15.108">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.109"></a><span id="l15.109">   if (! description || !_retval)</span>
<a href="#l15.110"></a><span id="l15.110">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.111"></a><span id="l15.111"> </span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-  *_retval = PR_TRUE;</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  *_retval = true;</span>
<a href="#l15.114"></a><span id="l15.114">   nsString str;</span>
<a href="#l15.115"></a><span id="l15.115">   nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_ADDRNAME, str);</span>
<a href="#l15.116"></a><span id="l15.116">   *description = ToNewUnicode(str);</span>
<a href="#l15.117"></a><span id="l15.117">   return( NS_OK);</span>
<a href="#l15.118"></a><span id="l15.118"> }</span>
<a href="#l15.119"></a><span id="l15.119"> </span>
<a href="#l15.120"></a><span id="l15.120"> NS_IMETHODIMP ImportOutlookAddressImpl::FindAddressBooks(nsIFile *location, nsISupportsArray **_retval)</span>
<a href="#l15.121"></a><span id="l15.121"> {</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineat">@@ -561,17 +563,17 @@ NS_IMETHODIMP ImportOutlookAddressImpl::</span>
<a href="#l15.123"></a><span id="l15.123">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125">   nsString  success;</span>
<a href="#l15.126"></a><span id="l15.126">   nsString  error;</span>
<a href="#l15.127"></a><span id="l15.127">     if (!source || !destination || !fatalError) {</span>
<a href="#l15.128"></a><span id="l15.128">     IMPORT_LOG0( &quot;*** Bad param passed to outlook address import\n&quot;);</span>
<a href="#l15.129"></a><span id="l15.129">     nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l15.130"></a><span id="l15.130">     if (fatalError)</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-      *fatalError = PR_TRUE;</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+      *fatalError = true;</span>
<a href="#l15.133"></a><span id="l15.133">     ImportOutlookMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l15.134"></a><span id="l15.134">       return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.135"></a><span id="l15.135">   }</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137">     nsString name;</span>
<a href="#l15.138"></a><span id="l15.138">     source-&gt;GetPreferredName(name);</span>
<a href="#l15.139"></a><span id="l15.139"> </span>
<a href="#l15.140"></a><span id="l15.140">   PRUint32  id;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookStringBundle.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookStringBundle.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -36,17 +36,16 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;prprf.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;prmem.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;nsIURI.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> #define OUTLOOK_MSGS_URL       &quot;chrome://messenger/locale/outlookImportMsgs.properties&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> nsIStringBundle *  nsOutlookStringBundle::m_pBundle = nsnull;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> nsIStringBundle *nsOutlookStringBundle::GetStringBundle( void)</span>
<a href="#l16.20"></a><span id="l16.20"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -53,31 +53,30 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13"> </span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-#include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25"> #include &quot;plstr.h&quot;</span>
<a href="#l17.26"></a><span id="l17.26"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29"> #define IMPORT_MSGS_URL       &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33"> static void ImportMailThread( void *stuff);</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35"> class ImportThreadData;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineat">@@ -159,16 +158,30 @@ public:</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   ImportThreadData();</span>
<a href="#l17.39"></a><span id="l17.39">   ~ImportThreadData();</span>
<a href="#l17.40"></a><span id="l17.40">   void DriverDelete();</span>
<a href="#l17.41"></a><span id="l17.41">   void ThreadDelete();</span>
<a href="#l17.42"></a><span id="l17.42">   void DriverAbort();</span>
<a href="#l17.43"></a><span id="l17.43"> };</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+// forward decl for proxy methods</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+nsresult ProxyGetSubFolders(nsIMsgFolder *aFolder,</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+                            nsISimpleEnumerator **aEnumerator);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+nsresult ProxyGetChildNamed(nsIMsgFolder *aFolder,const nsAString &amp; aName,</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+                            nsIMsgFolder **aChild);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+nsresult ProxyGetParent(nsIMsgFolder *aFolder, nsIMsgFolder **aParent);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+nsresult ProxyContainsChildNamed(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+                                 bool *aResult);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+nsresult ProxyGenerateUniqueSubfolderName(nsIMsgFolder *aFolder,</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+                                          const nsAString&amp; aPrefix,</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+                                          nsIMsgFolder *aOtherFolder,</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+                                          nsAString&amp; aName);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+nsresult ProxyCreateSubfolder(nsIMsgFolder *aFolder, const nsAString &amp;aName);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+nsresult ProxyForceDBClosed(nsIMsgFolder *aFolder);</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60"> nsresult NS_NewGenericMail(nsIImportGeneric** aImportGeneric)</span>
<a href="#l17.61"></a><span id="l17.61"> {</span>
<a href="#l17.62"></a><span id="l17.62">     NS_PRECONDITION(aImportGeneric != nsnull, &quot;null ptr&quot;);</span>
<a href="#l17.63"></a><span id="l17.63">     if (! aImportGeneric)</span>
<a href="#l17.64"></a><span id="l17.64">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66">   nsImportGenericMail *pGen = new nsImportGenericMail();</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineat">@@ -180,31 +193,31 @@ nsresult NS_NewGenericMail(nsIImportGene</span>
<a href="#l17.68"></a><span id="l17.68">   nsresult rv = pGen-&gt;QueryInterface( NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l17.69"></a><span id="l17.69">   NS_RELEASE( pGen);</span>
<a href="#l17.70"></a><span id="l17.70"> </span>
<a href="#l17.71"></a><span id="l17.71">     return( rv);</span>
<a href="#l17.72"></a><span id="l17.72"> }</span>
<a href="#l17.73"></a><span id="l17.73"> </span>
<a href="#l17.74"></a><span id="l17.74"> nsImportGenericMail::nsImportGenericMail()</span>
<a href="#l17.75"></a><span id="l17.75"> {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-  m_found = PR_FALSE;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-  m_userVerify = PR_FALSE;</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-  m_gotLocation = PR_FALSE;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  m_found = false;</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  m_userVerify = false;</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+  m_gotLocation = false;</span>
<a href="#l17.82"></a><span id="l17.82">   m_pInterface = nsnull;</span>
<a href="#l17.83"></a><span id="l17.83">   m_pMailboxes = nsnull;</span>
<a href="#l17.84"></a><span id="l17.84">   m_pSuccessLog = nsnull;</span>
<a href="#l17.85"></a><span id="l17.85">   m_pErrorLog = nsnull;</span>
<a href="#l17.86"></a><span id="l17.86">   m_totalSize = 0;</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-  m_doImport = PR_FALSE;</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+  m_doImport = false;</span>
<a href="#l17.89"></a><span id="l17.89">   m_pThreadData = nsnull;</span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91">   m_pDestFolder = nsnull;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-  m_deleteDestFolder = PR_FALSE;</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  m_createdFolder = PR_FALSE;</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-    m_performingMigration = PR_FALSE;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  m_deleteDestFolder = false;</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  m_createdFolder = false;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+    m_performingMigration = false;</span>
<a href="#l17.98"></a><span id="l17.98"> </span>
<a href="#l17.99"></a><span id="l17.99">   // Init logging module.</span>
<a href="#l17.100"></a><span id="l17.100">   if (!IMPORTLOGMODULE)</span>
<a href="#l17.101"></a><span id="l17.101">     IMPORTLOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103">   nsresult rv = nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l17.104"></a><span id="l17.104">   if (NS_FAILED(rv))</span>
<a href="#l17.105"></a><span id="l17.105">     IMPORT_LOG0(&quot;Failed to get string bundle for Importing Mail&quot;);</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineat">@@ -313,17 +326,17 @@ NS_IMETHODIMP nsImportGenericMail::SetDa</span>
<a href="#l17.107"></a><span id="l17.107">       m_pSrcLocation = location;</span>
<a href="#l17.108"></a><span id="l17.108">     }</span>
<a href="#l17.109"></a><span id="l17.109">   }</span>
<a href="#l17.110"></a><span id="l17.110"> </span>
<a href="#l17.111"></a><span id="l17.111">   if (!PL_strcasecmp( dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l17.112"></a><span id="l17.112">     NS_IF_RELEASE( m_pDestFolder);</span>
<a href="#l17.113"></a><span id="l17.113">     if (item)</span>
<a href="#l17.114"></a><span id="l17.114">       item-&gt;QueryInterface( NS_GET_IID(nsIMsgFolder), (void **) &amp;m_pDestFolder);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    m_deleteDestFolder = PR_FALSE;</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+    m_deleteDestFolder = false;</span>
<a href="#l17.117"></a><span id="l17.117">   }</span>
<a href="#l17.118"></a><span id="l17.118"> </span>
<a href="#l17.119"></a><span id="l17.119">   if (!PL_strcasecmp( dataId, &quot;name&quot;)) {</span>
<a href="#l17.120"></a><span id="l17.120">     nsCOMPtr&lt;nsISupportsString&gt; nameString;</span>
<a href="#l17.121"></a><span id="l17.121">     if (item) {</span>
<a href="#l17.122"></a><span id="l17.122">       item-&gt;QueryInterface( NS_GET_IID(nsISupportsString), getter_AddRefs(nameString));</span>
<a href="#l17.123"></a><span id="l17.123">       rv = nameString-&gt;GetData(m_pName);</span>
<a href="#l17.124"></a><span id="l17.124">     }</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineat">@@ -365,17 +378,17 @@ NS_IMETHODIMP nsImportGenericMail::GetSt</span>
<a href="#l17.126"></a><span id="l17.126"> void nsImportGenericMail::GetDefaultLocation( void)</span>
<a href="#l17.127"></a><span id="l17.127"> {</span>
<a href="#l17.128"></a><span id="l17.128">   if (!m_pInterface)</span>
<a href="#l17.129"></a><span id="l17.129">     return;</span>
<a href="#l17.130"></a><span id="l17.130"> </span>
<a href="#l17.131"></a><span id="l17.131">   if (m_pSrcLocation &amp;&amp; m_gotLocation)</span>
<a href="#l17.132"></a><span id="l17.132">     return;</span>
<a href="#l17.133"></a><span id="l17.133"> </span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-  m_gotLocation = PR_TRUE;</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+  m_gotLocation = true;</span>
<a href="#l17.136"></a><span id="l17.136"> </span>
<a href="#l17.137"></a><span id="l17.137">   nsCOMPtr &lt;nsIFile&gt; pLoc;</span>
<a href="#l17.138"></a><span id="l17.138">   m_pInterface-&gt;GetDefaultLocation( getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l17.139"></a><span id="l17.139">   if (!m_pSrcLocation)</span>
<a href="#l17.140"></a><span id="l17.140">     m_pSrcLocation = pLoc;</span>
<a href="#l17.141"></a><span id="l17.141"> }</span>
<a href="#l17.142"></a><span id="l17.142"> </span>
<a href="#l17.143"></a><span id="l17.143"> void nsImportGenericMail::GetDefaultMailboxes( void)</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineat">@@ -389,22 +402,22 @@ void nsImportGenericMail::GetDefaultMail</span>
<a href="#l17.145"></a><span id="l17.145"> void nsImportGenericMail::GetDefaultDestination( void)</span>
<a href="#l17.146"></a><span id="l17.146"> {</span>
<a href="#l17.147"></a><span id="l17.147">   if (m_pDestFolder)</span>
<a href="#l17.148"></a><span id="l17.148">     return;</span>
<a href="#l17.149"></a><span id="l17.149">   if (!m_pInterface)</span>
<a href="#l17.150"></a><span id="l17.150">     return;</span>
<a href="#l17.151"></a><span id="l17.151"> </span>
<a href="#l17.152"></a><span id="l17.152">   nsIMsgFolder *  rootFolder;</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-  m_deleteDestFolder = PR_FALSE;</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-  m_createdFolder = PR_FALSE;</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+  m_deleteDestFolder = false;</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+  m_createdFolder = false;</span>
<a href="#l17.157"></a><span id="l17.157">   if (CreateFolder( &amp;rootFolder)) {</span>
<a href="#l17.158"></a><span id="l17.158">     m_pDestFolder = rootFolder;</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-    m_deleteDestFolder = PR_TRUE;</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-    m_createdFolder = PR_TRUE;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+    m_deleteDestFolder = true;</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+    m_createdFolder = true;</span>
<a href="#l17.163"></a><span id="l17.163">     return;</span>
<a href="#l17.164"></a><span id="l17.164">   }</span>
<a href="#l17.165"></a><span id="l17.165">   IMPORT_LOG0(&quot;*** GetDefaultDestination: Failed to create a default import destination folder.&quot;);</span>
<a href="#l17.166"></a><span id="l17.166"> }</span>
<a href="#l17.167"></a><span id="l17.167"> </span>
<a href="#l17.168"></a><span id="l17.168"> NS_IMETHODIMP nsImportGenericMail::WantsProgress(bool *_retval)</span>
<a href="#l17.169"></a><span id="l17.169"> {</span>
<a href="#l17.170"></a><span id="l17.170">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineat">@@ -436,22 +449,22 @@ NS_IMETHODIMP nsImportGenericMail::Wants</span>
<a href="#l17.172"></a><span id="l17.172">     PRUint32    size;</span>
<a href="#l17.173"></a><span id="l17.173"> </span>
<a href="#l17.174"></a><span id="l17.174">     rv = m_pMailboxes-&gt;Count( &amp;count);</span>
<a href="#l17.175"></a><span id="l17.175"> </span>
<a href="#l17.176"></a><span id="l17.176">     for (i = 0; i &lt; count; i++) {</span>
<a href="#l17.177"></a><span id="l17.177">       nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box =</span>
<a href="#l17.178"></a><span id="l17.178">         do_QueryElementAt(m_pMailboxes, i);</span>
<a href="#l17.179"></a><span id="l17.179">       if (box) {</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-        import = PR_FALSE;</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+        import = false;</span>
<a href="#l17.182"></a><span id="l17.182">         size = 0;</span>
<a href="#l17.183"></a><span id="l17.183">         rv = box-&gt;GetImport( &amp;import);</span>
<a href="#l17.184"></a><span id="l17.184">         if (import) {</span>
<a href="#l17.185"></a><span id="l17.185">           rv = box-&gt;GetSize( &amp;size);</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-          result = PR_TRUE;</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+          result = true;</span>
<a href="#l17.188"></a><span id="l17.188">         }</span>
<a href="#l17.189"></a><span id="l17.189">         totalSize += size;</span>
<a href="#l17.190"></a><span id="l17.190">       }</span>
<a href="#l17.191"></a><span id="l17.191">     }</span>
<a href="#l17.192"></a><span id="l17.192"> </span>
<a href="#l17.193"></a><span id="l17.193">     m_totalSize = totalSize;</span>
<a href="#l17.194"></a><span id="l17.194">   }</span>
<a href="#l17.195"></a><span id="l17.195"> </span>
<a href="#l17.196"></a><span id="l17.196" class="difflineat">@@ -484,35 +497,35 @@ NS_IMETHODIMP nsImportGenericMail::Begin</span>
<a href="#l17.197"></a><span id="l17.197"> </span>
<a href="#l17.198"></a><span id="l17.198">   nsString  success;</span>
<a href="#l17.199"></a><span id="l17.199">   nsString  error;</span>
<a href="#l17.200"></a><span id="l17.200"> </span>
<a href="#l17.201"></a><span id="l17.201">   if (!m_doImport) {</span>
<a href="#l17.202"></a><span id="l17.202">     nsImportStringBundle::GetStringByID(IMPORT_NO_MAILBOXES,</span>
<a href="#l17.203"></a><span id="l17.203">                                         m_stringBundle, success);</span>
<a href="#l17.204"></a><span id="l17.204">     SetLogs( success, error, successLog, errorLog);</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-    *_retval = PR_TRUE;</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+    *_retval = true;</span>
<a href="#l17.207"></a><span id="l17.207">     return( NS_OK);</span>
<a href="#l17.208"></a><span id="l17.208">   }</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210">   if (!m_pInterface || !m_pMailboxes) {</span>
<a href="#l17.211"></a><span id="l17.211">     IMPORT_LOG0( &quot;*** BeginImport: Either the interface or source mailbox is not set properly.&quot;);</span>
<a href="#l17.212"></a><span id="l17.212">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOTINITIALIZED,</span>
<a href="#l17.213"></a><span id="l17.213">                                         m_stringBundle, error);</span>
<a href="#l17.214"></a><span id="l17.214">     SetLogs( success, error, successLog, errorLog);</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-    *_retval = PR_FALSE;</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+    *_retval = false;</span>
<a href="#l17.217"></a><span id="l17.217">     return( NS_OK);</span>
<a href="#l17.218"></a><span id="l17.218">   }</span>
<a href="#l17.219"></a><span id="l17.219"> </span>
<a href="#l17.220"></a><span id="l17.220">   if (!m_pDestFolder) {</span>
<a href="#l17.221"></a><span id="l17.221">     IMPORT_LOG0( &quot;*** BeginImport: The destination mailbox is not set properly.&quot;);</span>
<a href="#l17.222"></a><span id="l17.222">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NODESTFOLDER,</span>
<a href="#l17.223"></a><span id="l17.223">                                         m_stringBundle, error);</span>
<a href="#l17.224"></a><span id="l17.224">     SetLogs( success, error, successLog, errorLog);</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-    *_retval = PR_FALSE;</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+    *_retval = false;</span>
<a href="#l17.227"></a><span id="l17.227">     return( NS_OK);</span>
<a href="#l17.228"></a><span id="l17.228">   }</span>
<a href="#l17.229"></a><span id="l17.229"> </span>
<a href="#l17.230"></a><span id="l17.230">   if (m_pThreadData) {</span>
<a href="#l17.231"></a><span id="l17.231">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l17.232"></a><span id="l17.232">     m_pThreadData = nsnull;</span>
<a href="#l17.233"></a><span id="l17.233">   }</span>
<a href="#l17.234"></a><span id="l17.234"> </span>
<a href="#l17.235"></a><span id="l17.235" class="difflineat">@@ -544,42 +557,42 @@ NS_IMETHODIMP nsImportGenericMail::Begin</span>
<a href="#l17.236"></a><span id="l17.236"> </span>
<a href="#l17.237"></a><span id="l17.237">   PRThread *pThread = PR_CreateThread( PR_USER_THREAD, &amp;ImportMailThread, m_pThreadData,</span>
<a href="#l17.238"></a><span id="l17.238">                   PR_PRIORITY_NORMAL,</span>
<a href="#l17.239"></a><span id="l17.239">                   PR_LOCAL_THREAD,</span>
<a href="#l17.240"></a><span id="l17.240">                   PR_UNJOINABLE_THREAD,</span>
<a href="#l17.241"></a><span id="l17.241">                   0);</span>
<a href="#l17.242"></a><span id="l17.242">   if (!pThread) {</span>
<a href="#l17.243"></a><span id="l17.243">     m_pThreadData-&gt;ThreadDelete();</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-    m_pThreadData-&gt;abort = PR_TRUE;</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+    m_pThreadData-&gt;abort = true;</span>
<a href="#l17.246"></a><span id="l17.246">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l17.247"></a><span id="l17.247">     m_pThreadData = nsnull;</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-    *_retval = PR_FALSE;</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+    *_retval = false;</span>
<a href="#l17.250"></a><span id="l17.250">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOTHREAD,</span>
<a href="#l17.251"></a><span id="l17.251">                                         m_stringBundle, error);</span>
<a href="#l17.252"></a><span id="l17.252">     SetLogs( success, error, successLog, errorLog);</span>
<a href="#l17.253"></a><span id="l17.253">   }</span>
<a href="#l17.254"></a><span id="l17.254">   else</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineminus">-    *_retval = PR_TRUE;</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+    *_retval = true;</span>
<a href="#l17.257"></a><span id="l17.257"> </span>
<a href="#l17.258"></a><span id="l17.258">   return( NS_OK);</span>
<a href="#l17.259"></a><span id="l17.259"> </span>
<a href="#l17.260"></a><span id="l17.260"> }</span>
<a href="#l17.261"></a><span id="l17.261"> </span>
<a href="#l17.262"></a><span id="l17.262"> </span>
<a href="#l17.263"></a><span id="l17.263"> NS_IMETHODIMP nsImportGenericMail::ContinueImport(bool *_retval)</span>
<a href="#l17.264"></a><span id="l17.264"> {</span>
<a href="#l17.265"></a><span id="l17.265">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l17.266"></a><span id="l17.266">     if (!_retval)</span>
<a href="#l17.267"></a><span id="l17.267">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.268"></a><span id="l17.268"> </span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-  *_retval = PR_TRUE;</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+  *_retval = true;</span>
<a href="#l17.271"></a><span id="l17.271">   if (m_pThreadData) {</span>
<a href="#l17.272"></a><span id="l17.272">     if (m_pThreadData-&gt;fatalError)</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-      *_retval = PR_FALSE;</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+      *_retval = false;</span>
<a href="#l17.275"></a><span id="l17.275">   }</span>
<a href="#l17.276"></a><span id="l17.276"> </span>
<a href="#l17.277"></a><span id="l17.277">   return( NS_OK);</span>
<a href="#l17.278"></a><span id="l17.278"> }</span>
<a href="#l17.279"></a><span id="l17.279"> </span>
<a href="#l17.280"></a><span id="l17.280"> </span>
<a href="#l17.281"></a><span id="l17.281"> NS_IMETHODIMP nsImportGenericMail::GetProgress(PRInt32 *_retval)</span>
<a href="#l17.282"></a><span id="l17.282"> {</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineat">@@ -651,35 +664,35 @@ void nsImportGenericMail::SetLogs(nsStri</span>
<a href="#l17.284"></a><span id="l17.284">         str.Append(error);</span>
<a href="#l17.285"></a><span id="l17.285">         pError-&gt;SetData(str);</span>
<a href="#l17.286"></a><span id="l17.286">     }</span>
<a href="#l17.287"></a><span id="l17.287"> }</span>
<a href="#l17.288"></a><span id="l17.288"> </span>
<a href="#l17.289"></a><span id="l17.289"> NS_IMETHODIMP nsImportGenericMail::CancelImport(void)</span>
<a href="#l17.290"></a><span id="l17.290"> {</span>
<a href="#l17.291"></a><span id="l17.291">   if (m_pThreadData) {</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-    m_pThreadData-&gt;abort = PR_TRUE;</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+    m_pThreadData-&gt;abort = true;</span>
<a href="#l17.294"></a><span id="l17.294">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l17.295"></a><span id="l17.295">     m_pThreadData = nsnull;</span>
<a href="#l17.296"></a><span id="l17.296">   }</span>
<a href="#l17.297"></a><span id="l17.297"> </span>
<a href="#l17.298"></a><span id="l17.298">   return( NS_OK);</span>
<a href="#l17.299"></a><span id="l17.299"> }</span>
<a href="#l17.300"></a><span id="l17.300"> </span>
<a href="#l17.301"></a><span id="l17.301"> </span>
<a href="#l17.302"></a><span id="l17.302"> ImportThreadData::ImportThreadData()</span>
<a href="#l17.303"></a><span id="l17.303"> {</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-  fatalError = PR_FALSE;</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-  driverAlive = PR_TRUE;</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-  threadAlive = PR_TRUE;</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-  abort = PR_FALSE;</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineplus">+  fatalError = false;</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+  driverAlive = true;</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+  threadAlive = true;</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  abort = false;</span>
<a href="#l17.312"></a><span id="l17.312">   currentTotal = 0;</span>
<a href="#l17.313"></a><span id="l17.313">   currentSize = 0;</span>
<a href="#l17.314"></a><span id="l17.314">   destRoot = nsnull;</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineminus">-  ownsDestRoot = PR_FALSE;</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+  ownsDestRoot = false;</span>
<a href="#l17.317"></a><span id="l17.317">   boxes = nsnull;</span>
<a href="#l17.318"></a><span id="l17.318">   mailImport = nsnull;</span>
<a href="#l17.319"></a><span id="l17.319">   successLog = nsnull;</span>
<a href="#l17.320"></a><span id="l17.320">   errorLog = nsnull;</span>
<a href="#l17.321"></a><span id="l17.321">   stringBundle = nsnull;</span>
<a href="#l17.322"></a><span id="l17.322"> }</span>
<a href="#l17.323"></a><span id="l17.323"> </span>
<a href="#l17.324"></a><span id="l17.324"> ImportThreadData::~ImportThreadData()</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineat">@@ -689,40 +702,40 @@ ImportThreadData::~ImportThreadData()</span>
<a href="#l17.326"></a><span id="l17.326">   NS_IF_RELEASE( mailImport);</span>
<a href="#l17.327"></a><span id="l17.327">   NS_IF_RELEASE( errorLog);</span>
<a href="#l17.328"></a><span id="l17.328">   NS_IF_RELEASE( successLog);</span>
<a href="#l17.329"></a><span id="l17.329">   NS_IF_RELEASE( stringBundle);</span>
<a href="#l17.330"></a><span id="l17.330"> }</span>
<a href="#l17.331"></a><span id="l17.331"> </span>
<a href="#l17.332"></a><span id="l17.332"> void ImportThreadData::DriverDelete( void)</span>
<a href="#l17.333"></a><span id="l17.333"> {</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineminus">-  driverAlive = PR_FALSE;</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineplus">+  driverAlive = false;</span>
<a href="#l17.336"></a><span id="l17.336">   if (!driverAlive &amp;&amp; !threadAlive)</span>
<a href="#l17.337"></a><span id="l17.337">     delete this;</span>
<a href="#l17.338"></a><span id="l17.338"> }</span>
<a href="#l17.339"></a><span id="l17.339"> </span>
<a href="#l17.340"></a><span id="l17.340"> void ImportThreadData::ThreadDelete()</span>
<a href="#l17.341"></a><span id="l17.341"> {</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineminus">-  threadAlive = PR_FALSE;</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+  threadAlive = false;</span>
<a href="#l17.344"></a><span id="l17.344">   if (!driverAlive &amp;&amp; !threadAlive)</span>
<a href="#l17.345"></a><span id="l17.345">     delete this;</span>
<a href="#l17.346"></a><span id="l17.346"> }</span>
<a href="#l17.347"></a><span id="l17.347"> </span>
<a href="#l17.348"></a><span id="l17.348"> void ImportThreadData::DriverAbort()</span>
<a href="#l17.349"></a><span id="l17.349"> {</span>
<a href="#l17.350"></a><span id="l17.350">   if (abort &amp;&amp; !threadAlive &amp;&amp; destRoot) {</span>
<a href="#l17.351"></a><span id="l17.351">     if (ownsDestRoot) {</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-      destRoot-&gt;RecursiveDelete(PR_TRUE, nsnull);</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+      destRoot-&gt;RecursiveDelete(true, nsnull);</span>
<a href="#l17.354"></a><span id="l17.354">     }</span>
<a href="#l17.355"></a><span id="l17.355">     else {</span>
<a href="#l17.356"></a><span id="l17.356">       // FIXME: just delete the stuff we created?</span>
<a href="#l17.357"></a><span id="l17.357">     }</span>
<a href="#l17.358"></a><span id="l17.358">   }</span>
<a href="#l17.359"></a><span id="l17.359">   else</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineminus">-    abort = PR_TRUE;</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+    abort = true;</span>
<a href="#l17.362"></a><span id="l17.362">   DriverDelete();</span>
<a href="#l17.363"></a><span id="l17.363"> }</span>
<a href="#l17.364"></a><span id="l17.364"> </span>
<a href="#l17.365"></a><span id="l17.365"> </span>
<a href="#l17.366"></a><span id="l17.366"> </span>
<a href="#l17.367"></a><span id="l17.367"> static void</span>
<a href="#l17.368"></a><span id="l17.368"> ImportMailThread( void *stuff)</span>
<a href="#l17.369"></a><span id="l17.369"> {</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineat">@@ -741,124 +754,83 @@ ImportMailThread( void *stuff)</span>
<a href="#l17.371"></a><span id="l17.371">   bool        import;</span>
<a href="#l17.372"></a><span id="l17.372">   PRUint32    size;</span>
<a href="#l17.373"></a><span id="l17.373">   PRUint32    depth = 1;</span>
<a href="#l17.374"></a><span id="l17.374">   PRUint32    newDepth;</span>
<a href="#l17.375"></a><span id="l17.375">   nsString    lastName;</span>
<a href="#l17.376"></a><span id="l17.376">   PRUnichar *    pName;</span>
<a href="#l17.377"></a><span id="l17.377"> </span>
<a href="#l17.378"></a><span id="l17.378">   nsCOMPtr&lt;nsIMsgFolder&gt;    curFolder( destRoot);</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;    curProxy;</span>
<a href="#l17.380"></a><span id="l17.380"> </span>
<a href="#l17.381"></a><span id="l17.381">   nsCOMPtr&lt;nsIMsgFolder&gt;          newFolder;</span>
<a href="#l17.382"></a><span id="l17.382">   nsCOMPtr&lt;nsILocalFile&gt;          outBox;</span>
<a href="#l17.383"></a><span id="l17.383">   nsCOMPtr&lt;nsIMsgFolder&gt;          subFolder;</span>
<a href="#l17.384"></a><span id="l17.384">   nsCOMPtr&lt;nsISimpleEnumerator&gt;   enumerator;</span>
<a href="#l17.385"></a><span id="l17.385"> </span>
<a href="#l17.386"></a><span id="l17.386">   bool              exists;</span>
<a href="#l17.387"></a><span id="l17.387"> </span>
<a href="#l17.388"></a><span id="l17.388">   nsString  success;</span>
<a href="#l17.389"></a><span id="l17.389">   nsString  error;</span>
<a href="#l17.390"></a><span id="l17.390"> </span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-  // Initialize the curFolder proxy object</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineminus">-  nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr =</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineminus">-    do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineminus">-  {</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-    IMPORT_LOG0(&quot;*** ImportMailThread: Unable to obtain proxy object manager for the import.&quot;);</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineminus">-    pData-&gt;abort = PR_TRUE;</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-  }</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineminus">-</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineminus">-  rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineminus">-                                      NS_GET_IID(nsIMsgFolder),</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineminus">-                                      curFolder,</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineminus">-                                      NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineminus">-                                      getter_AddRefs(curProxy));</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineminus">-</span>
<a href="#l17.406"></a><span id="l17.406" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-    // GetSubfolders() will initialize folders if they are not already initialized.</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineminus">-    curProxy-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineminus">-  } else {</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineminus">-    IMPORT_LOG1( &quot;*** ImportMailThread: Can't get the destination root folder proxy. rv=(0x%lx)&quot;, (long) rv);</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineminus">-  }</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineminus">-</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineplus">+  // GetSubFolders() will initialize folders if they are not already initialized.</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+  ProxyGetSubFolders(curFolder, getter_AddRefs(enumerator));</span>
<a href="#l17.415"></a><span id="l17.415"> </span>
<a href="#l17.416"></a><span id="l17.416">   IMPORT_LOG1(&quot;ImportMailThread: Total number of folders to import = %d.&quot;, count);</span>
<a href="#l17.417"></a><span id="l17.417"> </span>
<a href="#l17.418"></a><span id="l17.418">   // Note that the front-end js script only displays one import result string so</span>
<a href="#l17.419"></a><span id="l17.419">   // we combine both good and bad import status into one string (in var 'success').</span>
<a href="#l17.420"></a><span id="l17.420"> </span>
<a href="#l17.421"></a><span id="l17.421">   for (i = 0; (i &lt; count) &amp;&amp; !(pData-&gt;abort); i++) {</span>
<a href="#l17.422"></a><span id="l17.422">     nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box =</span>
<a href="#l17.423"></a><span id="l17.423">       do_QueryElementAt(pData-&gt;boxes, i);</span>
<a href="#l17.424"></a><span id="l17.424">     if (box) {</span>
<a href="#l17.425"></a><span id="l17.425">       pData-&gt;currentMailbox = i;</span>
<a href="#l17.426"></a><span id="l17.426"> </span>
<a href="#l17.427"></a><span id="l17.427" class="difflineminus">-      import = PR_FALSE;</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+      import = false;</span>
<a href="#l17.429"></a><span id="l17.429">       size = 0;</span>
<a href="#l17.430"></a><span id="l17.430">       rv = box-&gt;GetImport( &amp;import);</span>
<a href="#l17.431"></a><span id="l17.431">       if (import)</span>
<a href="#l17.432"></a><span id="l17.432">         rv = box-&gt;GetSize( &amp;size);</span>
<a href="#l17.433"></a><span id="l17.433">       rv = box-&gt;GetDepth( &amp;newDepth);</span>
<a href="#l17.434"></a><span id="l17.434">       if (newDepth &gt; depth) {</span>
<a href="#l17.435"></a><span id="l17.435">           // OK, we are going to add a subfolder under the last/previous folder we processed, so</span>
<a href="#l17.436"></a><span id="l17.436">           // find this folder (stored in 'lastName') who is going to be the new parent folder.</span>
<a href="#l17.437"></a><span id="l17.437">         IMPORT_LOG1(&quot;ImportMailThread: Processing child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineminus">-        rv = curProxy-&gt;GetChildNamed( lastName, getter_AddRefs( subFolder));</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineplus">+        rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(subFolder));</span>
<a href="#l17.440"></a><span id="l17.440">         if (NS_FAILED( rv)) {</span>
<a href="#l17.441"></a><span id="l17.441">           IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the interface for child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l17.442"></a><span id="l17.442">           nsImportGenericMail::ReportError(IMPORT_ERROR_MB_FINDCHILD,</span>
<a href="#l17.443"></a><span id="l17.443">                                            lastName.get(),</span>
<a href="#l17.444"></a><span id="l17.444">                                            &amp;error, pData-&gt;stringBundle);</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineminus">-          pData-&gt;fatalError = PR_TRUE;</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineminus">-          break;</span>
<a href="#l17.447"></a><span id="l17.447" class="difflineminus">-        }</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineminus">-</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-        rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineminus">-                                            NS_GET_IID(nsIMsgFolder),</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineminus">-                                            subFolder,</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineminus">-                                            NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineminus">-                                            getter_AddRefs(curProxy));</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineminus">-        if (NS_FAILED( rv)) {</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineminus">-          IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the proxy interface for child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineminus">-          nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOPROXY, pData-&gt;stringBundle,</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineminus">-                                              error);</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineminus">-          pData-&gt;fatalError = PR_TRUE;</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineplus">+          pData-&gt;fatalError = true;</span>
<a href="#l17.460"></a><span id="l17.460">           break;</span>
<a href="#l17.461"></a><span id="l17.461">         }</span>
<a href="#l17.462"></a><span id="l17.462"> </span>
<a href="#l17.463"></a><span id="l17.463">         // Make sure this new parent folder obj has the correct subfolder list so far.</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineminus">-        rv = curProxy-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l17.465"></a><span id="l17.465" class="difflineplus">+        rv = ProxyGetSubFolders(subFolder, getter_AddRefs(enumerator));</span>
<a href="#l17.466"></a><span id="l17.466">       }</span>
<a href="#l17.467"></a><span id="l17.467">       else if (newDepth &lt; depth) {</span>
<a href="#l17.468"></a><span id="l17.468">         rv = NS_OK;</span>
<a href="#l17.469"></a><span id="l17.469">         while ((newDepth &lt; depth) &amp;&amp; NS_SUCCEEDED( rv)) {</span>
<a href="#l17.470"></a><span id="l17.470" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; parFolder;</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-          rv = curProxy-&gt;GetParent( getter_AddRefs( parFolder));</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineplus">+          rv = curFolder-&gt;GetParent(getter_AddRefs(curFolder));</span>
<a href="#l17.473"></a><span id="l17.473">           if (NS_FAILED( rv)) {</span>
<a href="#l17.474"></a><span id="l17.474">             IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the interface for parent folder '%s'.&quot;, lastName.get());</span>
<a href="#l17.475"></a><span id="l17.475">             nsImportGenericMail::ReportError(IMPORT_ERROR_MB_FINDCHILD,</span>
<a href="#l17.476"></a><span id="l17.476">                                              lastName.get(), &amp;error,</span>
<a href="#l17.477"></a><span id="l17.477">                                              pData-&gt;stringBundle);</span>
<a href="#l17.478"></a><span id="l17.478" class="difflineminus">-            pData-&gt;fatalError = PR_TRUE;</span>
<a href="#l17.479"></a><span id="l17.479" class="difflineplus">+            pData-&gt;fatalError = true;</span>
<a href="#l17.480"></a><span id="l17.480">             break;</span>
<a href="#l17.481"></a><span id="l17.481">           }</span>
<a href="#l17.482"></a><span id="l17.482" class="difflineminus">-</span>
<a href="#l17.483"></a><span id="l17.483" class="difflineminus">-          rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l17.484"></a><span id="l17.484" class="difflineminus">-                                              NS_GET_IID(nsIMsgFolder),</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineminus">-                                              parFolder,</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineminus">-                                              NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineminus">-                                              getter_AddRefs(curProxy));</span>
<a href="#l17.488"></a><span id="l17.488">           depth--;</span>
<a href="#l17.489"></a><span id="l17.489">         }</span>
<a href="#l17.490"></a><span id="l17.490">         if (NS_FAILED( rv)) {</span>
<a href="#l17.491"></a><span id="l17.491">           IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the proxy interface for parent folder '%s'.&quot;, lastName.get());</span>
<a href="#l17.492"></a><span id="l17.492">           nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOPROXY,</span>
<a href="#l17.493"></a><span id="l17.493">                                               pData-&gt;stringBundle, error);</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineminus">-          pData-&gt;fatalError = PR_TRUE;</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineplus">+          pData-&gt;fatalError = true;</span>
<a href="#l17.496"></a><span id="l17.496">           break;</span>
<a href="#l17.497"></a><span id="l17.497">         }</span>
<a href="#l17.498"></a><span id="l17.498">       }</span>
<a href="#l17.499"></a><span id="l17.499">       depth = newDepth;</span>
<a href="#l17.500"></a><span id="l17.500">       pName = nsnull;</span>
<a href="#l17.501"></a><span id="l17.501">       box-&gt;GetDisplayName( &amp;pName);</span>
<a href="#l17.502"></a><span id="l17.502">       if (pName) {</span>
<a href="#l17.503"></a><span id="l17.503">         lastName = pName;</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineat">@@ -867,34 +839,34 @@ ImportMailThread( void *stuff)</span>
<a href="#l17.505"></a><span id="l17.505">       else</span>
<a href="#l17.506"></a><span id="l17.506">         lastName.AssignLiteral(&quot;Unknown!&quot;);</span>
<a href="#l17.507"></a><span id="l17.507"> </span>
<a href="#l17.508"></a><span id="l17.508">       // translate the folder name if we are doing migration, but</span>
<a href="#l17.509"></a><span id="l17.509">       // only for special folders which are at the root level</span>
<a href="#l17.510"></a><span id="l17.510">       if (pData-&gt;performingMigration &amp;&amp; depth == 1)</span>
<a href="#l17.511"></a><span id="l17.511">         pData-&gt;mailImport-&gt;TranslateFolderName(lastName, lastName);</span>
<a href="#l17.512"></a><span id="l17.512"> </span>
<a href="#l17.513"></a><span id="l17.513" class="difflineminus">-      exists = PR_FALSE;</span>
<a href="#l17.514"></a><span id="l17.514" class="difflineminus">-      rv = curProxy-&gt;ContainsChildNamed( lastName, &amp;exists);</span>
<a href="#l17.515"></a><span id="l17.515" class="difflineplus">+      exists = false;</span>
<a href="#l17.516"></a><span id="l17.516" class="difflineplus">+      rv = ProxyContainsChildNamed(curFolder, lastName, &amp;exists);</span>
<a href="#l17.517"></a><span id="l17.517"> </span>
<a href="#l17.518"></a><span id="l17.518">       // If we are performing profile migration (as opposed to importing) then we are starting</span>
<a href="#l17.519"></a><span id="l17.519">       // with empty local folders. In that case, always choose to over-write the existing local folder</span>
<a href="#l17.520"></a><span id="l17.520">       // with this name. Don't create a unique subfolder name. Otherwise you end up with &quot;Inbox, Inbox0&quot;</span>
<a href="#l17.521"></a><span id="l17.521">       // or &quot;Unsent Folders, UnsentFolders0&quot;</span>
<a href="#l17.522"></a><span id="l17.522">       if (exists &amp;&amp; !pData-&gt;performingMigration) {</span>
<a href="#l17.523"></a><span id="l17.523">         nsString subName;</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-        curProxy-&gt;GenerateUniqueSubfolderName( lastName, nsnull, subName);</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineplus">+        ProxyGenerateUniqueSubfolderName(curFolder, lastName, nsnull, subName);</span>
<a href="#l17.526"></a><span id="l17.526">         if (!subName.IsEmpty())</span>
<a href="#l17.527"></a><span id="l17.527">           lastName.Assign(subName);</span>
<a href="#l17.528"></a><span id="l17.528">       }</span>
<a href="#l17.529"></a><span id="l17.529"> </span>
<a href="#l17.530"></a><span id="l17.530">       IMPORT_LOG1(&quot;ImportMailThread: Creating new import folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l17.531"></a><span id="l17.531" class="difflineminus">-      curProxy-&gt;CreateSubfolder( lastName, nsnull); // this may fail if the folder already exists..that's ok</span>
<a href="#l17.532"></a><span id="l17.532" class="difflineplus">+      ProxyCreateSubfolder(curFolder, lastName); // this may fail if the folder already exists..that's ok</span>
<a href="#l17.533"></a><span id="l17.533"> </span>
<a href="#l17.534"></a><span id="l17.534" class="difflineminus">-      rv = curProxy-&gt;GetChildNamed(lastName, getter_AddRefs(newFolder));</span>
<a href="#l17.535"></a><span id="l17.535" class="difflineplus">+      rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(newFolder));</span>
<a href="#l17.536"></a><span id="l17.536">       if (NS_SUCCEEDED(rv))</span>
<a href="#l17.537"></a><span id="l17.537">         newFolder-&gt;GetFilePath(getter_AddRefs(outBox));</span>
<a href="#l17.538"></a><span id="l17.538">       else</span>
<a href="#l17.539"></a><span id="l17.539">         IMPORT_LOG1(&quot;*** ImportMailThread: Failed to locate subfolder '%s' after it's been created.&quot;, lastName.get());</span>
<a href="#l17.540"></a><span id="l17.540"> </span>
<a href="#l17.541"></a><span id="l17.541">       if (NS_FAILED( rv)) {</span>
<a href="#l17.542"></a><span id="l17.542">         nsImportGenericMail::ReportError(IMPORT_ERROR_MB_CREATE, lastName.get(),</span>
<a href="#l17.543"></a><span id="l17.543">                                          &amp;error, pData-&gt;stringBundle);</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineat">@@ -915,37 +887,26 @@ ImportMailThread( void *stuff)</span>
<a href="#l17.545"></a><span id="l17.545">           NS_Free( pSuccess);</span>
<a href="#l17.546"></a><span id="l17.546">         }</span>
<a href="#l17.547"></a><span id="l17.547"> </span>
<a href="#l17.548"></a><span id="l17.548">         pData-&gt;currentSize = 0;</span>
<a href="#l17.549"></a><span id="l17.549">         pData-&gt;currentTotal += size;</span>
<a href="#l17.550"></a><span id="l17.550">         </span>
<a href="#l17.551"></a><span id="l17.551">         // commit to the db synchronously, but using a proxy since it doesn't like being used</span>
<a href="#l17.552"></a><span id="l17.552">         // elsewhere than from the main thread.</span>
<a href="#l17.553"></a><span id="l17.553" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; newFolderProxy;</span>
<a href="#l17.554"></a><span id="l17.554" class="difflineminus">-        rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l17.555"></a><span id="l17.555" class="difflineminus">-                                            NS_GET_IID(nsIMsgFolder),</span>
<a href="#l17.556"></a><span id="l17.556" class="difflineminus">-                                            newFolder,</span>
<a href="#l17.557"></a><span id="l17.557" class="difflineminus">-                                            NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l17.558"></a><span id="l17.558" class="difflineminus">-                                            getter_AddRefs(newFolderProxy));</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineminus">-</span>
<a href="#l17.560"></a><span id="l17.560" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; newFolderProxy) {</span>
<a href="#l17.561"></a><span id="l17.561" class="difflineminus">-          // OK, we've copied the actual folder/file over if the folder size is not 0</span>
<a href="#l17.562"></a><span id="l17.562" class="difflineminus">-          // (ie, the msg summary is no longer valid) so close the msg database so that</span>
<a href="#l17.563"></a><span id="l17.563" class="difflineminus">-          // when the folder is reopened the folder db can be reconstructed (which</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineminus">-          // validates msg summary and forces folder to be reparsed).</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineminus">-          newFolderProxy-&gt;ForceDBClosed();</span>
<a href="#l17.566"></a><span id="l17.566" class="difflineminus">-        }</span>
<a href="#l17.567"></a><span id="l17.567" class="difflineminus">-        else</span>
<a href="#l17.568"></a><span id="l17.568" class="difflineminus">-          // probably a fatal error if you can't commit the mailbox, right?</span>
<a href="#l17.569"></a><span id="l17.569" class="difflineminus">-          fatalError = PR_TRUE;</span>
<a href="#l17.570"></a><span id="l17.570" class="difflineplus">+        // OK, we've copied the actual folder/file over if the folder size is not 0</span>
<a href="#l17.571"></a><span id="l17.571" class="difflineplus">+        // (ie, the msg summary is no longer valid) so close the msg database so that</span>
<a href="#l17.572"></a><span id="l17.572" class="difflineplus">+        // when the folder is reopened the folder db can be reconstructed (which</span>
<a href="#l17.573"></a><span id="l17.573" class="difflineplus">+        // validates msg summary and forces folder to be reparsed).</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineplus">+        rv = ProxyForceDBClosed(newFolder);</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineplus">+        fatalError = NS_FAILED(rv);</span>
<a href="#l17.576"></a><span id="l17.576"> </span>
<a href="#l17.577"></a><span id="l17.577">         if (fatalError) {</span>
<a href="#l17.578"></a><span id="l17.578">           IMPORT_LOG1( &quot;*** ImportMailThread: ImportMailbox returned fatalError, mailbox #%d\n&quot;, (int) i);</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineminus">-          pData-&gt;fatalError = PR_TRUE;</span>
<a href="#l17.580"></a><span id="l17.580" class="difflineplus">+          pData-&gt;fatalError = true;</span>
<a href="#l17.581"></a><span id="l17.581">           break;</span>
<a href="#l17.582"></a><span id="l17.582">         }</span>
<a href="#l17.583"></a><span id="l17.583">       }</span>
<a href="#l17.584"></a><span id="l17.584">     }</span>
<a href="#l17.585"></a><span id="l17.585">   }</span>
<a href="#l17.586"></a><span id="l17.586"> </span>
<a href="#l17.587"></a><span id="l17.587">   // Now save the new acct info to pref file.</span>
<a href="#l17.588"></a><span id="l17.588">   nsCOMPtr &lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.589"></a><span id="l17.589" class="difflineat">@@ -955,17 +916,17 @@ ImportMailThread( void *stuff)</span>
<a href="#l17.590"></a><span id="l17.590">   }</span>
<a href="#l17.591"></a><span id="l17.591"> </span>
<a href="#l17.592"></a><span id="l17.592">   nsImportGenericMail::SetLogs( success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l17.593"></a><span id="l17.593"> </span>
<a href="#l17.594"></a><span id="l17.594">   if (pData-&gt;abort || pData-&gt;fatalError) {</span>
<a href="#l17.595"></a><span id="l17.595">     IMPORT_LOG0( &quot;*** ImportMailThread: Abort or fatalError flag was set\n&quot;);</span>
<a href="#l17.596"></a><span id="l17.596">     if (pData-&gt;ownsDestRoot) {</span>
<a href="#l17.597"></a><span id="l17.597">       IMPORT_LOG0( &quot;Calling destRoot-&gt;RecursiveDelete\n&quot;);</span>
<a href="#l17.598"></a><span id="l17.598" class="difflineminus">-      destRoot-&gt;RecursiveDelete( PR_TRUE, nsnull);</span>
<a href="#l17.599"></a><span id="l17.599" class="difflineplus">+      destRoot-&gt;RecursiveDelete( true, nsnull);</span>
<a href="#l17.600"></a><span id="l17.600">     }</span>
<a href="#l17.601"></a><span id="l17.601">     else {</span>
<a href="#l17.602"></a><span id="l17.602">       // FIXME: just delete the stuff we created?</span>
<a href="#l17.603"></a><span id="l17.603">     }</span>
<a href="#l17.604"></a><span id="l17.604">   }</span>
<a href="#l17.605"></a><span id="l17.605"> </span>
<a href="#l17.606"></a><span id="l17.606">   IMPORT_LOG1( &quot;Import mailbox thread done: %d\n&quot;, (int) pData-&gt;currentTotal);</span>
<a href="#l17.607"></a><span id="l17.607"> </span>
<a href="#l17.608"></a><span id="l17.608" class="difflineat">@@ -979,50 +940,50 @@ bool nsImportGenericMail::CreateFolder( </span>
<a href="#l17.609"></a><span id="l17.609"> {</span>
<a href="#l17.610"></a><span id="l17.610">   nsresult rv;</span>
<a href="#l17.611"></a><span id="l17.611">   *ppFolder = nsnull;</span>
<a href="#l17.612"></a><span id="l17.612"> </span>
<a href="#l17.613"></a><span id="l17.613">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l17.614"></a><span id="l17.614">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(</span>
<a href="#l17.615"></a><span id="l17.615">                                      NS_STRINGBUNDLE_CONTRACTID, &amp;rv));</span>
<a href="#l17.616"></a><span id="l17.616">   if (NS_FAILED(rv) || !bundleService)</span>
<a href="#l17.617"></a><span id="l17.617" class="difflineminus">-      return PR_FALSE;</span>
<a href="#l17.618"></a><span id="l17.618" class="difflineplus">+      return false;</span>
<a href="#l17.619"></a><span id="l17.619">   rv = bundleService-&gt;CreateBundle(IMPORT_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l17.620"></a><span id="l17.620">   if (NS_FAILED(rv))</span>
<a href="#l17.621"></a><span id="l17.621" class="difflineminus">-      return PR_FALSE;</span>
<a href="#l17.622"></a><span id="l17.622" class="difflineplus">+      return false;</span>
<a href="#l17.623"></a><span id="l17.623">   nsString folderName;</span>
<a href="#l17.624"></a><span id="l17.624">   if (!m_pName.IsEmpty()) {</span>
<a href="#l17.625"></a><span id="l17.625">     const PRUnichar *moduleName[] = { m_pName.get() };</span>
<a href="#l17.626"></a><span id="l17.626">     rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;ImportModuleFolderName&quot;).get(),</span>
<a href="#l17.627"></a><span id="l17.627">                                       moduleName, 1,</span>
<a href="#l17.628"></a><span id="l17.628">                                       getter_Copies(folderName));</span>
<a href="#l17.629"></a><span id="l17.629">   }</span>
<a href="#l17.630"></a><span id="l17.630">   else {</span>
<a href="#l17.631"></a><span id="l17.631">     rv = bundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;DefaultFolderName&quot;).get(),</span>
<a href="#l17.632"></a><span id="l17.632">                                    getter_Copies(folderName));</span>
<a href="#l17.633"></a><span id="l17.633">   }</span>
<a href="#l17.634"></a><span id="l17.634">   if (NS_FAILED(rv)) {</span>
<a href="#l17.635"></a><span id="l17.635">       IMPORT_LOG0( &quot;*** Failed to get Folder Name!\n&quot;);</span>
<a href="#l17.636"></a><span id="l17.636" class="difflineminus">-      return PR_FALSE;</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineplus">+      return false;</span>
<a href="#l17.638"></a><span id="l17.638">   }</span>
<a href="#l17.639"></a><span id="l17.639">   nsCOMPtr &lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.640"></a><span id="l17.640">   if (NS_FAILED(rv)) {</span>
<a href="#l17.641"></a><span id="l17.641">     IMPORT_LOG0( &quot;*** Failed to create account manager!\n&quot;);</span>
<a href="#l17.642"></a><span id="l17.642" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l17.643"></a><span id="l17.643" class="difflineplus">+    return false;</span>
<a href="#l17.644"></a><span id="l17.644">   }</span>
<a href="#l17.645"></a><span id="l17.645"> </span>
<a href="#l17.646"></a><span id="l17.646">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l17.647"></a><span id="l17.647">   rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l17.648"></a><span id="l17.648">   // if Local Folders does not exist already, create it</span>
<a href="#l17.649"></a><span id="l17.649">   if (NS_FAILED(rv) || !server)</span>
<a href="#l17.650"></a><span id="l17.650">   {</span>
<a href="#l17.651"></a><span id="l17.651">     rv = accMgr-&gt;CreateLocalMailAccount();</span>
<a href="#l17.652"></a><span id="l17.652">     if (NS_FAILED(rv)) {</span>
<a href="#l17.653"></a><span id="l17.653">       IMPORT_LOG0( &quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l17.654"></a><span id="l17.654" class="difflineminus">-      return PR_FALSE;</span>
<a href="#l17.655"></a><span id="l17.655" class="difflineplus">+      return false;</span>
<a href="#l17.656"></a><span id="l17.656">     }</span>
<a href="#l17.657"></a><span id="l17.657"> </span>
<a href="#l17.658"></a><span id="l17.658">     rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l17.659"></a><span id="l17.659">   }</span>
<a href="#l17.660"></a><span id="l17.660"> </span>
<a href="#l17.661"></a><span id="l17.661">   if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l17.662"></a><span id="l17.662">     nsCOMPtr &lt;nsIMsgFolder&gt; localRootFolder;</span>
<a href="#l17.663"></a><span id="l17.663">     rv = server-&gt;GetRootMsgFolder(getter_AddRefs(localRootFolder));</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineat">@@ -1037,31 +998,259 @@ bool nsImportGenericMail::CreateFolder( </span>
<a href="#l17.665"></a><span id="l17.665">         rv = localRootFolder-&gt;ContainsChildNamed(folderName, &amp;exists);</span>
<a href="#l17.666"></a><span id="l17.666">         if (exists) {</span>
<a href="#l17.667"></a><span id="l17.667">           nsString name;</span>
<a href="#l17.668"></a><span id="l17.668">           localRootFolder-&gt;GenerateUniqueSubfolderName(folderName, nsnull, name);</span>
<a href="#l17.669"></a><span id="l17.669">           if (!name.IsEmpty())</span>
<a href="#l17.670"></a><span id="l17.670">             folderName.Assign(name);</span>
<a href="#l17.671"></a><span id="l17.671">           else {</span>
<a href="#l17.672"></a><span id="l17.672">             IMPORT_LOG0( &quot;*** Failed to find a unique folder name!\n&quot;);</span>
<a href="#l17.673"></a><span id="l17.673" class="difflineminus">-            return PR_FALSE;</span>
<a href="#l17.674"></a><span id="l17.674" class="difflineplus">+            return false;</span>
<a href="#l17.675"></a><span id="l17.675">           }</span>
<a href="#l17.676"></a><span id="l17.676">         }</span>
<a href="#l17.677"></a><span id="l17.677">         IMPORT_LOG1( &quot;Creating folder for importing mail: '%s'\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l17.678"></a><span id="l17.678"> </span>
<a href="#l17.679"></a><span id="l17.679">         // Bug 564162 identifies a dataloss design flaw.</span>
<a href="#l17.680"></a><span id="l17.680">         // A working Thunderbird client can have mail in Local Folders and a</span>
<a href="#l17.681"></a><span id="l17.681">         // subsequent import 'Everything' will trigger a migration which</span>
<a href="#l17.682"></a><span id="l17.682">         // overwrites existing mailboxes with the imported mailboxes.</span>
<a href="#l17.683"></a><span id="l17.683">         rv = localRootFolder-&gt;CreateSubfolder(folderName, nsnull);</span>
<a href="#l17.684"></a><span id="l17.684">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.685"></a><span id="l17.685">           rv = localRootFolder-&gt;GetChildNamed(folderName, ppFolder);</span>
<a href="#l17.686"></a><span id="l17.686">           if (*ppFolder) {</span>
<a href="#l17.687"></a><span id="l17.687">             IMPORT_LOG1(&quot;Folder '%s' created successfully\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l17.688"></a><span id="l17.688" class="difflineminus">-            return PR_TRUE;</span>
<a href="#l17.689"></a><span id="l17.689" class="difflineplus">+            return true;</span>
<a href="#l17.690"></a><span id="l17.690">           }</span>
<a href="#l17.691"></a><span id="l17.691">         }</span>
<a href="#l17.692"></a><span id="l17.692">       }</span>
<a href="#l17.693"></a><span id="l17.693">     } // if localRootFolder</span>
<a href="#l17.694"></a><span id="l17.694">   } // if server</span>
<a href="#l17.695"></a><span id="l17.695">   IMPORT_LOG0(&quot;****** FAILED TO CREATE FOLDER FOR IMPORT\n&quot;);</span>
<a href="#l17.696"></a><span id="l17.696" class="difflineminus">-  return PR_FALSE;</span>
<a href="#l17.697"></a><span id="l17.697" class="difflineplus">+  return false;</span>
<a href="#l17.698"></a><span id="l17.698" class="difflineplus">+}</span>
<a href="#l17.699"></a><span id="l17.699" class="difflineplus">+</span>
<a href="#l17.700"></a><span id="l17.700" class="difflineplus">+/**</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineplus">+ * These are the proxy objects we use to proxy nsIMsgFolder methods back</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineplus">+ * the the main thread. Since there are only five, we can hand roll them.</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineplus">+ * A better design might be a co-routine-ish design where the ui thread</span>
<a href="#l17.704"></a><span id="l17.704" class="difflineplus">+ * hands off each folder to the import thread and when the thread finishes</span>
<a href="#l17.705"></a><span id="l17.705" class="difflineplus">+ * the folder, the main thread hands it the next folder.</span>
<a href="#l17.706"></a><span id="l17.706" class="difflineplus">+ */</span>
<a href="#l17.707"></a><span id="l17.707" class="difflineplus">+</span>
<a href="#l17.708"></a><span id="l17.708" class="difflineplus">+class GetSubFoldersRunnable : public nsRunnable</span>
<a href="#l17.709"></a><span id="l17.709" class="difflineplus">+{</span>
<a href="#l17.710"></a><span id="l17.710" class="difflineplus">+public:</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineplus">+  GetSubFoldersRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineplus">+                        nsISimpleEnumerator **aEnumerator);</span>
<a href="#l17.713"></a><span id="l17.713" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.714"></a><span id="l17.714" class="difflineplus">+private:</span>
<a href="#l17.715"></a><span id="l17.715" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.716"></a><span id="l17.716" class="difflineplus">+  nsISimpleEnumerator **m_enumerator;</span>
<a href="#l17.717"></a><span id="l17.717" class="difflineplus">+  nsresult m_status;</span>
<a href="#l17.718"></a><span id="l17.718" class="difflineplus">+};</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineplus">+</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineplus">+GetSubFoldersRunnable::GetSubFoldersRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l17.721"></a><span id="l17.721" class="difflineplus">+                                             nsISimpleEnumerator **aEnumerator) :</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineplus">+  m_folder(aFolder), m_enumerator(aEnumerator)</span>
<a href="#l17.723"></a><span id="l17.723" class="difflineplus">+{</span>
<a href="#l17.724"></a><span id="l17.724" class="difflineplus">+}</span>
<a href="#l17.725"></a><span id="l17.725" class="difflineplus">+</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineplus">+NS_IMETHODIMP GetSubFoldersRunnable::Run()</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineplus">+{</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineplus">+  return m_folder-&gt;GetSubFolders(m_enumerator);</span>
<a href="#l17.729"></a><span id="l17.729" class="difflineplus">+}</span>
<a href="#l17.730"></a><span id="l17.730" class="difflineplus">+</span>
<a href="#l17.731"></a><span id="l17.731" class="difflineplus">+</span>
<a href="#l17.732"></a><span id="l17.732" class="difflineplus">+nsresult ProxyGetSubFolders(nsIMsgFolder *aFolder, nsISimpleEnumerator **aEnumerator)</span>
<a href="#l17.733"></a><span id="l17.733" class="difflineplus">+{</span>
<a href="#l17.734"></a><span id="l17.734" class="difflineplus">+  nsRefPtr&lt;GetSubFoldersRunnable&gt; getSubFolders =</span>
<a href="#l17.735"></a><span id="l17.735" class="difflineplus">+    new GetSubFoldersRunnable(aFolder, aEnumerator);</span>
<a href="#l17.736"></a><span id="l17.736" class="difflineplus">+  return NS_DispatchToMainThread(getSubFolders, NS_DISPATCH_SYNC);</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineplus">+}</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineplus">+</span>
<a href="#l17.739"></a><span id="l17.739" class="difflineplus">+class GetChildNamedRunnable : public nsRunnable</span>
<a href="#l17.740"></a><span id="l17.740" class="difflineplus">+{</span>
<a href="#l17.741"></a><span id="l17.741" class="difflineplus">+public:</span>
<a href="#l17.742"></a><span id="l17.742" class="difflineplus">+  GetChildNamedRunnable(nsIMsgFolder *aFolder, const nsAString&amp; aName, nsIMsgFolder **aChild);</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineplus">+protected:</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineplus">+  nsString m_name;</span>
<a href="#l17.747"></a><span id="l17.747" class="difflineplus">+  nsIMsgFolder **m_child;</span>
<a href="#l17.748"></a><span id="l17.748" class="difflineplus">+};</span>
<a href="#l17.749"></a><span id="l17.749" class="difflineplus">+</span>
<a href="#l17.750"></a><span id="l17.750" class="difflineplus">+GetChildNamedRunnable::GetChildNamedRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l17.751"></a><span id="l17.751" class="difflineplus">+                                             const nsAString &amp; aName,</span>
<a href="#l17.752"></a><span id="l17.752" class="difflineplus">+                                             nsIMsgFolder **aChild) :</span>
<a href="#l17.753"></a><span id="l17.753" class="difflineplus">+  m_folder(aFolder), m_name(aName), m_child(aChild)</span>
<a href="#l17.754"></a><span id="l17.754" class="difflineplus">+{</span>
<a href="#l17.755"></a><span id="l17.755" class="difflineplus">+}</span>
<a href="#l17.756"></a><span id="l17.756" class="difflineplus">+</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineplus">+NS_IMETHODIMP GetChildNamedRunnable::Run()</span>
<a href="#l17.758"></a><span id="l17.758" class="difflineplus">+{</span>
<a href="#l17.759"></a><span id="l17.759" class="difflineplus">+  return m_folder-&gt;GetChildNamed(m_name, m_child);</span>
<a href="#l17.760"></a><span id="l17.760" class="difflineplus">+}</span>
<a href="#l17.761"></a><span id="l17.761" class="difflineplus">+</span>
<a href="#l17.762"></a><span id="l17.762" class="difflineplus">+</span>
<a href="#l17.763"></a><span id="l17.763" class="difflineplus">+nsresult ProxyGetChildNamed(nsIMsgFolder *aFolder, const nsAString &amp; aName,</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineplus">+                            nsIMsgFolder **aChild)</span>
<a href="#l17.765"></a><span id="l17.765" class="difflineplus">+{</span>
<a href="#l17.766"></a><span id="l17.766" class="difflineplus">+  nsRefPtr&lt;GetChildNamedRunnable&gt; getChildNamed =</span>
<a href="#l17.767"></a><span id="l17.767" class="difflineplus">+    new GetChildNamedRunnable(aFolder, aName, aChild);</span>
<a href="#l17.768"></a><span id="l17.768" class="difflineplus">+  return NS_DispatchToMainThread(getChildNamed, NS_DISPATCH_SYNC);</span>
<a href="#l17.769"></a><span id="l17.769" class="difflineplus">+}</span>
<a href="#l17.770"></a><span id="l17.770" class="difflineplus">+</span>
<a href="#l17.771"></a><span id="l17.771" class="difflineplus">+class GetParentRunnable : public nsRunnable</span>
<a href="#l17.772"></a><span id="l17.772" class="difflineplus">+{</span>
<a href="#l17.773"></a><span id="l17.773" class="difflineplus">+public:</span>
<a href="#l17.774"></a><span id="l17.774" class="difflineplus">+  GetParentRunnable(nsIMsgFolder *aFolder, nsIMsgFolder **aParent);</span>
<a href="#l17.775"></a><span id="l17.775" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineplus">+protected:</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.778"></a><span id="l17.778" class="difflineplus">+  nsIMsgFolder **m_parent;</span>
<a href="#l17.779"></a><span id="l17.779" class="difflineplus">+};</span>
<a href="#l17.780"></a><span id="l17.780" class="difflineplus">+</span>
<a href="#l17.781"></a><span id="l17.781" class="difflineplus">+GetParentRunnable::GetParentRunnable(nsIMsgFolder *aFolder, nsIMsgFolder **aParent) :</span>
<a href="#l17.782"></a><span id="l17.782" class="difflineplus">+  m_folder(aFolder), m_parent(aParent)</span>
<a href="#l17.783"></a><span id="l17.783" class="difflineplus">+{</span>
<a href="#l17.784"></a><span id="l17.784" class="difflineplus">+}</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineplus">+</span>
<a href="#l17.786"></a><span id="l17.786" class="difflineplus">+NS_IMETHODIMP GetParentRunnable::Run()</span>
<a href="#l17.787"></a><span id="l17.787" class="difflineplus">+{</span>
<a href="#l17.788"></a><span id="l17.788" class="difflineplus">+  return m_folder-&gt;GetParent(m_parent);</span>
<a href="#l17.789"></a><span id="l17.789" class="difflineplus">+}</span>
<a href="#l17.790"></a><span id="l17.790" class="difflineplus">+</span>
<a href="#l17.791"></a><span id="l17.791" class="difflineplus">+</span>
<a href="#l17.792"></a><span id="l17.792" class="difflineplus">+nsresult ProxyGetParent(nsIMsgFolder *aFolder, nsIMsgFolder **aParent)</span>
<a href="#l17.793"></a><span id="l17.793" class="difflineplus">+{</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineplus">+  nsRefPtr&lt;GetParentRunnable&gt; getParent =</span>
<a href="#l17.795"></a><span id="l17.795" class="difflineplus">+    new GetParentRunnable(aFolder, aParent);</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineplus">+  return NS_DispatchToMainThread(getParent, NS_DISPATCH_SYNC);</span>
<a href="#l17.797"></a><span id="l17.797"> }</span>
<a href="#l17.798"></a><span id="l17.798" class="difflineplus">+</span>
<a href="#l17.799"></a><span id="l17.799" class="difflineplus">+class ContainsChildNamedRunnable : public nsRunnable</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineplus">+{</span>
<a href="#l17.801"></a><span id="l17.801" class="difflineplus">+public:</span>
<a href="#l17.802"></a><span id="l17.802" class="difflineplus">+  ContainsChildNamedRunnable(nsIMsgFolder *aFolder, const nsAString&amp; aName, bool *aResult);</span>
<a href="#l17.803"></a><span id="l17.803" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.804"></a><span id="l17.804" class="difflineplus">+protected:</span>
<a href="#l17.805"></a><span id="l17.805" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineplus">+  nsString m_name;</span>
<a href="#l17.807"></a><span id="l17.807" class="difflineplus">+  bool *m_result;</span>
<a href="#l17.808"></a><span id="l17.808" class="difflineplus">+};</span>
<a href="#l17.809"></a><span id="l17.809" class="difflineplus">+</span>
<a href="#l17.810"></a><span id="l17.810" class="difflineplus">+ContainsChildNamedRunnable::ContainsChildNamedRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l17.811"></a><span id="l17.811" class="difflineplus">+                                                       const nsAString &amp;aName,</span>
<a href="#l17.812"></a><span id="l17.812" class="difflineplus">+                                                       bool *aResult) :</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineplus">+  m_folder(aFolder), m_name(aName), m_result(aResult)</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineplus">+{</span>
<a href="#l17.815"></a><span id="l17.815" class="difflineplus">+}</span>
<a href="#l17.816"></a><span id="l17.816" class="difflineplus">+</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineplus">+NS_IMETHODIMP ContainsChildNamedRunnable::Run()</span>
<a href="#l17.818"></a><span id="l17.818" class="difflineplus">+{</span>
<a href="#l17.819"></a><span id="l17.819" class="difflineplus">+  return m_folder-&gt;ContainsChildNamed(m_name, m_result);</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineplus">+}</span>
<a href="#l17.821"></a><span id="l17.821" class="difflineplus">+</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineplus">+</span>
<a href="#l17.823"></a><span id="l17.823" class="difflineplus">+nsresult ProxyContainsChildNamed(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l17.824"></a><span id="l17.824" class="difflineplus">+                                 bool *aResult)</span>
<a href="#l17.825"></a><span id="l17.825" class="difflineplus">+{</span>
<a href="#l17.826"></a><span id="l17.826" class="difflineplus">+  nsRefPtr&lt;ContainsChildNamedRunnable&gt; containsChildNamed =</span>
<a href="#l17.827"></a><span id="l17.827" class="difflineplus">+    new ContainsChildNamedRunnable(aFolder, aName, aResult);</span>
<a href="#l17.828"></a><span id="l17.828" class="difflineplus">+  return NS_DispatchToMainThread(containsChildNamed, NS_DISPATCH_SYNC);</span>
<a href="#l17.829"></a><span id="l17.829" class="difflineplus">+}</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineplus">+</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineplus">+</span>
<a href="#l17.832"></a><span id="l17.832" class="difflineplus">+class GenerateUniqueSubfolderNameRunnable : public nsRunnable</span>
<a href="#l17.833"></a><span id="l17.833" class="difflineplus">+{</span>
<a href="#l17.834"></a><span id="l17.834" class="difflineplus">+public:</span>
<a href="#l17.835"></a><span id="l17.835" class="difflineplus">+  GenerateUniqueSubfolderNameRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineplus">+                                      const nsAString&amp; prefix,</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineplus">+                                      nsIMsgFolder *otherFolder,</span>
<a href="#l17.838"></a><span id="l17.838" class="difflineplus">+                                      nsAString&amp; name);</span>
<a href="#l17.839"></a><span id="l17.839" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.840"></a><span id="l17.840" class="difflineplus">+protected:</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineplus">+  nsString m_prefix;</span>
<a href="#l17.843"></a><span id="l17.843" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_otherFolder;</span>
<a href="#l17.844"></a><span id="l17.844" class="difflineplus">+  nsString m_name;</span>
<a href="#l17.845"></a><span id="l17.845" class="difflineplus">+};</span>
<a href="#l17.846"></a><span id="l17.846" class="difflineplus">+</span>
<a href="#l17.847"></a><span id="l17.847" class="difflineplus">+GenerateUniqueSubfolderNameRunnable::GenerateUniqueSubfolderNameRunnable(</span>
<a href="#l17.848"></a><span id="l17.848" class="difflineplus">+  nsIMsgFolder *aFolder, const nsAString&amp; aPrefix, nsIMsgFolder *aOtherFolder,</span>
<a href="#l17.849"></a><span id="l17.849" class="difflineplus">+  nsAString&amp; aName)</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineplus">+  : m_folder(aFolder), m_prefix(aPrefix), m_otherFolder(aOtherFolder), m_name(aName)</span>
<a href="#l17.851"></a><span id="l17.851" class="difflineplus">+{</span>
<a href="#l17.852"></a><span id="l17.852" class="difflineplus">+}</span>
<a href="#l17.853"></a><span id="l17.853" class="difflineplus">+</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineplus">+NS_IMETHODIMP GenerateUniqueSubfolderNameRunnable::Run()</span>
<a href="#l17.855"></a><span id="l17.855" class="difflineplus">+{</span>
<a href="#l17.856"></a><span id="l17.856" class="difflineplus">+  return m_folder-&gt;GenerateUniqueSubfolderName(m_prefix, m_otherFolder, m_name);</span>
<a href="#l17.857"></a><span id="l17.857" class="difflineplus">+}</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineplus">+</span>
<a href="#l17.859"></a><span id="l17.859" class="difflineplus">+</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineplus">+nsresult ProxyGenerateUniqueSubfolderName(nsIMsgFolder *aFolder,</span>
<a href="#l17.861"></a><span id="l17.861" class="difflineplus">+                                          const nsAString&amp; aPrefix,</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineplus">+                                          nsIMsgFolder *aOtherFolder,</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineplus">+                                          nsAString&amp; aName)</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineplus">+</span>
<a href="#l17.865"></a><span id="l17.865" class="difflineplus">+{</span>
<a href="#l17.866"></a><span id="l17.866" class="difflineplus">+  nsRefPtr&lt;GenerateUniqueSubfolderNameRunnable&gt; generateUniqueSubfolderName =</span>
<a href="#l17.867"></a><span id="l17.867" class="difflineplus">+    new GenerateUniqueSubfolderNameRunnable(aFolder, aPrefix, aOtherFolder, aName);</span>
<a href="#l17.868"></a><span id="l17.868" class="difflineplus">+  return NS_DispatchToMainThread(generateUniqueSubfolderName, NS_DISPATCH_SYNC);</span>
<a href="#l17.869"></a><span id="l17.869" class="difflineplus">+}</span>
<a href="#l17.870"></a><span id="l17.870" class="difflineplus">+</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineplus">+class CreateSubfolderRunnable : public nsRunnable</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineplus">+{</span>
<a href="#l17.873"></a><span id="l17.873" class="difflineplus">+public:</span>
<a href="#l17.874"></a><span id="l17.874" class="difflineplus">+  CreateSubfolderRunnable(nsIMsgFolder *aFolder, const nsAString&amp; aName);</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.876"></a><span id="l17.876" class="difflineplus">+protected:</span>
<a href="#l17.877"></a><span id="l17.877" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.878"></a><span id="l17.878" class="difflineplus">+  nsString m_name;</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineplus">+};</span>
<a href="#l17.880"></a><span id="l17.880" class="difflineplus">+</span>
<a href="#l17.881"></a><span id="l17.881" class="difflineplus">+CreateSubfolderRunnable::CreateSubfolderRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l17.882"></a><span id="l17.882" class="difflineplus">+                                                 const nsAString &amp;aName) :</span>
<a href="#l17.883"></a><span id="l17.883" class="difflineplus">+  m_folder(aFolder), m_name(aName)</span>
<a href="#l17.884"></a><span id="l17.884" class="difflineplus">+{</span>
<a href="#l17.885"></a><span id="l17.885" class="difflineplus">+}</span>
<a href="#l17.886"></a><span id="l17.886" class="difflineplus">+</span>
<a href="#l17.887"></a><span id="l17.887" class="difflineplus">+NS_IMETHODIMP CreateSubfolderRunnable::Run()</span>
<a href="#l17.888"></a><span id="l17.888" class="difflineplus">+{</span>
<a href="#l17.889"></a><span id="l17.889" class="difflineplus">+  return m_folder-&gt;CreateSubfolder(m_name, nsnull);</span>
<a href="#l17.890"></a><span id="l17.890" class="difflineplus">+}</span>
<a href="#l17.891"></a><span id="l17.891" class="difflineplus">+</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineplus">+</span>
<a href="#l17.893"></a><span id="l17.893" class="difflineplus">+nsresult ProxyCreateSubfolder(nsIMsgFolder *aFolder, const nsAString &amp;aName)</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineplus">+{</span>
<a href="#l17.895"></a><span id="l17.895" class="difflineplus">+  nsRefPtr&lt;CreateSubfolderRunnable&gt; createSubfolder =</span>
<a href="#l17.896"></a><span id="l17.896" class="difflineplus">+    new CreateSubfolderRunnable(aFolder, aName);</span>
<a href="#l17.897"></a><span id="l17.897" class="difflineplus">+  return NS_DispatchToMainThread(createSubfolder, NS_DISPATCH_SYNC);</span>
<a href="#l17.898"></a><span id="l17.898" class="difflineplus">+}</span>
<a href="#l17.899"></a><span id="l17.899" class="difflineplus">+</span>
<a href="#l17.900"></a><span id="l17.900" class="difflineplus">+class ForceDBClosedRunnable : public nsRunnable</span>
<a href="#l17.901"></a><span id="l17.901" class="difflineplus">+{</span>
<a href="#l17.902"></a><span id="l17.902" class="difflineplus">+public:</span>
<a href="#l17.903"></a><span id="l17.903" class="difflineplus">+  ForceDBClosedRunnable(nsIMsgFolder *aFolder);</span>
<a href="#l17.904"></a><span id="l17.904" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l17.905"></a><span id="l17.905" class="difflineplus">+protected:</span>
<a href="#l17.906"></a><span id="l17.906" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l17.907"></a><span id="l17.907" class="difflineplus">+};</span>
<a href="#l17.908"></a><span id="l17.908" class="difflineplus">+</span>
<a href="#l17.909"></a><span id="l17.909" class="difflineplus">+ForceDBClosedRunnable::ForceDBClosedRunnable(nsIMsgFolder *aFolder) :</span>
<a href="#l17.910"></a><span id="l17.910" class="difflineplus">+  m_folder(aFolder)</span>
<a href="#l17.911"></a><span id="l17.911" class="difflineplus">+{</span>
<a href="#l17.912"></a><span id="l17.912" class="difflineplus">+}</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineplus">+</span>
<a href="#l17.914"></a><span id="l17.914" class="difflineplus">+NS_IMETHODIMP ForceDBClosedRunnable::Run()</span>
<a href="#l17.915"></a><span id="l17.915" class="difflineplus">+{</span>
<a href="#l17.916"></a><span id="l17.916" class="difflineplus">+  return m_folder-&gt;ForceDBClosed();</span>
<a href="#l17.917"></a><span id="l17.917" class="difflineplus">+}</span>
<a href="#l17.918"></a><span id="l17.918" class="difflineplus">+</span>
<a href="#l17.919"></a><span id="l17.919" class="difflineplus">+nsresult ProxyForceDBClosed(nsIMsgFolder *aFolder)</span>
<a href="#l17.920"></a><span id="l17.920" class="difflineplus">+{</span>
<a href="#l17.921"></a><span id="l17.921" class="difflineplus">+  nsRefPtr&lt;ForceDBClosedRunnable&gt; forceDBClosed =</span>
<a href="#l17.922"></a><span id="l17.922" class="difflineplus">+    new ForceDBClosedRunnable(aFolder);</span>
<a href="#l17.923"></a><span id="l17.923" class="difflineplus">+  return NS_DispatchToMainThread(forceDBClosed, NS_DISPATCH_SYNC);</span>
<a href="#l17.924"></a><span id="l17.924" class="difflineplus">+}</span>
<a href="#l17.925"></a><span id="l17.925" class="difflineplus">+</span>
<a href="#l17.926"></a><span id="l17.926" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -35,17 +35,16 @@</span>
<a href="#l18.4"></a><span id="l18.4">  *</span>
<a href="#l18.5"></a><span id="l18.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;prprf.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;prmem.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> #include &quot;nsIURI.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> nsresult nsImportStringBundle::GetStringBundle(const char *aPropertyURL,</span>
<a href="#l18.18"></a><span id="l18.18">                                                nsIStringBundle **aBundle)</span>
<a href="#l18.19"></a><span id="l18.19"> {</span>
<a href="#l18.20"></a><span id="l18.20">   nsresult rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -64,19 +64,17 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIMsgAttachment.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIMsgComposeParams.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-#include &quot;nsProxiedService.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16"> #include &quot;nsIDirectoryService.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18"> #include &quot;msgMapi.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19"> #include &quot;msgMapiHook.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20"> #include &quot;msgMapiSupport.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21"> #include &quot;msgMapiMain.h&quot;</span>
<a href="#l19.22"></a><span id="l19.22"> #include &quot;nsThreadUtils.h&quot;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

