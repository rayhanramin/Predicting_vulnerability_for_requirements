<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10337:e3698c85b250af30bb52bc5c28a262bc069d9b81</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e3698c85b250af30bb52bc5c28a262bc069d9b81" />
<meta property="og:url" content="/comm-central/rev/e3698c85b250af30bb52bc5c28a262bc069d9b81" />
<meta property="og:description" content="Bug 750292 - Fix/renovate feed opml import/export r=bienvenu,ui-r=bwinton." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e3698c85b250af30bb52bc5c28a262bc069d9b81 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e3698c85b250af30bb52bc5c28a262bc069d9b81">shortlog</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e3698c85b250af30bb52bc5c28a262bc069d9b81">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81">files</a> |
changeset |
<a href="/comm-central/raw-rev/e3698c85b250af30bb52bc5c28a262bc069d9b81">raw</a>  | <a href="/comm-central/archive/e3698c85b250af30bb52bc5c28a262bc069d9b81.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=750292">Bug 750292</a> - Fix/renovate feed opml import/export r=bienvenu,ui-r=bwinton.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#32;&#60;&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 01 Jun 2012 12:12:31 -0600</td></tr>

<tr>
 <td>changeset 10337</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e3698c85b250af30bb52bc5c28a262bc069d9b81">e3698c85b250af30bb52bc5c28a262bc069d9b81</a></td>
</tr>



<tr>
<td>parent 10336</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9bff4e70af5a0f0c883185c302a71004880bfa3d">9bff4e70af5a0f0c883185c302a71004880bfa3d</a>
</td>
</tr>

<tr>
<td>child 10338</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/490b4c844b347df78a332104fc1ea771ab026e66">490b4c844b347df78a332104fc1ea771ab026e66</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e3698c85b250af30bb52bc5c28a262bc069d9b81">7829</a></td></tr>
<tr><td>push user</td><td>mconley@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 02 Jun 2012 18:48:00 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7ee39bdf99ae [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ee39bdf99ae54150a9343ad9ee68f0c727a4b3f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ee39bdf99ae54150a9343ad9ee68f0c727a4b3f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ee39bdf99ae54150a9343ad9ee68f0c727a4b3f&newProject=comm-central&newRevision=e3698c85b250af30bb52bc5c28a262bc069d9b81&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ee39bdf99ae54150a9343ad9ee68f0c727a4b3f&newProject=comm-central&newRevision=e3698c85b250af30bb52bc5c28a262bc069d9b81&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ee39bdf99ae54150a9343ad9ee68f0c727a4b3f&newProject=comm-central&newRevision=e3698c85b250af30bb52bc5c28a262bc069d9b81&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=750292">750292</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=750292">Bug 750292</a> - Fix/renovate feed opml import/export r=bienvenu,ui-r=bwinton.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd">mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties">mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger/importDialog.dtd">mail/locales/en-US/chrome/messenger/importDialog.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger/importDialog.dtd">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger/importDialog.dtd">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger/importDialog.dtd">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger/importDialog.dtd">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/locales/en-US/chrome/messenger/importDialog.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css">mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css">mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/qute/mail/newsblog/feed-subscriptions.css">mail/themes/qute/mail/newsblog/feed-subscriptions.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/qute/mail/newsblog/feed-subscriptions.css">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/qute/mail/newsblog/feed-subscriptions.css">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/qute/mail/newsblog/feed-subscriptions.css">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/qute/mail/newsblog/feed-subscriptions.css">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mail/themes/qute/mail/newsblog/feed-subscriptions.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/FeedItem.js">mailnews/extensions/newsblog/content/FeedItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/FeedItem.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/FeedItem.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/FeedItem.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/FeedItem.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/FeedItem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.xul">mailnews/extensions/newsblog/content/feed-subscriptions.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.xul">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.xul">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.xul">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.xul">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/feed-subscriptions.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/newsblogOverlay.js">mailnews/extensions/newsblog/content/newsblogOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/newsblogOverlay.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/newsblogOverlay.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/newsblogOverlay.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/newsblogOverlay.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/newsblogOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/utils.js">mailnews/extensions/newsblog/content/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/utils.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/utils.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/utils.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/utils.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/content/utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.js">mailnews/import/content/importDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.xul">mailnews/import/content/importDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.xul">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.xul">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.xul">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.xul">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/import/content/importDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/importDialog.dtd">suite/locales/en-US/chrome/mailnews/importDialog.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/importDialog.dtd">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/importDialog.dtd">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/importDialog.dtd">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/importDialog.dtd">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/importDialog.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd">suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties">suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties">file</a> |
<a href="/comm-central/annotate/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties">annotate</a> |
<a href="/comm-central/diff/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties">diff</a> |
<a href="/comm-central/comparison/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties">comparison</a> |
<a href="/comm-central/log/e3698c85b250af30bb52bc5c28a262bc069d9b81/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger-newsblog/feed-subscriptions.dtd</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -27,10 +27,11 @@</span>
<a href="#l1.4"></a><span id="l1.4"> &lt;!ENTITY button.editFeed.label       &quot;Update&quot;&gt;</span>
<a href="#l1.5"></a><span id="l1.5"> &lt;!ENTITY button.editFeed.accesskey   &quot;U&quot;&gt;</span>
<a href="#l1.6"></a><span id="l1.6"> &lt;!ENTITY button.removeFeed.label     &quot;Remove&quot;&gt;</span>
<a href="#l1.7"></a><span id="l1.7"> &lt;!ENTITY button.removeFeed.accesskey &quot;R&quot;&gt;</span>
<a href="#l1.8"></a><span id="l1.8"> &lt;!ENTITY button.importOPML.label     &quot;Import&quot;&gt;</span>
<a href="#l1.9"></a><span id="l1.9"> &lt;!ENTITY button.importOPML.accesskey &quot;I&quot;&gt;</span>
<a href="#l1.10"></a><span id="l1.10"> &lt;!ENTITY button.exportOPML.label     &quot;Export&quot;&gt;</span>
<a href="#l1.11"></a><span id="l1.11"> &lt;!ENTITY button.exportOPML.accesskey &quot;X&quot;&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+&lt;!ENTITY button.exportOPML.tooltip   &quot;Export Feeds with folder structure; ctrl click or ctrl enter to export Feeds as a list&quot;&gt;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> &lt;!ENTITY cmd.close.commandKey        &quot;w&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger-newsblog/newsblog.properties</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -12,21 +12,29 @@ subscribe-feedUpdated=Feed updated.</span>
<a href="#l2.4"></a><span id="l2.4"> subscribe-feedMoved=Feed subscription moved.</span>
<a href="#l2.5"></a><span id="l2.5"> subscribe-feedCopied=Feed subscription copied.</span>
<a href="#l2.6"></a><span id="l2.6"> subscribe-feedRemoved=Feed unsubscribed.</span>
<a href="#l2.7"></a><span id="l2.7"> subscribe-feedNotValid=The Feed URL is not a valid feed.</span>
<a href="#l2.8"></a><span id="l2.8"> subscribe-networkError=The Feed URL could not be found. Please check the name and try again.</span>
<a href="#l2.9"></a><span id="l2.9"> subscribe-loading=Loading, please wait…</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> subscribe-OPMLImportTitle=Select OPML file to import</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-subscribe-OPMLExportTitle=Export feeds as an OPML file</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-## LOCALIZATION NOTE(subscribe-OPMLExportFileDialogTitle): %S is the brandShortName</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-subscribe-OPMLExportFileDialogTitle=%S OPML Export</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-## LOCALIZATION NOTE(subscribe-OPMLExportDefaultFileName): %S is the brandShortName</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-subscribe-OPMLExportDefaultFileName=My%SFeeds.opml</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportTitleList):</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+## %S is the name of the feed account folder name.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+subscribe-OPMLExportTitleList=Export %S as an OPML file - Feeds list</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportTitleStruct):</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+## %S is the name of the feed account folder name.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+subscribe-OPMLExportTitleStruct=Export %S as an OPML file - Feeds with folder structure</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportFileDialogTitle):</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+## %1$S is the brandShortName, %2$S is the name of the feed account folder name.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+subscribe-OPMLExportFileDialogTitle=%1$S OPML Export - %2$S</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportDefaultFileName):</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+## %1$S is the brandShortName (Thunderbird for example), %2$S is the account name.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+## The default extension (.opml) is added here as it is not automatically appended in the file picker on MacOS.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+subscribe-OPMLExportDefaultFileName=My%1$SFeeds-%2$S.opml</span>
<a href="#l2.30"></a><span id="l2.30"> ## LOCALIZATION NOTE(subscribe-OPMLImportInvalidFile): %S is the name of the OPML file the user tried to import.</span>
<a href="#l2.31"></a><span id="l2.31"> subscribe-OPMLImportInvalidFile=The file %S does not seem to be a valid OPML file.</span>
<a href="#l2.32"></a><span id="l2.32"> ## LOCALIZATION NOTE(subscribe-OPMLImportFeedCount): Semi-colon list of plural forms.</span>
<a href="#l2.33"></a><span id="l2.33"> ## See: http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l2.34"></a><span id="l2.34"> ## #1 is the count of new imported entries.</span>
<a href="#l2.35"></a><span id="l2.35"> subscribe-OPMLImportFeedCount=Imported #1 new feed.;Imported #1 new feeds.</span>
<a href="#l2.36"></a><span id="l2.36"> ## LOCALIZATION NOTE(subscribe-OPMLImportUniqueFeeds): Semi-colon list of plural forms.</span>
<a href="#l2.37"></a><span id="l2.37"> ## #1 is the count of new imported entries</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineat">@@ -36,16 +44,18 @@ subscribe-OPMLImportUniqueFeeds=Imported</span>
<a href="#l2.39"></a><span id="l2.39"> subscribe-OPMLImportFoundFeeds=(out of #1 entry found);(out of #1 total entries found)</span>
<a href="#l2.40"></a><span id="l2.40"> ## LOCALIZATION NOTE(subscribe-OPMLImportStatus):</span>
<a href="#l2.41"></a><span id="l2.41"> ## This is the concatenation of the two strings defined above to compose 1 sentence.</span>
<a href="#l2.42"></a><span id="l2.42"> ## %1$S = subscribe-OPMLImportUniqueFeeds</span>
<a href="#l2.43"></a><span id="l2.43"> ## %2$S = subscribe-OPMLImportFoundFeeds</span>
<a href="#l2.44"></a><span id="l2.44"> subscribe-OPMLImportStatus=%1$S %2$S.</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46"> subscribe-OPMLExportOPMLFilesFilterText=OPML Files</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportDone): %S is the export file name.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+subscribe-OPMLExportDone=Feeds in this account have been exported to %S.</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50"> subscribe-confirmFeedDeletionTitle=Remove Feed</span>
<a href="#l2.51"></a><span id="l2.51"> ## LOCALIZATION NOTE(subscribe-confirmFeedDeletion): %S is the name of the feed the user wants to unsubscribe from.</span>
<a href="#l2.52"></a><span id="l2.52"> subscribe-confirmFeedDeletion=Are you sure you want to unsubscribe from the feed: \n %S?</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54"> ## LOCALIZATION NOTE(subscribe-gettingFeedItems):</span>
<a href="#l2.55"></a><span id="l2.55"> ##  - The first %S is the number of articles processed so far;</span>
<a href="#l2.56"></a><span id="l2.56"> ##  - The second %S is the total number of items</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineat">@@ -55,8 +65,20 @@ newsblog-noNewArticlesForFeed=There are </span>
<a href="#l2.58"></a><span id="l2.58"> ## LOCALIZATION NOTE(newsblog-networkError): %S is the feed URL</span>
<a href="#l2.59"></a><span id="l2.59"> newsblog-networkError=%S could not be found. Please check the name and try again.</span>
<a href="#l2.60"></a><span id="l2.60"> ## LOCALIZATION NOTE(newsblog-feedNotValid): %S is the feed URL</span>
<a href="#l2.61"></a><span id="l2.61"> newsblog-feedNotValid=%S is not a valid feed.</span>
<a href="#l2.62"></a><span id="l2.62"> newsblog-getNewMsgsCheck=Checking feeds for new items…</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64"> ## LOCALIZATION NOTE(feeds-accountname): This string should be the same as feeds.accountName in am-newsblog.dtd</span>
<a href="#l2.65"></a><span id="l2.65"> feeds-accountname=Blogs &amp; News Feeds</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+## Import wizard.</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+ImportFeedsCreateNewListItem=* New Account *</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+ImportFeedsNewAccount=Create and import into a new Feeds account</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+ImportFeedsExistingAccount=Import into an existing Feeds account</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+## LOCALIZATION NOTE(ImportFeedsDone):</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+##  - The first %S is the import file name;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+##  - The second %S is the value of either ImportFeedsNew or ImportFeedsExisting;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+##  - The third %S is the feed account name.</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+ImportFeedsNew=new</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+ImportFeedsExisting=existing</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+ImportFeedsDone=The feed subscriptions import from file %1$S into %2$S account '%3$S' has finished.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/importDialog.dtd</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/importDialog.dtd</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -10,34 +10,39 @@ LOCALIZATION NOTE : Do not translate any</span>
<a href="#l3.4"></a><span id="l3.4"> &quot;&amp;brandShortName;&quot; below.</span>
<a href="#l3.5"></a><span id="l3.5"> --&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> &lt;!ENTITY importDialog.windowTitle &quot;Import&quot;&gt;</span>
<a href="#l3.8"></a><span id="l3.8"> &lt;!ENTITY importAll.label          &quot;Import Everything&quot;&gt;</span>
<a href="#l3.9"></a><span id="l3.9"> &lt;!ENTITY importAll.accesskey      &quot;E&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> &lt;!ENTITY importMail.label         &quot;Mail&quot;&gt;</span>
<a href="#l3.11"></a><span id="l3.11"> &lt;!ENTITY importMail.accesskey     &quot;M&quot;&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+&lt;!ENTITY importFeeds.label        &quot;Feed Subscriptions&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+&lt;!ENTITY importFeeds.accesskey    &quot;d&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14"> &lt;!ENTITY importAddressbook.label  &quot;Address Books&quot;&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> &lt;!ENTITY importAddressbook.accesskey &quot;A&quot;&gt;</span>
<a href="#l3.16"></a><span id="l3.16"> &lt;!ENTITY importSettings.label     &quot;Settings&quot;&gt;</span>
<a href="#l3.17"></a><span id="l3.17"> &lt;!ENTITY importSettings.accesskey &quot;S&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18"> &lt;!ENTITY importFilters.label      &quot;Filters&quot;&gt;</span>
<a href="#l3.19"></a><span id="l3.19"> &lt;!ENTITY importFilters.accesskey  &quot;F&quot;&gt;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> &lt;!ENTITY  window.width            &quot;40em&quot;&gt;</span>
<a href="#l3.22"></a><span id="l3.22"> &lt;!ENTITY  window.macWidth         &quot;45em&quot;&gt;</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24"> &lt;!ENTITY importTitle.label        &quot;&amp;brandShortName; Import Wizard&quot;&gt;</span>
<a href="#l3.25"></a><span id="l3.25"> &lt;!ENTITY importShortDesc.label    &quot;Import Mail, Address Books, Settings, and Filters from other programs&quot;&gt;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-&lt;!ENTITY importDescription1.label &quot;This wizard will import mail messages, address book entries, preferences, and/or filters from other mail programs and common address book formats into &amp;brandShortName;.&quot;&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+&lt;!ENTITY importDescription1.label &quot;This wizard will import mail messages, address book entries, feed subscriptions, preferences, and/or filters from other mail programs and common address book formats into &amp;brandShortName;.&quot;&gt;</span>
<a href="#l3.29"></a><span id="l3.29"> &lt;!ENTITY importDescription2.label &quot;Once they have been imported, you will be able to access them from within &amp;brandShortName;.&quot;&gt;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31"> &lt;!ENTITY selectDescription.label  &quot;Please select the type of file that you would like to import:&quot;&gt;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+&lt;!ENTITY selectDescriptionB.label &quot;Please select an existing account or create a new account:&quot;&gt;</span>
<a href="#l3.33"></a><span id="l3.33"> &lt;!ENTITY selectDescription.accesskey &quot;P&quot;&gt;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+&lt;!ENTITY acctName.label           &quot;Name:&quot;&gt;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+&lt;!ENTITY acctName.accesskey       &quot;N&quot;&gt;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> &lt;!ENTITY back.label               &quot;&amp;lt; Back&quot;&gt;</span>
<a href="#l3.38"></a><span id="l3.38"> &lt;!ENTITY forward.label            &quot;Next &amp;gt;&quot;&gt;</span>
<a href="#l3.39"></a><span id="l3.39"> &lt;!ENTITY finish.label             &quot;Finish&quot;&gt;</span>
<a href="#l3.40"></a><span id="l3.40"> &lt;!ENTITY cancel.label             &quot;Cancel&quot;&gt;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42"> &lt;!ENTITY select.label             &quot;or select the type of material to import:&quot;&gt;</span>
<a href="#l3.43"></a><span id="l3.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/newsblog/feed-subscriptions.css</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -21,8 +21,11 @@</span>
<a href="#l4.4"></a><span id="l4.4">   padding-top: 4px;</span>
<a href="#l4.5"></a><span id="l4.5">   background-color: #EAE8E4;</span>
<a href="#l4.6"></a><span id="l4.6"> }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> #statusContainerBox {</span>
<a href="#l4.9"></a><span id="l4.9">   height: 24px;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#selectFolder {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  margin-top: 1px !important;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/newsblog/feed-subscriptions.css</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,8 +16,12 @@</span>
<a href="#l5.4"></a><span id="l5.4">   margin: 4px;</span>
<a href="#l5.5"></a><span id="l5.5">   padding-top: 4px;</span>
<a href="#l5.6"></a><span id="l5.6">   background-color: #EAE8E4;</span>
<a href="#l5.7"></a><span id="l5.7"> }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> #statusContainerBox {</span>
<a href="#l5.10"></a><span id="l5.10">   height: 24px;</span>
<a href="#l5.11"></a><span id="l5.11"> }</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#selectFolder {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  margin-top: 1px !important;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/themes/qute/mail/newsblog/feed-subscriptions.css</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/themes/qute/mail/newsblog/feed-subscriptions.css</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -20,8 +20,12 @@</span>
<a href="#l6.4"></a><span id="l6.4">   margin: 4px;</span>
<a href="#l6.5"></a><span id="l6.5">   padding-top: 4px;</span>
<a href="#l6.6"></a><span id="l6.6">   background-color: #EAE8E4;</span>
<a href="#l6.7"></a><span id="l6.7"> }</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> #statusContainerBox {</span>
<a href="#l6.10"></a><span id="l6.10">   height: 24px;</span>
<a href="#l6.11"></a><span id="l6.11"> }</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#selectFolder {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  margin-bottom: 3px !important;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -423,18 +423,30 @@ Feed.prototype =</span>
<a href="#l7.4"></a><span id="l7.4">                             &quot; this feed removed&quot;);</span>
<a href="#l7.5"></a><span id="l7.5">       else</span>
<a href="#l7.6"></a><span id="l7.6">         FeedUtils.removeAssertions(ds, item);</span>
<a href="#l7.7"></a><span id="l7.7">     }</span>
<a href="#l7.8"></a><span id="l7.8">   },</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   createFolder: function()</span>
<a href="#l7.11"></a><span id="l7.11">   {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    if (!this.folder)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-      this.server.rootMsgFolder.createSubfolder(this.name, null);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    if (this.folder)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+      return;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    try {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+      this.folder = this.server.rootMsgFolder.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+                                QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+                                createLocalSubfolder(this.name);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    }</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    catch (ex) {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+      // An error creating.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+      FeedUtils.log.error(&quot;Feed.createFolder: error creating folder - '&quot;+</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+                          this.name+&quot;' in parent folder &quot;+</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+                          this.server.rootMsgFolder.filePath.path + &quot; -- &quot;+ex);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+    }</span>
<a href="#l7.28"></a><span id="l7.28">   },</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   // Gets the next item from itemsToStore and forces that item to be stored</span>
<a href="#l7.31"></a><span id="l7.31">   // to the folder.  If more items are left to be stored, fires a timer for</span>
<a href="#l7.32"></a><span id="l7.32">   // the next one, otherwise triggers a download done notification to the UI.</span>
<a href="#l7.33"></a><span id="l7.33">   storeNextItem: function()</span>
<a href="#l7.34"></a><span id="l7.34">   {</span>
<a href="#l7.35"></a><span id="l7.35">     if (!this.itemsToStore || !this.itemsToStore.length)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -152,18 +152,17 @@ FeedItem.prototype =</span>
<a href="#l8.4"></a><span id="l8.4">     let server = this.feed.server;</span>
<a href="#l8.5"></a><span id="l8.5">     let folder = this.feed.folder;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">     if (!folder)</span>
<a href="#l8.8"></a><span id="l8.8">     {</span>
<a href="#l8.9"></a><span id="l8.9">       FeedUtils.log.debug(&quot;FeedItem.findStoredResource: &quot; + this.feed.name +</span>
<a href="#l8.10"></a><span id="l8.10">                           &quot; folder doesn't exist; creating as child of &quot; +</span>
<a href="#l8.11"></a><span id="l8.11">                           server.rootMsgFolder.prettyName + &quot;\n&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      server.rootMsgFolder.createSubfolder(this.feed.name, null);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-      folder = server.rootMsgFolder.findSubFolder(this.feed.name);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+      this.feed.createFolder();</span>
<a href="#l8.15"></a><span id="l8.15">       FeedUtils.log.debug(&quot;FeedItem.findStoredResource: &quot; + this.identity +</span>
<a href="#l8.16"></a><span id="l8.16">                           &quot; not stored (folder didn't exist)&quot;);</span>
<a href="#l8.17"></a><span id="l8.17">       return null;</span>
<a href="#l8.18"></a><span id="l8.18">     }</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">     let ds = FeedUtils.getItemsDS(server);</span>
<a href="#l8.21"></a><span id="l8.21">     let itemURI = this.itemUniqueURI;</span>
<a href="#l8.22"></a><span id="l8.22">     let itemResource = FeedUtils.rdf.GetResource(itemURI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,37 +1,38 @@</span>
<a href="#l9.4"></a><span id="l9.4"> # -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l9.5"></a><span id="l9.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-var gFeedSubscriptionsWindow = {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+var FeedSubscriptions = {</span>
<a href="#l9.13"></a><span id="l9.13">   get mTree() { return document.getElementById(&quot;rssSubscriptionsList&quot;); },</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   mFeedContainers: [],</span>
<a href="#l9.16"></a><span id="l9.16">   mRSSServer     : null,</span>
<a href="#l9.17"></a><span id="l9.17">   mActionMode    : null,</span>
<a href="#l9.18"></a><span id="l9.18">   kSubscribeMode : 1,</span>
<a href="#l9.19"></a><span id="l9.19">   kUpdateMode    : 2,</span>
<a href="#l9.20"></a><span id="l9.20">   kMoveMode      : 3,</span>
<a href="#l9.21"></a><span id="l9.21">   kCopyMode      : 4,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  kImportingOPML : 5,</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   onLoad: function ()</span>
<a href="#l9.25"></a><span id="l9.25">   {</span>
<a href="#l9.26"></a><span id="l9.26">     // Extract the folder argument.</span>
<a href="#l9.27"></a><span id="l9.27">     let folder;</span>
<a href="#l9.28"></a><span id="l9.28">     if (window.arguments &amp;&amp; window.arguments[0].folder)</span>
<a href="#l9.29"></a><span id="l9.29">       folder = window.arguments[0].folder;</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">     // Ensure dialog is fully loaded before selecting, to get visible row.</span>
<a href="#l9.32"></a><span id="l9.32">     setTimeout(function() {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-      gFeedSubscriptionsWindow.refreshSubscriptionView(folder)</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-    }, 10);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+      FeedSubscriptions.refreshSubscriptionView(folder)</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+    }, 100);</span>
<a href="#l9.37"></a><span id="l9.37">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-loading&quot;);</span>
<a href="#l9.38"></a><span id="l9.38">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">     let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l9.41"></a><span id="l9.41">     if (win)</span>
<a href="#l9.42"></a><span id="l9.42">     {</span>
<a href="#l9.43"></a><span id="l9.43">       win.FeedFolderNotificationService =</span>
<a href="#l9.44"></a><span id="l9.44">         Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;].</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineat">@@ -70,71 +71,44 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.46"></a><span id="l9.46">     }</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">     return dismissDialog;</span>
<a href="#l9.49"></a><span id="l9.49">   },</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   refreshSubscriptionView: function(aSelectFolder)</span>
<a href="#l9.52"></a><span id="l9.52">   {</span>
<a href="#l9.53"></a><span id="l9.53">     let item = this.mView.currentItem;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    let firstVisRow, lastVisRow, curFirstVisRow;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    if (this.mView.treeBox)</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-      firstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.57"></a><span id="l9.57">     this.loadSubscriptions();</span>
<a href="#l9.58"></a><span id="l9.58">     this.mTree.view = this.mView;</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">     document.getElementById(&quot;selectFolderPopup&quot;)._ensureInitialized();</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62">     if (aSelectFolder)</span>
<a href="#l9.63"></a><span id="l9.63">       this.selectFolder(aSelectFolder);</span>
<a href="#l9.64"></a><span id="l9.64">     else</span>
<a href="#l9.65"></a><span id="l9.65">     {</span>
<a href="#l9.66"></a><span id="l9.66">       // If no folder to select, try to select the pre rebuild selection, in</span>
<a href="#l9.67"></a><span id="l9.67">       // an existing window.  For folderpane changes in a feed account.</span>
<a href="#l9.68"></a><span id="l9.68">       if (item)</span>
<a href="#l9.69"></a><span id="l9.69">       {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+        let rootFolder = item.container ? item.folder.rootFolder :</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+                                          item.parentFolder.rootFolder;</span>
<a href="#l9.72"></a><span id="l9.72">         if (item.container)</span>
<a href="#l9.73"></a><span id="l9.73">         {</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-          if (!this.selectFolder(item.folder))</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+          if (!this.selectFolder(item.folder, { open: item.open }))</span>
<a href="#l9.76"></a><span id="l9.76">             // The item no longer exists, an ancestor folder was deleted or</span>
<a href="#l9.77"></a><span id="l9.77">             // renamed/moved.</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-            this.selectFolder(item.folder.rootFolder);</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+            this.selectFolder(rootFolder);</span>
<a href="#l9.80"></a><span id="l9.80">         }</span>
<a href="#l9.81"></a><span id="l9.81">         else</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-        {</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-          // If selecting a prior selected feed, get its folder from the db</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-          // in case an ancestor folder was renamed/moved.</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-          let itemResource = FeedUtils.rdf.GetResource(item.url);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-          let ds = FeedUtils.getSubscriptionsDS(item.parentFolder.server);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-          let itemFolder = ds.GetTarget(itemResource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-          if (itemFolder)</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-          {</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-            itemFolder = itemFolder.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-            this.selectFeed({folder: itemFolder, url: item.url}, null);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-          }</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-          else</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-            // The item no longer exists, an ancestor folder was deleted.</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-            this.selectFolder(item.parentFolder.rootFolder);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-        }</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-        curFirstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-        lastVisRow = this.mView.treeBox.getLastVisibleRow();</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-        if (firstVisRow &gt;= 0 &amp;&amp; //firstVisRow &gt;= curFirstVisRow &amp;&amp;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-            this.mView.rowCount - lastVisRow &gt; firstVisRow - curFirstVisRow)</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-          this.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-        else</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-          this.mView.treeBox.ensureRowIsVisible(this.mView.rowCount - 1);</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-        FeedUtils.log.debug(&quot;refreshSubscriptionView: curIndex:curFirstVisRow:&quot; +</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-                            &quot;firstVisRow:lastVisRow:rowCount - &quot; +</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-                            this.mView.selection.currentIndex+&quot;:&quot;+</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-                            curFirstVisRow+&quot;:&quot;+</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-                            firstVisRow+&quot;:&quot;+lastVisRow+&quot;:&quot;+this.mView.rowCount);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+          this.selectFeed({ folder: rootFolder, url: item.url }, null);</span>
<a href="#l9.111"></a><span id="l9.111">       }</span>
<a href="#l9.112"></a><span id="l9.112">     }</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+    this.mView.treeBox.ensureRowIsVisible(this.mView.selection.currentIndex);</span>
<a href="#l9.115"></a><span id="l9.115">     this.clearStatusInfo();</span>
<a href="#l9.116"></a><span id="l9.116">   },</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118">   mView:</span>
<a href="#l9.119"></a><span id="l9.119">   {</span>
<a href="#l9.120"></a><span id="l9.120">     _atoms: [],</span>
<a href="#l9.121"></a><span id="l9.121">     _getAtomFor: function(aName) {</span>
<a href="#l9.122"></a><span id="l9.122">       if (!this._atoms[aName])</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineat">@@ -229,31 +203,47 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.124"></a><span id="l9.124">       if (!item) </span>
<a href="#l9.125"></a><span id="l9.125">         return false;</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127">       return item.children.length == 0;</span>
<a href="#l9.128"></a><span id="l9.128">     },</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130">     getItemAtIndex: function (aRow)</span>
<a href="#l9.131"></a><span id="l9.131">     {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-      if (aRow &lt; 0 || aRow &gt;= gFeedSubscriptionsWindow.mFeedContainers.length)</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+      if (aRow &lt; 0 || aRow &gt;= FeedSubscriptions.mFeedContainers.length)</span>
<a href="#l9.134"></a><span id="l9.134">         return null;</span>
<a href="#l9.135"></a><span id="l9.135"> </span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-      return gFeedSubscriptionsWindow.mFeedContainers[aRow];</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+      return FeedSubscriptions.mFeedContainers[aRow];</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    },</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+    getItemInViewIndex: function(aFolder)</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+    {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+      if (!aFolder || !(aFolder instanceof Ci.nsIMsgFolder))</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+        return null;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+      for (let index = 0; index &lt; this.rowCount; index++)</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+      {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+        // Find the visible folder in the view.</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+        let item = this.getItemAtIndex(index);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+        if (item &amp;&amp; item.container &amp;&amp; item.url == aFolder.URI)</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+          return index;</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+      }</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+      return null;</span>
<a href="#l9.154"></a><span id="l9.154">     },</span>
<a href="#l9.155"></a><span id="l9.155"> </span>
<a href="#l9.156"></a><span id="l9.156">     removeItemAtIndex: function (aRow, aNoSelect)</span>
<a href="#l9.157"></a><span id="l9.157">     {</span>
<a href="#l9.158"></a><span id="l9.158">       let itemToRemove = this.getItemAtIndex(aRow);</span>
<a href="#l9.159"></a><span id="l9.159">       if (!itemToRemove)</span>
<a href="#l9.160"></a><span id="l9.160">         return;</span>
<a href="#l9.161"></a><span id="l9.161"> </span>
<a href="#l9.162"></a><span id="l9.162">       if (itemToRemove.container &amp;&amp; itemToRemove.open)</span>
<a href="#l9.163"></a><span id="l9.163">         // Close it, if open container.</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-        this.toggle(aRow);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+        this.toggleOpenState(aRow);</span>
<a href="#l9.166"></a><span id="l9.166"> </span>
<a href="#l9.167"></a><span id="l9.167">       let parentIndex = this.getParentIndex(aRow);</span>
<a href="#l9.168"></a><span id="l9.168">       let hasNextSibling = this.hasNextSibling(aRow, aRow);</span>
<a href="#l9.169"></a><span id="l9.169">       if (parentIndex != this.kRowIndexUndefined)</span>
<a href="#l9.170"></a><span id="l9.170">       {</span>
<a href="#l9.171"></a><span id="l9.171">         let parent = this.getItemAtIndex(parentIndex);</span>
<a href="#l9.172"></a><span id="l9.172">         if (parent)</span>
<a href="#l9.173"></a><span id="l9.173">         {</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineat">@@ -262,34 +252,34 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.175"></a><span id="l9.175">             {</span>
<a href="#l9.176"></a><span id="l9.176">               parent.children.splice(index, 1);</span>
<a href="#l9.177"></a><span id="l9.177">               break;</span>
<a href="#l9.178"></a><span id="l9.178">             }</span>
<a href="#l9.179"></a><span id="l9.179">         }</span>
<a href="#l9.180"></a><span id="l9.180">       }</span>
<a href="#l9.181"></a><span id="l9.181"> </span>
<a href="#l9.182"></a><span id="l9.182">       // Now remove it from our view.</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-      gFeedSubscriptionsWindow.mFeedContainers.splice(aRow, 1);</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+      FeedSubscriptions.mFeedContainers.splice(aRow, 1);</span>
<a href="#l9.185"></a><span id="l9.185"> </span>
<a href="#l9.186"></a><span id="l9.186">       // Now invalidate the correct tree rows.</span>
<a href="#l9.187"></a><span id="l9.187">       this.mRowCount--;</span>
<a href="#l9.188"></a><span id="l9.188">       this.treeBox.rowCountChanged(aRow, -1);</span>
<a href="#l9.189"></a><span id="l9.189"> </span>
<a href="#l9.190"></a><span id="l9.190">       // Now update the selection position, unless noSelect (selection is</span>
<a href="#l9.191"></a><span id="l9.191">       // done later or not at all).  If the item is the last child, select the</span>
<a href="#l9.192"></a><span id="l9.192">       // parent.  Otherwise select the next sibling.</span>
<a href="#l9.193"></a><span id="l9.193">       if (!aNoSelect) {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-        if (aRow &lt;= gFeedSubscriptionsWindow.mFeedContainers.length)</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+        if (aRow &lt;= FeedSubscriptions.mFeedContainers.length)</span>
<a href="#l9.196"></a><span id="l9.196">           this.selection.select(hasNextSibling ? aRow : aRow - 1);</span>
<a href="#l9.197"></a><span id="l9.197">         else</span>
<a href="#l9.198"></a><span id="l9.198">           this.selection.clearSelection();</span>
<a href="#l9.199"></a><span id="l9.199">       }</span>
<a href="#l9.200"></a><span id="l9.200"> </span>
<a href="#l9.201"></a><span id="l9.201">       // Now refocus the tree.</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-      gFeedSubscriptionsWindow.mTree.focus();</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+      FeedSubscriptions.mTree.focus();</span>
<a href="#l9.204"></a><span id="l9.204">     },</span>
<a href="#l9.205"></a><span id="l9.205"> </span>
<a href="#l9.206"></a><span id="l9.206">     getCellText: function (aRow, aColumn)</span>
<a href="#l9.207"></a><span id="l9.207">     {</span>
<a href="#l9.208"></a><span id="l9.208">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l9.209"></a><span id="l9.209">       return (item &amp;&amp; aColumn.id == &quot;folderNameCol&quot;) ? item.name : &quot;&quot;;</span>
<a href="#l9.210"></a><span id="l9.210">     },</span>
<a href="#l9.211"></a><span id="l9.211"> </span>
<a href="#l9.212"></a><span id="l9.212" class="difflineat">@@ -297,34 +287,34 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.213"></a><span id="l9.213">     { </span>
<a href="#l9.214"></a><span id="l9.214">       let dropResult = this.extractDragData(aRow);</span>
<a href="#l9.215"></a><span id="l9.215">       return aOrientation == Ci.nsITreeView.DROP_ON &amp;&amp; dropResult.canDrop &amp;&amp;</span>
<a href="#l9.216"></a><span id="l9.216">              (dropResult.dropUrl || dropResult.dropOnIndex != this.kRowIndexUndefined);</span>
<a href="#l9.217"></a><span id="l9.217">     },</span>
<a href="#l9.218"></a><span id="l9.218"> </span>
<a href="#l9.219"></a><span id="l9.219">     drop: function (aRow, aOrientation)</span>
<a href="#l9.220"></a><span id="l9.220">     {</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-      let win = gFeedSubscriptionsWindow;</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+      let win = FeedSubscriptions;</span>
<a href="#l9.223"></a><span id="l9.223">       let results = this.extractDragData(aRow);</span>
<a href="#l9.224"></a><span id="l9.224">       if (!results.canDrop)</span>
<a href="#l9.225"></a><span id="l9.225">         return;</span>
<a href="#l9.226"></a><span id="l9.226"> </span>
<a href="#l9.227"></a><span id="l9.227">       // Preselect the drop folder.</span>
<a href="#l9.228"></a><span id="l9.228">       this.selection.select(aRow);</span>
<a href="#l9.229"></a><span id="l9.229"> </span>
<a href="#l9.230"></a><span id="l9.230">       if (results.dropUrl)</span>
<a href="#l9.231"></a><span id="l9.231">       {</span>
<a href="#l9.232"></a><span id="l9.232">         // Don't freeze the app that initiated the drop just because we are</span>
<a href="#l9.233"></a><span id="l9.233">         // in a loop waiting for the user to dimisss the add feed dialog.</span>
<a href="#l9.234"></a><span id="l9.234">         setTimeout(function() {</span>
<a href="#l9.235"></a><span id="l9.235">           win.addFeed(results.dropUrl, null, true, null, win.kSubscribeMode);</span>
<a href="#l9.236"></a><span id="l9.236">         }, 0);</span>
<a href="#l9.237"></a><span id="l9.237">         let folderItem = this.getItemAtIndex(aRow);</span>
<a href="#l9.238"></a><span id="l9.238">         FeedUtils.log.debug(&quot;drop: folder, url - &quot; +</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-                            folderItem.folder.name+&quot;, &quot;+results.dropUrl);</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+                            folderItem.folder.name + &quot;, &quot; + results.dropUrl);</span>
<a href="#l9.241"></a><span id="l9.241">       }</span>
<a href="#l9.242"></a><span id="l9.242">       else if (results.dropOnIndex != this.kRowIndexUndefined)</span>
<a href="#l9.243"></a><span id="l9.243">       {</span>
<a href="#l9.244"></a><span id="l9.244">         win.moveCopyFeed(results.dropOnIndex, aRow, results.dropEffect);</span>
<a href="#l9.245"></a><span id="l9.245">       }</span>
<a href="#l9.246"></a><span id="l9.246">     },</span>
<a href="#l9.247"></a><span id="l9.247"> </span>
<a href="#l9.248"></a><span id="l9.248">     // Helper function for drag and drop.</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineat">@@ -376,26 +366,46 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.250"></a><span id="l9.250"> </span>
<a href="#l9.251"></a><span id="l9.251">     getParentIndex: function (aRow)</span>
<a href="#l9.252"></a><span id="l9.252">     {</span>
<a href="#l9.253"></a><span id="l9.253">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l9.254"></a><span id="l9.254"> </span>
<a href="#l9.255"></a><span id="l9.255">       if (item)</span>
<a href="#l9.256"></a><span id="l9.256">       {</span>
<a href="#l9.257"></a><span id="l9.257">         for (let index = aRow; index &gt;= 0; index--)</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-          if (gFeedSubscriptionsWindow.mFeedContainers[index].level &lt; item.level)</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+          if (FeedSubscriptions.mFeedContainers[index].level &lt; item.level)</span>
<a href="#l9.260"></a><span id="l9.260">             return index;</span>
<a href="#l9.261"></a><span id="l9.261">       }</span>
<a href="#l9.262"></a><span id="l9.262"> </span>
<a href="#l9.263"></a><span id="l9.263">       return this.kRowIndexUndefined;</span>
<a href="#l9.264"></a><span id="l9.264">     },</span>
<a href="#l9.265"></a><span id="l9.265"> </span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+    isIndexChildOfParentIndex: function (aRow, aChildRow)</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+    {</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+      // For visible tree rows, not if items are children of closed folders.</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+      let item = this.getItemAtIndex(aRow);</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+      if (!item || aChildRow &lt;= aRow)</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+        return false;</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+      let targetLevel = this.getItemAtIndex(aRow).level;</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+      let rows = FeedSubscriptions.mFeedContainers;</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+      for (let i = aRow + 1; i &lt; rows.length; i++) {</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+        if (this.getItemAtIndex(i).level &lt;= targetLevel)</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+          break;</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+        if (aChildRow == i)</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+          return true;</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+      }</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+      return false;</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+    },</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+</span>
<a href="#l9.286"></a><span id="l9.286">     hasNextSibling: function(aRow, aAfterIndex) {</span>
<a href="#l9.287"></a><span id="l9.287">       let targetLevel = this.getItemAtIndex(aRow).level;</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-      let rows = gFeedSubscriptionsWindow.mFeedContainers;</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+      let rows = FeedSubscriptions.mFeedContainers;</span>
<a href="#l9.290"></a><span id="l9.290">       for (let i = aAfterIndex + 1; i &lt; rows.length; i++) {</span>
<a href="#l9.291"></a><span id="l9.291">         if (this.getItemAtIndex(i).level == targetLevel)</span>
<a href="#l9.292"></a><span id="l9.292">           return true;</span>
<a href="#l9.293"></a><span id="l9.293">         if (this.getItemAtIndex(i).level &lt; targetLevel)</span>
<a href="#l9.294"></a><span id="l9.294">           return false;</span>
<a href="#l9.295"></a><span id="l9.295">       }</span>
<a href="#l9.296"></a><span id="l9.296"> </span>
<a href="#l9.297"></a><span id="l9.297">       return false;</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineat">@@ -442,17 +452,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.299"></a><span id="l9.299"> </span>
<a href="#l9.300"></a><span id="l9.300">     toggle: function (aRow)</span>
<a href="#l9.301"></a><span id="l9.301">     {</span>
<a href="#l9.302"></a><span id="l9.302">       // Collapse the row, or build sub rows based on open states in the map.</span>
<a href="#l9.303"></a><span id="l9.303">       let item = this.getItemAtIndex(aRow);</span>
<a href="#l9.304"></a><span id="l9.304">       if (!item)</span>
<a href="#l9.305"></a><span id="l9.305">         return null;</span>
<a href="#l9.306"></a><span id="l9.306"> </span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-      let rows = gFeedSubscriptionsWindow.mFeedContainers;</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+      let rows = FeedSubscriptions.mFeedContainers;</span>
<a href="#l9.309"></a><span id="l9.309">       let rowCount = 0;</span>
<a href="#l9.310"></a><span id="l9.310">       let multiplier;</span>
<a href="#l9.311"></a><span id="l9.311"> </span>
<a href="#l9.312"></a><span id="l9.312">       if (item.open)</span>
<a href="#l9.313"></a><span id="l9.313">       {</span>
<a href="#l9.314"></a><span id="l9.314">         // Close the container.  Add up all subfolders and their descendants</span>
<a href="#l9.315"></a><span id="l9.315">         // who may be open.</span>
<a href="#l9.316"></a><span id="l9.316">         multiplier = -1;</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineat">@@ -496,23 +506,26 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.318"></a><span id="l9.318">       this.treeBox.rowCountChanged(aRow, delta);</span>
<a href="#l9.319"></a><span id="l9.319">       return delta;</span>
<a href="#l9.320"></a><span id="l9.320">     }</span>
<a href="#l9.321"></a><span id="l9.321">   },</span>
<a href="#l9.322"></a><span id="l9.322"> </span>
<a href="#l9.323"></a><span id="l9.323">   makeFolderObject: function (aFolder, aCurrentLevel)</span>
<a href="#l9.324"></a><span id="l9.324">   {</span>
<a href="#l9.325"></a><span id="l9.325">     let defaultQuickMode = aFolder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+    let open = !aFolder.isServer &amp;&amp;</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+               aFolder.server == this.mRSSServer &amp;&amp;</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+               this.mActionMode == this.kImportingOPML ? true : false</span>
<a href="#l9.329"></a><span id="l9.329">     let folderObject =  { children : [],</span>
<a href="#l9.330"></a><span id="l9.330">                           folder   : aFolder,</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-                          name     : aFolder.prettiestName,</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+                          name     : aFolder.prettyName,</span>
<a href="#l9.333"></a><span id="l9.333">                           level    : aCurrentLevel,</span>
<a href="#l9.334"></a><span id="l9.334">                           url      : aFolder.URI,</span>
<a href="#l9.335"></a><span id="l9.335">                           quickMode: defaultQuickMode,</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-                          open     : false,</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+                          open     : open,</span>
<a href="#l9.338"></a><span id="l9.338">                           container: true };</span>
<a href="#l9.339"></a><span id="l9.339"> </span>
<a href="#l9.340"></a><span id="l9.340">     // If a feed has any sub folders, add them to the list of children.</span>
<a href="#l9.341"></a><span id="l9.341">     let folderEnumerator = aFolder.subFolders;</span>
<a href="#l9.342"></a><span id="l9.342"> </span>
<a href="#l9.343"></a><span id="l9.343">     while (folderEnumerator.hasMoreElements())</span>
<a href="#l9.344"></a><span id="l9.344">     {</span>
<a href="#l9.345"></a><span id="l9.345">       let folder = folderEnumerator.getNext();</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineat">@@ -520,44 +533,43 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.347"></a><span id="l9.347">           !folder.getFlag(Ci.nsMsgFolderFlags.Trash) &amp;&amp;</span>
<a href="#l9.348"></a><span id="l9.348">           !folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l9.349"></a><span id="l9.349">       {</span>
<a href="#l9.350"></a><span id="l9.350">         folderObject.children</span>
<a href="#l9.351"></a><span id="l9.351">                     .push(this.makeFolderObject(folder, aCurrentLevel + 1));</span>
<a href="#l9.352"></a><span id="l9.352">       }</span>
<a href="#l9.353"></a><span id="l9.353">     }</span>
<a href="#l9.354"></a><span id="l9.354"> </span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-    function sorter(a, b)</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-    {</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-      let sortKey = a.folder.compareSortKeys(b.folder);</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-      if (sortKey)</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-        return sortKey;</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-      return a.name.toLowerCase() &gt; b.name.toLowerCase();</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-    }</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">- </span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-    folderObject.children.sort(sorter);</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-</span>
<a href="#l9.365"></a><span id="l9.365">     let feeds = this.getFeedsInFolder(aFolder);</span>
<a href="#l9.366"></a><span id="l9.366">     for (let feed in feeds)</span>
<a href="#l9.367"></a><span id="l9.367">     {</span>
<a href="#l9.368"></a><span id="l9.368">       // Now add any feed urls for the folder.</span>
<a href="#l9.369"></a><span id="l9.369">       folderObject.children.push(this.makeFeedObject(feeds[feed],</span>
<a href="#l9.370"></a><span id="l9.370">                                                      aFolder,</span>
<a href="#l9.371"></a><span id="l9.371">                                                      aCurrentLevel + 1));</span>
<a href="#l9.372"></a><span id="l9.372">     }</span>
<a href="#l9.373"></a><span id="l9.373"> </span>
<a href="#l9.374"></a><span id="l9.374">     // Finally, set the folder's quickMode based on the its first feed's</span>
<a href="#l9.375"></a><span id="l9.375">     // quickMode, since that is how the view determines summary mode, and now</span>
<a href="#l9.376"></a><span id="l9.376">     // quickMode is updated to be the same for all feeds in a folder.</span>
<a href="#l9.377"></a><span id="l9.377">     if (feeds &amp;&amp; feeds[0])</span>
<a href="#l9.378"></a><span id="l9.378">       folderObject.quickMode = feeds[0].quickMode;</span>
<a href="#l9.379"></a><span id="l9.379"> </span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+    folderObject.children = this.folderItemSorter(folderObject.children);</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+</span>
<a href="#l9.382"></a><span id="l9.382">     return folderObject;</span>
<a href="#l9.383"></a><span id="l9.383">   },</span>
<a href="#l9.384"></a><span id="l9.384"> </span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+  folderItemSorter: function (aArray)</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+  {</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+    return aArray.sort(function(a, b) { return a.name.toLowerCase() &gt;</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+                                               b.name.toLowerCase() }).</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+                  sort(function(a, b) { return a.container &lt; b.container });</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+  },</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+</span>
<a href="#l9.392"></a><span id="l9.392">   getFeedsInFolder: function (aFolder)</span>
<a href="#l9.393"></a><span id="l9.393">   {</span>
<a href="#l9.394"></a><span id="l9.394">     let feeds = new Array();</span>
<a href="#l9.395"></a><span id="l9.395">     let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l9.396"></a><span id="l9.396">     if (!feedUrlArray)</span>
<a href="#l9.397"></a><span id="l9.397">       // No feedUrls in this folder.</span>
<a href="#l9.398"></a><span id="l9.398">       return feeds;</span>
<a href="#l9.399"></a><span id="l9.399"> </span>
<a href="#l9.400"></a><span id="l9.400" class="difflineat">@@ -587,144 +599,234 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.401"></a><span id="l9.401">     return feed;</span>
<a href="#l9.402"></a><span id="l9.402">   },</span>
<a href="#l9.403"></a><span id="l9.403"> </span>
<a href="#l9.404"></a><span id="l9.404">   loadSubscriptions: function ()</span>
<a href="#l9.405"></a><span id="l9.405">   {</span>
<a href="#l9.406"></a><span id="l9.406">     // Put together an array of folders.  Each feed account level folder is</span>
<a href="#l9.407"></a><span id="l9.407">     // included as the root.</span>
<a href="#l9.408"></a><span id="l9.408">     let numFolders = 0;</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-    let feedRootFolders = [];</span>
<a href="#l9.410"></a><span id="l9.410">     let feedContainers = [];</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-</span>
<a href="#l9.412"></a><span id="l9.412">     // Get all the feed account folders.</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-    let allServers = MailServices.accounts.allServers;</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-    for (let i = 0; i &lt; allServers.Count(); i++)</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-    {</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-      let currentServer = allServers.QueryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-      if (currentServer &amp;&amp; currentServer.type == &quot;rss&quot;)</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-        feedRootFolders.push(currentServer.rootFolder);</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-    }</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+    let feedRootFolders = FeedUtils.getAllRssServerRootFolders();</span>
<a href="#l9.421"></a><span id="l9.421"> </span>
<a href="#l9.422"></a><span id="l9.422">     feedRootFolders.forEach(function(rootFolder) {</span>
<a href="#l9.423"></a><span id="l9.423">       feedContainers.push(this.makeFolderObject(rootFolder, 0));</span>
<a href="#l9.424"></a><span id="l9.424">       numFolders++;</span>
<a href="#l9.425"></a><span id="l9.425">     }, this);</span>
<a href="#l9.426"></a><span id="l9.426"> </span>
<a href="#l9.427"></a><span id="l9.427">     this.mFeedContainers = feedContainers;</span>
<a href="#l9.428"></a><span id="l9.428">     this.mView.mRowCount = numFolders;</span>
<a href="#l9.429"></a><span id="l9.429"> </span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-    gFeedSubscriptionsWindow.mTree.focus();</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+    FeedSubscriptions.mTree.focus();</span>
<a href="#l9.432"></a><span id="l9.432">   },</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434">   /**</span>
<a href="#l9.435"></a><span id="l9.435">    * Find the folder in the tree.  The search may be limited to subfolders of</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-   * a known folder, or expanded to include the entire tree.  The first</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-   * occurence of a folder URI will be selected.</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+   * a known folder, or expanded to include the entire tree. This function is</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+   * also used to insert/remove folders without rebuilding the tree view cache</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+   * (to avoid position/toggle state loss).</span>
<a href="#l9.441"></a><span id="l9.441">    * </span>
<a href="#l9.442"></a><span id="l9.442">    * @param  aFolder nsIMsgFolder - the folder to find.</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-   * @param  [aSelect] boolean    - if true (default) the folder's ancestors</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-   *                                will be opened and the folder selected.</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-   * @param  [aParentIndex] int   - index of folder to start the search.</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-   * @param  [aOpen] boolean      - if true (default) the folder is opened.</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+   * @param  [aParams] object     - params object, containing:</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+   * </span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+   * [parentIndex] int        - index of folder to start the search; if</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+   *                            null (default), the index of the folder's</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+   *                            rootFolder will be used.</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+   * [select] boolean         - if true (default) the folder's ancestors</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+   *                            will be opened and the folder selected.</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+   * [open] boolean           - if true (default) the folder is opened.</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+   * [remove] boolean         - delete the item from tree row cache if true,</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+   *                            false (default) otherwise.</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+   * [newFolder] nsIMsgFolder - if not null (default) the new folder,</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+   *                            for add or rename.</span>
<a href="#l9.459"></a><span id="l9.459">    * </span>
<a href="#l9.460"></a><span id="l9.460">    * @return bool found - true if found, false if not.</span>
<a href="#l9.461"></a><span id="l9.461">    */</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-  selectFolder: function(aFolder, aSelect, aParentIndex, aOpen)</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+  selectFolder: function(aFolder, aParms)</span>
<a href="#l9.464"></a><span id="l9.464">   {</span>
<a href="#l9.465"></a><span id="l9.465">     let folderURI = aFolder.URI;</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-    let selectIt = aSelect == null ? true : aSelect;</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-    let openIt = aOpen == null ? true : aOpen;</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+    let parentIndex = aParms &amp;&amp; (&quot;parentIndex&quot; in aParms) ? aParms.parentIndex : null;</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineplus">+    let selectIt = aParms &amp;&amp; (&quot;select&quot; in aParms) ? aParms.select : true;</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+    let openIt = aParms &amp;&amp; (&quot;open&quot; in aParms) ? aParms.open : true;</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+    let removeIt = aParms &amp;&amp; (&quot;remove&quot; in aParms) ? aParms.remove : false;</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+    let newFolder = aParms &amp;&amp; (&quot;newFolder&quot; in aParms) ? aParms.newFolder : null;</span>
<a href="#l9.473"></a><span id="l9.473">     let startIndex, startItem;</span>
<a href="#l9.474"></a><span id="l9.474">     let found = false;</span>
<a href="#l9.475"></a><span id="l9.475"> </span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-    if (aFolder.isServer || aParentIndex != null)</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-      // For a server, the aParentIndex doesn't matter, they are always visible.</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-      startIndex = aParentIndex;</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+    let firstVisRow, curFirstVisRow, curLastVisRow;</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+    if (this.mView.treeBox)</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+      firstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+    if (parentIndex != null)</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineplus">+    {</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineplus">+      // Use the parentIndex if given.</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+      startIndex = parentIndex;</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+      if (aFolder.isServer)</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+        // Fake item for account root folder.</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+        startItem = { name: &quot;AccountRoot&quot;,</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+                      children: [this.mView.getItemAtIndex(startIndex)],</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineplus">+                      container: true, open: false, url: null, level: -1};</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+      else</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+        startItem = this.mView.getItemAtIndex(startIndex);</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+    }</span>
<a href="#l9.495"></a><span id="l9.495">     else</span>
<a href="#l9.496"></a><span id="l9.496">     {</span>
<a href="#l9.497"></a><span id="l9.497">       // Get the folder's root parent index.</span>
<a href="#l9.498"></a><span id="l9.498">       let index = 0;</span>
<a href="#l9.499"></a><span id="l9.499">       for (index; index &lt; this.mView.rowCount; index++)</span>
<a href="#l9.500"></a><span id="l9.500">       {</span>
<a href="#l9.501"></a><span id="l9.501">         let item = this.mView.getItemAtIndex(index);</span>
<a href="#l9.502"></a><span id="l9.502">         if (item.url == aFolder.server.rootFolder.URI)</span>
<a href="#l9.503"></a><span id="l9.503">           break;</span>
<a href="#l9.504"></a><span id="l9.504">       }</span>
<a href="#l9.505"></a><span id="l9.505">       startIndex = index;</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+      if (aFolder.isServer)</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+        // Fake item for account root folder.</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+        startItem = { name: &quot;AccountRoot&quot;,</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+                      children: [this.mView.getItemAtIndex(startIndex)],</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+                      container: true, open: false, url: null, level: -1};</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+      else</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+        startItem = this.mView.getItemAtIndex(startIndex);</span>
<a href="#l9.513"></a><span id="l9.513">     }</span>
<a href="#l9.514"></a><span id="l9.514"> </span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-    if (!aFolder.isServer)</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-      startItem = this.mView.getItemAtIndex(startIndex);</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-</span>
<a href="#l9.518"></a><span id="l9.518">     function containsFolder(aItem)</span>
<a href="#l9.519"></a><span id="l9.519">     {</span>
<a href="#l9.520"></a><span id="l9.520">       // Search for the folder.  If it's found, set the open state on all</span>
<a href="#l9.521"></a><span id="l9.521">       // ancestor folders.  A toggle() rebuilds the view rows to match the map.</span>
<a href="#l9.522"></a><span id="l9.522">       if (aItem.url == folderURI)</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-        return true;</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineplus">+        return found = true;</span>
<a href="#l9.525"></a><span id="l9.525"> </span>
<a href="#l9.526"></a><span id="l9.526">       for (let i = 0; i &lt; aItem.children.length; i++) {</span>
<a href="#l9.527"></a><span id="l9.527">         if (aItem.children[i].container &amp;&amp; containsFolder(aItem.children[i]))</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineminus">-          return aItem.children[i].open = true;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+        {</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+          if (removeIt &amp;&amp; aItem.children[i].url == folderURI)</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+          {</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+            // Get all occurences in the tree cache arrays.</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+            FeedUtils.log.debug(&quot;selectFolder: delete in cache, &quot; +</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+                                &quot;parent:children:item:index - &quot;+</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+                                aItem.name + &quot;:&quot; + aItem.children.length + &quot;:&quot; +</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineplus">+                                aItem.children[i].name + &quot;:&quot; + i);</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineplus">+            aItem.children.splice(i, 1);</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineplus">+            FeedUtils.log.debug(&quot;selectFolder: deleted in cache, &quot; +</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+                                &quot;parent:children - &quot; +</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+                                aItem.name + &quot;:&quot; + aItem.children.length);</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+            removeIt = false;</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+            return true;</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+          }</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+          if (newFolder)</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+          {</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+            let newItem = FeedSubscriptions.makeFolderObject(newFolder,</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+                                                             aItem.level + 1);</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+            newItem.open = aItem.children[i].open;</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+            if (newFolder.isServer)</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+              FeedSubscriptions.mFeedContainers[startIndex] = newItem;</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineplus">+            else</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+            {</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineplus">+              aItem.children[i] = newItem;</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineplus">+              aItem.children = FeedSubscriptions.folderItemSorter(aItem.children);</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineplus">+            }</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+            FeedUtils.log.debug(&quot;selectFolder: parentName:newFolderName:newFolderItem - &quot; +</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineplus">+                                aItem.name + &quot;:&quot; + newItem.name + &quot;:&quot; + newItem.toSource());</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+            newFolder = null;</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+            return true;</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+          }</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+          if (!found)</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+          {</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+            // For the folder to find.</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+            found = true;</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+            aItem.children[i].open = openIt;</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+          }</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+          else</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+          {</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+            // For ancestor folders.</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+            if (selectIt || openIt)</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+              aItem.children[i].open = true;</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+          }</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineplus">+          return true;</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineplus">+        }</span>
<a href="#l9.576"></a><span id="l9.576">       }</span>
<a href="#l9.577"></a><span id="l9.577"> </span>
<a href="#l9.578"></a><span id="l9.578">       return false;</span>
<a href="#l9.579"></a><span id="l9.579">     }</span>
<a href="#l9.580"></a><span id="l9.580"> </span>
<a href="#l9.581"></a><span id="l9.581">     if (startItem)</span>
<a href="#l9.582"></a><span id="l9.582">     {</span>
<a href="#l9.583"></a><span id="l9.583">       // Find a folder with a specific parent.</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineminus">-      found = containsFolder(startItem);</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineplus">+      containsFolder(startItem);</span>
<a href="#l9.586"></a><span id="l9.586">       if (!found)</span>
<a href="#l9.587"></a><span id="l9.587">         return false;</span>
<a href="#l9.588"></a><span id="l9.588"> </span>
<a href="#l9.589"></a><span id="l9.589">       if (!selectIt)</span>
<a href="#l9.590"></a><span id="l9.590">         return true;</span>
<a href="#l9.591"></a><span id="l9.591"> </span>
<a href="#l9.592"></a><span id="l9.592">       if (startItem.open)</span>
<a href="#l9.593"></a><span id="l9.593">         this.mView.toggle(startIndex);</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-      this.mView.toggle(startIndex);</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+      this.mView.toggleOpenState(startIndex);</span>
<a href="#l9.596"></a><span id="l9.596">     }</span>
<a href="#l9.597"></a><span id="l9.597"> </span>
<a href="#l9.598"></a><span id="l9.598">     for (let index = 0; index &lt; this.mView.rowCount &amp;&amp; selectIt; index++)</span>
<a href="#l9.599"></a><span id="l9.599">     {</span>
<a href="#l9.600"></a><span id="l9.600">       // The desired folder is now in the view.</span>
<a href="#l9.601"></a><span id="l9.601">       let item = this.mView.getItemAtIndex(index);</span>
<a href="#l9.602"></a><span id="l9.602">       if (!item.container)</span>
<a href="#l9.603"></a><span id="l9.603">         continue;</span>
<a href="#l9.604"></a><span id="l9.604">       if (item.url == folderURI)</span>
<a href="#l9.605"></a><span id="l9.605">       {</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-        if (item.children.length &amp;&amp; !item.open &amp;&amp; openIt)</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-          this.mView.toggle(index);</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+        if (item.children.length &amp;&amp;</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+            ((!item.open &amp;&amp; openIt) || (item.open &amp;&amp; !openIt)))</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineplus">+          this.mView.toggleOpenState(index);</span>
<a href="#l9.611"></a><span id="l9.611">         this.mView.selection.select(index);</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-        this.mView.treeBox.ensureRowIsVisible(index);</span>
<a href="#l9.613"></a><span id="l9.613">         found = true;</span>
<a href="#l9.614"></a><span id="l9.614">         break;</span>
<a href="#l9.615"></a><span id="l9.615">       }</span>
<a href="#l9.616"></a><span id="l9.616">     }</span>
<a href="#l9.617"></a><span id="l9.617"> </span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-    if (this.mView.selection.selectEventsSuppressed)</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-      this.mView.selection.selectEventsSuppressed = false;</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineplus">+    // Ensure tree position does not jump unnecessarily.</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineplus">+    curFirstVisRow = this.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineplus">+    curLastVisRow = this.mView.treeBox.getLastVisibleRow();</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineplus">+    if (firstVisRow &gt;= 0 &amp;&amp;</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineplus">+        this.mView.rowCount - curLastVisRow &gt; firstVisRow - curFirstVisRow)</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineplus">+      this.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineplus">+    else</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineplus">+      this.mView.treeBox.ensureRowIsVisible(this.mView.rowCount - 1);</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineplus">+</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineplus">+    FeedUtils.log.debug(&quot;selectFolder: curIndex:firstVisRow:&quot; +</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineplus">+                        &quot;curFirstVisRow:curLastVisRow:rowCount - &quot; +</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineplus">+                        this.mView.selection.currentIndex + &quot;:&quot; +</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+                        firstVisRow + &quot;:&quot; +</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+                        curFirstVisRow + &quot;:&quot; + curLastVisRow + &quot;:&quot; + this.mView.rowCount);</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineplus">+</span>
<a href="#l9.635"></a><span id="l9.635">     return found;</span>
<a href="#l9.636"></a><span id="l9.636">   },</span>
<a href="#l9.637"></a><span id="l9.637"> </span>
<a href="#l9.638"></a><span id="l9.638">   /**</span>
<a href="#l9.639"></a><span id="l9.639">    * Find the feed in the tree.  The search first gets the feed's folder,</span>
<a href="#l9.640"></a><span id="l9.640">    * then selects the child feed.</span>
<a href="#l9.641"></a><span id="l9.641">    * </span>
<a href="#l9.642"></a><span id="l9.642">    * @param  aFeed {Feed object}    - the feed to find.</span>
<a href="#l9.643"></a><span id="l9.643">    * @param  [aParentIndex] integer - index to start the folder search.</span>
<a href="#l9.644"></a><span id="l9.644">    * </span>
<a href="#l9.645"></a><span id="l9.645">    * @return found bool - true if found, false if not.</span>
<a href="#l9.646"></a><span id="l9.646">    */</span>
<a href="#l9.647"></a><span id="l9.647">   selectFeed: function(aFeed, aParentIndex)</span>
<a href="#l9.648"></a><span id="l9.648">   {</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineplus">+    let folder = aFeed.folder;</span>
<a href="#l9.650"></a><span id="l9.650">     let found = false;</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-    if (this.selectFolder(aFeed.folder, true, aParentIndex))</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+    if (aFeed.folder.isServer) {</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+      // If passed the root folder, the caller wants to get the feed's folder</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+      // from the db (for cases of an ancestor folder rename/move).</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineplus">+      let itemResource = FeedUtils.rdf.GetResource(aFeed.url);</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+      let ds = FeedUtils.getSubscriptionsDS(aFeed.folder.server);</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineplus">+      folder = ds.GetTarget(itemResource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineplus">+    }</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineplus">+</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineplus">+    if (this.selectFolder(folder, { parentIndex: aParentIndex }))</span>
<a href="#l9.662"></a><span id="l9.662">     {</span>
<a href="#l9.663"></a><span id="l9.663">       let seln = this.mView.selection;</span>
<a href="#l9.664"></a><span id="l9.664">       let item = this.mView.currentItem;</span>
<a href="#l9.665"></a><span id="l9.665">       if (item) {</span>
<a href="#l9.666"></a><span id="l9.666">         for (let i = seln.currentIndex + 1; i &lt; this.mView.rowCount; i++) {</span>
<a href="#l9.667"></a><span id="l9.667">           if (this.mView.getItemAtIndex(i).url == aFeed.url) {</span>
<a href="#l9.668"></a><span id="l9.668">             this.mView.selection.select(i);</span>
<a href="#l9.669"></a><span id="l9.669">             this.mView.treeBox.ensureRowIsVisible(i);</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineat">@@ -845,17 +947,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.671"></a><span id="l9.671">     {</span>
<a href="#l9.672"></a><span id="l9.672">       if (document.getElementById(&quot;locationValue&quot;).value)</span>
<a href="#l9.673"></a><span id="l9.673">         // Intent is to add a feed/folder to the account, so return.</span>
<a href="#l9.674"></a><span id="l9.674">         return;</span>
<a href="#l9.675"></a><span id="l9.675"> </span>
<a href="#l9.676"></a><span id="l9.676">       // An account folder.  If it changes, all non feed containing subfolders</span>
<a href="#l9.677"></a><span id="l9.677">       // need to be updated with the new default.</span>
<a href="#l9.678"></a><span id="l9.678">       item.folder.server.setBoolValue(&quot;quickMode&quot;, aChecked);</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-      this.refreshSubscriptionView();</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineplus">+      this.FolderListener.folderAdded(item.folder);</span>
<a href="#l9.681"></a><span id="l9.681">     }</span>
<a href="#l9.682"></a><span id="l9.682">     else if (!FeedUtils.getFeedUrlsInFolder(item.folder))</span>
<a href="#l9.683"></a><span id="l9.683">       // Not a folder with feeds.</span>
<a href="#l9.684"></a><span id="l9.684">       return;</span>
<a href="#l9.685"></a><span id="l9.685">     else</span>
<a href="#l9.686"></a><span id="l9.686">     {</span>
<a href="#l9.687"></a><span id="l9.687">       let feedsInFolder = this.getFeedsInFolder(item.folder);</span>
<a href="#l9.688"></a><span id="l9.688">       // Update the feeds database, for each feed in the folder.</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineat">@@ -876,27 +978,36 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.690"></a><span id="l9.690">       this.removeFeed(true);</span>
<a href="#l9.691"></a><span id="l9.691"> </span>
<a href="#l9.692"></a><span id="l9.692">     this.clearStatusInfo();</span>
<a href="#l9.693"></a><span id="l9.693">   },</span>
<a href="#l9.694"></a><span id="l9.694"> </span>
<a href="#l9.695"></a><span id="l9.695">   onSelect: function ()</span>
<a href="#l9.696"></a><span id="l9.696">   {</span>
<a href="#l9.697"></a><span id="l9.697">     let item = this.mView.currentItem;</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-    let isServer = item &amp;&amp; item.folder &amp;&amp; item.folder.isServer;</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-    let disable;</span>
<a href="#l9.700"></a><span id="l9.700">     this.updateFeedData(item);</span>
<a href="#l9.701"></a><span id="l9.701">     this.setSummaryFocus();</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineminus">-    disable = !item || !item.container;</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineplus">+    this.updateButtons(item);</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineplus">+  },</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineplus">+</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+  updateButtons: function (aSelectedItem)</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+  {</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineplus">+    let item = aSelectedItem;</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineplus">+    let isServer = item &amp;&amp; item.folder &amp;&amp; item.folder.isServer;</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+    let disable = !item || !item.container ||</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+                  this.mActionMode == this.kImportingOPML;</span>
<a href="#l9.712"></a><span id="l9.712">     document.getElementById(&quot;addFeed&quot;).disabled = disable;</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-    disable = !item || item.container;</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineplus">+    disable = !item || item.container ||</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineplus">+              this.mActionMode == this.kImportingOPML;</span>
<a href="#l9.716"></a><span id="l9.716">     document.getElementById(&quot;editFeed&quot;).disabled = disable;</span>
<a href="#l9.717"></a><span id="l9.717">     document.getElementById(&quot;removeFeed&quot;).disabled = disable;</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineminus">-    document.getElementById(&quot;importOPML&quot;).disabled = !item || !isServer;</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineminus">-    document.getElementById(&quot;exportOPML&quot;).disabled = !item || !isServer;</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineplus">+    disable = !item || !isServer ||</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineplus">+              this.mActionMode == this.kImportingOPML;</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+    document.getElementById(&quot;importOPML&quot;).disabled = disable;</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+    document.getElementById(&quot;exportOPML&quot;).disabled = disable;</span>
<a href="#l9.724"></a><span id="l9.724">   },</span>
<a href="#l9.725"></a><span id="l9.725"> </span>
<a href="#l9.726"></a><span id="l9.726">   onMouseDown: function (aEvent)</span>
<a href="#l9.727"></a><span id="l9.727">   {</span>
<a href="#l9.728"></a><span id="l9.728">     if (aEvent.button != 0 || aEvent.target.id == &quot;validationText&quot;)</span>
<a href="#l9.729"></a><span id="l9.729">       return;</span>
<a href="#l9.730"></a><span id="l9.730"> </span>
<a href="#l9.731"></a><span id="l9.731">     this.clearStatusInfo();</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineat">@@ -1111,33 +1222,34 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.733"></a><span id="l9.733">     }</span>
<a href="#l9.734"></a><span id="l9.734"> </span>
<a href="#l9.735"></a><span id="l9.735">     let updated = false;</span>
<a href="#l9.736"></a><span id="l9.736">     // Check to see if the title value changed.</span>
<a href="#l9.737"></a><span id="l9.737">     if (feed.title != editNameValue)</span>
<a href="#l9.738"></a><span id="l9.738">     {</span>
<a href="#l9.739"></a><span id="l9.739">       feed.title = editNameValue;</span>
<a href="#l9.740"></a><span id="l9.740">       itemToEdit.name = editNameValue;</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineplus">+      seln.tree.invalidateRow(seln.currentIndex);</span>
<a href="#l9.742"></a><span id="l9.742">       updated = true;</span>
<a href="#l9.743"></a><span id="l9.743">     }</span>
<a href="#l9.744"></a><span id="l9.744"> </span>
<a href="#l9.745"></a><span id="l9.745">     // Check to see if the quickMode value changed.</span>
<a href="#l9.746"></a><span id="l9.746">     if (feed.quickMode != editQuickMode)</span>
<a href="#l9.747"></a><span id="l9.747">     {</span>
<a href="#l9.748"></a><span id="l9.748">       feed.quickMode = editQuickMode;</span>
<a href="#l9.749"></a><span id="l9.749">       itemToEdit.quickMode = editQuickMode;</span>
<a href="#l9.750"></a><span id="l9.750">       updated = true;</span>
<a href="#l9.751"></a><span id="l9.751">     }</span>
<a href="#l9.752"></a><span id="l9.752"> </span>
<a href="#l9.753"></a><span id="l9.753">     // Did the user change the folder URI for storing the feed?</span>
<a href="#l9.754"></a><span id="l9.754">     let editFolderURI = selectFolder.getAttribute(&quot;uri&quot;);</span>
<a href="#l9.755"></a><span id="l9.755">     if (currentFolderURI != editFolderURI)</span>
<a href="#l9.756"></a><span id="l9.756">     {</span>
<a href="#l9.757"></a><span id="l9.757">       // Make sure the new folderpicked folder is visible.</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineminus">-      this.selectFolder(selectFolder._folder, true);</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+      this.selectFolder(selectFolder._folder);</span>
<a href="#l9.760"></a><span id="l9.760">       // Now go back to the feed item.</span>
<a href="#l9.761"></a><span id="l9.761">       this.selectFeed(feed, null);</span>
<a href="#l9.762"></a><span id="l9.762">       // We need to find the index of the new parent folder.</span>
<a href="#l9.763"></a><span id="l9.763">       let newParentIndex = this.mView.kRowIndexUndefined;</span>
<a href="#l9.764"></a><span id="l9.764">       for (let index = 0; index &lt; this.mView.rowCount; index++)</span>
<a href="#l9.765"></a><span id="l9.765">       {</span>
<a href="#l9.766"></a><span id="l9.766">         let item = this.mView.getItemAtIndex(index);</span>
<a href="#l9.767"></a><span id="l9.767">         if (item &amp;&amp; item.container &amp;&amp; item.url == editFolderURI)</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineat">@@ -1235,17 +1347,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.769"></a><span id="l9.769">       if (aNewParentIndex &gt; aOldFeedIndex)</span>
<a href="#l9.770"></a><span id="l9.770">         aNewParentIndex--;</span>
<a href="#l9.771"></a><span id="l9.771">     }</span>
<a href="#l9.772"></a><span id="l9.772"> </span>
<a href="#l9.773"></a><span id="l9.773">     if (accountMoveCopy)</span>
<a href="#l9.774"></a><span id="l9.774">     {</span>
<a href="#l9.775"></a><span id="l9.775">       // If a cross account move/copy, download callback will update the view</span>
<a href="#l9.776"></a><span id="l9.776">       // with the new location.  Preselect folder/mode for callback.</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-      this.selectFolder(newFolder, true, aNewParentIndex);</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+      this.selectFolder(newFolder, { parentIndex: aNewParentIndex });</span>
<a href="#l9.779"></a><span id="l9.779">       return;</span>
<a href="#l9.780"></a><span id="l9.780">     }</span>
<a href="#l9.781"></a><span id="l9.781"> </span>
<a href="#l9.782"></a><span id="l9.782">     // Add the new row location to the view.</span>
<a href="#l9.783"></a><span id="l9.783">     currentItem.level = newParentItem.level + 1;</span>
<a href="#l9.784"></a><span id="l9.784">     currentItem.parentFolder = newFolder;</span>
<a href="#l9.785"></a><span id="l9.785">     this.updateFolderQuickModeInView(currentItem, newParentItem, false);</span>
<a href="#l9.786"></a><span id="l9.786">     newParentItem.children.push(currentItem);</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineat">@@ -1311,17 +1423,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.788"></a><span id="l9.788">   },</span>
<a href="#l9.789"></a><span id="l9.789"> </span>
<a href="#l9.790"></a><span id="l9.790">   mFeedDownloadCallback:</span>
<a href="#l9.791"></a><span id="l9.791">   {</span>
<a href="#l9.792"></a><span id="l9.792">     downloaded: function(feed, aErrorCode)</span>
<a href="#l9.793"></a><span id="l9.793">     {</span>
<a href="#l9.794"></a><span id="l9.794">       // Feed is null if our attempt to parse the feed failed.</span>
<a href="#l9.795"></a><span id="l9.795">       let message = &quot;&quot;;</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineminus">-      let win = gFeedSubscriptionsWindow;</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+      let win = FeedSubscriptions;</span>
<a href="#l9.798"></a><span id="l9.798">       if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l9.799"></a><span id="l9.799">       {</span>
<a href="#l9.800"></a><span id="l9.800">         win.updateStatusItem(&quot;progressMeter&quot;, 100);</span>
<a href="#l9.801"></a><span id="l9.801"> </span>
<a href="#l9.802"></a><span id="l9.802">         // If we get here we should always have a folder by now, either in</span>
<a href="#l9.803"></a><span id="l9.803">         // feed.folder or FeedItems created the folder for us.</span>
<a href="#l9.804"></a><span id="l9.804">         FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l9.805"></a><span id="l9.805"> </span>
<a href="#l9.806"></a><span id="l9.806" class="difflineat">@@ -1336,17 +1448,18 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.807"></a><span id="l9.807">         let curItem = win.mView.getItemAtIndex(curIndex);</span>
<a href="#l9.808"></a><span id="l9.808">         if (curItem)</span>
<a href="#l9.809"></a><span id="l9.809">         {</span>
<a href="#l9.810"></a><span id="l9.810">           let parentIndex, parentItem, newItem, level;</span>
<a href="#l9.811"></a><span id="l9.811">           let rows = win.mFeedContainers;</span>
<a href="#l9.812"></a><span id="l9.812">           if (curItem.container)</span>
<a href="#l9.813"></a><span id="l9.813">           {</span>
<a href="#l9.814"></a><span id="l9.814">             // Open the container, if it exists.</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineminus">-            let folderExists = win.selectFolder(feed.folder, true, curIndex);</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineplus">+            let folderExists = win.selectFolder(feed.folder,</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineplus">+                                                { parentIndex: curIndex });</span>
<a href="#l9.818"></a><span id="l9.818">             if (!folderExists)</span>
<a href="#l9.819"></a><span id="l9.819">             {</span>
<a href="#l9.820"></a><span id="l9.820">               // This means a new folder was created.</span>
<a href="#l9.821"></a><span id="l9.821">               parentIndex = curIndex;</span>
<a href="#l9.822"></a><span id="l9.822">               parentItem = curItem;</span>
<a href="#l9.823"></a><span id="l9.823">               level = curItem.level + 1;</span>
<a href="#l9.824"></a><span id="l9.824">               newItem = win.makeFolderObject(feed.folder, level);</span>
<a href="#l9.825"></a><span id="l9.825">             }</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineat">@@ -1366,18 +1479,20 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.827"></a><span id="l9.827">           else</span>
<a href="#l9.828"></a><span id="l9.828">           {</span>
<a href="#l9.829"></a><span id="l9.829">             parentIndex = win.mView.getParentIndex(curIndex);</span>
<a href="#l9.830"></a><span id="l9.830">             parentItem = win.mView.getItemAtIndex(parentIndex);</span>
<a href="#l9.831"></a><span id="l9.831">             level = curItem.level;</span>
<a href="#l9.832"></a><span id="l9.832">             newItem = win.makeFeedObject(feed, feed.folder, level);</span>
<a href="#l9.833"></a><span id="l9.833">           }</span>
<a href="#l9.834"></a><span id="l9.834"> </span>
<a href="#l9.835"></a><span id="l9.835" class="difflineminus">-          win.updateFolderQuickModeInView(newItem, parentItem, false);</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineplus">+          if (!newItem.container)</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+            win.updateFolderQuickModeInView(newItem, parentItem, false);</span>
<a href="#l9.838"></a><span id="l9.838">           parentItem.children.push(newItem);</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineplus">+          parentItem.children = win.folderItemSorter(parentItem.children)</span>
<a href="#l9.840"></a><span id="l9.840"> </span>
<a href="#l9.841"></a><span id="l9.841">           if (win.mActionMode == win.kSubscribeMode)</span>
<a href="#l9.842"></a><span id="l9.842">             message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l9.843"></a><span id="l9.843">                         &quot;subscribe-feedAdded&quot;);</span>
<a href="#l9.844"></a><span id="l9.844">           if (win.mActionMode == win.kUpdateMode)</span>
<a href="#l9.845"></a><span id="l9.845">           {</span>
<a href="#l9.846"></a><span id="l9.846">             win.removeFeed(false);</span>
<a href="#l9.847"></a><span id="l9.847">             message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineat">@@ -1422,46 +1537,52 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.849"></a><span id="l9.849">     // disk.  aCurrentFeedItems is an integer corresponding to how many feed</span>
<a href="#l9.850"></a><span id="l9.850">     // items have been downloaded so far.  aMaxFeedItems is an integer</span>
<a href="#l9.851"></a><span id="l9.851">     // corresponding to the total number of feed items to download.</span>
<a href="#l9.852"></a><span id="l9.852">     onFeedItemStored: function (feed, aCurrentFeedItems, aMaxFeedItems)</span>
<a href="#l9.853"></a><span id="l9.853">     {</span>
<a href="#l9.854"></a><span id="l9.854">       let message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.855"></a><span id="l9.855">                       &quot;subscribe-gettingFeedItems&quot;,</span>
<a href="#l9.856"></a><span id="l9.856">                       [aCurrentFeedItems, aMaxFeedItems], 2);</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineminus">-      gFeedSubscriptionsWindow.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineplus">+      FeedSubscriptions.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l9.859"></a><span id="l9.859">       this.onProgress(feed, aCurrentFeedItems, aMaxFeedItems);</span>
<a href="#l9.860"></a><span id="l9.860">     },</span>
<a href="#l9.861"></a><span id="l9.861"> </span>
<a href="#l9.862"></a><span id="l9.862">     onProgress: function(feed, aProgress, aProgressMax, aLengthComputable)</span>
<a href="#l9.863"></a><span id="l9.863">     {</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineminus">-      gFeedSubscriptionsWindow.updateStatusItem(&quot;progressMeter&quot;,</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineminus">-                                                (aProgress * 100) / aProgressMax);</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineplus">+      FeedSubscriptions.updateStatusItem(&quot;progressMeter&quot;,</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineplus">+                                         (aProgress * 100) / aProgressMax);</span>
<a href="#l9.868"></a><span id="l9.868">     }</span>
<a href="#l9.869"></a><span id="l9.869">   },</span>
<a href="#l9.870"></a><span id="l9.870"> </span>
<a href="#l9.871"></a><span id="l9.871">   // Status routines.</span>
<a href="#l9.872"></a><span id="l9.872">   updateStatusItem: function(aID, aValue, aErrorCode)</span>
<a href="#l9.873"></a><span id="l9.873">   {</span>
<a href="#l9.874"></a><span id="l9.874">     let el = document.getElementById(aID);</span>
<a href="#l9.875"></a><span id="l9.875">     if (el.getAttribute(&quot;collapsed&quot;))</span>
<a href="#l9.876"></a><span id="l9.876">       el.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l9.877"></a><span id="l9.877"> </span>
<a href="#l9.878"></a><span id="l9.878" class="difflineminus">-    el.value = aValue;</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineplus">+    if (aID == &quot;progressMeter&quot;)</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineplus">+      el.setAttribute(&quot;mode&quot;, aValue == &quot;?&quot; ? &quot;undetermined&quot; : &quot;determined&quot;);</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineplus">+</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineplus">+    if (aID == &quot;statusText&quot;)</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineplus">+      el.textContent = aValue;</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineplus">+    else</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+      el.value = aValue;</span>
<a href="#l9.886"></a><span id="l9.886"> </span>
<a href="#l9.887"></a><span id="l9.887">     el = document.getElementById(&quot;validationText&quot;);</span>
<a href="#l9.888"></a><span id="l9.888">     if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed)</span>
<a href="#l9.889"></a><span id="l9.889">       el.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l9.890"></a><span id="l9.890">     else</span>
<a href="#l9.891"></a><span id="l9.891">       el.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l9.892"></a><span id="l9.892">   },</span>
<a href="#l9.893"></a><span id="l9.893"> </span>
<a href="#l9.894"></a><span id="l9.894">   clearStatusInfo: function()</span>
<a href="#l9.895"></a><span id="l9.895">   {</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineminus">-    document.getElementById(&quot;statusText&quot;).value = &quot;&quot;;</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineplus">+    document.getElementById(&quot;statusText&quot;).textContent = &quot;&quot;;</span>
<a href="#l9.898"></a><span id="l9.898">     document.getElementById(&quot;progressMeter&quot;).collapsed = true;</span>
<a href="#l9.899"></a><span id="l9.899">     document.getElementById(&quot;validationText&quot;).collapsed = true;</span>
<a href="#l9.900"></a><span id="l9.900">   },</span>
<a href="#l9.901"></a><span id="l9.901"> </span>
<a href="#l9.902"></a><span id="l9.902">   checkValidation: function(aEvent)</span>
<a href="#l9.903"></a><span id="l9.903">   {</span>
<a href="#l9.904"></a><span id="l9.904">     if (aEvent.button != 0)</span>
<a href="#l9.905"></a><span id="l9.905">       return;</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineat">@@ -1475,401 +1596,771 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l9.907"></a><span id="l9.907">       let tabmail = win.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l9.908"></a><span id="l9.908">       if (tabmail)</span>
<a href="#l9.909"></a><span id="l9.909">       {</span>
<a href="#l9.910"></a><span id="l9.910">         let feedLocation = document.getElementById(&quot;locationValue&quot;).value;</span>
<a href="#l9.911"></a><span id="l9.911">         let url = validationQuery + feedLocation;</span>
<a href="#l9.912"></a><span id="l9.912"> </span>
<a href="#l9.913"></a><span id="l9.913">         win.focus();</span>
<a href="#l9.914"></a><span id="l9.914">         win.openContentTab(url, &quot;tab&quot;, &quot;^&quot; + validationSite);</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineminus">-        FeedUtils.log.debug(&quot;checkValidation: query url - &quot;+url);</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineplus">+        FeedUtils.log.debug(&quot;checkValidation: query url - &quot; + url);</span>
<a href="#l9.917"></a><span id="l9.917">       }</span>
<a href="#l9.918"></a><span id="l9.918">     }</span>
<a href="#l9.919"></a><span id="l9.919">     aEvent.stopPropagation();</span>
<a href="#l9.920"></a><span id="l9.920">   },</span>
<a href="#l9.921"></a><span id="l9.921"> </span>
<a href="#l9.922"></a><span id="l9.922">   // Listener for folder pane changes.</span>
<a href="#l9.923"></a><span id="l9.923">   FolderListener: {</span>
<a href="#l9.924"></a><span id="l9.924">     get feedWindow() {</span>
<a href="#l9.925"></a><span id="l9.925">       if (this._feedWindow)</span>
<a href="#l9.926"></a><span id="l9.926">         return this._feedWindow;</span>
<a href="#l9.927"></a><span id="l9.927">       let subscriptionsWindow =</span>
<a href="#l9.928"></a><span id="l9.928">         Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l9.929"></a><span id="l9.929">       if (subscriptionsWindow)</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineminus">-        return this._feedWindow = subscriptionsWindow.gFeedSubscriptionsWindow;</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineplus">+        return this._feedWindow = subscriptionsWindow.FeedSubscriptions;</span>
<a href="#l9.932"></a><span id="l9.932">       return null;</span>
<a href="#l9.933"></a><span id="l9.933">     },</span>
<a href="#l9.934"></a><span id="l9.934"> </span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+    get currentSelectedIndex() {</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+      return this.feedWindow ? this.feedWindow.mView.selection.currentIndex : -1;</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineplus">+    },</span>
<a href="#l9.938"></a><span id="l9.938" class="difflineplus">+</span>
<a href="#l9.939"></a><span id="l9.939">     get currentSelectedItem() {</span>
<a href="#l9.940"></a><span id="l9.940">       return this.feedWindow ? this.feedWindow.mView.currentItem : null;</span>
<a href="#l9.941"></a><span id="l9.941">     },</span>
<a href="#l9.942"></a><span id="l9.942"> </span>
<a href="#l9.943"></a><span id="l9.943">     folderAdded: function(aFolder)</span>
<a href="#l9.944"></a><span id="l9.944">     {</span>
<a href="#l9.945"></a><span id="l9.945" class="difflineminus">-      if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aFolder))</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineplus">+      if (aFolder.server.type != &quot;rss&quot; ||</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineplus">+          FeedUtils.isInTrash(aFolder))</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineplus">+        return;</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineplus">+</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineplus">+      let parentFolder = aFolder.isServer ? aFolder : aFolder.parent;</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+      FeedUtils.log.debug(&quot;folderAdded: folder:parent - &quot; + aFolder.name + &quot;:&quot; +</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineplus">+                          (parentFolder ? parentFolder.filePath.path : &quot;(null)&quot;));</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineplus">+      let feedWindow = this.feedWindow;</span>
<a href="#l9.954"></a><span id="l9.954" class="difflineplus">+</span>
<a href="#l9.955"></a><span id="l9.955" class="difflineplus">+      if (!parentFolder)</span>
<a href="#l9.956"></a><span id="l9.956">         return;</span>
<a href="#l9.957"></a><span id="l9.957" class="difflineminus">-      FeedUtils.log.debug(&quot;folderAdded: folder - &quot;+ aFolder.name);</span>
<a href="#l9.958"></a><span id="l9.958" class="difflineminus">-      this.feedWindow.refreshSubscriptionView();</span>
<a href="#l9.959"></a><span id="l9.959" class="difflineplus">+</span>
<a href="#l9.960"></a><span id="l9.960" class="difflineplus">+      let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineplus">+      let curSelItem = this.currentSelectedItem;</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineplus">+      let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineplus">+      let indexInView = feedWindow.mView.getItemInViewIndex(parentFolder);</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineplus">+      let open = indexInView != null;</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineplus">+</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineplus">+      if (aFolder.isServer)</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineplus">+      {</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineplus">+        if (indexInView)</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineplus">+          // Existing account root folder in the view.</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineplus">+          open = feedWindow.mView.getItemAtIndex(indexInView).open;</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineplus">+        else</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineplus">+        {</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineplus">+          // Add the account root folder to the view.</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineplus">+          feedWindow.mFeedContainers.push(feedWindow.makeFolderObject(parentFolder, 0));</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+          feedWindow.mView.mRowCount++;</span>
<a href="#l9.976"></a><span id="l9.976" class="difflineplus">+          feedWindow.mTree.view = feedWindow.mView;</span>
<a href="#l9.977"></a><span id="l9.977" class="difflineplus">+          feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l9.978"></a><span id="l9.978" class="difflineplus">+          return;</span>
<a href="#l9.979"></a><span id="l9.979" class="difflineplus">+        }</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineplus">+      }</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineplus">+</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineplus">+      // Rebuild the added folder's parent item in the tree row cache.</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineplus">+      feedWindow.selectFolder(parentFolder, { select: false,</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineplus">+                                              open: open,</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineplus">+                                              newFolder: parentFolder });</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineplus">+</span>
<a href="#l9.987"></a><span id="l9.987" class="difflineplus">+      if (indexInView == null || !curSelItem)</span>
<a href="#l9.988"></a><span id="l9.988" class="difflineplus">+        // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineplus">+        return;</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineplus">+</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+      let parentIndex = feedWindow.mView.getParentIndex(indexInView);</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+      if (parentIndex == feedWindow.mView.kRowIndexUndefined)</span>
<a href="#l9.993"></a><span id="l9.993" class="difflineplus">+        // Root folder is its own parent.</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineplus">+        parentIndex = indexInView;</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineplus">+      if (open)</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineplus">+      {</span>
<a href="#l9.997"></a><span id="l9.997" class="difflineplus">+        // Close an open parent (or root) folder.</span>
<a href="#l9.998"></a><span id="l9.998" class="difflineplus">+        feedWindow.mView.toggle(parentIndex);</span>
<a href="#l9.999"></a><span id="l9.999" class="difflineplus">+        feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l9.1000"></a><span id="l9.1000" class="difflineplus">+      }</span>
<a href="#l9.1001"></a><span id="l9.1001" class="difflineplus">+      feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l9.1002"></a><span id="l9.1002" class="difflineplus">+</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineplus">+      if (curSelItem.container)</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineplus">+        feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineplus">+      else</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineplus">+        feedWindow.selectFeed({ folder: curSelItem.parentFolder,</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineplus">+                                url: curSelItem.url }, parentIndex);</span>
<a href="#l9.1008"></a><span id="l9.1008">     },</span>
<a href="#l9.1009"></a><span id="l9.1009"> </span>
<a href="#l9.1010"></a><span id="l9.1010">     folderDeleted: function(aFolder)</span>
<a href="#l9.1011"></a><span id="l9.1011">     {</span>
<a href="#l9.1012"></a><span id="l9.1012">       if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aFolder))</span>
<a href="#l9.1013"></a><span id="l9.1013">         return;</span>
<a href="#l9.1014"></a><span id="l9.1014" class="difflineminus">-      FeedUtils.log.debug(&quot;folderDeleted: folder - &quot;+ aFolder.name);</span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineminus">-      let curSelItem = this.currentSelectedItem;</span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineplus">+</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineplus">+      FeedUtils.log.debug(&quot;folderDeleted: folder - &quot; + aFolder.name);</span>
<a href="#l9.1018"></a><span id="l9.1018">       let feedWindow = this.feedWindow;</span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineminus">-      if (curSelItem &amp;&amp; curSelItem.container &amp;&amp; curSelItem.folder == aFolder)</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineminus">-      {</span>
<a href="#l9.1021"></a><span id="l9.1021" class="difflineminus">-        let curSelIndex = this.feedWindow.mView.selection.currentIndex;</span>
<a href="#l9.1022"></a><span id="l9.1022" class="difflineminus">-        this.feedWindow.mView.removeItemAtIndex(curSelIndex);</span>
<a href="#l9.1023"></a><span id="l9.1023" class="difflineminus">-      }</span>
<a href="#l9.1024"></a><span id="l9.1024" class="difflineminus">-      else</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineminus">-        setTimeout(function() {</span>
<a href="#l9.1026"></a><span id="l9.1026" class="difflineminus">-          feedWindow.refreshSubscriptionView();</span>
<a href="#l9.1027"></a><span id="l9.1027" class="difflineminus">-        }, 20);</span>
<a href="#l9.1028"></a><span id="l9.1028" class="difflineplus">+      let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l9.1029"></a><span id="l9.1029" class="difflineplus">+      let indexInView = feedWindow.mView.getItemInViewIndex(aFolder);</span>
<a href="#l9.1030"></a><span id="l9.1030" class="difflineplus">+      let open = indexInView != null;</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineplus">+</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineplus">+      // Delete the folder from the tree row cache.</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineplus">+      feedWindow.selectFolder(aFolder, { select: false, open: false, remove: true });</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineplus">+</span>
<a href="#l9.1035"></a><span id="l9.1035" class="difflineplus">+      if (!open || curSelIndex &lt; 0)</span>
<a href="#l9.1036"></a><span id="l9.1036" class="difflineplus">+        // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l9.1037"></a><span id="l9.1037" class="difflineplus">+        return;</span>
<a href="#l9.1038"></a><span id="l9.1038" class="difflineplus">+</span>
<a href="#l9.1039"></a><span id="l9.1039" class="difflineplus">+      let select =</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineplus">+        indexInView == curSelIndex ||</span>
<a href="#l9.1041"></a><span id="l9.1041" class="difflineplus">+        feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l9.1042"></a><span id="l9.1042" class="difflineplus">+      feedWindow.mView.removeItemAtIndex(indexInView, !select);</span>
<a href="#l9.1043"></a><span id="l9.1043">     },</span>
<a href="#l9.1044"></a><span id="l9.1044"> </span>
<a href="#l9.1045"></a><span id="l9.1045">     folderRenamed: function(aOrigFolder, aNewFolder)</span>
<a href="#l9.1046"></a><span id="l9.1046">     {</span>
<a href="#l9.1047"></a><span id="l9.1047">       if (aNewFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aNewFolder))</span>
<a href="#l9.1048"></a><span id="l9.1048">         return;</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineminus">-      FeedUtils.log.debug(&quot;folderRenamed: old:new - &quot;+</span>
<a href="#l9.1050"></a><span id="l9.1050" class="difflineminus">-                          aOrigFolder.name+&quot;:&quot;+aNewFolder.name);</span>
<a href="#l9.1051"></a><span id="l9.1051" class="difflineminus">-      let curSelItem = this.currentSelectedItem;</span>
<a href="#l9.1052"></a><span id="l9.1052" class="difflineplus">+</span>
<a href="#l9.1053"></a><span id="l9.1053" class="difflineplus">+      FeedUtils.log.debug(&quot;folderRenamed: old:new - &quot; +</span>
<a href="#l9.1054"></a><span id="l9.1054" class="difflineplus">+                          aOrigFolder.name + &quot;:&quot; + aNewFolder.name);</span>
<a href="#l9.1055"></a><span id="l9.1055">       let feedWindow = this.feedWindow;</span>
<a href="#l9.1056"></a><span id="l9.1056" class="difflineminus">-      setTimeout(function() {</span>
<a href="#l9.1057"></a><span id="l9.1057" class="difflineminus">-        feedWindow.refreshSubscriptionView();</span>
<a href="#l9.1058"></a><span id="l9.1058" class="difflineminus">-        if (curSelItem &amp;&amp; curSelItem.container &amp;&amp;</span>
<a href="#l9.1059"></a><span id="l9.1059" class="difflineminus">-            curSelItem.folder == aOrigFolder)</span>
<a href="#l9.1060"></a><span id="l9.1060" class="difflineminus">-          feedWindow.selectFolder(aNewFolder, true, null, false);</span>
<a href="#l9.1061"></a><span id="l9.1061" class="difflineminus">-      }, 20);</span>
<a href="#l9.1062"></a><span id="l9.1062" class="difflineplus">+      let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l9.1063"></a><span id="l9.1063" class="difflineplus">+      let curSelItem = this.currentSelectedItem;</span>
<a href="#l9.1064"></a><span id="l9.1064" class="difflineplus">+      let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.1065"></a><span id="l9.1065" class="difflineplus">+      let indexInView = feedWindow.mView.getItemInViewIndex(aOrigFolder);</span>
<a href="#l9.1066"></a><span id="l9.1066" class="difflineplus">+      let open = indexInView != null;</span>
<a href="#l9.1067"></a><span id="l9.1067" class="difflineplus">+</span>
<a href="#l9.1068"></a><span id="l9.1068" class="difflineplus">+      // Rebuild the renamed folder's item in the tree row cache.</span>
<a href="#l9.1069"></a><span id="l9.1069" class="difflineplus">+      feedWindow.selectFolder(aOrigFolder, { select: false,</span>
<a href="#l9.1070"></a><span id="l9.1070" class="difflineplus">+                                             open: open,</span>
<a href="#l9.1071"></a><span id="l9.1071" class="difflineplus">+                                             newFolder: aNewFolder });</span>
<a href="#l9.1072"></a><span id="l9.1072" class="difflineplus">+</span>
<a href="#l9.1073"></a><span id="l9.1073" class="difflineplus">+      if (!open || !curSelItem)</span>
<a href="#l9.1074"></a><span id="l9.1074" class="difflineplus">+        // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l9.1075"></a><span id="l9.1075" class="difflineplus">+        return;</span>
<a href="#l9.1076"></a><span id="l9.1076" class="difflineplus">+</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineplus">+      let select =</span>
<a href="#l9.1078"></a><span id="l9.1078" class="difflineplus">+        indexInView == curSelIndex ||</span>
<a href="#l9.1079"></a><span id="l9.1079" class="difflineplus">+        feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l9.1080"></a><span id="l9.1080" class="difflineplus">+      let parentIndex = feedWindow.mView.getParentIndex(indexInView);</span>
<a href="#l9.1081"></a><span id="l9.1081" class="difflineplus">+      if (parentIndex == feedWindow.mView.kRowIndexUndefined)</span>
<a href="#l9.1082"></a><span id="l9.1082" class="difflineplus">+        // Root folder is its own parent.</span>
<a href="#l9.1083"></a><span id="l9.1083" class="difflineplus">+        parentIndex = indexInView;</span>
<a href="#l9.1084"></a><span id="l9.1084" class="difflineplus">+      feedWindow.mView.toggle(parentIndex);</span>
<a href="#l9.1085"></a><span id="l9.1085" class="difflineplus">+      feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineplus">+      feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l9.1087"></a><span id="l9.1087" class="difflineplus">+</span>
<a href="#l9.1088"></a><span id="l9.1088" class="difflineplus">+      if (curSelItem.container) {</span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineplus">+        if (curSelItem.folder == aOrigFolder)</span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineplus">+          feedWindow.selectFolder(aNewFolder, { open: curSelItem.open });</span>
<a href="#l9.1091"></a><span id="l9.1091" class="difflineplus">+        else if (select)</span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineplus">+          feedWindow.mView.selection.select(indexInView);</span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+        else</span>
<a href="#l9.1094"></a><span id="l9.1094" class="difflineplus">+          feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l9.1095"></a><span id="l9.1095" class="difflineplus">+      }</span>
<a href="#l9.1096"></a><span id="l9.1096" class="difflineplus">+      else</span>
<a href="#l9.1097"></a><span id="l9.1097" class="difflineplus">+        feedWindow.selectFeed({ folder: curSelItem.parentFolder.rootFolder,</span>
<a href="#l9.1098"></a><span id="l9.1098" class="difflineplus">+                                url: curSelItem.url }, parentIndex);</span>
<a href="#l9.1099"></a><span id="l9.1099">     },</span>
<a href="#l9.1100"></a><span id="l9.1100"> </span>
<a href="#l9.1101"></a><span id="l9.1101">     folderMoveCopyCompleted: function(aMove, aSrcFolder, aDestFolder)</span>
<a href="#l9.1102"></a><span id="l9.1102">     {</span>
<a href="#l9.1103"></a><span id="l9.1103">       if (aDestFolder.server.type != &quot;rss&quot;)</span>
<a href="#l9.1104"></a><span id="l9.1104">         return;</span>
<a href="#l9.1105"></a><span id="l9.1105" class="difflineminus">-      FeedUtils.log.debug(&quot;folderMoveCopyCompleted: move:src:dest - &quot;+</span>
<a href="#l9.1106"></a><span id="l9.1106" class="difflineminus">-                          aMove+&quot;:&quot;+aSrcFolder.name+&quot;:&quot;+aDestFolder.name);</span>
<a href="#l9.1107"></a><span id="l9.1107" class="difflineplus">+</span>
<a href="#l9.1108"></a><span id="l9.1108" class="difflineplus">+      FeedUtils.log.debug(&quot;folderMoveCopyCompleted: move:src:dest - &quot; +</span>
<a href="#l9.1109"></a><span id="l9.1109" class="difflineplus">+                          aMove + &quot;:&quot; + aSrcFolder.name + &quot;:&quot; + aDestFolder.name);</span>
<a href="#l9.1110"></a><span id="l9.1110" class="difflineplus">+      let feedWindow = this.feedWindow;</span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineplus">+      let curSelIndex = this.currentSelectedIndex;</span>
<a href="#l9.1112"></a><span id="l9.1112">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l9.1113"></a><span id="l9.1113" class="difflineminus">-      let feedWindow = this.feedWindow;</span>
<a href="#l9.1114"></a><span id="l9.1114" class="difflineminus">-      if (aMove &amp;&amp; aDestFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l9.1115"></a><span id="l9.1115" class="difflineplus">+      let firstVisRow = feedWindow.mView.treeBox.getFirstVisibleRow();</span>
<a href="#l9.1116"></a><span id="l9.1116" class="difflineplus">+      let indexInView = feedWindow.mView.getItemInViewIndex(aSrcFolder);</span>
<a href="#l9.1117"></a><span id="l9.1117" class="difflineplus">+      let destIndexInView = feedWindow.mView.getItemInViewIndex(aDestFolder);</span>
<a href="#l9.1118"></a><span id="l9.1118" class="difflineplus">+      let open = indexInView != null || destIndexInView != null;</span>
<a href="#l9.1119"></a><span id="l9.1119" class="difflineplus">+      let parentIndex = feedWindow.mView.getItemInViewIndex(aDestFolder.parent);</span>
<a href="#l9.1120"></a><span id="l9.1120" class="difflineplus">+      let select =</span>
<a href="#l9.1121"></a><span id="l9.1121" class="difflineplus">+        indexInView == curSelIndex ||</span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineplus">+        feedWindow.mView.isIndexChildOfParentIndex(indexInView, curSelIndex);</span>
<a href="#l9.1123"></a><span id="l9.1123" class="difflineplus">+</span>
<a href="#l9.1124"></a><span id="l9.1124" class="difflineplus">+      if (aMove)</span>
<a href="#l9.1125"></a><span id="l9.1125">       {</span>
<a href="#l9.1126"></a><span id="l9.1126">         this.folderDeleted(aSrcFolder);</span>
<a href="#l9.1127"></a><span id="l9.1127" class="difflineminus">-        return</span>
<a href="#l9.1128"></a><span id="l9.1128" class="difflineplus">+        if (aDestFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l9.1129"></a><span id="l9.1129" class="difflineplus">+          return;</span>
<a href="#l9.1130"></a><span id="l9.1130">       }</span>
<a href="#l9.1131"></a><span id="l9.1131"> </span>
<a href="#l9.1132"></a><span id="l9.1132">       setTimeout(function() {</span>
<a href="#l9.1133"></a><span id="l9.1133" class="difflineminus">-        feedWindow.refreshSubscriptionView();</span>
<a href="#l9.1134"></a><span id="l9.1134" class="difflineminus">-        if (curSelItem &amp;&amp; curSelItem.container &amp;&amp;</span>
<a href="#l9.1135"></a><span id="l9.1135" class="difflineminus">-            curSelItem.folder == aSrcFolder)</span>
<a href="#l9.1136"></a><span id="l9.1136" class="difflineminus">-          feedWindow.selectFolder(aDestFolder);</span>
<a href="#l9.1137"></a><span id="l9.1137" class="difflineminus">-      }, 20);</span>
<a href="#l9.1138"></a><span id="l9.1138" class="difflineplus">+        // State on disk needs to settle before a folder object can be rebuilt.</span>
<a href="#l9.1139"></a><span id="l9.1139" class="difflineplus">+        feedWindow.selectFolder(aDestFolder, { select: false,</span>
<a href="#l9.1140"></a><span id="l9.1140" class="difflineplus">+                                               open: open || select,</span>
<a href="#l9.1141"></a><span id="l9.1141" class="difflineplus">+                                               newFolder: aDestFolder });</span>
<a href="#l9.1142"></a><span id="l9.1142" class="difflineplus">+</span>
<a href="#l9.1143"></a><span id="l9.1143" class="difflineplus">+        if (!open || !curSelItem)</span>
<a href="#l9.1144"></a><span id="l9.1144" class="difflineplus">+          // Folder isn't in the tree view, no need to update the view.</span>
<a href="#l9.1145"></a><span id="l9.1145" class="difflineplus">+          return;</span>
<a href="#l9.1146"></a><span id="l9.1146" class="difflineplus">+</span>
<a href="#l9.1147"></a><span id="l9.1147" class="difflineplus">+        feedWindow.mView.toggle(parentIndex);</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineplus">+        feedWindow.mView.toggleOpenState(parentIndex);</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineplus">+        feedWindow.mView.treeBox.scrollToRow(firstVisRow);</span>
<a href="#l9.1150"></a><span id="l9.1150" class="difflineplus">+</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineplus">+        if (curSelItem.container) {</span>
<a href="#l9.1152"></a><span id="l9.1152" class="difflineplus">+          if (curSelItem.folder == aSrcFolder || select)</span>
<a href="#l9.1153"></a><span id="l9.1153" class="difflineplus">+            feedWindow.selectFolder(aDestFolder, { open: true });</span>
<a href="#l9.1154"></a><span id="l9.1154" class="difflineplus">+          else</span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineplus">+            feedWindow.selectFolder(curSelItem.folder, { open: curSelItem.open });</span>
<a href="#l9.1156"></a><span id="l9.1156" class="difflineplus">+        }</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineplus">+        else</span>
<a href="#l9.1158"></a><span id="l9.1158" class="difflineplus">+          feedWindow.selectFeed({ folder: curSelItem.parentFolder.rootFolder,</span>
<a href="#l9.1159"></a><span id="l9.1159" class="difflineplus">+                                  url: curSelItem.url }, null);</span>
<a href="#l9.1160"></a><span id="l9.1160" class="difflineplus">+      }, 50);</span>
<a href="#l9.1161"></a><span id="l9.1161">     }</span>
<a href="#l9.1162"></a><span id="l9.1162">   },</span>
<a href="#l9.1163"></a><span id="l9.1163"> </span>
<a href="#l9.1164"></a><span id="l9.1164">   /* *************************************************************** */</span>
<a href="#l9.1165"></a><span id="l9.1165">   /* OPML Functions                                                  */</span>
<a href="#l9.1166"></a><span id="l9.1166">   /* *************************************************************** */</span>
<a href="#l9.1167"></a><span id="l9.1167"> </span>
<a href="#l9.1168"></a><span id="l9.1168">   get brandShortName() {</span>
<a href="#l9.1169"></a><span id="l9.1169">     let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l9.1170"></a><span id="l9.1170">     return brandBundle ? brandBundle.getString(&quot;brandShortName&quot;) : &quot;&quot;;</span>
<a href="#l9.1171"></a><span id="l9.1171">   },</span>
<a href="#l9.1172"></a><span id="l9.1172"> </span>
<a href="#l9.1173"></a><span id="l9.1173"> /**</span>
<a href="#l9.1174"></a><span id="l9.1174">  * Export feeds as opml file Save As filepicker function.</span>
<a href="#l9.1175"></a><span id="l9.1175">  * </span>
<a href="#l9.1176"></a><span id="l9.1176" class="difflineplus">+ * @param  bool aList - if true, exporting as list; if false (default)</span>
<a href="#l9.1177"></a><span id="l9.1177" class="difflineplus">+ *                      exporting feeds in folder structure - used for title.</span>
<a href="#l9.1178"></a><span id="l9.1178">  * @return nsILocalFile or null.</span>
<a href="#l9.1179"></a><span id="l9.1179">  */</span>
<a href="#l9.1180"></a><span id="l9.1180" class="difflineminus">-  opmlPickSaveAsFile: function() {</span>
<a href="#l9.1181"></a><span id="l9.1181" class="difflineplus">+  opmlPickSaveAsFile: function(aList)</span>
<a href="#l9.1182"></a><span id="l9.1182" class="difflineplus">+  {</span>
<a href="#l9.1183"></a><span id="l9.1183" class="difflineplus">+    let accountName = this.mRSSServer.rootFolder.prettyName;</span>
<a href="#l9.1184"></a><span id="l9.1184">     let fileName = FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.1185"></a><span id="l9.1185">                      &quot;subscribe-OPMLExportDefaultFileName&quot;,</span>
<a href="#l9.1186"></a><span id="l9.1186" class="difflineminus">-                     [this.brandShortName], 1);</span>
<a href="#l9.1187"></a><span id="l9.1187" class="difflineminus">-    let title = FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLExportTitle&quot;);</span>
<a href="#l9.1188"></a><span id="l9.1188" class="difflineplus">+                     [this.brandShortName, accountName], 2);</span>
<a href="#l9.1189"></a><span id="l9.1189" class="difflineplus">+    let title = aList ? FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.1190"></a><span id="l9.1190" class="difflineplus">+                          &quot;subscribe-OPMLExportTitleList&quot;, [accountName], 1) :</span>
<a href="#l9.1191"></a><span id="l9.1191" class="difflineplus">+                        FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.1192"></a><span id="l9.1192" class="difflineplus">+                          &quot;subscribe-OPMLExportTitleStruct&quot;, [accountName], 1);</span>
<a href="#l9.1193"></a><span id="l9.1193">     let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l9.1194"></a><span id="l9.1194"> </span>
<a href="#l9.1195"></a><span id="l9.1195">     fp.defaultString = fileName;</span>
<a href="#l9.1196"></a><span id="l9.1196" class="difflineplus">+    fp.defaultExtension = &quot;opml&quot;;</span>
<a href="#l9.1197"></a><span id="l9.1197">     if (this.opmlLastSaveAsDir &amp;&amp; (this.opmlLastSaveAsDir instanceof Ci.nsILocalFile))</span>
<a href="#l9.1198"></a><span id="l9.1198">       fp.displayDirectory = this.opmlLastSaveAsDir;</span>
<a href="#l9.1199"></a><span id="l9.1199"> </span>
<a href="#l9.1200"></a><span id="l9.1200" class="difflineplus">+    let opmlFilterText = FeedUtils.strings.GetStringFromName(</span>
<a href="#l9.1201"></a><span id="l9.1201" class="difflineplus">+                           &quot;subscribe-OPMLExportOPMLFilesFilterText&quot;);</span>
<a href="#l9.1202"></a><span id="l9.1202" class="difflineplus">+    fp.appendFilter(opmlFilterText, &quot;*.opml&quot;);</span>
<a href="#l9.1203"></a><span id="l9.1203">     fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l9.1204"></a><span id="l9.1204" class="difflineplus">+    fp.filterIndex = 0;</span>
<a href="#l9.1205"></a><span id="l9.1205">     fp.init(window, title, Ci.nsIFilePicker.modeSave);</span>
<a href="#l9.1206"></a><span id="l9.1206"> </span>
<a href="#l9.1207"></a><span id="l9.1207" class="difflineminus">-    if (fp.show() != Ci.nsIFilePicker.returnCancel &amp;&amp; fp.file) {</span>
<a href="#l9.1208"></a><span id="l9.1208" class="difflineplus">+    if (fp.show() != Ci.nsIFilePicker.returnCancel &amp;&amp; fp.file)</span>
<a href="#l9.1209"></a><span id="l9.1209" class="difflineplus">+    {</span>
<a href="#l9.1210"></a><span id="l9.1210">       this.opmlLastSaveAsDir = fp.file.parent;</span>
<a href="#l9.1211"></a><span id="l9.1211">       return fp.file;</span>
<a href="#l9.1212"></a><span id="l9.1212">     }</span>
<a href="#l9.1213"></a><span id="l9.1213"> </span>
<a href="#l9.1214"></a><span id="l9.1214">     return null;</span>
<a href="#l9.1215"></a><span id="l9.1215">   },</span>
<a href="#l9.1216"></a><span id="l9.1216"> </span>
<a href="#l9.1217"></a><span id="l9.1217"> /**</span>
<a href="#l9.1218"></a><span id="l9.1218">  * Import feeds opml file Open filepicker function.</span>
<a href="#l9.1219"></a><span id="l9.1219">  * </span>
<a href="#l9.1220"></a><span id="l9.1220">  * @return nsILocalFile or null.</span>
<a href="#l9.1221"></a><span id="l9.1221">  */</span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineminus">-  opmlPickOpenFile: function() {</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineplus">+  opmlPickOpenFile: function()</span>
<a href="#l9.1224"></a><span id="l9.1224" class="difflineplus">+  {</span>
<a href="#l9.1225"></a><span id="l9.1225">     let title = FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportTitle&quot;);</span>
<a href="#l9.1226"></a><span id="l9.1226">     let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l9.1227"></a><span id="l9.1227"> </span>
<a href="#l9.1228"></a><span id="l9.1228">     fp.defaultString = &quot;&quot;;</span>
<a href="#l9.1229"></a><span id="l9.1229">     if (this.opmlLastOpenDir &amp;&amp; (this.opmlLastOpenDir instanceof Ci.nsILocalFile))</span>
<a href="#l9.1230"></a><span id="l9.1230">       fp.displayDirectory = this.opmlLastOpenDir;</span>
<a href="#l9.1231"></a><span id="l9.1231"> </span>
<a href="#l9.1232"></a><span id="l9.1232">     let opmlFilterText = FeedUtils.strings.GetStringFromName(</span>
<a href="#l9.1233"></a><span id="l9.1233">                            &quot;subscribe-OPMLExportOPMLFilesFilterText&quot;);</span>
<a href="#l9.1234"></a><span id="l9.1234">     fp.appendFilter(opmlFilterText, &quot;*.opml&quot;);</span>
<a href="#l9.1235"></a><span id="l9.1235">     fp.appendFilters(Ci.nsIFilePicker.filterXML);</span>
<a href="#l9.1236"></a><span id="l9.1236">     fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l9.1237"></a><span id="l9.1237">     fp.init(window, title, Ci.nsIFilePicker.modeOpen);</span>
<a href="#l9.1238"></a><span id="l9.1238"> </span>
<a href="#l9.1239"></a><span id="l9.1239" class="difflineminus">-    if (fp.show() != Ci.nsIFilePicker.returnCancel &amp;&amp; fp.file) {</span>
<a href="#l9.1240"></a><span id="l9.1240" class="difflineplus">+    if (fp.show() != Ci.nsIFilePicker.returnCancel &amp;&amp; fp.file)</span>
<a href="#l9.1241"></a><span id="l9.1241" class="difflineplus">+    {</span>
<a href="#l9.1242"></a><span id="l9.1242">       this.opmlLastOpenDir = fp.file.parent;</span>
<a href="#l9.1243"></a><span id="l9.1243">       return fp.file;</span>
<a href="#l9.1244"></a><span id="l9.1244">     }</span>
<a href="#l9.1245"></a><span id="l9.1245"> </span>
<a href="#l9.1246"></a><span id="l9.1246">     return null;</span>
<a href="#l9.1247"></a><span id="l9.1247">   },</span>
<a href="#l9.1248"></a><span id="l9.1248"> </span>
<a href="#l9.1249"></a><span id="l9.1249" class="difflineminus">-  exportOPML: function()</span>
<a href="#l9.1250"></a><span id="l9.1250" class="difflineplus">+  exportOPML: function(aEvent)</span>
<a href="#l9.1251"></a><span id="l9.1251">   {</span>
<a href="#l9.1252"></a><span id="l9.1252">     // Account folder must be selected.</span>
<a href="#l9.1253"></a><span id="l9.1253">     let item = this.mView.currentItem;</span>
<a href="#l9.1254"></a><span id="l9.1254">     if (!item || !item.folder || !item.folder.isServer)</span>
<a href="#l9.1255"></a><span id="l9.1255">       return;</span>
<a href="#l9.1256"></a><span id="l9.1256"> </span>
<a href="#l9.1257"></a><span id="l9.1257">     this.mRSSServer = item.folder.server;</span>
<a href="#l9.1258"></a><span id="l9.1258" class="difflineplus">+    let rootFolder = this.mRSSServer.rootFolder;</span>
<a href="#l9.1259"></a><span id="l9.1259" class="difflineplus">+    let exportAsList = aEvent.ctrlKey;</span>
<a href="#l9.1260"></a><span id="l9.1260">     let SPACES2 = &quot;  &quot;;</span>
<a href="#l9.1261"></a><span id="l9.1261">     let SPACES4 = &quot;    &quot;;</span>
<a href="#l9.1262"></a><span id="l9.1262"> </span>
<a href="#l9.1263"></a><span id="l9.1263">     if (this.mRSSServer.rootFolder.hasSubFolders)</span>
<a href="#l9.1264"></a><span id="l9.1264">     {</span>
<a href="#l9.1265"></a><span id="l9.1265">       let opmlDoc = document.implementation.createDocument(&quot;&quot;, &quot;opml&quot;, null);</span>
<a href="#l9.1266"></a><span id="l9.1266">       let opmlRoot = opmlDoc.documentElement;</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineminus">-      opmlRoot.setAttribute(&quot;version&quot;,&quot;1.0&quot;);</span>
<a href="#l9.1268"></a><span id="l9.1268" class="difflineplus">+      opmlRoot.setAttribute(&quot;version&quot;, &quot;1.0&quot;);</span>
<a href="#l9.1269"></a><span id="l9.1269" class="difflineplus">+      opmlRoot.setAttribute(&quot;xmlns:fz&quot;, &quot;urn:forumzilla:&quot;);</span>
<a href="#l9.1270"></a><span id="l9.1270"> </span>
<a href="#l9.1271"></a><span id="l9.1271">       this.generatePPSpace(opmlRoot, SPACES2);</span>
<a href="#l9.1272"></a><span id="l9.1272"> </span>
<a href="#l9.1273"></a><span id="l9.1273">       // Make the &lt;head&gt; element.</span>
<a href="#l9.1274"></a><span id="l9.1274">       let head = opmlDoc.createElement(&quot;head&quot;);</span>
<a href="#l9.1275"></a><span id="l9.1275">       this.generatePPSpace(head, SPACES4);</span>
<a href="#l9.1276"></a><span id="l9.1276">       let titleText = FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.1277"></a><span id="l9.1277">                         &quot;subscribe-OPMLExportFileDialogTitle&quot;,</span>
<a href="#l9.1278"></a><span id="l9.1278" class="difflineminus">-                        [this.brandShortName], 1);</span>
<a href="#l9.1279"></a><span id="l9.1279" class="difflineplus">+                        [this.brandShortName, rootFolder.prettyName], 2);</span>
<a href="#l9.1280"></a><span id="l9.1280">       let title = opmlDoc.createElement(&quot;title&quot;);</span>
<a href="#l9.1281"></a><span id="l9.1281">       title.appendChild(opmlDoc.createTextNode(titleText));</span>
<a href="#l9.1282"></a><span id="l9.1282">       head.appendChild(title);</span>
<a href="#l9.1283"></a><span id="l9.1283">       this.generatePPSpace(head, SPACES4);</span>
<a href="#l9.1284"></a><span id="l9.1284">       let dt = opmlDoc.createElement(&quot;dateCreated&quot;);</span>
<a href="#l9.1285"></a><span id="l9.1285">       dt.appendChild(opmlDoc.createTextNode((new Date()).toGMTString()));</span>
<a href="#l9.1286"></a><span id="l9.1286">       head.appendChild(dt);</span>
<a href="#l9.1287"></a><span id="l9.1287">       this.generatePPSpace(head, SPACES2);</span>
<a href="#l9.1288"></a><span id="l9.1288">       opmlRoot.appendChild(head);</span>
<a href="#l9.1289"></a><span id="l9.1289"> </span>
<a href="#l9.1290"></a><span id="l9.1290">       this.generatePPSpace(opmlRoot, SPACES2);</span>
<a href="#l9.1291"></a><span id="l9.1291"> </span>
<a href="#l9.1292"></a><span id="l9.1292">       // Add &lt;outline&gt;s to the &lt;body&gt;.</span>
<a href="#l9.1293"></a><span id="l9.1293">       let body = opmlDoc.createElement(&quot;body&quot;);</span>
<a href="#l9.1294"></a><span id="l9.1294" class="difflineminus">-      this.generateOutline(this.mRSSServer.rootFolder, body, SPACES4.length);</span>
<a href="#l9.1295"></a><span id="l9.1295" class="difflineplus">+      if (exportAsList)</span>
<a href="#l9.1296"></a><span id="l9.1296" class="difflineplus">+        this.generateOutlineList(rootFolder, body, SPACES4.length + 2);</span>
<a href="#l9.1297"></a><span id="l9.1297" class="difflineplus">+      else</span>
<a href="#l9.1298"></a><span id="l9.1298" class="difflineplus">+        this.generateOutlineStruct(rootFolder, body, SPACES4.length);</span>
<a href="#l9.1299"></a><span id="l9.1299" class="difflineplus">+</span>
<a href="#l9.1300"></a><span id="l9.1300">       this.generatePPSpace(body, SPACES2);</span>
<a href="#l9.1301"></a><span id="l9.1301" class="difflineplus">+</span>
<a href="#l9.1302"></a><span id="l9.1302" class="difflineplus">+      if (!body.childElementCount)</span>
<a href="#l9.1303"></a><span id="l9.1303" class="difflineplus">+        // No folders/feeds.</span>
<a href="#l9.1304"></a><span id="l9.1304" class="difflineplus">+        return;</span>
<a href="#l9.1305"></a><span id="l9.1305" class="difflineplus">+</span>
<a href="#l9.1306"></a><span id="l9.1306">       opmlRoot.appendChild(body);</span>
<a href="#l9.1307"></a><span id="l9.1307" class="difflineminus">-</span>
<a href="#l9.1308"></a><span id="l9.1308">       this.generatePPSpace(opmlRoot, &quot;&quot;);</span>
<a href="#l9.1309"></a><span id="l9.1309"> </span>
<a href="#l9.1310"></a><span id="l9.1310" class="difflineplus">+      let serializer = new XMLSerializer();</span>
<a href="#l9.1311"></a><span id="l9.1311" class="difflineplus">+</span>
<a href="#l9.1312"></a><span id="l9.1312" class="difflineplus">+      if (FeedUtils.log.level &lt;= Log4Moz.Level.Debug)</span>
<a href="#l9.1313"></a><span id="l9.1313" class="difflineplus">+        FeedUtils.log.debug(&quot;exportOPML: opmlDoc -\n&quot; +</span>
<a href="#l9.1314"></a><span id="l9.1314" class="difflineplus">+                            serializer.serializeToString(opmlDoc) + &quot;\n&quot;);</span>
<a href="#l9.1315"></a><span id="l9.1315" class="difflineplus">+</span>
<a href="#l9.1316"></a><span id="l9.1316">       // Get file to save from filepicker.</span>
<a href="#l9.1317"></a><span id="l9.1317" class="difflineminus">-      let saveAsFile = this.opmlPickSaveAsFile();</span>
<a href="#l9.1318"></a><span id="l9.1318" class="difflineplus">+      let saveAsFile = this.opmlPickSaveAsFile(exportAsList);</span>
<a href="#l9.1319"></a><span id="l9.1319">       if (!saveAsFile)</span>
<a href="#l9.1320"></a><span id="l9.1320">         return;</span>
<a href="#l9.1321"></a><span id="l9.1321"> </span>
<a href="#l9.1322"></a><span id="l9.1322" class="difflineminus">-      let serializer = new XMLSerializer();</span>
<a href="#l9.1323"></a><span id="l9.1323">       let fos = FileUtils.openSafeFileOutputStream(saveAsFile);</span>
<a href="#l9.1324"></a><span id="l9.1324">       serializer.serializeToStream(opmlDoc, fos, &quot;utf-8&quot;);</span>
<a href="#l9.1325"></a><span id="l9.1325">       FileUtils.closeSafeFileOutputStream(fos);</span>
<a href="#l9.1326"></a><span id="l9.1326" class="difflineplus">+</span>
<a href="#l9.1327"></a><span id="l9.1327" class="difflineplus">+      let statusReport = FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.1328"></a><span id="l9.1328" class="difflineplus">+                           &quot;subscribe-OPMLExportDone&quot;, [saveAsFile.path], 1);</span>
<a href="#l9.1329"></a><span id="l9.1329" class="difflineplus">+      this.updateStatusItem(&quot;statusText&quot;, statusReport);</span>
<a href="#l9.1330"></a><span id="l9.1330">     }</span>
<a href="#l9.1331"></a><span id="l9.1331">   },</span>
<a href="#l9.1332"></a><span id="l9.1332"> </span>
<a href="#l9.1333"></a><span id="l9.1333">   generatePPSpace: function(aNode, indentString)</span>
<a href="#l9.1334"></a><span id="l9.1334">   {</span>
<a href="#l9.1335"></a><span id="l9.1335">     aNode.appendChild(aNode.ownerDocument.createTextNode(&quot;\n&quot;));</span>
<a href="#l9.1336"></a><span id="l9.1336">     aNode.appendChild(aNode.ownerDocument.createTextNode(indentString));</span>
<a href="#l9.1337"></a><span id="l9.1337">   },</span>
<a href="#l9.1338"></a><span id="l9.1338"> </span>
<a href="#l9.1339"></a><span id="l9.1339" class="difflineminus">-  generateOutline: function(baseFolder, parent, indentLevel)</span>
<a href="#l9.1340"></a><span id="l9.1340" class="difflineplus">+  generateOutlineList: function(baseFolder, parent, indentLevel)</span>
<a href="#l9.1341"></a><span id="l9.1341">   {</span>
<a href="#l9.1342"></a><span id="l9.1342" class="difflineminus">-    let folderEnumerator = baseFolder.subFolders;</span>
<a href="#l9.1343"></a><span id="l9.1343" class="difflineminus">-</span>
<a href="#l9.1344"></a><span id="l9.1344">     // Pretty printing.</span>
<a href="#l9.1345"></a><span id="l9.1345" class="difflineminus">-    let indentString = &quot;&quot;;</span>
<a href="#l9.1346"></a><span id="l9.1346" class="difflineminus">-    for (let i = 0; i &lt; indentLevel; i++)</span>
<a href="#l9.1347"></a><span id="l9.1347" class="difflineminus">-      indentString = indentString + &quot; &quot;;</span>
<a href="#l9.1348"></a><span id="l9.1348" class="difflineplus">+    let indentString = (new Array(indentLevel - 1)).join(&quot; &quot;);</span>
<a href="#l9.1349"></a><span id="l9.1349"> </span>
<a href="#l9.1350"></a><span id="l9.1350" class="difflineplus">+    let feedOutline;</span>
<a href="#l9.1351"></a><span id="l9.1351" class="difflineplus">+    let folderEnumerator = baseFolder.subFolders;</span>
<a href="#l9.1352"></a><span id="l9.1352">     while (folderEnumerator.hasMoreElements())</span>
<a href="#l9.1353"></a><span id="l9.1353">     {</span>
<a href="#l9.1354"></a><span id="l9.1354" class="difflineminus">-      let folder = folderEnumerator.getNext();</span>
<a href="#l9.1355"></a><span id="l9.1355" class="difflineminus">-      if ((folder instanceof Ci.nsIMsgFolder) &amp;&amp;</span>
<a href="#l9.1356"></a><span id="l9.1356" class="difflineminus">-          !folder.getFlag(Ci.nsMsgFolderFlags.Trash) &amp;&amp;</span>
<a href="#l9.1357"></a><span id="l9.1357" class="difflineminus">-          !folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l9.1358"></a><span id="l9.1358" class="difflineplus">+      let folder = folderEnumerator.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l9.1359"></a><span id="l9.1359" class="difflineplus">+      FeedUtils.log.debug(&quot;generateOutlineList: folder - &quot; +</span>
<a href="#l9.1360"></a><span id="l9.1360" class="difflineplus">+                          folder.filePath.path);</span>
<a href="#l9.1361"></a><span id="l9.1361" class="difflineplus">+      if (!(folder instanceof Ci.nsIMsgFolder) ||</span>
<a href="#l9.1362"></a><span id="l9.1362" class="difflineplus">+          folder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l9.1363"></a><span id="l9.1363" class="difflineplus">+          folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l9.1364"></a><span id="l9.1364" class="difflineplus">+        continue;</span>
<a href="#l9.1365"></a><span id="l9.1365" class="difflineplus">+</span>
<a href="#l9.1366"></a><span id="l9.1366" class="difflineplus">+      FeedUtils.log.debug(&quot;generateOutlineList: CONTINUE folderName - &quot; +</span>
<a href="#l9.1367"></a><span id="l9.1367" class="difflineplus">+                          folder.name);</span>
<a href="#l9.1368"></a><span id="l9.1368" class="difflineplus">+</span>
<a href="#l9.1369"></a><span id="l9.1369" class="difflineplus">+      if (folder.hasSubFolders)</span>
<a href="#l9.1370"></a><span id="l9.1370">       {</span>
<a href="#l9.1371"></a><span id="l9.1371" class="difflineminus">-        let outline;</span>
<a href="#l9.1372"></a><span id="l9.1372" class="difflineminus">-        if (folder.hasSubFolders)</span>
<a href="#l9.1373"></a><span id="l9.1373" class="difflineminus">-        {</span>
<a href="#l9.1374"></a><span id="l9.1374" class="difflineminus">-          // Make a mostly empty outline element.</span>
<a href="#l9.1375"></a><span id="l9.1375" class="difflineminus">-          outline = parent.ownerDocument.createElement(&quot;outline&quot;);</span>
<a href="#l9.1376"></a><span id="l9.1376" class="difflineminus">-          outline.setAttribute(&quot;text&quot;, folder.prettiestName);</span>
<a href="#l9.1377"></a><span id="l9.1377" class="difflineminus">-          // Recurse.</span>
<a href="#l9.1378"></a><span id="l9.1378" class="difflineminus">-          this.generateOutline(folder, outline, indentLevel + 2);</span>
<a href="#l9.1379"></a><span id="l9.1379" class="difflineminus">-          this.generatePPSpace(parent, indentString);</span>
<a href="#l9.1380"></a><span id="l9.1380" class="difflineminus">-          this.generatePPSpace(outline, indentString);</span>
<a href="#l9.1381"></a><span id="l9.1381" class="difflineminus">-          parent.appendChild(outline);</span>
<a href="#l9.1382"></a><span id="l9.1382" class="difflineminus">-        }</span>
<a href="#l9.1383"></a><span id="l9.1383" class="difflineminus">-        else</span>
<a href="#l9.1384"></a><span id="l9.1384" class="difflineminus">-        {</span>
<a href="#l9.1385"></a><span id="l9.1385" class="difflineminus">-          // Add outline elements with xmlUrls.</span>
<a href="#l9.1386"></a><span id="l9.1386" class="difflineminus">-          let feeds = this.getFeedsInFolder(folder);</span>
<a href="#l9.1387"></a><span id="l9.1387" class="difflineminus">-          for (let feed in feeds)</span>
<a href="#l9.1388"></a><span id="l9.1388" class="difflineminus">-          {</span>
<a href="#l9.1389"></a><span id="l9.1389" class="difflineminus">-            outline = this.opmlFeedToOutline(feeds[feed], parent.ownerDocument);</span>
<a href="#l9.1390"></a><span id="l9.1390" class="difflineminus">-            this.generatePPSpace(parent, indentString);</span>
<a href="#l9.1391"></a><span id="l9.1391" class="difflineminus">-            parent.appendChild(outline);</span>
<a href="#l9.1392"></a><span id="l9.1392" class="difflineminus">-          }</span>
<a href="#l9.1393"></a><span id="l9.1393" class="difflineminus">-        }</span>
<a href="#l9.1394"></a><span id="l9.1394" class="difflineplus">+        FeedUtils.log.debug(&quot;generateOutlineList: has subfolders - &quot; +</span>
<a href="#l9.1395"></a><span id="l9.1395" class="difflineplus">+                            folder.name);</span>
<a href="#l9.1396"></a><span id="l9.1396" class="difflineplus">+        // Recurse.</span>
<a href="#l9.1397"></a><span id="l9.1397" class="difflineplus">+        this.generateOutlineList(folder, parent, indentLevel);</span>
<a href="#l9.1398"></a><span id="l9.1398" class="difflineplus">+      }</span>
<a href="#l9.1399"></a><span id="l9.1399" class="difflineplus">+</span>
<a href="#l9.1400"></a><span id="l9.1400" class="difflineplus">+      // Add outline elements with xmlUrls.</span>
<a href="#l9.1401"></a><span id="l9.1401" class="difflineplus">+      let feeds = this.getFeedsInFolder(folder);</span>
<a href="#l9.1402"></a><span id="l9.1402" class="difflineplus">+      for (let feed in feeds)</span>
<a href="#l9.1403"></a><span id="l9.1403" class="difflineplus">+      {</span>
<a href="#l9.1404"></a><span id="l9.1404" class="difflineplus">+        FeedUtils.log.debug(&quot;generateOutlineList: folder has FEED url - &quot; +</span>
<a href="#l9.1405"></a><span id="l9.1405" class="difflineplus">+                            folder.name + &quot; : &quot; + feeds[feed].url);</span>
<a href="#l9.1406"></a><span id="l9.1406" class="difflineplus">+        feedOutline = this.exportOPMLOutline(feeds[feed], parent.ownerDocument);</span>
<a href="#l9.1407"></a><span id="l9.1407" class="difflineplus">+        this.generatePPSpace(parent, indentString);</span>
<a href="#l9.1408"></a><span id="l9.1408" class="difflineplus">+        parent.appendChild(feedOutline);</span>
<a href="#l9.1409"></a><span id="l9.1409">       }</span>
<a href="#l9.1410"></a><span id="l9.1410">     }</span>
<a href="#l9.1411"></a><span id="l9.1411">   },</span>
<a href="#l9.1412"></a><span id="l9.1412"> </span>
<a href="#l9.1413"></a><span id="l9.1413" class="difflineminus">-  opmlFeedToOutline: function(aFeed, aDoc)</span>
<a href="#l9.1414"></a><span id="l9.1414" class="difflineplus">+  generateOutlineStruct: function(baseFolder, parent, indentLevel)</span>
<a href="#l9.1415"></a><span id="l9.1415" class="difflineplus">+  {</span>
<a href="#l9.1416"></a><span id="l9.1416" class="difflineplus">+    // Pretty printing.</span>
<a href="#l9.1417"></a><span id="l9.1417" class="difflineplus">+    function indentString(len) { return (new Array(len - 1)).join(&quot; &quot;) };</span>
<a href="#l9.1418"></a><span id="l9.1418" class="difflineplus">+</span>
<a href="#l9.1419"></a><span id="l9.1419" class="difflineplus">+    let folderOutline, feedOutline;</span>
<a href="#l9.1420"></a><span id="l9.1420" class="difflineplus">+    let folderEnumerator = baseFolder.subFolders;</span>
<a href="#l9.1421"></a><span id="l9.1421" class="difflineplus">+    while (folderEnumerator.hasMoreElements())</span>
<a href="#l9.1422"></a><span id="l9.1422" class="difflineplus">+    {</span>
<a href="#l9.1423"></a><span id="l9.1423" class="difflineplus">+      let folder = folderEnumerator.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l9.1424"></a><span id="l9.1424" class="difflineplus">+      FeedUtils.log.debug(&quot;generateOutlineStruct: folder - &quot; +</span>
<a href="#l9.1425"></a><span id="l9.1425" class="difflineplus">+                          folder.filePath.path);</span>
<a href="#l9.1426"></a><span id="l9.1426" class="difflineplus">+      if (!(folder instanceof Ci.nsIMsgFolder) ||</span>
<a href="#l9.1427"></a><span id="l9.1427" class="difflineplus">+          folder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l9.1428"></a><span id="l9.1428" class="difflineplus">+          folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l9.1429"></a><span id="l9.1429" class="difflineplus">+        continue;</span>
<a href="#l9.1430"></a><span id="l9.1430" class="difflineplus">+</span>
<a href="#l9.1431"></a><span id="l9.1431" class="difflineplus">+      FeedUtils.log.debug(&quot;generateOutlineStruct: CONTINUE folderName - &quot; +</span>
<a href="#l9.1432"></a><span id="l9.1432" class="difflineplus">+                          folder.name);</span>
<a href="#l9.1433"></a><span id="l9.1433" class="difflineplus">+</span>
<a href="#l9.1434"></a><span id="l9.1434" class="difflineplus">+      // Make a folder outline element.</span>
<a href="#l9.1435"></a><span id="l9.1435" class="difflineplus">+      folderOutline = parent.ownerDocument.createElement(&quot;outline&quot;);</span>
<a href="#l9.1436"></a><span id="l9.1436" class="difflineplus">+      folderOutline.setAttribute(&quot;title&quot;, folder.prettyName);</span>
<a href="#l9.1437"></a><span id="l9.1437" class="difflineplus">+      this.generatePPSpace(parent, indentString(indentLevel + 2));</span>
<a href="#l9.1438"></a><span id="l9.1438" class="difflineplus">+</span>
<a href="#l9.1439"></a><span id="l9.1439" class="difflineplus">+      if (folder.hasSubFolders)</span>
<a href="#l9.1440"></a><span id="l9.1440" class="difflineplus">+      {</span>
<a href="#l9.1441"></a><span id="l9.1441" class="difflineplus">+        FeedUtils.log.debug(&quot;generateOutlineStruct: has subfolders - &quot; +</span>
<a href="#l9.1442"></a><span id="l9.1442" class="difflineplus">+                            folder.name);</span>
<a href="#l9.1443"></a><span id="l9.1443" class="difflineplus">+        // Recurse.</span>
<a href="#l9.1444"></a><span id="l9.1444" class="difflineplus">+        this.generateOutlineStruct(folder, folderOutline, indentLevel + 2);</span>
<a href="#l9.1445"></a><span id="l9.1445" class="difflineplus">+      }</span>
<a href="#l9.1446"></a><span id="l9.1446" class="difflineplus">+</span>
<a href="#l9.1447"></a><span id="l9.1447" class="difflineplus">+      let feeds = this.getFeedsInFolder(folder);</span>
<a href="#l9.1448"></a><span id="l9.1448" class="difflineplus">+      for (let feed in feeds)</span>
<a href="#l9.1449"></a><span id="l9.1449" class="difflineplus">+      {</span>
<a href="#l9.1450"></a><span id="l9.1450" class="difflineplus">+        // Add feed outline elements with xmlUrls.</span>
<a href="#l9.1451"></a><span id="l9.1451" class="difflineplus">+        FeedUtils.log.debug(&quot;generateOutlineStruct: folder has FEED url - &quot;+</span>
<a href="#l9.1452"></a><span id="l9.1452" class="difflineplus">+                            folder.name + &quot; : &quot; + feeds[feed].url);</span>
<a href="#l9.1453"></a><span id="l9.1453" class="difflineplus">+        feedOutline = this.exportOPMLOutline(feeds[feed], parent.ownerDocument);</span>
<a href="#l9.1454"></a><span id="l9.1454" class="difflineplus">+        this.generatePPSpace(folderOutline, indentString(indentLevel + 4));</span>
<a href="#l9.1455"></a><span id="l9.1455" class="difflineplus">+        folderOutline.appendChild(feedOutline);</span>
<a href="#l9.1456"></a><span id="l9.1456" class="difflineplus">+      }</span>
<a href="#l9.1457"></a><span id="l9.1457" class="difflineplus">+</span>
<a href="#l9.1458"></a><span id="l9.1458" class="difflineplus">+      parent.appendChild(folderOutline);</span>
<a href="#l9.1459"></a><span id="l9.1459" class="difflineplus">+    }</span>
<a href="#l9.1460"></a><span id="l9.1460" class="difflineplus">+  },</span>
<a href="#l9.1461"></a><span id="l9.1461" class="difflineplus">+</span>
<a href="#l9.1462"></a><span id="l9.1462" class="difflineplus">+  exportOPMLOutline: function(aFeed, aDoc)</span>
<a href="#l9.1463"></a><span id="l9.1463">   {</span>
<a href="#l9.1464"></a><span id="l9.1464">     let outRv = aDoc.createElement(&quot;outline&quot;);</span>
<a href="#l9.1465"></a><span id="l9.1465" class="difflineplus">+    outRv.setAttribute(&quot;type&quot;, &quot;rss&quot;);</span>
<a href="#l9.1466"></a><span id="l9.1466">     outRv.setAttribute(&quot;title&quot;, aFeed.title);</span>
<a href="#l9.1467"></a><span id="l9.1467">     outRv.setAttribute(&quot;text&quot;, aFeed.title);</span>
<a href="#l9.1468"></a><span id="l9.1468" class="difflineminus">-    outRv.setAttribute(&quot;type&quot;, &quot;rss&quot;);</span>
<a href="#l9.1469"></a><span id="l9.1469">     outRv.setAttribute(&quot;version&quot;, &quot;RSS&quot;);</span>
<a href="#l9.1470"></a><span id="l9.1470" class="difflineplus">+    outRv.setAttribute(&quot;fz:quickMode&quot;, aFeed.quickMode);</span>
<a href="#l9.1471"></a><span id="l9.1471">     outRv.setAttribute(&quot;xmlUrl&quot;, aFeed.url);</span>
<a href="#l9.1472"></a><span id="l9.1472">     outRv.setAttribute(&quot;htmlUrl&quot;, aFeed.link);</span>
<a href="#l9.1473"></a><span id="l9.1473">     return outRv;</span>
<a href="#l9.1474"></a><span id="l9.1474">   },</span>
<a href="#l9.1475"></a><span id="l9.1475"> </span>
<a href="#l9.1476"></a><span id="l9.1476">   importOPML: function()</span>
<a href="#l9.1477"></a><span id="l9.1477">   {</span>
<a href="#l9.1478"></a><span id="l9.1478" class="difflineminus">-    // Account folder must be selected.</span>
<a href="#l9.1479"></a><span id="l9.1479" class="difflineminus">-    let item = this.mView.currentItem;</span>
<a href="#l9.1480"></a><span id="l9.1480" class="difflineplus">+    // Account folder must be selected in subscribe dialog.</span>
<a href="#l9.1481"></a><span id="l9.1481" class="difflineplus">+    let item = this.mView ? this.mView.currentItem : null;</span>
<a href="#l9.1482"></a><span id="l9.1482">     if (!item || !item.folder || !item.folder.isServer)</span>
<a href="#l9.1483"></a><span id="l9.1483">       return;</span>
<a href="#l9.1484"></a><span id="l9.1484"> </span>
<a href="#l9.1485"></a><span id="l9.1485" class="difflineminus">-    this.mRSSServer = item.folder.server;</span>
<a href="#l9.1486"></a><span id="l9.1486" class="difflineminus">-</span>
<a href="#l9.1487"></a><span id="l9.1487" class="difflineplus">+    let server = item.folder.server;</span>
<a href="#l9.1488"></a><span id="l9.1488">     // Get file to open from filepicker.</span>
<a href="#l9.1489"></a><span id="l9.1489">     let openFile = this.opmlPickOpenFile();</span>
<a href="#l9.1490"></a><span id="l9.1490">     if (!openFile)</span>
<a href="#l9.1491"></a><span id="l9.1491">       return;</span>
<a href="#l9.1492"></a><span id="l9.1492"> </span>
<a href="#l9.1493"></a><span id="l9.1493" class="difflineminus">-    let opmlDom = null;</span>
<a href="#l9.1494"></a><span id="l9.1494" class="difflineminus">-    let statusReport;</span>
<a href="#l9.1495"></a><span id="l9.1495" class="difflineminus">-    let feedsAdded = 0;</span>
<a href="#l9.1496"></a><span id="l9.1496" class="difflineplus">+    this.mActionMode = this.kImportingOPML;</span>
<a href="#l9.1497"></a><span id="l9.1497" class="difflineplus">+    this.updateButtons(null);</span>
<a href="#l9.1498"></a><span id="l9.1498" class="difflineplus">+    this.selectFolder(item.folder, { select: false, open: true });</span>
<a href="#l9.1499"></a><span id="l9.1499" class="difflineplus">+    let statusReport = FeedUtils.strings.GetStringFromName(&quot;subscribe-loading&quot;);</span>
<a href="#l9.1500"></a><span id="l9.1500" class="difflineplus">+    this.updateStatusItem(&quot;statusText&quot;, statusReport);</span>
<a href="#l9.1501"></a><span id="l9.1501" class="difflineplus">+    // If there were a getElementsByAttribute in html, we could go determined...</span>
<a href="#l9.1502"></a><span id="l9.1502" class="difflineplus">+    this.updateStatusItem(&quot;progressMeter&quot;, &quot;?&quot;);</span>
<a href="#l9.1503"></a><span id="l9.1503" class="difflineplus">+</span>
<a href="#l9.1504"></a><span id="l9.1504" class="difflineplus">+    if (!this.importOPMLFile(openFile, server, this.importOPMLFinished)) {</span>
<a href="#l9.1505"></a><span id="l9.1505" class="difflineplus">+      this.mActionMode = null;</span>
<a href="#l9.1506"></a><span id="l9.1506" class="difflineplus">+      this.updateButtons(item);</span>
<a href="#l9.1507"></a><span id="l9.1507" class="difflineplus">+      this.clearStatusInfo();</span>
<a href="#l9.1508"></a><span id="l9.1508" class="difflineplus">+    }</span>
<a href="#l9.1509"></a><span id="l9.1509" class="difflineplus">+  },</span>
<a href="#l9.1510"></a><span id="l9.1510" class="difflineplus">+</span>
<a href="#l9.1511"></a><span id="l9.1511" class="difflineplus">+/**</span>
<a href="#l9.1512"></a><span id="l9.1512" class="difflineplus">+ * Import opml file into a feed account.  Used by the Subscribe dialog and</span>
<a href="#l9.1513"></a><span id="l9.1513" class="difflineplus">+ * the Import wizard.</span>
<a href="#l9.1514"></a><span id="l9.1514" class="difflineplus">+ * </span>
<a href="#l9.1515"></a><span id="l9.1515" class="difflineplus">+ * @param  nsILocalFile aFile           - the opml file.</span>
<a href="#l9.1516"></a><span id="l9.1516" class="difflineplus">+ * @param  nsIMsgIncomingServer aServer - the account server.</span>
<a href="#l9.1517"></a><span id="l9.1517" class="difflineplus">+ * @param  func aCallback               - callback function.</span>
<a href="#l9.1518"></a><span id="l9.1518" class="difflineplus">+ * </span>
<a href="#l9.1519"></a><span id="l9.1519" class="difflineplus">+ * @return bool                         - false if error.</span>
<a href="#l9.1520"></a><span id="l9.1520" class="difflineplus">+ */</span>
<a href="#l9.1521"></a><span id="l9.1521" class="difflineplus">+  importOPMLFile: function(aFile, aServer, aCallback)</span>
<a href="#l9.1522"></a><span id="l9.1522" class="difflineplus">+  {</span>
<a href="#l9.1523"></a><span id="l9.1523" class="difflineplus">+    if (aServer &amp;&amp; (aServer instanceof Ci.nsIMsgIncomingServer))</span>
<a href="#l9.1524"></a><span id="l9.1524" class="difflineplus">+      this.mRSSServer = aServer;</span>
<a href="#l9.1525"></a><span id="l9.1525" class="difflineplus">+</span>
<a href="#l9.1526"></a><span id="l9.1526" class="difflineplus">+    if (!aFile || !this.mRSSServer || !aCallback)</span>
<a href="#l9.1527"></a><span id="l9.1527" class="difflineplus">+      return false;</span>
<a href="#l9.1528"></a><span id="l9.1528" class="difflineplus">+</span>
<a href="#l9.1529"></a><span id="l9.1529" class="difflineplus">+    let opmlDom, statusReport;</span>
<a href="#l9.1530"></a><span id="l9.1530">     let stream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l9.1531"></a><span id="l9.1531">                  createInstance(Ci.nsIFileInputStream);</span>
<a href="#l9.1532"></a><span id="l9.1532"> </span>
<a href="#l9.1533"></a><span id="l9.1533">     // Read in file as raw bytes, so Expat can do the decoding for us.</span>
<a href="#l9.1534"></a><span id="l9.1534">     try {</span>
<a href="#l9.1535"></a><span id="l9.1535" class="difflineminus">-      stream.init(openFile, FileUtils.MODE_RDONLY, FileUtils.PERMS_FILE, 0);</span>
<a href="#l9.1536"></a><span id="l9.1536" class="difflineplus">+      stream.init(aFile, FileUtils.MODE_RDONLY, FileUtils.PERMS_FILE, 0);</span>
<a href="#l9.1537"></a><span id="l9.1537">       let parser = new DOMParser();</span>
<a href="#l9.1538"></a><span id="l9.1538">       opmlDom = parser.parseFromStream(stream, null, stream.available(),</span>
<a href="#l9.1539"></a><span id="l9.1539">                                        &quot;application/xml&quot;);</span>
<a href="#l9.1540"></a><span id="l9.1540">     }</span>
<a href="#l9.1541"></a><span id="l9.1541">     catch(e) {</span>
<a href="#l9.1542"></a><span id="l9.1542">       statusReport = FeedUtils.strings.GetStringFromName(</span>
<a href="#l9.1543"></a><span id="l9.1543">                        &quot;subscribe-errorOpeningFile&quot;);</span>
<a href="#l9.1544"></a><span id="l9.1544">       Services.prompt.alert(window, null, statusReport);</span>
<a href="#l9.1545"></a><span id="l9.1545" class="difflineminus">-      return;</span>
<a href="#l9.1546"></a><span id="l9.1546" class="difflineplus">+      return false;</span>
<a href="#l9.1547"></a><span id="l9.1547">     }</span>
<a href="#l9.1548"></a><span id="l9.1548">     finally {</span>
<a href="#l9.1549"></a><span id="l9.1549">       stream.close();</span>
<a href="#l9.1550"></a><span id="l9.1550">     }</span>
<a href="#l9.1551"></a><span id="l9.1551"> </span>
<a href="#l9.1552"></a><span id="l9.1552" class="difflineminus">-    // Return if the user didn't give us an OPML file.</span>
<a href="#l9.1553"></a><span id="l9.1553" class="difflineminus">-    if(!opmlDom || opmlDom.documentElement.tagName != &quot;opml&quot;)</span>
<a href="#l9.1554"></a><span id="l9.1554" class="difflineplus">+    let body = opmlDom ? opmlDom.getElementsByTagName(&quot;body&quot;)[0] : null;</span>
<a href="#l9.1555"></a><span id="l9.1555" class="difflineplus">+</span>
<a href="#l9.1556"></a><span id="l9.1556" class="difflineplus">+    // Return if the OPML file is invalid or empty.</span>
<a href="#l9.1557"></a><span id="l9.1557" class="difflineplus">+    if (!body || !body.childElementCount ||</span>
<a href="#l9.1558"></a><span id="l9.1558" class="difflineplus">+      opmlDom.documentElement.tagName != &quot;opml&quot;)</span>
<a href="#l9.1559"></a><span id="l9.1559">     {</span>
<a href="#l9.1560"></a><span id="l9.1560">       statusReport = FeedUtils.strings.formatStringFromName(</span>
<a href="#l9.1561"></a><span id="l9.1561" class="difflineminus">-                       &quot;subscribe-OPMLImportInvalidFile&quot;, [rv.file.leafName], 1);</span>
<a href="#l9.1562"></a><span id="l9.1562" class="difflineplus">+                       &quot;subscribe-OPMLImportInvalidFile&quot;, [aFile.leafName], 1);</span>
<a href="#l9.1563"></a><span id="l9.1563">       Services.prompt.alert(window, null, statusReport);</span>
<a href="#l9.1564"></a><span id="l9.1564" class="difflineminus">-      return;</span>
<a href="#l9.1565"></a><span id="l9.1565" class="difflineminus">-    }</span>
<a href="#l9.1566"></a><span id="l9.1566" class="difflineminus">-    else</span>
<a href="#l9.1567"></a><span id="l9.1567" class="difflineminus">-    {</span>
<a href="#l9.1568"></a><span id="l9.1568" class="difflineminus">-      let outlines = opmlDom.getElementsByTagName(&quot;body&quot;)[0].</span>
<a href="#l9.1569"></a><span id="l9.1569" class="difflineminus">-                             getElementsByTagName(&quot;outline&quot;);</span>
<a href="#l9.1570"></a><span id="l9.1570" class="difflineminus">-      // Try to import records if there are any.</span>
<a href="#l9.1571"></a><span id="l9.1571" class="difflineminus">-      for (let index = 0; index &lt; outlines.length; index++)</span>
<a href="#l9.1572"></a><span id="l9.1572" class="difflineminus">-      {</span>
<a href="#l9.1573"></a><span id="l9.1573" class="difflineminus">-        if (this.importOutline(outlines[index]) == 1)</span>
<a href="#l9.1574"></a><span id="l9.1574" class="difflineminus">-          feedsAdded++;</span>
<a href="#l9.1575"></a><span id="l9.1575" class="difflineminus">-      }</span>
<a href="#l9.1576"></a><span id="l9.1576" class="difflineminus">-</span>
<a href="#l9.1577"></a><span id="l9.1577" class="difflineminus">-      if (outlines.length &gt; feedsAdded)</span>
<a href="#l9.1578"></a><span id="l9.1578" class="difflineminus">-        statusReport = FeedUtils.strings.formatStringFromName(&quot;subscribe-OPMLImportStatus&quot;,</span>
<a href="#l9.1579"></a><span id="l9.1579" class="difflineminus">-          [PluralForm.get(feedsAdded,</span>
<a href="#l9.1580"></a><span id="l9.1580" class="difflineminus">-                          FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportUniqueFeeds&quot;))</span>
<a href="#l9.1581"></a><span id="l9.1581" class="difflineminus">-                     .replace(&quot;#1&quot;, feedsAdded),</span>
<a href="#l9.1582"></a><span id="l9.1582" class="difflineminus">-           PluralForm.get(outlines.length,</span>
<a href="#l9.1583"></a><span id="l9.1583" class="difflineminus">-                          FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportFoundFeeds&quot;))</span>
<a href="#l9.1584"></a><span id="l9.1584" class="difflineminus">-                     .replace(&quot;#1&quot;, outlines.length)], 2);</span>
<a href="#l9.1585"></a><span id="l9.1585" class="difflineminus">-       else</span>
<a href="#l9.1586"></a><span id="l9.1586" class="difflineminus">-        statusReport = PluralForm.get(feedsAdded,</span>
<a href="#l9.1587"></a><span id="l9.1587" class="difflineminus">-          FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportFeedCount&quot;))</span>
<a href="#l9.1588"></a><span id="l9.1588" class="difflineminus">-                           .replace(&quot;#1&quot;, feedsAdded);</span>
<a href="#l9.1589"></a><span id="l9.1589" class="difflineplus">+      return false;</span>
<a href="#l9.1590"></a><span id="l9.1590">     }</span>
<a href="#l9.1591"></a><span id="l9.1591"> </span>
<a href="#l9.1592"></a><span id="l9.1592" class="difflineminus">-    this.clearStatusInfo();</span>
<a href="#l9.1593"></a><span id="l9.1593" class="difflineminus">-    this.updateStatusItem(&quot;statusText&quot;, statusReport);</span>
<a href="#l9.1594"></a><span id="l9.1594" class="difflineminus">-</span>
<a href="#l9.1595"></a><span id="l9.1595" class="difflineminus">-    // Add the new feeds to our view.</span>
<a href="#l9.1596"></a><span id="l9.1596" class="difflineminus">-    if (feedsAdded)</span>
<a href="#l9.1597"></a><span id="l9.1597" class="difflineminus">-      this.refreshSubscriptionView(this.mRSSServer.rootFolder);</span>
<a href="#l9.1598"></a><span id="l9.1598" class="difflineplus">+    this.importOPMLOutlines(body, this.mRSSServer, aCallback);</span>
<a href="#l9.1599"></a><span id="l9.1599" class="difflineplus">+    return true;</span>
<a href="#l9.1600"></a><span id="l9.1600">   },</span>
<a href="#l9.1601"></a><span id="l9.1601"> </span>
<a href="#l9.1602"></a><span id="l9.1602" class="difflineminus">-  importOutline: function(aOutline)</span>
<a href="#l9.1603"></a><span id="l9.1603" class="difflineplus">+  importOPMLOutlines: function(aBody, aRSSServer, aCallback)</span>
<a href="#l9.1604"></a><span id="l9.1604">   {</span>
<a href="#l9.1605"></a><span id="l9.1605" class="difflineminus">-    // XXX only dealing with flat OPML files for now.</span>
<a href="#l9.1606"></a><span id="l9.1606" class="difflineminus">-    // We still need to add support for grouped files.</span>
<a href="#l9.1607"></a><span id="l9.1607" class="difflineminus">-    let newFeedUrl = aOutline.getAttribute(&quot;xmlUrl&quot;) ||</span>
<a href="#l9.1608"></a><span id="l9.1608" class="difflineminus">-                     aOutline.getAttribute(&quot;url&quot;);</span>
<a href="#l9.1609"></a><span id="l9.1609" class="difflineminus">-    if (!newFeedUrl)</span>
<a href="#l9.1610"></a><span id="l9.1610" class="difflineminus">-      return -1;</span>
<a href="#l9.1611"></a><span id="l9.1611" class="difflineplus">+    let win = this;</span>
<a href="#l9.1612"></a><span id="l9.1612" class="difflineplus">+    let rssServer = aRSSServer;</span>
<a href="#l9.1613"></a><span id="l9.1613" class="difflineplus">+    let callback = aCallback;</span>
<a href="#l9.1614"></a><span id="l9.1614" class="difflineplus">+    let outline, feedFolder;</span>
<a href="#l9.1615"></a><span id="l9.1615" class="difflineplus">+    let badTag = false;</span>
<a href="#l9.1616"></a><span id="l9.1616" class="difflineplus">+    let firstFeedInFolderQuickMode = null;</span>
<a href="#l9.1617"></a><span id="l9.1617" class="difflineplus">+    let lastFolder;</span>
<a href="#l9.1618"></a><span id="l9.1618" class="difflineplus">+    let feedsAdded = 0;</span>
<a href="#l9.1619"></a><span id="l9.1619" class="difflineplus">+    let rssOutlines = 0;</span>
<a href="#l9.1620"></a><span id="l9.1620" class="difflineplus">+    let folderOutlines = 0;</span>
<a href="#l9.1621"></a><span id="l9.1621" class="difflineplus">+</span>
<a href="#l9.1622"></a><span id="l9.1622" class="difflineplus">+    function processor(aParentNode, aParentFolder)</span>
<a href="#l9.1623"></a><span id="l9.1623" class="difflineplus">+    {</span>
<a href="#l9.1624"></a><span id="l9.1624" class="difflineplus">+      FeedUtils.log.trace(&quot;importOPMLOutlines: PROCESSOR tag:name:childs - &quot; +</span>
<a href="#l9.1625"></a><span id="l9.1625" class="difflineplus">+                          aParentNode.tagName + &quot;:&quot; +</span>
<a href="#l9.1626"></a><span id="l9.1626" class="difflineplus">+                          aParentNode.getAttribute(&quot;text&quot;) + &quot;:&quot; +</span>
<a href="#l9.1627"></a><span id="l9.1627" class="difflineplus">+                          aParentNode.childElementCount);</span>
<a href="#l9.1628"></a><span id="l9.1628" class="difflineplus">+      while (true)</span>
<a href="#l9.1629"></a><span id="l9.1629" class="difflineplus">+      {</span>
<a href="#l9.1630"></a><span id="l9.1630" class="difflineplus">+        if (aParentNode.tagName == &quot;body&quot; &amp;&amp; !aParentNode.childElementCount)</span>
<a href="#l9.1631"></a><span id="l9.1631" class="difflineplus">+        {</span>
<a href="#l9.1632"></a><span id="l9.1632" class="difflineplus">+          // Finished.</span>
<a href="#l9.1633"></a><span id="l9.1633" class="difflineplus">+          let statusReport = win.importOPMLStatus(feedsAdded, rssOutlines);</span>
<a href="#l9.1634"></a><span id="l9.1634" class="difflineplus">+          callback(statusReport, lastFolder, win);</span>
<a href="#l9.1635"></a><span id="l9.1635" class="difflineplus">+          return;</span>
<a href="#l9.1636"></a><span id="l9.1636" class="difflineplus">+        }</span>
<a href="#l9.1637"></a><span id="l9.1637" class="difflineplus">+</span>
<a href="#l9.1638"></a><span id="l9.1638" class="difflineplus">+        outline = aParentNode.firstElementChild;</span>
<a href="#l9.1639"></a><span id="l9.1639" class="difflineplus">+        if (outline.tagName != &quot;outline&quot;)</span>
<a href="#l9.1640"></a><span id="l9.1640" class="difflineplus">+        {</span>
<a href="#l9.1641"></a><span id="l9.1641" class="difflineplus">+          FeedUtils.log.info(&quot;importOPMLOutlines: skipping, node is not an &quot; +</span>
<a href="#l9.1642"></a><span id="l9.1642" class="difflineplus">+                             &quot;&lt;outline&gt; - &lt;&quot; + outline.tagName + &quot;&gt;&quot;);</span>
<a href="#l9.1643"></a><span id="l9.1643" class="difflineplus">+          badTag = true;</span>
<a href="#l9.1644"></a><span id="l9.1644" class="difflineplus">+          break;</span>
<a href="#l9.1645"></a><span id="l9.1645" class="difflineplus">+        }</span>
<a href="#l9.1646"></a><span id="l9.1646" class="difflineplus">+</span>
<a href="#l9.1647"></a><span id="l9.1647" class="difflineplus">+        let outlineName = outline.getAttribute(&quot;text&quot;) ||</span>
<a href="#l9.1648"></a><span id="l9.1648" class="difflineplus">+                          outline.getAttribute(&quot;title&quot;) ||</span>
<a href="#l9.1649"></a><span id="l9.1649" class="difflineplus">+                          outline.getAttribute(&quot;xmlUrl&quot;);</span>
<a href="#l9.1650"></a><span id="l9.1650" class="difflineplus">+        let feedUrl, folderURI;</span>
<a href="#l9.1651"></a><span id="l9.1651" class="difflineplus">+</span>
<a href="#l9.1652"></a><span id="l9.1652" class="difflineplus">+        if (outline.getAttribute(&quot;type&quot;) == &quot;rss&quot;)</span>
<a href="#l9.1653"></a><span id="l9.1653" class="difflineplus">+        {</span>
<a href="#l9.1654"></a><span id="l9.1654" class="difflineplus">+          // A feed outline.</span>
<a href="#l9.1655"></a><span id="l9.1655" class="difflineplus">+          feedUrl = outline.getAttribute(&quot;xmlUrl&quot;) || outline.getAttribute(&quot;url&quot;);</span>
<a href="#l9.1656"></a><span id="l9.1656" class="difflineplus">+          if (!feedUrl)</span>
<a href="#l9.1657"></a><span id="l9.1657" class="difflineplus">+          {</span>
<a href="#l9.1658"></a><span id="l9.1658" class="difflineplus">+            FeedUtils.log.info(&quot;importOPMLOutlines: skipping, type=rss &lt;outline&gt; &quot; +</span>
<a href="#l9.1659"></a><span id="l9.1659" class="difflineplus">+                               &quot;has no url - &quot; + outlineName);</span>
<a href="#l9.1660"></a><span id="l9.1660" class="difflineplus">+            break;</span>
<a href="#l9.1661"></a><span id="l9.1661" class="difflineplus">+          }</span>
<a href="#l9.1662"></a><span id="l9.1662" class="difflineplus">+</span>
<a href="#l9.1663"></a><span id="l9.1663" class="difflineplus">+          rssOutlines++;</span>
<a href="#l9.1664"></a><span id="l9.1664" class="difflineplus">+          feedFolder = aParentFolder;</span>
<a href="#l9.1665"></a><span id="l9.1665" class="difflineplus">+</span>
<a href="#l9.1666"></a><span id="l9.1666" class="difflineplus">+          if (FeedUtils.feedAlreadyExists(feedUrl, rssServer))</span>
<a href="#l9.1667"></a><span id="l9.1667" class="difflineplus">+          {</span>
<a href="#l9.1668"></a><span id="l9.1668" class="difflineplus">+            FeedUtils.log.info(&quot;importOPMLOutlines: feed already subscribed in account &quot; +</span>
<a href="#l9.1669"></a><span id="l9.1669" class="difflineplus">+                               rssServer.prettyName + &quot;, url - &quot; + feedUrl);</span>
<a href="#l9.1670"></a><span id="l9.1670" class="difflineplus">+            break;</span>
<a href="#l9.1671"></a><span id="l9.1671" class="difflineplus">+          }</span>
<a href="#l9.1672"></a><span id="l9.1672" class="difflineplus">+</span>
<a href="#l9.1673"></a><span id="l9.1673" class="difflineplus">+          if (aParentNode.tagName == &quot;outline&quot; &amp;&amp;</span>
<a href="#l9.1674"></a><span id="l9.1674" class="difflineplus">+              aParentNode.getAttribute(&quot;type&quot;) != &quot;rss&quot;)</span>
<a href="#l9.1675"></a><span id="l9.1675" class="difflineplus">+            // Parent is a folder, already created.</span>
<a href="#l9.1676"></a><span id="l9.1676" class="difflineplus">+            folderURI = feedFolder.URI;</span>
<a href="#l9.1677"></a><span id="l9.1677" class="difflineplus">+          else</span>
<a href="#l9.1678"></a><span id="l9.1678" class="difflineplus">+          {</span>
<a href="#l9.1679"></a><span id="l9.1679" class="difflineplus">+            // Parent is not a folder outline, likely the &lt;body&gt; in a flat list.</span>
<a href="#l9.1680"></a><span id="l9.1680" class="difflineplus">+            // Create feed's folder with feed's name and account rootFolder as</span>
<a href="#l9.1681"></a><span id="l9.1681" class="difflineplus">+            // parent of feed's folder.</span>
<a href="#l9.1682"></a><span id="l9.1682" class="difflineplus">+            // NOTE: Assume a type=rss outline must be a leaf and is not a</span>
<a href="#l9.1683"></a><span id="l9.1683" class="difflineplus">+            // direct parent of another type=rss outline; such a structure</span>
<a href="#l9.1684"></a><span id="l9.1684" class="difflineplus">+            // may lead to unintended nesting and inaccurate counts.</span>
<a href="#l9.1685"></a><span id="l9.1685" class="difflineplus">+          }</span>
<a href="#l9.1686"></a><span id="l9.1686" class="difflineplus">+</span>
<a href="#l9.1687"></a><span id="l9.1687" class="difflineplus">+          // Create the feed.</span>
<a href="#l9.1688"></a><span id="l9.1688" class="difflineplus">+          let quickMode = outline.hasAttribute(&quot;fz:quickMode&quot;) ?</span>
<a href="#l9.1689"></a><span id="l9.1689" class="difflineplus">+                          outline.getAttribute(&quot;fz:quickMode&quot;) == &quot;true&quot; ?</span>
<a href="#l9.1690"></a><span id="l9.1690" class="difflineplus">+                          true : false : rssServer.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l9.1691"></a><span id="l9.1691"> </span>
<a href="#l9.1692"></a><span id="l9.1692" class="difflineminus">-    // Silently skip feeds that are already subscribed.</span>
<a href="#l9.1693"></a><span id="l9.1693" class="difflineminus">-    if (FeedUtils.feedAlreadyExists(newFeedUrl, this.mRSSServer))</span>
<a href="#l9.1694"></a><span id="l9.1694" class="difflineminus">-    {</span>
<a href="#l9.1695"></a><span id="l9.1695" class="difflineminus">-      FeedUtils.log.debug(&quot;importOutline: already subscribed in account &quot;+</span>
<a href="#l9.1696"></a><span id="l9.1696" class="difflineminus">-                          this.mRSSServer.prettyName+&quot;, url - &quot;+ newFeedUrl);</span>
<a href="#l9.1697"></a><span id="l9.1697" class="difflineminus">-      return 0;</span>
<a href="#l9.1698"></a><span id="l9.1698" class="difflineplus">+          if (firstFeedInFolderQuickMode === null)</span>
<a href="#l9.1699"></a><span id="l9.1699" class="difflineplus">+            // The summary/web page pref applies to all feeds in a folder,</span>
<a href="#l9.1700"></a><span id="l9.1700" class="difflineplus">+            // though it is a property of an individual feed.  This can be</span>
<a href="#l9.1701"></a><span id="l9.1701" class="difflineplus">+            // set (and is obvious) in the subscribe dialog; ensure import</span>
<a href="#l9.1702"></a><span id="l9.1702" class="difflineplus">+            // doesn't leave mismatches if mismatched in the opml file.</span>
<a href="#l9.1703"></a><span id="l9.1703" class="difflineplus">+            firstFeedInFolderQuickMode = quickMode;</span>
<a href="#l9.1704"></a><span id="l9.1704" class="difflineplus">+          else</span>
<a href="#l9.1705"></a><span id="l9.1705" class="difflineplus">+            quickMode = firstFeedInFolderQuickMode;</span>
<a href="#l9.1706"></a><span id="l9.1706" class="difflineplus">+</span>
<a href="#l9.1707"></a><span id="l9.1707" class="difflineplus">+          let feedProperties = { feedName     : outlineName,</span>
<a href="#l9.1708"></a><span id="l9.1708" class="difflineplus">+                                 feedLocation : feedUrl,</span>
<a href="#l9.1709"></a><span id="l9.1709" class="difflineplus">+                                 server       : rssServer,</span>
<a href="#l9.1710"></a><span id="l9.1710" class="difflineplus">+                                 folderURI    : folderURI,</span>
<a href="#l9.1711"></a><span id="l9.1711" class="difflineplus">+                                 quickMode    : quickMode };</span>
<a href="#l9.1712"></a><span id="l9.1712" class="difflineplus">+</span>
<a href="#l9.1713"></a><span id="l9.1713" class="difflineplus">+          FeedUtils.log.debug(&quot;importOPMLOutlines: importing feed: name, url - &quot;+</span>
<a href="#l9.1714"></a><span id="l9.1714" class="difflineplus">+                              outlineName + &quot;, &quot; + feedUrl);</span>
<a href="#l9.1715"></a><span id="l9.1715" class="difflineplus">+</span>
<a href="#l9.1716"></a><span id="l9.1716" class="difflineplus">+          let feed = win.storeFeed(feedProperties);</span>
<a href="#l9.1717"></a><span id="l9.1717" class="difflineplus">+          if (outline.hasAttribute(&quot;htmlUrl&quot;))</span>
<a href="#l9.1718"></a><span id="l9.1718" class="difflineplus">+            feed.link = outline.getAttribute(&quot;htmlUrl&quot;);</span>
<a href="#l9.1719"></a><span id="l9.1719" class="difflineplus">+</span>
<a href="#l9.1720"></a><span id="l9.1720" class="difflineplus">+          feed.createFolder();</span>
<a href="#l9.1721"></a><span id="l9.1721" class="difflineplus">+          FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l9.1722"></a><span id="l9.1722" class="difflineplus">+</span>
<a href="#l9.1723"></a><span id="l9.1723" class="difflineplus">+          // addFeed() adds the feed to the datasource, it also flushes the</span>
<a href="#l9.1724"></a><span id="l9.1724" class="difflineplus">+          // subscription datasource.</span>
<a href="#l9.1725"></a><span id="l9.1725" class="difflineplus">+          FeedUtils.addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l9.1726"></a><span id="l9.1726" class="difflineplus">+          // Feed correctly added.</span>
<a href="#l9.1727"></a><span id="l9.1727" class="difflineplus">+          feedsAdded++;</span>
<a href="#l9.1728"></a><span id="l9.1728" class="difflineplus">+          lastFolder = feed.folder;</span>
<a href="#l9.1729"></a><span id="l9.1729" class="difflineplus">+        }</span>
<a href="#l9.1730"></a><span id="l9.1730" class="difflineplus">+        else</span>
<a href="#l9.1731"></a><span id="l9.1731" class="difflineplus">+        {</span>
<a href="#l9.1732"></a><span id="l9.1732" class="difflineplus">+          // A folder outline.</span>
<a href="#l9.1733"></a><span id="l9.1733" class="difflineplus">+          try {</span>
<a href="#l9.1734"></a><span id="l9.1734" class="difflineplus">+            feedFolder = aParentFolder.getChildNamed(outlineName);</span>
<a href="#l9.1735"></a><span id="l9.1735" class="difflineplus">+          }</span>
<a href="#l9.1736"></a><span id="l9.1736" class="difflineplus">+          catch (ex) {</span>
<a href="#l9.1737"></a><span id="l9.1737" class="difflineplus">+            // Folder not found, create it.</span>
<a href="#l9.1738"></a><span id="l9.1738" class="difflineplus">+            FeedUtils.log.debug(&quot;importOPMLOutlines: creating folder - '&quot; +</span>
<a href="#l9.1739"></a><span id="l9.1739" class="difflineplus">+                                outlineName + &quot;' in parent folder &quot; +</span>
<a href="#l9.1740"></a><span id="l9.1740" class="difflineplus">+                                aParentFolder.filePath.path);</span>
<a href="#l9.1741"></a><span id="l9.1741" class="difflineplus">+            firstFeedInFolderQuickMode = null;</span>
<a href="#l9.1742"></a><span id="l9.1742" class="difflineplus">+            try {</span>
<a href="#l9.1743"></a><span id="l9.1743" class="difflineplus">+              feedFolder = aParentFolder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l9.1744"></a><span id="l9.1744" class="difflineplus">+                                         createLocalSubfolder(outlineName);</span>
<a href="#l9.1745"></a><span id="l9.1745" class="difflineplus">+              folderOutlines++;</span>
<a href="#l9.1746"></a><span id="l9.1746" class="difflineplus">+            }</span>
<a href="#l9.1747"></a><span id="l9.1747" class="difflineplus">+            catch (ex) {</span>
<a href="#l9.1748"></a><span id="l9.1748" class="difflineplus">+              // An error creating.  This can happen in (rare, if user manually</span>
<a href="#l9.1749"></a><span id="l9.1749" class="difflineplus">+              // deletes .msf or panacea or such) cases of mismatched folder</span>
<a href="#l9.1750"></a><span id="l9.1750" class="difflineplus">+              // names and hashed names and files on disk.  Skip it.</span>
<a href="#l9.1751"></a><span id="l9.1751" class="difflineplus">+              FeedUtils.log.error(&quot;importOPMLOutlines: skipping, error creating &quot; +</span>
<a href="#l9.1752"></a><span id="l9.1752" class="difflineplus">+                                  &quot; folder - '&quot; + outlineName +</span>
<a href="#l9.1753"></a><span id="l9.1753" class="difflineplus">+                                  &quot;' in parent folder &quot; + aParentFolder.filePath.path);</span>
<a href="#l9.1754"></a><span id="l9.1754" class="difflineplus">+              badTag = true;</span>
<a href="#l9.1755"></a><span id="l9.1755" class="difflineplus">+              break;</span>
<a href="#l9.1756"></a><span id="l9.1756" class="difflineplus">+            }</span>
<a href="#l9.1757"></a><span id="l9.1757" class="difflineplus">+          }</span>
<a href="#l9.1758"></a><span id="l9.1758" class="difflineplus">+        }</span>
<a href="#l9.1759"></a><span id="l9.1759" class="difflineplus">+        break;</span>
<a href="#l9.1760"></a><span id="l9.1760" class="difflineplus">+      }</span>
<a href="#l9.1761"></a><span id="l9.1761" class="difflineplus">+</span>
<a href="#l9.1762"></a><span id="l9.1762" class="difflineplus">+      if (!outline.childElementCount || badTag)</span>
<a href="#l9.1763"></a><span id="l9.1763" class="difflineplus">+      {</span>
<a href="#l9.1764"></a><span id="l9.1764" class="difflineplus">+        // Remove leaf nodes that are processed or bad tags from the opml dom,</span>
<a href="#l9.1765"></a><span id="l9.1765" class="difflineplus">+        // and go back to reparse.  This method lets us use setTimeout to</span>
<a href="#l9.1766"></a><span id="l9.1766" class="difflineplus">+        // prevent UI hang, in situations of both deep and shallow trees.</span>
<a href="#l9.1767"></a><span id="l9.1767" class="difflineplus">+        // A yield/generator.next() method is fine for shallow trees, but not</span>
<a href="#l9.1768"></a><span id="l9.1768" class="difflineplus">+        // the true recursion required for deeper trees; both the shallow loop</span>
<a href="#l9.1769"></a><span id="l9.1769" class="difflineplus">+        // and the recurse should give it up.</span>
<a href="#l9.1770"></a><span id="l9.1770" class="difflineplus">+        aParentNode.removeChild(outline);</span>
<a href="#l9.1771"></a><span id="l9.1771" class="difflineplus">+        badTag = false;</span>
<a href="#l9.1772"></a><span id="l9.1772" class="difflineplus">+        outline = aBody;</span>
<a href="#l9.1773"></a><span id="l9.1773" class="difflineplus">+        feedFolder = rssServer.rootFolder;</span>
<a href="#l9.1774"></a><span id="l9.1774" class="difflineplus">+      }</span>
<a href="#l9.1775"></a><span id="l9.1775" class="difflineplus">+</span>
<a href="#l9.1776"></a><span id="l9.1776" class="difflineplus">+      setTimeout(function() {</span>
<a href="#l9.1777"></a><span id="l9.1777" class="difflineplus">+        processor(outline, feedFolder);</span>
<a href="#l9.1778"></a><span id="l9.1778" class="difflineplus">+      }, 0);</span>
<a href="#l9.1779"></a><span id="l9.1779">     }</span>
<a href="#l9.1780"></a><span id="l9.1780"> </span>
<a href="#l9.1781"></a><span id="l9.1781" class="difflineminus">-    let feedName = aOutline.getAttribute(&quot;text&quot;) ||</span>
<a href="#l9.1782"></a><span id="l9.1782" class="difflineminus">-                   aOutline.getAttribute(&quot;title&quot;) ||</span>
<a href="#l9.1783"></a><span id="l9.1783" class="difflineminus">-                   aOutline.getAttribute(&quot;xmlUrl&quot;);</span>
<a href="#l9.1784"></a><span id="l9.1784" class="difflineminus">-</span>
<a href="#l9.1785"></a><span id="l9.1785" class="difflineminus">-    let defaultQuickMode = this.mRSSServer.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l9.1786"></a><span id="l9.1786" class="difflineminus">-    let feedProperties = { feedName     : feedName,</span>
<a href="#l9.1787"></a><span id="l9.1787" class="difflineminus">-                           feedLocation : newFeedUrl,</span>
<a href="#l9.1788"></a><span id="l9.1788" class="difflineminus">-                           server       : this.mRSSServer,</span>
<a href="#l9.1789"></a><span id="l9.1789" class="difflineminus">-                           folderURI    : &quot;&quot;,</span>
<a href="#l9.1790"></a><span id="l9.1790" class="difflineminus">-                           quickMode    : defaultQuickMode};</span>
<a href="#l9.1791"></a><span id="l9.1791" class="difflineminus">-</span>
<a href="#l9.1792"></a><span id="l9.1792" class="difflineminus">-    FeedUtils.log.debug(&quot;importOutline: importing feed: name, url - &quot;+</span>
<a href="#l9.1793"></a><span id="l9.1793" class="difflineminus">-                        feedName+&quot;, &quot;+newFeedUrl);</span>
<a href="#l9.1794"></a><span id="l9.1794" class="difflineplus">+    processor(aBody, rssServer.rootFolder);</span>
<a href="#l9.1795"></a><span id="l9.1795" class="difflineplus">+  },</span>
<a href="#l9.1796"></a><span id="l9.1796"> </span>
<a href="#l9.1797"></a><span id="l9.1797" class="difflineminus">-    let feed = this.storeFeed(feedProperties);</span>
<a href="#l9.1798"></a><span id="l9.1798" class="difflineminus">-    feed.title = feedProperties.feedName;</span>
<a href="#l9.1799"></a><span id="l9.1799" class="difflineminus">-    if (aOutline.hasAttribute(&quot;htmlUrl&quot;))</span>
<a href="#l9.1800"></a><span id="l9.1800" class="difflineminus">-      feed.link = aOutline.getAttribute(&quot;htmlUrl&quot;);</span>
<a href="#l9.1801"></a><span id="l9.1801" class="difflineminus">-</span>
<a href="#l9.1802"></a><span id="l9.1802" class="difflineminus">-    feed.createFolder();</span>
<a href="#l9.1803"></a><span id="l9.1803" class="difflineminus">-    FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l9.1804"></a><span id="l9.1804" class="difflineplus">+  importOPMLStatus: function(aFeedsAdded, aRssOutlines, aFolderOutlines)</span>
<a href="#l9.1805"></a><span id="l9.1805" class="difflineplus">+  {</span>
<a href="#l9.1806"></a><span id="l9.1806" class="difflineplus">+    let statusReport;</span>
<a href="#l9.1807"></a><span id="l9.1807" class="difflineplus">+    if (aRssOutlines &gt; aFeedsAdded)</span>
<a href="#l9.1808"></a><span id="l9.1808" class="difflineplus">+      statusReport = FeedUtils.strings.formatStringFromName(&quot;subscribe-OPMLImportStatus&quot;,</span>
<a href="#l9.1809"></a><span id="l9.1809" class="difflineplus">+        [PluralForm.get(aFeedsAdded,</span>
<a href="#l9.1810"></a><span id="l9.1810" class="difflineplus">+                        FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportUniqueFeeds&quot;))</span>
<a href="#l9.1811"></a><span id="l9.1811" class="difflineplus">+                   .replace(&quot;#1&quot;, aFeedsAdded),</span>
<a href="#l9.1812"></a><span id="l9.1812" class="difflineplus">+         PluralForm.get(aRssOutlines,</span>
<a href="#l9.1813"></a><span id="l9.1813" class="difflineplus">+                        FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportFoundFeeds&quot;))</span>
<a href="#l9.1814"></a><span id="l9.1814" class="difflineplus">+                   .replace(&quot;#1&quot;, aRssOutlines)], 2);</span>
<a href="#l9.1815"></a><span id="l9.1815" class="difflineplus">+    else</span>
<a href="#l9.1816"></a><span id="l9.1816" class="difflineplus">+      statusReport = PluralForm.get(aFeedsAdded,</span>
<a href="#l9.1817"></a><span id="l9.1817" class="difflineplus">+        FeedUtils.strings.GetStringFromName(&quot;subscribe-OPMLImportFeedCount&quot;))</span>
<a href="#l9.1818"></a><span id="l9.1818" class="difflineplus">+                         .replace(&quot;#1&quot;, aFeedsAdded);</span>
<a href="#l9.1819"></a><span id="l9.1819"> </span>
<a href="#l9.1820"></a><span id="l9.1820" class="difflineminus">-    // addFeed adds the feed we have validated and downloaded to</span>
<a href="#l9.1821"></a><span id="l9.1821" class="difflineminus">-    // our datasource, it also flushes the subscription datasource.</span>
<a href="#l9.1822"></a><span id="l9.1822" class="difflineminus">-    FeedUtils.addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l9.1823"></a><span id="l9.1823" class="difflineminus">-    // Feed correctly added.</span>
<a href="#l9.1824"></a><span id="l9.1824" class="difflineminus">-    return 1;</span>
<a href="#l9.1825"></a><span id="l9.1825" class="difflineplus">+    return statusReport;</span>
<a href="#l9.1826"></a><span id="l9.1826" class="difflineplus">+  },</span>
<a href="#l9.1827"></a><span id="l9.1827" class="difflineplus">+</span>
<a href="#l9.1828"></a><span id="l9.1828" class="difflineplus">+  importOPMLFinished: function(aStatusReport, aLastFolder, aWin)</span>
<a href="#l9.1829"></a><span id="l9.1829" class="difflineplus">+  {</span>
<a href="#l9.1830"></a><span id="l9.1830" class="difflineplus">+    if (aLastFolder)</span>
<a href="#l9.1831"></a><span id="l9.1831" class="difflineplus">+    {</span>
<a href="#l9.1832"></a><span id="l9.1832" class="difflineplus">+      aWin.selectFolder(aLastFolder, { select: false, newFolder: aLastFolder });</span>
<a href="#l9.1833"></a><span id="l9.1833" class="difflineplus">+      aWin.selectFolder(aLastFolder.parent);</span>
<a href="#l9.1834"></a><span id="l9.1834" class="difflineplus">+    }</span>
<a href="#l9.1835"></a><span id="l9.1835" class="difflineplus">+    aWin.mActionMode = null;</span>
<a href="#l9.1836"></a><span id="l9.1836" class="difflineplus">+    aWin.updateButtons(aWin.mView.currentItem);</span>
<a href="#l9.1837"></a><span id="l9.1837" class="difflineplus">+    aWin.clearStatusInfo();</span>
<a href="#l9.1838"></a><span id="l9.1838" class="difflineplus">+    aWin.updateStatusItem(&quot;statusText&quot;, aStatusReport);</span>
<a href="#l9.1839"></a><span id="l9.1839">   }</span>
<a href="#l9.1840"></a><span id="l9.1840" class="difflineplus">+</span>
<a href="#l9.1841"></a><span id="l9.1841"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.xul</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.xul</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -14,20 +14,20 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &lt;window id=&quot;subscriptionsDialog&quot;</span>
<a href="#l10.5"></a><span id="l10.5">         flex=&quot;1&quot;</span>
<a href="#l10.6"></a><span id="l10.6">         title=&quot;&amp;feedSubscriptions.label;&quot;</span>
<a href="#l10.7"></a><span id="l10.7">         windowtype=&quot;Mail:News-BlogSubscriptions&quot;</span>
<a href="#l10.8"></a><span id="l10.8">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l10.9"></a><span id="l10.9">         xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l10.10"></a><span id="l10.10">         xmlns:nc=&quot;http://home.netscape.com/NC-rdf#&quot;</span>
<a href="#l10.11"></a><span id="l10.11">         persist=&quot;width height screenX screenY sizemode&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        onload=&quot;gFeedSubscriptionsWindow.onLoad();&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-        onunload=&quot;return gFeedSubscriptionsWindow.onUnload();&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-        onkeypress=&quot;gFeedSubscriptionsWindow.onKeyPress(event);&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-        onmousedown=&quot;gFeedSubscriptionsWindow.onMouseDown(event);&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+        onload=&quot;FeedSubscriptions.onLoad();&quot;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+        onunload=&quot;return FeedSubscriptions.onUnload();&quot;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+        onkeypress=&quot;FeedSubscriptions.onKeyPress(event);&quot;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+        onmousedown=&quot;FeedSubscriptions.onMouseDown(event);&quot;&gt;</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l10.22"></a><span id="l10.22">           src=&quot;chrome://messenger-newsblog/content/utils.js&quot;/&gt;</span>
<a href="#l10.23"></a><span id="l10.23">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l10.24"></a><span id="l10.24">           src=&quot;chrome://messenger-newsblog/content/feed-subscriptions.js&quot;/&gt;</span>
<a href="#l10.25"></a><span id="l10.25">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l10.26"></a><span id="l10.26">           src=&quot;chrome://messenger-newsblog/content/Feed.js&quot;/&gt;</span>
<a href="#l10.27"></a><span id="l10.27">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -54,27 +54,27 @@</span>
<a href="#l10.29"></a><span id="l10.29">     &lt;description control=&quot;rssSubscriptionsList&quot;&gt;&amp;subscriptionDesc.label;&lt;/description&gt;</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">     &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">     &lt;tree id=&quot;rssSubscriptionsList&quot;</span>
<a href="#l10.34"></a><span id="l10.34">           treelines=&quot;true&quot;</span>
<a href="#l10.35"></a><span id="l10.35">           flex=&quot;1&quot;</span>
<a href="#l10.36"></a><span id="l10.36">           hidecolumnpicker=&quot;true&quot;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-          onselect=&quot;gFeedSubscriptionsWindow.onSelect();&quot;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+          onselect=&quot;FeedSubscriptions.onSelect();&quot;</span>
<a href="#l10.39"></a><span id="l10.39">           seltype=&quot;single&quot;&gt;</span>
<a href="#l10.40"></a><span id="l10.40">       &lt;treecols&gt;</span>
<a href="#l10.41"></a><span id="l10.41">         &lt;treecol id=&quot;folderNameCol&quot;</span>
<a href="#l10.42"></a><span id="l10.42">                  flex=&quot;2&quot;</span>
<a href="#l10.43"></a><span id="l10.43">                  primary=&quot;true&quot;</span>
<a href="#l10.44"></a><span id="l10.44">                  hideheader=&quot;true&quot;/&gt;</span>
<a href="#l10.45"></a><span id="l10.45">       &lt;/treecols&gt;</span>
<a href="#l10.46"></a><span id="l10.46">       &lt;treechildren id=&quot;subscriptionChildren&quot;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-                    ondragstart=&quot;gFeedSubscriptionsWindow.onDragStart(event);&quot;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-                    ondragover=&quot;gFeedSubscriptionsWindow.onDragOver(event);&quot;/&gt;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+                    ondragstart=&quot;FeedSubscriptions.onDragStart(event);&quot;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+                    ondragover=&quot;FeedSubscriptions.onDragOver(event);&quot;/&gt;</span>
<a href="#l10.51"></a><span id="l10.51">     &lt;/tree&gt;</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">     &lt;hbox id=&quot;rssFeedInfoBox&quot;&gt;</span>
<a href="#l10.54"></a><span id="l10.54">       &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l10.55"></a><span id="l10.55">         &lt;grid flex=&quot;1&quot;&gt;</span>
<a href="#l10.56"></a><span id="l10.56">           &lt;columns&gt;</span>
<a href="#l10.57"></a><span id="l10.57">             &lt;column/&gt;</span>
<a href="#l10.58"></a><span id="l10.58">             &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineat">@@ -98,24 +98,24 @@</span>
<a href="#l10.60"></a><span id="l10.60">                        value=&quot;&amp;feedLocation.label;&quot;/&gt;</span>
<a href="#l10.61"></a><span id="l10.61">               &lt;/hbox&gt;</span>
<a href="#l10.62"></a><span id="l10.62">               &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l10.63"></a><span id="l10.63">                 &lt;textbox id=&quot;locationValue&quot;</span>
<a href="#l10.64"></a><span id="l10.64">                          flex=&quot;1&quot;</span>
<a href="#l10.65"></a><span id="l10.65">                          class=&quot;uri-element&quot;</span>
<a href="#l10.66"></a><span id="l10.66">                          placeholder=&quot;&amp;feedLocation.placeholder;&quot;</span>
<a href="#l10.67"></a><span id="l10.67">                          clickSelectsAll=&quot;true&quot;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-                         onfocus=&quot;gFeedSubscriptionsWindow.setSummaryFocus();&quot;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-                         onblur=&quot;gFeedSubscriptionsWindow.setSummaryFocus();&quot;/&gt;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+                         onfocus=&quot;FeedSubscriptions.setSummaryFocus();&quot;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+                         onblur=&quot;FeedSubscriptions.setSummaryFocus();&quot;/&gt;</span>
<a href="#l10.72"></a><span id="l10.72">                 &lt;label id=&quot;locationValidate&quot;</span>
<a href="#l10.73"></a><span id="l10.73">                        collapsed=&quot;true&quot;</span>
<a href="#l10.74"></a><span id="l10.74">                        class=&quot;text-link&quot;</span>
<a href="#l10.75"></a><span id="l10.75">                        crop=&quot;end&quot;</span>
<a href="#l10.76"></a><span id="l10.76">                        value=&quot;&amp;locationValidate.label;&quot;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-                       onclick=&quot;gFeedSubscriptionsWindow.checkValidation(event);&quot;/&gt;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+                       onclick=&quot;FeedSubscriptions.checkValidation(event);&quot;/&gt;</span>
<a href="#l10.79"></a><span id="l10.79">               &lt;/hbox&gt;</span>
<a href="#l10.80"></a><span id="l10.80">             &lt;/row&gt;</span>
<a href="#l10.81"></a><span id="l10.81">             &lt;row&gt;</span>
<a href="#l10.82"></a><span id="l10.82">               &lt;hbox align=&quot;right&quot; valign=&quot;middle&quot;&gt;</span>
<a href="#l10.83"></a><span id="l10.83">                 &lt;label id=&quot;feedFolderLabel&quot;</span>
<a href="#l10.84"></a><span id="l10.84">                        value=&quot;&amp;feedFolder.label;&quot;</span>
<a href="#l10.85"></a><span id="l10.85">                        accesskey=&quot;&amp;feedFolder.accesskey;&quot;</span>
<a href="#l10.86"></a><span id="l10.86">                        control=&quot;selectFolder&quot;/&gt;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineat">@@ -126,80 +126,80 @@</span>
<a href="#l10.88"></a><span id="l10.88">                           class=&quot;folderMenuItem&quot;</span>
<a href="#l10.89"></a><span id="l10.89">                           hidden=&quot;true&quot;&gt;</span>
<a href="#l10.90"></a><span id="l10.90">                   &lt;menupopup id=&quot;selectFolderPopup&quot;</span>
<a href="#l10.91"></a><span id="l10.91">                              class=&quot;folderLocationPopup&quot;</span>
<a href="#l10.92"></a><span id="l10.92">                              type=&quot;folder&quot;</span>
<a href="#l10.93"></a><span id="l10.93">                              mode=&quot;feeds&quot;</span>
<a href="#l10.94"></a><span id="l10.94">                              showFileHereLabel=&quot;true&quot;</span>
<a href="#l10.95"></a><span id="l10.95">                              showAccountsFileHere=&quot;true&quot;</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-                             oncommand=&quot;gFeedSubscriptionsWindow.setFolderPicker(event.target._folder)&quot;/&gt;</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+                             oncommand=&quot;FeedSubscriptions.setFolderPicker(event.target._folder)&quot;/&gt;</span>
<a href="#l10.98"></a><span id="l10.98">                 &lt;/menulist&gt;</span>
<a href="#l10.99"></a><span id="l10.99">                 &lt;textbox id=&quot;selectFolderValue&quot;</span>
<a href="#l10.100"></a><span id="l10.100">                          flex=&quot;1&quot;</span>
<a href="#l10.101"></a><span id="l10.101">                          readonly=&quot;true&quot;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-                         onkeypress=&quot;gFeedSubscriptionsWindow.onClickSelectFolderValue(event)&quot;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-                         onclick=&quot;gFeedSubscriptionsWindow.onClickSelectFolderValue(event)&quot;/&gt;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+                         onkeypress=&quot;FeedSubscriptions.onClickSelectFolderValue(event)&quot;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+                         onclick=&quot;FeedSubscriptions.onClickSelectFolderValue(event)&quot;/&gt;</span>
<a href="#l10.106"></a><span id="l10.106">               &lt;/hbox&gt;</span>
<a href="#l10.107"></a><span id="l10.107">             &lt;/row&gt;</span>
<a href="#l10.108"></a><span id="l10.108">           &lt;/rows&gt;</span>
<a href="#l10.109"></a><span id="l10.109">         &lt;/grid&gt;</span>
<a href="#l10.110"></a><span id="l10.110">         &lt;checkbox id=&quot;quickMode&quot;</span>
<a href="#l10.111"></a><span id="l10.111">                   accesskey=&quot;&amp;quickMode.accesskey;&quot;</span>
<a href="#l10.112"></a><span id="l10.112">                   label=&quot;&amp;quickMode.label;&quot;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-                  oncommand=&quot;gFeedSubscriptionsWindow.setSummary(this.checked)&quot;/&gt;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+                  oncommand=&quot;FeedSubscriptions.setSummary(this.checked)&quot;/&gt;</span>
<a href="#l10.115"></a><span id="l10.115">       &lt;/vbox&gt;</span>
<a href="#l10.116"></a><span id="l10.116">     &lt;/hbox&gt;</span>
<a href="#l10.117"></a><span id="l10.117"> </span>
<a href="#l10.118"></a><span id="l10.118">     &lt;hbox id=&quot;statusContainerBox&quot;</span>
<a href="#l10.119"></a><span id="l10.119">           align=&quot;center&quot;</span>
<a href="#l10.120"></a><span id="l10.120">           valign=&quot;middle&quot;&gt;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-      &lt;label id=&quot;statusText&quot;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-             class=&quot;statusbarpanel-text&quot;</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-             crop=&quot;end&quot;</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-             value=&quot;&quot;/&gt;</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+      &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+        &lt;description id=&quot;statusText&quot;/&gt;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+      &lt;/vbox&gt;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+      &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l10.129"></a><span id="l10.129">       &lt;label id=&quot;validationText&quot;</span>
<a href="#l10.130"></a><span id="l10.130">              collapsed=&quot;true&quot;</span>
<a href="#l10.131"></a><span id="l10.131">              class=&quot;text-link&quot;</span>
<a href="#l10.132"></a><span id="l10.132">              crop=&quot;end&quot;</span>
<a href="#l10.133"></a><span id="l10.133">              value=&quot;&amp;validateText.label;&quot;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-             onclick=&quot;gFeedSubscriptionsWindow.checkValidation(event);&quot;/&gt;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-      &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+             onclick=&quot;FeedSubscriptions.checkValidation(event);&quot;/&gt;</span>
<a href="#l10.137"></a><span id="l10.137">       &lt;progressmeter id=&quot;progressMeter&quot;</span>
<a href="#l10.138"></a><span id="l10.138">                      collapsed=&quot;true&quot;</span>
<a href="#l10.139"></a><span id="l10.139">                      mode=&quot;determined&quot;</span>
<a href="#l10.140"></a><span id="l10.140">                      value=&quot;0&quot;/&gt;</span>
<a href="#l10.141"></a><span id="l10.141">     &lt;/hbox&gt;</span>
<a href="#l10.142"></a><span id="l10.142"> </span>
<a href="#l10.143"></a><span id="l10.143">     &lt;hbox align=&quot;end&quot;&gt;</span>
<a href="#l10.144"></a><span id="l10.144">       &lt;hbox class=&quot;actionButtons&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l10.145"></a><span id="l10.145">         &lt;button id=&quot;addFeed&quot;</span>
<a href="#l10.146"></a><span id="l10.146">                 label=&quot;&amp;button.addFeed.label;&quot;</span>
<a href="#l10.147"></a><span id="l10.147">                 accesskey=&quot;&amp;button.addFeed.accesskey;&quot;</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-                oncommand=&quot;gFeedSubscriptionsWindow.addFeed();&quot;/&gt;</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+                oncommand=&quot;FeedSubscriptions.addFeed();&quot;/&gt;</span>
<a href="#l10.150"></a><span id="l10.150"> </span>
<a href="#l10.151"></a><span id="l10.151">         &lt;button id=&quot;editFeed&quot;</span>
<a href="#l10.152"></a><span id="l10.152">                 disabled=&quot;true&quot;</span>
<a href="#l10.153"></a><span id="l10.153">                 label=&quot;&amp;button.editFeed.label;&quot;</span>
<a href="#l10.154"></a><span id="l10.154">                 accesskey=&quot;&amp;button.editFeed.accesskey;&quot;</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-                oncommand=&quot;gFeedSubscriptionsWindow.editFeed();&quot;/&gt;</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+                oncommand=&quot;FeedSubscriptions.editFeed();&quot;/&gt;</span>
<a href="#l10.157"></a><span id="l10.157"> </span>
<a href="#l10.158"></a><span id="l10.158">         &lt;button id=&quot;removeFeed&quot;</span>
<a href="#l10.159"></a><span id="l10.159">                 disabled=&quot;true&quot;</span>
<a href="#l10.160"></a><span id="l10.160">                 label=&quot;&amp;button.removeFeed.label;&quot;</span>
<a href="#l10.161"></a><span id="l10.161">                 accesskey=&quot;&amp;button.removeFeed.accesskey;&quot;</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-                oncommand=&quot;gFeedSubscriptionsWindow.removeFeed(true);&quot;/&gt;</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+                oncommand=&quot;FeedSubscriptions.removeFeed(true);&quot;/&gt;</span>
<a href="#l10.164"></a><span id="l10.164"> </span>
<a href="#l10.165"></a><span id="l10.165">         &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l10.166"></a><span id="l10.166"> </span>
<a href="#l10.167"></a><span id="l10.167">         &lt;button id=&quot;importOPML&quot;</span>
<a href="#l10.168"></a><span id="l10.168">                 label=&quot;&amp;button.importOPML.label;&quot;</span>
<a href="#l10.169"></a><span id="l10.169">                 accesskey=&quot;&amp;button.importOPML.accesskey;&quot;</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-                oncommand=&quot;gFeedSubscriptionsWindow.importOPML();&quot;/&gt;</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+                oncommand=&quot;FeedSubscriptions.importOPML();&quot;/&gt;</span>
<a href="#l10.172"></a><span id="l10.172"> </span>
<a href="#l10.173"></a><span id="l10.173">         &lt;button id=&quot;exportOPML&quot;</span>
<a href="#l10.174"></a><span id="l10.174">                 label=&quot;&amp;button.exportOPML.label;&quot;</span>
<a href="#l10.175"></a><span id="l10.175">                 accesskey=&quot;&amp;button.exportOPML.accesskey;&quot;</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-                oncommand=&quot;gFeedSubscriptionsWindow.exportOPML();&quot;/&gt;</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+                tooltiptext=&quot;&amp;button.exportOPML.tooltip;&quot;</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+                oncommand=&quot;FeedSubscriptions.exportOPML(event);&quot;/&gt;</span>
<a href="#l10.179"></a><span id="l10.179">       &lt;/hbox&gt;</span>
<a href="#l10.180"></a><span id="l10.180">     &lt;/hbox&gt;</span>
<a href="#l10.181"></a><span id="l10.181">   &lt;/vbox&gt;</span>
<a href="#l10.182"></a><span id="l10.182"> &lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -11,17 +11,22 @@ function openSubscriptionsDialog(aFolder</span>
<a href="#l11.4"></a><span id="l11.4"> {</span>
<a href="#l11.5"></a><span id="l11.5">   // Check for an existing feed subscriptions window and focus it.</span>
<a href="#l11.6"></a><span id="l11.6">   let subscriptionsWindow =</span>
<a href="#l11.7"></a><span id="l11.7">     Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   if (subscriptionsWindow)</span>
<a href="#l11.10"></a><span id="l11.10">   {</span>
<a href="#l11.11"></a><span id="l11.11">     if (aFolder)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      subscriptionsWindow.gFeedSubscriptionsWindow.selectFolder(aFolder);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+      subscriptionsWindow.FeedSubscriptions.selectFolder(aFolder);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+      subscriptionsWindow.FeedSubscriptions.mView.treeBox.ensureRowIsVisible(</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+        subscriptionsWindow.FeedSubscriptions.mView.selection.currentIndex);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    }</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+</span>
<a href="#l11.19"></a><span id="l11.19">     subscriptionsWindow.focus();</span>
<a href="#l11.20"></a><span id="l11.20">   }</span>
<a href="#l11.21"></a><span id="l11.21">   else</span>
<a href="#l11.22"></a><span id="l11.22">   {</span>
<a href="#l11.23"></a><span id="l11.23">     window.openDialog(&quot;chrome://messenger-newsblog/content/feed-subscriptions.xul&quot;,</span>
<a href="#l11.24"></a><span id="l11.24">                       &quot;&quot;, &quot;centerscreen,chrome,dialog=no,resizable&quot;,</span>
<a href="#l11.25"></a><span id="l11.25">                       { folder: aFolder});</span>
<a href="#l11.26"></a><span id="l11.26">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -78,16 +78,88 @@ var FeedUtils = {</span>
<a href="#l12.4"></a><span id="l12.4">   kNewsBlogInvalidFeed: 1,</span>
<a href="#l12.5"></a><span id="l12.5">   // Generic networking failure when trying to download the feed.</span>
<a href="#l12.6"></a><span id="l12.6">   kNewsBlogRequestFailure: 2,</span>
<a href="#l12.7"></a><span id="l12.7">   kNewsBlogFeedIsBusy: 3,</span>
<a href="#l12.8"></a><span id="l12.8">   // There are no new articles for this feed</span>
<a href="#l12.9"></a><span id="l12.9">   kNewsBlogNoNewItems: 4,</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> /**</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ * Get all rss account servers rootFolders.</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * </span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * @return array of nsIMsgIncomingServer (empty array if none).</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ */</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  getAllRssServerRootFolders: function() {</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    let rssRootFolders = [];</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    let allServers = MailServices.accounts.allServers;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+    for (let i = 0; i &lt; allServers.Count(); i++)</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    {</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+      let server = allServers.QueryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+      if (server &amp;&amp; server.type == &quot;rss&quot;)</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+        rssRootFolders.push(server.rootFolder);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    }</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+    // By default, Tb sorts by hostname, ie Feeds, Feeds-1, and not by alpha</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    // prettyName.  Do the same as a stock install to match folderpane order.</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+    rssRootFolders.sort(function(a, b) { return a.hostname &gt; b.hostname });</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    return rssRootFolders;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+  },</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+/**</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * Create rss account.</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * </span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * @param  string [aName] - optional account name to override default.</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * @return nsIMsgAccount.</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ */</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  createRssAccount: function(aName) {</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    let userName = &quot;nobody&quot;;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    let hostName = &quot;Feeds&quot;;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    let hostNamePref = hostName;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    let server;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    let serverType = &quot;rss&quot;;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    let defaultName = FeedUtils.strings.GetStringFromName(&quot;feeds-accountname&quot;);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    let i = 2;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    while (MailServices.accounts.findRealServer(userName, hostName, serverType, 0))</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+      // If &quot;Feeds&quot; exists, try &quot;Feeds-2&quot;, then &quot;Feeds-3&quot;, etc.</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+      hostName = hostNamePref + &quot;-&quot; + i++;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    server = MailServices.accounts.createIncomingServer(userName, hostName, serverType);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    server.biffMinutes = FeedUtils.kBiffMinutesDefault;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    server.prettyName = aName ? aName : defaultName;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    server.valid = true;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    let account = MailServices.accounts.createAccount();</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+    account.incomingServer = server;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+    // Create &quot;Local Folders&quot; if none exist yet as it's guaranteed that</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    // those exist when any account exists.</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    let localFolders;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    try {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+      localFolders = MailServices.accounts.localFoldersServer;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    }</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+    catch (ex) {}</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+    if (!localFolders)</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+      MailServices.accounts.createLocalMailAccount();</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    // Save new accounts in case of a crash.</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    try {</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+      MailServices.accounts.saveAccountInfo();</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    }</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    catch (ex) {</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+      this.log.error(&quot;FeedUtils.createRssAccount: error on saveAccountInfo - &quot; + ex);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+    }</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    this.log.debug(&quot;FeedUtils.createRssAccount: &quot; +</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+                   account.incomingServer.rootFolder.prettyName);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+    return account;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  },</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+/**</span>
<a href="#l12.84"></a><span id="l12.84">  * Helper routine that checks our subscriptions list array and returns</span>
<a href="#l12.85"></a><span id="l12.85">  * true if the url is already in our list.  This is used to prevent the</span>
<a href="#l12.86"></a><span id="l12.86">  * user from subscribing to the same feed multiple times for the same server.</span>
<a href="#l12.87"></a><span id="l12.87">  * </span>
<a href="#l12.88"></a><span id="l12.88">  * @param  string aUrl                  - the url.</span>
<a href="#l12.89"></a><span id="l12.89">  * @param  nsIMsgIncomingServer aServer - account server.</span>
<a href="#l12.90"></a><span id="l12.90">  * @return boolean                      - true if exists else false.</span>
<a href="#l12.91"></a><span id="l12.91">  */</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineat">@@ -217,29 +289,29 @@ var FeedUtils = {</span>
<a href="#l12.93"></a><span id="l12.93">             try {</span>
<a href="#l12.94"></a><span id="l12.94">               let id = this.rdf.GetResource(url);</span>
<a href="#l12.95"></a><span id="l12.95">               // Get the node for the current folder URI.</span>
<a href="#l12.96"></a><span id="l12.96">               let node = ds.GetTarget(id, this.FZ_DESTFOLDER, true);</span>
<a href="#l12.97"></a><span id="l12.97">               if (node)</span>
<a href="#l12.98"></a><span id="l12.98">               {</span>
<a href="#l12.99"></a><span id="l12.99">                 ds.Change(id, this.FZ_DESTFOLDER, node, resource);</span>
<a href="#l12.100"></a><span id="l12.100">                 this.log.debug(&quot;getFeedUrlsInFolder: sync update folder:url - &quot; +</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-                               aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+                               aFolder.filePath.path + &quot; : &quot; + url);</span>
<a href="#l12.103"></a><span id="l12.103">               }</span>
<a href="#l12.104"></a><span id="l12.104">               else</span>
<a href="#l12.105"></a><span id="l12.105">               {</span>
<a href="#l12.106"></a><span id="l12.106">                 this.addFeed(url, null, aFolder);</span>
<a href="#l12.107"></a><span id="l12.107">                 this.log.debug(&quot;getFeedUrlsInFolder: sync add folder:url - &quot; +</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-                               aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+                               aFolder.filePath.path + &quot; : &quot; + url);</span>
<a href="#l12.110"></a><span id="l12.110">               }</span>
<a href="#l12.111"></a><span id="l12.111">             }</span>
<a href="#l12.112"></a><span id="l12.112">             catch (ex) {</span>
<a href="#l12.113"></a><span id="l12.113">               this.log.debug(&quot;getFeedUrlsInFolder: error - &quot; + ex);</span>
<a href="#l12.114"></a><span id="l12.114">               this.log.debug(&quot;getFeedUrlsInFolder: sync failed for folder:url - &quot; +</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-                             aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+                             aFolder.filePath.path + &quot; : &quot; + url);</span>
<a href="#l12.117"></a><span id="l12.117">             }</span>
<a href="#l12.118"></a><span id="l12.118">         }, this);</span>
<a href="#l12.119"></a><span id="l12.119">         ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l12.120"></a><span id="l12.120">   </span>
<a href="#l12.121"></a><span id="l12.121">         // Set property on folder so we don't come here ever again.</span>
<a href="#l12.122"></a><span id="l12.122">         aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l12.123"></a><span id="l12.123">         aFolder.msgDatabase = null;</span>
<a href="#l12.124"></a><span id="l12.124">   </span>
<a href="#l12.125"></a><span id="l12.125" class="difflineat">@@ -271,17 +343,17 @@ var FeedUtils = {</span>
<a href="#l12.126"></a><span id="l12.126">                      aFolder.filePath.path);</span>
<a href="#l12.127"></a><span id="l12.127">     }</span>
<a href="#l12.128"></a><span id="l12.128">   </span>
<a href="#l12.129"></a><span id="l12.129">     feedurls = feedUrlArray.join(this.kFeedUrlDelimiter);</span>
<a href="#l12.130"></a><span id="l12.130">     if (feedurls)</span>
<a href="#l12.131"></a><span id="l12.131">     {</span>
<a href="#l12.132"></a><span id="l12.132">       aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l12.133"></a><span id="l12.133">       this.log.debug(&quot;getFeedUrlsInFolder: got urls from db, folder:feedUrl - &quot; +</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-                     aFolder.filePath.path+&quot; : &quot;+feedurls);</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+                     aFolder.filePath.path + &quot; : &quot; + feedurls);</span>
<a href="#l12.136"></a><span id="l12.136">     }</span>
<a href="#l12.137"></a><span id="l12.137">     else</span>
<a href="#l12.138"></a><span id="l12.138">       this.log.trace(&quot;getFeedUrlsInFolder: no urls from db, folder - &quot; +</span>
<a href="#l12.139"></a><span id="l12.139">                      aFolder.filePath.path);</span>
<a href="#l12.140"></a><span id="l12.140">   </span>
<a href="#l12.141"></a><span id="l12.141">     return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l12.142"></a><span id="l12.142">   },</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144" class="difflineat">@@ -468,34 +540,34 @@ var FeedUtils = {</span>
<a href="#l12.145"></a><span id="l12.145">     let uri = Cc[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l12.146"></a><span id="l12.146">               createInstance(Ci.nsIURI);</span>
<a href="#l12.147"></a><span id="l12.147"> </span>
<a href="#l12.148"></a><span id="l12.148">     if (dt.getData(types[0]))</span>
<a href="#l12.149"></a><span id="l12.149">     {</span>
<a href="#l12.150"></a><span id="l12.150">       // The url is the data.</span>
<a href="#l12.151"></a><span id="l12.151">       uri.spec = dt.mozGetDataAt(types[0], 0);</span>
<a href="#l12.152"></a><span id="l12.152">       validUri = this.isValidScheme(uri);</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-      this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot;+</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-                     dt.dropEffect+&quot; : &quot;+types[0]+&quot; : &quot;+uri.spec);</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+      this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot; +</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+                     dt.dropEffect + &quot; : &quot; + types[0] + &quot; : &quot; + uri.spec);</span>
<a href="#l12.157"></a><span id="l12.157">     }</span>
<a href="#l12.158"></a><span id="l12.158">     else if (dt.getData(types[1]))</span>
<a href="#l12.159"></a><span id="l12.159">     {</span>
<a href="#l12.160"></a><span id="l12.160">       // The url is the first part of the data, the second part is random.</span>
<a href="#l12.161"></a><span id="l12.161">       uri.spec = dt.mozGetDataAt(types[1], 0).split(&quot;\n&quot;)[0];</span>
<a href="#l12.162"></a><span id="l12.162">       validUri = this.isValidScheme(uri);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-      this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot;+</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-                     dt.dropEffect+&quot; : &quot;+types[0]+&quot; : &quot;+uri.spec);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+      this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot; +</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+                     dt.dropEffect + &quot; : &quot; + types[0] + &quot; : &quot; + uri.spec);</span>
<a href="#l12.167"></a><span id="l12.167">     }</span>
<a href="#l12.168"></a><span id="l12.168">     else</span>
<a href="#l12.169"></a><span id="l12.169">     {</span>
<a href="#l12.170"></a><span id="l12.170">       // Go through the types and see if there's a url; get the first one.</span>
<a href="#l12.171"></a><span id="l12.171">       for (let i = 0; i &lt; dt.types.length; i++) {</span>
<a href="#l12.172"></a><span id="l12.172">         let spec = dt.mozGetDataAt(dt.types[i], 0);</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-        this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:index:type:value - &quot;+</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-                       dt.dropEffect+&quot; : &quot;+i+&quot; : &quot;+dt.types[i]+&quot; : &quot;+spec);</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+        this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:index:type:value - &quot; +</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+                       dt.dropEffect + &quot; : &quot; + i + &quot; : &quot; + dt.types[i] + &quot; : &quot;+spec);</span>
<a href="#l12.177"></a><span id="l12.177">         try {</span>
<a href="#l12.178"></a><span id="l12.178">           uri.spec = spec;</span>
<a href="#l12.179"></a><span id="l12.179">           validUri = this.isValidScheme(uri);</span>
<a href="#l12.180"></a><span id="l12.180">         }</span>
<a href="#l12.181"></a><span id="l12.181">         catch(ex) {}</span>
<a href="#l12.182"></a><span id="l12.182"> </span>
<a href="#l12.183"></a><span id="l12.183">         if (validUri)</span>
<a href="#l12.184"></a><span id="l12.184">           break;</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineat">@@ -599,17 +671,17 @@ var FeedUtils = {</span>
<a href="#l12.186"></a><span id="l12.186">     },</span>
<a href="#l12.187"></a><span id="l12.187"> </span>
<a href="#l12.188"></a><span id="l12.188">     downloaded: function(feed, aErrorCode)</span>
<a href="#l12.189"></a><span id="l12.189">     {</span>
<a href="#l12.190"></a><span id="l12.190">       let location = feed.folder ? feed.folder.filePath.path : &quot;&quot;;</span>
<a href="#l12.191"></a><span id="l12.191">       FeedUtils.log.debug(&quot;downloaded: &quot;+</span>
<a href="#l12.192"></a><span id="l12.192">                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l12.193"></a><span id="l12.193">                           &quot;errorCode:feedName:folder - &quot; +</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-                          aErrorCode+&quot; : &quot;+feed.name+&quot; : &quot;+location);</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+                          aErrorCode + &quot; : &quot; + feed.name + &quot; : &quot; + location);</span>
<a href="#l12.196"></a><span id="l12.196">       if (this.mSubscribeMode)</span>
<a href="#l12.197"></a><span id="l12.197">       {</span>
<a href="#l12.198"></a><span id="l12.198">         if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l12.199"></a><span id="l12.199">         {</span>
<a href="#l12.200"></a><span id="l12.200">           // If we get here we should always have a folder by now, either in</span>
<a href="#l12.201"></a><span id="l12.201">           // feed.folder or FeedItems created the folder for us.</span>
<a href="#l12.202"></a><span id="l12.202">           FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l12.203"></a><span id="l12.203"> </span>
<a href="#l12.204"></a><span id="l12.204" class="difflineat">@@ -621,17 +693,18 @@ var FeedUtils = {</span>
<a href="#l12.205"></a><span id="l12.205">           // feed.  This is particularly nice if we just finished subscribing</span>
<a href="#l12.206"></a><span id="l12.206">           // to a feed URL that the operating system gave us.</span>
<a href="#l12.207"></a><span id="l12.207">           this.mMsgWindow.windowCommands.selectFolder(feed.folder.URI);</span>
<a href="#l12.208"></a><span id="l12.208"> </span>
<a href="#l12.209"></a><span id="l12.209">           // Check for an existing feed subscriptions window and update it.</span>
<a href="#l12.210"></a><span id="l12.210">           let subscriptionsWindow =</span>
<a href="#l12.211"></a><span id="l12.211">               Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l12.212"></a><span id="l12.212">           if (subscriptionsWindow)</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-            subscriptionsWindow.gFeedSubscriptionsWindow.refreshSubscriptionView();</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+            subscriptionsWindow.FeedSubscriptions.</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+                                FolderListener.folderAdded(feed.folder);</span>
<a href="#l12.216"></a><span id="l12.216">         }</span>
<a href="#l12.217"></a><span id="l12.217">         else</span>
<a href="#l12.218"></a><span id="l12.218">         {</span>
<a href="#l12.219"></a><span id="l12.219">           // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l12.220"></a><span id="l12.220">           if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l12.221"></a><span id="l12.221">             FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(feed.url),</span>
<a href="#l12.222"></a><span id="l12.222">                                  feed.server,</span>
<a href="#l12.223"></a><span id="l12.223">                                  feed.server.rootFolder);</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineat">@@ -661,17 +734,17 @@ var FeedUtils = {</span>
<a href="#l12.225"></a><span id="l12.225">                       &quot;newsblog-feedNotValid&quot;, [feed.url], 1);</span>
<a href="#l12.226"></a><span id="l12.226">           break;</span>
<a href="#l12.227"></a><span id="l12.227">         case FeedUtils.kNewsBlogRequestFailure:</span>
<a href="#l12.228"></a><span id="l12.228">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l12.229"></a><span id="l12.229">                       &quot;newsblog-networkError&quot;, [feed.url], 1);</span>
<a href="#l12.230"></a><span id="l12.230">           break;</span>
<a href="#l12.231"></a><span id="l12.231">       }</span>
<a href="#l12.232"></a><span id="l12.232">       if (message)</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-        FeedUtils.log.info(&quot;downloaded: &quot;+</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+        FeedUtils.log.info(&quot;downloaded: &quot; +</span>
<a href="#l12.235"></a><span id="l12.235">                            (this.mSubscribeMode ? &quot;Subscribe: &quot; : &quot;Update: &quot;) +</span>
<a href="#l12.236"></a><span id="l12.236">                            location + message);</span>
<a href="#l12.237"></a><span id="l12.237"> </span>
<a href="#l12.238"></a><span id="l12.238">       if (this.mStatusFeedback)</span>
<a href="#l12.239"></a><span id="l12.239">       {</span>
<a href="#l12.240"></a><span id="l12.240">         this.mStatusFeedback.showStatusString(message);</span>
<a href="#l12.241"></a><span id="l12.241">         this.mStatusFeedback.stopMeteors();</span>
<a href="#l12.242"></a><span id="l12.242">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -32,33 +32,33 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l13.4"></a><span id="l13.4">     let numFolders = allFolders.Count();</span>
<a href="#l13.5"></a><span id="l13.5">     let trashFolder =</span>
<a href="#l13.6"></a><span id="l13.6">         aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">     function feeder() {</span>
<a href="#l13.9"></a><span id="l13.9">       let folder;</span>
<a href="#l13.10"></a><span id="l13.10">       for (let i = 0; i &lt; numFolders; i++) {</span>
<a href="#l13.11"></a><span id="l13.11">         folder = allFolders.GetElementAt(i).QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        FeedUtils.log.debug(&quot;downloadFeed: START x/# foldername:uri - &quot;+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                            (i+1)+&quot;/&quot;+ numFolders+&quot; &quot;+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-                            folder.name+&quot;:&quot;+folder.URI);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+        FeedUtils.log.debug(&quot;downloadFeed: START x/# foldername:uri - &quot; +</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+                            (i+1) + &quot;/&quot; + numFolders + &quot; &quot; +</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+                            folder.name + &quot;:&quot; + folder.URI);</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">         // Ensure msgDatabase for the folder is open for new message processing.</span>
<a href="#l13.20"></a><span id="l13.20">         let msgDb;</span>
<a href="#l13.21"></a><span id="l13.21">         try {</span>
<a href="#l13.22"></a><span id="l13.22">           msgDb = folder.msgDatabase;</span>
<a href="#l13.23"></a><span id="l13.23">         }</span>
<a href="#l13.24"></a><span id="l13.24">         catch (ex) {}</span>
<a href="#l13.25"></a><span id="l13.25">         if (!msgDb) {</span>
<a href="#l13.26"></a><span id="l13.26">           // Force a reparse.  After the async reparse the folder will be ready</span>
<a href="#l13.27"></a><span id="l13.27">           // for the next cycle; don't bother with a listener.  Continue with</span>
<a href="#l13.28"></a><span id="l13.28">           // the next folder, as attempting to add a message to a folder with</span>
<a href="#l13.29"></a><span id="l13.29">           // an unavailable msgDatabase will throw later.</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-          FeedUtils.log.debug(&quot;downloadFeed: rebuild msgDatabase for &quot;+</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                              folder.name+&quot; - &quot;+folder.filePath.path);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+          FeedUtils.log.debug(&quot;downloadFeed: rebuild msgDatabase for &quot; +</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+                              folder.name + &quot; - &quot; + folder.filePath.path);</span>
<a href="#l13.34"></a><span id="l13.34">           try</span>
<a href="#l13.35"></a><span id="l13.35">           {</span>
<a href="#l13.36"></a><span id="l13.36">             // Ignore error returns.</span>
<a href="#l13.37"></a><span id="l13.37">             folder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l13.38"></a><span id="l13.38">                    getDatabaseWithReparse(null, null);</span>
<a href="#l13.39"></a><span id="l13.39">           }</span>
<a href="#l13.40"></a><span id="l13.40">           catch (ex) {}</span>
<a href="#l13.41"></a><span id="l13.41">           continue;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineat">@@ -67,45 +67,45 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l13.43"></a><span id="l13.43">         let feedUrlArray = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l13.44"></a><span id="l13.44">         // Continue if there are no feedUrls for the folder in the feeds</span>
<a href="#l13.45"></a><span id="l13.45">         // database.  All folders in Trash are now unsubscribed, so perhaps</span>
<a href="#l13.46"></a><span id="l13.46">         // we may not want to check that here each biff each folder.</span>
<a href="#l13.47"></a><span id="l13.47">         if (!feedUrlArray ||</span>
<a href="#l13.48"></a><span id="l13.48">             (aFolder.isServer &amp;&amp; trashFolder &amp;&amp; trashFolder.isAncestorOf(folder)))</span>
<a href="#l13.49"></a><span id="l13.49">           continue;</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-        FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot;+</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-                            folder.name+&quot;:&quot;+feedUrlArray);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+        FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot; +</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+                            folder.name + &quot;:&quot; + feedUrlArray);</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56">         FeedUtils.progressNotifier.init(aMsgWindow, false);</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">         // We need to kick off a download for each feed.</span>
<a href="#l13.59"></a><span id="l13.59">         let id, feed;</span>
<a href="#l13.60"></a><span id="l13.60">         for (let url in feedUrlArray)</span>
<a href="#l13.61"></a><span id="l13.61">         {</span>
<a href="#l13.62"></a><span id="l13.62">           if (feedUrlArray[url])</span>
<a href="#l13.63"></a><span id="l13.63">           {</span>
<a href="#l13.64"></a><span id="l13.64">             id = FeedUtils.rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l13.65"></a><span id="l13.65">             feed = new Feed(id, folder.server);</span>
<a href="#l13.66"></a><span id="l13.66">             feed.folder = folder;</span>
<a href="#l13.67"></a><span id="l13.67">             // Bump our pending feed download count.</span>
<a href="#l13.68"></a><span id="l13.68">             FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l13.69"></a><span id="l13.69">             feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-            FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot;+</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+            FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot; +</span>
<a href="#l13.72"></a><span id="l13.72">                                 feedUrlArray[url]);</span>
<a href="#l13.73"></a><span id="l13.73">           }</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75">           Services.tm.mainThread.dispatch(function() {</span>
<a href="#l13.76"></a><span id="l13.76">             try {</span>
<a href="#l13.77"></a><span id="l13.77">               getFeed.next();</span>
<a href="#l13.78"></a><span id="l13.78">             }</span>
<a href="#l13.79"></a><span id="l13.79">             catch (ex) {</span>
<a href="#l13.80"></a><span id="l13.80">               if (ex instanceof StopIteration)</span>
<a href="#l13.81"></a><span id="l13.81">                 // Finished with all feeds in base folder and its subfolders.</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-                FeedUtils.log.debug(&quot;downloadFeed: Finished with folder - &quot;+</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+                FeedUtils.log.debug(&quot;downloadFeed: Finished with folder - &quot; +</span>
<a href="#l13.84"></a><span id="l13.84">                                     aFolder.name);</span>
<a href="#l13.85"></a><span id="l13.85">               else</span>
<a href="#l13.86"></a><span id="l13.86">               {</span>
<a href="#l13.87"></a><span id="l13.87">                 FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l13.88"></a><span id="l13.88">                 FeedUtils.progressNotifier.downloaded({name: folder.name}, 0);</span>
<a href="#l13.89"></a><span id="l13.89">               }</span>
<a href="#l13.90"></a><span id="l13.90">             }</span>
<a href="#l13.91"></a><span id="l13.91">           }, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineat">@@ -117,17 +117,17 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94">     let getFeed = feeder();</span>
<a href="#l13.95"></a><span id="l13.95">     try {</span>
<a href="#l13.96"></a><span id="l13.96">       getFeed.next();</span>
<a href="#l13.97"></a><span id="l13.97">     }</span>
<a href="#l13.98"></a><span id="l13.98">     catch (ex) {</span>
<a href="#l13.99"></a><span id="l13.99">       if (ex instanceof StopIteration)</span>
<a href="#l13.100"></a><span id="l13.100">         // Nothing to do.</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-        FeedUtils.log.debug(&quot;downloadFeed: Nothing to do in folder - &quot;+</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+        FeedUtils.log.debug(&quot;downloadFeed: Nothing to do in folder - &quot; +</span>
<a href="#l13.103"></a><span id="l13.103">                             aFolder.name);</span>
<a href="#l13.104"></a><span id="l13.104">       else</span>
<a href="#l13.105"></a><span id="l13.105">       {</span>
<a href="#l13.106"></a><span id="l13.106">         FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l13.107"></a><span id="l13.107">         FeedUtils.progressNotifier.downloaded({name: aFolder.name}, 0);</span>
<a href="#l13.108"></a><span id="l13.108">       }</span>
<a href="#l13.109"></a><span id="l13.109">     }</span>
<a href="#l13.110"></a><span id="l13.110">   },</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineat">@@ -144,57 +144,21 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l13.112"></a><span id="l13.112">     {</span>
<a href="#l13.113"></a><span id="l13.113">       FeedUtils.log.warn(&quot;subscribeToFeed: Aborting RSS subscription. &quot; +</span>
<a href="#l13.114"></a><span id="l13.114">                          &quot;Feed downloads already in progress\n&quot;);</span>
<a href="#l13.115"></a><span id="l13.115">       return;</span>
<a href="#l13.116"></a><span id="l13.116">     }</span>
<a href="#l13.117"></a><span id="l13.117"> </span>
<a href="#l13.118"></a><span id="l13.118">     // If aFolder is null, then use the root folder for the first RSS account.</span>
<a href="#l13.119"></a><span id="l13.119">     if (!aFolder)</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-    {</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-      let allServers = MailServices.accounts.allServers;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-      for (let i = 0; i &lt; allServers.Count() &amp;&amp; !aFolder; i++)</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-      {</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-        let currentServer = allServers.QueryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-        if (currentServer &amp;&amp; currentServer.type == &quot;rss&quot;)</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-          aFolder = currentServer.rootFolder;</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-      }</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-    }</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+      aFolder = FeedUtils.getAllRssServerRootFolders()[0];</span>
<a href="#l13.130"></a><span id="l13.130"> </span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-    // If the user has no RSS account yet, create one; also check then if</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-    // the &quot;Local Folders&quot; exist yet and create if necessary.</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+    // If the user has no Feeds account yet, create one.</span>
<a href="#l13.134"></a><span id="l13.134">     if (!aFolder)</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-    {</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-      let server = MailServices.accounts.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-                                                              &quot;Feeds&quot;,</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-                                                              &quot;rss&quot;);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-      server.biffMinutes = FeedUtils.kBiffMinutesDefault;</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-      server.prettyName = FeedUtils.strings.GetStringFromName(&quot;feeds-accountname&quot;);</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-      server.valid = true;</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-      let account = MailServices.accounts.createAccount();</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-      account.incomingServer = server;</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-      aFolder = account.incomingServer.rootFolder;</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-      // Create &quot;Local Folders&quot; if none exist yet as it's guaranteed that</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-      // those exist when any account exists.</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-      let localFolders = null;</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-      try {</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-        localFolders = MailServices.accounts.localFoldersServer;</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-      }</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-      catch (ex) {}</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-      if (!localFolders)</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-        MailServices.accounts.createLocalMailAccount();</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-      // Save new accounts in case of a crash.</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-      try {</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-        MailServices.accounts.saveAccountInfo();</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-    }</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+      aFolder = FeedUtils.createRssAccount().incomingServer.rootFolder;</span>
<a href="#l13.164"></a><span id="l13.164"> </span>
<a href="#l13.165"></a><span id="l13.165">     if (!aMsgWindow)</span>
<a href="#l13.166"></a><span id="l13.166">     {</span>
<a href="#l13.167"></a><span id="l13.167">       let wlist = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l13.168"></a><span id="l13.168">       if (wlist.hasMoreElements())</span>
<a href="#l13.169"></a><span id="l13.169">       {</span>
<a href="#l13.170"></a><span id="l13.170">         let win = wlist.getNext().QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l13.171"></a><span id="l13.171">         win.focus();</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineat">@@ -243,32 +207,38 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l13.173"></a><span id="l13.173">     feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l13.174"></a><span id="l13.174">   },</span>
<a href="#l13.175"></a><span id="l13.175"> </span>
<a href="#l13.176"></a><span id="l13.176">   updateSubscriptionsDS: function(aFolder, aUnsubscribe)</span>
<a href="#l13.177"></a><span id="l13.177">   {</span>
<a href="#l13.178"></a><span id="l13.178">     if (!gExternalScriptsLoaded)</span>
<a href="#l13.179"></a><span id="l13.179">       loadScripts();</span>
<a href="#l13.180"></a><span id="l13.180"> </span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+    FeedUtils.log.debug(&quot;updateSubscriptionsDS: folder changed, name:unsubscribe - &quot; +</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+                        aFolder.filePath.path + &quot;:&quot; + aUnsubscribe);</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+</span>
<a href="#l13.184"></a><span id="l13.184">     // An rss folder was just changed, get the folder's feedUrls and update</span>
<a href="#l13.185"></a><span id="l13.185">     // our feed data source.</span>
<a href="#l13.186"></a><span id="l13.186">     let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l13.187"></a><span id="l13.187">     if (!feedUrlArray)</span>
<a href="#l13.188"></a><span id="l13.188">       // No feedUrls in this folder.</span>
<a href="#l13.189"></a><span id="l13.189">       return;</span>
<a href="#l13.190"></a><span id="l13.190"> </span>
<a href="#l13.191"></a><span id="l13.191">     let newFeedUrl, id, resource, node;</span>
<a href="#l13.192"></a><span id="l13.192">     let ds = FeedUtils.getSubscriptionsDS(aFolder.server);</span>
<a href="#l13.193"></a><span id="l13.193">     let trashFolder =</span>
<a href="#l13.194"></a><span id="l13.194">         aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l13.195"></a><span id="l13.195">     for (let url in feedUrlArray)</span>
<a href="#l13.196"></a><span id="l13.196">     {</span>
<a href="#l13.197"></a><span id="l13.197">       newFeedUrl = feedUrlArray[url];</span>
<a href="#l13.198"></a><span id="l13.198">       if (newFeedUrl)</span>
<a href="#l13.199"></a><span id="l13.199">       {</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+        FeedUtils.log.debug(&quot;updateSubscriptionsDS: processing url - &quot; +</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+                            newFeedUrl);</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+</span>
<a href="#l13.203"></a><span id="l13.203">         id = FeedUtils.rdf.GetResource(newFeedUrl);</span>
<a href="#l13.204"></a><span id="l13.204">         // If explicit delete or move to trash, unsubscribe.</span>
<a href="#l13.205"></a><span id="l13.205">         if (aUnsubscribe ||</span>
<a href="#l13.206"></a><span id="l13.206">             (trashFolder &amp;&amp; trashFolder.isAncestorOf(aFolder)))</span>
<a href="#l13.207"></a><span id="l13.207">         {</span>
<a href="#l13.208"></a><span id="l13.208">           FeedUtils.deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l13.209"></a><span id="l13.209">         }</span>
<a href="#l13.210"></a><span id="l13.210">         else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/content/importDialog.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/content/importDialog.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,29 +1,32 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l14.5"></a><span id="l14.5">  *</span>
<a href="#l14.6"></a><span id="l14.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> var importType = null;</span>
<a href="#l14.11"></a><span id="l14.11"> var gImportMsgsBundle;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+var gFeedsBundle;</span>
<a href="#l14.13"></a><span id="l14.13"> var importService = 0;</span>
<a href="#l14.14"></a><span id="l14.14"> var successStr = null;</span>
<a href="#l14.15"></a><span id="l14.15"> var errorStr = null;</span>
<a href="#l14.16"></a><span id="l14.16"> var inputStr = null ;</span>
<a href="#l14.17"></a><span id="l14.17"> var progressInfo = null;</span>
<a href="#l14.18"></a><span id="l14.18"> var selectedModuleName = null;</span>
<a href="#l14.19"></a><span id="l14.19"> var addInterface = null ;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+var newFeedAcctCreated = false;</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22"> const nsISupportsString = Components.interfaces.nsISupportsString;</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24"> function OnLoadImportDialog()</span>
<a href="#l14.25"></a><span id="l14.25"> {</span>
<a href="#l14.26"></a><span id="l14.26">   gImportMsgsBundle = document.getElementById(&quot;bundle_importMsgs&quot;);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  gFeedsBundle = document.getElementById(&quot;bundle_feeds&quot;);</span>
<a href="#l14.28"></a><span id="l14.28">   importService = Components.classes[&quot;@mozilla.org/import/import-service;1&quot;]</span>
<a href="#l14.29"></a><span id="l14.29">                             .getService(Components.interfaces.nsIImportService);</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   progressInfo = { };</span>
<a href="#l14.32"></a><span id="l14.32">   progressInfo.progressWindow = null;</span>
<a href="#l14.33"></a><span id="l14.33">   progressInfo.importInterface = null;</span>
<a href="#l14.34"></a><span id="l14.34">   progressInfo.mainWindow = window;</span>
<a href="#l14.35"></a><span id="l14.35">   progressInfo.intervalState = 0;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineat">@@ -62,18 +65,26 @@ function SetUpImportType()</span>
<a href="#l14.37"></a><span id="l14.37">   </span>
<a href="#l14.38"></a><span id="l14.38">   // Mac migration not working right now, so disable it</span>
<a href="#l14.39"></a><span id="l14.39">   if (navigator.platform.match(&quot;^Mac&quot;))</span>
<a href="#l14.40"></a><span id="l14.40">   {</span>
<a href="#l14.41"></a><span id="l14.41">     document.getElementById(&quot;allRadio&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l14.42"></a><span id="l14.42">     if (importType == &quot;all&quot;)</span>
<a href="#l14.43"></a><span id="l14.43">       document.getElementById(&quot;importFields&quot;).value = &quot;addressbook&quot;;</span>
<a href="#l14.44"></a><span id="l14.44">   }</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  </span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  ListModules();</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  let descriptionDeck = document.getElementById(&quot;selectDescriptionDeck&quot;);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  descriptionDeck.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  if (importType == &quot;feeds&quot;)</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    descriptionDeck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    ListFeedAccounts();</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  }</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  else</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+    ListModules();</span>
<a href="#l14.57"></a><span id="l14.57"> }</span>
<a href="#l14.58"></a><span id="l14.58"> </span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60"> function SetDivText(id, text)</span>
<a href="#l14.61"></a><span id="l14.61"> {</span>
<a href="#l14.62"></a><span id="l14.62">   var div = document.getElementById(id);</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">   if (div) {</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineat">@@ -102,31 +113,37 @@ function CheckIfLocalFolderExists()</span>
<a href="#l14.66"></a><span id="l14.66"> }</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68"> function ImportDialogOKButton()</span>
<a href="#l14.69"></a><span id="l14.69"> {</span>
<a href="#l14.70"></a><span id="l14.70">   var listbox = document.getElementById('moduleList');</span>
<a href="#l14.71"></a><span id="l14.71">   var deck = document.getElementById(&quot;stateDeck&quot;);</span>
<a href="#l14.72"></a><span id="l14.72">   var header = document.getElementById(&quot;header&quot;);</span>
<a href="#l14.73"></a><span id="l14.73">   var progressMeterEl = document.getElementById(&quot;progressMeter&quot;);</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  progressMeterEl.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l14.75"></a><span id="l14.75">   var progressStatusEl = document.getElementById(&quot;progressStatus&quot;);</span>
<a href="#l14.76"></a><span id="l14.76">   var progressTitleEl = document.getElementById(&quot;progressTitle&quot;);</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">   // better not mess around with navigation at this point</span>
<a href="#l14.79"></a><span id="l14.79">   var nextButton = document.getElementById(&quot;forward&quot;);</span>
<a href="#l14.80"></a><span id="l14.80">   nextButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l14.81"></a><span id="l14.81">   var backButton = document.getElementById(&quot;back&quot;);</span>
<a href="#l14.82"></a><span id="l14.82">   backButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l14.83"></a><span id="l14.83"> </span>
<a href="#l14.84"></a><span id="l14.84">   if ( listbox &amp;&amp; listbox.selectedItems &amp;&amp; (listbox.selectedItems.length == 1) )</span>
<a href="#l14.85"></a><span id="l14.85">   {</span>
<a href="#l14.86"></a><span id="l14.86">     importType = document.getElementById(&quot;importFields&quot;).value;</span>
<a href="#l14.87"></a><span id="l14.87">     var index = listbox.selectedItems[0].getAttribute('list-index');</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-    var module = importService.GetModule(importType, index);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-    var name = importService.GetModuleName(importType, index);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+    if (importType == &quot;feeds&quot;)</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+      var module = &quot;Feeds&quot;;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    else</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+      var module = importService.GetModule(importType, index);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+      var name = importService.GetModuleName(importType, index);</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    }</span>
<a href="#l14.97"></a><span id="l14.97">     selectedModuleName = name;</span>
<a href="#l14.98"></a><span id="l14.98">     if (module)</span>
<a href="#l14.99"></a><span id="l14.99">     {</span>
<a href="#l14.100"></a><span id="l14.100">       // Fix for Bug 57839 &amp; 85219</span>
<a href="#l14.101"></a><span id="l14.101">       // We use localFoldersServer(in nsIMsgAccountManager) to check if Local Folder exists.</span>
<a href="#l14.102"></a><span id="l14.102">       // We need to check localFoldersServer before importing &quot;mail&quot;, &quot;settings&quot;, or &quot;filters&quot;.</span>
<a href="#l14.103"></a><span id="l14.103">       // Reason: We will create an account with an incoming server of type &quot;none&quot; after </span>
<a href="#l14.104"></a><span id="l14.104">       // importing &quot;mail&quot;, so the localFoldersServer is valid even though the Local Folder </span>
<a href="#l14.105"></a><span id="l14.105" class="difflineat">@@ -171,16 +188,39 @@ function ImportDialogOKButton()</span>
<a href="#l14.106"></a><span id="l14.106">             ShowImportResults(false, 'Mail');</span>
<a href="#l14.107"></a><span id="l14.107">             // enable back and next buttons so that users can retry or pick other import options.</span>
<a href="#l14.108"></a><span id="l14.108">             nextButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.109"></a><span id="l14.109">             backButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.110"></a><span id="l14.110">             return( false);</span>
<a href="#l14.111"></a><span id="l14.111">           }</span>
<a href="#l14.112"></a><span id="l14.112">           break;</span>
<a href="#l14.113"></a><span id="l14.113"> </span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+        case &quot;feeds&quot;:</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+          if (ImportFeeds())</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+          {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+            // Successful completion of pre processing and launch of async import.</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+            meterText = document.getElementById(&quot;description&quot;).textContent;</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+            header.setAttribute(&quot;description&quot;, meterText);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+            progressStatusEl.setAttribute(&quot;label&quot;, &quot;&quot;);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+            progressTitleEl.setAttribute(&quot;label&quot;, meterText);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+            progressMeterEl.setAttribute(&quot;mode&quot;, &quot;undetermined&quot;);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+            deck.setAttribute(&quot;selectedIndex&quot;, &quot;2&quot;);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+            return true;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+          }</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+          else</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+          {</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+            // Cancelled or error.</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+            nextButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+            backButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+            return false;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+          }</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+          break;</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+</span>
<a href="#l14.137"></a><span id="l14.137">         case &quot;addressbook&quot;:</span>
<a href="#l14.138"></a><span id="l14.138">           top.successStr = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.139"></a><span id="l14.139">                                      .createInstance(nsISupportsString);</span>
<a href="#l14.140"></a><span id="l14.140">           top.errorStr = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.141"></a><span id="l14.141">                                    .createInstance(nsISupportsString);</span>
<a href="#l14.142"></a><span id="l14.142">           top.inputStr = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.143"></a><span id="l14.143">                                    .createInstance(nsISupportsString);</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145" class="difflineat">@@ -276,21 +316,36 @@ function SetProgress( val)</span>
<a href="#l14.146"></a><span id="l14.146"> </span>
<a href="#l14.147"></a><span id="l14.147"> function ContinueImportCallback()</span>
<a href="#l14.148"></a><span id="l14.148"> {</span>
<a href="#l14.149"></a><span id="l14.149">   progressInfo.mainWindow.ContinueImport( top.progressInfo);</span>
<a href="#l14.150"></a><span id="l14.150"> }</span>
<a href="#l14.151"></a><span id="l14.151"> </span>
<a href="#l14.152"></a><span id="l14.152"> function ImportSelectionChanged()</span>
<a href="#l14.153"></a><span id="l14.153"> {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-  var listbox = document.getElementById('moduleList');</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+  let listbox = document.getElementById('moduleList');</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+  let acctNameBox = document.getElementById('acctName-box');</span>
<a href="#l14.157"></a><span id="l14.157">   if ( listbox &amp;&amp; listbox.selectedItems &amp;&amp; (listbox.selectedItems.length == 1) )</span>
<a href="#l14.158"></a><span id="l14.158">   {</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-    var index = listbox.selectedItems[0].getAttribute('list-index');</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-    SetDivText('description', top.importService.GetModuleDescription(top.importType, index));</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+    let index = listbox.selectedItems[0].getAttribute('list-index');</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+    acctNameBox.setAttribute('style', 'visibility: hidden;');</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+    if (importType == 'feeds')</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    {</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      if (index == 0)</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+      {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+        SetDivText('description', gFeedsBundle.getString('ImportFeedsNewAccount'));</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+        let defaultName = gFeedsBundle.getString(&quot;feeds-accountname&quot;);</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+        document.getElementById( &quot;acctName&quot;).value = defaultName;</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+        acctNameBox.removeAttribute('style');</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+      }</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+      else</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+        SetDivText('description', gFeedsBundle.getString('ImportFeedsExistingAccount'));</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+    }</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+    else</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+      SetDivText('description', top.importService.GetModuleDescription(top.importType, index));</span>
<a href="#l14.177"></a><span id="l14.177">   }</span>
<a href="#l14.178"></a><span id="l14.178"> }</span>
<a href="#l14.179"></a><span id="l14.179"> </span>
<a href="#l14.180"></a><span id="l14.180"> function CompareImportModuleName(a, b)</span>
<a href="#l14.181"></a><span id="l14.181"> {</span>
<a href="#l14.182"></a><span id="l14.182">   if (a.name &gt; b.name)</span>
<a href="#l14.183"></a><span id="l14.183">     return 1;</span>
<a href="#l14.184"></a><span id="l14.184">   if (a.name &lt; b.name)</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineat">@@ -329,16 +384,42 @@ function AddModuleToList(moduleName, ind</span>
<a href="#l14.186"></a><span id="l14.186"> </span>
<a href="#l14.187"></a><span id="l14.187">   var item = document.createElement('listitem');</span>
<a href="#l14.188"></a><span id="l14.188">   item.setAttribute('label', moduleName);</span>
<a href="#l14.189"></a><span id="l14.189">   item.setAttribute('list-index', index);</span>
<a href="#l14.190"></a><span id="l14.190"> </span>
<a href="#l14.191"></a><span id="l14.191">   body.appendChild(item);</span>
<a href="#l14.192"></a><span id="l14.192"> }</span>
<a href="#l14.193"></a><span id="l14.193"> </span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+function ListFeedAccounts() {</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+  let body = document.getElementById( &quot;moduleList&quot;);</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+  while (body.hasChildNodes())</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    body.removeChild(body.lastChild);</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+  // Add item to allow for new account creation.</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+  let item = document.createElement(&quot;listitem&quot;);</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  item.setAttribute(&quot;label&quot;, gFeedsBundle.getString('ImportFeedsCreateNewListItem'));</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+  item.setAttribute(&quot;list-index&quot;, 0);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+  body.appendChild(item);</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+  let index = 0;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+  let feedRootFolders = FeedUtils.getAllRssServerRootFolders();</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+  feedRootFolders.forEach(function(rootFolder) {</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    item = document.createElement(&quot;listitem&quot;);</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+    item.setAttribute(&quot;label&quot;, rootFolder.prettyName);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+    item.setAttribute(&quot;list-index&quot;, ++index);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+    item.server = rootFolder.server;</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+    body.appendChild(item);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+  }, this);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+  if (index)</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+    // If there is an existing feed account, select the first one.</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+    body.selectedIndex = 1;</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+}</span>
<a href="#l14.220"></a><span id="l14.220"> </span>
<a href="#l14.221"></a><span id="l14.221"> function ContinueImport( info) {</span>
<a href="#l14.222"></a><span id="l14.222">   var isMail = info.importType == 'mail' ? true : false;</span>
<a href="#l14.223"></a><span id="l14.223">   var clear = true;</span>
<a href="#l14.224"></a><span id="l14.224">   var deck;</span>
<a href="#l14.225"></a><span id="l14.225">   var pcnt;</span>
<a href="#l14.226"></a><span id="l14.226"> </span>
<a href="#l14.227"></a><span id="l14.227">   if (info.importInterface) {</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineat">@@ -396,20 +477,19 @@ function ShowResults(doesWantProgress, r</span>
<a href="#l14.229"></a><span id="l14.229">        {</span>
<a href="#l14.230"></a><span id="l14.230">                if (doesWantProgress)</span>
<a href="#l14.231"></a><span id="l14.231">                {</span>
<a href="#l14.232"></a><span id="l14.232">                        var deck = document.getElementById(&quot;stateDeck&quot;);</span>
<a href="#l14.233"></a><span id="l14.233">                        var header = document.getElementById(&quot;header&quot;);</span>
<a href="#l14.234"></a><span id="l14.234">                        var progressStatusEl = document.getElementById(&quot;progressStatus&quot;);</span>
<a href="#l14.235"></a><span id="l14.235">                        var progressTitleEl = document.getElementById(&quot;progressTitle&quot;);</span>
<a href="#l14.236"></a><span id="l14.236"> </span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-                       var meterText = gImportMsgsBundle.getFormattedString('AddrProgressMeterText',</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-                                                                                                                  [ name ]);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+                       var meterText = gImportMsgsBundle.getFormattedString('AddrProgressMeterText', [ name ]);</span>
<a href="#l14.240"></a><span id="l14.240">                        header.setAttribute(&quot;description&quot;, meterText);</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-      </span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+</span>
<a href="#l14.243"></a><span id="l14.243">                        progressStatusEl.setAttribute(&quot;label&quot;, &quot;&quot;);</span>
<a href="#l14.244"></a><span id="l14.244">                        progressTitleEl.setAttribute(&quot;label&quot;, meterText);</span>
<a href="#l14.245"></a><span id="l14.245"> </span>
<a href="#l14.246"></a><span id="l14.246">                        deck.setAttribute(&quot;selectedIndex&quot;, &quot;2&quot;);</span>
<a href="#l14.247"></a><span id="l14.247">                        progressInfo.progressWindow = top.window;</span>
<a href="#l14.248"></a><span id="l14.248">                        progressInfo.intervalState = setInterval(&quot;ContinueImportCallback()&quot;, 100);</span>
<a href="#l14.249"></a><span id="l14.249">                }</span>
<a href="#l14.250"></a><span id="l14.250">                else</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineat">@@ -838,18 +918,85 @@ function ImportFilters( module, error)</span>
<a href="#l14.252"></a><span id="l14.252">   if (filtersInterface == null) {</span>
<a href="#l14.253"></a><span id="l14.253">     error.data = gImportMsgsBundle.getString('ImportFiltersBadModule');</span>
<a href="#l14.254"></a><span id="l14.254">     return( false);</span>
<a href="#l14.255"></a><span id="l14.255">   }</span>
<a href="#l14.256"></a><span id="l14.256">   </span>
<a href="#l14.257"></a><span id="l14.257">   return filtersInterface.Import(error);</span>
<a href="#l14.258"></a><span id="l14.258"> }</span>
<a href="#l14.259"></a><span id="l14.259"> </span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+/*</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+  Import feeds.</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+*/</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+function ImportFeeds()</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+{</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+  // Get file to open from filepicker.</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+  let openFile = FeedSubscriptions.opmlPickOpenFile();</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+  if (!openFile)</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+    return false;</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+  let acctName;</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+  let acctNewExist = gFeedsBundle.getString(&quot;ImportFeedsExisting&quot;);</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+  let fileName = openFile.path;</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+  let server = document.getElementById(&quot;moduleList&quot;).selectedItem.server;</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+  newFeedAcctCreated = false;</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+  if (!server)</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+  {</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+    // Create a new Feeds account.</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+    acctName = document.getElementById(&quot;acctName&quot;).value;</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+    server = FeedUtils.createRssAccount(acctName).incomingServer;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+    acctNewExist = gFeedsBundle.getString(&quot;ImportFeedsNew&quot;);</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+    newFeedAcctCreated = true;</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+  }</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+  acctName = server.rootFolder.prettyName;</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+  let callback = function(aStatusReport, aLastFolder , aFeedWin)</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+  {</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+    let message = gFeedsBundle.getFormattedString(&quot;ImportFeedsDone&quot;,</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+                                                  [fileName, acctNewExist, acctName]);</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+    ShowImportResultsRaw(message + &quot;  &quot; + aStatusReport, null, true);</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+    document.getElementById(&quot;back&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+    let subscriptionsWindow = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+    if (subscriptionsWindow)</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+    {</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+      let feedWin = subscriptionsWindow.FeedSubscriptions;</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+      if (aLastFolder)</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+        feedWin.FolderListener.folderAdded(aLastFolder);</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+      feedWin.mActionMode = null;</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+      feedWin.updateButtons(feedWin.mView.currentItem);</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+      feedWin.clearStatusInfo();</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+      feedWin.updateStatusItem(&quot;statusText&quot;, aStatusReport);</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+    }</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+  }</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+  if (!FeedSubscriptions.importOPMLFile(openFile, server, callback))</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+    return false;</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+  let subscriptionsWindow = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+  if (subscriptionsWindow)</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+  {</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+    let feedWin = subscriptionsWindow.FeedSubscriptions;</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+    feedWin.mActionMode = feedWin.kImportingOPML;</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+    feedWin.updateButtons(null);</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+    let statusReport = gFeedsBundle.getString(&quot;subscribe-loading&quot;);</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+    feedWin.updateStatusItem(&quot;statusText&quot;, statusReport);</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineplus">+    feedWin.updateStatusItem(&quot;progressMeter&quot;, &quot;?&quot;);</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+  }</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+  return true;</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+}</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+</span>
<a href="#l14.324"></a><span id="l14.324"> function SwitchType( newType)</span>
<a href="#l14.325"></a><span id="l14.325"> {</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+  if (top.importType == newType)</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+    return;</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+</span>
<a href="#l14.329"></a><span id="l14.329">   top.importType = newType;</span>
<a href="#l14.330"></a><span id="l14.330">   top.progressInfo.importType = newType;</span>
<a href="#l14.331"></a><span id="l14.331"> </span>
<a href="#l14.332"></a><span id="l14.332">   SetUpImportType();</span>
<a href="#l14.333"></a><span id="l14.333"> </span>
<a href="#l14.334"></a><span id="l14.334">   SetDivText('description', &quot;&quot;);</span>
<a href="#l14.335"></a><span id="l14.335"> }</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337" class="difflineat">@@ -890,17 +1037,18 @@ function next()</span>
<a href="#l14.338"></a><span id="l14.338">     close();</span>
<a href="#l14.339"></a><span id="l14.339">     break;</span>
<a href="#l14.340"></a><span id="l14.340">   }</span>
<a href="#l14.341"></a><span id="l14.341"> }</span>
<a href="#l14.342"></a><span id="l14.342"> </span>
<a href="#l14.343"></a><span id="l14.343"> function SelectFirstItem()</span>
<a href="#l14.344"></a><span id="l14.344"> {</span>
<a href="#l14.345"></a><span id="l14.345">   var listbox = document.getElementById(&quot;moduleList&quot;);</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-  listbox.selectedIndex = 0;</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+  if (listbox.selectedIndex == -1)</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+    listbox.selectedIndex = 0;</span>
<a href="#l14.349"></a><span id="l14.349">   ImportSelectionChanged();</span>
<a href="#l14.350"></a><span id="l14.350"> }</span>
<a href="#l14.351"></a><span id="l14.351"> </span>
<a href="#l14.352"></a><span id="l14.352"> function enableAdvance()</span>
<a href="#l14.353"></a><span id="l14.353"> {</span>
<a href="#l14.354"></a><span id="l14.354">   var listbox = document.getElementById(&quot;moduleList&quot;);</span>
<a href="#l14.355"></a><span id="l14.355">   var nextButton = document.getElementById(&quot;forward&quot;);</span>
<a href="#l14.356"></a><span id="l14.356">   if (listbox.selectedItems.length)</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineat">@@ -930,13 +1078,17 @@ function back()</span>
<a href="#l14.358"></a><span id="l14.358">     // Reset the next button.</span>
<a href="#l14.359"></a><span id="l14.359">     var nextButton = document.getElementById(&quot;forward&quot;);</span>
<a href="#l14.360"></a><span id="l14.360">     nextButton.label = nextButton.getAttribute(&quot;nextval&quot;);</span>
<a href="#l14.361"></a><span id="l14.361">     nextButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.362"></a><span id="l14.362"> </span>
<a href="#l14.363"></a><span id="l14.363">     // Enable the cancel button again.</span>
<a href="#l14.364"></a><span id="l14.364">     document.getElementById(&quot;cancel&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l14.365"></a><span id="l14.365"> </span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+    // If a new Feed account has been created, rebuild the list.</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+    if (newFeedAcctCreated)</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+      ListFeedAccounts();</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+</span>
<a href="#l14.370"></a><span id="l14.370">     // Now go back to the second page.</span>
<a href="#l14.371"></a><span id="l14.371">     deck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l14.372"></a><span id="l14.372">     break;</span>
<a href="#l14.373"></a><span id="l14.373">   }</span>
<a href="#l14.374"></a><span id="l14.374"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/content/importDialog.xul</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/content/importDialog.xul</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -22,17 +22,21 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #else</span>
<a href="#l15.5"></a><span id="l15.5">         style=&quot;width: &amp;window.width; !important;&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #endif</span>
<a href="#l15.7"></a><span id="l15.7">         title=&quot;&amp;importDialog.windowTitle;&quot;&gt;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9">   &lt;stringbundle id=&quot;bundle_importMsgs&quot; src=&quot;chrome://messenger/locale/importMsgs.properties&quot;/&gt;</span>
<a href="#l15.10"></a><span id="l15.10">   &lt;stringbundle id=&quot;bundle_addressbook&quot; src=&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;/&gt;</span>
<a href="#l15.11"></a><span id="l15.11">   &lt;stringbundle id=&quot;bundle_vcardImportMsgs&quot; src=&quot;chrome://messenger/locale/vCardImportMsgs.properties&quot;/&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  &lt;stringbundle id=&quot;bundle_feeds&quot; src=&quot;chrome://messenger-newsblog/locale/newsblog.properties&quot;/&gt;</span>
<a href="#l15.13"></a><span id="l15.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/importDialog.js&quot;/&gt;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-newsblog/content/Feed.js&quot;/&gt;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-newsblog/content/feed-subscriptions.js&quot;/&gt;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-newsblog/content/utils.js&quot;/&gt;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">   &lt;keyset id=&quot;dialogKeys&quot;/&gt;</span>
<a href="#l15.19"></a><span id="l15.19">   </span>
<a href="#l15.20"></a><span id="l15.20">   &lt;hbox class=&quot;box-header&quot; id=&quot;header&quot;</span>
<a href="#l15.21"></a><span id="l15.21">        title=&quot;&amp;importTitle.label;&quot;</span>
<a href="#l15.22"></a><span id="l15.22">        description=&quot;&amp;importShortDesc.label;&quot;/&gt;</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24">   &lt;deck id=&quot;stateDeck&quot; selectedIndex=&quot;0&quot;&gt;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineat">@@ -52,43 +56,67 @@</span>
<a href="#l15.26"></a><span id="l15.26">           &lt;radio id=&quot;addressbookRadio&quot;</span>
<a href="#l15.27"></a><span id="l15.27">                  value=&quot;addressbook&quot;</span>
<a href="#l15.28"></a><span id="l15.28">                  label=&quot;&amp;importAddressbook.label;&quot;</span>
<a href="#l15.29"></a><span id="l15.29">                  accesskey=&quot;&amp;importAddressbook.accesskey;&quot;/&gt;</span>
<a href="#l15.30"></a><span id="l15.30">           &lt;radio id=&quot;mailRadio&quot;</span>
<a href="#l15.31"></a><span id="l15.31">                  value=&quot;mail&quot;</span>
<a href="#l15.32"></a><span id="l15.32">                  label=&quot;&amp;importMail.label;&quot;</span>
<a href="#l15.33"></a><span id="l15.33">                  accesskey=&quot;&amp;importMail.accesskey;&quot;/&gt;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+          &lt;radio id=&quot;feedsRadio&quot;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+                 value=&quot;feeds&quot;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+                 label=&quot;&amp;importFeeds.label;&quot;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                 accesskey=&quot;&amp;importFeeds.accesskey;&quot;/&gt;</span>
<a href="#l15.38"></a><span id="l15.38">           &lt;radio id=&quot;settingsRadio&quot;</span>
<a href="#l15.39"></a><span id="l15.39">                  value=&quot;settings&quot;</span>
<a href="#l15.40"></a><span id="l15.40">                  label=&quot;&amp;importSettings.label;&quot;</span>
<a href="#l15.41"></a><span id="l15.41">                  accesskey=&quot;&amp;importSettings.accesskey;&quot;/&gt;</span>
<a href="#l15.42"></a><span id="l15.42">           &lt;radio id=&quot;filtersRadio&quot;</span>
<a href="#l15.43"></a><span id="l15.43">                  value=&quot;filters&quot;</span>
<a href="#l15.44"></a><span id="l15.44">                  label=&quot;&amp;importFilters.label;&quot;</span>
<a href="#l15.45"></a><span id="l15.45">                  accesskey=&quot;&amp;importFilters.accesskey;&quot;/&gt;</span>
<a href="#l15.46"></a><span id="l15.46">         &lt;/vbox&gt;</span>
<a href="#l15.47"></a><span id="l15.47">       &lt;/radiogroup&gt;</span>
<a href="#l15.48"></a><span id="l15.48">     &lt;/vbox&gt;</span>
<a href="#l15.49"></a><span id="l15.49">     &lt;vbox class=&quot;wizard-box&quot;&gt;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-      &lt;label control=&quot;moduleList&quot;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-             value=&quot;&amp;selectDescription.label;&quot;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-             accesskey=&quot;&amp;selectDescription.accesskey;&quot;/&gt;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+      &lt;deck id=&quot;selectDescriptionDeck&quot; selectedIndex=&quot;0&quot;&gt;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+        &lt;label control=&quot;moduleList&quot;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+               value=&quot;&amp;selectDescription.label;&quot;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+               accesskey=&quot;&amp;selectDescription.accesskey;&quot;/&gt;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+        &lt;label control=&quot;moduleList&quot;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+               value=&quot;&amp;selectDescriptionB.label;&quot;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+               accesskey=&quot;&amp;selectDescription.accesskey;&quot;/&gt;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+      &lt;/deck&gt;</span>
<a href="#l15.61"></a><span id="l15.61">       &lt;listbox id=&quot;moduleList&quot; flex=&quot;3&quot;</span>
<a href="#l15.62"></a><span id="l15.62">                 onselect=&quot;ImportSelectionChanged(); enableAdvance();&quot; </span>
<a href="#l15.63"></a><span id="l15.63">                 style=&quot;height: 0px;&quot;/&gt;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-      &lt;description control=&quot;moduleList&quot; id=&quot;description&quot; class=&quot;box-padded&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+      &lt;grid flex=&quot;1&quot;&gt;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+        &lt;columns&gt;&lt;column/&gt;&lt;/columns&gt;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+        &lt;rows&gt;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+          &lt;row&gt;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+            &lt;description control=&quot;moduleList&quot; id=&quot;description&quot; class=&quot;box-padded&quot;/&gt;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+          &lt;row&gt;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+            &lt;hbox id=&quot;acctName-box&quot; flex=&quot;1&quot; style=&quot;visibility: hidden;&quot;&gt;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+              &lt;label control=&quot;acctName&quot; class=&quot;box-padded&quot;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                     accesskey=&quot;&amp;acctName.accesskey;&quot;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+                     value=&quot;&amp;acctName.label;&quot;/&gt;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+              &lt;textbox id=&quot;acctName&quot; clickSelectsAll=&quot;true&quot;/&gt;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+        &lt;/rows&gt;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+      &lt;/grid&gt;</span>
<a href="#l15.81"></a><span id="l15.81">     &lt;/vbox&gt;</span>
<a href="#l15.82"></a><span id="l15.82">     &lt;vbox class=&quot;wizard-box&quot;&gt;</span>
<a href="#l15.83"></a><span id="l15.83">       &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l15.84"></a><span id="l15.84">       &lt;groupbox&gt;</span>
<a href="#l15.85"></a><span id="l15.85">         &lt;caption id=&quot;progressTitle&quot; label=&quot;&amp;title.label;&quot;/&gt;</span>
<a href="#l15.86"></a><span id="l15.86">         &lt;label class=&quot;indent&quot; id=&quot;progressStatus&quot; value=&quot;&amp;processing.label;&quot;/&gt;</span>
<a href="#l15.87"></a><span id="l15.87">         &lt;vbox class=&quot;box-padded&quot;&gt;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-          &lt;progressmeter id=&quot;progressMeter&quot; mode=&quot;normal&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+          &lt;progressmeter id=&quot;progressMeter&quot; mode=&quot;determined&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l15.90"></a><span id="l15.90">         &lt;/vbox&gt;</span>
<a href="#l15.91"></a><span id="l15.91">       &lt;/groupbox&gt;</span>
<a href="#l15.92"></a><span id="l15.92">     &lt;/vbox&gt;</span>
<a href="#l15.93"></a><span id="l15.93">     &lt;vbox class=&quot;wizard-box&quot;&gt;</span>
<a href="#l15.94"></a><span id="l15.94">       &lt;description id=&quot;status&quot;/&gt;</span>
<a href="#l15.95"></a><span id="l15.95">       &lt;hbox style=&quot;overflow: auto&quot; class=&quot;inset&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l15.96"></a><span id="l15.96">         &lt;description id=&quot;results&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l15.97"></a><span id="l15.97">       &lt;/hbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -529,16 +529,18 @@ pref(&quot;rss.display.disallow_mime_handlers</span>
<a href="#l16.4"></a><span id="l16.4"> pref(&quot;rss.show.summary&quot;, 1);</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> // Action on double click or enter in threadpane for message with </span>
<a href="#l16.7"></a><span id="l16.7"> // header 'content-base' url (rss)</span>
<a href="#l16.8"></a><span id="l16.8"> // 0 - open content-base url in new window</span>
<a href="#l16.9"></a><span id="l16.9"> // 1 - open summary in new window</span>
<a href="#l16.10"></a><span id="l16.10"> // 2 - toggle load summary and content-base url in message pane</span>
<a href="#l16.11"></a><span id="l16.11"> pref(&quot;rss.show.content-base&quot;, 0);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+// Feeds system logging, uses log4moz conventions.</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+pref(&quot;Feeds.logging.console&quot;, &quot;Info&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> pref(&quot;mail.forward_message_mode&quot;, 0); // 0=default as attachment 2=forward as inline with attachments, (obsolete 4.x value)1=forward as quoted (mapped to 2 in mozilla)</span>
<a href="#l16.16"></a><span id="l16.16"> pref(&quot;mail.forward_add_extension&quot;, true); // add .eml extension when forwarding as attachment</span>
<a href="#l16.17"></a><span id="l16.17"> // Prefix of for mail forwards. E.g. &quot;Fwd&quot; -&gt; subject will be Fwd: &lt;subject&gt;</span>
<a href="#l16.18"></a><span id="l16.18"> pref(&quot;mail.forward_subject_prefix&quot;, &quot;Fwd&quot;);</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> pref(&quot;mail.startup.enabledMailCheckOnce&quot;, false);</span>
<a href="#l16.21"></a><span id="l16.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/importDialog.dtd</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/importDialog.dtd</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,34 +2,39 @@</span>
<a href="#l17.4"></a><span id="l17.4">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.5"></a><span id="l17.5">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> &lt;!ENTITY importDialog.windowTitle &quot;Import&quot;&gt;</span>
<a href="#l17.8"></a><span id="l17.8"> &lt;!ENTITY importAll.label          &quot;Import Everything&quot;&gt;</span>
<a href="#l17.9"></a><span id="l17.9"> &lt;!ENTITY importAll.accesskey      &quot;E&quot;&gt;</span>
<a href="#l17.10"></a><span id="l17.10"> &lt;!ENTITY importMail.label         &quot;Mail&quot;&gt;</span>
<a href="#l17.11"></a><span id="l17.11"> &lt;!ENTITY importMail.accesskey     &quot;M&quot;&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+&lt;!ENTITY importFeeds.label        &quot;Feed Subscriptions&quot;&gt;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+&lt;!ENTITY importFeeds.accesskey    &quot;d&quot;&gt;</span>
<a href="#l17.14"></a><span id="l17.14"> &lt;!ENTITY importAddressbook.label  &quot;Address Books&quot;&gt;</span>
<a href="#l17.15"></a><span id="l17.15"> &lt;!ENTITY importAddressbook.accesskey &quot;A&quot;&gt;</span>
<a href="#l17.16"></a><span id="l17.16"> &lt;!ENTITY importSettings.label     &quot;Settings&quot;&gt;</span>
<a href="#l17.17"></a><span id="l17.17"> &lt;!ENTITY importSettings.accesskey &quot;S&quot;&gt;</span>
<a href="#l17.18"></a><span id="l17.18"> &lt;!ENTITY importFilters.label      &quot;Filters&quot;&gt;</span>
<a href="#l17.19"></a><span id="l17.19"> &lt;!ENTITY importFilters.accesskey  &quot;F&quot;&gt;</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> &lt;!ENTITY  window.width            &quot;40em&quot;&gt;</span>
<a href="#l17.22"></a><span id="l17.22"> &lt;!ENTITY  window.macWidth         &quot;45em&quot;&gt;</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> &lt;!ENTITY importTitle.label        &quot;&amp;brandShortName; Import Wizard&quot;&gt;</span>
<a href="#l17.25"></a><span id="l17.25"> &lt;!ENTITY importShortDesc.label    &quot;Import Mail, Address Books, Settings, and Filters from other programs&quot;&gt;</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-&lt;!ENTITY importDescription1.label &quot;This wizard will import mail messages, address book entries, preferences, and/or filters from other mail programs and common address book formats into &amp;brandShortName;.&quot;&gt;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+&lt;!ENTITY importDescription1.label &quot;This wizard will import mail messages, address book entries, feed subscriptions, preferences, and/or filters from other mail programs and common address book formats into &amp;brandShortName;.&quot;&gt;</span>
<a href="#l17.29"></a><span id="l17.29"> &lt;!ENTITY importDescription2.label &quot;Once they have been imported, you will be able to access them from within &amp;brandShortName;.&quot;&gt;</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31"> &lt;!ENTITY selectDescription.label  &quot;Please select the type of file that you would like to import:&quot;&gt;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+&lt;!ENTITY selectDescriptionB.label &quot;Please select an existing account or create a new account:&quot;&gt;</span>
<a href="#l17.33"></a><span id="l17.33"> &lt;!ENTITY selectDescription.accesskey &quot;P&quot;&gt;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+&lt;!ENTITY acctName.label           &quot;Name:&quot;&gt;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+&lt;!ENTITY acctName.accesskey       &quot;N&quot;&gt;</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37"> &lt;!ENTITY back.label               &quot;&amp;lt; Back&quot;&gt;</span>
<a href="#l17.38"></a><span id="l17.38"> &lt;!ENTITY forward.label            &quot;Next &amp;gt;&quot;&gt;</span>
<a href="#l17.39"></a><span id="l17.39"> &lt;!ENTITY finish.label             &quot;Finish&quot;&gt;</span>
<a href="#l17.40"></a><span id="l17.40"> &lt;!ENTITY cancel.label             &quot;Cancel&quot;&gt;</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42"> &lt;!ENTITY select.label             &quot;or select the type of material to import:&quot;&gt;</span>
<a href="#l17.43"></a><span id="l17.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/newsblog/feed-subscriptions.dtd</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -27,10 +27,11 @@</span>
<a href="#l18.4"></a><span id="l18.4"> &lt;!ENTITY button.editFeed.label       &quot;Update&quot;&gt;</span>
<a href="#l18.5"></a><span id="l18.5"> &lt;!ENTITY button.editFeed.accesskey   &quot;U&quot;&gt;</span>
<a href="#l18.6"></a><span id="l18.6"> &lt;!ENTITY button.removeFeed.label     &quot;Remove&quot;&gt;</span>
<a href="#l18.7"></a><span id="l18.7"> &lt;!ENTITY button.removeFeed.accesskey &quot;R&quot;&gt;</span>
<a href="#l18.8"></a><span id="l18.8"> &lt;!ENTITY button.importOPML.label     &quot;Import&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9"> &lt;!ENTITY button.importOPML.accesskey &quot;I&quot;&gt;</span>
<a href="#l18.10"></a><span id="l18.10"> &lt;!ENTITY button.exportOPML.label     &quot;Export&quot;&gt;</span>
<a href="#l18.11"></a><span id="l18.11"> &lt;!ENTITY button.exportOPML.accesskey &quot;X&quot;&gt;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+&lt;!ENTITY button.exportOPML.tooltip   &quot;Export Feeds with folder structure; ctrl click or ctrl enter to export Feeds as a list&quot;&gt;</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> &lt;!ENTITY cmd.close.commandKey        &quot;w&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/newsblog/newsblog.properties</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -12,21 +12,29 @@ subscribe-feedUpdated=Feed updated.</span>
<a href="#l19.4"></a><span id="l19.4"> subscribe-feedMoved=Feed subscription moved.</span>
<a href="#l19.5"></a><span id="l19.5"> subscribe-feedCopied=Feed subscription copied.</span>
<a href="#l19.6"></a><span id="l19.6"> subscribe-feedRemoved=Feed unsubscribed.</span>
<a href="#l19.7"></a><span id="l19.7"> subscribe-feedNotValid=The Feed URL is not a valid feed.</span>
<a href="#l19.8"></a><span id="l19.8"> subscribe-networkError=The Feed URL could not be found. Please check the name and try again.</span>
<a href="#l19.9"></a><span id="l19.9"> subscribe-loading=Loading, please wait…</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> subscribe-OPMLImportTitle=Select OPML file to import</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-subscribe-OPMLExportTitle=Export feeds as an OPML file</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-## LOCALIZATION NOTE(subscribe-OPMLExportFileDialogTitle): %S is the brandShortName</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-subscribe-OPMLExportFileDialogTitle=%S OPML Export</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-## LOCALIZATION NOTE(subscribe-OPMLExportDefaultFileName): %S is the brandShortName</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-subscribe-OPMLExportDefaultFileName=My%SFeeds.opml</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportTitleList):</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+## %S is the name of the feed account folder name.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+subscribe-OPMLExportTitleList=Export %S as an OPML file - Feeds list</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportTitleStruct):</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+## %S is the name of the feed account folder name.</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+subscribe-OPMLExportTitleStruct=Export %S as an OPML file - Feeds with folder structure</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportFileDialogTitle):</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+## %1$S is the brandShortName, %2$S is the name of the feed account folder name.</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+subscribe-OPMLExportFileDialogTitle=%1$S OPML Export - %2$S</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportDefaultFileName):</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+## %1$S is the brandShortName (Thunderbird for example), %2$S is the account name.</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+## The default extension (.opml) is added here as it is not automatically appended in the file picker on MacOS.</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+subscribe-OPMLExportDefaultFileName=My%1$SFeeds-%2$S.opml</span>
<a href="#l19.30"></a><span id="l19.30"> ## LOCALIZATION NOTE(subscribe-OPMLImportInvalidFile): %S is the name of the OPML file the user tried to import.</span>
<a href="#l19.31"></a><span id="l19.31"> subscribe-OPMLImportInvalidFile=The file %S does not seem to be a valid OPML file.</span>
<a href="#l19.32"></a><span id="l19.32"> ## LOCALIZATION NOTE(subscribe-OPMLImportFeedCount): Semi-colon list of plural forms.</span>
<a href="#l19.33"></a><span id="l19.33"> ## See: http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l19.34"></a><span id="l19.34"> ## #1 is the count of new imported entries.</span>
<a href="#l19.35"></a><span id="l19.35"> subscribe-OPMLImportFeedCount=Imported #1 new feed.;Imported #1 new feeds.</span>
<a href="#l19.36"></a><span id="l19.36"> ## LOCALIZATION NOTE(subscribe-OPMLImportUniqueFeeds): Semi-colon list of plural forms.</span>
<a href="#l19.37"></a><span id="l19.37"> ## #1 is the count of new imported entries</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineat">@@ -36,16 +44,18 @@ subscribe-OPMLImportUniqueFeeds=Imported</span>
<a href="#l19.39"></a><span id="l19.39"> subscribe-OPMLImportFoundFeeds=(out of #1 entry found);(out of #1 total entries found)</span>
<a href="#l19.40"></a><span id="l19.40"> ## LOCALIZATION NOTE(subscribe-OPMLImportStatus):</span>
<a href="#l19.41"></a><span id="l19.41"> ## This is the concatenation of the two strings defined above to compose 1 sentence.</span>
<a href="#l19.42"></a><span id="l19.42"> ## %1$S = subscribe-OPMLImportUniqueFeeds</span>
<a href="#l19.43"></a><span id="l19.43"> ## %2$S = subscribe-OPMLImportFoundFeeds</span>
<a href="#l19.44"></a><span id="l19.44"> subscribe-OPMLImportStatus=%1$S %2$S.</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46"> subscribe-OPMLExportOPMLFilesFilterText=OPML Files</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+## LOCALIZATION NOTE(subscribe-OPMLExportDone): %S is the export file name.</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+subscribe-OPMLExportDone=Feeds in this account have been exported to %S.</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50"> subscribe-confirmFeedDeletionTitle=Remove Feed</span>
<a href="#l19.51"></a><span id="l19.51"> ## LOCALIZATION NOTE(subscribe-confirmFeedDeletion): %S is the name of the feed the user wants to unsubscribe from.</span>
<a href="#l19.52"></a><span id="l19.52"> subscribe-confirmFeedDeletion=Are you sure you want to unsubscribe from the feed: \n %S?</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54"> ## LOCALIZATION NOTE(subscribe-gettingFeedItems):</span>
<a href="#l19.55"></a><span id="l19.55"> ##  - The first %S is the number of articles processed so far;</span>
<a href="#l19.56"></a><span id="l19.56"> ##  - The second %S is the total number of items</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineat">@@ -55,8 +65,20 @@ newsblog-noNewArticlesForFeed=There are </span>
<a href="#l19.58"></a><span id="l19.58"> ## LOCALIZATION NOTE(newsblog-networkError): %S is the feed URL</span>
<a href="#l19.59"></a><span id="l19.59"> newsblog-networkError=%S could not be found. Please check the name and try again.</span>
<a href="#l19.60"></a><span id="l19.60"> ## LOCALIZATION NOTE(newsblog-feedNotValid): %S is the feed URL</span>
<a href="#l19.61"></a><span id="l19.61"> newsblog-feedNotValid=%S is not a valid feed.</span>
<a href="#l19.62"></a><span id="l19.62"> newsblog-getNewMsgsCheck=Checking feeds for new items…</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64"> ## LOCALIZATION NOTE(feeds-accountname): This string should be the same as feeds.accountName in am-newsblog.dtd</span>
<a href="#l19.65"></a><span id="l19.65"> feeds-accountname=Blogs &amp; News Feeds</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+## Import wizard.</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+ImportFeedsCreateNewListItem=* New Account *</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+ImportFeedsNewAccount=Create and import into a new Feeds account</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+ImportFeedsExistingAccount=Import into an existing Feeds account</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+## LOCALIZATION NOTE(ImportFeedsDone):</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+##  - The first %S is the import file name;</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+##  - The second %S is the value of either ImportFeedsNew or ImportFeedsExisting;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+##  - The third %S is the feed account name.</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+ImportFeedsNew=new</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+ImportFeedsExisting=existing</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+ImportFeedsDone=The feed subscriptions import from file %1$S into %2$S account '%3$S' has finished.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

