<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27495:6468fdce4742ed0907b9d6a27581508847dc0dda</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6468fdce4742ed0907b9d6a27581508847dc0dda" />
<meta property="og:url" content="/comm-central/rev/6468fdce4742ed0907b9d6a27581508847dc0dda" />
<meta property="og:description" content="Bug 1507754 - Check source repositories and changesets during configure. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6468fdce4742ed0907b9d6a27581508847dc0dda 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6468fdce4742ed0907b9d6a27581508847dc0dda">shortlog</a> |
<a href="/comm-central/log/6468fdce4742ed0907b9d6a27581508847dc0dda">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6468fdce4742ed0907b9d6a27581508847dc0dda">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6468fdce4742ed0907b9d6a27581508847dc0dda">files</a> |
changeset |
<a href="/comm-central/raw-rev/6468fdce4742ed0907b9d6a27581508847dc0dda">raw</a>  | <a href="/comm-central/archive/6468fdce4742ed0907b9d6a27581508847dc0dda.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507754">Bug 1507754</a> - Check source repositories and changesets during configure. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 26 Aug 2019 21:20:54 -0400</td></tr>

<tr>
 <td>changeset 27495</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6468fdce4742ed0907b9d6a27581508847dc0dda">6468fdce4742ed0907b9d6a27581508847dc0dda</a></td>
</tr>



<tr>
<td>parent 27494</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/34e95735ae2b6d9218caaccdbf97b59866a6888b">34e95735ae2b6d9218caaccdbf97b59866a6888b</a>
</td>
</tr>

<tr>
<td>child 27496</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/44f9a7cee435bbce887bc2f473e6c3b43a5c7433">44f9a7cee435bbce887bc2f473e6c3b43a5c7433</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6468fdce4742ed0907b9d6a27581508847dc0dda">16359</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 03 Sep 2019 22:05:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0f86305777da [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0f86305777da4bc0814494572d9b56a802c316b0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0f86305777da4bc0814494572d9b56a802c316b0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0f86305777da4bc0814494572d9b56a802c316b0&newProject=comm-central&newRevision=34e95735ae2b6d9218caaccdbf97b59866a6888b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0f86305777da4bc0814494572d9b56a802c316b0&newProject=comm-central&newRevision=34e95735ae2b6d9218caaccdbf97b59866a6888b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0f86305777da4bc0814494572d9b56a802c316b0&newProject=comm-central&newRevision=34e95735ae2b6d9218caaccdbf97b59866a6888b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507754">1507754</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507754">Bug 1507754</a> - Check source repositories and changesets during configure. r=darktrojan

PACKAGERS: if you update application.ini, platform.ini, or source-repo.h
in some way during your process, you might need to change something.

Make sure that the source repositories for both Mozilla and Comm can be found
during mach configure and abort if they cannot.

For Taskcluster builds, there are various environment variables that can be
relied upon.

Local builds present a challenge. Chances are those variables are not set.

I came up with a set of checks and keep trying until something works.
For comm-* code:
 - Look for MOZ_SOURCE_REPO and MOZ_SOURCE_CHANGESET environment vars. This
   is counter-intuitive, but it's the current status-quo for Taskcluster
   builds. Those variables are set to the comm values.
 - Next, try use the Mercurial source checkout itself. Uses the same technique
   as Mozilla code does in build/variables.py.
 - Last, try to use a file named &quot;sourcestamp.txt&quot;. That file is part of
   our source tar files that get built for releases.
 - Finally, if those MOZ_SOURCE environment variables were not set, set them.
   This is needed because old-configure will look for them and set buildconfig
   variables with them when it runs later during the configure process.
 - Additionally, set MOZ_COMM_SOURCE_REPO and MOZ_COMM_SOURCE_CHANGESET in
   buildconfig. Code in the comm- tree should prefer those values over the
   generic MOZ_SOURCE_* values that the Mozilla code will look at.

For the Gecko/Mozilla source repository information, it's almost the same
process.
- Check for GECKO_SOURCE_REPO and GECKO_SOURCE_REV environment variables first.
  Taskcluster sets these based on comm/.gecko_rev.yml.
- Next, try comm/.gecko_rev.yml itself. PyYAML is not required as the file is
  pretty simple to parse. Release builds are pinned to a specific revision hash,
  so we can use that. Builds from comm-central pin to &quot;default&quot; though, so
  next try running &quot;hg id&quot; in $topsrcdir to get the revision hash.
- If for some reason there's no .gecko_rev.yml and it's not a Mercurial checkout,
  try the sourcestamp.txt file.
- Set MOZ_GECKO_SOURCE_REPO and MOZ_GECKO_SOURCE_CHANGESET in buildconfig.

mach configure should fail if any one of those values cannot be determined.
The error message will suggest setting the environment variables; ideally
that is not necessary.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6468fdce4742ed0907b9d6a27581508847dc0dda/build/moz.configure/gecko_source.configure">build/moz.configure/gecko_source.configure</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6468fdce4742ed0907b9d6a27581508847dc0dda/build/moz.configure/gecko_source.configure">file</a> |
<a href="/comm-central/annotate/6468fdce4742ed0907b9d6a27581508847dc0dda/build/moz.configure/gecko_source.configure">annotate</a> |
<a href="/comm-central/diff/6468fdce4742ed0907b9d6a27581508847dc0dda/build/moz.configure/gecko_source.configure">diff</a> |
<a href="/comm-central/comparison/6468fdce4742ed0907b9d6a27581508847dc0dda/build/moz.configure/gecko_source.configure">comparison</a> |
<a href="/comm-central/log/6468fdce4742ed0907b9d6a27581508847dc0dda/build/moz.configure/gecko_source.configure">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6468fdce4742ed0907b9d6a27581508847dc0dda/mail/moz.configure">mail/moz.configure</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6468fdce4742ed0907b9d6a27581508847dc0dda/mail/moz.configure">file</a> |
<a href="/comm-central/annotate/6468fdce4742ed0907b9d6a27581508847dc0dda/mail/moz.configure">annotate</a> |
<a href="/comm-central/diff/6468fdce4742ed0907b9d6a27581508847dc0dda/mail/moz.configure">diff</a> |
<a href="/comm-central/comparison/6468fdce4742ed0907b9d6a27581508847dc0dda/mail/moz.configure">comparison</a> |
<a href="/comm-central/log/6468fdce4742ed0907b9d6a27581508847dc0dda/mail/moz.configure">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/build/moz.configure/gecko_source.configure</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,264 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+#  This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+#  License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+#  file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+# Attempt to ascertain the Gecko source repository information. This is</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+# necessary because MOZ_SOURCE_REPOSITORY and MOZ_SOURCE_CHANGESET both refer</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+# to the Thunderbird (comm) repository.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+# We need to have accurate source repository information for MPL compliance.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+@template</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+def read_sourcestamp(repository):</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    Last resort, look for the revision data in the sourcestamp file.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    This file only exists in release tar files created in CI.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    repository must be one of &quot;GECKO&quot; or &quot;COMM&quot;.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    log.info('Determining %s source information from sourcestamp.txt...'</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+             % repository)</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    line2read = {'COMM': 1,</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                 'GECKO': 2}[repository]</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    @depends(comm_paths)</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    @imports(_from='os.path', _import='exists')</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    @imports(_from='os.path', _import='join')</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    @imports(_from='__builtin__', _import='open')</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    @imports(_from='mozbuild.util', _import='system_encoding')</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    def get_sourcestamp(paths):</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+        sourcestamp_file = join(paths.moztopsrcdir, 'sourcestamp.txt')</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+        if exists(sourcestamp_file):</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+            try:</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                lines = open(sourcestamp_file).readlines()</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+            except:</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                pass</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+            if len(lines) != 3:</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+                log.warn('sourcestamp.txt is corrupt!')</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                return</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+            if lines and lines[line2read].startswith('http'):</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                repo_line = lines[line2read].decode(system_encoding)</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+                repo_url = repo_line.split('/rev/')</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+                return namespace(repo_url=repo_url[0], repo_rev=repo_url[1])</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    return get_sourcestamp</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+@template</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+def read_gecko_rev_yml():</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    def get_value(x):</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        return x.split()[1]</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    @depends(comm_paths)</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    @imports(_from='os.path', _import='exists')</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    @imports(_from='os.path', _import='join')</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    @imports(_from='__builtin__', _import='open')</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+    @imports(_from='mozbuild.util', _import='system_encoding')</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+    def wrapped(paths):</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+        log.info(&quot;Determining GECKO source information from .gecko_rev.yml&quot;)</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+        rev_file = join(paths.commtopsrcdir, '.gecko_rev.yml')</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+        if not exists(rev_file): return</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+        repo = rev = ref = None</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        for line in open(rev_file).readlines():</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+            if line.startswith('GECKO_HEAD_REPOSITORY:'):</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+                repo = get_value(line).decode(system_encoding)</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+            elif line.startswith('GECKO_HEAD_REV:'):</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+                rev = get_value(line).decode(system_encoding)</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+            elif line.startswith('GECKO_HEAD_REF:'):</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+                ref = get_value(line).decode(system_encoding)</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+            else:</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+                pass</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        return namespace(repo=repo, rev=rev, ref=ref)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    return wrapped</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+@depends(application)</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+@imports(_from='os', _import=&quot;environ&quot;)</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+@imports(_from='mozbuild.util', _import='system_encoding')</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+def comm_repo_from_environ(app):</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    Read the Thunderbird source repository information from the environment.</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+    Taskcluster builds set MOZ_SOURCE_REPO and MOZ_SOURCE_CHANGESET pointing</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+    to the comm-* repository.</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+    log.info(&quot;Determining COMM source information from environment...&quot;)</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+    comm_repo = environ.get('MOZ_SOURCE_REPO', None)</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    comm_rev = environ.get('MOZ_SOURCE_CHANGESET', None)</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    if all([comm_repo, comm_rev]):</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+        comm_repo = comm_repo.decode(system_encoding)</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+        comm_rev = comm_rev.decode(system_encoding)</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+        log.info(&quot;{}/rev/{}&quot;.format(comm_repo, comm_rev))</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+        return namespace(comm_repo=comm_repo, comm_rev=comm_rev)</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+# Read sourcestamp.txt and return the Thunderbird source URL (with changeset).</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+# Silent fail if the file cannot be read.</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+comm_sourcestamp = read_sourcestamp('COMM')</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+@depends(comm_repo_from_environ, comm_paths, hg, comm_sourcestamp)</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+@imports(_from='os', _import=&quot;environ&quot;)</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+def comm_repo_heuristics(comm_environ, paths, hg, sourcestamp):</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    Determine the Thunderbird Mercurial repository and revision from Mercurial</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    or sourcestamp.txt when MOZ_SOURCE_REPO and MOZ_SOURCE_CHANGESET are unset</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    (local developer builds).</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    In that case, MOZ_SOURCE_REPO and MOZ_SOURCE_CHANGESET are set</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+    by build/variables.py, but will refer to the mozilla- repository,</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+    which is incorrect for Thunderbird builds.</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    There's no set_config call for MOZ_SOURCE_REPO or MOZ_SOURCE_CHANGESET</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    here as that will be done when old-configure runs later. Here we just</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    set the environment variables the same as Taskcluster would.</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    if not comm_environ:</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+        comm_repo = comm_rev = None</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+        if hg:</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+            log.info(</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+                &quot;Determining COMM source information from &quot;</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+                &quot;Mercurial...&quot;)</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+            comm_rev = check_cmd_output(hg, '-R', paths.commtopsrcdir,</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+                                        'id', '-T', '{p1.node}')</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+            comm_repo = check_cmd_output(hg, '-R', paths.commtopsrcdir,</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+                                         'path', 'default')</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+            if comm_repo:</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+                comm_repo = comm_repo.strip()</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+                if comm_repo.startswith('ssh://'):</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+                    comm_repo = 'https://' + comm_repo[6:]</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+                comm_repo = comm_repo.rstrip('/')</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+        # TODO: git-cinnabar support?</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+        if not comm_repo or not comm_rev:</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+            try:</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+                comm_repo, comm_rev = sourcestamp.repo_url, sourcestamp.repo_rev</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+            except:</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+                pass</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+        # If values are found, set MOZ_SOURCE_REPO and MOZ_SOURCE_CHANGESET</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+        if comm_repo and comm_rev:</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+            environ['MOZ_SOURCE_REPO'] = comm_repo</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+            environ['MOZ_SOURCE_CHANGESET'] = comm_rev</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+        if comm_repo and comm_rev:</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+            return namespace(comm_repo=comm_repo, comm_rev=comm_rev)</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+@depends(comm_repo_from_environ, comm_repo_heuristics)</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+def comm_source_repo(from_environ, from_config):</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+    rv = None</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+    if from_environ:</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+        rv = from_environ</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+    elif from_config:</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+        rv = from_config</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+    else:</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+        die(&quot;Unable to determine COMM source repository.&quot;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+            &quot;Try setting COMM_HEAD_REPOSITORY and COMM_HEAD_REV&quot;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+            &quot;environment variables or build from a Mercurial checkout.&quot;)</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+    log.info('COMM_SOURCE_REPOSITORY: {}'.format(rv.comm_repo))</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+    log.info('COMM_SOURCE_CHANGESET: {}'.format(rv.comm_rev))</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+    return rv</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+@depends(application)</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+@imports(_from='os', _import=&quot;environ&quot;)</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+@imports(_from='mozbuild.util', _import='system_encoding')</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+def gecko_repo_from_environ(app):</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+    Same as above, but this time checking for the mozilla- repository.</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+    log.info(&quot;Determining GECKO source information from environment...&quot;)</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+    gecko_repo = environ.get('GECKO_HEAD_REPOSITORY', None)</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+    gecko_rev = environ.get('GECKO_HEAD_REV', None)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+    if all([gecko_repo, gecko_rev]):</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+        gecko_repo = gecko_repo.decode(system_encoding)</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+        gecko_rev = gecko_rev.decode(system_encoding)</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+        log.info(&quot;{}/rev/{}&quot;.format(gecko_repo, gecko_rev))</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+        return namespace(gecko_repo=gecko_repo, gecko_rev=gecko_rev)</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+# Read sourcestamp.txt, this time returning the mozilla- data</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+gecko_sourcestamp = read_sourcestamp('GECKO')</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+# Look in comm/.gecko_rev.yml fpr repository information</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+gecko_yml = read_gecko_rev_yml()</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+@depends(gecko_repo_from_environ, comm_paths, hg, gecko_sourcestamp, gecko_yml)</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+@imports(_from='os.path', _import='join')</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+@imports(_from='os.path', _import='exists')</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+def gecko_repo_heuristics(gecko_environ, paths, hg, sourcestamp, gecko_yml):</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+    Look for the source repository and changeset for the mozilla- repository</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    when the Taskcluster environment variables are not set, checking</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+    .gecko_rev.yml before falling back to Mercurial and sourcestamp.txt.</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+    if not gecko_environ:</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+        gecko_repo = gecko_rev = gecko_ref = None</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+        try:</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+            gecko_repo = gecko_yml.repo</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+            gecko_rev = gecko_yml.rev</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+            gecko_ref = gecko_yml.ref</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+        except:</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+            pass</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+        if gecko_repo:</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+            if not gecko_rev and gecko_ref:</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+                # gecko_repo is known, but we have a branch ref like</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+                # &quot;default&quot; when a revision hash is needed. Try to query</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+                # Mercurial first.</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+                if hg:</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+                    log.info(</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+                        &quot;Determining GECKO source information from &quot;</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+                        &quot;Mercurial...&quot;)</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+                    gecko_rev = check_cmd_output(hg, '-R', paths.moztopsrcdir,</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+                                                 'id', '-T', '{p1.node}')</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+                # TODO: git-cinnabar support?</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+        if not gecko_repo or not gecko_rev:</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+            # See if we have a sourcestamo file. Last ditch effort!</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+            try:</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+                gecko_repo, gecko_rev = sourcestamp.repo_url, \</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+                                        sourcestamp.repo_rev</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+            except:</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+                pass</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+        # Check one last time to see if both gecko_repo and gecko_rev</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+        # are set</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+        if gecko_repo and gecko_rev:</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+            return namespace(gecko_repo=gecko_repo, gecko_rev=gecko_rev)</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+@depends(gecko_repo_from_environ, gecko_repo_heuristics)</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+def gecko_source_repo(from_environ, from_heuristics):</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+    rv = None</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+    if from_environ:</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+        rv = from_environ</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+    elif from_heuristics:</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        rv = from_heuristics</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+    else:</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+        die(&quot;Unable to determine GECKO source repository.&quot;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+            &quot;Try setting GECKO_HEAD_REPOSITORY and GECKO_HEAD_REV&quot;</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+            &quot;environment variables or build from a Mercurial checkout.&quot;)</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+    log.info('GECKO_SOURCE_REPOSITORY: {}'.format(rv.gecko_repo))</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+    log.info('GECKO_SOURCE_CHANGESET: {}'.format(rv.gecko_rev))</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+    return rv</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+set_config('MOZ_COMM_SOURCE_REPO', comm_source_repo.comm_repo)</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+set_config('MOZ_COMM_SOURCE_CHANGESET', comm_source_repo.comm_rev)</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+set_config('MOZ_GECKO_SOURCE_REPO', gecko_source_repo.gecko_repo)</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+set_config('MOZ_GECKO_SOURCE_CHANGESET', gecko_source_repo.gecko_rev)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/moz.configure</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/moz.configure</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -76,10 +76,12 @@ imply_option('MOZ_BLOCK_PROFILE_DOWNGRAD</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> with only_when(target_is_linux &amp; compile_environment):</span>
<a href="#l2.6"></a><span id="l2.6">     option(env='MOZ_NO_PIE_COMPAT',</span>
<a href="#l2.7"></a><span id="l2.7">            help='Enable non-PIE wrapper')</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     set_config('MOZ_NO_PIE_COMPAT',</span>
<a href="#l2.10"></a><span id="l2.10">                depends_if('MOZ_NO_PIE_COMPAT')(lambda _: True))</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+include('../build/moz.configure/gecko_source.configure')</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> include('../mailnews/moz.configure')</span>
<a href="#l2.15"></a><span id="l2.15"> include('../../toolkit/moz.configure')</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

