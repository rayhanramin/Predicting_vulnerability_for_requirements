<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26474:ee166a9bb9e027f5e857c802bcf94a512f10c44f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ee166a9bb9e027f5e857c802bcf94a512f10c44f" />
<meta property="og:url" content="/comm-central/rev/ee166a9bb9e027f5e857c802bcf94a512f10c44f" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/search. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ee166a9bb9e027f5e857c802bcf94a512f10c44f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ee166a9bb9e027f5e857c802bcf94a512f10c44f">shortlog</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ee166a9bb9e027f5e857c802bcf94a512f10c44f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f">files</a> |
changeset |
<a href="/comm-central/raw-rev/ee166a9bb9e027f5e857c802bcf94a512f10c44f">raw</a>  | <a href="/comm-central/archive/ee166a9bb9e027f5e857c802bcf94a512f10c44f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/search. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 28 Apr 2019 21:42:15 +0200</td></tr>

<tr>
 <td>changeset 26474</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ee166a9bb9e027f5e857c802bcf94a512f10c44f">ee166a9bb9e027f5e857c802bcf94a512f10c44f</a></td>
</tr>



<tr>
<td>parent 26473</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/340b555c26cfee24bddfa077ae075b7131892083">340b555c26cfee24bddfa077ae075b7131892083</a>
</td>
</tr>

<tr>
<td>child 26475</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/572f63e71e6eeb8e4eca7e8aa11b2a74cbd98bcc">572f63e71e6eeb8e4eca7e8aa11b2a74cbd98bcc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ee166a9bb9e027f5e857c802bcf94a512f10c44f">15847</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 28 Apr 2019 20:37:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@635dddf89443 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=635dddf89443cb9c5a0691865d6499ccf687f36c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=635dddf89443cb9c5a0691865d6499ccf687f36c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=635dddf89443cb9c5a0691865d6499ccf687f36c&newProject=comm-central&newRevision=ee166a9bb9e027f5e857c802bcf94a512f10c44f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=635dddf89443cb9c5a0691865d6499ccf687f36c&newProject=comm-central&newRevision=ee166a9bb9e027f5e857c802bcf94a512f10c44f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=635dddf89443cb9c5a0691865d6499ccf687f36c&newProject=comm-central&newRevision=ee166a9bb9e027f5e857c802bcf94a512f10c44f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/search. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgBodyHandler.h">mailnews/base/search/public/nsMsgBodyHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgBodyHandler.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgBodyHandler.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgBodyHandler.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgBodyHandler.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgBodyHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgResultElement.h">mailnews/base/search/public/nsMsgResultElement.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgResultElement.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgResultElement.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgResultElement.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgResultElement.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgResultElement.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchAdapter.h">mailnews/base/search/public/nsMsgSearchAdapter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchAdapter.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchAdapter.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchAdapter.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchAdapter.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchAdapter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchBoolExpression.h">mailnews/base/search/public/nsMsgSearchBoolExpression.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchBoolExpression.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchBoolExpression.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchBoolExpression.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchBoolExpression.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchBoolExpression.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchScopeTerm.h">mailnews/base/search/public/nsMsgSearchScopeTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchScopeTerm.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchScopeTerm.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchScopeTerm.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchScopeTerm.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchScopeTerm.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchTerm.h">mailnews/base/search/public/nsMsgSearchTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchTerm.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchTerm.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchTerm.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchTerm.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/public/nsMsgSearchTerm.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgBodyHandler.cpp">mailnews/base/search/src/nsMsgBodyHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgBodyHandler.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgBodyHandler.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgBodyHandler.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgBodyHandler.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgBodyHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.h">mailnews/base/search/src/nsMsgFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.h">mailnews/base/search/src/nsMsgFilterList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterList.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.h">mailnews/base/search/src/nsMsgFilterService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgFilterService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgImapSearch.cpp">mailnews/base/search/src/nsMsgImapSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgImapSearch.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgImapSearch.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgImapSearch.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgImapSearch.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgImapSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.cpp">mailnews/base/search/src/nsMsgLocalSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.h">mailnews/base/search/src/nsMsgLocalSearch.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgLocalSearch.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchImap.h">mailnews/base/search/src/nsMsgSearchImap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchImap.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchImap.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchImap.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchImap.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchImap.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.cpp">mailnews/base/search/src/nsMsgSearchNews.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.h">mailnews/base/search/src/nsMsgSearchNews.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchNews.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.cpp">mailnews/base/search/src/nsMsgSearchSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.h">mailnews/base/search/src/nsMsgSearchSession.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchSession.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.cpp">mailnews/base/search/src/nsMsgSearchValue.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.cpp">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.cpp">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.cpp">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.cpp">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.h">mailnews/base/search/src/nsMsgSearchValue.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.h">file</a> |
<a href="/comm-central/annotate/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.h">annotate</a> |
<a href="/comm-central/diff/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.h">diff</a> |
<a href="/comm-central/comparison/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.h">comparison</a> |
<a href="/comm-central/log/ee166a9bb9e027f5e857c802bcf94a512f10c44f/mailnews/base/search/src/nsMsgSearchValue.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgBodyHandler.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgBodyHandler.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,72 +1,68 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">-</span>
<a href="#l1.9"></a><span id="l1.9"> #ifndef __nsMsgBodyHandler_h</span>
<a href="#l1.10"></a><span id="l1.10"> #define __nsMsgBodyHandler_h</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12"> #include &quot;nsIMsgSearchScopeTerm.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> //---------------------------------------------------------------------------</span>
<a href="#l1.17"></a><span id="l1.17"> // nsMsgBodyHandler: used to retrieve lines from POP and IMAP offline messages.</span>
<a href="#l1.18"></a><span id="l1.18"> // This is a helper class used by nsMsgSearchTerm::MatchBody</span>
<a href="#l1.19"></a><span id="l1.19"> //---------------------------------------------------------------------------</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-class nsMsgBodyHandler</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-{</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-public:</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  nsMsgBodyHandler (nsIMsgSearchScopeTerm *,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    uint32_t length,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    nsIMsgDBHdr * msg,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    nsIMsgDatabase * db);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+class nsMsgBodyHandler {</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+ public:</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  nsMsgBodyHandler(nsIMsgSearchScopeTerm *, uint32_t length, nsIMsgDBHdr *msg,</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+                   nsIMsgDatabase *db);</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">   // we can also create a body handler when doing arbitrary header</span>
<a href="#l1.33"></a><span id="l1.33">   // filtering...we need the list of headers and the header size as well</span>
<a href="#l1.34"></a><span id="l1.34">   // if we are doing filtering...if ForFilters is false, headers and</span>
<a href="#l1.35"></a><span id="l1.35">   // headersSize is ignored!!!</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  nsMsgBodyHandler (nsIMsgSearchScopeTerm *,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    uint32_t length, nsIMsgDBHdr * msg, nsIMsgDatabase * db,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    const char * headers /* NULL terminated list of headers */,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    uint32_t headersSize, bool ForFilters);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  nsMsgBodyHandler(nsIMsgSearchScopeTerm *, uint32_t length, nsIMsgDBHdr *msg,</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+                   nsIMsgDatabase *db,</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+                   const char *headers /* NULL terminated list of headers */,</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+                   uint32_t headersSize, bool ForFilters);</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">   virtual ~nsMsgBodyHandler();</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   // Returns next message line in buf and the applicable charset, if found.</span>
<a href="#l1.48"></a><span id="l1.48">   // The return value is the length of 'buf' or -1 for EOF.</span>
<a href="#l1.49"></a><span id="l1.49">   int32_t GetNextLine(nsCString &amp;buf, nsCString &amp;charset);</span>
<a href="#l1.50"></a><span id="l1.50">   bool IsQP() { return m_partIsQP; }</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   // Transformations</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  void SetStripHeaders (bool strip) { m_stripHeaders = strip; }</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  void SetStripHeaders(bool strip) { m_stripHeaders = strip; }</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-protected:</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+ protected:</span>
<a href="#l1.58"></a><span id="l1.58">   void Initialize();  // common initialization code</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60">   // filter related methods. For filtering we always use the headers</span>
<a href="#l1.61"></a><span id="l1.61">   // list instead of the database...</span>
<a href="#l1.62"></a><span id="l1.62">   bool m_Filtering;</span>
<a href="#l1.63"></a><span id="l1.63">   int32_t GetNextFilterLine(nsCString &amp;buf);</span>
<a href="#l1.64"></a><span id="l1.64">   // pointer into the headers list in the original message hdr db...</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-  const char * m_headers;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  const char *m_headers;</span>
<a href="#l1.67"></a><span id="l1.67">   uint32_t m_headersSize;</span>
<a href="#l1.68"></a><span id="l1.68">   uint32_t m_headerBytesRead;</span>
<a href="#l1.69"></a><span id="l1.69"> </span>
<a href="#l1.70"></a><span id="l1.70">   // local / POP related methods</span>
<a href="#l1.71"></a><span id="l1.71">   void OpenLocalFolder();</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">   // goes through the mail folder</span>
<a href="#l1.74"></a><span id="l1.74">   int32_t GetNextLocalLine(nsCString &amp;buf);</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">   nsIMsgSearchScopeTerm *m_scope;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  nsCOMPtr &lt;nsILineInputStream&gt; m_fileLineStream;</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_localFile;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; m_fileLineStream;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_localFile;</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">   /**</span>
<a href="#l1.83"></a><span id="l1.83">    * The number of lines in the message.  If |m_lineCountInBodyLines| then this</span>
<a href="#l1.84"></a><span id="l1.84">    * is the number of body lines, otherwise this is the entire number of lines</span>
<a href="#l1.85"></a><span id="l1.85">    * in the message.  This is important so we know when to stop reading the file</span>
<a href="#l1.86"></a><span id="l1.86">    * without accidentally reading part of the next message.</span>
<a href="#l1.87"></a><span id="l1.87">    */</span>
<a href="#l1.88"></a><span id="l1.88">   uint32_t m_numLocalLines;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineat">@@ -78,35 +74,37 @@ protected:</span>
<a href="#l1.90"></a><span id="l1.90">    * will be the entire number of lines, so this should be false.  When the</span>
<a href="#l1.91"></a><span id="l1.91">    * message is a local message, the number of lines will be the number of body</span>
<a href="#l1.92"></a><span id="l1.92">    * lines.</span>
<a href="#l1.93"></a><span id="l1.93">    */</span>
<a href="#l1.94"></a><span id="l1.94">   bool m_lineCountInBodyLines;</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96">   // Offline IMAP related methods &amp; state</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-</span>
<a href="#l1.99"></a><span id="l1.99">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_msgHdr;</span>
<a href="#l1.100"></a><span id="l1.100">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102">   // Transformations</span>
<a href="#l1.103"></a><span id="l1.103">   // With the exception of m_isMultipart, these all apply to the various parts</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-  bool m_stripHeaders;    // true if we're supposed to strip of message headers</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-  bool m_pastMsgHeaders;  // true if we've already skipped over the message headers</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-  bool m_pastPartHeaders; // true if we've already skipped over the part headers</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-  bool m_partIsQP;        // true if the Content-Transfer-Encoding header claims quoted-printable</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-  bool m_partIsHtml;      // true if the Content-type header claims text/html</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  bool m_base64part;      // true if the current part is in base64</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-  bool m_isMultipart;     // true if the message is a multipart/* message</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  bool m_partIsText;      // true if the current part is text/*</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  bool m_inMessageAttachment; // true if current part is message/*</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  bool m_stripHeaders;     // true if we're supposed to strip of message headers</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  bool m_pastMsgHeaders;   // true if we've already skipped over the message</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+                           // headers</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  bool m_pastPartHeaders;  // true if we've already skipped over the part</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+                           // headers</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+  bool m_partIsQP;     // true if the Content-Transfer-Encoding header claims</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+                       // quoted-printable</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+  bool m_partIsHtml;   // true if the Content-type header claims text/html</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+  bool m_base64part;   // true if the current part is in base64</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  bool m_isMultipart;  // true if the message is a multipart/* message</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+  bool m_partIsText;   // true if the current part is text/*</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  bool m_inMessageAttachment;  // true if current part is message/*</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126">   nsTArray&lt;nsCString&gt; m_boundaries;  // The boundary strings to look for</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-  nsCString m_partCharset; // The charset found in the part</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  nsCString m_partCharset;           // The charset found in the part</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">   // See implementation for comments</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  int32_t ApplyTransformations (const nsCString &amp;line, int32_t length,</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-                                bool &amp;returnThisLine, nsCString &amp;buf);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  void SniffPossibleMIMEHeader (const nsCString &amp;line);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  static void StripHtml (nsCString &amp;buf);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  static void Base64Decode (nsCString &amp;buf);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+  int32_t ApplyTransformations(const nsCString &amp;line, int32_t length,</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+                               bool &amp;returnThisLine, nsCString &amp;buf);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  void SniffPossibleMIMEHeader(const nsCString &amp;line);</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  static void StripHtml(nsCString &amp;buf);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+  static void Base64Decode(nsCString &amp;buf);</span>
<a href="#l1.141"></a><span id="l1.141"> };</span>
<a href="#l1.142"></a><span id="l1.142"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgResultElement.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgResultElement.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -9,32 +9,32 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsMsgSearchCore.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIMsgSearchAdapter.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> // nsMsgResultElement specifies a single search hit.</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> //---------------------------------------------------------------------------</span>
<a href="#l2.11"></a><span id="l2.11"> // nsMsgResultElement is a list of attribute/value pairs which are used to</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// represent a search hit without requiring a message header or server connection</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// represent a search hit without requiring a message header or server</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// connection</span>
<a href="#l2.15"></a><span id="l2.15"> //---------------------------------------------------------------------------</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-class nsMsgResultElement</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-{</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-public:</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  explicit nsMsgResultElement (nsIMsgSearchAdapter *);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  virtual ~nsMsgResultElement ();</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+class nsMsgResultElement {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ public:</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  explicit nsMsgResultElement(nsIMsgSearchAdapter *);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  virtual ~nsMsgResultElement();</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  static nsresult AssignValues (nsIMsgSearchValue *src, nsMsgSearchValue *dst);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  nsresult GetValue (nsMsgSearchAttribValue, nsMsgSearchValue **) const;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  nsresult AddValue (nsIMsgSearchValue*);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    nsresult AddValue (nsMsgSearchValue*);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  static nsresult AssignValues(nsIMsgSearchValue *src, nsMsgSearchValue *dst);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  nsresult GetValue(nsMsgSearchAttribValue, nsMsgSearchValue **) const;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  nsresult AddValue(nsIMsgSearchValue *);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  nsresult AddValue(nsMsgSearchValue *);</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  nsresult GetPrettyName (nsMsgSearchValue**);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  nsresult Open (void *window);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  nsresult GetPrettyName(nsMsgSearchValue **);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  nsresult Open(void *window);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   nsTArray&lt;nsCOMPtr&lt;nsIMsgSearchValue&gt; &gt; m_valueList;</span>
<a href="#l2.42"></a><span id="l2.42">   nsIMsgSearchAdapter *m_adapter;</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-protected:</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+ protected:</span>
<a href="#l2.46"></a><span id="l2.46"> };</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchAdapter.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchAdapter.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -21,42 +21,41 @@ class nsIMsgSearchScopeTerm;</span>
<a href="#l3.4"></a><span id="l3.4"> // These Adapter classes contain the smarts to convert search criteria from</span>
<a href="#l3.5"></a><span id="l3.5"> // the canonical structures in msg_srch.h into whatever format is required</span>
<a href="#l3.6"></a><span id="l3.6"> // by their protocol.</span>
<a href="#l3.7"></a><span id="l3.7"> //</span>
<a href="#l3.8"></a><span id="l3.8"> // There is a separate Adapter class for area (pop, imap, nntp, ldap) to contain</span>
<a href="#l3.9"></a><span id="l3.9"> // the special smarts for that protocol.</span>
<a href="#l3.10"></a><span id="l3.10"> //-----------------------------------------------------------------------------</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-class nsMsgSearchAdapter : public nsIMsgSearchAdapter</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-public:</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  nsMsgSearchAdapter (nsIMsgSearchScopeTerm*, nsIArray*);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+class nsMsgSearchAdapter : public nsIMsgSearchAdapter {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ public:</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  nsMsgSearchAdapter(nsIMsgSearchScopeTerm *, nsIArray *);</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   NS_DECL_ISUPPORTS</span>
<a href="#l3.21"></a><span id="l3.21">   NS_DECL_NSIMSGSEARCHADAPTER</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  nsIMsgSearchScopeTerm        *m_scope;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt;  m_searchTerms;       /* linked list of criteria terms */</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  nsIMsgSearchScopeTerm *m_scope;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_searchTerms; /* linked list of criteria terms */</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  nsString  m_defaultCharset;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  nsString m_defaultCharset;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  static nsresult EncodeImap (char **ppEncoding,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-           nsIArray *searchTerms,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-           const char16_t *srcCharset,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-           const char16_t *destCharset,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-           bool reallyDredd = false);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  static nsresult EncodeImap(char **ppEncoding, nsIArray *searchTerms,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+                             const char16_t *srcCharset,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+                             const char16_t *destCharset,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                             bool reallyDredd = false);</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  static nsresult EncodeImapValue(char *encoding, const char *value, bool useQuotes, bool reallyDredd);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  static nsresult EncodeImapValue(char *encoding, const char *value,</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+                                  bool useQuotes, bool reallyDredd);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   static char *GetImapCharsetParam(const char16_t *destCharset);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  static char16_t *EscapeSearchUrl (const char16_t *nntpCommand);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  static char16_t *EscapeSearchUrl(const char16_t *nntpCommand);</span>
<a href="#l3.48"></a><span id="l3.48">   static char16_t *EscapeImapSearchProtocol(const char16_t *imapCommand);</span>
<a href="#l3.49"></a><span id="l3.49">   static char16_t *EscapeQuoteImapSearchProtocol(const char16_t *imapCommand);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  static char *UnEscapeSearchUrl (const char *commandSpecificData);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  static char *UnEscapeSearchUrl(const char *commandSpecificData);</span>
<a href="#l3.52"></a><span id="l3.52">   // This stuff lives in the base class because the IMAP search syntax</span>
<a href="#l3.53"></a><span id="l3.53">   // is used by the Dredd SEARCH command as well as IMAP itself</span>
<a href="#l3.54"></a><span id="l3.54">   static const char *m_kImapBefore;</span>
<a href="#l3.55"></a><span id="l3.55">   static const char *m_kImapBody;</span>
<a href="#l3.56"></a><span id="l3.56">   static const char *m_kImapCC;</span>
<a href="#l3.57"></a><span id="l3.57">   static const char *m_kImapFrom;</span>
<a href="#l3.58"></a><span id="l3.58">   static const char *m_kImapNot;</span>
<a href="#l3.59"></a><span id="l3.59">   static const char *m_kImapOr;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -75,142 +74,167 @@ public:</span>
<a href="#l3.61"></a><span id="l3.61">   static const char *m_kImapCharset;</span>
<a href="#l3.62"></a><span id="l3.62">   static const char *m_kImapUnDeleted;</span>
<a href="#l3.63"></a><span id="l3.63">   static const char *m_kImapSizeSmaller;</span>
<a href="#l3.64"></a><span id="l3.64">   static const char *m_kImapSizeLarger;</span>
<a href="#l3.65"></a><span id="l3.65">   static const char *m_kImapNew;</span>
<a href="#l3.66"></a><span id="l3.66">   static const char *m_kImapNotNew;</span>
<a href="#l3.67"></a><span id="l3.67">   static const char *m_kImapFlagged;</span>
<a href="#l3.68"></a><span id="l3.68">   static const char *m_kImapNotFlagged;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-protected:</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+ protected:</span>
<a href="#l3.72"></a><span id="l3.72">   virtual ~nsMsgSearchAdapter();</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  typedef enum _msg_TransformType</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  {</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    kOverwrite,    /* &quot;John Doe&quot; -&gt; &quot;John*Doe&quot;,   simple contains   */</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    kInsert,       /* &quot;John Doe&quot; -&gt; &quot;John* Doe&quot;,  name completion   */</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    kSurround      /* &quot;John Doe&quot; -&gt; &quot;John* *Doe&quot;, advanced contains */</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  typedef enum _msg_TransformType {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    kOverwrite, /* &quot;John Doe&quot; -&gt; &quot;John*Doe&quot;,   simple contains   */</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    kInsert,    /* &quot;John Doe&quot; -&gt; &quot;John* Doe&quot;,  name completion   */</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    kSurround   /* &quot;John Doe&quot; -&gt; &quot;John* *Doe&quot;, advanced contains */</span>
<a href="#l3.82"></a><span id="l3.82">   } msg_TransformType;</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  char *TransformSpacesToStars (const char *, msg_TransformType transformType);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  nsresult OpenNewsResultInUnknownGroup (nsMsgResultElement*);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  char *TransformSpacesToStars(const char *, msg_TransformType transformType);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  nsresult OpenNewsResultInUnknownGroup(nsMsgResultElement *);</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  static nsresult EncodeImapTerm (nsIMsgSearchTerm *, bool reallyDredd, const char16_t *srcCharset, const char16_t *destCharset, char **ppOutTerm);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  static nsresult EncodeImapTerm(nsIMsgSearchTerm *, bool reallyDredd,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+                                 const char16_t *srcCharset,</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+                                 const char16_t *destCharset, char **ppOutTerm);</span>
<a href="#l3.93"></a><span id="l3.93"> };</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95"> //-----------------------------------------------------------------------------</span>
<a href="#l3.96"></a><span id="l3.96"> // Validity checking for attrib/op pairs. We need to know what operations are</span>
<a href="#l3.97"></a><span id="l3.97"> // legal in three places:</span>
<a href="#l3.98"></a><span id="l3.98"> //   1. when the FE brings up the dialog box and needs to know how to build</span>
<a href="#l3.99"></a><span id="l3.99"> //      the menus and enable their items</span>
<a href="#l3.100"></a><span id="l3.100"> //   2. when the FE fires off a search, we need to check their lists for</span>
<a href="#l3.101"></a><span id="l3.101"> //      correctness</span>
<a href="#l3.102"></a><span id="l3.102"> //   3. for on-the-fly capability negotion e.g. with XSEARCH-capable news</span>
<a href="#l3.103"></a><span id="l3.103"> //      servers</span>
<a href="#l3.104"></a><span id="l3.104"> //-----------------------------------------------------------------------------</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-class nsMsgSearchValidityTable final : public nsIMsgSearchValidityTable</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-{</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-public:</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  nsMsgSearchValidityTable ();</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+class nsMsgSearchValidityTable final : public nsIMsgSearchValidityTable {</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+ public:</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+  nsMsgSearchValidityTable();</span>
<a href="#l3.113"></a><span id="l3.113">   NS_DECL_NSIMSGSEARCHVALIDITYTABLE</span>
<a href="#l3.114"></a><span id="l3.114">   NS_DECL_ISUPPORTS</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-protected:</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  int m_numAvailAttribs;        // number of rows with at least one available operator</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  typedef struct vtBits</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+ protected:</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+  int m_numAvailAttribs;  // number of rows with at least one available operator</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  typedef struct vtBits {</span>
<a href="#l3.123"></a><span id="l3.123">     uint16_t bitEnabled : 1;</span>
<a href="#l3.124"></a><span id="l3.124">     uint16_t bitAvailable : 1;</span>
<a href="#l3.125"></a><span id="l3.125">     uint16_t bitValidButNotShown : 1;</span>
<a href="#l3.126"></a><span id="l3.126">   } vtBits;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  vtBits m_table [nsMsgSearchAttrib::kNumMsgSearchAttributes][nsMsgSearchOp::kNumMsgSearchOperators];</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-private:</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  vtBits m_table[nsMsgSearchAttrib::kNumMsgSearchAttributes]</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+                [nsMsgSearchOp::kNumMsgSearchOperators];</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+ private:</span>
<a href="#l3.133"></a><span id="l3.133">   ~nsMsgSearchValidityTable() {}</span>
<a href="#l3.134"></a><span id="l3.134">   nsMsgSearchAttribValue m_defaultAttrib;</span>
<a href="#l3.135"></a><span id="l3.135"> };</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137"> // Using getters and setters seems a little nicer then dumping the 2-D array</span>
<a href="#l3.138"></a><span id="l3.138"> // syntax all over the code</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-#define CHECK_AO if (a &lt; 0 || \</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-                     a &gt;= nsMsgSearchAttrib::kNumMsgSearchAttributes || \</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-                     o &lt; 0 || \</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-                     o &gt;= nsMsgSearchOp::kNumMsgSearchOperators) \</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-                   return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-inline nsresult nsMsgSearchValidityTable::SetAvailable (int a, int o, bool b)</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-{ CHECK_AO; m_table [a][o].bitAvailable = b; return NS_OK;}</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-inline nsresult nsMsgSearchValidityTable::SetEnabled (int a, int o, bool b)</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-{ CHECK_AO; m_table [a][o].bitEnabled = b; return NS_OK; }</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-inline nsresult nsMsgSearchValidityTable::SetValidButNotShown (int a, int o, bool b)</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-{ CHECK_AO; m_table [a][o].bitValidButNotShown = b; return NS_OK;}</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+#define CHECK_AO                                                           \</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  if (a &lt; 0 || a &gt;= nsMsgSearchAttrib::kNumMsgSearchAttributes || o &lt; 0 || \</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+      o &gt;= nsMsgSearchOp::kNumMsgSearchOperators)                          \</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+    return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+inline nsresult nsMsgSearchValidityTable::SetAvailable(int a, int o, bool b) {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  CHECK_AO;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  m_table[a][o].bitAvailable = b;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+}</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+inline nsresult nsMsgSearchValidityTable::SetEnabled(int a, int o, bool b) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  CHECK_AO;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  m_table[a][o].bitEnabled = b;</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+}</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+inline nsresult nsMsgSearchValidityTable::SetValidButNotShown(int a, int o,</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+                                                              bool b) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+  CHECK_AO;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+  m_table[a][o].bitValidButNotShown = b;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+}</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-inline nsresult nsMsgSearchValidityTable::GetAvailable (int a, int o, bool *aResult)</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-{ CHECK_AO; *aResult = m_table [a][o].bitAvailable; return NS_OK;}</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-inline nsresult nsMsgSearchValidityTable::GetEnabled (int a, int o, bool *aResult)</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-{ CHECK_AO; *aResult = m_table [a][o].bitEnabled; return NS_OK;}</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-inline nsresult nsMsgSearchValidityTable::GetValidButNotShown (int a, int o, bool *aResult)</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-{ CHECK_AO; *aResult = m_table [a][o].bitValidButNotShown; return NS_OK;}</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+inline nsresult nsMsgSearchValidityTable::GetAvailable(int a, int o,</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+                                                       bool *aResult) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  CHECK_AO;</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  *aResult = m_table[a][o].bitAvailable;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+}</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+inline nsresult nsMsgSearchValidityTable::GetEnabled(int a, int o,</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+                                                     bool *aResult) {</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  CHECK_AO;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  *aResult = m_table[a][o].bitEnabled;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+}</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+inline nsresult nsMsgSearchValidityTable::GetValidButNotShown(int a, int o,</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+                                                              bool *aResult) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  CHECK_AO;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  *aResult = m_table[a][o].bitValidButNotShown;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+}</span>
<a href="#l3.195"></a><span id="l3.195"> #undef CHECK_AO</span>
<a href="#l3.196"></a><span id="l3.196"> </span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-class nsMsgSearchValidityManager : public nsIMsgSearchValidityManager</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-{</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-public:</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-  nsMsgSearchValidityManager ();</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+class nsMsgSearchValidityManager : public nsIMsgSearchValidityManager {</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+ public:</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  nsMsgSearchValidityManager();</span>
<a href="#l3.204"></a><span id="l3.204"> </span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-protected:</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  virtual ~nsMsgSearchValidityManager ();</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+ protected:</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  virtual ~nsMsgSearchValidityManager();</span>
<a href="#l3.209"></a><span id="l3.209"> </span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-public:</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+ public:</span>
<a href="#l3.212"></a><span id="l3.212">   NS_DECL_NSIMSGSEARCHVALIDITYMANAGER</span>
<a href="#l3.213"></a><span id="l3.213">   NS_DECL_ISUPPORTS</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-  nsresult GetTable (int, nsMsgSearchValidityTable**);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+  nsresult GetTable(int, nsMsgSearchValidityTable **);</span>
<a href="#l3.217"></a><span id="l3.217"> </span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-protected:</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+ protected:</span>
<a href="#l3.221"></a><span id="l3.221">   // There's one global validity manager that everyone uses. You *could* do</span>
<a href="#l3.222"></a><span id="l3.222">   // this with static members of the adapter classes, but having a dedicated</span>
<a href="#l3.223"></a><span id="l3.223">   // object makes cleanup of these tables (at shutdown-time) automagic.</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_offlineMailTable;</span>
<a href="#l3.226"></a><span id="l3.226">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_offlineMailFilterTable;</span>
<a href="#l3.227"></a><span id="l3.227">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_onlineMailTable;</span>
<a href="#l3.228"></a><span id="l3.228">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_onlineMailFilterTable;</span>
<a href="#l3.229"></a><span id="l3.229">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_onlineManualFilterTable;</span>
<a href="#l3.230"></a><span id="l3.230"> </span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_newsTable;      // online news</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_newsTable;  // online news</span>
<a href="#l3.233"></a><span id="l3.233"> </span>
<a href="#l3.234"></a><span id="l3.234">   // Local news tables, used for local news searching or offline.</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsTable;         // base table</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsJunkTable;     // base + junk</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsBodyTable;     // base + body</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsJunkBodyTable; // base + junk + body</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsTable;      // base table</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsJunkTable;  // base + junk</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localNewsBodyTable;  // base + body</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValidityTable&gt;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      m_localNewsJunkBodyTable;  // base + junk + body</span>
<a href="#l3.244"></a><span id="l3.244">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_ldapTable;</span>
<a href="#l3.245"></a><span id="l3.245">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_ldapAndTable;</span>
<a href="#l3.246"></a><span id="l3.246">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localABTable;</span>
<a href="#l3.247"></a><span id="l3.247">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_localABAndTable;</span>
<a href="#l3.248"></a><span id="l3.248">   nsCOMPtr&lt;nsIMsgSearchValidityTable&gt; m_newsFilterTable;</span>
<a href="#l3.249"></a><span id="l3.249"> </span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-  nsresult NewTable (nsIMsgSearchValidityTable **);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+  nsresult NewTable(nsIMsgSearchValidityTable **);</span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253">   nsresult InitOfflineMailTable();</span>
<a href="#l3.254"></a><span id="l3.254">   nsresult InitOfflineMailFilterTable();</span>
<a href="#l3.255"></a><span id="l3.255">   nsresult InitOnlineMailTable();</span>
<a href="#l3.256"></a><span id="l3.256">   nsresult InitOnlineMailFilterTable();</span>
<a href="#l3.257"></a><span id="l3.257">   nsresult InitOnlineManualFilterTable();</span>
<a href="#l3.258"></a><span id="l3.258">   nsresult InitNewsTable();</span>
<a href="#l3.259"></a><span id="l3.259">   nsresult InitLocalNewsTable();</span>
<a href="#l3.260"></a><span id="l3.260">   nsresult InitLocalNewsJunkTable();</span>
<a href="#l3.261"></a><span id="l3.261">   nsresult InitLocalNewsBodyTable();</span>
<a href="#l3.262"></a><span id="l3.262">   nsresult InitLocalNewsJunkBodyTable();</span>
<a href="#l3.263"></a><span id="l3.263">   nsresult InitNewsFilterTable();</span>
<a href="#l3.264"></a><span id="l3.264"> </span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-  //set the custom headers in the table, changes whenever &quot;mailnews.customHeaders&quot; pref changes.</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-  nsresult SetOtherHeadersInTable(nsIMsgSearchValidityTable *table, const char *customHeaders);</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  // set the custom headers in the table, changes whenever</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+  // &quot;mailnews.customHeaders&quot; pref changes.</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  nsresult SetOtherHeadersInTable(nsIMsgSearchValidityTable *table,</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+                                  const char *customHeaders);</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272">   nsresult InitLdapTable();</span>
<a href="#l3.273"></a><span id="l3.273">   nsresult InitLdapAndTable();</span>
<a href="#l3.274"></a><span id="l3.274">   nsresult InitLocalABTable();</span>
<a href="#l3.275"></a><span id="l3.275">   nsresult InitLocalABAndTable();</span>
<a href="#l3.276"></a><span id="l3.276">   nsresult SetUpABTable(nsIMsgSearchValidityTable *aTable, bool isOrTable);</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  nsresult EnableDirectoryAttribute(nsIMsgSearchValidityTable *table, nsMsgSearchAttribValue aSearchAttrib);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+  nsresult EnableDirectoryAttribute(nsIMsgSearchValidityTable *table,</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+                                    nsMsgSearchAttribValue aSearchAttrib);</span>
<a href="#l3.280"></a><span id="l3.280"> };</span>
<a href="#l3.281"></a><span id="l3.281"> </span>
<a href="#l3.282"></a><span id="l3.282"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchBoolExpression.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchBoolExpression.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,21 +1,23 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsMsgSearchCore.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> #ifndef __nsMsgSearchBoolExpression_h</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#define __nsMsgSearchBoolExpression_h</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#  define __nsMsgSearchBoolExpression_h</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> //-----------------------------------------------------------------------------</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-// nsMsgSearchBoolExpression is a class added to provide AND/OR terms in search queries.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-//  A nsMsgSearchBoolExpression contains either a search term or two nsMsgSearchBoolExpressions and</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+// nsMsgSearchBoolExpression is a class added to provide AND/OR terms in search</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+// queries.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+//  A nsMsgSearchBoolExpression contains either a search term or two</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+//  nsMsgSearchBoolExpressions and</span>
<a href="#l4.22"></a><span id="l4.22"> //    a boolean operator.</span>
<a href="#l4.23"></a><span id="l4.23"> // I (mscott) am placing it here for now....</span>
<a href="#l4.24"></a><span id="l4.24"> //-----------------------------------------------------------------------------</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> /* CBoolExpression --&gt; encapsulates one or more search terms by internally</span>
<a href="#l4.27"></a><span id="l4.27">    representing the search terms and their boolean operators as a binary</span>
<a href="#l4.28"></a><span id="l4.28">    expression tree. Each node in the tree consists of either</span>
<a href="#l4.29"></a><span id="l4.29">      (1) a boolean operator and two nsMsgSearchBoolExpressions or</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineat">@@ -31,76 +33,78 @@</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">    Order of Evaluation: Okay, the way in which the boolean expression tree</span>
<a href="#l4.33"></a><span id="l4.33">    is put together directly effects the order of evaluation. We currently</span>
<a href="#l4.34"></a><span id="l4.34">    support left to right evaluation.</span>
<a href="#l4.35"></a><span id="l4.35">    Supporting other order of evaluations involves adding new internal add</span>
<a href="#l4.36"></a><span id="l4.36">    term methods.</span>
<a href="#l4.37"></a><span id="l4.37">  */</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-class nsMsgSearchBoolExpression</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-{</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-public:</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+class nsMsgSearchBoolExpression {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ public:</span>
<a href="#l4.45"></a><span id="l4.45">   // create a leaf node expression</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-  explicit nsMsgSearchBoolExpression(nsIMsgSearchTerm * aNewTerm,</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-                              char * aEncodingString = NULL);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  explicit nsMsgSearchBoolExpression(nsIMsgSearchTerm *aNewTerm,</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+                                     char *aEncodingString = NULL);</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">   // create a non-leaf node expression containing 2 expressions</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    // and a boolean operator</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  // and a boolean operator</span>
<a href="#l4.54"></a><span id="l4.54">   nsMsgSearchBoolExpression(nsMsgSearchBoolExpression *,</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-                              nsMsgSearchBoolExpression *,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-                              nsMsgSearchBooleanOperator boolOp);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+                            nsMsgSearchBoolExpression *,</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+                            nsMsgSearchBooleanOperator boolOp);</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">   nsMsgSearchBoolExpression();</span>
<a href="#l4.61"></a><span id="l4.61">   ~nsMsgSearchBoolExpression();  // recursively destroys all sub</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-                                   // expressions as well</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+                                 // expressions as well</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   // accessors</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    // Offline</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-  static nsMsgSearchBoolExpression * AddSearchTerm (nsMsgSearchBoolExpression * aOrigExpr, nsIMsgSearchTerm * aNewTerm, char * aEncodingStr); // IMAP/NNTP</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    static nsMsgSearchBoolExpression * AddExpressionTree(nsMsgSearchBoolExpression * aOrigExpr, nsMsgSearchBoolExpression * aExpression, bool aBoolOp);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  // Offline</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  static nsMsgSearchBoolExpression *AddSearchTerm(</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+      nsMsgSearchBoolExpression *aOrigExpr, nsIMsgSearchTerm *aNewTerm,</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+      char *aEncodingStr);  // IMAP/NNTP</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  static nsMsgSearchBoolExpression *AddExpressionTree(</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+      nsMsgSearchBoolExpression *aOrigExpr,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      nsMsgSearchBoolExpression *aExpression, bool aBoolOp);</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    // parses the expression tree and all</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-    // expressions underneath this node to</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    // determine if the end result is true or false.</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  bool OfflineEvaluate(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-          const char *defaultCharset, nsIMsgSearchScopeTerm *scope,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-          nsIMsgDatabase *db, const nsACString&amp; headers, bool Filtering);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  // parses the expression tree and all</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  // expressions underneath this node to</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  // determine if the end result is true or false.</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  bool OfflineEvaluate(nsIMsgDBHdr *msgToMatch, const char *defaultCharset,</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+                       nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db,</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+                       const nsACString &amp;headers, bool Filtering);</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-    // assuming the expression is for online</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    // searches, determine the length of the</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-    // resulting IMAP/NNTP encoding string</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  // assuming the expression is for online</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  // searches, determine the length of the</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  // resulting IMAP/NNTP encoding string</span>
<a href="#l4.97"></a><span id="l4.97">   int32_t CalcEncodeStrSize();</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    // fills pre-allocated</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    // memory in buffer with</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-    // the IMAP/NNTP encoding for the expression</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  void GenerateEncodeStr(nsCString * buffer);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  // fills pre-allocated</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  // memory in buffer with</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  // the IMAP/NNTP encoding for the expression</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  void GenerateEncodeStr(nsCString *buffer);</span>
<a href="#l4.107"></a><span id="l4.107"> </span>
<a href="#l4.108"></a><span id="l4.108">   // if we are not a leaf node, then we have two other expressions</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    // and a boolean operator</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-  nsMsgSearchBoolExpression * m_leftChild;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  nsMsgSearchBoolExpression * m_rightChild;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  // and a boolean operator</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  nsMsgSearchBoolExpression *m_leftChild;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  nsMsgSearchBoolExpression *m_rightChild;</span>
<a href="#l4.115"></a><span id="l4.115">   nsMsgSearchBooleanOperator m_boolOp;</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-protected:</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+ protected:</span>
<a href="#l4.119"></a><span id="l4.119">   // if we are a leaf node, all we have is a search term</span>
<a href="#l4.120"></a><span id="l4.120"> </span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-    nsIMsgSearchTerm * m_term;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  nsIMsgSearchTerm *m_term;</span>
<a href="#l4.123"></a><span id="l4.123"> </span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-    // store IMAP/NNTP encoding for the search term if applicable</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  // store IMAP/NNTP encoding for the search term if applicable</span>
<a href="#l4.126"></a><span id="l4.126">   nsCString m_encodingStr;</span>
<a href="#l4.127"></a><span id="l4.127"> </span>
<a href="#l4.128"></a><span id="l4.128">   // internal methods</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">   // the idea is to separate the public interface for adding terms to</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-    // the expression tree from the order of evaluation which influences</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-    // how we internally construct the tree. Right now, we are supporting</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-    // left to right evaluation so the tree is constructed to represent</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-    // that by calling leftToRightAddTerm. If future forms of evaluation</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    // need to be supported, add new methods here for proper tree construction.</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  nsMsgSearchBoolExpression * leftToRightAddTerm(nsIMsgSearchTerm * newTerm,</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-                                                   char * encodingStr);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  // the expression tree from the order of evaluation which influences</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  // how we internally construct the tree. Right now, we are supporting</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+  // left to right evaluation so the tree is constructed to represent</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  // that by calling leftToRightAddTerm. If future forms of evaluation</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+  // need to be supported, add new methods here for proper tree construction.</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  nsMsgSearchBoolExpression *leftToRightAddTerm(nsIMsgSearchTerm *newTerm,</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+                                                char *encodingStr);</span>
<a href="#l4.145"></a><span id="l4.145"> };</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchScopeTerm.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchScopeTerm.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -10,35 +10,35 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsMsgSearchScopeTerm.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMsgSearchAdapter.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIMsgSearchAdapter.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-class nsMsgSearchScopeTerm : public nsIMsgSearchScopeTerm</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-public:</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  nsMsgSearchScopeTerm (nsIMsgSearchSession *, nsMsgSearchScopeValue, nsIMsgFolder *);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  nsMsgSearchScopeTerm ();</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+class nsMsgSearchScopeTerm : public nsIMsgSearchScopeTerm {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ public:</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  nsMsgSearchScopeTerm(nsIMsgSearchSession *, nsMsgSearchScopeValue,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+                       nsIMsgFolder *);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  nsMsgSearchScopeTerm();</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   NS_DECL_ISUPPORTS</span>
<a href="#l5.24"></a><span id="l5.24">   NS_DECL_NSIMSGSEARCHSCOPETERM</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  nsresult TimeSlice (bool *aDone);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  nsresult InitializeAdapter (nsIArray *termList);</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  nsresult TimeSlice(bool *aDone);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  nsresult InitializeAdapter(nsIArray *termList);</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  char *GetStatusBarName ();</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  char *GetStatusBarName();</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">   nsMsgSearchScopeValue m_attribute;</span>
<a href="#l5.35"></a><span id="l5.35">   char *m_name;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchAdapter&gt; m_adapter;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; m_inputStream; // for message bodies</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchAdapter&gt; m_adapter;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; m_inputStream;  // for message bodies</span>
<a href="#l5.42"></a><span id="l5.42">   nsWeakPtr m_searchSession;</span>
<a href="#l5.43"></a><span id="l5.43">   bool m_searchServer;</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-private:</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+ private:</span>
<a href="#l5.47"></a><span id="l5.47">   virtual ~nsMsgSearchScopeTerm();</span>
<a href="#l5.48"></a><span id="l5.48"> };</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,85 +1,89 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10"> #ifndef __nsMsgSearchTerm_h</span>
<a href="#l6.11"></a><span id="l6.11"> #define __nsMsgSearchTerm_h</span>
<a href="#l6.12"></a><span id="l6.12"> //---------------------------------------------------------------------------</span>
<a href="#l6.13"></a><span id="l6.13"> // nsMsgSearchTerm specifies one criterion, e.g. name contains phil</span>
<a href="#l6.14"></a><span id="l6.14"> //---------------------------------------------------------------------------</span>
<a href="#l6.15"></a><span id="l6.15"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;nsIMsgSearchScopeTerm.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18"> #include &quot;nsIMsgSearchCustomTerm.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> // needed to search for addresses in address books</span>
<a href="#l6.21"></a><span id="l6.21"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-#define EMPTY_MESSAGE_LINE(buf) (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+#define EMPTY_MESSAGE_LINE(buf) \</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-class nsMsgSearchTerm : public nsIMsgSearchTerm</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-{</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-public:</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+class nsMsgSearchTerm : public nsIMsgSearchTerm {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ public:</span>
<a href="#l6.32"></a><span id="l6.32">   nsMsgSearchTerm();</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  nsMsgSearchTerm (nsMsgSearchAttribValue, nsMsgSearchOpValue, nsIMsgSearchValue *, nsMsgSearchBooleanOperator, const char * arbitraryHeader);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  nsMsgSearchTerm(nsMsgSearchAttribValue, nsMsgSearchOpValue,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+                  nsIMsgSearchValue *, nsMsgSearchBooleanOperator,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+                  const char *arbitraryHeader);</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-    NS_DECL_NSIMSGSEARCHTERM</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  NS_DECL_NSIMSGSEARCHTERM</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  nsresult DeStream (char *, int16_t length);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-  nsresult DeStreamNew (char *, int16_t length);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  nsresult DeStream(char *, int16_t length);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  nsresult DeStreamNew(char *, int16_t length);</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  nsresult GetLocalTimes (PRTime, PRTime, PRExplodedTime &amp;, PRExplodedTime &amp;);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  nsresult GetLocalTimes(PRTime, PRTime, PRExplodedTime &amp;, PRExplodedTime &amp;);</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  bool IsBooleanOpAND() { return m_booleanOp == nsMsgSearchBooleanOp::BooleanAND ? true : false;}</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  nsMsgSearchBooleanOperator GetBooleanOp() {return m_booleanOp;}</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  bool IsBooleanOpAND() {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+    return m_booleanOp == nsMsgSearchBooleanOp::BooleanAND ? true : false;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  }</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+  nsMsgSearchBooleanOperator GetBooleanOp() { return m_booleanOp; }</span>
<a href="#l6.57"></a><span id="l6.57">   // maybe should return nsString &amp;   ??</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  const char * GetArbitraryHeader() {return m_arbitraryHeader.get();}</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  const char *GetArbitraryHeader() { return m_arbitraryHeader.get(); }</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  static char *  EscapeQuotesInStr(const char *str);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  static char *EscapeQuotesInStr(const char *str);</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64">   nsMsgSearchAttribValue m_attribute;</span>
<a href="#l6.65"></a><span id="l6.65">   nsMsgSearchOpValue m_operator;</span>
<a href="#l6.66"></a><span id="l6.66">   nsMsgSearchValue m_value;</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  // boolean operator to be applied to this search term and the search term which precedes it.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  // boolean operator to be applied to this search term and the search term</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  // which precedes it.</span>
<a href="#l6.71"></a><span id="l6.71">   nsMsgSearchBooleanOperator m_booleanOp;</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  // user specified string for the name of the arbitrary header to be used in the search</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  // only has a value when m_attribute = OtherHeader!!!!</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  // user specified string for the name of the arbitrary header to be used in</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  // the search only has a value when m_attribute = OtherHeader!!!!</span>
<a href="#l6.77"></a><span id="l6.77">   nsCString m_arbitraryHeader;</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79">   // db hdr property name to use - used when m_attribute = HdrProperty.</span>
<a href="#l6.80"></a><span id="l6.80">   nsCString m_hdrProperty;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  bool m_matchAll; // does this term match all headers?</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-  nsCString m_customId; // id of custom search term</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  bool m_matchAll;       // does this term match all headers?</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  nsCString m_customId;  // id of custom search term</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-protected:</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+ protected:</span>
<a href="#l6.88"></a><span id="l6.88">   virtual ~nsMsgSearchTerm();</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   nsresult MatchString(const nsACString &amp;stringToMatch, const char *charset,</span>
<a href="#l6.91"></a><span id="l6.91">                        bool *pResult);</span>
<a href="#l6.92"></a><span id="l6.92">   nsresult MatchString(const nsAString &amp;stringToMatch, bool *pResult);</span>
<a href="#l6.93"></a><span id="l6.93">   nsresult OutputValue(nsCString &amp;outputStr);</span>
<a href="#l6.94"></a><span id="l6.94">   nsresult ParseAttribute(char *inStream, nsMsgSearchAttribValue *attrib);</span>
<a href="#l6.95"></a><span id="l6.95">   nsresult ParseOperator(char *inStream, nsMsgSearchOpValue *value);</span>
<a href="#l6.96"></a><span id="l6.96">   nsresult ParseValue(char *inStream);</span>
<a href="#l6.97"></a><span id="l6.97">   /**</span>
<a href="#l6.98"></a><span id="l6.98">    * Switch a string to lower case, except for special database rows</span>
<a href="#l6.99"></a><span id="l6.99">    * that are not headers, but could be headers</span>
<a href="#l6.100"></a><span id="l6.100">    *</span>
<a href="#l6.101"></a><span id="l6.101">    * @param aValue  the string to switch</span>
<a href="#l6.102"></a><span id="l6.102">    */</span>
<a href="#l6.103"></a><span id="l6.103">   void ToLowerCaseExceptSpecials(nsACString &amp;aValue);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-    nsresult InitializeAddressBook();</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  nsresult InitializeAddressBook();</span>
<a href="#l6.106"></a><span id="l6.106">   nsresult MatchInAddressBook(const nsAString &amp;aAddress, bool *pResult);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    // fields used by search in address book</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-    nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  // fields used by search in address book</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-    bool mBeginsGrouping;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    bool mEndsGrouping;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  bool mBeginsGrouping;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+  bool mEndsGrouping;</span>
<a href="#l6.116"></a><span id="l6.116"> };</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgBodyHandler.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgBodyHandler.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -12,203 +12,189 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;plbase64.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;prmem.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-nsMsgBodyHandler::nsMsgBodyHandler (nsIMsgSearchScopeTerm * scope,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                                    uint32_t numLines,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-                                    nsIMsgDBHdr* msg, nsIMsgDatabase * db)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-{</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+nsMsgBodyHandler::nsMsgBodyHandler(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+                                   uint32_t numLines, nsIMsgDBHdr *msg,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+                                   nsIMsgDatabase *db) {</span>
<a href="#l7.19"></a><span id="l7.19">   m_scope = scope;</span>
<a href="#l7.20"></a><span id="l7.20">   m_numLocalLines = numLines;</span>
<a href="#l7.21"></a><span id="l7.21">   uint32_t flags;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  m_lineCountInBodyLines = NS_SUCCEEDED(msg-&gt;GetFlags(&amp;flags)) ?</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-    !(flags &amp; nsMsgMessageFlags::Offline) : true;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  m_lineCountInBodyLines = NS_SUCCEEDED(msg-&gt;GetFlags(&amp;flags))</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+                               ? !(flags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+                               : true;</span>
<a href="#l7.27"></a><span id="l7.27">   // account for added x-mozilla-status lines, and envelope line.</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  if (!m_lineCountInBodyLines)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-    m_numLocalLines += 3;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  if (!m_lineCountInBodyLines) m_numLocalLines += 3;</span>
<a href="#l7.31"></a><span id="l7.31">   m_msgHdr = msg;</span>
<a href="#l7.32"></a><span id="l7.32">   m_db = db;</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  // the following are variables used when the body handler is handling stuff from filters....through this constructor, that is not the</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  // case so we set them to NULL.</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  // the following are variables used when the body handler is handling stuff</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  // from filters....through this constructor, that is not the case so we set</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  // them to NULL.</span>
<a href="#l7.39"></a><span id="l7.39">   m_headers = NULL;</span>
<a href="#l7.40"></a><span id="l7.40">   m_headersSize = 0;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  m_Filtering = false; // make sure we set this before we call initialize...</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  m_Filtering = false;  // make sure we set this before we call initialize...</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   Initialize();  // common initialization stuff</span>
<a href="#l7.45"></a><span id="l7.45">   OpenLocalFolder();</span>
<a href="#l7.46"></a><span id="l7.46"> }</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-nsMsgBodyHandler::nsMsgBodyHandler(nsIMsgSearchScopeTerm * scope,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-                                   uint32_t numLines,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-                                   nsIMsgDBHdr* msg, nsIMsgDatabase* db,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-                                   const char * headers, uint32_t headersSize,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-                                   bool Filtering)</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-{</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+nsMsgBodyHandler::nsMsgBodyHandler(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                                   uint32_t numLines, nsIMsgDBHdr *msg,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                                   nsIMsgDatabase *db, const char *headers,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                                   uint32_t headersSize, bool Filtering) {</span>
<a href="#l7.58"></a><span id="l7.58">   m_scope = scope;</span>
<a href="#l7.59"></a><span id="l7.59">   m_numLocalLines = numLines;</span>
<a href="#l7.60"></a><span id="l7.60">   uint32_t flags;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  m_lineCountInBodyLines = NS_SUCCEEDED(msg-&gt;GetFlags(&amp;flags)) ?</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    !(flags &amp; nsMsgMessageFlags::Offline) : true;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  m_lineCountInBodyLines = NS_SUCCEEDED(msg-&gt;GetFlags(&amp;flags))</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                               ? !(flags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+                               : true;</span>
<a href="#l7.66"></a><span id="l7.66">   // account for added x-mozilla-status lines, and envelope line.</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  if (!m_lineCountInBodyLines)</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    m_numLocalLines += 3;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  if (!m_lineCountInBodyLines) m_numLocalLines += 3;</span>
<a href="#l7.70"></a><span id="l7.70">   m_msgHdr = msg;</span>
<a href="#l7.71"></a><span id="l7.71">   m_db = db;</span>
<a href="#l7.72"></a><span id="l7.72">   m_headersSize = headersSize;</span>
<a href="#l7.73"></a><span id="l7.73">   m_Filtering = Filtering;</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75">   Initialize();</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">   if (m_Filtering)</span>
<a href="#l7.78"></a><span id="l7.78">     m_headers = headers;</span>
<a href="#l7.79"></a><span id="l7.79">   else</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    OpenLocalFolder();  // if nothing else applies, then we must be a POP folder file</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    OpenLocalFolder();  // if nothing else applies, then we must be a POP folder</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+                        // file</span>
<a href="#l7.83"></a><span id="l7.83"> }</span>
<a href="#l7.84"></a><span id="l7.84"> </span>
<a href="#l7.85"></a><span id="l7.85"> void nsMsgBodyHandler::Initialize()</span>
<a href="#l7.86"></a><span id="l7.86"> // common initialization code regardless of what body type we are handling...</span>
<a href="#l7.87"></a><span id="l7.87"> {</span>
<a href="#l7.88"></a><span id="l7.88">   // Default transformations for local message search and MAPI access</span>
<a href="#l7.89"></a><span id="l7.89">   m_stripHeaders = true;</span>
<a href="#l7.90"></a><span id="l7.90">   m_partIsHtml = false;</span>
<a href="#l7.91"></a><span id="l7.91">   m_base64part = false;</span>
<a href="#l7.92"></a><span id="l7.92">   m_partIsQP = false;</span>
<a href="#l7.93"></a><span id="l7.93">   m_isMultipart = false;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-  m_partIsText = true; // Default is text/plain, maybe proven otherwise later.</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  m_partIsText = true;  // Default is text/plain, maybe proven otherwise later.</span>
<a href="#l7.96"></a><span id="l7.96">   m_pastMsgHeaders = false;</span>
<a href="#l7.97"></a><span id="l7.97">   m_pastPartHeaders = false;</span>
<a href="#l7.98"></a><span id="l7.98">   m_inMessageAttachment = false;</span>
<a href="#l7.99"></a><span id="l7.99">   m_headerBytesRead = 0;</span>
<a href="#l7.100"></a><span id="l7.100"> }</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-nsMsgBodyHandler::~nsMsgBodyHandler()</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-{</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-}</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+nsMsgBodyHandler::~nsMsgBodyHandler() {}</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-int32_t nsMsgBodyHandler::GetNextLine (nsCString &amp;buf, nsCString &amp;charset)</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-{</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  int32_t length = -1;          // length of incoming line or -1 eof</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  int32_t outLength = -1;       // length of outgoing line or -1 eof</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+int32_t nsMsgBodyHandler::GetNextLine(nsCString &amp;buf, nsCString &amp;charset) {</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  int32_t length = -1;     // length of incoming line or -1 eof</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  int32_t outLength = -1;  // length of outgoing line or -1 eof</span>
<a href="#l7.114"></a><span id="l7.114">   bool eatThisLine = true;</span>
<a href="#l7.115"></a><span id="l7.115">   nsAutoCString nextLine;</span>
<a href="#l7.116"></a><span id="l7.116"> </span>
<a href="#l7.117"></a><span id="l7.117">   while (eatThisLine) {</span>
<a href="#l7.118"></a><span id="l7.118">     // first, handle the filtering case...this is easy....</span>
<a href="#l7.119"></a><span id="l7.119">     if (m_Filtering)</span>
<a href="#l7.120"></a><span id="l7.120">       length = GetNextFilterLine(nextLine);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-    else</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-    {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+    else {</span>
<a href="#l7.124"></a><span id="l7.124">       // 3 cases: Offline IMAP, POP, or we are dealing with a news message....</span>
<a href="#l7.125"></a><span id="l7.125">       // Offline cases should be same as local mail cases, since we're going</span>
<a href="#l7.126"></a><span id="l7.126">       // to store offline messages in berkeley format folders.</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-      if (m_db)</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-      {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-         length = GetNextLocalLine (nextLine); // (2) POP</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      if (m_db) {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+        length = GetNextLocalLine(nextLine);  // (2) POP</span>
<a href="#l7.132"></a><span id="l7.132">       }</span>
<a href="#l7.133"></a><span id="l7.133">     }</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    if (length &lt; 0)</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-      break; // eof in</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    if (length &lt; 0) break;  // eof in</span>
<a href="#l7.138"></a><span id="l7.138"> </span>
<a href="#l7.139"></a><span id="l7.139">     outLength = ApplyTransformations(nextLine, length, eatThisLine, buf);</span>
<a href="#l7.140"></a><span id="l7.140">   }</span>
<a href="#l7.141"></a><span id="l7.141"> </span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  if (outLength &lt; 0)</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    return -1; // eof out</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  if (outLength &lt; 0) return -1;  // eof out</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146">   // For non-multipart messages, the entire message minus headers is encoded</span>
<a href="#l7.147"></a><span id="l7.147">   // ApplyTransformations can only decode a part</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-  if (!m_isMultipart &amp;&amp; m_base64part)</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+  if (!m_isMultipart &amp;&amp; m_base64part) {</span>
<a href="#l7.151"></a><span id="l7.151">     Base64Decode(buf);</span>
<a href="#l7.152"></a><span id="l7.152">     m_base64part = false;</span>
<a href="#l7.153"></a><span id="l7.153">     // And reapply our transformations...</span>
<a href="#l7.154"></a><span id="l7.154">     outLength = ApplyTransformations(buf, buf.Length(), eatThisLine, buf);</span>
<a href="#l7.155"></a><span id="l7.155">   }</span>
<a href="#l7.156"></a><span id="l7.156"> </span>
<a href="#l7.157"></a><span id="l7.157">   // Process aggregated HTML.</span>
<a href="#l7.158"></a><span id="l7.158">   if (!m_isMultipart &amp;&amp; m_partIsHtml) {</span>
<a href="#l7.159"></a><span id="l7.159">     StripHtml(buf);</span>
<a href="#l7.160"></a><span id="l7.160">     outLength = buf.Length();</span>
<a href="#l7.161"></a><span id="l7.161">   }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163">   charset = m_partCharset;</span>
<a href="#l7.164"></a><span id="l7.164">   return outLength;</span>
<a href="#l7.165"></a><span id="l7.165"> }</span>
<a href="#l7.166"></a><span id="l7.166"> </span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-void nsMsgBodyHandler::OpenLocalFolder()</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-{</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+void nsMsgBodyHandler::OpenLocalFolder() {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l7.172"></a><span id="l7.172">   nsresult rv = m_scope-&gt;GetInputStream(m_msgHdr, getter_AddRefs(inputStream));</span>
<a href="#l7.173"></a><span id="l7.173">   // Warn and return if GetInputStream fails</span>
<a href="#l7.174"></a><span id="l7.174">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.175"></a><span id="l7.175">   m_fileLineStream = do_QueryInterface(inputStream);</span>
<a href="#l7.176"></a><span id="l7.176"> }</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-int32_t nsMsgBodyHandler::GetNextFilterLine(nsCString &amp;buf)</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-{</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  // m_nextHdr always points to the next header in the list....the list is NULL terminated...</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+int32_t nsMsgBodyHandler::GetNextFilterLine(nsCString &amp;buf) {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  // m_nextHdr always points to the next header in the list....the list is NULL</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  // terminated...</span>
<a href="#l7.184"></a><span id="l7.184">   uint32_t numBytesCopied = 0;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-  if (m_headersSize &gt; 0)</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-  {</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-    // #mscott. Ugly hack! filter headers list have CRs &amp; LFs inside the NULL delimited list of header</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-    // strings. It is possible to have: To NULL CR LF From. We want to skip over these CR/LFs if they start</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-    // at the beginning of what we think is another header.</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  if (m_headersSize &gt; 0) {</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    // #mscott. Ugly hack! filter headers list have CRs &amp; LFs inside the NULL</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+    // delimited list of header strings. It is possible to have: To NULL CR LF</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    // From. We want to skip over these CR/LFs if they start at the beginning of</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    // what we think is another header.</span>
<a href="#l7.195"></a><span id="l7.195"> </span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    while (m_headersSize &gt; 0 &amp;&amp; (m_headers[0] == '\r' || m_headers[0] == '\n' || m_headers[0] == ' ' || m_headers[0] == '\0'))</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    while (m_headersSize &gt; 0 &amp;&amp; (m_headers[0] == '\r' || m_headers[0] == '\n' ||</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+                                 m_headers[0] == ' ' || m_headers[0] == '\0')) {</span>
<a href="#l7.200"></a><span id="l7.200">       m_headers++;  // skip over these chars...</span>
<a href="#l7.201"></a><span id="l7.201">       m_headersSize--;</span>
<a href="#l7.202"></a><span id="l7.202">     }</span>
<a href="#l7.203"></a><span id="l7.203"> </span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-    if (m_headersSize &gt; 0)</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-    {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-      numBytesCopied = strlen(m_headers) + 1 ;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+    if (m_headersSize &gt; 0) {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+      numBytesCopied = strlen(m_headers) + 1;</span>
<a href="#l7.209"></a><span id="l7.209">       buf.Assign(m_headers);</span>
<a href="#l7.210"></a><span id="l7.210">       m_headers += numBytesCopied;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-      // be careful...m_headersSize is unsigned. Don't let it go negative or we overflow to 2^32....*yikes*</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+      // be careful...m_headersSize is unsigned. Don't let it go negative or we</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+      // overflow to 2^32....*yikes*</span>
<a href="#l7.214"></a><span id="l7.214">       if (m_headersSize &lt; numBytesCopied)</span>
<a href="#l7.215"></a><span id="l7.215">         m_headersSize = 0;</span>
<a href="#l7.216"></a><span id="l7.216">       else</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-        m_headersSize -= numBytesCopied;  // update # bytes we have read from the headers list</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+        m_headersSize -= numBytesCopied;  // update # bytes we have read from</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                                          // the headers list</span>
<a href="#l7.220"></a><span id="l7.220"> </span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-      return (int32_t) numBytesCopied;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+      return (int32_t)numBytesCopied;</span>
<a href="#l7.223"></a><span id="l7.223">     }</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-  }</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-  else if (m_headersSize == 0) {</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  } else if (m_headersSize == 0) {</span>
<a href="#l7.227"></a><span id="l7.227">     buf.Truncate();</span>
<a href="#l7.228"></a><span id="l7.228">   }</span>
<a href="#l7.229"></a><span id="l7.229">   return -1;</span>
<a href="#l7.230"></a><span id="l7.230"> }</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232"> // return -1 if no more local lines, length of next line otherwise.</span>
<a href="#l7.233"></a><span id="l7.233"> </span>
<a href="#l7.234"></a><span id="l7.234"> int32_t nsMsgBodyHandler::GetNextLocalLine(nsCString &amp;buf)</span>
<a href="#l7.235"></a><span id="l7.235"> // returns number of bytes copied</span>
<a href="#l7.236"></a><span id="l7.236"> {</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  if (m_numLocalLines)</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  if (m_numLocalLines) {</span>
<a href="#l7.240"></a><span id="l7.240">     // I the line count is in body lines, only decrement once we have</span>
<a href="#l7.241"></a><span id="l7.241">     // processed all the headers.  Otherwise the line is not in body</span>
<a href="#l7.242"></a><span id="l7.242">     // lines and we want to decrement for every line.</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-    if (m_pastMsgHeaders || !m_lineCountInBodyLines)</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-      m_numLocalLines--;</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+    if (m_pastMsgHeaders || !m_lineCountInBodyLines) m_numLocalLines--;</span>
<a href="#l7.246"></a><span id="l7.246">     // do we need to check the return value here?</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    if (m_fileLineStream)</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    {</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    if (m_fileLineStream) {</span>
<a href="#l7.250"></a><span id="l7.250">       bool more = false;</span>
<a href="#l7.251"></a><span id="l7.251">       nsresult rv = m_fileLineStream-&gt;ReadLine(buf, &amp;more);</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-        return buf.Length();</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+      if (NS_SUCCEEDED(rv)) return buf.Length();</span>
<a href="#l7.255"></a><span id="l7.255">     }</span>
<a href="#l7.256"></a><span id="l7.256">   }</span>
<a href="#l7.257"></a><span id="l7.257"> </span>
<a href="#l7.258"></a><span id="l7.258">   return -1;</span>
<a href="#l7.259"></a><span id="l7.259"> }</span>
<a href="#l7.260"></a><span id="l7.260"> </span>
<a href="#l7.261"></a><span id="l7.261"> /**</span>
<a href="#l7.262"></a><span id="l7.262">  * This method applies a sequence of transformations to the line.</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineat">@@ -227,25 +213,25 @@ int32_t nsMsgBodyHandler::GetNextLocalLi</span>
<a href="#l7.264"></a><span id="l7.264">  * @param line        (in)    the current line</span>
<a href="#l7.265"></a><span id="l7.265">  * @param length      (in)    the length of said line</span>
<a href="#l7.266"></a><span id="l7.266">  * @param eatThisLine (out)   whether or not to ignore this line</span>
<a href="#l7.267"></a><span id="l7.267">  * @param buf         (inout) if m_base64part, the current part as needed for</span>
<a href="#l7.268"></a><span id="l7.268">  *                            decoding; else, it is treated as an out param (a</span>
<a href="#l7.269"></a><span id="l7.269">  *                            redundant version of line).</span>
<a href="#l7.270"></a><span id="l7.270">  * @return            the length of the line after applying transformations</span>
<a href="#l7.271"></a><span id="l7.271">  */</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-int32_t nsMsgBodyHandler::ApplyTransformations (const nsCString &amp;line, int32_t length,</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-                                                bool &amp;eatThisLine, nsCString &amp;buf)</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-{</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+int32_t nsMsgBodyHandler::ApplyTransformations(const nsCString &amp;line,</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+                                               int32_t length,</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+                                               bool &amp;eatThisLine,</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+                                               nsCString &amp;buf) {</span>
<a href="#l7.279"></a><span id="l7.279">   eatThisLine = false;</span>
<a href="#l7.280"></a><span id="l7.280"> </span>
<a href="#l7.281"></a><span id="l7.281">   if (!m_pastPartHeaders)  // line is a line from the part headers</span>
<a href="#l7.282"></a><span id="l7.282">   {</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-    if (m_stripHeaders)</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-      eatThisLine = true;</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    if (m_stripHeaders) eatThisLine = true;</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287">     // We have already grabbed all worthwhile information from the headers,</span>
<a href="#l7.288"></a><span id="l7.288">     // so there is no need to keep track of the current lines</span>
<a href="#l7.289"></a><span id="l7.289">     buf.Assign(line);</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291">     SniffPossibleMIMEHeader(buf);</span>
<a href="#l7.292"></a><span id="l7.292"> </span>
<a href="#l7.293"></a><span id="l7.293">     if (buf.IsEmpty() || buf.First() == '\r' || buf.First() == '\n') {</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineat">@@ -256,247 +242,222 @@ int32_t nsMsgBodyHandler::ApplyTransform</span>
<a href="#l7.295"></a><span id="l7.295">         // part header for the attached message. We now need to read</span>
<a href="#l7.296"></a><span id="l7.296">         // the message headers and any part headers.</span>
<a href="#l7.297"></a><span id="l7.297">         // We can now forget about the special handling of attached messages.</span>
<a href="#l7.298"></a><span id="l7.298">         m_inMessageAttachment = false;</span>
<a href="#l7.299"></a><span id="l7.299">       }</span>
<a href="#l7.300"></a><span id="l7.300">     }</span>
<a href="#l7.301"></a><span id="l7.301"> </span>
<a href="#l7.302"></a><span id="l7.302">     // We set m_pastMsgHeaders to 'true' only once.</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-    if (m_pastPartHeaders)</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-      m_pastMsgHeaders = true;</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+    if (m_pastPartHeaders) m_pastMsgHeaders = true;</span>
<a href="#l7.306"></a><span id="l7.306"> </span>
<a href="#l7.307"></a><span id="l7.307">     return length;</span>
<a href="#l7.308"></a><span id="l7.308">   }</span>
<a href="#l7.309"></a><span id="l7.309"> </span>
<a href="#l7.310"></a><span id="l7.310">   // Check to see if this is one of our boundary strings.</span>
<a href="#l7.311"></a><span id="l7.311">   bool matchedBoundary = false;</span>
<a href="#l7.312"></a><span id="l7.312">   if (m_isMultipart &amp;&amp; m_boundaries.Length() &gt; 0) {</span>
<a href="#l7.313"></a><span id="l7.313">     for (int32_t i = (int32_t)m_boundaries.Length() - 1; i &gt;= 0; i--) {</span>
<a href="#l7.314"></a><span id="l7.314">       if (StringBeginsWith(line, m_boundaries[i])) {</span>
<a href="#l7.315"></a><span id="l7.315">         matchedBoundary = true;</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-        // If we matched a boundary, we won't need the nested/later ones any more.</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-        m_boundaries.SetLength(i+1);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+        // If we matched a boundary, we won't need the nested/later ones any</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+        // more.</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+        m_boundaries.SetLength(i + 1);</span>
<a href="#l7.321"></a><span id="l7.321">         break;</span>
<a href="#l7.322"></a><span id="l7.322">       }</span>
<a href="#l7.323"></a><span id="l7.323">     }</span>
<a href="#l7.324"></a><span id="l7.324">   }</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-  if (matchedBoundary)</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-  {</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-    if (m_base64part &amp;&amp; m_partIsText)</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-    {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+  if (matchedBoundary) {</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+    if (m_base64part &amp;&amp; m_partIsText) {</span>
<a href="#l7.331"></a><span id="l7.331">       Base64Decode(buf);</span>
<a href="#l7.332"></a><span id="l7.332">       // Work on the parsed string</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-      if (!buf.Length())</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-      {</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+      if (!buf.Length()) {</span>
<a href="#l7.336"></a><span id="l7.336">         NS_WARNING(&quot;Trying to transform an empty buffer&quot;);</span>
<a href="#l7.337"></a><span id="l7.337">         eatThisLine = true;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-      }</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-      else</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-      {</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+      } else {</span>
<a href="#l7.342"></a><span id="l7.342">         // It is wrong to call ApplyTransformations() here since this will</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-        // lead to the buffer being doubled-up at |buf.Append(line.get());| below.</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-        // ApplyTransformations(buf, buf.Length(), eatThisLine, buf);</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+        // lead to the buffer being doubled-up at |buf.Append(line.get());|</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+        // below. ApplyTransformations(buf, buf.Length(), eatThisLine, buf);</span>
<a href="#l7.347"></a><span id="l7.347">         // Avoid spurious failures</span>
<a href="#l7.348"></a><span id="l7.348">         eatThisLine = false;</span>
<a href="#l7.349"></a><span id="l7.349">       }</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-    }</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-    else if (!m_partIsHtml)</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-    {</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+    } else if (!m_partIsHtml) {</span>
<a href="#l7.354"></a><span id="l7.354">       buf.Truncate();</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-      eatThisLine = true; // We have no content...</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+      eatThisLine = true;  // We have no content...</span>
<a href="#l7.357"></a><span id="l7.357">     }</span>
<a href="#l7.358"></a><span id="l7.358"> </span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-    if (m_partIsHtml)</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-    {</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+    if (m_partIsHtml) {</span>
<a href="#l7.362"></a><span id="l7.362">       StripHtml(buf);</span>
<a href="#l7.363"></a><span id="l7.363">     }</span>
<a href="#l7.364"></a><span id="l7.364"> </span>
<a href="#l7.365"></a><span id="l7.365">     // Reset all assumed headers</span>
<a href="#l7.366"></a><span id="l7.366">     m_base64part = false;</span>
<a href="#l7.367"></a><span id="l7.367">     // Get ready to sniff new part headers, but do not reset m_pastMsgHeaders</span>
<a href="#l7.368"></a><span id="l7.368">     // since it will screw the body line count.</span>
<a href="#l7.369"></a><span id="l7.369">     m_pastPartHeaders = false;</span>
<a href="#l7.370"></a><span id="l7.370">     m_partIsHtml = false;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-    // If we ever see a multipart message, each part needs to set 'm_partIsText',</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-    // so no more defaulting to 'true' when the part is done.</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+    // If we ever see a multipart message, each part needs to set</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+    // 'm_partIsText', so no more defaulting to 'true' when the part is done.</span>
<a href="#l7.375"></a><span id="l7.375">     m_partIsText = false;</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377">     // Note: we cannot reset 'm_partIsQP' yet since we still need it to process</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-    // the last buffer returned here. Parsing the next part will set a new value.</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+    // the last buffer returned here. Parsing the next part will set a new</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+    // value.</span>
<a href="#l7.381"></a><span id="l7.381">     return buf.Length();</span>
<a href="#l7.382"></a><span id="l7.382">   }</span>
<a href="#l7.383"></a><span id="l7.383"> </span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  if (!m_partIsText)</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-  {</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+  if (!m_partIsText) {</span>
<a href="#l7.387"></a><span id="l7.387">     // Ignore non-text parts</span>
<a href="#l7.388"></a><span id="l7.388">     buf.Truncate();</span>
<a href="#l7.389"></a><span id="l7.389">     eatThisLine = true;</span>
<a href="#l7.390"></a><span id="l7.390">     return 0;</span>
<a href="#l7.391"></a><span id="l7.391">   }</span>
<a href="#l7.392"></a><span id="l7.392"> </span>
<a href="#l7.393"></a><span id="l7.393">   // Accumulate base64 parts and HTML parts for later decoding or tag stripping.</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-  if (m_base64part || m_partIsHtml)</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  {</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-    if (m_partIsHtml &amp;&amp; ! m_base64part)  // Replace newline in HTML with a space.</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  if (m_base64part || m_partIsHtml) {</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+    if (m_partIsHtml &amp;&amp; !m_base64part)  // Replace newline in HTML with a space.</span>
<a href="#l7.399"></a><span id="l7.399">       buf.Append(' ');</span>
<a href="#l7.400"></a><span id="l7.400">     buf.Append(line.get());</span>
<a href="#l7.401"></a><span id="l7.401">     eatThisLine = true;</span>
<a href="#l7.402"></a><span id="l7.402">     return buf.Length();</span>
<a href="#l7.403"></a><span id="l7.403">   }</span>
<a href="#l7.404"></a><span id="l7.404"> </span>
<a href="#l7.405"></a><span id="l7.405">   buf.Assign(line);</span>
<a href="#l7.406"></a><span id="l7.406">   return buf.Length();</span>
<a href="#l7.407"></a><span id="l7.407"> }</span>
<a href="#l7.408"></a><span id="l7.408"> </span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-void nsMsgBodyHandler::StripHtml(nsCString &amp;pBufInOut)</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-{</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  char *pBuf = (char*) PR_Malloc (pBufInOut.Length() + 1);</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-  if (pBuf)</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-  {</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+void nsMsgBodyHandler::StripHtml(nsCString &amp;pBufInOut) {</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+  char *pBuf = (char *)PR_Malloc(pBufInOut.Length() + 1);</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  if (pBuf) {</span>
<a href="#l7.417"></a><span id="l7.417">     char *pWalk = pBuf;</span>
<a href="#l7.418"></a><span id="l7.418"> </span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-    char *pWalkInOut = (char *) pBufInOut.get();</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+    char *pWalkInOut = (char *)pBufInOut.get();</span>
<a href="#l7.421"></a><span id="l7.421">     bool inTag = false;</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-    while (*pWalkInOut) // throw away everything inside &lt; &gt;</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+    while (*pWalkInOut)  // throw away everything inside &lt; &gt;</span>
<a href="#l7.424"></a><span id="l7.424">     {</span>
<a href="#l7.425"></a><span id="l7.425">       if (!inTag) {</span>
<a href="#l7.426"></a><span id="l7.426">         if (*pWalkInOut == '&lt;')</span>
<a href="#l7.427"></a><span id="l7.427">           inTag = true;</span>
<a href="#l7.428"></a><span id="l7.428">         else</span>
<a href="#l7.429"></a><span id="l7.429">           *pWalk++ = *pWalkInOut;</span>
<a href="#l7.430"></a><span id="l7.430">       } else {</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-        if (*pWalkInOut == '&gt;')</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-          inTag = false;</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+        if (*pWalkInOut == '&gt;') inTag = false;</span>
<a href="#l7.434"></a><span id="l7.434">       }</span>
<a href="#l7.435"></a><span id="l7.435">       pWalkInOut++;</span>
<a href="#l7.436"></a><span id="l7.436">     }</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-    *pWalk = 0; // null terminator</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+    *pWalk = 0;  // null terminator</span>
<a href="#l7.439"></a><span id="l7.439"> </span>
<a href="#l7.440"></a><span id="l7.440">     pBufInOut.Adopt(pBuf);</span>
<a href="#l7.441"></a><span id="l7.441">   }</span>
<a href="#l7.442"></a><span id="l7.442"> }</span>
<a href="#l7.443"></a><span id="l7.443"> </span>
<a href="#l7.444"></a><span id="l7.444"> /**</span>
<a href="#l7.445"></a><span id="l7.445">  * Determines the MIME type, if present, from the current line.</span>
<a href="#l7.446"></a><span id="l7.446">  *</span>
<a href="#l7.447"></a><span id="l7.447">  * m_partIsHtml, m_isMultipart, m_partIsText, m_base64part, and boundary are</span>
<a href="#l7.448"></a><span id="l7.448">  * all set by this method at various points in time.</span>
<a href="#l7.449"></a><span id="l7.449">  *</span>
<a href="#l7.450"></a><span id="l7.450">  * @param line        (in)    a header line that may contain a MIME header</span>
<a href="#l7.451"></a><span id="l7.451">  */</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-void nsMsgBodyHandler::SniffPossibleMIMEHeader(const nsCString &amp;line)</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-{</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+void nsMsgBodyHandler::SniffPossibleMIMEHeader(const nsCString &amp;line) {</span>
<a href="#l7.455"></a><span id="l7.455">   // Some parts of MIME are case-sensitive and other parts are case-insensitive;</span>
<a href="#l7.456"></a><span id="l7.456">   // specifically, the headers are all case-insensitive and the values we care</span>
<a href="#l7.457"></a><span id="l7.457">   // about are also case-insensitive, with the sole exception of the boundary</span>
<a href="#l7.458"></a><span id="l7.458">   // string, so we can't just take the input line and make it lower case.</span>
<a href="#l7.459"></a><span id="l7.459">   nsCString lowerCaseLine(line);</span>
<a href="#l7.460"></a><span id="l7.460">   ToLowerCase(lowerCaseLine);</span>
<a href="#l7.461"></a><span id="l7.461"> </span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-  if (StringBeginsWith(lowerCaseLine, NS_LITERAL_CSTRING(&quot;content-transfer-encoding:&quot;)))</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-    m_partIsQP = lowerCaseLine.Find(&quot;quoted-printable&quot;, /* ignoreCase = */ true) != -1;</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+  if (StringBeginsWith(lowerCaseLine,</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;content-transfer-encoding:&quot;)))</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+    m_partIsQP =</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+        lowerCaseLine.Find(&quot;quoted-printable&quot;, /* ignoreCase = */ true) != -1;</span>
<a href="#l7.468"></a><span id="l7.468"> </span>
<a href="#l7.469"></a><span id="l7.469" class="difflineminus">-  if (StringBeginsWith(lowerCaseLine, NS_LITERAL_CSTRING(&quot;content-type:&quot;)))</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineminus">-  {</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-    if (lowerCaseLine.Find(&quot;text/html&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-    {</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+  if (StringBeginsWith(lowerCaseLine, NS_LITERAL_CSTRING(&quot;content-type:&quot;))) {</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+    if (lowerCaseLine.Find(&quot;text/html&quot;, /* ignoreCase = */ true) != -1) {</span>
<a href="#l7.475"></a><span id="l7.475">       m_partIsText = true;</span>
<a href="#l7.476"></a><span id="l7.476">       m_partIsHtml = true;</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-    }</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-    else if (lowerCaseLine.Find(&quot;multipart/&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-    {</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-      if (m_isMultipart)</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-      {</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+    } else if (lowerCaseLine.Find(&quot;multipart/&quot;, /* ignoreCase = */ true) !=</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+               -1) {</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+      if (m_isMultipart) {</span>
<a href="#l7.485"></a><span id="l7.485">         // Nested multipart, get ready for new headers.</span>
<a href="#l7.486"></a><span id="l7.486">         m_base64part = false;</span>
<a href="#l7.487"></a><span id="l7.487">         m_partIsQP = false;</span>
<a href="#l7.488"></a><span id="l7.488">         m_pastPartHeaders = false;</span>
<a href="#l7.489"></a><span id="l7.489">         m_partIsHtml = false;</span>
<a href="#l7.490"></a><span id="l7.490">         m_partIsText = false;</span>
<a href="#l7.491"></a><span id="l7.491">       }</span>
<a href="#l7.492"></a><span id="l7.492">       m_isMultipart = true;</span>
<a href="#l7.493"></a><span id="l7.493">       m_partCharset.Truncate();</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineminus">-    }</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-    else if (lowerCaseLine.Find(&quot;message/&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-    {</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+    } else if (lowerCaseLine.Find(&quot;message/&quot;, /* ignoreCase = */ true) != -1) {</span>
<a href="#l7.498"></a><span id="l7.498">       // Initialise again.</span>
<a href="#l7.499"></a><span id="l7.499">       m_base64part = false;</span>
<a href="#l7.500"></a><span id="l7.500">       m_partIsQP = false;</span>
<a href="#l7.501"></a><span id="l7.501">       m_pastPartHeaders = false;</span>
<a href="#l7.502"></a><span id="l7.502">       m_partIsHtml = false;</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-      m_partIsText = true;  // Default is text/plain, maybe proven otherwise later.</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+      m_partIsText =</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+          true;  // Default is text/plain, maybe proven otherwise later.</span>
<a href="#l7.506"></a><span id="l7.506">       m_inMessageAttachment = true;</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-    }</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-    else if (lowerCaseLine.Find(&quot;text/&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+    } else if (lowerCaseLine.Find(&quot;text/&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l7.510"></a><span id="l7.510">       m_partIsText = true;</span>
<a href="#l7.511"></a><span id="l7.511">     else if (lowerCaseLine.Find(&quot;text/&quot;, /* ignoreCase = */ true) == -1)</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-      m_partIsText = false; // We have disproven our assumption.</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+      m_partIsText = false;  // We have disproven our assumption.</span>
<a href="#l7.514"></a><span id="l7.514">   }</span>
<a href="#l7.515"></a><span id="l7.515"> </span>
<a href="#l7.516"></a><span id="l7.516">   int32_t start;</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-  if (m_isMultipart &amp;&amp;</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-      (start = lowerCaseLine.Find(&quot;boundary=&quot;, /* ignoreCase = */ true)) != -1)</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-  {</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+  if (m_isMultipart &amp;&amp; (start = lowerCaseLine.Find(</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+                            &quot;boundary=&quot;, /* ignoreCase = */ true)) != -1) {</span>
<a href="#l7.522"></a><span id="l7.522">     start += 9;  // strlen(&quot;boundary=&quot;)</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-    if (line[start] == '\&quot;')</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-      start++;</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+    if (line[start] == '\&quot;') start++;</span>
<a href="#l7.526"></a><span id="l7.526">     int32_t end = line.RFindChar('\&quot;');</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-    if (end == -1)</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-      end = line.Length();</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+    if (end == -1) end = line.Length();</span>
<a href="#l7.530"></a><span id="l7.530"> </span>
<a href="#l7.531"></a><span id="l7.531">     // Collect all boundaries. Since we only react to crossing a boundary,</span>
<a href="#l7.532"></a><span id="l7.532">     // we can simply collect the boundaries instead of forming a tree</span>
<a href="#l7.533"></a><span id="l7.533">     // structure from the message. Keep it simple ;-)</span>
<a href="#l7.534"></a><span id="l7.534">     nsCString boundary;</span>
<a href="#l7.535"></a><span id="l7.535">     boundary.AssignLiteral(&quot;--&quot;);</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineminus">-    boundary.Append(Substring(line, start, end-start));</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-    if (!m_boundaries.Contains(boundary))</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-      m_boundaries.AppendElement(boundary);</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+    boundary.Append(Substring(line, start, end - start));</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+    if (!m_boundaries.Contains(boundary)) m_boundaries.AppendElement(boundary);</span>
<a href="#l7.541"></a><span id="l7.541">   }</span>
<a href="#l7.542"></a><span id="l7.542"> </span>
<a href="#l7.543"></a><span id="l7.543">   if (m_isMultipart &amp;&amp;</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineminus">-      (start = lowerCaseLine.Find(&quot;charset=&quot;, /* ignoreCase = */ true)) != -1)</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-  {</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+      (start = lowerCaseLine.Find(&quot;charset=&quot;, /* ignoreCase = */ true)) != -1) {</span>
<a href="#l7.547"></a><span id="l7.547">     start += 8;  // strlen(&quot;charset=&quot;)</span>
<a href="#l7.548"></a><span id="l7.548">     bool foundQuote = false;</span>
<a href="#l7.549"></a><span id="l7.549">     if (line[start] == '\&quot;') {</span>
<a href="#l7.550"></a><span id="l7.550">       start++;</span>
<a href="#l7.551"></a><span id="l7.551">       foundQuote = true;</span>
<a href="#l7.552"></a><span id="l7.552">     }</span>
<a href="#l7.553"></a><span id="l7.553">     int32_t end = line.FindChar(foundQuote ? '\&quot;' : ';', start);</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-    if (end == -1)</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-      end = line.Length();</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+    if (end == -1) end = line.Length();</span>
<a href="#l7.557"></a><span id="l7.557"> </span>
<a href="#l7.558"></a><span id="l7.558" class="difflineminus">-    m_partCharset.Assign(Substring(line, start, end-start));</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+    m_partCharset.Assign(Substring(line, start, end - start));</span>
<a href="#l7.560"></a><span id="l7.560">   }</span>
<a href="#l7.561"></a><span id="l7.561"> </span>
<a href="#l7.562"></a><span id="l7.562">   if (StringBeginsWith(lowerCaseLine,</span>
<a href="#l7.563"></a><span id="l7.563">                        NS_LITERAL_CSTRING(&quot;content-transfer-encoding:&quot;)) &amp;&amp;</span>
<a href="#l7.564"></a><span id="l7.564">       lowerCaseLine.Find(ENCODING_BASE64, /* ignoreCase = */ true) != kNotFound)</span>
<a href="#l7.565"></a><span id="l7.565">     m_base64part = true;</span>
<a href="#l7.566"></a><span id="l7.566"> }</span>
<a href="#l7.567"></a><span id="l7.567"> </span>
<a href="#l7.568"></a><span id="l7.568"> /**</span>
<a href="#l7.569"></a><span id="l7.569">  * Decodes the given base64 string.</span>
<a href="#l7.570"></a><span id="l7.570">  *</span>
<a href="#l7.571"></a><span id="l7.571">  * It returns its decoded string in its input.</span>
<a href="#l7.572"></a><span id="l7.572">  *</span>
<a href="#l7.573"></a><span id="l7.573">  * @param pBufInOut   (inout) a buffer of the string</span>
<a href="#l7.574"></a><span id="l7.574">  */</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-void nsMsgBodyHandler::Base64Decode (nsCString &amp;pBufInOut)</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-{</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-  char *decodedBody = PL_Base64Decode(pBufInOut.get(), pBufInOut.Length(), nullptr);</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-  if (decodedBody)</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineminus">-    pBufInOut.Adopt(decodedBody);</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+void nsMsgBodyHandler::Base64Decode(nsCString &amp;pBufInOut) {</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+  char *decodedBody =</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+      PL_Base64Decode(pBufInOut.get(), pBufInOut.Length(), nullptr);</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+  if (decodedBody) pBufInOut.Adopt(decodedBody);</span>
<a href="#l7.584"></a><span id="l7.584"> </span>
<a href="#l7.585"></a><span id="l7.585">   int32_t offset = pBufInOut.FindChar('\n');</span>
<a href="#l7.586"></a><span id="l7.586">   while (offset != -1) {</span>
<a href="#l7.587"></a><span id="l7.587">     pBufInOut.Replace(offset, 1, ' ');</span>
<a href="#l7.588"></a><span id="l7.588">     offset = pBufInOut.FindChar('\n', offset);</span>
<a href="#l7.589"></a><span id="l7.589">   }</span>
<a href="#l7.590"></a><span id="l7.590">   offset = pBufInOut.FindChar('\r');</span>
<a href="#l7.591"></a><span id="l7.591">   while (offset != -1) {</span>
<a href="#l7.592"></a><span id="l7.592">     pBufInOut.Replace(offset, 1, ' ');</span>
<a href="#l7.593"></a><span id="l7.593">     offset = pBufInOut.FindChar('\r', offset);</span>
<a href="#l7.594"></a><span id="l7.594">   }</span>
<a href="#l7.595"></a><span id="l7.595"> }</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> // this file implements the nsMsgFilter interface</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsArray.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsMsgFilterList.h&quot;    // for kFileVersion</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+#include &quot;nsMsgFilterList.h&quot;  // for kFileVersion</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsMsgFilter.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsMsgLocalSearch.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsMsgSearchTerm.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsMsgSearchValue.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -28,243 +28,215 @@</span>
<a href="#l8.23"></a><span id="l8.23"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24"> #include &quot;prmem.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l8.26"></a><span id="l8.26"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> static const char *kImapPrefix = &quot;//imap:&quot;;</span>
<a href="#l8.29"></a><span id="l8.29"> static const char *kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-nsMsgRuleAction::nsMsgRuleAction()</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-{</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-}</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+nsMsgRuleAction::nsMsgRuleAction() {}</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-nsMsgRuleAction::~nsMsgRuleAction()</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-{</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-}</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+nsMsgRuleAction::~nsMsgRuleAction() {}</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41"> NS_IMPL_ISUPPORTS(nsMsgRuleAction, nsIMsgRuleAction)</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43"> NS_IMPL_GETSET(nsMsgRuleAction, Type, nsMsgRuleActionType, m_type)</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-NS_IMETHODIMP nsMsgRuleAction::SetPriority(nsMsgPriorityValue aPriority)</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-{</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::SetPriority(nsMsgPriorityValue aPriority) {</span>
<a href="#l8.48"></a><span id="l8.48">   NS_ENSURE_TRUE(m_type == nsMsgFilterAction::ChangePriority,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-                NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+                 NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.51"></a><span id="l8.51">   m_priority = aPriority;</span>
<a href="#l8.52"></a><span id="l8.52">   return NS_OK;</span>
<a href="#l8.53"></a><span id="l8.53"> }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55"> NS_IMETHODIMP</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-nsMsgRuleAction::GetPriority(nsMsgPriorityValue *aResult)</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-{</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+nsMsgRuleAction::GetPriority(nsMsgPriorityValue *aResult) {</span>
<a href="#l8.59"></a><span id="l8.59">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.60"></a><span id="l8.60">   NS_ENSURE_TRUE(m_type == nsMsgFilterAction::ChangePriority,</span>
<a href="#l8.61"></a><span id="l8.61">                  NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.62"></a><span id="l8.62">   *aResult = m_priority;</span>
<a href="#l8.63"></a><span id="l8.63">   return NS_OK;</span>
<a href="#l8.64"></a><span id="l8.64"> }</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66"> NS_IMETHODIMP</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-nsMsgRuleAction::SetLabel(nsMsgLabelValue aLabel)</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-{</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-  NS_ENSURE_TRUE(m_type == nsMsgFilterAction::Label,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-                 NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+nsMsgRuleAction::SetLabel(nsMsgLabelValue aLabel) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  NS_ENSURE_TRUE(m_type == nsMsgFilterAction::Label, NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.73"></a><span id="l8.73">   m_label = aLabel;</span>
<a href="#l8.74"></a><span id="l8.74">   return NS_OK;</span>
<a href="#l8.75"></a><span id="l8.75"> }</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77"> NS_IMETHODIMP</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-nsMsgRuleAction::GetLabel(nsMsgLabelValue *aResult)</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-{</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+nsMsgRuleAction::GetLabel(nsMsgLabelValue *aResult) {</span>
<a href="#l8.81"></a><span id="l8.81">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.82"></a><span id="l8.82">   NS_ENSURE_TRUE(m_type == nsMsgFilterAction::Label, NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.83"></a><span id="l8.83">   *aResult = m_label;</span>
<a href="#l8.84"></a><span id="l8.84">   return NS_OK;</span>
<a href="#l8.85"></a><span id="l8.85"> }</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87"> NS_IMETHODIMP</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-nsMsgRuleAction::SetTargetFolderUri(const nsACString &amp;aUri)</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-{</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+nsMsgRuleAction::SetTargetFolderUri(const nsACString &amp;aUri) {</span>
<a href="#l8.91"></a><span id="l8.91">   NS_ENSURE_TRUE(m_type == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-                 m_type == nsMsgFilterAction::CopyToFolder,</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+                     m_type == nsMsgFilterAction::CopyToFolder,</span>
<a href="#l8.94"></a><span id="l8.94">                  NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.95"></a><span id="l8.95">   m_folderUri = aUri;</span>
<a href="#l8.96"></a><span id="l8.96">   return NS_OK;</span>
<a href="#l8.97"></a><span id="l8.97"> }</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99"> NS_IMETHODIMP</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-nsMsgRuleAction::GetTargetFolderUri(nsACString &amp;aResult)</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-{</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+nsMsgRuleAction::GetTargetFolderUri(nsACString &amp;aResult) {</span>
<a href="#l8.103"></a><span id="l8.103">   NS_ENSURE_TRUE(m_type == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-                 m_type == nsMsgFilterAction::CopyToFolder,</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+                     m_type == nsMsgFilterAction::CopyToFolder,</span>
<a href="#l8.106"></a><span id="l8.106">                  NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.107"></a><span id="l8.107">   aResult = m_folderUri;</span>
<a href="#l8.108"></a><span id="l8.108">   return NS_OK;</span>
<a href="#l8.109"></a><span id="l8.109"> }</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111"> NS_IMETHODIMP</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-nsMsgRuleAction::SetJunkScore(int32_t aJunkScore)</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-{</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-  NS_ENSURE_TRUE(m_type == nsMsgFilterAction::JunkScore &amp;&amp; aJunkScore &gt;= 0 &amp;&amp; aJunkScore &lt;= 100,</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+nsMsgRuleAction::SetJunkScore(int32_t aJunkScore) {</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+  NS_ENSURE_TRUE(m_type == nsMsgFilterAction::JunkScore &amp;&amp; aJunkScore &gt;= 0 &amp;&amp;</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+                     aJunkScore &lt;= 100,</span>
<a href="#l8.118"></a><span id="l8.118">                  NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.119"></a><span id="l8.119">   m_junkScore = aJunkScore;</span>
<a href="#l8.120"></a><span id="l8.120">   return NS_OK;</span>
<a href="#l8.121"></a><span id="l8.121"> }</span>
<a href="#l8.122"></a><span id="l8.122"> </span>
<a href="#l8.123"></a><span id="l8.123"> NS_IMETHODIMP</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-nsMsgRuleAction::GetJunkScore(int32_t *aResult)</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-{</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+nsMsgRuleAction::GetJunkScore(int32_t *aResult) {</span>
<a href="#l8.127"></a><span id="l8.127">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  NS_ENSURE_TRUE(m_type == nsMsgFilterAction::JunkScore, NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  NS_ENSURE_TRUE(m_type == nsMsgFilterAction::JunkScore,</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+                 NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.131"></a><span id="l8.131">   *aResult = m_junkScore;</span>
<a href="#l8.132"></a><span id="l8.132">   return NS_OK;</span>
<a href="#l8.133"></a><span id="l8.133"> }</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135"> NS_IMETHODIMP</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-nsMsgRuleAction::SetStrValue(const nsACString &amp;aStrValue)</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-{</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+nsMsgRuleAction::SetStrValue(const nsACString &amp;aStrValue) {</span>
<a href="#l8.139"></a><span id="l8.139">   m_strValue = aStrValue;</span>
<a href="#l8.140"></a><span id="l8.140">   return NS_OK;</span>
<a href="#l8.141"></a><span id="l8.141"> }</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143"> NS_IMETHODIMP</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-nsMsgRuleAction::GetStrValue(nsACString &amp;aStrValue)</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-{</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+nsMsgRuleAction::GetStrValue(nsACString &amp;aStrValue) {</span>
<a href="#l8.147"></a><span id="l8.147">   aStrValue = m_strValue;</span>
<a href="#l8.148"></a><span id="l8.148">   return NS_OK;</span>
<a href="#l8.149"></a><span id="l8.149"> }</span>
<a href="#l8.150"></a><span id="l8.150"> </span>
<a href="#l8.151"></a><span id="l8.151"> /* attribute ACString customId; */</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-NS_IMETHODIMP nsMsgRuleAction::GetCustomId(nsACString &amp; aCustomId)</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-{</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::GetCustomId(nsACString &amp;aCustomId) {</span>
<a href="#l8.155"></a><span id="l8.155">   aCustomId = m_customId;</span>
<a href="#l8.156"></a><span id="l8.156">   return NS_OK;</span>
<a href="#l8.157"></a><span id="l8.157"> }</span>
<a href="#l8.158"></a><span id="l8.158"> </span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-NS_IMETHODIMP nsMsgRuleAction::SetCustomId(const nsACString &amp; aCustomId)</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-{</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::SetCustomId(const nsACString &amp;aCustomId) {</span>
<a href="#l8.162"></a><span id="l8.162">   m_customId = aCustomId;</span>
<a href="#l8.163"></a><span id="l8.163">   return NS_OK;</span>
<a href="#l8.164"></a><span id="l8.164"> }</span>
<a href="#l8.165"></a><span id="l8.165"> </span>
<a href="#l8.166"></a><span id="l8.166"> // this can only be called after the customId is set</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-NS_IMETHODIMP nsMsgRuleAction::GetCustomAction(nsIMsgFilterCustomAction **aCustomAction)</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-{</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+NS_IMETHODIMP nsMsgRuleAction::GetCustomAction(</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    nsIMsgFilterCustomAction **aCustomAction) {</span>
<a href="#l8.171"></a><span id="l8.171">   NS_ENSURE_ARG_POINTER(aCustomAction);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-  if (!m_customAction)</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-  {</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-    if (m_customId.IsEmpty())</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-      return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  if (!m_customAction) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    if (m_customId.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.178"></a><span id="l8.178">     nsresult rv;</span>
<a href="#l8.179"></a><span id="l8.179">     nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l8.180"></a><span id="l8.180">         do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.181"></a><span id="l8.181">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.182"></a><span id="l8.182"> </span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-    rv = filterService-&gt;GetCustomAction(m_customId, getter_AddRefs(m_customAction));</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    rv = filterService-&gt;GetCustomAction(m_customId,</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+                                        getter_AddRefs(m_customAction));</span>
<a href="#l8.186"></a><span id="l8.186">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.187"></a><span id="l8.187">   }</span>
<a href="#l8.188"></a><span id="l8.188"> </span>
<a href="#l8.189"></a><span id="l8.189">   // found the correct custom action</span>
<a href="#l8.190"></a><span id="l8.190">   NS_ADDREF(*aCustomAction = m_customAction);</span>
<a href="#l8.191"></a><span id="l8.191">   return NS_OK;</span>
<a href="#l8.192"></a><span id="l8.192"> }</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-nsMsgFilter::nsMsgFilter():</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-    m_temporary(false),</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-    m_unparseable(false),</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-    m_filterList(nullptr),</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-    m_expressionTree(nullptr)</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-{</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+nsMsgFilter::nsMsgFilter()</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    : m_temporary(false),</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+      m_unparseable(false),</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+      m_filterList(nullptr),</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      m_expressionTree(nullptr) {</span>
<a href="#l8.205"></a><span id="l8.205">   m_termList = nsArray::Create();</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-  NS_ASSERTION(m_termList, &quot;Failed to allocate a nsIMutableArray for m_termList&quot;);</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  NS_ASSERTION(m_termList,</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+               &quot;Failed to allocate a nsIMutableArray for m_termList&quot;);</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">   m_type = nsMsgFilterType::InboxRule | nsMsgFilterType::Manual;</span>
<a href="#l8.211"></a><span id="l8.211"> }</span>
<a href="#l8.212"></a><span id="l8.212"> </span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-nsMsgFilter::~nsMsgFilter()</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-{</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-  delete m_expressionTree;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-}</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+nsMsgFilter::~nsMsgFilter() { delete m_expressionTree; }</span>
<a href="#l8.218"></a><span id="l8.218"> </span>
<a href="#l8.219"></a><span id="l8.219"> NS_IMPL_ISUPPORTS(nsMsgFilter, nsIMsgFilter)</span>
<a href="#l8.220"></a><span id="l8.220"> </span>
<a href="#l8.221"></a><span id="l8.221"> NS_IMPL_GETSET(nsMsgFilter, FilterType, nsMsgFilterTypeType, m_type)</span>
<a href="#l8.222"></a><span id="l8.222"> NS_IMPL_GETSET(nsMsgFilter, Enabled, bool, m_enabled)</span>
<a href="#l8.223"></a><span id="l8.223"> NS_IMPL_GETSET(nsMsgFilter, Temporary, bool, m_temporary)</span>
<a href="#l8.224"></a><span id="l8.224"> NS_IMPL_GETSET(nsMsgFilter, Unparseable, bool, m_unparseable)</span>
<a href="#l8.225"></a><span id="l8.225"> </span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::GetFilterName(nsAString &amp;name)</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-{</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::GetFilterName(nsAString &amp;name) {</span>
<a href="#l8.229"></a><span id="l8.229">   name = m_filterName;</span>
<a href="#l8.230"></a><span id="l8.230">   return NS_OK;</span>
<a href="#l8.231"></a><span id="l8.231"> }</span>
<a href="#l8.232"></a><span id="l8.232"> </span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::SetFilterName(const nsAString &amp;name)</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-{</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::SetFilterName(const nsAString &amp;name) {</span>
<a href="#l8.236"></a><span id="l8.236">   m_filterName.Assign(name);</span>
<a href="#l8.237"></a><span id="l8.237">   return NS_OK;</span>
<a href="#l8.238"></a><span id="l8.238"> }</span>
<a href="#l8.239"></a><span id="l8.239"> </span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::GetFilterDesc(nsACString &amp;description)</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-{</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::GetFilterDesc(nsACString &amp;description) {</span>
<a href="#l8.243"></a><span id="l8.243">   description = m_description;</span>
<a href="#l8.244"></a><span id="l8.244">   return NS_OK;</span>
<a href="#l8.245"></a><span id="l8.245"> }</span>
<a href="#l8.246"></a><span id="l8.246"> </span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::SetFilterDesc(const nsACString &amp;description)</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-{</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::SetFilterDesc(const nsACString &amp;description) {</span>
<a href="#l8.250"></a><span id="l8.250">   m_description.Assign(description);</span>
<a href="#l8.251"></a><span id="l8.251">   return NS_OK;</span>
<a href="#l8.252"></a><span id="l8.252"> }</span>
<a href="#l8.253"></a><span id="l8.253"> </span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::GetUnparsedBuffer(nsACString &amp;unparsedBuffer)</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-{</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::GetUnparsedBuffer(nsACString &amp;unparsedBuffer) {</span>
<a href="#l8.257"></a><span id="l8.257">   unparsedBuffer = m_unparsedBuffer;</span>
<a href="#l8.258"></a><span id="l8.258">   return NS_OK;</span>
<a href="#l8.259"></a><span id="l8.259"> }</span>
<a href="#l8.260"></a><span id="l8.260"> </span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::SetUnparsedBuffer(const nsACString &amp;unparsedBuffer)</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-{</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::SetUnparsedBuffer(const nsACString &amp;unparsedBuffer) {</span>
<a href="#l8.264"></a><span id="l8.264">   m_unparsedBuffer.Assign(unparsedBuffer);</span>
<a href="#l8.265"></a><span id="l8.265">   return NS_OK;</span>
<a href="#l8.266"></a><span id="l8.266"> }</span>
<a href="#l8.267"></a><span id="l8.267"> </span>
<a href="#l8.268"></a><span id="l8.268"> NS_IMETHODIMP nsMsgFilter::AddTerm(</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-                                   nsMsgSearchAttribValue attrib,    /* attribute for this term          */</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-                                   nsMsgSearchOpValue op,         /* operator e.g. opContains           */</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-                                   nsIMsgSearchValue *value,        /* value e.g. &quot;Dogbert&quot;               */</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-                                  bool BooleanAND,       /* true if AND is the boolean operator.</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-                                                            false if OR is the boolean operators */</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-                                  const nsACString &amp; arbitraryHeader)  /* arbitrary header specified by user.</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-                                  ignored unless attrib = attribOtherHeader */</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+    nsMsgSearchAttribValue attrib,     /* attribute for this term          */</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+    nsMsgSearchOpValue op,             /* operator e.g. opContains           */</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+    nsIMsgSearchValue *value,          /* value e.g. &quot;Dogbert&quot;               */</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    bool BooleanAND,                   /* true if AND is the boolean operator.</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+                                          false if OR is the boolean operators */</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+    const nsACString &amp;arbitraryHeader) /* arbitrary header specified by user.</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+  ignored unless attrib = attribOtherHeader */</span>
<a href="#l8.283"></a><span id="l8.283"> {</span>
<a href="#l8.284"></a><span id="l8.284">   return NS_OK;</span>
<a href="#l8.285"></a><span id="l8.285"> }</span>
<a href="#l8.286"></a><span id="l8.286"> </span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::AppendTerm(nsIMsgSearchTerm * aTerm)</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-{</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-    NS_ENSURE_TRUE(aTerm, NS_ERROR_NULL_POINTER);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-    // invalidate expression tree if we're changing the terms</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-    delete m_expressionTree;</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-    m_expressionTree = nullptr;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-    return m_termList-&gt;AppendElement(aTerm);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::AppendTerm(nsIMsgSearchTerm *aTerm) {</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  NS_ENSURE_TRUE(aTerm, NS_ERROR_NULL_POINTER);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+  // invalidate expression tree if we're changing the terms</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+  delete m_expressionTree;</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+  m_expressionTree = nullptr;</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  return m_termList-&gt;AppendElement(aTerm);</span>
<a href="#l8.300"></a><span id="l8.300"> }</span>
<a href="#l8.301"></a><span id="l8.301"> </span>
<a href="#l8.302"></a><span id="l8.302"> NS_IMETHODIMP</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-nsMsgFilter::CreateTerm(nsIMsgSearchTerm **aResult)</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-{</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-    NS_ADDREF(*aResult = new nsMsgSearchTerm);</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+nsMsgFilter::CreateTerm(nsIMsgSearchTerm **aResult) {</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+  NS_ADDREF(*aResult = new nsMsgSearchTerm);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.312"></a><span id="l8.312"> }</span>
<a href="#l8.313"></a><span id="l8.313"> </span>
<a href="#l8.314"></a><span id="l8.314"> NS_IMETHODIMP</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-nsMsgFilter::CreateAction(nsIMsgRuleAction **aAction)</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-{</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+nsMsgFilter::CreateAction(nsIMsgRuleAction **aAction) {</span>
<a href="#l8.318"></a><span id="l8.318">   NS_ENSURE_ARG_POINTER(aAction);</span>
<a href="#l8.319"></a><span id="l8.319">   NS_ADDREF(*aAction = new nsMsgRuleAction);</span>
<a href="#l8.320"></a><span id="l8.320">   return NS_OK;</span>
<a href="#l8.321"></a><span id="l8.321"> }</span>
<a href="#l8.322"></a><span id="l8.322"> </span>
<a href="#l8.323"></a><span id="l8.323"> // All the rules' actions form a unit, with no real order imposed.</span>
<a href="#l8.324"></a><span id="l8.324"> // But certain actions like MoveToFolder or StopExecution would make us drop</span>
<a href="#l8.325"></a><span id="l8.325"> // consecutive actions, while actions like AddTag implicitly care about the</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineat">@@ -278,196 +250,178 @@ nsMsgFilter::CreateAction(nsIMsgRuleActi</span>
<a href="#l8.327"></a><span id="l8.327"> //   index    action(s)</span>
<a href="#l8.328"></a><span id="l8.328"> //  -------   ---------</span>
<a href="#l8.329"></a><span id="l8.329"> //     0      FetchBodyFromPop3Server</span>
<a href="#l8.330"></a><span id="l8.330"> //    1..n    all other 'normal' actions, in their original order</span>
<a href="#l8.331"></a><span id="l8.331"> //  n+1..m    CopyToFolder</span>
<a href="#l8.332"></a><span id="l8.332"> //    m+1     MoveToFolder or Delete</span>
<a href="#l8.333"></a><span id="l8.333"> //    m+2     StopExecution</span>
<a href="#l8.334"></a><span id="l8.334"> NS_IMETHODIMP</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-nsMsgFilter::GetSortedActionList(nsIArray **aActionList)</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-{</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+nsMsgFilter::GetSortedActionList(nsIArray **aActionList) {</span>
<a href="#l8.338"></a><span id="l8.338">   NS_ENSURE_ARG_POINTER(aActionList);</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340">   uint32_t numActions;</span>
<a href="#l8.341"></a><span id="l8.341">   nsresult rv = GetActionCount(&amp;numActions);</span>
<a href="#l8.342"></a><span id="l8.342">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.343"></a><span id="l8.343"> </span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; orderedActions(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; orderedActions(</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l8.347"></a><span id="l8.347">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.348"></a><span id="l8.348"> </span>
<a href="#l8.349"></a><span id="l8.349">   // hold separate pointers into the action list</span>
<a href="#l8.350"></a><span id="l8.350">   uint32_t nextIndexForNormal = 0, nextIndexForCopy = 0, nextIndexForMove = 0;</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-  for (uint32_t index = 0; index &lt; numActions; ++index)</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-  {</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+  for (uint32_t index = 0; index &lt; numActions; ++index) {</span>
<a href="#l8.354"></a><span id="l8.354">     nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l8.355"></a><span id="l8.355">     rv = GetActionAt(index, getter_AddRefs(action));</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-    if (NS_FAILED(rv) || !action)</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-      continue;</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    if (NS_FAILED(rv) || !action) continue;</span>
<a href="#l8.359"></a><span id="l8.359"> </span>
<a href="#l8.360"></a><span id="l8.360">     nsMsgRuleActionType actionType;</span>
<a href="#l8.361"></a><span id="l8.361">     action-&gt;GetType(&amp;actionType);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-    switch (actionType)</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-    {</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-      case nsMsgFilterAction::FetchBodyFromPop3Server:</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-      {</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+    switch (actionType) {</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+      case nsMsgFilterAction::FetchBodyFromPop3Server: {</span>
<a href="#l8.368"></a><span id="l8.368">         // always insert in front</span>
<a href="#l8.369"></a><span id="l8.369">         rv = orderedActions-&gt;InsertElementAt(action, 0);</span>
<a href="#l8.370"></a><span id="l8.370">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.371"></a><span id="l8.371">         ++nextIndexForNormal;</span>
<a href="#l8.372"></a><span id="l8.372">         ++nextIndexForCopy;</span>
<a href="#l8.373"></a><span id="l8.373">         ++nextIndexForMove;</span>
<a href="#l8.374"></a><span id="l8.374">         break;</span>
<a href="#l8.375"></a><span id="l8.375">       }</span>
<a href="#l8.376"></a><span id="l8.376"> </span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-      case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-      {</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+      case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l8.380"></a><span id="l8.380">         // insert into copy actions block, in order of appearance</span>
<a href="#l8.381"></a><span id="l8.381">         rv = orderedActions-&gt;InsertElementAt(action, nextIndexForCopy);</span>
<a href="#l8.382"></a><span id="l8.382">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.383"></a><span id="l8.383">         ++nextIndexForCopy;</span>
<a href="#l8.384"></a><span id="l8.384">         ++nextIndexForMove;</span>
<a href="#l8.385"></a><span id="l8.385">         break;</span>
<a href="#l8.386"></a><span id="l8.386">       }</span>
<a href="#l8.387"></a><span id="l8.387"> </span>
<a href="#l8.388"></a><span id="l8.388">       case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-      case nsMsgFilterAction::Delete:</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-      {</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+      case nsMsgFilterAction::Delete: {</span>
<a href="#l8.392"></a><span id="l8.392">         // insert into move/delete action block</span>
<a href="#l8.393"></a><span id="l8.393">         rv = orderedActions-&gt;InsertElementAt(action, nextIndexForMove);</span>
<a href="#l8.394"></a><span id="l8.394">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.395"></a><span id="l8.395">         ++nextIndexForMove;</span>
<a href="#l8.396"></a><span id="l8.396">         break;</span>
<a href="#l8.397"></a><span id="l8.397">       }</span>
<a href="#l8.398"></a><span id="l8.398"> </span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-      case nsMsgFilterAction::StopExecution:</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-      {</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+      case nsMsgFilterAction::StopExecution: {</span>
<a href="#l8.402"></a><span id="l8.402">         // insert into stop action block</span>
<a href="#l8.403"></a><span id="l8.403">         rv = orderedActions-&gt;AppendElement(action);</span>
<a href="#l8.404"></a><span id="l8.404">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.405"></a><span id="l8.405">         break;</span>
<a href="#l8.406"></a><span id="l8.406">       }</span>
<a href="#l8.407"></a><span id="l8.407"> </span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-      default:</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-      {</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+      default: {</span>
<a href="#l8.411"></a><span id="l8.411">         // insert into normal action block, in order of appearance</span>
<a href="#l8.412"></a><span id="l8.412">         rv = orderedActions-&gt;InsertElementAt(action, nextIndexForNormal);</span>
<a href="#l8.413"></a><span id="l8.413">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.414"></a><span id="l8.414">         ++nextIndexForNormal;</span>
<a href="#l8.415"></a><span id="l8.415">         ++nextIndexForCopy;</span>
<a href="#l8.416"></a><span id="l8.416">         ++nextIndexForMove;</span>
<a href="#l8.417"></a><span id="l8.417">         break;</span>
<a href="#l8.418"></a><span id="l8.418">       }</span>
<a href="#l8.419"></a><span id="l8.419">     }</span>
<a href="#l8.420"></a><span id="l8.420">   }</span>
<a href="#l8.421"></a><span id="l8.421"> </span>
<a href="#l8.422"></a><span id="l8.422">   orderedActions.forget(aActionList);</span>
<a href="#l8.423"></a><span id="l8.423">   return NS_OK;</span>
<a href="#l8.424"></a><span id="l8.424"> }</span>
<a href="#l8.425"></a><span id="l8.425"> </span>
<a href="#l8.426"></a><span id="l8.426"> NS_IMETHODIMP</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-nsMsgFilter::AppendAction(nsIMsgRuleAction *aAction)</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-{</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+nsMsgFilter::AppendAction(nsIMsgRuleAction *aAction) {</span>
<a href="#l8.430"></a><span id="l8.430">   NS_ENSURE_ARG_POINTER(aAction);</span>
<a href="#l8.431"></a><span id="l8.431"> </span>
<a href="#l8.432"></a><span id="l8.432">   m_actionList.AppendElement(aAction);</span>
<a href="#l8.433"></a><span id="l8.433">   return NS_OK;</span>
<a href="#l8.434"></a><span id="l8.434"> }</span>
<a href="#l8.435"></a><span id="l8.435"> </span>
<a href="#l8.436"></a><span id="l8.436"> NS_IMETHODIMP</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-nsMsgFilter::GetActionAt(uint32_t aIndex, nsIMsgRuleAction **aAction)</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-{</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+nsMsgFilter::GetActionAt(uint32_t aIndex, nsIMsgRuleAction **aAction) {</span>
<a href="#l8.440"></a><span id="l8.440">   NS_ENSURE_ARG_POINTER(aAction);</span>
<a href="#l8.441"></a><span id="l8.441">   NS_ENSURE_ARG(aIndex &lt; m_actionList.Length());</span>
<a href="#l8.442"></a><span id="l8.442"> </span>
<a href="#l8.443"></a><span id="l8.443">   NS_ENSURE_TRUE(m_actionList[aIndex], NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l8.444"></a><span id="l8.444">   NS_IF_ADDREF(*aAction = m_actionList[aIndex]);</span>
<a href="#l8.445"></a><span id="l8.445">   return NS_OK;</span>
<a href="#l8.446"></a><span id="l8.446"> }</span>
<a href="#l8.447"></a><span id="l8.447"> </span>
<a href="#l8.448"></a><span id="l8.448"> NS_IMETHODIMP</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-nsMsgFilter::GetActionIndex(nsIMsgRuleAction *aAction, int32_t *aIndex)</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-{</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+nsMsgFilter::GetActionIndex(nsIMsgRuleAction *aAction, int32_t *aIndex) {</span>
<a href="#l8.452"></a><span id="l8.452">   NS_ENSURE_ARG_POINTER(aIndex);</span>
<a href="#l8.453"></a><span id="l8.453"> </span>
<a href="#l8.454"></a><span id="l8.454">   *aIndex = m_actionList.IndexOf(aAction);</span>
<a href="#l8.455"></a><span id="l8.455">   return NS_OK;</span>
<a href="#l8.456"></a><span id="l8.456"> }</span>
<a href="#l8.457"></a><span id="l8.457"> </span>
<a href="#l8.458"></a><span id="l8.458"> NS_IMETHODIMP</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-nsMsgFilter::GetActionCount(uint32_t *aCount)</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-{</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+nsMsgFilter::GetActionCount(uint32_t *aCount) {</span>
<a href="#l8.462"></a><span id="l8.462">   NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l8.463"></a><span id="l8.463"> </span>
<a href="#l8.464"></a><span id="l8.464">   *aCount = m_actionList.Length();</span>
<a href="#l8.465"></a><span id="l8.465">   return NS_OK;</span>
<a href="#l8.466"></a><span id="l8.466"> }</span>
<a href="#l8.467"></a><span id="l8.467"> </span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-NS_IMETHODIMP  //for editing a filter</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-nsMsgFilter::ClearActionList()</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-{</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+NS_IMETHODIMP  // for editing a filter</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+nsMsgFilter::ClearActionList() {</span>
<a href="#l8.473"></a><span id="l8.473">   m_actionList.Clear();</span>
<a href="#l8.474"></a><span id="l8.474">   return NS_OK;</span>
<a href="#l8.475"></a><span id="l8.475"> }</span>
<a href="#l8.476"></a><span id="l8.476"> </span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::GetTerm(int32_t termIndex,</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-                                   nsMsgSearchAttribValue *attrib,    /* attribute for this term          */</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-                                   nsMsgSearchOpValue *op,         /* operator e.g. opContains           */</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-                                   nsIMsgSearchValue **value,         /* value e.g. &quot;Dogbert&quot;               */</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-                                   bool *booleanAnd, /* true if AND is the boolean operator. false if OR is the boolean operator */</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-                                   nsACString &amp;arbitraryHeader) /* arbitrary header specified by user.ignore unless attrib = attribOtherHeader */</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::GetTerm(</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+    int32_t termIndex,</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+    nsMsgSearchAttribValue *attrib, /* attribute for this term          */</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+    nsMsgSearchOpValue *op,         /* operator e.g. opContains           */</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+    nsIMsgSearchValue **value,      /* value e.g. &quot;Dogbert&quot;               */</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+    bool *booleanAnd, /* true if AND is the boolean operator. false if OR is the</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+                         boolean operator */</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+    nsACString &amp;arbitraryHeader) /* arbitrary header specified by user.ignore</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+                                    unless attrib = attribOtherHeader */</span>
<a href="#l8.492"></a><span id="l8.492"> {</span>
<a href="#l8.493"></a><span id="l8.493">   nsresult rv;</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchTerm&gt; term = do_QueryElementAt(m_termList, termIndex, &amp;rv);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; term)</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-  {</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-    if (attrib)</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-      term-&gt;GetAttrib(attrib);</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-    if (op)</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-      term-&gt;GetOp(op);</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-    if (value)</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-      term-&gt;GetValue(value);</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-    if (booleanAnd)</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-      term-&gt;GetBooleanAnd(booleanAnd);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-    if (attrib &amp;&amp; *attrib &gt; nsMsgSearchAttrib::OtherHeader</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-        &amp;&amp; *attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchTerm&gt; term =</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+      do_QueryElementAt(m_termList, termIndex, &amp;rv);</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; term) {</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+    if (attrib) term-&gt;GetAttrib(attrib);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+    if (op) term-&gt;GetOp(op);</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+    if (value) term-&gt;GetValue(value);</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+    if (booleanAnd) term-&gt;GetBooleanAnd(booleanAnd);</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+    if (attrib &amp;&amp; *attrib &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+        *attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l8.516"></a><span id="l8.516">       term-&gt;GetArbitraryHeader(arbitraryHeader);</span>
<a href="#l8.517"></a><span id="l8.517">   }</span>
<a href="#l8.518"></a><span id="l8.518">   return NS_OK;</span>
<a href="#l8.519"></a><span id="l8.519"> }</span>
<a href="#l8.520"></a><span id="l8.520"> </span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::GetSearchTerms(nsIMutableArray **aResult)</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-{</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-    // caller can change m_termList, which can invalidate m_expressionTree.</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-    delete m_expressionTree;</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-    m_expressionTree = nullptr;</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-    NS_IF_ADDREF(*aResult = m_termList);</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::GetSearchTerms(nsIMutableArray **aResult) {</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+  // caller can change m_termList, which can invalidate m_expressionTree.</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+  delete m_expressionTree;</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+  m_expressionTree = nullptr;</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+  NS_IF_ADDREF(*aResult = m_termList);</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.536"></a><span id="l8.536"> }</span>
<a href="#l8.537"></a><span id="l8.537"> </span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::SetSearchTerms(nsIMutableArray *aSearchList)</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-{</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-    delete m_expressionTree;</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-    m_expressionTree = nullptr;</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-    m_termList = aSearchList;</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::SetSearchTerms(nsIMutableArray *aSearchList) {</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+  delete m_expressionTree;</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+  m_expressionTree = nullptr;</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+  m_termList = aSearchList;</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.549"></a><span id="l8.549"> }</span>
<a href="#l8.550"></a><span id="l8.550"> </span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::SetScope(nsIMsgSearchScopeTerm *aResult)</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-{</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-    m_scope = aResult;</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::SetScope(nsIMsgSearchScopeTerm *aResult) {</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+  m_scope = aResult;</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.558"></a><span id="l8.558"> }</span>
<a href="#l8.559"></a><span id="l8.559"> </span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-NS_IMETHODIMP nsMsgFilter::GetScope(nsIMsgSearchScopeTerm **aResult)</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-{</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-    NS_IF_ADDREF(*aResult = m_scope);</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+NS_IMETHODIMP nsMsgFilter::GetScope(nsIMsgSearchScopeTerm **aResult) {</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+  NS_IF_ADDREF(*aResult = m_scope);</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.569"></a><span id="l8.569"> }</span>
<a href="#l8.570"></a><span id="l8.570"> </span>
<a href="#l8.571"></a><span id="l8.571"> // This function handles the logging both for success of filtering</span>
<a href="#l8.572"></a><span id="l8.572"> // (NS_SUCCEEDED(aRcode)), and for error reporting (NS_FAILED(aRcode)</span>
<a href="#l8.573"></a><span id="l8.573"> // when the filter action (such as file move/copy) failed.</span>
<a href="#l8.574"></a><span id="l8.574"> //</span>
<a href="#l8.575"></a><span id="l8.575"> // @param aRcode  NS_OK for successful filtering</span>
<a href="#l8.576"></a><span id="l8.576"> //                operation, otherwise, an error code for filtering failure.</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineat">@@ -484,508 +438,468 @@ NS_IMETHODIMP nsMsgFilter::GetScope(nsIM</span>
<a href="#l8.578"></a><span id="l8.578"> // move/copy failures are taken care of.</span>
<a href="#l8.579"></a><span id="l8.579"> //</span>
<a href="#l8.580"></a><span id="l8.580"> // XXX Possible Improvement: For error case reporting, someone might</span>
<a href="#l8.581"></a><span id="l8.581"> // want to implement a transient message that appears and stick until</span>
<a href="#l8.582"></a><span id="l8.582"> // the user clears in the message status bar, etc. For now, we log an</span>
<a href="#l8.583"></a><span id="l8.583"> // error in a similar form as a conventional successful filter event</span>
<a href="#l8.584"></a><span id="l8.584"> // with additional error information at the beginning.</span>
<a href="#l8.585"></a><span id="l8.585"> //</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineminus">-nsresult</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-nsMsgFilter::LogRuleHitGeneric(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-                               nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-                               nsresult aRcode,</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-                               const nsACString &amp;aErrmsg)</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-{</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aFilterAction);</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+nsresult nsMsgFilter::LogRuleHitGeneric(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+                                        nsIMsgDBHdr *aMsgHdr, nsresult aRcode,</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+                                        const nsACString &amp;aErrmsg) {</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFilterAction);</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+  NS_ENSURE_TRUE(m_filterList, NS_OK);</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+  PRTime date;</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+  nsMsgRuleActionType actionType;</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+  nsString authorValue;</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+  nsString subjectValue;</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+  nsString filterName;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+  nsString dateValue;</span>
<a href="#l8.609"></a><span id="l8.609"> </span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-    NS_ENSURE_TRUE(m_filterList, NS_OK);</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+  GetFilterName(filterName);</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+  aFilterAction-&gt;GetType(&amp;actionType);</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+  (void)aMsgHdr-&gt;GetDate(&amp;date);</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+  PRExplodedTime exploded;</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+  PR_ExplodeTime(date, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l8.616"></a><span id="l8.616"> </span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-    PRTime date;</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-    nsMsgRuleActionType actionType;</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+  mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+                                                mozilla::kTimeFormatSeconds,</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+                                                &amp;exploded, dateValue);</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+  (void)aMsgHdr-&gt;GetMime2DecodedAuthor(authorValue);</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+  (void)aMsgHdr-&gt;GetMime2DecodedSubject(subjectValue);</span>
<a href="#l8.625"></a><span id="l8.625"> </span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-    nsString authorValue;</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-    nsString subjectValue;</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-    nsString filterName;</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-    nsString dateValue;</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+  nsString buffer;</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+  // this is big enough to hold a log entry.</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+  // do this so we avoid growing and copying as we append to the log.</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+  buffer.SetCapacity(512);</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+  nsresult rv = bundleService-&gt;CreateBundle(</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+      &quot;chrome://messenger/locale/filter.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.643"></a><span id="l8.643"> </span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-    GetFilterName(filterName);</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-    aFilterAction-&gt;GetType(&amp;actionType);</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-    (void)aMsgHdr-&gt;GetDate(&amp;date);</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-    PRExplodedTime exploded;</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-    PR_ExplodeTime(date, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+  // If error, prefix with the error code and error message.</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+  // A desired wording (without NEWLINEs):</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+  // Filter Action Failed &quot;Move failed&quot; with error code=0x80004005</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+  // while attempting: Applied filter &quot;test&quot; to message from</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+  // Some Test &lt;test@example.com&gt; - send test 3 at 2/13/2015 11:32:53 AM</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+  // moved message id = 54DE5165.7000907@example.com to</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+  // mailbox://nobody@Local%20Folders/test</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+  if (NS_FAILED(aRcode)) {</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+    // Convert aErrmsg to UTF16 string, and</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+    // convert aRcode to UTF16 string in advance.</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+    char tcode[20];</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+    PR_snprintf(tcode, sizeof(tcode), &quot;0x%08x&quot;, aRcode);</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+    NS_ConvertASCIItoUTF16 tcode16(tcode);</span>
<a href="#l8.662"></a><span id="l8.662"> </span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-    mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-                                                  mozilla::kTimeFormatSeconds,</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-                                                  &amp;exploded,</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineminus">-                                                  dateValue);</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+    nsString tErrmsg;</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+    if (actionType != nsMsgFilterAction::Custom) {</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+      // If this is one of our internal actions, the passed string</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+      // is an identifier to get from the bundle.</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+      rv =</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+          bundle-&gt;GetStringFromName(PromiseFlatCString(aErrmsg).get(), tErrmsg);</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+      if (NS_FAILED(rv)) tErrmsg.Assign(NS_ConvertUTF8toUTF16(aErrmsg));</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+    } else {</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+      // The addon creating the custom action should have passed a localized</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+      // string.</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+      tErrmsg.Assign(NS_ConvertUTF8toUTF16(aErrmsg));</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+    }</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+    const char16_t *logErrorFormatStrings[2] = {tErrmsg.get(), tcode16.get()};</span>
<a href="#l8.680"></a><span id="l8.680"> </span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-    (void)aMsgHdr-&gt;GetMime2DecodedAuthor(authorValue);</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-    (void)aMsgHdr-&gt;GetMime2DecodedSubject(subjectValue);</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+    nsString filterFailureWarningPrefix;</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;filterFailureWarningPrefix&quot;,</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+                                      logErrorFormatStrings, 2,</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+                                      filterFailureWarningPrefix);</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+    buffer += filterFailureWarningPrefix;</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+    buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+  }</span>
<a href="#l8.691"></a><span id="l8.691"> </span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-    nsString buffer;</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-    // this is big enough to hold a log entry.</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-    // do this so we avoid growing and copying as we append to the log.</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-    buffer.SetCapacity(512);</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+  const char16_t *filterLogDetectFormatStrings[4] = {</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+      filterName.get(), authorValue.get(), subjectValue.get(), dateValue.get()};</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+  nsString filterLogDetectStr;</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(&quot;filterLogDetectStr&quot;,</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+                                    filterLogDetectFormatStrings, 4,</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+                                    filterLogDetectStr);</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.703"></a><span id="l8.703"> </span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+  buffer += filterLogDetectStr;</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+  buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+  if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+      actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+    nsCString actionFolderUri;</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+    aFilterAction-&gt;GetTargetFolderUri(actionFolderUri);</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+    NS_ConvertASCIItoUTF16 actionFolderUriValue(actionFolderUri);</span>
<a href="#l8.715"></a><span id="l8.715"> </span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-    nsresult rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-      getter_AddRefs(bundle));</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+    nsCString msgId;</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+    aMsgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+    NS_ConvertASCIItoUTF16 msgIdValue(msgId);</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+    const char16_t *logMoveFormatStrings[2] = {msgIdValue.get(),</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+                                               actionFolderUriValue.get()};</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+    nsString logMoveStr;</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+        (actionType == nsMsgFilterAction::MoveToFolder) ? &quot;logMoveStr&quot;</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+                                                        : &quot;logCopyStr&quot;,</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+        logMoveFormatStrings, 2, logMoveStr);</span>
<a href="#l8.730"></a><span id="l8.730">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.731"></a><span id="l8.731"> </span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-    // If error, prefix with the error code and error message.</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-    // A desired wording (without NEWLINEs):</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-    // Filter Action Failed &quot;Move failed&quot; with error code=0x80004005</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-    // while attempting: Applied filter &quot;test&quot; to message from</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-    // Some Test &lt;test@example.com&gt; - send test 3 at 2/13/2015 11:32:53 AM</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-    // moved message id = 54DE5165.7000907@example.com to</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-    // mailbox://nobody@Local%20Folders/test</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-    if (NS_FAILED(aRcode))</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-    {</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-      // Convert aErrmsg to UTF16 string, and</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-      // convert aRcode to UTF16 string in advance.</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-      char tcode[20];</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-      PR_snprintf(tcode, sizeof(tcode), &quot;0x%08x&quot;, aRcode);</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-      NS_ConvertASCIItoUTF16 tcode16(tcode);</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-      nsString tErrmsg;</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-      if (actionType != nsMsgFilterAction::Custom) {</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-        // If this is one of our internal actions, the passed string</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-        // is an identifier to get from the bundle.</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-        rv = bundle-&gt;GetStringFromName(PromiseFlatCString(aErrmsg).get(), tErrmsg);</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-          tErrmsg.Assign(NS_ConvertUTF8toUTF16(aErrmsg));</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-      } else {</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-        // The addon creating the custom action should have passed a localized string.</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-        tErrmsg.Assign(NS_ConvertUTF8toUTF16(aErrmsg));</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-      }</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-      const char16_t *logErrorFormatStrings[2] = { tErrmsg.get(), tcode16.get() };</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-      nsString filterFailureWarningPrefix;</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-                      &quot;filterFailureWarningPrefix&quot;,</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-                      logErrorFormatStrings, 2,</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-                      filterFailureWarningPrefix);</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-      buffer += filterFailureWarningPrefix;</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-      buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-    }</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-    const char16_t *filterLogDetectFormatStrings[4] = { filterName.get(), authorValue.get(), subjectValue.get(), dateValue.get() };</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-    nsString filterLogDetectStr;</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-      &quot;filterLogDetectStr&quot;,</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-      filterLogDetectFormatStrings, 4,</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-      filterLogDetectStr);</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineplus">+    buffer += logMoveStr;</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+  } else if (actionType == nsMsgFilterAction::Custom) {</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+    nsAutoString filterActionName;</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+    rv = aFilterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; customAction)</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+      customAction-&gt;GetName(filterActionName);</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+    if (filterActionName.IsEmpty())</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+      bundle-&gt;GetStringFromName(&quot;filterMissingCustomAction&quot;, filterActionName);</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+    buffer += filterActionName;</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+  } else {</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+    nsString actionValue;</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+    nsAutoCString filterActionID;</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+    filterActionID = NS_LITERAL_CSTRING(&quot;filterAction&quot;);</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+    filterActionID.AppendInt(actionType);</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+    rv = bundle-&gt;GetStringFromName(filterActionID.get(), actionValue);</span>
<a href="#l8.792"></a><span id="l8.792">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.793"></a><span id="l8.793"> </span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-    buffer += filterLogDetectStr;</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-    buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineminus">-</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-    if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineminus">-        actionType == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineminus">-    {</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-      nsCString actionFolderUri;</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-      aFilterAction-&gt;GetTargetFolderUri(actionFolderUri);</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-      NS_ConvertASCIItoUTF16 actionFolderUriValue(actionFolderUri);</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineminus">-</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-      nsCString msgId;</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-      aMsgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-      NS_ConvertASCIItoUTF16 msgIdValue(msgId);</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-      const char16_t *logMoveFormatStrings[2] = { msgIdValue.get(), actionFolderUriValue.get() };</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-      nsString logMoveStr;</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-        (actionType == nsMsgFilterAction::MoveToFolder) ?</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-          &quot;logMoveStr&quot; : &quot;logCopyStr&quot;,</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-        logMoveFormatStrings, 2,</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-        logMoveStr);</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+    buffer += actionValue;</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+  }</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+  buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.819"></a><span id="l8.819"> </span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-      buffer += logMoveStr;</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-    }</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-    else if (actionType == nsMsgFilterAction::Custom)</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-    {</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-      nsAutoString filterActionName;</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-      rv = aFilterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; customAction)</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-        customAction-&gt;GetName(filterActionName);</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-      if (filterActionName.IsEmpty())</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-        bundle-&gt;GetStringFromName(</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-                  &quot;filterMissingCustomAction&quot;,</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-                  filterActionName);</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-      buffer += filterActionName;</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-    }</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">-    else</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">-    {</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-      nsString actionValue;</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-      nsAutoCString filterActionID;</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-      filterActionID = NS_LITERAL_CSTRING(&quot;filterAction&quot;);</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-      filterActionID.AppendInt(actionType);</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-      rv = bundle-&gt;GetStringFromName(filterActionID.get(), actionValue);</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineminus">-      buffer += actionValue;</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-    }</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-    buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-    m_filterList-&gt;LogFilterMessage(buffer, nullptr);</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+  m_filterList-&gt;LogFilterMessage(buffer, nullptr);</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.852"></a><span id="l8.852"> }</span>
<a href="#l8.853"></a><span id="l8.853"> </span>
<a href="#l8.854"></a><span id="l8.854"> NS_IMETHODIMP nsMsgFilter::LogRuleHit(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-                                      nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-{</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineminus">-  return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, NS_OK, EmptyCString());</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+                                      nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineplus">+  return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, NS_OK,</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineplus">+                                        EmptyCString());</span>
<a href="#l8.861"></a><span id="l8.861"> }</span>
<a href="#l8.862"></a><span id="l8.862"> </span>
<a href="#l8.863"></a><span id="l8.863"> NS_IMETHODIMP nsMsgFilter::LogRuleHitFail(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-                                          nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-                                          nsresult aRcode,</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-                                          const nsACString &amp;aErrMsg)</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-{</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-  return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, aRcode, aErrMsg);</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+                                          nsIMsgDBHdr *aMsgHdr, nsresult aRcode,</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+                                          const nsACString &amp;aErrMsg) {</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+  return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, aRcode,</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineplus">+                                        aErrMsg);</span>
<a href="#l8.873"></a><span id="l8.873"> }</span>
<a href="#l8.874"></a><span id="l8.874"> </span>
<a href="#l8.875"></a><span id="l8.875"> NS_IMETHODIMP</span>
<a href="#l8.876"></a><span id="l8.876"> nsMsgFilter::MatchHdr(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder,</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-                      nsIMsgDatabase *db, const nsACString&amp; headers,</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-                      bool *pResult)</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-{</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineplus">+                      nsIMsgDatabase *db, const nsACString &amp;headers,</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineplus">+                      bool *pResult) {</span>
<a href="#l8.882"></a><span id="l8.882">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l8.883"></a><span id="l8.883">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l8.884"></a><span id="l8.884">   // use offlineMail because</span>
<a href="#l8.885"></a><span id="l8.885">   nsCString folderCharset;</span>
<a href="#l8.886"></a><span id="l8.886">   folder-&gt;GetCharset(folderCharset);</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-  nsresult rv = nsMsgSearchOfflineMail::MatchTermsForFilter(msgHdr, m_termList,</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-                  folderCharset.get(), m_scope, db, headers, &amp;m_expressionTree, pResult);</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineplus">+  nsresult rv = nsMsgSearchOfflineMail::MatchTermsForFilter(</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+      msgHdr, m_termList, folderCharset.get(), m_scope, db, headers,</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+      &amp;m_expressionTree, pResult);</span>
<a href="#l8.892"></a><span id="l8.892">   return rv;</span>
<a href="#l8.893"></a><span id="l8.893"> }</span>
<a href="#l8.894"></a><span id="l8.894"> </span>
<a href="#l8.895"></a><span id="l8.895"> NS_IMETHODIMP</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-nsMsgFilter::SetFilterList(nsIMsgFilterList *filterList)</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-{</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineplus">+nsMsgFilter::SetFilterList(nsIMsgFilterList *filterList) {</span>
<a href="#l8.899"></a><span id="l8.899">   // doesn't hold a ref.</span>
<a href="#l8.900"></a><span id="l8.900">   m_filterList = filterList;</span>
<a href="#l8.901"></a><span id="l8.901">   return NS_OK;</span>
<a href="#l8.902"></a><span id="l8.902"> }</span>
<a href="#l8.903"></a><span id="l8.903"> </span>
<a href="#l8.904"></a><span id="l8.904"> NS_IMETHODIMP</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-nsMsgFilter::GetFilterList(nsIMsgFilterList **aResult)</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-{</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineplus">+nsMsgFilter::GetFilterList(nsIMsgFilterList **aResult) {</span>
<a href="#l8.908"></a><span id="l8.908">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l8.909"></a><span id="l8.909">   NS_IF_ADDREF(*aResult = m_filterList);</span>
<a href="#l8.910"></a><span id="l8.910">   return NS_OK;</span>
<a href="#l8.911"></a><span id="l8.911"> }</span>
<a href="#l8.912"></a><span id="l8.912"> </span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-void nsMsgFilter::SetFilterScript(nsCString *fileName)</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-{</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineplus">+void nsMsgFilter::SetFilterScript(nsCString *fileName) {</span>
<a href="#l8.916"></a><span id="l8.916">   m_scriptFileName = *fileName;</span>
<a href="#l8.917"></a><span id="l8.917"> }</span>
<a href="#l8.918"></a><span id="l8.918"> </span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-nsresult nsMsgFilter::ConvertMoveOrCopyToFolderValue(nsIMsgRuleAction *filterAction, nsCString &amp;moveValue)</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-{</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineplus">+nsresult nsMsgFilter::ConvertMoveOrCopyToFolderValue(</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineplus">+    nsIMsgRuleAction *filterAction, nsCString &amp;moveValue) {</span>
<a href="#l8.923"></a><span id="l8.923">   NS_ENSURE_ARG_POINTER(filterAction);</span>
<a href="#l8.924"></a><span id="l8.924">   int16_t filterVersion = kFileVersion;</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-  if (m_filterList)</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-      m_filterList-&gt;GetVersion(&amp;filterVersion);</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-  if (filterVersion &lt;= k60Beta1Version)</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-  {</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+  if (m_filterList) m_filterList-&gt;GetVersion(&amp;filterVersion);</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+  if (filterVersion &lt;= k60Beta1Version) {</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l8.933"></a><span id="l8.933">     nsCString folderUri;</span>
<a href="#l8.934"></a><span id="l8.934"> </span>
<a href="#l8.935"></a><span id="l8.935">     m_filterList-&gt;GetFolder(getter_AddRefs(rootFolder));</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineminus">-    // if relative path starts with kImap, this is a move to folder on the same server</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineminus">-    if (moveValue.Find(kImapPrefix) == 0)</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineminus">-    {</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+    // if relative path starts with kImap, this is a move to folder on the same</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+    // server</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineplus">+    if (moveValue.Find(kImapPrefix) == 0) {</span>
<a href="#l8.942"></a><span id="l8.942">       int32_t prefixLen = PL_strlen(kImapPrefix);</span>
<a href="#l8.943"></a><span id="l8.943">       nsAutoCString originalServerPath(Substring(moveValue, prefixLen));</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-      if (filterVersion == k45Version)</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-      {</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+      if (filterVersion == k45Version) {</span>
<a href="#l8.947"></a><span id="l8.947">         nsAutoString unicodeStr;</span>
<a href="#l8.948"></a><span id="l8.948">         NS_CopyNativeToUnicode(originalServerPath, unicodeStr);</span>
<a href="#l8.949"></a><span id="l8.949"> </span>
<a href="#l8.950"></a><span id="l8.950">         nsresult rv = CopyUTF16toMUTF7(unicodeStr, originalServerPath);</span>
<a href="#l8.951"></a><span id="l8.951">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.952"></a><span id="l8.952">       }</span>
<a href="#l8.953"></a><span id="l8.953"> </span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">-      if (rootFolder)</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-      {</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-        rootFolder-&gt;FindSubFolder(originalServerPath, getter_AddRefs(destIFolder));</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">-        if (destIFolder)</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-        {</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+      if (rootFolder) {</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineplus">+        rootFolder-&gt;FindSubFolder(originalServerPath,</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineplus">+                                  getter_AddRefs(destIFolder));</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+        if (destIFolder) {</span>
<a href="#l8.965"></a><span id="l8.965">           destIFolder-&gt;GetURI(folderUri);</span>
<a href="#l8.966"></a><span id="l8.966">           filterAction-&gt;SetTargetFolderUri(folderUri);</span>
<a href="#l8.967"></a><span id="l8.967">           moveValue.Assign(folderUri);</span>
<a href="#l8.968"></a><span id="l8.968">         }</span>
<a href="#l8.969"></a><span id="l8.969">       }</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-    }</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-    else</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-    {</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineplus">+    } else {</span>
<a href="#l8.974"></a><span id="l8.974">       // start off leaving the value the same.</span>
<a href="#l8.975"></a><span id="l8.975">       filterAction-&gt;SetTargetFolderUri(moveValue);</span>
<a href="#l8.976"></a><span id="l8.976">       nsresult rv = NS_OK;</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; localMailRoot;</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; localMailRoot;</span>
<a href="#l8.979"></a><span id="l8.979">       rootFolder-&gt;GetURI(folderUri);</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-      // if the root folder is not imap, than the local mail root is the server root.</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineminus">-      // otherwise, it's the migrated local folders.</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineplus">+      // if the root folder is not imap, than the local mail root is the server</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineplus">+      // root. otherwise, it's the migrated local folders.</span>
<a href="#l8.984"></a><span id="l8.984">       if (!StringBeginsWith(folderUri, NS_LITERAL_CSTRING(&quot;imap:&quot;)))</span>
<a href="#l8.985"></a><span id="l8.985">         localMailRoot = rootFolder;</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineminus">-      else</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineminus">-      {</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineplus">+      else {</span>
<a href="#l8.989"></a><span id="l8.989">         nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineminus">-                 do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineplus">+            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.992"></a><span id="l8.992">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-        nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.995"></a><span id="l8.995">         rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l8.996"></a><span id="l8.996">         if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l8.997"></a><span id="l8.997">           rv = server-&gt;GetRootFolder(getter_AddRefs(localMailRoot));</span>
<a href="#l8.998"></a><span id="l8.998">       }</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; localMailRoot)</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineminus">-      {</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; localMailRoot) {</span>
<a href="#l8.1002"></a><span id="l8.1002">         nsCString localRootURI;</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; destIMsgFolder;</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; destIMsgFolder;</span>
<a href="#l8.1005"></a><span id="l8.1005">         localMailRoot-&gt;GetURI(localRootURI);</span>
<a href="#l8.1006"></a><span id="l8.1006">         nsCString destFolderUri;</span>
<a href="#l8.1007"></a><span id="l8.1007">         destFolderUri.Assign(localRootURI);</span>
<a href="#l8.1008"></a><span id="l8.1008">         // need to remove &quot;.sbd&quot; from moveValue, and perhaps escape it.</span>
<a href="#l8.1009"></a><span id="l8.1009">         int32_t offset = moveValue.Find(FOLDER_SUFFIX8 &quot;/&quot;);</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-        if (offset != -1)</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-          moveValue.Cut(offset, FOLDER_SUFFIX_LENGTH);</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineplus">+        if (offset != -1) moveValue.Cut(offset, FOLDER_SUFFIX_LENGTH);</span>
<a href="#l8.1013"></a><span id="l8.1013"> </span>
<a href="#l8.1014"></a><span id="l8.1014"> #ifdef XP_MACOSX</span>
<a href="#l8.1015"></a><span id="l8.1015">         nsCString unescapedMoveValue;</span>
<a href="#l8.1016"></a><span id="l8.1016">         MsgUnescapeString(moveValue, 0, unescapedMoveValue);</span>
<a href="#l8.1017"></a><span id="l8.1017">         moveValue = unescapedMoveValue;</span>
<a href="#l8.1018"></a><span id="l8.1018"> #endif</span>
<a href="#l8.1019"></a><span id="l8.1019">         destFolderUri.Append('/');</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-        if (filterVersion == k45Version)</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineminus">-        {</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineplus">+        if (filterVersion == k45Version) {</span>
<a href="#l8.1023"></a><span id="l8.1023">           nsAutoString unicodeStr;</span>
<a href="#l8.1024"></a><span id="l8.1024">           NS_CopyNativeToUnicode(moveValue, unicodeStr);</span>
<a href="#l8.1025"></a><span id="l8.1025">           rv = NS_MsgEscapeEncodeURLPath(unicodeStr, moveValue);</span>
<a href="#l8.1026"></a><span id="l8.1026">         }</span>
<a href="#l8.1027"></a><span id="l8.1027">         destFolderUri.Append(moveValue);</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-        localMailRoot-&gt;GetChildWithURI(destFolderUri, true, false /*caseInsensitive*/, getter_AddRefs(destIMsgFolder));</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineplus">+        localMailRoot-&gt;GetChildWithURI(destFolderUri, true,</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineplus">+                                       false /*caseInsensitive*/,</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineplus">+                                       getter_AddRefs(destIMsgFolder));</span>
<a href="#l8.1032"></a><span id="l8.1032"> </span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-        if (destIMsgFolder)</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-        {</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineplus">+        if (destIMsgFolder) {</span>
<a href="#l8.1036"></a><span id="l8.1036">           destIMsgFolder-&gt;GetURI(folderUri);</span>
<a href="#l8.1037"></a><span id="l8.1037">           filterAction-&gt;SetTargetFolderUri(folderUri);</span>
<a href="#l8.1038"></a><span id="l8.1038">           moveValue.Assign(folderUri);</span>
<a href="#l8.1039"></a><span id="l8.1039">         }</span>
<a href="#l8.1040"></a><span id="l8.1040">       }</span>
<a href="#l8.1041"></a><span id="l8.1041">     }</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-  }</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineminus">-  else</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineplus">+  } else</span>
<a href="#l8.1045"></a><span id="l8.1045">     filterAction-&gt;SetTargetFolderUri(moveValue);</span>
<a href="#l8.1046"></a><span id="l8.1046"> </span>
<a href="#l8.1047"></a><span id="l8.1047">   return NS_OK;</span>
<a href="#l8.1048"></a><span id="l8.1048">   // set m_action.m_value.m_folderUri</span>
<a href="#l8.1049"></a><span id="l8.1049"> }</span>
<a href="#l8.1050"></a><span id="l8.1050"> </span>
<a href="#l8.1051"></a><span id="l8.1051"> NS_IMETHODIMP</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-nsMsgFilter::SaveToTextFile(nsIOutputStream *aStream)</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineminus">-{</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineplus">+nsMsgFilter::SaveToTextFile(nsIOutputStream *aStream) {</span>
<a href="#l8.1055"></a><span id="l8.1055">   NS_ENSURE_ARG_POINTER(aStream);</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-  if (m_unparseable)</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-  {</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+  if (m_unparseable) {</span>
<a href="#l8.1059"></a><span id="l8.1059">     uint32_t bytesWritten;</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineminus">-    //we need to trim leading whitespaces before filing out</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-    m_unparsedBuffer.Trim(kWhitespace, true /*leadingCharacters*/, false /*trailingCharacters*/);</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineminus">-    return aStream-&gt;Write(m_unparsedBuffer.get(), m_unparsedBuffer.Length(), &amp;bytesWritten);</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineplus">+    // we need to trim leading whitespaces before filing out</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineplus">+    m_unparsedBuffer.Trim(kWhitespace, true /*leadingCharacters*/,</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineplus">+                          false /*trailingCharacters*/);</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineplus">+    return aStream-&gt;Write(m_unparsedBuffer.get(), m_unparsedBuffer.Length(),</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineplus">+                          &amp;bytesWritten);</span>
<a href="#l8.1068"></a><span id="l8.1068">   }</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineminus">-  nsresult err = m_filterList-&gt;WriteWstrAttr(nsIMsgFilterList::attribName, m_filterName.get(), aStream);</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineminus">-  err = m_filterList-&gt;WriteBoolAttr(nsIMsgFilterList::attribEnabled, m_enabled, aStream);</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineminus">-  err = m_filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribDescription, m_description.get(), aStream);</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineminus">-  err = m_filterList-&gt;WriteIntAttr(nsIMsgFilterList::attribType, m_type, aStream);</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineplus">+  nsresult err = m_filterList-&gt;WriteWstrAttr(nsIMsgFilterList::attribName,</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineplus">+                                             m_filterName.get(), aStream);</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineplus">+  err = m_filterList-&gt;WriteBoolAttr(nsIMsgFilterList::attribEnabled, m_enabled,</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineplus">+                                    aStream);</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineplus">+  err = m_filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribDescription,</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineplus">+                                   m_description.get(), aStream);</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineplus">+  err =</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineplus">+      m_filterList-&gt;WriteIntAttr(nsIMsgFilterList::attribType, m_type, aStream);</span>
<a href="#l8.1081"></a><span id="l8.1081">   if (IsScript())</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineminus">-    err = m_filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribScriptFile, m_scriptFileName.get(), aStream);</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineplus">+    err = m_filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribScriptFile,</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineplus">+                                     m_scriptFileName.get(), aStream);</span>
<a href="#l8.1085"></a><span id="l8.1085">   else</span>
<a href="#l8.1086"></a><span id="l8.1086">     err = SaveRule(aStream);</span>
<a href="#l8.1087"></a><span id="l8.1087">   return err;</span>
<a href="#l8.1088"></a><span id="l8.1088"> }</span>
<a href="#l8.1089"></a><span id="l8.1089"> </span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-nsresult nsMsgFilter::SaveRule(nsIOutputStream *aStream)</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-{</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineplus">+nsresult nsMsgFilter::SaveRule(nsIOutputStream *aStream) {</span>
<a href="#l8.1093"></a><span id="l8.1093">   nsresult err = NS_OK;</span>
<a href="#l8.1094"></a><span id="l8.1094">   nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l8.1095"></a><span id="l8.1095">   GetFilterList(getter_AddRefs(filterList));</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineminus">-  nsAutoCString  actionFilingStr;</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineplus">+  nsAutoCString actionFilingStr;</span>
<a href="#l8.1098"></a><span id="l8.1098"> </span>
<a href="#l8.1099"></a><span id="l8.1099">   uint32_t numActions;</span>
<a href="#l8.1100"></a><span id="l8.1100">   err = GetActionCount(&amp;numActions);</span>
<a href="#l8.1101"></a><span id="l8.1101">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l8.1102"></a><span id="l8.1102"> </span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineminus">-  for (uint32_t index = 0; index &lt; numActions; index++)</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineminus">-  {</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineplus">+  for (uint32_t index = 0; index &lt; numActions; index++) {</span>
<a href="#l8.1106"></a><span id="l8.1106">     nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l8.1107"></a><span id="l8.1107">     err = GetActionAt(index, getter_AddRefs(action));</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineminus">-    if (NS_FAILED(err) || !action)</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineminus">-      continue;</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineplus">+    if (NS_FAILED(err) || !action) continue;</span>
<a href="#l8.1111"></a><span id="l8.1111"> </span>
<a href="#l8.1112"></a><span id="l8.1112">     nsMsgRuleActionType actionType;</span>
<a href="#l8.1113"></a><span id="l8.1113">     action-&gt;GetType(&amp;actionType);</span>
<a href="#l8.1114"></a><span id="l8.1114">     GetActionFilingStr(actionType, actionFilingStr);</span>
<a href="#l8.1115"></a><span id="l8.1115"> </span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-    err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribAction, actionFilingStr.get(), aStream);</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineplus">+    err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribAction,</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineplus">+                                   actionFilingStr.get(), aStream);</span>
<a href="#l8.1119"></a><span id="l8.1119">     NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l8.1120"></a><span id="l8.1120"> </span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineminus">-    switch(actionType)</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineminus">-    {</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineplus">+    switch (actionType) {</span>
<a href="#l8.1124"></a><span id="l8.1124">       case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineminus">-      case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineminus">-      {</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineplus">+      case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l8.1128"></a><span id="l8.1128">         nsCString imapTargetString;</span>
<a href="#l8.1129"></a><span id="l8.1129">         action-&gt;GetTargetFolderUri(imapTargetString);</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribActionValue, imapTargetString.get(), aStream);</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineminus">-      }</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineminus">-      break;</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineminus">-      case nsMsgFilterAction::ChangePriority:</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-      {</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineplus">+        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineplus">+                                       imapTargetString.get(), aStream);</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineplus">+      } break;</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineplus">+      case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l8.1139"></a><span id="l8.1139">         nsMsgPriorityValue priorityValue;</span>
<a href="#l8.1140"></a><span id="l8.1140">         action-&gt;GetPriority(&amp;priorityValue);</span>
<a href="#l8.1141"></a><span id="l8.1141">         nsAutoCString priority;</span>
<a href="#l8.1142"></a><span id="l8.1142">         NS_MsgGetUntranslatedPriorityName(priorityValue, priority);</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineminus">-        err = filterList-&gt;WriteStrAttr(</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineminus">-                nsIMsgFilterList::attribActionValue, priority.get(), aStream);</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineminus">-      }</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineminus">-      break;</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-      case nsMsgFilterAction::Label:</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-      {</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineplus">+        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineplus">+                                       priority.get(), aStream);</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineplus">+      } break;</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineplus">+      case nsMsgFilterAction::Label: {</span>
<a href="#l8.1153"></a><span id="l8.1153">         nsMsgLabelValue label;</span>
<a href="#l8.1154"></a><span id="l8.1154">         action-&gt;GetLabel(&amp;label);</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineminus">-        err = filterList-&gt;WriteIntAttr(nsIMsgFilterList::attribActionValue, label, aStream);</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineminus">-      }</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineminus">-      break;</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineminus">-      case nsMsgFilterAction::JunkScore:</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineminus">-      {</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineplus">+        err = filterList-&gt;WriteIntAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l8.1161"></a><span id="l8.1161" class="difflineplus">+                                       label, aStream);</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineplus">+      } break;</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineplus">+      case nsMsgFilterAction::JunkScore: {</span>
<a href="#l8.1164"></a><span id="l8.1164">         int32_t junkScore;</span>
<a href="#l8.1165"></a><span id="l8.1165">         action-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineminus">-        err = filterList-&gt;WriteIntAttr(nsIMsgFilterList::attribActionValue, junkScore, aStream);</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineminus">-      }</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-      break;</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineplus">+        err = filterList-&gt;WriteIntAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineplus">+                                       junkScore, aStream);</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineplus">+      } break;</span>
<a href="#l8.1172"></a><span id="l8.1172">       case nsMsgFilterAction::AddTag:</span>
<a href="#l8.1173"></a><span id="l8.1173">       case nsMsgFilterAction::Reply:</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineminus">-      case nsMsgFilterAction::Forward:</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-      {</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineplus">+      case nsMsgFilterAction::Forward: {</span>
<a href="#l8.1177"></a><span id="l8.1177">         nsCString strValue;</span>
<a href="#l8.1178"></a><span id="l8.1178">         action-&gt;GetStrValue(strValue);</span>
<a href="#l8.1179"></a><span id="l8.1179">         // strValue is e-mail address</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribActionValue, strValue.get(), aStream);</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-      }</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineminus">-      break;</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineminus">-      case nsMsgFilterAction::Custom:</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-      {</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineplus">+        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineplus">+                                       strValue.get(), aStream);</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineplus">+      } break;</span>
<a href="#l8.1188"></a><span id="l8.1188" class="difflineplus">+      case nsMsgFilterAction::Custom: {</span>
<a href="#l8.1189"></a><span id="l8.1189">         nsAutoCString id;</span>
<a href="#l8.1190"></a><span id="l8.1190">         action-&gt;GetCustomId(id);</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribCustomId, id.get(), aStream);</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineplus">+        err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribCustomId,</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineplus">+                                       id.get(), aStream);</span>
<a href="#l8.1194"></a><span id="l8.1194">         nsAutoCString strValue;</span>
<a href="#l8.1195"></a><span id="l8.1195">         action-&gt;GetStrValue(strValue);</span>
<a href="#l8.1196"></a><span id="l8.1196">         if (strValue.Length())</span>
<a href="#l8.1197"></a><span id="l8.1197">           err = filterList-&gt;WriteWstrAttr(nsIMsgFilterList::attribActionValue,</span>
<a href="#l8.1198"></a><span id="l8.1198">                                           NS_ConvertUTF8toUTF16(strValue).get(),</span>
<a href="#l8.1199"></a><span id="l8.1199">                                           aStream);</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineminus">-      }</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineminus">-      break;</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineplus">+      } break;</span>
<a href="#l8.1203"></a><span id="l8.1203"> </span>
<a href="#l8.1204"></a><span id="l8.1204">       default:</span>
<a href="#l8.1205"></a><span id="l8.1205">         break;</span>
<a href="#l8.1206"></a><span id="l8.1206">     }</span>
<a href="#l8.1207"></a><span id="l8.1207">   }</span>
<a href="#l8.1208"></a><span id="l8.1208">   // and here the fun begins - file out term list...</span>
<a href="#l8.1209"></a><span id="l8.1209" class="difflineminus">-  nsAutoCString  condition;</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineplus">+  nsAutoCString condition;</span>
<a href="#l8.1211"></a><span id="l8.1211">   err = MsgTermListToString(m_termList, condition);</span>
<a href="#l8.1212"></a><span id="l8.1212">   if (NS_SUCCEEDED(err))</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineminus">-    err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribCondition, condition.get(), aStream);</span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineplus">+    err = filterList-&gt;WriteStrAttr(nsIMsgFilterList::attribCondition,</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineplus">+                                   condition.get(), aStream);</span>
<a href="#l8.1216"></a><span id="l8.1216">   return err;</span>
<a href="#l8.1217"></a><span id="l8.1217"> }</span>
<a href="#l8.1218"></a><span id="l8.1218"> </span>
<a href="#l8.1219"></a><span id="l8.1219"> // for each action, this table encodes the filterTypes that support the action.</span>
<a href="#l8.1220"></a><span id="l8.1220" class="difflineminus">-struct RuleActionsTableEntry</span>
<a href="#l8.1221"></a><span id="l8.1221" class="difflineminus">-{</span>
<a href="#l8.1222"></a><span id="l8.1222" class="difflineminus">-  nsMsgRuleActionType  action;</span>
<a href="#l8.1223"></a><span id="l8.1223" class="difflineminus">-  const char*          actionFilingStr;  /* used for filing out filters, don't translate! */</span>
<a href="#l8.1224"></a><span id="l8.1224" class="difflineplus">+struct RuleActionsTableEntry {</span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineplus">+  nsMsgRuleActionType action;</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineplus">+  const char</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineplus">+      *actionFilingStr; /* used for filing out filters, don't translate! */</span>
<a href="#l8.1228"></a><span id="l8.1228"> };</span>
<a href="#l8.1229"></a><span id="l8.1229"> </span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineminus">-static struct RuleActionsTableEntry ruleActionsTable[] =</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineminus">-{</span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-  { nsMsgFilterAction::MoveToFolder,            &quot;Move to folder&quot;},</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-  { nsMsgFilterAction::CopyToFolder,            &quot;Copy to folder&quot;},</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-  { nsMsgFilterAction::ChangePriority,          &quot;Change priority&quot;},</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineminus">-  { nsMsgFilterAction::Delete,                  &quot;Delete&quot;},</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineminus">-  { nsMsgFilterAction::MarkRead,                &quot;Mark read&quot;},</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineminus">-  { nsMsgFilterAction::KillThread,              &quot;Ignore thread&quot;},</span>
<a href="#l8.1238"></a><span id="l8.1238" class="difflineminus">-  { nsMsgFilterAction::KillSubthread,           &quot;Ignore subthread&quot;},</span>
<a href="#l8.1239"></a><span id="l8.1239" class="difflineminus">-  { nsMsgFilterAction::WatchThread,             &quot;Watch thread&quot;},</span>
<a href="#l8.1240"></a><span id="l8.1240" class="difflineminus">-  { nsMsgFilterAction::MarkFlagged,             &quot;Mark flagged&quot;},</span>
<a href="#l8.1241"></a><span id="l8.1241" class="difflineminus">-  { nsMsgFilterAction::Label,                   &quot;Label&quot;},</span>
<a href="#l8.1242"></a><span id="l8.1242" class="difflineminus">-  { nsMsgFilterAction::Reply,                   &quot;Reply&quot;},</span>
<a href="#l8.1243"></a><span id="l8.1243" class="difflineminus">-  { nsMsgFilterAction::Forward,                 &quot;Forward&quot;},</span>
<a href="#l8.1244"></a><span id="l8.1244" class="difflineminus">-  { nsMsgFilterAction::StopExecution,           &quot;Stop execution&quot;},</span>
<a href="#l8.1245"></a><span id="l8.1245" class="difflineminus">-  { nsMsgFilterAction::DeleteFromPop3Server,    &quot;Delete from Pop3 server&quot;},</span>
<a href="#l8.1246"></a><span id="l8.1246" class="difflineminus">-  { nsMsgFilterAction::LeaveOnPop3Server,       &quot;Leave on Pop3 server&quot;},</span>
<a href="#l8.1247"></a><span id="l8.1247" class="difflineminus">-  { nsMsgFilterAction::JunkScore,               &quot;JunkScore&quot;},</span>
<a href="#l8.1248"></a><span id="l8.1248" class="difflineminus">-  { nsMsgFilterAction::FetchBodyFromPop3Server, &quot;Fetch body from Pop3Server&quot;},</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineminus">-  { nsMsgFilterAction::AddTag,                  &quot;AddTag&quot;},</span>
<a href="#l8.1250"></a><span id="l8.1250" class="difflineminus">-  { nsMsgFilterAction::MarkUnread,              &quot;Mark unread&quot;},</span>
<a href="#l8.1251"></a><span id="l8.1251" class="difflineminus">-  { nsMsgFilterAction::Custom,                  &quot;Custom&quot;},</span>
<a href="#l8.1252"></a><span id="l8.1252" class="difflineplus">+static struct RuleActionsTableEntry ruleActionsTable[] = {</span>
<a href="#l8.1253"></a><span id="l8.1253" class="difflineplus">+    {nsMsgFilterAction::MoveToFolder, &quot;Move to folder&quot;},</span>
<a href="#l8.1254"></a><span id="l8.1254" class="difflineplus">+    {nsMsgFilterAction::CopyToFolder, &quot;Copy to folder&quot;},</span>
<a href="#l8.1255"></a><span id="l8.1255" class="difflineplus">+    {nsMsgFilterAction::ChangePriority, &quot;Change priority&quot;},</span>
<a href="#l8.1256"></a><span id="l8.1256" class="difflineplus">+    {nsMsgFilterAction::Delete, &quot;Delete&quot;},</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineplus">+    {nsMsgFilterAction::MarkRead, &quot;Mark read&quot;},</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineplus">+    {nsMsgFilterAction::KillThread, &quot;Ignore thread&quot;},</span>
<a href="#l8.1259"></a><span id="l8.1259" class="difflineplus">+    {nsMsgFilterAction::KillSubthread, &quot;Ignore subthread&quot;},</span>
<a href="#l8.1260"></a><span id="l8.1260" class="difflineplus">+    {nsMsgFilterAction::WatchThread, &quot;Watch thread&quot;},</span>
<a href="#l8.1261"></a><span id="l8.1261" class="difflineplus">+    {nsMsgFilterAction::MarkFlagged, &quot;Mark flagged&quot;},</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineplus">+    {nsMsgFilterAction::Label, &quot;Label&quot;},</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineplus">+    {nsMsgFilterAction::Reply, &quot;Reply&quot;},</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineplus">+    {nsMsgFilterAction::Forward, &quot;Forward&quot;},</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineplus">+    {nsMsgFilterAction::StopExecution, &quot;Stop execution&quot;},</span>
<a href="#l8.1266"></a><span id="l8.1266" class="difflineplus">+    {nsMsgFilterAction::DeleteFromPop3Server, &quot;Delete from Pop3 server&quot;},</span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineplus">+    {nsMsgFilterAction::LeaveOnPop3Server, &quot;Leave on Pop3 server&quot;},</span>
<a href="#l8.1268"></a><span id="l8.1268" class="difflineplus">+    {nsMsgFilterAction::JunkScore, &quot;JunkScore&quot;},</span>
<a href="#l8.1269"></a><span id="l8.1269" class="difflineplus">+    {nsMsgFilterAction::FetchBodyFromPop3Server, &quot;Fetch body from Pop3Server&quot;},</span>
<a href="#l8.1270"></a><span id="l8.1270" class="difflineplus">+    {nsMsgFilterAction::AddTag, &quot;AddTag&quot;},</span>
<a href="#l8.1271"></a><span id="l8.1271" class="difflineplus">+    {nsMsgFilterAction::MarkUnread, &quot;Mark unread&quot;},</span>
<a href="#l8.1272"></a><span id="l8.1272" class="difflineplus">+    {nsMsgFilterAction::Custom, &quot;Custom&quot;},</span>
<a href="#l8.1273"></a><span id="l8.1273"> };</span>
<a href="#l8.1274"></a><span id="l8.1274"> </span>
<a href="#l8.1275"></a><span id="l8.1275"> static const unsigned int sNumActions = MOZ_ARRAY_LENGTH(ruleActionsTable);</span>
<a href="#l8.1276"></a><span id="l8.1276"> </span>
<a href="#l8.1277"></a><span id="l8.1277" class="difflineminus">-const char *nsMsgFilter::GetActionStr(nsMsgRuleActionType action)</span>
<a href="#l8.1278"></a><span id="l8.1278" class="difflineminus">-{</span>
<a href="#l8.1279"></a><span id="l8.1279" class="difflineminus">-  for (unsigned int i = 0; i &lt; sNumActions; i++)</span>
<a href="#l8.1280"></a><span id="l8.1280" class="difflineminus">-  {</span>
<a href="#l8.1281"></a><span id="l8.1281" class="difflineplus">+const char *nsMsgFilter::GetActionStr(nsMsgRuleActionType action) {</span>
<a href="#l8.1282"></a><span id="l8.1282" class="difflineplus">+  for (unsigned int i = 0; i &lt; sNumActions; i++) {</span>
<a href="#l8.1283"></a><span id="l8.1283">     if (action == ruleActionsTable[i].action)</span>
<a href="#l8.1284"></a><span id="l8.1284">       return ruleActionsTable[i].actionFilingStr;</span>
<a href="#l8.1285"></a><span id="l8.1285">   }</span>
<a href="#l8.1286"></a><span id="l8.1286">   return &quot;&quot;;</span>
<a href="#l8.1287"></a><span id="l8.1287"> }</span>
<a href="#l8.1288"></a><span id="l8.1288" class="difflineminus">-/*static */nsresult nsMsgFilter::GetActionFilingStr(nsMsgRuleActionType action, nsCString &amp;actionStr)</span>
<a href="#l8.1289"></a><span id="l8.1289" class="difflineminus">-{</span>
<a href="#l8.1290"></a><span id="l8.1290" class="difflineminus">-  for (unsigned int i = 0; i &lt; sNumActions; i++)</span>
<a href="#l8.1291"></a><span id="l8.1291" class="difflineminus">-  {</span>
<a href="#l8.1292"></a><span id="l8.1292" class="difflineminus">-    if (action == ruleActionsTable[i].action)</span>
<a href="#l8.1293"></a><span id="l8.1293" class="difflineminus">-    {</span>
<a href="#l8.1294"></a><span id="l8.1294" class="difflineplus">+/*static */ nsresult nsMsgFilter::GetActionFilingStr(nsMsgRuleActionType action,</span>
<a href="#l8.1295"></a><span id="l8.1295" class="difflineplus">+                                                     nsCString &amp;actionStr) {</span>
<a href="#l8.1296"></a><span id="l8.1296" class="difflineplus">+  for (unsigned int i = 0; i &lt; sNumActions; i++) {</span>
<a href="#l8.1297"></a><span id="l8.1297" class="difflineplus">+    if (action == ruleActionsTable[i].action) {</span>
<a href="#l8.1298"></a><span id="l8.1298">       actionStr = ruleActionsTable[i].actionFilingStr;</span>
<a href="#l8.1299"></a><span id="l8.1299">       return NS_OK;</span>
<a href="#l8.1300"></a><span id="l8.1300">     }</span>
<a href="#l8.1301"></a><span id="l8.1301">   }</span>
<a href="#l8.1302"></a><span id="l8.1302">   return NS_ERROR_INVALID_ARG;</span>
<a href="#l8.1303"></a><span id="l8.1303"> }</span>
<a href="#l8.1304"></a><span id="l8.1304"> </span>
<a href="#l8.1305"></a><span id="l8.1305" class="difflineminus">-</span>
<a href="#l8.1306"></a><span id="l8.1306" class="difflineminus">-nsMsgRuleActionType nsMsgFilter::GetActionForFilingStr(nsCString &amp;actionStr)</span>
<a href="#l8.1307"></a><span id="l8.1307" class="difflineminus">-{</span>
<a href="#l8.1308"></a><span id="l8.1308" class="difflineminus">-  for (unsigned int i = 0; i &lt; sNumActions; i++)</span>
<a href="#l8.1309"></a><span id="l8.1309" class="difflineminus">-  {</span>
<a href="#l8.1310"></a><span id="l8.1310" class="difflineplus">+nsMsgRuleActionType nsMsgFilter::GetActionForFilingStr(nsCString &amp;actionStr) {</span>
<a href="#l8.1311"></a><span id="l8.1311" class="difflineplus">+  for (unsigned int i = 0; i &lt; sNumActions; i++) {</span>
<a href="#l8.1312"></a><span id="l8.1312">     if (actionStr.Equals(ruleActionsTable[i].actionFilingStr))</span>
<a href="#l8.1313"></a><span id="l8.1313">       return ruleActionsTable[i].action;</span>
<a href="#l8.1314"></a><span id="l8.1314">   }</span>
<a href="#l8.1315"></a><span id="l8.1315">   return nsMsgFilterAction::None;</span>
<a href="#l8.1316"></a><span id="l8.1316"> }</span>
<a href="#l8.1317"></a><span id="l8.1317"> </span>
<a href="#l8.1318"></a><span id="l8.1318" class="difflineminus">-int16_t</span>
<a href="#l8.1319"></a><span id="l8.1319" class="difflineminus">-nsMsgFilter::GetVersion()</span>
<a href="#l8.1320"></a><span id="l8.1320" class="difflineminus">-{</span>
<a href="#l8.1321"></a><span id="l8.1321" class="difflineminus">-    if (!m_filterList) return 0;</span>
<a href="#l8.1322"></a><span id="l8.1322" class="difflineminus">-    int16_t version;</span>
<a href="#l8.1323"></a><span id="l8.1323" class="difflineminus">-    m_filterList-&gt;GetVersion(&amp;version);</span>
<a href="#l8.1324"></a><span id="l8.1324" class="difflineminus">-    return version;</span>
<a href="#l8.1325"></a><span id="l8.1325" class="difflineplus">+int16_t nsMsgFilter::GetVersion() {</span>
<a href="#l8.1326"></a><span id="l8.1326" class="difflineplus">+  if (!m_filterList) return 0;</span>
<a href="#l8.1327"></a><span id="l8.1327" class="difflineplus">+  int16_t version;</span>
<a href="#l8.1328"></a><span id="l8.1328" class="difflineplus">+  m_filterList-&gt;GetVersion(&amp;version);</span>
<a href="#l8.1329"></a><span id="l8.1329" class="difflineplus">+  return version;</span>
<a href="#l8.1330"></a><span id="l8.1330"> }</span>
<a href="#l8.1331"></a><span id="l8.1331"> </span>
<a href="#l8.1332"></a><span id="l8.1332"> #ifdef DEBUG</span>
<a href="#l8.1333"></a><span id="l8.1333" class="difflineminus">-void nsMsgFilter::Dump()</span>
<a href="#l8.1334"></a><span id="l8.1334" class="difflineminus">-{</span>
<a href="#l8.1335"></a><span id="l8.1335" class="difflineplus">+void nsMsgFilter::Dump() {</span>
<a href="#l8.1336"></a><span id="l8.1336">   nsAutoCString s;</span>
<a href="#l8.1337"></a><span id="l8.1337">   LossyCopyUTF16toASCII(m_filterName, s);</span>
<a href="#l8.1338"></a><span id="l8.1338" class="difflineminus">-  printf(&quot;filter %s type = %c desc = %s\n&quot;, s.get(), m_type + '0', m_description.get());</span>
<a href="#l8.1339"></a><span id="l8.1339" class="difflineplus">+  printf(&quot;filter %s type = %c desc = %s\n&quot;, s.get(), m_type + '0',</span>
<a href="#l8.1340"></a><span id="l8.1340" class="difflineplus">+         m_description.get());</span>
<a href="#l8.1341"></a><span id="l8.1341"> }</span>
<a href="#l8.1342"></a><span id="l8.1342"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -10,94 +10,94 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsISupports.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgSearchScopeTerm.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsMsgSearchBoolExpression.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;DateTimeFormat.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-class nsMsgRuleAction : public nsIMsgRuleAction</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-public:</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+class nsMsgRuleAction : public nsIMsgRuleAction {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ public:</span>
<a href="#l9.17"></a><span id="l9.17">   NS_DECL_ISUPPORTS</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   nsMsgRuleAction();</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   NS_DECL_NSIMSGRULEACTION</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-private:</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+ private:</span>
<a href="#l9.25"></a><span id="l9.25">   virtual ~nsMsgRuleAction();</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    nsMsgRuleActionType      m_type;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    // this used to be a union - why bother?</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    nsMsgPriorityValue  m_priority;  /* priority to set rule to */</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    nsMsgLabelValue         m_label;  /* label to set rule to */</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    nsCString    m_folderUri;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-    int32_t             m_junkScore;  /* junk score (or arbitrary int value?) */</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    // arbitrary string value. Currently, email address to forward to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-    nsCString           m_strValue;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-    nsCString           m_customId;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; m_customAction;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-} ;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  nsMsgRuleActionType m_type;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  // this used to be a union - why bother?</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  nsMsgPriorityValue m_priority; /* priority to set rule to */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  nsMsgLabelValue m_label;       /* label to set rule to */</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  nsCString m_folderUri;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  int32_t m_junkScore; /* junk score (or arbitrary int value?) */</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  // arbitrary string value. Currently, email address to forward to</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  nsCString m_strValue;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  nsCString m_customId;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; m_customAction;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+};</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-class nsMsgFilter : public nsIMsgFilter</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-{</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-public:</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+class nsMsgFilter : public nsIMsgFilter {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+ public:</span>
<a href="#l9.56"></a><span id="l9.56">   NS_DECL_ISUPPORTS</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   nsMsgFilter();</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">   NS_DECL_NSIMSGFILTER</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  nsMsgFilterTypeType  GetType() {return m_type;}</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  void    SetType(nsMsgFilterTypeType  type) {m_type = type;}</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  bool    GetEnabled() {return m_enabled;}</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  void    SetFilterScript(nsCString *filterName);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  nsMsgFilterTypeType GetType() { return m_type; }</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  void SetType(nsMsgFilterTypeType type) { m_type = type; }</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  bool GetEnabled() { return m_enabled; }</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  void SetFilterScript(nsCString *filterName);</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  bool    IsScript() {return (m_type &amp;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-                                  (nsMsgFilterType::InboxJavaScript |</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-                                   nsMsgFilterType::NewsJavaScript)) != 0;}</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  bool IsScript() {</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+    return (m_type &amp; (nsMsgFilterType::InboxJavaScript |</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+                      nsMsgFilterType::NewsJavaScript)) != 0;</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  }</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79">   // filing routines.</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  nsresult  SaveRule(nsIOutputStream *aStream);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  nsresult SaveRule(nsIOutputStream *aStream);</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  int16_t   GetVersion();</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  int16_t GetVersion();</span>
<a href="#l9.85"></a><span id="l9.85"> #ifdef DEBUG</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  void      Dump();</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  void Dump();</span>
<a href="#l9.88"></a><span id="l9.88"> #endif</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-  nsresult  ConvertMoveOrCopyToFolderValue(nsIMsgRuleAction *filterAction, nsCString &amp;relativePath);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  nsresult ConvertMoveOrCopyToFolderValue(nsIMsgRuleAction *filterAction,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+                                          nsCString &amp;relativePath);</span>
<a href="#l9.93"></a><span id="l9.93">   static const char *GetActionStr(nsMsgRuleActionType action);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  static nsresult GetActionFilingStr(nsMsgRuleActionType action, nsCString &amp;actionStr);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  static nsresult GetActionFilingStr(nsMsgRuleActionType action,</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+                                     nsCString &amp;actionStr);</span>
<a href="#l9.97"></a><span id="l9.97">   static nsMsgRuleActionType GetActionForFilingStr(nsCString &amp;actionStr);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-protected:</span>
<a href="#l9.99"></a><span id="l9.99"> </span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+ protected:</span>
<a href="#l9.101"></a><span id="l9.101">   /*</span>
<a href="#l9.102"></a><span id="l9.102">    * Reporting function for filtering success/failure.</span>
<a href="#l9.103"></a><span id="l9.103">    * Logging has to be enabled for the message to appear.</span>
<a href="#l9.104"></a><span id="l9.104">    */</span>
<a href="#l9.105"></a><span id="l9.105">   nsresult LogRuleHitGeneric(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-                             nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-                             nsresult aRcode,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+                             nsIMsgDBHdr *aMsgHdr, nsresult aRcode,</span>
<a href="#l9.109"></a><span id="l9.109">                              const nsACString &amp;aErrmsg);</span>
<a href="#l9.110"></a><span id="l9.110"> </span>
<a href="#l9.111"></a><span id="l9.111">   virtual ~nsMsgFilter();</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113">   nsMsgFilterTypeType m_type;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  nsString    m_filterName;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-  nsCString   m_scriptFileName;  // iff this filter is a script.</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-  nsCString   m_description;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-  nsCString   m_unparsedBuffer;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  nsString m_filterName;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  nsCString m_scriptFileName;  // iff this filter is a script.</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  nsCString m_description;</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  nsCString m_unparsedBuffer;</span>
<a href="#l9.122"></a><span id="l9.122"> </span>
<a href="#l9.123"></a><span id="l9.123">   bool m_enabled;</span>
<a href="#l9.124"></a><span id="l9.124">   bool m_temporary;</span>
<a href="#l9.125"></a><span id="l9.125">   bool m_unparseable;</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-  nsIMsgFilterList *m_filterList;  /* owning filter list */</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; m_termList;       /* linked list of criteria terms */</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchScopeTerm&gt; m_scope;         /* default for mail rules is inbox, but news rules could</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-                                                  have a newsgroup - LDAP would be invalid */</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  nsIMsgFilterList *m_filterList;       /* owning filter list */</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; m_termList; /* linked list of criteria terms */</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchScopeTerm&gt;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+      m_scope; /* default for mail rules is inbox, but news rules could</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+              have a newsgroup - LDAP would be invalid */</span>
<a href="#l9.135"></a><span id="l9.135">   nsTArray&lt;nsCOMPtr&lt;nsIMsgRuleAction&gt; &gt; m_actionList;</span>
<a href="#l9.136"></a><span id="l9.136">   nsMsgSearchBoolExpression *m_expressionTree;</span>
<a href="#l9.137"></a><span id="l9.137"> };</span>
<a href="#l9.138"></a><span id="l9.138"> </span>
<a href="#l9.139"></a><span id="l9.139"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -32,1035 +32,961 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #define EOF_CHAR -1</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> using namespace mozilla;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> static uint32_t nextListId = 0;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-nsMsgFilterList::nsMsgFilterList() :</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    m_fileVersion(0)</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-{</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+nsMsgFilterList::nsMsgFilterList() : m_fileVersion(0) {</span>
<a href="#l10.16"></a><span id="l10.16">   m_loggingEnabled = false;</span>
<a href="#l10.17"></a><span id="l10.17">   m_startWritingToBuffer = false;</span>
<a href="#l10.18"></a><span id="l10.18">   m_temporaryList = false;</span>
<a href="#l10.19"></a><span id="l10.19">   m_curFilter = nullptr;</span>
<a href="#l10.20"></a><span id="l10.20">   m_listId.Assign(&quot;List&quot;);</span>
<a href="#l10.21"></a><span id="l10.21">   m_listId.AppendInt(nextListId++);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Creating a new filter list with id=%s&quot;, m_listId.get()));</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+          (&quot;Creating a new filter list with id=%s&quot;, m_listId.get()));</span>
<a href="#l10.25"></a><span id="l10.25"> }</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> NS_IMPL_ADDREF(nsMsgFilterList)</span>
<a href="#l10.28"></a><span id="l10.28"> NS_IMPL_RELEASE(nsMsgFilterList)</span>
<a href="#l10.29"></a><span id="l10.29"> NS_IMPL_QUERY_INTERFACE(nsMsgFilterList, nsIMsgFilterList)</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::CreateFilter(const nsAString &amp;name,class nsIMsgFilter **aFilter)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-{</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::CreateFilter(const nsAString &amp;name,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+                                            class nsIMsgFilter **aFilter) {</span>
<a href="#l10.35"></a><span id="l10.35">   NS_ENSURE_ARG_POINTER(aFilter);</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">   NS_ADDREF(*aFilter = new nsMsgFilter);</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">   (*aFilter)-&gt;SetFilterName(name);</span>
<a href="#l10.40"></a><span id="l10.40">   (*aFilter)-&gt;SetFilterList(this);</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">   return NS_OK;</span>
<a href="#l10.43"></a><span id="l10.43"> }</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45"> NS_IMPL_GETSET(nsMsgFilterList, LoggingEnabled, bool, m_loggingEnabled)</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::GetListId(nsACString &amp;aListId)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-{</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::GetListId(nsACString &amp;aListId) {</span>
<a href="#l10.50"></a><span id="l10.50">   aListId.Assign(m_listId);</span>
<a href="#l10.51"></a><span id="l10.51">   return NS_OK;</span>
<a href="#l10.52"></a><span id="l10.52"> }</span>
<a href="#l10.53"></a><span id="l10.53"> </span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::GetFolder(nsIMsgFolder **aFolder)</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-{</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::GetFolder(nsIMsgFolder **aFolder) {</span>
<a href="#l10.57"></a><span id="l10.57">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l10.60"></a><span id="l10.60">   return NS_OK;</span>
<a href="#l10.61"></a><span id="l10.61"> }</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::SetFolder(nsIMsgFolder *aFolder)</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-{</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::SetFolder(nsIMsgFolder *aFolder) {</span>
<a href="#l10.66"></a><span id="l10.66">   m_folder = aFolder;</span>
<a href="#l10.67"></a><span id="l10.67">   return NS_OK;</span>
<a href="#l10.68"></a><span id="l10.68"> }</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::SaveToFile(nsIOutputStream *stream)</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-{</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  if (!stream)</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::SaveToFile(nsIOutputStream *stream) {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  if (!stream) return NS_ERROR_NULL_POINTER;</span>
<a href="#l10.76"></a><span id="l10.76">   return SaveTextFilters(stream);</span>
<a href="#l10.77"></a><span id="l10.77"> }</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-#define LOG_HEADER &quot;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&lt;style type=\&quot;text/css\&quot;&gt;body{font-family:Consolas,\&quot;Lucida Console\&quot;,Monaco,\&quot;Courier New\&quot;,Courier,monospace;font-size:small}&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&quot;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+#define LOG_HEADER                                                     \</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  &quot;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&lt;style &quot; \</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  &quot;type=\&quot;text/css\&quot;&gt;body{font-family:Consolas,\&quot;Lucida &quot;              \</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+  &quot;Console\&quot;,Monaco,\&quot;Courier &quot;                                        \</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  &quot;New\&quot;,Courier,monospace;font-size:small}&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&quot;</span>
<a href="#l10.85"></a><span id="l10.85"> #define LOG_HEADER_LEN (strlen(LOG_HEADER))</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-nsresult nsMsgFilterList::EnsureLogFile(nsIFile *file)</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-{</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+nsresult nsMsgFilterList::EnsureLogFile(nsIFile *file) {</span>
<a href="#l10.90"></a><span id="l10.90">   bool exists;</span>
<a href="#l10.91"></a><span id="l10.91">   nsresult rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l10.92"></a><span id="l10.92">   if (NS_SUCCEEDED(rv) &amp;&amp; !exists) {</span>
<a href="#l10.93"></a><span id="l10.93">     rv = file-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0666);</span>
<a href="#l10.94"></a><span id="l10.94">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.95"></a><span id="l10.95">   }</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97">   int64_t fileSize;</span>
<a href="#l10.98"></a><span id="l10.98">   rv = file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l10.99"></a><span id="l10.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.100"></a><span id="l10.100"> </span>
<a href="#l10.101"></a><span id="l10.101">   // write the header at the start</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-  if (fileSize == 0)</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-  {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+  if (fileSize == 0) {</span>
<a href="#l10.105"></a><span id="l10.105">     nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l10.106"></a><span id="l10.106">     rv = MsgGetFileStream(file, getter_AddRefs(outputStream));</span>
<a href="#l10.107"></a><span id="l10.107">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.108"></a><span id="l10.108"> </span>
<a href="#l10.109"></a><span id="l10.109">     uint32_t writeCount;</span>
<a href="#l10.110"></a><span id="l10.110">     rv = outputStream-&gt;Write(LOG_HEADER, LOG_HEADER_LEN, &amp;writeCount);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-    NS_ASSERTION(writeCount == LOG_HEADER_LEN, &quot;failed to write out log header&quot;);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+    NS_ASSERTION(writeCount == LOG_HEADER_LEN,</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                 &quot;failed to write out log header&quot;);</span>
<a href="#l10.114"></a><span id="l10.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.115"></a><span id="l10.115">     outputStream-&gt;Close();</span>
<a href="#l10.116"></a><span id="l10.116">   }</span>
<a href="#l10.117"></a><span id="l10.117"> </span>
<a href="#l10.118"></a><span id="l10.118">   return NS_OK;</span>
<a href="#l10.119"></a><span id="l10.119"> }</span>
<a href="#l10.120"></a><span id="l10.120"> </span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-nsresult nsMsgFilterList::TruncateLog()</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-{</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+nsresult nsMsgFilterList::TruncateLog() {</span>
<a href="#l10.124"></a><span id="l10.124">   // This will flush and close the stream.</span>
<a href="#l10.125"></a><span id="l10.125">   nsresult rv = SetLogStream(nullptr);</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l10.131"></a><span id="l10.131">   rv = GetLogFile(getter_AddRefs(file));</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.134"></a><span id="l10.134"> </span>
<a href="#l10.135"></a><span id="l10.135">   file-&gt;Remove(false);</span>
<a href="#l10.136"></a><span id="l10.136"> </span>
<a href="#l10.137"></a><span id="l10.137">   return EnsureLogFile(file);</span>
<a href="#l10.138"></a><span id="l10.138"> }</span>
<a href="#l10.139"></a><span id="l10.139"> </span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::ClearLog()</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-{</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::ClearLog() {</span>
<a href="#l10.143"></a><span id="l10.143">   bool loggingEnabled = m_loggingEnabled;</span>
<a href="#l10.144"></a><span id="l10.144"> </span>
<a href="#l10.145"></a><span id="l10.145">   // disable logging while clearing</span>
<a href="#l10.146"></a><span id="l10.146">   m_loggingEnabled = false;</span>
<a href="#l10.147"></a><span id="l10.147"> </span>
<a href="#l10.148"></a><span id="l10.148"> #ifdef DEBUG</span>
<a href="#l10.149"></a><span id="l10.149">   nsresult rv =</span>
<a href="#l10.150"></a><span id="l10.150"> #endif</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-    TruncateLog();</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+      TruncateLog();</span>
<a href="#l10.153"></a><span id="l10.153">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to truncate filter log&quot;);</span>
<a href="#l10.154"></a><span id="l10.154"> </span>
<a href="#l10.155"></a><span id="l10.155">   m_loggingEnabled = loggingEnabled;</span>
<a href="#l10.156"></a><span id="l10.156"> </span>
<a href="#l10.157"></a><span id="l10.157">   return NS_OK;</span>
<a href="#l10.158"></a><span id="l10.158"> }</span>
<a href="#l10.159"></a><span id="l10.159"> </span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-nsresult</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-nsMsgFilterList::GetLogFile(nsIFile **aFile)</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-{</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+nsresult nsMsgFilterList::GetLogFile(nsIFile **aFile) {</span>
<a href="#l10.164"></a><span id="l10.164">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l10.165"></a><span id="l10.165"> </span>
<a href="#l10.166"></a><span id="l10.166">   // XXX todo</span>
<a href="#l10.167"></a><span id="l10.167">   // the path to the log file won't change</span>
<a href="#l10.168"></a><span id="l10.168">   // should we cache it?</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.171"></a><span id="l10.171">   nsresult rv = GetFolder(getter_AddRefs(folder));</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.174"></a><span id="l10.174"> </span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.177"></a><span id="l10.177">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.180"></a><span id="l10.180"> </span>
<a href="#l10.181"></a><span id="l10.181">   nsCString type;</span>
<a href="#l10.182"></a><span id="l10.182">   rv = server-&gt;GetType(type);</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.185"></a><span id="l10.185"> </span>
<a href="#l10.186"></a><span id="l10.186">   bool isServer = false;</span>
<a href="#l10.187"></a><span id="l10.187">   rv = folder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.190"></a><span id="l10.190"> </span>
<a href="#l10.191"></a><span id="l10.191">   // for news folders (not servers), the filter file is</span>
<a href="#l10.192"></a><span id="l10.192">   // mcom.test.dat</span>
<a href="#l10.193"></a><span id="l10.193">   // where the summary file is</span>
<a href="#l10.194"></a><span id="l10.194">   // mcom.test.msf</span>
<a href="#l10.195"></a><span id="l10.195">   // since the log is an html file we make it</span>
<a href="#l10.196"></a><span id="l10.196">   // mcom.test.htm</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-  if (type.EqualsLiteral(&quot;nntp&quot;) &amp;&amp; !isServer)</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-  {</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+  if (type.EqualsLiteral(&quot;nntp&quot;) &amp;&amp; !isServer) {</span>
<a href="#l10.200"></a><span id="l10.200">     nsCOMPtr&lt;nsIFile&gt; thisFolder;</span>
<a href="#l10.201"></a><span id="l10.201">     rv = m_folder-&gt;GetFilePath(getter_AddRefs(thisFolder));</span>
<a href="#l10.202"></a><span id="l10.202">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.203"></a><span id="l10.203"> </span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; filterLogFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; filterLogFile =</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+        do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.207"></a><span id="l10.207">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.208"></a><span id="l10.208">     rv = filterLogFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l10.209"></a><span id="l10.209">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.210"></a><span id="l10.210"> </span>
<a href="#l10.211"></a><span id="l10.211">     // NOTE:</span>
<a href="#l10.212"></a><span id="l10.212">     // we don't we need to call NS_MsgHashIfNecessary()</span>
<a href="#l10.213"></a><span id="l10.213">     // it's already been hashed, if necessary</span>
<a href="#l10.214"></a><span id="l10.214">     nsAutoString filterLogName;</span>
<a href="#l10.215"></a><span id="l10.215">     rv = filterLogFile-&gt;GetLeafName(filterLogName);</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219">     filterLogName.AppendLiteral(u&quot;.htm&quot;);</span>
<a href="#l10.220"></a><span id="l10.220"> </span>
<a href="#l10.221"></a><span id="l10.221">     rv = filterLogFile-&gt;SetLeafName(filterLogName);</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.224"></a><span id="l10.224"> </span>
<a href="#l10.225"></a><span id="l10.225">     filterLogFile.forget(aFile);</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-  }</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-  else {</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+  } else {</span>
<a href="#l10.229"></a><span id="l10.229">     rv = server-&gt;GetLocalPath(aFile);</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.232"></a><span id="l10.232"> </span>
<a href="#l10.233"></a><span id="l10.233">     rv = (*aFile)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;filterlog.html&quot;));</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.236"></a><span id="l10.236">   }</span>
<a href="#l10.237"></a><span id="l10.237">   return EnsureLogFile(*aFile);</span>
<a href="#l10.238"></a><span id="l10.238"> }</span>
<a href="#l10.239"></a><span id="l10.239"> </span>
<a href="#l10.240"></a><span id="l10.240"> NS_IMETHODIMP</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-nsMsgFilterList::GetLogURL(nsACString &amp;aLogURL)</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-{</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+nsMsgFilterList::GetLogURL(nsACString &amp;aLogURL) {</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l10.246"></a><span id="l10.246">   nsresult rv = GetLogFile(getter_AddRefs(file));</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.249"></a><span id="l10.249"> </span>
<a href="#l10.250"></a><span id="l10.250">   rv = NS_GetURLSpecFromFile(file, aLogURL);</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.253"></a><span id="l10.253"> </span>
<a href="#l10.254"></a><span id="l10.254">   return !aLogURL.IsEmpty() ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.255"></a><span id="l10.255"> }</span>
<a href="#l10.256"></a><span id="l10.256"> </span>
<a href="#l10.257"></a><span id="l10.257"> NS_IMETHODIMP</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-nsMsgFilterList::SetLogStream(nsIOutputStream *aLogStream)</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-{</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+nsMsgFilterList::SetLogStream(nsIOutputStream *aLogStream) {</span>
<a href="#l10.261"></a><span id="l10.261">   // if there is a log stream already, close it</span>
<a href="#l10.262"></a><span id="l10.262">   if (m_logStream) {</span>
<a href="#l10.263"></a><span id="l10.263">     // will flush</span>
<a href="#l10.264"></a><span id="l10.264">     nsresult rv = m_logStream-&gt;Close();</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.267"></a><span id="l10.267">   }</span>
<a href="#l10.268"></a><span id="l10.268"> </span>
<a href="#l10.269"></a><span id="l10.269">   m_logStream = aLogStream;</span>
<a href="#l10.270"></a><span id="l10.270">   return NS_OK;</span>
<a href="#l10.271"></a><span id="l10.271"> }</span>
<a href="#l10.272"></a><span id="l10.272"> </span>
<a href="#l10.273"></a><span id="l10.273"> NS_IMETHODIMP</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-nsMsgFilterList::GetLogStream(nsIOutputStream **aLogStream)</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-{</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+nsMsgFilterList::GetLogStream(nsIOutputStream **aLogStream) {</span>
<a href="#l10.277"></a><span id="l10.277">   NS_ENSURE_ARG_POINTER(aLogStream);</span>
<a href="#l10.278"></a><span id="l10.278"> </span>
<a href="#l10.279"></a><span id="l10.279">   nsresult rv;</span>
<a href="#l10.280"></a><span id="l10.280"> </span>
<a href="#l10.281"></a><span id="l10.281">   if (!m_logStream) {</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; logFile;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; logFile;</span>
<a href="#l10.284"></a><span id="l10.284">     rv = GetLogFile(getter_AddRefs(logFile));</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.287"></a><span id="l10.287"> </span>
<a href="#l10.288"></a><span id="l10.288">     // append to the end of the log file</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_logStream),</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-                                        logFile,</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_logStream), logFile,</span>
<a href="#l10.292"></a><span id="l10.292">                                         PR_CREATE_FILE | PR_WRONLY | PR_APPEND,</span>
<a href="#l10.293"></a><span id="l10.293">                                         0666);</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.296"></a><span id="l10.296"> </span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-    if (!m_logStream)</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+    if (!m_logStream) return NS_ERROR_FAILURE;</span>
<a href="#l10.300"></a><span id="l10.300">   }</span>
<a href="#l10.301"></a><span id="l10.301"> </span>
<a href="#l10.302"></a><span id="l10.302">   NS_ADDREF(*aLogStream = m_logStream);</span>
<a href="#l10.303"></a><span id="l10.303">   return NS_OK;</span>
<a href="#l10.304"></a><span id="l10.304"> }</span>
<a href="#l10.305"></a><span id="l10.305"> </span>
<a href="#l10.306"></a><span id="l10.306"> NS_IMETHODIMP</span>
<a href="#l10.307"></a><span id="l10.307"> nsMsgFilterList::ApplyFiltersToHdr(nsMsgFilterTypeType filterType,</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-                                   nsIMsgDBHdr *msgHdr,</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-                                   nsIMsgFolder *folder,</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+                                   nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder,</span>
<a href="#l10.311"></a><span id="l10.311">                                    nsIMsgDatabase *db,</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-                                   const nsACString&amp; headers,</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+                                   const nsACString &amp;headers,</span>
<a href="#l10.314"></a><span id="l10.314">                                    nsIMsgFilterHitNotify *listener,</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-                                   nsIMsgWindow *msgWindow)</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-{</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Auto) nsMsgFilterList::ApplyFiltersToHdr&quot;));</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+                                   nsIMsgWindow *msgWindow) {</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+          (&quot;(Auto) nsMsgFilterList::ApplyFiltersToHdr&quot;));</span>
<a href="#l10.321"></a><span id="l10.321">   nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.322"></a><span id="l10.322">   uint32_t filterCount = 0;</span>
<a href="#l10.323"></a><span id="l10.323">   nsresult rv = GetFilterCount(&amp;filterCount);</span>
<a href="#l10.324"></a><span id="l10.324">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.325"></a><span id="l10.325"> </span>
<a href="#l10.326"></a><span id="l10.326">   RefPtr&lt;nsMsgSearchScopeTerm&gt; scope =</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-    new nsMsgSearchScopeTerm(nullptr, nsMsgSearchScope::offlineMail, folder);</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+      new nsMsgSearchScopeTerm(nullptr, nsMsgSearchScope::offlineMail, folder);</span>
<a href="#l10.329"></a><span id="l10.329"> </span>
<a href="#l10.330"></a><span id="l10.330">   nsString folderName;</span>
<a href="#l10.331"></a><span id="l10.331">   folder-&gt;GetName(folderName);</span>
<a href="#l10.332"></a><span id="l10.332">   nsMsgKey msgKey;</span>
<a href="#l10.333"></a><span id="l10.333">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.334"></a><span id="l10.334">   nsCString typeName;</span>
<a href="#l10.335"></a><span id="l10.335">   nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-    do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+      do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.338"></a><span id="l10.338">   filterService-&gt;FilterTypeName(filterType, typeName);</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(), filterType));</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Running %&quot; PRIu32 &quot; filters from %s on message with key %&quot; PRIu32 &quot; in folder '%s'&quot;,</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-                                            filterCount, m_listId.get(), msgKeyToInt(msgKey), NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+          (&quot;(Auto) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(),</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+           filterType));</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+          (&quot;(Auto) Running %&quot; PRIu32</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+           &quot; filters from %s on message with key %&quot; PRIu32 &quot; in folder '%s'&quot;,</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+           filterCount, m_listId.get(), msgKeyToInt(msgKey),</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+           NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l10.350"></a><span id="l10.350"> </span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-  for (uint32_t filterIndex = 0; filterIndex &lt; filterCount; filterIndex++)</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-  {</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-    if (NS_SUCCEEDED(GetFilterAt(filterIndex, getter_AddRefs(filter))))</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-    {</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+  for (uint32_t filterIndex = 0; filterIndex &lt; filterCount; filterIndex++) {</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+    if (NS_SUCCEEDED(GetFilterAt(filterIndex, getter_AddRefs(filter)))) {</span>
<a href="#l10.357"></a><span id="l10.357">       bool isEnabled;</span>
<a href="#l10.358"></a><span id="l10.358">       nsMsgFilterTypeType curFilterType;</span>
<a href="#l10.359"></a><span id="l10.359"> </span>
<a href="#l10.360"></a><span id="l10.360">       filter-&gt;GetEnabled(&amp;isEnabled);</span>
<a href="#l10.361"></a><span id="l10.361">       if (!isEnabled) {</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Skipping disabled filter at index %&quot; PRIu32, filterIndex));</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+        MOZ_LOG(</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+            FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+            (&quot;(Auto) Skipping disabled filter at index %&quot; PRIu32, filterIndex));</span>
<a href="#l10.366"></a><span id="l10.366">         continue;</span>
<a href="#l10.367"></a><span id="l10.367">       }</span>
<a href="#l10.368"></a><span id="l10.368"> </span>
<a href="#l10.369"></a><span id="l10.369">       nsString filterName;</span>
<a href="#l10.370"></a><span id="l10.370">       filter-&gt;GetFilterName(filterName);</span>
<a href="#l10.371"></a><span id="l10.371">       filter-&gt;GetFilterType(&amp;curFilterType);</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineminus">-      if (curFilterType &amp; filterType)</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-      {</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Running filter %&quot; PRIu32, filterIndex));</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Auto) Filter name: %s&quot;,</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineminus">-                                                   NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+      if (curFilterType &amp; filterType) {</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+                (&quot;(Auto) Running filter %&quot; PRIu32, filterIndex));</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+                (&quot;(Auto) Filter name: %s&quot;,</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+                 NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l10.383"></a><span id="l10.383"> </span>
<a href="#l10.384"></a><span id="l10.384">         nsresult matchTermStatus = NS_OK;</span>
<a href="#l10.385"></a><span id="l10.385">         bool result;</span>
<a href="#l10.386"></a><span id="l10.386"> </span>
<a href="#l10.387"></a><span id="l10.387">         filter-&gt;SetScope(scope);</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-        matchTermStatus = filter-&gt;MatchHdr(msgHdr, folder, db, headers, &amp;result);</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+        matchTermStatus =</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+            filter-&gt;MatchHdr(msgHdr, folder, db, headers, &amp;result);</span>
<a href="#l10.391"></a><span id="l10.391">         filter-&gt;SetScope(nullptr);</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-        if (NS_SUCCEEDED(matchTermStatus) &amp;&amp; result &amp;&amp; listener)</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-        {</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+        if (NS_SUCCEEDED(matchTermStatus) &amp;&amp; result &amp;&amp; listener) {</span>
<a href="#l10.395"></a><span id="l10.395">           nsCString msgId;</span>
<a href="#l10.396"></a><span id="l10.396">           msgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-          MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Filter matched message with key %&quot; PRIu32,</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-                                                    msgKeyToInt(msgKey)));</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-          MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Auto) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+                  (&quot;(Auto) Filter matched message with key %&quot; PRIu32,</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+                   msgKeyToInt(msgKey)));</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+                  (&quot;(Auto) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l10.405"></a><span id="l10.405"> </span>
<a href="#l10.406"></a><span id="l10.406">           bool applyMore = true;</span>
<a href="#l10.407"></a><span id="l10.407">           rv = listener-&gt;ApplyFilterHit(filter, msgWindow, &amp;applyMore);</span>
<a href="#l10.408"></a><span id="l10.408">           if (NS_FAILED(rv) || !applyMore) {</span>
<a href="#l10.409"></a><span id="l10.409">             if (NS_FAILED(rv)) {</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-              MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Auto) Applying filter actions failed&quot;));</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-              LogFilterMessage(NS_LITERAL_STRING(&quot;Applying filter actions failed&quot;), filter);</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+              MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+                      (&quot;(Auto) Applying filter actions failed&quot;));</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+              LogFilterMessage(</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineplus">+                  NS_LITERAL_STRING(&quot;Applying filter actions failed&quot;), filter);</span>
<a href="#l10.416"></a><span id="l10.416">             }</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Stopping further filter execution on this message&quot;));</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+            MOZ_LOG(</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineplus">+                FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+                (&quot;(Auto) Stopping further filter execution on this message&quot;));</span>
<a href="#l10.421"></a><span id="l10.421">             break;</span>
<a href="#l10.422"></a><span id="l10.422">           }</span>
<a href="#l10.423"></a><span id="l10.423">         } else {</span>
<a href="#l10.424"></a><span id="l10.424">           if (NS_FAILED(matchTermStatus)) {</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Auto) Filter evaluation failed&quot;));</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineminus">-            LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;), filter);</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+                    (&quot;(Auto) Filter evaluation failed&quot;));</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+            LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;),</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineplus">+                             filter);</span>
<a href="#l10.431"></a><span id="l10.431">           }</span>
<a href="#l10.432"></a><span id="l10.432">           if (!result)</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Filter didn't match&quot;));</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineplus">+                    (&quot;(Auto) Filter didn't match&quot;));</span>
<a href="#l10.436"></a><span id="l10.436">         }</span>
<a href="#l10.437"></a><span id="l10.437">       } else {</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Skipping filter of non-matching type at index %&quot; PRIu32, filterIndex));</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+        MOZ_LOG(</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineplus">+            FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+            (&quot;(Auto) Skipping filter of non-matching type at index %&quot; PRIu32,</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineplus">+             filterIndex));</span>
<a href="#l10.443"></a><span id="l10.443">       }</span>
<a href="#l10.444"></a><span id="l10.444">     }</span>
<a href="#l10.445"></a><span id="l10.445">   }</span>
<a href="#l10.446"></a><span id="l10.446">   if (NS_FAILED(rv)) {</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Auto) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+    MOZ_LOG(</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineplus">+        FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+        (&quot;(Auto) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l10.451"></a><span id="l10.451">     LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;), nullptr);</span>
<a href="#l10.452"></a><span id="l10.452">   }</span>
<a href="#l10.453"></a><span id="l10.453">   return rv;</span>
<a href="#l10.454"></a><span id="l10.454"> }</span>
<a href="#l10.455"></a><span id="l10.455"> </span>
<a href="#l10.456"></a><span id="l10.456"> NS_IMETHODIMP</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-nsMsgFilterList::SetDefaultFile(nsIFile *aFile)</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineminus">-{</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineplus">+nsMsgFilterList::SetDefaultFile(nsIFile *aFile) {</span>
<a href="#l10.460"></a><span id="l10.460">   m_defaultFile = aFile;</span>
<a href="#l10.461"></a><span id="l10.461">   return NS_OK;</span>
<a href="#l10.462"></a><span id="l10.462"> }</span>
<a href="#l10.463"></a><span id="l10.463"> </span>
<a href="#l10.464"></a><span id="l10.464"> NS_IMETHODIMP</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-nsMsgFilterList::GetDefaultFile(nsIFile **aResult)</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-{</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+nsMsgFilterList::GetDefaultFile(nsIFile **aResult) {</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.470"></a><span id="l10.470"> </span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-    NS_IF_ADDREF(*aResult = m_defaultFile);</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+  NS_IF_ADDREF(*aResult = m_defaultFile);</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.475"></a><span id="l10.475"> }</span>
<a href="#l10.476"></a><span id="l10.476"> </span>
<a href="#l10.477"></a><span id="l10.477"> NS_IMETHODIMP</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineminus">-nsMsgFilterList::SaveToDefaultFile()</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineminus">-{</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineminus">-    nsresult rv;</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+nsMsgFilterList::SaveToDefaultFile() {</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+      do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.489"></a><span id="l10.489"> </span>
<a href="#l10.490"></a><span id="l10.490" class="difflineminus">-    return filterService-&gt;SaveFilterList(this, m_defaultFile);</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+  return filterService-&gt;SaveFilterList(this, m_defaultFile);</span>
<a href="#l10.492"></a><span id="l10.492"> }</span>
<a href="#l10.493"></a><span id="l10.493"> </span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-typedef struct</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-{</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-  nsMsgFilterFileAttribValue  attrib;</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-  const char      *attribName;</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+typedef struct {</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+  nsMsgFilterFileAttribValue attrib;</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+  const char *attribName;</span>
<a href="#l10.501"></a><span id="l10.501"> } FilterFileAttribEntry;</span>
<a href="#l10.502"></a><span id="l10.502"> </span>
<a href="#l10.503"></a><span id="l10.503" class="difflineminus">-static FilterFileAttribEntry FilterFileAttribTable[] =</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineminus">-{</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-  {nsIMsgFilterList::attribNone,      &quot;&quot;},</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-  {nsIMsgFilterList::attribVersion,    &quot;version&quot;},</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-  {nsIMsgFilterList::attribLogging,    &quot;logging&quot;},</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineminus">-  {nsIMsgFilterList::attribName,      &quot;name&quot;},</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineminus">-  {nsIMsgFilterList::attribEnabled,    &quot;enabled&quot;},</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineminus">-  {nsIMsgFilterList::attribDescription,  &quot;description&quot;},</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineminus">-  {nsIMsgFilterList::attribType,      &quot;type&quot;},</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-  {nsIMsgFilterList::attribScriptFile,  &quot;scriptName&quot;},</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-  {nsIMsgFilterList::attribAction,    &quot;action&quot;},</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-  {nsIMsgFilterList::attribActionValue,  &quot;actionValue&quot;},</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineminus">-  {nsIMsgFilterList::attribCondition,    &quot;condition&quot;},</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineminus">-  {nsIMsgFilterList::attribCustomId,  &quot;customId&quot;},</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+static FilterFileAttribEntry FilterFileAttribTable[] = {</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineplus">+    {nsIMsgFilterList::attribNone, &quot;&quot;},</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineplus">+    {nsIMsgFilterList::attribVersion, &quot;version&quot;},</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+    {nsIMsgFilterList::attribLogging, &quot;logging&quot;},</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineplus">+    {nsIMsgFilterList::attribName, &quot;name&quot;},</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+    {nsIMsgFilterList::attribEnabled, &quot;enabled&quot;},</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+    {nsIMsgFilterList::attribDescription, &quot;description&quot;},</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+    {nsIMsgFilterList::attribType, &quot;type&quot;},</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+    {nsIMsgFilterList::attribScriptFile, &quot;scriptName&quot;},</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineplus">+    {nsIMsgFilterList::attribAction, &quot;action&quot;},</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineplus">+    {nsIMsgFilterList::attribActionValue, &quot;actionValue&quot;},</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineplus">+    {nsIMsgFilterList::attribCondition, &quot;condition&quot;},</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+    {nsIMsgFilterList::attribCustomId, &quot;customId&quot;},</span>
<a href="#l10.530"></a><span id="l10.530"> };</span>
<a href="#l10.531"></a><span id="l10.531"> </span>
<a href="#l10.532"></a><span id="l10.532"> static const unsigned int sNumFilterFileAttribTable =</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-  MOZ_ARRAY_LENGTH(FilterFileAttribTable);</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineplus">+    MOZ_ARRAY_LENGTH(FilterFileAttribTable);</span>
<a href="#l10.535"></a><span id="l10.535"> </span>
<a href="#l10.536"></a><span id="l10.536"> // If we want to buffer file IO, wrap it in here.</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineminus">-int nsMsgFilterList::ReadChar(nsIInputStream *aStream)</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineminus">-{</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineminus">-  char  newChar;</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineplus">+int nsMsgFilterList::ReadChar(nsIInputStream *aStream) {</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineplus">+  char newChar;</span>
<a href="#l10.542"></a><span id="l10.542">   uint32_t bytesRead;</span>
<a href="#l10.543"></a><span id="l10.543">   nsresult rv = aStream-&gt;Read(&amp;newChar, 1, &amp;bytesRead);</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineminus">-  if (NS_FAILED(rv) || !bytesRead)</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineminus">-    return EOF_CHAR;</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineplus">+  if (NS_FAILED(rv) || !bytesRead) return EOF_CHAR;</span>
<a href="#l10.547"></a><span id="l10.547">   uint64_t bytesAvailable;</span>
<a href="#l10.548"></a><span id="l10.548">   rv = aStream-&gt;Available(&amp;bytesAvailable);</span>
<a href="#l10.549"></a><span id="l10.549">   if (NS_FAILED(rv))</span>
<a href="#l10.550"></a><span id="l10.550">     return EOF_CHAR;</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-  else</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-  {</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-    if (m_startWritingToBuffer)</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineminus">-      m_unparsedFilterBuffer.Append(newChar);</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineminus">-    return (unsigned char)newChar; // Make sure the char is unsigned.</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineplus">+  else {</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineplus">+    if (m_startWritingToBuffer) m_unparsedFilterBuffer.Append(newChar);</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+    return (unsigned char)newChar;  // Make sure the char is unsigned.</span>
<a href="#l10.559"></a><span id="l10.559">   }</span>
<a href="#l10.560"></a><span id="l10.560"> }</span>
<a href="#l10.561"></a><span id="l10.561"> </span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-int nsMsgFilterList::SkipWhitespace(nsIInputStream *aStream)</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineminus">-{</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineplus">+int nsMsgFilterList::SkipWhitespace(nsIInputStream *aStream) {</span>
<a href="#l10.565"></a><span id="l10.565">   int ch;</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-  do</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-  {</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineplus">+  do {</span>
<a href="#l10.569"></a><span id="l10.569">     ch = ReadChar(aStream);</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-  } while (!(ch &amp; 0x80) &amp;&amp; isspace(ch)); // isspace can crash with non-ascii input</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+  } while (!(ch &amp; 0x80) &amp;&amp;</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+           isspace(ch));  // isspace can crash with non-ascii input</span>
<a href="#l10.573"></a><span id="l10.573"> </span>
<a href="#l10.574"></a><span id="l10.574">   return ch;</span>
<a href="#l10.575"></a><span id="l10.575"> }</span>
<a href="#l10.576"></a><span id="l10.576"> </span>
<a href="#l10.577"></a><span id="l10.577" class="difflineminus">-bool nsMsgFilterList::StrToBool(nsCString &amp;str)</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineminus">-{</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineplus">+bool nsMsgFilterList::StrToBool(nsCString &amp;str) {</span>
<a href="#l10.580"></a><span id="l10.580">   return str.EqualsLiteral(&quot;yes&quot;);</span>
<a href="#l10.581"></a><span id="l10.581"> }</span>
<a href="#l10.582"></a><span id="l10.582"> </span>
<a href="#l10.583"></a><span id="l10.583" class="difflineminus">-int nsMsgFilterList::LoadAttrib(nsMsgFilterFileAttribValue &amp;attrib, nsIInputStream *aStream)</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineminus">-{</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-  char  attribStr[100];</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+int nsMsgFilterList::LoadAttrib(nsMsgFilterFileAttribValue &amp;attrib,</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineplus">+                                nsIInputStream *aStream) {</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineplus">+  char attribStr[100];</span>
<a href="#l10.589"></a><span id="l10.589">   int curChar;</span>
<a href="#l10.590"></a><span id="l10.590">   attrib = nsIMsgFilterList::attribNone;</span>
<a href="#l10.591"></a><span id="l10.591"> </span>
<a href="#l10.592"></a><span id="l10.592">   curChar = SkipWhitespace(aStream);</span>
<a href="#l10.593"></a><span id="l10.593">   int i;</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-  for (i = 0; i + 1 &lt; (int)(sizeof(attribStr)); )</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-  {</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-    if (curChar == EOF_CHAR || (!(curChar &amp; 0x80) &amp;&amp; isspace(curChar)) || curChar == '=')</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+  for (i = 0; i + 1 &lt; (int)(sizeof(attribStr));) {</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+    if (curChar == EOF_CHAR || (!(curChar &amp; 0x80) &amp;&amp; isspace(curChar)) ||</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+        curChar == '=')</span>
<a href="#l10.600"></a><span id="l10.600">       break;</span>
<a href="#l10.601"></a><span id="l10.601">     attribStr[i++] = curChar;</span>
<a href="#l10.602"></a><span id="l10.602">     curChar = ReadChar(aStream);</span>
<a href="#l10.603"></a><span id="l10.603">   }</span>
<a href="#l10.604"></a><span id="l10.604">   attribStr[i] = '\0';</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-  for (unsigned int tableIndex = 0; tableIndex &lt; sNumFilterFileAttribTable; tableIndex++)</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-  {</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineminus">-    if (!PL_strcasecmp(attribStr, FilterFileAttribTable[tableIndex].attribName))</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineminus">-    {</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineplus">+  for (unsigned int tableIndex = 0; tableIndex &lt; sNumFilterFileAttribTable;</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineplus">+       tableIndex++) {</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+    if (!PL_strcasecmp(attribStr,</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineplus">+                       FilterFileAttribTable[tableIndex].attribName)) {</span>
<a href="#l10.613"></a><span id="l10.613">       attrib = FilterFileAttribTable[tableIndex].attrib;</span>
<a href="#l10.614"></a><span id="l10.614">       break;</span>
<a href="#l10.615"></a><span id="l10.615">     }</span>
<a href="#l10.616"></a><span id="l10.616">   }</span>
<a href="#l10.617"></a><span id="l10.617">   return curChar;</span>
<a href="#l10.618"></a><span id="l10.618"> }</span>
<a href="#l10.619"></a><span id="l10.619"> </span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-const char *nsMsgFilterList::GetStringForAttrib(nsMsgFilterFileAttribValue attrib)</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-{</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-  for (unsigned int tableIndex = 0; tableIndex &lt; sNumFilterFileAttribTable; tableIndex++)</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-  {</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineplus">+const char *nsMsgFilterList::GetStringForAttrib(</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineplus">+    nsMsgFilterFileAttribValue attrib) {</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineplus">+  for (unsigned int tableIndex = 0; tableIndex &lt; sNumFilterFileAttribTable;</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+       tableIndex++) {</span>
<a href="#l10.628"></a><span id="l10.628">     if (attrib == FilterFileAttribTable[tableIndex].attrib)</span>
<a href="#l10.629"></a><span id="l10.629">       return FilterFileAttribTable[tableIndex].attribName;</span>
<a href="#l10.630"></a><span id="l10.630">   }</span>
<a href="#l10.631"></a><span id="l10.631">   return nullptr;</span>
<a href="#l10.632"></a><span id="l10.632"> }</span>
<a href="#l10.633"></a><span id="l10.633"> </span>
<a href="#l10.634"></a><span id="l10.634" class="difflineminus">-nsresult nsMsgFilterList::LoadValue(nsCString &amp;value, nsIInputStream *aStream)</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineminus">-{</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineminus">-  nsAutoCString  valueStr;</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineplus">+nsresult nsMsgFilterList::LoadValue(nsCString &amp;value, nsIInputStream *aStream) {</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineplus">+  nsAutoCString valueStr;</span>
<a href="#l10.639"></a><span id="l10.639">   int curChar;</span>
<a href="#l10.640"></a><span id="l10.640">   value = &quot;&quot;;</span>
<a href="#l10.641"></a><span id="l10.641">   curChar = SkipWhitespace(aStream);</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineminus">-  if (curChar != '&quot;')</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineminus">-  {</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineplus">+  if (curChar != '&quot;') {</span>
<a href="#l10.645"></a><span id="l10.645">     NS_ASSERTION(false, &quot;expecting quote as start of value&quot;);</span>
<a href="#l10.646"></a><span id="l10.646">     return NS_MSG_FILTER_PARSE_ERROR;</span>
<a href="#l10.647"></a><span id="l10.647">   }</span>
<a href="#l10.648"></a><span id="l10.648">   curChar = ReadChar(aStream);</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-  do</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-  {</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineminus">-    if (curChar == '\\')</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineminus">-    {</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineplus">+  do {</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineplus">+    if (curChar == '\\') {</span>
<a href="#l10.655"></a><span id="l10.655">       int nextChar = ReadChar(aStream);</span>
<a href="#l10.656"></a><span id="l10.656">       if (nextChar == '&quot;')</span>
<a href="#l10.657"></a><span id="l10.657">         curChar = '&quot;';</span>
<a href="#l10.658"></a><span id="l10.658">       else if (nextChar == '\\')  // replace &quot;\\&quot; with &quot;\&quot;</span>
<a href="#l10.659"></a><span id="l10.659">       {</span>
<a href="#l10.660"></a><span id="l10.660">         valueStr += curChar;</span>
<a href="#l10.661"></a><span id="l10.661">         curChar = ReadChar(aStream);</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineminus">-      }</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineminus">-      else</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineminus">-      {</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineplus">+      } else {</span>
<a href="#l10.666"></a><span id="l10.666">         valueStr += curChar;</span>
<a href="#l10.667"></a><span id="l10.667">         curChar = nextChar;</span>
<a href="#l10.668"></a><span id="l10.668">       }</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineminus">-    }</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineminus">-    else</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineminus">-    {</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineminus">-      if (curChar == EOF_CHAR || curChar == '&quot;' || curChar == '\n' || curChar == '\r')</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineminus">-      {</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineplus">+    } else {</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineplus">+      if (curChar == EOF_CHAR || curChar == '&quot;' || curChar == '\n' ||</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineplus">+          curChar == '\r') {</span>
<a href="#l10.677"></a><span id="l10.677">         value += valueStr;</span>
<a href="#l10.678"></a><span id="l10.678">         break;</span>
<a href="#l10.679"></a><span id="l10.679">       }</span>
<a href="#l10.680"></a><span id="l10.680">     }</span>
<a href="#l10.681"></a><span id="l10.681">     valueStr += curChar;</span>
<a href="#l10.682"></a><span id="l10.682">     curChar = ReadChar(aStream);</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineminus">-  }</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineminus">-  while (curChar != EOF_CHAR);</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+  } while (curChar != EOF_CHAR);</span>
<a href="#l10.686"></a><span id="l10.686">   return NS_OK;</span>
<a href="#l10.687"></a><span id="l10.687"> }</span>
<a href="#l10.688"></a><span id="l10.688"> </span>
<a href="#l10.689"></a><span id="l10.689" class="difflineminus">-nsresult nsMsgFilterList::LoadTextFilters(already_AddRefed&lt;nsIInputStream&gt; aStream)</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineminus">-{</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineplus">+nsresult nsMsgFilterList::LoadTextFilters(</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineplus">+    already_AddRefed&lt;nsIInputStream&gt; aStream) {</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l10.695"></a><span id="l10.695">   uint64_t bytesAvailable;</span>
<a href="#l10.696"></a><span id="l10.696"> </span>
<a href="#l10.697"></a><span id="l10.697">   nsCOMPtr&lt;nsIInputStream&gt; bufStream;</span>
<a href="#l10.698"></a><span id="l10.698">   nsCOMPtr&lt;nsIInputStream&gt; stream = std::move(aStream);</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineminus">-  err = NS_NewBufferedInputStream(getter_AddRefs(bufStream), stream.forget(), FILE_IO_BUFFER_SIZE);</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineplus">+  err = NS_NewBufferedInputStream(getter_AddRefs(bufStream), stream.forget(),</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineplus">+                                  FILE_IO_BUFFER_SIZE);</span>
<a href="#l10.702"></a><span id="l10.702">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.703"></a><span id="l10.703"> </span>
<a href="#l10.704"></a><span id="l10.704">   nsMsgFilterFileAttribValue attrib;</span>
<a href="#l10.705"></a><span id="l10.705">   nsCOMPtr&lt;nsIMsgRuleAction&gt; currentFilterAction;</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineminus">-  // We'd really like to move lot's of these into the objects that they refer to.</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineminus">-  do</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineminus">-  {</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+  // We'd really like to move lot's of these into the objects that they refer</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineplus">+  // to.</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineplus">+  do {</span>
<a href="#l10.712"></a><span id="l10.712">     nsAutoCString value;</span>
<a href="#l10.713"></a><span id="l10.713">     nsresult intToStringResult;</span>
<a href="#l10.714"></a><span id="l10.714"> </span>
<a href="#l10.715"></a><span id="l10.715">     int curChar;</span>
<a href="#l10.716"></a><span id="l10.716">     curChar = LoadAttrib(attrib, bufStream);</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineminus">-    if (curChar == EOF_CHAR)  //reached eof</span>
<a href="#l10.718"></a><span id="l10.718" class="difflineplus">+    if (curChar == EOF_CHAR)  // reached eof</span>
<a href="#l10.719"></a><span id="l10.719">       break;</span>
<a href="#l10.720"></a><span id="l10.720">     err = LoadValue(value, bufStream);</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineminus">-    if (NS_FAILED(err))</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineminus">-      break;</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineplus">+    if (NS_FAILED(err)) break;</span>
<a href="#l10.724"></a><span id="l10.724"> </span>
<a href="#l10.725"></a><span id="l10.725" class="difflineminus">-    switch(attrib)</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineminus">-    {</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineminus">-    case nsIMsgFilterList::attribNone:</span>
<a href="#l10.728"></a><span id="l10.728" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineminus">-        m_curFilter-&gt;SetUnparseable(true);</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineminus">-      break;</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineminus">-    case nsIMsgFilterList::attribVersion:</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineminus">-      m_fileVersion = value.ToInteger(&amp;intToStringResult);</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineminus">-      if (NS_FAILED(intToStringResult))</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineplus">+    switch (attrib) {</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineplus">+      case nsIMsgFilterList::attribNone:</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineplus">+        if (m_curFilter) m_curFilter-&gt;SetUnparseable(true);</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineplus">+        break;</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineplus">+      case nsIMsgFilterList::attribVersion:</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineplus">+        m_fileVersion = value.ToInteger(&amp;intToStringResult);</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineplus">+        if (NS_FAILED(intToStringResult)) {</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineplus">+          attrib = nsIMsgFilterList::attribNone;</span>
<a href="#l10.742"></a><span id="l10.742" class="difflineplus">+          NS_ASSERTION(false, &quot;error parsing filter file version&quot;);</span>
<a href="#l10.743"></a><span id="l10.743" class="difflineplus">+        }</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineplus">+        break;</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineplus">+      case nsIMsgFilterList::attribLogging:</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineplus">+        m_loggingEnabled = StrToBool(value);</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineplus">+        m_unparsedFilterBuffer</span>
<a href="#l10.748"></a><span id="l10.748" class="difflineplus">+            .Truncate();  // we are going to buffer each filter as we read them,</span>
<a href="#l10.749"></a><span id="l10.749" class="difflineplus">+                          // make sure no garbage is there</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineplus">+        m_startWritingToBuffer = true;  // filters begin now</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineplus">+        break;</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineplus">+      case nsIMsgFilterList::attribName:  // every filter starts w/ a name</span>
<a href="#l10.753"></a><span id="l10.753">       {</span>
<a href="#l10.754"></a><span id="l10.754" class="difflineminus">-        attrib = nsIMsgFilterList::attribNone;</span>
<a href="#l10.755"></a><span id="l10.755" class="difflineminus">-        NS_ASSERTION(false, &quot;error parsing filter file version&quot;);</span>
<a href="#l10.756"></a><span id="l10.756" class="difflineminus">-      }</span>
<a href="#l10.757"></a><span id="l10.757" class="difflineminus">-      break;</span>
<a href="#l10.758"></a><span id="l10.758" class="difflineminus">-    case nsIMsgFilterList::attribLogging:</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineminus">-      m_loggingEnabled = StrToBool(value);</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineminus">-      m_unparsedFilterBuffer.Truncate(); //we are going to buffer each filter as we read them, make sure no garbage is there</span>
<a href="#l10.761"></a><span id="l10.761" class="difflineminus">-      m_startWritingToBuffer = true; //filters begin now</span>
<a href="#l10.762"></a><span id="l10.762" class="difflineminus">-      break;</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineminus">-    case nsIMsgFilterList::attribName:  //every filter starts w/ a name</span>
<a href="#l10.764"></a><span id="l10.764" class="difflineminus">-      {</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineminus">-        if (m_curFilter)</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineminus">-        {</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineplus">+        if (m_curFilter) {</span>
<a href="#l10.768"></a><span id="l10.768">           int32_t nextFilterStartPos = m_unparsedFilterBuffer.RFind(&quot;name&quot;);</span>
<a href="#l10.769"></a><span id="l10.769"> </span>
<a href="#l10.770"></a><span id="l10.770">           nsAutoCString nextFilterPart;</span>
<a href="#l10.771"></a><span id="l10.771" class="difflineminus">-          nextFilterPart = Substring(m_unparsedFilterBuffer, nextFilterStartPos, m_unparsedFilterBuffer.Length());</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineplus">+          nextFilterPart = Substring(m_unparsedFilterBuffer, nextFilterStartPos,</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineplus">+                                     m_unparsedFilterBuffer.Length());</span>
<a href="#l10.774"></a><span id="l10.774">           m_unparsedFilterBuffer.SetLength(nextFilterStartPos);</span>
<a href="#l10.775"></a><span id="l10.775"> </span>
<a href="#l10.776"></a><span id="l10.776">           bool unparseableFilter;</span>
<a href="#l10.777"></a><span id="l10.777">           m_curFilter-&gt;GetUnparseable(&amp;unparseableFilter);</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineminus">-          if (unparseableFilter)</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineminus">-          {</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineplus">+          if (unparseableFilter) {</span>
<a href="#l10.781"></a><span id="l10.781">             m_curFilter-&gt;SetUnparsedBuffer(m_unparsedFilterBuffer);</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineminus">-            m_curFilter-&gt;SetEnabled(false); //disable the filter because we don't know how to apply it</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineplus">+            m_curFilter-&gt;SetEnabled(false);  // disable the filter because we</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineplus">+                                             // don't know how to apply it</span>
<a href="#l10.785"></a><span id="l10.785">           }</span>
<a href="#l10.786"></a><span id="l10.786">           m_unparsedFilterBuffer = nextFilterPart;</span>
<a href="#l10.787"></a><span id="l10.787">         }</span>
<a href="#l10.788"></a><span id="l10.788">         nsMsgFilter *filter = new nsMsgFilter;</span>
<a href="#l10.789"></a><span id="l10.789" class="difflineminus">-        if (filter == nullptr)</span>
<a href="#l10.790"></a><span id="l10.790" class="difflineminus">-        {</span>
<a href="#l10.791"></a><span id="l10.791" class="difflineplus">+        if (filter == nullptr) {</span>
<a href="#l10.792"></a><span id="l10.792">           err = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.793"></a><span id="l10.793">           break;</span>
<a href="#l10.794"></a><span id="l10.794">         }</span>
<a href="#l10.795"></a><span id="l10.795" class="difflineminus">-        filter-&gt;SetFilterList(static_cast&lt;nsIMsgFilterList*&gt;(this));</span>
<a href="#l10.796"></a><span id="l10.796" class="difflineplus">+        filter-&gt;SetFilterList(static_cast&lt;nsIMsgFilterList *&gt;(this));</span>
<a href="#l10.797"></a><span id="l10.797">         nsAutoString unicodeStr;</span>
<a href="#l10.798"></a><span id="l10.798" class="difflineminus">-        if (m_fileVersion == k45Version)</span>
<a href="#l10.799"></a><span id="l10.799" class="difflineminus">-        {</span>
<a href="#l10.800"></a><span id="l10.800" class="difflineplus">+        if (m_fileVersion == k45Version) {</span>
<a href="#l10.801"></a><span id="l10.801">           NS_CopyNativeToUnicode(value, unicodeStr);</span>
<a href="#l10.802"></a><span id="l10.802">           filter-&gt;SetFilterName(unicodeStr);</span>
<a href="#l10.803"></a><span id="l10.803" class="difflineminus">-        }</span>
<a href="#l10.804"></a><span id="l10.804" class="difflineminus">-        else</span>
<a href="#l10.805"></a><span id="l10.805" class="difflineminus">-        {</span>
<a href="#l10.806"></a><span id="l10.806" class="difflineplus">+        } else {</span>
<a href="#l10.807"></a><span id="l10.807">           CopyUTF8toUTF16(value, unicodeStr);</span>
<a href="#l10.808"></a><span id="l10.808">           filter-&gt;SetFilterName(unicodeStr);</span>
<a href="#l10.809"></a><span id="l10.809">         }</span>
<a href="#l10.810"></a><span id="l10.810">         m_curFilter = filter;</span>
<a href="#l10.811"></a><span id="l10.811">         m_filters.AppendElement(filter);</span>
<a href="#l10.812"></a><span id="l10.812" class="difflineminus">-      }</span>
<a href="#l10.813"></a><span id="l10.813" class="difflineminus">-      break;</span>
<a href="#l10.814"></a><span id="l10.814" class="difflineminus">-    case nsIMsgFilterList::attribEnabled:</span>
<a href="#l10.815"></a><span id="l10.815" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.816"></a><span id="l10.816" class="difflineminus">-        m_curFilter-&gt;SetEnabled(StrToBool(value));</span>
<a href="#l10.817"></a><span id="l10.817" class="difflineminus">-      break;</span>
<a href="#l10.818"></a><span id="l10.818" class="difflineminus">-    case nsIMsgFilterList::attribDescription:</span>
<a href="#l10.819"></a><span id="l10.819" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.820"></a><span id="l10.820" class="difflineminus">-        m_curFilter-&gt;SetFilterDesc(value);</span>
<a href="#l10.821"></a><span id="l10.821" class="difflineminus">-      break;</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineminus">-    case nsIMsgFilterList::attribType:</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.824"></a><span id="l10.824" class="difflineminus">-      {</span>
<a href="#l10.825"></a><span id="l10.825" class="difflineminus">-        // Older versions of filters didn't have the ability to turn on/off the</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineminus">-        // manual filter context, so default manual to be on in that case</span>
<a href="#l10.827"></a><span id="l10.827" class="difflineminus">-        int32_t filterType = value.ToInteger(&amp;intToStringResult);</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineminus">-        if (m_fileVersion &lt; kManualContextVersion)</span>
<a href="#l10.829"></a><span id="l10.829" class="difflineminus">-          filterType |= nsMsgFilterType::Manual;</span>
<a href="#l10.830"></a><span id="l10.830" class="difflineminus">-        m_curFilter-&gt;SetType((nsMsgFilterTypeType) filterType);</span>
<a href="#l10.831"></a><span id="l10.831" class="difflineminus">-      }</span>
<a href="#l10.832"></a><span id="l10.832" class="difflineminus">-      break;</span>
<a href="#l10.833"></a><span id="l10.833" class="difflineminus">-    case nsIMsgFilterList::attribScriptFile:</span>
<a href="#l10.834"></a><span id="l10.834" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.835"></a><span id="l10.835" class="difflineminus">-        m_curFilter-&gt;SetFilterScript(&amp;value);</span>
<a href="#l10.836"></a><span id="l10.836" class="difflineminus">-      break;</span>
<a href="#l10.837"></a><span id="l10.837" class="difflineminus">-    case nsIMsgFilterList::attribAction:</span>
<a href="#l10.838"></a><span id="l10.838" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.839"></a><span id="l10.839" class="difflineminus">-      {</span>
<a href="#l10.840"></a><span id="l10.840" class="difflineminus">-        nsMsgRuleActionType actionType = nsMsgFilter::GetActionForFilingStr(value);</span>
<a href="#l10.841"></a><span id="l10.841" class="difflineminus">-        if (actionType == nsMsgFilterAction::None)</span>
<a href="#l10.842"></a><span id="l10.842" class="difflineminus">-          m_curFilter-&gt;SetUnparseable(true);</span>
<a href="#l10.843"></a><span id="l10.843" class="difflineminus">-        else</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineminus">-        {</span>
<a href="#l10.845"></a><span id="l10.845" class="difflineminus">-          err = m_curFilter-&gt;CreateAction(getter_AddRefs(currentFilterAction));</span>
<a href="#l10.846"></a><span id="l10.846" class="difflineminus">-          NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.847"></a><span id="l10.847" class="difflineminus">-          currentFilterAction-&gt;SetType(actionType);</span>
<a href="#l10.848"></a><span id="l10.848" class="difflineminus">-          m_curFilter-&gt;AppendAction(currentFilterAction);</span>
<a href="#l10.849"></a><span id="l10.849" class="difflineplus">+      } break;</span>
<a href="#l10.850"></a><span id="l10.850" class="difflineplus">+      case nsIMsgFilterList::attribEnabled:</span>
<a href="#l10.851"></a><span id="l10.851" class="difflineplus">+        if (m_curFilter) m_curFilter-&gt;SetEnabled(StrToBool(value));</span>
<a href="#l10.852"></a><span id="l10.852" class="difflineplus">+        break;</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineplus">+      case nsIMsgFilterList::attribDescription:</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineplus">+        if (m_curFilter) m_curFilter-&gt;SetFilterDesc(value);</span>
<a href="#l10.855"></a><span id="l10.855" class="difflineplus">+        break;</span>
<a href="#l10.856"></a><span id="l10.856" class="difflineplus">+      case nsIMsgFilterList::attribType:</span>
<a href="#l10.857"></a><span id="l10.857" class="difflineplus">+        if (m_curFilter) {</span>
<a href="#l10.858"></a><span id="l10.858" class="difflineplus">+          // Older versions of filters didn't have the ability to turn on/off</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineplus">+          // the manual filter context, so default manual to be on in that case</span>
<a href="#l10.860"></a><span id="l10.860" class="difflineplus">+          int32_t filterType = value.ToInteger(&amp;intToStringResult);</span>
<a href="#l10.861"></a><span id="l10.861" class="difflineplus">+          if (m_fileVersion &lt; kManualContextVersion)</span>
<a href="#l10.862"></a><span id="l10.862" class="difflineplus">+            filterType |= nsMsgFilterType::Manual;</span>
<a href="#l10.863"></a><span id="l10.863" class="difflineplus">+          m_curFilter-&gt;SetType((nsMsgFilterTypeType)filterType);</span>
<a href="#l10.864"></a><span id="l10.864">         }</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineminus">-      }</span>
<a href="#l10.866"></a><span id="l10.866" class="difflineminus">-      break;</span>
<a href="#l10.867"></a><span id="l10.867" class="difflineminus">-    case nsIMsgFilterList::attribActionValue:</span>
<a href="#l10.868"></a><span id="l10.868" class="difflineminus">-      if (m_curFilter &amp;&amp; currentFilterAction)</span>
<a href="#l10.869"></a><span id="l10.869" class="difflineminus">-      {</span>
<a href="#l10.870"></a><span id="l10.870" class="difflineminus">-        nsMsgRuleActionType type;</span>
<a href="#l10.871"></a><span id="l10.871" class="difflineminus">-        currentFilterAction-&gt;GetType(&amp;type);</span>
<a href="#l10.872"></a><span id="l10.872" class="difflineminus">-        if (type == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l10.873"></a><span id="l10.873" class="difflineminus">-              type == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l10.874"></a><span id="l10.874" class="difflineminus">-          err = m_curFilter-&gt;ConvertMoveOrCopyToFolderValue(currentFilterAction, value);</span>
<a href="#l10.875"></a><span id="l10.875" class="difflineminus">-        else if (type == nsMsgFilterAction::ChangePriority)</span>
<a href="#l10.876"></a><span id="l10.876" class="difflineminus">-        {</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineminus">-          nsMsgPriorityValue outPriority;</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineminus">-          nsresult res = NS_MsgGetPriorityFromString(value.get(), outPriority);</span>
<a href="#l10.879"></a><span id="l10.879" class="difflineminus">-          if (NS_SUCCEEDED(res))</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineminus">-            currentFilterAction-&gt;SetPriority(outPriority);</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineminus">-          else</span>
<a href="#l10.882"></a><span id="l10.882" class="difflineminus">-            NS_ASSERTION(false, &quot;invalid priority in filter file&quot;);</span>
<a href="#l10.883"></a><span id="l10.883" class="difflineminus">-        }</span>
<a href="#l10.884"></a><span id="l10.884" class="difflineminus">-        else if (type == nsMsgFilterAction::Label)</span>
<a href="#l10.885"></a><span id="l10.885" class="difflineminus">-        {</span>
<a href="#l10.886"></a><span id="l10.886" class="difflineminus">-          // upgrade label to corresponding tag/keyword</span>
<a href="#l10.887"></a><span id="l10.887" class="difflineminus">-          nsresult res;</span>
<a href="#l10.888"></a><span id="l10.888" class="difflineminus">-          int32_t labelInt = value.ToInteger(&amp;res);</span>
<a href="#l10.889"></a><span id="l10.889" class="difflineminus">-          if (NS_SUCCEEDED(res))</span>
<a href="#l10.890"></a><span id="l10.890" class="difflineminus">-          {</span>
<a href="#l10.891"></a><span id="l10.891" class="difflineminus">-            nsAutoCString keyword(&quot;$label&quot;);</span>
<a href="#l10.892"></a><span id="l10.892" class="difflineminus">-            keyword.Append('0' + labelInt);</span>
<a href="#l10.893"></a><span id="l10.893" class="difflineminus">-            currentFilterAction-&gt;SetType(nsMsgFilterAction::AddTag);</span>
<a href="#l10.894"></a><span id="l10.894" class="difflineminus">-            currentFilterAction-&gt;SetStrValue(keyword);</span>
<a href="#l10.895"></a><span id="l10.895" class="difflineplus">+        break;</span>
<a href="#l10.896"></a><span id="l10.896" class="difflineplus">+      case nsIMsgFilterList::attribScriptFile:</span>
<a href="#l10.897"></a><span id="l10.897" class="difflineplus">+        if (m_curFilter) m_curFilter-&gt;SetFilterScript(&amp;value);</span>
<a href="#l10.898"></a><span id="l10.898" class="difflineplus">+        break;</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineplus">+      case nsIMsgFilterList::attribAction:</span>
<a href="#l10.900"></a><span id="l10.900" class="difflineplus">+        if (m_curFilter) {</span>
<a href="#l10.901"></a><span id="l10.901" class="difflineplus">+          nsMsgRuleActionType actionType =</span>
<a href="#l10.902"></a><span id="l10.902" class="difflineplus">+              nsMsgFilter::GetActionForFilingStr(value);</span>
<a href="#l10.903"></a><span id="l10.903" class="difflineplus">+          if (actionType == nsMsgFilterAction::None)</span>
<a href="#l10.904"></a><span id="l10.904" class="difflineplus">+            m_curFilter-&gt;SetUnparseable(true);</span>
<a href="#l10.905"></a><span id="l10.905" class="difflineplus">+          else {</span>
<a href="#l10.906"></a><span id="l10.906" class="difflineplus">+            err =</span>
<a href="#l10.907"></a><span id="l10.907" class="difflineplus">+                m_curFilter-&gt;CreateAction(getter_AddRefs(currentFilterAction));</span>
<a href="#l10.908"></a><span id="l10.908" class="difflineplus">+            NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.909"></a><span id="l10.909" class="difflineplus">+            currentFilterAction-&gt;SetType(actionType);</span>
<a href="#l10.910"></a><span id="l10.910" class="difflineplus">+            m_curFilter-&gt;AppendAction(currentFilterAction);</span>
<a href="#l10.911"></a><span id="l10.911">           }</span>
<a href="#l10.912"></a><span id="l10.912">         }</span>
<a href="#l10.913"></a><span id="l10.913" class="difflineminus">-        else if (type == nsMsgFilterAction::JunkScore)</span>
<a href="#l10.914"></a><span id="l10.914" class="difflineminus">-        {</span>
<a href="#l10.915"></a><span id="l10.915" class="difflineminus">-          nsresult res;</span>
<a href="#l10.916"></a><span id="l10.916" class="difflineminus">-          int32_t junkScore = value.ToInteger(&amp;res);</span>
<a href="#l10.917"></a><span id="l10.917" class="difflineminus">-          if (NS_SUCCEEDED(res))</span>
<a href="#l10.918"></a><span id="l10.918" class="difflineminus">-            currentFilterAction-&gt;SetJunkScore(junkScore);</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineminus">-        }</span>
<a href="#l10.920"></a><span id="l10.920" class="difflineminus">-        else if (type == nsMsgFilterAction::Forward ||</span>
<a href="#l10.921"></a><span id="l10.921" class="difflineminus">-                 type == nsMsgFilterAction::Reply ||</span>
<a href="#l10.922"></a><span id="l10.922" class="difflineminus">-                 type == nsMsgFilterAction::AddTag ||</span>
<a href="#l10.923"></a><span id="l10.923" class="difflineminus">-                 type == nsMsgFilterAction::Custom)</span>
<a href="#l10.924"></a><span id="l10.924" class="difflineminus">-        {</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineminus">-          currentFilterAction-&gt;SetStrValue(value);</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineplus">+        break;</span>
<a href="#l10.927"></a><span id="l10.927" class="difflineplus">+      case nsIMsgFilterList::attribActionValue:</span>
<a href="#l10.928"></a><span id="l10.928" class="difflineplus">+        if (m_curFilter &amp;&amp; currentFilterAction) {</span>
<a href="#l10.929"></a><span id="l10.929" class="difflineplus">+          nsMsgRuleActionType type;</span>
<a href="#l10.930"></a><span id="l10.930" class="difflineplus">+          currentFilterAction-&gt;GetType(&amp;type);</span>
<a href="#l10.931"></a><span id="l10.931" class="difflineplus">+          if (type == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l10.932"></a><span id="l10.932" class="difflineplus">+              type == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l10.933"></a><span id="l10.933" class="difflineplus">+            err = m_curFilter-&gt;ConvertMoveOrCopyToFolderValue(</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineplus">+                currentFilterAction, value);</span>
<a href="#l10.935"></a><span id="l10.935" class="difflineplus">+          else if (type == nsMsgFilterAction::ChangePriority) {</span>
<a href="#l10.936"></a><span id="l10.936" class="difflineplus">+            nsMsgPriorityValue outPriority;</span>
<a href="#l10.937"></a><span id="l10.937" class="difflineplus">+            nsresult res =</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineplus">+                NS_MsgGetPriorityFromString(value.get(), outPriority);</span>
<a href="#l10.939"></a><span id="l10.939" class="difflineplus">+            if (NS_SUCCEEDED(res))</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineplus">+              currentFilterAction-&gt;SetPriority(outPriority);</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineplus">+            else</span>
<a href="#l10.942"></a><span id="l10.942" class="difflineplus">+              NS_ASSERTION(false, &quot;invalid priority in filter file&quot;);</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineplus">+          } else if (type == nsMsgFilterAction::Label) {</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineplus">+            // upgrade label to corresponding tag/keyword</span>
<a href="#l10.945"></a><span id="l10.945" class="difflineplus">+            nsresult res;</span>
<a href="#l10.946"></a><span id="l10.946" class="difflineplus">+            int32_t labelInt = value.ToInteger(&amp;res);</span>
<a href="#l10.947"></a><span id="l10.947" class="difflineplus">+            if (NS_SUCCEEDED(res)) {</span>
<a href="#l10.948"></a><span id="l10.948" class="difflineplus">+              nsAutoCString keyword(&quot;$label&quot;);</span>
<a href="#l10.949"></a><span id="l10.949" class="difflineplus">+              keyword.Append('0' + labelInt);</span>
<a href="#l10.950"></a><span id="l10.950" class="difflineplus">+              currentFilterAction-&gt;SetType(nsMsgFilterAction::AddTag);</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineplus">+              currentFilterAction-&gt;SetStrValue(keyword);</span>
<a href="#l10.952"></a><span id="l10.952" class="difflineplus">+            }</span>
<a href="#l10.953"></a><span id="l10.953" class="difflineplus">+          } else if (type == nsMsgFilterAction::JunkScore) {</span>
<a href="#l10.954"></a><span id="l10.954" class="difflineplus">+            nsresult res;</span>
<a href="#l10.955"></a><span id="l10.955" class="difflineplus">+            int32_t junkScore = value.ToInteger(&amp;res);</span>
<a href="#l10.956"></a><span id="l10.956" class="difflineplus">+            if (NS_SUCCEEDED(res)) currentFilterAction-&gt;SetJunkScore(junkScore);</span>
<a href="#l10.957"></a><span id="l10.957" class="difflineplus">+          } else if (type == nsMsgFilterAction::Forward ||</span>
<a href="#l10.958"></a><span id="l10.958" class="difflineplus">+                     type == nsMsgFilterAction::Reply ||</span>
<a href="#l10.959"></a><span id="l10.959" class="difflineplus">+                     type == nsMsgFilterAction::AddTag ||</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineplus">+                     type == nsMsgFilterAction::Custom) {</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineplus">+            currentFilterAction-&gt;SetStrValue(value);</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineplus">+          }</span>
<a href="#l10.963"></a><span id="l10.963">         }</span>
<a href="#l10.964"></a><span id="l10.964" class="difflineminus">-      }</span>
<a href="#l10.965"></a><span id="l10.965" class="difflineminus">-      break;</span>
<a href="#l10.966"></a><span id="l10.966" class="difflineminus">-    case nsIMsgFilterList::attribCondition:</span>
<a href="#l10.967"></a><span id="l10.967" class="difflineminus">-      if (m_curFilter)</span>
<a href="#l10.968"></a><span id="l10.968" class="difflineminus">-      {</span>
<a href="#l10.969"></a><span id="l10.969" class="difflineminus">-        if (m_fileVersion == k45Version)</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineminus">-        {</span>
<a href="#l10.971"></a><span id="l10.971" class="difflineminus">-          nsAutoString unicodeStr;</span>
<a href="#l10.972"></a><span id="l10.972" class="difflineminus">-          NS_CopyNativeToUnicode(value, unicodeStr);</span>
<a href="#l10.973"></a><span id="l10.973" class="difflineminus">-          CopyUTF16toUTF8(unicodeStr, value);</span>
<a href="#l10.974"></a><span id="l10.974" class="difflineplus">+        break;</span>
<a href="#l10.975"></a><span id="l10.975" class="difflineplus">+      case nsIMsgFilterList::attribCondition:</span>
<a href="#l10.976"></a><span id="l10.976" class="difflineplus">+        if (m_curFilter) {</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineplus">+          if (m_fileVersion == k45Version) {</span>
<a href="#l10.978"></a><span id="l10.978" class="difflineplus">+            nsAutoString unicodeStr;</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineplus">+            NS_CopyNativeToUnicode(value, unicodeStr);</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineplus">+            CopyUTF16toUTF8(unicodeStr, value);</span>
<a href="#l10.981"></a><span id="l10.981" class="difflineplus">+          }</span>
<a href="#l10.982"></a><span id="l10.982" class="difflineplus">+          err = ParseCondition(m_curFilter, value.get());</span>
<a href="#l10.983"></a><span id="l10.983" class="difflineplus">+          if (err == NS_ERROR_INVALID_ARG)</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineplus">+            err = m_curFilter-&gt;SetUnparseable(true);</span>
<a href="#l10.985"></a><span id="l10.985" class="difflineplus">+          NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.986"></a><span id="l10.986">         }</span>
<a href="#l10.987"></a><span id="l10.987" class="difflineminus">-        err = ParseCondition(m_curFilter, value.get());</span>
<a href="#l10.988"></a><span id="l10.988" class="difflineminus">-        if (err == NS_ERROR_INVALID_ARG)</span>
<a href="#l10.989"></a><span id="l10.989" class="difflineminus">-          err = m_curFilter-&gt;SetUnparseable(true);</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineminus">-        NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.991"></a><span id="l10.991" class="difflineminus">-      }</span>
<a href="#l10.992"></a><span id="l10.992" class="difflineminus">-      break;</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineminus">-    case nsIMsgFilterList::attribCustomId:</span>
<a href="#l10.994"></a><span id="l10.994" class="difflineminus">-      if (m_curFilter &amp;&amp; currentFilterAction)</span>
<a href="#l10.995"></a><span id="l10.995" class="difflineminus">-      {</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineminus">-        err = currentFilterAction-&gt;SetCustomId(value);</span>
<a href="#l10.997"></a><span id="l10.997" class="difflineminus">-        NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.998"></a><span id="l10.998" class="difflineminus">-      }</span>
<a href="#l10.999"></a><span id="l10.999" class="difflineminus">-      break;</span>
<a href="#l10.1000"></a><span id="l10.1000" class="difflineminus">-</span>
<a href="#l10.1001"></a><span id="l10.1001" class="difflineplus">+        break;</span>
<a href="#l10.1002"></a><span id="l10.1002" class="difflineplus">+      case nsIMsgFilterList::attribCustomId:</span>
<a href="#l10.1003"></a><span id="l10.1003" class="difflineplus">+        if (m_curFilter &amp;&amp; currentFilterAction) {</span>
<a href="#l10.1004"></a><span id="l10.1004" class="difflineplus">+          err = currentFilterAction-&gt;SetCustomId(value);</span>
<a href="#l10.1005"></a><span id="l10.1005" class="difflineplus">+          NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.1006"></a><span id="l10.1006" class="difflineplus">+        }</span>
<a href="#l10.1007"></a><span id="l10.1007" class="difflineplus">+        break;</span>
<a href="#l10.1008"></a><span id="l10.1008">     }</span>
<a href="#l10.1009"></a><span id="l10.1009">   } while (NS_SUCCEEDED(bufStream-&gt;Available(&amp;bytesAvailable)));</span>
<a href="#l10.1010"></a><span id="l10.1010"> </span>
<a href="#l10.1011"></a><span id="l10.1011" class="difflineminus">-  if (m_curFilter)</span>
<a href="#l10.1012"></a><span id="l10.1012" class="difflineminus">-  {</span>
<a href="#l10.1013"></a><span id="l10.1013" class="difflineplus">+  if (m_curFilter) {</span>
<a href="#l10.1014"></a><span id="l10.1014">     bool unparseableFilter;</span>
<a href="#l10.1015"></a><span id="l10.1015">     m_curFilter-&gt;GetUnparseable(&amp;unparseableFilter);</span>
<a href="#l10.1016"></a><span id="l10.1016" class="difflineminus">-    if (unparseableFilter)</span>
<a href="#l10.1017"></a><span id="l10.1017" class="difflineminus">-    {</span>
<a href="#l10.1018"></a><span id="l10.1018" class="difflineplus">+    if (unparseableFilter) {</span>
<a href="#l10.1019"></a><span id="l10.1019">       m_curFilter-&gt;SetUnparsedBuffer(m_unparsedFilterBuffer);</span>
<a href="#l10.1020"></a><span id="l10.1020" class="difflineminus">-      m_curFilter-&gt;SetEnabled(false);  //disable the filter because we don't know how to apply it</span>
<a href="#l10.1021"></a><span id="l10.1021" class="difflineplus">+      m_curFilter-&gt;SetEnabled(</span>
<a href="#l10.1022"></a><span id="l10.1022" class="difflineplus">+          false);  // disable the filter because we don't know how to apply it</span>
<a href="#l10.1023"></a><span id="l10.1023">     }</span>
<a href="#l10.1024"></a><span id="l10.1024">   }</span>
<a href="#l10.1025"></a><span id="l10.1025"> </span>
<a href="#l10.1026"></a><span id="l10.1026">   return err;</span>
<a href="#l10.1027"></a><span id="l10.1027"> }</span>
<a href="#l10.1028"></a><span id="l10.1028"> </span>
<a href="#l10.1029"></a><span id="l10.1029"> // parse condition like &quot;(subject, contains, fred) AND (body, isn't, &quot;foo)&quot;)&quot;</span>
<a href="#l10.1030"></a><span id="l10.1030"> // values with close parens will be quoted.</span>
<a href="#l10.1031"></a><span id="l10.1031"> // what about values with close parens and quotes? e.g., (body, isn't, &quot;foo&quot;)&quot;)</span>
<a href="#l10.1032"></a><span id="l10.1032"> // I guess interior quotes will need to be escaped - (&quot;foo\&quot;)&quot;)</span>
<a href="#l10.1033"></a><span id="l10.1033"> // which will get written out as (\&quot;foo\\&quot;)\&quot;) and read in as (&quot;foo\&quot;)&quot;</span>
<a href="#l10.1034"></a><span id="l10.1034"> // ALL means match all messages.</span>
<a href="#l10.1035"></a><span id="l10.1035" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::ParseCondition(nsIMsgFilter *aFilter, const char *aCondition)</span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineminus">-{</span>
<a href="#l10.1037"></a><span id="l10.1037" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::ParseCondition(nsIMsgFilter *aFilter,</span>
<a href="#l10.1038"></a><span id="l10.1038" class="difflineplus">+                                              const char *aCondition) {</span>
<a href="#l10.1039"></a><span id="l10.1039">   NS_ENSURE_ARG_POINTER(aFilter);</span>
<a href="#l10.1040"></a><span id="l10.1040"> </span>
<a href="#l10.1041"></a><span id="l10.1041" class="difflineminus">-  bool    done = false;</span>
<a href="#l10.1042"></a><span id="l10.1042" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l10.1043"></a><span id="l10.1043" class="difflineplus">+  bool done = false;</span>
<a href="#l10.1044"></a><span id="l10.1044" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l10.1045"></a><span id="l10.1045">   const char *curPtr = aCondition;</span>
<a href="#l10.1046"></a><span id="l10.1046" class="difflineminus">-  if (!strcmp(aCondition, &quot;ALL&quot;))</span>
<a href="#l10.1047"></a><span id="l10.1047" class="difflineminus">-  {</span>
<a href="#l10.1048"></a><span id="l10.1048" class="difflineplus">+  if (!strcmp(aCondition, &quot;ALL&quot;)) {</span>
<a href="#l10.1049"></a><span id="l10.1049">     nsMsgSearchTerm *newTerm = new nsMsgSearchTerm;</span>
<a href="#l10.1050"></a><span id="l10.1050"> </span>
<a href="#l10.1051"></a><span id="l10.1051" class="difflineminus">-    if (newTerm)</span>
<a href="#l10.1052"></a><span id="l10.1052" class="difflineminus">-    {</span>
<a href="#l10.1053"></a><span id="l10.1053" class="difflineplus">+    if (newTerm) {</span>
<a href="#l10.1054"></a><span id="l10.1054">       newTerm-&gt;m_matchAll = true;</span>
<a href="#l10.1055"></a><span id="l10.1055">       aFilter-&gt;AppendTerm(newTerm);</span>
<a href="#l10.1056"></a><span id="l10.1056">     }</span>
<a href="#l10.1057"></a><span id="l10.1057">     return (newTerm) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.1058"></a><span id="l10.1058">   }</span>
<a href="#l10.1059"></a><span id="l10.1059"> </span>
<a href="#l10.1060"></a><span id="l10.1060" class="difflineminus">-  while (!done)</span>
<a href="#l10.1061"></a><span id="l10.1061" class="difflineminus">-  {</span>
<a href="#l10.1062"></a><span id="l10.1062" class="difflineminus">-    // insert code to save the boolean operator if there is one for this search term....</span>
<a href="#l10.1063"></a><span id="l10.1063" class="difflineplus">+  while (!done) {</span>
<a href="#l10.1064"></a><span id="l10.1064" class="difflineplus">+    // insert code to save the boolean operator if there is one for this search</span>
<a href="#l10.1065"></a><span id="l10.1065" class="difflineplus">+    // term....</span>
<a href="#l10.1066"></a><span id="l10.1066">     const char *openParen = PL_strchr(curPtr, '(');</span>
<a href="#l10.1067"></a><span id="l10.1067" class="difflineminus">-    const char *orTermPos = PL_strchr(curPtr, 'O');    // determine if an &quot;OR&quot; appears b4 the openParen...</span>
<a href="#l10.1068"></a><span id="l10.1068" class="difflineplus">+    const char *orTermPos = PL_strchr(</span>
<a href="#l10.1069"></a><span id="l10.1069" class="difflineplus">+        curPtr, 'O');  // determine if an &quot;OR&quot; appears b4 the openParen...</span>
<a href="#l10.1070"></a><span id="l10.1070">     bool ANDTerm = true;</span>
<a href="#l10.1071"></a><span id="l10.1071" class="difflineminus">-    if (orTermPos &amp;&amp; orTermPos &lt; openParen) // make sure OR term falls before the '('</span>
<a href="#l10.1072"></a><span id="l10.1072" class="difflineplus">+    if (orTermPos &amp;&amp;</span>
<a href="#l10.1073"></a><span id="l10.1073" class="difflineplus">+        orTermPos &lt; openParen)  // make sure OR term falls before the '('</span>
<a href="#l10.1074"></a><span id="l10.1074">       ANDTerm = false;</span>
<a href="#l10.1075"></a><span id="l10.1075"> </span>
<a href="#l10.1076"></a><span id="l10.1076">     char *termDup = nullptr;</span>
<a href="#l10.1077"></a><span id="l10.1077" class="difflineminus">-    if (openParen)</span>
<a href="#l10.1078"></a><span id="l10.1078" class="difflineminus">-    {</span>
<a href="#l10.1079"></a><span id="l10.1079" class="difflineplus">+    if (openParen) {</span>
<a href="#l10.1080"></a><span id="l10.1080">       bool foundEndTerm = false;</span>
<a href="#l10.1081"></a><span id="l10.1081">       bool inQuote = false;</span>
<a href="#l10.1082"></a><span id="l10.1082" class="difflineminus">-      for (curPtr = openParen +1; *curPtr; curPtr++)</span>
<a href="#l10.1083"></a><span id="l10.1083" class="difflineminus">-      {</span>
<a href="#l10.1084"></a><span id="l10.1084" class="difflineplus">+      for (curPtr = openParen + 1; *curPtr; curPtr++) {</span>
<a href="#l10.1085"></a><span id="l10.1085">         if (*curPtr == '\\' &amp;&amp; *(curPtr + 1) == '&quot;')</span>
<a href="#l10.1086"></a><span id="l10.1086">           curPtr++;</span>
<a href="#l10.1087"></a><span id="l10.1087" class="difflineminus">-        else if (*curPtr == ')' &amp;&amp; !inQuote)</span>
<a href="#l10.1088"></a><span id="l10.1088" class="difflineminus">-        {</span>
<a href="#l10.1089"></a><span id="l10.1089" class="difflineplus">+        else if (*curPtr == ')' &amp;&amp; !inQuote) {</span>
<a href="#l10.1090"></a><span id="l10.1090">           foundEndTerm = true;</span>
<a href="#l10.1091"></a><span id="l10.1091">           break;</span>
<a href="#l10.1092"></a><span id="l10.1092" class="difflineminus">-        }</span>
<a href="#l10.1093"></a><span id="l10.1093" class="difflineminus">-        else if (*curPtr == '&quot;')</span>
<a href="#l10.1094"></a><span id="l10.1094" class="difflineplus">+        } else if (*curPtr == '&quot;')</span>
<a href="#l10.1095"></a><span id="l10.1095">           inQuote = !inQuote;</span>
<a href="#l10.1096"></a><span id="l10.1096">       }</span>
<a href="#l10.1097"></a><span id="l10.1097" class="difflineminus">-      if (foundEndTerm)</span>
<a href="#l10.1098"></a><span id="l10.1098" class="difflineminus">-      {</span>
<a href="#l10.1099"></a><span id="l10.1099" class="difflineplus">+      if (foundEndTerm) {</span>
<a href="#l10.1100"></a><span id="l10.1100">         int termLen = curPtr - openParen - 1;</span>
<a href="#l10.1101"></a><span id="l10.1101" class="difflineminus">-        termDup = (char *) PR_Malloc(termLen + 1);</span>
<a href="#l10.1102"></a><span id="l10.1102" class="difflineminus">-        if (termDup)</span>
<a href="#l10.1103"></a><span id="l10.1103" class="difflineminus">-        {</span>
<a href="#l10.1104"></a><span id="l10.1104" class="difflineplus">+        termDup = (char *)PR_Malloc(termLen + 1);</span>
<a href="#l10.1105"></a><span id="l10.1105" class="difflineplus">+        if (termDup) {</span>
<a href="#l10.1106"></a><span id="l10.1106">           PL_strncpy(termDup, openParen + 1, termLen + 1);</span>
<a href="#l10.1107"></a><span id="l10.1107">           termDup[termLen] = '\0';</span>
<a href="#l10.1108"></a><span id="l10.1108" class="difflineminus">-        }</span>
<a href="#l10.1109"></a><span id="l10.1109" class="difflineminus">-        else</span>
<a href="#l10.1110"></a><span id="l10.1110" class="difflineminus">-        {</span>
<a href="#l10.1111"></a><span id="l10.1111" class="difflineplus">+        } else {</span>
<a href="#l10.1112"></a><span id="l10.1112">           err = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.1113"></a><span id="l10.1113">           break;</span>
<a href="#l10.1114"></a><span id="l10.1114">         }</span>
<a href="#l10.1115"></a><span id="l10.1115">       }</span>
<a href="#l10.1116"></a><span id="l10.1116" class="difflineminus">-    }</span>
<a href="#l10.1117"></a><span id="l10.1117" class="difflineminus">-    else</span>
<a href="#l10.1118"></a><span id="l10.1118" class="difflineplus">+    } else</span>
<a href="#l10.1119"></a><span id="l10.1119">       break;</span>
<a href="#l10.1120"></a><span id="l10.1120" class="difflineminus">-    if (termDup)</span>
<a href="#l10.1121"></a><span id="l10.1121" class="difflineminus">-    {</span>
<a href="#l10.1122"></a><span id="l10.1122" class="difflineminus">-      nsMsgSearchTerm  *newTerm = new nsMsgSearchTerm;</span>
<a href="#l10.1123"></a><span id="l10.1123" class="difflineplus">+    if (termDup) {</span>
<a href="#l10.1124"></a><span id="l10.1124" class="difflineplus">+      nsMsgSearchTerm *newTerm = new nsMsgSearchTerm;</span>
<a href="#l10.1125"></a><span id="l10.1125"> </span>
<a href="#l10.1126"></a><span id="l10.1126" class="difflineminus">-      if (newTerm)</span>
<a href="#l10.1127"></a><span id="l10.1127" class="difflineminus">-      {</span>
<a href="#l10.1128"></a><span id="l10.1128" class="difflineplus">+      if (newTerm) {</span>
<a href="#l10.1129"></a><span id="l10.1129">         /* Invert nsMsgSearchTerm::EscapeQuotesInStr() */</span>
<a href="#l10.1130"></a><span id="l10.1130" class="difflineminus">-        for (char *to = termDup, *from = termDup;;)</span>
<a href="#l10.1131"></a><span id="l10.1131" class="difflineminus">-        {</span>
<a href="#l10.1132"></a><span id="l10.1132" class="difflineplus">+        for (char *to = termDup, *from = termDup;;) {</span>
<a href="#l10.1133"></a><span id="l10.1133">           if (*from == '\\' &amp;&amp; from[1] == '&quot;') from++;</span>
<a href="#l10.1134"></a><span id="l10.1134">           if (!(*to++ = *from++)) break;</span>
<a href="#l10.1135"></a><span id="l10.1135">         }</span>
<a href="#l10.1136"></a><span id="l10.1136">         newTerm-&gt;m_booleanOp = (ANDTerm) ? nsMsgSearchBooleanOp::BooleanAND</span>
<a href="#l10.1137"></a><span id="l10.1137">                                          : nsMsgSearchBooleanOp::BooleanOR;</span>
<a href="#l10.1138"></a><span id="l10.1138"> </span>
<a href="#l10.1139"></a><span id="l10.1139">         err = newTerm-&gt;DeStreamNew(termDup, PL_strlen(termDup));</span>
<a href="#l10.1140"></a><span id="l10.1140">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.1141"></a><span id="l10.1141">         aFilter-&gt;AppendTerm(newTerm);</span>
<a href="#l10.1142"></a><span id="l10.1142">       }</span>
<a href="#l10.1143"></a><span id="l10.1143">       PR_FREEIF(termDup);</span>
<a href="#l10.1144"></a><span id="l10.1144" class="difflineminus">-    }</span>
<a href="#l10.1145"></a><span id="l10.1145" class="difflineminus">-    else</span>
<a href="#l10.1146"></a><span id="l10.1146" class="difflineplus">+    } else</span>
<a href="#l10.1147"></a><span id="l10.1147">       break;</span>
<a href="#l10.1148"></a><span id="l10.1148">   }</span>
<a href="#l10.1149"></a><span id="l10.1149">   return err;</span>
<a href="#l10.1150"></a><span id="l10.1150"> }</span>
<a href="#l10.1151"></a><span id="l10.1151"> </span>
<a href="#l10.1152"></a><span id="l10.1152" class="difflineminus">-nsresult nsMsgFilterList::WriteIntAttr(nsMsgFilterFileAttribValue attrib, int value, nsIOutputStream *aStream)</span>
<a href="#l10.1153"></a><span id="l10.1153" class="difflineminus">-{</span>
<a href="#l10.1154"></a><span id="l10.1154" class="difflineplus">+nsresult nsMsgFilterList::WriteIntAttr(nsMsgFilterFileAttribValue attrib,</span>
<a href="#l10.1155"></a><span id="l10.1155" class="difflineplus">+                                       int value, nsIOutputStream *aStream) {</span>
<a href="#l10.1156"></a><span id="l10.1156">   nsresult rv = NS_OK;</span>
<a href="#l10.1157"></a><span id="l10.1157">   const char *attribStr = GetStringForAttrib(attrib);</span>
<a href="#l10.1158"></a><span id="l10.1158" class="difflineminus">-  if (attribStr)</span>
<a href="#l10.1159"></a><span id="l10.1159" class="difflineminus">-  {</span>
<a href="#l10.1160"></a><span id="l10.1160" class="difflineplus">+  if (attribStr) {</span>
<a href="#l10.1161"></a><span id="l10.1161">     uint32_t bytesWritten;</span>
<a href="#l10.1162"></a><span id="l10.1162">     nsAutoCString writeStr(attribStr);</span>
<a href="#l10.1163"></a><span id="l10.1163">     writeStr.AppendLiteral(&quot;=\&quot;&quot;);</span>
<a href="#l10.1164"></a><span id="l10.1164">     writeStr.AppendInt(value);</span>
<a href="#l10.1165"></a><span id="l10.1165">     writeStr.AppendLiteral(&quot;\&quot;&quot; MSG_LINEBREAK);</span>
<a href="#l10.1166"></a><span id="l10.1166">     rv = aStream-&gt;Write(writeStr.get(), writeStr.Length(), &amp;bytesWritten);</span>
<a href="#l10.1167"></a><span id="l10.1167">   }</span>
<a href="#l10.1168"></a><span id="l10.1168">   return rv;</span>
<a href="#l10.1169"></a><span id="l10.1169"> }</span>
<a href="#l10.1170"></a><span id="l10.1170"> </span>
<a href="#l10.1171"></a><span id="l10.1171"> NS_IMETHODIMP</span>
<a href="#l10.1172"></a><span id="l10.1172"> nsMsgFilterList::WriteStrAttr(nsMsgFilterFileAttribValue attrib,</span>
<a href="#l10.1173"></a><span id="l10.1173" class="difflineminus">-                              const char *aStr, nsIOutputStream *aStream)</span>
<a href="#l10.1174"></a><span id="l10.1174" class="difflineminus">-{</span>
<a href="#l10.1175"></a><span id="l10.1175" class="difflineplus">+                              const char *aStr, nsIOutputStream *aStream) {</span>
<a href="#l10.1176"></a><span id="l10.1176">   nsresult rv = NS_OK;</span>
<a href="#l10.1177"></a><span id="l10.1177" class="difflineminus">-  if (aStr &amp;&amp; *aStr &amp;&amp; aStream) // only proceed if we actually have a string to write out.</span>
<a href="#l10.1178"></a><span id="l10.1178" class="difflineplus">+  if (aStr &amp;&amp; *aStr &amp;&amp;</span>
<a href="#l10.1179"></a><span id="l10.1179" class="difflineplus">+      aStream)  // only proceed if we actually have a string to write out.</span>
<a href="#l10.1180"></a><span id="l10.1180">   {</span>
<a href="#l10.1181"></a><span id="l10.1181">     char *escapedStr = nullptr;</span>
<a href="#l10.1182"></a><span id="l10.1182">     if (PL_strchr(aStr, '&quot;'))</span>
<a href="#l10.1183"></a><span id="l10.1183">       escapedStr = nsMsgSearchTerm::EscapeQuotesInStr(aStr);</span>
<a href="#l10.1184"></a><span id="l10.1184"> </span>
<a href="#l10.1185"></a><span id="l10.1185">     const char *attribStr = GetStringForAttrib(attrib);</span>
<a href="#l10.1186"></a><span id="l10.1186" class="difflineminus">-    if (attribStr)</span>
<a href="#l10.1187"></a><span id="l10.1187" class="difflineminus">-    {</span>
<a href="#l10.1188"></a><span id="l10.1188" class="difflineplus">+    if (attribStr) {</span>
<a href="#l10.1189"></a><span id="l10.1189">       uint32_t bytesWritten;</span>
<a href="#l10.1190"></a><span id="l10.1190">       nsAutoCString writeStr(attribStr);</span>
<a href="#l10.1191"></a><span id="l10.1191">       writeStr.AppendLiteral(&quot;=\&quot;&quot;);</span>
<a href="#l10.1192"></a><span id="l10.1192">       writeStr.Append((escapedStr) ? escapedStr : aStr);</span>
<a href="#l10.1193"></a><span id="l10.1193">       writeStr.AppendLiteral(&quot;\&quot;&quot; MSG_LINEBREAK);</span>
<a href="#l10.1194"></a><span id="l10.1194">       rv = aStream-&gt;Write(writeStr.get(), writeStr.Length(), &amp;bytesWritten);</span>
<a href="#l10.1195"></a><span id="l10.1195">     }</span>
<a href="#l10.1196"></a><span id="l10.1196">     PR_Free(escapedStr);</span>
<a href="#l10.1197"></a><span id="l10.1197">   }</span>
<a href="#l10.1198"></a><span id="l10.1198">   return rv;</span>
<a href="#l10.1199"></a><span id="l10.1199"> }</span>
<a href="#l10.1200"></a><span id="l10.1200"> </span>
<a href="#l10.1201"></a><span id="l10.1201" class="difflineminus">-nsresult nsMsgFilterList::WriteBoolAttr(nsMsgFilterFileAttribValue attrib, bool boolVal, nsIOutputStream *aStream)</span>
<a href="#l10.1202"></a><span id="l10.1202" class="difflineminus">-{</span>
<a href="#l10.1203"></a><span id="l10.1203" class="difflineplus">+nsresult nsMsgFilterList::WriteBoolAttr(nsMsgFilterFileAttribValue attrib,</span>
<a href="#l10.1204"></a><span id="l10.1204" class="difflineplus">+                                        bool boolVal,</span>
<a href="#l10.1205"></a><span id="l10.1205" class="difflineplus">+                                        nsIOutputStream *aStream) {</span>
<a href="#l10.1206"></a><span id="l10.1206">   return WriteStrAttr(attrib, (boolVal) ? &quot;yes&quot; : &quot;no&quot;, aStream);</span>
<a href="#l10.1207"></a><span id="l10.1207"> }</span>
<a href="#l10.1208"></a><span id="l10.1208"> </span>
<a href="#l10.1209"></a><span id="l10.1209" class="difflineminus">-nsresult</span>
<a href="#l10.1210"></a><span id="l10.1210" class="difflineminus">-nsMsgFilterList::WriteWstrAttr(nsMsgFilterFileAttribValue attrib,</span>
<a href="#l10.1211"></a><span id="l10.1211" class="difflineminus">-                               const char16_t *aFilterName, nsIOutputStream *aStream)</span>
<a href="#l10.1212"></a><span id="l10.1212" class="difflineminus">-{</span>
<a href="#l10.1213"></a><span id="l10.1213" class="difflineminus">-    WriteStrAttr(attrib, NS_ConvertUTF16toUTF8(aFilterName).get(), aStream);</span>
<a href="#l10.1214"></a><span id="l10.1214" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.1215"></a><span id="l10.1215" class="difflineplus">+nsresult nsMsgFilterList::WriteWstrAttr(nsMsgFilterFileAttribValue attrib,</span>
<a href="#l10.1216"></a><span id="l10.1216" class="difflineplus">+                                        const char16_t *aFilterName,</span>
<a href="#l10.1217"></a><span id="l10.1217" class="difflineplus">+                                        nsIOutputStream *aStream) {</span>
<a href="#l10.1218"></a><span id="l10.1218" class="difflineplus">+  WriteStrAttr(attrib, NS_ConvertUTF16toUTF8(aFilterName).get(), aStream);</span>
<a href="#l10.1219"></a><span id="l10.1219" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.1220"></a><span id="l10.1220"> }</span>
<a href="#l10.1221"></a><span id="l10.1221"> </span>
<a href="#l10.1222"></a><span id="l10.1222" class="difflineminus">-nsresult nsMsgFilterList::SaveTextFilters(nsIOutputStream *aStream)</span>
<a href="#l10.1223"></a><span id="l10.1223" class="difflineminus">-{</span>
<a href="#l10.1224"></a><span id="l10.1224" class="difflineminus">-  uint32_t   filterCount = 0;</span>
<a href="#l10.1225"></a><span id="l10.1225" class="difflineminus">-  nsresult   err = GetFilterCount(&amp;filterCount);</span>
<a href="#l10.1226"></a><span id="l10.1226" class="difflineplus">+nsresult nsMsgFilterList::SaveTextFilters(nsIOutputStream *aStream) {</span>
<a href="#l10.1227"></a><span id="l10.1227" class="difflineplus">+  uint32_t filterCount = 0;</span>
<a href="#l10.1228"></a><span id="l10.1228" class="difflineplus">+  nsresult err = GetFilterCount(&amp;filterCount);</span>
<a href="#l10.1229"></a><span id="l10.1229">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.1230"></a><span id="l10.1230"> </span>
<a href="#l10.1231"></a><span id="l10.1231">   err = WriteIntAttr(nsIMsgFilterList::attribVersion, kFileVersion, aStream);</span>
<a href="#l10.1232"></a><span id="l10.1232">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.1233"></a><span id="l10.1233" class="difflineminus">-  err = WriteBoolAttr(nsIMsgFilterList::attribLogging, m_loggingEnabled, aStream);</span>
<a href="#l10.1234"></a><span id="l10.1234" class="difflineplus">+  err =</span>
<a href="#l10.1235"></a><span id="l10.1235" class="difflineplus">+      WriteBoolAttr(nsIMsgFilterList::attribLogging, m_loggingEnabled, aStream);</span>
<a href="#l10.1236"></a><span id="l10.1236">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l10.1237"></a><span id="l10.1237" class="difflineminus">-  for (uint32_t i = 0; i &lt; filterCount; i ++)</span>
<a href="#l10.1238"></a><span id="l10.1238" class="difflineminus">-  {</span>
<a href="#l10.1239"></a><span id="l10.1239" class="difflineplus">+  for (uint32_t i = 0; i &lt; filterCount; i++) {</span>
<a href="#l10.1240"></a><span id="l10.1240">     nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.1241"></a><span id="l10.1241" class="difflineminus">-    if (NS_SUCCEEDED(GetFilterAt(i, getter_AddRefs(filter))) &amp;&amp; filter)</span>
<a href="#l10.1242"></a><span id="l10.1242" class="difflineminus">-    {</span>
<a href="#l10.1243"></a><span id="l10.1243" class="difflineplus">+    if (NS_SUCCEEDED(GetFilterAt(i, getter_AddRefs(filter))) &amp;&amp; filter) {</span>
<a href="#l10.1244"></a><span id="l10.1244">       filter-&gt;SetFilterList(this);</span>
<a href="#l10.1245"></a><span id="l10.1245"> </span>
<a href="#l10.1246"></a><span id="l10.1246">       // if the filter is temporary, don't write it to disk</span>
<a href="#l10.1247"></a><span id="l10.1247">       bool isTemporary;</span>
<a href="#l10.1248"></a><span id="l10.1248">       err = filter-&gt;GetTemporary(&amp;isTemporary);</span>
<a href="#l10.1249"></a><span id="l10.1249">       if (NS_SUCCEEDED(err) &amp;&amp; !isTemporary) {</span>
<a href="#l10.1250"></a><span id="l10.1250">         err = filter-&gt;SaveToTextFile(aStream);</span>
<a href="#l10.1251"></a><span id="l10.1251" class="difflineminus">-        if (NS_FAILED(err))</span>
<a href="#l10.1252"></a><span id="l10.1252" class="difflineminus">-          break;</span>
<a href="#l10.1253"></a><span id="l10.1253" class="difflineplus">+        if (NS_FAILED(err)) break;</span>
<a href="#l10.1254"></a><span id="l10.1254">       }</span>
<a href="#l10.1255"></a><span id="l10.1255" class="difflineminus">-    }</span>
<a href="#l10.1256"></a><span id="l10.1256" class="difflineminus">-    else</span>
<a href="#l10.1257"></a><span id="l10.1257" class="difflineplus">+    } else</span>
<a href="#l10.1258"></a><span id="l10.1258">       break;</span>
<a href="#l10.1259"></a><span id="l10.1259">   }</span>
<a href="#l10.1260"></a><span id="l10.1260" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l10.1261"></a><span id="l10.1261" class="difflineminus">-    m_arbitraryHeaders.Truncate();</span>
<a href="#l10.1262"></a><span id="l10.1262" class="difflineplus">+  if (NS_SUCCEEDED(err)) m_arbitraryHeaders.Truncate();</span>
<a href="#l10.1263"></a><span id="l10.1263">   return err;</span>
<a href="#l10.1264"></a><span id="l10.1264"> }</span>
<a href="#l10.1265"></a><span id="l10.1265"> </span>
<a href="#l10.1266"></a><span id="l10.1266" class="difflineminus">-nsMsgFilterList::~nsMsgFilterList()</span>
<a href="#l10.1267"></a><span id="l10.1267" class="difflineminus">-{</span>
<a href="#l10.1268"></a><span id="l10.1268" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Closing filter list %s&quot;, m_listId.get()));</span>
<a href="#l10.1269"></a><span id="l10.1269" class="difflineplus">+nsMsgFilterList::~nsMsgFilterList() {</span>
<a href="#l10.1270"></a><span id="l10.1270" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.1271"></a><span id="l10.1271" class="difflineplus">+          (&quot;Closing filter list %s&quot;, m_listId.get()));</span>
<a href="#l10.1272"></a><span id="l10.1272"> }</span>
<a href="#l10.1273"></a><span id="l10.1273"> </span>
<a href="#l10.1274"></a><span id="l10.1274" class="difflineminus">-nsresult nsMsgFilterList::Close()</span>
<a href="#l10.1275"></a><span id="l10.1275" class="difflineminus">-{</span>
<a href="#l10.1276"></a><span id="l10.1276" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.1277"></a><span id="l10.1277" class="difflineminus">-}</span>
<a href="#l10.1278"></a><span id="l10.1278" class="difflineplus">+nsresult nsMsgFilterList::Close() { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l10.1279"></a><span id="l10.1279"> </span>
<a href="#l10.1280"></a><span id="l10.1280" class="difflineminus">-nsresult nsMsgFilterList::GetFilterCount(uint32_t *pCount)</span>
<a href="#l10.1281"></a><span id="l10.1281" class="difflineminus">-{</span>
<a href="#l10.1282"></a><span id="l10.1282" class="difflineplus">+nsresult nsMsgFilterList::GetFilterCount(uint32_t *pCount) {</span>
<a href="#l10.1283"></a><span id="l10.1283">   NS_ENSURE_ARG_POINTER(pCount);</span>
<a href="#l10.1284"></a><span id="l10.1284"> </span>
<a href="#l10.1285"></a><span id="l10.1285">   *pCount = m_filters.Length();</span>
<a href="#l10.1286"></a><span id="l10.1286">   return NS_OK;</span>
<a href="#l10.1287"></a><span id="l10.1287"> }</span>
<a href="#l10.1288"></a><span id="l10.1288"> </span>
<a href="#l10.1289"></a><span id="l10.1289" class="difflineminus">-nsresult nsMsgFilterList::GetFilterAt(uint32_t filterIndex, nsIMsgFilter **filter)</span>
<a href="#l10.1290"></a><span id="l10.1290" class="difflineminus">-{</span>
<a href="#l10.1291"></a><span id="l10.1291" class="difflineplus">+nsresult nsMsgFilterList::GetFilterAt(uint32_t filterIndex,</span>
<a href="#l10.1292"></a><span id="l10.1292" class="difflineplus">+                                      nsIMsgFilter **filter) {</span>
<a href="#l10.1293"></a><span id="l10.1293">   NS_ENSURE_ARG_POINTER(filter);</span>
<a href="#l10.1294"></a><span id="l10.1294"> </span>
<a href="#l10.1295"></a><span id="l10.1295">   uint32_t filterCount = 0;</span>
<a href="#l10.1296"></a><span id="l10.1296">   GetFilterCount(&amp;filterCount);</span>
<a href="#l10.1297"></a><span id="l10.1297">   NS_ENSURE_ARG(filterIndex &lt; filterCount);</span>
<a href="#l10.1298"></a><span id="l10.1298"> </span>
<a href="#l10.1299"></a><span id="l10.1299">   NS_IF_ADDREF(*filter = m_filters[filterIndex]);</span>
<a href="#l10.1300"></a><span id="l10.1300">   return NS_OK;</span>
<a href="#l10.1301"></a><span id="l10.1301"> }</span>
<a href="#l10.1302"></a><span id="l10.1302"> </span>
<a href="#l10.1303"></a><span id="l10.1303" class="difflineminus">-nsresult</span>
<a href="#l10.1304"></a><span id="l10.1304" class="difflineminus">-nsMsgFilterList::GetFilterNamed(const nsAString &amp;aName, nsIMsgFilter **aResult)</span>
<a href="#l10.1305"></a><span id="l10.1305" class="difflineminus">-{</span>
<a href="#l10.1306"></a><span id="l10.1306" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.1307"></a><span id="l10.1307" class="difflineplus">+nsresult nsMsgFilterList::GetFilterNamed(const nsAString &amp;aName,</span>
<a href="#l10.1308"></a><span id="l10.1308" class="difflineplus">+                                         nsIMsgFilter **aResult) {</span>
<a href="#l10.1309"></a><span id="l10.1309" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.1310"></a><span id="l10.1310"> </span>
<a href="#l10.1311"></a><span id="l10.1311" class="difflineminus">-    uint32_t count = 0;</span>
<a href="#l10.1312"></a><span id="l10.1312" class="difflineminus">-    nsresult rv = GetFilterCount(&amp;count);</span>
<a href="#l10.1313"></a><span id="l10.1313" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1314"></a><span id="l10.1314" class="difflineplus">+  uint32_t count = 0;</span>
<a href="#l10.1315"></a><span id="l10.1315" class="difflineplus">+  nsresult rv = GetFilterCount(&amp;count);</span>
<a href="#l10.1316"></a><span id="l10.1316" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1317"></a><span id="l10.1317"> </span>
<a href="#l10.1318"></a><span id="l10.1318" class="difflineminus">-    *aResult = nullptr;</span>
<a href="#l10.1319"></a><span id="l10.1319" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.1320"></a><span id="l10.1320" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.1321"></a><span id="l10.1321" class="difflineminus">-        rv = GetFilterAt(i, getter_AddRefs(filter));</span>
<a href="#l10.1322"></a><span id="l10.1322" class="difflineminus">-        if (NS_FAILED(rv)) continue;</span>
<a href="#l10.1323"></a><span id="l10.1323" class="difflineplus">+  *aResult = nullptr;</span>
<a href="#l10.1324"></a><span id="l10.1324" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.1325"></a><span id="l10.1325" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.1326"></a><span id="l10.1326" class="difflineplus">+    rv = GetFilterAt(i, getter_AddRefs(filter));</span>
<a href="#l10.1327"></a><span id="l10.1327" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l10.1328"></a><span id="l10.1328"> </span>
<a href="#l10.1329"></a><span id="l10.1329" class="difflineminus">-        nsString filterName;</span>
<a href="#l10.1330"></a><span id="l10.1330" class="difflineminus">-        filter-&gt;GetFilterName(filterName);</span>
<a href="#l10.1331"></a><span id="l10.1331" class="difflineminus">-        if (filterName.Equals(aName))</span>
<a href="#l10.1332"></a><span id="l10.1332" class="difflineminus">-        {</span>
<a href="#l10.1333"></a><span id="l10.1333" class="difflineminus">-            filter.forget(aResult);</span>
<a href="#l10.1334"></a><span id="l10.1334" class="difflineminus">-            break;</span>
<a href="#l10.1335"></a><span id="l10.1335" class="difflineminus">-        }</span>
<a href="#l10.1336"></a><span id="l10.1336" class="difflineplus">+    nsString filterName;</span>
<a href="#l10.1337"></a><span id="l10.1337" class="difflineplus">+    filter-&gt;GetFilterName(filterName);</span>
<a href="#l10.1338"></a><span id="l10.1338" class="difflineplus">+    if (filterName.Equals(aName)) {</span>
<a href="#l10.1339"></a><span id="l10.1339" class="difflineplus">+      filter.forget(aResult);</span>
<a href="#l10.1340"></a><span id="l10.1340" class="difflineplus">+      break;</span>
<a href="#l10.1341"></a><span id="l10.1341">     }</span>
<a href="#l10.1342"></a><span id="l10.1342" class="difflineplus">+  }</span>
<a href="#l10.1343"></a><span id="l10.1343"> </span>
<a href="#l10.1344"></a><span id="l10.1344" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.1345"></a><span id="l10.1345" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.1346"></a><span id="l10.1346"> }</span>
<a href="#l10.1347"></a><span id="l10.1347"> </span>
<a href="#l10.1348"></a><span id="l10.1348" class="difflineminus">-nsresult nsMsgFilterList::SetFilterAt(uint32_t filterIndex, nsIMsgFilter *filter)</span>
<a href="#l10.1349"></a><span id="l10.1349" class="difflineminus">-{</span>
<a href="#l10.1350"></a><span id="l10.1350" class="difflineplus">+nsresult nsMsgFilterList::SetFilterAt(uint32_t filterIndex,</span>
<a href="#l10.1351"></a><span id="l10.1351" class="difflineplus">+                                      nsIMsgFilter *filter) {</span>
<a href="#l10.1352"></a><span id="l10.1352">   m_filters[filterIndex] = filter;</span>
<a href="#l10.1353"></a><span id="l10.1353">   return NS_OK;</span>
<a href="#l10.1354"></a><span id="l10.1354"> }</span>
<a href="#l10.1355"></a><span id="l10.1355"> </span>
<a href="#l10.1356"></a><span id="l10.1356" class="difflineminus">-</span>
<a href="#l10.1357"></a><span id="l10.1357" class="difflineminus">-nsresult nsMsgFilterList::RemoveFilterAt(uint32_t filterIndex)</span>
<a href="#l10.1358"></a><span id="l10.1358" class="difflineminus">-{</span>
<a href="#l10.1359"></a><span id="l10.1359" class="difflineplus">+nsresult nsMsgFilterList::RemoveFilterAt(uint32_t filterIndex) {</span>
<a href="#l10.1360"></a><span id="l10.1360">   m_filters.RemoveElementAt(filterIndex);</span>
<a href="#l10.1361"></a><span id="l10.1361">   return NS_OK;</span>
<a href="#l10.1362"></a><span id="l10.1362"> }</span>
<a href="#l10.1363"></a><span id="l10.1363"> </span>
<a href="#l10.1364"></a><span id="l10.1364" class="difflineminus">-nsresult</span>
<a href="#l10.1365"></a><span id="l10.1365" class="difflineminus">-nsMsgFilterList::RemoveFilter(nsIMsgFilter *aFilter)</span>
<a href="#l10.1366"></a><span id="l10.1366" class="difflineminus">-{</span>
<a href="#l10.1367"></a><span id="l10.1367" class="difflineplus">+nsresult nsMsgFilterList::RemoveFilter(nsIMsgFilter *aFilter) {</span>
<a href="#l10.1368"></a><span id="l10.1368">   m_filters.RemoveElement(aFilter);</span>
<a href="#l10.1369"></a><span id="l10.1369">   return NS_OK;</span>
<a href="#l10.1370"></a><span id="l10.1370"> }</span>
<a href="#l10.1371"></a><span id="l10.1371"> </span>
<a href="#l10.1372"></a><span id="l10.1372" class="difflineminus">-nsresult nsMsgFilterList::InsertFilterAt(uint32_t filterIndex, nsIMsgFilter *aFilter)</span>
<a href="#l10.1373"></a><span id="l10.1373" class="difflineminus">-{</span>
<a href="#l10.1374"></a><span id="l10.1374" class="difflineminus">-  if (!m_temporaryList)</span>
<a href="#l10.1375"></a><span id="l10.1375" class="difflineminus">-    aFilter-&gt;SetFilterList(this);</span>
<a href="#l10.1376"></a><span id="l10.1376" class="difflineplus">+nsresult nsMsgFilterList::InsertFilterAt(uint32_t filterIndex,</span>
<a href="#l10.1377"></a><span id="l10.1377" class="difflineplus">+                                         nsIMsgFilter *aFilter) {</span>
<a href="#l10.1378"></a><span id="l10.1378" class="difflineplus">+  if (!m_temporaryList) aFilter-&gt;SetFilterList(this);</span>
<a href="#l10.1379"></a><span id="l10.1379">   m_filters.InsertElementAt(filterIndex, aFilter);</span>
<a href="#l10.1380"></a><span id="l10.1380"> </span>
<a href="#l10.1381"></a><span id="l10.1381">   return NS_OK;</span>
<a href="#l10.1382"></a><span id="l10.1382"> }</span>
<a href="#l10.1383"></a><span id="l10.1383"> </span>
<a href="#l10.1384"></a><span id="l10.1384"> // Attempt to move the filter at index filterIndex in the specified direction.</span>
<a href="#l10.1385"></a><span id="l10.1385"> // If motion not possible in that direction, we still return success.</span>
<a href="#l10.1386"></a><span id="l10.1386"> // We could return an error if the FE's want to beep or something.</span>
<a href="#l10.1387"></a><span id="l10.1387"> nsresult nsMsgFilterList::MoveFilterAt(uint32_t filterIndex,</span>
<a href="#l10.1388"></a><span id="l10.1388" class="difflineminus">-                                       nsMsgFilterMotionValue motion)</span>
<a href="#l10.1389"></a><span id="l10.1389" class="difflineminus">-{</span>
<a href="#l10.1390"></a><span id="l10.1390" class="difflineplus">+                                       nsMsgFilterMotionValue motion) {</span>
<a href="#l10.1391"></a><span id="l10.1391">   NS_ENSURE_ARG((motion == nsMsgFilterMotion::up) ||</span>
<a href="#l10.1392"></a><span id="l10.1392">                 (motion == nsMsgFilterMotion::down));</span>
<a href="#l10.1393"></a><span id="l10.1393"> </span>
<a href="#l10.1394"></a><span id="l10.1394">   uint32_t filterCount = 0;</span>
<a href="#l10.1395"></a><span id="l10.1395">   nsresult rv = GetFilterCount(&amp;filterCount);</span>
<a href="#l10.1396"></a><span id="l10.1396">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1397"></a><span id="l10.1397"> </span>
<a href="#l10.1398"></a><span id="l10.1398">   NS_ENSURE_ARG(filterIndex &lt; filterCount);</span>
<a href="#l10.1399"></a><span id="l10.1399"> </span>
<a href="#l10.1400"></a><span id="l10.1400">   uint32_t newIndex = filterIndex;</span>
<a href="#l10.1401"></a><span id="l10.1401"> </span>
<a href="#l10.1402"></a><span id="l10.1402" class="difflineminus">-  if (motion == nsMsgFilterMotion::up)</span>
<a href="#l10.1403"></a><span id="l10.1403" class="difflineminus">-  {</span>
<a href="#l10.1404"></a><span id="l10.1404" class="difflineplus">+  if (motion == nsMsgFilterMotion::up) {</span>
<a href="#l10.1405"></a><span id="l10.1405">     // are we already at the top?</span>
<a href="#l10.1406"></a><span id="l10.1406" class="difflineminus">-    if (filterIndex == 0)</span>
<a href="#l10.1407"></a><span id="l10.1407" class="difflineminus">-      return NS_OK;</span>
<a href="#l10.1408"></a><span id="l10.1408" class="difflineplus">+    if (filterIndex == 0) return NS_OK;</span>
<a href="#l10.1409"></a><span id="l10.1409"> </span>
<a href="#l10.1410"></a><span id="l10.1410">     newIndex = filterIndex - 1;</span>
<a href="#l10.1411"></a><span id="l10.1411" class="difflineminus">-  }</span>
<a href="#l10.1412"></a><span id="l10.1412" class="difflineminus">-  else if (motion == nsMsgFilterMotion::down)</span>
<a href="#l10.1413"></a><span id="l10.1413" class="difflineminus">-  {</span>
<a href="#l10.1414"></a><span id="l10.1414" class="difflineplus">+  } else if (motion == nsMsgFilterMotion::down) {</span>
<a href="#l10.1415"></a><span id="l10.1415">     // are we already at the bottom?</span>
<a href="#l10.1416"></a><span id="l10.1416" class="difflineminus">-    if (filterIndex == filterCount - 1)</span>
<a href="#l10.1417"></a><span id="l10.1417" class="difflineminus">-      return NS_OK;</span>
<a href="#l10.1418"></a><span id="l10.1418" class="difflineplus">+    if (filterIndex == filterCount - 1) return NS_OK;</span>
<a href="#l10.1419"></a><span id="l10.1419"> </span>
<a href="#l10.1420"></a><span id="l10.1420">     newIndex = filterIndex + 1;</span>
<a href="#l10.1421"></a><span id="l10.1421">   }</span>
<a href="#l10.1422"></a><span id="l10.1422"> </span>
<a href="#l10.1423"></a><span id="l10.1423">   nsCOMPtr&lt;nsIMsgFilter&gt; tempFilter1;</span>
<a href="#l10.1424"></a><span id="l10.1424">   rv = GetFilterAt(newIndex, getter_AddRefs(tempFilter1));</span>
<a href="#l10.1425"></a><span id="l10.1425">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1426"></a><span id="l10.1426"> </span>
<a href="#l10.1427"></a><span id="l10.1427" class="difflineat">@@ -1070,246 +996,223 @@ nsresult nsMsgFilterList::MoveFilterAt(u</span>
<a href="#l10.1428"></a><span id="l10.1428"> </span>
<a href="#l10.1429"></a><span id="l10.1429">   SetFilterAt(newIndex, tempFilter2);</span>
<a href="#l10.1430"></a><span id="l10.1430">   SetFilterAt(filterIndex, tempFilter1);</span>
<a href="#l10.1431"></a><span id="l10.1431"> </span>
<a href="#l10.1432"></a><span id="l10.1432">   return NS_OK;</span>
<a href="#l10.1433"></a><span id="l10.1433"> }</span>
<a href="#l10.1434"></a><span id="l10.1434"> </span>
<a href="#l10.1435"></a><span id="l10.1435"> nsresult nsMsgFilterList::MoveFilter(nsIMsgFilter *aFilter,</span>
<a href="#l10.1436"></a><span id="l10.1436" class="difflineminus">-                                     nsMsgFilterMotionValue motion)</span>
<a href="#l10.1437"></a><span id="l10.1437" class="difflineminus">-{</span>
<a href="#l10.1438"></a><span id="l10.1438" class="difflineplus">+                                     nsMsgFilterMotionValue motion) {</span>
<a href="#l10.1439"></a><span id="l10.1439">   size_t filterIndex = m_filters.IndexOf(aFilter, 0);</span>
<a href="#l10.1440"></a><span id="l10.1440">   NS_ENSURE_ARG(filterIndex != m_filters.NoIndex);</span>
<a href="#l10.1441"></a><span id="l10.1441"> </span>
<a href="#l10.1442"></a><span id="l10.1442">   return MoveFilterAt(filterIndex, motion);</span>
<a href="#l10.1443"></a><span id="l10.1443"> }</span>
<a href="#l10.1444"></a><span id="l10.1444"> </span>
<a href="#l10.1445"></a><span id="l10.1445" class="difflineminus">-nsresult</span>
<a href="#l10.1446"></a><span id="l10.1446" class="difflineminus">-nsMsgFilterList::GetVersion(int16_t *aResult)</span>
<a href="#l10.1447"></a><span id="l10.1447" class="difflineminus">-{</span>
<a href="#l10.1448"></a><span id="l10.1448" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.1449"></a><span id="l10.1449" class="difflineminus">-    *aResult = m_fileVersion;</span>
<a href="#l10.1450"></a><span id="l10.1450" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.1451"></a><span id="l10.1451" class="difflineplus">+nsresult nsMsgFilterList::GetVersion(int16_t *aResult) {</span>
<a href="#l10.1452"></a><span id="l10.1452" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.1453"></a><span id="l10.1453" class="difflineplus">+  *aResult = m_fileVersion;</span>
<a href="#l10.1454"></a><span id="l10.1454" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.1455"></a><span id="l10.1455"> }</span>
<a href="#l10.1456"></a><span id="l10.1456"> </span>
<a href="#l10.1457"></a><span id="l10.1457" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::MatchOrChangeFilterTarget(const nsACString &amp;oldFolderUri, const nsACString &amp;newFolderUri, bool caseInsensitive, bool *found)</span>
<a href="#l10.1458"></a><span id="l10.1458" class="difflineminus">-{</span>
<a href="#l10.1459"></a><span id="l10.1459" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::MatchOrChangeFilterTarget(</span>
<a href="#l10.1460"></a><span id="l10.1460" class="difflineplus">+    const nsACString &amp;oldFolderUri, const nsACString &amp;newFolderUri,</span>
<a href="#l10.1461"></a><span id="l10.1461" class="difflineplus">+    bool caseInsensitive, bool *found) {</span>
<a href="#l10.1462"></a><span id="l10.1462">   NS_ENSURE_ARG_POINTER(found);</span>
<a href="#l10.1463"></a><span id="l10.1463"> </span>
<a href="#l10.1464"></a><span id="l10.1464">   uint32_t numFilters = 0;</span>
<a href="#l10.1465"></a><span id="l10.1465">   nsresult rv = GetFilterCount(&amp;numFilters);</span>
<a href="#l10.1466"></a><span id="l10.1466">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1467"></a><span id="l10.1467"> </span>
<a href="#l10.1468"></a><span id="l10.1468">   nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.1469"></a><span id="l10.1469">   nsCString folderUri;</span>
<a href="#l10.1470"></a><span id="l10.1470">   *found = false;</span>
<a href="#l10.1471"></a><span id="l10.1471" class="difflineminus">-  for (uint32_t index = 0; index &lt; numFilters; index++)</span>
<a href="#l10.1472"></a><span id="l10.1472" class="difflineminus">-  {</span>
<a href="#l10.1473"></a><span id="l10.1473" class="difflineplus">+  for (uint32_t index = 0; index &lt; numFilters; index++) {</span>
<a href="#l10.1474"></a><span id="l10.1474">     rv = GetFilterAt(index, getter_AddRefs(filter));</span>
<a href="#l10.1475"></a><span id="l10.1475">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1476"></a><span id="l10.1476"> </span>
<a href="#l10.1477"></a><span id="l10.1477">     uint32_t numActions;</span>
<a href="#l10.1478"></a><span id="l10.1478">     rv = filter-&gt;GetActionCount(&amp;numActions);</span>
<a href="#l10.1479"></a><span id="l10.1479">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1480"></a><span id="l10.1480"> </span>
<a href="#l10.1481"></a><span id="l10.1481" class="difflineminus">-    for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++)</span>
<a href="#l10.1482"></a><span id="l10.1482" class="difflineminus">-    {</span>
<a href="#l10.1483"></a><span id="l10.1483" class="difflineplus">+    for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++) {</span>
<a href="#l10.1484"></a><span id="l10.1484">       nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction;</span>
<a href="#l10.1485"></a><span id="l10.1485">       rv = filter-&gt;GetActionAt(actionIndex, getter_AddRefs(filterAction));</span>
<a href="#l10.1486"></a><span id="l10.1486" class="difflineminus">-      if (NS_FAILED(rv) || !filterAction)</span>
<a href="#l10.1487"></a><span id="l10.1487" class="difflineminus">-        continue;</span>
<a href="#l10.1488"></a><span id="l10.1488" class="difflineplus">+      if (NS_FAILED(rv) || !filterAction) continue;</span>
<a href="#l10.1489"></a><span id="l10.1489"> </span>
<a href="#l10.1490"></a><span id="l10.1490">       nsMsgRuleActionType actionType;</span>
<a href="#l10.1491"></a><span id="l10.1491" class="difflineminus">-      if (NS_FAILED(filterAction-&gt;GetType(&amp;actionType)))</span>
<a href="#l10.1492"></a><span id="l10.1492" class="difflineminus">-        continue;</span>
<a href="#l10.1493"></a><span id="l10.1493" class="difflineplus">+      if (NS_FAILED(filterAction-&gt;GetType(&amp;actionType))) continue;</span>
<a href="#l10.1494"></a><span id="l10.1494"> </span>
<a href="#l10.1495"></a><span id="l10.1495">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l10.1496"></a><span id="l10.1496" class="difflineminus">-          actionType == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l10.1497"></a><span id="l10.1497" class="difflineminus">-      {</span>
<a href="#l10.1498"></a><span id="l10.1498" class="difflineplus">+          actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l10.1499"></a><span id="l10.1499">         rv = filterAction-&gt;GetTargetFolderUri(folderUri);</span>
<a href="#l10.1500"></a><span id="l10.1500" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; !folderUri.IsEmpty())</span>
<a href="#l10.1501"></a><span id="l10.1501" class="difflineminus">-        {</span>
<a href="#l10.1502"></a><span id="l10.1502" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; !folderUri.IsEmpty()) {</span>
<a href="#l10.1503"></a><span id="l10.1503">           bool matchFound = false;</span>
<a href="#l10.1504"></a><span id="l10.1504" class="difflineminus">-          if (caseInsensitive)</span>
<a href="#l10.1505"></a><span id="l10.1505" class="difflineminus">-          {</span>
<a href="#l10.1506"></a><span id="l10.1506" class="difflineminus">-            if (folderUri.Equals(oldFolderUri, nsCaseInsensitiveCStringComparator())) //local</span>
<a href="#l10.1507"></a><span id="l10.1507" class="difflineplus">+          if (caseInsensitive) {</span>
<a href="#l10.1508"></a><span id="l10.1508" class="difflineplus">+            if (folderUri.Equals(</span>
<a href="#l10.1509"></a><span id="l10.1509" class="difflineplus">+                    oldFolderUri,</span>
<a href="#l10.1510"></a><span id="l10.1510" class="difflineplus">+                    nsCaseInsensitiveCStringComparator()))  // local</span>
<a href="#l10.1511"></a><span id="l10.1511" class="difflineplus">+              matchFound = true;</span>
<a href="#l10.1512"></a><span id="l10.1512" class="difflineplus">+          } else {</span>
<a href="#l10.1513"></a><span id="l10.1513" class="difflineplus">+            if (folderUri.Equals(oldFolderUri))  // imap</span>
<a href="#l10.1514"></a><span id="l10.1514">               matchFound = true;</span>
<a href="#l10.1515"></a><span id="l10.1515">           }</span>
<a href="#l10.1516"></a><span id="l10.1516" class="difflineminus">-          else</span>
<a href="#l10.1517"></a><span id="l10.1517" class="difflineminus">-          {</span>
<a href="#l10.1518"></a><span id="l10.1518" class="difflineminus">-            if (folderUri.Equals(oldFolderUri))  //imap</span>
<a href="#l10.1519"></a><span id="l10.1519" class="difflineminus">-              matchFound = true;</span>
<a href="#l10.1520"></a><span id="l10.1520" class="difflineminus">-          }</span>
<a href="#l10.1521"></a><span id="l10.1521" class="difflineminus">-          if (matchFound)</span>
<a href="#l10.1522"></a><span id="l10.1522" class="difflineminus">-          {</span>
<a href="#l10.1523"></a><span id="l10.1523" class="difflineplus">+          if (matchFound) {</span>
<a href="#l10.1524"></a><span id="l10.1524">             *found = true;</span>
<a href="#l10.1525"></a><span id="l10.1525" class="difflineminus">-            //if we just want to match the uri's, newFolderUri will be null</span>
<a href="#l10.1526"></a><span id="l10.1526" class="difflineminus">-            if (!newFolderUri.IsEmpty())</span>
<a href="#l10.1527"></a><span id="l10.1527" class="difflineminus">-            {</span>
<a href="#l10.1528"></a><span id="l10.1528" class="difflineplus">+            // if we just want to match the uri's, newFolderUri will be null</span>
<a href="#l10.1529"></a><span id="l10.1529" class="difflineplus">+            if (!newFolderUri.IsEmpty()) {</span>
<a href="#l10.1530"></a><span id="l10.1530">               rv = filterAction-&gt;SetTargetFolderUri(newFolderUri);</span>
<a href="#l10.1531"></a><span id="l10.1531">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1532"></a><span id="l10.1532">             }</span>
<a href="#l10.1533"></a><span id="l10.1533">           }</span>
<a href="#l10.1534"></a><span id="l10.1534">         }</span>
<a href="#l10.1535"></a><span id="l10.1535">       }</span>
<a href="#l10.1536"></a><span id="l10.1536">     }</span>
<a href="#l10.1537"></a><span id="l10.1537">   }</span>
<a href="#l10.1538"></a><span id="l10.1538">   return rv;</span>
<a href="#l10.1539"></a><span id="l10.1539"> }</span>
<a href="#l10.1540"></a><span id="l10.1540"> </span>
<a href="#l10.1541"></a><span id="l10.1541"> // this would only return true if any filter was on &quot;any header&quot;, which we</span>
<a href="#l10.1542"></a><span id="l10.1542"> // don't support in 6.x</span>
<a href="#l10.1543"></a><span id="l10.1543" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::GetShouldDownloadAllHeaders(bool *aResult)</span>
<a href="#l10.1544"></a><span id="l10.1544" class="difflineminus">-{</span>
<a href="#l10.1545"></a><span id="l10.1545" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::GetShouldDownloadAllHeaders(bool *aResult) {</span>
<a href="#l10.1546"></a><span id="l10.1546">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.1547"></a><span id="l10.1547"> </span>
<a href="#l10.1548"></a><span id="l10.1548">   *aResult = false;</span>
<a href="#l10.1549"></a><span id="l10.1549">   return NS_OK;</span>
<a href="#l10.1550"></a><span id="l10.1550"> }</span>
<a href="#l10.1551"></a><span id="l10.1551"> </span>
<a href="#l10.1552"></a><span id="l10.1552"> // leaves m_arbitraryHeaders filed in with the arbitrary headers.</span>
<a href="#l10.1553"></a><span id="l10.1553" class="difflineminus">-nsresult nsMsgFilterList::ComputeArbitraryHeaders()</span>
<a href="#l10.1554"></a><span id="l10.1554" class="difflineminus">-{</span>
<a href="#l10.1555"></a><span id="l10.1555" class="difflineminus">-  NS_ENSURE_TRUE (m_arbitraryHeaders.IsEmpty(), NS_OK);</span>
<a href="#l10.1556"></a><span id="l10.1556" class="difflineplus">+nsresult nsMsgFilterList::ComputeArbitraryHeaders() {</span>
<a href="#l10.1557"></a><span id="l10.1557" class="difflineplus">+  NS_ENSURE_TRUE(m_arbitraryHeaders.IsEmpty(), NS_OK);</span>
<a href="#l10.1558"></a><span id="l10.1558"> </span>
<a href="#l10.1559"></a><span id="l10.1559">   uint32_t numFilters = 0;</span>
<a href="#l10.1560"></a><span id="l10.1560">   nsresult rv = GetFilterCount(&amp;numFilters);</span>
<a href="#l10.1561"></a><span id="l10.1561">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1562"></a><span id="l10.1562"> </span>
<a href="#l10.1563"></a><span id="l10.1563">   nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.1564"></a><span id="l10.1564">   nsMsgSearchAttribValue attrib;</span>
<a href="#l10.1565"></a><span id="l10.1565">   nsCString arbitraryHeader;</span>
<a href="#l10.1566"></a><span id="l10.1566" class="difflineminus">-  for (uint32_t index = 0; index &lt; numFilters; index++)</span>
<a href="#l10.1567"></a><span id="l10.1567" class="difflineminus">-  {</span>
<a href="#l10.1568"></a><span id="l10.1568" class="difflineplus">+  for (uint32_t index = 0; index &lt; numFilters; index++) {</span>
<a href="#l10.1569"></a><span id="l10.1569">     rv = GetFilterAt(index, getter_AddRefs(filter));</span>
<a href="#l10.1570"></a><span id="l10.1570">     if (!(NS_SUCCEEDED(rv) &amp;&amp; filter)) continue;</span>
<a href="#l10.1571"></a><span id="l10.1571"> </span>
<a href="#l10.1572"></a><span id="l10.1572">     nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l10.1573"></a><span id="l10.1573">     uint32_t numSearchTerms = 0;</span>
<a href="#l10.1574"></a><span id="l10.1574">     filter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l10.1575"></a><span id="l10.1575" class="difflineminus">-    if (searchTerms)</span>
<a href="#l10.1576"></a><span id="l10.1576" class="difflineminus">-      searchTerms-&gt;GetLength(&amp;numSearchTerms);</span>
<a href="#l10.1577"></a><span id="l10.1577" class="difflineminus">-    for (uint32_t i = 0; i &lt; numSearchTerms; i++)</span>
<a href="#l10.1578"></a><span id="l10.1578" class="difflineminus">-    {</span>
<a href="#l10.1579"></a><span id="l10.1579" class="difflineplus">+    if (searchTerms) searchTerms-&gt;GetLength(&amp;numSearchTerms);</span>
<a href="#l10.1580"></a><span id="l10.1580" class="difflineplus">+    for (uint32_t i = 0; i &lt; numSearchTerms; i++) {</span>
<a href="#l10.1581"></a><span id="l10.1581">       filter-&gt;GetTerm(i, &amp;attrib, nullptr, nullptr, nullptr, arbitraryHeader);</span>
<a href="#l10.1582"></a><span id="l10.1582" class="difflineminus">-      if (!arbitraryHeader.IsEmpty())</span>
<a href="#l10.1583"></a><span id="l10.1583" class="difflineminus">-      {</span>
<a href="#l10.1584"></a><span id="l10.1584" class="difflineplus">+      if (!arbitraryHeader.IsEmpty()) {</span>
<a href="#l10.1585"></a><span id="l10.1585">         if (m_arbitraryHeaders.IsEmpty())</span>
<a href="#l10.1586"></a><span id="l10.1586">           m_arbitraryHeaders.Assign(arbitraryHeader);</span>
<a href="#l10.1587"></a><span id="l10.1587" class="difflineminus">-        else if (m_arbitraryHeaders.Find(arbitraryHeader, /* ignoreCase = */ true) == -1)</span>
<a href="#l10.1588"></a><span id="l10.1588" class="difflineminus">-        {</span>
<a href="#l10.1589"></a><span id="l10.1589" class="difflineplus">+        else if (m_arbitraryHeaders.Find(arbitraryHeader,</span>
<a href="#l10.1590"></a><span id="l10.1590" class="difflineplus">+                                         /* ignoreCase = */ true) == -1) {</span>
<a href="#l10.1591"></a><span id="l10.1591">           m_arbitraryHeaders.Append(' ');</span>
<a href="#l10.1592"></a><span id="l10.1592">           m_arbitraryHeaders.Append(arbitraryHeader);</span>
<a href="#l10.1593"></a><span id="l10.1593">         }</span>
<a href="#l10.1594"></a><span id="l10.1594">       }</span>
<a href="#l10.1595"></a><span id="l10.1595">     }</span>
<a href="#l10.1596"></a><span id="l10.1596">   }</span>
<a href="#l10.1597"></a><span id="l10.1597"> </span>
<a href="#l10.1598"></a><span id="l10.1598">   return NS_OK;</span>
<a href="#l10.1599"></a><span id="l10.1599"> }</span>
<a href="#l10.1600"></a><span id="l10.1600"> </span>
<a href="#l10.1601"></a><span id="l10.1601" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::GetArbitraryHeaders(nsACString &amp;aResult)</span>
<a href="#l10.1602"></a><span id="l10.1602" class="difflineminus">-{</span>
<a href="#l10.1603"></a><span id="l10.1603" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::GetArbitraryHeaders(nsACString &amp;aResult) {</span>
<a href="#l10.1604"></a><span id="l10.1604">   ComputeArbitraryHeaders();</span>
<a href="#l10.1605"></a><span id="l10.1605">   aResult = m_arbitraryHeaders;</span>
<a href="#l10.1606"></a><span id="l10.1606">   return NS_OK;</span>
<a href="#l10.1607"></a><span id="l10.1607"> }</span>
<a href="#l10.1608"></a><span id="l10.1608"> </span>
<a href="#l10.1609"></a><span id="l10.1609" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::FlushLogIfNecessary()</span>
<a href="#l10.1610"></a><span id="l10.1610" class="difflineminus">-{</span>
<a href="#l10.1611"></a><span id="l10.1611" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::FlushLogIfNecessary() {</span>
<a href="#l10.1612"></a><span id="l10.1612">   // only flush the log if we are logging</span>
<a href="#l10.1613"></a><span id="l10.1613">   bool loggingEnabled = false;</span>
<a href="#l10.1614"></a><span id="l10.1614">   nsresult rv = GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l10.1615"></a><span id="l10.1615" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1616"></a><span id="l10.1616" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1617"></a><span id="l10.1617"> </span>
<a href="#l10.1618"></a><span id="l10.1618" class="difflineminus">-  if (loggingEnabled)</span>
<a href="#l10.1619"></a><span id="l10.1619" class="difflineminus">-  {</span>
<a href="#l10.1620"></a><span id="l10.1620" class="difflineminus">-    nsCOMPtr &lt;nsIOutputStream&gt; logStream;</span>
<a href="#l10.1621"></a><span id="l10.1621" class="difflineplus">+  if (loggingEnabled) {</span>
<a href="#l10.1622"></a><span id="l10.1622" class="difflineplus">+    nsCOMPtr&lt;nsIOutputStream&gt; logStream;</span>
<a href="#l10.1623"></a><span id="l10.1623">     rv = GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l10.1624"></a><span id="l10.1624">     if (NS_SUCCEEDED(rv) &amp;&amp; logStream) {</span>
<a href="#l10.1625"></a><span id="l10.1625">       rv = logStream-&gt;Flush();</span>
<a href="#l10.1626"></a><span id="l10.1626" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1627"></a><span id="l10.1627" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1628"></a><span id="l10.1628">     }</span>
<a href="#l10.1629"></a><span id="l10.1629">   }</span>
<a href="#l10.1630"></a><span id="l10.1630">   return rv;</span>
<a href="#l10.1631"></a><span id="l10.1631"> }</span>
<a href="#l10.1632"></a><span id="l10.1632"> </span>
<a href="#l10.1633"></a><span id="l10.1633"> #define LOG_ENTRY_START_TAG &quot;&lt;p&gt;\n&quot;</span>
<a href="#l10.1634"></a><span id="l10.1634"> #define LOG_ENTRY_START_TAG_LEN (strlen(LOG_ENTRY_START_TAG))</span>
<a href="#l10.1635"></a><span id="l10.1635"> #define LOG_ENTRY_END_TAG &quot;&lt;/p&gt;\n&quot;</span>
<a href="#l10.1636"></a><span id="l10.1636"> #define LOG_ENTRY_END_TAG_LEN (strlen(LOG_ENTRY_END_TAG))</span>
<a href="#l10.1637"></a><span id="l10.1637"> </span>
<a href="#l10.1638"></a><span id="l10.1638" class="difflineminus">-NS_IMETHODIMP nsMsgFilterList::LogFilterMessage(const nsAString &amp;message, nsIMsgFilter *filter)</span>
<a href="#l10.1639"></a><span id="l10.1639" class="difflineminus">-{</span>
<a href="#l10.1640"></a><span id="l10.1640" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; logStream;</span>
<a href="#l10.1641"></a><span id="l10.1641" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::LogFilterMessage(const nsAString &amp;message,</span>
<a href="#l10.1642"></a><span id="l10.1642" class="difflineplus">+                                                nsIMsgFilter *filter) {</span>
<a href="#l10.1643"></a><span id="l10.1643" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; logStream;</span>
<a href="#l10.1644"></a><span id="l10.1644">   nsresult rv = GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l10.1645"></a><span id="l10.1645">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1646"></a><span id="l10.1646"> </span>
<a href="#l10.1647"></a><span id="l10.1647">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l10.1648"></a><span id="l10.1648" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l10.1649"></a><span id="l10.1649" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l10.1650"></a><span id="l10.1650">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l10.1651"></a><span id="l10.1651"> </span>
<a href="#l10.1652"></a><span id="l10.1652">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.1653"></a><span id="l10.1653" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l10.1654"></a><span id="l10.1654" class="difflineminus">-    getter_AddRefs(bundle));</span>
<a href="#l10.1655"></a><span id="l10.1655" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l10.1656"></a><span id="l10.1656" class="difflineplus">+      &quot;chrome://messenger/locale/filter.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l10.1657"></a><span id="l10.1657">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1658"></a><span id="l10.1658"> </span>
<a href="#l10.1659"></a><span id="l10.1659">   nsString tempMessage(message);</span>
<a href="#l10.1660"></a><span id="l10.1660"> </span>
<a href="#l10.1661"></a><span id="l10.1661">   if (filter) {</span>
<a href="#l10.1662"></a><span id="l10.1662">     // If a filter was passed, prepend its name in the log message.</span>
<a href="#l10.1663"></a><span id="l10.1663">     nsString filterName;</span>
<a href="#l10.1664"></a><span id="l10.1664">     filter-&gt;GetFilterName(filterName);</span>
<a href="#l10.1665"></a><span id="l10.1665"> </span>
<a href="#l10.1666"></a><span id="l10.1666" class="difflineminus">-    const char16_t *logFormatStrings[2] = { filterName.get(),</span>
<a href="#l10.1667"></a><span id="l10.1667" class="difflineminus">-                                            tempMessage.get() };</span>
<a href="#l10.1668"></a><span id="l10.1668" class="difflineplus">+    const char16_t *logFormatStrings[2] = {filterName.get(), tempMessage.get()};</span>
<a href="#l10.1669"></a><span id="l10.1669">     nsString statusLogMessage;</span>
<a href="#l10.1670"></a><span id="l10.1670" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(&quot;filterMessage&quot;,</span>
<a href="#l10.1671"></a><span id="l10.1671" class="difflineminus">-                                      logFormatStrings, 2,</span>
<a href="#l10.1672"></a><span id="l10.1672" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;filterMessage&quot;, logFormatStrings, 2,</span>
<a href="#l10.1673"></a><span id="l10.1673">                                       statusLogMessage);</span>
<a href="#l10.1674"></a><span id="l10.1674" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1675"></a><span id="l10.1675" class="difflineminus">-      tempMessage.Assign(statusLogMessage);</span>
<a href="#l10.1676"></a><span id="l10.1676" class="difflineplus">+    if (NS_SUCCEEDED(rv)) tempMessage.Assign(statusLogMessage);</span>
<a href="#l10.1677"></a><span id="l10.1677">   }</span>
<a href="#l10.1678"></a><span id="l10.1678"> </span>
<a href="#l10.1679"></a><span id="l10.1679">   // Prepare timestamp</span>
<a href="#l10.1680"></a><span id="l10.1680">   PRExplodedTime exploded;</span>
<a href="#l10.1681"></a><span id="l10.1681">   nsString dateValue;</span>
<a href="#l10.1682"></a><span id="l10.1682">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l10.1683"></a><span id="l10.1683">   mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l10.1684"></a><span id="l10.1684">                                                 mozilla::kTimeFormatSeconds,</span>
<a href="#l10.1685"></a><span id="l10.1685" class="difflineminus">-                                                &amp;exploded,</span>
<a href="#l10.1686"></a><span id="l10.1686" class="difflineminus">-                                                dateValue);</span>
<a href="#l10.1687"></a><span id="l10.1687" class="difflineplus">+                                                &amp;exploded, dateValue);</span>
<a href="#l10.1688"></a><span id="l10.1688"> </span>
<a href="#l10.1689"></a><span id="l10.1689">   // HTML-escape the log for security reasons.</span>
<a href="#l10.1690"></a><span id="l10.1690">   // We don't want someone to send us a message with a subject with</span>
<a href="#l10.1691"></a><span id="l10.1691">   // HTML tags, especially &lt;script&gt;.</span>
<a href="#l10.1692"></a><span id="l10.1692">   nsCString escapedBuffer;</span>
<a href="#l10.1693"></a><span id="l10.1693">   nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(tempMessage), escapedBuffer);</span>
<a href="#l10.1694"></a><span id="l10.1694">   NS_ConvertUTF8toUTF16 finalMessage(escapedBuffer);</span>
<a href="#l10.1695"></a><span id="l10.1695"> </span>
<a href="#l10.1696"></a><span id="l10.1696">   // Print timestamp and the message.</span>
<a href="#l10.1697"></a><span id="l10.1697" class="difflineminus">-  const char16_t *logFormatStrings[2] = { dateValue.get(),</span>
<a href="#l10.1698"></a><span id="l10.1698" class="difflineminus">-                                          finalMessage.get() };</span>
<a href="#l10.1699"></a><span id="l10.1699" class="difflineplus">+  const char16_t *logFormatStrings[2] = {dateValue.get(), finalMessage.get()};</span>
<a href="#l10.1700"></a><span id="l10.1700">   nsString filterLogMessage;</span>
<a href="#l10.1701"></a><span id="l10.1701" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(&quot;filterLogLine&quot;,</span>
<a href="#l10.1702"></a><span id="l10.1702" class="difflineminus">-                                    logFormatStrings, 2,</span>
<a href="#l10.1703"></a><span id="l10.1703" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(&quot;filterLogLine&quot;, logFormatStrings, 2,</span>
<a href="#l10.1704"></a><span id="l10.1704">                                     filterLogMessage);</span>
<a href="#l10.1705"></a><span id="l10.1705"> </span>
<a href="#l10.1706"></a><span id="l10.1706">   // Write message into log stream.</span>
<a href="#l10.1707"></a><span id="l10.1707">   uint32_t writeCount;</span>
<a href="#l10.1708"></a><span id="l10.1708"> </span>
<a href="#l10.1709"></a><span id="l10.1709" class="difflineminus">-  rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN, &amp;writeCount);</span>
<a href="#l10.1710"></a><span id="l10.1710" class="difflineplus">+  rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN,</span>
<a href="#l10.1711"></a><span id="l10.1711" class="difflineplus">+                        &amp;writeCount);</span>
<a href="#l10.1712"></a><span id="l10.1712">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1713"></a><span id="l10.1713" class="difflineminus">-  NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN, &quot;failed to write out start log tag&quot;);</span>
<a href="#l10.1714"></a><span id="l10.1714" class="difflineplus">+  NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN,</span>
<a href="#l10.1715"></a><span id="l10.1715" class="difflineplus">+               &quot;failed to write out start log tag&quot;);</span>
<a href="#l10.1716"></a><span id="l10.1716"> </span>
<a href="#l10.1717"></a><span id="l10.1717">   NS_ConvertUTF16toUTF8 buffer(filterLogMessage);</span>
<a href="#l10.1718"></a><span id="l10.1718">   uint32_t escapedBufferLen = buffer.Length();</span>
<a href="#l10.1719"></a><span id="l10.1719">   rv = logStream-&gt;Write(buffer.get(), escapedBufferLen, &amp;writeCount);</span>
<a href="#l10.1720"></a><span id="l10.1720">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1721"></a><span id="l10.1721">   NS_ASSERTION(writeCount == escapedBufferLen, &quot;failed to write out log hit&quot;);</span>
<a href="#l10.1722"></a><span id="l10.1722"> </span>
<a href="#l10.1723"></a><span id="l10.1723">   rv = logStream-&gt;Write(LOG_ENTRY_END_TAG, LOG_ENTRY_END_TAG_LEN, &amp;writeCount);</span>
<a href="#l10.1724"></a><span id="l10.1724">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1725"></a><span id="l10.1725" class="difflineminus">-  NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN, &quot;failed to write out end log tag&quot;);</span>
<a href="#l10.1726"></a><span id="l10.1726" class="difflineplus">+  NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN,</span>
<a href="#l10.1727"></a><span id="l10.1727" class="difflineplus">+               &quot;failed to write out end log tag&quot;);</span>
<a href="#l10.1728"></a><span id="l10.1728">   return NS_OK;</span>
<a href="#l10.1729"></a><span id="l10.1729"> }</span>
<a href="#l10.1730"></a><span id="l10.1730"> // ------------ End FilterList methods ------------------</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -16,60 +16,60 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> const int16_t kFileVersion = 9;</span>
<a href="#l11.6"></a><span id="l11.6"> const int16_t kManualContextVersion = 9;</span>
<a href="#l11.7"></a><span id="l11.7"> const int16_t k60Beta1Version = 7;</span>
<a href="#l11.8"></a><span id="l11.8"> const int16_t k45Version = 6;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.11"></a><span id="l11.11"> // The Msg Filter List is an interface designed to make accessing filter lists</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-// easier. Clients typically open a filter list and either enumerate the filters,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-// or add new filters, or change the order around...</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+// easier. Clients typically open a filter list and either enumerate the</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+// filters, or add new filters, or change the order around...</span>
<a href="#l11.16"></a><span id="l11.16"> //</span>
<a href="#l11.17"></a><span id="l11.17"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> class nsIMsgFilter;</span>
<a href="#l11.20"></a><span id="l11.20"> class nsMsgFilter;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-class nsMsgFilterList : public nsIMsgFilterList</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-{</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-public:</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+class nsMsgFilterList : public nsIMsgFilterList {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ public:</span>
<a href="#l11.27"></a><span id="l11.27">   NS_DECL_ISUPPORTS</span>
<a href="#l11.28"></a><span id="l11.28">   NS_DECL_NSIMSGFILTERLIST</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   nsMsgFilterList();</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">   nsresult Close();</span>
<a href="#l11.33"></a><span id="l11.33">   nsresult LoadTextFilters(already_AddRefed&lt;nsIInputStream&gt; aStream);</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35">   bool m_temporaryList;</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-protected:</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ protected:</span>
<a href="#l11.39"></a><span id="l11.39">   virtual ~nsMsgFilterList();</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41">   nsresult ComputeArbitraryHeaders();</span>
<a href="#l11.42"></a><span id="l11.42">   nsresult SaveTextFilters(nsIOutputStream *aStream);</span>
<a href="#l11.43"></a><span id="l11.43">   // file streaming methods</span>
<a href="#l11.44"></a><span id="l11.44">   int ReadChar(nsIInputStream *aStream);</span>
<a href="#l11.45"></a><span id="l11.45">   int SkipWhitespace(nsIInputStream *aStream);</span>
<a href="#l11.46"></a><span id="l11.46">   bool StrToBool(nsCString &amp;str);</span>
<a href="#l11.47"></a><span id="l11.47">   int LoadAttrib(nsMsgFilterFileAttribValue &amp;attrib, nsIInputStream *aStream);</span>
<a href="#l11.48"></a><span id="l11.48">   const char *GetStringForAttrib(nsMsgFilterFileAttribValue attrib);</span>
<a href="#l11.49"></a><span id="l11.49">   nsresult LoadValue(nsCString &amp;value, nsIInputStream *aStream);</span>
<a href="#l11.50"></a><span id="l11.50">   int16_t m_fileVersion;</span>
<a href="#l11.51"></a><span id="l11.51">   bool m_loggingEnabled;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  bool m_startWritingToBuffer; //tells us when to start writing one whole filter to m_unparsedBuffer</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  bool m_startWritingToBuffer;  // tells us when to start writing one whole</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+                                // filter to m_unparsedBuffer</span>
<a href="#l11.55"></a><span id="l11.55">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  nsMsgFilter *m_curFilter; // filter we're filing in or out(?)</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  nsMsgFilter *m_curFilter;  // filter we're filing in or out(?)</span>
<a href="#l11.58"></a><span id="l11.58">   nsCString m_listId;</span>
<a href="#l11.59"></a><span id="l11.59">   nsTArray&lt;nsCOMPtr&lt;nsIMsgFilter&gt; &gt; m_filters;</span>
<a href="#l11.60"></a><span id="l11.60">   nsCString m_arbitraryHeaders;</span>
<a href="#l11.61"></a><span id="l11.61">   nsCOMPtr&lt;nsIFile&gt; m_defaultFile;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  nsCString m_unparsedFilterBuffer; //holds one entire filter unparsed</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  nsCString m_unparsedFilterBuffer;  // holds one entire filter unparsed</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-private:</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ private:</span>
<a href="#l11.67"></a><span id="l11.67">   nsresult TruncateLog();</span>
<a href="#l11.68"></a><span id="l11.68">   nsresult GetLogFile(nsIFile **aFile);</span>
<a href="#l11.69"></a><span id="l11.69">   nsresult EnsureLogFile(nsIFile *file);</span>
<a href="#l11.70"></a><span id="l11.70">   nsCOMPtr&lt;nsIOutputStream&gt; m_logStream;</span>
<a href="#l11.71"></a><span id="l11.71"> };</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -48,88 +48,93 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMsgOperationListener.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> using namespace mozilla;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> LazyLogModule FILTERLOGMODULE(&quot;Filters&quot;);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#define BREAK_IF_FAILURE(_rv, _text) if (NS_FAILED(_rv)) { \</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter error: %s&quot;, _text)); \</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-  NS_WARNING(_text); \</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  mFinalResult = _rv; \</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-  break; \</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-}</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+#define BREAK_IF_FAILURE(_rv, _text)                                    \</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  if (NS_FAILED(_rv)) {                                                 \</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,                           \</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+            (&quot;(Post) Filter error: %s&quot;, _text));                        \</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    NS_WARNING(_text);                                                  \</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    mFinalResult = _rv;                                                 \</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+    break;                                                              \</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+  }</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-#define CONTINUE_IF_FAILURE(_rv, _text) if (NS_FAILED(_rv)) { \</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning, (&quot;(Post) Filter problem: %s&quot;, _text)); \</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  NS_WARNING(_text); \</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  mFinalResult = _rv; \</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) \</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-    return OnEndExecution(); \</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  continue; \</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-}</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+#define CONTINUE_IF_FAILURE(_rv, _text)                                     \</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  if (NS_FAILED(_rv)) {                                                     \</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,                             \</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+            (&quot;(Post) Filter problem: %s&quot;, _text));                          \</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter);     \</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    NS_WARNING(_text);                                                      \</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    mFinalResult = _rv;                                                     \</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution(); \</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    continue;                                                               \</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+  }</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-#define BREAK_IF_FALSE(_assertTrue, _text) if (!(_assertTrue)) { \</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter error: %s&quot;, _text)); \</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  NS_WARNING(_text); \</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-  mFinalResult = NS_ERROR_FAILURE; \</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-  break; \</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-}</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+#define BREAK_IF_FALSE(_assertTrue, _text)                              \</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  if (!(_assertTrue)) {                                                 \</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,                           \</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+            (&quot;(Post) Filter error: %s&quot;, _text));                        \</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    NS_WARNING(_text);                                                  \</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+    mFinalResult = NS_ERROR_FAILURE;                                    \</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    break;                                                              \</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  }</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-#define CONTINUE_IF_FALSE(_assertTrue, _text) if (!(_assertTrue)) { \</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning, (&quot;(Post) Filter problem: %s&quot;, _text)); \</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-  NS_WARNING(_text); \</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-  mFinalResult = NS_ERROR_FAILURE; \</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) \</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-    return OnEndExecution(); \</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  continue; \</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-}</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+#define CONTINUE_IF_FALSE(_assertTrue, _text)                               \</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+  if (!(_assertTrue)) {                                                     \</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,                             \</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+            (&quot;(Post) Filter problem: %s&quot;, _text));                          \</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter);     \</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+    NS_WARNING(_text);                                                      \</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    mFinalResult = NS_ERROR_FAILURE;                                        \</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution(); \</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+    continue;                                                               \</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  }</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86"> NS_IMPL_ISUPPORTS(nsMsgFilterService, nsIMsgFilterService)</span>
<a href="#l12.87"></a><span id="l12.87"> </span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-nsMsgFilterService::nsMsgFilterService()</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-{</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+nsMsgFilterService::nsMsgFilterService() {</span>
<a href="#l12.91"></a><span id="l12.91">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;nsMsgFilterService&quot;));</span>
<a href="#l12.92"></a><span id="l12.92"> }</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-nsMsgFilterService::~nsMsgFilterService()</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-{</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+nsMsgFilterService::~nsMsgFilterService() {</span>
<a href="#l12.97"></a><span id="l12.97">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;~nsMsgFilterService&quot;));</span>
<a href="#l12.98"></a><span id="l12.98"> }</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::OpenFilterList(nsIFile *aFilterFile,</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-                                                 nsIMsgFolder *rootFolder,</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-                                                 nsIMsgFilterList **resultFilterList)</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-{</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::OpenFilterList(</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+    nsIFile *aFilterFile, nsIMsgFolder *rootFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+    nsIMsgFilterList **resultFilterList) {</span>
<a href="#l12.108"></a><span id="l12.108">   NS_ENSURE_ARG_POINTER(aFilterFile);</span>
<a href="#l12.109"></a><span id="l12.109">   NS_ENSURE_ARG_POINTER(resultFilterList);</span>
<a href="#l12.110"></a><span id="l12.110"> </span>
<a href="#l12.111"></a><span id="l12.111">   if (rootFolder) {</span>
<a href="#l12.112"></a><span id="l12.112">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.113"></a><span id="l12.113">     rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l12.114"></a><span id="l12.114">     nsString serverName;</span>
<a href="#l12.115"></a><span id="l12.115">     server-&gt;GetPrettyName(serverName);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Reading filter list for account '%s'&quot;, NS_ConvertUTF16toUTF8(serverName).get()));</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+            (&quot;Reading filter list for account '%s'&quot;,</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+             NS_ConvertUTF16toUTF8(serverName).get()));</span>
<a href="#l12.120"></a><span id="l12.120">   }</span>
<a href="#l12.121"></a><span id="l12.121"> </span>
<a href="#l12.122"></a><span id="l12.122">   nsString fileName;</span>
<a href="#l12.123"></a><span id="l12.123">   (void)aFilterFile-&gt;GetPath(fileName);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;Reading filter list from file '%s'&quot;, NS_ConvertUTF16toUTF8(fileName).get()));</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+          (&quot;Reading filter list from file '%s'&quot;,</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+           NS_ConvertUTF16toUTF8(fileName).get()));</span>
<a href="#l12.128"></a><span id="l12.128"> </span>
<a href="#l12.129"></a><span id="l12.129">   bool exists = false;</span>
<a href="#l12.130"></a><span id="l12.130">   nsresult rv = aFilterFile-&gt;Exists(&amp;exists);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-  {</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  if (NS_FAILED(rv) || !exists) {</span>
<a href="#l12.134"></a><span id="l12.134">     rv = aFilterFile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0644);</span>
<a href="#l12.135"></a><span id="l12.135">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.136"></a><span id="l12.136">   }</span>
<a href="#l12.137"></a><span id="l12.137"> </span>
<a href="#l12.138"></a><span id="l12.138">   nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l12.139"></a><span id="l12.139">   rv = NS_NewLocalFileInputStream(getter_AddRefs(fileStream), aFilterFile);</span>
<a href="#l12.140"></a><span id="l12.140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.141"></a><span id="l12.141">   NS_ENSURE_TRUE(fileStream, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineat">@@ -139,953 +144,955 @@ NS_IMETHODIMP nsMsgFilterService::OpenFi</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144">   // temporarily tell the filter where its file path is</span>
<a href="#l12.145"></a><span id="l12.145">   filterList-&gt;SetDefaultFile(aFilterFile);</span>
<a href="#l12.146"></a><span id="l12.146"> </span>
<a href="#l12.147"></a><span id="l12.147">   int64_t size = 0;</span>
<a href="#l12.148"></a><span id="l12.148">   rv = aFilterFile-&gt;GetFileSize(&amp;size);</span>
<a href="#l12.149"></a><span id="l12.149">   if (NS_SUCCEEDED(rv) &amp;&amp; size &gt; 0)</span>
<a href="#l12.150"></a><span id="l12.150">     rv = filterList-&gt;LoadTextFilters(fileStream.forget());</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-  {</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.154"></a><span id="l12.154">     int16_t version;</span>
<a href="#l12.155"></a><span id="l12.155">     filterList-&gt;GetVersion(&amp;version);</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-    if (version != kFileVersion)</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-      SaveFilterList(filterList, aFilterFile);</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-  }</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-  else</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-  {</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-    if (rv == NS_MSG_FILTER_PARSE_ERROR &amp;&amp; aMsgWindow)</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-    {</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+    if (version != kFileVersion) SaveFilterList(filterList, aFilterFile);</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+  } else {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+    if (rv == NS_MSG_FILTER_PARSE_ERROR &amp;&amp; aMsgWindow) {</span>
<a href="#l12.166"></a><span id="l12.166">       rv = BackUpFilterFile(aFilterFile, aMsgWindow);</span>
<a href="#l12.167"></a><span id="l12.167">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.168"></a><span id="l12.168">       rv = aFilterFile-&gt;SetFileSize(0);</span>
<a href="#l12.169"></a><span id="l12.169">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-      return OpenFilterList(aFilterFile, rootFolder, aMsgWindow, resultFilterList);</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-    }</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-    else if (rv == NS_MSG_CUSTOM_HEADERS_OVERFLOW &amp;&amp; aMsgWindow)</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+      return OpenFilterList(aFilterFile, rootFolder, aMsgWindow,</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+                            resultFilterList);</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+    } else if (rv == NS_MSG_CUSTOM_HEADERS_OVERFLOW &amp;&amp; aMsgWindow)</span>
<a href="#l12.176"></a><span id="l12.176">       ThrowAlertMsg(&quot;filterCustomHeaderOverflow&quot;, aMsgWindow);</span>
<a href="#l12.177"></a><span id="l12.177">     else if (rv == NS_MSG_INVALID_CUSTOM_HEADER &amp;&amp; aMsgWindow)</span>
<a href="#l12.178"></a><span id="l12.178">       ThrowAlertMsg(&quot;invalidCustomHeader&quot;, aMsgWindow);</span>
<a href="#l12.179"></a><span id="l12.179">   }</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181">   nsCString listId;</span>
<a href="#l12.182"></a><span id="l12.182">   filterList-&gt;GetListId(listId);</span>
<a href="#l12.183"></a><span id="l12.183">   uint32_t filterCount = 0;</span>
<a href="#l12.184"></a><span id="l12.184">   (void)filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Read %&quot; PRIu32 &quot; filters&quot;, filterCount));</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Filter list stored as %s&quot;, listId.get()));</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+          (&quot;Read %&quot; PRIu32 &quot; filters&quot;, filterCount));</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+          (&quot;Filter list stored as %s&quot;, listId.get()));</span>
<a href="#l12.191"></a><span id="l12.191"> </span>
<a href="#l12.192"></a><span id="l12.192">   filterList.forget(resultFilterList);</span>
<a href="#l12.193"></a><span id="l12.193">   return rv;</span>
<a href="#l12.194"></a><span id="l12.194"> }</span>
<a href="#l12.195"></a><span id="l12.195"> </span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::CloseFilterList(nsIMsgFilterList *filterList)</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-{</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-  //NS_ASSERTION(false,&quot;CloseFilterList doesn't do anything yet&quot;);</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::CloseFilterList(</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+    nsIMsgFilterList *filterList) {</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+  // NS_ASSERTION(false,&quot;CloseFilterList doesn't do anything yet&quot;);</span>
<a href="#l12.202"></a><span id="l12.202">   return NS_OK;</span>
<a href="#l12.203"></a><span id="l12.203"> }</span>
<a href="#l12.204"></a><span id="l12.204"> </span>
<a href="#l12.205"></a><span id="l12.205"> /* save without deleting */</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-NS_IMETHODIMP  nsMsgFilterService::SaveFilterList(nsIMsgFilterList *filterList, nsIFile *filterFile)</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-{</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::SaveFilterList(nsIMsgFilterList *filterList,</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+                                                 nsIFile *filterFile) {</span>
<a href="#l12.210"></a><span id="l12.210">   NS_ENSURE_ARG_POINTER(filterFile);</span>
<a href="#l12.211"></a><span id="l12.211">   NS_ENSURE_ARG_POINTER(filterList);</span>
<a href="#l12.212"></a><span id="l12.212"> </span>
<a href="#l12.213"></a><span id="l12.213">   nsCString listId;</span>
<a href="#l12.214"></a><span id="l12.214">   filterList-&gt;GetListId(listId);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Saving filter list %s&quot;, listId.get()));</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+          (&quot;Saving filter list %s&quot;, listId.get()));</span>
<a href="#l12.218"></a><span id="l12.218"> </span>
<a href="#l12.219"></a><span id="l12.219">   nsCOMPtr&lt;nsIOutputStream&gt; strm;</span>
<a href="#l12.220"></a><span id="l12.220">   nsresult rv = MsgNewSafeBufferedFileOutputStream(getter_AddRefs(strm),</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineminus">-                                                filterFile, -1, 0600);</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+                                                   filterFile, -1, 0600);</span>
<a href="#l12.223"></a><span id="l12.223">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.224"></a><span id="l12.224"> </span>
<a href="#l12.225"></a><span id="l12.225">   rv = filterList-&gt;SaveToFile(strm);</span>
<a href="#l12.226"></a><span id="l12.226"> </span>
<a href="#l12.227"></a><span id="l12.227">   nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(strm);</span>
<a href="#l12.228"></a><span id="l12.228">   NS_ASSERTION(safeStream, &quot;expected a safe output stream!&quot;);</span>
<a href="#l12.229"></a><span id="l12.229">   if (safeStream) {</span>
<a href="#l12.230"></a><span id="l12.230">     rv = safeStream-&gt;Finish();</span>
<a href="#l12.231"></a><span id="l12.231">     if (NS_FAILED(rv)) {</span>
<a href="#l12.232"></a><span id="l12.232">       NS_WARNING(&quot;failed to save filter file! possible data loss&quot;);</span>
<a href="#l12.233"></a><span id="l12.233">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;Save of list failed&quot;));</span>
<a href="#l12.234"></a><span id="l12.234">     }</span>
<a href="#l12.235"></a><span id="l12.235">   }</span>
<a href="#l12.236"></a><span id="l12.236">   return rv;</span>
<a href="#l12.237"></a><span id="l12.237"> }</span>
<a href="#l12.238"></a><span id="l12.238"> </span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::CancelFilterList(nsIMsgFilterList *filterList)</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-{</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::CancelFilterList(</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+    nsIMsgFilterList *filterList) {</span>
<a href="#l12.243"></a><span id="l12.243">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.244"></a><span id="l12.244"> }</span>
<a href="#l12.245"></a><span id="l12.245"> </span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-nsresult nsMsgFilterService::BackUpFilterFile(nsIFile *aFilterFile, nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-{</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+nsresult nsMsgFilterService::BackUpFilterFile(nsIFile *aFilterFile,</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+                                              nsIMsgWindow *aMsgWindow) {</span>
<a href="#l12.250"></a><span id="l12.250">   AlertBackingUpFilterFile(aMsgWindow);</span>
<a href="#l12.251"></a><span id="l12.251"> </span>
<a href="#l12.252"></a><span id="l12.252">   nsCOMPtr&lt;nsIFile&gt; localParentDir;</span>
<a href="#l12.253"></a><span id="l12.253">   nsresult rv = aFilterFile-&gt;GetParent(getter_AddRefs(localParentDir));</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.256"></a><span id="l12.256"> </span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-  //if back-up file exists delete the back up file otherwise copy fails.</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; backupFile;</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+  // if back-up file exists delete the back up file otherwise copy fails.</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; backupFile;</span>
<a href="#l12.261"></a><span id="l12.261">   rv = localParentDir-&gt;Clone(getter_AddRefs(backupFile));</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.264"></a><span id="l12.264">   backupFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;rulesbackup.dat&quot;));</span>
<a href="#l12.265"></a><span id="l12.265">   bool exists;</span>
<a href="#l12.266"></a><span id="l12.266">   backupFile-&gt;Exists(&amp;exists);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineminus">-  if (exists)</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineminus">-    backupFile-&gt;Remove(false);</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+  if (exists) backupFile-&gt;Remove(false);</span>
<a href="#l12.270"></a><span id="l12.270"> </span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-  return aFilterFile-&gt;CopyToNative(localParentDir, NS_LITERAL_CSTRING(&quot;rulesbackup.dat&quot;));</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+  return aFilterFile-&gt;CopyToNative(localParentDir,</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+                                   NS_LITERAL_CSTRING(&quot;rulesbackup.dat&quot;));</span>
<a href="#l12.274"></a><span id="l12.274"> }</span>
<a href="#l12.275"></a><span id="l12.275"> </span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-nsresult nsMsgFilterService::AlertBackingUpFilterFile(nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-{</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+nsresult nsMsgFilterService::AlertBackingUpFilterFile(</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+    nsIMsgWindow *aMsgWindow) {</span>
<a href="#l12.280"></a><span id="l12.280">   return ThrowAlertMsg(&quot;filterListBackUpMsg&quot;, aMsgWindow);</span>
<a href="#l12.281"></a><span id="l12.281"> }</span>
<a href="#l12.282"></a><span id="l12.282"> </span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">-nsresult //Do not use this routine if you have to call it very often because it creates a new bundle each time</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">-nsMsgFilterService::GetStringFromBundle(const char *aMsgName, nsAString&amp; aResult)</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-{</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+// Do not use this routine if you have to call it very often because it creates</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+// a new bundle each time.</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+nsresult nsMsgFilterService::GetStringFromBundle(const char *aMsgName,</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+                                                 nsAString &amp;aResult) {</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l12.292"></a><span id="l12.292">   nsresult rv = GetFilterStringBundle(getter_AddRefs(bundle));</span>
<a href="#l12.293"></a><span id="l12.293">   if (NS_SUCCEEDED(rv) &amp;&amp; bundle)</span>
<a href="#l12.294"></a><span id="l12.294">     rv = bundle-&gt;GetStringFromName(aMsgName, aResult);</span>
<a href="#l12.295"></a><span id="l12.295">   return rv;</span>
<a href="#l12.296"></a><span id="l12.296"> }</span>
<a href="#l12.297"></a><span id="l12.297"> </span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-nsresult</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-nsMsgFilterService::GetFilterStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-{</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+nsresult nsMsgFilterService::GetFilterStringBundle(nsIStringBundle **aBundle) {</span>
<a href="#l12.302"></a><span id="l12.302">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l12.303"></a><span id="l12.303"> </span>
<a href="#l12.304"></a><span id="l12.304">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-         mozilla::services::GetStringBundleService();</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l12.307"></a><span id="l12.307">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l12.308"></a><span id="l12.308">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l12.309"></a><span id="l12.309">   if (bundleService)</span>
<a href="#l12.310"></a><span id="l12.310">     bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-                                 getter_AddRefs(bundle));</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+                                getter_AddRefs(bundle));</span>
<a href="#l12.313"></a><span id="l12.313">   bundle.forget(aBundle);</span>
<a href="#l12.314"></a><span id="l12.314">   return NS_OK;</span>
<a href="#l12.315"></a><span id="l12.315"> }</span>
<a href="#l12.316"></a><span id="l12.316"> </span>
<a href="#l12.317"></a><span id="l12.317" class="difflineminus">-nsresult</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineminus">-nsMsgFilterService::ThrowAlertMsg(const char*aMsgName, nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineminus">-{</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+nsresult nsMsgFilterService::ThrowAlertMsg(const char *aMsgName,</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+                                           nsIMsgWindow *aMsgWindow) {</span>
<a href="#l12.322"></a><span id="l12.322">   nsString alertString;</span>
<a href="#l12.323"></a><span id="l12.323">   nsresult rv = GetStringFromBundle(aMsgName, alertString);</span>
<a href="#l12.324"></a><span id="l12.324">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow = aMsgWindow;</span>
<a href="#l12.325"></a><span id="l12.325">   if (!msgWindow) {</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession ( do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l12.329"></a><span id="l12.329">     if (NS_SUCCEEDED(rv))</span>
<a href="#l12.330"></a><span id="l12.330">       rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l12.331"></a><span id="l12.331">   }</span>
<a href="#l12.332"></a><span id="l12.332"> </span>
<a href="#l12.333"></a><span id="l12.333" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !alertString.IsEmpty() &amp;&amp; msgWindow)</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineminus">-  {</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-    nsCOMPtr &lt;nsIDocShell&gt; docShell;</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !alertString.IsEmpty() &amp;&amp; msgWindow) {</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+    nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l12.338"></a><span id="l12.338">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineminus">-    if (docShell)</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineminus">-    {</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+    if (docShell) {</span>
<a href="#l12.342"></a><span id="l12.342">       nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(docShell));</span>
<a href="#l12.343"></a><span id="l12.343">       if (dialog &amp;&amp; !alertString.IsEmpty())</span>
<a href="#l12.344"></a><span id="l12.344">         dialog-&gt;Alert(nullptr, alertString.get());</span>
<a href="#l12.345"></a><span id="l12.345">     }</span>
<a href="#l12.346"></a><span id="l12.346">   }</span>
<a href="#l12.347"></a><span id="l12.347">   return rv;</span>
<a href="#l12.348"></a><span id="l12.348"> }</span>
<a href="#l12.349"></a><span id="l12.349"> </span>
<a href="#l12.350"></a><span id="l12.350" class="difflineminus">-// this class is used to run filters after the fact, i.e., after new mail has been downloaded from the server.</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineminus">-// It can do the following:</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+// this class is used to run filters after the fact, i.e., after new mail has</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+// been downloaded from the server. It can do the following:</span>
<a href="#l12.354"></a><span id="l12.354"> // 1. Apply a single imap or pop3 filter on a single folder.</span>
<a href="#l12.355"></a><span id="l12.355"> // 2. Apply multiple filters on a single imap or pop3 folder.</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineminus">-// 3. Apply a single filter on multiple imap or pop3 folders in the same account.</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineminus">-// 4. Apply multiple filters on multiple imap or pop3 folders in the same account.</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineminus">-// This will be called from the front end js code in the case of the apply filters to folder menu code,</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-// and from the filter dialog js code with the run filter now command.</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+// 3. Apply a single filter on multiple imap or pop3 folders in the same</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+//    account.</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+// 4. Apply multiple filters on multiple imap or pop3 folders in the same</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+//    account.</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+// This will be called from the front end js code in the case of the</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+// apply filters to folder menu code, and from the filter dialog js code with</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+// the run filter now command.</span>
<a href="#l12.368"></a><span id="l12.368"> </span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-// this class holds the list of filters and folders, and applies them in turn, first iterating</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-// over all the filters on one folder, and then advancing to the next folder and repeating.</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineminus">-// For each filter,we take the filter criteria and create a search term list. Then, we execute the search.</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineminus">-// We are a search listener so that we can build up the list of search hits.</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineminus">-// Then, when the search is done, we will apply the filter action(s) en-masse, so, for example, if the action is a move,</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineminus">-// we calls one method to move all the messages to the destination folder. Or, mark all the messages read.</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-// In the case of imap operations, or imap/local  moves, the action will be asynchronous, so we'll need to be a url listener</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineminus">-// as well, and kick off the next filter when the action completes.</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-class nsMsgFilterAfterTheFact : public nsIUrlListener, public nsIMsgSearchNotify, public nsIMsgCopyServiceListener</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineminus">-{</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineminus">-public:</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+// this class holds the list of filters and folders, and applies them in turn,</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+// first iterating over all the filters on one folder, and then advancing to the</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+// next folder and repeating. For each filter,we take the filter criteria and</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+// create a search term list. Then, we execute the search. We are a search</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+// listener so that we can build up the list of search hits. Then, when the</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+// search is done, we will apply the filter action(s) en-masse, so, for example,</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineplus">+// if the action is a move, we calls one method to move all the messages to the</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineplus">+// destination folder. Or, mark all the messages read. In the case of imap</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineplus">+// operations, or imap/local  moves, the action will be asynchronous, so we'll</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+// need to be a url listener as well, and kick off the next filter when the</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineplus">+// action completes.</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineplus">+class nsMsgFilterAfterTheFact : public nsIUrlListener,</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineplus">+                                public nsIMsgSearchNotify,</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+                                public nsIMsgCopyServiceListener {</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+ public:</span>
<a href="#l12.395"></a><span id="l12.395">   nsMsgFilterAfterTheFact(nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.396"></a><span id="l12.396">                           nsIMsgFilterList *aFilterList, nsIArray *aFolderList,</span>
<a href="#l12.397"></a><span id="l12.397">                           nsIMsgOperationListener *aCallback);</span>
<a href="#l12.398"></a><span id="l12.398">   NS_DECL_ISUPPORTS</span>
<a href="#l12.399"></a><span id="l12.399">   NS_DECL_NSIURLLISTENER</span>
<a href="#l12.400"></a><span id="l12.400">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l12.401"></a><span id="l12.401">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l12.402"></a><span id="l12.402"> </span>
<a href="#l12.403"></a><span id="l12.403" class="difflineminus">-  nsresult  AdvanceToNextFolder();  // kicks off the process</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineminus">-protected:</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+  nsresult AdvanceToNextFolder();  // kicks off the process</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+ protected:</span>
<a href="#l12.407"></a><span id="l12.407">   virtual ~nsMsgFilterAfterTheFact();</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineminus">-  virtual   nsresult  RunNextFilter();</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineplus">+  virtual nsresult RunNextFilter();</span>
<a href="#l12.410"></a><span id="l12.410">   /**</span>
<a href="#l12.411"></a><span id="l12.411">    * apply filter actions to current search hits</span>
<a href="#l12.412"></a><span id="l12.412">    */</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineminus">-  nsresult  ApplyFilter();</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineminus">-  nsresult  OnEndExecution(); // do what we have to do to cleanup.</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineminus">-  bool      ContinueExecutionPrompt();</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineminus">-  nsresult  DisplayConfirmationPrompt(nsIMsgWindow *msgWindow, const char16_t *confirmString, bool *confirmed);</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-  nsCOMPtr&lt;nsIMsgWindow&gt;      m_msgWindow;</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFilterList&gt;  m_filters;</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt;          m_folders;</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;      m_curFolder;</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDatabase&gt;    m_curFolderDB;</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFilter&gt;      m_curFilter;</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineminus">-  uint32_t                    m_curFilterIndex;</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineminus">-  uint32_t                    m_curFolderIndex;</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineminus">-  uint32_t                    m_numFilters;</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineminus">-  uint32_t                    m_numFolders;</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt;          m_searchHits;</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt;   m_searchHitHdrs;</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt;          m_stopFiltering;</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineplus">+  nsresult ApplyFilter();</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+  nsresult OnEndExecution();  // do what we have to do to cleanup.</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineplus">+  bool ContinueExecutionPrompt();</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+  nsresult DisplayConfirmationPrompt(nsIMsgWindow *msgWindow,</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineplus">+                                     const char16_t *confirmString,</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineplus">+                                     bool *confirmed);</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; m_filters;</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_folders;</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_curFolder;</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_curFolderDB;</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilter&gt; m_curFilter;</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+  uint32_t m_curFilterIndex;</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineplus">+  uint32_t m_curFolderIndex;</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineplus">+  uint32_t m_numFilters;</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+  uint32_t m_numFolders;</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_searchHits;</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; m_searchHitHdrs;</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_stopFiltering;</span>
<a href="#l12.449"></a><span id="l12.449">   nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l12.450"></a><span id="l12.450">   nsCOMPtr&lt;nsIMsgOperationListener&gt; m_callback;</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-  uint32_t                    m_nextAction; // next filter action to perform</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineminus">-  nsresult                    mFinalResult; // report of overall success or failure</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineminus">-  bool                        mNeedsRelease; // Did we need to release ourself?</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineplus">+  uint32_t m_nextAction;  // next filter action to perform</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineplus">+  nsresult mFinalResult;  // report of overall success or failure</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineplus">+  bool mNeedsRelease;     // Did we need to release ourself?</span>
<a href="#l12.457"></a><span id="l12.457"> };</span>
<a href="#l12.458"></a><span id="l12.458"> </span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgFilterAfterTheFact, nsIUrlListener, nsIMsgSearchNotify, nsIMsgCopyServiceListener)</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgFilterAfterTheFact, nsIUrlListener, nsIMsgSearchNotify,</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineplus">+                  nsIMsgCopyServiceListener)</span>
<a href="#l12.462"></a><span id="l12.462"> </span>
<a href="#l12.463"></a><span id="l12.463" class="difflineminus">-nsMsgFilterAfterTheFact::nsMsgFilterAfterTheFact(nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineminus">-                                                 nsIMsgFilterList *aFilterList,</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineminus">-                                                 nsIArray *aFolderList,</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineminus">-                                                 nsIMsgOperationListener *aCallback)</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineminus">-{</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineplus">+nsMsgFilterAfterTheFact::nsMsgFilterAfterTheFact(</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIMsgFilterList *aFilterList,</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineplus">+    nsIArray *aFolderList, nsIMsgOperationListener *aCallback) {</span>
<a href="#l12.471"></a><span id="l12.471">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact&quot;));</span>
<a href="#l12.472"></a><span id="l12.472">   m_curFilterIndex = m_curFolderIndex = m_nextAction = 0;</span>
<a href="#l12.473"></a><span id="l12.473">   m_msgWindow = aMsgWindow;</span>
<a href="#l12.474"></a><span id="l12.474">   m_filters = aFilterList;</span>
<a href="#l12.475"></a><span id="l12.475">   m_folders = aFolderList;</span>
<a href="#l12.476"></a><span id="l12.476">   m_filters-&gt;GetFilterCount(&amp;m_numFilters);</span>
<a href="#l12.477"></a><span id="l12.477">   m_folders-&gt;GetLength(&amp;m_numFolders);</span>
<a href="#l12.478"></a><span id="l12.478"> </span>
<a href="#l12.479"></a><span id="l12.479" class="difflineminus">-  NS_ADDREF_THIS(); // we own ourselves, and will release ourselves when execution is done.</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineplus">+  NS_ADDREF_THIS();  // we own ourselves, and will release ourselves when</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+                     // execution is done.</span>
<a href="#l12.482"></a><span id="l12.482">   mNeedsRelease = true;</span>
<a href="#l12.483"></a><span id="l12.483"> </span>
<a href="#l12.484"></a><span id="l12.484">   m_searchHitHdrs = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l12.485"></a><span id="l12.485">   m_callback = aCallback;</span>
<a href="#l12.486"></a><span id="l12.486">   mFinalResult = NS_OK;</span>
<a href="#l12.487"></a><span id="l12.487"> }</span>
<a href="#l12.488"></a><span id="l12.488"> </span>
<a href="#l12.489"></a><span id="l12.489" class="difflineminus">-nsMsgFilterAfterTheFact::~nsMsgFilterAfterTheFact()</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineminus">-{</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) ~nsMsgFilterAfterTheFact&quot;));</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineplus">+nsMsgFilterAfterTheFact::~nsMsgFilterAfterTheFact() {</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+          (&quot;(Post) ~nsMsgFilterAfterTheFact&quot;));</span>
<a href="#l12.495"></a><span id="l12.495"> }</span>
<a href="#l12.496"></a><span id="l12.496"> </span>
<a href="#l12.497"></a><span id="l12.497"> // do what we have to do to cleanup.</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineminus">-nsresult nsMsgFilterAfterTheFact::OnEndExecution()</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineminus">-{</span>
<a href="#l12.500"></a><span id="l12.500" class="difflineminus">-  if (m_searchSession)</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineminus">-    m_searchSession-&gt;UnregisterListener(this);</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineplus">+nsresult nsMsgFilterAfterTheFact::OnEndExecution() {</span>
<a href="#l12.503"></a><span id="l12.503" class="difflineplus">+  if (m_searchSession) m_searchSession-&gt;UnregisterListener(this);</span>
<a href="#l12.504"></a><span id="l12.504"> </span>
<a href="#l12.505"></a><span id="l12.505" class="difflineminus">-  if (m_filters)</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-    (void)m_filters-&gt;FlushLogIfNecessary();</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineplus">+  if (m_filters) (void)m_filters-&gt;FlushLogIfNecessary();</span>
<a href="#l12.508"></a><span id="l12.508"> </span>
<a href="#l12.509"></a><span id="l12.509" class="difflineminus">-  if (m_callback)</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineminus">-    (void)m_callback-&gt;OnStopOperation(mFinalResult);</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineplus">+  if (m_callback) (void)m_callback-&gt;OnStopOperation(mFinalResult);</span>
<a href="#l12.512"></a><span id="l12.512"> </span>
<a href="#l12.513"></a><span id="l12.513">   nsresult rv = mFinalResult;</span>
<a href="#l12.514"></a><span id="l12.514">   // OnEndExecution() can be called a second time when a rule execution fails</span>
<a href="#l12.515"></a><span id="l12.515">   // and the user is prompted whether he wants to continue.</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineminus">-  if (mNeedsRelease)</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineminus">-  {</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineminus">-    NS_RELEASE_THIS(); // release ourselves.</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineplus">+  if (mNeedsRelease) {</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineplus">+    NS_RELEASE_THIS();  // release ourselves.</span>
<a href="#l12.521"></a><span id="l12.521">     mNeedsRelease = false;</span>
<a href="#l12.522"></a><span id="l12.522">   }</span>
<a href="#l12.523"></a><span id="l12.523">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) End executing filters&quot;));</span>
<a href="#l12.524"></a><span id="l12.524">   return rv;</span>
<a href="#l12.525"></a><span id="l12.525"> }</span>
<a href="#l12.526"></a><span id="l12.526"> </span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-nsresult nsMsgFilterAfterTheFact::RunNextFilter()</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-{</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact::RunNextFilter&quot;));</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineplus">+nsresult nsMsgFilterAfterTheFact::RunNextFilter() {</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+          (&quot;(Post) nsMsgFilterAfterTheFact::RunNextFilter&quot;));</span>
<a href="#l12.533"></a><span id="l12.533">   nsresult rv = NS_OK;</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineminus">-  while (true)</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineminus">-  {</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineplus">+  while (true) {</span>
<a href="#l12.537"></a><span id="l12.537">     m_curFilter = nullptr;</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineminus">-    if (m_curFilterIndex &gt;= m_numFilters)</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineminus">-      break;</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineplus">+    if (m_curFilterIndex &gt;= m_numFilters) break;</span>
<a href="#l12.541"></a><span id="l12.541"> </span>
<a href="#l12.542"></a><span id="l12.542">     BREAK_IF_FALSE(m_filters, &quot;Missing filters&quot;);</span>
<a href="#l12.543"></a><span id="l12.543"> </span>
<a href="#l12.544"></a><span id="l12.544" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Running filter %&quot; PRIu32, m_curFilterIndex));</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineplus">+            (&quot;(Post) Running filter %&quot; PRIu32, m_curFilterIndex));</span>
<a href="#l12.547"></a><span id="l12.547"> </span>
<a href="#l12.548"></a><span id="l12.548" class="difflineminus">-    rv = m_filters-&gt;GetFilterAt(m_curFilterIndex++, getter_AddRefs(m_curFilter));</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineplus">+    rv =</span>
<a href="#l12.550"></a><span id="l12.550" class="difflineplus">+        m_filters-&gt;GetFilterAt(m_curFilterIndex++, getter_AddRefs(m_curFilter));</span>
<a href="#l12.551"></a><span id="l12.551">     CONTINUE_IF_FAILURE(rv, &quot;Could not get filter at index&quot;);</span>
<a href="#l12.552"></a><span id="l12.552"> </span>
<a href="#l12.553"></a><span id="l12.553">     nsString filterName;</span>
<a href="#l12.554"></a><span id="l12.554">     m_curFilter-&gt;GetFilterName(filterName);</span>
<a href="#l12.555"></a><span id="l12.555" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter name: %s&quot;, NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineplus">+    // clang-format off</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.558"></a><span id="l12.558" class="difflineplus">+            (&quot;(Post) Filter name: %s&quot;, NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineplus">+    // clang-format on</span>
<a href="#l12.560"></a><span id="l12.560"> </span>
<a href="#l12.561"></a><span id="l12.561">     nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l12.562"></a><span id="l12.562">     rv = m_curFilter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l12.563"></a><span id="l12.563">     CONTINUE_IF_FAILURE(rv, &quot;Could not get searchTerms&quot;);</span>
<a href="#l12.564"></a><span id="l12.564"> </span>
<a href="#l12.565"></a><span id="l12.565" class="difflineminus">-    if (m_searchSession)</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineminus">-      m_searchSession-&gt;UnregisterListener(this);</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+    if (m_searchSession) m_searchSession-&gt;UnregisterListener(this);</span>
<a href="#l12.568"></a><span id="l12.568">     m_searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l12.569"></a><span id="l12.569">     BREAK_IF_FAILURE(rv, &quot;Failed to get search session&quot;);</span>
<a href="#l12.570"></a><span id="l12.570"> </span>
<a href="#l12.571"></a><span id="l12.571">     nsMsgSearchScopeValue searchScope = nsMsgSearchScope::offlineMail;</span>
<a href="#l12.572"></a><span id="l12.572">     uint32_t termCount = 0;</span>
<a href="#l12.573"></a><span id="l12.573">     searchTerms-&gt;GetLength(&amp;termCount);</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineminus">-    for (uint32_t termIndex = 0; termIndex &lt; termCount; termIndex++)</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineminus">-    {</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineminus">-      nsCOMPtr&lt;nsIMsgSearchTerm&gt; term = do_QueryElementAt(searchTerms, termIndex, &amp;rv);</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+    for (uint32_t termIndex = 0; termIndex &lt; termCount; termIndex++) {</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineplus">+      nsCOMPtr&lt;nsIMsgSearchTerm&gt; term =</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineplus">+          do_QueryElementAt(searchTerms, termIndex, &amp;rv);</span>
<a href="#l12.580"></a><span id="l12.580">       BREAK_IF_FAILURE(rv, &quot;Could not get search term&quot;);</span>
<a href="#l12.581"></a><span id="l12.581">       rv = m_searchSession-&gt;AppendTerm(term);</span>
<a href="#l12.582"></a><span id="l12.582">       BREAK_IF_FAILURE(rv, &quot;Could not append search term&quot;);</span>
<a href="#l12.583"></a><span id="l12.583">     }</span>
<a href="#l12.584"></a><span id="l12.584">     CONTINUE_IF_FAILURE(rv, &quot;Failed to setup search terms&quot;);</span>
<a href="#l12.585"></a><span id="l12.585">     m_searchSession-&gt;RegisterListener(this,</span>
<a href="#l12.586"></a><span id="l12.586">                                       nsIMsgSearchSession::allNotifications);</span>
<a href="#l12.587"></a><span id="l12.587"> </span>
<a href="#l12.588"></a><span id="l12.588">     rv = m_searchSession-&gt;AddScopeTerm(searchScope, m_curFolder);</span>
<a href="#l12.589"></a><span id="l12.589">     CONTINUE_IF_FAILURE(rv, &quot;Failed to add scope term&quot;);</span>
<a href="#l12.590"></a><span id="l12.590">     m_nextAction = 0;</span>
<a href="#l12.591"></a><span id="l12.591">     rv = m_searchSession-&gt;Search(m_msgWindow);</span>
<a href="#l12.592"></a><span id="l12.592">     CONTINUE_IF_FAILURE(rv, &quot;Search failed&quot;);</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineminus">-    return NS_OK; // OnSearchDone will continue</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineplus">+    return NS_OK;  // OnSearchDone will continue</span>
<a href="#l12.595"></a><span id="l12.595">   }</span>
<a href="#l12.596"></a><span id="l12.596"> </span>
<a href="#l12.597"></a><span id="l12.597">   if (NS_FAILED(rv)) {</span>
<a href="#l12.598"></a><span id="l12.598" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter evaluation failed&quot;));</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineminus">-    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;), m_curFilter);</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineplus">+            (&quot;(Post) Filter evaluation failed&quot;));</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;),</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineplus">+                                m_curFilter);</span>
<a href="#l12.604"></a><span id="l12.604">   }</span>
<a href="#l12.605"></a><span id="l12.605"> </span>
<a href="#l12.606"></a><span id="l12.606">   m_curFilter = nullptr;</span>
<a href="#l12.607"></a><span id="l12.607">   NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;Search failed&quot;);</span>
<a href="#l12.608"></a><span id="l12.608">   return AdvanceToNextFolder();</span>
<a href="#l12.609"></a><span id="l12.609"> }</span>
<a href="#l12.610"></a><span id="l12.610"> </span>
<a href="#l12.611"></a><span id="l12.611" class="difflineminus">-nsresult nsMsgFilterAfterTheFact::AdvanceToNextFolder()</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineminus">-{</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact::AdvanceToNextFolder&quot;));</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineplus">+nsresult nsMsgFilterAfterTheFact::AdvanceToNextFolder() {</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineplus">+          (&quot;(Post) nsMsgFilterAfterTheFact::AdvanceToNextFolder&quot;));</span>
<a href="#l12.617"></a><span id="l12.617">   nsresult rv = NS_OK;</span>
<a href="#l12.618"></a><span id="l12.618">   // Advance through folders, making sure m_curFolder is null on errors</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineminus">-  while (true)</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineminus">-  {</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineplus">+  while (true) {</span>
<a href="#l12.622"></a><span id="l12.622">     m_stopFiltering.Clear();</span>
<a href="#l12.623"></a><span id="l12.623">     m_curFolder = nullptr;</span>
<a href="#l12.624"></a><span id="l12.624">     if (m_curFolderIndex &gt;= m_numFolders) {</span>
<a href="#l12.625"></a><span id="l12.625">       // final end of nsMsgFilterAfterTheFact object</span>
<a href="#l12.626"></a><span id="l12.626">       return OnEndExecution();</span>
<a href="#l12.627"></a><span id="l12.627">     }</span>
<a href="#l12.628"></a><span id="l12.628"> </span>
<a href="#l12.629"></a><span id="l12.629" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Entering folder %&quot; PRIu32, m_curFolderIndex));</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineplus">+            (&quot;(Post) Entering folder %&quot; PRIu32, m_curFolderIndex));</span>
<a href="#l12.632"></a><span id="l12.632"> </span>
<a href="#l12.633"></a><span id="l12.633">     // reset the filter index to apply all filters to this new folder</span>
<a href="#l12.634"></a><span id="l12.634">     m_curFilterIndex = 0;</span>
<a href="#l12.635"></a><span id="l12.635">     m_nextAction = 0;</span>
<a href="#l12.636"></a><span id="l12.636">     m_curFolder = do_QueryElementAt(m_folders, m_curFolderIndex++, &amp;rv);</span>
<a href="#l12.637"></a><span id="l12.637">     CONTINUE_IF_FAILURE(rv, &quot;Could not get next folder&quot;);</span>
<a href="#l12.638"></a><span id="l12.638"> </span>
<a href="#l12.639"></a><span id="l12.639">     // Note: I got rv = NS_OK but null m_curFolder after deleting a folder</span>
<a href="#l12.640"></a><span id="l12.640">     // outside of TB, when I select a single message and &quot;run filter on message&quot;</span>
<a href="#l12.641"></a><span id="l12.641">     // and the filter is to move the message to the deleted folder.</span>
<a href="#l12.642"></a><span id="l12.642"> </span>
<a href="#l12.643"></a><span id="l12.643" class="difflineminus">-     // m_curFolder may be null when the folder is deleted externally.</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineplus">+    // m_curFolder may be null when the folder is deleted externally.</span>
<a href="#l12.645"></a><span id="l12.645">     CONTINUE_IF_FALSE(m_curFolder, &quot;Next folder returned null&quot;);</span>
<a href="#l12.646"></a><span id="l12.646"> </span>
<a href="#l12.647"></a><span id="l12.647">     nsString folderName;</span>
<a href="#l12.648"></a><span id="l12.648">     (void)m_curFolder-&gt;GetName(folderName);</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Folder name: %s&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineplus">+    MOZ_LOG(</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+        FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineplus">+        (&quot;(Post) Folder name: %s&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l12.653"></a><span id="l12.653"> </span>
<a href="#l12.654"></a><span id="l12.654">     nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l12.655"></a><span id="l12.655">     (void)m_curFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l12.656"></a><span id="l12.656">     (void)folderPath-&gt;GetPath(folderName);</span>
<a href="#l12.657"></a><span id="l12.657" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Folder path: %s&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineplus">+    MOZ_LOG(</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineplus">+        FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineplus">+        (&quot;(Post) Folder path: %s&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l12.661"></a><span id="l12.661"> </span>
<a href="#l12.662"></a><span id="l12.662">     rv = m_curFolder-&gt;GetMsgDatabase(getter_AddRefs(m_curFolderDB));</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineminus">-    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineminus">-    {</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineminus">-      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_curFolder, &amp;rv);</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineplus">+    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) {</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineplus">+      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+          do_QueryInterface(m_curFolder, &amp;rv);</span>
<a href="#l12.669"></a><span id="l12.669">       if (NS_SUCCEEDED(rv) &amp;&amp; localFolder)</span>
<a href="#l12.670"></a><span id="l12.670">         // will continue with OnStopRunningUrl</span>
<a href="#l12.671"></a><span id="l12.671">         return localFolder-&gt;ParseFolder(m_msgWindow, this);</span>
<a href="#l12.672"></a><span id="l12.672">     }</span>
<a href="#l12.673"></a><span id="l12.673">     CONTINUE_IF_FAILURE(rv, &quot;Could not get folder db&quot;);</span>
<a href="#l12.674"></a><span id="l12.674"> </span>
<a href="#l12.675"></a><span id="l12.675">     rv = RunNextFilter();</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineminus">-    // RunNextFilter returns success when either filters are done, or an async process has started.</span>
<a href="#l12.677"></a><span id="l12.677" class="difflineminus">-    // It will call AdvanceToNextFolder itself if possible, so no need to call here.</span>
<a href="#l12.678"></a><span id="l12.678" class="difflineplus">+    // RunNextFilter returns success when either filters are done, or an async</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineplus">+    // process has started. It will call AdvanceToNextFolder itself if possible,</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineplus">+    // so no need to call here.</span>
<a href="#l12.681"></a><span id="l12.681">     BREAK_IF_FAILURE(rv, &quot;Failed to run next filter&quot;);</span>
<a href="#l12.682"></a><span id="l12.682">     break;</span>
<a href="#l12.683"></a><span id="l12.683">   }</span>
<a href="#l12.684"></a><span id="l12.684">   return rv;</span>
<a href="#l12.685"></a><span id="l12.685"> }</span>
<a href="#l12.686"></a><span id="l12.686"> </span>
<a href="#l12.687"></a><span id="l12.687" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineminus">-{</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStartRunningUrl(nsIURI *aUrl) {</span>
<a href="#l12.690"></a><span id="l12.690">   return NS_OK;</span>
<a href="#l12.691"></a><span id="l12.691"> }</span>
<a href="#l12.692"></a><span id="l12.692"> </span>
<a href="#l12.693"></a><span id="l12.693"> // This is the return from a folder parse</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineminus">-{</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineminus">-  if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineminus">-    return RunNextFilter();</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStopRunningUrl(nsIURI *aUrl,</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineplus">+                                                        nsresult aExitCode) {</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineplus">+  if (NS_SUCCEEDED(aExitCode)) return RunNextFilter();</span>
<a href="#l12.701"></a><span id="l12.701"> </span>
<a href="#l12.702"></a><span id="l12.702">   mFinalResult = aExitCode;</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineminus">-   // If m_msgWindow then we are in a context where the user can deal with</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineminus">-   //  errors. Put up a prompt, and exit if user wants.</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineminus">-  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt())</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineminus">-    return OnEndExecution();</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineplus">+  // If m_msgWindow then we are in a context where the user can deal with</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+  //  errors. Put up a prompt, and exit if user wants.</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineplus">+  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution();</span>
<a href="#l12.710"></a><span id="l12.710"> </span>
<a href="#l12.711"></a><span id="l12.711">   // folder parse failed, so stop processing this folder.</span>
<a href="#l12.712"></a><span id="l12.712">   return AdvanceToNextFolder();</span>
<a href="#l12.713"></a><span id="l12.713"> }</span>
<a href="#l12.714"></a><span id="l12.714"> </span>
<a href="#l12.715"></a><span id="l12.715" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnSearchHit(nsIMsgDBHdr *header, nsIMsgFolder *folder)</span>
<a href="#l12.716"></a><span id="l12.716" class="difflineminus">-{</span>
<a href="#l12.717"></a><span id="l12.717" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnSearchHit(nsIMsgDBHdr *header,</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineplus">+                                                   nsIMsgFolder *folder) {</span>
<a href="#l12.719"></a><span id="l12.719">   NS_ENSURE_ARG_POINTER(header);</span>
<a href="#l12.720"></a><span id="l12.720">   NS_ENSURE_TRUE(m_searchHitHdrs, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l12.721"></a><span id="l12.721"> </span>
<a href="#l12.722"></a><span id="l12.722">   nsMsgKey msgKey;</span>
<a href="#l12.723"></a><span id="l12.723">   header-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.724"></a><span id="l12.724"> </span>
<a href="#l12.725"></a><span id="l12.725">   nsCString msgId;</span>
<a href="#l12.726"></a><span id="l12.726">   header-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter matched message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l12.728"></a><span id="l12.728" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineplus">+  // clang-format off</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineplus">+          (&quot;(Post) Filter matched message with key %&quot; PRIu32,</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineplus">+           msgKeyToInt(msgKey)));</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineplus">+  // clang-format on</span>
<a href="#l12.734"></a><span id="l12.734" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineplus">+          (&quot;(Post) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l12.736"></a><span id="l12.736"> </span>
<a href="#l12.737"></a><span id="l12.737">   // Under various previous actions (a move, delete, or stopExecution)</span>
<a href="#l12.738"></a><span id="l12.738">   //  we do not want to process filters on a per-message basis.</span>
<a href="#l12.739"></a><span id="l12.739">   if (m_stopFiltering.Contains(msgKey)) {</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Stopping further filter execution on this message&quot;));</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineplus">+            (&quot;(Post) Stopping further filter execution on this message&quot;));</span>
<a href="#l12.743"></a><span id="l12.743">     return NS_OK;</span>
<a href="#l12.744"></a><span id="l12.744">   }</span>
<a href="#l12.745"></a><span id="l12.745"> </span>
<a href="#l12.746"></a><span id="l12.746">   m_searchHits.AppendElement(msgKey);</span>
<a href="#l12.747"></a><span id="l12.747">   m_searchHitHdrs-&gt;AppendElement(header);</span>
<a href="#l12.748"></a><span id="l12.748">   return NS_OK;</span>
<a href="#l12.749"></a><span id="l12.749"> }</span>
<a href="#l12.750"></a><span id="l12.750"> </span>
<a href="#l12.751"></a><span id="l12.751"> // Continue after an async operation.</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnSearchDone(nsresult status)</span>
<a href="#l12.753"></a><span id="l12.753" class="difflineminus">-{</span>
<a href="#l12.754"></a><span id="l12.754" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Done matching current filter&quot;));</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnSearchDone(nsresult status) {</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.757"></a><span id="l12.757" class="difflineplus">+          (&quot;(Post) Done matching current filter&quot;));</span>
<a href="#l12.758"></a><span id="l12.758">   if (NS_SUCCEEDED(status))</span>
<a href="#l12.759"></a><span id="l12.759">     return m_searchHits.IsEmpty() ? RunNextFilter() : ApplyFilter();</span>
<a href="#l12.760"></a><span id="l12.760"> </span>
<a href="#l12.761"></a><span id="l12.761">   mFinalResult = status;</span>
<a href="#l12.762"></a><span id="l12.762" class="difflineminus">-  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt())</span>
<a href="#l12.763"></a><span id="l12.763" class="difflineminus">-    return OnEndExecution();</span>
<a href="#l12.764"></a><span id="l12.764" class="difflineplus">+  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution();</span>
<a href="#l12.765"></a><span id="l12.765"> </span>
<a href="#l12.766"></a><span id="l12.766">   // The search failed, so move on to the next filter.</span>
<a href="#l12.767"></a><span id="l12.767">   return RunNextFilter();</span>
<a href="#l12.768"></a><span id="l12.768"> }</span>
<a href="#l12.769"></a><span id="l12.769"> </span>
<a href="#l12.770"></a><span id="l12.770" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnNewSearch()</span>
<a href="#l12.771"></a><span id="l12.771" class="difflineminus">-{</span>
<a href="#l12.772"></a><span id="l12.772" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnNewSearch() {</span>
<a href="#l12.773"></a><span id="l12.773">   m_searchHits.Clear();</span>
<a href="#l12.774"></a><span id="l12.774">   m_searchHitHdrs-&gt;Clear();</span>
<a href="#l12.775"></a><span id="l12.775">   return NS_OK;</span>
<a href="#l12.776"></a><span id="l12.776"> }</span>
<a href="#l12.777"></a><span id="l12.777"> </span>
<a href="#l12.778"></a><span id="l12.778"> // This method will apply filters. It will continue to advance though headers,</span>
<a href="#l12.779"></a><span id="l12.779"> //   filters, and folders until done, unless it starts an async operation with</span>
<a href="#l12.780"></a><span id="l12.780"> //   a callback. The callback should call ApplyFilter again. It only returns</span>
<a href="#l12.781"></a><span id="l12.781"> //   an error if it is impossible to continue after attempting to continue the</span>
<a href="#l12.782"></a><span id="l12.782"> //   next filter action, filter, or folder.</span>
<a href="#l12.783"></a><span id="l12.783" class="difflineminus">-nsresult nsMsgFilterAfterTheFact::ApplyFilter()</span>
<a href="#l12.784"></a><span id="l12.784" class="difflineminus">-{</span>
<a href="#l12.785"></a><span id="l12.785" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact::ApplyFilter&quot;));</span>
<a href="#l12.786"></a><span id="l12.786" class="difflineplus">+nsresult nsMsgFilterAfterTheFact::ApplyFilter() {</span>
<a href="#l12.787"></a><span id="l12.787" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.788"></a><span id="l12.788" class="difflineplus">+          (&quot;(Post) nsMsgFilterAfterTheFact::ApplyFilter&quot;));</span>
<a href="#l12.789"></a><span id="l12.789">   nsresult rv;</span>
<a href="#l12.790"></a><span id="l12.790" class="difflineminus">-  do { // error management block, break if unable to continue with filter.</span>
<a href="#l12.791"></a><span id="l12.791" class="difflineplus">+  do {  // error management block, break if unable to continue with filter.</span>
<a href="#l12.792"></a><span id="l12.792">     // 'm_curFolder' can be reset asynchronously by the copy service</span>
<a href="#l12.793"></a><span id="l12.793">     // calling OnStopCopy(). So take a local copy here and use it throughout the</span>
<a href="#l12.794"></a><span id="l12.794">     // function.</span>
<a href="#l12.795"></a><span id="l12.795">     nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = m_curFolder;</span>
<a href="#l12.796"></a><span id="l12.796">     if (!m_curFilter)</span>
<a href="#l12.797"></a><span id="l12.797" class="difflineminus">-      break; // Maybe not an error, we just need to call RunNextFilter();</span>
<a href="#l12.798"></a><span id="l12.798" class="difflineplus">+      break;  // Maybe not an error, we just need to call RunNextFilter();</span>
<a href="#l12.799"></a><span id="l12.799">     if (!curFolder)</span>
<a href="#l12.800"></a><span id="l12.800" class="difflineminus">-      break; // Maybe not an error, we just need to call AdvanceToNextFolder();</span>
<a href="#l12.801"></a><span id="l12.801" class="difflineplus">+      break;  // Maybe not an error, we just need to call AdvanceToNextFolder();</span>
<a href="#l12.802"></a><span id="l12.802"> </span>
<a href="#l12.803"></a><span id="l12.803">     BREAK_IF_FALSE(m_searchHitHdrs, &quot;No search headers object&quot;);</span>
<a href="#l12.804"></a><span id="l12.804" class="difflineminus">-    // we're going to log the filter actions before firing them because some actions are async</span>
<a href="#l12.805"></a><span id="l12.805" class="difflineplus">+    // we're going to log the filter actions before firing them because some</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineplus">+    // actions are async</span>
<a href="#l12.807"></a><span id="l12.807">     bool loggingEnabled = false;</span>
<a href="#l12.808"></a><span id="l12.808" class="difflineminus">-    if (m_filters)</span>
<a href="#l12.809"></a><span id="l12.809" class="difflineminus">-      (void)m_filters-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l12.810"></a><span id="l12.810" class="difflineplus">+    if (m_filters) (void)m_filters-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l12.811"></a><span id="l12.811"> </span>
<a href="#l12.812"></a><span id="l12.812">     nsCOMPtr&lt;nsIArray&gt; actionList;</span>
<a href="#l12.813"></a><span id="l12.813">     rv = m_curFilter-&gt;GetSortedActionList(getter_AddRefs(actionList));</span>
<a href="#l12.814"></a><span id="l12.814">     BREAK_IF_FAILURE(rv, &quot;Could not get action list for filter&quot;);</span>
<a href="#l12.815"></a><span id="l12.815"> </span>
<a href="#l12.816"></a><span id="l12.816">     uint32_t numActions;</span>
<a href="#l12.817"></a><span id="l12.817">     actionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l12.818"></a><span id="l12.818"> </span>
<a href="#l12.819"></a><span id="l12.819" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Applying filter actions to %&quot; PRIu32 &quot; matched messages&quot;, static_cast&lt;uint32_t&gt;(m_searchHits.Length())));</span>
<a href="#l12.820"></a><span id="l12.820" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.821"></a><span id="l12.821" class="difflineplus">+            (&quot;(Post) Applying filter actions to %&quot; PRIu32 &quot; matched messages&quot;,</span>
<a href="#l12.822"></a><span id="l12.822" class="difflineplus">+             static_cast&lt;uint32_t&gt;(m_searchHits.Length())));</span>
<a href="#l12.823"></a><span id="l12.823"> </span>
<a href="#l12.824"></a><span id="l12.824">     // We start from m_nextAction to allow us to continue applying actions</span>
<a href="#l12.825"></a><span id="l12.825">     // after the return from an async copy.</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineminus">-    while (m_nextAction &lt; numActions)</span>
<a href="#l12.827"></a><span id="l12.827" class="difflineminus">-    {</span>
<a href="#l12.828"></a><span id="l12.828" class="difflineminus">-      nsCOMPtr&lt;nsIMsgRuleAction&gt;filterAction(do_QueryElementAt(actionList, m_nextAction++, &amp;rv));</span>
<a href="#l12.829"></a><span id="l12.829" class="difflineplus">+    while (m_nextAction &lt; numActions) {</span>
<a href="#l12.830"></a><span id="l12.830" class="difflineplus">+      nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction(</span>
<a href="#l12.831"></a><span id="l12.831" class="difflineplus">+          do_QueryElementAt(actionList, m_nextAction++, &amp;rv));</span>
<a href="#l12.832"></a><span id="l12.832">       CONTINUE_IF_FAILURE(rv, &quot;actionList cannot QI element&quot;);</span>
<a href="#l12.833"></a><span id="l12.833"> </span>
<a href="#l12.834"></a><span id="l12.834">       nsMsgRuleActionType actionType;</span>
<a href="#l12.835"></a><span id="l12.835">       rv = filterAction-&gt;GetType(&amp;actionType);</span>
<a href="#l12.836"></a><span id="l12.836">       CONTINUE_IF_FAILURE(rv, &quot;Could not get type for filter action&quot;);</span>
<a href="#l12.837"></a><span id="l12.837"> </span>
<a href="#l12.838"></a><span id="l12.838">       nsCString actionTargetFolderUri;</span>
<a href="#l12.839"></a><span id="l12.839">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l12.840"></a><span id="l12.840" class="difflineminus">-          actionType == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l12.841"></a><span id="l12.841" class="difflineminus">-      {</span>
<a href="#l12.842"></a><span id="l12.842" class="difflineplus">+          actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l12.843"></a><span id="l12.843">         rv = filterAction-&gt;GetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l12.844"></a><span id="l12.844">         CONTINUE_IF_FALSE(NS_SUCCEEDED(rv) &amp;&amp; !actionTargetFolderUri.IsEmpty(),</span>
<a href="#l12.845"></a><span id="l12.845">                           &quot;actionTargetFolderUri is empty&quot;);</span>
<a href="#l12.846"></a><span id="l12.846">       }</span>
<a href="#l12.847"></a><span id="l12.847"> </span>
<a href="#l12.848"></a><span id="l12.848" class="difflineminus">-      if (loggingEnabled)</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineminus">-      {</span>
<a href="#l12.850"></a><span id="l12.850" class="difflineminus">-        for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.851"></a><span id="l12.851" class="difflineminus">-        {</span>
<a href="#l12.852"></a><span id="l12.852" class="difflineminus">-          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.853"></a><span id="l12.853" class="difflineplus">+      if (loggingEnabled) {</span>
<a href="#l12.854"></a><span id="l12.854" class="difflineplus">+        for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.855"></a><span id="l12.855" class="difflineplus">+             msgIndex++) {</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.857"></a><span id="l12.857" class="difflineplus">+              do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.858"></a><span id="l12.858">           if (msgHdr)</span>
<a href="#l12.859"></a><span id="l12.859">             (void)m_curFilter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l12.860"></a><span id="l12.860">           else</span>
<a href="#l12.861"></a><span id="l12.861">             NS_WARNING(&quot;could not QI element to nsIMsgDBHdr&quot;);</span>
<a href="#l12.862"></a><span id="l12.862">         }</span>
<a href="#l12.863"></a><span id="l12.863">       }</span>
<a href="#l12.864"></a><span id="l12.864"> </span>
<a href="#l12.865"></a><span id="l12.865" class="difflineminus">-      // all actions that pass &quot;this&quot; as a listener in order to chain filter execution</span>
<a href="#l12.866"></a><span id="l12.866" class="difflineminus">-      // when the action is finished need to return before reaching the bottom of this</span>
<a href="#l12.867"></a><span id="l12.867" class="difflineminus">-      // routine, because we run the next filter at the end of this routine.</span>
<a href="#l12.868"></a><span id="l12.868" class="difflineminus">-      switch (actionType)</span>
<a href="#l12.869"></a><span id="l12.869" class="difflineminus">-      {</span>
<a href="#l12.870"></a><span id="l12.870" class="difflineminus">-      case nsMsgFilterAction::Delete:</span>
<a href="#l12.871"></a><span id="l12.871" class="difflineminus">-        // we can't pass ourselves in as a copy service listener because the copy service</span>
<a href="#l12.872"></a><span id="l12.872" class="difflineminus">-        // listener won't get called in several situations (e.g., the delete model is imap delete)</span>
<a href="#l12.873"></a><span id="l12.873" class="difflineminus">-        // and we rely on the listener getting called to continue the filter application.</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineminus">-        // This means we're going to end up firing off the delete, and then subsequently</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineminus">-        // issuing a search for the next filter, which will block until the delete finishes.</span>
<a href="#l12.876"></a><span id="l12.876" class="difflineminus">-        curFolder-&gt;DeleteMessages(m_searchHitHdrs, m_msgWindow, false, false, nullptr, false /*allow Undo*/ );</span>
<a href="#l12.877"></a><span id="l12.877" class="difflineplus">+      // all actions that pass &quot;this&quot; as a listener in order to chain filter</span>
<a href="#l12.878"></a><span id="l12.878" class="difflineplus">+      // execution when the action is finished need to return before reaching</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineplus">+      // the bottom of this routine, because we run the next filter at the end</span>
<a href="#l12.880"></a><span id="l12.880" class="difflineplus">+      // of this routine.</span>
<a href="#l12.881"></a><span id="l12.881" class="difflineplus">+      switch (actionType) {</span>
<a href="#l12.882"></a><span id="l12.882" class="difflineplus">+        case nsMsgFilterAction::Delete:</span>
<a href="#l12.883"></a><span id="l12.883" class="difflineplus">+          // we can't pass ourselves in as a copy service listener because the</span>
<a href="#l12.884"></a><span id="l12.884" class="difflineplus">+          // copy service listener won't get called in several situations (e.g.,</span>
<a href="#l12.885"></a><span id="l12.885" class="difflineplus">+          // the delete model is imap delete) and we rely on the listener</span>
<a href="#l12.886"></a><span id="l12.886" class="difflineplus">+          // getting called to continue the filter application. This means we're</span>
<a href="#l12.887"></a><span id="l12.887" class="difflineplus">+          // going to end up firing off the delete, and then subsequently</span>
<a href="#l12.888"></a><span id="l12.888" class="difflineplus">+          // issuing a search for the next filter, which will block until the</span>
<a href="#l12.889"></a><span id="l12.889" class="difflineplus">+          // delete finishes.</span>
<a href="#l12.890"></a><span id="l12.890" class="difflineplus">+          curFolder-&gt;DeleteMessages(m_searchHitHdrs, m_msgWindow, false, false,</span>
<a href="#l12.891"></a><span id="l12.891" class="difflineplus">+                                    nullptr, false /*allow Undo*/);</span>
<a href="#l12.892"></a><span id="l12.892"> </span>
<a href="#l12.893"></a><span id="l12.893" class="difflineminus">-        // don't allow any more filters on this message</span>
<a href="#l12.894"></a><span id="l12.894" class="difflineminus">-        m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l12.895"></a><span id="l12.895" class="difflineminus">-        for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l12.896"></a><span id="l12.896" class="difflineminus">-          curFolder-&gt;OrProcessingFlags(m_searchHits[i], nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l12.897"></a><span id="l12.897" class="difflineminus">-        //if we are deleting then we couldn't care less about applying remaining filter actions</span>
<a href="#l12.898"></a><span id="l12.898" class="difflineminus">-        m_nextAction = numActions;</span>
<a href="#l12.899"></a><span id="l12.899" class="difflineminus">-        break;</span>
<a href="#l12.900"></a><span id="l12.900" class="difflineplus">+          // don't allow any more filters on this message</span>
<a href="#l12.901"></a><span id="l12.901" class="difflineplus">+          m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l12.902"></a><span id="l12.902" class="difflineplus">+          for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l12.903"></a><span id="l12.903" class="difflineplus">+            curFolder-&gt;OrProcessingFlags(m_searchHits[i],</span>
<a href="#l12.904"></a><span id="l12.904" class="difflineplus">+                                         nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l12.905"></a><span id="l12.905" class="difflineplus">+          // if we are deleting then we couldn't care less about applying</span>
<a href="#l12.906"></a><span id="l12.906" class="difflineplus">+          // remaining filter actions</span>
<a href="#l12.907"></a><span id="l12.907" class="difflineplus">+          m_nextAction = numActions;</span>
<a href="#l12.908"></a><span id="l12.908" class="difflineplus">+          break;</span>
<a href="#l12.909"></a><span id="l12.909"> </span>
<a href="#l12.910"></a><span id="l12.910" class="difflineminus">-      case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l12.911"></a><span id="l12.911" class="difflineminus">-        // Even if move fails we will not run additional actions, as they</span>
<a href="#l12.912"></a><span id="l12.912" class="difflineminus">-        //   would not have run if move succeeded.</span>
<a href="#l12.913"></a><span id="l12.913" class="difflineminus">-        m_nextAction = numActions;</span>
<a href="#l12.914"></a><span id="l12.914" class="difflineminus">-        // Fall through to the copy case.</span>
<a href="#l12.915"></a><span id="l12.915" class="difflineminus">-        MOZ_FALLTHROUGH;</span>
<a href="#l12.916"></a><span id="l12.916" class="difflineminus">-      case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l12.917"></a><span id="l12.917" class="difflineminus">-      {</span>
<a href="#l12.918"></a><span id="l12.918" class="difflineminus">-        nsCString uri;</span>
<a href="#l12.919"></a><span id="l12.919" class="difflineminus">-        curFolder-&gt;GetURI(uri);</span>
<a href="#l12.920"></a><span id="l12.920" class="difflineminus">-        if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l12.921"></a><span id="l12.921" class="difflineminus">-            !uri.Equals(actionTargetFolderUri))</span>
<a href="#l12.922"></a><span id="l12.922" class="difflineminus">-        {</span>
<a href="#l12.923"></a><span id="l12.923" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l12.924"></a><span id="l12.924" class="difflineminus">-          rv = GetOrCreateFolder(actionTargetFolderUri, getter_AddRefs(destIFolder));</span>
<a href="#l12.925"></a><span id="l12.925" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get action folder&quot;);</span>
<a href="#l12.926"></a><span id="l12.926" class="difflineplus">+        case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l12.927"></a><span id="l12.927" class="difflineplus">+          // Even if move fails we will not run additional actions, as they</span>
<a href="#l12.928"></a><span id="l12.928" class="difflineplus">+          // would not have run if move succeeded.</span>
<a href="#l12.929"></a><span id="l12.929" class="difflineplus">+          m_nextAction = numActions;</span>
<a href="#l12.930"></a><span id="l12.930" class="difflineplus">+          // Fall through to the copy case.</span>
<a href="#l12.931"></a><span id="l12.931" class="difflineplus">+          MOZ_FALLTHROUGH;</span>
<a href="#l12.932"></a><span id="l12.932" class="difflineplus">+        case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l12.933"></a><span id="l12.933" class="difflineplus">+          nsCString uri;</span>
<a href="#l12.934"></a><span id="l12.934" class="difflineplus">+          curFolder-&gt;GetURI(uri);</span>
<a href="#l12.935"></a><span id="l12.935" class="difflineplus">+          if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l12.936"></a><span id="l12.936" class="difflineplus">+              !uri.Equals(actionTargetFolderUri)) {</span>
<a href="#l12.937"></a><span id="l12.937" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l12.938"></a><span id="l12.938" class="difflineplus">+            rv = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l12.939"></a><span id="l12.939" class="difflineplus">+                                   getter_AddRefs(destIFolder));</span>
<a href="#l12.940"></a><span id="l12.940" class="difflineplus">+            CONTINUE_IF_FAILURE(rv, &quot;Could not get action folder&quot;);</span>
<a href="#l12.941"></a><span id="l12.941"> </span>
<a href="#l12.942"></a><span id="l12.942" class="difflineminus">-          bool canFileMessages = true;</span>
<a href="#l12.943"></a><span id="l12.943" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l12.944"></a><span id="l12.944" class="difflineminus">-          destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l12.945"></a><span id="l12.945" class="difflineminus">-          if (parentFolder)</span>
<a href="#l12.946"></a><span id="l12.946" class="difflineminus">-            destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l12.947"></a><span id="l12.947" class="difflineminus">-          if (!parentFolder || !canFileMessages)</span>
<a href="#l12.948"></a><span id="l12.948" class="difflineminus">-          {</span>
<a href="#l12.949"></a><span id="l12.949" class="difflineminus">-            m_curFilter-&gt;SetEnabled(false);</span>
<a href="#l12.950"></a><span id="l12.950" class="difflineminus">-            destIFolder-&gt;ThrowAlertMsg(&quot;filterDisabled&quot;,m_msgWindow);</span>
<a href="#l12.951"></a><span id="l12.951" class="difflineminus">-            // we need to explicitly save the filter file.</span>
<a href="#l12.952"></a><span id="l12.952" class="difflineminus">-            m_filters-&gt;SaveToDefaultFile();</span>
<a href="#l12.953"></a><span id="l12.953" class="difflineminus">-            // In the case of applying multiple filters</span>
<a href="#l12.954"></a><span id="l12.954" class="difflineminus">-            // we might want to remove the filter from the list, but</span>
<a href="#l12.955"></a><span id="l12.955" class="difflineminus">-            // that's a bit evil since we really don't know that we own</span>
<a href="#l12.956"></a><span id="l12.956" class="difflineminus">-            // the list. Disabling it doesn't do a lot of good since</span>
<a href="#l12.957"></a><span id="l12.957" class="difflineminus">-            // we still apply disabled filters. Currently, we don't</span>
<a href="#l12.958"></a><span id="l12.958" class="difflineminus">-            // have any clients that apply filters to multiple folders,</span>
<a href="#l12.959"></a><span id="l12.959" class="difflineminus">-            // so this might be the edge case of an edge case.</span>
<a href="#l12.960"></a><span id="l12.960" class="difflineminus">-            m_nextAction = numActions;</span>
<a href="#l12.961"></a><span id="l12.961" class="difflineminus">-            mFinalResult = NS_ERROR_FAILURE;</span>
<a href="#l12.962"></a><span id="l12.962" class="difflineminus">-            break;</span>
<a href="#l12.963"></a><span id="l12.963" class="difflineminus">-          }</span>
<a href="#l12.964"></a><span id="l12.964" class="difflineminus">-          nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.965"></a><span id="l12.965" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get copy service&quot;)</span>
<a href="#l12.966"></a><span id="l12.966" class="difflineplus">+            bool canFileMessages = true;</span>
<a href="#l12.967"></a><span id="l12.967" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l12.968"></a><span id="l12.968" class="difflineplus">+            destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l12.969"></a><span id="l12.969" class="difflineplus">+            if (parentFolder) destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l12.970"></a><span id="l12.970" class="difflineplus">+            if (!parentFolder || !canFileMessages) {</span>
<a href="#l12.971"></a><span id="l12.971" class="difflineplus">+              m_curFilter-&gt;SetEnabled(false);</span>
<a href="#l12.972"></a><span id="l12.972" class="difflineplus">+              destIFolder-&gt;ThrowAlertMsg(&quot;filterDisabled&quot;, m_msgWindow);</span>
<a href="#l12.973"></a><span id="l12.973" class="difflineplus">+              // we need to explicitly save the filter file.</span>
<a href="#l12.974"></a><span id="l12.974" class="difflineplus">+              m_filters-&gt;SaveToDefaultFile();</span>
<a href="#l12.975"></a><span id="l12.975" class="difflineplus">+              // In the case of applying multiple filters</span>
<a href="#l12.976"></a><span id="l12.976" class="difflineplus">+              // we might want to remove the filter from the list, but</span>
<a href="#l12.977"></a><span id="l12.977" class="difflineplus">+              // that's a bit evil since we really don't know that we own</span>
<a href="#l12.978"></a><span id="l12.978" class="difflineplus">+              // the list. Disabling it doesn't do a lot of good since</span>
<a href="#l12.979"></a><span id="l12.979" class="difflineplus">+              // we still apply disabled filters. Currently, we don't</span>
<a href="#l12.980"></a><span id="l12.980" class="difflineplus">+              // have any clients that apply filters to multiple folders,</span>
<a href="#l12.981"></a><span id="l12.981" class="difflineplus">+              // so this might be the edge case of an edge case.</span>
<a href="#l12.982"></a><span id="l12.982" class="difflineplus">+              m_nextAction = numActions;</span>
<a href="#l12.983"></a><span id="l12.983" class="difflineplus">+              mFinalResult = NS_ERROR_FAILURE;</span>
<a href="#l12.984"></a><span id="l12.984" class="difflineplus">+              break;</span>
<a href="#l12.985"></a><span id="l12.985" class="difflineplus">+            }</span>
<a href="#l12.986"></a><span id="l12.986" class="difflineplus">+            nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l12.987"></a><span id="l12.987" class="difflineplus">+                do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.988"></a><span id="l12.988" class="difflineplus">+            CONTINUE_IF_FAILURE(rv, &quot;Could not get copy service&quot;)</span>
<a href="#l12.989"></a><span id="l12.989"> </span>
<a href="#l12.990"></a><span id="l12.990" class="difflineminus">-          if (actionType == nsMsgFilterAction::MoveToFolder)</span>
<a href="#l12.991"></a><span id="l12.991" class="difflineminus">-          {</span>
<a href="#l12.992"></a><span id="l12.992" class="difflineminus">-            m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l12.993"></a><span id="l12.993" class="difflineminus">-            for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l12.994"></a><span id="l12.994" class="difflineminus">-              curFolder-&gt;OrProcessingFlags(m_searchHits[i],</span>
<a href="#l12.995"></a><span id="l12.995" class="difflineminus">-                                             nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l12.996"></a><span id="l12.996" class="difflineminus">-          }</span>
<a href="#l12.997"></a><span id="l12.997" class="difflineplus">+            if (actionType == nsMsgFilterAction::MoveToFolder) {</span>
<a href="#l12.998"></a><span id="l12.998" class="difflineplus">+              m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l12.999"></a><span id="l12.999" class="difflineplus">+              for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l12.1000"></a><span id="l12.1000" class="difflineplus">+                curFolder-&gt;OrProcessingFlags(</span>
<a href="#l12.1001"></a><span id="l12.1001" class="difflineplus">+                    m_searchHits[i], nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l12.1002"></a><span id="l12.1002" class="difflineplus">+            }</span>
<a href="#l12.1003"></a><span id="l12.1003"> </span>
<a href="#l12.1004"></a><span id="l12.1004" class="difflineminus">-          rv = copyService-&gt;CopyMessages(curFolder, m_searchHitHdrs,</span>
<a href="#l12.1005"></a><span id="l12.1005" class="difflineminus">-              destIFolder, actionType == nsMsgFilterAction::MoveToFolder,</span>
<a href="#l12.1006"></a><span id="l12.1006" class="difflineminus">-              this, m_msgWindow, false);</span>
<a href="#l12.1007"></a><span id="l12.1007" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;CopyMessages failed&quot;);</span>
<a href="#l12.1008"></a><span id="l12.1008" class="difflineminus">-          return NS_OK; // OnStopCopy callback to continue;</span>
<a href="#l12.1009"></a><span id="l12.1009" class="difflineminus">-        }</span>
<a href="#l12.1010"></a><span id="l12.1010" class="difflineminus">-        else</span>
<a href="#l12.1011"></a><span id="l12.1011" class="difflineminus">-          NS_WARNING(&quot;Move or copy failed, empty or unchanged destination&quot;);</span>
<a href="#l12.1012"></a><span id="l12.1012" class="difflineminus">-      }</span>
<a href="#l12.1013"></a><span id="l12.1013" class="difflineminus">-        break;</span>
<a href="#l12.1014"></a><span id="l12.1014" class="difflineminus">-      case nsMsgFilterAction::MarkRead:</span>
<a href="#l12.1015"></a><span id="l12.1015" class="difflineminus">-          // crud, no listener support here - we'll probably just need to go on and apply</span>
<a href="#l12.1016"></a><span id="l12.1016" class="difflineminus">-          // the next filter, and, in the imap case, rely on multiple connection and url</span>
<a href="#l12.1017"></a><span id="l12.1017" class="difflineminus">-          // queueing to stay out of trouble</span>
<a href="#l12.1018"></a><span id="l12.1018" class="difflineminus">-        curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, true);</span>
<a href="#l12.1019"></a><span id="l12.1019" class="difflineminus">-        break;</span>
<a href="#l12.1020"></a><span id="l12.1020" class="difflineminus">-      case nsMsgFilterAction::MarkUnread:</span>
<a href="#l12.1021"></a><span id="l12.1021" class="difflineminus">-        curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, false);</span>
<a href="#l12.1022"></a><span id="l12.1022" class="difflineminus">-        break;</span>
<a href="#l12.1023"></a><span id="l12.1023" class="difflineminus">-      case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineminus">-        curFolder-&gt;MarkMessagesFlagged(m_searchHitHdrs, true);</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineminus">-        break;</span>
<a href="#l12.1026"></a><span id="l12.1026" class="difflineminus">-      case nsMsgFilterAction::KillThread:</span>
<a href="#l12.1027"></a><span id="l12.1027" class="difflineminus">-      case nsMsgFilterAction::WatchThread:</span>
<a href="#l12.1028"></a><span id="l12.1028" class="difflineminus">-        {</span>
<a href="#l12.1029"></a><span id="l12.1029" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1030"></a><span id="l12.1030" class="difflineminus">-          {</span>
<a href="#l12.1031"></a><span id="l12.1031" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1032"></a><span id="l12.1032" class="difflineplus">+            rv = copyService-&gt;CopyMessages(</span>
<a href="#l12.1033"></a><span id="l12.1033" class="difflineplus">+                curFolder, m_searchHitHdrs, destIFolder,</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineplus">+                actionType == nsMsgFilterAction::MoveToFolder, this,</span>
<a href="#l12.1035"></a><span id="l12.1035" class="difflineplus">+                m_msgWindow, false);</span>
<a href="#l12.1036"></a><span id="l12.1036" class="difflineplus">+            CONTINUE_IF_FAILURE(rv, &quot;CopyMessages failed&quot;);</span>
<a href="#l12.1037"></a><span id="l12.1037" class="difflineplus">+            return NS_OK;  // OnStopCopy callback to continue;</span>
<a href="#l12.1038"></a><span id="l12.1038" class="difflineplus">+          } else</span>
<a href="#l12.1039"></a><span id="l12.1039" class="difflineplus">+            NS_WARNING(&quot;Move or copy failed, empty or unchanged destination&quot;);</span>
<a href="#l12.1040"></a><span id="l12.1040" class="difflineplus">+        } break;</span>
<a href="#l12.1041"></a><span id="l12.1041" class="difflineplus">+        case nsMsgFilterAction::MarkRead:</span>
<a href="#l12.1042"></a><span id="l12.1042" class="difflineplus">+          // crud, no listener support here - we'll probably just need to go on</span>
<a href="#l12.1043"></a><span id="l12.1043" class="difflineplus">+          // and apply the next filter, and, in the imap case, rely on multiple</span>
<a href="#l12.1044"></a><span id="l12.1044" class="difflineplus">+          // connection and url queueing to stay out of trouble</span>
<a href="#l12.1045"></a><span id="l12.1045" class="difflineplus">+          curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, true);</span>
<a href="#l12.1046"></a><span id="l12.1046" class="difflineplus">+          break;</span>
<a href="#l12.1047"></a><span id="l12.1047" class="difflineplus">+        case nsMsgFilterAction::MarkUnread:</span>
<a href="#l12.1048"></a><span id="l12.1048" class="difflineplus">+          curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, false);</span>
<a href="#l12.1049"></a><span id="l12.1049" class="difflineplus">+          break;</span>
<a href="#l12.1050"></a><span id="l12.1050" class="difflineplus">+        case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l12.1051"></a><span id="l12.1051" class="difflineplus">+          curFolder-&gt;MarkMessagesFlagged(m_searchHitHdrs, true);</span>
<a href="#l12.1052"></a><span id="l12.1052" class="difflineplus">+          break;</span>
<a href="#l12.1053"></a><span id="l12.1053" class="difflineplus">+        case nsMsgFilterAction::KillThread:</span>
<a href="#l12.1054"></a><span id="l12.1054" class="difflineplus">+        case nsMsgFilterAction::WatchThread: {</span>
<a href="#l12.1055"></a><span id="l12.1055" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1056"></a><span id="l12.1056" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1057"></a><span id="l12.1057" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.1058"></a><span id="l12.1058" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1059"></a><span id="l12.1059">             CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l12.1060"></a><span id="l12.1060"> </span>
<a href="#l12.1061"></a><span id="l12.1061">             nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l12.1062"></a><span id="l12.1062">             nsMsgKey threadKey;</span>
<a href="#l12.1063"></a><span id="l12.1063" class="difflineminus">-            m_curFolderDB-&gt;GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(msgThread));</span>
<a href="#l12.1064"></a><span id="l12.1064" class="difflineplus">+            m_curFolderDB-&gt;GetThreadContainingMsgHdr(msgHdr,</span>
<a href="#l12.1065"></a><span id="l12.1065" class="difflineplus">+                                                     getter_AddRefs(msgThread));</span>
<a href="#l12.1066"></a><span id="l12.1066">             CONTINUE_IF_FALSE(msgThread, &quot;Could not find msg thread&quot;);</span>
<a href="#l12.1067"></a><span id="l12.1067">             msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l12.1068"></a><span id="l12.1068">             if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l12.1069"></a><span id="l12.1069" class="difflineminus">-              m_curFolderDB-&gt;MarkThreadIgnored(msgThread, threadKey, true, nullptr);</span>
<a href="#l12.1070"></a><span id="l12.1070" class="difflineplus">+              m_curFolderDB-&gt;MarkThreadIgnored(msgThread, threadKey, true,</span>
<a href="#l12.1071"></a><span id="l12.1071" class="difflineplus">+                                               nullptr);</span>
<a href="#l12.1072"></a><span id="l12.1072">             else</span>
<a href="#l12.1073"></a><span id="l12.1073" class="difflineminus">-              m_curFolderDB-&gt;MarkThreadWatched(msgThread, threadKey, true, nullptr);</span>
<a href="#l12.1074"></a><span id="l12.1074" class="difflineplus">+              m_curFolderDB-&gt;MarkThreadWatched(msgThread, threadKey, true,</span>
<a href="#l12.1075"></a><span id="l12.1075" class="difflineplus">+                                               nullptr);</span>
<a href="#l12.1076"></a><span id="l12.1076">           }</span>
<a href="#l12.1077"></a><span id="l12.1077" class="difflineminus">-        }</span>
<a href="#l12.1078"></a><span id="l12.1078" class="difflineminus">-        break;</span>
<a href="#l12.1079"></a><span id="l12.1079" class="difflineminus">-      case nsMsgFilterAction::KillSubthread:</span>
<a href="#l12.1080"></a><span id="l12.1080" class="difflineminus">-        {</span>
<a href="#l12.1081"></a><span id="l12.1081" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineminus">-          {</span>
<a href="#l12.1083"></a><span id="l12.1083" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1084"></a><span id="l12.1084" class="difflineplus">+        } break;</span>
<a href="#l12.1085"></a><span id="l12.1085" class="difflineplus">+        case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l12.1086"></a><span id="l12.1086" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1087"></a><span id="l12.1087" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1088"></a><span id="l12.1088" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.1089"></a><span id="l12.1089" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1090"></a><span id="l12.1090">             CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l12.1091"></a><span id="l12.1091">             m_curFolderDB-&gt;MarkHeaderKilled(msgHdr, true, nullptr);</span>
<a href="#l12.1092"></a><span id="l12.1092">           }</span>
<a href="#l12.1093"></a><span id="l12.1093" class="difflineminus">-        }</span>
<a href="#l12.1094"></a><span id="l12.1094" class="difflineminus">-        break;</span>
<a href="#l12.1095"></a><span id="l12.1095" class="difflineminus">-      case nsMsgFilterAction::ChangePriority:</span>
<a href="#l12.1096"></a><span id="l12.1096" class="difflineminus">-        {</span>
<a href="#l12.1097"></a><span id="l12.1097" class="difflineplus">+        } break;</span>
<a href="#l12.1098"></a><span id="l12.1098" class="difflineplus">+        case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l12.1099"></a><span id="l12.1099">           nsMsgPriorityValue filterPriority;</span>
<a href="#l12.1100"></a><span id="l12.1100">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l12.1101"></a><span id="l12.1101" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1102"></a><span id="l12.1102" class="difflineminus">-          {</span>
<a href="#l12.1103"></a><span id="l12.1103" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1104"></a><span id="l12.1104" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1105"></a><span id="l12.1105" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1106"></a><span id="l12.1106" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.1107"></a><span id="l12.1107" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1108"></a><span id="l12.1108">             CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l12.1109"></a><span id="l12.1109">             msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l12.1110"></a><span id="l12.1110">           }</span>
<a href="#l12.1111"></a><span id="l12.1111" class="difflineminus">-        }</span>
<a href="#l12.1112"></a><span id="l12.1112" class="difflineminus">-        break;</span>
<a href="#l12.1113"></a><span id="l12.1113" class="difflineminus">-      case nsMsgFilterAction::Label:</span>
<a href="#l12.1114"></a><span id="l12.1114" class="difflineminus">-        {</span>
<a href="#l12.1115"></a><span id="l12.1115" class="difflineplus">+        } break;</span>
<a href="#l12.1116"></a><span id="l12.1116" class="difflineplus">+        case nsMsgFilterAction::Label: {</span>
<a href="#l12.1117"></a><span id="l12.1117">           nsMsgLabelValue filterLabel;</span>
<a href="#l12.1118"></a><span id="l12.1118">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l12.1119"></a><span id="l12.1119">           curFolder-&gt;SetLabelForMessages(m_searchHitHdrs, filterLabel);</span>
<a href="#l12.1120"></a><span id="l12.1120" class="difflineminus">-        }</span>
<a href="#l12.1121"></a><span id="l12.1121" class="difflineminus">-        break;</span>
<a href="#l12.1122"></a><span id="l12.1122" class="difflineminus">-      case nsMsgFilterAction::AddTag:</span>
<a href="#l12.1123"></a><span id="l12.1123" class="difflineminus">-        {</span>
<a href="#l12.1124"></a><span id="l12.1124" class="difflineplus">+        } break;</span>
<a href="#l12.1125"></a><span id="l12.1125" class="difflineplus">+        case nsMsgFilterAction::AddTag: {</span>
<a href="#l12.1126"></a><span id="l12.1126">           nsCString keyword;</span>
<a href="#l12.1127"></a><span id="l12.1127">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l12.1128"></a><span id="l12.1128">           curFolder-&gt;AddKeywordsToMessages(m_searchHitHdrs, keyword);</span>
<a href="#l12.1129"></a><span id="l12.1129" class="difflineminus">-        }</span>
<a href="#l12.1130"></a><span id="l12.1130" class="difflineminus">-        break;</span>
<a href="#l12.1131"></a><span id="l12.1131" class="difflineminus">-      case nsMsgFilterAction::JunkScore:</span>
<a href="#l12.1132"></a><span id="l12.1132" class="difflineminus">-        {</span>
<a href="#l12.1133"></a><span id="l12.1133" class="difflineplus">+        } break;</span>
<a href="#l12.1134"></a><span id="l12.1134" class="difflineplus">+        case nsMsgFilterAction::JunkScore: {</span>
<a href="#l12.1135"></a><span id="l12.1135">           nsAutoCString junkScoreStr;</span>
<a href="#l12.1136"></a><span id="l12.1136">           int32_t junkScore;</span>
<a href="#l12.1137"></a><span id="l12.1137">           filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l12.1138"></a><span id="l12.1138">           junkScoreStr.AppendInt(junkScore);</span>
<a href="#l12.1139"></a><span id="l12.1139">           curFolder-&gt;SetJunkScoreForMessages(m_searchHitHdrs, junkScoreStr);</span>
<a href="#l12.1140"></a><span id="l12.1140" class="difflineminus">-        }</span>
<a href="#l12.1141"></a><span id="l12.1141" class="difflineminus">-        break;</span>
<a href="#l12.1142"></a><span id="l12.1142" class="difflineminus">-      case nsMsgFilterAction::Forward:</span>
<a href="#l12.1143"></a><span id="l12.1143" class="difflineminus">-        {</span>
<a href="#l12.1144"></a><span id="l12.1144" class="difflineplus">+        } break;</span>
<a href="#l12.1145"></a><span id="l12.1145" class="difflineplus">+        case nsMsgFilterAction::Forward: {</span>
<a href="#l12.1146"></a><span id="l12.1146">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.1147"></a><span id="l12.1147">           rv = curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l12.1148"></a><span id="l12.1148">           CONTINUE_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l12.1149"></a><span id="l12.1149">           nsCString forwardTo;</span>
<a href="#l12.1150"></a><span id="l12.1150">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l12.1151"></a><span id="l12.1151">           CONTINUE_IF_FALSE(!forwardTo.IsEmpty(), &quot;blank forwardTo URI&quot;);</span>
<a href="#l12.1152"></a><span id="l12.1152">           nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l12.1153"></a><span id="l12.1153" class="difflineminus">-            do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1154"></a><span id="l12.1154" class="difflineplus">+              do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1155"></a><span id="l12.1155">           CONTINUE_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l12.1156"></a><span id="l12.1156"> </span>
<a href="#l12.1157"></a><span id="l12.1157" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1158"></a><span id="l12.1158" class="difflineminus">-          {</span>
<a href="#l12.1159"></a><span id="l12.1159" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryElementAt(m_searchHitHdrs,</span>
<a href="#l12.1160"></a><span id="l12.1160" class="difflineminus">-                                         msgIndex));</span>
<a href="#l12.1161"></a><span id="l12.1161" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1162"></a><span id="l12.1162" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1163"></a><span id="l12.1163" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(</span>
<a href="#l12.1164"></a><span id="l12.1164" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex));</span>
<a href="#l12.1165"></a><span id="l12.1165">             if (msgHdr)</span>
<a href="#l12.1166"></a><span id="l12.1166" class="difflineminus">-              rv = compService-&gt;ForwardMessage(NS_ConvertASCIItoUTF16(forwardTo),</span>
<a href="#l12.1167"></a><span id="l12.1167" class="difflineminus">-                                               msgHdr, m_msgWindow, server,</span>
<a href="#l12.1168"></a><span id="l12.1168" class="difflineminus">-                                               nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l12.1169"></a><span id="l12.1169" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr &amp;&amp; NS_SUCCEEDED(rv), &quot;Forward action failed&quot;);</span>
<a href="#l12.1170"></a><span id="l12.1170" class="difflineplus">+              rv = compService-&gt;ForwardMessage(</span>
<a href="#l12.1171"></a><span id="l12.1171" class="difflineplus">+                  NS_ConvertASCIItoUTF16(forwardTo), msgHdr, m_msgWindow,</span>
<a href="#l12.1172"></a><span id="l12.1172" class="difflineplus">+                  server, nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l12.1173"></a><span id="l12.1173" class="difflineplus">+            CONTINUE_IF_FALSE(msgHdr &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l12.1174"></a><span id="l12.1174" class="difflineplus">+                              &quot;Forward action failed&quot;);</span>
<a href="#l12.1175"></a><span id="l12.1175">           }</span>
<a href="#l12.1176"></a><span id="l12.1176" class="difflineminus">-        }</span>
<a href="#l12.1177"></a><span id="l12.1177" class="difflineminus">-        break;</span>
<a href="#l12.1178"></a><span id="l12.1178" class="difflineminus">-      case nsMsgFilterAction::Reply:</span>
<a href="#l12.1179"></a><span id="l12.1179" class="difflineminus">-        {</span>
<a href="#l12.1180"></a><span id="l12.1180" class="difflineplus">+        } break;</span>
<a href="#l12.1181"></a><span id="l12.1181" class="difflineplus">+        case nsMsgFilterAction::Reply: {</span>
<a href="#l12.1182"></a><span id="l12.1182">           nsCString replyTemplateUri;</span>
<a href="#l12.1183"></a><span id="l12.1183">           filterAction-&gt;GetStrValue(replyTemplateUri);</span>
<a href="#l12.1184"></a><span id="l12.1184" class="difflineminus">-          CONTINUE_IF_FALSE(!replyTemplateUri.IsEmpty(), &quot;Empty reply template URI&quot;);</span>
<a href="#l12.1185"></a><span id="l12.1185" class="difflineplus">+          CONTINUE_IF_FALSE(!replyTemplateUri.IsEmpty(),</span>
<a href="#l12.1186"></a><span id="l12.1186" class="difflineplus">+                            &quot;Empty reply template URI&quot;);</span>
<a href="#l12.1187"></a><span id="l12.1187"> </span>
<a href="#l12.1188"></a><span id="l12.1188">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l12.1189"></a><span id="l12.1189">           rv = curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l12.1190"></a><span id="l12.1190">           CONTINUE_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l12.1191"></a><span id="l12.1191"> </span>
<a href="#l12.1192"></a><span id="l12.1192" class="difflineminus">-          nsCOMPtr&lt;nsIMsgComposeService&gt; compService = do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1193"></a><span id="l12.1193" class="difflineplus">+          nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l12.1194"></a><span id="l12.1194" class="difflineplus">+              do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l12.1195"></a><span id="l12.1195">           CONTINUE_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l12.1196"></a><span id="l12.1196" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1197"></a><span id="l12.1197" class="difflineminus">-          {</span>
<a href="#l12.1198"></a><span id="l12.1198" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1199"></a><span id="l12.1199" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1200"></a><span id="l12.1200" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1201"></a><span id="l12.1201" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.1202"></a><span id="l12.1202" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1203"></a><span id="l12.1203">             CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l12.1204"></a><span id="l12.1204" class="difflineminus">-            rv = compService-&gt;ReplyWithTemplate(msgHdr, replyTemplateUri.get(), m_msgWindow, server);</span>
<a href="#l12.1205"></a><span id="l12.1205" class="difflineplus">+            rv = compService-&gt;ReplyWithTemplate(msgHdr, replyTemplateUri.get(),</span>
<a href="#l12.1206"></a><span id="l12.1206" class="difflineplus">+                                                m_msgWindow, server);</span>
<a href="#l12.1207"></a><span id="l12.1207">             if (NS_FAILED(rv)) {</span>
<a href="#l12.1208"></a><span id="l12.1208">               if (rv == NS_ERROR_ABORT) {</span>
<a href="#l12.1209"></a><span id="l12.1209" class="difflineminus">-                (void) m_curFilter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l12.1210"></a><span id="l12.1210" class="difflineminus">-                                                   NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l12.1211"></a><span id="l12.1211" class="difflineplus">+                (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l12.1212"></a><span id="l12.1212" class="difflineplus">+                    filterAction, msgHdr, rv,</span>
<a href="#l12.1213"></a><span id="l12.1213" class="difflineplus">+                    NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l12.1214"></a><span id="l12.1214">               } else {</span>
<a href="#l12.1215"></a><span id="l12.1215" class="difflineminus">-                (void) m_curFilter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l12.1216"></a><span id="l12.1216" class="difflineminus">-                                                   NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l12.1217"></a><span id="l12.1217" class="difflineplus">+                (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l12.1218"></a><span id="l12.1218" class="difflineplus">+                    filterAction, msgHdr, rv,</span>
<a href="#l12.1219"></a><span id="l12.1219" class="difflineplus">+                    NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l12.1220"></a><span id="l12.1220">               }</span>
<a href="#l12.1221"></a><span id="l12.1221">             }</span>
<a href="#l12.1222"></a><span id="l12.1222">             CONTINUE_IF_FAILURE(rv, &quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l12.1223"></a><span id="l12.1223">           }</span>
<a href="#l12.1224"></a><span id="l12.1224" class="difflineminus">-        }</span>
<a href="#l12.1225"></a><span id="l12.1225" class="difflineminus">-        break;</span>
<a href="#l12.1226"></a><span id="l12.1226" class="difflineminus">-      case nsMsgFilterAction::DeleteFromPop3Server:</span>
<a href="#l12.1227"></a><span id="l12.1227" class="difflineminus">-        {</span>
<a href="#l12.1228"></a><span id="l12.1228" class="difflineminus">-          nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(curFolder);</span>
<a href="#l12.1229"></a><span id="l12.1229" class="difflineplus">+        } break;</span>
<a href="#l12.1230"></a><span id="l12.1230" class="difflineplus">+        case nsMsgFilterAction::DeleteFromPop3Server: {</span>
<a href="#l12.1231"></a><span id="l12.1231" class="difflineplus">+          nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l12.1232"></a><span id="l12.1232" class="difflineplus">+              do_QueryInterface(curFolder);</span>
<a href="#l12.1233"></a><span id="l12.1233">           CONTINUE_IF_FALSE(localFolder, &quot;Current folder not a local folder&quot;);</span>
<a href="#l12.1234"></a><span id="l12.1234">           // This action ignores the deleteMailLeftOnServer preference</span>
<a href="#l12.1235"></a><span id="l12.1235" class="difflineminus">-          rv = localFolder-&gt;MarkMsgsOnPop3Server(m_searchHitHdrs, POP3_FORCE_DEL);</span>
<a href="#l12.1236"></a><span id="l12.1236" class="difflineplus">+          rv = localFolder-&gt;MarkMsgsOnPop3Server(m_searchHitHdrs,</span>
<a href="#l12.1237"></a><span id="l12.1237" class="difflineplus">+                                                 POP3_FORCE_DEL);</span>
<a href="#l12.1238"></a><span id="l12.1238">           CONTINUE_IF_FAILURE(rv, &quot;MarkMsgsOnPop3Server failed&quot;);</span>
<a href="#l12.1239"></a><span id="l12.1239"> </span>
<a href="#l12.1240"></a><span id="l12.1240">           nsCOMPtr&lt;nsIMutableArray&gt; partialMsgs;</span>
<a href="#l12.1241"></a><span id="l12.1241">           // Delete the partial headers. They're useless now</span>
<a href="#l12.1242"></a><span id="l12.1242">           //   that the server copy is being deleted.</span>
<a href="#l12.1243"></a><span id="l12.1243" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1244"></a><span id="l12.1244" class="difflineminus">-          {</span>
<a href="#l12.1245"></a><span id="l12.1245" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1246"></a><span id="l12.1246" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1247"></a><span id="l12.1247" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1248"></a><span id="l12.1248" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.1249"></a><span id="l12.1249" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1250"></a><span id="l12.1250">             CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l12.1251"></a><span id="l12.1251">             uint32_t flags;</span>
<a href="#l12.1252"></a><span id="l12.1252">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.1253"></a><span id="l12.1253" class="difflineminus">-            if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l12.1254"></a><span id="l12.1254" class="difflineminus">-            {</span>
<a href="#l12.1255"></a><span id="l12.1255" class="difflineplus">+            if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l12.1256"></a><span id="l12.1256">               if (!partialMsgs)</span>
<a href="#l12.1257"></a><span id="l12.1257">                 partialMsgs = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l12.1258"></a><span id="l12.1258" class="difflineminus">-              CONTINUE_IF_FALSE(partialMsgs, &quot;Could not create partialMsgs array&quot;);</span>
<a href="#l12.1259"></a><span id="l12.1259" class="difflineplus">+              CONTINUE_IF_FALSE(partialMsgs,</span>
<a href="#l12.1260"></a><span id="l12.1260" class="difflineplus">+                                &quot;Could not create partialMsgs array&quot;);</span>
<a href="#l12.1261"></a><span id="l12.1261">               partialMsgs-&gt;AppendElement(msgHdr);</span>
<a href="#l12.1262"></a><span id="l12.1262">               m_stopFiltering.AppendElement(m_searchHits[msgIndex]);</span>
<a href="#l12.1263"></a><span id="l12.1263">               curFolder-&gt;OrProcessingFlags(m_searchHits[msgIndex],</span>
<a href="#l12.1264"></a><span id="l12.1264" class="difflineminus">-                                             nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l12.1265"></a><span id="l12.1265" class="difflineplus">+                                           nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l12.1266"></a><span id="l12.1266">             }</span>
<a href="#l12.1267"></a><span id="l12.1267">           }</span>
<a href="#l12.1268"></a><span id="l12.1268" class="difflineminus">-          if (partialMsgs)</span>
<a href="#l12.1269"></a><span id="l12.1269" class="difflineminus">-          {</span>
<a href="#l12.1270"></a><span id="l12.1270" class="difflineminus">-            curFolder-&gt;DeleteMessages(partialMsgs, m_msgWindow, true, false, nullptr, false);</span>
<a href="#l12.1271"></a><span id="l12.1271" class="difflineplus">+          if (partialMsgs) {</span>
<a href="#l12.1272"></a><span id="l12.1272" class="difflineplus">+            curFolder-&gt;DeleteMessages(partialMsgs, m_msgWindow, true, false,</span>
<a href="#l12.1273"></a><span id="l12.1273" class="difflineplus">+                                      nullptr, false);</span>
<a href="#l12.1274"></a><span id="l12.1274">             CONTINUE_IF_FAILURE(rv, &quot;Delete messages failed&quot;);</span>
<a href="#l12.1275"></a><span id="l12.1275">           }</span>
<a href="#l12.1276"></a><span id="l12.1276" class="difflineminus">-        }</span>
<a href="#l12.1277"></a><span id="l12.1277" class="difflineminus">-        break;</span>
<a href="#l12.1278"></a><span id="l12.1278" class="difflineminus">-      case nsMsgFilterAction::FetchBodyFromPop3Server:</span>
<a href="#l12.1279"></a><span id="l12.1279" class="difflineminus">-        {</span>
<a href="#l12.1280"></a><span id="l12.1280" class="difflineminus">-          nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(curFolder);</span>
<a href="#l12.1281"></a><span id="l12.1281" class="difflineplus">+        } break;</span>
<a href="#l12.1282"></a><span id="l12.1282" class="difflineplus">+        case nsMsgFilterAction::FetchBodyFromPop3Server: {</span>
<a href="#l12.1283"></a><span id="l12.1283" class="difflineplus">+          nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l12.1284"></a><span id="l12.1284" class="difflineplus">+              do_QueryInterface(curFolder);</span>
<a href="#l12.1285"></a><span id="l12.1285">           CONTINUE_IF_FALSE(localFolder, &quot;current folder not local&quot;);</span>
<a href="#l12.1286"></a><span id="l12.1286" class="difflineminus">-          nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.1287"></a><span id="l12.1287" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l12.1288"></a><span id="l12.1288" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.1289"></a><span id="l12.1289">           CONTINUE_IF_FAILURE(rv, &quot;Could not create messages array&quot;);</span>
<a href="#l12.1290"></a><span id="l12.1290" class="difflineminus">-          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length(); msgIndex++)</span>
<a href="#l12.1291"></a><span id="l12.1291" class="difflineminus">-          {</span>
<a href="#l12.1292"></a><span id="l12.1292" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1293"></a><span id="l12.1293" class="difflineplus">+          for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l12.1294"></a><span id="l12.1294" class="difflineplus">+               msgIndex++) {</span>
<a href="#l12.1295"></a><span id="l12.1295" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l12.1296"></a><span id="l12.1296" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l12.1297"></a><span id="l12.1297">             CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l12.1298"></a><span id="l12.1298">             uint32_t flags = 0;</span>
<a href="#l12.1299"></a><span id="l12.1299">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.1300"></a><span id="l12.1300">             if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l12.1301"></a><span id="l12.1301">               messages-&gt;AppendElement(msgHdr);</span>
<a href="#l12.1302"></a><span id="l12.1302">           }</span>
<a href="#l12.1303"></a><span id="l12.1303">           uint32_t msgsToFetch;</span>
<a href="#l12.1304"></a><span id="l12.1304">           messages-&gt;GetLength(&amp;msgsToFetch);</span>
<a href="#l12.1305"></a><span id="l12.1305" class="difflineminus">-          if (msgsToFetch &gt; 0)</span>
<a href="#l12.1306"></a><span id="l12.1306" class="difflineminus">-          {</span>
<a href="#l12.1307"></a><span id="l12.1307" class="difflineplus">+          if (msgsToFetch &gt; 0) {</span>
<a href="#l12.1308"></a><span id="l12.1308">             rv = curFolder-&gt;DownloadMessagesForOffline(messages, m_msgWindow);</span>
<a href="#l12.1309"></a><span id="l12.1309">             CONTINUE_IF_FAILURE(rv, &quot;DownloadMessagesForOffline failed&quot;);</span>
<a href="#l12.1310"></a><span id="l12.1310">           }</span>
<a href="#l12.1311"></a><span id="l12.1311" class="difflineminus">-        }</span>
<a href="#l12.1312"></a><span id="l12.1312" class="difflineminus">-        break;</span>
<a href="#l12.1313"></a><span id="l12.1313" class="difflineplus">+        } break;</span>
<a href="#l12.1314"></a><span id="l12.1314"> </span>
<a href="#l12.1315"></a><span id="l12.1315" class="difflineminus">-      case nsMsgFilterAction::StopExecution:</span>
<a href="#l12.1316"></a><span id="l12.1316" class="difflineminus">-        {</span>
<a href="#l12.1317"></a><span id="l12.1317" class="difflineplus">+        case nsMsgFilterAction::StopExecution: {</span>
<a href="#l12.1318"></a><span id="l12.1318">           // don't apply any more filters</span>
<a href="#l12.1319"></a><span id="l12.1319">           m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l12.1320"></a><span id="l12.1320">           m_nextAction = numActions;</span>
<a href="#l12.1321"></a><span id="l12.1321" class="difflineminus">-        }</span>
<a href="#l12.1322"></a><span id="l12.1322" class="difflineminus">-      break;</span>
<a href="#l12.1323"></a><span id="l12.1323" class="difflineplus">+        } break;</span>
<a href="#l12.1324"></a><span id="l12.1324"> </span>
<a href="#l12.1325"></a><span id="l12.1325" class="difflineminus">-      case nsMsgFilterAction::Custom:</span>
<a href="#l12.1326"></a><span id="l12.1326" class="difflineminus">-        {</span>
<a href="#l12.1327"></a><span id="l12.1327" class="difflineplus">+        case nsMsgFilterAction::Custom: {</span>
<a href="#l12.1328"></a><span id="l12.1328">           nsMsgFilterTypeType filterType;</span>
<a href="#l12.1329"></a><span id="l12.1329">           m_curFilter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l12.1330"></a><span id="l12.1330">           nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l12.1331"></a><span id="l12.1331">           rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l12.1332"></a><span id="l12.1332">           CONTINUE_IF_FAILURE(rv, &quot;Could not get custom action&quot;);</span>
<a href="#l12.1333"></a><span id="l12.1333"> </span>
<a href="#l12.1334"></a><span id="l12.1334">           nsAutoCString value;</span>
<a href="#l12.1335"></a><span id="l12.1335">           filterAction-&gt;GetStrValue(value);</span>
<a href="#l12.1336"></a><span id="l12.1336">           bool isAsync = false;</span>
<a href="#l12.1337"></a><span id="l12.1337">           customAction-&gt;GetIsAsync(&amp;isAsync);</span>
<a href="#l12.1338"></a><span id="l12.1338" class="difflineminus">-          rv = customAction-&gt;Apply(m_searchHitHdrs, value, this,</span>
<a href="#l12.1339"></a><span id="l12.1339" class="difflineminus">-                                   filterType, m_msgWindow);</span>
<a href="#l12.1340"></a><span id="l12.1340" class="difflineplus">+          rv = customAction-&gt;Apply(m_searchHitHdrs, value, this, filterType,</span>
<a href="#l12.1341"></a><span id="l12.1341" class="difflineplus">+                                   m_msgWindow);</span>
<a href="#l12.1342"></a><span id="l12.1342">           CONTINUE_IF_FAILURE(rv, &quot;custom action failed to apply&quot;);</span>
<a href="#l12.1343"></a><span id="l12.1343">           if (isAsync)</span>
<a href="#l12.1344"></a><span id="l12.1344" class="difflineminus">-            return NS_OK; // custom action should call ApplyFilter on callback</span>
<a href="#l12.1345"></a><span id="l12.1345" class="difflineminus">-        }</span>
<a href="#l12.1346"></a><span id="l12.1346" class="difflineminus">-      break;</span>
<a href="#l12.1347"></a><span id="l12.1347" class="difflineplus">+            return NS_OK;  // custom action should call ApplyFilter on callback</span>
<a href="#l12.1348"></a><span id="l12.1348" class="difflineplus">+        } break;</span>
<a href="#l12.1349"></a><span id="l12.1349"> </span>
<a href="#l12.1350"></a><span id="l12.1350" class="difflineminus">-      default:</span>
<a href="#l12.1351"></a><span id="l12.1351" class="difflineminus">-        break;</span>
<a href="#l12.1352"></a><span id="l12.1352" class="difflineplus">+        default:</span>
<a href="#l12.1353"></a><span id="l12.1353" class="difflineplus">+          break;</span>
<a href="#l12.1354"></a><span id="l12.1354">       }</span>
<a href="#l12.1355"></a><span id="l12.1355">     }</span>
<a href="#l12.1356"></a><span id="l12.1356" class="difflineminus">-  } while (false); // end error management block</span>
<a href="#l12.1357"></a><span id="l12.1357" class="difflineplus">+  } while (false);  // end error management block</span>
<a href="#l12.1358"></a><span id="l12.1358">   return RunNextFilter();</span>
<a href="#l12.1359"></a><span id="l12.1359"> }</span>
<a href="#l12.1360"></a><span id="l12.1360"> </span>
<a href="#l12.1361"></a><span id="l12.1361" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::GetTempFilterList(nsIMsgFolder *aFolder, nsIMsgFilterList **aFilterList)</span>
<a href="#l12.1362"></a><span id="l12.1362" class="difflineminus">-{</span>
<a href="#l12.1363"></a><span id="l12.1363" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::GetTempFilterList(</span>
<a href="#l12.1364"></a><span id="l12.1364" class="difflineplus">+    nsIMsgFolder *aFolder, nsIMsgFilterList **aFilterList) {</span>
<a href="#l12.1365"></a><span id="l12.1365">   NS_ENSURE_ARG_POINTER(aFilterList);</span>
<a href="#l12.1366"></a><span id="l12.1366"> </span>
<a href="#l12.1367"></a><span id="l12.1367">   nsMsgFilterList *filterList = new nsMsgFilterList;</span>
<a href="#l12.1368"></a><span id="l12.1368">   filterList-&gt;SetFolder(aFolder);</span>
<a href="#l12.1369"></a><span id="l12.1369">   filterList-&gt;m_temporaryList = true;</span>
<a href="#l12.1370"></a><span id="l12.1370">   NS_ADDREF(*aFilterList = filterList);</span>
<a href="#l12.1371"></a><span id="l12.1371">   return NS_OK;</span>
<a href="#l12.1372"></a><span id="l12.1372"> }</span>
<a href="#l12.1373"></a><span id="l12.1373"> </span>
<a href="#l12.1374"></a><span id="l12.1374"> NS_IMETHODIMP</span>
<a href="#l12.1375"></a><span id="l12.1375"> nsMsgFilterService::ApplyFiltersToFolders(nsIMsgFilterList *aFilterList,</span>
<a href="#l12.1376"></a><span id="l12.1376">                                           nsIArray *aFolders,</span>
<a href="#l12.1377"></a><span id="l12.1377">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.1378"></a><span id="l12.1378" class="difflineminus">-                                          nsIMsgOperationListener *aCallback)</span>
<a href="#l12.1379"></a><span id="l12.1379" class="difflineminus">-{</span>
<a href="#l12.1380"></a><span id="l12.1380" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterService::ApplyFiltersToFolders&quot;));</span>
<a href="#l12.1381"></a><span id="l12.1381" class="difflineplus">+                                          nsIMsgOperationListener *aCallback) {</span>
<a href="#l12.1382"></a><span id="l12.1382" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.1383"></a><span id="l12.1383" class="difflineplus">+          (&quot;(Post) nsMsgFilterService::ApplyFiltersToFolders&quot;));</span>
<a href="#l12.1384"></a><span id="l12.1384">   NS_ENSURE_ARG_POINTER(aFilterList);</span>
<a href="#l12.1385"></a><span id="l12.1385">   NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l12.1386"></a><span id="l12.1386"> </span>
<a href="#l12.1387"></a><span id="l12.1387">   uint32_t filterCount;</span>
<a href="#l12.1388"></a><span id="l12.1388">   aFilterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l12.1389"></a><span id="l12.1389">   nsCString listId;</span>
<a href="#l12.1390"></a><span id="l12.1390">   aFilterList-&gt;GetListId(listId);</span>
<a href="#l12.1391"></a><span id="l12.1391">   uint32_t folderCount;</span>
<a href="#l12.1392"></a><span id="l12.1392">   aFolders-&gt;GetLength(&amp;folderCount);</span>
<a href="#l12.1393"></a><span id="l12.1393" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Manual filter run initiated&quot;));</span>
<a href="#l12.1394"></a><span id="l12.1394" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32 &quot; folders&quot;,</span>
<a href="#l12.1395"></a><span id="l12.1395" class="difflineminus">-                                            filterCount, listId.get(), folderCount));</span>
<a href="#l12.1396"></a><span id="l12.1396" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.1397"></a><span id="l12.1397" class="difflineplus">+          (&quot;(Post) Manual filter run initiated&quot;));</span>
<a href="#l12.1398"></a><span id="l12.1398" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.1399"></a><span id="l12.1399" class="difflineplus">+          (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32 &quot; folders&quot;,</span>
<a href="#l12.1400"></a><span id="l12.1400" class="difflineplus">+           filterCount, listId.get(), folderCount));</span>
<a href="#l12.1401"></a><span id="l12.1401"> </span>
<a href="#l12.1402"></a><span id="l12.1402">   RefPtr&lt;nsMsgFilterAfterTheFact&gt; filterExecutor =</span>
<a href="#l12.1403"></a><span id="l12.1403" class="difflineminus">-    new nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolders, aCallback);</span>
<a href="#l12.1404"></a><span id="l12.1404" class="difflineplus">+      new nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolders, aCallback);</span>
<a href="#l12.1405"></a><span id="l12.1405">   if (filterExecutor)</span>
<a href="#l12.1406"></a><span id="l12.1406">     return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l12.1407"></a><span id="l12.1407">   else</span>
<a href="#l12.1408"></a><span id="l12.1408">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.1409"></a><span id="l12.1409"> }</span>
<a href="#l12.1410"></a><span id="l12.1410"> </span>
<a href="#l12.1411"></a><span id="l12.1411" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::AddCustomAction(nsIMsgFilterCustomAction *aAction)</span>
<a href="#l12.1412"></a><span id="l12.1412" class="difflineminus">-{</span>
<a href="#l12.1413"></a><span id="l12.1413" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::AddCustomAction(</span>
<a href="#l12.1414"></a><span id="l12.1414" class="difflineplus">+    nsIMsgFilterCustomAction *aAction) {</span>
<a href="#l12.1415"></a><span id="l12.1415">   mCustomActions.AppendObject(aAction);</span>
<a href="#l12.1416"></a><span id="l12.1416">   return NS_OK;</span>
<a href="#l12.1417"></a><span id="l12.1417"> }</span>
<a href="#l12.1418"></a><span id="l12.1418"> </span>
<a href="#l12.1419"></a><span id="l12.1419" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::GetCustomActions(nsISimpleEnumerator** aResult)</span>
<a href="#l12.1420"></a><span id="l12.1420" class="difflineminus">-{</span>
<a href="#l12.1421"></a><span id="l12.1421" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::GetCustomActions(</span>
<a href="#l12.1422"></a><span id="l12.1422" class="difflineplus">+    nsISimpleEnumerator **aResult) {</span>
<a href="#l12.1423"></a><span id="l12.1423">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.1424"></a><span id="l12.1424"> </span>
<a href="#l12.1425"></a><span id="l12.1425" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mCustomActions, NS_GET_IID(nsIMsgFilterCustomAction));</span>
<a href="#l12.1426"></a><span id="l12.1426" class="difflineplus">+  return NS_NewArrayEnumerator(aResult, mCustomActions,</span>
<a href="#l12.1427"></a><span id="l12.1427" class="difflineplus">+                               NS_GET_IID(nsIMsgFilterCustomAction));</span>
<a href="#l12.1428"></a><span id="l12.1428"> }</span>
<a href="#l12.1429"></a><span id="l12.1429"> </span>
<a href="#l12.1430"></a><span id="l12.1430"> NS_IMETHODIMP</span>
<a href="#l12.1431"></a><span id="l12.1431" class="difflineminus">-nsMsgFilterService::GetCustomAction(const nsACString &amp; aId,</span>
<a href="#l12.1432"></a><span id="l12.1432" class="difflineminus">-                                    nsIMsgFilterCustomAction** aResult)</span>
<a href="#l12.1433"></a><span id="l12.1433" class="difflineminus">-{</span>
<a href="#l12.1434"></a><span id="l12.1434" class="difflineplus">+nsMsgFilterService::GetCustomAction(const nsACString &amp;aId,</span>
<a href="#l12.1435"></a><span id="l12.1435" class="difflineplus">+                                    nsIMsgFilterCustomAction **aResult) {</span>
<a href="#l12.1436"></a><span id="l12.1436">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.1437"></a><span id="l12.1437"> </span>
<a href="#l12.1438"></a><span id="l12.1438" class="difflineminus">-  for (int32_t i = 0; i &lt; mCustomActions.Count(); i++)</span>
<a href="#l12.1439"></a><span id="l12.1439" class="difflineminus">-  {</span>
<a href="#l12.1440"></a><span id="l12.1440" class="difflineplus">+  for (int32_t i = 0; i &lt; mCustomActions.Count(); i++) {</span>
<a href="#l12.1441"></a><span id="l12.1441">     nsAutoCString id;</span>
<a href="#l12.1442"></a><span id="l12.1442">     nsresult rv = mCustomActions[i]-&gt;GetId(id);</span>
<a href="#l12.1443"></a><span id="l12.1443" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aId.Equals(id))</span>
<a href="#l12.1444"></a><span id="l12.1444" class="difflineminus">-    {</span>
<a href="#l12.1445"></a><span id="l12.1445" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aId.Equals(id)) {</span>
<a href="#l12.1446"></a><span id="l12.1446">       NS_ADDREF(*aResult = mCustomActions[i]);</span>
<a href="#l12.1447"></a><span id="l12.1447">       return NS_OK;</span>
<a href="#l12.1448"></a><span id="l12.1448">     }</span>
<a href="#l12.1449"></a><span id="l12.1449">   }</span>
<a href="#l12.1450"></a><span id="l12.1450">   aResult = nullptr;</span>
<a href="#l12.1451"></a><span id="l12.1451">   return NS_ERROR_FAILURE;</span>
<a href="#l12.1452"></a><span id="l12.1452"> }</span>
<a href="#l12.1453"></a><span id="l12.1453"> </span>
<a href="#l12.1454"></a><span id="l12.1454" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::AddCustomTerm(nsIMsgSearchCustomTerm *aTerm)</span>
<a href="#l12.1455"></a><span id="l12.1455" class="difflineminus">-{</span>
<a href="#l12.1456"></a><span id="l12.1456" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::AddCustomTerm(nsIMsgSearchCustomTerm *aTerm) {</span>
<a href="#l12.1457"></a><span id="l12.1457">   mCustomTerms.AppendObject(aTerm);</span>
<a href="#l12.1458"></a><span id="l12.1458">   return NS_OK;</span>
<a href="#l12.1459"></a><span id="l12.1459"> }</span>
<a href="#l12.1460"></a><span id="l12.1460"> </span>
<a href="#l12.1461"></a><span id="l12.1461" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::GetCustomTerms(nsISimpleEnumerator** aResult)</span>
<a href="#l12.1462"></a><span id="l12.1462" class="difflineminus">-{</span>
<a href="#l12.1463"></a><span id="l12.1463" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::GetCustomTerms(</span>
<a href="#l12.1464"></a><span id="l12.1464" class="difflineplus">+    nsISimpleEnumerator **aResult) {</span>
<a href="#l12.1465"></a><span id="l12.1465">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.1466"></a><span id="l12.1466"> </span>
<a href="#l12.1467"></a><span id="l12.1467" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mCustomTerms, NS_GET_IID(nsIMsgSearchCustomTerm));</span>
<a href="#l12.1468"></a><span id="l12.1468" class="difflineplus">+  return NS_NewArrayEnumerator(aResult, mCustomTerms,</span>
<a href="#l12.1469"></a><span id="l12.1469" class="difflineplus">+                               NS_GET_IID(nsIMsgSearchCustomTerm));</span>
<a href="#l12.1470"></a><span id="l12.1470"> }</span>
<a href="#l12.1471"></a><span id="l12.1471"> </span>
<a href="#l12.1472"></a><span id="l12.1472"> NS_IMETHODIMP</span>
<a href="#l12.1473"></a><span id="l12.1473" class="difflineminus">-nsMsgFilterService::GetCustomTerm(const nsACString&amp; aId,</span>
<a href="#l12.1474"></a><span id="l12.1474" class="difflineminus">-                                    nsIMsgSearchCustomTerm** aResult)</span>
<a href="#l12.1475"></a><span id="l12.1475" class="difflineminus">-{</span>
<a href="#l12.1476"></a><span id="l12.1476" class="difflineplus">+nsMsgFilterService::GetCustomTerm(const nsACString &amp;aId,</span>
<a href="#l12.1477"></a><span id="l12.1477" class="difflineplus">+                                  nsIMsgSearchCustomTerm **aResult) {</span>
<a href="#l12.1478"></a><span id="l12.1478">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.1479"></a><span id="l12.1479"> </span>
<a href="#l12.1480"></a><span id="l12.1480" class="difflineminus">-  for (int32_t i = 0; i &lt; mCustomTerms.Count(); i++)</span>
<a href="#l12.1481"></a><span id="l12.1481" class="difflineminus">-  {</span>
<a href="#l12.1482"></a><span id="l12.1482" class="difflineplus">+  for (int32_t i = 0; i &lt; mCustomTerms.Count(); i++) {</span>
<a href="#l12.1483"></a><span id="l12.1483">     nsAutoCString id;</span>
<a href="#l12.1484"></a><span id="l12.1484">     nsresult rv = mCustomTerms[i]-&gt;GetId(id);</span>
<a href="#l12.1485"></a><span id="l12.1485" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aId.Equals(id))</span>
<a href="#l12.1486"></a><span id="l12.1486" class="difflineminus">-    {</span>
<a href="#l12.1487"></a><span id="l12.1487" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aId.Equals(id)) {</span>
<a href="#l12.1488"></a><span id="l12.1488">       NS_ADDREF(*aResult = mCustomTerms[i]);</span>
<a href="#l12.1489"></a><span id="l12.1489">       return NS_OK;</span>
<a href="#l12.1490"></a><span id="l12.1490">     }</span>
<a href="#l12.1491"></a><span id="l12.1491">   }</span>
<a href="#l12.1492"></a><span id="l12.1492">   aResult = nullptr;</span>
<a href="#l12.1493"></a><span id="l12.1493">   // we use a null result to indicate failure to find a term</span>
<a href="#l12.1494"></a><span id="l12.1494">   return NS_OK;</span>
<a href="#l12.1495"></a><span id="l12.1495"> }</span>
<a href="#l12.1496"></a><span id="l12.1496"> </span>
<a href="#l12.1497"></a><span id="l12.1497"> /**</span>
<a href="#l12.1498"></a><span id="l12.1498">  * Translate the filter type flag into human readable type names.</span>
<a href="#l12.1499"></a><span id="l12.1499">  * In case of multiple flag they are delimited by '&amp;'.</span>
<a href="#l12.1500"></a><span id="l12.1500">  */</span>
<a href="#l12.1501"></a><span id="l12.1501"> NS_IMETHODIMP</span>
<a href="#l12.1502"></a><span id="l12.1502" class="difflineminus">-nsMsgFilterService::FilterTypeName(nsMsgFilterTypeType filterType, nsACString &amp;typeName) {</span>
<a href="#l12.1503"></a><span id="l12.1503" class="difflineplus">+nsMsgFilterService::FilterTypeName(nsMsgFilterTypeType filterType,</span>
<a href="#l12.1504"></a><span id="l12.1504" class="difflineplus">+                                   nsACString &amp;typeName) {</span>
<a href="#l12.1505"></a><span id="l12.1505">   typeName.Truncate();</span>
<a href="#l12.1506"></a><span id="l12.1506">   if (filterType == nsMsgFilterType::None) {</span>
<a href="#l12.1507"></a><span id="l12.1507">     typeName.Assign(&quot;None&quot;);</span>
<a href="#l12.1508"></a><span id="l12.1508">     return NS_OK;</span>
<a href="#l12.1509"></a><span id="l12.1509">   }</span>
<a href="#l12.1510"></a><span id="l12.1510"> </span>
<a href="#l12.1511"></a><span id="l12.1511">   if ((filterType &amp; nsMsgFilterType::Incoming) == nsMsgFilterType::Incoming) {</span>
<a href="#l12.1512"></a><span id="l12.1512">     typeName.Append(&quot;Incoming&amp;&quot;);</span>
<a href="#l12.1513"></a><span id="l12.1513" class="difflineat">@@ -1096,284 +1103,267 @@ nsMsgFilterService::FilterTypeName(nsMsg</span>
<a href="#l12.1514"></a><span id="l12.1514">       if (filterType &amp; nsMsgFilterType::InboxRule)</span>
<a href="#l12.1515"></a><span id="l12.1515">         typeName.Append(&quot;InboxRule&amp;&quot;);</span>
<a href="#l12.1516"></a><span id="l12.1516">       if (filterType &amp; nsMsgFilterType::InboxJavaScript)</span>
<a href="#l12.1517"></a><span id="l12.1517">         typeName.Append(&quot;InboxJavaScript&amp;&quot;);</span>
<a href="#l12.1518"></a><span id="l12.1518">     }</span>
<a href="#l12.1519"></a><span id="l12.1519">     if ((filterType &amp; nsMsgFilterType::News) == nsMsgFilterType::News) {</span>
<a href="#l12.1520"></a><span id="l12.1520">       typeName.Append(&quot;News&amp;&quot;);</span>
<a href="#l12.1521"></a><span id="l12.1521">     } else {</span>
<a href="#l12.1522"></a><span id="l12.1522" class="difflineminus">-      if (filterType &amp; nsMsgFilterType::NewsRule)</span>
<a href="#l12.1523"></a><span id="l12.1523" class="difflineminus">-        typeName.Append(&quot;NewsRule&amp;&quot;);</span>
<a href="#l12.1524"></a><span id="l12.1524" class="difflineplus">+      if (filterType &amp; nsMsgFilterType::NewsRule) typeName.Append(&quot;NewsRule&amp;&quot;);</span>
<a href="#l12.1525"></a><span id="l12.1525">       if (filterType &amp; nsMsgFilterType::NewsJavaScript)</span>
<a href="#l12.1526"></a><span id="l12.1526">         typeName.Append(&quot;NewsJavaScript&amp;&quot;);</span>
<a href="#l12.1527"></a><span id="l12.1527">     }</span>
<a href="#l12.1528"></a><span id="l12.1528">   }</span>
<a href="#l12.1529"></a><span id="l12.1529" class="difflineminus">-  if (filterType &amp; nsMsgFilterType::Manual)</span>
<a href="#l12.1530"></a><span id="l12.1530" class="difflineminus">-    typeName.Append(&quot;Manual&amp;&quot;);</span>
<a href="#l12.1531"></a><span id="l12.1531" class="difflineminus">-  if (filterType &amp; nsMsgFilterType::PostPlugin)</span>
<a href="#l12.1532"></a><span id="l12.1532" class="difflineminus">-    typeName.Append(&quot;PostPlugin&amp;&quot;);</span>
<a href="#l12.1533"></a><span id="l12.1533" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::Manual) typeName.Append(&quot;Manual&amp;&quot;);</span>
<a href="#l12.1534"></a><span id="l12.1534" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::PostPlugin) typeName.Append(&quot;PostPlugin&amp;&quot;);</span>
<a href="#l12.1535"></a><span id="l12.1535">   if (filterType &amp; nsMsgFilterType::PostOutgoing)</span>
<a href="#l12.1536"></a><span id="l12.1536">     typeName.Append(&quot;PostOutgoing&amp;&quot;);</span>
<a href="#l12.1537"></a><span id="l12.1537" class="difflineminus">-  if (filterType &amp; nsMsgFilterType::Archive)</span>
<a href="#l12.1538"></a><span id="l12.1538" class="difflineminus">-    typeName.Append(&quot;Archive&amp;&quot;);</span>
<a href="#l12.1539"></a><span id="l12.1539" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::Archive) typeName.Append(&quot;Archive&amp;&quot;);</span>
<a href="#l12.1540"></a><span id="l12.1540"> </span>
<a href="#l12.1541"></a><span id="l12.1541">   if (typeName.IsEmpty()) {</span>
<a href="#l12.1542"></a><span id="l12.1542">     typeName.Assign(&quot;UNKNOWN&quot;);</span>
<a href="#l12.1543"></a><span id="l12.1543">   } else {</span>
<a href="#l12.1544"></a><span id="l12.1544">     // Cut the trailing '&amp;' character.</span>
<a href="#l12.1545"></a><span id="l12.1545">     typeName.Truncate(typeName.Length() - 1);</span>
<a href="#l12.1546"></a><span id="l12.1546">   }</span>
<a href="#l12.1547"></a><span id="l12.1547">   return NS_OK;</span>
<a href="#l12.1548"></a><span id="l12.1548"> }</span>
<a href="#l12.1549"></a><span id="l12.1549"> </span>
<a href="#l12.1550"></a><span id="l12.1550"> // nsMsgApplyFiltersToMessages overrides nsMsgFilterAfterTheFact in order to</span>
<a href="#l12.1551"></a><span id="l12.1551"> // apply filters to a list of messages, rather than an entire folder</span>
<a href="#l12.1552"></a><span id="l12.1552" class="difflineminus">-class nsMsgApplyFiltersToMessages : public nsMsgFilterAfterTheFact</span>
<a href="#l12.1553"></a><span id="l12.1553" class="difflineminus">-{</span>
<a href="#l12.1554"></a><span id="l12.1554" class="difflineminus">-public:</span>
<a href="#l12.1555"></a><span id="l12.1555" class="difflineplus">+class nsMsgApplyFiltersToMessages : public nsMsgFilterAfterTheFact {</span>
<a href="#l12.1556"></a><span id="l12.1556" class="difflineplus">+ public:</span>
<a href="#l12.1557"></a><span id="l12.1557">   nsMsgApplyFiltersToMessages(nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.1558"></a><span id="l12.1558">                               nsIMsgFilterList *aFilterList,</span>
<a href="#l12.1559"></a><span id="l12.1559">                               nsIArray *aFolderList, nsIArray *aMsgHdrList,</span>
<a href="#l12.1560"></a><span id="l12.1560">                               nsMsgFilterTypeType aFilterType,</span>
<a href="#l12.1561"></a><span id="l12.1561">                               nsIMsgOperationListener *aCallback);</span>
<a href="#l12.1562"></a><span id="l12.1562"> </span>
<a href="#l12.1563"></a><span id="l12.1563" class="difflineminus">-protected:</span>
<a href="#l12.1564"></a><span id="l12.1564" class="difflineminus">-  virtual   nsresult  RunNextFilter();</span>
<a href="#l12.1565"></a><span id="l12.1565" class="difflineplus">+ protected:</span>
<a href="#l12.1566"></a><span id="l12.1566" class="difflineplus">+  virtual nsresult RunNextFilter();</span>
<a href="#l12.1567"></a><span id="l12.1567"> </span>
<a href="#l12.1568"></a><span id="l12.1568">   nsCOMArray&lt;nsIMsgDBHdr&gt; m_msgHdrList;</span>
<a href="#l12.1569"></a><span id="l12.1569" class="difflineminus">-  nsMsgFilterTypeType     m_filterType;</span>
<a href="#l12.1570"></a><span id="l12.1570" class="difflineplus">+  nsMsgFilterTypeType m_filterType;</span>
<a href="#l12.1571"></a><span id="l12.1571"> };</span>
<a href="#l12.1572"></a><span id="l12.1572"> </span>
<a href="#l12.1573"></a><span id="l12.1573" class="difflineminus">-nsMsgApplyFiltersToMessages::nsMsgApplyFiltersToMessages(nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.1574"></a><span id="l12.1574" class="difflineminus">-                                                         nsIMsgFilterList *aFilterList,</span>
<a href="#l12.1575"></a><span id="l12.1575" class="difflineminus">-                                                         nsIArray *aFolderList,</span>
<a href="#l12.1576"></a><span id="l12.1576" class="difflineminus">-                                                         nsIArray *aMsgHdrList,</span>
<a href="#l12.1577"></a><span id="l12.1577" class="difflineminus">-                                                         nsMsgFilterTypeType aFilterType,</span>
<a href="#l12.1578"></a><span id="l12.1578" class="difflineminus">-                                                         nsIMsgOperationListener *aCallback)</span>
<a href="#l12.1579"></a><span id="l12.1579" class="difflineminus">-: nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolderList, aCallback),</span>
<a href="#l12.1580"></a><span id="l12.1580" class="difflineminus">-  m_filterType(aFilterType)</span>
<a href="#l12.1581"></a><span id="l12.1581" class="difflineminus">-{</span>
<a href="#l12.1582"></a><span id="l12.1582" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgApplyFiltersToMessages&quot;));</span>
<a href="#l12.1583"></a><span id="l12.1583" class="difflineplus">+nsMsgApplyFiltersToMessages::nsMsgApplyFiltersToMessages(</span>
<a href="#l12.1584"></a><span id="l12.1584" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIMsgFilterList *aFilterList,</span>
<a href="#l12.1585"></a><span id="l12.1585" class="difflineplus">+    nsIArray *aFolderList, nsIArray *aMsgHdrList,</span>
<a href="#l12.1586"></a><span id="l12.1586" class="difflineplus">+    nsMsgFilterTypeType aFilterType, nsIMsgOperationListener *aCallback)</span>
<a href="#l12.1587"></a><span id="l12.1587" class="difflineplus">+    : nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolderList, aCallback),</span>
<a href="#l12.1588"></a><span id="l12.1588" class="difflineplus">+      m_filterType(aFilterType) {</span>
<a href="#l12.1589"></a><span id="l12.1589" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.1590"></a><span id="l12.1590" class="difflineplus">+          (&quot;(Post) nsMsgApplyFiltersToMessages&quot;));</span>
<a href="#l12.1591"></a><span id="l12.1591">   nsCOMPtr&lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l12.1592"></a><span id="l12.1592" class="difflineminus">-  if (NS_SUCCEEDED(aMsgHdrList-&gt;Enumerate(getter_AddRefs(msgEnumerator))))</span>
<a href="#l12.1593"></a><span id="l12.1593" class="difflineminus">-  {</span>
<a href="#l12.1594"></a><span id="l12.1594" class="difflineplus">+  if (NS_SUCCEEDED(aMsgHdrList-&gt;Enumerate(getter_AddRefs(msgEnumerator)))) {</span>
<a href="#l12.1595"></a><span id="l12.1595">     uint32_t length;</span>
<a href="#l12.1596"></a><span id="l12.1596">     if (NS_SUCCEEDED(aMsgHdrList-&gt;GetLength(&amp;length)))</span>
<a href="#l12.1597"></a><span id="l12.1597">       m_msgHdrList.SetCapacity(length);</span>
<a href="#l12.1598"></a><span id="l12.1598"> </span>
<a href="#l12.1599"></a><span id="l12.1599">     bool hasMore;</span>
<a href="#l12.1600"></a><span id="l12.1600" class="difflineminus">-    while (NS_SUCCEEDED(msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.1601"></a><span id="l12.1601" class="difflineminus">-    {</span>
<a href="#l12.1602"></a><span id="l12.1602" class="difflineplus">+    while (NS_SUCCEEDED(msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.1603"></a><span id="l12.1603">       nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.1604"></a><span id="l12.1604">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.1605"></a><span id="l12.1605">       if (NS_SUCCEEDED(msgEnumerator-&gt;GetNext(getter_AddRefs(supports))) &amp;&amp;</span>
<a href="#l12.1606"></a><span id="l12.1606">           (msgHdr = do_QueryInterface(supports)))</span>
<a href="#l12.1607"></a><span id="l12.1607">         m_msgHdrList.AppendObject(msgHdr);</span>
<a href="#l12.1608"></a><span id="l12.1608">     }</span>
<a href="#l12.1609"></a><span id="l12.1609">   }</span>
<a href="#l12.1610"></a><span id="l12.1610"> }</span>
<a href="#l12.1611"></a><span id="l12.1611"> </span>
<a href="#l12.1612"></a><span id="l12.1612" class="difflineminus">-nsresult nsMsgApplyFiltersToMessages::RunNextFilter()</span>
<a href="#l12.1613"></a><span id="l12.1613" class="difflineminus">-{</span>
<a href="#l12.1614"></a><span id="l12.1614" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgApplyFiltersToMessages::RunNextFilter&quot;));</span>
<a href="#l12.1615"></a><span id="l12.1615" class="difflineplus">+nsresult nsMsgApplyFiltersToMessages::RunNextFilter() {</span>
<a href="#l12.1616"></a><span id="l12.1616" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.1617"></a><span id="l12.1617" class="difflineplus">+          (&quot;(Post) nsMsgApplyFiltersToMessages::RunNextFilter&quot;));</span>
<a href="#l12.1618"></a><span id="l12.1618">   nsresult rv = NS_OK;</span>
<a href="#l12.1619"></a><span id="l12.1619" class="difflineminus">-  while (true)</span>
<a href="#l12.1620"></a><span id="l12.1620" class="difflineminus">-  {</span>
<a href="#l12.1621"></a><span id="l12.1621" class="difflineminus">-    m_curFilter = nullptr; // we are done with the current filter</span>
<a href="#l12.1622"></a><span id="l12.1622" class="difflineminus">-    if (!m_curFolder || // Not an error, we just need to run AdvanceToNextFolder()</span>
<a href="#l12.1623"></a><span id="l12.1623" class="difflineplus">+  while (true) {</span>
<a href="#l12.1624"></a><span id="l12.1624" class="difflineplus">+    m_curFilter = nullptr;  // we are done with the current filter</span>
<a href="#l12.1625"></a><span id="l12.1625" class="difflineplus">+    if (!m_curFolder ||     // Not an error, we just need to run</span>
<a href="#l12.1626"></a><span id="l12.1626" class="difflineplus">+                            // AdvanceToNextFolder()</span>
<a href="#l12.1627"></a><span id="l12.1627">         m_curFilterIndex &gt;= m_numFilters)</span>
<a href="#l12.1628"></a><span id="l12.1628">       break;</span>
<a href="#l12.1629"></a><span id="l12.1629"> </span>
<a href="#l12.1630"></a><span id="l12.1630">     BREAK_IF_FALSE(m_filters, &quot;No filters&quot;);</span>
<a href="#l12.1631"></a><span id="l12.1631">     nsMsgFilterTypeType filterType;</span>
<a href="#l12.1632"></a><span id="l12.1632">     bool isEnabled;</span>
<a href="#l12.1633"></a><span id="l12.1633" class="difflineminus">-    rv = m_filters-&gt;GetFilterAt(m_curFilterIndex++, getter_AddRefs(m_curFilter));</span>
<a href="#l12.1634"></a><span id="l12.1634" class="difflineplus">+    rv =</span>
<a href="#l12.1635"></a><span id="l12.1635" class="difflineplus">+        m_filters-&gt;GetFilterAt(m_curFilterIndex++, getter_AddRefs(m_curFilter));</span>
<a href="#l12.1636"></a><span id="l12.1636">     CONTINUE_IF_FAILURE(rv, &quot;Could not get filter&quot;);</span>
<a href="#l12.1637"></a><span id="l12.1637">     rv = m_curFilter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l12.1638"></a><span id="l12.1638">     CONTINUE_IF_FAILURE(rv, &quot;Could not get filter type&quot;);</span>
<a href="#l12.1639"></a><span id="l12.1639" class="difflineminus">-    if (!(filterType &amp; m_filterType))</span>
<a href="#l12.1640"></a><span id="l12.1640" class="difflineminus">-      continue;</span>
<a href="#l12.1641"></a><span id="l12.1641" class="difflineplus">+    if (!(filterType &amp; m_filterType)) continue;</span>
<a href="#l12.1642"></a><span id="l12.1642">     rv = m_curFilter-&gt;GetEnabled(&amp;isEnabled);</span>
<a href="#l12.1643"></a><span id="l12.1643">     CONTINUE_IF_FAILURE(rv, &quot;Could not get isEnabled&quot;);</span>
<a href="#l12.1644"></a><span id="l12.1644" class="difflineminus">-    if (!isEnabled)</span>
<a href="#l12.1645"></a><span id="l12.1645" class="difflineminus">-      continue;</span>
<a href="#l12.1646"></a><span id="l12.1646" class="difflineplus">+    if (!isEnabled) continue;</span>
<a href="#l12.1647"></a><span id="l12.1647"> </span>
<a href="#l12.1648"></a><span id="l12.1648" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Running filter %&quot; PRIu32, m_curFilterIndex));</span>
<a href="#l12.1649"></a><span id="l12.1649" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.1650"></a><span id="l12.1650" class="difflineplus">+            (&quot;(Post) Running filter %&quot; PRIu32, m_curFilterIndex));</span>
<a href="#l12.1651"></a><span id="l12.1651">     nsString filterName;</span>
<a href="#l12.1652"></a><span id="l12.1652">     m_curFilter-&gt;GetFilterName(filterName);</span>
<a href="#l12.1653"></a><span id="l12.1653" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter name: %s&quot;, NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l12.1654"></a><span id="l12.1654" class="difflineplus">+    // clang-format off</span>
<a href="#l12.1655"></a><span id="l12.1655" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.1656"></a><span id="l12.1656" class="difflineplus">+            (&quot;(Post) Filter name: %s&quot;, NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l12.1657"></a><span id="l12.1657" class="difflineplus">+    // clang-format on</span>
<a href="#l12.1658"></a><span id="l12.1658"> </span>
<a href="#l12.1659"></a><span id="l12.1659" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchScopeTerm&gt; scope(new nsMsgSearchScopeTerm(nullptr, nsMsgSearchScope::offlineMail, m_curFolder));</span>
<a href="#l12.1660"></a><span id="l12.1660" class="difflineplus">+    nsCOMPtr&lt;nsIMsgSearchScopeTerm&gt; scope(new nsMsgSearchScopeTerm(</span>
<a href="#l12.1661"></a><span id="l12.1661" class="difflineplus">+        nullptr, nsMsgSearchScope::offlineMail, m_curFolder));</span>
<a href="#l12.1662"></a><span id="l12.1662">     BREAK_IF_FALSE(scope, &quot;Could not create scope, OOM?&quot;);</span>
<a href="#l12.1663"></a><span id="l12.1663">     m_curFilter-&gt;SetScope(scope);</span>
<a href="#l12.1664"></a><span id="l12.1664">     OnNewSearch();</span>
<a href="#l12.1665"></a><span id="l12.1665"> </span>
<a href="#l12.1666"></a><span id="l12.1666" class="difflineminus">-    for (int32_t i = 0; i &lt; m_msgHdrList.Count(); i++)</span>
<a href="#l12.1667"></a><span id="l12.1667" class="difflineminus">-    {</span>
<a href="#l12.1668"></a><span id="l12.1668" class="difflineplus">+    for (int32_t i = 0; i &lt; m_msgHdrList.Count(); i++) {</span>
<a href="#l12.1669"></a><span id="l12.1669">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_msgHdrList[i];</span>
<a href="#l12.1670"></a><span id="l12.1670">       CONTINUE_IF_FALSE(msgHdr, &quot;null msgHdr&quot;);</span>
<a href="#l12.1671"></a><span id="l12.1671"> </span>
<a href="#l12.1672"></a><span id="l12.1672">       bool matched;</span>
<a href="#l12.1673"></a><span id="l12.1673" class="difflineminus">-      rv = m_curFilter-&gt;MatchHdr(msgHdr, m_curFolder, m_curFolderDB, EmptyCString(), &amp;matched);</span>
<a href="#l12.1674"></a><span id="l12.1674" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; matched)</span>
<a href="#l12.1675"></a><span id="l12.1675" class="difflineminus">-      {</span>
<a href="#l12.1676"></a><span id="l12.1676" class="difflineminus">-        // In order to work with nsMsgFilterAfterTheFact::ApplyFilter we initialize</span>
<a href="#l12.1677"></a><span id="l12.1677" class="difflineminus">-        // nsMsgFilterAfterTheFact's information with a search hit now for the message</span>
<a href="#l12.1678"></a><span id="l12.1678" class="difflineminus">-        // that we're filtering.</span>
<a href="#l12.1679"></a><span id="l12.1679" class="difflineplus">+      rv = m_curFilter-&gt;MatchHdr(msgHdr, m_curFolder, m_curFolderDB,</span>
<a href="#l12.1680"></a><span id="l12.1680" class="difflineplus">+                                 EmptyCString(), &amp;matched);</span>
<a href="#l12.1681"></a><span id="l12.1681" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; matched) {</span>
<a href="#l12.1682"></a><span id="l12.1682" class="difflineplus">+        // In order to work with nsMsgFilterAfterTheFact::ApplyFilter we</span>
<a href="#l12.1683"></a><span id="l12.1683" class="difflineplus">+        // initialize nsMsgFilterAfterTheFact's information with a search hit</span>
<a href="#l12.1684"></a><span id="l12.1684" class="difflineplus">+        // now for the message that we're filtering.</span>
<a href="#l12.1685"></a><span id="l12.1685">         OnSearchHit(msgHdr, m_curFolder);</span>
<a href="#l12.1686"></a><span id="l12.1686">       }</span>
<a href="#l12.1687"></a><span id="l12.1687">     }</span>
<a href="#l12.1688"></a><span id="l12.1688">     m_curFilter-&gt;SetScope(nullptr);</span>
<a href="#l12.1689"></a><span id="l12.1689"> </span>
<a href="#l12.1690"></a><span id="l12.1690" class="difflineminus">-    if (m_searchHits.Length() &gt; 0)</span>
<a href="#l12.1691"></a><span id="l12.1691" class="difflineminus">-    {</span>
<a href="#l12.1692"></a><span id="l12.1692" class="difflineplus">+    if (m_searchHits.Length() &gt; 0) {</span>
<a href="#l12.1693"></a><span id="l12.1693">       m_nextAction = 0;</span>
<a href="#l12.1694"></a><span id="l12.1694">       rv = ApplyFilter();</span>
<a href="#l12.1695"></a><span id="l12.1695">       if (NS_SUCCEEDED(rv))</span>
<a href="#l12.1696"></a><span id="l12.1696" class="difflineminus">-        return NS_OK; // async callback will continue, or we are done.</span>
<a href="#l12.1697"></a><span id="l12.1697" class="difflineplus">+        return NS_OK;  // async callback will continue, or we are done.</span>
<a href="#l12.1698"></a><span id="l12.1698">     }</span>
<a href="#l12.1699"></a><span id="l12.1699">   }</span>
<a href="#l12.1700"></a><span id="l12.1700"> </span>
<a href="#l12.1701"></a><span id="l12.1701">   if (NS_FAILED(rv)) {</span>
<a href="#l12.1702"></a><span id="l12.1702" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l12.1703"></a><span id="l12.1703" class="difflineminus">-    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;), m_curFilter);</span>
<a href="#l12.1704"></a><span id="l12.1704" class="difflineplus">+    // clang-format off</span>
<a href="#l12.1705"></a><span id="l12.1705" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l12.1706"></a><span id="l12.1706" class="difflineplus">+            (&quot;(Post) Filter run failed (%&quot; PRIx32 &quot;)&quot;,</span>
<a href="#l12.1707"></a><span id="l12.1707" class="difflineplus">+             static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l12.1708"></a><span id="l12.1708" class="difflineplus">+    // clang-format on</span>
<a href="#l12.1709"></a><span id="l12.1709" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;),</span>
<a href="#l12.1710"></a><span id="l12.1710" class="difflineplus">+                                m_curFilter);</span>
<a href="#l12.1711"></a><span id="l12.1711">     NS_WARNING_ASSERTION(false, &quot;Failed to run filters&quot;);</span>
<a href="#l12.1712"></a><span id="l12.1712">   } else {</span>
<a href="#l12.1713"></a><span id="l12.1713" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter run finished on the current folder&quot;));</span>
<a href="#l12.1714"></a><span id="l12.1714" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.1715"></a><span id="l12.1715" class="difflineplus">+            (&quot;(Post) Filter run finished on the current folder&quot;));</span>
<a href="#l12.1716"></a><span id="l12.1716">   }</span>
<a href="#l12.1717"></a><span id="l12.1717"> </span>
<a href="#l12.1718"></a><span id="l12.1718">   m_curFilter = nullptr;</span>
<a href="#l12.1719"></a><span id="l12.1719"> </span>
<a href="#l12.1720"></a><span id="l12.1720">   // We expect the failure is already recorded through one of the macro</span>
<a href="#l12.1721"></a><span id="l12.1721">   // expressions, that will have console logging added to them.</span>
<a href="#l12.1722"></a><span id="l12.1722">   // So an additional console warning is not needed here.</span>
<a href="#l12.1723"></a><span id="l12.1723">   return AdvanceToNextFolder();</span>
<a href="#l12.1724"></a><span id="l12.1724"> }</span>
<a href="#l12.1725"></a><span id="l12.1725"> </span>
<a href="#l12.1726"></a><span id="l12.1726" class="difflineminus">-NS_IMETHODIMP nsMsgFilterService::ApplyFilters(nsMsgFilterTypeType aFilterType,</span>
<a href="#l12.1727"></a><span id="l12.1727" class="difflineminus">-                                               nsIArray *aMsgHdrList,</span>
<a href="#l12.1728"></a><span id="l12.1728" class="difflineminus">-                                               nsIMsgFolder *aFolder,</span>
<a href="#l12.1729"></a><span id="l12.1729" class="difflineminus">-                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.1730"></a><span id="l12.1730" class="difflineminus">-                                               nsIMsgOperationListener *aCallback)</span>
<a href="#l12.1731"></a><span id="l12.1731" class="difflineminus">-{</span>
<a href="#l12.1732"></a><span id="l12.1732" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgApplyFiltersToMessages::ApplyFilters&quot;));</span>
<a href="#l12.1733"></a><span id="l12.1733" class="difflineplus">+NS_IMETHODIMP nsMsgFilterService::ApplyFilters(</span>
<a href="#l12.1734"></a><span id="l12.1734" class="difflineplus">+    nsMsgFilterTypeType aFilterType, nsIArray *aMsgHdrList,</span>
<a href="#l12.1735"></a><span id="l12.1735" class="difflineplus">+    nsIMsgFolder *aFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.1736"></a><span id="l12.1736" class="difflineplus">+    nsIMsgOperationListener *aCallback) {</span>
<a href="#l12.1737"></a><span id="l12.1737" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l12.1738"></a><span id="l12.1738" class="difflineplus">+          (&quot;(Post) nsMsgApplyFiltersToMessages::ApplyFilters&quot;));</span>
<a href="#l12.1739"></a><span id="l12.1739">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l12.1740"></a><span id="l12.1740"> </span>
<a href="#l12.1741"></a><span id="l12.1741" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFilterList&gt;    filterList;</span>
<a href="#l12.1742"></a><span id="l12.1742" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l12.1743"></a><span id="l12.1743">   nsresult rv = aFolder-&gt;GetFilterList(aMsgWindow, getter_AddRefs(filterList));</span>
<a href="#l12.1744"></a><span id="l12.1744">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1745"></a><span id="l12.1745"> </span>
<a href="#l12.1746"></a><span id="l12.1746" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; folderList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.1747"></a><span id="l12.1747" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; folderList(</span>
<a href="#l12.1748"></a><span id="l12.1748" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.1749"></a><span id="l12.1749">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1750"></a><span id="l12.1750"> </span>
<a href="#l12.1751"></a><span id="l12.1751">   folderList-&gt;AppendElement(aFolder);</span>
<a href="#l12.1752"></a><span id="l12.1752"> </span>
<a href="#l12.1753"></a><span id="l12.1753">   uint32_t filterCount;</span>
<a href="#l12.1754"></a><span id="l12.1754">   filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l12.1755"></a><span id="l12.1755">   uint32_t msgCount;</span>
<a href="#l12.1756"></a><span id="l12.1756">   aMsgHdrList-&gt;GetLength(&amp;msgCount);</span>
<a href="#l12.1757"></a><span id="l12.1757">   nsCString listId;</span>
<a href="#l12.1758"></a><span id="l12.1758">   filterList-&gt;GetListId(listId);</span>
<a href="#l12.1759"></a><span id="l12.1759">   nsString folderName;</span>
<a href="#l12.1760"></a><span id="l12.1760">   aFolder-&gt;GetName(folderName);</span>
<a href="#l12.1761"></a><span id="l12.1761">   nsCString typeName;</span>
<a href="#l12.1762"></a><span id="l12.1762">   FilterTypeName(aFilterType, typeName);</span>
<a href="#l12.1763"></a><span id="l12.1763" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(), aFilterType));</span>
<a href="#l12.1764"></a><span id="l12.1764" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32 &quot; message(s) in folder '%s'&quot;,</span>
<a href="#l12.1765"></a><span id="l12.1765" class="difflineminus">-                                            filterCount, listId.get(), msgCount, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l12.1766"></a><span id="l12.1766" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.1767"></a><span id="l12.1767" class="difflineplus">+          (&quot;(Post) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(),</span>
<a href="#l12.1768"></a><span id="l12.1768" class="difflineplus">+           aFilterType));</span>
<a href="#l12.1769"></a><span id="l12.1769" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l12.1770"></a><span id="l12.1770" class="difflineplus">+          (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32</span>
<a href="#l12.1771"></a><span id="l12.1771" class="difflineplus">+           &quot; message(s) in folder '%s'&quot;,</span>
<a href="#l12.1772"></a><span id="l12.1772" class="difflineplus">+           filterCount, listId.get(), msgCount,</span>
<a href="#l12.1773"></a><span id="l12.1773" class="difflineplus">+           NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l12.1774"></a><span id="l12.1774"> </span>
<a href="#l12.1775"></a><span id="l12.1775" class="difflineminus">-  // Create our nsMsgApplyFiltersToMessages object which will be called when ApplyFiltersToHdr</span>
<a href="#l12.1776"></a><span id="l12.1776" class="difflineminus">-  // finds one or more filters that hit.</span>
<a href="#l12.1777"></a><span id="l12.1777" class="difflineplus">+  // Create our nsMsgApplyFiltersToMessages object which will be called when</span>
<a href="#l12.1778"></a><span id="l12.1778" class="difflineplus">+  // ApplyFiltersToHdr finds one or more filters that hit.</span>
<a href="#l12.1779"></a><span id="l12.1779">   RefPtr&lt;nsMsgApplyFiltersToMessages&gt; filterExecutor =</span>
<a href="#l12.1780"></a><span id="l12.1780" class="difflineminus">-    new nsMsgApplyFiltersToMessages(aMsgWindow, filterList, folderList,</span>
<a href="#l12.1781"></a><span id="l12.1781" class="difflineminus">-                                    aMsgHdrList, aFilterType, aCallback);</span>
<a href="#l12.1782"></a><span id="l12.1782" class="difflineplus">+      new nsMsgApplyFiltersToMessages(aMsgWindow, filterList, folderList,</span>
<a href="#l12.1783"></a><span id="l12.1783" class="difflineplus">+                                      aMsgHdrList, aFilterType, aCallback);</span>
<a href="#l12.1784"></a><span id="l12.1784"> </span>
<a href="#l12.1785"></a><span id="l12.1785" class="difflineminus">-  if (filterExecutor)</span>
<a href="#l12.1786"></a><span id="l12.1786" class="difflineminus">-    return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l12.1787"></a><span id="l12.1787" class="difflineplus">+  if (filterExecutor) return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l12.1788"></a><span id="l12.1788"> </span>
<a href="#l12.1789"></a><span id="l12.1789">   return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.1790"></a><span id="l12.1790"> }</span>
<a href="#l12.1791"></a><span id="l12.1791"> </span>
<a href="#l12.1792"></a><span id="l12.1792"> /* void OnStartCopy (); */</span>
<a href="#l12.1793"></a><span id="l12.1793" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStartCopy()</span>
<a href="#l12.1794"></a><span id="l12.1794" class="difflineminus">-{</span>
<a href="#l12.1795"></a><span id="l12.1795" class="difflineminus">-  return NS_OK;</span>
<a href="#l12.1796"></a><span id="l12.1796" class="difflineminus">-}</span>
<a href="#l12.1797"></a><span id="l12.1797" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStartCopy() { return NS_OK; }</span>
<a href="#l12.1798"></a><span id="l12.1798"> </span>
<a href="#l12.1799"></a><span id="l12.1799"> /* void OnProgress (in uint32_t aProgress, in uint32_t aProgressMax); */</span>
<a href="#l12.1800"></a><span id="l12.1800" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l12.1801"></a><span id="l12.1801" class="difflineminus">-{</span>
<a href="#l12.1802"></a><span id="l12.1802" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnProgress(uint32_t aProgress,</span>
<a href="#l12.1803"></a><span id="l12.1803" class="difflineplus">+                                                  uint32_t aProgressMax) {</span>
<a href="#l12.1804"></a><span id="l12.1804">   return NS_OK;</span>
<a href="#l12.1805"></a><span id="l12.1805"> }</span>
<a href="#l12.1806"></a><span id="l12.1806"> </span>
<a href="#l12.1807"></a><span id="l12.1807"> /* void SetMessageKey (in uint32_t aKey); */</span>
<a href="#l12.1808"></a><span id="l12.1808" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::SetMessageKey(nsMsgKey /* aKey */)</span>
<a href="#l12.1809"></a><span id="l12.1809" class="difflineminus">-{</span>
<a href="#l12.1810"></a><span id="l12.1810" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::SetMessageKey(nsMsgKey /* aKey */) {</span>
<a href="#l12.1811"></a><span id="l12.1811">   return NS_OK;</span>
<a href="#l12.1812"></a><span id="l12.1812"> }</span>
<a href="#l12.1813"></a><span id="l12.1813"> </span>
<a href="#l12.1814"></a><span id="l12.1814" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::GetMessageId(nsACString&amp; messageId)</span>
<a href="#l12.1815"></a><span id="l12.1815" class="difflineminus">-{</span>
<a href="#l12.1816"></a><span id="l12.1816" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::GetMessageId(nsACString &amp;messageId) {</span>
<a href="#l12.1817"></a><span id="l12.1817">   return NS_OK;</span>
<a href="#l12.1818"></a><span id="l12.1818"> }</span>
<a href="#l12.1819"></a><span id="l12.1819"> </span>
<a href="#l12.1820"></a><span id="l12.1820"> /* void OnStopCopy (in nsresult aStatus); */</span>
<a href="#l12.1821"></a><span id="l12.1821" class="difflineminus">-NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStopCopy(nsresult aStatus)</span>
<a href="#l12.1822"></a><span id="l12.1822" class="difflineminus">-{</span>
<a href="#l12.1823"></a><span id="l12.1823" class="difflineminus">-  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l12.1824"></a><span id="l12.1824" class="difflineminus">-    return ApplyFilter();</span>
<a href="#l12.1825"></a><span id="l12.1825" class="difflineplus">+NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStopCopy(nsresult aStatus) {</span>
<a href="#l12.1826"></a><span id="l12.1826" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) return ApplyFilter();</span>
<a href="#l12.1827"></a><span id="l12.1827"> </span>
<a href="#l12.1828"></a><span id="l12.1828">   mFinalResult = aStatus;</span>
<a href="#l12.1829"></a><span id="l12.1829" class="difflineminus">-  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt())</span>
<a href="#l12.1830"></a><span id="l12.1830" class="difflineminus">-    return OnEndExecution();</span>
<a href="#l12.1831"></a><span id="l12.1831" class="difflineplus">+  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution();</span>
<a href="#l12.1832"></a><span id="l12.1832"> </span>
<a href="#l12.1833"></a><span id="l12.1833">   // Copy failed, so run the next filter</span>
<a href="#l12.1834"></a><span id="l12.1834">   return RunNextFilter();</span>
<a href="#l12.1835"></a><span id="l12.1835"> }</span>
<a href="#l12.1836"></a><span id="l12.1836"> </span>
<a href="#l12.1837"></a><span id="l12.1837" class="difflineminus">-bool nsMsgFilterAfterTheFact::ContinueExecutionPrompt()</span>
<a href="#l12.1838"></a><span id="l12.1838" class="difflineminus">-{</span>
<a href="#l12.1839"></a><span id="l12.1839" class="difflineminus">-  if (!m_curFilter)</span>
<a href="#l12.1840"></a><span id="l12.1840" class="difflineminus">-    return false;</span>
<a href="#l12.1841"></a><span id="l12.1841" class="difflineplus">+bool nsMsgFilterAfterTheFact::ContinueExecutionPrompt() {</span>
<a href="#l12.1842"></a><span id="l12.1842" class="difflineplus">+  if (!m_curFilter) return false;</span>
<a href="#l12.1843"></a><span id="l12.1843">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l12.1844"></a><span id="l12.1844">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l12.1845"></a><span id="l12.1845" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l12.1846"></a><span id="l12.1846" class="difflineminus">-  if (!bundleService)</span>
<a href="#l12.1847"></a><span id="l12.1847" class="difflineminus">-    return false;</span>
<a href="#l12.1848"></a><span id="l12.1848" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l12.1849"></a><span id="l12.1849" class="difflineplus">+  if (!bundleService) return false;</span>
<a href="#l12.1850"></a><span id="l12.1850">   bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l12.1851"></a><span id="l12.1851">                               getter_AddRefs(bundle));</span>
<a href="#l12.1852"></a><span id="l12.1852" class="difflineminus">-  if (!bundle)</span>
<a href="#l12.1853"></a><span id="l12.1853" class="difflineminus">-    return false;</span>
<a href="#l12.1854"></a><span id="l12.1854" class="difflineplus">+  if (!bundle) return false;</span>
<a href="#l12.1855"></a><span id="l12.1855">   nsString filterName;</span>
<a href="#l12.1856"></a><span id="l12.1856">   m_curFilter-&gt;GetFilterName(filterName);</span>
<a href="#l12.1857"></a><span id="l12.1857">   nsString formatString;</span>
<a href="#l12.1858"></a><span id="l12.1858">   nsString confirmText;</span>
<a href="#l12.1859"></a><span id="l12.1859" class="difflineminus">-  const char16_t *formatStrings[] =</span>
<a href="#l12.1860"></a><span id="l12.1860" class="difflineminus">-  {</span>
<a href="#l12.1861"></a><span id="l12.1861" class="difflineminus">-    filterName.get()</span>
<a href="#l12.1862"></a><span id="l12.1862" class="difflineminus">-  };</span>
<a href="#l12.1863"></a><span id="l12.1863" class="difflineplus">+  const char16_t *formatStrings[] = {filterName.get()};</span>
<a href="#l12.1864"></a><span id="l12.1864">   nsresult rv = bundle-&gt;FormatStringFromName(&quot;continueFilterExecution&quot;,</span>
<a href="#l12.1865"></a><span id="l12.1865">                                              formatStrings, 1, confirmText);</span>
<a href="#l12.1866"></a><span id="l12.1866" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.1867"></a><span id="l12.1867" class="difflineminus">-    return false;</span>
<a href="#l12.1868"></a><span id="l12.1868" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l12.1869"></a><span id="l12.1869">   bool returnVal = false;</span>
<a href="#l12.1870"></a><span id="l12.1870" class="difflineminus">-  (void) DisplayConfirmationPrompt(m_msgWindow, confirmText.get(), &amp;returnVal);</span>
<a href="#l12.1871"></a><span id="l12.1871" class="difflineplus">+  (void)DisplayConfirmationPrompt(m_msgWindow, confirmText.get(), &amp;returnVal);</span>
<a href="#l12.1872"></a><span id="l12.1872">   return returnVal;</span>
<a href="#l12.1873"></a><span id="l12.1873"> }</span>
<a href="#l12.1874"></a><span id="l12.1874"> </span>
<a href="#l12.1875"></a><span id="l12.1875" class="difflineminus">-nsresult</span>
<a href="#l12.1876"></a><span id="l12.1876" class="difflineminus">-nsMsgFilterAfterTheFact::DisplayConfirmationPrompt(nsIMsgWindow *msgWindow, const char16_t *confirmString, bool *confirmed)</span>
<a href="#l12.1877"></a><span id="l12.1877" class="difflineminus">-{</span>
<a href="#l12.1878"></a><span id="l12.1878" class="difflineminus">-  if (msgWindow)</span>
<a href="#l12.1879"></a><span id="l12.1879" class="difflineminus">-  {</span>
<a href="#l12.1880"></a><span id="l12.1880" class="difflineminus">-    nsCOMPtr &lt;nsIDocShell&gt; docShell;</span>
<a href="#l12.1881"></a><span id="l12.1881" class="difflineplus">+nsresult nsMsgFilterAfterTheFact::DisplayConfirmationPrompt(</span>
<a href="#l12.1882"></a><span id="l12.1882" class="difflineplus">+    nsIMsgWindow *msgWindow, const char16_t *confirmString, bool *confirmed) {</span>
<a href="#l12.1883"></a><span id="l12.1883" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l12.1884"></a><span id="l12.1884" class="difflineplus">+    nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l12.1885"></a><span id="l12.1885">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l12.1886"></a><span id="l12.1886" class="difflineminus">-    if (docShell)</span>
<a href="#l12.1887"></a><span id="l12.1887" class="difflineminus">-    {</span>
<a href="#l12.1888"></a><span id="l12.1888" class="difflineplus">+    if (docShell) {</span>
<a href="#l12.1889"></a><span id="l12.1889">       nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(docShell));</span>
<a href="#l12.1890"></a><span id="l12.1890">       if (dialog &amp;&amp; confirmString)</span>
<a href="#l12.1891"></a><span id="l12.1891">         dialog-&gt;Confirm(nullptr, confirmString, confirmed);</span>
<a href="#l12.1892"></a><span id="l12.1892">     }</span>
<a href="#l12.1893"></a><span id="l12.1893">   }</span>
<a href="#l12.1894"></a><span id="l12.1894">   return NS_OK;</span>
<a href="#l12.1895"></a><span id="l12.1895"> }</span>
<a href="#l12.1896"></a><span id="l12.1896" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -8,38 +8,36 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIFile.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> class nsIMsgWindow;</span>
<a href="#l13.10"></a><span id="l13.10"> class nsIStringBundle;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13"> // The filter service is used to acquire and manipulate filter lists.</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-class nsMsgFilterService : public nsIMsgFilterService</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-{</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-public:</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+class nsMsgFilterService : public nsIMsgFilterService {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ public:</span>
<a href="#l13.21"></a><span id="l13.21">   nsMsgFilterService();</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   NS_DECL_ISUPPORTS</span>
<a href="#l13.24"></a><span id="l13.24">   NS_DECL_NSIMSGFILTERSERVICE</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-/* clients call OpenFilterList to get a handle to a FilterList, of existing nsMsgFilter *.</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  These are manipulated by the front end as a result of user interaction</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-   with dialog boxes. To apply the new list call MSG_CloseFilterList.</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-*/</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  // clients call OpenFilterList to get a handle to a FilterList, of existing</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  // nsMsgFilter. These are manipulated by the front end as a result of user</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  // interaction with dialog boxes. To apply the new list call</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  // MSG_CloseFilterList.</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+</span>
<a href="#l13.34"></a><span id="l13.34">   nsresult BackUpFilterFile(nsIFile *aFilterFile, nsIMsgWindow *aMsgWindow);</span>
<a href="#l13.35"></a><span id="l13.35">   nsresult AlertBackingUpFilterFile(nsIMsgWindow *aMsgWindow);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  nsresult ThrowAlertMsg(const char*aMsgName, nsIMsgWindow *aMsgWindow);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-  nsresult GetStringFromBundle(const char *aMsgName, nsAString&amp; aResult);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  nsresult ThrowAlertMsg(const char *aMsgName, nsIMsgWindow *aMsgWindow);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  nsresult GetStringFromBundle(const char *aMsgName, nsAString &amp;aResult);</span>
<a href="#l13.40"></a><span id="l13.40">   nsresult GetFilterStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-protected:</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+ protected:</span>
<a href="#l13.44"></a><span id="l13.44">   virtual ~nsMsgFilterService();</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-  nsCOMArray&lt;nsIMsgFilterCustomAction&gt; mCustomActions; // defined custom action list</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-  nsCOMArray&lt;nsIMsgSearchCustomTerm&gt; mCustomTerms; // defined custom term list</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  nsCOMArray&lt;nsIMsgFilterCustomAction&gt;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+      mCustomActions;  // defined custom action list</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  nsCOMArray&lt;nsIMsgSearchCustomTerm&gt; mCustomTerms;  // defined custom term list</span>
<a href="#l13.51"></a><span id="l13.51"> };</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53"> #endif  // _nsMsgFilterService_H_</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -9,988 +9,976 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsMsgSearchTerm.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsMsgSearchImap.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;prmem.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsIArray.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> // Implementation of search for IMAP mail folders</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-nsMsgSearchOnlineMail::nsMsgSearchOnlineMail (nsMsgSearchScopeTerm *scope, nsIArray *termList) : nsMsgSearchAdapter (scope, termList)</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-{</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-}</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+nsMsgSearchOnlineMail::nsMsgSearchOnlineMail(nsMsgSearchScopeTerm *scope,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+                                             nsIArray *termList)</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+    : nsMsgSearchAdapter(scope, termList) {}</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+nsMsgSearchOnlineMail::~nsMsgSearchOnlineMail() {}</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-nsMsgSearchOnlineMail::~nsMsgSearchOnlineMail ()</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-{</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-}</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+nsresult nsMsgSearchOnlineMail::ValidateTerms() {</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  nsresult err = nsMsgSearchAdapter::ValidateTerms();</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-nsresult nsMsgSearchOnlineMail::ValidateTerms ()</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-{</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  nsresult err = nsMsgSearchAdapter::ValidateTerms ();</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+    // ### mwelch Figure out the charsets to use</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    //            for the search terms and targets.</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    nsAutoString srcCharset, dstCharset;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+    GetSearchCharsets(srcCharset, dstCharset);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-  {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-      // ### mwelch Figure out the charsets to use</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-      //            for the search terms and targets.</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-      nsAutoString srcCharset, dstCharset;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-      GetSearchCharsets(srcCharset, dstCharset);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-      // do IMAP specific validation</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-      err = Encode (m_encoding, m_searchTerms, dstCharset.get());</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(err), &quot;failed to encode imap search&quot;);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+    // do IMAP specific validation</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    err = Encode(m_encoding, m_searchTerms, dstCharset.get());</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(err), &quot;failed to encode imap search&quot;);</span>
<a href="#l14.51"></a><span id="l14.51">   }</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53">   return err;</span>
<a href="#l14.54"></a><span id="l14.54"> }</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-NS_IMETHODIMP nsMsgSearchOnlineMail::GetEncoding (char **result)</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-{</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+NS_IMETHODIMP nsMsgSearchOnlineMail::GetEncoding(char **result) {</span>
<a href="#l14.60"></a><span id="l14.60">   *result = ToNewCString(m_encoding);</span>
<a href="#l14.61"></a><span id="l14.61">   return NS_OK;</span>
<a href="#l14.62"></a><span id="l14.62"> }</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-NS_IMETHODIMP nsMsgSearchOnlineMail::AddResultElement (nsIMsgDBHdr *pHeaders)</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-{</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-    nsresult err = NS_OK;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+NS_IMETHODIMP nsMsgSearchOnlineMail::AddResultElement(nsIMsgDBHdr *pHeaders) {</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-    m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-    if (searchSession)</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-    {</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-      err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-      searchSession-&gt;AddSearchHit(pHeaders, scopeFolder);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-    }</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-    //XXXX alecf do not checkin without fixing!        m_scope-&gt;m_searchSession-&gt;AddResultElement (newResult);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-    return err;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  if (searchSession) {</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+    err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+    searchSession-&gt;AddSearchHit(pHeaders, scopeFolder);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  }</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  // XXXX alecf do not checkin without fixing!</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  // m_scope-&gt;m_searchSession-&gt;AddResultElement (newResult);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  return err;</span>
<a href="#l14.90"></a><span id="l14.90"> }</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-nsresult nsMsgSearchOnlineMail::Search (bool *aDone)</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-{</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-    // we should never end up here for a purely online</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-    // folder.  We might for an offline IMAP folder.</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-    nsresult err = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+nsresult nsMsgSearchOnlineMail::Search(bool *aDone) {</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  // we should never end up here for a purely online</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+  // folder.  We might for an offline IMAP folder.</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  nsresult err = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l14.101"></a><span id="l14.101"> </span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-    return err;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  return err;</span>
<a href="#l14.104"></a><span id="l14.104"> }</span>
<a href="#l14.105"></a><span id="l14.105"> </span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-nsresult nsMsgSearchOnlineMail::Encode (nsCString&amp; pEncoding,</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-                                        nsIArray *searchTerms,</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-                                        const char16_t *destCharset)</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-{</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+nsresult nsMsgSearchOnlineMail::Encode(nsCString &amp;pEncoding,</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+                                       nsIArray *searchTerms,</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+                                       const char16_t *destCharset) {</span>
<a href="#l14.113"></a><span id="l14.113">   nsCString imapTerms;</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-  //check if searchTerms are ascii only</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  // check if searchTerms are ascii only</span>
<a href="#l14.117"></a><span id="l14.117">   bool asciiOnly = true;</span>
<a href="#l14.118"></a><span id="l14.118">   // ### what's this mean in the NWO?????</span>
<a href="#l14.119"></a><span id="l14.119"> </span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-  if (true) // !(srcCharset &amp; CODESET_MASK == STATEFUL || srcCharset &amp; CODESET_MASK == WIDECHAR) )   //assume all single/multiple bytes charset has ascii as subset</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+  if (true)  // !(srcCharset &amp; CODESET_MASK == STATEFUL || srcCharset &amp;</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+             // CODESET_MASK == WIDECHAR) )</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+             // assume all single/multiple bytes charset has ascii as subset</span>
<a href="#l14.124"></a><span id="l14.124">   {</span>
<a href="#l14.125"></a><span id="l14.125">     uint32_t termCount;</span>
<a href="#l14.126"></a><span id="l14.126">     searchTerms-&gt;GetLength(&amp;termCount);</span>
<a href="#l14.127"></a><span id="l14.127">     uint32_t i = 0;</span>
<a href="#l14.128"></a><span id="l14.128"> </span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-    for (i = 0; i &lt; termCount &amp;&amp; asciiOnly; i++)</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-    {</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    for (i = 0; i &lt; termCount &amp;&amp; asciiOnly; i++) {</span>
<a href="#l14.132"></a><span id="l14.132">       nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm = do_QueryElementAt(searchTerms, i);</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134">       nsMsgSearchAttribValue attribute;</span>
<a href="#l14.135"></a><span id="l14.135">       pTerm-&gt;GetAttrib(&amp;attribute);</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-      if (IS_STRING_ATTRIBUTE(attribute))</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-      {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+      if (IS_STRING_ATTRIBUTE(attribute)) {</span>
<a href="#l14.139"></a><span id="l14.139">         nsString pchar;</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-        nsCOMPtr &lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+        nsCOMPtr&lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l14.142"></a><span id="l14.142"> </span>
<a href="#l14.143"></a><span id="l14.143">         nsresult rv = pTerm-&gt;GetValue(getter_AddRefs(searchValue));</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-        if (NS_FAILED(rv) || !searchValue)</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-          continue;</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+        if (NS_FAILED(rv) || !searchValue) continue;</span>
<a href="#l14.148"></a><span id="l14.148"> </span>
<a href="#l14.149"></a><span id="l14.149">         rv = searchValue-&gt;GetStr(pchar);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-        if (NS_FAILED(rv) || pchar.IsEmpty())</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-          continue;</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-        asciiOnly = mozilla::IsAsciiNullTerminated(static_cast&lt;const char16_t*&gt;(pchar.get()));</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+        if (NS_FAILED(rv) || pchar.IsEmpty()) continue;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+        asciiOnly = mozilla::IsAsciiNullTerminated(</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+            static_cast&lt;const char16_t *&gt;(pchar.get()));</span>
<a href="#l14.156"></a><span id="l14.156">       }</span>
<a href="#l14.157"></a><span id="l14.157">     }</span>
<a href="#l14.158"></a><span id="l14.158">   }</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-//  else</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-//    asciiOnly = false; // TODO: enable this line when the condition is not a plain &quot;true&quot; in the if().</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+  //  else</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+  //    asciiOnly = false; // TODO: enable this line when the condition is not a</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+  //    plain &quot;true&quot; in the if().</span>
<a href="#l14.164"></a><span id="l14.164"> </span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-  const char16_t* usAsciiCharSet = u&quot;us-ascii&quot;;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+  const char16_t *usAsciiCharSet = u&quot;us-ascii&quot;;</span>
<a href="#l14.167"></a><span id="l14.167">   // Get the optional CHARSET parameter, in case we need it.</span>
<a href="#l14.168"></a><span id="l14.168">   char *csname = GetImapCharsetParam(asciiOnly ? usAsciiCharSet : destCharset);</span>
<a href="#l14.169"></a><span id="l14.169"> </span>
<a href="#l14.170"></a><span id="l14.170">   // We do not need &quot;srcCharset&quot; since the search term in always unicode.</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-  // I just pass destCharset for both src and dest charset instead of removing srcCharst from the arguemnt.</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-  nsresult err = nsMsgSearchAdapter::EncodeImap (getter_Copies(imapTerms), searchTerms,</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-                                                 asciiOnly ? usAsciiCharSet : destCharset,</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-                                                 asciiOnly ? usAsciiCharSet : destCharset, false);</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-  {</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+  // I just pass destCharset for both src and dest charset instead of removing</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+  // srcCharst from the arguemnt.</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+  nsresult err = nsMsgSearchAdapter::EncodeImap(</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+      getter_Copies(imapTerms), searchTerms,</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+      asciiOnly ? usAsciiCharSet : destCharset,</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+      asciiOnly ? usAsciiCharSet : destCharset, false);</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l14.184"></a><span id="l14.184">     pEncoding.AppendLiteral(&quot;SEARCH&quot;);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-    if (csname)</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-      pEncoding.Append(csname);</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+    if (csname) pEncoding.Append(csname);</span>
<a href="#l14.188"></a><span id="l14.188">     pEncoding.Append(imapTerms);</span>
<a href="#l14.189"></a><span id="l14.189">   }</span>
<a href="#l14.190"></a><span id="l14.190">   PR_FREEIF(csname);</span>
<a href="#l14.191"></a><span id="l14.191">   return err;</span>
<a href="#l14.192"></a><span id="l14.192"> }</span>
<a href="#l14.193"></a><span id="l14.193"> </span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+// clang-format off</span>
<a href="#l14.196"></a><span id="l14.196"> nsresult</span>
<a href="#l14.197"></a><span id="l14.197"> nsMsgSearchValidityManager::InitOfflineMailTable()</span>
<a href="#l14.198"></a><span id="l14.198"> {</span>
<a href="#l14.199"></a><span id="l14.199">   NS_ASSERTION(!m_offlineMailTable, &quot;offline mail table already initted&quot;);</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-  nsresult rv = NewTable (getter_AddRefs(m_offlineMailTable));</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  nsresult rv = NewTable(getter_AddRefs(m_offlineMailTable));</span>
<a href="#l14.202"></a><span id="l14.202">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.203"></a><span id="l14.203"> </span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.228"></a><span id="l14.228"> </span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.237"></a><span id="l14.237"> </span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.270"></a><span id="l14.270"> </span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.303"></a><span id="l14.303"> </span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.369"></a><span id="l14.369"> </span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.394"></a><span id="l14.394"> </span>
<a href="#l14.395"></a><span id="l14.395" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.411"></a><span id="l14.411"> </span>
<a href="#l14.412"></a><span id="l14.412" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.428"></a><span id="l14.428"> </span>
<a href="#l14.429"></a><span id="l14.429" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.445"></a><span id="l14.445"> </span>
<a href="#l14.446"></a><span id="l14.446" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.454"></a><span id="l14.454"> </span>
<a href="#l14.455"></a><span id="l14.455" class="difflineminus">-  //      m_offlineMailTable-&gt;SetValidButNotShown (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineminus">-  //      m_offlineMailTable-&gt;SetValidButNotShown (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLowerThan,  1);</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineplus">+  // m_offlineMailTable-&gt;SetValidButNotShown (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineplus">+  // m_offlineMailTable-&gt;SetValidButNotShown (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLowerThan,  1);</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.471"></a><span id="l14.471"> </span>
<a href="#l14.472"></a><span id="l14.472" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.488"></a><span id="l14.488"> </span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.501"></a><span id="l14.501"> </span>
<a href="#l14.502"></a><span id="l14.502" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.510"></a><span id="l14.510"> </span>
<a href="#l14.511"></a><span id="l14.511" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.519"></a><span id="l14.519"> </span>
<a href="#l14.520"></a><span id="l14.520" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.532"></a><span id="l14.532"> </span>
<a href="#l14.533"></a><span id="l14.533" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.539"></a><span id="l14.539" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.540"></a><span id="l14.540" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.541"></a><span id="l14.541" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.542"></a><span id="l14.542" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.543"></a><span id="l14.543" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.548"></a><span id="l14.548" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.549"></a><span id="l14.549" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.553"></a><span id="l14.553" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.557"></a><span id="l14.557"> </span>
<a href="#l14.558"></a><span id="l14.558" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.562"></a><span id="l14.562" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.563"></a><span id="l14.563" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.566"></a><span id="l14.566" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.567"></a><span id="l14.567" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineminus">-  m_offlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineminus">-  m_offlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+  m_offlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.581"></a><span id="l14.581" class="difflineplus">+  m_offlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.582"></a><span id="l14.582">   return rv;</span>
<a href="#l14.583"></a><span id="l14.583"> }</span>
<a href="#l14.584"></a><span id="l14.584"> </span>
<a href="#l14.585"></a><span id="l14.585"> </span>
<a href="#l14.586"></a><span id="l14.586"> nsresult</span>
<a href="#l14.587"></a><span id="l14.587"> nsMsgSearchValidityManager::InitOnlineMailTable()</span>
<a href="#l14.588"></a><span id="l14.588"> {</span>
<a href="#l14.589"></a><span id="l14.589">   NS_ASSERTION(!m_onlineMailTable, &quot;Online mail table already initted!&quot;);</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineminus">-  nsresult rv = NewTable (getter_AddRefs(m_onlineMailTable));</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineplus">+  nsresult rv = NewTable(getter_AddRefs(m_onlineMailTable));</span>
<a href="#l14.592"></a><span id="l14.592">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.593"></a><span id="l14.593"> </span>
<a href="#l14.594"></a><span id="l14.594" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.595"></a><span id="l14.595" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.602"></a><span id="l14.602"> </span>
<a href="#l14.603"></a><span id="l14.603" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.611"></a><span id="l14.611"> </span>
<a href="#l14.612"></a><span id="l14.612" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.620"></a><span id="l14.620"> </span>
<a href="#l14.621"></a><span id="l14.621" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.623"></a><span id="l14.623" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.628"></a><span id="l14.628" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.629"></a><span id="l14.629"> </span>
<a href="#l14.630"></a><span id="l14.630" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.632"></a><span id="l14.632" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.638"></a><span id="l14.638"> </span>
<a href="#l14.639"></a><span id="l14.639" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.640"></a><span id="l14.640" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.641"></a><span id="l14.641" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.647"></a><span id="l14.647"> </span>
<a href="#l14.648"></a><span id="l14.648" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.660"></a><span id="l14.660" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.661"></a><span id="l14.661" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.664"></a><span id="l14.664"> </span>
<a href="#l14.665"></a><span id="l14.665" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.669"></a><span id="l14.669" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.673"></a><span id="l14.673"> </span>
<a href="#l14.674"></a><span id="l14.674" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.675"></a><span id="l14.675" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.676"></a><span id="l14.676" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.677"></a><span id="l14.677" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.678"></a><span id="l14.678" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.682"></a><span id="l14.682" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.683"></a><span id="l14.683" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.686"></a><span id="l14.686"> </span>
<a href="#l14.687"></a><span id="l14.687" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.695"></a><span id="l14.695"> </span>
<a href="#l14.696"></a><span id="l14.696" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.697"></a><span id="l14.697" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.704"></a><span id="l14.704"> </span>
<a href="#l14.705"></a><span id="l14.705" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.707"></a><span id="l14.707" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineminus">-  m_onlineMailTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineminus">-  m_onlineMailTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.713"></a><span id="l14.713" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.714"></a><span id="l14.714" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.715"></a><span id="l14.715" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.718"></a><span id="l14.718" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.719"></a><span id="l14.719" class="difflineplus">+  m_onlineMailTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.720"></a><span id="l14.720" class="difflineplus">+  m_onlineMailTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.721"></a><span id="l14.721"> </span>
<a href="#l14.722"></a><span id="l14.722">   return rv;</span>
<a href="#l14.723"></a><span id="l14.723"> }</span>
<a href="#l14.724"></a><span id="l14.724"> </span>
<a href="#l14.725"></a><span id="l14.725"> nsresult</span>
<a href="#l14.726"></a><span id="l14.726"> nsMsgSearchValidityManager::InitOnlineMailFilterTable()</span>
<a href="#l14.727"></a><span id="l14.727"> {</span>
<a href="#l14.728"></a><span id="l14.728">   // Oh what a tangled web...</span>
<a href="#l14.729"></a><span id="l14.729">   //</span>
<a href="#l14.730"></a><span id="l14.730">   // IMAP filtering happens on the client, fundamentally using the same</span>
<a href="#l14.731"></a><span id="l14.731">   // capabilities as POP filtering. However, since we don't yet have the</span>
<a href="#l14.732"></a><span id="l14.732">   // IMAP message body, we can't filter on body attributes. So this table</span>
<a href="#l14.733"></a><span id="l14.733">   // is supposed to be the same as offline mail, except that the body</span>
<a href="#l14.734"></a><span id="l14.734">   // attribute is omitted</span>
<a href="#l14.735"></a><span id="l14.735">   NS_ASSERTION(!m_onlineMailFilterTable, &quot;online filter table already initted&quot;);</span>
<a href="#l14.736"></a><span id="l14.736" class="difflineminus">-  nsresult rv = NewTable (getter_AddRefs(m_onlineMailFilterTable));</span>
<a href="#l14.737"></a><span id="l14.737" class="difflineplus">+  nsresult rv = NewTable(getter_AddRefs(m_onlineMailFilterTable));</span>
<a href="#l14.738"></a><span id="l14.738">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.739"></a><span id="l14.739"> </span>
<a href="#l14.740"></a><span id="l14.740" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.745"></a><span id="l14.745" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.746"></a><span id="l14.746" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.747"></a><span id="l14.747" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.748"></a><span id="l14.748" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.749"></a><span id="l14.749" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.750"></a><span id="l14.750" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.751"></a><span id="l14.751" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.753"></a><span id="l14.753" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.754"></a><span id="l14.754" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.755"></a><span id="l14.755" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.756"></a><span id="l14.756" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.757"></a><span id="l14.757" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.758"></a><span id="l14.758" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.759"></a><span id="l14.759" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.760"></a><span id="l14.760" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.761"></a><span id="l14.761" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.762"></a><span id="l14.762" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.763"></a><span id="l14.763" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.764"></a><span id="l14.764"> </span>
<a href="#l14.765"></a><span id="l14.765" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.766"></a><span id="l14.766" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.767"></a><span id="l14.767" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.768"></a><span id="l14.768" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.769"></a><span id="l14.769" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.770"></a><span id="l14.770" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.771"></a><span id="l14.771" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.772"></a><span id="l14.772" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.773"></a><span id="l14.773"> </span>
<a href="#l14.774"></a><span id="l14.774" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.775"></a><span id="l14.775" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.776"></a><span id="l14.776" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.777"></a><span id="l14.777" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.778"></a><span id="l14.778" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.779"></a><span id="l14.779" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.780"></a><span id="l14.780" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.781"></a><span id="l14.781" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.782"></a><span id="l14.782" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.783"></a><span id="l14.783" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.784"></a><span id="l14.784" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.785"></a><span id="l14.785" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.786"></a><span id="l14.786" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.787"></a><span id="l14.787" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.788"></a><span id="l14.788" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.789"></a><span id="l14.789" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.790"></a><span id="l14.790" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.791"></a><span id="l14.791" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.792"></a><span id="l14.792" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.793"></a><span id="l14.793" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.794"></a><span id="l14.794" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.795"></a><span id="l14.795" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.796"></a><span id="l14.796" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.797"></a><span id="l14.797" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.798"></a><span id="l14.798" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.799"></a><span id="l14.799" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.800"></a><span id="l14.800" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.801"></a><span id="l14.801" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.802"></a><span id="l14.802" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.803"></a><span id="l14.803" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.804"></a><span id="l14.804" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.805"></a><span id="l14.805" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.806"></a><span id="l14.806"> </span>
<a href="#l14.807"></a><span id="l14.807" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.808"></a><span id="l14.808" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.809"></a><span id="l14.809" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.810"></a><span id="l14.810" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.811"></a><span id="l14.811" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.812"></a><span id="l14.812" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.813"></a><span id="l14.813" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.814"></a><span id="l14.814" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.815"></a><span id="l14.815" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.816"></a><span id="l14.816" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.817"></a><span id="l14.817" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.818"></a><span id="l14.818" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.819"></a><span id="l14.819" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.820"></a><span id="l14.820" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.821"></a><span id="l14.821" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.822"></a><span id="l14.822" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.823"></a><span id="l14.823" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.824"></a><span id="l14.824" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.826"></a><span id="l14.826" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.827"></a><span id="l14.827" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.828"></a><span id="l14.828" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.829"></a><span id="l14.829" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.830"></a><span id="l14.830" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.831"></a><span id="l14.831" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.832"></a><span id="l14.832" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.833"></a><span id="l14.833" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.835"></a><span id="l14.835" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.836"></a><span id="l14.836" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.837"></a><span id="l14.837" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.838"></a><span id="l14.838" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.839"></a><span id="l14.839"> </span>
<a href="#l14.840"></a><span id="l14.840" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.841"></a><span id="l14.841" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.842"></a><span id="l14.842" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.843"></a><span id="l14.843" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.844"></a><span id="l14.844" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.845"></a><span id="l14.845" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.846"></a><span id="l14.846" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.847"></a><span id="l14.847" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.848"></a><span id="l14.848" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.850"></a><span id="l14.850" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.851"></a><span id="l14.851" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.852"></a><span id="l14.852" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.853"></a><span id="l14.853" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.854"></a><span id="l14.854" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.855"></a><span id="l14.855" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.856"></a><span id="l14.856" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.857"></a><span id="l14.857" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.858"></a><span id="l14.858" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.859"></a><span id="l14.859" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.860"></a><span id="l14.860" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.861"></a><span id="l14.861" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.862"></a><span id="l14.862" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.863"></a><span id="l14.863" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.865"></a><span id="l14.865" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.866"></a><span id="l14.866" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.868"></a><span id="l14.868" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.869"></a><span id="l14.869" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.870"></a><span id="l14.870" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.871"></a><span id="l14.871" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.872"></a><span id="l14.872"> </span>
<a href="#l14.873"></a><span id="l14.873" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.874"></a><span id="l14.874" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.875"></a><span id="l14.875" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.876"></a><span id="l14.876" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.877"></a><span id="l14.877" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.878"></a><span id="l14.878" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.879"></a><span id="l14.879" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.880"></a><span id="l14.880" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.881"></a><span id="l14.881" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.882"></a><span id="l14.882" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.883"></a><span id="l14.883" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.884"></a><span id="l14.884" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.885"></a><span id="l14.885" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.886"></a><span id="l14.886" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.887"></a><span id="l14.887" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.888"></a><span id="l14.888" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.889"></a><span id="l14.889" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.890"></a><span id="l14.890" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.891"></a><span id="l14.891" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.892"></a><span id="l14.892" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.893"></a><span id="l14.893" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.894"></a><span id="l14.894" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.895"></a><span id="l14.895" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.896"></a><span id="l14.896" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.897"></a><span id="l14.897" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.898"></a><span id="l14.898" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.899"></a><span id="l14.899" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.900"></a><span id="l14.900" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.901"></a><span id="l14.901" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.903"></a><span id="l14.903" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.904"></a><span id="l14.904" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.905"></a><span id="l14.905"> </span>
<a href="#l14.906"></a><span id="l14.906" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.907"></a><span id="l14.907" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.908"></a><span id="l14.908" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.909"></a><span id="l14.909" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.910"></a><span id="l14.910" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.911"></a><span id="l14.911" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.912"></a><span id="l14.912" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.913"></a><span id="l14.913" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.914"></a><span id="l14.914" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.915"></a><span id="l14.915" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.916"></a><span id="l14.916" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.917"></a><span id="l14.917" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.918"></a><span id="l14.918" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.919"></a><span id="l14.919" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.920"></a><span id="l14.920" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.921"></a><span id="l14.921" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.922"></a><span id="l14.922" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.923"></a><span id="l14.923" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.924"></a><span id="l14.924" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.925"></a><span id="l14.925" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.926"></a><span id="l14.926" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.927"></a><span id="l14.927" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.928"></a><span id="l14.928" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.929"></a><span id="l14.929" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.930"></a><span id="l14.930"> </span>
<a href="#l14.931"></a><span id="l14.931" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.932"></a><span id="l14.932" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.933"></a><span id="l14.933" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.934"></a><span id="l14.934" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.935"></a><span id="l14.935" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.936"></a><span id="l14.936" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.937"></a><span id="l14.937" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.938"></a><span id="l14.938" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.939"></a><span id="l14.939" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.940"></a><span id="l14.940" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.941"></a><span id="l14.941" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.942"></a><span id="l14.942" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.943"></a><span id="l14.943" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.944"></a><span id="l14.944" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.945"></a><span id="l14.945" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.946"></a><span id="l14.946" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.947"></a><span id="l14.947"> </span>
<a href="#l14.948"></a><span id="l14.948" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.949"></a><span id="l14.949" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.950"></a><span id="l14.950" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.951"></a><span id="l14.951" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.952"></a><span id="l14.952" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.953"></a><span id="l14.953" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.954"></a><span id="l14.954" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.955"></a><span id="l14.955" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.956"></a><span id="l14.956" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.957"></a><span id="l14.957" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.958"></a><span id="l14.958" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.959"></a><span id="l14.959" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.960"></a><span id="l14.960" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.961"></a><span id="l14.961" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.962"></a><span id="l14.962" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.963"></a><span id="l14.963" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.964"></a><span id="l14.964"> </span>
<a href="#l14.965"></a><span id="l14.965" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.966"></a><span id="l14.966" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.967"></a><span id="l14.967" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.968"></a><span id="l14.968" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.969"></a><span id="l14.969" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.970"></a><span id="l14.970" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.971"></a><span id="l14.971" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.972"></a><span id="l14.972" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.973"></a><span id="l14.973"> </span>
<a href="#l14.974"></a><span id="l14.974" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.975"></a><span id="l14.975" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.976"></a><span id="l14.976" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.977"></a><span id="l14.977" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.978"></a><span id="l14.978" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.979"></a><span id="l14.979" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.980"></a><span id="l14.980" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.981"></a><span id="l14.981" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.982"></a><span id="l14.982" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.983"></a><span id="l14.983" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.984"></a><span id="l14.984" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.985"></a><span id="l14.985" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.986"></a><span id="l14.986"> </span>
<a href="#l14.987"></a><span id="l14.987" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.988"></a><span id="l14.988" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.989"></a><span id="l14.989" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.990"></a><span id="l14.990" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.991"></a><span id="l14.991" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.992"></a><span id="l14.992" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.993"></a><span id="l14.993" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.994"></a><span id="l14.994" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.995"></a><span id="l14.995"> </span>
<a href="#l14.996"></a><span id="l14.996" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.997"></a><span id="l14.997" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.998"></a><span id="l14.998" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.999"></a><span id="l14.999" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1000"></a><span id="l14.1000" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1001"></a><span id="l14.1001" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1002"></a><span id="l14.1002" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1003"></a><span id="l14.1003" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1004"></a><span id="l14.1004" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1005"></a><span id="l14.1005" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1006"></a><span id="l14.1006" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1007"></a><span id="l14.1007" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1008"></a><span id="l14.1008" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1009"></a><span id="l14.1009" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1010"></a><span id="l14.1010" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1011"></a><span id="l14.1011" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1012"></a><span id="l14.1012" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1013"></a><span id="l14.1013" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1014"></a><span id="l14.1014" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1015"></a><span id="l14.1015" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1016"></a><span id="l14.1016" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1017"></a><span id="l14.1017" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1018"></a><span id="l14.1018" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1019"></a><span id="l14.1019" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1020"></a><span id="l14.1020"> </span>
<a href="#l14.1021"></a><span id="l14.1021" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1022"></a><span id="l14.1022" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1023"></a><span id="l14.1023" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1024"></a><span id="l14.1024" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1025"></a><span id="l14.1025" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1026"></a><span id="l14.1026" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1027"></a><span id="l14.1027" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1028"></a><span id="l14.1028" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1029"></a><span id="l14.1029" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1030"></a><span id="l14.1030" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1031"></a><span id="l14.1031" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1032"></a><span id="l14.1032" class="difflineminus">-  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1033"></a><span id="l14.1033" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1034"></a><span id="l14.1034" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1035"></a><span id="l14.1035" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1036"></a><span id="l14.1036" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1037"></a><span id="l14.1037" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1038"></a><span id="l14.1038" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1039"></a><span id="l14.1039" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1040"></a><span id="l14.1040" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1041"></a><span id="l14.1041" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1042"></a><span id="l14.1042" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1043"></a><span id="l14.1043" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1044"></a><span id="l14.1044" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1045"></a><span id="l14.1045"> </span>
<a href="#l14.1046"></a><span id="l14.1046">   return rv;</span>
<a href="#l14.1047"></a><span id="l14.1047"> }</span>
<a href="#l14.1048"></a><span id="l14.1048"> </span>
<a href="#l14.1049"></a><span id="l14.1049"> nsresult</span>
<a href="#l14.1050"></a><span id="l14.1050"> nsMsgSearchValidityManager::InitOfflineMailFilterTable()</span>
<a href="#l14.1051"></a><span id="l14.1051"> {</span>
<a href="#l14.1052"></a><span id="l14.1052">   NS_ASSERTION(!m_offlineMailFilterTable, &quot;offline mail filter table already initted&quot;);</span>
<a href="#l14.1053"></a><span id="l14.1053" class="difflineminus">-  nsresult rv = NewTable (getter_AddRefs(m_offlineMailFilterTable));</span>
<a href="#l14.1054"></a><span id="l14.1054" class="difflineplus">+  nsresult rv = NewTable(getter_AddRefs(m_offlineMailFilterTable));</span>
<a href="#l14.1055"></a><span id="l14.1055">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.1056"></a><span id="l14.1056"> </span>
<a href="#l14.1057"></a><span id="l14.1057" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1058"></a><span id="l14.1058" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1059"></a><span id="l14.1059" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1060"></a><span id="l14.1060" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1061"></a><span id="l14.1061" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1062"></a><span id="l14.1062" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1063"></a><span id="l14.1063" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1064"></a><span id="l14.1064" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1065"></a><span id="l14.1065" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1066"></a><span id="l14.1066" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1067"></a><span id="l14.1067" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1068"></a><span id="l14.1068" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1069"></a><span id="l14.1069" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1070"></a><span id="l14.1070" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1071"></a><span id="l14.1071" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1072"></a><span id="l14.1072" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1073"></a><span id="l14.1073" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1074"></a><span id="l14.1074" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1075"></a><span id="l14.1075" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1076"></a><span id="l14.1076" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1077"></a><span id="l14.1077" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1078"></a><span id="l14.1078" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1079"></a><span id="l14.1079" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1080"></a><span id="l14.1080" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1081"></a><span id="l14.1081"> </span>
<a href="#l14.1082"></a><span id="l14.1082" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1083"></a><span id="l14.1083" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1084"></a><span id="l14.1084" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1085"></a><span id="l14.1085" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1086"></a><span id="l14.1086" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1087"></a><span id="l14.1087" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1088"></a><span id="l14.1088" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1089"></a><span id="l14.1089" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1090"></a><span id="l14.1090"> </span>
<a href="#l14.1091"></a><span id="l14.1091" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1092"></a><span id="l14.1092" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1093"></a><span id="l14.1093" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1094"></a><span id="l14.1094" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1095"></a><span id="l14.1095" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1096"></a><span id="l14.1096" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1097"></a><span id="l14.1097" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1098"></a><span id="l14.1098" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1099"></a><span id="l14.1099" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1100"></a><span id="l14.1100" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1101"></a><span id="l14.1101" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1102"></a><span id="l14.1102" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1103"></a><span id="l14.1103" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1104"></a><span id="l14.1104" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1105"></a><span id="l14.1105" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1106"></a><span id="l14.1106" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1107"></a><span id="l14.1107" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1108"></a><span id="l14.1108" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1109"></a><span id="l14.1109" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1110"></a><span id="l14.1110" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1111"></a><span id="l14.1111" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1112"></a><span id="l14.1112" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1113"></a><span id="l14.1113" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1114"></a><span id="l14.1114" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1115"></a><span id="l14.1115" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1116"></a><span id="l14.1116" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1117"></a><span id="l14.1117" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1118"></a><span id="l14.1118" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1119"></a><span id="l14.1119" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1120"></a><span id="l14.1120" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1121"></a><span id="l14.1121" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1122"></a><span id="l14.1122" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1123"></a><span id="l14.1123"> </span>
<a href="#l14.1124"></a><span id="l14.1124" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1125"></a><span id="l14.1125" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1126"></a><span id="l14.1126" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1127"></a><span id="l14.1127" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1128"></a><span id="l14.1128" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1129"></a><span id="l14.1129" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1130"></a><span id="l14.1130" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1131"></a><span id="l14.1131" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1132"></a><span id="l14.1132" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1133"></a><span id="l14.1133" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1134"></a><span id="l14.1134" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1135"></a><span id="l14.1135" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1136"></a><span id="l14.1136" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1137"></a><span id="l14.1137" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1138"></a><span id="l14.1138" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1139"></a><span id="l14.1139" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1140"></a><span id="l14.1140" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1141"></a><span id="l14.1141" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1142"></a><span id="l14.1142" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1143"></a><span id="l14.1143" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1144"></a><span id="l14.1144" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1145"></a><span id="l14.1145" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1146"></a><span id="l14.1146" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1147"></a><span id="l14.1147" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1148"></a><span id="l14.1148" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1149"></a><span id="l14.1149" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1150"></a><span id="l14.1150" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1151"></a><span id="l14.1151" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1152"></a><span id="l14.1152" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1153"></a><span id="l14.1153" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1154"></a><span id="l14.1154" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1155"></a><span id="l14.1155" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1156"></a><span id="l14.1156"> </span>
<a href="#l14.1157"></a><span id="l14.1157" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1158"></a><span id="l14.1158" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1159"></a><span id="l14.1159" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1160"></a><span id="l14.1160" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1161"></a><span id="l14.1161" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1162"></a><span id="l14.1162" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1163"></a><span id="l14.1163" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1164"></a><span id="l14.1164" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1165"></a><span id="l14.1165" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1166"></a><span id="l14.1166" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1167"></a><span id="l14.1167" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1168"></a><span id="l14.1168" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1169"></a><span id="l14.1169" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1170"></a><span id="l14.1170" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1171"></a><span id="l14.1171" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1172"></a><span id="l14.1172" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1173"></a><span id="l14.1173" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1174"></a><span id="l14.1174" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1175"></a><span id="l14.1175" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1176"></a><span id="l14.1176" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1177"></a><span id="l14.1177" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1178"></a><span id="l14.1178" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1179"></a><span id="l14.1179" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1180"></a><span id="l14.1180" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1181"></a><span id="l14.1181" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1182"></a><span id="l14.1182" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1183"></a><span id="l14.1183" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1184"></a><span id="l14.1184" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1185"></a><span id="l14.1185" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1186"></a><span id="l14.1186" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1187"></a><span id="l14.1187" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1188"></a><span id="l14.1188" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1189"></a><span id="l14.1189"> </span>
<a href="#l14.1190"></a><span id="l14.1190" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1191"></a><span id="l14.1191" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1192"></a><span id="l14.1192" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1193"></a><span id="l14.1193" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1194"></a><span id="l14.1194" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1195"></a><span id="l14.1195" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1196"></a><span id="l14.1196" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1197"></a><span id="l14.1197" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1198"></a><span id="l14.1198" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1199"></a><span id="l14.1199" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1200"></a><span id="l14.1200" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1201"></a><span id="l14.1201" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1202"></a><span id="l14.1202" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1203"></a><span id="l14.1203" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1204"></a><span id="l14.1204" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1205"></a><span id="l14.1205" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1206"></a><span id="l14.1206" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1207"></a><span id="l14.1207" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1208"></a><span id="l14.1208" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1209"></a><span id="l14.1209" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1210"></a><span id="l14.1210" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1211"></a><span id="l14.1211" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1212"></a><span id="l14.1212" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1213"></a><span id="l14.1213" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1214"></a><span id="l14.1214" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1215"></a><span id="l14.1215" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1216"></a><span id="l14.1216" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1217"></a><span id="l14.1217" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1218"></a><span id="l14.1218" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1219"></a><span id="l14.1219" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1220"></a><span id="l14.1220" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1221"></a><span id="l14.1221" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1222"></a><span id="l14.1222"> </span>
<a href="#l14.1223"></a><span id="l14.1223" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1224"></a><span id="l14.1224" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1225"></a><span id="l14.1225" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1226"></a><span id="l14.1226" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1227"></a><span id="l14.1227" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1228"></a><span id="l14.1228" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1229"></a><span id="l14.1229" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1230"></a><span id="l14.1230" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1231"></a><span id="l14.1231" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1232"></a><span id="l14.1232" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1233"></a><span id="l14.1233" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1234"></a><span id="l14.1234" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1235"></a><span id="l14.1235" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1236"></a><span id="l14.1236" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1237"></a><span id="l14.1237" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1238"></a><span id="l14.1238" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1239"></a><span id="l14.1239" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1240"></a><span id="l14.1240" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1241"></a><span id="l14.1241" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1242"></a><span id="l14.1242" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1243"></a><span id="l14.1243" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1244"></a><span id="l14.1244" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1245"></a><span id="l14.1245" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1246"></a><span id="l14.1246" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1247"></a><span id="l14.1247"> </span>
<a href="#l14.1248"></a><span id="l14.1248" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1249"></a><span id="l14.1249" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1250"></a><span id="l14.1250" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1251"></a><span id="l14.1251" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1252"></a><span id="l14.1252" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1253"></a><span id="l14.1253" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1254"></a><span id="l14.1254" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1255"></a><span id="l14.1255" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1256"></a><span id="l14.1256" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1257"></a><span id="l14.1257" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1258"></a><span id="l14.1258" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1259"></a><span id="l14.1259" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1260"></a><span id="l14.1260" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1261"></a><span id="l14.1261" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1262"></a><span id="l14.1262" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1263"></a><span id="l14.1263" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1264"></a><span id="l14.1264"> </span>
<a href="#l14.1265"></a><span id="l14.1265" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1266"></a><span id="l14.1266" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1267"></a><span id="l14.1267" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1268"></a><span id="l14.1268" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1269"></a><span id="l14.1269" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1270"></a><span id="l14.1270" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1271"></a><span id="l14.1271" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1272"></a><span id="l14.1272" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1273"></a><span id="l14.1273" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1274"></a><span id="l14.1274" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1275"></a><span id="l14.1275" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1276"></a><span id="l14.1276" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1277"></a><span id="l14.1277" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1278"></a><span id="l14.1278" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1279"></a><span id="l14.1279" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1280"></a><span id="l14.1280" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1281"></a><span id="l14.1281"> </span>
<a href="#l14.1282"></a><span id="l14.1282" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1283"></a><span id="l14.1283" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1284"></a><span id="l14.1284" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1285"></a><span id="l14.1285" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1286"></a><span id="l14.1286" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1287"></a><span id="l14.1287" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1288"></a><span id="l14.1288" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1289"></a><span id="l14.1289" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1290"></a><span id="l14.1290" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1291"></a><span id="l14.1291" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1292"></a><span id="l14.1292" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1293"></a><span id="l14.1293" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1294"></a><span id="l14.1294" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1295"></a><span id="l14.1295" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1296"></a><span id="l14.1296" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1297"></a><span id="l14.1297" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1298"></a><span id="l14.1298"> </span>
<a href="#l14.1299"></a><span id="l14.1299" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1300"></a><span id="l14.1300" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1301"></a><span id="l14.1301" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1302"></a><span id="l14.1302" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1303"></a><span id="l14.1303" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1304"></a><span id="l14.1304" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1305"></a><span id="l14.1305" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1306"></a><span id="l14.1306" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1307"></a><span id="l14.1307"> </span>
<a href="#l14.1308"></a><span id="l14.1308" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1309"></a><span id="l14.1309" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1310"></a><span id="l14.1310" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.1311"></a><span id="l14.1311" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1312"></a><span id="l14.1312" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l14.1313"></a><span id="l14.1313" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1314"></a><span id="l14.1314" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1315"></a><span id="l14.1315" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1316"></a><span id="l14.1316" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.1317"></a><span id="l14.1317" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1318"></a><span id="l14.1318" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l14.1319"></a><span id="l14.1319" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1320"></a><span id="l14.1320"> </span>
<a href="#l14.1321"></a><span id="l14.1321">   // junk status and attachment status not available for offline mail (POP) filters</span>
<a href="#l14.1322"></a><span id="l14.1322">   // because we won't know those until after the message has been analyzed.</span>
<a href="#l14.1323"></a><span id="l14.1323">   // see bug #185937</span>
<a href="#l14.1324"></a><span id="l14.1324" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1325"></a><span id="l14.1325" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1326"></a><span id="l14.1326" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1327"></a><span id="l14.1327" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1328"></a><span id="l14.1328" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1329"></a><span id="l14.1329" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1330"></a><span id="l14.1330" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1331"></a><span id="l14.1331" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1332"></a><span id="l14.1332" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1333"></a><span id="l14.1333" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1334"></a><span id="l14.1334" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1335"></a><span id="l14.1335" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1336"></a><span id="l14.1336"> </span>
<a href="#l14.1337"></a><span id="l14.1337" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1338"></a><span id="l14.1338" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1339"></a><span id="l14.1339" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1340"></a><span id="l14.1340" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1341"></a><span id="l14.1341" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1342"></a><span id="l14.1342" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1343"></a><span id="l14.1343" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1344"></a><span id="l14.1344" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1345"></a><span id="l14.1345" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1346"></a><span id="l14.1346" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1347"></a><span id="l14.1347" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1348"></a><span id="l14.1348" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1349"></a><span id="l14.1349" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1350"></a><span id="l14.1350" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1351"></a><span id="l14.1351" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1352"></a><span id="l14.1352" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1353"></a><span id="l14.1353" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1354"></a><span id="l14.1354" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1355"></a><span id="l14.1355" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1356"></a><span id="l14.1356" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1357"></a><span id="l14.1357" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1358"></a><span id="l14.1358" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1359"></a><span id="l14.1359" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1360"></a><span id="l14.1360" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1361"></a><span id="l14.1361"> </span>
<a href="#l14.1362"></a><span id="l14.1362" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1363"></a><span id="l14.1363" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1364"></a><span id="l14.1364" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1365"></a><span id="l14.1365" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1366"></a><span id="l14.1366" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1367"></a><span id="l14.1367" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1368"></a><span id="l14.1368" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1369"></a><span id="l14.1369" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1370"></a><span id="l14.1370" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1371"></a><span id="l14.1371" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1372"></a><span id="l14.1372" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1373"></a><span id="l14.1373" class="difflineminus">-  m_offlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1374"></a><span id="l14.1374" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1375"></a><span id="l14.1375" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1376"></a><span id="l14.1376" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1377"></a><span id="l14.1377" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1378"></a><span id="l14.1378" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1379"></a><span id="l14.1379" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1380"></a><span id="l14.1380" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1381"></a><span id="l14.1381" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1382"></a><span id="l14.1382" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1383"></a><span id="l14.1383" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1384"></a><span id="l14.1384" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1385"></a><span id="l14.1385" class="difflineplus">+  m_offlineMailFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1386"></a><span id="l14.1386"> </span>
<a href="#l14.1387"></a><span id="l14.1387">   return rv;</span>
<a href="#l14.1388"></a><span id="l14.1388"> }</span>
<a href="#l14.1389"></a><span id="l14.1389"> </span>
<a href="#l14.1390"></a><span id="l14.1390"> // Online Manual is used for IMAP and NEWS, where at manual</span>
<a href="#l14.1391"></a><span id="l14.1391"> // filtering we have junk info, but cannot assure that the</span>
<a href="#l14.1392"></a><span id="l14.1392"> // body is available.</span>
<a href="#l14.1393"></a><span id="l14.1393"> nsresult</span>
<a href="#l14.1394"></a><span id="l14.1394"> nsMsgSearchValidityManager::InitOnlineManualFilterTable()</span>
<a href="#l14.1395"></a><span id="l14.1395"> {</span>
<a href="#l14.1396"></a><span id="l14.1396">   NS_ASSERTION(!m_onlineManualFilterTable, &quot;online manual filter table already initted&quot;);</span>
<a href="#l14.1397"></a><span id="l14.1397">   nsresult rv = NewTable(getter_AddRefs(m_onlineManualFilterTable));</span>
<a href="#l14.1398"></a><span id="l14.1398">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.1399"></a><span id="l14.1399"> </span>
<a href="#l14.1400"></a><span id="l14.1400">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1401"></a><span id="l14.1401" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1402"></a><span id="l14.1402" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1403"></a><span id="l14.1403">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1404"></a><span id="l14.1404" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1405"></a><span id="l14.1405" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1406"></a><span id="l14.1406">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1407"></a><span id="l14.1407" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1408"></a><span id="l14.1408" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1409"></a><span id="l14.1409">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1410"></a><span id="l14.1410" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1411"></a><span id="l14.1411" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1412"></a><span id="l14.1412">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1413"></a><span id="l14.1413" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1414"></a><span id="l14.1414" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1415"></a><span id="l14.1415">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1416"></a><span id="l14.1416" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1417"></a><span id="l14.1417" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1418"></a><span id="l14.1418"> </span>
<a href="#l14.1419"></a><span id="l14.1419">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1420"></a><span id="l14.1420" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1421"></a><span id="l14.1421" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1422"></a><span id="l14.1422">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1423"></a><span id="l14.1423" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1424"></a><span id="l14.1424" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1425"></a><span id="l14.1425"> </span>
<a href="#l14.1426"></a><span id="l14.1426">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1427"></a><span id="l14.1427" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1428"></a><span id="l14.1428" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1429"></a><span id="l14.1429">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1430"></a><span id="l14.1430" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1431"></a><span id="l14.1431" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1432"></a><span id="l14.1432">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1433"></a><span id="l14.1433" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1434"></a><span id="l14.1434" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1435"></a><span id="l14.1435">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1436"></a><span id="l14.1436" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1437"></a><span id="l14.1437" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1438"></a><span id="l14.1438">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1439"></a><span id="l14.1439" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1440"></a><span id="l14.1440" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1441"></a><span id="l14.1441">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1442"></a><span id="l14.1442" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1443"></a><span id="l14.1443" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1444"></a><span id="l14.1444">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1445"></a><span id="l14.1445" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1446"></a><span id="l14.1446" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1447"></a><span id="l14.1447">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1448"></a><span id="l14.1448" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1449"></a><span id="l14.1449" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::To, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1450"></a><span id="l14.1450"> </span>
<a href="#l14.1451"></a><span id="l14.1451">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1452"></a><span id="l14.1452" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1453"></a><span id="l14.1453" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1454"></a><span id="l14.1454">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1455"></a><span id="l14.1455" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1456"></a><span id="l14.1456" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1457"></a><span id="l14.1457">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1458"></a><span id="l14.1458" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1459"></a><span id="l14.1459" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1460"></a><span id="l14.1460">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1461"></a><span id="l14.1461" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1462"></a><span id="l14.1462" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1463"></a><span id="l14.1463">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1464"></a><span id="l14.1464" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1465"></a><span id="l14.1465" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1466"></a><span id="l14.1466">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1467"></a><span id="l14.1467" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1468"></a><span id="l14.1468" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1469"></a><span id="l14.1469">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1470"></a><span id="l14.1470" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1471"></a><span id="l14.1471" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1472"></a><span id="l14.1472">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1473"></a><span id="l14.1473" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1474"></a><span id="l14.1474" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::CC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1475"></a><span id="l14.1475"> </span>
<a href="#l14.1476"></a><span id="l14.1476">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1477"></a><span id="l14.1477" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1478"></a><span id="l14.1478" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1479"></a><span id="l14.1479">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1480"></a><span id="l14.1480" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1481"></a><span id="l14.1481" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1482"></a><span id="l14.1482">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1483"></a><span id="l14.1483" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1484"></a><span id="l14.1484" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1485"></a><span id="l14.1485">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1486"></a><span id="l14.1486" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1487"></a><span id="l14.1487" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1488"></a><span id="l14.1488">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1489"></a><span id="l14.1489" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1490"></a><span id="l14.1490" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1491"></a><span id="l14.1491">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1492"></a><span id="l14.1492" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1493"></a><span id="l14.1493" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1494"></a><span id="l14.1494">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1495"></a><span id="l14.1495" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1496"></a><span id="l14.1496" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1497"></a><span id="l14.1497">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1498"></a><span id="l14.1498" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1499"></a><span id="l14.1499" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::ToOrCC, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1500"></a><span id="l14.1500"> </span>
<a href="#l14.1501"></a><span id="l14.1501">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1502"></a><span id="l14.1502" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1503"></a><span id="l14.1503" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1504"></a><span id="l14.1504">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1505"></a><span id="l14.1505" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1506"></a><span id="l14.1506" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1507"></a><span id="l14.1507">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1508"></a><span id="l14.1508" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1509"></a><span id="l14.1509" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1510"></a><span id="l14.1510">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1511"></a><span id="l14.1511" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1512"></a><span id="l14.1512" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1513"></a><span id="l14.1513">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1514"></a><span id="l14.1514" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1515"></a><span id="l14.1515" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1516"></a><span id="l14.1516">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1517"></a><span id="l14.1517" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1518"></a><span id="l14.1518" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1519"></a><span id="l14.1519">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1520"></a><span id="l14.1520" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1521"></a><span id="l14.1521" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l14.1522"></a><span id="l14.1522">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1523"></a><span id="l14.1523" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1524"></a><span id="l14.1524" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AllAddresses, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l14.1525"></a><span id="l14.1525"> </span>
<a href="#l14.1526"></a><span id="l14.1526">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1527"></a><span id="l14.1527" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1528"></a><span id="l14.1528" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1529"></a><span id="l14.1529">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1530"></a><span id="l14.1530" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1531"></a><span id="l14.1531" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1532"></a><span id="l14.1532">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1533"></a><span id="l14.1533" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1534"></a><span id="l14.1534" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1535"></a><span id="l14.1535">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1536"></a><span id="l14.1536" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1537"></a><span id="l14.1537" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1538"></a><span id="l14.1538">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1539"></a><span id="l14.1539" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1540"></a><span id="l14.1540" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1541"></a><span id="l14.1541">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1542"></a><span id="l14.1542" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1543"></a><span id="l14.1543" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1544"></a><span id="l14.1544"> </span>
<a href="#l14.1545"></a><span id="l14.1545">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1546"></a><span id="l14.1546" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1547"></a><span id="l14.1547" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l14.1548"></a><span id="l14.1548">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1549"></a><span id="l14.1549" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1550"></a><span id="l14.1550" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l14.1551"></a><span id="l14.1551">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1552"></a><span id="l14.1552" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1553"></a><span id="l14.1553" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1554"></a><span id="l14.1554">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1555"></a><span id="l14.1555" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1556"></a><span id="l14.1556" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1557"></a><span id="l14.1557"> </span>
<a href="#l14.1558"></a><span id="l14.1558">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1559"></a><span id="l14.1559" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1560"></a><span id="l14.1560" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsHigherThan, 1);</span>
<a href="#l14.1561"></a><span id="l14.1561">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1562"></a><span id="l14.1562" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1563"></a><span id="l14.1563" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::IsLowerThan, 1);</span>
<a href="#l14.1564"></a><span id="l14.1564">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1565"></a><span id="l14.1565" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1566"></a><span id="l14.1566" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1567"></a><span id="l14.1567">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1568"></a><span id="l14.1568" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1569"></a><span id="l14.1569" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Priority, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1570"></a><span id="l14.1570"> </span>
<a href="#l14.1571"></a><span id="l14.1571">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1572"></a><span id="l14.1572" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1573"></a><span id="l14.1573" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1574"></a><span id="l14.1574">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1575"></a><span id="l14.1575" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1576"></a><span id="l14.1576" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1577"></a><span id="l14.1577"> </span>
<a href="#l14.1578"></a><span id="l14.1578">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1579"></a><span id="l14.1579" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1580"></a><span id="l14.1580" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1581"></a><span id="l14.1581">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l14.1582"></a><span id="l14.1582" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1583"></a><span id="l14.1583" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1584"></a><span id="l14.1584">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l14.1585"></a><span id="l14.1585" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1586"></a><span id="l14.1586" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1587"></a><span id="l14.1587"> </span>
<a href="#l14.1588"></a><span id="l14.1588">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1589"></a><span id="l14.1589" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1590"></a><span id="l14.1590" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1591"></a><span id="l14.1591">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1592"></a><span id="l14.1592" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1593"></a><span id="l14.1593" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1594"></a><span id="l14.1594">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1595"></a><span id="l14.1595" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1596"></a><span id="l14.1596" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1597"></a><span id="l14.1597">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1598"></a><span id="l14.1598" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1599"></a><span id="l14.1599" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1600"></a><span id="l14.1600"> </span>
<a href="#l14.1601"></a><span id="l14.1601">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1602"></a><span id="l14.1602" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1603"></a><span id="l14.1603" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1604"></a><span id="l14.1604">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1605"></a><span id="l14.1605" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1606"></a><span id="l14.1606" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1607"></a><span id="l14.1607">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1608"></a><span id="l14.1608" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1609"></a><span id="l14.1609" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1610"></a><span id="l14.1610"> </span>
<a href="#l14.1611"></a><span id="l14.1611">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1612"></a><span id="l14.1612" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1613"></a><span id="l14.1613" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1614"></a><span id="l14.1614">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1615"></a><span id="l14.1615" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1616"></a><span id="l14.1616" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1617"></a><span id="l14.1617"> </span>
<a href="#l14.1618"></a><span id="l14.1618">   // HasAttachmentStatus does not work reliably until the user has opened a</span>
<a href="#l14.1619"></a><span id="l14.1619">   // message to force it through MIME. We need a solution for this (bug 105169)</span>
<a href="#l14.1620"></a><span id="l14.1620">   // but in the meantime, I'm doing the same thing here that we do in the</span>
<a href="#l14.1621"></a><span id="l14.1621">   // offline mail table, as this does not really depend at the moment on</span>
<a href="#l14.1622"></a><span id="l14.1622">   // whether we have downloaded the body for offline use.</span>
<a href="#l14.1623"></a><span id="l14.1623" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1624"></a><span id="l14.1624" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1625"></a><span id="l14.1625" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1626"></a><span id="l14.1626" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1627"></a><span id="l14.1627" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1628"></a><span id="l14.1628" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1629"></a><span id="l14.1629" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1630"></a><span id="l14.1630" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::HasAttachmentStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1631"></a><span id="l14.1631"> </span>
<a href="#l14.1632"></a><span id="l14.1632">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1633"></a><span id="l14.1633" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1634"></a><span id="l14.1634" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l14.1635"></a><span id="l14.1635">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1636"></a><span id="l14.1636" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1637"></a><span id="l14.1637" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l14.1638"></a><span id="l14.1638">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1639"></a><span id="l14.1639" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1640"></a><span id="l14.1640" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1641"></a><span id="l14.1641"> </span>
<a href="#l14.1642"></a><span id="l14.1642">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1643"></a><span id="l14.1643" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1644"></a><span id="l14.1644" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1645"></a><span id="l14.1645">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1646"></a><span id="l14.1646" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1647"></a><span id="l14.1647" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1648"></a><span id="l14.1648">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1649"></a><span id="l14.1649" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1650"></a><span id="l14.1650" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1651"></a><span id="l14.1651">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1652"></a><span id="l14.1652" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1653"></a><span id="l14.1653" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1654"></a><span id="l14.1654">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1655"></a><span id="l14.1655" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1656"></a><span id="l14.1656" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l14.1657"></a><span id="l14.1657">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1658"></a><span id="l14.1658" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1659"></a><span id="l14.1659" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l14.1660"></a><span id="l14.1660"> </span>
<a href="#l14.1661"></a><span id="l14.1661">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1662"></a><span id="l14.1662" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1663"></a><span id="l14.1663" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l14.1664"></a><span id="l14.1664">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1665"></a><span id="l14.1665" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1666"></a><span id="l14.1666" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l14.1667"></a><span id="l14.1667">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1668"></a><span id="l14.1668" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1669"></a><span id="l14.1669" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l14.1670"></a><span id="l14.1670">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1671"></a><span id="l14.1671" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1672"></a><span id="l14.1672" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l14.1673"></a><span id="l14.1673">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1674"></a><span id="l14.1674" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1675"></a><span id="l14.1675" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l14.1676"></a><span id="l14.1676">   m_onlineManualFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1677"></a><span id="l14.1677" class="difflineminus">-  m_onlineManualFilterTable-&gt;SetEnabled(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1678"></a><span id="l14.1678" class="difflineplus">+  m_onlineManualFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l14.1679"></a><span id="l14.1679"> </span>
<a href="#l14.1680"></a><span id="l14.1680">   return rv;</span>
<a href="#l14.1681"></a><span id="l14.1681"> }</span>
<a href="#l14.1682"></a><span id="l14.1682" class="difflineplus">+// clang-format on</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -21,991 +21,921 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    extern int MK_MSG_SEARCH_STATUS;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-    extern int MK_MSG_CANT_SEARCH_IF_NO_SUMMARY;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-    extern int MK_MSG_SEARCH_HITS_NOT_IN_DB;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+extern int MK_MSG_SEARCH_STATUS;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+extern int MK_MSG_CANT_SEARCH_IF_NO_SUMMARY;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+extern int MK_MSG_SEARCH_HITS_NOT_IN_DB;</span>
<a href="#l15.21"></a><span id="l15.21"> }</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-</span>
<a href="#l15.24"></a><span id="l15.24"> //----------------------------------------------------------------------------</span>
<a href="#l15.25"></a><span id="l15.25"> // Class definitions for the boolean expression structure....</span>
<a href="#l15.26"></a><span id="l15.26"> //----------------------------------------------------------------------------</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-nsMsgSearchBoolExpression * nsMsgSearchBoolExpression::AddSearchTerm(nsMsgSearchBoolExpression * aOrigExpr, nsIMsgSearchTerm * aNewTerm, char * aEncodingStr)</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-// appropriately add the search term to the current expression and return a pointer to the</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-// new expression. The encodingStr is the IMAP/NNTP encoding string for newTerm.</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+nsMsgSearchBoolExpression *nsMsgSearchBoolExpression::AddSearchTerm(</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+    nsMsgSearchBoolExpression *aOrigExpr, nsIMsgSearchTerm *aNewTerm,</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+    char *aEncodingStr)</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+// appropriately add the search term to the current expression and return a</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+// pointer to the new expression. The encodingStr is the IMAP/NNTP encoding</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+// string for newTerm.</span>
<a href="#l15.38"></a><span id="l15.38"> {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-    return aOrigExpr-&gt;leftToRightAddTerm(aNewTerm, aEncodingStr);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  return aOrigExpr-&gt;leftToRightAddTerm(aNewTerm, aEncodingStr);</span>
<a href="#l15.41"></a><span id="l15.41"> }</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-nsMsgSearchBoolExpression * nsMsgSearchBoolExpression::AddExpressionTree(nsMsgSearchBoolExpression * aOrigExpr, nsMsgSearchBoolExpression * aExpression, bool aBoolOp)</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-{</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  if (!aOrigExpr-&gt;m_term &amp;&amp; !aOrigExpr-&gt;m_leftChild &amp;&amp; !aOrigExpr-&gt;m_rightChild)</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  {</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-      // just use the original expression tree...</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-      // delete the original since we have a new original to use</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-      delete aOrigExpr;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-      return aExpression;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+nsMsgSearchBoolExpression *nsMsgSearchBoolExpression::AddExpressionTree(</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+    nsMsgSearchBoolExpression *aOrigExpr,</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+    nsMsgSearchBoolExpression *aExpression, bool aBoolOp) {</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  if (!aOrigExpr-&gt;m_term &amp;&amp; !aOrigExpr-&gt;m_leftChild &amp;&amp;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+      !aOrigExpr-&gt;m_rightChild) {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+    // just use the original expression tree...</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+    // delete the original since we have a new original to use</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    delete aOrigExpr;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+    return aExpression;</span>
<a href="#l15.60"></a><span id="l15.60">   }</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  nsMsgSearchBoolExpression * newExpr = new nsMsgSearchBoolExpression (aOrigExpr, aExpression, aBoolOp);</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  nsMsgSearchBoolExpression *newExpr =</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+      new nsMsgSearchBoolExpression(aOrigExpr, aExpression, aBoolOp);</span>
<a href="#l15.65"></a><span id="l15.65">   return (newExpr) ? newExpr : aOrigExpr;</span>
<a href="#l15.66"></a><span id="l15.66"> }</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-nsMsgSearchBoolExpression::nsMsgSearchBoolExpression()</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-{</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-    m_term = nullptr;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    m_boolOp = nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    m_leftChild = nullptr;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-    m_rightChild = nullptr;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+nsMsgSearchBoolExpression::nsMsgSearchBoolExpression() {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  m_term = nullptr;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  m_boolOp = nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  m_leftChild = nullptr;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  m_rightChild = nullptr;</span>
<a href="#l15.79"></a><span id="l15.79"> }</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-nsMsgSearchBoolExpression::nsMsgSearchBoolExpression (nsIMsgSearchTerm * newTerm, char * encodingStr)</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+nsMsgSearchBoolExpression::nsMsgSearchBoolExpression(nsIMsgSearchTerm *newTerm,</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+                                                     char *encodingStr)</span>
<a href="#l15.84"></a><span id="l15.84"> // we are creating an expression which contains a single search term (newTerm)</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-// and the search term's IMAP or NNTP encoding value for online search expressions AND</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-// a boolean evaluation value which is used for offline search expressions.</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+// and the search term's IMAP or NNTP encoding value for online search</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+// expressions AND a boolean evaluation value which is used for offline search</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+// expressions.</span>
<a href="#l15.90"></a><span id="l15.90"> {</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-    m_term = newTerm;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-    m_encodingStr = encodingStr;</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-    m_boolOp = nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  m_term = newTerm;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  m_encodingStr = encodingStr;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+  m_boolOp = nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l15.97"></a><span id="l15.97"> </span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-    // this expression does not contain sub expressions</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-    m_leftChild = nullptr;</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-    m_rightChild = nullptr;</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+  // this expression does not contain sub expressions</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+  m_leftChild = nullptr;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  m_rightChild = nullptr;</span>
<a href="#l15.104"></a><span id="l15.104"> }</span>
<a href="#l15.105"></a><span id="l15.105"> </span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-nsMsgSearchBoolExpression::nsMsgSearchBoolExpression (nsMsgSearchBoolExpression * expr1, nsMsgSearchBoolExpression * expr2, nsMsgSearchBooleanOperator boolOp)</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-// we are creating an expression which contains two sub expressions and a boolean operator used to combine</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-// them.</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+nsMsgSearchBoolExpression::nsMsgSearchBoolExpression(</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+    nsMsgSearchBoolExpression *expr1, nsMsgSearchBoolExpression *expr2,</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+    nsMsgSearchBooleanOperator boolOp)</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+// we are creating an expression which contains two sub expressions and a</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+// boolean operator used to combine them.</span>
<a href="#l15.115"></a><span id="l15.115"> {</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-    m_leftChild = expr1;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-    m_rightChild = expr2;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-    m_boolOp = boolOp;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+  m_leftChild = expr1;</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+  m_rightChild = expr2;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+  m_boolOp = boolOp;</span>
<a href="#l15.122"></a><span id="l15.122"> </span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    m_term = nullptr;</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  m_term = nullptr;</span>
<a href="#l15.125"></a><span id="l15.125"> }</span>
<a href="#l15.126"></a><span id="l15.126"> </span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-nsMsgSearchBoolExpression::~nsMsgSearchBoolExpression()</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-{</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-  // we must recursively destroy all sub expressions before we destroy ourself.....We leave search terms alone!</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+nsMsgSearchBoolExpression::~nsMsgSearchBoolExpression() {</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  // we must recursively destroy all sub expressions before we destroy</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  // ourself.....We leave search terms alone!</span>
<a href="#l15.133"></a><span id="l15.133">   delete m_leftChild;</span>
<a href="#l15.134"></a><span id="l15.134">   delete m_rightChild;</span>
<a href="#l15.135"></a><span id="l15.135"> }</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-nsMsgSearchBoolExpression *</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-nsMsgSearchBoolExpression::leftToRightAddTerm(nsIMsgSearchTerm * newTerm, char * encodingStr)</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-{</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-    // we have a base case where this is the first term being added to the expression:</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-    if (!m_term &amp;&amp; !m_leftChild &amp;&amp; !m_rightChild)</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-    {</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-        m_term = newTerm;</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-        m_encodingStr = encodingStr;</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-        return this;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-    }</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+nsMsgSearchBoolExpression *nsMsgSearchBoolExpression::leftToRightAddTerm(</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+    nsIMsgSearchTerm *newTerm, char *encodingStr) {</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+  // we have a base case where this is the first term being added to the</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+  // expression:</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+  if (!m_term &amp;&amp; !m_leftChild &amp;&amp; !m_rightChild) {</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+    m_term = newTerm;</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+    m_encodingStr = encodingStr;</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+    return this;</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+  }</span>
<a href="#l15.156"></a><span id="l15.156"> </span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-    nsMsgSearchBoolExpression * tempExpr = new nsMsgSearchBoolExpression (newTerm,encodingStr);</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-    if (tempExpr)  // make sure creation succeeded</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-    {</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-      bool booleanAnd;</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-      newTerm-&gt;GetBooleanAnd(&amp;booleanAnd);</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-      nsMsgSearchBoolExpression * newExpr = new nsMsgSearchBoolExpression (this, tempExpr, booleanAnd);</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-      if (newExpr)</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-         return newExpr;</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-      else</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-         delete tempExpr;    // clean up memory allocation in case of failure</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    }</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-    return this;   // in case we failed to create a new expression, return self</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+  nsMsgSearchBoolExpression *tempExpr =</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+      new nsMsgSearchBoolExpression(newTerm, encodingStr);</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+  if (tempExpr)  // make sure creation succeeded</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+  {</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+    bool booleanAnd;</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+    newTerm-&gt;GetBooleanAnd(&amp;booleanAnd);</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+    nsMsgSearchBoolExpression *newExpr =</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+        new nsMsgSearchBoolExpression(this, tempExpr, booleanAnd);</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+    if (newExpr)</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+      return newExpr;</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+    else</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+      delete tempExpr;  // clean up memory allocation in case of failure</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+  }</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+  return this;  // in case we failed to create a new expression, return self</span>
<a href="#l15.183"></a><span id="l15.183"> }</span>
<a href="#l15.184"></a><span id="l15.184"> </span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-</span>
<a href="#l15.186"></a><span id="l15.186"> // returns true or false depending on what the current expression evaluates to.</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-bool nsMsgSearchBoolExpression::OfflineEvaluate(nsIMsgDBHdr *msgToMatch, const char *defaultCharset,</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-  nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db, const nsACString&amp; headers,</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-  bool Filtering)</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-{</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-    bool result = true;    // always default to false positives</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-    bool isAnd;</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+bool nsMsgSearchBoolExpression::OfflineEvaluate(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+                                                const char *defaultCharset,</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+                                                nsIMsgSearchScopeTerm *scope,</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+                                                nsIMsgDatabase *db,</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+                                                const nsACString &amp;headers,</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+                                                bool Filtering) {</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+  bool result = true;  // always default to false positives</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+  bool isAnd;</span>
<a href="#l15.201"></a><span id="l15.201"> </span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-    if (m_term) // do we contain just a search term?</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-    {</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-      nsMsgSearchOfflineMail::ProcessSearchTerm(msgToMatch, m_term,</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-        defaultCharset, scope, db, headers, Filtering, &amp;result);</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineminus">-      return result;</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-    }</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-    // otherwise we must recursively determine the value of our sub expressions</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+  if (m_term)  // do we contain just a search term?</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+  {</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+    nsMsgSearchOfflineMail::ProcessSearchTerm(msgToMatch, m_term,</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+                                              defaultCharset, scope, db,</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+                                              headers, Filtering, &amp;result);</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+    return result;</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+  }</span>
<a href="#l15.217"></a><span id="l15.217"> </span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-    isAnd = (m_boolOp == nsMsgSearchBooleanOp::BooleanAND);</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+  // otherwise we must recursively determine the value of our sub expressions</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineplus">+</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+  isAnd = (m_boolOp == nsMsgSearchBooleanOp::BooleanAND);</span>
<a href="#l15.222"></a><span id="l15.222"> </span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-    if (m_leftChild)</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-    {</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-        result = m_leftChild-&gt;OfflineEvaluate(msgToMatch, defaultCharset,</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-          scope, db, headers, Filtering);</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-        if ( (result &amp;&amp; !isAnd) || (!result &amp;&amp; isAnd))</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-          return result;</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-    }</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+  if (m_leftChild) {</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+    result = m_leftChild-&gt;OfflineEvaluate(msgToMatch, defaultCharset, scope, db,</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+                                          headers, Filtering);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+    if ((result &amp;&amp; !isAnd) || (!result &amp;&amp; isAnd)) return result;</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+  }</span>
<a href="#l15.235"></a><span id="l15.235"> </span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-    // If we got this far, either there was no leftChild (which is impossible)</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-    // or we got (FALSE and OR) or (TRUE and AND) from the first result. That</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-    // means the outcome depends entirely on the rightChild.</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-    if (m_rightChild)</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-        result = m_rightChild-&gt;OfflineEvaluate(msgToMatch, defaultCharset,</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-          scope, db, headers, Filtering);</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+  // If we got this far, either there was no leftChild (which is impossible)</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+  // or we got (FALSE and OR) or (TRUE and AND) from the first result. That</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+  // means the outcome depends entirely on the rightChild.</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+  if (m_rightChild)</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+    result = m_rightChild-&gt;OfflineEvaluate(msgToMatch, defaultCharset, scope,</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+                                           db, headers, Filtering);</span>
<a href="#l15.248"></a><span id="l15.248"> </span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-    return result;</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+  return result;</span>
<a href="#l15.251"></a><span id="l15.251"> }</span>
<a href="#l15.252"></a><span id="l15.252"> </span>
<a href="#l15.253"></a><span id="l15.253"> // ### Maybe we can get rid of these because of our use of nsString???</span>
<a href="#l15.254"></a><span id="l15.254"> // constants used for online searching with IMAP/NNTP encoded search terms.</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-// the + 1 is to account for null terminators we add at each stage of assembling the expression...</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-const int sizeOfORTerm = 6+1;  // 6 bytes if we are combining two sub expressions with an OR term</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-const int sizeOfANDTerm = 1+1; // 1 byte if we are combining two sub expressions with an AND term</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+// the + 1 is to account for null terminators we add at each stage of assembling</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+// the expression...</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineplus">+const int sizeOfORTerm =</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+    6 + 1;  // 6 bytes if we are combining two sub expressions with an OR term</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+const int sizeOfANDTerm =</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+    1 + 1;  // 1 byte if we are combining two sub expressions with an AND term</span>
<a href="#l15.264"></a><span id="l15.264"> </span>
<a href="#l15.265"></a><span id="l15.265"> int32_t nsMsgSearchBoolExpression::CalcEncodeStrSize()</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineminus">-// recursively examine each sub expression and calculate a final size for the entire IMAP/NNTP encoding</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+// recursively examine each sub expression and calculate a final size for the</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+// entire IMAP/NNTP encoding</span>
<a href="#l15.269"></a><span id="l15.269"> {</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-    if (!m_term &amp;&amp; (!m_leftChild || !m_rightChild))   // is the expression empty?</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-        return 0;</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-    if (m_term)  // are we a leaf node?</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-        return m_encodingStr.Length();</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-    if (m_boolOp == nsMsgSearchBooleanOp::BooleanOR)</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-        return sizeOfORTerm + m_leftChild-&gt;CalcEncodeStrSize() + m_rightChild-&gt;CalcEncodeStrSize();</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-    if (m_boolOp == nsMsgSearchBooleanOp::BooleanAND)</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-        return sizeOfANDTerm + m_leftChild-&gt;CalcEncodeStrSize() + m_rightChild-&gt;CalcEncodeStrSize();</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+  if (!m_term &amp;&amp; (!m_leftChild || !m_rightChild))  // is the expression empty?</span>
<a href="#l15.279"></a><span id="l15.279">     return 0;</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+  if (m_term)  // are we a leaf node?</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+    return m_encodingStr.Length();</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+  if (m_boolOp == nsMsgSearchBooleanOp::BooleanOR)</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+    return sizeOfORTerm + m_leftChild-&gt;CalcEncodeStrSize() +</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+           m_rightChild-&gt;CalcEncodeStrSize();</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+  if (m_boolOp == nsMsgSearchBooleanOp::BooleanAND)</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+    return sizeOfANDTerm + m_leftChild-&gt;CalcEncodeStrSize() +</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+           m_rightChild-&gt;CalcEncodeStrSize();</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+  return 0;</span>
<a href="#l15.289"></a><span id="l15.289"> }</span>
<a href="#l15.290"></a><span id="l15.290"> </span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-void nsMsgSearchBoolExpression::GenerateEncodeStr(nsCString * buffer)</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+void nsMsgSearchBoolExpression::GenerateEncodeStr(nsCString *buffer)</span>
<a href="#l15.294"></a><span id="l15.294"> // recurively combine sub expressions to form a single IMAP/NNTP encoded string</span>
<a href="#l15.295"></a><span id="l15.295"> {</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-    if ((!m_term &amp;&amp; (!m_leftChild || !m_rightChild))) // is expression empty?</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-        return;</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineplus">+  if ((!m_term &amp;&amp; (!m_leftChild || !m_rightChild)))  // is expression empty?</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+    return;</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineplus">+</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+  if (m_term)  // are we a leaf expression?</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+  {</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+    *buffer += m_encodingStr;</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+    return;</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+  }</span>
<a href="#l15.306"></a><span id="l15.306"> </span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-    if (m_term) // are we a leaf expression?</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-    {</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-        *buffer += m_encodingStr;</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-        return;</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+  // add encode strings of each sub expression</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+  if (m_boolOp == nsMsgSearchBooleanOp::BooleanOR) {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+    *buffer += &quot; (OR&quot;;</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineplus">+    m_leftChild-&gt;GenerateEncodeStr(</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineplus">+        buffer);  // insert left expression into the buffer</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+    m_rightChild-&gt;GenerateEncodeStr(</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+        buffer);  // insert right expression into the buffer</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+    // HACK ALERT!!! if last returned character in the buffer is now a ' ' then</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+    // we need to remove it because we don't want a ' ' to preceded the closing</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineplus">+    // paren in the OR encoding.</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineplus">+    uint32_t lastCharPos = buffer-&gt;Length() - 1;</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineplus">+    if (buffer-&gt;CharAt(lastCharPos) == ' ') {</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineplus">+      buffer-&gt;SetLength(lastCharPos);</span>
<a href="#l15.326"></a><span id="l15.326">     }</span>
<a href="#l15.327"></a><span id="l15.327"> </span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-    // add encode strings of each sub expression</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-    if (m_boolOp == nsMsgSearchBooleanOp::BooleanOR)</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-    {</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-        *buffer += &quot; (OR&quot;;</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineminus">-</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-        m_leftChild-&gt;GenerateEncodeStr(buffer);  // insert left expression into the buffer</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineminus">-        m_rightChild-&gt;GenerateEncodeStr(buffer);  // insert right expression into the buffer</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-        // HACK ALERT!!! if last returned character in the buffer is now a ' ' then we need to remove it because we don't want</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-        // a ' ' to preceded the closing paren in the OR encoding.</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineminus">-        uint32_t lastCharPos = buffer-&gt;Length() - 1;</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineminus">-        if (buffer-&gt;CharAt(lastCharPos) == ' ')</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineminus">-        {</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineminus">-            buffer-&gt;SetLength(lastCharPos);</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineminus">-        }</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineminus">-</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineminus">-        *buffer += ')';</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-    }</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineminus">-    else if (m_boolOp == nsMsgSearchBooleanOp::BooleanAND)</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineminus">-    {</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-        m_leftChild-&gt;GenerateEncodeStr(buffer); // insert left expression</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineminus">-        m_rightChild-&gt;GenerateEncodeStr(buffer);</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineminus">-    }</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineminus">-    return;</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+    *buffer += ')';</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineplus">+  } else if (m_boolOp == nsMsgSearchBooleanOp::BooleanAND) {</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineplus">+    m_leftChild-&gt;GenerateEncodeStr(buffer);  // insert left expression</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineplus">+    m_rightChild-&gt;GenerateEncodeStr(buffer);</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineplus">+  }</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineplus">+  return;</span>
<a href="#l15.358"></a><span id="l15.358"> }</span>
<a href="#l15.359"></a><span id="l15.359"> </span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-</span>
<a href="#l15.361"></a><span id="l15.361"> //-----------------------------------------------------------------------------</span>
<a href="#l15.362"></a><span id="l15.362"> //---------------- Adapter class for searching offline folders ----------------</span>
<a href="#l15.363"></a><span id="l15.363"> //-----------------------------------------------------------------------------</span>
<a href="#l15.364"></a><span id="l15.364"> </span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsMsgSearchOfflineMail, nsMsgSearchAdapter, nsIUrlListener)</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsMsgSearchOfflineMail, nsMsgSearchAdapter,</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineplus">+                            nsIUrlListener)</span>
<a href="#l15.369"></a><span id="l15.369"> </span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-nsMsgSearchOfflineMail::nsMsgSearchOfflineMail (nsIMsgSearchScopeTerm *scope, nsIArray *termList) : nsMsgSearchAdapter (scope, termList)</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-{</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-}</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineplus">+nsMsgSearchOfflineMail::nsMsgSearchOfflineMail(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineplus">+                                               nsIArray *termList)</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineplus">+    : nsMsgSearchAdapter(scope, termList) {}</span>
<a href="#l15.376"></a><span id="l15.376"> </span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-nsMsgSearchOfflineMail::~nsMsgSearchOfflineMail ()</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-{</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineplus">+nsMsgSearchOfflineMail::~nsMsgSearchOfflineMail() {</span>
<a href="#l15.380"></a><span id="l15.380">   // Database should have been closed when the scope term finished.</span>
<a href="#l15.381"></a><span id="l15.381">   CleanUpScope();</span>
<a href="#l15.382"></a><span id="l15.382">   NS_ASSERTION(!m_db, &quot;db not closed&quot;);</span>
<a href="#l15.383"></a><span id="l15.383"> }</span>
<a href="#l15.384"></a><span id="l15.384"> </span>
<a href="#l15.385"></a><span id="l15.385" class="difflineminus">-</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-nsresult nsMsgSearchOfflineMail::ValidateTerms ()</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineminus">-{</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-  return nsMsgSearchAdapter::ValidateTerms ();</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+nsresult nsMsgSearchOfflineMail::ValidateTerms() {</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+  return nsMsgSearchAdapter::ValidateTerms();</span>
<a href="#l15.391"></a><span id="l15.391"> }</span>
<a href="#l15.392"></a><span id="l15.392"> </span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+nsresult nsMsgSearchOfflineMail::OpenSummaryFile() {</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; mailDB;</span>
<a href="#l15.395"></a><span id="l15.395"> </span>
<a href="#l15.396"></a><span id="l15.396" class="difflineminus">-nsresult nsMsgSearchOfflineMail::OpenSummaryFile ()</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineminus">-{</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; mailDB ;</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-    nsresult err = NS_OK;</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-    // do password protection of local cache thing.</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+  // do password protection of local cache thing.</span>
<a href="#l15.404"></a><span id="l15.404"> #ifdef DOING_FOLDER_CACHE_PASSWORDS</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineminus">-    if (m_scope-&gt;m_folder &amp;&amp; m_scope-&gt;m_folder-&gt;UserNeedsToAuthenticateForFolder(false) &amp;&amp; m_scope-&gt;m_folder-&gt;GetMaster()-&gt;PromptForHostPassword(m_scope-&gt;m_frame-&gt;GetContext(), m_scope-&gt;m_folder) != 0)</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineminus">-    {</span>
<a href="#l15.407"></a><span id="l15.407" class="difflineminus">-        m_scope-&gt;m_frame-&gt;StopRunning();</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineminus">-        return SearchError_ScopeDone;</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineminus">-    }</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineplus">+  if (m_scope-&gt;m_folder &amp;&amp;</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineplus">+      m_scope-&gt;m_folder-&gt;UserNeedsToAuthenticateForFolder(false) &amp;&amp;</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineplus">+      m_scope-&gt;m_folder-&gt;GetMaster()-&gt;PromptForHostPassword(</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+          m_scope-&gt;m_frame-&gt;GetContext(), m_scope-&gt;m_folder) != 0) {</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+    m_scope-&gt;m_frame-&gt;StopRunning();</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineplus">+    return SearchError_ScopeDone;</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+  }</span>
<a href="#l15.417"></a><span id="l15.417"> #endif</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt;  folderInfo;</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-    err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; scopeFolder)</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineminus">-    {</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineminus">-      err = scopeFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(m_db));</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-    }</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineminus">-    else</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineminus">-      return err; // not sure why m_folder wouldn't be set.</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineplus">+  err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; scopeFolder) {</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineplus">+    err = scopeFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+                                            getter_AddRefs(m_db));</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+  } else</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineplus">+    return err;  // not sure why m_folder wouldn't be set.</span>
<a href="#l15.435"></a><span id="l15.435"> </span>
<a href="#l15.436"></a><span id="l15.436" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineminus">-      return NS_OK;</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineplus">+  if (NS_SUCCEEDED(err)) return NS_OK;</span>
<a href="#l15.439"></a><span id="l15.439"> </span>
<a href="#l15.440"></a><span id="l15.440" class="difflineminus">-    if ((err == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING) ||</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineminus">-        (err == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE))</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineminus">-    {</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-            nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(scopeFolder, &amp;err);</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-            if (NS_SUCCEEDED(err) &amp;&amp; localFolder)</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-            {</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineminus">-              nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineminus">-              m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineminus">-              if (searchSession)</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineminus">-              {</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-                nsCOMPtr &lt;nsIMsgWindow&gt; searchWindow;</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+  if ((err == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING) ||</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+      (err == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)) {</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineplus">+        do_QueryInterface(scopeFolder, &amp;err);</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; localFolder) {</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+      nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineplus">+      m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineplus">+      if (searchSession) {</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineplus">+        nsCOMPtr&lt;nsIMsgWindow&gt; searchWindow;</span>
<a href="#l15.460"></a><span id="l15.460"> </span>
<a href="#l15.461"></a><span id="l15.461" class="difflineminus">-                searchSession-&gt;GetWindow(getter_AddRefs(searchWindow));</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineminus">-                searchSession-&gt;PauseSearch();</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineminus">-                localFolder-&gt;ParseFolder(searchWindow, this);</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineminus">-              }</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineminus">-            }</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineplus">+        searchSession-&gt;GetWindow(getter_AddRefs(searchWindow));</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineplus">+        searchSession-&gt;PauseSearch();</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineplus">+        localFolder-&gt;ParseFolder(searchWindow, this);</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineplus">+      }</span>
<a href="#l15.470"></a><span id="l15.470">     }</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-    else</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-    {</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineminus">-      NS_ASSERTION(false, &quot;unexpected error opening db&quot;);</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineminus">-    }</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+  } else {</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineplus">+    NS_ASSERTION(false, &quot;unexpected error opening db&quot;);</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+  }</span>
<a href="#l15.478"></a><span id="l15.478"> </span>
<a href="#l15.479"></a><span id="l15.479" class="difflineminus">-    return err;</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineplus">+  return err;</span>
<a href="#l15.481"></a><span id="l15.481"> }</span>
<a href="#l15.482"></a><span id="l15.482"> </span>
<a href="#l15.483"></a><span id="l15.483" class="difflineminus">-</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineminus">-nsresult</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-nsMsgSearchOfflineMail::MatchTermsForFilter(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineminus">-                                            nsIArray *termList,</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineminus">-                                            const char *defaultCharset,</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineminus">-                                            nsIMsgSearchScopeTerm * scope,</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineminus">-                                            nsIMsgDatabase * db,</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineminus">-                                            const nsACString&amp; headers,</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineminus">-                                            nsMsgSearchBoolExpression ** aExpressionTree,</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineminus">-                                            bool *pResult)</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-{</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineminus">-    return MatchTerms(msgToMatch, termList, defaultCharset, scope, db, headers, true, aExpressionTree, pResult);</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+nsresult nsMsgSearchOfflineMail::MatchTermsForFilter(</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineplus">+    nsIMsgDBHdr *msgToMatch, nsIArray *termList, const char *defaultCharset,</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineplus">+    nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db, const nsACString &amp;headers,</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineplus">+    nsMsgSearchBoolExpression **aExpressionTree, bool *pResult) {</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineplus">+  return MatchTerms(msgToMatch, termList, defaultCharset, scope, db, headers,</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineplus">+                    true, aExpressionTree, pResult);</span>
<a href="#l15.501"></a><span id="l15.501"> }</span>
<a href="#l15.502"></a><span id="l15.502"> </span>
<a href="#l15.503"></a><span id="l15.503"> // static method which matches a header against a list of search terms.</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineminus">-nsresult</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineminus">-nsMsgSearchOfflineMail::MatchTermsForSearch(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineminus">-                                            nsIArray* termList,</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineminus">-                                            const char *defaultCharset,</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineminus">-                                            nsIMsgSearchScopeTerm *scope,</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineminus">-                                            nsIMsgDatabase *db,</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineminus">-                                            nsMsgSearchBoolExpression ** aExpressionTree,</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineminus">-                                            bool *pResult)</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineminus">-{</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineminus">-</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineminus">-    return MatchTerms(msgToMatch, termList, defaultCharset, scope, db, EmptyCString(), false, aExpressionTree, pResult);</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineplus">+nsresult nsMsgSearchOfflineMail::MatchTermsForSearch(</span>
<a href="#l15.516"></a><span id="l15.516" class="difflineplus">+    nsIMsgDBHdr *msgToMatch, nsIArray *termList, const char *defaultCharset,</span>
<a href="#l15.517"></a><span id="l15.517" class="difflineplus">+    nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db,</span>
<a href="#l15.518"></a><span id="l15.518" class="difflineplus">+    nsMsgSearchBoolExpression **aExpressionTree, bool *pResult) {</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineplus">+  return MatchTerms(msgToMatch, termList, defaultCharset, scope, db,</span>
<a href="#l15.520"></a><span id="l15.520" class="difflineplus">+                    EmptyCString(), false, aExpressionTree, pResult);</span>
<a href="#l15.521"></a><span id="l15.521"> }</span>
<a href="#l15.522"></a><span id="l15.522"> </span>
<a href="#l15.523"></a><span id="l15.523" class="difflineminus">-nsresult nsMsgSearchOfflineMail::ConstructExpressionTree(nsIArray *termList,</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineminus">-                                            uint32_t termCount,</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineminus">-                                            uint32_t &amp;aStartPosInList,</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineminus">-                                            nsMsgSearchBoolExpression ** aExpressionTree)</span>
<a href="#l15.527"></a><span id="l15.527" class="difflineminus">-{</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineminus">-  nsMsgSearchBoolExpression * finalExpression = *aExpressionTree;</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineplus">+nsresult nsMsgSearchOfflineMail::ConstructExpressionTree(</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineplus">+    nsIArray *termList, uint32_t termCount, uint32_t &amp;aStartPosInList,</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineplus">+    nsMsgSearchBoolExpression **aExpressionTree) {</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineplus">+  nsMsgSearchBoolExpression *finalExpression = *aExpressionTree;</span>
<a href="#l15.533"></a><span id="l15.533"> </span>
<a href="#l15.534"></a><span id="l15.534" class="difflineminus">-  if (!finalExpression)</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineminus">-    finalExpression = new nsMsgSearchBoolExpression();</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineplus">+  if (!finalExpression) finalExpression = new nsMsgSearchBoolExpression();</span>
<a href="#l15.537"></a><span id="l15.537"> </span>
<a href="#l15.538"></a><span id="l15.538" class="difflineminus">-  while (aStartPosInList &lt; termCount)</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineminus">-  {</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineminus">-      nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm = do_QueryElementAt(termList, aStartPosInList);</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineminus">-      NS_ASSERTION (pTerm, &quot;couldn't get term to match&quot;);</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineplus">+  while (aStartPosInList &lt; termCount) {</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineplus">+    nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm =</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineplus">+        do_QueryElementAt(termList, aStartPosInList);</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineplus">+    NS_ASSERTION(pTerm, &quot;couldn't get term to match&quot;);</span>
<a href="#l15.546"></a><span id="l15.546"> </span>
<a href="#l15.547"></a><span id="l15.547" class="difflineminus">-      bool beginsGrouping;</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineminus">-      bool endsGrouping;</span>
<a href="#l15.549"></a><span id="l15.549" class="difflineminus">-      pTerm-&gt;GetBeginsGrouping(&amp;beginsGrouping);</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineminus">-      pTerm-&gt;GetEndsGrouping(&amp;endsGrouping);</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineplus">+    bool beginsGrouping;</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineplus">+    bool endsGrouping;</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineplus">+    pTerm-&gt;GetBeginsGrouping(&amp;beginsGrouping);</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineplus">+    pTerm-&gt;GetEndsGrouping(&amp;endsGrouping);</span>
<a href="#l15.555"></a><span id="l15.555"> </span>
<a href="#l15.556"></a><span id="l15.556" class="difflineminus">-      if (beginsGrouping)</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineminus">-      {</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineminus">-          //temporarily turn off the grouping for our recursive call</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineminus">-          pTerm-&gt;SetBeginsGrouping(false);</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineminus">-          nsMsgSearchBoolExpression * innerExpression = new nsMsgSearchBoolExpression();</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineplus">+    if (beginsGrouping) {</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineplus">+      // temporarily turn off the grouping for our recursive call</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineplus">+      pTerm-&gt;SetBeginsGrouping(false);</span>
<a href="#l15.564"></a><span id="l15.564" class="difflineplus">+      nsMsgSearchBoolExpression *innerExpression =</span>
<a href="#l15.565"></a><span id="l15.565" class="difflineplus">+          new nsMsgSearchBoolExpression();</span>
<a href="#l15.566"></a><span id="l15.566"> </span>
<a href="#l15.567"></a><span id="l15.567" class="difflineminus">-          // the first search term in the grouping is the one that holds the operator for how this search term</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineminus">-          // should be joined with the expressions to it's left.</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineminus">-          bool booleanAnd;</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineminus">-          pTerm-&gt;GetBooleanAnd(&amp;booleanAnd);</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineplus">+      // the first search term in the grouping is the one that holds the</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineplus">+      // operator for how this search term should be joined with the expressions</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineplus">+      // to it's left.</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineplus">+      bool booleanAnd;</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+      pTerm-&gt;GetBooleanAnd(&amp;booleanAnd);</span>
<a href="#l15.576"></a><span id="l15.576"> </span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-          // now add this expression tree to our overall expression tree...</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineminus">-          finalExpression = nsMsgSearchBoolExpression::AddExpressionTree(finalExpression, innerExpression, booleanAnd);</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineplus">+      // now add this expression tree to our overall expression tree...</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineplus">+      finalExpression = nsMsgSearchBoolExpression::AddExpressionTree(</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineplus">+          finalExpression, innerExpression, booleanAnd);</span>
<a href="#l15.582"></a><span id="l15.582"> </span>
<a href="#l15.583"></a><span id="l15.583" class="difflineminus">-          // recursively process this inner expression</span>
<a href="#l15.584"></a><span id="l15.584" class="difflineminus">-          ConstructExpressionTree(termList, termCount, aStartPosInList,</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineminus">-            &amp;finalExpression-&gt;m_rightChild);</span>
<a href="#l15.586"></a><span id="l15.586" class="difflineplus">+      // recursively process this inner expression</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineplus">+      ConstructExpressionTree(termList, termCount, aStartPosInList,</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineplus">+                              &amp;finalExpression-&gt;m_rightChild);</span>
<a href="#l15.589"></a><span id="l15.589"> </span>
<a href="#l15.590"></a><span id="l15.590" class="difflineminus">-          // undo our damage</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineminus">-          pTerm-&gt;SetBeginsGrouping(true);</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineplus">+      // undo our damage</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineplus">+      pTerm-&gt;SetBeginsGrouping(true);</span>
<a href="#l15.594"></a><span id="l15.594"> </span>
<a href="#l15.595"></a><span id="l15.595" class="difflineminus">-      }</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineminus">-      else</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineminus">-      {</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineminus">-        finalExpression = nsMsgSearchBoolExpression::AddSearchTerm(finalExpression, pTerm, nullptr);    // add the term to the expression tree</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineplus">+    } else {</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineplus">+      finalExpression = nsMsgSearchBoolExpression::AddSearchTerm(</span>
<a href="#l15.601"></a><span id="l15.601" class="difflineplus">+          finalExpression, pTerm,</span>
<a href="#l15.602"></a><span id="l15.602" class="difflineplus">+          nullptr);  // add the term to the expression tree</span>
<a href="#l15.603"></a><span id="l15.603"> </span>
<a href="#l15.604"></a><span id="l15.604" class="difflineminus">-        if (endsGrouping)</span>
<a href="#l15.605"></a><span id="l15.605" class="difflineminus">-          break;</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineminus">-      }</span>
<a href="#l15.607"></a><span id="l15.607" class="difflineplus">+      if (endsGrouping) break;</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineplus">+    }</span>
<a href="#l15.609"></a><span id="l15.609"> </span>
<a href="#l15.610"></a><span id="l15.610" class="difflineminus">-      aStartPosInList++;</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineminus">-  } // while we still have terms to process in this group</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineplus">+    aStartPosInList++;</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineplus">+  }  // while we still have terms to process in this group</span>
<a href="#l15.614"></a><span id="l15.614"> </span>
<a href="#l15.615"></a><span id="l15.615">   *aExpressionTree = finalExpression;</span>
<a href="#l15.616"></a><span id="l15.616"> </span>
<a href="#l15.617"></a><span id="l15.617">   return NS_OK;</span>
<a href="#l15.618"></a><span id="l15.618"> }</span>
<a href="#l15.619"></a><span id="l15.619"> </span>
<a href="#l15.620"></a><span id="l15.620" class="difflineminus">-nsresult nsMsgSearchOfflineMail::ProcessSearchTerm(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineminus">-                                            nsIMsgSearchTerm * aTerm,</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineminus">-                                            const char *defaultCharset,</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineminus">-                                            nsIMsgSearchScopeTerm * scope,</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineminus">-                                            nsIMsgDatabase * db,</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineminus">-                                            const nsACString&amp; headers,</span>
<a href="#l15.626"></a><span id="l15.626" class="difflineminus">-                                            bool Filtering,</span>
<a href="#l15.627"></a><span id="l15.627" class="difflineminus">-                                            bool *pResult)</span>
<a href="#l15.628"></a><span id="l15.628" class="difflineminus">-{</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineminus">-    nsresult err = NS_OK;</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineminus">-    nsCString  recipients;</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineminus">-    nsCString  ccList;</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineminus">-    nsCString  matchString;</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineminus">-    nsCString  msgCharset;</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineminus">-    const char *charset;</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineminus">-    bool charsetOverride = false; /* XXX BUG 68706 */</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineminus">-    uint32_t msgFlags;</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineminus">-    bool result;</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineminus">-    bool matchAll;</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineplus">+nsresult nsMsgSearchOfflineMail::ProcessSearchTerm(</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineplus">+    nsIMsgDBHdr *msgToMatch, nsIMsgSearchTerm *aTerm,</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineplus">+    const char *defaultCharset, nsIMsgSearchScopeTerm *scope,</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineplus">+    nsIMsgDatabase *db, const nsACString &amp;headers, bool Filtering,</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineplus">+    bool *pResult) {</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineplus">+  nsCString recipients;</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineplus">+  nsCString ccList;</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineplus">+  nsCString matchString;</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineplus">+  nsCString msgCharset;</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineplus">+  const char *charset;</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineplus">+  bool charsetOverride = false; /* XXX BUG 68706 */</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineplus">+  uint32_t msgFlags;</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineplus">+  bool result;</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineplus">+  bool matchAll;</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineplus">+</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineplus">+</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineplus">+  aTerm-&gt;GetMatchAll(&amp;matchAll);</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineplus">+  if (matchAll) {</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineplus">+    *pResult = true;</span>
<a href="#l15.660"></a><span id="l15.660" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineplus">+  }</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineplus">+  *pResult = false;</span>
<a href="#l15.663"></a><span id="l15.663"> </span>
<a href="#l15.664"></a><span id="l15.664" class="difflineminus">-    NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l15.665"></a><span id="l15.665" class="difflineplus">+  nsMsgSearchAttribValue attrib;</span>
<a href="#l15.666"></a><span id="l15.666" class="difflineplus">+  aTerm-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l15.667"></a><span id="l15.667" class="difflineplus">+  msgToMatch-&gt;GetCharset(getter_Copies(msgCharset));</span>
<a href="#l15.668"></a><span id="l15.668" class="difflineplus">+  charset = msgCharset.get();</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineplus">+  if (!charset || !*charset) charset = (const char *)defaultCharset;</span>
<a href="#l15.670"></a><span id="l15.670" class="difflineplus">+  msgToMatch-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l15.671"></a><span id="l15.671"> </span>
<a href="#l15.672"></a><span id="l15.672" class="difflineminus">-    aTerm-&gt;GetMatchAll(&amp;matchAll);</span>
<a href="#l15.673"></a><span id="l15.673" class="difflineminus">-    if (matchAll)</span>
<a href="#l15.674"></a><span id="l15.674" class="difflineminus">-    {</span>
<a href="#l15.675"></a><span id="l15.675" class="difflineminus">-      *pResult = true;</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineminus">-      return NS_OK;</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineplus">+  switch (attrib) {</span>
<a href="#l15.678"></a><span id="l15.678" class="difflineplus">+    case nsMsgSearchAttrib::Sender:</span>
<a href="#l15.679"></a><span id="l15.679" class="difflineplus">+      msgToMatch-&gt;GetAuthor(getter_Copies(matchString));</span>
<a href="#l15.680"></a><span id="l15.680" class="difflineplus">+      err = aTerm-&gt;MatchRfc822String(matchString, charset, &amp;result);</span>
<a href="#l15.681"></a><span id="l15.681" class="difflineplus">+      break;</span>
<a href="#l15.682"></a><span id="l15.682" class="difflineplus">+    case nsMsgSearchAttrib::Subject: {</span>
<a href="#l15.683"></a><span id="l15.683" class="difflineplus">+      msgToMatch-&gt;GetSubject(getter_Copies(matchString) /* , true */);</span>
<a href="#l15.684"></a><span id="l15.684" class="difflineplus">+      if (msgFlags &amp; nsMsgMessageFlags::HasRe) {</span>
<a href="#l15.685"></a><span id="l15.685" class="difflineplus">+        // Make sure we pass along the &quot;Re: &quot; part of the subject if this is a</span>
<a href="#l15.686"></a><span id="l15.686" class="difflineplus">+        // reply.</span>
<a href="#l15.687"></a><span id="l15.687" class="difflineplus">+        nsCString reString;</span>
<a href="#l15.688"></a><span id="l15.688" class="difflineplus">+        reString.AssignLiteral(&quot;Re: &quot;);</span>
<a href="#l15.689"></a><span id="l15.689" class="difflineplus">+        reString.Append(matchString);</span>
<a href="#l15.690"></a><span id="l15.690" class="difflineplus">+        err = aTerm-&gt;MatchRfc2047String(reString, charset, charsetOverride,</span>
<a href="#l15.691"></a><span id="l15.691" class="difflineplus">+                                        &amp;result);</span>
<a href="#l15.692"></a><span id="l15.692" class="difflineplus">+      } else</span>
<a href="#l15.693"></a><span id="l15.693" class="difflineplus">+        err = aTerm-&gt;MatchRfc2047String(matchString, charset, charsetOverride,</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineplus">+                                        &amp;result);</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineplus">+      break;</span>
<a href="#l15.696"></a><span id="l15.696">     }</span>
<a href="#l15.697"></a><span id="l15.697" class="difflineminus">-    *pResult = false;</span>
<a href="#l15.698"></a><span id="l15.698" class="difflineminus">-</span>
<a href="#l15.699"></a><span id="l15.699" class="difflineminus">-    nsMsgSearchAttribValue attrib;</span>
<a href="#l15.700"></a><span id="l15.700" class="difflineminus">-    aTerm-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l15.701"></a><span id="l15.701" class="difflineminus">-    msgToMatch-&gt;GetCharset(getter_Copies(msgCharset));</span>
<a href="#l15.702"></a><span id="l15.702" class="difflineminus">-    charset = msgCharset.get();</span>
<a href="#l15.703"></a><span id="l15.703" class="difflineminus">-    if (!charset || !*charset)</span>
<a href="#l15.704"></a><span id="l15.704" class="difflineminus">-      charset = (const char*)defaultCharset;</span>
<a href="#l15.705"></a><span id="l15.705" class="difflineminus">-    msgToMatch-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l15.706"></a><span id="l15.706" class="difflineminus">-</span>
<a href="#l15.707"></a><span id="l15.707" class="difflineminus">-    switch (attrib)</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineminus">-    {</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineminus">-      case nsMsgSearchAttrib::Sender:</span>
<a href="#l15.710"></a><span id="l15.710" class="difflineminus">-        msgToMatch-&gt;GetAuthor(getter_Copies(matchString));</span>
<a href="#l15.711"></a><span id="l15.711" class="difflineminus">-        err = aTerm-&gt;MatchRfc822String(matchString, charset, &amp;result);</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-        break;</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineminus">-      case nsMsgSearchAttrib::Subject:</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineminus">-      {</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineminus">-        msgToMatch-&gt;GetSubject(getter_Copies(matchString) /* , true */);</span>
<a href="#l15.716"></a><span id="l15.716" class="difflineminus">-        if (msgFlags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineminus">-        {</span>
<a href="#l15.718"></a><span id="l15.718" class="difflineminus">-          // Make sure we pass along the &quot;Re: &quot; part of the subject if this is a reply.</span>
<a href="#l15.719"></a><span id="l15.719" class="difflineminus">-          nsCString reString;</span>
<a href="#l15.720"></a><span id="l15.720" class="difflineminus">-          reString.AssignLiteral(&quot;Re: &quot;);</span>
<a href="#l15.721"></a><span id="l15.721" class="difflineminus">-          reString.Append(matchString);</span>
<a href="#l15.722"></a><span id="l15.722" class="difflineminus">-          err = aTerm-&gt;MatchRfc2047String(reString, charset, charsetOverride, &amp;result);</span>
<a href="#l15.723"></a><span id="l15.723" class="difflineminus">-        }</span>
<a href="#l15.724"></a><span id="l15.724" class="difflineminus">-        else</span>
<a href="#l15.725"></a><span id="l15.725" class="difflineminus">-          err = aTerm-&gt;MatchRfc2047String(matchString, charset, charsetOverride, &amp;result);</span>
<a href="#l15.726"></a><span id="l15.726" class="difflineminus">-        break;</span>
<a href="#l15.727"></a><span id="l15.727" class="difflineplus">+    case nsMsgSearchAttrib::ToOrCC: {</span>
<a href="#l15.728"></a><span id="l15.728" class="difflineplus">+      bool boolKeepGoing;</span>
<a href="#l15.729"></a><span id="l15.729" class="difflineplus">+      aTerm-&gt;GetMatchAllBeforeDeciding(&amp;boolKeepGoing);</span>
<a href="#l15.730"></a><span id="l15.730" class="difflineplus">+      msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l15.731"></a><span id="l15.731" class="difflineplus">+      err = aTerm-&gt;MatchRfc822String(recipients, charset, &amp;result);</span>
<a href="#l15.732"></a><span id="l15.732" class="difflineplus">+      if (boolKeepGoing == result) {</span>
<a href="#l15.733"></a><span id="l15.733" class="difflineplus">+        msgToMatch-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineplus">+        err = aTerm-&gt;MatchRfc822String(ccList, charset, &amp;result);</span>
<a href="#l15.735"></a><span id="l15.735">       }</span>
<a href="#l15.736"></a><span id="l15.736" class="difflineminus">-      case nsMsgSearchAttrib::ToOrCC:</span>
<a href="#l15.737"></a><span id="l15.737" class="difflineminus">-      {</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineminus">-        bool boolKeepGoing;</span>
<a href="#l15.739"></a><span id="l15.739" class="difflineminus">-        aTerm-&gt;GetMatchAllBeforeDeciding(&amp;boolKeepGoing);</span>
<a href="#l15.740"></a><span id="l15.740" class="difflineminus">-        msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l15.741"></a><span id="l15.741" class="difflineminus">-        err = aTerm-&gt;MatchRfc822String(recipients, charset, &amp;result);</span>
<a href="#l15.742"></a><span id="l15.742" class="difflineminus">-        if (boolKeepGoing == result)</span>
<a href="#l15.743"></a><span id="l15.743" class="difflineminus">-        {</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineminus">-          msgToMatch-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l15.745"></a><span id="l15.745" class="difflineminus">-          err = aTerm-&gt;MatchRfc822String(ccList, charset, &amp;result);</span>
<a href="#l15.746"></a><span id="l15.746" class="difflineminus">-        }</span>
<a href="#l15.747"></a><span id="l15.747" class="difflineminus">-        break;</span>
<a href="#l15.748"></a><span id="l15.748" class="difflineminus">-      }</span>
<a href="#l15.749"></a><span id="l15.749" class="difflineminus">-      case nsMsgSearchAttrib::AllAddresses:</span>
<a href="#l15.750"></a><span id="l15.750" class="difflineminus">-      {</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-        bool boolKeepGoing;</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineminus">-        aTerm-&gt;GetMatchAllBeforeDeciding(&amp;boolKeepGoing);</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineminus">-        msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineminus">-        err = aTerm-&gt;MatchRfc822String(recipients, charset, &amp;result);</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineminus">-        if (boolKeepGoing == result)</span>
<a href="#l15.756"></a><span id="l15.756" class="difflineminus">-        {</span>
<a href="#l15.757"></a><span id="l15.757" class="difflineminus">-          msgToMatch-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l15.758"></a><span id="l15.758" class="difflineminus">-          err = aTerm-&gt;MatchRfc822String(ccList, charset, &amp;result);</span>
<a href="#l15.759"></a><span id="l15.759" class="difflineminus">-        }</span>
<a href="#l15.760"></a><span id="l15.760" class="difflineminus">-        if (boolKeepGoing == result)</span>
<a href="#l15.761"></a><span id="l15.761" class="difflineminus">-        {</span>
<a href="#l15.762"></a><span id="l15.762" class="difflineminus">-          msgToMatch-&gt;GetAuthor(getter_Copies(matchString));</span>
<a href="#l15.763"></a><span id="l15.763" class="difflineminus">-          err = aTerm-&gt;MatchRfc822String(matchString, charset, &amp;result);</span>
<a href="#l15.764"></a><span id="l15.764" class="difflineminus">-        }</span>
<a href="#l15.765"></a><span id="l15.765" class="difflineminus">-        if (boolKeepGoing == result)</span>
<a href="#l15.766"></a><span id="l15.766" class="difflineminus">-        {</span>
<a href="#l15.767"></a><span id="l15.767" class="difflineminus">-          nsCString bccList;</span>
<a href="#l15.768"></a><span id="l15.768" class="difflineminus">-          msgToMatch-&gt;GetBccList(getter_Copies(bccList));</span>
<a href="#l15.769"></a><span id="l15.769" class="difflineminus">-          err = aTerm-&gt;MatchRfc822String(bccList, charset, &amp;result);</span>
<a href="#l15.770"></a><span id="l15.770" class="difflineminus">-        }</span>
<a href="#l15.771"></a><span id="l15.771" class="difflineminus">-        break;</span>
<a href="#l15.772"></a><span id="l15.772" class="difflineminus">-      }</span>
<a href="#l15.773"></a><span id="l15.773" class="difflineminus">-      case nsMsgSearchAttrib::Body:</span>
<a href="#l15.774"></a><span id="l15.774" class="difflineminus">-       {</span>
<a href="#l15.775"></a><span id="l15.775" class="difflineminus">-         uint64_t messageOffset;</span>
<a href="#l15.776"></a><span id="l15.776" class="difflineminus">-         uint32_t lineCount;</span>
<a href="#l15.777"></a><span id="l15.777" class="difflineminus">-         msgToMatch-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l15.778"></a><span id="l15.778" class="difflineminus">-         msgToMatch-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l15.779"></a><span id="l15.779" class="difflineminus">-         err = aTerm-&gt;MatchBody (scope, messageOffset, lineCount, charset, msgToMatch, db, &amp;result);</span>
<a href="#l15.780"></a><span id="l15.780" class="difflineminus">-         break;</span>
<a href="#l15.781"></a><span id="l15.781" class="difflineminus">-       }</span>
<a href="#l15.782"></a><span id="l15.782" class="difflineminus">-      case nsMsgSearchAttrib::Date:</span>
<a href="#l15.783"></a><span id="l15.783" class="difflineminus">-      {</span>
<a href="#l15.784"></a><span id="l15.784" class="difflineminus">-        PRTime date;</span>
<a href="#l15.785"></a><span id="l15.785" class="difflineminus">-        msgToMatch-&gt;GetDate(&amp;date);</span>
<a href="#l15.786"></a><span id="l15.786" class="difflineminus">-        err = aTerm-&gt;MatchDate (date, &amp;result);</span>
<a href="#l15.787"></a><span id="l15.787" class="difflineminus">-</span>
<a href="#l15.788"></a><span id="l15.788" class="difflineminus">-        break;</span>
<a href="#l15.789"></a><span id="l15.789" class="difflineminus">-      }</span>
<a href="#l15.790"></a><span id="l15.790" class="difflineminus">-      case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l15.791"></a><span id="l15.791" class="difflineminus">-      case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l15.792"></a><span id="l15.792" class="difflineminus">-        err = aTerm-&gt;MatchStatus (msgFlags, &amp;result);</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineminus">-        break;</span>
<a href="#l15.794"></a><span id="l15.794" class="difflineminus">-      case nsMsgSearchAttrib::Priority:</span>
<a href="#l15.795"></a><span id="l15.795" class="difflineminus">-      {</span>
<a href="#l15.796"></a><span id="l15.796" class="difflineminus">-        nsMsgPriorityValue msgPriority;</span>
<a href="#l15.797"></a><span id="l15.797" class="difflineminus">-        msgToMatch-&gt;GetPriority(&amp;msgPriority);</span>
<a href="#l15.798"></a><span id="l15.798" class="difflineminus">-        err = aTerm-&gt;MatchPriority (msgPriority, &amp;result);</span>
<a href="#l15.799"></a><span id="l15.799" class="difflineminus">-        break;</span>
<a href="#l15.800"></a><span id="l15.800" class="difflineminus">-      }</span>
<a href="#l15.801"></a><span id="l15.801" class="difflineminus">-      case nsMsgSearchAttrib::Size:</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineminus">-      {</span>
<a href="#l15.803"></a><span id="l15.803" class="difflineminus">-        uint32_t messageSize;</span>
<a href="#l15.804"></a><span id="l15.804" class="difflineminus">-        msgToMatch-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l15.805"></a><span id="l15.805" class="difflineminus">-        err = aTerm-&gt;MatchSize (messageSize, &amp;result);</span>
<a href="#l15.806"></a><span id="l15.806" class="difflineminus">-        break;</span>
<a href="#l15.807"></a><span id="l15.807" class="difflineminus">-      }</span>
<a href="#l15.808"></a><span id="l15.808" class="difflineminus">-      case nsMsgSearchAttrib::To:</span>
<a href="#l15.809"></a><span id="l15.809" class="difflineminus">-        msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l15.810"></a><span id="l15.810" class="difflineminus">-        err = aTerm-&gt;MatchRfc822String(recipients, charset, &amp;result);</span>
<a href="#l15.811"></a><span id="l15.811" class="difflineminus">-        break;</span>
<a href="#l15.812"></a><span id="l15.812" class="difflineminus">-      case nsMsgSearchAttrib::CC:</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineplus">+      break;</span>
<a href="#l15.814"></a><span id="l15.814" class="difflineplus">+    }</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineplus">+    case nsMsgSearchAttrib::AllAddresses: {</span>
<a href="#l15.816"></a><span id="l15.816" class="difflineplus">+      bool boolKeepGoing;</span>
<a href="#l15.817"></a><span id="l15.817" class="difflineplus">+      aTerm-&gt;GetMatchAllBeforeDeciding(&amp;boolKeepGoing);</span>
<a href="#l15.818"></a><span id="l15.818" class="difflineplus">+      msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l15.819"></a><span id="l15.819" class="difflineplus">+      err = aTerm-&gt;MatchRfc822String(recipients, charset, &amp;result);</span>
<a href="#l15.820"></a><span id="l15.820" class="difflineplus">+      if (boolKeepGoing == result) {</span>
<a href="#l15.821"></a><span id="l15.821">         msgToMatch-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l15.822"></a><span id="l15.822">         err = aTerm-&gt;MatchRfc822String(ccList, charset, &amp;result);</span>
<a href="#l15.823"></a><span id="l15.823" class="difflineminus">-        break;</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineminus">-      case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l15.825"></a><span id="l15.825" class="difflineminus">-      {</span>
<a href="#l15.826"></a><span id="l15.826" class="difflineminus">-        PRTime date;</span>
<a href="#l15.827"></a><span id="l15.827" class="difflineminus">-        msgToMatch-&gt;GetDate(&amp;date);</span>
<a href="#l15.828"></a><span id="l15.828" class="difflineminus">-        err = aTerm-&gt;MatchAge (date, &amp;result);</span>
<a href="#l15.829"></a><span id="l15.829" class="difflineminus">-        break;</span>
<a href="#l15.830"></a><span id="l15.830" class="difflineminus">-       }</span>
<a href="#l15.831"></a><span id="l15.831" class="difflineminus">-      case nsMsgSearchAttrib::Label:</span>
<a href="#l15.832"></a><span id="l15.832" class="difflineminus">-      {</span>
<a href="#l15.833"></a><span id="l15.833" class="difflineminus">-         nsMsgLabelValue label;</span>
<a href="#l15.834"></a><span id="l15.834" class="difflineminus">-         msgToMatch-&gt;GetLabel(&amp;label);</span>
<a href="#l15.835"></a><span id="l15.835" class="difflineminus">-         err = aTerm-&gt;MatchLabel(label, &amp;result);</span>
<a href="#l15.836"></a><span id="l15.836" class="difflineminus">-         break;</span>
<a href="#l15.837"></a><span id="l15.837" class="difflineplus">+      }</span>
<a href="#l15.838"></a><span id="l15.838" class="difflineplus">+      if (boolKeepGoing == result) {</span>
<a href="#l15.839"></a><span id="l15.839" class="difflineplus">+        msgToMatch-&gt;GetAuthor(getter_Copies(matchString));</span>
<a href="#l15.840"></a><span id="l15.840" class="difflineplus">+        err = aTerm-&gt;MatchRfc822String(matchString, charset, &amp;result);</span>
<a href="#l15.841"></a><span id="l15.841" class="difflineplus">+      }</span>
<a href="#l15.842"></a><span id="l15.842" class="difflineplus">+      if (boolKeepGoing == result) {</span>
<a href="#l15.843"></a><span id="l15.843" class="difflineplus">+        nsCString bccList;</span>
<a href="#l15.844"></a><span id="l15.844" class="difflineplus">+        msgToMatch-&gt;GetBccList(getter_Copies(bccList));</span>
<a href="#l15.845"></a><span id="l15.845" class="difflineplus">+        err = aTerm-&gt;MatchRfc822String(bccList, charset, &amp;result);</span>
<a href="#l15.846"></a><span id="l15.846">       }</span>
<a href="#l15.847"></a><span id="l15.847" class="difflineminus">-      case nsMsgSearchAttrib::Keywords:</span>
<a href="#l15.848"></a><span id="l15.848" class="difflineminus">-      {</span>
<a href="#l15.849"></a><span id="l15.849" class="difflineminus">-          nsCString keywords;</span>
<a href="#l15.850"></a><span id="l15.850" class="difflineminus">-          nsMsgLabelValue label;</span>
<a href="#l15.851"></a><span id="l15.851" class="difflineminus">-          msgToMatch-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l15.852"></a><span id="l15.852" class="difflineminus">-          msgToMatch-&gt;GetLabel(&amp;label);</span>
<a href="#l15.853"></a><span id="l15.853" class="difflineminus">-          if (label &gt;= 1)</span>
<a href="#l15.854"></a><span id="l15.854" class="difflineminus">-          {</span>
<a href="#l15.855"></a><span id="l15.855" class="difflineminus">-            if (!keywords.IsEmpty())</span>
<a href="#l15.856"></a><span id="l15.856" class="difflineminus">-              keywords.Append(' ');</span>
<a href="#l15.857"></a><span id="l15.857" class="difflineminus">-            keywords.AppendLiteral(&quot;$label&quot;);</span>
<a href="#l15.858"></a><span id="l15.858" class="difflineminus">-            keywords.Append(label + '0');</span>
<a href="#l15.859"></a><span id="l15.859" class="difflineminus">-          }</span>
<a href="#l15.860"></a><span id="l15.860" class="difflineminus">-          err = aTerm-&gt;MatchKeyword(keywords, &amp;result);</span>
<a href="#l15.861"></a><span id="l15.861" class="difflineminus">-          break;</span>
<a href="#l15.862"></a><span id="l15.862" class="difflineplus">+      break;</span>
<a href="#l15.863"></a><span id="l15.863" class="difflineplus">+    }</span>
<a href="#l15.864"></a><span id="l15.864" class="difflineplus">+    case nsMsgSearchAttrib::Body: {</span>
<a href="#l15.865"></a><span id="l15.865" class="difflineplus">+      uint64_t messageOffset;</span>
<a href="#l15.866"></a><span id="l15.866" class="difflineplus">+      uint32_t lineCount;</span>
<a href="#l15.867"></a><span id="l15.867" class="difflineplus">+      msgToMatch-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l15.868"></a><span id="l15.868" class="difflineplus">+      msgToMatch-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l15.869"></a><span id="l15.869" class="difflineplus">+      err = aTerm-&gt;MatchBody(scope, messageOffset, lineCount, charset,</span>
<a href="#l15.870"></a><span id="l15.870" class="difflineplus">+                             msgToMatch, db, &amp;result);</span>
<a href="#l15.871"></a><span id="l15.871" class="difflineplus">+      break;</span>
<a href="#l15.872"></a><span id="l15.872" class="difflineplus">+    }</span>
<a href="#l15.873"></a><span id="l15.873" class="difflineplus">+    case nsMsgSearchAttrib::Date: {</span>
<a href="#l15.874"></a><span id="l15.874" class="difflineplus">+      PRTime date;</span>
<a href="#l15.875"></a><span id="l15.875" class="difflineplus">+      msgToMatch-&gt;GetDate(&amp;date);</span>
<a href="#l15.876"></a><span id="l15.876" class="difflineplus">+      err = aTerm-&gt;MatchDate(date, &amp;result);</span>
<a href="#l15.877"></a><span id="l15.877" class="difflineplus">+</span>
<a href="#l15.878"></a><span id="l15.878" class="difflineplus">+      break;</span>
<a href="#l15.879"></a><span id="l15.879" class="difflineplus">+    }</span>
<a href="#l15.880"></a><span id="l15.880" class="difflineplus">+    case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l15.881"></a><span id="l15.881" class="difflineplus">+    case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l15.882"></a><span id="l15.882" class="difflineplus">+      err = aTerm-&gt;MatchStatus(msgFlags, &amp;result);</span>
<a href="#l15.883"></a><span id="l15.883" class="difflineplus">+      break;</span>
<a href="#l15.884"></a><span id="l15.884" class="difflineplus">+    case nsMsgSearchAttrib::Priority: {</span>
<a href="#l15.885"></a><span id="l15.885" class="difflineplus">+      nsMsgPriorityValue msgPriority;</span>
<a href="#l15.886"></a><span id="l15.886" class="difflineplus">+      msgToMatch-&gt;GetPriority(&amp;msgPriority);</span>
<a href="#l15.887"></a><span id="l15.887" class="difflineplus">+      err = aTerm-&gt;MatchPriority(msgPriority, &amp;result);</span>
<a href="#l15.888"></a><span id="l15.888" class="difflineplus">+      break;</span>
<a href="#l15.889"></a><span id="l15.889" class="difflineplus">+    }</span>
<a href="#l15.890"></a><span id="l15.890" class="difflineplus">+    case nsMsgSearchAttrib::Size: {</span>
<a href="#l15.891"></a><span id="l15.891" class="difflineplus">+      uint32_t messageSize;</span>
<a href="#l15.892"></a><span id="l15.892" class="difflineplus">+      msgToMatch-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l15.893"></a><span id="l15.893" class="difflineplus">+      err = aTerm-&gt;MatchSize(messageSize, &amp;result);</span>
<a href="#l15.894"></a><span id="l15.894" class="difflineplus">+      break;</span>
<a href="#l15.895"></a><span id="l15.895" class="difflineplus">+    }</span>
<a href="#l15.896"></a><span id="l15.896" class="difflineplus">+    case nsMsgSearchAttrib::To:</span>
<a href="#l15.897"></a><span id="l15.897" class="difflineplus">+      msgToMatch-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l15.898"></a><span id="l15.898" class="difflineplus">+      err = aTerm-&gt;MatchRfc822String(recipients, charset, &amp;result);</span>
<a href="#l15.899"></a><span id="l15.899" class="difflineplus">+      break;</span>
<a href="#l15.900"></a><span id="l15.900" class="difflineplus">+    case nsMsgSearchAttrib::CC:</span>
<a href="#l15.901"></a><span id="l15.901" class="difflineplus">+      msgToMatch-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l15.902"></a><span id="l15.902" class="difflineplus">+      err = aTerm-&gt;MatchRfc822String(ccList, charset, &amp;result);</span>
<a href="#l15.903"></a><span id="l15.903" class="difflineplus">+      break;</span>
<a href="#l15.904"></a><span id="l15.904" class="difflineplus">+    case nsMsgSearchAttrib::AgeInDays: {</span>
<a href="#l15.905"></a><span id="l15.905" class="difflineplus">+      PRTime date;</span>
<a href="#l15.906"></a><span id="l15.906" class="difflineplus">+      msgToMatch-&gt;GetDate(&amp;date);</span>
<a href="#l15.907"></a><span id="l15.907" class="difflineplus">+      err = aTerm-&gt;MatchAge(date, &amp;result);</span>
<a href="#l15.908"></a><span id="l15.908" class="difflineplus">+      break;</span>
<a href="#l15.909"></a><span id="l15.909" class="difflineplus">+    }</span>
<a href="#l15.910"></a><span id="l15.910" class="difflineplus">+    case nsMsgSearchAttrib::Label: {</span>
<a href="#l15.911"></a><span id="l15.911" class="difflineplus">+      nsMsgLabelValue label;</span>
<a href="#l15.912"></a><span id="l15.912" class="difflineplus">+      msgToMatch-&gt;GetLabel(&amp;label);</span>
<a href="#l15.913"></a><span id="l15.913" class="difflineplus">+      err = aTerm-&gt;MatchLabel(label, &amp;result);</span>
<a href="#l15.914"></a><span id="l15.914" class="difflineplus">+      break;</span>
<a href="#l15.915"></a><span id="l15.915" class="difflineplus">+    }</span>
<a href="#l15.916"></a><span id="l15.916" class="difflineplus">+    case nsMsgSearchAttrib::Keywords: {</span>
<a href="#l15.917"></a><span id="l15.917" class="difflineplus">+      nsCString keywords;</span>
<a href="#l15.918"></a><span id="l15.918" class="difflineplus">+      nsMsgLabelValue label;</span>
<a href="#l15.919"></a><span id="l15.919" class="difflineplus">+      msgToMatch-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l15.920"></a><span id="l15.920" class="difflineplus">+      msgToMatch-&gt;GetLabel(&amp;label);</span>
<a href="#l15.921"></a><span id="l15.921" class="difflineplus">+      if (label &gt;= 1) {</span>
<a href="#l15.922"></a><span id="l15.922" class="difflineplus">+        if (!keywords.IsEmpty()) keywords.Append(' ');</span>
<a href="#l15.923"></a><span id="l15.923" class="difflineplus">+        keywords.AppendLiteral(&quot;$label&quot;);</span>
<a href="#l15.924"></a><span id="l15.924" class="difflineplus">+        keywords.Append(label + '0');</span>
<a href="#l15.925"></a><span id="l15.925">       }</span>
<a href="#l15.926"></a><span id="l15.926" class="difflineminus">-      case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l15.927"></a><span id="l15.927" class="difflineminus">-      {</span>
<a href="#l15.928"></a><span id="l15.928" class="difflineminus">-         nsCString junkScoreStr;</span>
<a href="#l15.929"></a><span id="l15.929" class="difflineminus">-         msgToMatch-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l15.930"></a><span id="l15.930" class="difflineminus">-         err = aTerm-&gt;MatchJunkStatus(junkScoreStr.get(), &amp;result);</span>
<a href="#l15.931"></a><span id="l15.931" class="difflineminus">-         break;</span>
<a href="#l15.932"></a><span id="l15.932" class="difflineminus">-      }</span>
<a href="#l15.933"></a><span id="l15.933" class="difflineminus">-      case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l15.934"></a><span id="l15.934" class="difflineminus">-      {</span>
<a href="#l15.935"></a><span id="l15.935" class="difflineminus">-        // When the junk status is set by the plugin, use junkpercent (if available)</span>
<a href="#l15.936"></a><span id="l15.936" class="difflineminus">-        // Otherwise, use the limits (0 or 100) depending on the junkscore.</span>
<a href="#l15.937"></a><span id="l15.937" class="difflineminus">-        uint32_t junkPercent;</span>
<a href="#l15.938"></a><span id="l15.938" class="difflineminus">-        nsresult rv;</span>
<a href="#l15.939"></a><span id="l15.939" class="difflineminus">-        nsCString junkScoreOriginStr;</span>
<a href="#l15.940"></a><span id="l15.940" class="difflineminus">-        nsCString junkPercentStr;</span>
<a href="#l15.941"></a><span id="l15.941" class="difflineminus">-        msgToMatch-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(junkScoreOriginStr));</span>
<a href="#l15.942"></a><span id="l15.942" class="difflineminus">-        msgToMatch-&gt;GetStringProperty(&quot;junkpercent&quot;, getter_Copies(junkPercentStr));</span>
<a href="#l15.943"></a><span id="l15.943" class="difflineminus">-        if ( junkScoreOriginStr.EqualsLiteral(&quot;plugin&quot;) &amp;&amp;</span>
<a href="#l15.944"></a><span id="l15.944" class="difflineminus">-            !junkPercentStr.IsEmpty())</span>
<a href="#l15.945"></a><span id="l15.945" class="difflineminus">-        {</span>
<a href="#l15.946"></a><span id="l15.946" class="difflineminus">-          junkPercent = junkPercentStr.ToInteger(&amp;rv);</span>
<a href="#l15.947"></a><span id="l15.947" class="difflineplus">+      err = aTerm-&gt;MatchKeyword(keywords, &amp;result);</span>
<a href="#l15.948"></a><span id="l15.948" class="difflineplus">+      break;</span>
<a href="#l15.949"></a><span id="l15.949" class="difflineplus">+    }</span>
<a href="#l15.950"></a><span id="l15.950" class="difflineplus">+    case nsMsgSearchAttrib::JunkStatus: {</span>
<a href="#l15.951"></a><span id="l15.951" class="difflineplus">+      nsCString junkScoreStr;</span>
<a href="#l15.952"></a><span id="l15.952" class="difflineplus">+      msgToMatch-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l15.953"></a><span id="l15.953" class="difflineplus">+      err = aTerm-&gt;MatchJunkStatus(junkScoreStr.get(), &amp;result);</span>
<a href="#l15.954"></a><span id="l15.954" class="difflineplus">+      break;</span>
<a href="#l15.955"></a><span id="l15.955" class="difflineplus">+    }</span>
<a href="#l15.956"></a><span id="l15.956" class="difflineplus">+    case nsMsgSearchAttrib::JunkPercent: {</span>
<a href="#l15.957"></a><span id="l15.957" class="difflineplus">+      // When the junk status is set by the plugin, use junkpercent (if</span>
<a href="#l15.958"></a><span id="l15.958" class="difflineplus">+      // available) Otherwise, use the limits (0 or 100) depending on the</span>
<a href="#l15.959"></a><span id="l15.959" class="difflineplus">+      // junkscore.</span>
<a href="#l15.960"></a><span id="l15.960" class="difflineplus">+      uint32_t junkPercent;</span>
<a href="#l15.961"></a><span id="l15.961" class="difflineplus">+      nsresult rv;</span>
<a href="#l15.962"></a><span id="l15.962" class="difflineplus">+      nsCString junkScoreOriginStr;</span>
<a href="#l15.963"></a><span id="l15.963" class="difflineplus">+      nsCString junkPercentStr;</span>
<a href="#l15.964"></a><span id="l15.964" class="difflineplus">+      msgToMatch-&gt;GetStringProperty(&quot;junkscoreorigin&quot;,</span>
<a href="#l15.965"></a><span id="l15.965" class="difflineplus">+                                    getter_Copies(junkScoreOriginStr));</span>
<a href="#l15.966"></a><span id="l15.966" class="difflineplus">+      msgToMatch-&gt;GetStringProperty(&quot;junkpercent&quot;,</span>
<a href="#l15.967"></a><span id="l15.967" class="difflineplus">+                                    getter_Copies(junkPercentStr));</span>
<a href="#l15.968"></a><span id="l15.968" class="difflineplus">+      if (junkScoreOriginStr.EqualsLiteral(&quot;plugin&quot;) &amp;&amp;</span>
<a href="#l15.969"></a><span id="l15.969" class="difflineplus">+          !junkPercentStr.IsEmpty()) {</span>
<a href="#l15.970"></a><span id="l15.970" class="difflineplus">+        junkPercent = junkPercentStr.ToInteger(&amp;rv);</span>
<a href="#l15.971"></a><span id="l15.971" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.972"></a><span id="l15.972" class="difflineplus">+      } else {</span>
<a href="#l15.973"></a><span id="l15.973" class="difflineplus">+        nsCString junkScoreStr;</span>
<a href="#l15.974"></a><span id="l15.974" class="difflineplus">+        msgToMatch-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l15.975"></a><span id="l15.975" class="difflineplus">+        // When junk status is not set (uncertain) we'll set the value to ham.</span>
<a href="#l15.976"></a><span id="l15.976" class="difflineplus">+        if (junkScoreStr.IsEmpty())</span>
<a href="#l15.977"></a><span id="l15.977" class="difflineplus">+          junkPercent = nsIJunkMailPlugin::IS_HAM_SCORE;</span>
<a href="#l15.978"></a><span id="l15.978" class="difflineplus">+        else {</span>
<a href="#l15.979"></a><span id="l15.979" class="difflineplus">+          junkPercent = junkScoreStr.ToInteger(&amp;rv);</span>
<a href="#l15.980"></a><span id="l15.980">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.981"></a><span id="l15.981">         }</span>
<a href="#l15.982"></a><span id="l15.982" class="difflineminus">-        else</span>
<a href="#l15.983"></a><span id="l15.983" class="difflineminus">-        {</span>
<a href="#l15.984"></a><span id="l15.984" class="difflineminus">-          nsCString junkScoreStr;</span>
<a href="#l15.985"></a><span id="l15.985" class="difflineminus">-          msgToMatch-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l15.986"></a><span id="l15.986" class="difflineminus">-          // When junk status is not set (uncertain) we'll set the value to ham.</span>
<a href="#l15.987"></a><span id="l15.987" class="difflineminus">-          if (junkScoreStr.IsEmpty())</span>
<a href="#l15.988"></a><span id="l15.988" class="difflineminus">-            junkPercent = nsIJunkMailPlugin::IS_HAM_SCORE;</span>
<a href="#l15.989"></a><span id="l15.989" class="difflineminus">-          else</span>
<a href="#l15.990"></a><span id="l15.990" class="difflineminus">-          {</span>
<a href="#l15.991"></a><span id="l15.991" class="difflineminus">-            junkPercent = junkScoreStr.ToInteger(&amp;rv);</span>
<a href="#l15.992"></a><span id="l15.992" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.993"></a><span id="l15.993" class="difflineminus">-          }</span>
<a href="#l15.994"></a><span id="l15.994" class="difflineminus">-        }</span>
<a href="#l15.995"></a><span id="l15.995" class="difflineminus">-        err = aTerm-&gt;MatchJunkPercent(junkPercent, &amp;result);</span>
<a href="#l15.996"></a><span id="l15.996" class="difflineminus">-        break;</span>
<a href="#l15.997"></a><span id="l15.997" class="difflineminus">-      }</span>
<a href="#l15.998"></a><span id="l15.998" class="difflineminus">-      case nsMsgSearchAttrib::JunkScoreOrigin:</span>
<a href="#l15.999"></a><span id="l15.999" class="difflineminus">-      {</span>
<a href="#l15.1000"></a><span id="l15.1000" class="difflineminus">-         nsCString junkScoreOriginStr;</span>
<a href="#l15.1001"></a><span id="l15.1001" class="difflineminus">-         msgToMatch-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(junkScoreOriginStr));</span>
<a href="#l15.1002"></a><span id="l15.1002" class="difflineminus">-         err = aTerm-&gt;MatchJunkScoreOrigin(junkScoreOriginStr.get(), &amp;result);</span>
<a href="#l15.1003"></a><span id="l15.1003" class="difflineminus">-         break;</span>
<a href="#l15.1004"></a><span id="l15.1004" class="difflineminus">-      }</span>
<a href="#l15.1005"></a><span id="l15.1005" class="difflineminus">-      case nsMsgSearchAttrib::HdrProperty:</span>
<a href="#l15.1006"></a><span id="l15.1006" class="difflineminus">-      {</span>
<a href="#l15.1007"></a><span id="l15.1007" class="difflineminus">-        err = aTerm-&gt;MatchHdrProperty(msgToMatch, &amp;result);</span>
<a href="#l15.1008"></a><span id="l15.1008" class="difflineminus">-        break;</span>
<a href="#l15.1009"></a><span id="l15.1009" class="difflineminus">-      }</span>
<a href="#l15.1010"></a><span id="l15.1010" class="difflineminus">-      case nsMsgSearchAttrib::Uint32HdrProperty:</span>
<a href="#l15.1011"></a><span id="l15.1011" class="difflineminus">-      {</span>
<a href="#l15.1012"></a><span id="l15.1012" class="difflineminus">-        err = aTerm-&gt;MatchUint32HdrProperty(msgToMatch, &amp;result);</span>
<a href="#l15.1013"></a><span id="l15.1013" class="difflineminus">-        break;</span>
<a href="#l15.1014"></a><span id="l15.1014">       }</span>
<a href="#l15.1015"></a><span id="l15.1015" class="difflineminus">-      case nsMsgSearchAttrib::Custom:</span>
<a href="#l15.1016"></a><span id="l15.1016" class="difflineminus">-      {</span>
<a href="#l15.1017"></a><span id="l15.1017" class="difflineminus">-        err = aTerm-&gt;MatchCustom(msgToMatch, &amp;result);</span>
<a href="#l15.1018"></a><span id="l15.1018" class="difflineminus">-        break;</span>
<a href="#l15.1019"></a><span id="l15.1019" class="difflineminus">-      }</span>
<a href="#l15.1020"></a><span id="l15.1020" class="difflineminus">-      case nsMsgSearchAttrib::FolderFlag:</span>
<a href="#l15.1021"></a><span id="l15.1021" class="difflineminus">-      {</span>
<a href="#l15.1022"></a><span id="l15.1022" class="difflineminus">-        err = aTerm-&gt;MatchFolderFlag(msgToMatch, &amp;result);</span>
<a href="#l15.1023"></a><span id="l15.1023" class="difflineminus">-        break;</span>
<a href="#l15.1024"></a><span id="l15.1024" class="difflineplus">+      err = aTerm-&gt;MatchJunkPercent(junkPercent, &amp;result);</span>
<a href="#l15.1025"></a><span id="l15.1025" class="difflineplus">+      break;</span>
<a href="#l15.1026"></a><span id="l15.1026" class="difflineplus">+    }</span>
<a href="#l15.1027"></a><span id="l15.1027" class="difflineplus">+    case nsMsgSearchAttrib::JunkScoreOrigin: {</span>
<a href="#l15.1028"></a><span id="l15.1028" class="difflineplus">+      nsCString junkScoreOriginStr;</span>
<a href="#l15.1029"></a><span id="l15.1029" class="difflineplus">+      msgToMatch-&gt;GetStringProperty(&quot;junkscoreorigin&quot;,</span>
<a href="#l15.1030"></a><span id="l15.1030" class="difflineplus">+                                    getter_Copies(junkScoreOriginStr));</span>
<a href="#l15.1031"></a><span id="l15.1031" class="difflineplus">+      err = aTerm-&gt;MatchJunkScoreOrigin(junkScoreOriginStr.get(), &amp;result);</span>
<a href="#l15.1032"></a><span id="l15.1032" class="difflineplus">+      break;</span>
<a href="#l15.1033"></a><span id="l15.1033" class="difflineplus">+    }</span>
<a href="#l15.1034"></a><span id="l15.1034" class="difflineplus">+    case nsMsgSearchAttrib::HdrProperty: {</span>
<a href="#l15.1035"></a><span id="l15.1035" class="difflineplus">+      err = aTerm-&gt;MatchHdrProperty(msgToMatch, &amp;result);</span>
<a href="#l15.1036"></a><span id="l15.1036" class="difflineplus">+      break;</span>
<a href="#l15.1037"></a><span id="l15.1037" class="difflineplus">+    }</span>
<a href="#l15.1038"></a><span id="l15.1038" class="difflineplus">+    case nsMsgSearchAttrib::Uint32HdrProperty: {</span>
<a href="#l15.1039"></a><span id="l15.1039" class="difflineplus">+      err = aTerm-&gt;MatchUint32HdrProperty(msgToMatch, &amp;result);</span>
<a href="#l15.1040"></a><span id="l15.1040" class="difflineplus">+      break;</span>
<a href="#l15.1041"></a><span id="l15.1041" class="difflineplus">+    }</span>
<a href="#l15.1042"></a><span id="l15.1042" class="difflineplus">+    case nsMsgSearchAttrib::Custom: {</span>
<a href="#l15.1043"></a><span id="l15.1043" class="difflineplus">+      err = aTerm-&gt;MatchCustom(msgToMatch, &amp;result);</span>
<a href="#l15.1044"></a><span id="l15.1044" class="difflineplus">+      break;</span>
<a href="#l15.1045"></a><span id="l15.1045" class="difflineplus">+    }</span>
<a href="#l15.1046"></a><span id="l15.1046" class="difflineplus">+    case nsMsgSearchAttrib::FolderFlag: {</span>
<a href="#l15.1047"></a><span id="l15.1047" class="difflineplus">+      err = aTerm-&gt;MatchFolderFlag(msgToMatch, &amp;result);</span>
<a href="#l15.1048"></a><span id="l15.1048" class="difflineplus">+      break;</span>
<a href="#l15.1049"></a><span id="l15.1049" class="difflineplus">+    }</span>
<a href="#l15.1050"></a><span id="l15.1050" class="difflineplus">+    default:</span>
<a href="#l15.1051"></a><span id="l15.1051" class="difflineplus">+      // XXX todo</span>
<a href="#l15.1052"></a><span id="l15.1052" class="difflineplus">+      // for the temporary return receipts filters, we use a custom header for</span>
<a href="#l15.1053"></a><span id="l15.1053" class="difflineplus">+      // Content-Type but unlike the other custom headers, this one doesn't show</span>
<a href="#l15.1054"></a><span id="l15.1054" class="difflineplus">+      // up in the search / filter UI.  we set the attrib to be</span>
<a href="#l15.1055"></a><span id="l15.1055" class="difflineplus">+      // nsMsgSearchAttrib::OtherHeader, where as for user defined custom</span>
<a href="#l15.1056"></a><span id="l15.1056" class="difflineplus">+      // headers start at nsMsgSearchAttrib::OtherHeader + 1 Not sure if there</span>
<a href="#l15.1057"></a><span id="l15.1057" class="difflineplus">+      // is a better way to do this yet.  Maybe reserve the last custom header</span>
<a href="#l15.1058"></a><span id="l15.1058" class="difflineplus">+      // for ::Content-Type?  But if we do, make sure that change doesn't cause</span>
<a href="#l15.1059"></a><span id="l15.1059" class="difflineplus">+      // nsMsgFilter::GetTerm() to change, and start making us ask IMAP servers</span>
<a href="#l15.1060"></a><span id="l15.1060" class="difflineplus">+      // for the Content-Type header on all messages.</span>
<a href="#l15.1061"></a><span id="l15.1061" class="difflineplus">+      if (attrib &gt;= nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l15.1062"></a><span id="l15.1062" class="difflineplus">+          attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes) {</span>
<a href="#l15.1063"></a><span id="l15.1063" class="difflineplus">+        uint32_t lineCount;</span>
<a href="#l15.1064"></a><span id="l15.1064" class="difflineplus">+        msgToMatch-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l15.1065"></a><span id="l15.1065" class="difflineplus">+        uint64_t messageOffset;</span>
<a href="#l15.1066"></a><span id="l15.1066" class="difflineplus">+        msgToMatch-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l15.1067"></a><span id="l15.1067" class="difflineplus">+        err = aTerm-&gt;MatchArbitraryHeader(scope, lineCount, charset,</span>
<a href="#l15.1068"></a><span id="l15.1068" class="difflineplus">+                                          charsetOverride, msgToMatch, db,</span>
<a href="#l15.1069"></a><span id="l15.1069" class="difflineplus">+                                          headers, Filtering, &amp;result);</span>
<a href="#l15.1070"></a><span id="l15.1070" class="difflineplus">+      } else {</span>
<a href="#l15.1071"></a><span id="l15.1071" class="difflineplus">+        err = NS_ERROR_INVALID_ARG;  // ### was SearchError_InvalidAttribute</span>
<a href="#l15.1072"></a><span id="l15.1072" class="difflineplus">+        result = false;</span>
<a href="#l15.1073"></a><span id="l15.1073">       }</span>
<a href="#l15.1074"></a><span id="l15.1074" class="difflineminus">-      default:</span>
<a href="#l15.1075"></a><span id="l15.1075" class="difflineminus">-          // XXX todo</span>
<a href="#l15.1076"></a><span id="l15.1076" class="difflineminus">-          // for the temporary return receipts filters, we use a custom header for Content-Type</span>
<a href="#l15.1077"></a><span id="l15.1077" class="difflineminus">-          // but unlike the other custom headers, this one doesn't show up in the search / filter</span>
<a href="#l15.1078"></a><span id="l15.1078" class="difflineminus">-          // UI.  we set the attrib to be nsMsgSearchAttrib::OtherHeader, where as for user</span>
<a href="#l15.1079"></a><span id="l15.1079" class="difflineminus">-          // defined custom headers start at nsMsgSearchAttrib::OtherHeader + 1</span>
<a href="#l15.1080"></a><span id="l15.1080" class="difflineminus">-          // Not sure if there is a better way to do this yet.  Maybe reserve the last</span>
<a href="#l15.1081"></a><span id="l15.1081" class="difflineminus">-          // custom header for ::Content-Type?  But if we do, make sure that change</span>
<a href="#l15.1082"></a><span id="l15.1082" class="difflineminus">-          // doesn't cause nsMsgFilter::GetTerm() to change, and start making us</span>
<a href="#l15.1083"></a><span id="l15.1083" class="difflineminus">-          // ask IMAP servers for the Content-Type header on all messages.</span>
<a href="#l15.1084"></a><span id="l15.1084" class="difflineminus">-          if (attrib &gt;= nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l15.1085"></a><span id="l15.1085" class="difflineminus">-              attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l15.1086"></a><span id="l15.1086" class="difflineminus">-          {</span>
<a href="#l15.1087"></a><span id="l15.1087" class="difflineminus">-            uint32_t lineCount;</span>
<a href="#l15.1088"></a><span id="l15.1088" class="difflineminus">-            msgToMatch-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l15.1089"></a><span id="l15.1089" class="difflineminus">-            uint64_t messageOffset;</span>
<a href="#l15.1090"></a><span id="l15.1090" class="difflineminus">-            msgToMatch-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l15.1091"></a><span id="l15.1091" class="difflineminus">-            err = aTerm-&gt;MatchArbitraryHeader(scope, lineCount,charset,</span>
<a href="#l15.1092"></a><span id="l15.1092" class="difflineminus">-                                              charsetOverride, msgToMatch, db,</span>
<a href="#l15.1093"></a><span id="l15.1093" class="difflineminus">-                                              headers, Filtering, &amp;result);</span>
<a href="#l15.1094"></a><span id="l15.1094" class="difflineminus">-          }</span>
<a href="#l15.1095"></a><span id="l15.1095" class="difflineminus">-          else {</span>
<a href="#l15.1096"></a><span id="l15.1096" class="difflineminus">-            err = NS_ERROR_INVALID_ARG; // ### was SearchError_InvalidAttribute</span>
<a href="#l15.1097"></a><span id="l15.1097" class="difflineminus">-            result = false;</span>
<a href="#l15.1098"></a><span id="l15.1098" class="difflineminus">-          }</span>
<a href="#l15.1099"></a><span id="l15.1099" class="difflineminus">-    }</span>
<a href="#l15.1100"></a><span id="l15.1100" class="difflineplus">+  }</span>
<a href="#l15.1101"></a><span id="l15.1101"> </span>
<a href="#l15.1102"></a><span id="l15.1102" class="difflineminus">-    *pResult = result;</span>
<a href="#l15.1103"></a><span id="l15.1103" class="difflineminus">-    return err;</span>
<a href="#l15.1104"></a><span id="l15.1104" class="difflineplus">+  *pResult = result;</span>
<a href="#l15.1105"></a><span id="l15.1105" class="difflineplus">+  return err;</span>
<a href="#l15.1106"></a><span id="l15.1106"> }</span>
<a href="#l15.1107"></a><span id="l15.1107"> </span>
<a href="#l15.1108"></a><span id="l15.1108" class="difflineminus">-nsresult nsMsgSearchOfflineMail::MatchTerms(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l15.1109"></a><span id="l15.1109" class="difflineminus">-                                            nsIArray *termList,</span>
<a href="#l15.1110"></a><span id="l15.1110" class="difflineminus">-                                            const char *defaultCharset,</span>
<a href="#l15.1111"></a><span id="l15.1111" class="difflineminus">-                                            nsIMsgSearchScopeTerm * scope,</span>
<a href="#l15.1112"></a><span id="l15.1112" class="difflineminus">-                                            nsIMsgDatabase * db,</span>
<a href="#l15.1113"></a><span id="l15.1113" class="difflineminus">-                                            const nsACString&amp; headers,</span>
<a href="#l15.1114"></a><span id="l15.1114" class="difflineminus">-                                            bool Filtering,</span>
<a href="#l15.1115"></a><span id="l15.1115" class="difflineminus">-                                            nsMsgSearchBoolExpression ** aExpressionTree,</span>
<a href="#l15.1116"></a><span id="l15.1116" class="difflineminus">-                                            bool *pResult)</span>
<a href="#l15.1117"></a><span id="l15.1117" class="difflineminus">-{</span>
<a href="#l15.1118"></a><span id="l15.1118" class="difflineplus">+nsresult nsMsgSearchOfflineMail::MatchTerms(</span>
<a href="#l15.1119"></a><span id="l15.1119" class="difflineplus">+    nsIMsgDBHdr *msgToMatch, nsIArray *termList, const char *defaultCharset,</span>
<a href="#l15.1120"></a><span id="l15.1120" class="difflineplus">+    nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db, const nsACString &amp;headers,</span>
<a href="#l15.1121"></a><span id="l15.1121" class="difflineplus">+    bool Filtering, nsMsgSearchBoolExpression **aExpressionTree,</span>
<a href="#l15.1122"></a><span id="l15.1122" class="difflineplus">+    bool *pResult) {</span>
<a href="#l15.1123"></a><span id="l15.1123">   NS_ENSURE_ARG(aExpressionTree);</span>
<a href="#l15.1124"></a><span id="l15.1124">   nsresult err;</span>
<a href="#l15.1125"></a><span id="l15.1125"> </span>
<a href="#l15.1126"></a><span id="l15.1126" class="difflineminus">-  if (!*aExpressionTree)</span>
<a href="#l15.1127"></a><span id="l15.1127" class="difflineminus">-  {</span>
<a href="#l15.1128"></a><span id="l15.1128" class="difflineplus">+  if (!*aExpressionTree) {</span>
<a href="#l15.1129"></a><span id="l15.1129">     uint32_t initialPos = 0;</span>
<a href="#l15.1130"></a><span id="l15.1130">     uint32_t count;</span>
<a href="#l15.1131"></a><span id="l15.1131">     termList-&gt;GetLength(&amp;count);</span>
<a href="#l15.1132"></a><span id="l15.1132">     err = ConstructExpressionTree(termList, count, initialPos, aExpressionTree);</span>
<a href="#l15.1133"></a><span id="l15.1133" class="difflineminus">-    if (NS_FAILED(err))</span>
<a href="#l15.1134"></a><span id="l15.1134" class="difflineminus">-      return err;</span>
<a href="#l15.1135"></a><span id="l15.1135" class="difflineplus">+    if (NS_FAILED(err)) return err;</span>
<a href="#l15.1136"></a><span id="l15.1136">   }</span>
<a href="#l15.1137"></a><span id="l15.1137"> </span>
<a href="#l15.1138"></a><span id="l15.1138">   // evaluate the expression tree and return the result</span>
<a href="#l15.1139"></a><span id="l15.1139">   *pResult = (*aExpressionTree)</span>
<a href="#l15.1140"></a><span id="l15.1140" class="difflineminus">-    ?  (*aExpressionTree)-&gt;OfflineEvaluate(msgToMatch,</span>
<a href="#l15.1141"></a><span id="l15.1141" class="difflineminus">-                 defaultCharset, scope, db, headers, Filtering)</span>
<a href="#l15.1142"></a><span id="l15.1142" class="difflineminus">-    :true;  // vacuously true...</span>
<a href="#l15.1143"></a><span id="l15.1143" class="difflineplus">+                 ? (*aExpressionTree)</span>
<a href="#l15.1144"></a><span id="l15.1144" class="difflineplus">+                       -&gt;OfflineEvaluate(msgToMatch, defaultCharset, scope, db,</span>
<a href="#l15.1145"></a><span id="l15.1145" class="difflineplus">+                                         headers, Filtering)</span>
<a href="#l15.1146"></a><span id="l15.1146" class="difflineplus">+                 : true;  // vacuously true...</span>
<a href="#l15.1147"></a><span id="l15.1147"> </span>
<a href="#l15.1148"></a><span id="l15.1148">   return NS_OK;</span>
<a href="#l15.1149"></a><span id="l15.1149"> }</span>
<a href="#l15.1150"></a><span id="l15.1150"> </span>
<a href="#l15.1151"></a><span id="l15.1151" class="difflineminus">-nsresult nsMsgSearchOfflineMail::Search(bool *aDone)</span>
<a href="#l15.1152"></a><span id="l15.1152" class="difflineminus">-{</span>
<a href="#l15.1153"></a><span id="l15.1153" class="difflineplus">+nsresult nsMsgSearchOfflineMail::Search(bool *aDone) {</span>
<a href="#l15.1154"></a><span id="l15.1154">   nsresult err = NS_OK;</span>
<a href="#l15.1155"></a><span id="l15.1155"> </span>
<a href="#l15.1156"></a><span id="l15.1156">   NS_ENSURE_ARG(aDone);</span>
<a href="#l15.1157"></a><span id="l15.1157">   nsresult dbErr = NS_OK;</span>
<a href="#l15.1158"></a><span id="l15.1158">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l15.1159"></a><span id="l15.1159">   nsMsgSearchBoolExpression *expressionTree = nullptr;</span>
<a href="#l15.1160"></a><span id="l15.1160"> </span>
<a href="#l15.1161"></a><span id="l15.1161">   const uint32_t kTimeSliceInMS = 200;</span>
<a href="#l15.1162"></a><span id="l15.1162"> </span>
<a href="#l15.1163"></a><span id="l15.1163">   *aDone = false;</span>
<a href="#l15.1164"></a><span id="l15.1164">   // Try to open the DB lazily. This will set up a parser if one is required</span>
<a href="#l15.1165"></a><span id="l15.1165" class="difflineminus">-  if (!m_db)</span>
<a href="#l15.1166"></a><span id="l15.1166" class="difflineminus">-    err = OpenSummaryFile ();</span>
<a href="#l15.1167"></a><span id="l15.1167" class="difflineplus">+  if (!m_db) err = OpenSummaryFile();</span>
<a href="#l15.1168"></a><span id="l15.1168">   if (!m_db)  // must be reparsing.</span>
<a href="#l15.1169"></a><span id="l15.1169">     return err;</span>
<a href="#l15.1170"></a><span id="l15.1170"> </span>
<a href="#l15.1171"></a><span id="l15.1171">   // Reparsing is unnecessary or completed</span>
<a href="#l15.1172"></a><span id="l15.1172" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l15.1173"></a><span id="l15.1173" class="difflineminus">-  {</span>
<a href="#l15.1174"></a><span id="l15.1174" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l15.1175"></a><span id="l15.1175">     if (!m_listContext)</span>
<a href="#l15.1176"></a><span id="l15.1176">       dbErr = m_db-&gt;ReverseEnumerateMessages(getter_AddRefs(m_listContext));</span>
<a href="#l15.1177"></a><span id="l15.1177" class="difflineminus">-    if (NS_SUCCEEDED(dbErr) &amp;&amp; m_listContext)</span>
<a href="#l15.1178"></a><span id="l15.1178" class="difflineminus">-    {</span>
<a href="#l15.1179"></a><span id="l15.1179" class="difflineplus">+    if (NS_SUCCEEDED(dbErr) &amp;&amp; m_listContext) {</span>
<a href="#l15.1180"></a><span id="l15.1180">       PRIntervalTime startTime = PR_IntervalNow();</span>
<a href="#l15.1181"></a><span id="l15.1181" class="difflineminus">-      while (!*aDone)  // we'll break out of the loop after kTimeSliceInMS milliseconds</span>
<a href="#l15.1182"></a><span id="l15.1182" class="difflineplus">+      while (!*aDone)  // we'll break out of the loop after kTimeSliceInMS</span>
<a href="#l15.1183"></a><span id="l15.1183" class="difflineplus">+                       // milliseconds</span>
<a href="#l15.1184"></a><span id="l15.1184">       {</span>
<a href="#l15.1185"></a><span id="l15.1185">         nsCOMPtr&lt;nsISupports&gt; currentItem;</span>
<a href="#l15.1186"></a><span id="l15.1186"> </span>
<a href="#l15.1187"></a><span id="l15.1187">         dbErr = m_listContext-&gt;GetNext(getter_AddRefs(currentItem));</span>
<a href="#l15.1188"></a><span id="l15.1188" class="difflineminus">-        if(NS_SUCCEEDED(dbErr))</span>
<a href="#l15.1189"></a><span id="l15.1189" class="difflineminus">-        {</span>
<a href="#l15.1190"></a><span id="l15.1190" class="difflineplus">+        if (NS_SUCCEEDED(dbErr)) {</span>
<a href="#l15.1191"></a><span id="l15.1191">           msgDBHdr = do_QueryInterface(currentItem, &amp;dbErr);</span>
<a href="#l15.1192"></a><span id="l15.1192">         }</span>
<a href="#l15.1193"></a><span id="l15.1193">         if (NS_FAILED(dbErr))</span>
<a href="#l15.1194"></a><span id="l15.1194" class="difflineminus">-          *aDone = true; //###phil dbErr is dropped on the floor. just note that we did have an error so we'll clean up later</span>
<a href="#l15.1195"></a><span id="l15.1195" class="difflineminus">-        else</span>
<a href="#l15.1196"></a><span id="l15.1196" class="difflineminus">-        {</span>
<a href="#l15.1197"></a><span id="l15.1197" class="difflineplus">+          *aDone = true;  //###phil dbErr is dropped on the floor. just note</span>
<a href="#l15.1198"></a><span id="l15.1198" class="difflineplus">+                          // that we did have an error so we'll clean up later</span>
<a href="#l15.1199"></a><span id="l15.1199" class="difflineplus">+        else {</span>
<a href="#l15.1200"></a><span id="l15.1200">           bool match = false;</span>
<a href="#l15.1201"></a><span id="l15.1201">           nsAutoString nullCharset, folderCharset;</span>
<a href="#l15.1202"></a><span id="l15.1202">           GetSearchCharsets(nullCharset, folderCharset);</span>
<a href="#l15.1203"></a><span id="l15.1203">           NS_ConvertUTF16toUTF8 charset(folderCharset);</span>
<a href="#l15.1204"></a><span id="l15.1204">           // Is this message a hit?</span>
<a href="#l15.1205"></a><span id="l15.1205" class="difflineminus">-          err = MatchTermsForSearch (msgDBHdr, m_searchTerms, charset.get(), m_scope, m_db, &amp;expressionTree, &amp;match);</span>
<a href="#l15.1206"></a><span id="l15.1206" class="difflineplus">+          err = MatchTermsForSearch(msgDBHdr, m_searchTerms, charset.get(),</span>
<a href="#l15.1207"></a><span id="l15.1207" class="difflineplus">+                                    m_scope, m_db, &amp;expressionTree, &amp;match);</span>
<a href="#l15.1208"></a><span id="l15.1208">           // Add search hits to the results list</span>
<a href="#l15.1209"></a><span id="l15.1209" class="difflineminus">-          if (NS_SUCCEEDED(err) &amp;&amp; match)</span>
<a href="#l15.1210"></a><span id="l15.1210" class="difflineminus">-          {</span>
<a href="#l15.1211"></a><span id="l15.1211" class="difflineminus">-            AddResultElement (msgDBHdr);</span>
<a href="#l15.1212"></a><span id="l15.1212" class="difflineplus">+          if (NS_SUCCEEDED(err) &amp;&amp; match) {</span>
<a href="#l15.1213"></a><span id="l15.1213" class="difflineplus">+            AddResultElement(msgDBHdr);</span>
<a href="#l15.1214"></a><span id="l15.1214">           }</span>
<a href="#l15.1215"></a><span id="l15.1215">           PRIntervalTime elapsedTime = PR_IntervalNow() - startTime;</span>
<a href="#l15.1216"></a><span id="l15.1216" class="difflineminus">-          // check if more than kTimeSliceInMS milliseconds have elapsed in this time slice started</span>
<a href="#l15.1217"></a><span id="l15.1217" class="difflineminus">-          if (PR_IntervalToMilliseconds(elapsedTime) &gt; kTimeSliceInMS)</span>
<a href="#l15.1218"></a><span id="l15.1218" class="difflineminus">-            break;</span>
<a href="#l15.1219"></a><span id="l15.1219" class="difflineplus">+          // check if more than kTimeSliceInMS milliseconds have elapsed in this</span>
<a href="#l15.1220"></a><span id="l15.1220" class="difflineplus">+          // time slice started</span>
<a href="#l15.1221"></a><span id="l15.1221" class="difflineplus">+          if (PR_IntervalToMilliseconds(elapsedTime) &gt; kTimeSliceInMS) break;</span>
<a href="#l15.1222"></a><span id="l15.1222">         }</span>
<a href="#l15.1223"></a><span id="l15.1223">       }</span>
<a href="#l15.1224"></a><span id="l15.1224">     }</span>
<a href="#l15.1225"></a><span id="l15.1225" class="difflineminus">-  }</span>
<a href="#l15.1226"></a><span id="l15.1226" class="difflineminus">-  else</span>
<a href="#l15.1227"></a><span id="l15.1227" class="difflineminus">-    *aDone = true; // we couldn't open up the DB. This is an unrecoverable error so mark the scope as done.</span>
<a href="#l15.1228"></a><span id="l15.1228" class="difflineplus">+  } else</span>
<a href="#l15.1229"></a><span id="l15.1229" class="difflineplus">+    *aDone = true;  // we couldn't open up the DB. This is an unrecoverable</span>
<a href="#l15.1230"></a><span id="l15.1230" class="difflineplus">+                    // error so mark the scope as done.</span>
<a href="#l15.1231"></a><span id="l15.1231"> </span>
<a href="#l15.1232"></a><span id="l15.1232">   delete expressionTree;</span>
<a href="#l15.1233"></a><span id="l15.1233"> </span>
<a href="#l15.1234"></a><span id="l15.1234" class="difflineminus">-  // in the past an error here would cause an &quot;infinite&quot; search because the url would continue to run...</span>
<a href="#l15.1235"></a><span id="l15.1235" class="difflineminus">-  // i.e. if we couldn't open the database, it returns an error code but the caller of this function says, oh,</span>
<a href="#l15.1236"></a><span id="l15.1236" class="difflineminus">-  // we did not finish so continue...what we really want is to treat this current scope as done</span>
<a href="#l15.1237"></a><span id="l15.1237" class="difflineminus">-  if (*aDone)</span>
<a href="#l15.1238"></a><span id="l15.1238" class="difflineminus">-    CleanUpScope(); // Do clean up for end-of-scope processing</span>
<a href="#l15.1239"></a><span id="l15.1239" class="difflineplus">+  // in the past an error here would cause an &quot;infinite&quot; search because the url</span>
<a href="#l15.1240"></a><span id="l15.1240" class="difflineplus">+  // would continue to run... i.e. if we couldn't open the database, it returns</span>
<a href="#l15.1241"></a><span id="l15.1241" class="difflineplus">+  // an error code but the caller of this function says, oh, we did not finish</span>
<a href="#l15.1242"></a><span id="l15.1242" class="difflineplus">+  // so continue...what we really want is to treat this current scope as done</span>
<a href="#l15.1243"></a><span id="l15.1243" class="difflineplus">+  if (*aDone) CleanUpScope();  // Do clean up for end-of-scope processing</span>
<a href="#l15.1244"></a><span id="l15.1244">   return err;</span>
<a href="#l15.1245"></a><span id="l15.1245"> }</span>
<a href="#l15.1246"></a><span id="l15.1246"> </span>
<a href="#l15.1247"></a><span id="l15.1247" class="difflineminus">-void nsMsgSearchOfflineMail::CleanUpScope()</span>
<a href="#l15.1248"></a><span id="l15.1248" class="difflineminus">-{</span>
<a href="#l15.1249"></a><span id="l15.1249" class="difflineplus">+void nsMsgSearchOfflineMail::CleanUpScope() {</span>
<a href="#l15.1250"></a><span id="l15.1250">   // Let go of the DB when we're done with it so we don't kill the db cache</span>
<a href="#l15.1251"></a><span id="l15.1251" class="difflineminus">-  if (m_db)</span>
<a href="#l15.1252"></a><span id="l15.1252" class="difflineminus">-  {</span>
<a href="#l15.1253"></a><span id="l15.1253" class="difflineplus">+  if (m_db) {</span>
<a href="#l15.1254"></a><span id="l15.1254">     m_listContext = nullptr;</span>
<a href="#l15.1255"></a><span id="l15.1255">     m_db-&gt;Close(false);</span>
<a href="#l15.1256"></a><span id="l15.1256">   }</span>
<a href="#l15.1257"></a><span id="l15.1257">   m_db = nullptr;</span>
<a href="#l15.1258"></a><span id="l15.1258"> </span>
<a href="#l15.1259"></a><span id="l15.1259" class="difflineminus">-  if (m_scope)</span>
<a href="#l15.1260"></a><span id="l15.1260" class="difflineminus">-    m_scope-&gt;CloseInputStream();</span>
<a href="#l15.1261"></a><span id="l15.1261" class="difflineplus">+  if (m_scope) m_scope-&gt;CloseInputStream();</span>
<a href="#l15.1262"></a><span id="l15.1262"> }</span>
<a href="#l15.1263"></a><span id="l15.1263"> </span>
<a href="#l15.1264"></a><span id="l15.1264" class="difflineminus">-NS_IMETHODIMP nsMsgSearchOfflineMail::AddResultElement (nsIMsgDBHdr *pHeaders)</span>
<a href="#l15.1265"></a><span id="l15.1265" class="difflineminus">-{</span>
<a href="#l15.1266"></a><span id="l15.1266" class="difflineminus">-    nsresult err = NS_OK;</span>
<a href="#l15.1267"></a><span id="l15.1267" class="difflineplus">+NS_IMETHODIMP nsMsgSearchOfflineMail::AddResultElement(nsIMsgDBHdr *pHeaders) {</span>
<a href="#l15.1268"></a><span id="l15.1268" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l15.1269"></a><span id="l15.1269"> </span>
<a href="#l15.1270"></a><span id="l15.1270" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l15.1271"></a><span id="l15.1271" class="difflineminus">-    m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l15.1272"></a><span id="l15.1272" class="difflineminus">-    if (searchSession)</span>
<a href="#l15.1273"></a><span id="l15.1273" class="difflineminus">-    {</span>
<a href="#l15.1274"></a><span id="l15.1274" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l15.1275"></a><span id="l15.1275" class="difflineminus">-      err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l15.1276"></a><span id="l15.1276" class="difflineminus">-      searchSession-&gt;AddSearchHit(pHeaders, scopeFolder);</span>
<a href="#l15.1277"></a><span id="l15.1277" class="difflineminus">-    }</span>
<a href="#l15.1278"></a><span id="l15.1278" class="difflineminus">-    return err;</span>
<a href="#l15.1279"></a><span id="l15.1279" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l15.1280"></a><span id="l15.1280" class="difflineplus">+  m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l15.1281"></a><span id="l15.1281" class="difflineplus">+  if (searchSession) {</span>
<a href="#l15.1282"></a><span id="l15.1282" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l15.1283"></a><span id="l15.1283" class="difflineplus">+    err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l15.1284"></a><span id="l15.1284" class="difflineplus">+    searchSession-&gt;AddSearchHit(pHeaders, scopeFolder);</span>
<a href="#l15.1285"></a><span id="l15.1285" class="difflineplus">+  }</span>
<a href="#l15.1286"></a><span id="l15.1286" class="difflineplus">+  return err;</span>
<a href="#l15.1287"></a><span id="l15.1287"> }</span>
<a href="#l15.1288"></a><span id="l15.1288"> </span>
<a href="#l15.1289"></a><span id="l15.1289"> NS_IMETHODIMP</span>
<a href="#l15.1290"></a><span id="l15.1290" class="difflineminus">-nsMsgSearchOfflineMail::Abort ()</span>
<a href="#l15.1291"></a><span id="l15.1291" class="difflineminus">-{</span>
<a href="#l15.1292"></a><span id="l15.1292" class="difflineminus">-    // Let go of the DB when we're done with it so we don't kill the db cache</span>
<a href="#l15.1293"></a><span id="l15.1293" class="difflineminus">-    if (m_db)</span>
<a href="#l15.1294"></a><span id="l15.1294" class="difflineminus">-        m_db-&gt;Close(true /* commit in case we downloaded new headers */);</span>
<a href="#l15.1295"></a><span id="l15.1295" class="difflineminus">-    m_db = nullptr;</span>
<a href="#l15.1296"></a><span id="l15.1296" class="difflineminus">-    return nsMsgSearchAdapter::Abort ();</span>
<a href="#l15.1297"></a><span id="l15.1297" class="difflineplus">+nsMsgSearchOfflineMail::Abort() {</span>
<a href="#l15.1298"></a><span id="l15.1298" class="difflineplus">+  // Let go of the DB when we're done with it so we don't kill the db cache</span>
<a href="#l15.1299"></a><span id="l15.1299" class="difflineplus">+  if (m_db) m_db-&gt;Close(true /* commit in case we downloaded new headers */);</span>
<a href="#l15.1300"></a><span id="l15.1300" class="difflineplus">+  m_db = nullptr;</span>
<a href="#l15.1301"></a><span id="l15.1301" class="difflineplus">+  return nsMsgSearchAdapter::Abort();</span>
<a href="#l15.1302"></a><span id="l15.1302"> }</span>
<a href="#l15.1303"></a><span id="l15.1303"> </span>
<a href="#l15.1304"></a><span id="l15.1304"> /* void OnStartRunningUrl (in nsIURI url); */</span>
<a href="#l15.1305"></a><span id="l15.1305" class="difflineminus">-NS_IMETHODIMP nsMsgSearchOfflineMail::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l15.1306"></a><span id="l15.1306" class="difflineminus">-{</span>
<a href="#l15.1307"></a><span id="l15.1307" class="difflineminus">-    return NS_OK;</span>
<a href="#l15.1308"></a><span id="l15.1308" class="difflineplus">+NS_IMETHODIMP nsMsgSearchOfflineMail::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l15.1309"></a><span id="l15.1309" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.1310"></a><span id="l15.1310"> }</span>
<a href="#l15.1311"></a><span id="l15.1311"> </span>
<a href="#l15.1312"></a><span id="l15.1312"> /* void OnStopRunningUrl (in nsIURI url, in nsresult aExitCode); */</span>
<a href="#l15.1313"></a><span id="l15.1313" class="difflineminus">-NS_IMETHODIMP nsMsgSearchOfflineMail::OnStopRunningUrl(nsIURI *url, nsresult aExitCode)</span>
<a href="#l15.1314"></a><span id="l15.1314" class="difflineminus">-{</span>
<a href="#l15.1315"></a><span id="l15.1315" class="difflineplus">+NS_IMETHODIMP nsMsgSearchOfflineMail::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l15.1316"></a><span id="l15.1316" class="difflineplus">+                                                       nsresult aExitCode) {</span>
<a href="#l15.1317"></a><span id="l15.1317">   nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession;</span>
<a href="#l15.1318"></a><span id="l15.1318" class="difflineminus">-  if (m_scope)</span>
<a href="#l15.1319"></a><span id="l15.1319" class="difflineminus">-    m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l15.1320"></a><span id="l15.1320" class="difflineminus">-  if (searchSession)</span>
<a href="#l15.1321"></a><span id="l15.1321" class="difflineminus">-    searchSession-&gt;ResumeSearch();</span>
<a href="#l15.1322"></a><span id="l15.1322" class="difflineplus">+  if (m_scope) m_scope-&gt;GetSearchSession(getter_AddRefs(searchSession));</span>
<a href="#l15.1323"></a><span id="l15.1323" class="difflineplus">+  if (searchSession) searchSession-&gt;ResumeSearch();</span>
<a href="#l15.1324"></a><span id="l15.1324"> </span>
<a href="#l15.1325"></a><span id="l15.1325">   return NS_OK;</span>
<a href="#l15.1326"></a><span id="l15.1326"> }</span>
<a href="#l15.1327"></a><span id="l15.1327"> </span>
<a href="#l15.1328"></a><span id="l15.1328" class="difflineminus">-nsMsgSearchOfflineNews::nsMsgSearchOfflineNews (nsIMsgSearchScopeTerm *scope, nsIArray *termList) : nsMsgSearchOfflineMail (scope, termList)</span>
<a href="#l15.1329"></a><span id="l15.1329" class="difflineminus">-{</span>
<a href="#l15.1330"></a><span id="l15.1330" class="difflineminus">-}</span>
<a href="#l15.1331"></a><span id="l15.1331" class="difflineplus">+nsMsgSearchOfflineNews::nsMsgSearchOfflineNews(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l15.1332"></a><span id="l15.1332" class="difflineplus">+                                               nsIArray *termList)</span>
<a href="#l15.1333"></a><span id="l15.1333" class="difflineplus">+    : nsMsgSearchOfflineMail(scope, termList) {}</span>
<a href="#l15.1334"></a><span id="l15.1334"> </span>
<a href="#l15.1335"></a><span id="l15.1335" class="difflineminus">-</span>
<a href="#l15.1336"></a><span id="l15.1336" class="difflineminus">-nsMsgSearchOfflineNews::~nsMsgSearchOfflineNews ()</span>
<a href="#l15.1337"></a><span id="l15.1337" class="difflineminus">-{</span>
<a href="#l15.1338"></a><span id="l15.1338" class="difflineminus">-}</span>
<a href="#l15.1339"></a><span id="l15.1339" class="difflineplus">+nsMsgSearchOfflineNews::~nsMsgSearchOfflineNews() {}</span>
<a href="#l15.1340"></a><span id="l15.1340"> </span>
<a href="#l15.1341"></a><span id="l15.1341" class="difflineminus">-</span>
<a href="#l15.1342"></a><span id="l15.1342" class="difflineminus">-nsresult nsMsgSearchOfflineNews::OpenSummaryFile ()</span>
<a href="#l15.1343"></a><span id="l15.1343" class="difflineminus">-{</span>
<a href="#l15.1344"></a><span id="l15.1344" class="difflineplus">+nsresult nsMsgSearchOfflineNews::OpenSummaryFile() {</span>
<a href="#l15.1345"></a><span id="l15.1345">   nsresult err = NS_OK;</span>
<a href="#l15.1346"></a><span id="l15.1346" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt;  folderInfo;</span>
<a href="#l15.1347"></a><span id="l15.1347" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l15.1348"></a><span id="l15.1348" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l15.1349"></a><span id="l15.1349" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l15.1350"></a><span id="l15.1350">   err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l15.1351"></a><span id="l15.1351" class="difflineminus">-  // code here used to check if offline store existed, which breaks offline news.</span>
<a href="#l15.1352"></a><span id="l15.1352" class="difflineplus">+  // code here used to check if offline store existed, which breaks offline</span>
<a href="#l15.1353"></a><span id="l15.1353" class="difflineplus">+  // news.</span>
<a href="#l15.1354"></a><span id="l15.1354">   if (NS_SUCCEEDED(err) &amp;&amp; scopeFolder)</span>
<a href="#l15.1355"></a><span id="l15.1355">     err = scopeFolder-&gt;GetMsgDatabase(getter_AddRefs(m_db));</span>
<a href="#l15.1356"></a><span id="l15.1356">   return err;</span>
<a href="#l15.1357"></a><span id="l15.1357"> }</span>
<a href="#l15.1358"></a><span id="l15.1358"> </span>
<a href="#l15.1359"></a><span id="l15.1359" class="difflineminus">-nsresult nsMsgSearchOfflineNews::ValidateTerms ()</span>
<a href="#l15.1360"></a><span id="l15.1360" class="difflineminus">-{</span>
<a href="#l15.1361"></a><span id="l15.1361" class="difflineminus">-  return nsMsgSearchOfflineMail::ValidateTerms ();</span>
<a href="#l15.1362"></a><span id="l15.1362" class="difflineplus">+nsresult nsMsgSearchOfflineNews::ValidateTerms() {</span>
<a href="#l15.1363"></a><span id="l15.1363" class="difflineplus">+  return nsMsgSearchOfflineMail::ValidateTerms();</span>
<a href="#l15.1364"></a><span id="l15.1364"> }</span>
<a href="#l15.1365"></a><span id="l15.1365"> </span>
<a href="#l15.1366"></a><span id="l15.1366"> // local helper functions to set subsets of the validity table</span>
<a href="#l15.1367"></a><span id="l15.1367" class="difflineminus">-</span>
<a href="#l15.1368"></a><span id="l15.1368" class="difflineminus">-nsresult SetJunk(nsIMsgSearchValidityTable* aTable)</span>
<a href="#l15.1369"></a><span id="l15.1369" class="difflineminus">-{</span>
<a href="#l15.1370"></a><span id="l15.1370" class="difflineplus">+// clang-format off</span>
<a href="#l15.1371"></a><span id="l15.1371" class="difflineplus">+nsresult SetJunk(nsIMsgSearchValidityTable *aTable) {</span>
<a href="#l15.1372"></a><span id="l15.1372">   NS_ENSURE_ARG_POINTER(aTable);</span>
<a href="#l15.1373"></a><span id="l15.1373"> </span>
<a href="#l15.1374"></a><span id="l15.1374">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1375"></a><span id="l15.1375" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1376"></a><span id="l15.1376" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1377"></a><span id="l15.1377">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1378"></a><span id="l15.1378" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1379"></a><span id="l15.1379" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1380"></a><span id="l15.1380">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1381"></a><span id="l15.1381" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1382"></a><span id="l15.1382" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1383"></a><span id="l15.1383">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1384"></a><span id="l15.1384" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1385"></a><span id="l15.1385" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkStatus, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1386"></a><span id="l15.1386"> </span>
<a href="#l15.1387"></a><span id="l15.1387">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1388"></a><span id="l15.1388" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1389"></a><span id="l15.1389" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1390"></a><span id="l15.1390">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l15.1391"></a><span id="l15.1391" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l15.1392"></a><span id="l15.1392" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l15.1393"></a><span id="l15.1393">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1394"></a><span id="l15.1394" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1395"></a><span id="l15.1395" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkPercent, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1396"></a><span id="l15.1396"> </span>
<a href="#l15.1397"></a><span id="l15.1397">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1398"></a><span id="l15.1398" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1399"></a><span id="l15.1399" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1400"></a><span id="l15.1400">   aTable-&gt;SetAvailable(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1401"></a><span id="l15.1401" class="difflineminus">-  aTable-&gt;SetEnabled(nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1402"></a><span id="l15.1402" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::JunkScoreOrigin, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1403"></a><span id="l15.1403"> </span>
<a href="#l15.1404"></a><span id="l15.1404">   return NS_OK;</span>
<a href="#l15.1405"></a><span id="l15.1405"> }</span>
<a href="#l15.1406"></a><span id="l15.1406"> </span>
<a href="#l15.1407"></a><span id="l15.1407" class="difflineminus">-nsresult SetBody(nsIMsgSearchValidityTable* aTable)</span>
<a href="#l15.1408"></a><span id="l15.1408" class="difflineminus">-{</span>
<a href="#l15.1409"></a><span id="l15.1409" class="difflineplus">+nsresult SetBody(nsIMsgSearchValidityTable* aTable) {</span>
<a href="#l15.1410"></a><span id="l15.1410">   NS_ENSURE_ARG_POINTER(aTable);</span>
<a href="#l15.1411"></a><span id="l15.1411" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1412"></a><span id="l15.1412" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1413"></a><span id="l15.1413" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1414"></a><span id="l15.1414" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1415"></a><span id="l15.1415" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1416"></a><span id="l15.1416" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1417"></a><span id="l15.1417" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1418"></a><span id="l15.1418" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1419"></a><span id="l15.1419" class="difflineplus">+</span>
<a href="#l15.1420"></a><span id="l15.1420" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1421"></a><span id="l15.1421" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1422"></a><span id="l15.1422" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1423"></a><span id="l15.1423" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1424"></a><span id="l15.1424" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1425"></a><span id="l15.1425" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1426"></a><span id="l15.1426" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1427"></a><span id="l15.1427" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Body, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1428"></a><span id="l15.1428"> </span>
<a href="#l15.1429"></a><span id="l15.1429">   return NS_OK;</span>
<a href="#l15.1430"></a><span id="l15.1430"> }</span>
<a href="#l15.1431"></a><span id="l15.1431"> </span>
<a href="#l15.1432"></a><span id="l15.1432"> // set the base validity table values for local news</span>
<a href="#l15.1433"></a><span id="l15.1433" class="difflineminus">-nsresult SetLocalNews(nsIMsgSearchValidityTable* aTable)</span>
<a href="#l15.1434"></a><span id="l15.1434" class="difflineminus">-{</span>
<a href="#l15.1435"></a><span id="l15.1435" class="difflineplus">+nsresult SetLocalNews(nsIMsgSearchValidityTable* aTable) {</span>
<a href="#l15.1436"></a><span id="l15.1436">   NS_ENSURE_ARG_POINTER(aTable);</span>
<a href="#l15.1437"></a><span id="l15.1437"> </span>
<a href="#l15.1438"></a><span id="l15.1438" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1439"></a><span id="l15.1439" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1440"></a><span id="l15.1440" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1441"></a><span id="l15.1441" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1442"></a><span id="l15.1442" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1443"></a><span id="l15.1443" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1444"></a><span id="l15.1444" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1445"></a><span id="l15.1445" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1446"></a><span id="l15.1446" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1447"></a><span id="l15.1447" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1448"></a><span id="l15.1448" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1449"></a><span id="l15.1449" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1450"></a><span id="l15.1450" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l15.1451"></a><span id="l15.1451" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l15.1452"></a><span id="l15.1452" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l15.1453"></a><span id="l15.1453" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l15.1454"></a><span id="l15.1454" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1455"></a><span id="l15.1455" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1456"></a><span id="l15.1456" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1457"></a><span id="l15.1457" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1458"></a><span id="l15.1458" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1459"></a><span id="l15.1459" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1460"></a><span id="l15.1460" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1461"></a><span id="l15.1461" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1462"></a><span id="l15.1462" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1463"></a><span id="l15.1463" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1464"></a><span id="l15.1464" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1465"></a><span id="l15.1465" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1466"></a><span id="l15.1466" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l15.1467"></a><span id="l15.1467" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l15.1468"></a><span id="l15.1468" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l15.1469"></a><span id="l15.1469" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l15.1470"></a><span id="l15.1470"> </span>
<a href="#l15.1471"></a><span id="l15.1471" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1472"></a><span id="l15.1472" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1473"></a><span id="l15.1473" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1474"></a><span id="l15.1474" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1475"></a><span id="l15.1475" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1476"></a><span id="l15.1476" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1477"></a><span id="l15.1477" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1478"></a><span id="l15.1478" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1479"></a><span id="l15.1479" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1480"></a><span id="l15.1480" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1481"></a><span id="l15.1481" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1482"></a><span id="l15.1482" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1483"></a><span id="l15.1483" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1484"></a><span id="l15.1484" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1485"></a><span id="l15.1485" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1486"></a><span id="l15.1486" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1487"></a><span id="l15.1487" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1488"></a><span id="l15.1488" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1489"></a><span id="l15.1489" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1490"></a><span id="l15.1490" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1491"></a><span id="l15.1491" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1492"></a><span id="l15.1492" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1493"></a><span id="l15.1493" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1494"></a><span id="l15.1494" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1495"></a><span id="l15.1495"> </span>
<a href="#l15.1496"></a><span id="l15.1496" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l15.1497"></a><span id="l15.1497" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l15.1498"></a><span id="l15.1498" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l15.1499"></a><span id="l15.1499" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l15.1500"></a><span id="l15.1500" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1501"></a><span id="l15.1501" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1502"></a><span id="l15.1502" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1503"></a><span id="l15.1503" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1504"></a><span id="l15.1504" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l15.1505"></a><span id="l15.1505" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l15.1506"></a><span id="l15.1506" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l15.1507"></a><span id="l15.1507" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l15.1508"></a><span id="l15.1508" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1509"></a><span id="l15.1509" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1510"></a><span id="l15.1510" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1511"></a><span id="l15.1511" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1512"></a><span id="l15.1512"> </span>
<a href="#l15.1513"></a><span id="l15.1513" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1514"></a><span id="l15.1514" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1515"></a><span id="l15.1515" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l15.1516"></a><span id="l15.1516" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l15.1517"></a><span id="l15.1517" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l15.1518"></a><span id="l15.1518" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1519"></a><span id="l15.1519" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1520"></a><span id="l15.1520" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l15.1521"></a><span id="l15.1521" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan,  1);</span>
<a href="#l15.1522"></a><span id="l15.1522" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l15.1523"></a><span id="l15.1523" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is,  1);</span>
<a href="#l15.1524"></a><span id="l15.1524" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::AgeInDays, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1525"></a><span id="l15.1525"> </span>
<a href="#l15.1526"></a><span id="l15.1526" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1527"></a><span id="l15.1527" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1528"></a><span id="l15.1528" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1529"></a><span id="l15.1529" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1530"></a><span id="l15.1530" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1531"></a><span id="l15.1531" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1532"></a><span id="l15.1532" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1533"></a><span id="l15.1533" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::MsgStatus, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1534"></a><span id="l15.1534"> </span>
<a href="#l15.1535"></a><span id="l15.1535" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1536"></a><span id="l15.1536" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1537"></a><span id="l15.1537" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1538"></a><span id="l15.1538" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1539"></a><span id="l15.1539" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1540"></a><span id="l15.1540" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1541"></a><span id="l15.1541" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1542"></a><span id="l15.1542" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1543"></a><span id="l15.1543" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1544"></a><span id="l15.1544" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1545"></a><span id="l15.1545" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1546"></a><span id="l15.1546" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1547"></a><span id="l15.1547" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1548"></a><span id="l15.1548" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1549"></a><span id="l15.1549" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1550"></a><span id="l15.1550" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1551"></a><span id="l15.1551" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1552"></a><span id="l15.1552" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1553"></a><span id="l15.1553" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1554"></a><span id="l15.1554" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1555"></a><span id="l15.1555" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1556"></a><span id="l15.1556" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l15.1557"></a><span id="l15.1557" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1558"></a><span id="l15.1558" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l15.1559"></a><span id="l15.1559"> </span>
<a href="#l15.1560"></a><span id="l15.1560" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1561"></a><span id="l15.1561" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1562"></a><span id="l15.1562" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1563"></a><span id="l15.1563" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1564"></a><span id="l15.1564" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1565"></a><span id="l15.1565" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1566"></a><span id="l15.1566" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1567"></a><span id="l15.1567" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1568"></a><span id="l15.1568" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1569"></a><span id="l15.1569" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1570"></a><span id="l15.1570" class="difflineminus">-  aTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1571"></a><span id="l15.1571" class="difflineminus">-  aTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1572"></a><span id="l15.1572" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1573"></a><span id="l15.1573" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l15.1574"></a><span id="l15.1574" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1575"></a><span id="l15.1575" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l15.1576"></a><span id="l15.1576" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1577"></a><span id="l15.1577" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l15.1578"></a><span id="l15.1578" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1579"></a><span id="l15.1579" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l15.1580"></a><span id="l15.1580" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1581"></a><span id="l15.1581" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l15.1582"></a><span id="l15.1582" class="difflineplus">+  aTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1583"></a><span id="l15.1583" class="difflineplus">+  aTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l15.1584"></a><span id="l15.1584">   return NS_OK;</span>
<a href="#l15.1585"></a><span id="l15.1585" class="difflineminus">-</span>
<a href="#l15.1586"></a><span id="l15.1586"> }</span>
<a href="#l15.1587"></a><span id="l15.1587" class="difflineplus">+// clang-format on</span>
<a href="#l15.1588"></a><span id="l15.1588"> </span>
<a href="#l15.1589"></a><span id="l15.1589" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLocalNewsTable()</span>
<a href="#l15.1590"></a><span id="l15.1590" class="difflineminus">-{</span>
<a href="#l15.1591"></a><span id="l15.1591" class="difflineminus">-  NS_ASSERTION (nullptr == m_localNewsTable, &quot;already have local news validity table&quot;);</span>
<a href="#l15.1592"></a><span id="l15.1592" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLocalNewsTable() {</span>
<a href="#l15.1593"></a><span id="l15.1593" class="difflineplus">+  NS_ASSERTION(nullptr == m_localNewsTable,</span>
<a href="#l15.1594"></a><span id="l15.1594" class="difflineplus">+               &quot;already have local news validity table&quot;);</span>
<a href="#l15.1595"></a><span id="l15.1595">   nsresult rv = NewTable(getter_AddRefs(m_localNewsTable));</span>
<a href="#l15.1596"></a><span id="l15.1596">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1597"></a><span id="l15.1597">   return SetLocalNews(m_localNewsTable);</span>
<a href="#l15.1598"></a><span id="l15.1598"> }</span>
<a href="#l15.1599"></a><span id="l15.1599"> </span>
<a href="#l15.1600"></a><span id="l15.1600" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLocalNewsBodyTable()</span>
<a href="#l15.1601"></a><span id="l15.1601" class="difflineminus">-{</span>
<a href="#l15.1602"></a><span id="l15.1602" class="difflineminus">-  NS_ASSERTION (nullptr == m_localNewsBodyTable, &quot;already have local news+body validity table&quot;);</span>
<a href="#l15.1603"></a><span id="l15.1603" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLocalNewsBodyTable() {</span>
<a href="#l15.1604"></a><span id="l15.1604" class="difflineplus">+  NS_ASSERTION(nullptr == m_localNewsBodyTable,</span>
<a href="#l15.1605"></a><span id="l15.1605" class="difflineplus">+               &quot;already have local news+body validity table&quot;);</span>
<a href="#l15.1606"></a><span id="l15.1606">   nsresult rv = NewTable(getter_AddRefs(m_localNewsBodyTable));</span>
<a href="#l15.1607"></a><span id="l15.1607">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1608"></a><span id="l15.1608">   rv = SetLocalNews(m_localNewsBodyTable);</span>
<a href="#l15.1609"></a><span id="l15.1609">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1610"></a><span id="l15.1610">   return SetBody(m_localNewsBodyTable);</span>
<a href="#l15.1611"></a><span id="l15.1611"> }</span>
<a href="#l15.1612"></a><span id="l15.1612"> </span>
<a href="#l15.1613"></a><span id="l15.1613" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLocalNewsJunkTable()</span>
<a href="#l15.1614"></a><span id="l15.1614" class="difflineminus">-{</span>
<a href="#l15.1615"></a><span id="l15.1615" class="difflineminus">-  NS_ASSERTION (nullptr == m_localNewsJunkTable, &quot;already have local news+junk validity table&quot;);</span>
<a href="#l15.1616"></a><span id="l15.1616" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLocalNewsJunkTable() {</span>
<a href="#l15.1617"></a><span id="l15.1617" class="difflineplus">+  NS_ASSERTION(nullptr == m_localNewsJunkTable,</span>
<a href="#l15.1618"></a><span id="l15.1618" class="difflineplus">+               &quot;already have local news+junk validity table&quot;);</span>
<a href="#l15.1619"></a><span id="l15.1619">   nsresult rv = NewTable(getter_AddRefs(m_localNewsJunkTable));</span>
<a href="#l15.1620"></a><span id="l15.1620">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1621"></a><span id="l15.1621">   rv = SetLocalNews(m_localNewsJunkTable);</span>
<a href="#l15.1622"></a><span id="l15.1622">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1623"></a><span id="l15.1623">   return SetJunk(m_localNewsJunkTable);</span>
<a href="#l15.1624"></a><span id="l15.1624"> }</span>
<a href="#l15.1625"></a><span id="l15.1625"> </span>
<a href="#l15.1626"></a><span id="l15.1626" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLocalNewsJunkBodyTable()</span>
<a href="#l15.1627"></a><span id="l15.1627" class="difflineminus">-{</span>
<a href="#l15.1628"></a><span id="l15.1628" class="difflineminus">-  NS_ASSERTION (nullptr == m_localNewsJunkBodyTable, &quot;already have local news+junk+body validity table&quot;);</span>
<a href="#l15.1629"></a><span id="l15.1629" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLocalNewsJunkBodyTable() {</span>
<a href="#l15.1630"></a><span id="l15.1630" class="difflineplus">+  NS_ASSERTION(nullptr == m_localNewsJunkBodyTable,</span>
<a href="#l15.1631"></a><span id="l15.1631" class="difflineplus">+               &quot;already have local news+junk+body validity table&quot;);</span>
<a href="#l15.1632"></a><span id="l15.1632">   nsresult rv = NewTable(getter_AddRefs(m_localNewsJunkBodyTable));</span>
<a href="#l15.1633"></a><span id="l15.1633">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1634"></a><span id="l15.1634">   rv = SetLocalNews(m_localNewsJunkBodyTable);</span>
<a href="#l15.1635"></a><span id="l15.1635">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1636"></a><span id="l15.1636">   rv = SetJunk(m_localNewsJunkBodyTable);</span>
<a href="#l15.1637"></a><span id="l15.1637">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1638"></a><span id="l15.1638">   return SetBody(m_localNewsJunkBodyTable);</span>
<a href="#l15.1639"></a><span id="l15.1639"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgLocalSearch.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgLocalSearch.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -10,92 +10,76 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsIMsgSearchAdapter.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> // inherit base implementation</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsMsgSearchAdapter.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13"> class nsIMsgDBHdr;</span>
<a href="#l16.14"></a><span id="l16.14"> class nsIMsgSearchScopeTerm;</span>
<a href="#l16.15"></a><span id="l16.15"> class nsIMsgFolder;</span>
<a href="#l16.16"></a><span id="l16.16"> class nsMsgSearchBoolExpression;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-class nsMsgSearchOfflineMail : public nsMsgSearchAdapter, public nsIUrlListener</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-{</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-public:</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-  nsMsgSearchOfflineMail (nsIMsgSearchScopeTerm*, nsIArray *);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+class nsMsgSearchOfflineMail : public nsMsgSearchAdapter,</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+                               public nsIUrlListener {</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ public:</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+  nsMsgSearchOfflineMail(nsIMsgSearchScopeTerm *, nsIArray *);</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">   NS_DECL_NSIURLLISTENER</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  NS_IMETHOD ValidateTerms () override;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-  NS_IMETHOD Search (bool *aDone) override;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  NS_IMETHOD Abort () override;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  NS_IMETHOD AddResultElement (nsIMsgDBHdr *) override;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  NS_IMETHOD ValidateTerms() override;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  NS_IMETHOD Search(bool *aDone) override;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+  NS_IMETHOD Abort() override;</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+  NS_IMETHOD AddResultElement(nsIMsgDBHdr *) override;</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  static nsresult  MatchTermsForFilter(nsIMsgDBHdr * msgToMatch,</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-                                         nsIArray *termList,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-                                         const char *defaultCharset,</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-                                         nsIMsgSearchScopeTerm *scope,</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-                                         nsIMsgDatabase * db,</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-                                         const nsACString&amp; headers,</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-                                         nsMsgSearchBoolExpression ** aExpressionTree,</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-                     bool *pResult);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  static nsresult MatchTermsForFilter(</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+      nsIMsgDBHdr *msgToMatch, nsIArray *termList, const char *defaultCharset,</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+      nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+      const nsACString &amp;headers, nsMsgSearchBoolExpression **aExpressionTree,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+      bool *pResult);</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-  static nsresult MatchTermsForSearch(nsIMsgDBHdr * msgTomatch,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-                                      nsIArray *termList,</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-                                      const char *defaultCharset,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-                                      nsIMsgSearchScopeTerm *scope,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-                                      nsIMsgDatabase *db,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-                                      nsMsgSearchBoolExpression ** aExpressionTree,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">- bool *pResult);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  static nsresult MatchTermsForSearch(</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+      nsIMsgDBHdr *msgTomatch, nsIArray *termList, const char *defaultCharset,</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+      nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db,</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+      nsMsgSearchBoolExpression **aExpressionTree, bool *pResult);</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  virtual nsresult OpenSummaryFile ();</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+  virtual nsresult OpenSummaryFile();</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-     static nsresult ProcessSearchTerm(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-                               nsIMsgSearchTerm * aTerm,</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-                               const char *defaultCharset,</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-                               nsIMsgSearchScopeTerm * scope,</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-                               nsIMsgDatabase * db,</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-                               const nsACString&amp; headers,</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-                               bool Filtering,</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-                 bool *pResult);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-protected:</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  static nsresult ProcessSearchTerm(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+                                    nsIMsgSearchTerm *aTerm,</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+                                    const char *defaultCharset,</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+                                    nsIMsgSearchScopeTerm *scope,</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+                                    nsIMsgDatabase *db,</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+                                    const nsACString &amp;headers, bool Filtering,</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+                                    bool *pResult);</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+ protected:</span>
<a href="#l16.87"></a><span id="l16.87">   virtual ~nsMsgSearchOfflineMail();</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-  static nsresult MatchTerms(nsIMsgDBHdr *msgToMatch,</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-                                nsIArray *termList,</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-                                const char *defaultCharset,</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-                                nsIMsgSearchScopeTerm *scope,</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-                                nsIMsgDatabase * db,</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-                                const nsACString&amp; headers,</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-                                bool ForFilters,</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-                                nsMsgSearchBoolExpression ** aExpressionTree,</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-                bool *pResult);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  static nsresult MatchTerms(nsIMsgDBHdr *msgToMatch, nsIArray *termList,</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+                             const char *defaultCharset,</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+                             nsIMsgSearchScopeTerm *scope, nsIMsgDatabase *db,</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+                             const nsACString &amp;headers, bool ForFilters,</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+                             nsMsgSearchBoolExpression **aExpressionTree,</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+                             bool *pResult);</span>
<a href="#l16.103"></a><span id="l16.103"> </span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    static nsresult ConstructExpressionTree(nsIArray *termList,</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-                                      uint32_t termCount,</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-                                      uint32_t &amp;aStartPosInList,</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-                                      nsMsgSearchBoolExpression ** aExpressionTree);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+  static nsresult ConstructExpressionTree(</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+      nsIArray *termList, uint32_t termCount, uint32_t &amp;aStartPosInList,</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+      nsMsgSearchBoolExpression **aExpressionTree);</span>
<a href="#l16.111"></a><span id="l16.111"> </span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l16.114"></a><span id="l16.114">   nsCOMPtr&lt;nsISimpleEnumerator&gt; m_listContext;</span>
<a href="#l16.115"></a><span id="l16.115">   void CleanUpScope();</span>
<a href="#l16.116"></a><span id="l16.116"> };</span>
<a href="#l16.117"></a><span id="l16.117"> </span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+class nsMsgSearchOfflineNews : public nsMsgSearchOfflineMail {</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+ public:</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  nsMsgSearchOfflineNews(nsIMsgSearchScopeTerm *, nsIArray *);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+  virtual ~nsMsgSearchOfflineNews();</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+  NS_IMETHOD ValidateTerms() override;</span>
<a href="#l16.123"></a><span id="l16.123"> </span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-class nsMsgSearchOfflineNews : public nsMsgSearchOfflineMail</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-{</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-public:</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-  nsMsgSearchOfflineNews (nsIMsgSearchScopeTerm*, nsIArray*);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-  virtual ~nsMsgSearchOfflineNews ();</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-  NS_IMETHOD ValidateTerms () override;</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-  virtual nsresult OpenSummaryFile () override;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+  virtual nsresult OpenSummaryFile() override;</span>
<a href="#l16.133"></a><span id="l16.133"> };</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-</span>
<a href="#l16.137"></a><span id="l16.137"> #endif</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -30,1291 +30,1176 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> // This stuff lives in the base class because the IMAP search syntax</span>
<a href="#l17.6"></a><span id="l17.6"> // is used by the Dredd SEARCH command as well as IMAP itself</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> // km - the NOT and HEADER strings are not encoded with a trailing</span>
<a href="#l17.9"></a><span id="l17.9"> //      &lt;space&gt; because they always precede a mnemonic that has a</span>
<a href="#l17.10"></a><span id="l17.10"> //      preceding &lt;space&gt; and double &lt;space&gt; characters cause some</span>
<a href="#l17.11"></a><span id="l17.11"> //    imap servers to return an error.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapBefore   = &quot; SENTBEFORE &quot;;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapBody     = &quot; BODY &quot;;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapCC       = &quot; CC &quot;;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapFrom     = &quot; FROM &quot;;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapNot      = &quot; NOT&quot;;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapUnDeleted= &quot; UNDELETED&quot;;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapOr       = &quot; OR&quot;;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapSince    = &quot; SENTSINCE &quot;;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapSubject  = &quot; SUBJECT &quot;;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapTo       = &quot; TO &quot;;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapHeader   = &quot; HEADER&quot;;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapAnyText  = &quot; TEXT &quot;;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-const char *nsMsgSearchAdapter::m_kImapKeyword  = &quot; KEYWORD &quot;;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-const char *nsMsgSearchAdapter::m_kNntpKeywords = &quot; KEYWORDS &quot;; //ggrrrr...</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapBefore = &quot; SENTBEFORE &quot;;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapBody = &quot; BODY &quot;;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapCC = &quot; CC &quot;;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapFrom = &quot; FROM &quot;;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapNot = &quot; NOT&quot;;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapUnDeleted = &quot; UNDELETED&quot;;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapOr = &quot; OR&quot;;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapSince = &quot; SENTSINCE &quot;;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapSubject = &quot; SUBJECT &quot;;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapTo = &quot; TO &quot;;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapHeader = &quot; HEADER&quot;;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapAnyText = &quot; TEXT &quot;;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+const char *nsMsgSearchAdapter::m_kImapKeyword = &quot; KEYWORD &quot;;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+const char *nsMsgSearchAdapter::m_kNntpKeywords = &quot; KEYWORDS &quot;;  // ggrrrr...</span>
<a href="#l17.40"></a><span id="l17.40"> const char *nsMsgSearchAdapter::m_kImapSentOn = &quot; SENTON &quot;;</span>
<a href="#l17.41"></a><span id="l17.41"> const char *nsMsgSearchAdapter::m_kImapSeen = &quot; SEEN &quot;;</span>
<a href="#l17.42"></a><span id="l17.42"> const char *nsMsgSearchAdapter::m_kImapAnswered = &quot; ANSWERED &quot;;</span>
<a href="#l17.43"></a><span id="l17.43"> const char *nsMsgSearchAdapter::m_kImapNotSeen = &quot; UNSEEN &quot;;</span>
<a href="#l17.44"></a><span id="l17.44"> const char *nsMsgSearchAdapter::m_kImapNotAnswered = &quot; UNANSWERED &quot;;</span>
<a href="#l17.45"></a><span id="l17.45"> const char *nsMsgSearchAdapter::m_kImapCharset = &quot; CHARSET &quot;;</span>
<a href="#l17.46"></a><span id="l17.46"> const char *nsMsgSearchAdapter::m_kImapSizeSmaller = &quot; SMALLER &quot;;</span>
<a href="#l17.47"></a><span id="l17.47"> const char *nsMsgSearchAdapter::m_kImapSizeLarger = &quot; LARGER &quot;;</span>
<a href="#l17.48"></a><span id="l17.48"> const char *nsMsgSearchAdapter::m_kImapNew = &quot; NEW &quot;;</span>
<a href="#l17.49"></a><span id="l17.49"> const char *nsMsgSearchAdapter::m_kImapNotNew = &quot; OLD SEEN &quot;;</span>
<a href="#l17.50"></a><span id="l17.50"> const char *nsMsgSearchAdapter::m_kImapFlagged = &quot; FLAGGED &quot;;</span>
<a href="#l17.51"></a><span id="l17.51"> const char *nsMsgSearchAdapter::m_kImapNotFlagged = &quot; UNFLAGGED &quot;;</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53"> #define PREF_CUSTOM_HEADERS &quot;mailnews.customHeaders&quot;</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::FindTargetFolder(const nsMsgResultElement *,nsIMsgFolder * *)</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-{</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::FindTargetFolder(const nsMsgResultElement *,</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+                                                   nsIMsgFolder **) {</span>
<a href="#l17.59"></a><span id="l17.59">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.60"></a><span id="l17.60"> }</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::ModifyResultElement(nsMsgResultElement *, nsMsgSearchValue *)</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-{</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::ModifyResultElement(nsMsgResultElement *,</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+                                                      nsMsgSearchValue *) {</span>
<a href="#l17.66"></a><span id="l17.66">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.67"></a><span id="l17.67"> }</span>
<a href="#l17.68"></a><span id="l17.68"> </span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::OpenResultElement(nsMsgResultElement *)</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-{</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::OpenResultElement(nsMsgResultElement *) {</span>
<a href="#l17.72"></a><span id="l17.72">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.73"></a><span id="l17.73"> }</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75"> NS_IMPL_ISUPPORTS(nsMsgSearchAdapter, nsIMsgSearchAdapter)</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-nsMsgSearchAdapter::nsMsgSearchAdapter(nsIMsgSearchScopeTerm *scope, nsIArray *searchTerms)</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-  : m_searchTerms(searchTerms)</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-{</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+nsMsgSearchAdapter::nsMsgSearchAdapter(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+                                       nsIArray *searchTerms)</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+    : m_searchTerms(searchTerms) {</span>
<a href="#l17.83"></a><span id="l17.83">   m_scope = scope;</span>
<a href="#l17.84"></a><span id="l17.84"> }</span>
<a href="#l17.85"></a><span id="l17.85"> </span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-nsMsgSearchAdapter::~nsMsgSearchAdapter()</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-{</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-}</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+nsMsgSearchAdapter::~nsMsgSearchAdapter() {}</span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::ClearScope()</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-{</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  if (m_scope)</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-  {</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::ClearScope() {</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  if (m_scope) {</span>
<a href="#l17.97"></a><span id="l17.97">     m_scope-&gt;CloseInputStream();</span>
<a href="#l17.98"></a><span id="l17.98">     m_scope = nullptr;</span>
<a href="#l17.99"></a><span id="l17.99">   }</span>
<a href="#l17.100"></a><span id="l17.100">   return NS_OK;</span>
<a href="#l17.101"></a><span id="l17.101"> }</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::ValidateTerms ()</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-{</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-  // all this used to do is check if the object had been deleted - we can skip that.</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::ValidateTerms() {</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+  // all this used to do is check if the object had been deleted - we can skip</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+  // that.</span>
<a href="#l17.109"></a><span id="l17.109">   return NS_OK;</span>
<a href="#l17.110"></a><span id="l17.110"> }</span>
<a href="#l17.111"></a><span id="l17.111"> </span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::Abort ()</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-{</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::Abort() { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::Search(bool *aDone) { return NS_OK; }</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-}</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::Search (bool *aDone)</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-{</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-}</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::SendUrl ()</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-{</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-}</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::SendUrl() { return NS_OK; }</span>
<a href="#l17.129"></a><span id="l17.129"> </span>
<a href="#l17.130"></a><span id="l17.130"> /* void CurrentUrlDone (in nsresult exitCode); */</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::CurrentUrlDone(nsresult exitCode)</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-{</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::CurrentUrlDone(nsresult exitCode) {</span>
<a href="#l17.134"></a><span id="l17.134">   // base implementation doesn't need to do anything.</span>
<a href="#l17.135"></a><span id="l17.135">   return NS_OK;</span>
<a href="#l17.136"></a><span id="l17.136"> }</span>
<a href="#l17.137"></a><span id="l17.137"> </span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::GetEncoding (char **encoding)</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-{</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-}</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::GetEncoding(char **encoding) { return NS_OK; }</span>
<a href="#l17.143"></a><span id="l17.143"> </span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::AddResultElement (nsIMsgDBHdr *pHeaders)</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-{</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-    NS_ASSERTION(false, &quot;shouldn't call this base class impl&quot;);</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-}</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-NS_IMETHODIMP nsMsgSearchAdapter::AddHit(nsMsgKey key)</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-{</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::AddResultElement(nsIMsgDBHdr *pHeaders) {</span>
<a href="#l17.154"></a><span id="l17.154">   NS_ASSERTION(false, &quot;shouldn't call this base class impl&quot;);</span>
<a href="#l17.155"></a><span id="l17.155">   return NS_ERROR_FAILURE;</span>
<a href="#l17.156"></a><span id="l17.156"> }</span>
<a href="#l17.157"></a><span id="l17.157"> </span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+NS_IMETHODIMP nsMsgSearchAdapter::AddHit(nsMsgKey key) {</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+  NS_ASSERTION(false, &quot;shouldn't call this base class impl&quot;);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+}</span>
<a href="#l17.162"></a><span id="l17.162"> </span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-char *</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-nsMsgSearchAdapter::GetImapCharsetParam(const char16_t *destCharset)</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-{</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+char *nsMsgSearchAdapter::GetImapCharsetParam(const char16_t *destCharset) {</span>
<a href="#l17.167"></a><span id="l17.167">   char *result = nullptr;</span>
<a href="#l17.168"></a><span id="l17.168"> </span>
<a href="#l17.169"></a><span id="l17.169">   // Specify a character set unless we happen to be US-ASCII.</span>
<a href="#l17.170"></a><span id="l17.170">   if (NS_strcmp(destCharset, u&quot;us-ascii&quot;))</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-      result = PR_smprintf(&quot;%s%s&quot;, nsMsgSearchAdapter::m_kImapCharset, NS_ConvertUTF16toUTF8(destCharset).get());</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+    result = PR_smprintf(&quot;%s%s&quot;, nsMsgSearchAdapter::m_kImapCharset,</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+                         NS_ConvertUTF16toUTF8(destCharset).get());</span>
<a href="#l17.174"></a><span id="l17.174"> </span>
<a href="#l17.175"></a><span id="l17.175">   return result;</span>
<a href="#l17.176"></a><span id="l17.176"> }</span>
<a href="#l17.177"></a><span id="l17.177"> </span>
<a href="#l17.178"></a><span id="l17.178"> /*</span>
<a href="#l17.179"></a><span id="l17.179">    09/21/2000 - taka@netscape.com</span>
<a href="#l17.180"></a><span id="l17.180">    This method is bogus. Escape must be done against char * not char16_t *</span>
<a href="#l17.181"></a><span id="l17.181">    should be rewritten later.</span>
<a href="#l17.182"></a><span id="l17.182">    for now, just duplicate the string.</span>
<a href="#l17.183"></a><span id="l17.183"> */</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-char16_t *nsMsgSearchAdapter::EscapeSearchUrl (const char16_t *nntpCommand)</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-{</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+char16_t *nsMsgSearchAdapter::EscapeSearchUrl(const char16_t *nntpCommand) {</span>
<a href="#l17.187"></a><span id="l17.187">   return nntpCommand ? NS_xstrdup(nntpCommand) : nullptr;</span>
<a href="#l17.188"></a><span id="l17.188"> }</span>
<a href="#l17.189"></a><span id="l17.189"> </span>
<a href="#l17.190"></a><span id="l17.190"> /*</span>
<a href="#l17.191"></a><span id="l17.191">    09/21/2000 - taka@netscape.com</span>
<a href="#l17.192"></a><span id="l17.192">    This method is bogus. Escape must be done against char * not char16_t *</span>
<a href="#l17.193"></a><span id="l17.193">    should be rewritten later.</span>
<a href="#l17.194"></a><span id="l17.194">    for now, just duplicate the string.</span>
<a href="#l17.195"></a><span id="l17.195"> */</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-char16_t *</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-nsMsgSearchAdapter::EscapeImapSearchProtocol(const char16_t *imapCommand)</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-{</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+char16_t *nsMsgSearchAdapter::EscapeImapSearchProtocol(</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+    const char16_t *imapCommand) {</span>
<a href="#l17.201"></a><span id="l17.201">   return imapCommand ? NS_xstrdup(imapCommand) : nullptr;</span>
<a href="#l17.202"></a><span id="l17.202"> }</span>
<a href="#l17.203"></a><span id="l17.203"> </span>
<a href="#l17.204"></a><span id="l17.204"> /*</span>
<a href="#l17.205"></a><span id="l17.205">    09/21/2000 - taka@netscape.com</span>
<a href="#l17.206"></a><span id="l17.206">    This method is bogus. Escape must be done against char * not char16_t *</span>
<a href="#l17.207"></a><span id="l17.207">    should be rewritten later.</span>
<a href="#l17.208"></a><span id="l17.208">    for now, just duplicate the string.</span>
<a href="#l17.209"></a><span id="l17.209"> */</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-char16_t *</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-nsMsgSearchAdapter::EscapeQuoteImapSearchProtocol(const char16_t *imapCommand)</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-{</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+char16_t *nsMsgSearchAdapter::EscapeQuoteImapSearchProtocol(</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+    const char16_t *imapCommand) {</span>
<a href="#l17.215"></a><span id="l17.215">   return imapCommand ? NS_xstrdup(imapCommand) : nullptr;</span>
<a href="#l17.216"></a><span id="l17.216"> }</span>
<a href="#l17.217"></a><span id="l17.217"> </span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-char *nsMsgSearchAdapter::UnEscapeSearchUrl (const char *commandSpecificData)</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-{</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-  char *result = (char*) PR_Malloc (strlen(commandSpecificData) + 1);</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-  if (result)</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-  {</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+char *nsMsgSearchAdapter::UnEscapeSearchUrl(const char *commandSpecificData) {</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+  char *result = (char *)PR_Malloc(strlen(commandSpecificData) + 1);</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+  if (result) {</span>
<a href="#l17.226"></a><span id="l17.226">     char *resultPtr = result;</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-    while (1)</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-    {</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+    while (1) {</span>
<a href="#l17.230"></a><span id="l17.230">       char ch = *commandSpecificData++;</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-      if (!ch)</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-        break;</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-      if (ch == '\\')</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-      {</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+      if (!ch) break;</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+      if (ch == '\\') {</span>
<a href="#l17.237"></a><span id="l17.237">         char scratchBuf[3];</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-        scratchBuf[0] = (char) *commandSpecificData++;</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-        scratchBuf[1] = (char) *commandSpecificData++;</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+        scratchBuf[0] = (char)*commandSpecificData++;</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+        scratchBuf[1] = (char)*commandSpecificData++;</span>
<a href="#l17.242"></a><span id="l17.242">         scratchBuf[2] = '\0';</span>
<a href="#l17.243"></a><span id="l17.243">         unsigned int accum = 0;</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-        sscanf (scratchBuf, &quot;%X&quot;, &amp;accum);</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-        *resultPtr++ = (char) accum;</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-      }</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-      else</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+        sscanf(scratchBuf, &quot;%X&quot;, &amp;accum);</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+        *resultPtr++ = (char)accum;</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+      } else</span>
<a href="#l17.251"></a><span id="l17.251">         *resultPtr++ = ch;</span>
<a href="#l17.252"></a><span id="l17.252">     }</span>
<a href="#l17.253"></a><span id="l17.253">     *resultPtr = '\0';</span>
<a href="#l17.254"></a><span id="l17.254">   }</span>
<a href="#l17.255"></a><span id="l17.255">   return result;</span>
<a href="#l17.256"></a><span id="l17.256"> }</span>
<a href="#l17.257"></a><span id="l17.257"> </span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-nsresult</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-nsMsgSearchAdapter::GetSearchCharsets(nsAString &amp;srcCharset, nsAString &amp;dstCharset)</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-{</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+nsresult nsMsgSearchAdapter::GetSearchCharsets(nsAString &amp;srcCharset,</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+                                               nsAString &amp;dstCharset) {</span>
<a href="#l17.264"></a><span id="l17.264">   nsresult rv;</span>
<a href="#l17.265"></a><span id="l17.265">   bool forceAsciiSearch = false;</span>
<a href="#l17.266"></a><span id="l17.266"> </span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-  if (m_defaultCharset.IsEmpty())</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-  {</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-    {</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+  if (m_defaultCharset.IsEmpty()) {</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.276"></a><span id="l17.276">       nsCOMPtr&lt;nsIPrefLocalizedString&gt; localizedstr;</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-      rv = prefs-&gt;GetComplexValue(&quot;mailnews.view_default_charset&quot;, NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+      rv = prefs-&gt;GetComplexValue(&quot;mailnews.view_default_charset&quot;,</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+                                  NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l17.280"></a><span id="l17.280">                                   getter_AddRefs(localizedstr));</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineminus">-        localizedstr-&gt;GetData(m_defaultCharset);</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+      if (NS_SUCCEEDED(rv)) localizedstr-&gt;GetData(m_defaultCharset);</span>
<a href="#l17.284"></a><span id="l17.284"> </span>
<a href="#l17.285"></a><span id="l17.285">       prefs-&gt;GetBoolPref(&quot;mailnews.force_ascii_search&quot;, &amp;forceAsciiSearch);</span>
<a href="#l17.286"></a><span id="l17.286">     }</span>
<a href="#l17.287"></a><span id="l17.287">   }</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-  srcCharset = m_defaultCharset.IsEmpty() ?</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineminus">-    static_cast&lt;const nsAString&amp;&gt;(NS_LITERAL_STRING(&quot;ISO-8859-1&quot;)) :</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineminus">-    m_defaultCharset;</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+  srcCharset =</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+      m_defaultCharset.IsEmpty()</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+          ? static_cast&lt;const nsAString &amp;&gt;(NS_LITERAL_STRING(&quot;ISO-8859-1&quot;))</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+          : m_defaultCharset;</span>
<a href="#l17.295"></a><span id="l17.295"> </span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-  if (m_scope)</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineminus">-  {</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+  if (m_scope) {</span>
<a href="#l17.299"></a><span id="l17.299">     // ### DMB is there a way to get the charset for the &quot;window&quot;?</span>
<a href="#l17.300"></a><span id="l17.300"> </span>
<a href="#l17.301"></a><span id="l17.301">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.302"></a><span id="l17.302">     rv = m_scope-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l17.303"></a><span id="l17.303"> </span>
<a href="#l17.304"></a><span id="l17.304">     // Ask the newsgroup/folder for its csid.</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-    {</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l17.308"></a><span id="l17.308">       nsCString folderCharset;</span>
<a href="#l17.309"></a><span id="l17.309">       folder-&gt;GetCharset(folderCharset);</span>
<a href="#l17.310"></a><span id="l17.310">       dstCharset.Append(NS_ConvertASCIItoUTF16(folderCharset));</span>
<a href="#l17.311"></a><span id="l17.311">     }</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineminus">-  }</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineminus">-  else</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+  } else</span>
<a href="#l17.315"></a><span id="l17.315">     dstCharset.Assign(srcCharset);</span>
<a href="#l17.316"></a><span id="l17.316"> </span>
<a href="#l17.317"></a><span id="l17.317">   // If</span>
<a href="#l17.318"></a><span id="l17.318">   // the destination is still CS_DEFAULT, make the destination match</span>
<a href="#l17.319"></a><span id="l17.319">   // the source. (CS_DEFAULT is an indication that the charset</span>
<a href="#l17.320"></a><span id="l17.320">   // was undefined or unavailable.)</span>
<a href="#l17.321"></a><span id="l17.321">   // ### well, it's not really anymore. Is there an equivalent?</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineminus">-  if (dstCharset.Equals(m_defaultCharset))</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineminus">-  {</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+  if (dstCharset.Equals(m_defaultCharset)) {</span>
<a href="#l17.325"></a><span id="l17.325">     dstCharset.Assign(srcCharset);</span>
<a href="#l17.326"></a><span id="l17.326">   }</span>
<a href="#l17.327"></a><span id="l17.327"> </span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-  if (forceAsciiSearch)</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-  {</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+  if (forceAsciiSearch) {</span>
<a href="#l17.331"></a><span id="l17.331">     // Special cases to use in order to force US-ASCII searching with Latin1</span>
<a href="#l17.332"></a><span id="l17.332">     // or MacRoman text. Eurgh. This only has to happen because IMAP</span>
<a href="#l17.333"></a><span id="l17.333">     // and Dredd servers currently (4/23/97) only support US-ASCII.</span>
<a href="#l17.334"></a><span id="l17.334">     //</span>
<a href="#l17.335"></a><span id="l17.335">     // If the dest csid is ISO Latin 1 or MacRoman, attempt to convert the</span>
<a href="#l17.336"></a><span id="l17.336">     // source text to US-ASCII. (Not for now.)</span>
<a href="#l17.337"></a><span id="l17.337">     // if ((dst_csid == CS_LATIN1) || (dst_csid == CS_MAC_ROMAN))</span>
<a href="#l17.338"></a><span id="l17.338">     dstCharset.AssignLiteral(&quot;us-ascii&quot;);</span>
<a href="#l17.339"></a><span id="l17.339">   }</span>
<a href="#l17.340"></a><span id="l17.340"> </span>
<a href="#l17.341"></a><span id="l17.341">   return NS_OK;</span>
<a href="#l17.342"></a><span id="l17.342"> }</span>
<a href="#l17.343"></a><span id="l17.343"> </span>
<a href="#l17.344"></a><span id="l17.344" class="difflineminus">-nsresult nsMsgSearchAdapter::EncodeImapTerm (nsIMsgSearchTerm *term, bool reallyDredd, const char16_t *srcCharset, const char16_t *destCharset, char **ppOutTerm)</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineminus">-{</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+nsresult nsMsgSearchAdapter::EncodeImapTerm(nsIMsgSearchTerm *term,</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+                                            bool reallyDredd,</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+                                            const char16_t *srcCharset,</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+                                            const char16_t *destCharset,</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+                                            char **ppOutTerm) {</span>
<a href="#l17.351"></a><span id="l17.351">   NS_ENSURE_ARG_POINTER(term);</span>
<a href="#l17.352"></a><span id="l17.352">   NS_ENSURE_ARG_POINTER(ppOutTerm);</span>
<a href="#l17.353"></a><span id="l17.353"> </span>
<a href="#l17.354"></a><span id="l17.354">   nsresult err = NS_OK;</span>
<a href="#l17.355"></a><span id="l17.355">   bool useNot = false;</span>
<a href="#l17.356"></a><span id="l17.356">   bool useQuotes = false;</span>
<a href="#l17.357"></a><span id="l17.357">   bool ignoreValue = false;</span>
<a href="#l17.358"></a><span id="l17.358">   nsAutoCString arbitraryHeader;</span>
<a href="#l17.359"></a><span id="l17.359">   const char *whichMnemonic = nullptr;</span>
<a href="#l17.360"></a><span id="l17.360">   const char *orHeaderMnemonic = nullptr;</span>
<a href="#l17.361"></a><span id="l17.361"> </span>
<a href="#l17.362"></a><span id="l17.362">   *ppOutTerm = nullptr;</span>
<a href="#l17.363"></a><span id="l17.363"> </span>
<a href="#l17.364"></a><span id="l17.364" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l17.366"></a><span id="l17.366">   nsresult rv = term-&gt;GetValue(getter_AddRefs(searchValue));</span>
<a href="#l17.367"></a><span id="l17.367"> </span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.370"></a><span id="l17.370"> </span>
<a href="#l17.371"></a><span id="l17.371">   nsMsgSearchOpValue op;</span>
<a href="#l17.372"></a><span id="l17.372">   term-&gt;GetOp(&amp;op);</span>
<a href="#l17.373"></a><span id="l17.373"> </span>
<a href="#l17.374"></a><span id="l17.374">   if (op == nsMsgSearchOp::DoesntContain || op == nsMsgSearchOp::Isnt)</span>
<a href="#l17.375"></a><span id="l17.375">     useNot = true;</span>
<a href="#l17.376"></a><span id="l17.376"> </span>
<a href="#l17.377"></a><span id="l17.377">   nsMsgSearchAttribValue attrib;</span>
<a href="#l17.378"></a><span id="l17.378">   term-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l17.379"></a><span id="l17.379"> </span>
<a href="#l17.380"></a><span id="l17.380" class="difflineminus">-  switch (attrib)</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineminus">-  {</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineminus">-  case nsMsgSearchAttrib::ToOrCC:</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-    orHeaderMnemonic = m_kImapCC;</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineminus">-    // fall through to case nsMsgSearchAttrib::To:</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineminus">-    MOZ_FALLTHROUGH;</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineminus">-  case nsMsgSearchAttrib::To:</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineminus">-    whichMnemonic = m_kImapTo;</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineminus">-    break;</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineminus">-  case nsMsgSearchAttrib::CC:</span>
<a href="#l17.390"></a><span id="l17.390" class="difflineminus">-    whichMnemonic = m_kImapCC;</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-    break;</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineminus">-  case nsMsgSearchAttrib::Sender:</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineminus">-    whichMnemonic = m_kImapFrom;</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineminus">-    break;</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineminus">-  case nsMsgSearchAttrib::Subject:</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-    whichMnemonic = m_kImapSubject;</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineminus">-    break;</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-  case nsMsgSearchAttrib::Body:</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineminus">-    whichMnemonic = m_kImapBody;</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineminus">-    break;</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineminus">-  case nsMsgSearchAttrib::AgeInDays:  // added for searching online for age in days...</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineminus">-    // for AgeInDays, we are actually going to perform a search by date, so convert the operations for age</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineminus">-    // to the IMAP mnemonics that we would use for date!</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineminus">-    {</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineminus">-      // If we have a future date, the &gt; and &lt; are reversed.</span>
<a href="#l17.406"></a><span id="l17.406" class="difflineminus">-      // e.g. ageInDays &gt; 2 means more than 2 days old (&quot;date before X&quot;) whereas</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-      //      ageInDays &gt; -2 should be more than 2 days in the future (&quot;date after X&quot;)</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineminus">-      int32_t ageInDays;</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineminus">-      searchValue-&gt;GetAge(&amp;ageInDays);</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineminus">-      bool dateInFuture = (ageInDays &lt; 0);</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineminus">-      switch (op)</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineplus">+  switch (attrib) {</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineplus">+    case nsMsgSearchAttrib::ToOrCC:</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+      orHeaderMnemonic = m_kImapCC;</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineplus">+      // fall through to case nsMsgSearchAttrib::To:</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineplus">+    case nsMsgSearchAttrib::To:</span>
<a href="#l17.418"></a><span id="l17.418" class="difflineplus">+      whichMnemonic = m_kImapTo;</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineplus">+      break;</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineplus">+    case nsMsgSearchAttrib::CC:</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineplus">+      whichMnemonic = m_kImapCC;</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineplus">+      break;</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineplus">+    case nsMsgSearchAttrib::Sender:</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineplus">+      whichMnemonic = m_kImapFrom;</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineplus">+      break;</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineplus">+    case nsMsgSearchAttrib::Subject:</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineplus">+      whichMnemonic = m_kImapSubject;</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+      break;</span>
<a href="#l17.429"></a><span id="l17.429" class="difflineplus">+    case nsMsgSearchAttrib::Body:</span>
<a href="#l17.430"></a><span id="l17.430" class="difflineplus">+      whichMnemonic = m_kImapBody;</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineplus">+      break;</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineplus">+    case nsMsgSearchAttrib::AgeInDays:  // added for searching online for age in</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineplus">+                                        // days...</span>
<a href="#l17.434"></a><span id="l17.434" class="difflineplus">+      // for AgeInDays, we are actually going to perform a search by date, so</span>
<a href="#l17.435"></a><span id="l17.435" class="difflineplus">+      // convert the operations for age to the IMAP mnemonics that we would use</span>
<a href="#l17.436"></a><span id="l17.436" class="difflineplus">+      // for date!</span>
<a href="#l17.437"></a><span id="l17.437">       {</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineminus">-      case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineminus">-        whichMnemonic = (!dateInFuture) ? m_kImapBefore : m_kImapSince;</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineminus">-        break;</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineminus">-      case nsMsgSearchOp::IsLessThan:</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineminus">-        whichMnemonic = (!dateInFuture) ? m_kImapSince : m_kImapBefore;</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineminus">-        break;</span>
<a href="#l17.444"></a><span id="l17.444" class="difflineminus">-      case nsMsgSearchOp::Is:</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineminus">-        whichMnemonic = m_kImapSentOn;</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineminus">-        break;</span>
<a href="#l17.447"></a><span id="l17.447" class="difflineminus">-      default:</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineminus">-        NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineplus">+        // If we have a future date, the &gt; and &lt; are reversed.</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineplus">+        // e.g. ageInDays &gt; 2 means more than 2 days old (&quot;date before X&quot;)</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineplus">+        // whereas</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineplus">+        //      ageInDays &gt; -2 should be more than 2 days in the future (&quot;date</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineplus">+        //      after X&quot;)</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineplus">+        int32_t ageInDays;</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineplus">+        searchValue-&gt;GetAge(&amp;ageInDays);</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineplus">+        bool dateInFuture = (ageInDays &lt; 0);</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineplus">+        switch (op) {</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineplus">+          case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineplus">+            whichMnemonic = (!dateInFuture) ? m_kImapBefore : m_kImapSince;</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineplus">+            break;</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineplus">+          case nsMsgSearchOp::IsLessThan:</span>
<a href="#l17.463"></a><span id="l17.463" class="difflineplus">+            whichMnemonic = (!dateInFuture) ? m_kImapSince : m_kImapBefore;</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineplus">+            break;</span>
<a href="#l17.465"></a><span id="l17.465" class="difflineplus">+          case nsMsgSearchOp::Is:</span>
<a href="#l17.466"></a><span id="l17.466" class="difflineplus">+            whichMnemonic = m_kImapSentOn;</span>
<a href="#l17.467"></a><span id="l17.467" class="difflineplus">+            break;</span>
<a href="#l17.468"></a><span id="l17.468" class="difflineplus">+          default:</span>
<a href="#l17.469"></a><span id="l17.469" class="difflineplus">+            NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.470"></a><span id="l17.470" class="difflineplus">+            return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineplus">+        }</span>
<a href="#l17.472"></a><span id="l17.472">       }</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineminus">-    }</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineminus">-    break;</span>
<a href="#l17.475"></a><span id="l17.475" class="difflineminus">-  case nsMsgSearchAttrib::Size:</span>
<a href="#l17.476"></a><span id="l17.476" class="difflineminus">-    switch (op)</span>
<a href="#l17.477"></a><span id="l17.477" class="difflineminus">-    {</span>
<a href="#l17.478"></a><span id="l17.478" class="difflineminus">-    case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l17.479"></a><span id="l17.479" class="difflineminus">-      whichMnemonic = m_kImapSizeLarger;</span>
<a href="#l17.480"></a><span id="l17.480">       break;</span>
<a href="#l17.481"></a><span id="l17.481" class="difflineminus">-    case nsMsgSearchOp::IsLessThan:</span>
<a href="#l17.482"></a><span id="l17.482" class="difflineminus">-      whichMnemonic = m_kImapSizeSmaller;</span>
<a href="#l17.483"></a><span id="l17.483" class="difflineplus">+    case nsMsgSearchAttrib::Size:</span>
<a href="#l17.484"></a><span id="l17.484" class="difflineplus">+      switch (op) {</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineplus">+        case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineplus">+          whichMnemonic = m_kImapSizeLarger;</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineplus">+          break;</span>
<a href="#l17.488"></a><span id="l17.488" class="difflineplus">+        case nsMsgSearchOp::IsLessThan:</span>
<a href="#l17.489"></a><span id="l17.489" class="difflineplus">+          whichMnemonic = m_kImapSizeSmaller;</span>
<a href="#l17.490"></a><span id="l17.490" class="difflineplus">+          break;</span>
<a href="#l17.491"></a><span id="l17.491" class="difflineplus">+        default:</span>
<a href="#l17.492"></a><span id="l17.492" class="difflineplus">+          NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.493"></a><span id="l17.493" class="difflineplus">+          return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineplus">+      }</span>
<a href="#l17.495"></a><span id="l17.495">       break;</span>
<a href="#l17.496"></a><span id="l17.496" class="difflineminus">-    default:</span>
<a href="#l17.497"></a><span id="l17.497" class="difflineminus">-      NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.498"></a><span id="l17.498" class="difflineminus">-      return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.499"></a><span id="l17.499" class="difflineminus">-    }</span>
<a href="#l17.500"></a><span id="l17.500" class="difflineminus">-    break;</span>
<a href="#l17.501"></a><span id="l17.501">     case nsMsgSearchAttrib::Date:</span>
<a href="#l17.502"></a><span id="l17.502" class="difflineminus">-      switch (op)</span>
<a href="#l17.503"></a><span id="l17.503" class="difflineminus">-      {</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineminus">-      case nsMsgSearchOp::IsBefore:</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineminus">-        whichMnemonic = m_kImapBefore;</span>
<a href="#l17.506"></a><span id="l17.506" class="difflineminus">-        break;</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineminus">-      case nsMsgSearchOp::IsAfter:</span>
<a href="#l17.508"></a><span id="l17.508" class="difflineminus">-        whichMnemonic = m_kImapSince;</span>
<a href="#l17.509"></a><span id="l17.509" class="difflineminus">-        break;</span>
<a href="#l17.510"></a><span id="l17.510" class="difflineminus">-      case nsMsgSearchOp::Isnt:  /* we've already added the &quot;Not&quot; so just process it like it was a date is search */</span>
<a href="#l17.511"></a><span id="l17.511" class="difflineminus">-      case nsMsgSearchOp::Is:</span>
<a href="#l17.512"></a><span id="l17.512" class="difflineminus">-        whichMnemonic = m_kImapSentOn;</span>
<a href="#l17.513"></a><span id="l17.513" class="difflineminus">-        break;</span>
<a href="#l17.514"></a><span id="l17.514" class="difflineminus">-      default:</span>
<a href="#l17.515"></a><span id="l17.515" class="difflineminus">-        NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.516"></a><span id="l17.516" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.517"></a><span id="l17.517" class="difflineplus">+      switch (op) {</span>
<a href="#l17.518"></a><span id="l17.518" class="difflineplus">+        case nsMsgSearchOp::IsBefore:</span>
<a href="#l17.519"></a><span id="l17.519" class="difflineplus">+          whichMnemonic = m_kImapBefore;</span>
<a href="#l17.520"></a><span id="l17.520" class="difflineplus">+          break;</span>
<a href="#l17.521"></a><span id="l17.521" class="difflineplus">+        case nsMsgSearchOp::IsAfter:</span>
<a href="#l17.522"></a><span id="l17.522" class="difflineplus">+          whichMnemonic = m_kImapSince;</span>
<a href="#l17.523"></a><span id="l17.523" class="difflineplus">+          break;</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineplus">+        case nsMsgSearchOp::Isnt: /* we've already added the &quot;Not&quot; so just</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineplus">+                                     process it like it was a date is search */</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineplus">+        case nsMsgSearchOp::Is:</span>
<a href="#l17.527"></a><span id="l17.527" class="difflineplus">+          whichMnemonic = m_kImapSentOn;</span>
<a href="#l17.528"></a><span id="l17.528" class="difflineplus">+          break;</span>
<a href="#l17.529"></a><span id="l17.529" class="difflineplus">+        default:</span>
<a href="#l17.530"></a><span id="l17.530" class="difflineplus">+          NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.531"></a><span id="l17.531" class="difflineplus">+          return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.532"></a><span id="l17.532">       }</span>
<a href="#l17.533"></a><span id="l17.533">       break;</span>
<a href="#l17.534"></a><span id="l17.534">     case nsMsgSearchAttrib::AnyText:</span>
<a href="#l17.535"></a><span id="l17.535">       whichMnemonic = m_kImapAnyText;</span>
<a href="#l17.536"></a><span id="l17.536">       break;</span>
<a href="#l17.537"></a><span id="l17.537">     case nsMsgSearchAttrib::Keywords:</span>
<a href="#l17.538"></a><span id="l17.538">       whichMnemonic = m_kImapKeyword;</span>
<a href="#l17.539"></a><span id="l17.539">       break;</span>
<a href="#l17.540"></a><span id="l17.540">     case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineminus">-      useNot = false; // bizarrely, NOT SEEN is wrong, but UNSEEN is right.</span>
<a href="#l17.542"></a><span id="l17.542" class="difflineminus">-      ignoreValue = true; // the mnemonic is all we need</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineplus">+      useNot = false;      // bizarrely, NOT SEEN is wrong, but UNSEEN is right.</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineplus">+      ignoreValue = true;  // the mnemonic is all we need</span>
<a href="#l17.545"></a><span id="l17.545">       uint32_t status;</span>
<a href="#l17.546"></a><span id="l17.546">       searchValue-&gt;GetStatus(&amp;status);</span>
<a href="#l17.547"></a><span id="l17.547"> </span>
<a href="#l17.548"></a><span id="l17.548" class="difflineminus">-      switch (status)</span>
<a href="#l17.549"></a><span id="l17.549" class="difflineminus">-      {</span>
<a href="#l17.550"></a><span id="l17.550" class="difflineminus">-      case nsMsgMessageFlags::Read:</span>
<a href="#l17.551"></a><span id="l17.551" class="difflineminus">-        whichMnemonic = op == nsMsgSearchOp::Is ? m_kImapSeen : m_kImapNotSeen;</span>
<a href="#l17.552"></a><span id="l17.552" class="difflineminus">-        break;</span>
<a href="#l17.553"></a><span id="l17.553" class="difflineminus">-      case nsMsgMessageFlags::Replied:</span>
<a href="#l17.554"></a><span id="l17.554" class="difflineminus">-        whichMnemonic = op == nsMsgSearchOp::Is ? m_kImapAnswered : m_kImapNotAnswered;</span>
<a href="#l17.555"></a><span id="l17.555" class="difflineminus">-        break;</span>
<a href="#l17.556"></a><span id="l17.556" class="difflineminus">-      case nsMsgMessageFlags::New:</span>
<a href="#l17.557"></a><span id="l17.557" class="difflineminus">-        whichMnemonic = op == nsMsgSearchOp::Is ? m_kImapNew : m_kImapNotNew;</span>
<a href="#l17.558"></a><span id="l17.558" class="difflineminus">-        break;</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineminus">-      case nsMsgMessageFlags::Marked:</span>
<a href="#l17.560"></a><span id="l17.560" class="difflineminus">-        whichMnemonic = op == nsMsgSearchOp::Is ? m_kImapFlagged : m_kImapNotFlagged;</span>
<a href="#l17.561"></a><span id="l17.561" class="difflineminus">-        break;</span>
<a href="#l17.562"></a><span id="l17.562" class="difflineminus">-      default:</span>
<a href="#l17.563"></a><span id="l17.563" class="difflineminus">-        NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineplus">+      switch (status) {</span>
<a href="#l17.566"></a><span id="l17.566" class="difflineplus">+        case nsMsgMessageFlags::Read:</span>
<a href="#l17.567"></a><span id="l17.567" class="difflineplus">+          whichMnemonic =</span>
<a href="#l17.568"></a><span id="l17.568" class="difflineplus">+              op == nsMsgSearchOp::Is ? m_kImapSeen : m_kImapNotSeen;</span>
<a href="#l17.569"></a><span id="l17.569" class="difflineplus">+          break;</span>
<a href="#l17.570"></a><span id="l17.570" class="difflineplus">+        case nsMsgMessageFlags::Replied:</span>
<a href="#l17.571"></a><span id="l17.571" class="difflineplus">+          whichMnemonic =</span>
<a href="#l17.572"></a><span id="l17.572" class="difflineplus">+              op == nsMsgSearchOp::Is ? m_kImapAnswered : m_kImapNotAnswered;</span>
<a href="#l17.573"></a><span id="l17.573" class="difflineplus">+          break;</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineplus">+        case nsMsgMessageFlags::New:</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineplus">+          whichMnemonic = op == nsMsgSearchOp::Is ? m_kImapNew : m_kImapNotNew;</span>
<a href="#l17.576"></a><span id="l17.576" class="difflineplus">+          break;</span>
<a href="#l17.577"></a><span id="l17.577" class="difflineplus">+        case nsMsgMessageFlags::Marked:</span>
<a href="#l17.578"></a><span id="l17.578" class="difflineplus">+          whichMnemonic =</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineplus">+              op == nsMsgSearchOp::Is ? m_kImapFlagged : m_kImapNotFlagged;</span>
<a href="#l17.580"></a><span id="l17.580" class="difflineplus">+          break;</span>
<a href="#l17.581"></a><span id="l17.581" class="difflineplus">+        default:</span>
<a href="#l17.582"></a><span id="l17.582" class="difflineplus">+          NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.583"></a><span id="l17.583" class="difflineplus">+          return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.584"></a><span id="l17.584">       }</span>
<a href="#l17.585"></a><span id="l17.585">       break;</span>
<a href="#l17.586"></a><span id="l17.586">     default:</span>
<a href="#l17.587"></a><span id="l17.587" class="difflineminus">-      if ( attrib &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp; attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l17.588"></a><span id="l17.588" class="difflineminus">-      {</span>
<a href="#l17.589"></a><span id="l17.589" class="difflineplus">+      if (attrib &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l17.590"></a><span id="l17.590" class="difflineplus">+          attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes) {</span>
<a href="#l17.591"></a><span id="l17.591">         nsCString arbitraryHeaderTerm;</span>
<a href="#l17.592"></a><span id="l17.592">         term-&gt;GetArbitraryHeader(arbitraryHeaderTerm);</span>
<a href="#l17.593"></a><span id="l17.593" class="difflineminus">-        if (!arbitraryHeaderTerm.IsEmpty())</span>
<a href="#l17.594"></a><span id="l17.594" class="difflineminus">-        {</span>
<a href="#l17.595"></a><span id="l17.595" class="difflineplus">+        if (!arbitraryHeaderTerm.IsEmpty()) {</span>
<a href="#l17.596"></a><span id="l17.596">           arbitraryHeader.AssignLiteral(&quot; \&quot;&quot;);</span>
<a href="#l17.597"></a><span id="l17.597">           arbitraryHeader.Append(arbitraryHeaderTerm);</span>
<a href="#l17.598"></a><span id="l17.598">           arbitraryHeader.AppendLiteral(&quot;\&quot; &quot;);</span>
<a href="#l17.599"></a><span id="l17.599">           whichMnemonic = arbitraryHeader.get();</span>
<a href="#l17.600"></a><span id="l17.600" class="difflineminus">-        }</span>
<a href="#l17.601"></a><span id="l17.601" class="difflineminus">-        else</span>
<a href="#l17.602"></a><span id="l17.602" class="difflineplus">+        } else</span>
<a href="#l17.603"></a><span id="l17.603">           return NS_ERROR_FAILURE;</span>
<a href="#l17.604"></a><span id="l17.604" class="difflineminus">-      }</span>
<a href="#l17.605"></a><span id="l17.605" class="difflineminus">-      else</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineminus">-      {</span>
<a href="#l17.607"></a><span id="l17.607" class="difflineplus">+      } else {</span>
<a href="#l17.608"></a><span id="l17.608">         NS_ASSERTION(false, &quot;invalid search operator&quot;);</span>
<a href="#l17.609"></a><span id="l17.609">         return NS_ERROR_INVALID_ARG;</span>
<a href="#l17.610"></a><span id="l17.610">       }</span>
<a href="#l17.611"></a><span id="l17.611" class="difflineplus">+  }</span>
<a href="#l17.612"></a><span id="l17.612" class="difflineplus">+</span>
<a href="#l17.613"></a><span id="l17.613" class="difflineplus">+  char *value = nullptr;</span>
<a href="#l17.614"></a><span id="l17.614" class="difflineplus">+  char dateBuf[100];</span>
<a href="#l17.615"></a><span id="l17.615" class="difflineplus">+  dateBuf[0] = '\0';</span>
<a href="#l17.616"></a><span id="l17.616" class="difflineplus">+</span>
<a href="#l17.617"></a><span id="l17.617" class="difflineplus">+  bool valueWasAllocated = false;</span>
<a href="#l17.618"></a><span id="l17.618" class="difflineplus">+  if (attrib == nsMsgSearchAttrib::Date) {</span>
<a href="#l17.619"></a><span id="l17.619" class="difflineplus">+    // note that there used to be code here that encoded an RFC822 date for imap</span>
<a href="#l17.620"></a><span id="l17.620" class="difflineplus">+    // searches. The IMAP RFC 2060 is misleading to the point that it looks like</span>
<a href="#l17.621"></a><span id="l17.621" class="difflineplus">+    // it requires an RFC822 date but really it expects dd-mmm-yyyy, like dredd,</span>
<a href="#l17.622"></a><span id="l17.622" class="difflineplus">+    // and refers to the RFC822 date only in that the dd-mmm-yyyy date will</span>
<a href="#l17.623"></a><span id="l17.623" class="difflineplus">+    // match the RFC822 date within the message.</span>
<a href="#l17.624"></a><span id="l17.624" class="difflineplus">+</span>
<a href="#l17.625"></a><span id="l17.625" class="difflineplus">+    PRTime adjustedDate;</span>
<a href="#l17.626"></a><span id="l17.626" class="difflineplus">+    searchValue-&gt;GetDate(&amp;adjustedDate);</span>
<a href="#l17.627"></a><span id="l17.627" class="difflineplus">+    if (whichMnemonic == m_kImapSince) {</span>
<a href="#l17.628"></a><span id="l17.628" class="difflineplus">+      // it looks like the IMAP server searches on Since includes the date in</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineplus">+      // question... our UI presents Is, IsGreater and IsLessThan. For the</span>
<a href="#l17.630"></a><span id="l17.630" class="difflineplus">+      // IsGreater case (m_kImapSince) we need to adjust the date so we get</span>
<a href="#l17.631"></a><span id="l17.631" class="difflineplus">+      // greater than and not greater than or equal to which is what the IMAP</span>
<a href="#l17.632"></a><span id="l17.632" class="difflineplus">+      // server wants to search on won't work on Mac.</span>
<a href="#l17.633"></a><span id="l17.633" class="difflineplus">+      adjustedDate += PR_USEC_PER_DAY;</span>
<a href="#l17.634"></a><span id="l17.634">     }</span>
<a href="#l17.635"></a><span id="l17.635"> </span>
<a href="#l17.636"></a><span id="l17.636" class="difflineminus">-    char *value = nullptr;</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineminus">-    char dateBuf[100];</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineminus">-    dateBuf[0] = '\0';</span>
<a href="#l17.639"></a><span id="l17.639" class="difflineminus">-</span>
<a href="#l17.640"></a><span id="l17.640" class="difflineminus">-    bool valueWasAllocated = false;</span>
<a href="#l17.641"></a><span id="l17.641" class="difflineminus">-    if (attrib == nsMsgSearchAttrib::Date)</span>
<a href="#l17.642"></a><span id="l17.642" class="difflineminus">-    {</span>
<a href="#l17.643"></a><span id="l17.643" class="difflineminus">-      // note that there used to be code here that encoded an RFC822 date for imap searches.</span>
<a href="#l17.644"></a><span id="l17.644" class="difflineminus">-      // The IMAP RFC 2060 is misleading to the point that it looks like it requires an RFC822</span>
<a href="#l17.645"></a><span id="l17.645" class="difflineminus">-      // date but really it expects dd-mmm-yyyy, like dredd, and refers to the RFC822 date only in that the</span>
<a href="#l17.646"></a><span id="l17.646" class="difflineminus">-      // dd-mmm-yyyy date will match the RFC822 date within the message.</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineplus">+    PRExplodedTime exploded;</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineplus">+    PR_ExplodeTime(adjustedDate, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineplus">+    PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l17.650"></a><span id="l17.650" class="difflineplus">+    //    strftime (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, localtime (/*</span>
<a href="#l17.651"></a><span id="l17.651" class="difflineplus">+    //    &amp;term-&gt;m_value.u.date */ &amp;adjustedDate));</span>
<a href="#l17.652"></a><span id="l17.652" class="difflineplus">+    value = dateBuf;</span>
<a href="#l17.653"></a><span id="l17.653" class="difflineplus">+  } else {</span>
<a href="#l17.654"></a><span id="l17.654" class="difflineplus">+    if (attrib == nsMsgSearchAttrib::AgeInDays) {</span>
<a href="#l17.655"></a><span id="l17.655" class="difflineplus">+      // okay, take the current date, subtract off the age in days, then do an</span>
<a href="#l17.656"></a><span id="l17.656" class="difflineplus">+      // appropriate Date search on the resulting day.</span>
<a href="#l17.657"></a><span id="l17.657" class="difflineplus">+      int32_t ageInDays;</span>
<a href="#l17.658"></a><span id="l17.658"> </span>
<a href="#l17.659"></a><span id="l17.659" class="difflineminus">-      PRTime adjustedDate;</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-      searchValue-&gt;GetDate(&amp;adjustedDate);</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineminus">-      if (whichMnemonic == m_kImapSince)</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineminus">-      {</span>
<a href="#l17.663"></a><span id="l17.663" class="difflineminus">-        // it looks like the IMAP server searches on Since includes the date in question...</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineminus">-        // our UI presents Is, IsGreater and IsLessThan. For the IsGreater case (m_kImapSince)</span>
<a href="#l17.665"></a><span id="l17.665" class="difflineminus">-        // we need to adjust the date so we get greater than and not greater than or equal to which</span>
<a href="#l17.666"></a><span id="l17.666" class="difflineminus">-        // is what the IMAP server wants to search on</span>
<a href="#l17.667"></a><span id="l17.667" class="difflineminus">-        // won't work on Mac.</span>
<a href="#l17.668"></a><span id="l17.668" class="difflineminus">-        adjustedDate += PR_USEC_PER_DAY;</span>
<a href="#l17.669"></a><span id="l17.669" class="difflineminus">-      }</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineplus">+      searchValue-&gt;GetAge(&amp;ageInDays);</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineplus">+</span>
<a href="#l17.672"></a><span id="l17.672" class="difflineplus">+      PRTime now = PR_Now();</span>
<a href="#l17.673"></a><span id="l17.673" class="difflineplus">+      PRTime matchDay = now - ageInDays * PR_USEC_PER_DAY;</span>
<a href="#l17.674"></a><span id="l17.674"> </span>
<a href="#l17.675"></a><span id="l17.675">       PRExplodedTime exploded;</span>
<a href="#l17.676"></a><span id="l17.676" class="difflineminus">-      PR_ExplodeTime(adjustedDate, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l17.677"></a><span id="l17.677" class="difflineplus">+      PR_ExplodeTime(matchDay, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l17.678"></a><span id="l17.678">       PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l17.679"></a><span id="l17.679" class="difflineminus">-      //    strftime (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, localtime (/* &amp;term-&gt;m_value.u.date */ &amp;adjustedDate));</span>
<a href="#l17.680"></a><span id="l17.680" class="difflineplus">+      //      strftime (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, localtime</span>
<a href="#l17.681"></a><span id="l17.681" class="difflineplus">+      //      (&amp;matchDay));</span>
<a href="#l17.682"></a><span id="l17.682">       value = dateBuf;</span>
<a href="#l17.683"></a><span id="l17.683" class="difflineminus">-    }</span>
<a href="#l17.684"></a><span id="l17.684" class="difflineminus">-    else</span>
<a href="#l17.685"></a><span id="l17.685" class="difflineminus">-    {</span>
<a href="#l17.686"></a><span id="l17.686" class="difflineminus">-      if (attrib == nsMsgSearchAttrib::AgeInDays)</span>
<a href="#l17.687"></a><span id="l17.687" class="difflineminus">-      {</span>
<a href="#l17.688"></a><span id="l17.688" class="difflineminus">-        // okay, take the current date, subtract off the age in days, then do an appropriate Date search on</span>
<a href="#l17.689"></a><span id="l17.689" class="difflineminus">-        // the resulting day.</span>
<a href="#l17.690"></a><span id="l17.690" class="difflineminus">-        int32_t ageInDays;</span>
<a href="#l17.691"></a><span id="l17.691" class="difflineplus">+    } else if (attrib == nsMsgSearchAttrib::Size) {</span>
<a href="#l17.692"></a><span id="l17.692" class="difflineplus">+      uint32_t sizeValue;</span>
<a href="#l17.693"></a><span id="l17.693" class="difflineplus">+      nsAutoCString searchTermValue;</span>
<a href="#l17.694"></a><span id="l17.694" class="difflineplus">+      searchValue-&gt;GetSize(&amp;sizeValue);</span>
<a href="#l17.695"></a><span id="l17.695"> </span>
<a href="#l17.696"></a><span id="l17.696" class="difflineminus">-        searchValue-&gt;GetAge(&amp;ageInDays);</span>
<a href="#l17.697"></a><span id="l17.697" class="difflineplus">+      // Multiply by 1024 to get into kb resolution</span>
<a href="#l17.698"></a><span id="l17.698" class="difflineplus">+      sizeValue *= 1024;</span>
<a href="#l17.699"></a><span id="l17.699"> </span>
<a href="#l17.700"></a><span id="l17.700" class="difflineminus">-        PRTime now = PR_Now();</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineminus">-        PRTime matchDay = now - ageInDays * PR_USEC_PER_DAY;</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineplus">+      // Ensure that greater than is really greater than</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineplus">+      // in kb resolution.</span>
<a href="#l17.704"></a><span id="l17.704" class="difflineplus">+      if (op == nsMsgSearchOp::IsGreaterThan) sizeValue += 1024;</span>
<a href="#l17.705"></a><span id="l17.705" class="difflineplus">+</span>
<a href="#l17.706"></a><span id="l17.706" class="difflineplus">+      searchTermValue.AppendInt(sizeValue);</span>
<a href="#l17.707"></a><span id="l17.707"> </span>
<a href="#l17.708"></a><span id="l17.708" class="difflineminus">-        PRExplodedTime exploded;</span>
<a href="#l17.709"></a><span id="l17.709" class="difflineminus">-        PR_ExplodeTime(matchDay, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l17.710"></a><span id="l17.710" class="difflineminus">-        PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineminus">-        //      strftime (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, localtime (&amp;matchDay));</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineminus">-        value = dateBuf;</span>
<a href="#l17.713"></a><span id="l17.713" class="difflineminus">-      }</span>
<a href="#l17.714"></a><span id="l17.714" class="difflineminus">-      else if (attrib == nsMsgSearchAttrib::Size)</span>
<a href="#l17.715"></a><span id="l17.715" class="difflineminus">-      {</span>
<a href="#l17.716"></a><span id="l17.716" class="difflineminus">-        uint32_t sizeValue;</span>
<a href="#l17.717"></a><span id="l17.717" class="difflineminus">-        nsAutoCString searchTermValue;</span>
<a href="#l17.718"></a><span id="l17.718" class="difflineminus">-        searchValue-&gt;GetSize(&amp;sizeValue);</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineminus">-</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineminus">-        // Multiply by 1024 to get into kb resolution</span>
<a href="#l17.721"></a><span id="l17.721" class="difflineminus">-        sizeValue *= 1024;</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineminus">-</span>
<a href="#l17.723"></a><span id="l17.723" class="difflineminus">-        // Ensure that greater than is really greater than</span>
<a href="#l17.724"></a><span id="l17.724" class="difflineminus">-        // in kb resolution.</span>
<a href="#l17.725"></a><span id="l17.725" class="difflineminus">-        if (op == nsMsgSearchOp::IsGreaterThan)</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineminus">-          sizeValue += 1024;</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineplus">+      value = ToNewCString(searchTermValue);</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineplus">+      valueWasAllocated = true;</span>
<a href="#l17.729"></a><span id="l17.729" class="difflineplus">+    } else</span>
<a href="#l17.730"></a><span id="l17.730"> </span>
<a href="#l17.731"></a><span id="l17.731" class="difflineminus">-        searchTermValue.AppendInt(sizeValue);</span>
<a href="#l17.732"></a><span id="l17.732" class="difflineminus">-</span>
<a href="#l17.733"></a><span id="l17.733" class="difflineminus">-        value = ToNewCString(searchTermValue);</span>
<a href="#l17.734"></a><span id="l17.734" class="difflineminus">-        valueWasAllocated = true;</span>
<a href="#l17.735"></a><span id="l17.735" class="difflineminus">-      }</span>
<a href="#l17.736"></a><span id="l17.736" class="difflineplus">+        if (IS_STRING_ATTRIBUTE(attrib)) {</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineplus">+      char16_t *</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineplus">+          convertedValue;  // = reallyDredd ? MSG_EscapeSearchUrl</span>
<a href="#l17.739"></a><span id="l17.739" class="difflineplus">+                           // (term-&gt;m_value.u.string) :</span>
<a href="#l17.740"></a><span id="l17.740" class="difflineplus">+                           // msg_EscapeImapSearchProtocol(term-&gt;m_value.u.string);</span>
<a href="#l17.741"></a><span id="l17.741" class="difflineplus">+      nsString searchTermValue;</span>
<a href="#l17.742"></a><span id="l17.742" class="difflineplus">+      searchValue-&gt;GetStr(searchTermValue);</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineplus">+      // Ugly switch for Korean mail/news charsets.</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineplus">+      // We want to do this here because here is where</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineplus">+      // we know what charset we want to use.</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineplus">+#ifdef DOING_CHARSET</span>
<a href="#l17.747"></a><span id="l17.747" class="difflineplus">+      if (reallyDredd)</span>
<a href="#l17.748"></a><span id="l17.748" class="difflineplus">+        dest_csid = INTL_DefaultNewsCharSetID(dest_csid);</span>
<a href="#l17.749"></a><span id="l17.749">       else</span>
<a href="#l17.750"></a><span id="l17.750" class="difflineminus">-</span>
<a href="#l17.751"></a><span id="l17.751" class="difflineminus">-      if (IS_STRING_ATTRIBUTE(attrib))</span>
<a href="#l17.752"></a><span id="l17.752" class="difflineminus">-      {</span>
<a href="#l17.753"></a><span id="l17.753" class="difflineminus">-        char16_t *convertedValue; // = reallyDredd ? MSG_EscapeSearchUrl (term-&gt;m_value.u.string) : msg_EscapeImapSearchProtocol(term-&gt;m_value.u.string);</span>
<a href="#l17.754"></a><span id="l17.754" class="difflineminus">-        nsString searchTermValue;</span>
<a href="#l17.755"></a><span id="l17.755" class="difflineminus">-        searchValue-&gt;GetStr(searchTermValue);</span>
<a href="#l17.756"></a><span id="l17.756" class="difflineminus">-        // Ugly switch for Korean mail/news charsets.</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineminus">-        // We want to do this here because here is where</span>
<a href="#l17.758"></a><span id="l17.758" class="difflineminus">-        // we know what charset we want to use.</span>
<a href="#l17.759"></a><span id="l17.759" class="difflineminus">-#ifdef DOING_CHARSET</span>
<a href="#l17.760"></a><span id="l17.760" class="difflineminus">-        if (reallyDredd)</span>
<a href="#l17.761"></a><span id="l17.761" class="difflineminus">-          dest_csid = INTL_DefaultNewsCharSetID(dest_csid);</span>
<a href="#l17.762"></a><span id="l17.762" class="difflineminus">-        else</span>
<a href="#l17.763"></a><span id="l17.763" class="difflineminus">-          dest_csid = INTL_DefaultMailCharSetID(dest_csid);</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineplus">+        dest_csid = INTL_DefaultMailCharSetID(dest_csid);</span>
<a href="#l17.765"></a><span id="l17.765"> #endif</span>
<a href="#l17.766"></a><span id="l17.766"> </span>
<a href="#l17.767"></a><span id="l17.767" class="difflineminus">-        // do all sorts of crazy escaping</span>
<a href="#l17.768"></a><span id="l17.768" class="difflineminus">-        convertedValue = reallyDredd ? EscapeSearchUrl (searchTermValue.get()) :</span>
<a href="#l17.769"></a><span id="l17.769" class="difflineminus">-        EscapeImapSearchProtocol(searchTermValue.get());</span>
<a href="#l17.770"></a><span id="l17.770" class="difflineminus">-        useQuotes = ((!reallyDredd ||</span>
<a href="#l17.771"></a><span id="l17.771" class="difflineminus">-                    (nsDependentString(convertedValue).FindChar(char16_t(' ')) != -1)) &amp;&amp;</span>
<a href="#l17.772"></a><span id="l17.772" class="difflineplus">+      // do all sorts of crazy escaping</span>
<a href="#l17.773"></a><span id="l17.773" class="difflineplus">+      convertedValue = reallyDredd</span>
<a href="#l17.774"></a><span id="l17.774" class="difflineplus">+                           ? EscapeSearchUrl(searchTermValue.get())</span>
<a href="#l17.775"></a><span id="l17.775" class="difflineplus">+                           : EscapeImapSearchProtocol(searchTermValue.get());</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineplus">+      useQuotes =</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineplus">+          ((!reallyDredd ||</span>
<a href="#l17.778"></a><span id="l17.778" class="difflineplus">+            (nsDependentString(convertedValue).FindChar(char16_t(' ')) !=</span>
<a href="#l17.779"></a><span id="l17.779" class="difflineplus">+             -1)) &amp;&amp;</span>
<a href="#l17.780"></a><span id="l17.780">            (attrib != nsMsgSearchAttrib::Keywords));</span>
<a href="#l17.781"></a><span id="l17.781" class="difflineminus">-        // now convert to char* and escape quoted_specials</span>
<a href="#l17.782"></a><span id="l17.782" class="difflineminus">-        nsAutoCString valueStr;</span>
<a href="#l17.783"></a><span id="l17.783" class="difflineminus">-        nsresult rv = nsMsgI18NConvertFromUnicode(</span>
<a href="#l17.784"></a><span id="l17.784" class="difflineplus">+      // now convert to char* and escape quoted_specials</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineplus">+      nsAutoCString valueStr;</span>
<a href="#l17.786"></a><span id="l17.786" class="difflineplus">+      nsresult rv = nsMsgI18NConvertFromUnicode(</span>
<a href="#l17.787"></a><span id="l17.787">           NS_LossyConvertUTF16toASCII(destCharset),</span>
<a href="#l17.788"></a><span id="l17.788">           nsDependentString(convertedValue), valueStr);</span>
<a href="#l17.789"></a><span id="l17.789" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l17.790"></a><span id="l17.790" class="difflineminus">-        {</span>
<a href="#l17.791"></a><span id="l17.791" class="difflineminus">-          const char *vptr = valueStr.get();</span>
<a href="#l17.792"></a><span id="l17.792" class="difflineminus">-          // max escaped length is one extra character for every character in the cmd.</span>
<a href="#l17.793"></a><span id="l17.793" class="difflineminus">-          mozilla::UniquePtr&lt;char[]&gt; newValue = mozilla::MakeUnique&lt;char[]&gt;(2*strlen(vptr) + 1);</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineminus">-          if (newValue)</span>
<a href="#l17.795"></a><span id="l17.795" class="difflineminus">-          {</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineminus">-            char *p = newValue.get();</span>
<a href="#l17.797"></a><span id="l17.797" class="difflineminus">-            while (1)</span>
<a href="#l17.798"></a><span id="l17.798" class="difflineminus">-            {</span>
<a href="#l17.799"></a><span id="l17.799" class="difflineminus">-              char ch = *vptr++;</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineminus">-              if (!ch)</span>
<a href="#l17.801"></a><span id="l17.801" class="difflineminus">-                break;</span>
<a href="#l17.802"></a><span id="l17.802" class="difflineminus">-              if ((useQuotes ? ch == '&quot;' : 0) || ch == '\\')</span>
<a href="#l17.803"></a><span id="l17.803" class="difflineminus">-                *p++ = '\\';</span>
<a href="#l17.804"></a><span id="l17.804" class="difflineminus">-              *p++ = ch;</span>
<a href="#l17.805"></a><span id="l17.805" class="difflineminus">-            }</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineminus">-            *p = '\0';</span>
<a href="#l17.807"></a><span id="l17.807" class="difflineminus">-            value = strdup(newValue.get()); // realloc down to smaller size</span>
<a href="#l17.808"></a><span id="l17.808" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.809"></a><span id="l17.809" class="difflineplus">+        const char *vptr = valueStr.get();</span>
<a href="#l17.810"></a><span id="l17.810" class="difflineplus">+        // max escaped length is one extra character for every character in the</span>
<a href="#l17.811"></a><span id="l17.811" class="difflineplus">+        // cmd.</span>
<a href="#l17.812"></a><span id="l17.812" class="difflineplus">+        mozilla::UniquePtr&lt;char[]&gt; newValue =</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineplus">+            mozilla::MakeUnique&lt;char[]&gt;(2 * strlen(vptr) + 1);</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineplus">+        if (newValue) {</span>
<a href="#l17.815"></a><span id="l17.815" class="difflineplus">+          char *p = newValue.get();</span>
<a href="#l17.816"></a><span id="l17.816" class="difflineplus">+          while (1) {</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineplus">+            char ch = *vptr++;</span>
<a href="#l17.818"></a><span id="l17.818" class="difflineplus">+            if (!ch) break;</span>
<a href="#l17.819"></a><span id="l17.819" class="difflineplus">+            if ((useQuotes ? ch == '&quot;' : 0) || ch == '\\') *p++ = '\\';</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineplus">+            *p++ = ch;</span>
<a href="#l17.821"></a><span id="l17.821">           }</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineplus">+          *p = '\0';</span>
<a href="#l17.823"></a><span id="l17.823" class="difflineplus">+          value = strdup(newValue.get());  // realloc down to smaller size</span>
<a href="#l17.824"></a><span id="l17.824">         }</span>
<a href="#l17.825"></a><span id="l17.825" class="difflineminus">-        else</span>
<a href="#l17.826"></a><span id="l17.826" class="difflineminus">-          value = strdup(&quot;&quot;);</span>
<a href="#l17.827"></a><span id="l17.827" class="difflineminus">-        free(convertedValue);</span>
<a href="#l17.828"></a><span id="l17.828" class="difflineminus">-        valueWasAllocated = true;</span>
<a href="#l17.829"></a><span id="l17.829" class="difflineplus">+      } else</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineplus">+        value = strdup(&quot;&quot;);</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineplus">+      free(convertedValue);</span>
<a href="#l17.832"></a><span id="l17.832" class="difflineplus">+      valueWasAllocated = true;</span>
<a href="#l17.833"></a><span id="l17.833" class="difflineplus">+    }</span>
<a href="#l17.834"></a><span id="l17.834" class="difflineplus">+  }</span>
<a href="#l17.835"></a><span id="l17.835"> </span>
<a href="#l17.836"></a><span id="l17.836" class="difflineminus">-      }</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineplus">+  // this should be rewritten to use nsCString</span>
<a href="#l17.838"></a><span id="l17.838" class="difflineplus">+  int subLen = (value ? strlen(value) : 0) + (useNot ? strlen(m_kImapNot) : 0) +</span>
<a href="#l17.839"></a><span id="l17.839" class="difflineplus">+               strlen(m_kImapHeader);</span>
<a href="#l17.840"></a><span id="l17.840" class="difflineplus">+  int len =</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineplus">+      strlen(whichMnemonic) + subLen + (useQuotes ? 2 : 0) +</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineplus">+      (orHeaderMnemonic</span>
<a href="#l17.843"></a><span id="l17.843" class="difflineplus">+           ? (subLen + strlen(m_kImapOr) + strlen(orHeaderMnemonic) + 2 /*&quot;&quot;*/)</span>
<a href="#l17.844"></a><span id="l17.844" class="difflineplus">+           : 0) +</span>
<a href="#l17.845"></a><span id="l17.845" class="difflineplus">+      10;  // add slough for imap string literals</span>
<a href="#l17.846"></a><span id="l17.846" class="difflineplus">+  char *encoding = new char[len];</span>
<a href="#l17.847"></a><span id="l17.847" class="difflineplus">+  if (encoding) {</span>
<a href="#l17.848"></a><span id="l17.848" class="difflineplus">+    encoding[0] = '\0';</span>
<a href="#l17.849"></a><span id="l17.849" class="difflineplus">+    // Remember: if ToOrCC and useNot then the expression becomes NOT To AND Not</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineplus">+    // CC as opposed to (NOT TO) || (NOT CC)</span>
<a href="#l17.851"></a><span id="l17.851" class="difflineplus">+    if (orHeaderMnemonic &amp;&amp; !useNot) PL_strcat(encoding, m_kImapOr);</span>
<a href="#l17.852"></a><span id="l17.852" class="difflineplus">+    if (useNot) PL_strcat(encoding, m_kImapNot);</span>
<a href="#l17.853"></a><span id="l17.853" class="difflineplus">+    if (!arbitraryHeader.IsEmpty()) PL_strcat(encoding, m_kImapHeader);</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineplus">+    PL_strcat(encoding, whichMnemonic);</span>
<a href="#l17.855"></a><span id="l17.855" class="difflineplus">+    if (!ignoreValue)</span>
<a href="#l17.856"></a><span id="l17.856" class="difflineplus">+      err = EncodeImapValue(encoding, value, useQuotes, reallyDredd);</span>
<a href="#l17.857"></a><span id="l17.857" class="difflineplus">+</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineplus">+    if (orHeaderMnemonic) {</span>
<a href="#l17.859"></a><span id="l17.859" class="difflineplus">+      if (useNot) PL_strcat(encoding, m_kImapNot);</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineplus">+</span>
<a href="#l17.861"></a><span id="l17.861" class="difflineplus">+      PL_strcat(encoding, m_kImapHeader);</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineplus">+</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineplus">+      PL_strcat(encoding, orHeaderMnemonic);</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineplus">+      if (!ignoreValue)</span>
<a href="#l17.865"></a><span id="l17.865" class="difflineplus">+        err = EncodeImapValue(encoding, value, useQuotes, reallyDredd);</span>
<a href="#l17.866"></a><span id="l17.866">     }</span>
<a href="#l17.867"></a><span id="l17.867"> </span>
<a href="#l17.868"></a><span id="l17.868" class="difflineminus">-    // this should be rewritten to use nsCString</span>
<a href="#l17.869"></a><span id="l17.869" class="difflineminus">-    int subLen =</span>
<a href="#l17.870"></a><span id="l17.870" class="difflineminus">-      (value ? strlen(value) : 0) +</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineminus">-      (useNot ? strlen(m_kImapNot) : 0) +</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineminus">-      strlen(m_kImapHeader);</span>
<a href="#l17.873"></a><span id="l17.873" class="difflineminus">-    int len = strlen(whichMnemonic) + subLen + (useQuotes ? 2 : 0) +</span>
<a href="#l17.874"></a><span id="l17.874" class="difflineminus">-      (orHeaderMnemonic</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineminus">-       ? (subLen + strlen(m_kImapOr) + strlen(orHeaderMnemonic) + 2 /*&quot;&quot;*/)</span>
<a href="#l17.876"></a><span id="l17.876" class="difflineminus">-       : 0) +</span>
<a href="#l17.877"></a><span id="l17.877" class="difflineminus">-      10; // add slough for imap string literals</span>
<a href="#l17.878"></a><span id="l17.878" class="difflineminus">-    char *encoding = new char[len];</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineminus">-    if (encoding)</span>
<a href="#l17.880"></a><span id="l17.880" class="difflineminus">-    {</span>
<a href="#l17.881"></a><span id="l17.881" class="difflineminus">-      encoding[0] = '\0';</span>
<a href="#l17.882"></a><span id="l17.882" class="difflineminus">-      // Remember: if ToOrCC and useNot then the expression becomes NOT To AND Not CC as opposed to (NOT TO) || (NOT CC)</span>
<a href="#l17.883"></a><span id="l17.883" class="difflineminus">-      if (orHeaderMnemonic &amp;&amp; !useNot)</span>
<a href="#l17.884"></a><span id="l17.884" class="difflineminus">-        PL_strcat(encoding, m_kImapOr);</span>
<a href="#l17.885"></a><span id="l17.885" class="difflineminus">-      if (useNot)</span>
<a href="#l17.886"></a><span id="l17.886" class="difflineminus">-        PL_strcat (encoding, m_kImapNot);</span>
<a href="#l17.887"></a><span id="l17.887" class="difflineminus">-      if (!arbitraryHeader.IsEmpty())</span>
<a href="#l17.888"></a><span id="l17.888" class="difflineminus">-        PL_strcat (encoding, m_kImapHeader);</span>
<a href="#l17.889"></a><span id="l17.889" class="difflineminus">-      PL_strcat (encoding, whichMnemonic);</span>
<a href="#l17.890"></a><span id="l17.890" class="difflineminus">-      if (!ignoreValue)</span>
<a href="#l17.891"></a><span id="l17.891" class="difflineminus">-        err = EncodeImapValue(encoding, value, useQuotes, reallyDredd);</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineplus">+    // kmcentee, don't let the encoding end with whitespace,</span>
<a href="#l17.893"></a><span id="l17.893" class="difflineplus">+    // this throws off later url STRCMP</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineplus">+    if (*encoding &amp;&amp; *(encoding + strlen(encoding) - 1) == ' ')</span>
<a href="#l17.895"></a><span id="l17.895" class="difflineplus">+      *(encoding + strlen(encoding) - 1) = '\0';</span>
<a href="#l17.896"></a><span id="l17.896" class="difflineplus">+  }</span>
<a href="#l17.897"></a><span id="l17.897"> </span>
<a href="#l17.898"></a><span id="l17.898" class="difflineminus">-      if (orHeaderMnemonic)</span>
<a href="#l17.899"></a><span id="l17.899" class="difflineminus">-      {</span>
<a href="#l17.900"></a><span id="l17.900" class="difflineminus">-        if (useNot)</span>
<a href="#l17.901"></a><span id="l17.901" class="difflineminus">-          PL_strcat(encoding, m_kImapNot);</span>
<a href="#l17.902"></a><span id="l17.902" class="difflineminus">-</span>
<a href="#l17.903"></a><span id="l17.903" class="difflineminus">-        PL_strcat (encoding, m_kImapHeader);</span>
<a href="#l17.904"></a><span id="l17.904" class="difflineminus">-</span>
<a href="#l17.905"></a><span id="l17.905" class="difflineminus">-        PL_strcat (encoding, orHeaderMnemonic);</span>
<a href="#l17.906"></a><span id="l17.906" class="difflineminus">-        if (!ignoreValue)</span>
<a href="#l17.907"></a><span id="l17.907" class="difflineminus">-          err = EncodeImapValue(encoding, value, useQuotes, reallyDredd);</span>
<a href="#l17.908"></a><span id="l17.908" class="difflineminus">-      }</span>
<a href="#l17.909"></a><span id="l17.909" class="difflineplus">+  if (value &amp;&amp; valueWasAllocated) free(value);</span>
<a href="#l17.910"></a><span id="l17.910"> </span>
<a href="#l17.911"></a><span id="l17.911" class="difflineminus">-      // kmcentee, don't let the encoding end with whitespace,</span>
<a href="#l17.912"></a><span id="l17.912" class="difflineminus">-      // this throws off later url STRCMP</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineminus">-      if (*encoding &amp;&amp; *(encoding + strlen(encoding) - 1) == ' ')</span>
<a href="#l17.914"></a><span id="l17.914" class="difflineminus">-        *(encoding + strlen(encoding) - 1) = '\0';</span>
<a href="#l17.915"></a><span id="l17.915" class="difflineminus">-    }</span>
<a href="#l17.916"></a><span id="l17.916" class="difflineplus">+  *ppOutTerm = encoding;</span>
<a href="#l17.917"></a><span id="l17.917"> </span>
<a href="#l17.918"></a><span id="l17.918" class="difflineminus">-    if (value &amp;&amp; valueWasAllocated)</span>
<a href="#l17.919"></a><span id="l17.919" class="difflineminus">-      free (value);</span>
<a href="#l17.920"></a><span id="l17.920" class="difflineminus">-</span>
<a href="#l17.921"></a><span id="l17.921" class="difflineminus">-    *ppOutTerm = encoding;</span>
<a href="#l17.922"></a><span id="l17.922" class="difflineminus">-</span>
<a href="#l17.923"></a><span id="l17.923" class="difflineminus">-    return err;</span>
<a href="#l17.924"></a><span id="l17.924" class="difflineplus">+  return err;</span>
<a href="#l17.925"></a><span id="l17.925"> }</span>
<a href="#l17.926"></a><span id="l17.926"> </span>
<a href="#l17.927"></a><span id="l17.927" class="difflineminus">-nsresult nsMsgSearchAdapter::EncodeImapValue(char *encoding, const char *value, bool useQuotes, bool reallyDredd)</span>
<a href="#l17.928"></a><span id="l17.928" class="difflineminus">-{</span>
<a href="#l17.929"></a><span id="l17.929" class="difflineminus">-  // By NNTP RFC, SEARCH HEADER SUBJECT &quot;&quot; is legal and means 'find messages without a subject header'</span>
<a href="#l17.930"></a><span id="l17.930" class="difflineminus">-  if (!reallyDredd)</span>
<a href="#l17.931"></a><span id="l17.931" class="difflineminus">-  {</span>
<a href="#l17.932"></a><span id="l17.932" class="difflineminus">-    // By IMAP RFC, SEARCH HEADER SUBJECT &quot;&quot; is illegal and will generate an error from the server</span>
<a href="#l17.933"></a><span id="l17.933" class="difflineminus">-    if (!value || !value[0])</span>
<a href="#l17.934"></a><span id="l17.934" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.935"></a><span id="l17.935" class="difflineplus">+nsresult nsMsgSearchAdapter::EncodeImapValue(char *encoding, const char *value,</span>
<a href="#l17.936"></a><span id="l17.936" class="difflineplus">+                                             bool useQuotes, bool reallyDredd) {</span>
<a href="#l17.937"></a><span id="l17.937" class="difflineplus">+  // By NNTP RFC, SEARCH HEADER SUBJECT &quot;&quot; is legal and means 'find messages</span>
<a href="#l17.938"></a><span id="l17.938" class="difflineplus">+  // without a subject header'</span>
<a href="#l17.939"></a><span id="l17.939" class="difflineplus">+  if (!reallyDredd) {</span>
<a href="#l17.940"></a><span id="l17.940" class="difflineplus">+    // By IMAP RFC, SEARCH HEADER SUBJECT &quot;&quot; is illegal and will generate an</span>
<a href="#l17.941"></a><span id="l17.941" class="difflineplus">+    // error from the server</span>
<a href="#l17.942"></a><span id="l17.942" class="difflineplus">+    if (!value || !value[0]) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.943"></a><span id="l17.943">   }</span>
<a href="#l17.944"></a><span id="l17.944"> </span>
<a href="#l17.945"></a><span id="l17.945" class="difflineminus">-  if (!NS_IsAscii(value))</span>
<a href="#l17.946"></a><span id="l17.946" class="difflineminus">-  {</span>
<a href="#l17.947"></a><span id="l17.947" class="difflineplus">+  if (!NS_IsAscii(value)) {</span>
<a href="#l17.948"></a><span id="l17.948">     nsAutoCString lengthStr;</span>
<a href="#l17.949"></a><span id="l17.949">     PL_strcat(encoding, &quot;{&quot;);</span>
<a href="#l17.950"></a><span id="l17.950" class="difflineminus">-    lengthStr.AppendInt((int32_t) strlen(value));</span>
<a href="#l17.951"></a><span id="l17.951" class="difflineplus">+    lengthStr.AppendInt((int32_t)strlen(value));</span>
<a href="#l17.952"></a><span id="l17.952">     PL_strcat(encoding, lengthStr.get());</span>
<a href="#l17.953"></a><span id="l17.953">     PL_strcat(encoding, &quot;}&quot; CRLF);</span>
<a href="#l17.954"></a><span id="l17.954">     PL_strcat(encoding, value);</span>
<a href="#l17.955"></a><span id="l17.955">     return NS_OK;</span>
<a href="#l17.956"></a><span id="l17.956">   }</span>
<a href="#l17.957"></a><span id="l17.957" class="difflineminus">-  if (useQuotes)</span>
<a href="#l17.958"></a><span id="l17.958" class="difflineminus">-    PL_strcat(encoding, &quot;\&quot;&quot;);</span>
<a href="#l17.959"></a><span id="l17.959" class="difflineminus">-  PL_strcat (encoding, value);</span>
<a href="#l17.960"></a><span id="l17.960" class="difflineminus">-  if (useQuotes)</span>
<a href="#l17.961"></a><span id="l17.961" class="difflineminus">-    PL_strcat(encoding, &quot;\&quot;&quot;);</span>
<a href="#l17.962"></a><span id="l17.962" class="difflineplus">+  if (useQuotes) PL_strcat(encoding, &quot;\&quot;&quot;);</span>
<a href="#l17.963"></a><span id="l17.963" class="difflineplus">+  PL_strcat(encoding, value);</span>
<a href="#l17.964"></a><span id="l17.964" class="difflineplus">+  if (useQuotes) PL_strcat(encoding, &quot;\&quot;&quot;);</span>
<a href="#l17.965"></a><span id="l17.965"> </span>
<a href="#l17.966"></a><span id="l17.966">   return NS_OK;</span>
<a href="#l17.967"></a><span id="l17.967"> }</span>
<a href="#l17.968"></a><span id="l17.968"> </span>
<a href="#l17.969"></a><span id="l17.969" class="difflineminus">-</span>
<a href="#l17.970"></a><span id="l17.970" class="difflineminus">-nsresult nsMsgSearchAdapter::EncodeImap (char **ppOutEncoding, nsIArray *searchTerms, const char16_t *srcCharset, const char16_t *destCharset, bool reallyDredd)</span>
<a href="#l17.971"></a><span id="l17.971" class="difflineminus">-{</span>
<a href="#l17.972"></a><span id="l17.972" class="difflineminus">-  // i've left the old code (before using CBoolExpression for debugging purposes to make sure that</span>
<a href="#l17.973"></a><span id="l17.973" class="difflineminus">-  // the new code generates the same encoding string as the old code.....</span>
<a href="#l17.974"></a><span id="l17.974" class="difflineplus">+nsresult nsMsgSearchAdapter::EncodeImap(char **ppOutEncoding,</span>
<a href="#l17.975"></a><span id="l17.975" class="difflineplus">+                                        nsIArray *searchTerms,</span>
<a href="#l17.976"></a><span id="l17.976" class="difflineplus">+                                        const char16_t *srcCharset,</span>
<a href="#l17.977"></a><span id="l17.977" class="difflineplus">+                                        const char16_t *destCharset,</span>
<a href="#l17.978"></a><span id="l17.978" class="difflineplus">+                                        bool reallyDredd) {</span>
<a href="#l17.979"></a><span id="l17.979" class="difflineplus">+  // i've left the old code (before using CBoolExpression for debugging purposes</span>
<a href="#l17.980"></a><span id="l17.980" class="difflineplus">+  // to make sure that the new code generates the same encoding string as the</span>
<a href="#l17.981"></a><span id="l17.981" class="difflineplus">+  // old code.....</span>
<a href="#l17.982"></a><span id="l17.982"> </span>
<a href="#l17.983"></a><span id="l17.983">   nsresult err = NS_OK;</span>
<a href="#l17.984"></a><span id="l17.984">   *ppOutEncoding = nullptr;</span>
<a href="#l17.985"></a><span id="l17.985"> </span>
<a href="#l17.986"></a><span id="l17.986">   uint32_t termCount;</span>
<a href="#l17.987"></a><span id="l17.987">   searchTerms-&gt;GetLength(&amp;termCount);</span>
<a href="#l17.988"></a><span id="l17.988">   uint32_t i = 0;</span>
<a href="#l17.989"></a><span id="l17.989"> </span>
<a href="#l17.990"></a><span id="l17.990">   // create our expression</span>
<a href="#l17.991"></a><span id="l17.991" class="difflineminus">-  nsMsgSearchBoolExpression * expression = new nsMsgSearchBoolExpression();</span>
<a href="#l17.992"></a><span id="l17.992" class="difflineminus">-  if (!expression)</span>
<a href="#l17.993"></a><span id="l17.993" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.994"></a><span id="l17.994" class="difflineplus">+  nsMsgSearchBoolExpression *expression = new nsMsgSearchBoolExpression();</span>
<a href="#l17.995"></a><span id="l17.995" class="difflineplus">+  if (!expression) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.996"></a><span id="l17.996"> </span>
<a href="#l17.997"></a><span id="l17.997" class="difflineminus">-  for (i = 0; i &lt; termCount &amp;&amp; NS_SUCCEEDED(err); i++)</span>
<a href="#l17.998"></a><span id="l17.998" class="difflineminus">-  {</span>
<a href="#l17.999"></a><span id="l17.999" class="difflineplus">+  for (i = 0; i &lt; termCount &amp;&amp; NS_SUCCEEDED(err); i++) {</span>
<a href="#l17.1000"></a><span id="l17.1000">     char *termEncoding;</span>
<a href="#l17.1001"></a><span id="l17.1001">     bool matchAll;</span>
<a href="#l17.1002"></a><span id="l17.1002">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm = do_QueryElementAt(searchTerms, i);</span>
<a href="#l17.1003"></a><span id="l17.1003">     pTerm-&gt;GetMatchAll(&amp;matchAll);</span>
<a href="#l17.1004"></a><span id="l17.1004" class="difflineminus">-    if (matchAll)</span>
<a href="#l17.1005"></a><span id="l17.1005" class="difflineminus">-      continue;</span>
<a href="#l17.1006"></a><span id="l17.1006" class="difflineminus">-    err = EncodeImapTerm (pTerm, reallyDredd, srcCharset, destCharset, &amp;termEncoding);</span>
<a href="#l17.1007"></a><span id="l17.1007" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; nullptr != termEncoding)</span>
<a href="#l17.1008"></a><span id="l17.1008" class="difflineminus">-    {</span>
<a href="#l17.1009"></a><span id="l17.1009" class="difflineminus">-      expression = nsMsgSearchBoolExpression::AddSearchTerm(expression, pTerm, termEncoding);</span>
<a href="#l17.1010"></a><span id="l17.1010" class="difflineminus">-      delete [] termEncoding;</span>
<a href="#l17.1011"></a><span id="l17.1011" class="difflineplus">+    if (matchAll) continue;</span>
<a href="#l17.1012"></a><span id="l17.1012" class="difflineplus">+    err = EncodeImapTerm(pTerm, reallyDredd, srcCharset, destCharset,</span>
<a href="#l17.1013"></a><span id="l17.1013" class="difflineplus">+                         &amp;termEncoding);</span>
<a href="#l17.1014"></a><span id="l17.1014" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; nullptr != termEncoding) {</span>
<a href="#l17.1015"></a><span id="l17.1015" class="difflineplus">+      expression = nsMsgSearchBoolExpression::AddSearchTerm(expression, pTerm,</span>
<a href="#l17.1016"></a><span id="l17.1016" class="difflineplus">+                                                            termEncoding);</span>
<a href="#l17.1017"></a><span id="l17.1017" class="difflineplus">+      delete[] termEncoding;</span>
<a href="#l17.1018"></a><span id="l17.1018">     }</span>
<a href="#l17.1019"></a><span id="l17.1019">   }</span>
<a href="#l17.1020"></a><span id="l17.1020"> </span>
<a href="#l17.1021"></a><span id="l17.1021" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l17.1022"></a><span id="l17.1022" class="difflineminus">-  {</span>
<a href="#l17.1023"></a><span id="l17.1023" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l17.1024"></a><span id="l17.1024">     // Catenate the intermediate encodings together into a big string</span>
<a href="#l17.1025"></a><span id="l17.1025">     nsAutoCString encodingBuff;</span>
<a href="#l17.1026"></a><span id="l17.1026"> </span>
<a href="#l17.1027"></a><span id="l17.1027" class="difflineminus">-    if (!reallyDredd)</span>
<a href="#l17.1028"></a><span id="l17.1028" class="difflineminus">-      encodingBuff.Append(m_kImapUnDeleted);</span>
<a href="#l17.1029"></a><span id="l17.1029" class="difflineplus">+    if (!reallyDredd) encodingBuff.Append(m_kImapUnDeleted);</span>
<a href="#l17.1030"></a><span id="l17.1030"> </span>
<a href="#l17.1031"></a><span id="l17.1031">     expression-&gt;GenerateEncodeStr(&amp;encodingBuff);</span>
<a href="#l17.1032"></a><span id="l17.1032">     *ppOutEncoding = ToNewCString(encodingBuff);</span>
<a href="#l17.1033"></a><span id="l17.1033">   }</span>
<a href="#l17.1034"></a><span id="l17.1034"> </span>
<a href="#l17.1035"></a><span id="l17.1035">   delete expression;</span>
<a href="#l17.1036"></a><span id="l17.1036"> </span>
<a href="#l17.1037"></a><span id="l17.1037">   return err;</span>
<a href="#l17.1038"></a><span id="l17.1038"> }</span>
<a href="#l17.1039"></a><span id="l17.1039"> </span>
<a href="#l17.1040"></a><span id="l17.1040" class="difflineminus">-</span>
<a href="#l17.1041"></a><span id="l17.1041" class="difflineminus">-char *nsMsgSearchAdapter::TransformSpacesToStars (const char *spaceString, msg_TransformType transformType)</span>
<a href="#l17.1042"></a><span id="l17.1042" class="difflineminus">-{</span>
<a href="#l17.1043"></a><span id="l17.1043" class="difflineplus">+char *nsMsgSearchAdapter::TransformSpacesToStars(</span>
<a href="#l17.1044"></a><span id="l17.1044" class="difflineplus">+    const char *spaceString, msg_TransformType transformType) {</span>
<a href="#l17.1045"></a><span id="l17.1045">   char *starString;</span>
<a href="#l17.1046"></a><span id="l17.1046"> </span>
<a href="#l17.1047"></a><span id="l17.1047" class="difflineminus">-  if (transformType == kOverwrite)</span>
<a href="#l17.1048"></a><span id="l17.1048" class="difflineminus">-  {</span>
<a href="#l17.1049"></a><span id="l17.1049" class="difflineminus">-    if ((starString = strdup(spaceString)) != nullptr)</span>
<a href="#l17.1050"></a><span id="l17.1050" class="difflineminus">-    {</span>
<a href="#l17.1051"></a><span id="l17.1051" class="difflineplus">+  if (transformType == kOverwrite) {</span>
<a href="#l17.1052"></a><span id="l17.1052" class="difflineplus">+    if ((starString = strdup(spaceString)) != nullptr) {</span>
<a href="#l17.1053"></a><span id="l17.1053">       char *star = starString;</span>
<a href="#l17.1054"></a><span id="l17.1054" class="difflineminus">-      while ((star = PL_strchr(star, ' ')) != nullptr)</span>
<a href="#l17.1055"></a><span id="l17.1055" class="difflineminus">-        *star = '*';</span>
<a href="#l17.1056"></a><span id="l17.1056" class="difflineplus">+      while ((star = PL_strchr(star, ' ')) != nullptr) *star = '*';</span>
<a href="#l17.1057"></a><span id="l17.1057">     }</span>
<a href="#l17.1058"></a><span id="l17.1058" class="difflineminus">-  }</span>
<a href="#l17.1059"></a><span id="l17.1059" class="difflineminus">-  else</span>
<a href="#l17.1060"></a><span id="l17.1060" class="difflineminus">-  {</span>
<a href="#l17.1061"></a><span id="l17.1061" class="difflineplus">+  } else {</span>
<a href="#l17.1062"></a><span id="l17.1062">     int i, count;</span>
<a href="#l17.1063"></a><span id="l17.1063"> </span>
<a href="#l17.1064"></a><span id="l17.1064" class="difflineminus">-    for (i = 0, count = 0; spaceString[i]; )</span>
<a href="#l17.1065"></a><span id="l17.1065" class="difflineminus">-    {</span>
<a href="#l17.1066"></a><span id="l17.1066" class="difflineminus">-      if (spaceString[i++] == ' ')</span>
<a href="#l17.1067"></a><span id="l17.1067" class="difflineminus">-      {</span>
<a href="#l17.1068"></a><span id="l17.1068" class="difflineplus">+    for (i = 0, count = 0; spaceString[i];) {</span>
<a href="#l17.1069"></a><span id="l17.1069" class="difflineplus">+      if (spaceString[i++] == ' ') {</span>
<a href="#l17.1070"></a><span id="l17.1070">         count++;</span>
<a href="#l17.1071"></a><span id="l17.1071">         while (spaceString[i] &amp;&amp; spaceString[i] == ' ') i++;</span>
<a href="#l17.1072"></a><span id="l17.1072">       }</span>
<a href="#l17.1073"></a><span id="l17.1073">     }</span>
<a href="#l17.1074"></a><span id="l17.1074"> </span>
<a href="#l17.1075"></a><span id="l17.1075" class="difflineminus">-    if (transformType == kSurround)</span>
<a href="#l17.1076"></a><span id="l17.1076" class="difflineminus">-      count *= 2;</span>
<a href="#l17.1077"></a><span id="l17.1077" class="difflineplus">+    if (transformType == kSurround) count *= 2;</span>
<a href="#l17.1078"></a><span id="l17.1078"> </span>
<a href="#l17.1079"></a><span id="l17.1079" class="difflineminus">-    if (count &gt; 0)</span>
<a href="#l17.1080"></a><span id="l17.1080" class="difflineminus">-    {</span>
<a href="#l17.1081"></a><span id="l17.1081" class="difflineminus">-      if ((starString = (char *)PR_Malloc(i + count + 1)) != nullptr)</span>
<a href="#l17.1082"></a><span id="l17.1082" class="difflineminus">-      {</span>
<a href="#l17.1083"></a><span id="l17.1083" class="difflineplus">+    if (count &gt; 0) {</span>
<a href="#l17.1084"></a><span id="l17.1084" class="difflineplus">+      if ((starString = (char *)PR_Malloc(i + count + 1)) != nullptr) {</span>
<a href="#l17.1085"></a><span id="l17.1085">         int j;</span>
<a href="#l17.1086"></a><span id="l17.1086"> </span>
<a href="#l17.1087"></a><span id="l17.1087" class="difflineminus">-        for (i = 0, j = 0; spaceString[i]; )</span>
<a href="#l17.1088"></a><span id="l17.1088" class="difflineminus">-        {</span>
<a href="#l17.1089"></a><span id="l17.1089" class="difflineminus">-          if (spaceString[i] == ' ')</span>
<a href="#l17.1090"></a><span id="l17.1090" class="difflineminus">-          {</span>
<a href="#l17.1091"></a><span id="l17.1091" class="difflineplus">+        for (i = 0, j = 0; spaceString[i];) {</span>
<a href="#l17.1092"></a><span id="l17.1092" class="difflineplus">+          if (spaceString[i] == ' ') {</span>
<a href="#l17.1093"></a><span id="l17.1093">             starString[j++] = '*';</span>
<a href="#l17.1094"></a><span id="l17.1094">             starString[j++] = ' ';</span>
<a href="#l17.1095"></a><span id="l17.1095" class="difflineminus">-            if (transformType == kSurround)</span>
<a href="#l17.1096"></a><span id="l17.1096" class="difflineminus">-              starString[j++] = '*';</span>
<a href="#l17.1097"></a><span id="l17.1097" class="difflineplus">+            if (transformType == kSurround) starString[j++] = '*';</span>
<a href="#l17.1098"></a><span id="l17.1098"> </span>
<a href="#l17.1099"></a><span id="l17.1099">             i++;</span>
<a href="#l17.1100"></a><span id="l17.1100" class="difflineminus">-            while (spaceString[i] &amp;&amp; spaceString[i] == ' ')</span>
<a href="#l17.1101"></a><span id="l17.1101" class="difflineminus">-              i++;</span>
<a href="#l17.1102"></a><span id="l17.1102" class="difflineminus">-          }</span>
<a href="#l17.1103"></a><span id="l17.1103" class="difflineminus">-          else</span>
<a href="#l17.1104"></a><span id="l17.1104" class="difflineplus">+            while (spaceString[i] &amp;&amp; spaceString[i] == ' ') i++;</span>
<a href="#l17.1105"></a><span id="l17.1105" class="difflineplus">+          } else</span>
<a href="#l17.1106"></a><span id="l17.1106">             starString[j++] = spaceString[i++];</span>
<a href="#l17.1107"></a><span id="l17.1107">         }</span>
<a href="#l17.1108"></a><span id="l17.1108">         starString[j] = 0;</span>
<a href="#l17.1109"></a><span id="l17.1109">       }</span>
<a href="#l17.1110"></a><span id="l17.1110" class="difflineminus">-    }</span>
<a href="#l17.1111"></a><span id="l17.1111" class="difflineminus">-    else</span>
<a href="#l17.1112"></a><span id="l17.1112" class="difflineplus">+    } else</span>
<a href="#l17.1113"></a><span id="l17.1113">       starString = strdup(spaceString);</span>
<a href="#l17.1114"></a><span id="l17.1114">   }</span>
<a href="#l17.1115"></a><span id="l17.1115"> </span>
<a href="#l17.1116"></a><span id="l17.1116">   return starString;</span>
<a href="#l17.1117"></a><span id="l17.1117"> }</span>
<a href="#l17.1118"></a><span id="l17.1118"> </span>
<a href="#l17.1119"></a><span id="l17.1119"> //-----------------------------------------------------------------------------</span>
<a href="#l17.1120"></a><span id="l17.1120"> //------------------- Validity checking for menu items etc. -------------------</span>
<a href="#l17.1121"></a><span id="l17.1121"> //-----------------------------------------------------------------------------</span>
<a href="#l17.1122"></a><span id="l17.1122"> </span>
<a href="#l17.1123"></a><span id="l17.1123" class="difflineminus">-nsMsgSearchValidityTable::nsMsgSearchValidityTable ()</span>
<a href="#l17.1124"></a><span id="l17.1124" class="difflineminus">-{</span>
<a href="#l17.1125"></a><span id="l17.1125" class="difflineplus">+nsMsgSearchValidityTable::nsMsgSearchValidityTable() {</span>
<a href="#l17.1126"></a><span id="l17.1126">   // Set everything to be unavailable and disabled</span>
<a href="#l17.1127"></a><span id="l17.1127">   for (int i = 0; i &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; i++)</span>
<a href="#l17.1128"></a><span id="l17.1128" class="difflineminus">-    for (int j = 0; j &lt; nsMsgSearchOp::kNumMsgSearchOperators; j++)</span>
<a href="#l17.1129"></a><span id="l17.1129" class="difflineminus">-    {</span>
<a href="#l17.1130"></a><span id="l17.1130" class="difflineminus">-      SetAvailable (i, j, false);</span>
<a href="#l17.1131"></a><span id="l17.1131" class="difflineminus">-      SetEnabled (i, j, false);</span>
<a href="#l17.1132"></a><span id="l17.1132" class="difflineminus">-      SetValidButNotShown (i,j, false);</span>
<a href="#l17.1133"></a><span id="l17.1133" class="difflineplus">+    for (int j = 0; j &lt; nsMsgSearchOp::kNumMsgSearchOperators; j++) {</span>
<a href="#l17.1134"></a><span id="l17.1134" class="difflineplus">+      SetAvailable(i, j, false);</span>
<a href="#l17.1135"></a><span id="l17.1135" class="difflineplus">+      SetEnabled(i, j, false);</span>
<a href="#l17.1136"></a><span id="l17.1136" class="difflineplus">+      SetValidButNotShown(i, j, false);</span>
<a href="#l17.1137"></a><span id="l17.1137">     }</span>
<a href="#l17.1138"></a><span id="l17.1138" class="difflineminus">-  m_numAvailAttribs = 0;   // # of attributes marked with at least one available operator</span>
<a href="#l17.1139"></a><span id="l17.1139" class="difflineplus">+  m_numAvailAttribs =</span>
<a href="#l17.1140"></a><span id="l17.1140" class="difflineplus">+      0;  // # of attributes marked with at least one available operator</span>
<a href="#l17.1141"></a><span id="l17.1141">   // assume default is Subject, which it is for mail and news search</span>
<a href="#l17.1142"></a><span id="l17.1142">   // it's not for LDAP, so we'll call SetDefaultAttrib()</span>
<a href="#l17.1143"></a><span id="l17.1143">   m_defaultAttrib = nsMsgSearchAttrib::Subject;</span>
<a href="#l17.1144"></a><span id="l17.1144"> }</span>
<a href="#l17.1145"></a><span id="l17.1145"> </span>
<a href="#l17.1146"></a><span id="l17.1146"> NS_IMPL_ISUPPORTS(nsMsgSearchValidityTable, nsIMsgSearchValidityTable)</span>
<a href="#l17.1147"></a><span id="l17.1147"> </span>
<a href="#l17.1148"></a><span id="l17.1148" class="difflineminus">-</span>
<a href="#l17.1149"></a><span id="l17.1149" class="difflineminus">-nsresult</span>
<a href="#l17.1150"></a><span id="l17.1150" class="difflineminus">-nsMsgSearchValidityTable::GetNumAvailAttribs(int32_t *aResult)</span>
<a href="#l17.1151"></a><span id="l17.1151" class="difflineminus">-{</span>
<a href="#l17.1152"></a><span id="l17.1152" class="difflineplus">+nsresult nsMsgSearchValidityTable::GetNumAvailAttribs(int32_t *aResult) {</span>
<a href="#l17.1153"></a><span id="l17.1153">   m_numAvailAttribs = 0;</span>
<a href="#l17.1154"></a><span id="l17.1154">   for (int i = 0; i &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; i++)</span>
<a href="#l17.1155"></a><span id="l17.1155">     for (int j = 0; j &lt; nsMsgSearchOp::kNumMsgSearchOperators; j++) {</span>
<a href="#l17.1156"></a><span id="l17.1156" class="difflineminus">-            bool available;</span>
<a href="#l17.1157"></a><span id="l17.1157" class="difflineminus">-            GetAvailable(i, j, &amp;available);</span>
<a href="#l17.1158"></a><span id="l17.1158" class="difflineminus">-      if (available)</span>
<a href="#l17.1159"></a><span id="l17.1159" class="difflineminus">-      {</span>
<a href="#l17.1160"></a><span id="l17.1160" class="difflineplus">+      bool available;</span>
<a href="#l17.1161"></a><span id="l17.1161" class="difflineplus">+      GetAvailable(i, j, &amp;available);</span>
<a href="#l17.1162"></a><span id="l17.1162" class="difflineplus">+      if (available) {</span>
<a href="#l17.1163"></a><span id="l17.1163">         m_numAvailAttribs++;</span>
<a href="#l17.1164"></a><span id="l17.1164">         break;</span>
<a href="#l17.1165"></a><span id="l17.1165">       }</span>
<a href="#l17.1166"></a><span id="l17.1166" class="difflineminus">-        }</span>
<a href="#l17.1167"></a><span id="l17.1167" class="difflineplus">+    }</span>
<a href="#l17.1168"></a><span id="l17.1168">   *aResult = m_numAvailAttribs;</span>
<a href="#l17.1169"></a><span id="l17.1169" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.1170"></a><span id="l17.1170" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.1171"></a><span id="l17.1171"> }</span>
<a href="#l17.1172"></a><span id="l17.1172"> </span>
<a href="#l17.1173"></a><span id="l17.1173" class="difflineminus">-nsresult</span>
<a href="#l17.1174"></a><span id="l17.1174" class="difflineminus">-nsMsgSearchValidityTable::ValidateTerms (nsIArray *searchTerms)</span>
<a href="#l17.1175"></a><span id="l17.1175" class="difflineminus">-{</span>
<a href="#l17.1176"></a><span id="l17.1176" class="difflineplus">+nsresult nsMsgSearchValidityTable::ValidateTerms(nsIArray *searchTerms) {</span>
<a href="#l17.1177"></a><span id="l17.1177">   nsresult rv = NS_OK;</span>
<a href="#l17.1178"></a><span id="l17.1178">   uint32_t count;</span>
<a href="#l17.1179"></a><span id="l17.1179"> </span>
<a href="#l17.1180"></a><span id="l17.1180">   NS_ENSURE_ARG_POINTER(searchTerms);</span>
<a href="#l17.1181"></a><span id="l17.1181"> </span>
<a href="#l17.1182"></a><span id="l17.1182">   searchTerms-&gt;GetLength(&amp;count);</span>
<a href="#l17.1183"></a><span id="l17.1183" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l17.1184"></a><span id="l17.1184" class="difflineminus">-  {</span>
<a href="#l17.1185"></a><span id="l17.1185" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l17.1186"></a><span id="l17.1186">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm = do_QueryElementAt(searchTerms, i);</span>
<a href="#l17.1187"></a><span id="l17.1187"> </span>
<a href="#l17.1188"></a><span id="l17.1188">     nsIMsgSearchTerm *iTerm = pTerm;</span>
<a href="#l17.1189"></a><span id="l17.1189">     nsMsgSearchTerm *term = static_cast&lt;nsMsgSearchTerm *&gt;(iTerm);</span>
<a href="#l17.1190"></a><span id="l17.1190" class="difflineminus">-//    XP_ASSERT(term-&gt;IsValid());</span>
<a href="#l17.1191"></a><span id="l17.1191" class="difflineplus">+    //    XP_ASSERT(term-&gt;IsValid());</span>
<a href="#l17.1192"></a><span id="l17.1192">     bool enabled;</span>
<a href="#l17.1193"></a><span id="l17.1193">     bool available;</span>
<a href="#l17.1194"></a><span id="l17.1194">     rv = GetEnabled(term-&gt;m_attribute, term-&gt;m_operator, &amp;enabled);</span>
<a href="#l17.1195"></a><span id="l17.1195">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1196"></a><span id="l17.1196">     rv = GetAvailable(term-&gt;m_attribute, term-&gt;m_operator, &amp;available);</span>
<a href="#l17.1197"></a><span id="l17.1197">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1198"></a><span id="l17.1198" class="difflineminus">-    if (!enabled || !available)</span>
<a href="#l17.1199"></a><span id="l17.1199" class="difflineminus">-    {</span>
<a href="#l17.1200"></a><span id="l17.1200" class="difflineplus">+    if (!enabled || !available) {</span>
<a href="#l17.1201"></a><span id="l17.1201">       bool validNotShown;</span>
<a href="#l17.1202"></a><span id="l17.1202" class="difflineminus">-      rv = GetValidButNotShown(term-&gt;m_attribute, term-&gt;m_operator, &amp;validNotShown);</span>
<a href="#l17.1203"></a><span id="l17.1203" class="difflineplus">+      rv = GetValidButNotShown(term-&gt;m_attribute, term-&gt;m_operator,</span>
<a href="#l17.1204"></a><span id="l17.1204" class="difflineplus">+                               &amp;validNotShown);</span>
<a href="#l17.1205"></a><span id="l17.1205">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1206"></a><span id="l17.1206" class="difflineminus">-      if (!validNotShown)</span>
<a href="#l17.1207"></a><span id="l17.1207" class="difflineminus">-        return NS_MSG_ERROR_INVALID_SEARCH_SCOPE;</span>
<a href="#l17.1208"></a><span id="l17.1208" class="difflineplus">+      if (!validNotShown) return NS_MSG_ERROR_INVALID_SEARCH_SCOPE;</span>
<a href="#l17.1209"></a><span id="l17.1209">     }</span>
<a href="#l17.1210"></a><span id="l17.1210">   }</span>
<a href="#l17.1211"></a><span id="l17.1211"> </span>
<a href="#l17.1212"></a><span id="l17.1212">   return rv;</span>
<a href="#l17.1213"></a><span id="l17.1213"> }</span>
<a href="#l17.1214"></a><span id="l17.1214"> </span>
<a href="#l17.1215"></a><span id="l17.1215" class="difflineminus">-nsresult</span>
<a href="#l17.1216"></a><span id="l17.1216" class="difflineminus">-nsMsgSearchValidityTable::GetAvailableAttributes(uint32_t *length,</span>
<a href="#l17.1217"></a><span id="l17.1217" class="difflineminus">-                                                 nsMsgSearchAttribValue **aResult)</span>
<a href="#l17.1218"></a><span id="l17.1218" class="difflineminus">-{</span>
<a href="#l17.1219"></a><span id="l17.1219" class="difflineminus">-    NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l17.1220"></a><span id="l17.1220" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l17.1221"></a><span id="l17.1221" class="difflineplus">+nsresult nsMsgSearchValidityTable::GetAvailableAttributes(</span>
<a href="#l17.1222"></a><span id="l17.1222" class="difflineplus">+    uint32_t *length, nsMsgSearchAttribValue **aResult) {</span>
<a href="#l17.1223"></a><span id="l17.1223" class="difflineplus">+  NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l17.1224"></a><span id="l17.1224" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l17.1225"></a><span id="l17.1225"> </span>
<a href="#l17.1226"></a><span id="l17.1226" class="difflineminus">-    // count first</span>
<a href="#l17.1227"></a><span id="l17.1227" class="difflineminus">-    uint32_t totalAttributes=0;</span>
<a href="#l17.1228"></a><span id="l17.1228" class="difflineminus">-    int32_t i, j;</span>
<a href="#l17.1229"></a><span id="l17.1229" class="difflineminus">-    for (i = 0; i&lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; i++) {</span>
<a href="#l17.1230"></a><span id="l17.1230" class="difflineminus">-        for (j=0; j&lt; nsMsgSearchOp::kNumMsgSearchOperators; j++) {</span>
<a href="#l17.1231"></a><span id="l17.1231" class="difflineminus">-            if (m_table[i][j].bitAvailable) {</span>
<a href="#l17.1232"></a><span id="l17.1232" class="difflineminus">-                totalAttributes++;</span>
<a href="#l17.1233"></a><span id="l17.1233" class="difflineminus">-                break;</span>
<a href="#l17.1234"></a><span id="l17.1234" class="difflineminus">-            }</span>
<a href="#l17.1235"></a><span id="l17.1235" class="difflineminus">-        }</span>
<a href="#l17.1236"></a><span id="l17.1236" class="difflineplus">+  // count first</span>
<a href="#l17.1237"></a><span id="l17.1237" class="difflineplus">+  uint32_t totalAttributes = 0;</span>
<a href="#l17.1238"></a><span id="l17.1238" class="difflineplus">+  int32_t i, j;</span>
<a href="#l17.1239"></a><span id="l17.1239" class="difflineplus">+  for (i = 0; i &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; i++) {</span>
<a href="#l17.1240"></a><span id="l17.1240" class="difflineplus">+    for (j = 0; j &lt; nsMsgSearchOp::kNumMsgSearchOperators; j++) {</span>
<a href="#l17.1241"></a><span id="l17.1241" class="difflineplus">+      if (m_table[i][j].bitAvailable) {</span>
<a href="#l17.1242"></a><span id="l17.1242" class="difflineplus">+        totalAttributes++;</span>
<a href="#l17.1243"></a><span id="l17.1243" class="difflineplus">+        break;</span>
<a href="#l17.1244"></a><span id="l17.1244" class="difflineplus">+      }</span>
<a href="#l17.1245"></a><span id="l17.1245">     }</span>
<a href="#l17.1246"></a><span id="l17.1246" class="difflineplus">+  }</span>
<a href="#l17.1247"></a><span id="l17.1247"> </span>
<a href="#l17.1248"></a><span id="l17.1248" class="difflineminus">-    nsMsgSearchAttribValue *array = (nsMsgSearchAttribValue*)</span>
<a href="#l17.1249"></a><span id="l17.1249" class="difflineminus">-        moz_xmalloc(sizeof(nsMsgSearchAttribValue) * totalAttributes);</span>
<a href="#l17.1250"></a><span id="l17.1250" class="difflineminus">-    NS_ENSURE_TRUE(array, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l17.1251"></a><span id="l17.1251" class="difflineplus">+  nsMsgSearchAttribValue *array = (nsMsgSearchAttribValue *)moz_xmalloc(</span>
<a href="#l17.1252"></a><span id="l17.1252" class="difflineplus">+      sizeof(nsMsgSearchAttribValue) * totalAttributes);</span>
<a href="#l17.1253"></a><span id="l17.1253" class="difflineplus">+  NS_ENSURE_TRUE(array, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l17.1254"></a><span id="l17.1254"> </span>
<a href="#l17.1255"></a><span id="l17.1255" class="difflineminus">-    uint32_t numStored=0;</span>
<a href="#l17.1256"></a><span id="l17.1256" class="difflineminus">-    for (i = 0; i&lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; i++) {</span>
<a href="#l17.1257"></a><span id="l17.1257" class="difflineminus">-        for (j=0; j&lt; nsMsgSearchOp::kNumMsgSearchOperators; j++) {</span>
<a href="#l17.1258"></a><span id="l17.1258" class="difflineminus">-            if (m_table[i][j].bitAvailable) {</span>
<a href="#l17.1259"></a><span id="l17.1259" class="difflineminus">-                array[numStored++] = i;</span>
<a href="#l17.1260"></a><span id="l17.1260" class="difflineminus">-                break;</span>
<a href="#l17.1261"></a><span id="l17.1261" class="difflineminus">-            }</span>
<a href="#l17.1262"></a><span id="l17.1262" class="difflineminus">-        }</span>
<a href="#l17.1263"></a><span id="l17.1263" class="difflineplus">+  uint32_t numStored = 0;</span>
<a href="#l17.1264"></a><span id="l17.1264" class="difflineplus">+  for (i = 0; i &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; i++) {</span>
<a href="#l17.1265"></a><span id="l17.1265" class="difflineplus">+    for (j = 0; j &lt; nsMsgSearchOp::kNumMsgSearchOperators; j++) {</span>
<a href="#l17.1266"></a><span id="l17.1266" class="difflineplus">+      if (m_table[i][j].bitAvailable) {</span>
<a href="#l17.1267"></a><span id="l17.1267" class="difflineplus">+        array[numStored++] = i;</span>
<a href="#l17.1268"></a><span id="l17.1268" class="difflineplus">+        break;</span>
<a href="#l17.1269"></a><span id="l17.1269" class="difflineplus">+      }</span>
<a href="#l17.1270"></a><span id="l17.1270">     }</span>
<a href="#l17.1271"></a><span id="l17.1271" class="difflineplus">+  }</span>
<a href="#l17.1272"></a><span id="l17.1272"> </span>
<a href="#l17.1273"></a><span id="l17.1273" class="difflineminus">-    NS_ASSERTION(totalAttributes == numStored, &quot;Search Attributes not lining up&quot;);</span>
<a href="#l17.1274"></a><span id="l17.1274" class="difflineminus">-    *length = totalAttributes;</span>
<a href="#l17.1275"></a><span id="l17.1275" class="difflineminus">-    *aResult = array;</span>
<a href="#l17.1276"></a><span id="l17.1276" class="difflineplus">+  NS_ASSERTION(totalAttributes == numStored, &quot;Search Attributes not lining up&quot;);</span>
<a href="#l17.1277"></a><span id="l17.1277" class="difflineplus">+  *length = totalAttributes;</span>
<a href="#l17.1278"></a><span id="l17.1278" class="difflineplus">+  *aResult = array;</span>
<a href="#l17.1279"></a><span id="l17.1279"> </span>
<a href="#l17.1280"></a><span id="l17.1280" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.1281"></a><span id="l17.1281" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.1282"></a><span id="l17.1282"> }</span>
<a href="#l17.1283"></a><span id="l17.1283"> </span>
<a href="#l17.1284"></a><span id="l17.1284" class="difflineminus">-nsresult</span>
<a href="#l17.1285"></a><span id="l17.1285" class="difflineminus">-nsMsgSearchValidityTable::GetAvailableOperators(nsMsgSearchAttribValue aAttribute,</span>
<a href="#l17.1286"></a><span id="l17.1286" class="difflineminus">-                                                uint32_t *aLength,</span>
<a href="#l17.1287"></a><span id="l17.1287" class="difflineminus">-                                                nsMsgSearchOpValue **aResult)</span>
<a href="#l17.1288"></a><span id="l17.1288" class="difflineminus">-{</span>
<a href="#l17.1289"></a><span id="l17.1289" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l17.1290"></a><span id="l17.1290" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l17.1291"></a><span id="l17.1291" class="difflineplus">+nsresult nsMsgSearchValidityTable::GetAvailableOperators(</span>
<a href="#l17.1292"></a><span id="l17.1292" class="difflineplus">+    nsMsgSearchAttribValue aAttribute, uint32_t *aLength,</span>
<a href="#l17.1293"></a><span id="l17.1293" class="difflineplus">+    nsMsgSearchOpValue **aResult) {</span>
<a href="#l17.1294"></a><span id="l17.1294" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l17.1295"></a><span id="l17.1295" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l17.1296"></a><span id="l17.1296"> </span>
<a href="#l17.1297"></a><span id="l17.1297" class="difflineminus">-    nsMsgSearchAttribValue attr;</span>
<a href="#l17.1298"></a><span id="l17.1298" class="difflineminus">-    if (aAttribute == nsMsgSearchAttrib::Default)</span>
<a href="#l17.1299"></a><span id="l17.1299" class="difflineminus">-      attr = m_defaultAttrib;</span>
<a href="#l17.1300"></a><span id="l17.1300" class="difflineminus">-    else</span>
<a href="#l17.1301"></a><span id="l17.1301" class="difflineminus">-      attr = std::min(aAttribute,</span>
<a href="#l17.1302"></a><span id="l17.1302" class="difflineplus">+  nsMsgSearchAttribValue attr;</span>
<a href="#l17.1303"></a><span id="l17.1303" class="difflineplus">+  if (aAttribute == nsMsgSearchAttrib::Default)</span>
<a href="#l17.1304"></a><span id="l17.1304" class="difflineplus">+    attr = m_defaultAttrib;</span>
<a href="#l17.1305"></a><span id="l17.1305" class="difflineplus">+  else</span>
<a href="#l17.1306"></a><span id="l17.1306" class="difflineplus">+    attr = std::min(aAttribute,</span>
<a href="#l17.1307"></a><span id="l17.1307">                     (nsMsgSearchAttribValue)nsMsgSearchAttrib::OtherHeader);</span>
<a href="#l17.1308"></a><span id="l17.1308"> </span>
<a href="#l17.1309"></a><span id="l17.1309" class="difflineminus">-    uint32_t totalOperators=0;</span>
<a href="#l17.1310"></a><span id="l17.1310" class="difflineminus">-    int32_t i;</span>
<a href="#l17.1311"></a><span id="l17.1311" class="difflineminus">-    for (i=0; i&lt;nsMsgSearchOp::kNumMsgSearchOperators; i++) {</span>
<a href="#l17.1312"></a><span id="l17.1312" class="difflineminus">-        if (m_table[attr][i].bitAvailable)</span>
<a href="#l17.1313"></a><span id="l17.1313" class="difflineminus">-            totalOperators++;</span>
<a href="#l17.1314"></a><span id="l17.1314" class="difflineminus">-    }</span>
<a href="#l17.1315"></a><span id="l17.1315" class="difflineplus">+  uint32_t totalOperators = 0;</span>
<a href="#l17.1316"></a><span id="l17.1316" class="difflineplus">+  int32_t i;</span>
<a href="#l17.1317"></a><span id="l17.1317" class="difflineplus">+  for (i = 0; i &lt; nsMsgSearchOp::kNumMsgSearchOperators; i++) {</span>
<a href="#l17.1318"></a><span id="l17.1318" class="difflineplus">+    if (m_table[attr][i].bitAvailable) totalOperators++;</span>
<a href="#l17.1319"></a><span id="l17.1319" class="difflineplus">+  }</span>
<a href="#l17.1320"></a><span id="l17.1320"> </span>
<a href="#l17.1321"></a><span id="l17.1321" class="difflineminus">-    nsMsgSearchOpValue *array = (nsMsgSearchOpValue*)</span>
<a href="#l17.1322"></a><span id="l17.1322" class="difflineminus">-        moz_xmalloc(sizeof(nsMsgSearchOpValue) * totalOperators);</span>
<a href="#l17.1323"></a><span id="l17.1323" class="difflineminus">-    NS_ENSURE_TRUE(array, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l17.1324"></a><span id="l17.1324" class="difflineplus">+  nsMsgSearchOpValue *array = (nsMsgSearchOpValue *)moz_xmalloc(</span>
<a href="#l17.1325"></a><span id="l17.1325" class="difflineplus">+      sizeof(nsMsgSearchOpValue) * totalOperators);</span>
<a href="#l17.1326"></a><span id="l17.1326" class="difflineplus">+  NS_ENSURE_TRUE(array, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l17.1327"></a><span id="l17.1327"> </span>
<a href="#l17.1328"></a><span id="l17.1328" class="difflineminus">-    uint32_t numStored = 0;</span>
<a href="#l17.1329"></a><span id="l17.1329" class="difflineminus">-    for (i=0; i&lt;nsMsgSearchOp::kNumMsgSearchOperators;i++) {</span>
<a href="#l17.1330"></a><span id="l17.1330" class="difflineminus">-        if (m_table[attr][i].bitAvailable)</span>
<a href="#l17.1331"></a><span id="l17.1331" class="difflineminus">-            array[numStored++] = i;</span>
<a href="#l17.1332"></a><span id="l17.1332" class="difflineminus">-    }</span>
<a href="#l17.1333"></a><span id="l17.1333" class="difflineplus">+  uint32_t numStored = 0;</span>
<a href="#l17.1334"></a><span id="l17.1334" class="difflineplus">+  for (i = 0; i &lt; nsMsgSearchOp::kNumMsgSearchOperators; i++) {</span>
<a href="#l17.1335"></a><span id="l17.1335" class="difflineplus">+    if (m_table[attr][i].bitAvailable) array[numStored++] = i;</span>
<a href="#l17.1336"></a><span id="l17.1336" class="difflineplus">+  }</span>
<a href="#l17.1337"></a><span id="l17.1337"> </span>
<a href="#l17.1338"></a><span id="l17.1338" class="difflineminus">-    NS_ASSERTION(totalOperators == numStored, &quot;Search Operators not lining up&quot;);</span>
<a href="#l17.1339"></a><span id="l17.1339" class="difflineminus">-    *aLength = totalOperators;</span>
<a href="#l17.1340"></a><span id="l17.1340" class="difflineminus">-    *aResult = array;</span>
<a href="#l17.1341"></a><span id="l17.1341" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.1342"></a><span id="l17.1342" class="difflineplus">+  NS_ASSERTION(totalOperators == numStored, &quot;Search Operators not lining up&quot;);</span>
<a href="#l17.1343"></a><span id="l17.1343" class="difflineplus">+  *aLength = totalOperators;</span>
<a href="#l17.1344"></a><span id="l17.1344" class="difflineplus">+  *aResult = array;</span>
<a href="#l17.1345"></a><span id="l17.1345" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.1346"></a><span id="l17.1346"> }</span>
<a href="#l17.1347"></a><span id="l17.1347"> </span>
<a href="#l17.1348"></a><span id="l17.1348"> NS_IMETHODIMP</span>
<a href="#l17.1349"></a><span id="l17.1349" class="difflineminus">-nsMsgSearchValidityTable::SetDefaultAttrib(nsMsgSearchAttribValue aAttribute)</span>
<a href="#l17.1350"></a><span id="l17.1350" class="difflineminus">-{</span>
<a href="#l17.1351"></a><span id="l17.1351" class="difflineplus">+nsMsgSearchValidityTable::SetDefaultAttrib(nsMsgSearchAttribValue aAttribute) {</span>
<a href="#l17.1352"></a><span id="l17.1352">   m_defaultAttrib = aAttribute;</span>
<a href="#l17.1353"></a><span id="l17.1353">   return NS_OK;</span>
<a href="#l17.1354"></a><span id="l17.1354"> }</span>
<a href="#l17.1355"></a><span id="l17.1355"> </span>
<a href="#l17.1356"></a><span id="l17.1356" class="difflineminus">-</span>
<a href="#l17.1357"></a><span id="l17.1357" class="difflineminus">-nsMsgSearchValidityManager::nsMsgSearchValidityManager ()</span>
<a href="#l17.1358"></a><span id="l17.1358" class="difflineminus">-{</span>
<a href="#l17.1359"></a><span id="l17.1359" class="difflineminus">-}</span>
<a href="#l17.1360"></a><span id="l17.1360" class="difflineplus">+nsMsgSearchValidityManager::nsMsgSearchValidityManager() {}</span>
<a href="#l17.1361"></a><span id="l17.1361"> </span>
<a href="#l17.1362"></a><span id="l17.1362" class="difflineminus">-</span>
<a href="#l17.1363"></a><span id="l17.1363" class="difflineminus">-nsMsgSearchValidityManager::~nsMsgSearchValidityManager ()</span>
<a href="#l17.1364"></a><span id="l17.1364" class="difflineminus">-{</span>
<a href="#l17.1365"></a><span id="l17.1365" class="difflineminus">-    // tables released by nsCOMPtr</span>
<a href="#l17.1366"></a><span id="l17.1366" class="difflineplus">+nsMsgSearchValidityManager::~nsMsgSearchValidityManager() {</span>
<a href="#l17.1367"></a><span id="l17.1367" class="difflineplus">+  // tables released by nsCOMPtr</span>
<a href="#l17.1368"></a><span id="l17.1368"> }</span>
<a href="#l17.1369"></a><span id="l17.1369"> </span>
<a href="#l17.1370"></a><span id="l17.1370"> NS_IMPL_ISUPPORTS(nsMsgSearchValidityManager, nsIMsgSearchValidityManager)</span>
<a href="#l17.1371"></a><span id="l17.1371"> </span>
<a href="#l17.1372"></a><span id="l17.1372"> //-----------------------------------------------------------------------------</span>
<a href="#l17.1373"></a><span id="l17.1373"> // Bottleneck accesses to the objects so we can allocate and initialize them</span>
<a href="#l17.1374"></a><span id="l17.1374"> // lazily. This way, there's no heap overhead for the validity tables until the</span>
<a href="#l17.1375"></a><span id="l17.1375"> // user actually searches that scope.</span>
<a href="#l17.1376"></a><span id="l17.1376"> //-----------------------------------------------------------------------------</span>
<a href="#l17.1377"></a><span id="l17.1377"> </span>
<a href="#l17.1378"></a><span id="l17.1378" class="difflineminus">-NS_IMETHODIMP nsMsgSearchValidityManager::GetTable (int whichTable, nsIMsgSearchValidityTable **ppOutTable)</span>
<a href="#l17.1379"></a><span id="l17.1379" class="difflineminus">-{</span>
<a href="#l17.1380"></a><span id="l17.1380" class="difflineplus">+NS_IMETHODIMP nsMsgSearchValidityManager::GetTable(</span>
<a href="#l17.1381"></a><span id="l17.1381" class="difflineplus">+    int whichTable, nsIMsgSearchValidityTable **ppOutTable) {</span>
<a href="#l17.1382"></a><span id="l17.1382">   NS_ENSURE_ARG_POINTER(ppOutTable);</span>
<a href="#l17.1383"></a><span id="l17.1383"> </span>
<a href="#l17.1384"></a><span id="l17.1384">   nsresult rv;</span>
<a href="#l17.1385"></a><span id="l17.1385">   *ppOutTable = nullptr;</span>
<a href="#l17.1386"></a><span id="l17.1386"> </span>
<a href="#l17.1387"></a><span id="l17.1387">   nsCOMPtr&lt;nsIPrefBranch&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.1388"></a><span id="l17.1388">   nsCString customHeaders;</span>
<a href="#l17.1389"></a><span id="l17.1389" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.1390"></a><span id="l17.1390" class="difflineminus">-    pref-&gt;GetCharPref(PREF_CUSTOM_HEADERS, customHeaders);</span>
<a href="#l17.1391"></a><span id="l17.1391" class="difflineplus">+  if (NS_SUCCEEDED(rv)) pref-&gt;GetCharPref(PREF_CUSTOM_HEADERS, customHeaders);</span>
<a href="#l17.1392"></a><span id="l17.1392"> </span>
<a href="#l17.1393"></a><span id="l17.1393" class="difflineminus">-  switch (whichTable)</span>
<a href="#l17.1394"></a><span id="l17.1394" class="difflineminus">-  {</span>
<a href="#l17.1395"></a><span id="l17.1395" class="difflineminus">-  case nsMsgSearchScope::offlineMail:</span>
<a href="#l17.1396"></a><span id="l17.1396" class="difflineminus">-    if (!m_offlineMailTable)</span>
<a href="#l17.1397"></a><span id="l17.1397" class="difflineminus">-      rv = InitOfflineMailTable ();</span>
<a href="#l17.1398"></a><span id="l17.1398" class="difflineminus">-    if (m_offlineMailTable)</span>
<a href="#l17.1399"></a><span id="l17.1399" class="difflineminus">-      rv = SetOtherHeadersInTable(m_offlineMailTable, customHeaders.get());</span>
<a href="#l17.1400"></a><span id="l17.1400" class="difflineminus">-    *ppOutTable = m_offlineMailTable;</span>
<a href="#l17.1401"></a><span id="l17.1401" class="difflineminus">-    break;</span>
<a href="#l17.1402"></a><span id="l17.1402" class="difflineminus">-  case nsMsgSearchScope::offlineMailFilter:</span>
<a href="#l17.1403"></a><span id="l17.1403" class="difflineminus">-    if (!m_offlineMailFilterTable)</span>
<a href="#l17.1404"></a><span id="l17.1404" class="difflineminus">-      rv = InitOfflineMailFilterTable ();</span>
<a href="#l17.1405"></a><span id="l17.1405" class="difflineminus">-    if (m_offlineMailFilterTable)</span>
<a href="#l17.1406"></a><span id="l17.1406" class="difflineminus">-      rv = SetOtherHeadersInTable(m_offlineMailFilterTable, customHeaders.get());</span>
<a href="#l17.1407"></a><span id="l17.1407" class="difflineminus">-    *ppOutTable = m_offlineMailFilterTable;</span>
<a href="#l17.1408"></a><span id="l17.1408" class="difflineminus">-    break;</span>
<a href="#l17.1409"></a><span id="l17.1409" class="difflineminus">-  case nsMsgSearchScope::onlineMail:</span>
<a href="#l17.1410"></a><span id="l17.1410" class="difflineminus">-    if (!m_onlineMailTable)</span>
<a href="#l17.1411"></a><span id="l17.1411" class="difflineminus">-      rv = InitOnlineMailTable ();</span>
<a href="#l17.1412"></a><span id="l17.1412" class="difflineminus">-    if (m_onlineMailTable)</span>
<a href="#l17.1413"></a><span id="l17.1413" class="difflineminus">-      rv = SetOtherHeadersInTable(m_onlineMailTable, customHeaders.get());</span>
<a href="#l17.1414"></a><span id="l17.1414" class="difflineminus">-    *ppOutTable = m_onlineMailTable;</span>
<a href="#l17.1415"></a><span id="l17.1415" class="difflineminus">-    break;</span>
<a href="#l17.1416"></a><span id="l17.1416" class="difflineminus">-  case nsMsgSearchScope::onlineMailFilter:</span>
<a href="#l17.1417"></a><span id="l17.1417" class="difflineminus">-    if (!m_onlineMailFilterTable)</span>
<a href="#l17.1418"></a><span id="l17.1418" class="difflineminus">-      rv = InitOnlineMailFilterTable ();</span>
<a href="#l17.1419"></a><span id="l17.1419" class="difflineminus">-    if (m_onlineMailFilterTable)</span>
<a href="#l17.1420"></a><span id="l17.1420" class="difflineminus">-      rv = SetOtherHeadersInTable(m_onlineMailFilterTable, customHeaders.get());</span>
<a href="#l17.1421"></a><span id="l17.1421" class="difflineminus">-    *ppOutTable = m_onlineMailFilterTable;</span>
<a href="#l17.1422"></a><span id="l17.1422" class="difflineminus">-    break;</span>
<a href="#l17.1423"></a><span id="l17.1423" class="difflineminus">-  case nsMsgSearchScope::news:</span>
<a href="#l17.1424"></a><span id="l17.1424" class="difflineminus">-    if (!m_newsTable)</span>
<a href="#l17.1425"></a><span id="l17.1425" class="difflineminus">-      rv = InitNewsTable();</span>
<a href="#l17.1426"></a><span id="l17.1426" class="difflineminus">-    if (m_newsTable)</span>
<a href="#l17.1427"></a><span id="l17.1427" class="difflineminus">-      rv = SetOtherHeadersInTable(m_newsTable, customHeaders.get());</span>
<a href="#l17.1428"></a><span id="l17.1428" class="difflineminus">-    *ppOutTable = m_newsTable;</span>
<a href="#l17.1429"></a><span id="l17.1429" class="difflineminus">-    break;</span>
<a href="#l17.1430"></a><span id="l17.1430" class="difflineminus">-  case nsMsgSearchScope::newsFilter:</span>
<a href="#l17.1431"></a><span id="l17.1431" class="difflineminus">-    if (!m_newsFilterTable)</span>
<a href="#l17.1432"></a><span id="l17.1432" class="difflineminus">-      rv = InitNewsFilterTable();</span>
<a href="#l17.1433"></a><span id="l17.1433" class="difflineminus">-    if (m_newsFilterTable)</span>
<a href="#l17.1434"></a><span id="l17.1434" class="difflineminus">-      rv = SetOtherHeadersInTable(m_newsFilterTable, customHeaders.get());</span>
<a href="#l17.1435"></a><span id="l17.1435" class="difflineminus">-    *ppOutTable = m_newsFilterTable;</span>
<a href="#l17.1436"></a><span id="l17.1436" class="difflineminus">-    break;</span>
<a href="#l17.1437"></a><span id="l17.1437" class="difflineminus">-  case nsMsgSearchScope::localNews:</span>
<a href="#l17.1438"></a><span id="l17.1438" class="difflineminus">-    if (!m_localNewsTable)</span>
<a href="#l17.1439"></a><span id="l17.1439" class="difflineminus">-      rv = InitLocalNewsTable();</span>
<a href="#l17.1440"></a><span id="l17.1440" class="difflineminus">-    if (m_localNewsTable)</span>
<a href="#l17.1441"></a><span id="l17.1441" class="difflineminus">-      rv = SetOtherHeadersInTable(m_localNewsTable, customHeaders.get());</span>
<a href="#l17.1442"></a><span id="l17.1442" class="difflineminus">-    *ppOutTable = m_localNewsTable;</span>
<a href="#l17.1443"></a><span id="l17.1443" class="difflineminus">-    break;</span>
<a href="#l17.1444"></a><span id="l17.1444" class="difflineminus">-  case nsMsgSearchScope::localNewsJunk:</span>
<a href="#l17.1445"></a><span id="l17.1445" class="difflineminus">-    if (!m_localNewsJunkTable)</span>
<a href="#l17.1446"></a><span id="l17.1446" class="difflineminus">-      rv = InitLocalNewsJunkTable();</span>
<a href="#l17.1447"></a><span id="l17.1447" class="difflineminus">-    if (m_localNewsJunkTable)</span>
<a href="#l17.1448"></a><span id="l17.1448" class="difflineminus">-      rv = SetOtherHeadersInTable(m_localNewsJunkTable, customHeaders.get());</span>
<a href="#l17.1449"></a><span id="l17.1449" class="difflineminus">-    *ppOutTable = m_localNewsJunkTable;</span>
<a href="#l17.1450"></a><span id="l17.1450" class="difflineminus">-    break;</span>
<a href="#l17.1451"></a><span id="l17.1451" class="difflineminus">-  case nsMsgSearchScope::localNewsBody:</span>
<a href="#l17.1452"></a><span id="l17.1452" class="difflineminus">-    if (!m_localNewsBodyTable)</span>
<a href="#l17.1453"></a><span id="l17.1453" class="difflineminus">-      rv = InitLocalNewsBodyTable();</span>
<a href="#l17.1454"></a><span id="l17.1454" class="difflineminus">-    if (m_localNewsBodyTable)</span>
<a href="#l17.1455"></a><span id="l17.1455" class="difflineminus">-      rv = SetOtherHeadersInTable(m_localNewsBodyTable, customHeaders.get());</span>
<a href="#l17.1456"></a><span id="l17.1456" class="difflineminus">-    *ppOutTable = m_localNewsBodyTable;</span>
<a href="#l17.1457"></a><span id="l17.1457" class="difflineminus">-    break;</span>
<a href="#l17.1458"></a><span id="l17.1458" class="difflineminus">-  case nsMsgSearchScope::localNewsJunkBody:</span>
<a href="#l17.1459"></a><span id="l17.1459" class="difflineminus">-    if (!m_localNewsJunkBodyTable)</span>
<a href="#l17.1460"></a><span id="l17.1460" class="difflineminus">-      rv = InitLocalNewsJunkBodyTable();</span>
<a href="#l17.1461"></a><span id="l17.1461" class="difflineminus">-    if (m_localNewsJunkBodyTable)</span>
<a href="#l17.1462"></a><span id="l17.1462" class="difflineminus">-      rv = SetOtherHeadersInTable(m_localNewsJunkBodyTable, customHeaders.get());</span>
<a href="#l17.1463"></a><span id="l17.1463" class="difflineminus">-    *ppOutTable = m_localNewsJunkBodyTable;</span>
<a href="#l17.1464"></a><span id="l17.1464" class="difflineminus">-    break;</span>
<a href="#l17.1465"></a><span id="l17.1465" class="difflineplus">+  switch (whichTable) {</span>
<a href="#l17.1466"></a><span id="l17.1466" class="difflineplus">+    case nsMsgSearchScope::offlineMail:</span>
<a href="#l17.1467"></a><span id="l17.1467" class="difflineplus">+      if (!m_offlineMailTable) rv = InitOfflineMailTable();</span>
<a href="#l17.1468"></a><span id="l17.1468" class="difflineplus">+      if (m_offlineMailTable)</span>
<a href="#l17.1469"></a><span id="l17.1469" class="difflineplus">+        rv = SetOtherHeadersInTable(m_offlineMailTable, customHeaders.get());</span>
<a href="#l17.1470"></a><span id="l17.1470" class="difflineplus">+      *ppOutTable = m_offlineMailTable;</span>
<a href="#l17.1471"></a><span id="l17.1471" class="difflineplus">+      break;</span>
<a href="#l17.1472"></a><span id="l17.1472" class="difflineplus">+    case nsMsgSearchScope::offlineMailFilter:</span>
<a href="#l17.1473"></a><span id="l17.1473" class="difflineplus">+      if (!m_offlineMailFilterTable) rv = InitOfflineMailFilterTable();</span>
<a href="#l17.1474"></a><span id="l17.1474" class="difflineplus">+      if (m_offlineMailFilterTable)</span>
<a href="#l17.1475"></a><span id="l17.1475" class="difflineplus">+        rv = SetOtherHeadersInTable(m_offlineMailFilterTable,</span>
<a href="#l17.1476"></a><span id="l17.1476" class="difflineplus">+                                    customHeaders.get());</span>
<a href="#l17.1477"></a><span id="l17.1477" class="difflineplus">+      *ppOutTable = m_offlineMailFilterTable;</span>
<a href="#l17.1478"></a><span id="l17.1478" class="difflineplus">+      break;</span>
<a href="#l17.1479"></a><span id="l17.1479" class="difflineplus">+    case nsMsgSearchScope::onlineMail:</span>
<a href="#l17.1480"></a><span id="l17.1480" class="difflineplus">+      if (!m_onlineMailTable) rv = InitOnlineMailTable();</span>
<a href="#l17.1481"></a><span id="l17.1481" class="difflineplus">+      if (m_onlineMailTable)</span>
<a href="#l17.1482"></a><span id="l17.1482" class="difflineplus">+        rv = SetOtherHeadersInTable(m_onlineMailTable, customHeaders.get());</span>
<a href="#l17.1483"></a><span id="l17.1483" class="difflineplus">+      *ppOutTable = m_onlineMailTable;</span>
<a href="#l17.1484"></a><span id="l17.1484" class="difflineplus">+      break;</span>
<a href="#l17.1485"></a><span id="l17.1485" class="difflineplus">+    case nsMsgSearchScope::onlineMailFilter:</span>
<a href="#l17.1486"></a><span id="l17.1486" class="difflineplus">+      if (!m_onlineMailFilterTable) rv = InitOnlineMailFilterTable();</span>
<a href="#l17.1487"></a><span id="l17.1487" class="difflineplus">+      if (m_onlineMailFilterTable)</span>
<a href="#l17.1488"></a><span id="l17.1488" class="difflineplus">+        rv = SetOtherHeadersInTable(m_onlineMailFilterTable,</span>
<a href="#l17.1489"></a><span id="l17.1489" class="difflineplus">+                                    customHeaders.get());</span>
<a href="#l17.1490"></a><span id="l17.1490" class="difflineplus">+      *ppOutTable = m_onlineMailFilterTable;</span>
<a href="#l17.1491"></a><span id="l17.1491" class="difflineplus">+      break;</span>
<a href="#l17.1492"></a><span id="l17.1492" class="difflineplus">+    case nsMsgSearchScope::news:</span>
<a href="#l17.1493"></a><span id="l17.1493" class="difflineplus">+      if (!m_newsTable) rv = InitNewsTable();</span>
<a href="#l17.1494"></a><span id="l17.1494" class="difflineplus">+      if (m_newsTable)</span>
<a href="#l17.1495"></a><span id="l17.1495" class="difflineplus">+        rv = SetOtherHeadersInTable(m_newsTable, customHeaders.get());</span>
<a href="#l17.1496"></a><span id="l17.1496" class="difflineplus">+      *ppOutTable = m_newsTable;</span>
<a href="#l17.1497"></a><span id="l17.1497" class="difflineplus">+      break;</span>
<a href="#l17.1498"></a><span id="l17.1498" class="difflineplus">+    case nsMsgSearchScope::newsFilter:</span>
<a href="#l17.1499"></a><span id="l17.1499" class="difflineplus">+      if (!m_newsFilterTable) rv = InitNewsFilterTable();</span>
<a href="#l17.1500"></a><span id="l17.1500" class="difflineplus">+      if (m_newsFilterTable)</span>
<a href="#l17.1501"></a><span id="l17.1501" class="difflineplus">+        rv = SetOtherHeadersInTable(m_newsFilterTable, customHeaders.get());</span>
<a href="#l17.1502"></a><span id="l17.1502" class="difflineplus">+      *ppOutTable = m_newsFilterTable;</span>
<a href="#l17.1503"></a><span id="l17.1503" class="difflineplus">+      break;</span>
<a href="#l17.1504"></a><span id="l17.1504" class="difflineplus">+    case nsMsgSearchScope::localNews:</span>
<a href="#l17.1505"></a><span id="l17.1505" class="difflineplus">+      if (!m_localNewsTable) rv = InitLocalNewsTable();</span>
<a href="#l17.1506"></a><span id="l17.1506" class="difflineplus">+      if (m_localNewsTable)</span>
<a href="#l17.1507"></a><span id="l17.1507" class="difflineplus">+        rv = SetOtherHeadersInTable(m_localNewsTable, customHeaders.get());</span>
<a href="#l17.1508"></a><span id="l17.1508" class="difflineplus">+      *ppOutTable = m_localNewsTable;</span>
<a href="#l17.1509"></a><span id="l17.1509" class="difflineplus">+      break;</span>
<a href="#l17.1510"></a><span id="l17.1510" class="difflineplus">+    case nsMsgSearchScope::localNewsJunk:</span>
<a href="#l17.1511"></a><span id="l17.1511" class="difflineplus">+      if (!m_localNewsJunkTable) rv = InitLocalNewsJunkTable();</span>
<a href="#l17.1512"></a><span id="l17.1512" class="difflineplus">+      if (m_localNewsJunkTable)</span>
<a href="#l17.1513"></a><span id="l17.1513" class="difflineplus">+        rv = SetOtherHeadersInTable(m_localNewsJunkTable, customHeaders.get());</span>
<a href="#l17.1514"></a><span id="l17.1514" class="difflineplus">+      *ppOutTable = m_localNewsJunkTable;</span>
<a href="#l17.1515"></a><span id="l17.1515" class="difflineplus">+      break;</span>
<a href="#l17.1516"></a><span id="l17.1516" class="difflineplus">+    case nsMsgSearchScope::localNewsBody:</span>
<a href="#l17.1517"></a><span id="l17.1517" class="difflineplus">+      if (!m_localNewsBodyTable) rv = InitLocalNewsBodyTable();</span>
<a href="#l17.1518"></a><span id="l17.1518" class="difflineplus">+      if (m_localNewsBodyTable)</span>
<a href="#l17.1519"></a><span id="l17.1519" class="difflineplus">+        rv = SetOtherHeadersInTable(m_localNewsBodyTable, customHeaders.get());</span>
<a href="#l17.1520"></a><span id="l17.1520" class="difflineplus">+      *ppOutTable = m_localNewsBodyTable;</span>
<a href="#l17.1521"></a><span id="l17.1521" class="difflineplus">+      break;</span>
<a href="#l17.1522"></a><span id="l17.1522" class="difflineplus">+    case nsMsgSearchScope::localNewsJunkBody:</span>
<a href="#l17.1523"></a><span id="l17.1523" class="difflineplus">+      if (!m_localNewsJunkBodyTable) rv = InitLocalNewsJunkBodyTable();</span>
<a href="#l17.1524"></a><span id="l17.1524" class="difflineplus">+      if (m_localNewsJunkBodyTable)</span>
<a href="#l17.1525"></a><span id="l17.1525" class="difflineplus">+        rv = SetOtherHeadersInTable(m_localNewsJunkBodyTable,</span>
<a href="#l17.1526"></a><span id="l17.1526" class="difflineplus">+                                    customHeaders.get());</span>
<a href="#l17.1527"></a><span id="l17.1527" class="difflineplus">+      *ppOutTable = m_localNewsJunkBodyTable;</span>
<a href="#l17.1528"></a><span id="l17.1528" class="difflineplus">+      break;</span>
<a href="#l17.1529"></a><span id="l17.1529"> </span>
<a href="#l17.1530"></a><span id="l17.1530" class="difflineminus">-  case nsMsgSearchScope::onlineManual:</span>
<a href="#l17.1531"></a><span id="l17.1531" class="difflineminus">-    if (!m_onlineManualFilterTable)</span>
<a href="#l17.1532"></a><span id="l17.1532" class="difflineminus">-      rv = InitOnlineManualFilterTable();</span>
<a href="#l17.1533"></a><span id="l17.1533" class="difflineminus">-    if (m_onlineManualFilterTable)</span>
<a href="#l17.1534"></a><span id="l17.1534" class="difflineminus">-      rv = SetOtherHeadersInTable(m_onlineManualFilterTable, customHeaders.get());</span>
<a href="#l17.1535"></a><span id="l17.1535" class="difflineminus">-    *ppOutTable = m_onlineManualFilterTable;</span>
<a href="#l17.1536"></a><span id="l17.1536" class="difflineminus">-    break;</span>
<a href="#l17.1537"></a><span id="l17.1537" class="difflineminus">-  case nsMsgSearchScope::LDAP:</span>
<a href="#l17.1538"></a><span id="l17.1538" class="difflineminus">-    if (!m_ldapTable)</span>
<a href="#l17.1539"></a><span id="l17.1539" class="difflineminus">-      rv = InitLdapTable ();</span>
<a href="#l17.1540"></a><span id="l17.1540" class="difflineminus">-    *ppOutTable = m_ldapTable;</span>
<a href="#l17.1541"></a><span id="l17.1541" class="difflineminus">-    break;</span>
<a href="#l17.1542"></a><span id="l17.1542" class="difflineminus">-  case nsMsgSearchScope::LDAPAnd:</span>
<a href="#l17.1543"></a><span id="l17.1543" class="difflineminus">-    if (!m_ldapAndTable)</span>
<a href="#l17.1544"></a><span id="l17.1544" class="difflineminus">-      rv = InitLdapAndTable ();</span>
<a href="#l17.1545"></a><span id="l17.1545" class="difflineminus">-    *ppOutTable = m_ldapAndTable;</span>
<a href="#l17.1546"></a><span id="l17.1546" class="difflineminus">-    break;</span>
<a href="#l17.1547"></a><span id="l17.1547" class="difflineminus">-  case nsMsgSearchScope::LocalAB:</span>
<a href="#l17.1548"></a><span id="l17.1548" class="difflineminus">-    if (!m_localABTable)</span>
<a href="#l17.1549"></a><span id="l17.1549" class="difflineminus">-      rv = InitLocalABTable ();</span>
<a href="#l17.1550"></a><span id="l17.1550" class="difflineminus">-    *ppOutTable = m_localABTable;</span>
<a href="#l17.1551"></a><span id="l17.1551" class="difflineminus">-    break;</span>
<a href="#l17.1552"></a><span id="l17.1552" class="difflineminus">-  case nsMsgSearchScope::LocalABAnd:</span>
<a href="#l17.1553"></a><span id="l17.1553" class="difflineminus">-    if (!m_localABAndTable)</span>
<a href="#l17.1554"></a><span id="l17.1554" class="difflineminus">-      rv = InitLocalABAndTable ();</span>
<a href="#l17.1555"></a><span id="l17.1555" class="difflineminus">-    *ppOutTable = m_localABAndTable;</span>
<a href="#l17.1556"></a><span id="l17.1556" class="difflineminus">-    break;</span>
<a href="#l17.1557"></a><span id="l17.1557" class="difflineminus">-  default:</span>
<a href="#l17.1558"></a><span id="l17.1558" class="difflineminus">-    NS_ASSERTION(false, &quot;invalid table type&quot;);</span>
<a href="#l17.1559"></a><span id="l17.1559" class="difflineminus">-    rv = NS_MSG_ERROR_INVALID_SEARCH_TERM;</span>
<a href="#l17.1560"></a><span id="l17.1560" class="difflineplus">+    case nsMsgSearchScope::onlineManual:</span>
<a href="#l17.1561"></a><span id="l17.1561" class="difflineplus">+      if (!m_onlineManualFilterTable) rv = InitOnlineManualFilterTable();</span>
<a href="#l17.1562"></a><span id="l17.1562" class="difflineplus">+      if (m_onlineManualFilterTable)</span>
<a href="#l17.1563"></a><span id="l17.1563" class="difflineplus">+        rv = SetOtherHeadersInTable(m_onlineManualFilterTable,</span>
<a href="#l17.1564"></a><span id="l17.1564" class="difflineplus">+                                    customHeaders.get());</span>
<a href="#l17.1565"></a><span id="l17.1565" class="difflineplus">+      *ppOutTable = m_onlineManualFilterTable;</span>
<a href="#l17.1566"></a><span id="l17.1566" class="difflineplus">+      break;</span>
<a href="#l17.1567"></a><span id="l17.1567" class="difflineplus">+    case nsMsgSearchScope::LDAP:</span>
<a href="#l17.1568"></a><span id="l17.1568" class="difflineplus">+      if (!m_ldapTable) rv = InitLdapTable();</span>
<a href="#l17.1569"></a><span id="l17.1569" class="difflineplus">+      *ppOutTable = m_ldapTable;</span>
<a href="#l17.1570"></a><span id="l17.1570" class="difflineplus">+      break;</span>
<a href="#l17.1571"></a><span id="l17.1571" class="difflineplus">+    case nsMsgSearchScope::LDAPAnd:</span>
<a href="#l17.1572"></a><span id="l17.1572" class="difflineplus">+      if (!m_ldapAndTable) rv = InitLdapAndTable();</span>
<a href="#l17.1573"></a><span id="l17.1573" class="difflineplus">+      *ppOutTable = m_ldapAndTable;</span>
<a href="#l17.1574"></a><span id="l17.1574" class="difflineplus">+      break;</span>
<a href="#l17.1575"></a><span id="l17.1575" class="difflineplus">+    case nsMsgSearchScope::LocalAB:</span>
<a href="#l17.1576"></a><span id="l17.1576" class="difflineplus">+      if (!m_localABTable) rv = InitLocalABTable();</span>
<a href="#l17.1577"></a><span id="l17.1577" class="difflineplus">+      *ppOutTable = m_localABTable;</span>
<a href="#l17.1578"></a><span id="l17.1578" class="difflineplus">+      break;</span>
<a href="#l17.1579"></a><span id="l17.1579" class="difflineplus">+    case nsMsgSearchScope::LocalABAnd:</span>
<a href="#l17.1580"></a><span id="l17.1580" class="difflineplus">+      if (!m_localABAndTable) rv = InitLocalABAndTable();</span>
<a href="#l17.1581"></a><span id="l17.1581" class="difflineplus">+      *ppOutTable = m_localABAndTable;</span>
<a href="#l17.1582"></a><span id="l17.1582" class="difflineplus">+      break;</span>
<a href="#l17.1583"></a><span id="l17.1583" class="difflineplus">+    default:</span>
<a href="#l17.1584"></a><span id="l17.1584" class="difflineplus">+      NS_ASSERTION(false, &quot;invalid table type&quot;);</span>
<a href="#l17.1585"></a><span id="l17.1585" class="difflineplus">+      rv = NS_MSG_ERROR_INVALID_SEARCH_TERM;</span>
<a href="#l17.1586"></a><span id="l17.1586">   }</span>
<a href="#l17.1587"></a><span id="l17.1587"> </span>
<a href="#l17.1588"></a><span id="l17.1588" class="difflineminus">-  NS_IF_ADDREF(*ppOutTable); // Was populated from member variable.</span>
<a href="#l17.1589"></a><span id="l17.1589" class="difflineplus">+  NS_IF_ADDREF(*ppOutTable);  // Was populated from member variable.</span>
<a href="#l17.1590"></a><span id="l17.1590">   return rv;</span>
<a href="#l17.1591"></a><span id="l17.1591"> }</span>
<a href="#l17.1592"></a><span id="l17.1592"> </span>
<a href="#l17.1593"></a><span id="l17.1593"> // mapping between ordered attribute values, and property strings</span>
<a href="#l17.1594"></a><span id="l17.1594"> // see search-attributes.properties</span>
<a href="#l17.1595"></a><span id="l17.1595" class="difflineminus">-static struct</span>
<a href="#l17.1596"></a><span id="l17.1596" class="difflineminus">-{</span>
<a href="#l17.1597"></a><span id="l17.1597" class="difflineplus">+static struct {</span>
<a href="#l17.1598"></a><span id="l17.1598">   nsMsgSearchAttribValue id;</span>
<a href="#l17.1599"></a><span id="l17.1599" class="difflineminus">-  const char* property;</span>
<a href="#l17.1600"></a><span id="l17.1600" class="difflineminus">-}</span>
<a href="#l17.1601"></a><span id="l17.1601" class="difflineminus">-nsMsgSearchAttribMap[] =</span>
<a href="#l17.1602"></a><span id="l17.1602" class="difflineminus">-{</span>
<a href="#l17.1603"></a><span id="l17.1603" class="difflineminus">-  {nsMsgSearchAttrib::Subject, &quot;Subject&quot;},</span>
<a href="#l17.1604"></a><span id="l17.1604" class="difflineminus">-  {nsMsgSearchAttrib::Sender, &quot;From&quot;},</span>
<a href="#l17.1605"></a><span id="l17.1605" class="difflineminus">-  {nsMsgSearchAttrib::Body, &quot;Body&quot;},</span>
<a href="#l17.1606"></a><span id="l17.1606" class="difflineminus">-  {nsMsgSearchAttrib::Date, &quot;Date&quot;},</span>
<a href="#l17.1607"></a><span id="l17.1607" class="difflineminus">-  {nsMsgSearchAttrib::Priority, &quot;Priority&quot;},</span>
<a href="#l17.1608"></a><span id="l17.1608" class="difflineminus">-  {nsMsgSearchAttrib::MsgStatus, &quot;Status&quot;},</span>
<a href="#l17.1609"></a><span id="l17.1609" class="difflineminus">-  {nsMsgSearchAttrib::To, &quot;To&quot;},</span>
<a href="#l17.1610"></a><span id="l17.1610" class="difflineminus">-  {nsMsgSearchAttrib::CC, &quot;Cc&quot;},</span>
<a href="#l17.1611"></a><span id="l17.1611" class="difflineminus">-  {nsMsgSearchAttrib::ToOrCC, &quot;ToOrCc&quot;},</span>
<a href="#l17.1612"></a><span id="l17.1612" class="difflineminus">-  {nsMsgSearchAttrib::AgeInDays, &quot;AgeInDays&quot;},</span>
<a href="#l17.1613"></a><span id="l17.1613" class="difflineminus">-  {nsMsgSearchAttrib::Size, &quot;SizeKB&quot;},</span>
<a href="#l17.1614"></a><span id="l17.1614" class="difflineminus">-  {nsMsgSearchAttrib::Keywords, &quot;Tags&quot;},</span>
<a href="#l17.1615"></a><span id="l17.1615" class="difflineminus">-  {nsMsgSearchAttrib::Name, &quot;AnyName&quot;},</span>
<a href="#l17.1616"></a><span id="l17.1616" class="difflineminus">-  {nsMsgSearchAttrib::DisplayName, &quot;DisplayName&quot;},</span>
<a href="#l17.1617"></a><span id="l17.1617" class="difflineminus">-  {nsMsgSearchAttrib::Nickname, &quot;Nickname&quot;},</span>
<a href="#l17.1618"></a><span id="l17.1618" class="difflineminus">-  {nsMsgSearchAttrib::ScreenName, &quot;ScreenName&quot;},</span>
<a href="#l17.1619"></a><span id="l17.1619" class="difflineminus">-  {nsMsgSearchAttrib::Email, &quot;Email&quot;},</span>
<a href="#l17.1620"></a><span id="l17.1620" class="difflineminus">-  {nsMsgSearchAttrib::AdditionalEmail, &quot;AdditionalEmail&quot;},</span>
<a href="#l17.1621"></a><span id="l17.1621" class="difflineminus">-  {nsMsgSearchAttrib::PhoneNumber, &quot;AnyNumber&quot;},</span>
<a href="#l17.1622"></a><span id="l17.1622" class="difflineminus">-  {nsMsgSearchAttrib::WorkPhone, &quot;WorkPhone&quot;},</span>
<a href="#l17.1623"></a><span id="l17.1623" class="difflineminus">-  {nsMsgSearchAttrib::HomePhone, &quot;HomePhone&quot;},</span>
<a href="#l17.1624"></a><span id="l17.1624" class="difflineminus">-  {nsMsgSearchAttrib::Fax, &quot;Fax&quot;},</span>
<a href="#l17.1625"></a><span id="l17.1625" class="difflineminus">-  {nsMsgSearchAttrib::Pager, &quot;Pager&quot;},</span>
<a href="#l17.1626"></a><span id="l17.1626" class="difflineminus">-  {nsMsgSearchAttrib::Mobile, &quot;Mobile&quot;},</span>
<a href="#l17.1627"></a><span id="l17.1627" class="difflineminus">-  {nsMsgSearchAttrib::City, &quot;City&quot;},</span>
<a href="#l17.1628"></a><span id="l17.1628" class="difflineminus">-  {nsMsgSearchAttrib::Street, &quot;Street&quot;},</span>
<a href="#l17.1629"></a><span id="l17.1629" class="difflineminus">-  {nsMsgSearchAttrib::Title, &quot;Title&quot;},</span>
<a href="#l17.1630"></a><span id="l17.1630" class="difflineminus">-  {nsMsgSearchAttrib::Organization, &quot;Organization&quot;},</span>
<a href="#l17.1631"></a><span id="l17.1631" class="difflineminus">-  {nsMsgSearchAttrib::Department, &quot;Department&quot;},</span>
<a href="#l17.1632"></a><span id="l17.1632" class="difflineminus">-  {nsMsgSearchAttrib::AllAddresses, &quot;FromToCcOrBcc&quot;},</span>
<a href="#l17.1633"></a><span id="l17.1633" class="difflineminus">-  {nsMsgSearchAttrib::JunkScoreOrigin, &quot;JunkScoreOrigin&quot;},</span>
<a href="#l17.1634"></a><span id="l17.1634" class="difflineminus">-  {nsMsgSearchAttrib::JunkPercent, &quot;JunkPercent&quot;},</span>
<a href="#l17.1635"></a><span id="l17.1635" class="difflineminus">-  {nsMsgSearchAttrib::HasAttachmentStatus, &quot;AttachmentStatus&quot;},</span>
<a href="#l17.1636"></a><span id="l17.1636" class="difflineminus">-  {nsMsgSearchAttrib::JunkStatus, &quot;JunkStatus&quot;},</span>
<a href="#l17.1637"></a><span id="l17.1637" class="difflineminus">-  {nsMsgSearchAttrib::Label, &quot;Label&quot;},</span>
<a href="#l17.1638"></a><span id="l17.1638" class="difflineminus">-  {nsMsgSearchAttrib::OtherHeader, &quot;Customize&quot;},</span>
<a href="#l17.1639"></a><span id="l17.1639" class="difflineminus">-  // the last id is -1 to denote end of table</span>
<a href="#l17.1640"></a><span id="l17.1640" class="difflineminus">-  {-1, &quot;&quot;}</span>
<a href="#l17.1641"></a><span id="l17.1641" class="difflineminus">-};</span>
<a href="#l17.1642"></a><span id="l17.1642" class="difflineplus">+  const char *property;</span>
<a href="#l17.1643"></a><span id="l17.1643" class="difflineplus">+} nsMsgSearchAttribMap[] = {</span>
<a href="#l17.1644"></a><span id="l17.1644" class="difflineplus">+    {nsMsgSearchAttrib::Subject, &quot;Subject&quot;},</span>
<a href="#l17.1645"></a><span id="l17.1645" class="difflineplus">+    {nsMsgSearchAttrib::Sender, &quot;From&quot;},</span>
<a href="#l17.1646"></a><span id="l17.1646" class="difflineplus">+    {nsMsgSearchAttrib::Body, &quot;Body&quot;},</span>
<a href="#l17.1647"></a><span id="l17.1647" class="difflineplus">+    {nsMsgSearchAttrib::Date, &quot;Date&quot;},</span>
<a href="#l17.1648"></a><span id="l17.1648" class="difflineplus">+    {nsMsgSearchAttrib::Priority, &quot;Priority&quot;},</span>
<a href="#l17.1649"></a><span id="l17.1649" class="difflineplus">+    {nsMsgSearchAttrib::MsgStatus, &quot;Status&quot;},</span>
<a href="#l17.1650"></a><span id="l17.1650" class="difflineplus">+    {nsMsgSearchAttrib::To, &quot;To&quot;},</span>
<a href="#l17.1651"></a><span id="l17.1651" class="difflineplus">+    {nsMsgSearchAttrib::CC, &quot;Cc&quot;},</span>
<a href="#l17.1652"></a><span id="l17.1652" class="difflineplus">+    {nsMsgSearchAttrib::ToOrCC, &quot;ToOrCc&quot;},</span>
<a href="#l17.1653"></a><span id="l17.1653" class="difflineplus">+    {nsMsgSearchAttrib::AgeInDays, &quot;AgeInDays&quot;},</span>
<a href="#l17.1654"></a><span id="l17.1654" class="difflineplus">+    {nsMsgSearchAttrib::Size, &quot;SizeKB&quot;},</span>
<a href="#l17.1655"></a><span id="l17.1655" class="difflineplus">+    {nsMsgSearchAttrib::Keywords, &quot;Tags&quot;},</span>
<a href="#l17.1656"></a><span id="l17.1656" class="difflineplus">+    {nsMsgSearchAttrib::Name, &quot;AnyName&quot;},</span>
<a href="#l17.1657"></a><span id="l17.1657" class="difflineplus">+    {nsMsgSearchAttrib::DisplayName, &quot;DisplayName&quot;},</span>
<a href="#l17.1658"></a><span id="l17.1658" class="difflineplus">+    {nsMsgSearchAttrib::Nickname, &quot;Nickname&quot;},</span>
<a href="#l17.1659"></a><span id="l17.1659" class="difflineplus">+    {nsMsgSearchAttrib::ScreenName, &quot;ScreenName&quot;},</span>
<a href="#l17.1660"></a><span id="l17.1660" class="difflineplus">+    {nsMsgSearchAttrib::Email, &quot;Email&quot;},</span>
<a href="#l17.1661"></a><span id="l17.1661" class="difflineplus">+    {nsMsgSearchAttrib::AdditionalEmail, &quot;AdditionalEmail&quot;},</span>
<a href="#l17.1662"></a><span id="l17.1662" class="difflineplus">+    {nsMsgSearchAttrib::PhoneNumber, &quot;AnyNumber&quot;},</span>
<a href="#l17.1663"></a><span id="l17.1663" class="difflineplus">+    {nsMsgSearchAttrib::WorkPhone, &quot;WorkPhone&quot;},</span>
<a href="#l17.1664"></a><span id="l17.1664" class="difflineplus">+    {nsMsgSearchAttrib::HomePhone, &quot;HomePhone&quot;},</span>
<a href="#l17.1665"></a><span id="l17.1665" class="difflineplus">+    {nsMsgSearchAttrib::Fax, &quot;Fax&quot;},</span>
<a href="#l17.1666"></a><span id="l17.1666" class="difflineplus">+    {nsMsgSearchAttrib::Pager, &quot;Pager&quot;},</span>
<a href="#l17.1667"></a><span id="l17.1667" class="difflineplus">+    {nsMsgSearchAttrib::Mobile, &quot;Mobile&quot;},</span>
<a href="#l17.1668"></a><span id="l17.1668" class="difflineplus">+    {nsMsgSearchAttrib::City, &quot;City&quot;},</span>
<a href="#l17.1669"></a><span id="l17.1669" class="difflineplus">+    {nsMsgSearchAttrib::Street, &quot;Street&quot;},</span>
<a href="#l17.1670"></a><span id="l17.1670" class="difflineplus">+    {nsMsgSearchAttrib::Title, &quot;Title&quot;},</span>
<a href="#l17.1671"></a><span id="l17.1671" class="difflineplus">+    {nsMsgSearchAttrib::Organization, &quot;Organization&quot;},</span>
<a href="#l17.1672"></a><span id="l17.1672" class="difflineplus">+    {nsMsgSearchAttrib::Department, &quot;Department&quot;},</span>
<a href="#l17.1673"></a><span id="l17.1673" class="difflineplus">+    {nsMsgSearchAttrib::AllAddresses, &quot;FromToCcOrBcc&quot;},</span>
<a href="#l17.1674"></a><span id="l17.1674" class="difflineplus">+    {nsMsgSearchAttrib::JunkScoreOrigin, &quot;JunkScoreOrigin&quot;},</span>
<a href="#l17.1675"></a><span id="l17.1675" class="difflineplus">+    {nsMsgSearchAttrib::JunkPercent, &quot;JunkPercent&quot;},</span>
<a href="#l17.1676"></a><span id="l17.1676" class="difflineplus">+    {nsMsgSearchAttrib::HasAttachmentStatus, &quot;AttachmentStatus&quot;},</span>
<a href="#l17.1677"></a><span id="l17.1677" class="difflineplus">+    {nsMsgSearchAttrib::JunkStatus, &quot;JunkStatus&quot;},</span>
<a href="#l17.1678"></a><span id="l17.1678" class="difflineplus">+    {nsMsgSearchAttrib::Label, &quot;Label&quot;},</span>
<a href="#l17.1679"></a><span id="l17.1679" class="difflineplus">+    {nsMsgSearchAttrib::OtherHeader, &quot;Customize&quot;},</span>
<a href="#l17.1680"></a><span id="l17.1680" class="difflineplus">+    // the last id is -1 to denote end of table</span>
<a href="#l17.1681"></a><span id="l17.1681" class="difflineplus">+    {-1, &quot;&quot;}};</span>
<a href="#l17.1682"></a><span id="l17.1682"> </span>
<a href="#l17.1683"></a><span id="l17.1683"> NS_IMETHODIMP</span>
<a href="#l17.1684"></a><span id="l17.1684" class="difflineminus">-nsMsgSearchValidityManager::GetAttributeProperty(nsMsgSearchAttribValue aSearchAttribute,</span>
<a href="#l17.1685"></a><span id="l17.1685" class="difflineminus">-                                                 nsAString&amp; aProperty)</span>
<a href="#l17.1686"></a><span id="l17.1686" class="difflineminus">-{</span>
<a href="#l17.1687"></a><span id="l17.1687" class="difflineminus">-  for (int32_t i = 0; nsMsgSearchAttribMap[i].id &gt;= 0; ++i)</span>
<a href="#l17.1688"></a><span id="l17.1688" class="difflineminus">-  {</span>
<a href="#l17.1689"></a><span id="l17.1689" class="difflineminus">-    if (nsMsgSearchAttribMap[i].id == aSearchAttribute)</span>
<a href="#l17.1690"></a><span id="l17.1690" class="difflineminus">-    {</span>
<a href="#l17.1691"></a><span id="l17.1691" class="difflineplus">+nsMsgSearchValidityManager::GetAttributeProperty(</span>
<a href="#l17.1692"></a><span id="l17.1692" class="difflineplus">+    nsMsgSearchAttribValue aSearchAttribute, nsAString &amp;aProperty) {</span>
<a href="#l17.1693"></a><span id="l17.1693" class="difflineplus">+  for (int32_t i = 0; nsMsgSearchAttribMap[i].id &gt;= 0; ++i) {</span>
<a href="#l17.1694"></a><span id="l17.1694" class="difflineplus">+    if (nsMsgSearchAttribMap[i].id == aSearchAttribute) {</span>
<a href="#l17.1695"></a><span id="l17.1695">       aProperty.Assign(NS_ConvertUTF8toUTF16(nsMsgSearchAttribMap[i].property));</span>
<a href="#l17.1696"></a><span id="l17.1696">       return NS_OK;</span>
<a href="#l17.1697"></a><span id="l17.1697">     }</span>
<a href="#l17.1698"></a><span id="l17.1698">   }</span>
<a href="#l17.1699"></a><span id="l17.1699">   return NS_ERROR_FAILURE;</span>
<a href="#l17.1700"></a><span id="l17.1700"> }</span>
<a href="#l17.1701"></a><span id="l17.1701"> </span>
<a href="#l17.1702"></a><span id="l17.1702" class="difflineminus">-nsresult</span>
<a href="#l17.1703"></a><span id="l17.1703" class="difflineminus">-nsMsgSearchValidityManager::NewTable(nsIMsgSearchValidityTable **aTable)</span>
<a href="#l17.1704"></a><span id="l17.1704" class="difflineminus">-{</span>
<a href="#l17.1705"></a><span id="l17.1705" class="difflineplus">+nsresult nsMsgSearchValidityManager::NewTable(</span>
<a href="#l17.1706"></a><span id="l17.1706" class="difflineplus">+    nsIMsgSearchValidityTable **aTable) {</span>
<a href="#l17.1707"></a><span id="l17.1707">   NS_ENSURE_ARG_POINTER(aTable);</span>
<a href="#l17.1708"></a><span id="l17.1708">   NS_ADDREF(*aTable = new nsMsgSearchValidityTable);</span>
<a href="#l17.1709"></a><span id="l17.1709">   return NS_OK;</span>
<a href="#l17.1710"></a><span id="l17.1710"> }</span>
<a href="#l17.1711"></a><span id="l17.1711"> </span>
<a href="#l17.1712"></a><span id="l17.1712" class="difflineminus">-nsresult</span>
<a href="#l17.1713"></a><span id="l17.1713" class="difflineminus">-nsMsgSearchValidityManager::SetOtherHeadersInTable (nsIMsgSearchValidityTable *aTable, const char *customHeaders)</span>
<a href="#l17.1714"></a><span id="l17.1714" class="difflineminus">-{</span>
<a href="#l17.1715"></a><span id="l17.1715" class="difflineplus">+nsresult nsMsgSearchValidityManager::SetOtherHeadersInTable(</span>
<a href="#l17.1716"></a><span id="l17.1716" class="difflineplus">+    nsIMsgSearchValidityTable *aTable, const char *customHeaders) {</span>
<a href="#l17.1717"></a><span id="l17.1717">   uint32_t customHeadersLength = strlen(customHeaders);</span>
<a href="#l17.1718"></a><span id="l17.1718" class="difflineminus">-  uint32_t numHeaders=0;</span>
<a href="#l17.1719"></a><span id="l17.1719" class="difflineminus">-  if (customHeadersLength)</span>
<a href="#l17.1720"></a><span id="l17.1720" class="difflineminus">-  {</span>
<a href="#l17.1721"></a><span id="l17.1721" class="difflineplus">+  uint32_t numHeaders = 0;</span>
<a href="#l17.1722"></a><span id="l17.1722" class="difflineplus">+  if (customHeadersLength) {</span>
<a href="#l17.1723"></a><span id="l17.1723">     nsAutoCString hdrStr(customHeaders);</span>
<a href="#l17.1724"></a><span id="l17.1724" class="difflineminus">-    hdrStr.StripWhitespace();  //remove whitespace before parsing</span>
<a href="#l17.1725"></a><span id="l17.1725" class="difflineplus">+    hdrStr.StripWhitespace();  // remove whitespace before parsing</span>
<a href="#l17.1726"></a><span id="l17.1726">     char *newStr = hdrStr.BeginWriting();</span>
<a href="#l17.1727"></a><span id="l17.1727">     char *token = NS_strtok(&quot;:&quot;, &amp;newStr);</span>
<a href="#l17.1728"></a><span id="l17.1728" class="difflineminus">-    while(token)</span>
<a href="#l17.1729"></a><span id="l17.1729" class="difflineminus">-    {</span>
<a href="#l17.1730"></a><span id="l17.1730" class="difflineplus">+    while (token) {</span>
<a href="#l17.1731"></a><span id="l17.1731">       numHeaders++;</span>
<a href="#l17.1732"></a><span id="l17.1732">       token = NS_strtok(&quot;:&quot;, &amp;newStr);</span>
<a href="#l17.1733"></a><span id="l17.1733">     }</span>
<a href="#l17.1734"></a><span id="l17.1734">   }</span>
<a href="#l17.1735"></a><span id="l17.1735"> </span>
<a href="#l17.1736"></a><span id="l17.1736" class="difflineminus">-  NS_ASSERTION(nsMsgSearchAttrib::OtherHeader + numHeaders &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes, &quot;more headers than the table can hold&quot;);</span>
<a href="#l17.1737"></a><span id="l17.1737" class="difflineplus">+  NS_ASSERTION(nsMsgSearchAttrib::OtherHeader + numHeaders &lt;</span>
<a href="#l17.1738"></a><span id="l17.1738" class="difflineplus">+                   nsMsgSearchAttrib::kNumMsgSearchAttributes,</span>
<a href="#l17.1739"></a><span id="l17.1739" class="difflineplus">+               &quot;more headers than the table can hold&quot;);</span>
<a href="#l17.1740"></a><span id="l17.1740"> </span>
<a href="#l17.1741"></a><span id="l17.1741" class="difflineminus">-  uint32_t maxHdrs = std::min(nsMsgSearchAttrib::OtherHeader + numHeaders + 1,</span>
<a href="#l17.1742"></a><span id="l17.1742" class="difflineminus">-                            (uint32_t)nsMsgSearchAttrib::kNumMsgSearchAttributes);</span>
<a href="#l17.1743"></a><span id="l17.1743" class="difflineminus">-  for (uint32_t i=nsMsgSearchAttrib::OtherHeader+1;i&lt; maxHdrs;i++)</span>
<a href="#l17.1744"></a><span id="l17.1744" class="difflineminus">-  {</span>
<a href="#l17.1745"></a><span id="l17.1745" class="difflineminus">-    aTable-&gt;SetAvailable (i, nsMsgSearchOp::Contains, 1);   // added for arbitrary headers</span>
<a href="#l17.1746"></a><span id="l17.1746" class="difflineminus">-    aTable-&gt;SetEnabled   (i, nsMsgSearchOp::Contains, 1);</span>
<a href="#l17.1747"></a><span id="l17.1747" class="difflineminus">-    aTable-&gt;SetAvailable (i, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1748"></a><span id="l17.1748" class="difflineminus">-    aTable-&gt;SetEnabled   (i, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1749"></a><span id="l17.1749" class="difflineminus">-    aTable-&gt;SetAvailable (i, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1750"></a><span id="l17.1750" class="difflineminus">-    aTable-&gt;SetEnabled   (i, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1751"></a><span id="l17.1751" class="difflineminus">-    aTable-&gt;SetAvailable (i, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1752"></a><span id="l17.1752" class="difflineminus">-    aTable-&gt;SetEnabled   (i, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1753"></a><span id="l17.1753" class="difflineplus">+  uint32_t maxHdrs =</span>
<a href="#l17.1754"></a><span id="l17.1754" class="difflineplus">+      std::min(nsMsgSearchAttrib::OtherHeader + numHeaders + 1,</span>
<a href="#l17.1755"></a><span id="l17.1755" class="difflineplus">+               (uint32_t)nsMsgSearchAttrib::kNumMsgSearchAttributes);</span>
<a href="#l17.1756"></a><span id="l17.1756" class="difflineplus">+  for (uint32_t i = nsMsgSearchAttrib::OtherHeader + 1; i &lt; maxHdrs; i++) {</span>
<a href="#l17.1757"></a><span id="l17.1757" class="difflineplus">+    // clang-format off</span>
<a href="#l17.1758"></a><span id="l17.1758" class="difflineplus">+    aTable-&gt;SetAvailable(i, nsMsgSearchOp::Contains, 1);  // added for arbitrary headers</span>
<a href="#l17.1759"></a><span id="l17.1759" class="difflineplus">+    aTable-&gt;SetEnabled  (i, nsMsgSearchOp::Contains, 1);</span>
<a href="#l17.1760"></a><span id="l17.1760" class="difflineplus">+    aTable-&gt;SetAvailable(i, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1761"></a><span id="l17.1761" class="difflineplus">+    aTable-&gt;SetEnabled  (i, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1762"></a><span id="l17.1762" class="difflineplus">+    aTable-&gt;SetAvailable(i, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1763"></a><span id="l17.1763" class="difflineplus">+    aTable-&gt;SetEnabled  (i, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1764"></a><span id="l17.1764" class="difflineplus">+    aTable-&gt;SetAvailable(i, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1765"></a><span id="l17.1765" class="difflineplus">+    aTable-&gt;SetEnabled  (i, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1766"></a><span id="l17.1766" class="difflineplus">+    // clang-format on</span>
<a href="#l17.1767"></a><span id="l17.1767">   }</span>
<a href="#l17.1768"></a><span id="l17.1768" class="difflineminus">-   //because custom headers can change; so reset the table for those which are no longer used.</span>
<a href="#l17.1769"></a><span id="l17.1769" class="difflineminus">-  for (uint32_t j=maxHdrs; j &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes; j++)</span>
<a href="#l17.1770"></a><span id="l17.1770" class="difflineminus">-  {</span>
<a href="#l17.1771"></a><span id="l17.1771" class="difflineminus">-    for (uint32_t k=0; k &lt; nsMsgSearchOp::kNumMsgSearchOperators; k++)</span>
<a href="#l17.1772"></a><span id="l17.1772" class="difflineminus">-    {</span>
<a href="#l17.1773"></a><span id="l17.1773" class="difflineminus">-      aTable-&gt;SetAvailable(j,k,0);</span>
<a href="#l17.1774"></a><span id="l17.1774" class="difflineminus">-      aTable-&gt;SetEnabled(j,k,0);</span>
<a href="#l17.1775"></a><span id="l17.1775" class="difflineplus">+  // because custom headers can change; so reset the table for those which are</span>
<a href="#l17.1776"></a><span id="l17.1776" class="difflineplus">+  // no longer used.</span>
<a href="#l17.1777"></a><span id="l17.1777" class="difflineplus">+  for (uint32_t j = maxHdrs; j &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes;</span>
<a href="#l17.1778"></a><span id="l17.1778" class="difflineplus">+       j++) {</span>
<a href="#l17.1779"></a><span id="l17.1779" class="difflineplus">+    for (uint32_t k = 0; k &lt; nsMsgSearchOp::kNumMsgSearchOperators; k++) {</span>
<a href="#l17.1780"></a><span id="l17.1780" class="difflineplus">+      aTable-&gt;SetAvailable(j, k, 0);</span>
<a href="#l17.1781"></a><span id="l17.1781" class="difflineplus">+      aTable-&gt;SetEnabled(j, k, 0);</span>
<a href="#l17.1782"></a><span id="l17.1782">     }</span>
<a href="#l17.1783"></a><span id="l17.1783">   }</span>
<a href="#l17.1784"></a><span id="l17.1784">   return NS_OK;</span>
<a href="#l17.1785"></a><span id="l17.1785"> }</span>
<a href="#l17.1786"></a><span id="l17.1786"> </span>
<a href="#l17.1787"></a><span id="l17.1787" class="difflineminus">-nsresult nsMsgSearchValidityManager::EnableDirectoryAttribute(nsIMsgSearchValidityTable *table, nsMsgSearchAttribValue aSearchAttrib)</span>
<a href="#l17.1788"></a><span id="l17.1788" class="difflineminus">-{</span>
<a href="#l17.1789"></a><span id="l17.1789" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::Contains, 1);</span>
<a href="#l17.1790"></a><span id="l17.1790" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::Contains, 1);</span>
<a href="#l17.1791"></a><span id="l17.1791" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1792"></a><span id="l17.1792" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1793"></a><span id="l17.1793" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1794"></a><span id="l17.1794" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1795"></a><span id="l17.1795" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1796"></a><span id="l17.1796" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1797"></a><span id="l17.1797" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l17.1798"></a><span id="l17.1798" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l17.1799"></a><span id="l17.1799" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l17.1800"></a><span id="l17.1800" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l17.1801"></a><span id="l17.1801" class="difflineminus">-        table-&gt;SetAvailable (aSearchAttrib, nsMsgSearchOp::SoundsLike, 1);</span>
<a href="#l17.1802"></a><span id="l17.1802" class="difflineminus">-        table-&gt;SetEnabled   (aSearchAttrib, nsMsgSearchOp::SoundsLike, 1);</span>
<a href="#l17.1803"></a><span id="l17.1803" class="difflineminus">-        return NS_OK;</span>
<a href="#l17.1804"></a><span id="l17.1804" class="difflineplus">+nsresult nsMsgSearchValidityManager::EnableDirectoryAttribute(</span>
<a href="#l17.1805"></a><span id="l17.1805" class="difflineplus">+    nsIMsgSearchValidityTable *table, nsMsgSearchAttribValue aSearchAttrib) {</span>
<a href="#l17.1806"></a><span id="l17.1806" class="difflineplus">+  // clang-format off</span>
<a href="#l17.1807"></a><span id="l17.1807" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::Contains, 1);</span>
<a href="#l17.1808"></a><span id="l17.1808" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::Contains, 1);</span>
<a href="#l17.1809"></a><span id="l17.1809" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1810"></a><span id="l17.1810" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l17.1811"></a><span id="l17.1811" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1812"></a><span id="l17.1812" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::Is, 1);</span>
<a href="#l17.1813"></a><span id="l17.1813" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1814"></a><span id="l17.1814" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l17.1815"></a><span id="l17.1815" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l17.1816"></a><span id="l17.1816" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l17.1817"></a><span id="l17.1817" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l17.1818"></a><span id="l17.1818" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l17.1819"></a><span id="l17.1819" class="difflineplus">+  table-&gt;SetAvailable(aSearchAttrib, nsMsgSearchOp::SoundsLike, 1);</span>
<a href="#l17.1820"></a><span id="l17.1820" class="difflineplus">+  table-&gt;SetEnabled  (aSearchAttrib, nsMsgSearchOp::SoundsLike, 1);</span>
<a href="#l17.1821"></a><span id="l17.1821" class="difflineplus">+  // clang-format on</span>
<a href="#l17.1822"></a><span id="l17.1822" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.1823"></a><span id="l17.1823"> }</span>
<a href="#l17.1824"></a><span id="l17.1824"> </span>
<a href="#l17.1825"></a><span id="l17.1825" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLdapTable()</span>
<a href="#l17.1826"></a><span id="l17.1826" class="difflineminus">-{</span>
<a href="#l17.1827"></a><span id="l17.1827" class="difflineminus">-  NS_ASSERTION(!m_ldapTable,&quot;don't call this twice!&quot;);</span>
<a href="#l17.1828"></a><span id="l17.1828" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLdapTable() {</span>
<a href="#l17.1829"></a><span id="l17.1829" class="difflineplus">+  NS_ASSERTION(!m_ldapTable, &quot;don't call this twice!&quot;);</span>
<a href="#l17.1830"></a><span id="l17.1830"> </span>
<a href="#l17.1831"></a><span id="l17.1831">   nsresult rv = NewTable(getter_AddRefs(m_ldapTable));</span>
<a href="#l17.1832"></a><span id="l17.1832" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1833"></a><span id="l17.1833" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1834"></a><span id="l17.1834"> </span>
<a href="#l17.1835"></a><span id="l17.1835">   rv = SetUpABTable(m_ldapTable, true);</span>
<a href="#l17.1836"></a><span id="l17.1836" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1837"></a><span id="l17.1837" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1838"></a><span id="l17.1838">   return rv;</span>
<a href="#l17.1839"></a><span id="l17.1839"> }</span>
<a href="#l17.1840"></a><span id="l17.1840"> </span>
<a href="#l17.1841"></a><span id="l17.1841" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLdapAndTable()</span>
<a href="#l17.1842"></a><span id="l17.1842" class="difflineminus">-{</span>
<a href="#l17.1843"></a><span id="l17.1843" class="difflineminus">-  NS_ASSERTION(!m_ldapAndTable,&quot;don't call this twice!&quot;);</span>
<a href="#l17.1844"></a><span id="l17.1844" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLdapAndTable() {</span>
<a href="#l17.1845"></a><span id="l17.1845" class="difflineplus">+  NS_ASSERTION(!m_ldapAndTable, &quot;don't call this twice!&quot;);</span>
<a href="#l17.1846"></a><span id="l17.1846"> </span>
<a href="#l17.1847"></a><span id="l17.1847">   nsresult rv = NewTable(getter_AddRefs(m_ldapAndTable));</span>
<a href="#l17.1848"></a><span id="l17.1848" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1849"></a><span id="l17.1849" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1850"></a><span id="l17.1850"> </span>
<a href="#l17.1851"></a><span id="l17.1851">   rv = SetUpABTable(m_ldapAndTable, false);</span>
<a href="#l17.1852"></a><span id="l17.1852" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1853"></a><span id="l17.1853" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1854"></a><span id="l17.1854">   return rv;</span>
<a href="#l17.1855"></a><span id="l17.1855"> }</span>
<a href="#l17.1856"></a><span id="l17.1856"> </span>
<a href="#l17.1857"></a><span id="l17.1857" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLocalABTable()</span>
<a href="#l17.1858"></a><span id="l17.1858" class="difflineminus">-{</span>
<a href="#l17.1859"></a><span id="l17.1859" class="difflineminus">-  NS_ASSERTION(!m_localABTable,&quot;don't call this twice!&quot;);</span>
<a href="#l17.1860"></a><span id="l17.1860" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLocalABTable() {</span>
<a href="#l17.1861"></a><span id="l17.1861" class="difflineplus">+  NS_ASSERTION(!m_localABTable, &quot;don't call this twice!&quot;);</span>
<a href="#l17.1862"></a><span id="l17.1862"> </span>
<a href="#l17.1863"></a><span id="l17.1863">   nsresult rv = NewTable(getter_AddRefs(m_localABTable));</span>
<a href="#l17.1864"></a><span id="l17.1864" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1865"></a><span id="l17.1865" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1866"></a><span id="l17.1866"> </span>
<a href="#l17.1867"></a><span id="l17.1867">   rv = SetUpABTable(m_localABTable, true);</span>
<a href="#l17.1868"></a><span id="l17.1868" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1869"></a><span id="l17.1869" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1870"></a><span id="l17.1870">   return rv;</span>
<a href="#l17.1871"></a><span id="l17.1871"> }</span>
<a href="#l17.1872"></a><span id="l17.1872"> </span>
<a href="#l17.1873"></a><span id="l17.1873" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitLocalABAndTable()</span>
<a href="#l17.1874"></a><span id="l17.1874" class="difflineminus">-{</span>
<a href="#l17.1875"></a><span id="l17.1875" class="difflineminus">-  NS_ASSERTION(!m_localABAndTable,&quot;don't call this twice!&quot;);</span>
<a href="#l17.1876"></a><span id="l17.1876" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitLocalABAndTable() {</span>
<a href="#l17.1877"></a><span id="l17.1877" class="difflineplus">+  NS_ASSERTION(!m_localABAndTable, &quot;don't call this twice!&quot;);</span>
<a href="#l17.1878"></a><span id="l17.1878"> </span>
<a href="#l17.1879"></a><span id="l17.1879">   nsresult rv = NewTable(getter_AddRefs(m_localABAndTable));</span>
<a href="#l17.1880"></a><span id="l17.1880" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1881"></a><span id="l17.1881" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1882"></a><span id="l17.1882"> </span>
<a href="#l17.1883"></a><span id="l17.1883">   rv = SetUpABTable(m_localABAndTable, false);</span>
<a href="#l17.1884"></a><span id="l17.1884" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1885"></a><span id="l17.1885" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1886"></a><span id="l17.1886">   return rv;</span>
<a href="#l17.1887"></a><span id="l17.1887"> }</span>
<a href="#l17.1888"></a><span id="l17.1888"> </span>
<a href="#l17.1889"></a><span id="l17.1889" class="difflineminus">-nsresult</span>
<a href="#l17.1890"></a><span id="l17.1890" class="difflineminus">-nsMsgSearchValidityManager::SetUpABTable(nsIMsgSearchValidityTable *aTable, bool isOrTable)</span>
<a href="#l17.1891"></a><span id="l17.1891" class="difflineminus">-{</span>
<a href="#l17.1892"></a><span id="l17.1892" class="difflineminus">-  nsresult rv = aTable-&gt;SetDefaultAttrib(isOrTable ? nsMsgSearchAttrib::Name : nsMsgSearchAttrib::DisplayName);</span>
<a href="#l17.1893"></a><span id="l17.1893" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1894"></a><span id="l17.1894" class="difflineplus">+nsresult nsMsgSearchValidityManager::SetUpABTable(</span>
<a href="#l17.1895"></a><span id="l17.1895" class="difflineplus">+    nsIMsgSearchValidityTable *aTable, bool isOrTable) {</span>
<a href="#l17.1896"></a><span id="l17.1896" class="difflineplus">+  nsresult rv = aTable-&gt;SetDefaultAttrib(</span>
<a href="#l17.1897"></a><span id="l17.1897" class="difflineplus">+      isOrTable ? nsMsgSearchAttrib::Name : nsMsgSearchAttrib::DisplayName);</span>
<a href="#l17.1898"></a><span id="l17.1898" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1899"></a><span id="l17.1899"> </span>
<a href="#l17.1900"></a><span id="l17.1900">   if (isOrTable) {</span>
<a href="#l17.1901"></a><span id="l17.1901">     rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Name);</span>
<a href="#l17.1902"></a><span id="l17.1902" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1903"></a><span id="l17.1903" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1904"></a><span id="l17.1904"> </span>
<a href="#l17.1905"></a><span id="l17.1905">     rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::PhoneNumber);</span>
<a href="#l17.1906"></a><span id="l17.1906" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1907"></a><span id="l17.1907" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1908"></a><span id="l17.1908">   }</span>
<a href="#l17.1909"></a><span id="l17.1909"> </span>
<a href="#l17.1910"></a><span id="l17.1910">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::DisplayName);</span>
<a href="#l17.1911"></a><span id="l17.1911" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1912"></a><span id="l17.1912" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1913"></a><span id="l17.1913"> </span>
<a href="#l17.1914"></a><span id="l17.1914">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Email);</span>
<a href="#l17.1915"></a><span id="l17.1915" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1916"></a><span id="l17.1916" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1917"></a><span id="l17.1917"> </span>
<a href="#l17.1918"></a><span id="l17.1918">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::AdditionalEmail);</span>
<a href="#l17.1919"></a><span id="l17.1919" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1920"></a><span id="l17.1920" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1921"></a><span id="l17.1921"> </span>
<a href="#l17.1922"></a><span id="l17.1922">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::ScreenName);</span>
<a href="#l17.1923"></a><span id="l17.1923" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1924"></a><span id="l17.1924" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1925"></a><span id="l17.1925"> </span>
<a href="#l17.1926"></a><span id="l17.1926">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Street);</span>
<a href="#l17.1927"></a><span id="l17.1927" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1928"></a><span id="l17.1928" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1929"></a><span id="l17.1929"> </span>
<a href="#l17.1930"></a><span id="l17.1930">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::City);</span>
<a href="#l17.1931"></a><span id="l17.1931" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1932"></a><span id="l17.1932" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1933"></a><span id="l17.1933"> </span>
<a href="#l17.1934"></a><span id="l17.1934">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Title);</span>
<a href="#l17.1935"></a><span id="l17.1935" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1936"></a><span id="l17.1936" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1937"></a><span id="l17.1937"> </span>
<a href="#l17.1938"></a><span id="l17.1938">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Organization);</span>
<a href="#l17.1939"></a><span id="l17.1939" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1940"></a><span id="l17.1940" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1941"></a><span id="l17.1941"> </span>
<a href="#l17.1942"></a><span id="l17.1942">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Department);</span>
<a href="#l17.1943"></a><span id="l17.1943" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1944"></a><span id="l17.1944" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1945"></a><span id="l17.1945"> </span>
<a href="#l17.1946"></a><span id="l17.1946">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Nickname);</span>
<a href="#l17.1947"></a><span id="l17.1947" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1948"></a><span id="l17.1948" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1949"></a><span id="l17.1949"> </span>
<a href="#l17.1950"></a><span id="l17.1950">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::WorkPhone);</span>
<a href="#l17.1951"></a><span id="l17.1951" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1952"></a><span id="l17.1952" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1953"></a><span id="l17.1953"> </span>
<a href="#l17.1954"></a><span id="l17.1954">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::HomePhone);</span>
<a href="#l17.1955"></a><span id="l17.1955" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1956"></a><span id="l17.1956" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1957"></a><span id="l17.1957"> </span>
<a href="#l17.1958"></a><span id="l17.1958">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Fax);</span>
<a href="#l17.1959"></a><span id="l17.1959" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1960"></a><span id="l17.1960" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1961"></a><span id="l17.1961"> </span>
<a href="#l17.1962"></a><span id="l17.1962">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Pager);</span>
<a href="#l17.1963"></a><span id="l17.1963" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1964"></a><span id="l17.1964" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1965"></a><span id="l17.1965"> </span>
<a href="#l17.1966"></a><span id="l17.1966">   rv = EnableDirectoryAttribute(aTable, nsMsgSearchAttrib::Mobile);</span>
<a href="#l17.1967"></a><span id="l17.1967" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1968"></a><span id="l17.1968" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1969"></a><span id="l17.1969"> </span>
<a href="#l17.1970"></a><span id="l17.1970">   return rv;</span>
<a href="#l17.1971"></a><span id="l17.1971"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchImap.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchImap.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,37 +1,31 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> #ifndef _nsMsgSearchImap_h__</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-#include &quot;nsMsgSearchAdapter.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#  include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+#  include &quot;nsMsgSearchAdapter.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> //-----------------------------------------------------------------------------</span>
<a href="#l18.16"></a><span id="l18.16"> //---------- Adapter class for searching online (IMAP) folders ----------------</span>
<a href="#l18.17"></a><span id="l18.17"> //-----------------------------------------------------------------------------</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-class nsMsgSearchOnlineMail : public nsMsgSearchAdapter</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-{</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-public:</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-  nsMsgSearchOnlineMail (nsMsgSearchScopeTerm *scope, nsIArray *termList);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-  virtual ~nsMsgSearchOnlineMail ();</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+class nsMsgSearchOnlineMail : public nsMsgSearchAdapter {</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ public:</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+  nsMsgSearchOnlineMail(nsMsgSearchScopeTerm *scope, nsIArray *termList);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  virtual ~nsMsgSearchOnlineMail();</span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-  NS_IMETHOD ValidateTerms () override;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  NS_IMETHOD Search (bool *aDone) override;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  NS_IMETHOD GetEncoding (char **result) override;</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  NS_IMETHOD AddResultElement (nsIMsgDBHdr *) override;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  NS_IMETHOD ValidateTerms() override;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  NS_IMETHOD Search(bool *aDone) override;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+  NS_IMETHOD GetEncoding(char **result) override;</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+  NS_IMETHOD AddResultElement(nsIMsgDBHdr *) override;</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  static nsresult Encode (nsCString&amp; ppEncoding,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-                            nsIArray *searchTerms,</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-                            const char16_t *destCharset);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  static nsresult Encode(nsCString &amp;ppEncoding, nsIArray *searchTerms,</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+                         const char16_t *destCharset);</span>
<a href="#l18.43"></a><span id="l18.43"> </span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-protected:</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+ protected:</span>
<a href="#l18.47"></a><span id="l18.47">   nsCString m_encoding;</span>
<a href="#l18.48"></a><span id="l18.48"> };</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-</span>
<a href="#l18.52"></a><span id="l18.52"> #endif</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchNews.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchNews.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -15,280 +15,244 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsMemory.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &lt;ctype.h&gt;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsIArray.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> // Implementation of search for IMAP mail folders</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-</span>
<a href="#l19.13"></a><span id="l19.13"> // Implementation of search for newsgroups</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-</span>
<a href="#l19.16"></a><span id="l19.16"> //-----------------------------------------------------------------------------</span>
<a href="#l19.17"></a><span id="l19.17"> //----------- Adapter class for searching XPAT-capable news servers -----------</span>
<a href="#l19.18"></a><span id="l19.18"> //-----------------------------------------------------------------------------</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-</span>
<a href="#l19.21"></a><span id="l19.21"> const char *nsMsgSearchNews::m_kNntpFrom = &quot;FROM &quot;;</span>
<a href="#l19.22"></a><span id="l19.22"> const char *nsMsgSearchNews::m_kNntpSubject = &quot;SUBJECT &quot;;</span>
<a href="#l19.23"></a><span id="l19.23"> const char *nsMsgSearchNews::m_kTermSeparator = &quot;/&quot;;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-nsMsgSearchNews::nsMsgSearchNews (nsMsgSearchScopeTerm *scope, nsIArray *termList) : nsMsgSearchAdapter (scope, termList)</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-{</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+nsMsgSearchNews::nsMsgSearchNews(nsMsgSearchScopeTerm *scope,</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+                                 nsIArray *termList)</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+    : nsMsgSearchAdapter(scope, termList) {</span>
<a href="#l19.31"></a><span id="l19.31">   m_searchType = ST_UNINITIALIZED;</span>
<a href="#l19.32"></a><span id="l19.32"> }</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-nsMsgSearchNews::~nsMsgSearchNews ()</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-{</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-}</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+nsMsgSearchNews::~nsMsgSearchNews() {}</span>
<a href="#l19.40"></a><span id="l19.40"> </span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-nsresult nsMsgSearchNews::ValidateTerms ()</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-{</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-  nsresult err = nsMsgSearchAdapter::ValidateTerms ();</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  if (NS_OK == err)</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  {</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-    err = Encode (&amp;m_encoding);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+nsresult nsMsgSearchNews::ValidateTerms() {</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+  nsresult err = nsMsgSearchAdapter::ValidateTerms();</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+  if (NS_OK == err) {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+    err = Encode(&amp;m_encoding);</span>
<a href="#l19.51"></a><span id="l19.51">   }</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">   return err;</span>
<a href="#l19.54"></a><span id="l19.54"> }</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-nsresult nsMsgSearchNews::Search (bool *aDone)</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-{</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+nsresult nsMsgSearchNews::Search(bool *aDone) {</span>
<a href="#l19.60"></a><span id="l19.60">   // the state machine runs in the news: handler</span>
<a href="#l19.61"></a><span id="l19.61">   nsresult err = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.62"></a><span id="l19.62">   return err;</span>
<a href="#l19.63"></a><span id="l19.63"> }</span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-char16_t *nsMsgSearchNews::EncodeToWildmat (const char16_t *value)</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-{</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+char16_t *nsMsgSearchNews::EncodeToWildmat(const char16_t *value) {</span>
<a href="#l19.68"></a><span id="l19.68">   // Here we take advantage of XPAT's use of the wildmat format, which allows</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-  // a case-insensitive match by specifying each case possibility for each character</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  // So, &quot;FooBar&quot; is encoded as &quot;[Ff][Oo][Bb][Aa][Rr]&quot;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+  // a case-insensitive match by specifying each case possibility for each</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  // character So, &quot;FooBar&quot; is encoded as &quot;[Ff][Oo][Bb][Aa][Rr]&quot;</span>
<a href="#l19.73"></a><span id="l19.73"> </span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-  char16_t *caseInsensitiveValue = (char16_t*) moz_xmalloc(sizeof(char16_t) * ((4 * NS_strlen(value)) + 1));</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-  if (caseInsensitiveValue)</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-  {</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+  char16_t *caseInsensitiveValue =</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+      (char16_t *)moz_xmalloc(sizeof(char16_t) * ((4 * NS_strlen(value)) + 1));</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+  if (caseInsensitiveValue) {</span>
<a href="#l19.80"></a><span id="l19.80">     char16_t *walkValue = caseInsensitiveValue;</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-    while (*value)</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-    {</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-      if (isalpha(*value))</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-      {</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+    while (*value) {</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+      if (isalpha(*value)) {</span>
<a href="#l19.87"></a><span id="l19.87">         *walkValue++ = (char16_t)'[';</span>
<a href="#l19.88"></a><span id="l19.88">         *walkValue++ = ToUpperCase((char16_t)*value);</span>
<a href="#l19.89"></a><span id="l19.89">         *walkValue++ = ToLowerCase((char16_t)*value);</span>
<a href="#l19.90"></a><span id="l19.90">         *walkValue++ = (char16_t)']';</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-      }</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-      else</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+      } else</span>
<a href="#l19.94"></a><span id="l19.94">         *walkValue++ = *value;</span>
<a href="#l19.95"></a><span id="l19.95">       value++;</span>
<a href="#l19.96"></a><span id="l19.96">     }</span>
<a href="#l19.97"></a><span id="l19.97">     *walkValue = 0;</span>
<a href="#l19.98"></a><span id="l19.98">   }</span>
<a href="#l19.99"></a><span id="l19.99">   return caseInsensitiveValue;</span>
<a href="#l19.100"></a><span id="l19.100"> }</span>
<a href="#l19.101"></a><span id="l19.101"> </span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-char *nsMsgSearchNews::EncodeTerm (nsIMsgSearchTerm *term)</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-{</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+char *nsMsgSearchNews::EncodeTerm(nsIMsgSearchTerm *term) {</span>
<a href="#l19.106"></a><span id="l19.106">   // Develop an XPAT-style encoding for the search term</span>
<a href="#l19.107"></a><span id="l19.107"> </span>
<a href="#l19.108"></a><span id="l19.108">   NS_ASSERTION(term, &quot;null term&quot;);</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-  if (!term)</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-    return nullptr;</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+  if (!term) return nullptr;</span>
<a href="#l19.112"></a><span id="l19.112"> </span>
<a href="#l19.113"></a><span id="l19.113">   // Find a string to represent the attribute</span>
<a href="#l19.114"></a><span id="l19.114">   const char *attribEncoding = nullptr;</span>
<a href="#l19.115"></a><span id="l19.115">   nsMsgSearchAttribValue attrib;</span>
<a href="#l19.116"></a><span id="l19.116"> </span>
<a href="#l19.117"></a><span id="l19.117">   term-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l19.118"></a><span id="l19.118"> </span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-  switch (attrib)</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-  {</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-  case nsMsgSearchAttrib::Sender:</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-    attribEncoding = m_kNntpFrom;</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-    break;</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-  case nsMsgSearchAttrib::Subject:</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-    attribEncoding = m_kNntpSubject;</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-    break;</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-  default:</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-    nsCString header;</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-    term-&gt;GetArbitraryHeader(header);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-    if (header.IsEmpty())</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-    {</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-      NS_ASSERTION(false,&quot;malformed search&quot;); // malformed search term?</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-      return nullptr;</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-    }</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-    attribEncoding = header.get();</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+  switch (attrib) {</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+    case nsMsgSearchAttrib::Sender:</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+      attribEncoding = m_kNntpFrom;</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+      break;</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+    case nsMsgSearchAttrib::Subject:</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+      attribEncoding = m_kNntpSubject;</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+      break;</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+    default:</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+      nsCString header;</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+      term-&gt;GetArbitraryHeader(header);</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+      if (header.IsEmpty()) {</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+        NS_ASSERTION(false, &quot;malformed search&quot;);  // malformed search term?</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+        return nullptr;</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+      }</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+      attribEncoding = header.get();</span>
<a href="#l19.151"></a><span id="l19.151">   }</span>
<a href="#l19.152"></a><span id="l19.152"> </span>
<a href="#l19.153"></a><span id="l19.153">   // Build a string to represent the string pattern</span>
<a href="#l19.154"></a><span id="l19.154">   bool leadingStar = false;</span>
<a href="#l19.155"></a><span id="l19.155">   bool trailingStar = false;</span>
<a href="#l19.156"></a><span id="l19.156">   nsMsgSearchOpValue op;</span>
<a href="#l19.157"></a><span id="l19.157">   term-&gt;GetOp(&amp;op);</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-  switch (op)</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-  {</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-  case nsMsgSearchOp::Contains:</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-    leadingStar = true;</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-    trailingStar = true;</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-    break;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-    break;</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-  case nsMsgSearchOp::BeginsWith:</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-    trailingStar = true;</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-    break;</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  case nsMsgSearchOp::EndsWith:</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-    leadingStar = true;</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-    break;</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  default:</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-    NS_ASSERTION(false,&quot;malformed search&quot;); // malformed search term?</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-    return nullptr;</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+  switch (op) {</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+    case nsMsgSearchOp::Contains:</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+      leadingStar = true;</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+      trailingStar = true;</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+      break;</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+      break;</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+    case nsMsgSearchOp::BeginsWith:</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+      trailingStar = true;</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+      break;</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+    case nsMsgSearchOp::EndsWith:</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+      leadingStar = true;</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+      break;</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+    default:</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineplus">+      NS_ASSERTION(false, &quot;malformed search&quot;);  // malformed search term?</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineplus">+      return nullptr;</span>
<a href="#l19.192"></a><span id="l19.192">   }</span>
<a href="#l19.193"></a><span id="l19.193"> </span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-    // ### i18N problem Get the csid from FE, which is the correct csid for term</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-//  int16 wincsid = INTL_GetCharSetID(INTL_DefaultTextWidgetCsidSel);</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineplus">+  // ### i18N problem Get the csid from FE, which is the correct csid for term</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+  //  int16 wincsid = INTL_GetCharSetID(INTL_DefaultTextWidgetCsidSel);</span>
<a href="#l19.198"></a><span id="l19.198"> </span>
<a href="#l19.199"></a><span id="l19.199">   // Do INTL_FormatNNTPXPATInRFC1522Format trick for non-ASCII string</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-//  unsigned char *intlNonRFC1522Value = INTL_FormatNNTPXPATInNonRFC1522Format (wincsid, (unsigned char*)term-&gt;m_value.u.string);</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+  //  unsigned char *intlNonRFC1522Value = INTL_FormatNNTPXPATInNonRFC1522Format</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+  //  (wincsid, (unsigned char*)term-&gt;m_value.u.string);</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l19.205"></a><span id="l19.205"> </span>
<a href="#l19.206"></a><span id="l19.206">   nsresult rv = term-&gt;GetValue(getter_AddRefs(searchValue));</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-  if (NS_FAILED(rv) || !searchValue)</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-    return nullptr;</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+  if (NS_FAILED(rv) || !searchValue) return nullptr;</span>
<a href="#l19.211"></a><span id="l19.211"> </span>
<a href="#l19.212"></a><span id="l19.212">   nsString intlNonRFC1522Value;</span>
<a href="#l19.213"></a><span id="l19.213">   rv = searchValue-&gt;GetStr(intlNonRFC1522Value);</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-  if (NS_FAILED(rv) || intlNonRFC1522Value.IsEmpty())</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-    return nullptr;</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+  if (NS_FAILED(rv) || intlNonRFC1522Value.IsEmpty()) return nullptr;</span>
<a href="#l19.217"></a><span id="l19.217"> </span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-  char16_t *caseInsensitiveValue = EncodeToWildmat (intlNonRFC1522Value.get());</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-  if (!caseInsensitiveValue)</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-    return nullptr;</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+  char16_t *caseInsensitiveValue = EncodeToWildmat(intlNonRFC1522Value.get());</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineplus">+  if (!caseInsensitiveValue) return nullptr;</span>
<a href="#l19.223"></a><span id="l19.223"> </span>
<a href="#l19.224"></a><span id="l19.224">   // TO DO: Do INTL_FormatNNTPXPATInRFC1522Format trick for non-ASCII string</span>
<a href="#l19.225"></a><span id="l19.225">   // Unfortunately, we currently do not handle xxx or xxx search in XPAT</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-  // Need to add the INTL_FormatNNTPXPATInRFC1522Format call after we can do that</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-  // so we should search a string in either RFC1522 format and non-RFC1522 format</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+  // Need to add the INTL_FormatNNTPXPATInRFC1522Format call after we can do</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+  // that so we should search a string in either RFC1522 format and non-RFC1522</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+  // format</span>
<a href="#l19.231"></a><span id="l19.231"> </span>
<a href="#l19.232"></a><span id="l19.232" class="difflineminus">-  char16_t *escapedValue = EscapeSearchUrl (caseInsensitiveValue);</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineplus">+  char16_t *escapedValue = EscapeSearchUrl(caseInsensitiveValue);</span>
<a href="#l19.234"></a><span id="l19.234">   free(caseInsensitiveValue);</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineminus">-  if (!escapedValue)</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-    return nullptr;</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineplus">+  if (!escapedValue) return nullptr;</span>
<a href="#l19.238"></a><span id="l19.238"> </span>
<a href="#l19.239"></a><span id="l19.239">   nsAutoCString pattern;</span>
<a href="#l19.240"></a><span id="l19.240"> </span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-  if (leadingStar)</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-      pattern.Append('*');</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-    pattern.Append(NS_ConvertUTF16toUTF8(escapedValue));</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-  if (trailingStar)</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-      pattern.Append('*');</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineplus">+  if (leadingStar) pattern.Append('*');</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineplus">+  pattern.Append(NS_ConvertUTF16toUTF8(escapedValue));</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+  if (trailingStar) pattern.Append('*');</span>
<a href="#l19.249"></a><span id="l19.249"> </span>
<a href="#l19.250"></a><span id="l19.250">   // Combine the XPAT command syntax with the attribute and the pattern to</span>
<a href="#l19.251"></a><span id="l19.251">   // form the term encoding</span>
<a href="#l19.252"></a><span id="l19.252">   const char xpatTemplate[] = &quot;XPAT %s 1- %s&quot;;</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-  int termLength = (sizeof(xpatTemplate) - 1) + strlen(attribEncoding) + pattern.Length() + 1;</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-  char *termEncoding = new char [termLength];</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+  int termLength = (sizeof(xpatTemplate) - 1) + strlen(attribEncoding) +</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+                   pattern.Length() + 1;</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+  char *termEncoding = new char[termLength];</span>
<a href="#l19.258"></a><span id="l19.258">   if (termEncoding)</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineminus">-    PR_snprintf (termEncoding, termLength, xpatTemplate, attribEncoding, pattern.get());</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+    PR_snprintf(termEncoding, termLength, xpatTemplate, attribEncoding,</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineplus">+                pattern.get());</span>
<a href="#l19.262"></a><span id="l19.262"> </span>
<a href="#l19.263"></a><span id="l19.263">   return termEncoding;</span>
<a href="#l19.264"></a><span id="l19.264"> }</span>
<a href="#l19.265"></a><span id="l19.265"> </span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-nsresult nsMsgSearchNews::GetEncoding(char **result)</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-{</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineplus">+nsresult nsMsgSearchNews::GetEncoding(char **result) {</span>
<a href="#l19.269"></a><span id="l19.269">   NS_ENSURE_ARG(result);</span>
<a href="#l19.270"></a><span id="l19.270">   *result = ToNewCString(m_encoding);</span>
<a href="#l19.271"></a><span id="l19.271">   return (*result) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.272"></a><span id="l19.272"> }</span>
<a href="#l19.273"></a><span id="l19.273"> </span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-nsresult nsMsgSearchNews::Encode (nsCString *outEncoding)</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">-{</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineplus">+nsresult nsMsgSearchNews::Encode(nsCString *outEncoding) {</span>
<a href="#l19.277"></a><span id="l19.277">   NS_ASSERTION(outEncoding, &quot;no out encoding&quot;);</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">-  if (!outEncoding)</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineplus">+  if (!outEncoding) return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.281"></a><span id="l19.281"> </span>
<a href="#l19.282"></a><span id="l19.282">   nsresult err = NS_OK;</span>
<a href="#l19.283"></a><span id="l19.283"> </span>
<a href="#l19.284"></a><span id="l19.284">   uint32_t numTerms;</span>
<a href="#l19.285"></a><span id="l19.285"> </span>
<a href="#l19.286"></a><span id="l19.286">   m_searchTerms-&gt;GetLength(&amp;numTerms);</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-  char **intermediateEncodings = new char * [numTerms];</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-  if (intermediateEncodings)</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-  {</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineplus">+  char **intermediateEncodings = new char *[numTerms];</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineplus">+  if (intermediateEncodings) {</span>
<a href="#l19.292"></a><span id="l19.292">     // Build an XPAT command for each term</span>
<a href="#l19.293"></a><span id="l19.293">     int encodingLength = 0;</span>
<a href="#l19.294"></a><span id="l19.294">     uint32_t i;</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-    for (i = 0; i &lt; numTerms; i++)</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-    {</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineplus">+    for (i = 0; i &lt; numTerms; i++) {</span>
<a href="#l19.298"></a><span id="l19.298">       nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm = do_QueryElementAt(m_searchTerms, i);</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-      // set boolean OR term if any of the search terms are an OR...this only works if we are using</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-      // homogeneous boolean operators.</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineplus">+      // set boolean OR term if any of the search terms are an OR...this only</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+      // works if we are using homogeneous boolean operators.</span>
<a href="#l19.303"></a><span id="l19.303">       bool isBooleanOpAnd;</span>
<a href="#l19.304"></a><span id="l19.304">       pTerm-&gt;GetBooleanAnd(&amp;isBooleanOpAnd);</span>
<a href="#l19.305"></a><span id="l19.305">       m_searchType = isBooleanOpAnd ? ST_AND_SEARCH : ST_OR_SEARCH;</span>
<a href="#l19.306"></a><span id="l19.306"> </span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-      intermediateEncodings[i] = EncodeTerm (pTerm);</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineplus">+      intermediateEncodings[i] = EncodeTerm(pTerm);</span>
<a href="#l19.309"></a><span id="l19.309">       if (intermediateEncodings[i])</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-        encodingLength += strlen(intermediateEncodings[i]) + strlen(m_kTermSeparator);</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineplus">+        encodingLength +=</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+            strlen(intermediateEncodings[i]) + strlen(m_kTermSeparator);</span>
<a href="#l19.313"></a><span id="l19.313">     }</span>
<a href="#l19.314"></a><span id="l19.314">     encodingLength += strlen(&quot;?search&quot;);</span>
<a href="#l19.315"></a><span id="l19.315">     // Combine all the term encodings into one big encoding</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-    char *encoding = new char [encodingLength + 1];</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-    if (encoding)</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-    {</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-      PL_strcpy (encoding, &quot;?search&quot;);</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+    char *encoding = new char[encodingLength + 1];</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineplus">+    if (encoding) {</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineplus">+      PL_strcpy(encoding, &quot;?search&quot;);</span>
<a href="#l19.323"></a><span id="l19.323"> </span>
<a href="#l19.324"></a><span id="l19.324">       m_searchTerms-&gt;GetLength(&amp;numTerms);</span>
<a href="#l19.325"></a><span id="l19.325"> </span>
<a href="#l19.326"></a><span id="l19.326" class="difflineminus">-      for (i = 0; i &lt; numTerms; i++)</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-      {</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-        if (intermediateEncodings[i])</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-        {</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineminus">-          PL_strcat (encoding, m_kTermSeparator);</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-          PL_strcat (encoding, intermediateEncodings[i]);</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-          delete [] intermediateEncodings[i];</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineplus">+      for (i = 0; i &lt; numTerms; i++) {</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineplus">+        if (intermediateEncodings[i]) {</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineplus">+          PL_strcat(encoding, m_kTermSeparator);</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineplus">+          PL_strcat(encoding, intermediateEncodings[i]);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+          delete[] intermediateEncodings[i];</span>
<a href="#l19.338"></a><span id="l19.338">         }</span>
<a href="#l19.339"></a><span id="l19.339">       }</span>
<a href="#l19.340"></a><span id="l19.340">       *outEncoding = encoding;</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineminus">-    }</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineminus">-    else</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineplus">+    } else</span>
<a href="#l19.344"></a><span id="l19.344">       err = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineminus">-  }</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineminus">-  else</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+  } else</span>
<a href="#l19.348"></a><span id="l19.348">     err = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineminus">-  delete [] intermediateEncodings;</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineplus">+  delete[] intermediateEncodings;</span>
<a href="#l19.351"></a><span id="l19.351"> </span>
<a href="#l19.352"></a><span id="l19.352">   return err;</span>
<a href="#l19.353"></a><span id="l19.353"> }</span>
<a href="#l19.354"></a><span id="l19.354"> </span>
<a href="#l19.355"></a><span id="l19.355" class="difflineminus">-NS_IMETHODIMP nsMsgSearchNews::AddHit(nsMsgKey key)</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-{</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+NS_IMETHODIMP nsMsgSearchNews::AddHit(nsMsgKey key) {</span>
<a href="#l19.358"></a><span id="l19.358">   m_candidateHits.AppendElement(key);</span>
<a href="#l19.359"></a><span id="l19.359">   return NS_OK;</span>
<a href="#l19.360"></a><span id="l19.360"> }</span>
<a href="#l19.361"></a><span id="l19.361"> </span>
<a href="#l19.362"></a><span id="l19.362"> /* void CurrentUrlDone (in nsresult exitCode); */</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineminus">-NS_IMETHODIMP nsMsgSearchNews::CurrentUrlDone(nsresult exitCode)</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineminus">-{</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineplus">+NS_IMETHODIMP nsMsgSearchNews::CurrentUrlDone(nsresult exitCode) {</span>
<a href="#l19.366"></a><span id="l19.366">   CollateHits();</span>
<a href="#l19.367"></a><span id="l19.367">   ReportHits();</span>
<a href="#l19.368"></a><span id="l19.368">   return NS_OK;</span>
<a href="#l19.369"></a><span id="l19.369"> }</span>
<a href="#l19.370"></a><span id="l19.370"> </span>
<a href="#l19.371"></a><span id="l19.371" class="difflineminus">-</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineminus">-#if 0 // need to switch this to a notify stop loading handler, I think.</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineplus">+#if 0   // need to switch this to a notify stop loading handler, I think.</span>
<a href="#l19.374"></a><span id="l19.374"> void nsMsgSearchNews::PreExitFunction (URL_Struct * /*url*/, int status, MWContext *context)</span>
<a href="#l19.375"></a><span id="l19.375"> {</span>
<a href="#l19.376"></a><span id="l19.376">   MSG_SearchFrame *frame = MSG_SearchFrame::FromContext (context);</span>
<a href="#l19.377"></a><span id="l19.377">   nsMsgSearchNews *adapter = (nsMsgSearchNews*) frame-&gt;GetRunningAdapter();</span>
<a href="#l19.378"></a><span id="l19.378">   adapter-&gt;CollateHits();</span>
<a href="#l19.379"></a><span id="l19.379">   adapter-&gt;ReportHits();</span>
<a href="#l19.380"></a><span id="l19.380"> </span>
<a href="#l19.381"></a><span id="l19.381">   if (status == MK_INTERRUPTED)</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineat">@@ -298,208 +262,196 @@ void nsMsgSearchNews::PreExitFunction (U</span>
<a href="#l19.383"></a><span id="l19.383">   }</span>
<a href="#l19.384"></a><span id="l19.384">   else</span>
<a href="#l19.385"></a><span id="l19.385">   {</span>
<a href="#l19.386"></a><span id="l19.386">     frame-&gt;m_idxRunningScope++;</span>
<a href="#l19.387"></a><span id="l19.387">     if (frame-&gt;m_idxRunningScope &gt;= frame-&gt;m_scopeList.Count())</span>
<a href="#l19.388"></a><span id="l19.388">       frame-&gt;EndCylonMode();</span>
<a href="#l19.389"></a><span id="l19.389">   }</span>
<a href="#l19.390"></a><span id="l19.390"> }</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineminus">-#endif // 0</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+#endif  // 0</span>
<a href="#l19.393"></a><span id="l19.393"> </span>
<a href="#l19.394"></a><span id="l19.394" class="difflineminus">-void nsMsgSearchNews::CollateHits()</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineminus">-{</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineplus">+void nsMsgSearchNews::CollateHits() {</span>
<a href="#l19.397"></a><span id="l19.397">   // Since the XPAT commands are processed one at a time, the result set for the</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineminus">-  // entire query is the intersection of results for each XPAT command if an AND search,</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-  // otherwise we want the union of all the search hits (minus the duplicates of course).</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineplus">+  // entire query is the intersection of results for each XPAT command if an AND</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineplus">+  // search, otherwise we want the union of all the search hits (minus the</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineplus">+  // duplicates of course).</span>
<a href="#l19.403"></a><span id="l19.403"> </span>
<a href="#l19.404"></a><span id="l19.404">   uint32_t size = m_candidateHits.Length();</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-  if (!size)</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-    return;</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+  if (!size) return;</span>
<a href="#l19.408"></a><span id="l19.408"> </span>
<a href="#l19.409"></a><span id="l19.409">   // Sort the article numbers first, so it's easy to tell how many hits</span>
<a href="#l19.410"></a><span id="l19.410">   // on a given article we got</span>
<a href="#l19.411"></a><span id="l19.411">   m_candidateHits.Sort();</span>
<a href="#l19.412"></a><span id="l19.412"> </span>
<a href="#l19.413"></a><span id="l19.413">   // For an OR search we only need to count the first occurrence of a candidate.</span>
<a href="#l19.414"></a><span id="l19.414">   uint32_t termCount = 1;</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-  MOZ_ASSERT(m_searchType != ST_UNINITIALIZED, &quot;m_searchType accessed without being set&quot;);</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-  if (m_searchType == ST_AND_SEARCH)</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineminus">-  {</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineplus">+  MOZ_ASSERT(m_searchType != ST_UNINITIALIZED,</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+             &quot;m_searchType accessed without being set&quot;);</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineplus">+  if (m_searchType == ST_AND_SEARCH) {</span>
<a href="#l19.421"></a><span id="l19.421">     // We have a traditional AND search which must be collated. In order to</span>
<a href="#l19.422"></a><span id="l19.422">     // get promoted into the hits list, a candidate article number must appear</span>
<a href="#l19.423"></a><span id="l19.423">     // in the results of each XPAT command. So if we fire 3 XPAT commands (one</span>
<a href="#l19.424"></a><span id="l19.424">     // per search term), the article number must appear 3 times. If it appears</span>
<a href="#l19.425"></a><span id="l19.425">     // fewer than 3 times, it matched some search terms, but not all.</span>
<a href="#l19.426"></a><span id="l19.426">     m_searchTerms-&gt;GetLength(&amp;termCount);</span>
<a href="#l19.427"></a><span id="l19.427">   }</span>
<a href="#l19.428"></a><span id="l19.428">   uint32_t candidateCount = 0;</span>
<a href="#l19.429"></a><span id="l19.429">   uint32_t candidate = m_candidateHits[0];</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-  for (uint32_t index = 0; index &lt; size; ++index)</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-  {</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineplus">+  for (uint32_t index = 0; index &lt; size; ++index) {</span>
<a href="#l19.433"></a><span id="l19.433">     uint32_t possibleCandidate = m_candidateHits[index];</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-    if (candidate == possibleCandidate)</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineminus">-    {</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineplus">+    if (candidate == possibleCandidate) {</span>
<a href="#l19.437"></a><span id="l19.437">       ++candidateCount;</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineminus">-    }</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineminus">-    else</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineminus">-    {</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineplus">+    } else {</span>
<a href="#l19.442"></a><span id="l19.442">       candidateCount = 1;</span>
<a href="#l19.443"></a><span id="l19.443">       candidate = possibleCandidate;</span>
<a href="#l19.444"></a><span id="l19.444">     }</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineminus">-    if (candidateCount == termCount)</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineminus">-      m_hits.AppendElement(candidate);</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+    if (candidateCount == termCount) m_hits.AppendElement(candidate);</span>
<a href="#l19.448"></a><span id="l19.448">   }</span>
<a href="#l19.449"></a><span id="l19.449"> }</span>
<a href="#l19.450"></a><span id="l19.450"> </span>
<a href="#l19.451"></a><span id="l19.451" class="difflineminus">-void nsMsgSearchNews::ReportHits ()</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineminus">-{</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt;  folderInfo;</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineplus">+void nsMsgSearchNews::ReportHits() {</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l19.460"></a><span id="l19.460"> </span>
<a href="#l19.461"></a><span id="l19.461">   nsresult err = m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; scopeFolder)</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineminus">-  {</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineminus">-    err = scopeFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; scopeFolder) {</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+    err = scopeFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineplus">+                                            getter_AddRefs(db));</span>
<a href="#l19.468"></a><span id="l19.468">   }</span>
<a href="#l19.469"></a><span id="l19.469"> </span>
<a href="#l19.470"></a><span id="l19.470" class="difflineminus">-  if (db)</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineminus">-  {</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineplus">+  if (db) {</span>
<a href="#l19.473"></a><span id="l19.473">     uint32_t size = m_hits.Length();</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineminus">-    for (uint32_t i = 0; i &lt; size; ++i)</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineminus">-    {</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineplus">+    for (uint32_t i = 0; i &lt; size; ++i) {</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l19.479"></a><span id="l19.479"> </span>
<a href="#l19.480"></a><span id="l19.480">       db-&gt;GetMsgHdrForKey(m_hits.ElementAt(i), getter_AddRefs(header));</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineminus">-      if (header)</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineminus">-        ReportHit(header, scopeFolder);</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineplus">+      if (header) ReportHit(header, scopeFolder);</span>
<a href="#l19.484"></a><span id="l19.484">     }</span>
<a href="#l19.485"></a><span id="l19.485">   }</span>
<a href="#l19.486"></a><span id="l19.486"> }</span>
<a href="#l19.487"></a><span id="l19.487"> </span>
<a href="#l19.488"></a><span id="l19.488"> // ### this should take an nsIMsgFolder instead of a string location.</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineminus">-void nsMsgSearchNews::ReportHit (nsIMsgDBHdr *pHeaders, nsIMsgFolder *folder)</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineminus">-{</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineminus">-    // this is totally filched from msg_SearchOfflineMail until I decide whether the</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineminus">-    // right thing is to get them from the db or from NNTP</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchSession&gt; session;</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineminus">-    m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineminus">-    m_scope-&gt;GetSearchSession(getter_AddRefs(session));</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineminus">-    if (session)</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineminus">-      session-&gt;AddSearchHit (pHeaders, scopeFolder);</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineplus">+void nsMsgSearchNews::ReportHit(nsIMsgDBHdr *pHeaders, nsIMsgFolder *folder) {</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineplus">+  // this is totally filched from msg_SearchOfflineMail until I decide whether</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineplus">+  // the right thing is to get them from the db or from NNTP</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; session;</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; scopeFolder;</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineplus">+  m_scope-&gt;GetFolder(getter_AddRefs(scopeFolder));</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineplus">+  m_scope-&gt;GetSearchSession(getter_AddRefs(session));</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineplus">+  if (session) session-&gt;AddSearchHit(pHeaders, scopeFolder);</span>
<a href="#l19.507"></a><span id="l19.507"> }</span>
<a href="#l19.508"></a><span id="l19.508"> </span>
<a href="#l19.509"></a><span id="l19.509" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitNewsTable()</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineminus">-{</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineminus">-  NS_ASSERTION (nullptr == m_newsTable,&quot;don't call this twice!&quot;);</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineminus">-  nsresult rv = NewTable (getter_AddRefs(m_newsTable));</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitNewsTable() {</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineplus">+  NS_ASSERTION(nullptr == m_newsTable, &quot;don't call this twice!&quot;);</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+  nsresult rv = NewTable(getter_AddRefs(m_newsTable));</span>
<a href="#l19.516"></a><span id="l19.516"> </span>
<a href="#l19.517"></a><span id="l19.517" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineminus">-  {</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.528"></a><span id="l19.528" class="difflineplus">+    // clang-format off</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.537"></a><span id="l19.537"> </span>
<a href="#l19.538"></a><span id="l19.538" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.554"></a><span id="l19.554"> </span>
<a href="#l19.555"></a><span id="l19.555"> #if 0</span>
<a href="#l19.556"></a><span id="l19.556">     // Size should be handled after the fact...</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.565"></a><span id="l19.565"> #endif</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineminus">-</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineminus">-    m_newsTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineminus">-    m_newsTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineplus">+    m_newsTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineplus">+    m_newsTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineplus">+    // clang-format on</span>
<a href="#l19.584"></a><span id="l19.584">   }</span>
<a href="#l19.585"></a><span id="l19.585"> </span>
<a href="#l19.586"></a><span id="l19.586">   return rv;</span>
<a href="#l19.587"></a><span id="l19.587"> }</span>
<a href="#l19.588"></a><span id="l19.588"> </span>
<a href="#l19.589"></a><span id="l19.589" class="difflineminus">-nsresult nsMsgSearchValidityManager::InitNewsFilterTable()</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineminus">-{</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineminus">-  NS_ASSERTION (nullptr == m_newsFilterTable, &quot;news filter table already initted&quot;);</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineminus">-  nsresult rv = NewTable (getter_AddRefs(m_newsFilterTable));</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineplus">+nsresult nsMsgSearchValidityManager::InitNewsFilterTable() {</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineplus">+  NS_ASSERTION(nullptr == m_newsFilterTable,</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineplus">+               &quot;news filter table already initted&quot;);</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineplus">+  nsresult rv = NewTable(getter_AddRefs(m_newsFilterTable));</span>
<a href="#l19.597"></a><span id="l19.597"> </span>
<a href="#l19.598"></a><span id="l19.598" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineminus">-  {</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+    // clang-format off</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.626"></a><span id="l19.626"> </span>
<a href="#l19.627"></a><span id="l19.627" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsInAB, 1);</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Sender, nsMsgSearchOp::IsntInAB, 1);</span>
<a href="#l19.635"></a><span id="l19.635"> </span>
<a href="#l19.636"></a><span id="l19.636" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.643"></a><span id="l19.643" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.654"></a><span id="l19.654" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.659"></a><span id="l19.659" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Subject, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.660"></a><span id="l19.660"> </span>
<a href="#l19.661"></a><span id="l19.661" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l19.662"></a><span id="l19.662" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l19.663"></a><span id="l19.663" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.667"></a><span id="l19.667" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsBefore, 1);</span>
<a href="#l19.671"></a><span id="l19.671" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l19.672"></a><span id="l19.672" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::IsAfter, 1);</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Date, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.682"></a><span id="l19.682"> </span>
<a href="#l19.683"></a><span id="l19.683" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsGreaterThan, 1);</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Size, nsMsgSearchOp::IsLessThan, 1);</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineminus">-</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.697"></a><span id="l19.697" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineminus">-    m_newsFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineminus">-    m_newsFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+    m_newsFilterTable-&gt;SetAvailable(nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+    m_newsFilterTable-&gt;SetEnabled  (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+    // clang-format on</span>
<a href="#l19.713"></a><span id="l19.713">   }</span>
<a href="#l19.714"></a><span id="l19.714"> </span>
<a href="#l19.715"></a><span id="l19.715">   return rv;</span>
<a href="#l19.716"></a><span id="l19.716"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchNews.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchNews.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,55 +1,53 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> #ifndef _nsMsgSearchNews_h__</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-#include &quot;nsMsgSearchAdapter.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-#include &quot;MailNewsTypes.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+#  include &quot;nsMsgSearchAdapter.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+#  include &quot;MailNewsTypes.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+#  include &quot;nsTArray.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> typedef enum search_type {</span>
<a href="#l20.18"></a><span id="l20.18">   ST_UNINITIALIZED,</span>
<a href="#l20.19"></a><span id="l20.19">   ST_OR_SEARCH,</span>
<a href="#l20.20"></a><span id="l20.20">   ST_AND_SEARCH</span>
<a href="#l20.21"></a><span id="l20.21"> } search_type;</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23"> //-----------------------------------------------------------------------------</span>
<a href="#l20.24"></a><span id="l20.24"> //---------- Adapter class for searching online (news) folders ----------------</span>
<a href="#l20.25"></a><span id="l20.25"> //-----------------------------------------------------------------------------</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-class nsMsgSearchNews : public nsMsgSearchAdapter</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-{</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-public:</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  nsMsgSearchNews (nsMsgSearchScopeTerm *scope, nsIArray *termList);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  virtual ~nsMsgSearchNews ();</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+class nsMsgSearchNews : public nsMsgSearchAdapter {</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+ public:</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+  nsMsgSearchNews(nsMsgSearchScopeTerm *scope, nsIArray *termList);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+  virtual ~nsMsgSearchNews();</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  NS_IMETHOD ValidateTerms () override;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  NS_IMETHOD Search (bool *aDone) override;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  NS_IMETHOD GetEncoding (char **result) override;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  NS_IMETHOD ValidateTerms() override;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  NS_IMETHOD Search(bool *aDone) override;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  NS_IMETHOD GetEncoding(char **result) override;</span>
<a href="#l20.43"></a><span id="l20.43">   NS_IMETHOD AddHit(nsMsgKey key) override;</span>
<a href="#l20.44"></a><span id="l20.44">   NS_IMETHOD CurrentUrlDone(nsresult exitCode) override;</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-  virtual nsresult Encode (nsCString *outEncoding);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-  virtual char *EncodeTerm (nsIMsgSearchTerm *);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-  char16_t *EncodeToWildmat (const char16_t *);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+  virtual nsresult Encode(nsCString *outEncoding);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+  virtual char *EncodeTerm(nsIMsgSearchTerm *);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+  char16_t *EncodeToWildmat(const char16_t *);</span>
<a href="#l20.52"></a><span id="l20.52"> </span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  void ReportHits ();</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  void CollateHits ();</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  void ReportHit (nsIMsgDBHdr *pHeaders, nsIMsgFolder *folder);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  void ReportHits();</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  void CollateHits();</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  void ReportHit(nsIMsgDBHdr *pHeaders, nsIMsgFolder *folder);</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-protected:</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+ protected:</span>
<a href="#l20.62"></a><span id="l20.62">   nsCString m_encoding;</span>
<a href="#l20.63"></a><span id="l20.63">   search_type m_searchType;</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65">   nsTArray&lt;nsMsgKey&gt; m_candidateHits;</span>
<a href="#l20.66"></a><span id="l20.66">   nsTArray&lt;nsMsgKey&gt; m_hits;</span>
<a href="#l20.67"></a><span id="l20.67"> </span>
<a href="#l20.68"></a><span id="l20.68">   static const char *m_kNntpFrom;</span>
<a href="#l20.69"></a><span id="l20.69">   static const char *m_kNntpSubject;</span>
<a href="#l20.70"></a><span id="l20.70">   static const char *m_kTermSeparator;</span>
<a href="#l20.71"></a><span id="l20.71">   static const char *m_kUrlPrefix;</span>
<a href="#l20.72"></a><span id="l20.72"> };</span>
<a href="#l20.73"></a><span id="l20.73"> </span>
<a href="#l20.74"></a><span id="l20.74"> #endif</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -19,641 +19,563 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsMsgLocalSearch.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> NS_IMPL_ISUPPORTS(nsMsgSearchSession, nsIMsgSearchSession, nsIUrlListener,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-                   nsISupportsWeakReference)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-nsMsgSearchSession::nsMsgSearchSession()</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-{</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+nsMsgSearchSession::nsMsgSearchSession() {</span>
<a href="#l21.18"></a><span id="l21.18">   m_sortAttribute = nsMsgSearchAttrib::Sender;</span>
<a href="#l21.19"></a><span id="l21.19">   m_idxRunningScope = 0;</span>
<a href="#l21.20"></a><span id="l21.20">   m_handlingError = false;</span>
<a href="#l21.21"></a><span id="l21.21">   m_expressionTree = nullptr;</span>
<a href="#l21.22"></a><span id="l21.22">   m_searchPaused = false;</span>
<a href="#l21.23"></a><span id="l21.23">   m_termList = nsArray::Create();</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-  NS_ASSERTION(m_termList, &quot;Failed to allocate a nsIMutableArray for m_termList&quot;);</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  NS_ASSERTION(m_termList,</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+               &quot;Failed to allocate a nsIMutableArray for m_termList&quot;);</span>
<a href="#l21.27"></a><span id="l21.27"> }</span>
<a href="#l21.28"></a><span id="l21.28"> </span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-nsMsgSearchSession::~nsMsgSearchSession()</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-{</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+nsMsgSearchSession::~nsMsgSearchSession() {</span>
<a href="#l21.32"></a><span id="l21.32">   InterruptSearch();</span>
<a href="#l21.33"></a><span id="l21.33">   delete m_expressionTree;</span>
<a href="#l21.34"></a><span id="l21.34">   DestroyScopeList();</span>
<a href="#l21.35"></a><span id="l21.35">   DestroyTermList();</span>
<a href="#l21.36"></a><span id="l21.36"> }</span>
<a href="#l21.37"></a><span id="l21.37"> </span>
<a href="#l21.38"></a><span id="l21.38"> NS_IMETHODIMP</span>
<a href="#l21.39"></a><span id="l21.39"> nsMsgSearchSession::AddSearchTerm(nsMsgSearchAttribValue attrib,</span>
<a href="#l21.40"></a><span id="l21.40">                                   nsMsgSearchOpValue op,</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-                                  nsIMsgSearchValue *value,</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-                                  bool BooleanANDp,</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-                                  const char *customString)</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-{</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+                                  nsIMsgSearchValue *value, bool BooleanANDp,</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+                                  const char *customString) {</span>
<a href="#l21.47"></a><span id="l21.47">   // stupid gcc</span>
<a href="#l21.48"></a><span id="l21.48">   nsMsgSearchBooleanOperator boolOp;</span>
<a href="#l21.49"></a><span id="l21.49">   if (BooleanANDp)</span>
<a href="#l21.50"></a><span id="l21.50">     boolOp = (nsMsgSearchBooleanOperator)nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l21.51"></a><span id="l21.51">   else</span>
<a href="#l21.52"></a><span id="l21.52">     boolOp = (nsMsgSearchBooleanOperator)nsMsgSearchBooleanOp::BooleanOR;</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-  nsMsgSearchTerm *pTerm = new nsMsgSearchTerm(attrib, op, value,</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-                                               boolOp, customString);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+  nsMsgSearchTerm *pTerm =</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+      new nsMsgSearchTerm(attrib, op, value, boolOp, customString);</span>
<a href="#l21.57"></a><span id="l21.57">   NS_ENSURE_TRUE(pTerm, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l21.58"></a><span id="l21.58"> </span>
<a href="#l21.59"></a><span id="l21.59">   m_termList-&gt;AppendElement(pTerm);</span>
<a href="#l21.60"></a><span id="l21.60">   // force the expression tree to rebuild whenever we change the terms</span>
<a href="#l21.61"></a><span id="l21.61">   delete m_expressionTree;</span>
<a href="#l21.62"></a><span id="l21.62">   m_expressionTree = nullptr;</span>
<a href="#l21.63"></a><span id="l21.63">   return NS_OK;</span>
<a href="#l21.64"></a><span id="l21.64"> }</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66"> NS_IMETHODIMP</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-nsMsgSearchSession::AppendTerm(nsIMsgSearchTerm *aTerm)</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-{</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aTerm);</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-    NS_ENSURE_TRUE(m_termList, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-    delete m_expressionTree;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-    m_expressionTree = nullptr;</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-    return m_termList-&gt;AppendElement(aTerm);</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+nsMsgSearchSession::AppendTerm(nsIMsgSearchTerm *aTerm) {</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTerm);</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+  NS_ENSURE_TRUE(m_termList, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+  delete m_expressionTree;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+  m_expressionTree = nullptr;</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+  return m_termList-&gt;AppendElement(aTerm);</span>
<a href="#l21.80"></a><span id="l21.80"> }</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82"> NS_IMETHODIMP</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-nsMsgSearchSession::GetSearchTerms(nsIMutableArray **aResult)</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-{</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-    NS_ADDREF(*aResult = m_termList);</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+nsMsgSearchSession::GetSearchTerms(nsIMutableArray **aResult) {</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+  NS_ADDREF(*aResult = m_termList);</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.92"></a><span id="l21.92"> }</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94"> NS_IMETHODIMP</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-nsMsgSearchSession::SetSearchTerms(nsIMutableArray *aSearchTerms)</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-{</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+nsMsgSearchSession::SetSearchTerms(nsIMutableArray *aSearchTerms) {</span>
<a href="#l21.98"></a><span id="l21.98">   m_termList = aSearchTerms;</span>
<a href="#l21.99"></a><span id="l21.99">   return NS_OK;</span>
<a href="#l21.100"></a><span id="l21.100"> }</span>
<a href="#l21.101"></a><span id="l21.101"> </span>
<a href="#l21.102"></a><span id="l21.102"> NS_IMETHODIMP</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-nsMsgSearchSession::CreateTerm(nsIMsgSearchTerm **aResult)</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-{</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+nsMsgSearchSession::CreateTerm(nsIMsgSearchTerm **aResult) {</span>
<a href="#l21.106"></a><span id="l21.106">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l21.107"></a><span id="l21.107">   NS_ADDREF(*aResult = new nsMsgSearchTerm);</span>
<a href="#l21.108"></a><span id="l21.108">   return NS_OK;</span>
<a href="#l21.109"></a><span id="l21.109"> }</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::RegisterListener(nsIMsgSearchNotify *aListener,</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-                                                   int32_t aNotifyFlags)</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-{</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::RegisterListener(</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+    nsIMsgSearchNotify *aListener, int32_t aNotifyFlags) {</span>
<a href="#l21.116"></a><span id="l21.116">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l21.117"></a><span id="l21.117">   m_listenerList.AppendElement(aListener);</span>
<a href="#l21.118"></a><span id="l21.118">   m_listenerFlagList.AppendElement(aNotifyFlags);</span>
<a href="#l21.119"></a><span id="l21.119">   return NS_OK;</span>
<a href="#l21.120"></a><span id="l21.120"> }</span>
<a href="#l21.121"></a><span id="l21.121"> </span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::UnregisterListener(nsIMsgSearchNotify *aListener)</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineminus">-{</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::UnregisterListener(</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+    nsIMsgSearchNotify *aListener) {</span>
<a href="#l21.126"></a><span id="l21.126">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l21.127"></a><span id="l21.127">   size_t listenerIndex = m_listenerList.IndexOf(aListener);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-  if (listenerIndex != m_listenerList.NoIndex)</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-  {</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+  if (listenerIndex != m_listenerList.NoIndex) {</span>
<a href="#l21.131"></a><span id="l21.131">     m_listenerList.RemoveElementAt(listenerIndex);</span>
<a href="#l21.132"></a><span id="l21.132">     m_listenerFlagList.RemoveElementAt(listenerIndex);</span>
<a href="#l21.133"></a><span id="l21.133"> </span>
<a href="#l21.134"></a><span id="l21.134">     // Adjust our iterator if it is active.</span>
<a href="#l21.135"></a><span id="l21.135">     // Removal of something at a higher index than the iterator does not affect</span>
<a href="#l21.136"></a><span id="l21.136">     // it; we only care if the the index we were pointing at gets shifted down,</span>
<a href="#l21.137"></a><span id="l21.137">     // in which case we also want to shift down.</span>
<a href="#l21.138"></a><span id="l21.138">     if (m_iListener != -1 &amp;&amp; (signed)listenerIndex &lt;= m_iListener)</span>
<a href="#l21.139"></a><span id="l21.139">       m_iListener--;</span>
<a href="#l21.140"></a><span id="l21.140">   }</span>
<a href="#l21.141"></a><span id="l21.141"> </span>
<a href="#l21.142"></a><span id="l21.142">   return NS_OK;</span>
<a href="#l21.143"></a><span id="l21.143"> }</span>
<a href="#l21.144"></a><span id="l21.144"> </span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::GetNumSearchTerms(uint32_t *aNumSearchTerms)</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-{</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::GetNumSearchTerms(uint32_t *aNumSearchTerms) {</span>
<a href="#l21.148"></a><span id="l21.148">   NS_ENSURE_ARG(aNumSearchTerms);</span>
<a href="#l21.149"></a><span id="l21.149">   return m_termList-&gt;Count(aNumSearchTerms);</span>
<a href="#l21.150"></a><span id="l21.150"> }</span>
<a href="#l21.151"></a><span id="l21.151"> </span>
<a href="#l21.152"></a><span id="l21.152"> NS_IMETHODIMP</span>
<a href="#l21.153"></a><span id="l21.153"> nsMsgSearchSession::GetNthSearchTerm(int32_t whichTerm,</span>
<a href="#l21.154"></a><span id="l21.154">                                      nsMsgSearchAttribValue attrib,</span>
<a href="#l21.155"></a><span id="l21.155">                                      nsMsgSearchOpValue op,</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-                                     nsIMsgSearchValue *value)</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-{</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+                                     nsIMsgSearchValue *value) {</span>
<a href="#l21.159"></a><span id="l21.159">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.160"></a><span id="l21.160"> }</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::CountSearchScopes(int32_t *_retval)</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-{</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::CountSearchScopes(int32_t *_retval) {</span>
<a href="#l21.165"></a><span id="l21.165">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l21.166"></a><span id="l21.166">   *_retval = m_scopeList.Length();</span>
<a href="#l21.167"></a><span id="l21.167">   return NS_OK;</span>
<a href="#l21.168"></a><span id="l21.168"> }</span>
<a href="#l21.169"></a><span id="l21.169"> </span>
<a href="#l21.170"></a><span id="l21.170"> NS_IMETHODIMP</span>
<a href="#l21.171"></a><span id="l21.171"> nsMsgSearchSession::GetNthSearchScope(int32_t which,</span>
<a href="#l21.172"></a><span id="l21.172">                                       nsMsgSearchScopeValue *scopeId,</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-                                      nsIMsgFolder **folder)</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-{</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineplus">+                                      nsIMsgFolder **folder) {</span>
<a href="#l21.176"></a><span id="l21.176">   NS_ENSURE_ARG_POINTER(scopeId);</span>
<a href="#l21.177"></a><span id="l21.177">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l21.178"></a><span id="l21.178"> </span>
<a href="#l21.179"></a><span id="l21.179">   nsMsgSearchScopeTerm *scopeTerm = m_scopeList.SafeElementAt(which, nullptr);</span>
<a href="#l21.180"></a><span id="l21.180">   NS_ENSURE_ARG(scopeTerm);</span>
<a href="#l21.181"></a><span id="l21.181"> </span>
<a href="#l21.182"></a><span id="l21.182">   *scopeId = scopeTerm-&gt;m_attribute;</span>
<a href="#l21.183"></a><span id="l21.183">   NS_IF_ADDREF(*folder = scopeTerm-&gt;m_folder);</span>
<a href="#l21.184"></a><span id="l21.184">   return NS_OK;</span>
<a href="#l21.185"></a><span id="l21.185"> }</span>
<a href="#l21.186"></a><span id="l21.186"> </span>
<a href="#l21.187"></a><span id="l21.187"> NS_IMETHODIMP</span>
<a href="#l21.188"></a><span id="l21.188"> nsMsgSearchSession::AddScopeTerm(nsMsgSearchScopeValue scope,</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineminus">-                                 nsIMsgFolder *folder)</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-{</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineminus">-  if (scope != nsMsgSearchScope::allSearchableGroups)</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineminus">-  {</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineplus">+                                 nsIMsgFolder *folder) {</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineplus">+  if (scope != nsMsgSearchScope::allSearchableGroups) {</span>
<a href="#l21.195"></a><span id="l21.195">     NS_ASSERTION(folder, &quot;need folder if not searching all groups&quot;);</span>
<a href="#l21.196"></a><span id="l21.196">     NS_ENSURE_TRUE(folder, NS_ERROR_NULL_POINTER);</span>
<a href="#l21.197"></a><span id="l21.197">   }</span>
<a href="#l21.198"></a><span id="l21.198"> </span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-  nsMsgSearchScopeTerm *pScopeTerm = new nsMsgSearchScopeTerm(this, scope, folder);</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineplus">+  nsMsgSearchScopeTerm *pScopeTerm =</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+      new nsMsgSearchScopeTerm(this, scope, folder);</span>
<a href="#l21.202"></a><span id="l21.202">   NS_ENSURE_TRUE(pScopeTerm, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l21.203"></a><span id="l21.203"> </span>
<a href="#l21.204"></a><span id="l21.204">   m_scopeList.AppendElement(pScopeTerm);</span>
<a href="#l21.205"></a><span id="l21.205">   return NS_OK;</span>
<a href="#l21.206"></a><span id="l21.206"> }</span>
<a href="#l21.207"></a><span id="l21.207"> </span>
<a href="#l21.208"></a><span id="l21.208"> NS_IMETHODIMP</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-nsMsgSearchSession::AddDirectoryScopeTerm(nsMsgSearchScopeValue scope)</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-{</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-  nsMsgSearchScopeTerm *pScopeTerm = new nsMsgSearchScopeTerm(this, scope, nullptr);</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineplus">+nsMsgSearchSession::AddDirectoryScopeTerm(nsMsgSearchScopeValue scope) {</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineplus">+  nsMsgSearchScopeTerm *pScopeTerm =</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineplus">+      new nsMsgSearchScopeTerm(this, scope, nullptr);</span>
<a href="#l21.215"></a><span id="l21.215">   NS_ENSURE_TRUE(pScopeTerm, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l21.216"></a><span id="l21.216"> </span>
<a href="#l21.217"></a><span id="l21.217">   m_scopeList.AppendElement(pScopeTerm);</span>
<a href="#l21.218"></a><span id="l21.218">   return NS_OK;</span>
<a href="#l21.219"></a><span id="l21.219"> }</span>
<a href="#l21.220"></a><span id="l21.220"> </span>
<a href="#l21.221"></a><span id="l21.221" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::ClearScopes()</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineminus">-{</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineminus">-    DestroyScopeList();</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::ClearScopes() {</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineplus">+  DestroyScopeList();</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.228"></a><span id="l21.228"> }</span>
<a href="#l21.229"></a><span id="l21.229"> </span>
<a href="#l21.230"></a><span id="l21.230"> NS_IMETHODIMP</span>
<a href="#l21.231"></a><span id="l21.231"> nsMsgSearchSession::ScopeUsesCustomHeaders(nsMsgSearchScopeValue scope,</span>
<a href="#l21.232"></a><span id="l21.232" class="difflineminus">-                                           void *selection,</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-                                           bool forFilters,</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-                                           bool *_retval)</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">-{</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineplus">+                                           void *selection, bool forFilters,</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineplus">+                                           bool *_retval) {</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.240"></a><span id="l21.240"> }</span>
<a href="#l21.241"></a><span id="l21.241"> </span>
<a href="#l21.242"></a><span id="l21.242"> NS_IMETHODIMP</span>
<a href="#l21.243"></a><span id="l21.243"> nsMsgSearchSession::IsStringAttribute(nsMsgSearchAttribValue attrib,</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineminus">-                                      bool *_retval)</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineminus">-{</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineplus">+                                      bool *_retval) {</span>
<a href="#l21.247"></a><span id="l21.247">   // Is this check needed?</span>
<a href="#l21.248"></a><span id="l21.248">   NS_ENSURE_ARG(_retval);</span>
<a href="#l21.249"></a><span id="l21.249">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.250"></a><span id="l21.250"> }</span>
<a href="#l21.251"></a><span id="l21.251"> </span>
<a href="#l21.252"></a><span id="l21.252"> NS_IMETHODIMP</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineminus">-nsMsgSearchSession::AddAllScopes(nsMsgSearchScopeValue attrib)</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineminus">-{</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineplus">+nsMsgSearchSession::AddAllScopes(nsMsgSearchScopeValue attrib) {</span>
<a href="#l21.256"></a><span id="l21.256">   // don't think this is needed.</span>
<a href="#l21.257"></a><span id="l21.257">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.258"></a><span id="l21.258"> }</span>
<a href="#l21.259"></a><span id="l21.259"> </span>
<a href="#l21.260"></a><span id="l21.260" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::Search(nsIMsgWindow *aWindow)</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineminus">-{</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::Search(nsIMsgWindow *aWindow) {</span>
<a href="#l21.263"></a><span id="l21.263">   nsresult rv = Initialize();</span>
<a href="#l21.264"></a><span id="l21.264">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.265"></a><span id="l21.265"> </span>
<a href="#l21.266"></a><span id="l21.266">   nsCOMPtr&lt;nsIMsgSearchNotify&gt; listener;</span>
<a href="#l21.267"></a><span id="l21.267">   m_iListener = 0;</span>
<a href="#l21.268"></a><span id="l21.268" class="difflineminus">-  while (m_iListener != -1 &amp;&amp; m_iListener &lt; (signed)m_listenerList.Length())</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-  {</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineplus">+  while (m_iListener != -1 &amp;&amp; m_iListener &lt; (signed)m_listenerList.Length()) {</span>
<a href="#l21.271"></a><span id="l21.271">     listener = m_listenerList[m_iListener];</span>
<a href="#l21.272"></a><span id="l21.272">     int32_t listenerFlags = m_listenerFlagList[m_iListener++];</span>
<a href="#l21.273"></a><span id="l21.273">     if (!listenerFlags || (listenerFlags &amp; nsIMsgSearchSession::onNewSearch))</span>
<a href="#l21.274"></a><span id="l21.274">       listener-&gt;OnNewSearch();</span>
<a href="#l21.275"></a><span id="l21.275">   }</span>
<a href="#l21.276"></a><span id="l21.276">   m_iListener = -1;</span>
<a href="#l21.277"></a><span id="l21.277"> </span>
<a href="#l21.278"></a><span id="l21.278">   m_msgWindowWeak = do_GetWeakReference(aWindow);</span>
<a href="#l21.279"></a><span id="l21.279"> </span>
<a href="#l21.280"></a><span id="l21.280">   return BeginSearching();</span>
<a href="#l21.281"></a><span id="l21.281"> }</span>
<a href="#l21.282"></a><span id="l21.282"> </span>
<a href="#l21.283"></a><span id="l21.283" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::InterruptSearch()</span>
<a href="#l21.284"></a><span id="l21.284" class="difflineminus">-{</span>
<a href="#l21.285"></a><span id="l21.285" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::InterruptSearch() {</span>
<a href="#l21.286"></a><span id="l21.286">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineminus">-  if (msgWindow)</span>
<a href="#l21.288"></a><span id="l21.288" class="difflineminus">-  {</span>
<a href="#l21.289"></a><span id="l21.289" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l21.290"></a><span id="l21.290">     EnableFolderNotifications(true);</span>
<a href="#l21.291"></a><span id="l21.291" class="difflineminus">-    if (m_idxRunningScope &lt; m_scopeList.Length())</span>
<a href="#l21.292"></a><span id="l21.292" class="difflineminus">-      msgWindow-&gt;StopUrls();</span>
<a href="#l21.293"></a><span id="l21.293" class="difflineplus">+    if (m_idxRunningScope &lt; m_scopeList.Length()) msgWindow-&gt;StopUrls();</span>
<a href="#l21.294"></a><span id="l21.294"> </span>
<a href="#l21.295"></a><span id="l21.295" class="difflineminus">-    while (m_idxRunningScope &lt; m_scopeList.Length())</span>
<a href="#l21.296"></a><span id="l21.296" class="difflineminus">-    {</span>
<a href="#l21.297"></a><span id="l21.297" class="difflineplus">+    while (m_idxRunningScope &lt; m_scopeList.Length()) {</span>
<a href="#l21.298"></a><span id="l21.298">       ReleaseFolderDBRef();</span>
<a href="#l21.299"></a><span id="l21.299">       m_idxRunningScope++;</span>
<a href="#l21.300"></a><span id="l21.300">     }</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineminus">-    //m_idxRunningScope = m_scopeList.Length() so it will make us not run another url</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineplus">+    // m_idxRunningScope = m_scopeList.Length() so it will make us not run</span>
<a href="#l21.303"></a><span id="l21.303" class="difflineplus">+    // another url</span>
<a href="#l21.304"></a><span id="l21.304">   }</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineminus">-  if (m_backgroundTimer)</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineminus">-  {</span>
<a href="#l21.307"></a><span id="l21.307" class="difflineplus">+  if (m_backgroundTimer) {</span>
<a href="#l21.308"></a><span id="l21.308">     m_backgroundTimer-&gt;Cancel();</span>
<a href="#l21.309"></a><span id="l21.309">     NotifyListenersDone(NS_MSG_SEARCH_INTERRUPTED);</span>
<a href="#l21.310"></a><span id="l21.310"> </span>
<a href="#l21.311"></a><span id="l21.311">     m_backgroundTimer = nullptr;</span>
<a href="#l21.312"></a><span id="l21.312">   }</span>
<a href="#l21.313"></a><span id="l21.313">   return NS_OK;</span>
<a href="#l21.314"></a><span id="l21.314"> }</span>
<a href="#l21.315"></a><span id="l21.315"> </span>
<a href="#l21.316"></a><span id="l21.316" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::PauseSearch()</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineminus">-{</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-  if (m_backgroundTimer)</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineminus">-  {</span>
<a href="#l21.320"></a><span id="l21.320" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::PauseSearch() {</span>
<a href="#l21.321"></a><span id="l21.321" class="difflineplus">+  if (m_backgroundTimer) {</span>
<a href="#l21.322"></a><span id="l21.322">     m_backgroundTimer-&gt;Cancel();</span>
<a href="#l21.323"></a><span id="l21.323">     m_searchPaused = true;</span>
<a href="#l21.324"></a><span id="l21.324">     return NS_OK;</span>
<a href="#l21.325"></a><span id="l21.325" class="difflineminus">-  }</span>
<a href="#l21.326"></a><span id="l21.326" class="difflineminus">-  else</span>
<a href="#l21.327"></a><span id="l21.327" class="difflineplus">+  } else</span>
<a href="#l21.328"></a><span id="l21.328">     return NS_ERROR_FAILURE;</span>
<a href="#l21.329"></a><span id="l21.329"> }</span>
<a href="#l21.330"></a><span id="l21.330"> </span>
<a href="#l21.331"></a><span id="l21.331" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::ResumeSearch()</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineminus">-{</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineminus">-  if (m_searchPaused)</span>
<a href="#l21.334"></a><span id="l21.334" class="difflineminus">-  {</span>
<a href="#l21.335"></a><span id="l21.335" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::ResumeSearch() {</span>
<a href="#l21.336"></a><span id="l21.336" class="difflineplus">+  if (m_searchPaused) {</span>
<a href="#l21.337"></a><span id="l21.337">     m_searchPaused = false;</span>
<a href="#l21.338"></a><span id="l21.338">     return StartTimer();</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineminus">-  }</span>
<a href="#l21.340"></a><span id="l21.340" class="difflineminus">-  else</span>
<a href="#l21.341"></a><span id="l21.341" class="difflineplus">+  } else</span>
<a href="#l21.342"></a><span id="l21.342">     return NS_ERROR_FAILURE;</span>
<a href="#l21.343"></a><span id="l21.343"> }</span>
<a href="#l21.344"></a><span id="l21.344"> </span>
<a href="#l21.345"></a><span id="l21.345" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::GetNumResults(int32_t *aNumResults)</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineminus">-{</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::GetNumResults(int32_t *aNumResults) {</span>
<a href="#l21.348"></a><span id="l21.348">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l21.349"></a><span id="l21.349"> }</span>
<a href="#l21.350"></a><span id="l21.350"> </span>
<a href="#l21.351"></a><span id="l21.351" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::SetWindow(nsIMsgWindow *aWindow)</span>
<a href="#l21.352"></a><span id="l21.352" class="difflineminus">-{</span>
<a href="#l21.353"></a><span id="l21.353" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::SetWindow(nsIMsgWindow *aWindow) {</span>
<a href="#l21.354"></a><span id="l21.354">   m_msgWindowWeak = do_GetWeakReference(aWindow);</span>
<a href="#l21.355"></a><span id="l21.355">   return NS_OK;</span>
<a href="#l21.356"></a><span id="l21.356"> }</span>
<a href="#l21.357"></a><span id="l21.357"> </span>
<a href="#l21.358"></a><span id="l21.358" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::GetWindow(nsIMsgWindow **aWindow)</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineminus">-{</span>
<a href="#l21.360"></a><span id="l21.360" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::GetWindow(nsIMsgWindow **aWindow) {</span>
<a href="#l21.361"></a><span id="l21.361">   NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l21.362"></a><span id="l21.362">   *aWindow = nullptr;</span>
<a href="#l21.363"></a><span id="l21.363">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l21.364"></a><span id="l21.364">   msgWindow.forget(aWindow);</span>
<a href="#l21.365"></a><span id="l21.365">   return NS_OK;</span>
<a href="#l21.366"></a><span id="l21.366"> }</span>
<a href="#l21.367"></a><span id="l21.367"> </span>
<a href="#l21.368"></a><span id="l21.368" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l21.369"></a><span id="l21.369" class="difflineminus">-{</span>
<a href="#l21.370"></a><span id="l21.370" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.371"></a><span id="l21.371" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l21.372"></a><span id="l21.372" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.373"></a><span id="l21.373"> }</span>
<a href="#l21.374"></a><span id="l21.374"> </span>
<a href="#l21.375"></a><span id="l21.375" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::OnStopRunningUrl(nsIURI *url, nsresult aExitCode)</span>
<a href="#l21.376"></a><span id="l21.376" class="difflineminus">-{</span>
<a href="#l21.377"></a><span id="l21.377" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l21.378"></a><span id="l21.378" class="difflineplus">+                                                   nsresult aExitCode) {</span>
<a href="#l21.379"></a><span id="l21.379">   nsCOMPtr&lt;nsIMsgSearchAdapter&gt; runningAdapter;</span>
<a href="#l21.380"></a><span id="l21.380"> </span>
<a href="#l21.381"></a><span id="l21.381">   nsresult rv = GetRunningAdapter(getter_AddRefs(runningAdapter));</span>
<a href="#l21.382"></a><span id="l21.382">   // tell the current adapter that the current url has run.</span>
<a href="#l21.383"></a><span id="l21.383" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; runningAdapter)</span>
<a href="#l21.384"></a><span id="l21.384" class="difflineminus">-  {</span>
<a href="#l21.385"></a><span id="l21.385" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; runningAdapter) {</span>
<a href="#l21.386"></a><span id="l21.386">     runningAdapter-&gt;CurrentUrlDone(aExitCode);</span>
<a href="#l21.387"></a><span id="l21.387">     EnableFolderNotifications(true);</span>
<a href="#l21.388"></a><span id="l21.388">     ReleaseFolderDBRef();</span>
<a href="#l21.389"></a><span id="l21.389">   }</span>
<a href="#l21.390"></a><span id="l21.390">   if (++m_idxRunningScope &lt; m_scopeList.Length())</span>
<a href="#l21.391"></a><span id="l21.391">     DoNextSearch();</span>
<a href="#l21.392"></a><span id="l21.392">   else</span>
<a href="#l21.393"></a><span id="l21.393">     NotifyListenersDone(aExitCode);</span>
<a href="#l21.394"></a><span id="l21.394">   return NS_OK;</span>
<a href="#l21.395"></a><span id="l21.395"> }</span>
<a href="#l21.396"></a><span id="l21.396"> </span>
<a href="#l21.397"></a><span id="l21.397" class="difflineminus">-</span>
<a href="#l21.398"></a><span id="l21.398" class="difflineminus">-nsresult nsMsgSearchSession::Initialize()</span>
<a href="#l21.399"></a><span id="l21.399" class="difflineminus">-{</span>
<a href="#l21.400"></a><span id="l21.400" class="difflineplus">+nsresult nsMsgSearchSession::Initialize() {</span>
<a href="#l21.401"></a><span id="l21.401">   // Loop over scope terms, initializing an adapter per term. This</span>
<a href="#l21.402"></a><span id="l21.402">   // architecture is necessitated by two things:</span>
<a href="#l21.403"></a><span id="l21.403">   // 1. There might be more than one kind of adapter per if online</span>
<a href="#l21.404"></a><span id="l21.404">   //    *and* offline mail mail folders are selected, or if newsgroups</span>
<a href="#l21.405"></a><span id="l21.405">   //    belonging to Dredd *and* INN are selected</span>
<a href="#l21.406"></a><span id="l21.406">   // 2. Most of the protocols are only capable of searching one scope at a</span>
<a href="#l21.407"></a><span id="l21.407">   //    time, so we'll do each scope in a separate adapter on the client</span>
<a href="#l21.408"></a><span id="l21.408"> </span>
<a href="#l21.409"></a><span id="l21.409">   nsMsgSearchScopeTerm *scopeTerm = nullptr;</span>
<a href="#l21.410"></a><span id="l21.410">   nsresult rv = NS_OK;</span>
<a href="#l21.411"></a><span id="l21.411"> </span>
<a href="#l21.412"></a><span id="l21.412">   uint32_t numTerms;</span>
<a href="#l21.413"></a><span id="l21.413">   m_termList-&gt;Count(&amp;numTerms);</span>
<a href="#l21.414"></a><span id="l21.414">   // Ensure that the FE has added scopes and terms to this search</span>
<a href="#l21.415"></a><span id="l21.415">   NS_ASSERTION(numTerms &gt; 0, &quot;no terms to search!&quot;);</span>
<a href="#l21.416"></a><span id="l21.416" class="difflineminus">-  if (numTerms == 0)</span>
<a href="#l21.417"></a><span id="l21.417" class="difflineminus">-    return NS_MSG_ERROR_NO_SEARCH_VALUES;</span>
<a href="#l21.418"></a><span id="l21.418" class="difflineplus">+  if (numTerms == 0) return NS_MSG_ERROR_NO_SEARCH_VALUES;</span>
<a href="#l21.419"></a><span id="l21.419"> </span>
<a href="#l21.420"></a><span id="l21.420">   // if we don't have any search scopes to search, return that code.</span>
<a href="#l21.421"></a><span id="l21.421" class="difflineminus">-  if (m_scopeList.Length() == 0)</span>
<a href="#l21.422"></a><span id="l21.422" class="difflineminus">-    return NS_MSG_ERROR_INVALID_SEARCH_SCOPE;</span>
<a href="#l21.423"></a><span id="l21.423" class="difflineplus">+  if (m_scopeList.Length() == 0) return NS_MSG_ERROR_INVALID_SEARCH_SCOPE;</span>
<a href="#l21.424"></a><span id="l21.424"> </span>
<a href="#l21.425"></a><span id="l21.425" class="difflineminus">-  m_runningUrl.Truncate(); // clear out old url, if any.</span>
<a href="#l21.426"></a><span id="l21.426" class="difflineplus">+  m_runningUrl.Truncate();  // clear out old url, if any.</span>
<a href="#l21.427"></a><span id="l21.427">   m_idxRunningScope = 0;</span>
<a href="#l21.428"></a><span id="l21.428"> </span>
<a href="#l21.429"></a><span id="l21.429">   // If this term list (loosely specified here by the first term) should be</span>
<a href="#l21.430"></a><span id="l21.430" class="difflineminus">-  // scheduled in parallel, build up a list of scopes to do the round-robin scheduling</span>
<a href="#l21.431"></a><span id="l21.431" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_scopeList.Length() &amp;&amp; NS_SUCCEEDED(rv); i++)</span>
<a href="#l21.432"></a><span id="l21.432" class="difflineminus">-  {</span>
<a href="#l21.433"></a><span id="l21.433" class="difflineplus">+  // scheduled in parallel, build up a list of scopes to do the round-robin</span>
<a href="#l21.434"></a><span id="l21.434" class="difflineplus">+  // scheduling</span>
<a href="#l21.435"></a><span id="l21.435" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_scopeList.Length() &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l21.436"></a><span id="l21.436">     scopeTerm = m_scopeList.ElementAt(i);</span>
<a href="#l21.437"></a><span id="l21.437">     // NS_ASSERTION(scopeTerm-&gt;IsValid());</span>
<a href="#l21.438"></a><span id="l21.438"> </span>
<a href="#l21.439"></a><span id="l21.439">     rv = scopeTerm-&gt;InitializeAdapter(m_termList);</span>
<a href="#l21.440"></a><span id="l21.440">   }</span>
<a href="#l21.441"></a><span id="l21.441"> </span>
<a href="#l21.442"></a><span id="l21.442">   return rv;</span>
<a href="#l21.443"></a><span id="l21.443"> }</span>
<a href="#l21.444"></a><span id="l21.444"> </span>
<a href="#l21.445"></a><span id="l21.445" class="difflineminus">-nsresult nsMsgSearchSession::BeginSearching()</span>
<a href="#l21.446"></a><span id="l21.446" class="difflineminus">-{</span>
<a href="#l21.447"></a><span id="l21.447" class="difflineplus">+nsresult nsMsgSearchSession::BeginSearching() {</span>
<a href="#l21.448"></a><span id="l21.448">   // Here's a sloppy way to start the URL, but I don't really have time to</span>
<a href="#l21.449"></a><span id="l21.449">   // unify the scheduling mechanisms. If the first scope is a newsgroup, and</span>
<a href="#l21.450"></a><span id="l21.450">   // it's not Dredd-capable, we build the URL queue. All other searches can be</span>
<a href="#l21.451"></a><span id="l21.451">   // done with one URL</span>
<a href="#l21.452"></a><span id="l21.452">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l21.453"></a><span id="l21.453" class="difflineminus">-  if (msgWindow)</span>
<a href="#l21.454"></a><span id="l21.454" class="difflineminus">-    msgWindow-&gt;SetStopped(false);</span>
<a href="#l21.455"></a><span id="l21.455" class="difflineplus">+  if (msgWindow) msgWindow-&gt;SetStopped(false);</span>
<a href="#l21.456"></a><span id="l21.456">   return DoNextSearch();</span>
<a href="#l21.457"></a><span id="l21.457"> }</span>
<a href="#l21.458"></a><span id="l21.458"> </span>
<a href="#l21.459"></a><span id="l21.459" class="difflineminus">-nsresult nsMsgSearchSession::DoNextSearch()</span>
<a href="#l21.460"></a><span id="l21.460" class="difflineminus">-{</span>
<a href="#l21.461"></a><span id="l21.461" class="difflineplus">+nsresult nsMsgSearchSession::DoNextSearch() {</span>
<a href="#l21.462"></a><span id="l21.462">   nsMsgSearchScopeTerm *scope = m_scopeList.ElementAt(m_idxRunningScope);</span>
<a href="#l21.463"></a><span id="l21.463">   if (scope-&gt;m_attribute == nsMsgSearchScope::onlineMail ||</span>
<a href="#l21.464"></a><span id="l21.464" class="difflineminus">-    (scope-&gt;m_attribute == nsMsgSearchScope::news &amp;&amp; scope-&gt;m_searchServer))</span>
<a href="#l21.465"></a><span id="l21.465" class="difflineminus">-  {</span>
<a href="#l21.466"></a><span id="l21.466" class="difflineminus">-    if (scope-&gt;m_adapter)</span>
<a href="#l21.467"></a><span id="l21.467" class="difflineminus">-    {</span>
<a href="#l21.468"></a><span id="l21.468" class="difflineplus">+      (scope-&gt;m_attribute == nsMsgSearchScope::news &amp;&amp; scope-&gt;m_searchServer)) {</span>
<a href="#l21.469"></a><span id="l21.469" class="difflineplus">+    if (scope-&gt;m_adapter) {</span>
<a href="#l21.470"></a><span id="l21.470">       m_runningUrl.Truncate();</span>
<a href="#l21.471"></a><span id="l21.471">       scope-&gt;m_adapter-&gt;GetEncoding(getter_Copies(m_runningUrl));</span>
<a href="#l21.472"></a><span id="l21.472">     }</span>
<a href="#l21.473"></a><span id="l21.473">     NS_ENSURE_STATE(!m_runningUrl.IsEmpty());</span>
<a href="#l21.474"></a><span id="l21.474">     return GetNextUrl();</span>
<a href="#l21.475"></a><span id="l21.475" class="difflineminus">-  }</span>
<a href="#l21.476"></a><span id="l21.476" class="difflineminus">-  else</span>
<a href="#l21.477"></a><span id="l21.477" class="difflineminus">-  {</span>
<a href="#l21.478"></a><span id="l21.478" class="difflineplus">+  } else {</span>
<a href="#l21.479"></a><span id="l21.479">     return SearchWOUrls();</span>
<a href="#l21.480"></a><span id="l21.480">   }</span>
<a href="#l21.481"></a><span id="l21.481"> }</span>
<a href="#l21.482"></a><span id="l21.482"> </span>
<a href="#l21.483"></a><span id="l21.483" class="difflineminus">-nsresult nsMsgSearchSession::GetNextUrl()</span>
<a href="#l21.484"></a><span id="l21.484" class="difflineminus">-{</span>
<a href="#l21.485"></a><span id="l21.485" class="difflineplus">+nsresult nsMsgSearchSession::GetNextUrl() {</span>
<a href="#l21.486"></a><span id="l21.486">   nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l21.487"></a><span id="l21.487"> </span>
<a href="#l21.488"></a><span id="l21.488">   bool stopped = false;</span>
<a href="#l21.489"></a><span id="l21.489">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l21.490"></a><span id="l21.490" class="difflineminus">-  if (msgWindow)</span>
<a href="#l21.491"></a><span id="l21.491" class="difflineminus">-    msgWindow-&gt;GetStopped(&amp;stopped);</span>
<a href="#l21.492"></a><span id="l21.492" class="difflineminus">-  if (stopped)</span>
<a href="#l21.493"></a><span id="l21.493" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.494"></a><span id="l21.494" class="difflineplus">+  if (msgWindow) msgWindow-&gt;GetStopped(&amp;stopped);</span>
<a href="#l21.495"></a><span id="l21.495" class="difflineplus">+  if (stopped) return NS_OK;</span>
<a href="#l21.496"></a><span id="l21.496"> </span>
<a href="#l21.497"></a><span id="l21.497">   nsMsgSearchScopeTerm *currentTerm = GetRunningScope();</span>
<a href="#l21.498"></a><span id="l21.498">   NS_ENSURE_TRUE(currentTerm, NS_ERROR_NULL_POINTER);</span>
<a href="#l21.499"></a><span id="l21.499">   EnableFolderNotifications(false);</span>
<a href="#l21.500"></a><span id="l21.500">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = currentTerm-&gt;m_folder;</span>
<a href="#l21.501"></a><span id="l21.501" class="difflineminus">-  if (folder)</span>
<a href="#l21.502"></a><span id="l21.502" class="difflineminus">-  {</span>
<a href="#l21.503"></a><span id="l21.503" class="difflineplus">+  if (folder) {</span>
<a href="#l21.504"></a><span id="l21.504">     nsCString folderUri;</span>
<a href="#l21.505"></a><span id="l21.505">     folder-&gt;GetURI(folderUri);</span>
<a href="#l21.506"></a><span id="l21.506" class="difflineminus">-    nsresult rv = GetMessageServiceFromURI(folderUri, getter_AddRefs(msgService));</span>
<a href="#l21.507"></a><span id="l21.507" class="difflineplus">+    nsresult rv =</span>
<a href="#l21.508"></a><span id="l21.508" class="difflineplus">+        GetMessageServiceFromURI(folderUri, getter_AddRefs(msgService));</span>
<a href="#l21.509"></a><span id="l21.509"> </span>
<a href="#l21.510"></a><span id="l21.510">     if (NS_SUCCEEDED(rv) &amp;&amp; msgService &amp;&amp; currentTerm)</span>
<a href="#l21.511"></a><span id="l21.511" class="difflineminus">-      msgService-&gt;Search(this, msgWindow, currentTerm-&gt;m_folder, m_runningUrl.get());</span>
<a href="#l21.512"></a><span id="l21.512" class="difflineplus">+      msgService-&gt;Search(this, msgWindow, currentTerm-&gt;m_folder,</span>
<a href="#l21.513"></a><span id="l21.513" class="difflineplus">+                         m_runningUrl.get());</span>
<a href="#l21.514"></a><span id="l21.514">     return rv;</span>
<a href="#l21.515"></a><span id="l21.515">   }</span>
<a href="#l21.516"></a><span id="l21.516">   return NS_OK;</span>
<a href="#l21.517"></a><span id="l21.517"> }</span>
<a href="#l21.518"></a><span id="l21.518"> </span>
<a href="#l21.519"></a><span id="l21.519"> /* static */</span>
<a href="#l21.520"></a><span id="l21.520" class="difflineminus">-void nsMsgSearchSession::TimerCallback(nsITimer *aTimer, void *aClosure)</span>
<a href="#l21.521"></a><span id="l21.521" class="difflineminus">-{</span>
<a href="#l21.522"></a><span id="l21.522" class="difflineplus">+void nsMsgSearchSession::TimerCallback(nsITimer *aTimer, void *aClosure) {</span>
<a href="#l21.523"></a><span id="l21.523">   NS_ENSURE_TRUE_VOID(aClosure);</span>
<a href="#l21.524"></a><span id="l21.524" class="difflineminus">-  nsMsgSearchSession *searchSession = (nsMsgSearchSession *) aClosure;</span>
<a href="#l21.525"></a><span id="l21.525" class="difflineplus">+  nsMsgSearchSession *searchSession = (nsMsgSearchSession *)aClosure;</span>
<a href="#l21.526"></a><span id="l21.526">   bool done;</span>
<a href="#l21.527"></a><span id="l21.527">   bool stopped = false;</span>
<a href="#l21.528"></a><span id="l21.528"> </span>
<a href="#l21.529"></a><span id="l21.529">   searchSession-&gt;TimeSlice(&amp;done);</span>
<a href="#l21.530"></a><span id="l21.530" class="difflineminus">-  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(searchSession-&gt;m_msgWindowWeak));</span>
<a href="#l21.531"></a><span id="l21.531" class="difflineminus">-  if (msgWindow)</span>
<a href="#l21.532"></a><span id="l21.532" class="difflineminus">-    msgWindow-&gt;GetStopped(&amp;stopped);</span>
<a href="#l21.533"></a><span id="l21.533" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(</span>
<a href="#l21.534"></a><span id="l21.534" class="difflineplus">+      do_QueryReferent(searchSession-&gt;m_msgWindowWeak));</span>
<a href="#l21.535"></a><span id="l21.535" class="difflineplus">+  if (msgWindow) msgWindow-&gt;GetStopped(&amp;stopped);</span>
<a href="#l21.536"></a><span id="l21.536"> </span>
<a href="#l21.537"></a><span id="l21.537" class="difflineminus">-  if (done || stopped)</span>
<a href="#l21.538"></a><span id="l21.538" class="difflineminus">-  {</span>
<a href="#l21.539"></a><span id="l21.539" class="difflineminus">-    if (aTimer)</span>
<a href="#l21.540"></a><span id="l21.540" class="difflineminus">-      aTimer-&gt;Cancel();</span>
<a href="#l21.541"></a><span id="l21.541" class="difflineplus">+  if (done || stopped) {</span>
<a href="#l21.542"></a><span id="l21.542" class="difflineplus">+    if (aTimer) aTimer-&gt;Cancel();</span>
<a href="#l21.543"></a><span id="l21.543">     searchSession-&gt;m_backgroundTimer = nullptr;</span>
<a href="#l21.544"></a><span id="l21.544">     if (searchSession-&gt;m_idxRunningScope &lt; searchSession-&gt;m_scopeList.Length())</span>
<a href="#l21.545"></a><span id="l21.545">       searchSession-&gt;DoNextSearch();</span>
<a href="#l21.546"></a><span id="l21.546">     else</span>
<a href="#l21.547"></a><span id="l21.547">       searchSession-&gt;NotifyListenersDone(NS_OK);</span>
<a href="#l21.548"></a><span id="l21.548">   }</span>
<a href="#l21.549"></a><span id="l21.549"> }</span>
<a href="#l21.550"></a><span id="l21.550"> </span>
<a href="#l21.551"></a><span id="l21.551" class="difflineminus">-nsresult nsMsgSearchSession::StartTimer()</span>
<a href="#l21.552"></a><span id="l21.552" class="difflineminus">-{</span>
<a href="#l21.553"></a><span id="l21.553" class="difflineplus">+nsresult nsMsgSearchSession::StartTimer() {</span>
<a href="#l21.554"></a><span id="l21.554">   nsresult rv;</span>
<a href="#l21.555"></a><span id="l21.555"> </span>
<a href="#l21.556"></a><span id="l21.556">   m_backgroundTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l21.557"></a><span id="l21.557">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.558"></a><span id="l21.558" class="difflineminus">-  m_backgroundTimer-&gt;InitWithNamedFuncCallback(TimerCallback, (void *) this, 0,</span>
<a href="#l21.559"></a><span id="l21.559" class="difflineminus">-                                               nsITimer::TYPE_REPEATING_SLACK,</span>
<a href="#l21.560"></a><span id="l21.560" class="difflineminus">-                                               &quot;nsMsgSearchSession::TimerCallback&quot;);</span>
<a href="#l21.561"></a><span id="l21.561" class="difflineplus">+  m_backgroundTimer-&gt;InitWithNamedFuncCallback(</span>
<a href="#l21.562"></a><span id="l21.562" class="difflineplus">+      TimerCallback, (void *)this, 0, nsITimer::TYPE_REPEATING_SLACK,</span>
<a href="#l21.563"></a><span id="l21.563" class="difflineplus">+      &quot;nsMsgSearchSession::TimerCallback&quot;);</span>
<a href="#l21.564"></a><span id="l21.564">   TimerCallback(m_backgroundTimer, this);</span>
<a href="#l21.565"></a><span id="l21.565">   return NS_OK;</span>
<a href="#l21.566"></a><span id="l21.566"> }</span>
<a href="#l21.567"></a><span id="l21.567"> </span>
<a href="#l21.568"></a><span id="l21.568" class="difflineminus">-nsresult nsMsgSearchSession::SearchWOUrls()</span>
<a href="#l21.569"></a><span id="l21.569" class="difflineminus">-{</span>
<a href="#l21.570"></a><span id="l21.570" class="difflineplus">+nsresult nsMsgSearchSession::SearchWOUrls() {</span>
<a href="#l21.571"></a><span id="l21.571">   EnableFolderNotifications(false);</span>
<a href="#l21.572"></a><span id="l21.572">   return StartTimer();</span>
<a href="#l21.573"></a><span id="l21.573"> }</span>
<a href="#l21.574"></a><span id="l21.574"> </span>
<a href="#l21.575"></a><span id="l21.575"> NS_IMETHODIMP</span>
<a href="#l21.576"></a><span id="l21.576" class="difflineminus">-nsMsgSearchSession::GetRunningAdapter(nsIMsgSearchAdapter **aSearchAdapter)</span>
<a href="#l21.577"></a><span id="l21.577" class="difflineminus">-{</span>
<a href="#l21.578"></a><span id="l21.578" class="difflineplus">+nsMsgSearchSession::GetRunningAdapter(nsIMsgSearchAdapter **aSearchAdapter) {</span>
<a href="#l21.579"></a><span id="l21.579">   NS_ENSURE_ARG_POINTER(aSearchAdapter);</span>
<a href="#l21.580"></a><span id="l21.580">   *aSearchAdapter = nullptr;</span>
<a href="#l21.581"></a><span id="l21.581">   nsMsgSearchScopeTerm *scope = GetRunningScope();</span>
<a href="#l21.582"></a><span id="l21.582" class="difflineminus">-  if (scope)</span>
<a href="#l21.583"></a><span id="l21.583" class="difflineminus">-  {</span>
<a href="#l21.584"></a><span id="l21.584" class="difflineplus">+  if (scope) {</span>
<a href="#l21.585"></a><span id="l21.585">     NS_IF_ADDREF(*aSearchAdapter = scope-&gt;m_adapter);</span>
<a href="#l21.586"></a><span id="l21.586">   }</span>
<a href="#l21.587"></a><span id="l21.587">   return NS_OK;</span>
<a href="#l21.588"></a><span id="l21.588"> }</span>
<a href="#l21.589"></a><span id="l21.589"> </span>
<a href="#l21.590"></a><span id="l21.590"> NS_IMETHODIMP nsMsgSearchSession::AddSearchHit(nsIMsgDBHdr *aHeader,</span>
<a href="#l21.591"></a><span id="l21.591" class="difflineminus">-                                               nsIMsgFolder *aFolder)</span>
<a href="#l21.592"></a><span id="l21.592" class="difflineminus">-{</span>
<a href="#l21.593"></a><span id="l21.593" class="difflineplus">+                                               nsIMsgFolder *aFolder) {</span>
<a href="#l21.594"></a><span id="l21.594">   nsCOMPtr&lt;nsIMsgSearchNotify&gt; listener;</span>
<a href="#l21.595"></a><span id="l21.595">   m_iListener = 0;</span>
<a href="#l21.596"></a><span id="l21.596" class="difflineminus">-  while (m_iListener != -1 &amp;&amp; m_iListener &lt; (signed)m_listenerList.Length())</span>
<a href="#l21.597"></a><span id="l21.597" class="difflineminus">-  {</span>
<a href="#l21.598"></a><span id="l21.598" class="difflineplus">+  while (m_iListener != -1 &amp;&amp; m_iListener &lt; (signed)m_listenerList.Length()) {</span>
<a href="#l21.599"></a><span id="l21.599">     listener = m_listenerList[m_iListener];</span>
<a href="#l21.600"></a><span id="l21.600">     int32_t listenerFlags = m_listenerFlagList[m_iListener++];</span>
<a href="#l21.601"></a><span id="l21.601">     if (!listenerFlags || (listenerFlags &amp; nsIMsgSearchSession::onSearchHit))</span>
<a href="#l21.602"></a><span id="l21.602">       listener-&gt;OnSearchHit(aHeader, aFolder);</span>
<a href="#l21.603"></a><span id="l21.603">   }</span>
<a href="#l21.604"></a><span id="l21.604">   m_iListener = -1;</span>
<a href="#l21.605"></a><span id="l21.605">   return NS_OK;</span>
<a href="#l21.606"></a><span id="l21.606"> }</span>
<a href="#l21.607"></a><span id="l21.607"> </span>
<a href="#l21.608"></a><span id="l21.608" class="difflineminus">-nsresult nsMsgSearchSession::NotifyListenersDone(nsresult aStatus)</span>
<a href="#l21.609"></a><span id="l21.609" class="difflineminus">-{</span>
<a href="#l21.610"></a><span id="l21.610" class="difflineplus">+nsresult nsMsgSearchSession::NotifyListenersDone(nsresult aStatus) {</span>
<a href="#l21.611"></a><span id="l21.611">   // need to stabilize &quot;this&quot; in case one of the listeners releases the last</span>
<a href="#l21.612"></a><span id="l21.612">   // reference to us.</span>
<a href="#l21.613"></a><span id="l21.613">   RefPtr&lt;nsIMsgSearchSession&gt; kungFuDeathGrip(this);</span>
<a href="#l21.614"></a><span id="l21.614"> </span>
<a href="#l21.615"></a><span id="l21.615">   nsCOMPtr&lt;nsIMsgSearchNotify&gt; listener;</span>
<a href="#l21.616"></a><span id="l21.616">   m_iListener = 0;</span>
<a href="#l21.617"></a><span id="l21.617" class="difflineminus">-  while (m_iListener != -1 &amp;&amp; m_iListener &lt; (signed)m_listenerList.Length())</span>
<a href="#l21.618"></a><span id="l21.618" class="difflineminus">-  {</span>
<a href="#l21.619"></a><span id="l21.619" class="difflineplus">+  while (m_iListener != -1 &amp;&amp; m_iListener &lt; (signed)m_listenerList.Length()) {</span>
<a href="#l21.620"></a><span id="l21.620">     listener = m_listenerList[m_iListener];</span>
<a href="#l21.621"></a><span id="l21.621">     int32_t listenerFlags = m_listenerFlagList[m_iListener++];</span>
<a href="#l21.622"></a><span id="l21.622">     if (!listenerFlags || (listenerFlags &amp; nsIMsgSearchSession::onSearchDone))</span>
<a href="#l21.623"></a><span id="l21.623">       listener-&gt;OnSearchDone(aStatus);</span>
<a href="#l21.624"></a><span id="l21.624">   }</span>
<a href="#l21.625"></a><span id="l21.625">   m_iListener = -1;</span>
<a href="#l21.626"></a><span id="l21.626">   return NS_OK;</span>
<a href="#l21.627"></a><span id="l21.627"> }</span>
<a href="#l21.628"></a><span id="l21.628"> </span>
<a href="#l21.629"></a><span id="l21.629" class="difflineminus">-void nsMsgSearchSession::DestroyScopeList()</span>
<a href="#l21.630"></a><span id="l21.630" class="difflineminus">-{</span>
<a href="#l21.631"></a><span id="l21.631" class="difflineplus">+void nsMsgSearchSession::DestroyScopeList() {</span>
<a href="#l21.632"></a><span id="l21.632">   nsMsgSearchScopeTerm *scope = nullptr;</span>
<a href="#l21.633"></a><span id="l21.633"> </span>
<a href="#l21.634"></a><span id="l21.634" class="difflineminus">-  for (int32_t i = m_scopeList.Length() - 1; i &gt;= 0; i--)</span>
<a href="#l21.635"></a><span id="l21.635" class="difflineminus">-  {</span>
<a href="#l21.636"></a><span id="l21.636" class="difflineplus">+  for (int32_t i = m_scopeList.Length() - 1; i &gt;= 0; i--) {</span>
<a href="#l21.637"></a><span id="l21.637">     scope = m_scopeList.ElementAt(i);</span>
<a href="#l21.638"></a><span id="l21.638">     //    NS_ASSERTION (scope-&gt;IsValid(), &quot;invalid search scope&quot;);</span>
<a href="#l21.639"></a><span id="l21.639" class="difflineminus">-    if (scope-&gt;m_adapter)</span>
<a href="#l21.640"></a><span id="l21.640" class="difflineminus">-      scope-&gt;m_adapter-&gt;ClearScope();</span>
<a href="#l21.641"></a><span id="l21.641" class="difflineplus">+    if (scope-&gt;m_adapter) scope-&gt;m_adapter-&gt;ClearScope();</span>
<a href="#l21.642"></a><span id="l21.642">   }</span>
<a href="#l21.643"></a><span id="l21.643">   m_scopeList.Clear();</span>
<a href="#l21.644"></a><span id="l21.644"> }</span>
<a href="#l21.645"></a><span id="l21.645"> </span>
<a href="#l21.646"></a><span id="l21.646" class="difflineplus">+void nsMsgSearchSession::DestroyTermList() { m_termList-&gt;Clear(); }</span>
<a href="#l21.647"></a><span id="l21.647"> </span>
<a href="#l21.648"></a><span id="l21.648" class="difflineminus">-void nsMsgSearchSession::DestroyTermList()</span>
<a href="#l21.649"></a><span id="l21.649" class="difflineminus">-{</span>
<a href="#l21.650"></a><span id="l21.650" class="difflineminus">-  m_termList-&gt;Clear();</span>
<a href="#l21.651"></a><span id="l21.651" class="difflineminus">-}</span>
<a href="#l21.652"></a><span id="l21.652" class="difflineminus">-</span>
<a href="#l21.653"></a><span id="l21.653" class="difflineminus">-nsMsgSearchScopeTerm *nsMsgSearchSession::GetRunningScope()</span>
<a href="#l21.654"></a><span id="l21.654" class="difflineminus">-{</span>
<a href="#l21.655"></a><span id="l21.655" class="difflineplus">+nsMsgSearchScopeTerm *nsMsgSearchSession::GetRunningScope() {</span>
<a href="#l21.656"></a><span id="l21.656">   return m_scopeList.SafeElementAt(m_idxRunningScope, nullptr);</span>
<a href="#l21.657"></a><span id="l21.657"> }</span>
<a href="#l21.658"></a><span id="l21.658"> </span>
<a href="#l21.659"></a><span id="l21.659" class="difflineminus">-nsresult nsMsgSearchSession::TimeSlice(bool *aDone)</span>
<a href="#l21.660"></a><span id="l21.660" class="difflineminus">-{</span>
<a href="#l21.661"></a><span id="l21.661" class="difflineplus">+nsresult nsMsgSearchSession::TimeSlice(bool *aDone) {</span>
<a href="#l21.662"></a><span id="l21.662">   // we only do serial for now.</span>
<a href="#l21.663"></a><span id="l21.663">   return TimeSliceSerial(aDone);</span>
<a href="#l21.664"></a><span id="l21.664"> }</span>
<a href="#l21.665"></a><span id="l21.665"> </span>
<a href="#l21.666"></a><span id="l21.666" class="difflineminus">-void nsMsgSearchSession::ReleaseFolderDBRef()</span>
<a href="#l21.667"></a><span id="l21.667" class="difflineminus">-{</span>
<a href="#l21.668"></a><span id="l21.668" class="difflineplus">+void nsMsgSearchSession::ReleaseFolderDBRef() {</span>
<a href="#l21.669"></a><span id="l21.669">   nsMsgSearchScopeTerm *scope = GetRunningScope();</span>
<a href="#l21.670"></a><span id="l21.670" class="difflineminus">-  if (!scope)</span>
<a href="#l21.671"></a><span id="l21.671" class="difflineminus">-    return;</span>
<a href="#l21.672"></a><span id="l21.672" class="difflineplus">+  if (!scope) return;</span>
<a href="#l21.673"></a><span id="l21.673"> </span>
<a href="#l21.674"></a><span id="l21.674">   bool isOpen = false;</span>
<a href="#l21.675"></a><span id="l21.675">   uint32_t flags;</span>
<a href="#l21.676"></a><span id="l21.676">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l21.677"></a><span id="l21.677">   scope-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l21.678"></a><span id="l21.678" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l21.679"></a><span id="l21.679" class="difflineminus">-  if (!mailSession || !folder)</span>
<a href="#l21.680"></a><span id="l21.680" class="difflineminus">-    return;</span>
<a href="#l21.681"></a><span id="l21.681" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l21.682"></a><span id="l21.682" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l21.683"></a><span id="l21.683" class="difflineplus">+  if (!mailSession || !folder) return;</span>
<a href="#l21.684"></a><span id="l21.684"> </span>
<a href="#l21.685"></a><span id="l21.685">   mailSession-&gt;IsFolderOpenInWindow(folder, &amp;isOpen);</span>
<a href="#l21.686"></a><span id="l21.686">   folder-&gt;GetFlags(&amp;flags);</span>
<a href="#l21.687"></a><span id="l21.687"> </span>
<a href="#l21.688"></a><span id="l21.688" class="difflineminus">-  /*we don't null out the db reference for inbox because inbox is like the &quot;main&quot; folder</span>
<a href="#l21.689"></a><span id="l21.689" class="difflineminus">-    and performance outweighs footprint */</span>
<a href="#l21.690"></a><span id="l21.690" class="difflineplus">+  /*we don't null out the db reference for inbox because inbox is like the</span>
<a href="#l21.691"></a><span id="l21.691" class="difflineplus">+    &quot;main&quot; folder and performance outweighs footprint */</span>
<a href="#l21.692"></a><span id="l21.692">   if (!isOpen &amp;&amp; !(nsMsgFolderFlags::Inbox &amp; flags))</span>
<a href="#l21.693"></a><span id="l21.693">     folder-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l21.694"></a><span id="l21.694"> }</span>
<a href="#l21.695"></a><span id="l21.695" class="difflineminus">-nsresult nsMsgSearchSession::TimeSliceSerial(bool *aDone)</span>
<a href="#l21.696"></a><span id="l21.696" class="difflineminus">-{</span>
<a href="#l21.697"></a><span id="l21.697" class="difflineminus">-  // This version of TimeSlice runs each scope term one at a time, and waits until one</span>
<a href="#l21.698"></a><span id="l21.698" class="difflineminus">-  // scope term is finished before starting another one. When we're searching the local</span>
<a href="#l21.699"></a><span id="l21.699" class="difflineminus">-  // disk, this is the fastest way to do it.</span>
<a href="#l21.700"></a><span id="l21.700" class="difflineplus">+nsresult nsMsgSearchSession::TimeSliceSerial(bool *aDone) {</span>
<a href="#l21.701"></a><span id="l21.701" class="difflineplus">+  // This version of TimeSlice runs each scope term one at a time, and waits</span>
<a href="#l21.702"></a><span id="l21.702" class="difflineplus">+  // until one scope term is finished before starting another one. When we're</span>
<a href="#l21.703"></a><span id="l21.703" class="difflineplus">+  // searching the local disk, this is the fastest way to do it.</span>
<a href="#l21.704"></a><span id="l21.704"> </span>
<a href="#l21.705"></a><span id="l21.705">   NS_ENSURE_ARG_POINTER(aDone);</span>
<a href="#l21.706"></a><span id="l21.706"> </span>
<a href="#l21.707"></a><span id="l21.707">   nsMsgSearchScopeTerm *scope = GetRunningScope();</span>
<a href="#l21.708"></a><span id="l21.708" class="difflineminus">-  if (!scope)</span>
<a href="#l21.709"></a><span id="l21.709" class="difflineminus">-  {</span>
<a href="#l21.710"></a><span id="l21.710" class="difflineplus">+  if (!scope) {</span>
<a href="#l21.711"></a><span id="l21.711">     *aDone = true;</span>
<a href="#l21.712"></a><span id="l21.712">     return NS_OK;</span>
<a href="#l21.713"></a><span id="l21.713">   }</span>
<a href="#l21.714"></a><span id="l21.714"> </span>
<a href="#l21.715"></a><span id="l21.715">   nsresult rv = scope-&gt;TimeSlice(aDone);</span>
<a href="#l21.716"></a><span id="l21.716" class="difflineminus">-  if (*aDone || NS_FAILED(rv))</span>
<a href="#l21.717"></a><span id="l21.717" class="difflineminus">-  {</span>
<a href="#l21.718"></a><span id="l21.718" class="difflineplus">+  if (*aDone || NS_FAILED(rv)) {</span>
<a href="#l21.719"></a><span id="l21.719">     EnableFolderNotifications(true);</span>
<a href="#l21.720"></a><span id="l21.720">     ReleaseFolderDBRef();</span>
<a href="#l21.721"></a><span id="l21.721">     m_idxRunningScope++;</span>
<a href="#l21.722"></a><span id="l21.722">     EnableFolderNotifications(false);</span>
<a href="#l21.723"></a><span id="l21.723">     // check if the next scope is an online search; if so,</span>
<a href="#l21.724"></a><span id="l21.724">     // set *aDone to true so that we'll try to run the next</span>
<a href="#l21.725"></a><span id="l21.725">     // search in TimerCallback.</span>
<a href="#l21.726"></a><span id="l21.726">     scope = GetRunningScope();</span>
<a href="#l21.727"></a><span id="l21.727">     if (scope &amp;&amp; (scope-&gt;m_attribute == nsMsgSearchScope::onlineMail ||</span>
<a href="#l21.728"></a><span id="l21.728" class="difflineminus">-      (scope-&gt;m_attribute == nsMsgSearchScope::news &amp;&amp; scope-&gt;m_searchServer)))</span>
<a href="#l21.729"></a><span id="l21.729" class="difflineminus">-    {</span>
<a href="#l21.730"></a><span id="l21.730" class="difflineplus">+                  (scope-&gt;m_attribute == nsMsgSearchScope::news &amp;&amp;</span>
<a href="#l21.731"></a><span id="l21.731" class="difflineplus">+                   scope-&gt;m_searchServer))) {</span>
<a href="#l21.732"></a><span id="l21.732">       *aDone = true;</span>
<a href="#l21.733"></a><span id="l21.733">       return rv;</span>
<a href="#l21.734"></a><span id="l21.734">     }</span>
<a href="#l21.735"></a><span id="l21.735">   }</span>
<a href="#l21.736"></a><span id="l21.736">   *aDone = false;</span>
<a href="#l21.737"></a><span id="l21.737">   return rv;</span>
<a href="#l21.738"></a><span id="l21.738"> }</span>
<a href="#l21.739"></a><span id="l21.739"> </span>
<a href="#l21.740"></a><span id="l21.740" class="difflineminus">-void</span>
<a href="#l21.741"></a><span id="l21.741" class="difflineminus">-nsMsgSearchSession::EnableFolderNotifications(bool aEnable)</span>
<a href="#l21.742"></a><span id="l21.742" class="difflineminus">-{</span>
<a href="#l21.743"></a><span id="l21.743" class="difflineplus">+void nsMsgSearchSession::EnableFolderNotifications(bool aEnable) {</span>
<a href="#l21.744"></a><span id="l21.744">   nsMsgSearchScopeTerm *scope = GetRunningScope();</span>
<a href="#l21.745"></a><span id="l21.745" class="difflineminus">-  if (scope)</span>
<a href="#l21.746"></a><span id="l21.746" class="difflineminus">-  {</span>
<a href="#l21.747"></a><span id="l21.747" class="difflineplus">+  if (scope) {</span>
<a href="#l21.748"></a><span id="l21.748">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l21.749"></a><span id="l21.749">     scope-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l21.750"></a><span id="l21.750" class="difflineminus">-    if (folder)  //enable msg count notifications</span>
<a href="#l21.751"></a><span id="l21.751" class="difflineminus">-      folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, aEnable);</span>
<a href="#l21.752"></a><span id="l21.752" class="difflineplus">+    if (folder)  // enable msg count notifications</span>
<a href="#l21.753"></a><span id="l21.753" class="difflineplus">+      folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span>
<a href="#l21.754"></a><span id="l21.754" class="difflineplus">+                                  aEnable);</span>
<a href="#l21.755"></a><span id="l21.755">   }</span>
<a href="#l21.756"></a><span id="l21.756"> }</span>
<a href="#l21.757"></a><span id="l21.757"> </span>
<a href="#l21.758"></a><span id="l21.758" class="difflineminus">-//this method is used for adding new hdrs to quick search view</span>
<a href="#l21.759"></a><span id="l21.759" class="difflineplus">+// this method is used for adding new hdrs to quick search view</span>
<a href="#l21.760"></a><span id="l21.760"> NS_IMETHODIMP</span>
<a href="#l21.761"></a><span id="l21.761" class="difflineminus">-nsMsgSearchSession::MatchHdr(nsIMsgDBHdr *aMsgHdr, nsIMsgDatabase *aDatabase, bool *aResult)</span>
<a href="#l21.762"></a><span id="l21.762" class="difflineminus">-{</span>
<a href="#l21.763"></a><span id="l21.763" class="difflineplus">+nsMsgSearchSession::MatchHdr(nsIMsgDBHdr *aMsgHdr, nsIMsgDatabase *aDatabase,</span>
<a href="#l21.764"></a><span id="l21.764" class="difflineplus">+                             bool *aResult) {</span>
<a href="#l21.765"></a><span id="l21.765">   nsMsgSearchScopeTerm *scope = m_scopeList.SafeElementAt(0, nullptr);</span>
<a href="#l21.766"></a><span id="l21.766" class="difflineminus">-  if (scope)</span>
<a href="#l21.767"></a><span id="l21.767" class="difflineminus">-  {</span>
<a href="#l21.768"></a><span id="l21.768" class="difflineminus">-    if (!scope-&gt;m_adapter)</span>
<a href="#l21.769"></a><span id="l21.769" class="difflineminus">-      scope-&gt;InitializeAdapter(m_termList);</span>
<a href="#l21.770"></a><span id="l21.770" class="difflineminus">-    if (scope-&gt;m_adapter)</span>
<a href="#l21.771"></a><span id="l21.771" class="difflineminus">-    {</span>
<a href="#l21.772"></a><span id="l21.772" class="difflineplus">+  if (scope) {</span>
<a href="#l21.773"></a><span id="l21.773" class="difflineplus">+    if (!scope-&gt;m_adapter) scope-&gt;InitializeAdapter(m_termList);</span>
<a href="#l21.774"></a><span id="l21.774" class="difflineplus">+    if (scope-&gt;m_adapter) {</span>
<a href="#l21.775"></a><span id="l21.775">       nsAutoString nullCharset, folderCharset;</span>
<a href="#l21.776"></a><span id="l21.776">       scope-&gt;m_adapter-&gt;GetSearchCharsets(nullCharset, folderCharset);</span>
<a href="#l21.777"></a><span id="l21.777">       NS_ConvertUTF16toUTF8 charset(folderCharset.get());</span>
<a href="#l21.778"></a><span id="l21.778" class="difflineminus">-      nsMsgSearchOfflineMail::MatchTermsForSearch(aMsgHdr, m_termList,</span>
<a href="#l21.779"></a><span id="l21.779" class="difflineminus">-        charset.get(), scope, aDatabase, &amp;m_expressionTree, aResult);</span>
<a href="#l21.780"></a><span id="l21.780" class="difflineplus">+      nsMsgSearchOfflineMail::MatchTermsForSearch(</span>
<a href="#l21.781"></a><span id="l21.781" class="difflineplus">+          aMsgHdr, m_termList, charset.get(), scope, aDatabase,</span>
<a href="#l21.782"></a><span id="l21.782" class="difflineplus">+          &amp;m_expressionTree, aResult);</span>
<a href="#l21.783"></a><span id="l21.783">     }</span>
<a href="#l21.784"></a><span id="l21.784">   }</span>
<a href="#l21.785"></a><span id="l21.785">   return NS_OK;</span>
<a href="#l21.786"></a><span id="l21.786"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchSession.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchSession.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -16,46 +16,47 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> class nsMsgSearchAdapter;</span>
<a href="#l22.9"></a><span id="l22.9"> class nsMsgSearchBoolExpression;</span>
<a href="#l22.10"></a><span id="l22.10"> class nsMsgSearchScopeTerm;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-class nsMsgSearchSession : public nsIMsgSearchSession, public nsIUrlListener, public nsSupportsWeakReference</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-public:</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+class nsMsgSearchSession : public nsIMsgSearchSession,</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+                           public nsIUrlListener,</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+                           public nsSupportsWeakReference {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+ public:</span>
<a href="#l22.19"></a><span id="l22.19">   NS_DECL_ISUPPORTS</span>
<a href="#l22.20"></a><span id="l22.20">   NS_DECL_NSIMSGSEARCHSESSION</span>
<a href="#l22.21"></a><span id="l22.21">   NS_DECL_NSIURLLISTENER</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23">   nsMsgSearchSession();</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-protected:</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+ protected:</span>
<a href="#l22.27"></a><span id="l22.27">   virtual ~nsMsgSearchSession();</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">   nsWeakPtr m_msgWindowWeak;</span>
<a href="#l22.30"></a><span id="l22.30">   nsresult Initialize();</span>
<a href="#l22.31"></a><span id="l22.31">   nsresult StartTimer();</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  nsresult TimeSlice (bool *aDone);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  nsresult TimeSlice(bool *aDone);</span>
<a href="#l22.34"></a><span id="l22.34">   nsMsgSearchScopeTerm *GetRunningScope();</span>
<a href="#l22.35"></a><span id="l22.35">   void StopRunning();</span>
<a href="#l22.36"></a><span id="l22.36">   nsresult BeginSearching();</span>
<a href="#l22.37"></a><span id="l22.37">   nsresult DoNextSearch();</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-  nsresult SearchWOUrls ();</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+  nsresult SearchWOUrls();</span>
<a href="#l22.40"></a><span id="l22.40">   nsresult GetNextUrl();</span>
<a href="#l22.41"></a><span id="l22.41">   nsresult NotifyListenersDone(nsresult status);</span>
<a href="#l22.42"></a><span id="l22.42">   void EnableFolderNotifications(bool aEnable);</span>
<a href="#l22.43"></a><span id="l22.43">   void ReleaseFolderDBRef();</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45">   nsTArray&lt;RefPtr&lt;nsMsgSearchScopeTerm&gt;&gt; m_scopeList;</span>
<a href="#l22.46"></a><span id="l22.46">   nsCOMPtr&lt;nsIMutableArray&gt; m_termList;</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-  nsTArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt; &gt; m_listenerList;</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+  nsTArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt;&gt; m_listenerList;</span>
<a href="#l22.50"></a><span id="l22.50">   nsTArray&lt;int32_t&gt; m_listenerFlagList;</span>
<a href="#l22.51"></a><span id="l22.51">   /**</span>
<a href="#l22.52"></a><span id="l22.52">    * Iterator index for m_listenerList/m_listenerFlagList.  We used to use an</span>
<a href="#l22.53"></a><span id="l22.53">    * nsTObserverArray for m_listenerList but its auto-adjusting iterator was</span>
<a href="#l22.54"></a><span id="l22.54">    * not helping us keep our m_listenerFlagList iterator correct.</span>
<a href="#l22.55"></a><span id="l22.55">    *</span>
<a href="#l22.56"></a><span id="l22.56">    * We are making the simplifying assumption that our notifications are</span>
<a href="#l22.57"></a><span id="l22.57">    * non-reentrant.  In the exceptional case that it turns out they are</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineat">@@ -65,26 +66,26 @@ protected:</span>
<a href="#l22.59"></a><span id="l22.59">    *</span>
<a href="#l22.60"></a><span id="l22.60">    * This value is defined to be the index of the next listener we will process.</span>
<a href="#l22.61"></a><span id="l22.61">    * This allows us to use the sentinel value of -1 to convey that no iteration</span>
<a href="#l22.62"></a><span id="l22.62">    * is in progress (and the iteration process to abort if the value transitions</span>
<a href="#l22.63"></a><span id="l22.63">    * to -1, which we always set on conclusion of our loop).</span>
<a href="#l22.64"></a><span id="l22.64">    */</span>
<a href="#l22.65"></a><span id="l22.65">   int32_t m_iListener;</span>
<a href="#l22.66"></a><span id="l22.66"> </span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-  void DestroyTermList ();</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-  void DestroyScopeList ();</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+  void DestroyTermList();</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+  void DestroyScopeList();</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72">   static void TimerCallback(nsITimer *aTimer, void *aClosure);</span>
<a href="#l22.73"></a><span id="l22.73">   // support for searching multiple scopes in serial</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-  nsresult TimeSliceSerial (bool *aDone);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-  nsresult TimeSliceParallel ();</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+  nsresult TimeSliceSerial(bool *aDone);</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  nsresult TimeSliceParallel();</span>
<a href="#l22.78"></a><span id="l22.78"> </span>
<a href="#l22.79"></a><span id="l22.79">   nsMsgSearchAttribValue m_sortAttribute;</span>
<a href="#l22.80"></a><span id="l22.80">   uint32_t m_idxRunningScope;</span>
<a href="#l22.81"></a><span id="l22.81">   bool m_handlingError;</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-  nsCString m_runningUrl;     // The url for the current search</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-  nsCOMPtr &lt;nsITimer&gt; m_backgroundTimer;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+  nsCString m_runningUrl;  // The url for the current search</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+  nsCOMPtr&lt;nsITimer&gt; m_backgroundTimer;</span>
<a href="#l22.86"></a><span id="l22.86">   bool m_searchPaused;</span>
<a href="#l22.87"></a><span id="l22.87">   nsMsgSearchBoolExpression *m_expressionTree;</span>
<a href="#l22.88"></a><span id="l22.88"> };</span>
<a href="#l22.89"></a><span id="l22.89"> </span>
<a href="#l22.90"></a><span id="l22.90"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -45,130 +45,121 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> using namespace mozilla::mailnews;</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> //---------------------------------------------------------------------------</span>
<a href="#l23.9"></a><span id="l23.9"> // nsMsgSearchTerm specifies one criterion, e.g. name contains phil</span>
<a href="#l23.10"></a><span id="l23.10"> //---------------------------------------------------------------------------</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-</span>
<a href="#l23.13"></a><span id="l23.13"> //-----------------------------------------------------------------------------</span>
<a href="#l23.14"></a><span id="l23.14"> //-------------------- Implementation of nsMsgSearchTerm -----------------------</span>
<a href="#l23.15"></a><span id="l23.15"> //-----------------------------------------------------------------------------</span>
<a href="#l23.16"></a><span id="l23.16"> #define MAILNEWS_CUSTOM_HEADERS &quot;mailnews.customHeaders&quot;</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-typedef struct</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-{</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-  nsMsgSearchAttribValue  attrib;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-  const char      *attribName;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+typedef struct {</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+  nsMsgSearchAttribValue attrib;</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+  const char *attribName;</span>
<a href="#l23.25"></a><span id="l23.25"> } nsMsgSearchAttribEntry;</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-nsMsgSearchAttribEntry SearchAttribEntryTable[] =</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-{</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-    {nsMsgSearchAttrib::Subject,    &quot;subject&quot;},</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    {nsMsgSearchAttrib::Sender,     &quot;from&quot;},</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    {nsMsgSearchAttrib::Body,       &quot;body&quot;},</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-    {nsMsgSearchAttrib::Date,       &quot;date&quot;},</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-    {nsMsgSearchAttrib::Priority,   &quot;priority&quot;},</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    {nsMsgSearchAttrib::MsgStatus,  &quot;status&quot;},</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-    {nsMsgSearchAttrib::To,         &quot;to&quot;},</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-    {nsMsgSearchAttrib::CC,         &quot;cc&quot;},</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-    {nsMsgSearchAttrib::ToOrCC,     &quot;to or cc&quot;},</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+nsMsgSearchAttribEntry SearchAttribEntryTable[] = {</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+    {nsMsgSearchAttrib::Subject, &quot;subject&quot;},</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+    {nsMsgSearchAttrib::Sender, &quot;from&quot;},</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+    {nsMsgSearchAttrib::Body, &quot;body&quot;},</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+    {nsMsgSearchAttrib::Date, &quot;date&quot;},</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+    {nsMsgSearchAttrib::Priority, &quot;priority&quot;},</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+    {nsMsgSearchAttrib::MsgStatus, &quot;status&quot;},</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+    {nsMsgSearchAttrib::To, &quot;to&quot;},</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+    {nsMsgSearchAttrib::CC, &quot;cc&quot;},</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+    {nsMsgSearchAttrib::ToOrCC, &quot;to or cc&quot;},</span>
<a href="#l23.48"></a><span id="l23.48">     {nsMsgSearchAttrib::AllAddresses, &quot;all addresses&quot;},</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-    {nsMsgSearchAttrib::AgeInDays,  &quot;age in days&quot;},</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    {nsMsgSearchAttrib::Label,      &quot;label&quot;},</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-    {nsMsgSearchAttrib::Keywords,   &quot;tag&quot;},</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-    {nsMsgSearchAttrib::Size,       &quot;size&quot;},</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+    {nsMsgSearchAttrib::AgeInDays, &quot;age in days&quot;},</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+    {nsMsgSearchAttrib::Label, &quot;label&quot;},</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    {nsMsgSearchAttrib::Keywords, &quot;tag&quot;},</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+    {nsMsgSearchAttrib::Size, &quot;size&quot;},</span>
<a href="#l23.57"></a><span id="l23.57">     // this used to be nsMsgSearchAttrib::SenderInAddressBook</span>
<a href="#l23.58"></a><span id="l23.58">     // we used to have two Sender menuitems</span>
<a href="#l23.59"></a><span id="l23.59">     // for backward compatibility, we can still parse</span>
<a href="#l23.60"></a><span id="l23.60">     // the old style.  see bug #179803</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-    {nsMsgSearchAttrib::Sender,     &quot;from in ab&quot;},</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+    {nsMsgSearchAttrib::Sender, &quot;from in ab&quot;},</span>
<a href="#l23.63"></a><span id="l23.63">     {nsMsgSearchAttrib::JunkStatus, &quot;junk status&quot;},</span>
<a href="#l23.64"></a><span id="l23.64">     {nsMsgSearchAttrib::JunkPercent, &quot;junk percent&quot;},</span>
<a href="#l23.65"></a><span id="l23.65">     {nsMsgSearchAttrib::JunkScoreOrigin, &quot;junk score origin&quot;},</span>
<a href="#l23.66"></a><span id="l23.66">     {nsMsgSearchAttrib::HasAttachmentStatus, &quot;has attachment status&quot;},</span>
<a href="#l23.67"></a><span id="l23.67"> };</span>
<a href="#l23.68"></a><span id="l23.68"> </span>
<a href="#l23.69"></a><span id="l23.69"> static const unsigned int sNumSearchAttribEntryTable =</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-  MOZ_ARRAY_LENGTH(SearchAttribEntryTable);</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+    MOZ_ARRAY_LENGTH(SearchAttribEntryTable);</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73"> // Take a string which starts off with an attribute</span>
<a href="#l23.74"></a><span id="l23.74"> // and return the matching attribute. If the string is not in the table, and it</span>
<a href="#l23.75"></a><span id="l23.75"> // begins with a quote, then we can conclude that it is an arbitrary header.</span>
<a href="#l23.76"></a><span id="l23.76"> // Otherwise if not in the table, it is the id for a custom search term.</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-nsresult NS_MsgGetAttributeFromString(const char *string, nsMsgSearchAttribValue *attrib,</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-                                      nsACString &amp;aCustomId)</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-{</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+nsresult NS_MsgGetAttributeFromString(const char *string,</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+                                      nsMsgSearchAttribValue *attrib,</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+                                      nsACString &amp;aCustomId) {</span>
<a href="#l23.83"></a><span id="l23.83">   NS_ENSURE_ARG_POINTER(string);</span>
<a href="#l23.84"></a><span id="l23.84">   NS_ENSURE_ARG_POINTER(attrib);</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86">   bool found = false;</span>
<a href="#l23.87"></a><span id="l23.87">   bool isArbitraryHeader = false;</span>
<a href="#l23.88"></a><span id="l23.88">   // arbitrary headers have a leading quote</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-  if (*string != '&quot;')</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-  {</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-    for (unsigned int idxAttrib = 0; idxAttrib &lt; sNumSearchAttribEntryTable; idxAttrib++)</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-    {</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-      if (!PL_strcasecmp(string, SearchAttribEntryTable[idxAttrib].attribName))</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-      {</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+  if (*string != '&quot;') {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+    for (unsigned int idxAttrib = 0; idxAttrib &lt; sNumSearchAttribEntryTable;</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+         idxAttrib++) {</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+      if (!PL_strcasecmp(string,</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+                         SearchAttribEntryTable[idxAttrib].attribName)) {</span>
<a href="#l23.100"></a><span id="l23.100">         found = true;</span>
<a href="#l23.101"></a><span id="l23.101">         *attrib = SearchAttribEntryTable[idxAttrib].attrib;</span>
<a href="#l23.102"></a><span id="l23.102">         break;</span>
<a href="#l23.103"></a><span id="l23.103">       }</span>
<a href="#l23.104"></a><span id="l23.104">     }</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-  }</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-  else // remove the leading quote</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+  } else  // remove the leading quote</span>
<a href="#l23.108"></a><span id="l23.108">   {</span>
<a href="#l23.109"></a><span id="l23.109">     string++;</span>
<a href="#l23.110"></a><span id="l23.110">     isArbitraryHeader = true;</span>
<a href="#l23.111"></a><span id="l23.111">   }</span>
<a href="#l23.112"></a><span id="l23.112"> </span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-  if (!found &amp;&amp; !isArbitraryHeader)</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-  {</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+  if (!found &amp;&amp; !isArbitraryHeader) {</span>
<a href="#l23.116"></a><span id="l23.116">     // must be a custom attribute</span>
<a href="#l23.117"></a><span id="l23.117">     *attrib = nsMsgSearchAttrib::Custom;</span>
<a href="#l23.118"></a><span id="l23.118">     aCustomId.Assign(string);</span>
<a href="#l23.119"></a><span id="l23.119">     return NS_OK;</span>
<a href="#l23.120"></a><span id="l23.120">   }</span>
<a href="#l23.121"></a><span id="l23.121"> </span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-  if (!found)</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-  {</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+  if (!found) {</span>
<a href="#l23.125"></a><span id="l23.125">     nsresult rv;</span>
<a href="#l23.126"></a><span id="l23.126">     bool goodHdr;</span>
<a href="#l23.127"></a><span id="l23.127">     IsRFC822HeaderFieldName(string, &amp;goodHdr);</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-    if (!goodHdr)</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-      return NS_MSG_INVALID_CUSTOM_HEADER;</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-    //49 is for showing customize... in ui, headers start from 50 onwards up until 99.</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-    *attrib = nsMsgSearchAttrib::OtherHeader+1;</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+    if (!goodHdr) return NS_MSG_INVALID_CUSTOM_HEADER;</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+    // 49 is for showing customize... in ui, headers start from 50 onwards up</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+    // until 99.</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+    *attrib = nsMsgSearchAttrib::OtherHeader + 1;</span>
<a href="#l23.136"></a><span id="l23.136"> </span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefService = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+    nsCOMPtr&lt;nsIPrefService&gt; prefService =</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l23.140"></a><span id="l23.140">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.141"></a><span id="l23.141"> </span>
<a href="#l23.142"></a><span id="l23.142">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l23.143"></a><span id="l23.143">     rv = prefService-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l23.144"></a><span id="l23.144">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146">     nsCString headers;</span>
<a href="#l23.147"></a><span id="l23.147">     prefBranch-&gt;GetCharPref(MAILNEWS_CUSTOM_HEADERS, headers);</span>
<a href="#l23.148"></a><span id="l23.148"> </span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-    if (!headers.IsEmpty())</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-    {</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+    if (!headers.IsEmpty()) {</span>
<a href="#l23.152"></a><span id="l23.152">       nsAutoCString hdrStr(headers);</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-      hdrStr.StripWhitespace();  //remove whitespace before parsing</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+      hdrStr.StripWhitespace();  // remove whitespace before parsing</span>
<a href="#l23.155"></a><span id="l23.155"> </span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-      char *newStr= hdrStr.BeginWriting();</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+      char *newStr = hdrStr.BeginWriting();</span>
<a href="#l23.158"></a><span id="l23.158">       char *token = NS_strtok(&quot;:&quot;, &amp;newStr);</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-      uint32_t i=0;</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-      while (token)</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-      {</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-        if (PL_strcasecmp(token, string) == 0)</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-        {</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-          *attrib += i; //we found custom header in the pref</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+      uint32_t i = 0;</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+      while (token) {</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineplus">+        if (PL_strcasecmp(token, string) == 0) {</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineplus">+          *attrib += i;  // we found custom header in the pref</span>
<a href="#l23.169"></a><span id="l23.169">           found = true;</span>
<a href="#l23.170"></a><span id="l23.170">           break;</span>
<a href="#l23.171"></a><span id="l23.171">         }</span>
<a href="#l23.172"></a><span id="l23.172">         token = NS_strtok(&quot;:&quot;, &amp;newStr);</span>
<a href="#l23.173"></a><span id="l23.173">         i++;</span>
<a href="#l23.174"></a><span id="l23.174">       }</span>
<a href="#l23.175"></a><span id="l23.175">     }</span>
<a href="#l23.176"></a><span id="l23.176">   }</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineat">@@ -177,396 +168,332 @@ nsresult NS_MsgGetAttributeFromString(co</span>
<a href="#l23.178"></a><span id="l23.178">   // in case it's a client side spam filter description filter,</span>
<a href="#l23.179"></a><span id="l23.179">   // which doesn't add its headers to mailnews.customMailHeaders.</span>
<a href="#l23.180"></a><span id="l23.180">   // We've already checked that it's a valid header and returned</span>
<a href="#l23.181"></a><span id="l23.181">   // an error if so.</span>
<a href="#l23.182"></a><span id="l23.182"> </span>
<a href="#l23.183"></a><span id="l23.183">   return NS_OK;</span>
<a href="#l23.184"></a><span id="l23.184"> }</span>
<a href="#l23.185"></a><span id="l23.185"> </span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::GetAttributeFromString(const char *aString,</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-                                                      nsMsgSearchAttribValue *aAttrib)</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-{</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::GetAttributeFromString(</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+    const char *aString, nsMsgSearchAttribValue *aAttrib) {</span>
<a href="#l23.191"></a><span id="l23.191">   nsAutoCString customId;</span>
<a href="#l23.192"></a><span id="l23.192">   return NS_MsgGetAttributeFromString(aString, aAttrib, customId);</span>
<a href="#l23.193"></a><span id="l23.193"> }</span>
<a href="#l23.194"></a><span id="l23.194"> </span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-nsresult NS_MsgGetStringForAttribute(int16_t attrib, const char **string)</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-{</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+nsresult NS_MsgGetStringForAttribute(int16_t attrib, const char **string) {</span>
<a href="#l23.198"></a><span id="l23.198">   NS_ENSURE_ARG_POINTER(string);</span>
<a href="#l23.199"></a><span id="l23.199"> </span>
<a href="#l23.200"></a><span id="l23.200">   bool found = false;</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-  for (unsigned int idxAttrib = 0; idxAttrib &lt; sNumSearchAttribEntryTable; idxAttrib++)</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineminus">-  {</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineplus">+  for (unsigned int idxAttrib = 0; idxAttrib &lt; sNumSearchAttribEntryTable;</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineplus">+       idxAttrib++) {</span>
<a href="#l23.205"></a><span id="l23.205">     // I'm using the idx's as aliases into MSG_SearchAttribute and</span>
<a href="#l23.206"></a><span id="l23.206">     // MSG_SearchOperator enums which is legal because of the way the</span>
<a href="#l23.207"></a><span id="l23.207">     // enums are defined (starts at 0, numItems at end)</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-    if (attrib == SearchAttribEntryTable[idxAttrib].attrib)</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-    {</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineplus">+    if (attrib == SearchAttribEntryTable[idxAttrib].attrib) {</span>
<a href="#l23.211"></a><span id="l23.211">       found = true;</span>
<a href="#l23.212"></a><span id="l23.212">       *string = SearchAttribEntryTable[idxAttrib].attribName;</span>
<a href="#l23.213"></a><span id="l23.213">       break;</span>
<a href="#l23.214"></a><span id="l23.214">     }</span>
<a href="#l23.215"></a><span id="l23.215">   }</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineminus">-  if (!found)</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-    *string = &quot;&quot;; // don't leave the string uninitialized</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+  if (!found) *string = &quot;&quot;;  // don't leave the string uninitialized</span>
<a href="#l23.219"></a><span id="l23.219"> </span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-  // we no longer return invalid attribute. If we cannot find the string in the table,</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-  // then it is an arbitrary header. Return success regardless if found or not</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+  // we no longer return invalid attribute. If we cannot find the string in the</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+  // table, then it is an arbitrary header. Return success regardless if found</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineplus">+  // or not</span>
<a href="#l23.225"></a><span id="l23.225">   return NS_OK;</span>
<a href="#l23.226"></a><span id="l23.226"> }</span>
<a href="#l23.227"></a><span id="l23.227"> </span>
<a href="#l23.228"></a><span id="l23.228" class="difflineminus">-typedef struct</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-{</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-  nsMsgSearchOpValue  op;</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-  const char      *opName;</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+typedef struct {</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineplus">+  nsMsgSearchOpValue op;</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineplus">+  const char *opName;</span>
<a href="#l23.235"></a><span id="l23.235"> } nsMsgSearchOperatorEntry;</span>
<a href="#l23.236"></a><span id="l23.236"> </span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-nsMsgSearchOperatorEntry SearchOperatorEntryTable[] =</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-{</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-  {nsMsgSearchOp::Contains, &quot;contains&quot;},</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-  {nsMsgSearchOp::DoesntContain,&quot;doesn't contain&quot;},</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-  {nsMsgSearchOp::Is,&quot;is&quot;},</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-  {nsMsgSearchOp::Isnt,  &quot;isn't&quot;},</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-  {nsMsgSearchOp::IsEmpty, &quot;is empty&quot;},</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-  {nsMsgSearchOp::IsntEmpty, &quot;isn't empty&quot;},</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineminus">-  {nsMsgSearchOp::IsBefore, &quot;is before&quot;},</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-  {nsMsgSearchOp::IsAfter, &quot;is after&quot;},</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-  {nsMsgSearchOp::IsHigherThan, &quot;is higher than&quot;},</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-  {nsMsgSearchOp::IsLowerThan, &quot;is lower than&quot;},</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-  {nsMsgSearchOp::BeginsWith, &quot;begins with&quot;},</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-  {nsMsgSearchOp::EndsWith, &quot;ends with&quot;},</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-  {nsMsgSearchOp::IsInAB, &quot;is in ab&quot;},</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-  {nsMsgSearchOp::IsntInAB, &quot;isn't in ab&quot;},</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-  {nsMsgSearchOp::IsGreaterThan, &quot;is greater than&quot;},</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-  {nsMsgSearchOp::IsLessThan, &quot;is less than&quot;},</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-  {nsMsgSearchOp::Matches, &quot;matches&quot;},</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-  {nsMsgSearchOp::DoesntMatch, &quot;doesn't match&quot;}</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-};</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineplus">+nsMsgSearchOperatorEntry SearchOperatorEntryTable[] = {</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineplus">+    {nsMsgSearchOp::Contains, &quot;contains&quot;},</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+    {nsMsgSearchOp::DoesntContain, &quot;doesn't contain&quot;},</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineplus">+    {nsMsgSearchOp::Is, &quot;is&quot;},</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+    {nsMsgSearchOp::Isnt, &quot;isn't&quot;},</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+    {nsMsgSearchOp::IsEmpty, &quot;is empty&quot;},</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+    {nsMsgSearchOp::IsntEmpty, &quot;isn't empty&quot;},</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineplus">+    {nsMsgSearchOp::IsBefore, &quot;is before&quot;},</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineplus">+    {nsMsgSearchOp::IsAfter, &quot;is after&quot;},</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineplus">+    {nsMsgSearchOp::IsHigherThan, &quot;is higher than&quot;},</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineplus">+    {nsMsgSearchOp::IsLowerThan, &quot;is lower than&quot;},</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+    {nsMsgSearchOp::BeginsWith, &quot;begins with&quot;},</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineplus">+    {nsMsgSearchOp::EndsWith, &quot;ends with&quot;},</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineplus">+    {nsMsgSearchOp::IsInAB, &quot;is in ab&quot;},</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineplus">+    {nsMsgSearchOp::IsntInAB, &quot;isn't in ab&quot;},</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineplus">+    {nsMsgSearchOp::IsGreaterThan, &quot;is greater than&quot;},</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineplus">+    {nsMsgSearchOp::IsLessThan, &quot;is less than&quot;},</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineplus">+    {nsMsgSearchOp::Matches, &quot;matches&quot;},</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineplus">+    {nsMsgSearchOp::DoesntMatch, &quot;doesn't match&quot;}};</span>
<a href="#l23.277"></a><span id="l23.277"> </span>
<a href="#l23.278"></a><span id="l23.278"> static const unsigned int sNumSearchOperatorEntryTable =</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-  MOZ_ARRAY_LENGTH(SearchOperatorEntryTable);</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineplus">+    MOZ_ARRAY_LENGTH(SearchOperatorEntryTable);</span>
<a href="#l23.281"></a><span id="l23.281"> </span>
<a href="#l23.282"></a><span id="l23.282" class="difflineminus">-nsresult NS_MsgGetOperatorFromString(const char *string, int16_t *op)</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineminus">-{</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineplus">+nsresult NS_MsgGetOperatorFromString(const char *string, int16_t *op) {</span>
<a href="#l23.285"></a><span id="l23.285">   NS_ENSURE_ARG_POINTER(string);</span>
<a href="#l23.286"></a><span id="l23.286">   NS_ENSURE_ARG_POINTER(op);</span>
<a href="#l23.287"></a><span id="l23.287"> </span>
<a href="#l23.288"></a><span id="l23.288">   bool found = false;</span>
<a href="#l23.289"></a><span id="l23.289" class="difflineminus">-  for (unsigned int idxOp = 0; idxOp &lt; sNumSearchOperatorEntryTable; idxOp++)</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-  {</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineplus">+  for (unsigned int idxOp = 0; idxOp &lt; sNumSearchOperatorEntryTable; idxOp++) {</span>
<a href="#l23.292"></a><span id="l23.292">     // I'm using the idx's as aliases into MSG_SearchAttribute and</span>
<a href="#l23.293"></a><span id="l23.293">     // MSG_SearchOperator enums which is legal because of the way the</span>
<a href="#l23.294"></a><span id="l23.294">     // enums are defined (starts at 0, numItems at end)</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-    if (!PL_strcasecmp(string, SearchOperatorEntryTable[idxOp].opName))</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineminus">-    {</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineplus">+    if (!PL_strcasecmp(string, SearchOperatorEntryTable[idxOp].opName)) {</span>
<a href="#l23.298"></a><span id="l23.298">       found = true;</span>
<a href="#l23.299"></a><span id="l23.299">       *op = SearchOperatorEntryTable[idxOp].op;</span>
<a href="#l23.300"></a><span id="l23.300">       break;</span>
<a href="#l23.301"></a><span id="l23.301">     }</span>
<a href="#l23.302"></a><span id="l23.302">   }</span>
<a href="#l23.303"></a><span id="l23.303">   return (found) ? NS_OK : NS_ERROR_INVALID_ARG;</span>
<a href="#l23.304"></a><span id="l23.304"> }</span>
<a href="#l23.305"></a><span id="l23.305"> </span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-nsresult NS_MsgGetStringForOperator(int16_t op, const char **string)</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-{</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineplus">+nsresult NS_MsgGetStringForOperator(int16_t op, const char **string) {</span>
<a href="#l23.309"></a><span id="l23.309">   NS_ENSURE_ARG_POINTER(string);</span>
<a href="#l23.310"></a><span id="l23.310"> </span>
<a href="#l23.311"></a><span id="l23.311">   bool found = false;</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineminus">-  for (unsigned int idxOp = 0; idxOp &lt; sNumSearchOperatorEntryTable; idxOp++)</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-  {</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineplus">+  for (unsigned int idxOp = 0; idxOp &lt; sNumSearchOperatorEntryTable; idxOp++) {</span>
<a href="#l23.315"></a><span id="l23.315">     // I'm using the idx's as aliases into MSG_SearchAttribute and</span>
<a href="#l23.316"></a><span id="l23.316">     // MSG_SearchOperator enums which is legal because of the way the</span>
<a href="#l23.317"></a><span id="l23.317">     // enums are defined (starts at 0, numItems at end)</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineminus">-    if (op == SearchOperatorEntryTable[idxOp].op)</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineminus">-    {</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineplus">+    if (op == SearchOperatorEntryTable[idxOp].op) {</span>
<a href="#l23.321"></a><span id="l23.321">       found = true;</span>
<a href="#l23.322"></a><span id="l23.322">       *string = SearchOperatorEntryTable[idxOp].opName;</span>
<a href="#l23.323"></a><span id="l23.323">       break;</span>
<a href="#l23.324"></a><span id="l23.324">     }</span>
<a href="#l23.325"></a><span id="l23.325">   }</span>
<a href="#l23.326"></a><span id="l23.326"> </span>
<a href="#l23.327"></a><span id="l23.327">   return (found) ? NS_OK : NS_ERROR_INVALID_ARG;</span>
<a href="#l23.328"></a><span id="l23.328"> }</span>
<a href="#l23.329"></a><span id="l23.329"> </span>
<a href="#l23.330"></a><span id="l23.330" class="difflineminus">-void NS_MsgGetUntranslatedStatusName (uint32_t s, nsCString *outName)</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-{</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineplus">+void NS_MsgGetUntranslatedStatusName(uint32_t s, nsCString *outName) {</span>
<a href="#l23.333"></a><span id="l23.333">   const char *tmpOutName = NULL;</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineminus">-#define MSG_STATUS_MASK (nsMsgMessageFlags::Read | nsMsgMessageFlags::Replied |\</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineminus">-  nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::New | nsMsgMessageFlags::Marked)</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineplus">+#define MSG_STATUS_MASK                                    \</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineplus">+  (nsMsgMessageFlags::Read | nsMsgMessageFlags::Replied |  \</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineplus">+   nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::New | \</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineplus">+   nsMsgMessageFlags::Marked)</span>
<a href="#l23.340"></a><span id="l23.340">   uint32_t maskOut = (s &amp; MSG_STATUS_MASK);</span>
<a href="#l23.341"></a><span id="l23.341"> </span>
<a href="#l23.342"></a><span id="l23.342" class="difflineminus">-  // diddle the flags to pay attention to the most important ones first, if multiple</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineminus">-  // flags are set. Should remove this code from the winfe.</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineminus">-  if (maskOut &amp; nsMsgMessageFlags::New)</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineminus">-    maskOut = nsMsgMessageFlags::New;</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineplus">+  // diddle the flags to pay attention to the most important ones first, if</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineplus">+  // multiple flags are set. Should remove this code from the winfe.</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineplus">+  if (maskOut &amp; nsMsgMessageFlags::New) maskOut = nsMsgMessageFlags::New;</span>
<a href="#l23.349"></a><span id="l23.349">   if (maskOut &amp; nsMsgMessageFlags::Replied &amp;&amp;</span>
<a href="#l23.350"></a><span id="l23.350">       maskOut &amp; nsMsgMessageFlags::Forwarded)</span>
<a href="#l23.351"></a><span id="l23.351">     maskOut = nsMsgMessageFlags::Replied | nsMsgMessageFlags::Forwarded;</span>
<a href="#l23.352"></a><span id="l23.352">   else if (maskOut &amp; nsMsgMessageFlags::Forwarded)</span>
<a href="#l23.353"></a><span id="l23.353">     maskOut = nsMsgMessageFlags::Forwarded;</span>
<a href="#l23.354"></a><span id="l23.354">   else if (maskOut &amp; nsMsgMessageFlags::Replied)</span>
<a href="#l23.355"></a><span id="l23.355">     maskOut = nsMsgMessageFlags::Replied;</span>
<a href="#l23.356"></a><span id="l23.356"> </span>
<a href="#l23.357"></a><span id="l23.357" class="difflineminus">-  switch (maskOut)</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineminus">-  {</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineminus">-  case nsMsgMessageFlags::Read:</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineminus">-    tmpOutName = &quot;read&quot;;</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineminus">-    break;</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineminus">-  case nsMsgMessageFlags::Replied:</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineminus">-    tmpOutName = &quot;replied&quot;;</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineminus">-    break;</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineminus">-  case nsMsgMessageFlags::Forwarded:</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineminus">-    tmpOutName = &quot;forwarded&quot;;</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineminus">-    break;</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineminus">-  case nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::Replied:</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineminus">-    tmpOutName = &quot;replied and forwarded&quot;;</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineminus">-    break;</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineminus">-  case nsMsgMessageFlags::New:</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineminus">-    tmpOutName = &quot;new&quot;;</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineminus">-    break;</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineminus">-  case nsMsgMessageFlags::Marked:</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineminus">-    tmpOutName = &quot;flagged&quot;;</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineminus">-    break;</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineminus">-  default:</span>
<a href="#l23.378"></a><span id="l23.378" class="difflineminus">-    // This is fine, status may be &quot;unread&quot; for example</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineminus">-    break;</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineplus">+  switch (maskOut) {</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineplus">+    case nsMsgMessageFlags::Read:</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineplus">+      tmpOutName = &quot;read&quot;;</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineplus">+      break;</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineplus">+    case nsMsgMessageFlags::Replied:</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineplus">+      tmpOutName = &quot;replied&quot;;</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineplus">+      break;</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineplus">+    case nsMsgMessageFlags::Forwarded:</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineplus">+      tmpOutName = &quot;forwarded&quot;;</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineplus">+      break;</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineplus">+    case nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::Replied:</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineplus">+      tmpOutName = &quot;replied and forwarded&quot;;</span>
<a href="#l23.392"></a><span id="l23.392" class="difflineplus">+      break;</span>
<a href="#l23.393"></a><span id="l23.393" class="difflineplus">+    case nsMsgMessageFlags::New:</span>
<a href="#l23.394"></a><span id="l23.394" class="difflineplus">+      tmpOutName = &quot;new&quot;;</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineplus">+      break;</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineplus">+    case nsMsgMessageFlags::Marked:</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineplus">+      tmpOutName = &quot;flagged&quot;;</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineplus">+      break;</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineplus">+    default:</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineplus">+      // This is fine, status may be &quot;unread&quot; for example</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineplus">+      break;</span>
<a href="#l23.402"></a><span id="l23.402">   }</span>
<a href="#l23.403"></a><span id="l23.403"> </span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-  if (tmpOutName)</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-    *outName = tmpOutName;</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineplus">+  if (tmpOutName) *outName = tmpOutName;</span>
<a href="#l23.407"></a><span id="l23.407"> }</span>
<a href="#l23.408"></a><span id="l23.408"> </span>
<a href="#l23.409"></a><span id="l23.409" class="difflineminus">-</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-int32_t NS_MsgGetStatusValueFromName(char *name)</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-{</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineminus">-  if (!strcmp(&quot;read&quot;, name))</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-    return nsMsgMessageFlags::Read;</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-  if (!strcmp(&quot;replied&quot;, name))</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineminus">-    return nsMsgMessageFlags::Replied;</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineminus">-  if (!strcmp(&quot;forwarded&quot;, name))</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineminus">-    return nsMsgMessageFlags::Forwarded;</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+int32_t NS_MsgGetStatusValueFromName(char *name) {</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineplus">+  if (!strcmp(&quot;read&quot;, name)) return nsMsgMessageFlags::Read;</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineplus">+  if (!strcmp(&quot;replied&quot;, name)) return nsMsgMessageFlags::Replied;</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineplus">+  if (!strcmp(&quot;forwarded&quot;, name)) return nsMsgMessageFlags::Forwarded;</span>
<a href="#l23.422"></a><span id="l23.422">   if (!strcmp(&quot;replied and forwarded&quot;, name))</span>
<a href="#l23.423"></a><span id="l23.423">     return nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::Replied;</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineminus">-  if (!strcmp(&quot;new&quot;, name))</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineminus">-    return nsMsgMessageFlags::New;</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineminus">-  if (!strcmp(&quot;flagged&quot;, name))</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineminus">-    return nsMsgMessageFlags::Marked;</span>
<a href="#l23.428"></a><span id="l23.428" class="difflineplus">+  if (!strcmp(&quot;new&quot;, name)) return nsMsgMessageFlags::New;</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineplus">+  if (!strcmp(&quot;flagged&quot;, name)) return nsMsgMessageFlags::Marked;</span>
<a href="#l23.430"></a><span id="l23.430">   return 0;</span>
<a href="#l23.431"></a><span id="l23.431"> }</span>
<a href="#l23.432"></a><span id="l23.432"> </span>
<a href="#l23.433"></a><span id="l23.433" class="difflineplus">+// Needed for DeStream method.</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineplus">+nsMsgSearchTerm::nsMsgSearchTerm() {</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineplus">+  // initialize this to zero</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+  m_value.attribute = 0;</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineplus">+  m_value.u.priority = 0;</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineplus">+  m_attribute = nsMsgSearchAttrib::Default;</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineplus">+  m_operator = nsMsgSearchOp::Contains;</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineplus">+  mBeginsGrouping = false;</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineplus">+  mEndsGrouping = false;</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineplus">+  m_matchAll = false;</span>
<a href="#l23.443"></a><span id="l23.443"> </span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-// Needed for DeStream method.</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineminus">-nsMsgSearchTerm::nsMsgSearchTerm()</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineminus">-{</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineminus">-    // initialize this to zero</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">-    m_value.attribute=0;</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineminus">-    m_value.u.priority=0;</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineminus">-    m_attribute = nsMsgSearchAttrib::Default;</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">-    m_operator = nsMsgSearchOp::Contains;</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineminus">-    mBeginsGrouping = false;</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineminus">-    mEndsGrouping = false;</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineminus">-    m_matchAll = false;</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineminus">-</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineminus">-    // valgrind warning during GC/java data check suggests</span>
<a href="#l23.457"></a><span id="l23.457" class="difflineminus">-    // m_booleanp needs to be initialized too.</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineminus">-    m_booleanOp = nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineplus">+  // valgrind warning during GC/java data check suggests</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineplus">+  // m_booleanp needs to be initialized too.</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineplus">+  m_booleanOp = nsMsgSearchBooleanOp::BooleanAND;</span>
<a href="#l23.462"></a><span id="l23.462"> }</span>
<a href="#l23.463"></a><span id="l23.463"> </span>
<a href="#l23.464"></a><span id="l23.464" class="difflineminus">-nsMsgSearchTerm::nsMsgSearchTerm (nsMsgSearchAttribValue attrib,</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineminus">-                                  nsMsgSearchOpValue op,</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineminus">-                                  nsIMsgSearchValue *val,</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineminus">-                                  nsMsgSearchBooleanOperator boolOp,</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineminus">-                                  const char * aCustomString)</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineminus">-{</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineplus">+nsMsgSearchTerm::nsMsgSearchTerm(nsMsgSearchAttribValue attrib,</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineplus">+                                 nsMsgSearchOpValue op, nsIMsgSearchValue *val,</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineplus">+                                 nsMsgSearchBooleanOperator boolOp,</span>
<a href="#l23.473"></a><span id="l23.473" class="difflineplus">+                                 const char *aCustomString) {</span>
<a href="#l23.474"></a><span id="l23.474">   m_operator = op;</span>
<a href="#l23.475"></a><span id="l23.475">   m_attribute = attrib;</span>
<a href="#l23.476"></a><span id="l23.476">   m_booleanOp = boolOp;</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineminus">-  if (attrib &gt; nsMsgSearchAttrib::OtherHeader  &amp;&amp; attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes &amp;&amp; aCustomString)</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineminus">-  {</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineplus">+  if (attrib &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineplus">+      attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes &amp;&amp; aCustomString) {</span>
<a href="#l23.481"></a><span id="l23.481">     m_arbitraryHeader = aCustomString;</span>
<a href="#l23.482"></a><span id="l23.482">     ToLowerCaseExceptSpecials(m_arbitraryHeader);</span>
<a href="#l23.483"></a><span id="l23.483" class="difflineminus">-  }</span>
<a href="#l23.484"></a><span id="l23.484" class="difflineminus">-  else if (attrib == nsMsgSearchAttrib::Custom)</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineminus">-  {</span>
<a href="#l23.486"></a><span id="l23.486" class="difflineplus">+  } else if (attrib == nsMsgSearchAttrib::Custom) {</span>
<a href="#l23.487"></a><span id="l23.487">     m_customId = aCustomString;</span>
<a href="#l23.488"></a><span id="l23.488">   }</span>
<a href="#l23.489"></a><span id="l23.489"> </span>
<a href="#l23.490"></a><span id="l23.490" class="difflineminus">-  nsMsgResultElement::AssignValues (val, &amp;m_value);</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineplus">+  nsMsgResultElement::AssignValues(val, &amp;m_value);</span>
<a href="#l23.492"></a><span id="l23.492">   m_matchAll = false;</span>
<a href="#l23.493"></a><span id="l23.493"> }</span>
<a href="#l23.494"></a><span id="l23.494"> </span>
<a href="#l23.495"></a><span id="l23.495" class="difflineminus">-</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineminus">-</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineminus">-nsMsgSearchTerm::~nsMsgSearchTerm ()</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineminus">-{</span>
<a href="#l23.499"></a><span id="l23.499" class="difflineminus">-}</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineplus">+nsMsgSearchTerm::~nsMsgSearchTerm() {}</span>
<a href="#l23.501"></a><span id="l23.501"> </span>
<a href="#l23.502"></a><span id="l23.502"> NS_IMPL_ISUPPORTS(nsMsgSearchTerm, nsIMsgSearchTerm)</span>
<a href="#l23.503"></a><span id="l23.503"> </span>
<a href="#l23.504"></a><span id="l23.504" class="difflineminus">-</span>
<a href="#l23.505"></a><span id="l23.505"> // Perhaps we could find a better place for this?</span>
<a href="#l23.506"></a><span id="l23.506"> // Caller needs to free.</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-/* static */char *nsMsgSearchTerm::EscapeQuotesInStr(const char *str)</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineminus">-{</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineminus">-  int  numQuotes = 0;</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineplus">+/* static */ char *nsMsgSearchTerm::EscapeQuotesInStr(const char *str) {</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineplus">+  int numQuotes = 0;</span>
<a href="#l23.512"></a><span id="l23.512">   for (const char *strPtr = str; *strPtr; strPtr++)</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineminus">-    if (*strPtr == '&quot;')</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineminus">-      numQuotes++;</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineplus">+    if (*strPtr == '&quot;') numQuotes++;</span>
<a href="#l23.516"></a><span id="l23.516">   int escapedStrLen = PL_strlen(str) + numQuotes;</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineminus">-  char  *escapedStr = (char *) PR_Malloc(escapedStrLen + 1);</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineminus">-  if (escapedStr)</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineminus">-  {</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineplus">+  char *escapedStr = (char *)PR_Malloc(escapedStrLen + 1);</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineplus">+  if (escapedStr) {</span>
<a href="#l23.522"></a><span id="l23.522">     char *destPtr;</span>
<a href="#l23.523"></a><span id="l23.523" class="difflineminus">-    for (destPtr = escapedStr; *str; str++)</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineminus">-    {</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineminus">-      if (*str == '&quot;')</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineminus">-        *destPtr++ = '\\';</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineplus">+    for (destPtr = escapedStr; *str; str++) {</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineplus">+      if (*str == '&quot;') *destPtr++ = '\\';</span>
<a href="#l23.529"></a><span id="l23.529">       *destPtr++ = *str;</span>
<a href="#l23.530"></a><span id="l23.530">     }</span>
<a href="#l23.531"></a><span id="l23.531">     *destPtr = '\0';</span>
<a href="#l23.532"></a><span id="l23.532">   }</span>
<a href="#l23.533"></a><span id="l23.533">   return escapedStr;</span>
<a href="#l23.534"></a><span id="l23.534"> }</span>
<a href="#l23.535"></a><span id="l23.535"> </span>
<a href="#l23.536"></a><span id="l23.536" class="difflineminus">-</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineminus">-nsresult nsMsgSearchTerm::OutputValue(nsCString &amp;outputStr)</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineminus">-{</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineminus">-  if (IS_STRING_ATTRIBUTE(m_attribute) &amp;&amp; !m_value.utf8String.IsEmpty())</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineminus">-  {</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineminus">-    bool    quoteVal = false;</span>
<a href="#l23.542"></a><span id="l23.542" class="difflineplus">+nsresult nsMsgSearchTerm::OutputValue(nsCString &amp;outputStr) {</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineplus">+  if (IS_STRING_ATTRIBUTE(m_attribute) &amp;&amp; !m_value.utf8String.IsEmpty()) {</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineplus">+    bool quoteVal = false;</span>
<a href="#l23.545"></a><span id="l23.545">     // need to quote strings with ')' and strings starting with '&quot;' or ' '</span>
<a href="#l23.546"></a><span id="l23.546">     // filter code will escape quotes</span>
<a href="#l23.547"></a><span id="l23.547">     if (m_value.utf8String.FindChar(')') != kNotFound ||</span>
<a href="#l23.548"></a><span id="l23.548">         (m_value.utf8String.First() == ' ') ||</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineminus">-        (m_value.utf8String.First() == '&quot;'))</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineminus">-    {</span>
<a href="#l23.551"></a><span id="l23.551" class="difflineplus">+        (m_value.utf8String.First() == '&quot;')) {</span>
<a href="#l23.552"></a><span id="l23.552">       quoteVal = true;</span>
<a href="#l23.553"></a><span id="l23.553">       outputStr += &quot;\&quot;&quot;;</span>
<a href="#l23.554"></a><span id="l23.554">     }</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineminus">-    if (m_value.utf8String.FindChar('&quot;') != kNotFound)</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineminus">-    {</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineminus">-      char *escapedString = nsMsgSearchTerm::EscapeQuotesInStr(m_value.utf8String.get());</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineminus">-      if (escapedString)</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineminus">-      {</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineplus">+    if (m_value.utf8String.FindChar('&quot;') != kNotFound) {</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineplus">+      char *escapedString =</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineplus">+          nsMsgSearchTerm::EscapeQuotesInStr(m_value.utf8String.get());</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineplus">+      if (escapedString) {</span>
<a href="#l23.564"></a><span id="l23.564">         outputStr += escapedString;</span>
<a href="#l23.565"></a><span id="l23.565">         PR_Free(escapedString);</span>
<a href="#l23.566"></a><span id="l23.566">       }</span>
<a href="#l23.567"></a><span id="l23.567"> </span>
<a href="#l23.568"></a><span id="l23.568" class="difflineminus">-    }</span>
<a href="#l23.569"></a><span id="l23.569" class="difflineminus">-    else</span>
<a href="#l23.570"></a><span id="l23.570" class="difflineminus">-    {</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineplus">+    } else {</span>
<a href="#l23.572"></a><span id="l23.572">       outputStr += m_value.utf8String;</span>
<a href="#l23.573"></a><span id="l23.573">     }</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineminus">-    if (quoteVal)</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineminus">-      outputStr += &quot;\&quot;&quot;;</span>
<a href="#l23.576"></a><span id="l23.576" class="difflineminus">-  }</span>
<a href="#l23.577"></a><span id="l23.577" class="difflineminus">-  else</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineminus">-  {</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineminus">-    switch (m_attribute)</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineminus">-    {</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineminus">-      case nsMsgSearchAttrib::Date:</span>
<a href="#l23.582"></a><span id="l23.582" class="difflineminus">-      {</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineplus">+    if (quoteVal) outputStr += &quot;\&quot;&quot;;</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineplus">+  } else {</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineplus">+    switch (m_attribute) {</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineplus">+      case nsMsgSearchAttrib::Date: {</span>
<a href="#l23.587"></a><span id="l23.587">         PRExplodedTime exploded;</span>
<a href="#l23.588"></a><span id="l23.588">         PR_ExplodeTime(m_value.u.date, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l23.589"></a><span id="l23.589"> </span>
<a href="#l23.590"></a><span id="l23.590">         // wow, so tm_mon is 0 based, tm_mday is 1 based.</span>
<a href="#l23.591"></a><span id="l23.591">         char dateBuf[100];</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineminus">-        PR_FormatTimeUSEnglish (dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l23.593"></a><span id="l23.593" class="difflineplus">+        PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%d-%b-%Y&quot;, &amp;exploded);</span>
<a href="#l23.594"></a><span id="l23.594">         outputStr += dateBuf;</span>
<a href="#l23.595"></a><span id="l23.595">         break;</span>
<a href="#l23.596"></a><span id="l23.596">       }</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineminus">-    case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l23.598"></a><span id="l23.598" class="difflineminus">-      {</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineplus">+      case nsMsgSearchAttrib::AgeInDays: {</span>
<a href="#l23.600"></a><span id="l23.600">         outputStr.AppendInt(m_value.u.age);</span>
<a href="#l23.601"></a><span id="l23.601">         break;</span>
<a href="#l23.602"></a><span id="l23.602">       }</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineminus">-    case nsMsgSearchAttrib::Label:</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineminus">-      {</span>
<a href="#l23.605"></a><span id="l23.605" class="difflineplus">+      case nsMsgSearchAttrib::Label: {</span>
<a href="#l23.606"></a><span id="l23.606">         outputStr.AppendInt(m_value.u.label);</span>
<a href="#l23.607"></a><span id="l23.607">         break;</span>
<a href="#l23.608"></a><span id="l23.608">       }</span>
<a href="#l23.609"></a><span id="l23.609" class="difflineminus">-    case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l23.610"></a><span id="l23.610" class="difflineminus">-      {</span>
<a href="#l23.611"></a><span id="l23.611" class="difflineminus">-        outputStr.AppendInt(m_value.u.junkStatus); // only if we write to disk, right?</span>
<a href="#l23.612"></a><span id="l23.612" class="difflineplus">+      case nsMsgSearchAttrib::JunkStatus: {</span>
<a href="#l23.613"></a><span id="l23.613" class="difflineplus">+        outputStr.AppendInt(</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineplus">+            m_value.u.junkStatus);  // only if we write to disk, right?</span>
<a href="#l23.615"></a><span id="l23.615">         break;</span>
<a href="#l23.616"></a><span id="l23.616">       }</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineminus">-    case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l23.618"></a><span id="l23.618" class="difflineminus">-      {</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineplus">+      case nsMsgSearchAttrib::JunkPercent: {</span>
<a href="#l23.620"></a><span id="l23.620">         outputStr.AppendInt(m_value.u.junkPercent);</span>
<a href="#l23.621"></a><span id="l23.621">         break;</span>
<a href="#l23.622"></a><span id="l23.622">       }</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineminus">-    case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l23.624"></a><span id="l23.624" class="difflineminus">-      {</span>
<a href="#l23.625"></a><span id="l23.625" class="difflineplus">+      case nsMsgSearchAttrib::MsgStatus: {</span>
<a href="#l23.626"></a><span id="l23.626">         nsAutoCString status;</span>
<a href="#l23.627"></a><span id="l23.627" class="difflineminus">-        NS_MsgGetUntranslatedStatusName (m_value.u.msgStatus, &amp;status);</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineplus">+        NS_MsgGetUntranslatedStatusName(m_value.u.msgStatus, &amp;status);</span>
<a href="#l23.629"></a><span id="l23.629">         outputStr += status;</span>
<a href="#l23.630"></a><span id="l23.630">         break;</span>
<a href="#l23.631"></a><span id="l23.631">       }</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineminus">-    case nsMsgSearchAttrib::Priority:</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineminus">-      {</span>
<a href="#l23.634"></a><span id="l23.634" class="difflineplus">+      case nsMsgSearchAttrib::Priority: {</span>
<a href="#l23.635"></a><span id="l23.635">         nsAutoCString priority;</span>
<a href="#l23.636"></a><span id="l23.636">         NS_MsgGetUntranslatedPriorityName(m_value.u.priority, priority);</span>
<a href="#l23.637"></a><span id="l23.637">         outputStr += priority;</span>
<a href="#l23.638"></a><span id="l23.638">         break;</span>
<a href="#l23.639"></a><span id="l23.639">       }</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineminus">-    case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineminus">-      {</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineplus">+      case nsMsgSearchAttrib::HasAttachmentStatus: {</span>
<a href="#l23.643"></a><span id="l23.643">         outputStr.AppendLiteral(&quot;true&quot;);  // don't need anything here, really</span>
<a href="#l23.644"></a><span id="l23.644">         break;</span>
<a href="#l23.645"></a><span id="l23.645">       }</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineminus">-    case nsMsgSearchAttrib::Size:</span>
<a href="#l23.647"></a><span id="l23.647" class="difflineminus">-      {</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineplus">+      case nsMsgSearchAttrib::Size: {</span>
<a href="#l23.649"></a><span id="l23.649">         outputStr.AppendInt(m_value.u.size);</span>
<a href="#l23.650"></a><span id="l23.650">         break;</span>
<a href="#l23.651"></a><span id="l23.651">       }</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineminus">-    case nsMsgSearchAttrib::Uint32HdrProperty:</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineminus">-      {</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineplus">+      case nsMsgSearchAttrib::Uint32HdrProperty: {</span>
<a href="#l23.655"></a><span id="l23.655">         outputStr.AppendInt(m_value.u.msgStatus);</span>
<a href="#l23.656"></a><span id="l23.656">         break;</span>
<a href="#l23.657"></a><span id="l23.657">       }</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineminus">-    default:</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineminus">-      NS_ASSERTION(false, &quot;trying to output invalid attribute&quot;);</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineminus">-      break;</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineplus">+      default:</span>
<a href="#l23.662"></a><span id="l23.662" class="difflineplus">+        NS_ASSERTION(false, &quot;trying to output invalid attribute&quot;);</span>
<a href="#l23.663"></a><span id="l23.663" class="difflineplus">+        break;</span>
<a href="#l23.664"></a><span id="l23.664">     }</span>
<a href="#l23.665"></a><span id="l23.665">   }</span>
<a href="#l23.666"></a><span id="l23.666">   return NS_OK;</span>
<a href="#l23.667"></a><span id="l23.667"> }</span>
<a href="#l23.668"></a><span id="l23.668"> </span>
<a href="#l23.669"></a><span id="l23.669" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::GetTermAsString (nsACString &amp;outStream)</span>
<a href="#l23.670"></a><span id="l23.670" class="difflineminus">-{</span>
<a href="#l23.671"></a><span id="l23.671" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::GetTermAsString(nsACString &amp;outStream) {</span>
<a href="#l23.672"></a><span id="l23.672">   const char *operatorStr;</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineminus">-  nsAutoCString  outputStr;</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineminus">-  nsresult  rv;</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineplus">+  nsAutoCString outputStr;</span>
<a href="#l23.676"></a><span id="l23.676" class="difflineplus">+  nsresult rv;</span>
<a href="#l23.677"></a><span id="l23.677"> </span>
<a href="#l23.678"></a><span id="l23.678" class="difflineminus">-  if (m_matchAll)</span>
<a href="#l23.679"></a><span id="l23.679" class="difflineminus">-  {</span>
<a href="#l23.680"></a><span id="l23.680" class="difflineplus">+  if (m_matchAll) {</span>
<a href="#l23.681"></a><span id="l23.681">     outStream = &quot;ALL&quot;;</span>
<a href="#l23.682"></a><span id="l23.682">     return NS_OK;</span>
<a href="#l23.683"></a><span id="l23.683">   }</span>
<a href="#l23.684"></a><span id="l23.684"> </span>
<a href="#l23.685"></a><span id="l23.685">   // if arbitrary header, use it instead!</span>
<a href="#l23.686"></a><span id="l23.686">   if (m_attribute &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l23.687"></a><span id="l23.687" class="difflineminus">-      m_attribute &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineminus">-  {</span>
<a href="#l23.689"></a><span id="l23.689" class="difflineplus">+      m_attribute &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes) {</span>
<a href="#l23.690"></a><span id="l23.690">     outputStr = &quot;\&quot;&quot;;</span>
<a href="#l23.691"></a><span id="l23.691">     outputStr += m_arbitraryHeader;</span>
<a href="#l23.692"></a><span id="l23.692">     outputStr += &quot;\&quot;&quot;;</span>
<a href="#l23.693"></a><span id="l23.693" class="difflineminus">-  }</span>
<a href="#l23.694"></a><span id="l23.694" class="difflineminus">-  else if (m_attribute == nsMsgSearchAttrib::Custom)</span>
<a href="#l23.695"></a><span id="l23.695" class="difflineminus">-  {</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineplus">+  } else if (m_attribute == nsMsgSearchAttrib::Custom) {</span>
<a href="#l23.697"></a><span id="l23.697">     // use the custom id as the string</span>
<a href="#l23.698"></a><span id="l23.698">     outputStr = m_customId;</span>
<a href="#l23.699"></a><span id="l23.699">   }</span>
<a href="#l23.700"></a><span id="l23.700"> </span>
<a href="#l23.701"></a><span id="l23.701" class="difflineminus">-  else if (m_attribute == nsMsgSearchAttrib::Uint32HdrProperty)</span>
<a href="#l23.702"></a><span id="l23.702" class="difflineminus">-  {</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineplus">+  else if (m_attribute == nsMsgSearchAttrib::Uint32HdrProperty) {</span>
<a href="#l23.704"></a><span id="l23.704">     outputStr = m_hdrProperty;</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineminus">-  }</span>
<a href="#l23.706"></a><span id="l23.706" class="difflineminus">-  else {</span>
<a href="#l23.707"></a><span id="l23.707" class="difflineplus">+  } else {</span>
<a href="#l23.708"></a><span id="l23.708">     const char *attrib;</span>
<a href="#l23.709"></a><span id="l23.709">     rv = NS_MsgGetStringForAttribute(m_attribute, &amp;attrib);</span>
<a href="#l23.710"></a><span id="l23.710">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.711"></a><span id="l23.711"> </span>
<a href="#l23.712"></a><span id="l23.712">     outputStr = attrib;</span>
<a href="#l23.713"></a><span id="l23.713">   }</span>
<a href="#l23.714"></a><span id="l23.714"> </span>
<a href="#l23.715"></a><span id="l23.715">   outputStr += ',';</span>
<a href="#l23.716"></a><span id="l23.716" class="difflineat">@@ -578,540 +505,485 @@ NS_IMETHODIMP nsMsgSearchTerm::GetTermAs</span>
<a href="#l23.717"></a><span id="l23.717">   outputStr += ',';</span>
<a href="#l23.718"></a><span id="l23.718"> </span>
<a href="#l23.719"></a><span id="l23.719">   OutputValue(outputStr);</span>
<a href="#l23.720"></a><span id="l23.720">   outStream = outputStr;</span>
<a href="#l23.721"></a><span id="l23.721">   return NS_OK;</span>
<a href="#l23.722"></a><span id="l23.722"> }</span>
<a href="#l23.723"></a><span id="l23.723"> </span>
<a href="#l23.724"></a><span id="l23.724"> // fill in m_value from the input stream.</span>
<a href="#l23.725"></a><span id="l23.725" class="difflineminus">-nsresult nsMsgSearchTerm::ParseValue(char *inStream)</span>
<a href="#l23.726"></a><span id="l23.726" class="difflineminus">-{</span>
<a href="#l23.727"></a><span id="l23.727" class="difflineminus">-  if (IS_STRING_ATTRIBUTE(m_attribute))</span>
<a href="#l23.728"></a><span id="l23.728" class="difflineminus">-  {</span>
<a href="#l23.729"></a><span id="l23.729" class="difflineplus">+nsresult nsMsgSearchTerm::ParseValue(char *inStream) {</span>
<a href="#l23.730"></a><span id="l23.730" class="difflineplus">+  if (IS_STRING_ATTRIBUTE(m_attribute)) {</span>
<a href="#l23.731"></a><span id="l23.731">     bool quoteVal = false;</span>
<a href="#l23.732"></a><span id="l23.732" class="difflineminus">-    while (isspace(*inStream))</span>
<a href="#l23.733"></a><span id="l23.733" class="difflineminus">-      inStream++;</span>
<a href="#l23.734"></a><span id="l23.734" class="difflineplus">+    while (isspace(*inStream)) inStream++;</span>
<a href="#l23.735"></a><span id="l23.735">     // need to remove pair of '&quot;', if present</span>
<a href="#l23.736"></a><span id="l23.736" class="difflineminus">-    if (*inStream == '&quot;')</span>
<a href="#l23.737"></a><span id="l23.737" class="difflineminus">-    {</span>
<a href="#l23.738"></a><span id="l23.738" class="difflineplus">+    if (*inStream == '&quot;') {</span>
<a href="#l23.739"></a><span id="l23.739">       quoteVal = true;</span>
<a href="#l23.740"></a><span id="l23.740">       inStream++;</span>
<a href="#l23.741"></a><span id="l23.741">     }</span>
<a href="#l23.742"></a><span id="l23.742">     int valueLen = PL_strlen(inStream);</span>
<a href="#l23.743"></a><span id="l23.743" class="difflineminus">-    if (quoteVal &amp;&amp; inStream[valueLen - 1] == '&quot;')</span>
<a href="#l23.744"></a><span id="l23.744" class="difflineminus">-      valueLen--;</span>
<a href="#l23.745"></a><span id="l23.745" class="difflineplus">+    if (quoteVal &amp;&amp; inStream[valueLen - 1] == '&quot;') valueLen--;</span>
<a href="#l23.746"></a><span id="l23.746"> </span>
<a href="#l23.747"></a><span id="l23.747">     m_value.utf8String.Assign(inStream, valueLen);</span>
<a href="#l23.748"></a><span id="l23.748">     CopyUTF8toUTF16(m_value.utf8String, m_value.utf16String);</span>
<a href="#l23.749"></a><span id="l23.749" class="difflineminus">-  }</span>
<a href="#l23.750"></a><span id="l23.750" class="difflineminus">-  else</span>
<a href="#l23.751"></a><span id="l23.751" class="difflineminus">-  {</span>
<a href="#l23.752"></a><span id="l23.752" class="difflineminus">-    switch (m_attribute)</span>
<a href="#l23.753"></a><span id="l23.753" class="difflineminus">-    {</span>
<a href="#l23.754"></a><span id="l23.754" class="difflineminus">-    case nsMsgSearchAttrib::Date:</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineminus">-      PR_ParseTimeString (inStream, false, &amp;m_value.u.date);</span>
<a href="#l23.756"></a><span id="l23.756" class="difflineminus">-      break;</span>
<a href="#l23.757"></a><span id="l23.757" class="difflineminus">-    case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l23.758"></a><span id="l23.758" class="difflineminus">-      m_value.u.msgStatus = NS_MsgGetStatusValueFromName(inStream);</span>
<a href="#l23.759"></a><span id="l23.759" class="difflineminus">-      break;</span>
<a href="#l23.760"></a><span id="l23.760" class="difflineminus">-    case nsMsgSearchAttrib::Priority:</span>
<a href="#l23.761"></a><span id="l23.761" class="difflineminus">-      NS_MsgGetPriorityFromString(inStream, m_value.u.priority);</span>
<a href="#l23.762"></a><span id="l23.762" class="difflineminus">-      break;</span>
<a href="#l23.763"></a><span id="l23.763" class="difflineminus">-    case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l23.764"></a><span id="l23.764" class="difflineminus">-      m_value.u.age = atoi(inStream);</span>
<a href="#l23.765"></a><span id="l23.765" class="difflineminus">-      break;</span>
<a href="#l23.766"></a><span id="l23.766" class="difflineminus">-    case nsMsgSearchAttrib::Label:</span>
<a href="#l23.767"></a><span id="l23.767" class="difflineminus">-      m_value.u.label = atoi(inStream);</span>
<a href="#l23.768"></a><span id="l23.768" class="difflineminus">-      break;</span>
<a href="#l23.769"></a><span id="l23.769" class="difflineminus">-    case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l23.770"></a><span id="l23.770" class="difflineminus">-      m_value.u.junkStatus = atoi(inStream); // only if we read from disk, right?</span>
<a href="#l23.771"></a><span id="l23.771" class="difflineminus">-      break;</span>
<a href="#l23.772"></a><span id="l23.772" class="difflineminus">-    case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l23.773"></a><span id="l23.773" class="difflineminus">-      m_value.u.junkPercent = atoi(inStream);</span>
<a href="#l23.774"></a><span id="l23.774" class="difflineminus">-      break;</span>
<a href="#l23.775"></a><span id="l23.775" class="difflineminus">-    case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l23.776"></a><span id="l23.776" class="difflineminus">-      m_value.u.msgStatus = nsMsgMessageFlags::Attachment;</span>
<a href="#l23.777"></a><span id="l23.777" class="difflineminus">-      break; // this should always be true.</span>
<a href="#l23.778"></a><span id="l23.778" class="difflineminus">-    case nsMsgSearchAttrib::Size:</span>
<a href="#l23.779"></a><span id="l23.779" class="difflineminus">-      m_value.u.size = atoi(inStream);</span>
<a href="#l23.780"></a><span id="l23.780" class="difflineminus">-      break;</span>
<a href="#l23.781"></a><span id="l23.781" class="difflineminus">-    default:</span>
<a href="#l23.782"></a><span id="l23.782" class="difflineminus">-      NS_ASSERTION(false, &quot;invalid attribute parsing search term value&quot;);</span>
<a href="#l23.783"></a><span id="l23.783" class="difflineminus">-      break;</span>
<a href="#l23.784"></a><span id="l23.784" class="difflineplus">+  } else {</span>
<a href="#l23.785"></a><span id="l23.785" class="difflineplus">+    switch (m_attribute) {</span>
<a href="#l23.786"></a><span id="l23.786" class="difflineplus">+      case nsMsgSearchAttrib::Date:</span>
<a href="#l23.787"></a><span id="l23.787" class="difflineplus">+        PR_ParseTimeString(inStream, false, &amp;m_value.u.date);</span>
<a href="#l23.788"></a><span id="l23.788" class="difflineplus">+        break;</span>
<a href="#l23.789"></a><span id="l23.789" class="difflineplus">+      case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l23.790"></a><span id="l23.790" class="difflineplus">+        m_value.u.msgStatus = NS_MsgGetStatusValueFromName(inStream);</span>
<a href="#l23.791"></a><span id="l23.791" class="difflineplus">+        break;</span>
<a href="#l23.792"></a><span id="l23.792" class="difflineplus">+      case nsMsgSearchAttrib::Priority:</span>
<a href="#l23.793"></a><span id="l23.793" class="difflineplus">+        NS_MsgGetPriorityFromString(inStream, m_value.u.priority);</span>
<a href="#l23.794"></a><span id="l23.794" class="difflineplus">+        break;</span>
<a href="#l23.795"></a><span id="l23.795" class="difflineplus">+      case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l23.796"></a><span id="l23.796" class="difflineplus">+        m_value.u.age = atoi(inStream);</span>
<a href="#l23.797"></a><span id="l23.797" class="difflineplus">+        break;</span>
<a href="#l23.798"></a><span id="l23.798" class="difflineplus">+      case nsMsgSearchAttrib::Label:</span>
<a href="#l23.799"></a><span id="l23.799" class="difflineplus">+        m_value.u.label = atoi(inStream);</span>
<a href="#l23.800"></a><span id="l23.800" class="difflineplus">+        break;</span>
<a href="#l23.801"></a><span id="l23.801" class="difflineplus">+      case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l23.802"></a><span id="l23.802" class="difflineplus">+        m_value.u.junkStatus =</span>
<a href="#l23.803"></a><span id="l23.803" class="difflineplus">+            atoi(inStream);  // only if we read from disk, right?</span>
<a href="#l23.804"></a><span id="l23.804" class="difflineplus">+        break;</span>
<a href="#l23.805"></a><span id="l23.805" class="difflineplus">+      case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l23.806"></a><span id="l23.806" class="difflineplus">+        m_value.u.junkPercent = atoi(inStream);</span>
<a href="#l23.807"></a><span id="l23.807" class="difflineplus">+        break;</span>
<a href="#l23.808"></a><span id="l23.808" class="difflineplus">+      case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l23.809"></a><span id="l23.809" class="difflineplus">+        m_value.u.msgStatus = nsMsgMessageFlags::Attachment;</span>
<a href="#l23.810"></a><span id="l23.810" class="difflineplus">+        break;  // this should always be true.</span>
<a href="#l23.811"></a><span id="l23.811" class="difflineplus">+      case nsMsgSearchAttrib::Size:</span>
<a href="#l23.812"></a><span id="l23.812" class="difflineplus">+        m_value.u.size = atoi(inStream);</span>
<a href="#l23.813"></a><span id="l23.813" class="difflineplus">+        break;</span>
<a href="#l23.814"></a><span id="l23.814" class="difflineplus">+      default:</span>
<a href="#l23.815"></a><span id="l23.815" class="difflineplus">+        NS_ASSERTION(false, &quot;invalid attribute parsing search term value&quot;);</span>
<a href="#l23.816"></a><span id="l23.816" class="difflineplus">+        break;</span>
<a href="#l23.817"></a><span id="l23.817">     }</span>
<a href="#l23.818"></a><span id="l23.818">   }</span>
<a href="#l23.819"></a><span id="l23.819">   m_value.attribute = m_attribute;</span>
<a href="#l23.820"></a><span id="l23.820">   return NS_OK;</span>
<a href="#l23.821"></a><span id="l23.821"> }</span>
<a href="#l23.822"></a><span id="l23.822"> </span>
<a href="#l23.823"></a><span id="l23.823"> // find the operator code for this operator string.</span>
<a href="#l23.824"></a><span id="l23.824" class="difflineminus">-nsresult</span>
<a href="#l23.825"></a><span id="l23.825" class="difflineminus">-nsMsgSearchTerm::ParseOperator(char *inStream, nsMsgSearchOpValue *value)</span>
<a href="#l23.826"></a><span id="l23.826" class="difflineminus">-{</span>
<a href="#l23.827"></a><span id="l23.827" class="difflineplus">+nsresult nsMsgSearchTerm::ParseOperator(char *inStream,</span>
<a href="#l23.828"></a><span id="l23.828" class="difflineplus">+                                        nsMsgSearchOpValue *value) {</span>
<a href="#l23.829"></a><span id="l23.829">   NS_ENSURE_ARG_POINTER(value);</span>
<a href="#l23.830"></a><span id="l23.830">   int16_t operatorVal;</span>
<a href="#l23.831"></a><span id="l23.831" class="difflineminus">-  while (isspace(*inStream))</span>
<a href="#l23.832"></a><span id="l23.832" class="difflineminus">-    inStream++;</span>
<a href="#l23.833"></a><span id="l23.833" class="difflineplus">+  while (isspace(*inStream)) inStream++;</span>
<a href="#l23.834"></a><span id="l23.834"> </span>
<a href="#l23.835"></a><span id="l23.835">   char *commaSep = PL_strchr(inStream, ',');</span>
<a href="#l23.836"></a><span id="l23.836"> </span>
<a href="#l23.837"></a><span id="l23.837" class="difflineminus">-  if (commaSep)</span>
<a href="#l23.838"></a><span id="l23.838" class="difflineminus">-    *commaSep = '\0';</span>
<a href="#l23.839"></a><span id="l23.839" class="difflineplus">+  if (commaSep) *commaSep = '\0';</span>
<a href="#l23.840"></a><span id="l23.840"> </span>
<a href="#l23.841"></a><span id="l23.841">   nsresult err = NS_MsgGetOperatorFromString(inStream, &amp;operatorVal);</span>
<a href="#l23.842"></a><span id="l23.842" class="difflineminus">-  *value = (nsMsgSearchOpValue) operatorVal;</span>
<a href="#l23.843"></a><span id="l23.843" class="difflineplus">+  *value = (nsMsgSearchOpValue)operatorVal;</span>
<a href="#l23.844"></a><span id="l23.844">   return err;</span>
<a href="#l23.845"></a><span id="l23.845"> }</span>
<a href="#l23.846"></a><span id="l23.846"> </span>
<a href="#l23.847"></a><span id="l23.847"> // find the attribute code for this comma-delimited attribute.</span>
<a href="#l23.848"></a><span id="l23.848" class="difflineminus">-nsresult</span>
<a href="#l23.849"></a><span id="l23.849" class="difflineminus">-nsMsgSearchTerm::ParseAttribute(char *inStream, nsMsgSearchAttribValue *attrib)</span>
<a href="#l23.850"></a><span id="l23.850" class="difflineminus">-{</span>
<a href="#l23.851"></a><span id="l23.851" class="difflineminus">-    while (isspace(*inStream))</span>
<a href="#l23.852"></a><span id="l23.852" class="difflineminus">-      inStream++;</span>
<a href="#l23.853"></a><span id="l23.853" class="difflineplus">+nsresult nsMsgSearchTerm::ParseAttribute(char *inStream,</span>
<a href="#l23.854"></a><span id="l23.854" class="difflineplus">+                                         nsMsgSearchAttribValue *attrib) {</span>
<a href="#l23.855"></a><span id="l23.855" class="difflineplus">+  while (isspace(*inStream)) inStream++;</span>
<a href="#l23.856"></a><span id="l23.856"> </span>
<a href="#l23.857"></a><span id="l23.857" class="difflineminus">-    // if we are dealing with an arbitrary header, it will be quoted....</span>
<a href="#l23.858"></a><span id="l23.858" class="difflineminus">-    // it seems like a kludge, but to distinguish arbitrary headers from</span>
<a href="#l23.859"></a><span id="l23.859" class="difflineminus">-    // standard headers with the same name, like &quot;Date&quot;, we'll use the</span>
<a href="#l23.860"></a><span id="l23.860" class="difflineminus">-    // presence of the quote to recognize arbitrary headers. We leave the</span>
<a href="#l23.861"></a><span id="l23.861" class="difflineminus">-    // leading quote as a flag, but remove the trailing quote.</span>
<a href="#l23.862"></a><span id="l23.862" class="difflineminus">-    bool quoteVal = false;</span>
<a href="#l23.863"></a><span id="l23.863" class="difflineminus">-    if (*inStream == '&quot;')</span>
<a href="#l23.864"></a><span id="l23.864" class="difflineminus">-      quoteVal = true;</span>
<a href="#l23.865"></a><span id="l23.865" class="difflineplus">+  // if we are dealing with an arbitrary header, it will be quoted....</span>
<a href="#l23.866"></a><span id="l23.866" class="difflineplus">+  // it seems like a kludge, but to distinguish arbitrary headers from</span>
<a href="#l23.867"></a><span id="l23.867" class="difflineplus">+  // standard headers with the same name, like &quot;Date&quot;, we'll use the</span>
<a href="#l23.868"></a><span id="l23.868" class="difflineplus">+  // presence of the quote to recognize arbitrary headers. We leave the</span>
<a href="#l23.869"></a><span id="l23.869" class="difflineplus">+  // leading quote as a flag, but remove the trailing quote.</span>
<a href="#l23.870"></a><span id="l23.870" class="difflineplus">+  bool quoteVal = false;</span>
<a href="#l23.871"></a><span id="l23.871" class="difflineplus">+  if (*inStream == '&quot;') quoteVal = true;</span>
<a href="#l23.872"></a><span id="l23.872"> </span>
<a href="#l23.873"></a><span id="l23.873" class="difflineminus">-    // arbitrary headers are quoted. Skip first character, which will be the</span>
<a href="#l23.874"></a><span id="l23.874" class="difflineminus">-    // first quote for arbitrary headers</span>
<a href="#l23.875"></a><span id="l23.875" class="difflineminus">-    char *separator = strchr(inStream + 1, quoteVal ? '&quot;' : ',');</span>
<a href="#l23.876"></a><span id="l23.876" class="difflineplus">+  // arbitrary headers are quoted. Skip first character, which will be the</span>
<a href="#l23.877"></a><span id="l23.877" class="difflineplus">+  // first quote for arbitrary headers</span>
<a href="#l23.878"></a><span id="l23.878" class="difflineplus">+  char *separator = strchr(inStream + 1, quoteVal ? '&quot;' : ',');</span>
<a href="#l23.879"></a><span id="l23.879"> </span>
<a href="#l23.880"></a><span id="l23.880" class="difflineminus">-    if (separator)</span>
<a href="#l23.881"></a><span id="l23.881" class="difflineminus">-      *separator = '\0';</span>
<a href="#l23.882"></a><span id="l23.882" class="difflineplus">+  if (separator) *separator = '\0';</span>
<a href="#l23.883"></a><span id="l23.883"> </span>
<a href="#l23.884"></a><span id="l23.884" class="difflineminus">-    nsAutoCString customId;</span>
<a href="#l23.885"></a><span id="l23.885" class="difflineminus">-    nsresult rv = NS_MsgGetAttributeFromString(inStream, attrib, m_customId);</span>
<a href="#l23.886"></a><span id="l23.886" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.887"></a><span id="l23.887" class="difflineplus">+  nsAutoCString customId;</span>
<a href="#l23.888"></a><span id="l23.888" class="difflineplus">+  nsresult rv = NS_MsgGetAttributeFromString(inStream, attrib, m_customId);</span>
<a href="#l23.889"></a><span id="l23.889" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.890"></a><span id="l23.890"> </span>
<a href="#l23.891"></a><span id="l23.891" class="difflineminus">-    if (*attrib &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp; *attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)  // if we are dealing with an arbitrary header....</span>
<a href="#l23.892"></a><span id="l23.892" class="difflineminus">-    {</span>
<a href="#l23.893"></a><span id="l23.893" class="difflineminus">-      m_arbitraryHeader = inStream + 1; // remove the leading quote</span>
<a href="#l23.894"></a><span id="l23.894" class="difflineminus">-      ToLowerCaseExceptSpecials(m_arbitraryHeader);</span>
<a href="#l23.895"></a><span id="l23.895" class="difflineminus">-    }</span>
<a href="#l23.896"></a><span id="l23.896" class="difflineminus">-    return rv;</span>
<a href="#l23.897"></a><span id="l23.897" class="difflineplus">+  if (*attrib &gt; nsMsgSearchAttrib::OtherHeader &amp;&amp;</span>
<a href="#l23.898"></a><span id="l23.898" class="difflineplus">+      *attrib &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes) {</span>
<a href="#l23.899"></a><span id="l23.899" class="difflineplus">+    // We are dealing with an arbitrary header.</span>
<a href="#l23.900"></a><span id="l23.900" class="difflineplus">+    m_arbitraryHeader = inStream + 1;  // remove the leading quote</span>
<a href="#l23.901"></a><span id="l23.901" class="difflineplus">+    ToLowerCaseExceptSpecials(m_arbitraryHeader);</span>
<a href="#l23.902"></a><span id="l23.902" class="difflineplus">+  }</span>
<a href="#l23.903"></a><span id="l23.903" class="difflineplus">+  return rv;</span>
<a href="#l23.904"></a><span id="l23.904"> }</span>
<a href="#l23.905"></a><span id="l23.905"> </span>
<a href="#l23.906"></a><span id="l23.906"> // De stream one search term. If the condition looks like</span>
<a href="#l23.907"></a><span id="l23.907" class="difflineminus">-// condition = &quot;(to or cc, contains, r-thompson) AND (body, doesn't contain, fred)&quot;</span>
<a href="#l23.908"></a><span id="l23.908" class="difflineminus">-// This routine should get called twice, the first time</span>
<a href="#l23.909"></a><span id="l23.909" class="difflineminus">-// with &quot;to or cc, contains, r-thompson&quot;, the second time with</span>
<a href="#l23.910"></a><span id="l23.910" class="difflineminus">-// &quot;body, doesn't contain, fred&quot;</span>
<a href="#l23.911"></a><span id="l23.911" class="difflineplus">+// condition = &quot;(to or cc, contains, r-thompson) AND (body, doesn't contain,</span>
<a href="#l23.912"></a><span id="l23.912" class="difflineplus">+// fred)&quot; This routine should get called twice, the first time with &quot;to or cc,</span>
<a href="#l23.913"></a><span id="l23.913" class="difflineplus">+// contains, r-thompson&quot;, the second time with &quot;body, doesn't contain, fred&quot;</span>
<a href="#l23.914"></a><span id="l23.914"> </span>
<a href="#l23.915"></a><span id="l23.915" class="difflineminus">-nsresult nsMsgSearchTerm::DeStreamNew (char *inStream, int16_t /*length*/)</span>
<a href="#l23.916"></a><span id="l23.916" class="difflineminus">-{</span>
<a href="#l23.917"></a><span id="l23.917" class="difflineminus">-  if (!strcmp(inStream, &quot;ALL&quot;))</span>
<a href="#l23.918"></a><span id="l23.918" class="difflineminus">-  {</span>
<a href="#l23.919"></a><span id="l23.919" class="difflineplus">+nsresult nsMsgSearchTerm::DeStreamNew(char *inStream, int16_t /*length*/) {</span>
<a href="#l23.920"></a><span id="l23.920" class="difflineplus">+  if (!strcmp(inStream, &quot;ALL&quot;)) {</span>
<a href="#l23.921"></a><span id="l23.921">     m_matchAll = true;</span>
<a href="#l23.922"></a><span id="l23.922">     return NS_OK;</span>
<a href="#l23.923"></a><span id="l23.923">   }</span>
<a href="#l23.924"></a><span id="l23.924">   char *commaSep = PL_strchr(inStream, ',');</span>
<a href="#l23.925"></a><span id="l23.925" class="difflineminus">-  nsresult rv = ParseAttribute(inStream, &amp;m_attribute);  // will allocate space for arbitrary header if necessary</span>
<a href="#l23.926"></a><span id="l23.926" class="difflineplus">+  nsresult rv = ParseAttribute(</span>
<a href="#l23.927"></a><span id="l23.927" class="difflineplus">+      inStream,</span>
<a href="#l23.928"></a><span id="l23.928" class="difflineplus">+      &amp;m_attribute);  // will allocate space for arbitrary header if necessary</span>
<a href="#l23.929"></a><span id="l23.929">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.930"></a><span id="l23.930" class="difflineminus">-  if (!commaSep)</span>
<a href="#l23.931"></a><span id="l23.931" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l23.932"></a><span id="l23.932" class="difflineplus">+  if (!commaSep) return NS_ERROR_INVALID_ARG;</span>
<a href="#l23.933"></a><span id="l23.933">   char *secondCommaSep = PL_strchr(commaSep + 1, ',');</span>
<a href="#l23.934"></a><span id="l23.934" class="difflineminus">-  if (commaSep)</span>
<a href="#l23.935"></a><span id="l23.935" class="difflineminus">-    rv = ParseOperator(commaSep + 1, &amp;m_operator);</span>
<a href="#l23.936"></a><span id="l23.936" class="difflineplus">+  if (commaSep) rv = ParseOperator(commaSep + 1, &amp;m_operator);</span>
<a href="#l23.937"></a><span id="l23.937">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.938"></a><span id="l23.938">   // convert label filters and saved searches to keyword equivalents</span>
<a href="#l23.939"></a><span id="l23.939" class="difflineminus">-  if (secondCommaSep)</span>
<a href="#l23.940"></a><span id="l23.940" class="difflineminus">-    ParseValue(secondCommaSep + 1);</span>
<a href="#l23.941"></a><span id="l23.941" class="difflineminus">-  if (m_attribute == nsMsgSearchAttrib::Label)</span>
<a href="#l23.942"></a><span id="l23.942" class="difflineminus">-  {</span>
<a href="#l23.943"></a><span id="l23.943" class="difflineplus">+  if (secondCommaSep) ParseValue(secondCommaSep + 1);</span>
<a href="#l23.944"></a><span id="l23.944" class="difflineplus">+  if (m_attribute == nsMsgSearchAttrib::Label) {</span>
<a href="#l23.945"></a><span id="l23.945">     nsAutoCString keyword(&quot;$label&quot;);</span>
<a href="#l23.946"></a><span id="l23.946">     m_value.attribute = m_attribute = nsMsgSearchAttrib::Keywords;</span>
<a href="#l23.947"></a><span id="l23.947">     keyword.Append('0' + m_value.u.label);</span>
<a href="#l23.948"></a><span id="l23.948">     m_value.utf8String = keyword;</span>
<a href="#l23.949"></a><span id="l23.949">     CopyUTF8toUTF16(keyword, m_value.utf16String);</span>
<a href="#l23.950"></a><span id="l23.950">   }</span>
<a href="#l23.951"></a><span id="l23.951">   return NS_OK;</span>
<a href="#l23.952"></a><span id="l23.952"> }</span>
<a href="#l23.953"></a><span id="l23.953"> </span>
<a href="#l23.954"></a><span id="l23.954" class="difflineminus">-</span>
<a href="#l23.955"></a><span id="l23.955" class="difflineminus">-// Looks in the MessageDB for the user specified arbitrary header, if it finds the header, it then looks for a match against</span>
<a href="#l23.956"></a><span id="l23.956" class="difflineminus">-// the value for the header.</span>
<a href="#l23.957"></a><span id="l23.957" class="difflineminus">-nsresult nsMsgSearchTerm::MatchArbitraryHeader(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l23.958"></a><span id="l23.958" class="difflineminus">-                                               uint32_t length /* in lines*/,</span>
<a href="#l23.959"></a><span id="l23.959" class="difflineminus">-                                               const char *charset,</span>
<a href="#l23.960"></a><span id="l23.960" class="difflineminus">-                                               bool charsetOverride,</span>
<a href="#l23.961"></a><span id="l23.961" class="difflineminus">-                                               nsIMsgDBHdr *msg,</span>
<a href="#l23.962"></a><span id="l23.962" class="difflineminus">-                                               nsIMsgDatabase* db,</span>
<a href="#l23.963"></a><span id="l23.963" class="difflineminus">-                                               const nsACString&amp; headers,</span>
<a href="#l23.964"></a><span id="l23.964" class="difflineminus">-                                               bool ForFiltering,</span>
<a href="#l23.965"></a><span id="l23.965" class="difflineminus">-                                               bool *pResult)</span>
<a href="#l23.966"></a><span id="l23.966" class="difflineminus">-{</span>
<a href="#l23.967"></a><span id="l23.967" class="difflineplus">+// Looks in the MessageDB for the user specified arbitrary header, if it finds</span>
<a href="#l23.968"></a><span id="l23.968" class="difflineplus">+// the header, it then looks for a match against the value for the header.</span>
<a href="#l23.969"></a><span id="l23.969" class="difflineplus">+nsresult nsMsgSearchTerm::MatchArbitraryHeader(</span>
<a href="#l23.970"></a><span id="l23.970" class="difflineplus">+    nsIMsgSearchScopeTerm *scope, uint32_t length /* in lines*/,</span>
<a href="#l23.971"></a><span id="l23.971" class="difflineplus">+    const char *charset, bool charsetOverride, nsIMsgDBHdr *msg,</span>
<a href="#l23.972"></a><span id="l23.972" class="difflineplus">+    nsIMsgDatabase *db, const nsACString &amp;headers, bool ForFiltering,</span>
<a href="#l23.973"></a><span id="l23.973" class="difflineplus">+    bool *pResult) {</span>
<a href="#l23.974"></a><span id="l23.974">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.975"></a><span id="l23.975"> </span>
<a href="#l23.976"></a><span id="l23.976">   *pResult = false;</span>
<a href="#l23.977"></a><span id="l23.977">   nsresult rv = NS_OK;</span>
<a href="#l23.978"></a><span id="l23.978">   bool matchExpected = m_operator == nsMsgSearchOp::Contains ||</span>
<a href="#l23.979"></a><span id="l23.979">                        m_operator == nsMsgSearchOp::Is ||</span>
<a href="#l23.980"></a><span id="l23.980">                        m_operator == nsMsgSearchOp::BeginsWith ||</span>
<a href="#l23.981"></a><span id="l23.981">                        m_operator == nsMsgSearchOp::EndsWith;</span>
<a href="#l23.982"></a><span id="l23.982">   // Initialize result to what we want if we don't find the header at all.</span>
<a href="#l23.983"></a><span id="l23.983">   bool result = !matchExpected;</span>
<a href="#l23.984"></a><span id="l23.984"> </span>
<a href="#l23.985"></a><span id="l23.985">   nsCString dbHdrValue;</span>
<a href="#l23.986"></a><span id="l23.986">   msg-&gt;GetStringProperty(m_arbitraryHeader.get(), getter_Copies(dbHdrValue));</span>
<a href="#l23.987"></a><span id="l23.987">   if (!dbHdrValue.IsEmpty()) {</span>
<a href="#l23.988"></a><span id="l23.988">     // Match value with the other info. It doesn't check all header occurrences,</span>
<a href="#l23.989"></a><span id="l23.989" class="difflineminus">-    // so we use it only if we match and do line by line headers parsing otherwise.</span>
<a href="#l23.990"></a><span id="l23.990" class="difflineplus">+    // so we use it only if we match and do line by line headers parsing</span>
<a href="#l23.991"></a><span id="l23.991" class="difflineplus">+    // otherwise.</span>
<a href="#l23.992"></a><span id="l23.992">     rv = MatchRfc2047String(dbHdrValue, charset, charsetOverride, pResult);</span>
<a href="#l23.993"></a><span id="l23.993" class="difflineminus">-    if (matchExpected == *pResult)</span>
<a href="#l23.994"></a><span id="l23.994" class="difflineminus">-      return rv;</span>
<a href="#l23.995"></a><span id="l23.995" class="difflineplus">+    if (matchExpected == *pResult) return rv;</span>
<a href="#l23.996"></a><span id="l23.996"> </span>
<a href="#l23.997"></a><span id="l23.997">     // Preset result in case we don't have access to the headers, like for IMAP.</span>
<a href="#l23.998"></a><span id="l23.998">     result = *pResult;</span>
<a href="#l23.999"></a><span id="l23.999">   }</span>
<a href="#l23.1000"></a><span id="l23.1000"> </span>
<a href="#l23.1001"></a><span id="l23.1001" class="difflineminus">-  nsMsgBodyHandler *bodyHandler = new nsMsgBodyHandler(scope, length, msg, db,</span>
<a href="#l23.1002"></a><span id="l23.1002" class="difflineminus">-                                                       headers.BeginReading(),</span>
<a href="#l23.1003"></a><span id="l23.1003" class="difflineminus">-                                                       headers.Length(),</span>
<a href="#l23.1004"></a><span id="l23.1004" class="difflineminus">-                                                       ForFiltering);</span>
<a href="#l23.1005"></a><span id="l23.1005" class="difflineminus">-  bodyHandler-&gt;SetStripHeaders (false);</span>
<a href="#l23.1006"></a><span id="l23.1006" class="difflineplus">+  nsMsgBodyHandler *bodyHandler =</span>
<a href="#l23.1007"></a><span id="l23.1007" class="difflineplus">+      new nsMsgBodyHandler(scope, length, msg, db, headers.BeginReading(),</span>
<a href="#l23.1008"></a><span id="l23.1008" class="difflineplus">+                           headers.Length(), ForFiltering);</span>
<a href="#l23.1009"></a><span id="l23.1009" class="difflineplus">+  bodyHandler-&gt;SetStripHeaders(false);</span>
<a href="#l23.1010"></a><span id="l23.1010"> </span>
<a href="#l23.1011"></a><span id="l23.1011" class="difflineminus">-  nsCString headerFullValue;  // Contains matched header value accumulated over multiple lines.</span>
<a href="#l23.1012"></a><span id="l23.1012" class="difflineplus">+  nsCString headerFullValue;  // Contains matched header value accumulated over</span>
<a href="#l23.1013"></a><span id="l23.1013" class="difflineplus">+                              // multiple lines.</span>
<a href="#l23.1014"></a><span id="l23.1014">   nsAutoCString buf;</span>
<a href="#l23.1015"></a><span id="l23.1015">   nsAutoCString curMsgHeader;</span>
<a href="#l23.1016"></a><span id="l23.1016">   bool processingHeaders = true;</span>
<a href="#l23.1017"></a><span id="l23.1017"> </span>
<a href="#l23.1018"></a><span id="l23.1018" class="difflineminus">-  while (processingHeaders)</span>
<a href="#l23.1019"></a><span id="l23.1019" class="difflineminus">-  {</span>
<a href="#l23.1020"></a><span id="l23.1020" class="difflineplus">+  while (processingHeaders) {</span>
<a href="#l23.1021"></a><span id="l23.1021">     nsCString charsetIgnored;</span>
<a href="#l23.1022"></a><span id="l23.1022" class="difflineminus">-    if (bodyHandler-&gt;GetNextLine(buf, charsetIgnored) &lt; 0 || EMPTY_MESSAGE_LINE(buf))</span>
<a href="#l23.1023"></a><span id="l23.1023" class="difflineminus">-      processingHeaders = false;  // No more lines or empty line terminating headers.</span>
<a href="#l23.1024"></a><span id="l23.1024" class="difflineplus">+    if (bodyHandler-&gt;GetNextLine(buf, charsetIgnored) &lt; 0 ||</span>
<a href="#l23.1025"></a><span id="l23.1025" class="difflineplus">+        EMPTY_MESSAGE_LINE(buf))</span>
<a href="#l23.1026"></a><span id="l23.1026" class="difflineplus">+      processingHeaders =</span>
<a href="#l23.1027"></a><span id="l23.1027" class="difflineplus">+          false;  // No more lines or empty line terminating headers.</span>
<a href="#l23.1028"></a><span id="l23.1028"> </span>
<a href="#l23.1029"></a><span id="l23.1029" class="difflineminus">-    bool isContinuationHeader = processingHeaders ?</span>
<a href="#l23.1030"></a><span id="l23.1030" class="difflineminus">-      NS_IsAsciiWhitespace(buf.CharAt(0)) : false;</span>
<a href="#l23.1031"></a><span id="l23.1031" class="difflineplus">+    bool isContinuationHeader =</span>
<a href="#l23.1032"></a><span id="l23.1032" class="difflineplus">+        processingHeaders ? NS_IsAsciiWhitespace(buf.CharAt(0)) : false;</span>
<a href="#l23.1033"></a><span id="l23.1033"> </span>
<a href="#l23.1034"></a><span id="l23.1034">     // If we're not on a continuation header the header value is not empty,</span>
<a href="#l23.1035"></a><span id="l23.1035">     // we have finished accumulating the header value by iterating over all</span>
<a href="#l23.1036"></a><span id="l23.1036">     // header lines. Now we need to check whether the value is a match.</span>
<a href="#l23.1037"></a><span id="l23.1037" class="difflineminus">-    if (!isContinuationHeader &amp;&amp; !headerFullValue.IsEmpty())</span>
<a href="#l23.1038"></a><span id="l23.1038" class="difflineminus">-    {</span>
<a href="#l23.1039"></a><span id="l23.1039" class="difflineplus">+    if (!isContinuationHeader &amp;&amp; !headerFullValue.IsEmpty()) {</span>
<a href="#l23.1040"></a><span id="l23.1040">       bool stringMatches;</span>
<a href="#l23.1041"></a><span id="l23.1041">       // Match value with the other info.</span>
<a href="#l23.1042"></a><span id="l23.1042" class="difflineminus">-      rv = MatchRfc2047String(headerFullValue, charset, charsetOverride, &amp;stringMatches);</span>
<a href="#l23.1043"></a><span id="l23.1043" class="difflineminus">-      if (matchExpected == stringMatches) // if we found a match</span>
<a href="#l23.1044"></a><span id="l23.1044" class="difflineplus">+      rv = MatchRfc2047String(headerFullValue, charset, charsetOverride,</span>
<a href="#l23.1045"></a><span id="l23.1045" class="difflineplus">+                              &amp;stringMatches);</span>
<a href="#l23.1046"></a><span id="l23.1046" class="difflineplus">+      if (matchExpected == stringMatches)  // if we found a match</span>
<a href="#l23.1047"></a><span id="l23.1047">       {</span>
<a href="#l23.1048"></a><span id="l23.1048">         // If we found a match, stop examining the headers.</span>
<a href="#l23.1049"></a><span id="l23.1049">         processingHeaders = false;</span>
<a href="#l23.1050"></a><span id="l23.1050">         result = stringMatches;</span>
<a href="#l23.1051"></a><span id="l23.1051">       }</span>
<a href="#l23.1052"></a><span id="l23.1052">       // Prepare for repeated header of the same type.</span>
<a href="#l23.1053"></a><span id="l23.1053">       headerFullValue.Truncate();</span>
<a href="#l23.1054"></a><span id="l23.1054">     }</span>
<a href="#l23.1055"></a><span id="l23.1055"> </span>
<a href="#l23.1056"></a><span id="l23.1056">     // We got result or finished processing all lines.</span>
<a href="#l23.1057"></a><span id="l23.1057" class="difflineminus">-    if (!processingHeaders)</span>
<a href="#l23.1058"></a><span id="l23.1058" class="difflineminus">-      break;</span>
<a href="#l23.1059"></a><span id="l23.1059" class="difflineplus">+    if (!processingHeaders) break;</span>
<a href="#l23.1060"></a><span id="l23.1060"> </span>
<a href="#l23.1061"></a><span id="l23.1061" class="difflineminus">-    char * buf_end = (char *) (buf.get() + buf.Length());</span>
<a href="#l23.1062"></a><span id="l23.1062" class="difflineplus">+    char *buf_end = (char *)(buf.get() + buf.Length());</span>
<a href="#l23.1063"></a><span id="l23.1063">     int headerLength = m_arbitraryHeader.Length();</span>
<a href="#l23.1064"></a><span id="l23.1064"> </span>
<a href="#l23.1065"></a><span id="l23.1065">     // If the line starts with whitespace, then we use the current header.</span>
<a href="#l23.1066"></a><span id="l23.1066" class="difflineminus">-    if (!isContinuationHeader)</span>
<a href="#l23.1067"></a><span id="l23.1067" class="difflineminus">-    {</span>
<a href="#l23.1068"></a><span id="l23.1068" class="difflineplus">+    if (!isContinuationHeader) {</span>
<a href="#l23.1069"></a><span id="l23.1069">       // Here we start a new header.</span>
<a href="#l23.1070"></a><span id="l23.1070">       uint32_t colonPos = buf.FindChar(':');</span>
<a href="#l23.1071"></a><span id="l23.1071">       curMsgHeader = StringHead(buf, colonPos);</span>
<a href="#l23.1072"></a><span id="l23.1072">     }</span>
<a href="#l23.1073"></a><span id="l23.1073"> </span>
<a href="#l23.1074"></a><span id="l23.1074" class="difflineminus">-    if (curMsgHeader.Equals(m_arbitraryHeader, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l23.1075"></a><span id="l23.1075" class="difflineminus">-    {</span>
<a href="#l23.1076"></a><span id="l23.1076" class="difflineplus">+    if (curMsgHeader.Equals(m_arbitraryHeader,</span>
<a href="#l23.1077"></a><span id="l23.1077" class="difflineplus">+                            nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l23.1078"></a><span id="l23.1078">       // Process the value:</span>
<a href="#l23.1079"></a><span id="l23.1079">       // Value occurs after the header name or whitespace continuation char.</span>
<a href="#l23.1080"></a><span id="l23.1080" class="difflineminus">-      const char *headerValue = buf.get() + (isContinuationHeader ? 1 : headerLength);</span>
<a href="#l23.1081"></a><span id="l23.1081" class="difflineminus">-      if (headerValue &lt; buf_end &amp;&amp; headerValue[0] == ':')  // + 1 to account for the colon which is MANDATORY</span>
<a href="#l23.1082"></a><span id="l23.1082" class="difflineplus">+      const char *headerValue =</span>
<a href="#l23.1083"></a><span id="l23.1083" class="difflineplus">+          buf.get() + (isContinuationHeader ? 1 : headerLength);</span>
<a href="#l23.1084"></a><span id="l23.1084" class="difflineplus">+      if (headerValue &lt; buf_end &amp;&amp;</span>
<a href="#l23.1085"></a><span id="l23.1085" class="difflineplus">+          headerValue[0] ==</span>
<a href="#l23.1086"></a><span id="l23.1086" class="difflineplus">+              ':')  // + 1 to account for the colon which is MANDATORY</span>
<a href="#l23.1087"></a><span id="l23.1087">         headerValue++;</span>
<a href="#l23.1088"></a><span id="l23.1088"> </span>
<a href="#l23.1089"></a><span id="l23.1089">       // Strip leading white space.</span>
<a href="#l23.1090"></a><span id="l23.1090" class="difflineminus">-      while (headerValue &lt; buf_end &amp;&amp; isspace(*headerValue))</span>
<a href="#l23.1091"></a><span id="l23.1091" class="difflineminus">-        headerValue++;</span>
<a href="#l23.1092"></a><span id="l23.1092" class="difflineplus">+      while (headerValue &lt; buf_end &amp;&amp; isspace(*headerValue)) headerValue++;</span>
<a href="#l23.1093"></a><span id="l23.1093"> </span>
<a href="#l23.1094"></a><span id="l23.1094">       // Strip trailing white space.</span>
<a href="#l23.1095"></a><span id="l23.1095" class="difflineminus">-      char * end = buf_end - 1;</span>
<a href="#l23.1096"></a><span id="l23.1096" class="difflineminus">-      while (headerValue &lt; end &amp;&amp; isspace(*end))</span>
<a href="#l23.1097"></a><span id="l23.1097" class="difflineminus">-      {</span>
<a href="#l23.1098"></a><span id="l23.1098" class="difflineplus">+      char *end = buf_end - 1;</span>
<a href="#l23.1099"></a><span id="l23.1099" class="difflineplus">+      while (headerValue &lt; end &amp;&amp; isspace(*end)) {</span>
<a href="#l23.1100"></a><span id="l23.1100">         *end = '\0';</span>
<a href="#l23.1101"></a><span id="l23.1101">         end--;</span>
<a href="#l23.1102"></a><span id="l23.1102">       }</span>
<a href="#l23.1103"></a><span id="l23.1103"> </span>
<a href="#l23.1104"></a><span id="l23.1104">       // Any continuation whitespace is converted to a single space.</span>
<a href="#l23.1105"></a><span id="l23.1105" class="difflineminus">-      if (!headerFullValue.IsEmpty())</span>
<a href="#l23.1106"></a><span id="l23.1106" class="difflineminus">-        headerFullValue.Append(' ');</span>
<a href="#l23.1107"></a><span id="l23.1107" class="difflineplus">+      if (!headerFullValue.IsEmpty()) headerFullValue.Append(' ');</span>
<a href="#l23.1108"></a><span id="l23.1108">       headerFullValue.Append(nsDependentCString(headerValue));</span>
<a href="#l23.1109"></a><span id="l23.1109">     }</span>
<a href="#l23.1110"></a><span id="l23.1110">   }</span>
<a href="#l23.1111"></a><span id="l23.1111"> </span>
<a href="#l23.1112"></a><span id="l23.1112">   delete bodyHandler;</span>
<a href="#l23.1113"></a><span id="l23.1113">   *pResult = result;</span>
<a href="#l23.1114"></a><span id="l23.1114">   return rv;</span>
<a href="#l23.1115"></a><span id="l23.1115"> }</span>
<a href="#l23.1116"></a><span id="l23.1116"> </span>
<a href="#l23.1117"></a><span id="l23.1117" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::MatchHdrProperty(nsIMsgDBHdr *aHdr, bool *aResult)</span>
<a href="#l23.1118"></a><span id="l23.1118" class="difflineminus">-{</span>
<a href="#l23.1119"></a><span id="l23.1119" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::MatchHdrProperty(nsIMsgDBHdr *aHdr,</span>
<a href="#l23.1120"></a><span id="l23.1120" class="difflineplus">+                                                bool *aResult) {</span>
<a href="#l23.1121"></a><span id="l23.1121">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.1122"></a><span id="l23.1122">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l23.1123"></a><span id="l23.1123"> </span>
<a href="#l23.1124"></a><span id="l23.1124">   nsCString dbHdrValue;</span>
<a href="#l23.1125"></a><span id="l23.1125">   aHdr-&gt;GetStringProperty(m_hdrProperty.get(), getter_Copies(dbHdrValue));</span>
<a href="#l23.1126"></a><span id="l23.1126">   return MatchString(dbHdrValue, nullptr, aResult);</span>
<a href="#l23.1127"></a><span id="l23.1127"> }</span>
<a href="#l23.1128"></a><span id="l23.1128"> </span>
<a href="#l23.1129"></a><span id="l23.1129" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::MatchFolderFlag(nsIMsgDBHdr *aMsgToMatch, bool *aResult)</span>
<a href="#l23.1130"></a><span id="l23.1130" class="difflineminus">-{</span>
<a href="#l23.1131"></a><span id="l23.1131" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::MatchFolderFlag(nsIMsgDBHdr *aMsgToMatch,</span>
<a href="#l23.1132"></a><span id="l23.1132" class="difflineplus">+                                               bool *aResult) {</span>
<a href="#l23.1133"></a><span id="l23.1133">   NS_ENSURE_ARG_POINTER(aMsgToMatch);</span>
<a href="#l23.1134"></a><span id="l23.1134">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.1135"></a><span id="l23.1135"> </span>
<a href="#l23.1136"></a><span id="l23.1136">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l23.1137"></a><span id="l23.1137">   nsresult rv = aMsgToMatch-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l23.1138"></a><span id="l23.1138">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1139"></a><span id="l23.1139">   uint32_t folderFlags;</span>
<a href="#l23.1140"></a><span id="l23.1140">   msgFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l23.1141"></a><span id="l23.1141">   return MatchStatus(folderFlags, aResult);</span>
<a href="#l23.1142"></a><span id="l23.1142"> }</span>
<a href="#l23.1143"></a><span id="l23.1143"> </span>
<a href="#l23.1144"></a><span id="l23.1144" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::MatchUint32HdrProperty(nsIMsgDBHdr *aHdr, bool *aResult)</span>
<a href="#l23.1145"></a><span id="l23.1145" class="difflineminus">-{</span>
<a href="#l23.1146"></a><span id="l23.1146" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::MatchUint32HdrProperty(nsIMsgDBHdr *aHdr,</span>
<a href="#l23.1147"></a><span id="l23.1147" class="difflineplus">+                                                      bool *aResult) {</span>
<a href="#l23.1148"></a><span id="l23.1148">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.1149"></a><span id="l23.1149">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l23.1150"></a><span id="l23.1150"> </span>
<a href="#l23.1151"></a><span id="l23.1151">   nsresult rv = NS_OK;</span>
<a href="#l23.1152"></a><span id="l23.1152">   uint32_t dbHdrValue;</span>
<a href="#l23.1153"></a><span id="l23.1153">   aHdr-&gt;GetUint32Property(m_hdrProperty.get(), &amp;dbHdrValue);</span>
<a href="#l23.1154"></a><span id="l23.1154"> </span>
<a href="#l23.1155"></a><span id="l23.1155">   bool result = false;</span>
<a href="#l23.1156"></a><span id="l23.1156" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1157"></a><span id="l23.1157" class="difflineminus">-  {</span>
<a href="#l23.1158"></a><span id="l23.1158" class="difflineminus">-  case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l23.1159"></a><span id="l23.1159" class="difflineminus">-    if (dbHdrValue &gt; m_value.u.msgStatus)</span>
<a href="#l23.1160"></a><span id="l23.1160" class="difflineminus">-      result = true;</span>
<a href="#l23.1161"></a><span id="l23.1161" class="difflineminus">-    break;</span>
<a href="#l23.1162"></a><span id="l23.1162" class="difflineminus">-  case nsMsgSearchOp::IsLessThan:</span>
<a href="#l23.1163"></a><span id="l23.1163" class="difflineminus">-    if (dbHdrValue &lt; m_value.u.msgStatus)</span>
<a href="#l23.1164"></a><span id="l23.1164" class="difflineminus">-      result = true;</span>
<a href="#l23.1165"></a><span id="l23.1165" class="difflineminus">-    break;</span>
<a href="#l23.1166"></a><span id="l23.1166" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1167"></a><span id="l23.1167" class="difflineminus">-    if (dbHdrValue == m_value.u.msgStatus)</span>
<a href="#l23.1168"></a><span id="l23.1168" class="difflineminus">-      result = true;</span>
<a href="#l23.1169"></a><span id="l23.1169" class="difflineminus">-    break;</span>
<a href="#l23.1170"></a><span id="l23.1170" class="difflineminus">-  case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1171"></a><span id="l23.1171" class="difflineminus">-    if (dbHdrValue != m_value.u.msgStatus)</span>
<a href="#l23.1172"></a><span id="l23.1172" class="difflineminus">-      result = true;</span>
<a href="#l23.1173"></a><span id="l23.1173" class="difflineminus">-    break;</span>
<a href="#l23.1174"></a><span id="l23.1174" class="difflineminus">-  default:</span>
<a href="#l23.1175"></a><span id="l23.1175" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1176"></a><span id="l23.1176" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for uint&quot;);</span>
<a href="#l23.1177"></a><span id="l23.1177" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1178"></a><span id="l23.1178" class="difflineplus">+    case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l23.1179"></a><span id="l23.1179" class="difflineplus">+      if (dbHdrValue &gt; m_value.u.msgStatus) result = true;</span>
<a href="#l23.1180"></a><span id="l23.1180" class="difflineplus">+      break;</span>
<a href="#l23.1181"></a><span id="l23.1181" class="difflineplus">+    case nsMsgSearchOp::IsLessThan:</span>
<a href="#l23.1182"></a><span id="l23.1182" class="difflineplus">+      if (dbHdrValue &lt; m_value.u.msgStatus) result = true;</span>
<a href="#l23.1183"></a><span id="l23.1183" class="difflineplus">+      break;</span>
<a href="#l23.1184"></a><span id="l23.1184" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.1185"></a><span id="l23.1185" class="difflineplus">+      if (dbHdrValue == m_value.u.msgStatus) result = true;</span>
<a href="#l23.1186"></a><span id="l23.1186" class="difflineplus">+      break;</span>
<a href="#l23.1187"></a><span id="l23.1187" class="difflineplus">+    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1188"></a><span id="l23.1188" class="difflineplus">+      if (dbHdrValue != m_value.u.msgStatus) result = true;</span>
<a href="#l23.1189"></a><span id="l23.1189" class="difflineplus">+      break;</span>
<a href="#l23.1190"></a><span id="l23.1190" class="difflineplus">+    default:</span>
<a href="#l23.1191"></a><span id="l23.1191" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1192"></a><span id="l23.1192" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for uint&quot;);</span>
<a href="#l23.1193"></a><span id="l23.1193">   }</span>
<a href="#l23.1194"></a><span id="l23.1194">   *aResult = result;</span>
<a href="#l23.1195"></a><span id="l23.1195">   return rv;</span>
<a href="#l23.1196"></a><span id="l23.1196"> }</span>
<a href="#l23.1197"></a><span id="l23.1197"> </span>
<a href="#l23.1198"></a><span id="l23.1198" class="difflineminus">-nsresult nsMsgSearchTerm::MatchBody(nsIMsgSearchScopeTerm *scope, uint64_t offset,</span>
<a href="#l23.1199"></a><span id="l23.1199" class="difflineminus">-                                    uint32_t length /*in lines*/, const char *folderCharset,</span>
<a href="#l23.1200"></a><span id="l23.1200" class="difflineminus">-                                    nsIMsgDBHdr *msg, nsIMsgDatabase* db, bool *pResult)</span>
<a href="#l23.1201"></a><span id="l23.1201" class="difflineminus">-{</span>
<a href="#l23.1202"></a><span id="l23.1202" class="difflineplus">+nsresult nsMsgSearchTerm::MatchBody(nsIMsgSearchScopeTerm *scope,</span>
<a href="#l23.1203"></a><span id="l23.1203" class="difflineplus">+                                    uint64_t offset,</span>
<a href="#l23.1204"></a><span id="l23.1204" class="difflineplus">+                                    uint32_t length /*in lines*/,</span>
<a href="#l23.1205"></a><span id="l23.1205" class="difflineplus">+                                    const char *folderCharset, nsIMsgDBHdr *msg,</span>
<a href="#l23.1206"></a><span id="l23.1206" class="difflineplus">+                                    nsIMsgDatabase *db, bool *pResult) {</span>
<a href="#l23.1207"></a><span id="l23.1207">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1208"></a><span id="l23.1208"> </span>
<a href="#l23.1209"></a><span id="l23.1209">   nsresult rv = NS_OK;</span>
<a href="#l23.1210"></a><span id="l23.1210"> </span>
<a href="#l23.1211"></a><span id="l23.1211">   bool result = false;</span>
<a href="#l23.1212"></a><span id="l23.1212">   *pResult = false;</span>
<a href="#l23.1213"></a><span id="l23.1213"> </span>
<a href="#l23.1214"></a><span id="l23.1214">   // Small hack so we don't look all through a message when someone has</span>
<a href="#l23.1215"></a><span id="l23.1215" class="difflineminus">-  // specified &quot;BODY IS foo&quot;. ### Since length is in lines, this is not quite right.</span>
<a href="#l23.1216"></a><span id="l23.1216" class="difflineminus">-  if ((length &gt; 0) &amp;&amp; (m_operator == nsMsgSearchOp::Is || m_operator == nsMsgSearchOp::Isnt))</span>
<a href="#l23.1217"></a><span id="l23.1217" class="difflineplus">+  // specified &quot;BODY IS foo&quot;. ### Since length is in lines, this is not quite</span>
<a href="#l23.1218"></a><span id="l23.1218" class="difflineplus">+  // right.</span>
<a href="#l23.1219"></a><span id="l23.1219" class="difflineplus">+  if ((length &gt; 0) &amp;&amp;</span>
<a href="#l23.1220"></a><span id="l23.1220" class="difflineplus">+      (m_operator == nsMsgSearchOp::Is || m_operator == nsMsgSearchOp::Isnt))</span>
<a href="#l23.1221"></a><span id="l23.1221">     length = m_value.utf8String.Length();</span>
<a href="#l23.1222"></a><span id="l23.1222"> </span>
<a href="#l23.1223"></a><span id="l23.1223" class="difflineminus">-  nsMsgBodyHandler * bodyHan  = new nsMsgBodyHandler (scope, length, msg, db);</span>
<a href="#l23.1224"></a><span id="l23.1224" class="difflineminus">-  if (!bodyHan)</span>
<a href="#l23.1225"></a><span id="l23.1225" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.1226"></a><span id="l23.1226" class="difflineplus">+  nsMsgBodyHandler *bodyHan = new nsMsgBodyHandler(scope, length, msg, db);</span>
<a href="#l23.1227"></a><span id="l23.1227" class="difflineplus">+  if (!bodyHan) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.1228"></a><span id="l23.1228"> </span>
<a href="#l23.1229"></a><span id="l23.1229">   nsAutoCString buf;</span>
<a href="#l23.1230"></a><span id="l23.1230">   bool endOfFile = false;  // if retValue == 0, we've hit the end of the file</span>
<a href="#l23.1231"></a><span id="l23.1231">   uint32_t lines = 0;</span>
<a href="#l23.1232"></a><span id="l23.1232"> </span>
<a href="#l23.1233"></a><span id="l23.1233">   // Change the sense of the loop so we don't bail out prematurely</span>
<a href="#l23.1234"></a><span id="l23.1234">   // on negative terms. i.e. opDoesntContain must look at all lines</span>
<a href="#l23.1235"></a><span id="l23.1235">   bool boolContinueLoop;</span>
<a href="#l23.1236"></a><span id="l23.1236">   GetMatchAllBeforeDeciding(&amp;boolContinueLoop);</span>
<a href="#l23.1237"></a><span id="l23.1237">   result = boolContinueLoop;</span>
<a href="#l23.1238"></a><span id="l23.1238"> </span>
<a href="#l23.1239"></a><span id="l23.1239">   nsCString compare;</span>
<a href="#l23.1240"></a><span id="l23.1240">   nsCString charset;</span>
<a href="#l23.1241"></a><span id="l23.1241" class="difflineminus">-  while (!endOfFile &amp;&amp; result == boolContinueLoop)</span>
<a href="#l23.1242"></a><span id="l23.1242" class="difflineminus">-  {</span>
<a href="#l23.1243"></a><span id="l23.1243" class="difflineminus">-    if (bodyHan-&gt;GetNextLine(buf, charset) &gt;= 0)</span>
<a href="#l23.1244"></a><span id="l23.1244" class="difflineminus">-    {</span>
<a href="#l23.1245"></a><span id="l23.1245" class="difflineplus">+  while (!endOfFile &amp;&amp; result == boolContinueLoop) {</span>
<a href="#l23.1246"></a><span id="l23.1246" class="difflineplus">+    if (bodyHan-&gt;GetNextLine(buf, charset) &gt;= 0) {</span>
<a href="#l23.1247"></a><span id="l23.1247">       bool softLineBreak = false;</span>
<a href="#l23.1248"></a><span id="l23.1248">       // Do in-place decoding of quoted printable</span>
<a href="#l23.1249"></a><span id="l23.1249" class="difflineminus">-      if (bodyHan-&gt;IsQP())</span>
<a href="#l23.1250"></a><span id="l23.1250" class="difflineminus">-      {</span>
<a href="#l23.1251"></a><span id="l23.1251" class="difflineplus">+      if (bodyHan-&gt;IsQP()) {</span>
<a href="#l23.1252"></a><span id="l23.1252">         softLineBreak = StringEndsWith(buf, NS_LITERAL_CSTRING(&quot;=&quot;));</span>
<a href="#l23.1253"></a><span id="l23.1253">         MsgStripQuotedPrintable(buf);</span>
<a href="#l23.1254"></a><span id="l23.1254">         // If soft line break, chop off the last char as well.</span>
<a href="#l23.1255"></a><span id="l23.1255">         size_t bufLength = buf.Length();</span>
<a href="#l23.1256"></a><span id="l23.1256" class="difflineminus">-        if ((bufLength &gt; 0) &amp;&amp; softLineBreak)</span>
<a href="#l23.1257"></a><span id="l23.1257" class="difflineminus">-          buf.SetLength(bufLength - 1);</span>
<a href="#l23.1258"></a><span id="l23.1258" class="difflineplus">+        if ((bufLength &gt; 0) &amp;&amp; softLineBreak) buf.SetLength(bufLength - 1);</span>
<a href="#l23.1259"></a><span id="l23.1259">       }</span>
<a href="#l23.1260"></a><span id="l23.1260">       compare.Append(buf);</span>
<a href="#l23.1261"></a><span id="l23.1261">       // If this line ends with a soft line break, loop around</span>
<a href="#l23.1262"></a><span id="l23.1262">       // and get the next line before looking for the search string.</span>
<a href="#l23.1263"></a><span id="l23.1263">       // This assumes the message can't end on a QP soft-line break.</span>
<a href="#l23.1264"></a><span id="l23.1264">       // That seems like a pretty safe assumption.</span>
<a href="#l23.1265"></a><span id="l23.1265" class="difflineminus">-      if (softLineBreak)</span>
<a href="#l23.1266"></a><span id="l23.1266" class="difflineminus">-        continue;</span>
<a href="#l23.1267"></a><span id="l23.1267" class="difflineminus">-      if (!compare.IsEmpty())</span>
<a href="#l23.1268"></a><span id="l23.1268" class="difflineminus">-      {</span>
<a href="#l23.1269"></a><span id="l23.1269" class="difflineminus">-        char startChar = (char) compare.CharAt(0);</span>
<a href="#l23.1270"></a><span id="l23.1270" class="difflineminus">-        if (startChar != '\r' &amp;&amp; startChar != '\n')</span>
<a href="#l23.1271"></a><span id="l23.1271" class="difflineminus">-        {</span>
<a href="#l23.1272"></a><span id="l23.1272" class="difflineplus">+      if (softLineBreak) continue;</span>
<a href="#l23.1273"></a><span id="l23.1273" class="difflineplus">+      if (!compare.IsEmpty()) {</span>
<a href="#l23.1274"></a><span id="l23.1274" class="difflineplus">+        char startChar = (char)compare.CharAt(0);</span>
<a href="#l23.1275"></a><span id="l23.1275" class="difflineplus">+        if (startChar != '\r' &amp;&amp; startChar != '\n') {</span>
<a href="#l23.1276"></a><span id="l23.1276">           rv = MatchString(compare,</span>
<a href="#l23.1277"></a><span id="l23.1277">                            charset.IsEmpty() ? folderCharset : charset.get(),</span>
<a href="#l23.1278"></a><span id="l23.1278">                            &amp;result);</span>
<a href="#l23.1279"></a><span id="l23.1279">           lines++;</span>
<a href="#l23.1280"></a><span id="l23.1280">         }</span>
<a href="#l23.1281"></a><span id="l23.1281">         compare.Truncate();</span>
<a href="#l23.1282"></a><span id="l23.1282">       }</span>
<a href="#l23.1283"></a><span id="l23.1283" class="difflineminus">-    }</span>
<a href="#l23.1284"></a><span id="l23.1284" class="difflineminus">-    else</span>
<a href="#l23.1285"></a><span id="l23.1285" class="difflineplus">+    } else</span>
<a href="#l23.1286"></a><span id="l23.1286">       endOfFile = true;</span>
<a href="#l23.1287"></a><span id="l23.1287">   }</span>
<a href="#l23.1288"></a><span id="l23.1288"> </span>
<a href="#l23.1289"></a><span id="l23.1289">   delete bodyHan;</span>
<a href="#l23.1290"></a><span id="l23.1290">   *pResult = result;</span>
<a href="#l23.1291"></a><span id="l23.1291">   return rv;</span>
<a href="#l23.1292"></a><span id="l23.1292"> }</span>
<a href="#l23.1293"></a><span id="l23.1293"> </span>
<a href="#l23.1294"></a><span id="l23.1294" class="difflineminus">-nsresult nsMsgSearchTerm::InitializeAddressBook()</span>
<a href="#l23.1295"></a><span id="l23.1295" class="difflineminus">-{</span>
<a href="#l23.1296"></a><span id="l23.1296" class="difflineminus">-  // the search attribute value has the URI for the address book we need to load.</span>
<a href="#l23.1297"></a><span id="l23.1297" class="difflineminus">-  // we need both the database and the directory.</span>
<a href="#l23.1298"></a><span id="l23.1298" class="difflineplus">+nsresult nsMsgSearchTerm::InitializeAddressBook() {</span>
<a href="#l23.1299"></a><span id="l23.1299" class="difflineplus">+  // the search attribute value has the URI for the address book we need to</span>
<a href="#l23.1300"></a><span id="l23.1300" class="difflineplus">+  // load. we need both the database and the directory.</span>
<a href="#l23.1301"></a><span id="l23.1301">   nsresult rv = NS_OK;</span>
<a href="#l23.1302"></a><span id="l23.1302"> </span>
<a href="#l23.1303"></a><span id="l23.1303" class="difflineminus">-  if (mDirectory)</span>
<a href="#l23.1304"></a><span id="l23.1304" class="difflineminus">-  {</span>
<a href="#l23.1305"></a><span id="l23.1305" class="difflineplus">+  if (mDirectory) {</span>
<a href="#l23.1306"></a><span id="l23.1306">     nsCString uri;</span>
<a href="#l23.1307"></a><span id="l23.1307">     rv = mDirectory-&gt;GetURI(uri);</span>
<a href="#l23.1308"></a><span id="l23.1308">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1309"></a><span id="l23.1309"> </span>
<a href="#l23.1310"></a><span id="l23.1310">     if (!uri.Equals(m_value.utf8String))</span>
<a href="#l23.1311"></a><span id="l23.1311">       // clear out the directory....we are no longer pointing to the right one</span>
<a href="#l23.1312"></a><span id="l23.1312">       mDirectory = nullptr;</span>
<a href="#l23.1313"></a><span id="l23.1313">   }</span>
<a href="#l23.1314"></a><span id="l23.1314" class="difflineminus">-  if (!mDirectory)</span>
<a href="#l23.1315"></a><span id="l23.1315" class="difflineminus">-  {</span>
<a href="#l23.1316"></a><span id="l23.1316" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1317"></a><span id="l23.1317" class="difflineplus">+  if (!mDirectory) {</span>
<a href="#l23.1318"></a><span id="l23.1318" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l23.1319"></a><span id="l23.1319" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1320"></a><span id="l23.1320">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1321"></a><span id="l23.1321"> </span>
<a href="#l23.1322"></a><span id="l23.1322" class="difflineminus">-    rv = abManager-&gt;GetDirectory(m_value.utf8String, getter_AddRefs(mDirectory));</span>
<a href="#l23.1323"></a><span id="l23.1323" class="difflineplus">+    rv =</span>
<a href="#l23.1324"></a><span id="l23.1324" class="difflineplus">+        abManager-&gt;GetDirectory(m_value.utf8String, getter_AddRefs(mDirectory));</span>
<a href="#l23.1325"></a><span id="l23.1325">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1326"></a><span id="l23.1326">   }</span>
<a href="#l23.1327"></a><span id="l23.1327"> </span>
<a href="#l23.1328"></a><span id="l23.1328">   return NS_OK;</span>
<a href="#l23.1329"></a><span id="l23.1329"> }</span>
<a href="#l23.1330"></a><span id="l23.1330"> </span>
<a href="#l23.1331"></a><span id="l23.1331"> nsresult nsMsgSearchTerm::MatchInAddressBook(const nsAString &amp;aAddress,</span>
<a href="#l23.1332"></a><span id="l23.1332" class="difflineminus">-                                             bool *pResult)</span>
<a href="#l23.1333"></a><span id="l23.1333" class="difflineminus">-{</span>
<a href="#l23.1334"></a><span id="l23.1334" class="difflineplus">+                                             bool *pResult) {</span>
<a href="#l23.1335"></a><span id="l23.1335">   nsresult rv = InitializeAddressBook();</span>
<a href="#l23.1336"></a><span id="l23.1336">   *pResult = false;</span>
<a href="#l23.1337"></a><span id="l23.1337"> </span>
<a href="#l23.1338"></a><span id="l23.1338">   // Some junkmails have empty From: fields.</span>
<a href="#l23.1339"></a><span id="l23.1339" class="difflineminus">-  if (aAddress.IsEmpty())</span>
<a href="#l23.1340"></a><span id="l23.1340" class="difflineminus">-    return rv;</span>
<a href="#l23.1341"></a><span id="l23.1341" class="difflineplus">+  if (aAddress.IsEmpty()) return rv;</span>
<a href="#l23.1342"></a><span id="l23.1342"> </span>
<a href="#l23.1343"></a><span id="l23.1343" class="difflineminus">-  if (mDirectory)</span>
<a href="#l23.1344"></a><span id="l23.1344" class="difflineminus">-  {</span>
<a href="#l23.1345"></a><span id="l23.1345" class="difflineplus">+  if (mDirectory) {</span>
<a href="#l23.1346"></a><span id="l23.1346">     nsCOMPtr&lt;nsIAbCard&gt; cardForAddress = nullptr;</span>
<a href="#l23.1347"></a><span id="l23.1347">     rv = mDirectory-&gt;CardForEmailAddress(NS_ConvertUTF16toUTF8(aAddress),</span>
<a href="#l23.1348"></a><span id="l23.1348">                                          getter_AddRefs(cardForAddress));</span>
<a href="#l23.1349"></a><span id="l23.1349" class="difflineminus">-    if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l23.1350"></a><span id="l23.1350" class="difflineminus">-      return rv;</span>
<a href="#l23.1351"></a><span id="l23.1351" class="difflineminus">-    switch(m_operator)</span>
<a href="#l23.1352"></a><span id="l23.1352" class="difflineminus">-    {</span>
<a href="#l23.1353"></a><span id="l23.1353" class="difflineminus">-    case nsMsgSearchOp::IsInAB:</span>
<a href="#l23.1354"></a><span id="l23.1354" class="difflineminus">-      if (cardForAddress)</span>
<a href="#l23.1355"></a><span id="l23.1355" class="difflineminus">-        *pResult = true;</span>
<a href="#l23.1356"></a><span id="l23.1356" class="difflineminus">-      break;</span>
<a href="#l23.1357"></a><span id="l23.1357" class="difflineminus">-    case nsMsgSearchOp::IsntInAB:</span>
<a href="#l23.1358"></a><span id="l23.1358" class="difflineminus">-      if (!cardForAddress)</span>
<a href="#l23.1359"></a><span id="l23.1359" class="difflineminus">-        *pResult = true;</span>
<a href="#l23.1360"></a><span id="l23.1360" class="difflineminus">-      break;</span>
<a href="#l23.1361"></a><span id="l23.1361" class="difflineminus">-    default:</span>
<a href="#l23.1362"></a><span id="l23.1362" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1363"></a><span id="l23.1363" class="difflineminus">-      NS_ERROR(&quot;invalid compare op for address book&quot;);</span>
<a href="#l23.1364"></a><span id="l23.1364" class="difflineplus">+    if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED) return rv;</span>
<a href="#l23.1365"></a><span id="l23.1365" class="difflineplus">+    switch (m_operator) {</span>
<a href="#l23.1366"></a><span id="l23.1366" class="difflineplus">+      case nsMsgSearchOp::IsInAB:</span>
<a href="#l23.1367"></a><span id="l23.1367" class="difflineplus">+        if (cardForAddress) *pResult = true;</span>
<a href="#l23.1368"></a><span id="l23.1368" class="difflineplus">+        break;</span>
<a href="#l23.1369"></a><span id="l23.1369" class="difflineplus">+      case nsMsgSearchOp::IsntInAB:</span>
<a href="#l23.1370"></a><span id="l23.1370" class="difflineplus">+        if (!cardForAddress) *pResult = true;</span>
<a href="#l23.1371"></a><span id="l23.1371" class="difflineplus">+        break;</span>
<a href="#l23.1372"></a><span id="l23.1372" class="difflineplus">+      default:</span>
<a href="#l23.1373"></a><span id="l23.1373" class="difflineplus">+        rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1374"></a><span id="l23.1374" class="difflineplus">+        NS_ERROR(&quot;invalid compare op for address book&quot;);</span>
<a href="#l23.1375"></a><span id="l23.1375">     }</span>
<a href="#l23.1376"></a><span id="l23.1376">   }</span>
<a href="#l23.1377"></a><span id="l23.1377"> </span>
<a href="#l23.1378"></a><span id="l23.1378">   return rv;</span>
<a href="#l23.1379"></a><span id="l23.1379"> }</span>
<a href="#l23.1380"></a><span id="l23.1380"> </span>
<a href="#l23.1381"></a><span id="l23.1381"> // *pResult is false when strings don't match, true if they do.</span>
<a href="#l23.1382"></a><span id="l23.1382"> nsresult nsMsgSearchTerm::MatchRfc2047String(const nsACString &amp;rfc2047string,</span>
<a href="#l23.1383"></a><span id="l23.1383">                                              const char *charset,</span>
<a href="#l23.1384"></a><span id="l23.1384">                                              bool charsetOverride,</span>
<a href="#l23.1385"></a><span id="l23.1385" class="difflineminus">-                                             bool *pResult)</span>
<a href="#l23.1386"></a><span id="l23.1386" class="difflineminus">-{</span>
<a href="#l23.1387"></a><span id="l23.1387" class="difflineplus">+                                             bool *pResult) {</span>
<a href="#l23.1388"></a><span id="l23.1388">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1389"></a><span id="l23.1389"> </span>
<a href="#l23.1390"></a><span id="l23.1390">   nsresult rv;</span>
<a href="#l23.1391"></a><span id="l23.1391" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1392"></a><span id="l23.1392" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter =</span>
<a href="#l23.1393"></a><span id="l23.1393" class="difflineplus">+      do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l23.1394"></a><span id="l23.1394">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1395"></a><span id="l23.1395">   nsAutoString stringToMatch;</span>
<a href="#l23.1396"></a><span id="l23.1396" class="difflineminus">-  rv = mimeConverter-&gt;DecodeMimeHeader(</span>
<a href="#l23.1397"></a><span id="l23.1397" class="difflineminus">-    PromiseFlatCString(rfc2047string).get(), charset, charsetOverride, false,</span>
<a href="#l23.1398"></a><span id="l23.1398" class="difflineminus">-    stringToMatch);</span>
<a href="#l23.1399"></a><span id="l23.1399" class="difflineplus">+  rv = mimeConverter-&gt;DecodeMimeHeader(PromiseFlatCString(rfc2047string).get(),</span>
<a href="#l23.1400"></a><span id="l23.1400" class="difflineplus">+                                       charset, charsetOverride, false,</span>
<a href="#l23.1401"></a><span id="l23.1401" class="difflineplus">+                                       stringToMatch);</span>
<a href="#l23.1402"></a><span id="l23.1402">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1403"></a><span id="l23.1403">   if (m_operator == nsMsgSearchOp::IsInAB ||</span>
<a href="#l23.1404"></a><span id="l23.1404">       m_operator == nsMsgSearchOp::IsntInAB)</span>
<a href="#l23.1405"></a><span id="l23.1405">     return MatchInAddressBook(stringToMatch, pResult);</span>
<a href="#l23.1406"></a><span id="l23.1406"> </span>
<a href="#l23.1407"></a><span id="l23.1407">   return MatchString(stringToMatch, pResult);</span>
<a href="#l23.1408"></a><span id="l23.1408"> }</span>
<a href="#l23.1409"></a><span id="l23.1409"> </span>
<a href="#l23.1410"></a><span id="l23.1410"> // *pResult is false when strings don't match, true if they do.</span>
<a href="#l23.1411"></a><span id="l23.1411"> nsresult nsMsgSearchTerm::MatchString(const nsACString &amp;stringToMatch,</span>
<a href="#l23.1412"></a><span id="l23.1412" class="difflineminus">-                                      const char *charset,</span>
<a href="#l23.1413"></a><span id="l23.1413" class="difflineminus">-                                      bool *pResult)</span>
<a href="#l23.1414"></a><span id="l23.1414" class="difflineminus">-{</span>
<a href="#l23.1415"></a><span id="l23.1415" class="difflineplus">+                                      const char *charset, bool *pResult) {</span>
<a href="#l23.1416"></a><span id="l23.1416">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1417"></a><span id="l23.1417"> </span>
<a href="#l23.1418"></a><span id="l23.1418">   bool result = false;</span>
<a href="#l23.1419"></a><span id="l23.1419"> </span>
<a href="#l23.1420"></a><span id="l23.1420">   nsresult rv = NS_OK;</span>
<a href="#l23.1421"></a><span id="l23.1421"> </span>
<a href="#l23.1422"></a><span id="l23.1422">   // Save some performance for opIsEmpty / opIsntEmpty</span>
<a href="#l23.1423"></a><span id="l23.1423" class="difflineminus">-  if (nsMsgSearchOp::IsEmpty == m_operator)</span>
<a href="#l23.1424"></a><span id="l23.1424" class="difflineminus">-  {</span>
<a href="#l23.1425"></a><span id="l23.1425" class="difflineminus">-    if (stringToMatch.IsEmpty())</span>
<a href="#l23.1426"></a><span id="l23.1426" class="difflineminus">-      result = true;</span>
<a href="#l23.1427"></a><span id="l23.1427" class="difflineminus">-  }</span>
<a href="#l23.1428"></a><span id="l23.1428" class="difflineminus">-  else if (nsMsgSearchOp::IsntEmpty == m_operator)</span>
<a href="#l23.1429"></a><span id="l23.1429" class="difflineminus">-  {</span>
<a href="#l23.1430"></a><span id="l23.1430" class="difflineminus">-    if (!stringToMatch.IsEmpty())</span>
<a href="#l23.1431"></a><span id="l23.1431" class="difflineminus">-      result = true;</span>
<a href="#l23.1432"></a><span id="l23.1432" class="difflineminus">-  }</span>
<a href="#l23.1433"></a><span id="l23.1433" class="difflineminus">-  else</span>
<a href="#l23.1434"></a><span id="l23.1434" class="difflineminus">-  {</span>
<a href="#l23.1435"></a><span id="l23.1435" class="difflineplus">+  if (nsMsgSearchOp::IsEmpty == m_operator) {</span>
<a href="#l23.1436"></a><span id="l23.1436" class="difflineplus">+    if (stringToMatch.IsEmpty()) result = true;</span>
<a href="#l23.1437"></a><span id="l23.1437" class="difflineplus">+  } else if (nsMsgSearchOp::IsntEmpty == m_operator) {</span>
<a href="#l23.1438"></a><span id="l23.1438" class="difflineplus">+    if (!stringToMatch.IsEmpty()) result = true;</span>
<a href="#l23.1439"></a><span id="l23.1439" class="difflineplus">+  } else {</span>
<a href="#l23.1440"></a><span id="l23.1440">     nsAutoString utf16StrToMatch;</span>
<a href="#l23.1441"></a><span id="l23.1441">     rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l23.1442"></a><span id="l23.1442" class="difflineminus">-    if (charset)</span>
<a href="#l23.1443"></a><span id="l23.1443" class="difflineminus">-    {</span>
<a href="#l23.1444"></a><span id="l23.1444" class="difflineminus">-      rv = nsMsgI18NConvertToUnicode(nsDependentCString(charset),</span>
<a href="#l23.1445"></a><span id="l23.1445" class="difflineminus">-                                     stringToMatch,</span>
<a href="#l23.1446"></a><span id="l23.1446" class="difflineplus">+    if (charset) {</span>
<a href="#l23.1447"></a><span id="l23.1447" class="difflineplus">+      rv = nsMsgI18NConvertToUnicode(nsDependentCString(charset), stringToMatch,</span>
<a href="#l23.1448"></a><span id="l23.1448">                                      utf16StrToMatch);</span>
<a href="#l23.1449"></a><span id="l23.1449">     }</span>
<a href="#l23.1450"></a><span id="l23.1450">     if (NS_FAILED(rv)) {</span>
<a href="#l23.1451"></a><span id="l23.1451">       // No charset or conversion failed, maybe due to a bad charset, try UTF-8.</span>
<a href="#l23.1452"></a><span id="l23.1452">       if (MsgIsUTF8(stringToMatch)) {</span>
<a href="#l23.1453"></a><span id="l23.1453">         CopyUTF8toUTF16(stringToMatch, utf16StrToMatch);</span>
<a href="#l23.1454"></a><span id="l23.1454">       } else {</span>
<a href="#l23.1455"></a><span id="l23.1455">         // Bad luck, let's assume ASCII/windows-1252 then.</span>
<a href="#l23.1456"></a><span id="l23.1456" class="difflineat">@@ -1123,80 +995,74 @@ nsresult nsMsgSearchTerm::MatchString(co</span>
<a href="#l23.1457"></a><span id="l23.1457">   }</span>
<a href="#l23.1458"></a><span id="l23.1458"> </span>
<a href="#l23.1459"></a><span id="l23.1459">   *pResult = result;</span>
<a href="#l23.1460"></a><span id="l23.1460">   return rv;</span>
<a href="#l23.1461"></a><span id="l23.1461"> }</span>
<a href="#l23.1462"></a><span id="l23.1462"> </span>
<a href="#l23.1463"></a><span id="l23.1463"> // *pResult is false when strings don't match, true if they do.</span>
<a href="#l23.1464"></a><span id="l23.1464"> nsresult nsMsgSearchTerm::MatchString(const nsAString &amp;utf16StrToMatch,</span>
<a href="#l23.1465"></a><span id="l23.1465" class="difflineminus">-                                      bool *pResult)</span>
<a href="#l23.1466"></a><span id="l23.1466" class="difflineminus">-{</span>
<a href="#l23.1467"></a><span id="l23.1467" class="difflineplus">+                                      bool *pResult) {</span>
<a href="#l23.1468"></a><span id="l23.1468">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1469"></a><span id="l23.1469"> </span>
<a href="#l23.1470"></a><span id="l23.1470">   bool result = false;</span>
<a href="#l23.1471"></a><span id="l23.1471"> </span>
<a href="#l23.1472"></a><span id="l23.1472">   nsresult rv = NS_OK;</span>
<a href="#l23.1473"></a><span id="l23.1473">   auto needle = m_value.utf16String;</span>
<a href="#l23.1474"></a><span id="l23.1474"> </span>
<a href="#l23.1475"></a><span id="l23.1475" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1476"></a><span id="l23.1476" class="difflineminus">-  {</span>
<a href="#l23.1477"></a><span id="l23.1477" class="difflineminus">-  case nsMsgSearchOp::Contains:</span>
<a href="#l23.1478"></a><span id="l23.1478" class="difflineminus">-    if (CaseInsensitiveFindInReadable(needle, utf16StrToMatch))</span>
<a href="#l23.1479"></a><span id="l23.1479" class="difflineminus">-      result = true;</span>
<a href="#l23.1480"></a><span id="l23.1480" class="difflineminus">-    break;</span>
<a href="#l23.1481"></a><span id="l23.1481" class="difflineminus">-  case nsMsgSearchOp::DoesntContain:</span>
<a href="#l23.1482"></a><span id="l23.1482" class="difflineminus">-    if (!CaseInsensitiveFindInReadable(needle, utf16StrToMatch))</span>
<a href="#l23.1483"></a><span id="l23.1483" class="difflineminus">-      result = true;</span>
<a href="#l23.1484"></a><span id="l23.1484" class="difflineminus">-    break;</span>
<a href="#l23.1485"></a><span id="l23.1485" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1486"></a><span id="l23.1486" class="difflineminus">-    if(needle.Equals(utf16StrToMatch, nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1487"></a><span id="l23.1487" class="difflineminus">-      result = true;</span>
<a href="#l23.1488"></a><span id="l23.1488" class="difflineminus">-    break;</span>
<a href="#l23.1489"></a><span id="l23.1489" class="difflineminus">-  case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1490"></a><span id="l23.1490" class="difflineminus">-    if(!needle.Equals(utf16StrToMatch, nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1491"></a><span id="l23.1491" class="difflineminus">-      result = true;</span>
<a href="#l23.1492"></a><span id="l23.1492" class="difflineminus">-    break;</span>
<a href="#l23.1493"></a><span id="l23.1493" class="difflineminus">-  case nsMsgSearchOp::IsEmpty:</span>
<a href="#l23.1494"></a><span id="l23.1494" class="difflineminus">-    if (utf16StrToMatch.IsEmpty())</span>
<a href="#l23.1495"></a><span id="l23.1495" class="difflineminus">-      result = true;</span>
<a href="#l23.1496"></a><span id="l23.1496" class="difflineminus">-    break;</span>
<a href="#l23.1497"></a><span id="l23.1497" class="difflineminus">-  case nsMsgSearchOp::IsntEmpty:</span>
<a href="#l23.1498"></a><span id="l23.1498" class="difflineminus">-    if (!utf16StrToMatch.IsEmpty())</span>
<a href="#l23.1499"></a><span id="l23.1499" class="difflineminus">-      result = true;</span>
<a href="#l23.1500"></a><span id="l23.1500" class="difflineminus">-    break;</span>
<a href="#l23.1501"></a><span id="l23.1501" class="difflineminus">-  case nsMsgSearchOp::BeginsWith:</span>
<a href="#l23.1502"></a><span id="l23.1502" class="difflineminus">-    if (StringBeginsWith(utf16StrToMatch, needle,</span>
<a href="#l23.1503"></a><span id="l23.1503" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1504"></a><span id="l23.1504" class="difflineplus">+    case nsMsgSearchOp::Contains:</span>
<a href="#l23.1505"></a><span id="l23.1505" class="difflineplus">+      if (CaseInsensitiveFindInReadable(needle, utf16StrToMatch)) result = true;</span>
<a href="#l23.1506"></a><span id="l23.1506" class="difflineplus">+      break;</span>
<a href="#l23.1507"></a><span id="l23.1507" class="difflineplus">+    case nsMsgSearchOp::DoesntContain:</span>
<a href="#l23.1508"></a><span id="l23.1508" class="difflineplus">+      if (!CaseInsensitiveFindInReadable(needle, utf16StrToMatch))</span>
<a href="#l23.1509"></a><span id="l23.1509" class="difflineplus">+        result = true;</span>
<a href="#l23.1510"></a><span id="l23.1510" class="difflineplus">+      break;</span>
<a href="#l23.1511"></a><span id="l23.1511" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.1512"></a><span id="l23.1512" class="difflineplus">+      if (needle.Equals(utf16StrToMatch, nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1513"></a><span id="l23.1513" class="difflineplus">+        result = true;</span>
<a href="#l23.1514"></a><span id="l23.1514" class="difflineplus">+      break;</span>
<a href="#l23.1515"></a><span id="l23.1515" class="difflineplus">+    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1516"></a><span id="l23.1516" class="difflineplus">+      if (!needle.Equals(utf16StrToMatch, nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1517"></a><span id="l23.1517" class="difflineplus">+        result = true;</span>
<a href="#l23.1518"></a><span id="l23.1518" class="difflineplus">+      break;</span>
<a href="#l23.1519"></a><span id="l23.1519" class="difflineplus">+    case nsMsgSearchOp::IsEmpty:</span>
<a href="#l23.1520"></a><span id="l23.1520" class="difflineplus">+      if (utf16StrToMatch.IsEmpty()) result = true;</span>
<a href="#l23.1521"></a><span id="l23.1521" class="difflineplus">+      break;</span>
<a href="#l23.1522"></a><span id="l23.1522" class="difflineplus">+    case nsMsgSearchOp::IsntEmpty:</span>
<a href="#l23.1523"></a><span id="l23.1523" class="difflineplus">+      if (!utf16StrToMatch.IsEmpty()) result = true;</span>
<a href="#l23.1524"></a><span id="l23.1524" class="difflineplus">+      break;</span>
<a href="#l23.1525"></a><span id="l23.1525" class="difflineplus">+    case nsMsgSearchOp::BeginsWith:</span>
<a href="#l23.1526"></a><span id="l23.1526" class="difflineplus">+      if (StringBeginsWith(utf16StrToMatch, needle,</span>
<a href="#l23.1527"></a><span id="l23.1527" class="difflineplus">+                           nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1528"></a><span id="l23.1528" class="difflineplus">+        result = true;</span>
<a href="#l23.1529"></a><span id="l23.1529" class="difflineplus">+      break;</span>
<a href="#l23.1530"></a><span id="l23.1530" class="difflineplus">+    case nsMsgSearchOp::EndsWith:</span>
<a href="#l23.1531"></a><span id="l23.1531" class="difflineplus">+      if (StringEndsWith(utf16StrToMatch, needle,</span>
<a href="#l23.1532"></a><span id="l23.1532">                          nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1533"></a><span id="l23.1533" class="difflineminus">-      result = true;</span>
<a href="#l23.1534"></a><span id="l23.1534" class="difflineminus">-    break;</span>
<a href="#l23.1535"></a><span id="l23.1535" class="difflineminus">-  case nsMsgSearchOp::EndsWith:</span>
<a href="#l23.1536"></a><span id="l23.1536" class="difflineminus">-    if (StringEndsWith(utf16StrToMatch, needle,</span>
<a href="#l23.1537"></a><span id="l23.1537" class="difflineminus">-                       nsCaseInsensitiveStringComparator()))</span>
<a href="#l23.1538"></a><span id="l23.1538" class="difflineminus">-      result = true;</span>
<a href="#l23.1539"></a><span id="l23.1539" class="difflineminus">-    break;</span>
<a href="#l23.1540"></a><span id="l23.1540" class="difflineminus">-  default:</span>
<a href="#l23.1541"></a><span id="l23.1541" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1542"></a><span id="l23.1542" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for matching search results&quot;);</span>
<a href="#l23.1543"></a><span id="l23.1543" class="difflineplus">+        result = true;</span>
<a href="#l23.1544"></a><span id="l23.1544" class="difflineplus">+      break;</span>
<a href="#l23.1545"></a><span id="l23.1545" class="difflineplus">+    default:</span>
<a href="#l23.1546"></a><span id="l23.1546" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1547"></a><span id="l23.1547" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for matching search results&quot;);</span>
<a href="#l23.1548"></a><span id="l23.1548">   }</span>
<a href="#l23.1549"></a><span id="l23.1549"> </span>
<a href="#l23.1550"></a><span id="l23.1550">   *pResult = result;</span>
<a href="#l23.1551"></a><span id="l23.1551">   return rv;</span>
<a href="#l23.1552"></a><span id="l23.1552"> }</span>
<a href="#l23.1553"></a><span id="l23.1553"> </span>
<a href="#l23.1554"></a><span id="l23.1554" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::GetMatchAllBeforeDeciding (bool *aResult)</span>
<a href="#l23.1555"></a><span id="l23.1555" class="difflineminus">-{</span>
<a href="#l23.1556"></a><span id="l23.1556" class="difflineminus">-  *aResult = (m_operator == nsMsgSearchOp::DoesntContain || m_operator == nsMsgSearchOp::Isnt);</span>
<a href="#l23.1557"></a><span id="l23.1557" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::GetMatchAllBeforeDeciding(bool *aResult) {</span>
<a href="#l23.1558"></a><span id="l23.1558" class="difflineplus">+  *aResult = (m_operator == nsMsgSearchOp::DoesntContain ||</span>
<a href="#l23.1559"></a><span id="l23.1559" class="difflineplus">+              m_operator == nsMsgSearchOp::Isnt);</span>
<a href="#l23.1560"></a><span id="l23.1560">   return NS_OK;</span>
<a href="#l23.1561"></a><span id="l23.1561"> }</span>
<a href="#l23.1562"></a><span id="l23.1562"> </span>
<a href="#l23.1563"></a><span id="l23.1563"> NS_IMETHODIMP nsMsgSearchTerm::MatchRfc822String(const nsACString &amp;string,</span>
<a href="#l23.1564"></a><span id="l23.1564">                                                  const char *charset,</span>
<a href="#l23.1565"></a><span id="l23.1565" class="difflineminus">-                                                 bool *pResult)</span>
<a href="#l23.1566"></a><span id="l23.1566" class="difflineminus">-{</span>
<a href="#l23.1567"></a><span id="l23.1567" class="difflineplus">+                                                 bool *pResult) {</span>
<a href="#l23.1568"></a><span id="l23.1568">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1569"></a><span id="l23.1569"> </span>
<a href="#l23.1570"></a><span id="l23.1570">   *pResult = false;</span>
<a href="#l23.1571"></a><span id="l23.1571">   bool result;</span>
<a href="#l23.1572"></a><span id="l23.1572"> </span>
<a href="#l23.1573"></a><span id="l23.1573">   // Change the sense of the loop so we don't bail out prematurely</span>
<a href="#l23.1574"></a><span id="l23.1574">   // on negative terms. i.e. opDoesntContain must look at all recipients</span>
<a href="#l23.1575"></a><span id="l23.1575">   bool boolContinueLoop;</span>
<a href="#l23.1576"></a><span id="l23.1576" class="difflineat">@@ -1211,863 +1077,763 @@ NS_IMETHODIMP nsMsgSearchTerm::MatchRfc8</span>
<a href="#l23.1577"></a><span id="l23.1577">   if (m_operator == nsMsgSearchOp::Contains)</span>
<a href="#l23.1578"></a><span id="l23.1578">     return MatchRfc2047String(string, charset, false, pResult);</span>
<a href="#l23.1579"></a><span id="l23.1579"> </span>
<a href="#l23.1580"></a><span id="l23.1580">   nsTArray&lt;nsString&gt; names, addresses;</span>
<a href="#l23.1581"></a><span id="l23.1581">   ExtractAllAddresses(EncodedHeader(string, charset), names, addresses);</span>
<a href="#l23.1582"></a><span id="l23.1582">   uint32_t count = names.Length();</span>
<a href="#l23.1583"></a><span id="l23.1583"> </span>
<a href="#l23.1584"></a><span id="l23.1584">   nsresult rv = NS_OK;</span>
<a href="#l23.1585"></a><span id="l23.1585" class="difflineminus">-  for (uint32_t i = 0; i &lt; count &amp;&amp; result == boolContinueLoop; i++)</span>
<a href="#l23.1586"></a><span id="l23.1586" class="difflineminus">-  {</span>
<a href="#l23.1587"></a><span id="l23.1587" class="difflineminus">-    if ( m_operator == nsMsgSearchOp::IsInAB ||</span>
<a href="#l23.1588"></a><span id="l23.1588" class="difflineminus">-         m_operator == nsMsgSearchOp::IsntInAB)</span>
<a href="#l23.1589"></a><span id="l23.1589" class="difflineminus">-    {</span>
<a href="#l23.1590"></a><span id="l23.1590" class="difflineplus">+  for (uint32_t i = 0; i &lt; count &amp;&amp; result == boolContinueLoop; i++) {</span>
<a href="#l23.1591"></a><span id="l23.1591" class="difflineplus">+    if (m_operator == nsMsgSearchOp::IsInAB ||</span>
<a href="#l23.1592"></a><span id="l23.1592" class="difflineplus">+        m_operator == nsMsgSearchOp::IsntInAB) {</span>
<a href="#l23.1593"></a><span id="l23.1593">       rv = MatchInAddressBook(addresses[i], &amp;result);</span>
<a href="#l23.1594"></a><span id="l23.1594" class="difflineminus">-    }</span>
<a href="#l23.1595"></a><span id="l23.1595" class="difflineminus">-    else</span>
<a href="#l23.1596"></a><span id="l23.1596" class="difflineminus">-    {</span>
<a href="#l23.1597"></a><span id="l23.1597" class="difflineplus">+    } else {</span>
<a href="#l23.1598"></a><span id="l23.1598">       rv = MatchString(names[i], &amp;result);</span>
<a href="#l23.1599"></a><span id="l23.1599" class="difflineminus">-      if (boolContinueLoop == result)</span>
<a href="#l23.1600"></a><span id="l23.1600" class="difflineminus">-        rv = MatchString(addresses[i], &amp;result);</span>
<a href="#l23.1601"></a><span id="l23.1601" class="difflineplus">+      if (boolContinueLoop == result) rv = MatchString(addresses[i], &amp;result);</span>
<a href="#l23.1602"></a><span id="l23.1602">     }</span>
<a href="#l23.1603"></a><span id="l23.1603">   }</span>
<a href="#l23.1604"></a><span id="l23.1604">   *pResult = result;</span>
<a href="#l23.1605"></a><span id="l23.1605">   return rv;</span>
<a href="#l23.1606"></a><span id="l23.1606"> }</span>
<a href="#l23.1607"></a><span id="l23.1607"> </span>
<a href="#l23.1608"></a><span id="l23.1608" class="difflineminus">-</span>
<a href="#l23.1609"></a><span id="l23.1609" class="difflineminus">-nsresult nsMsgSearchTerm::GetLocalTimes (PRTime a, PRTime b, PRExplodedTime &amp;aExploded, PRExplodedTime &amp;bExploded)</span>
<a href="#l23.1610"></a><span id="l23.1610" class="difflineminus">-{</span>
<a href="#l23.1611"></a><span id="l23.1611" class="difflineplus">+nsresult nsMsgSearchTerm::GetLocalTimes(PRTime a, PRTime b,</span>
<a href="#l23.1612"></a><span id="l23.1612" class="difflineplus">+                                        PRExplodedTime &amp;aExploded,</span>
<a href="#l23.1613"></a><span id="l23.1613" class="difflineplus">+                                        PRExplodedTime &amp;bExploded) {</span>
<a href="#l23.1614"></a><span id="l23.1614">   PR_ExplodeTime(a, PR_LocalTimeParameters, &amp;aExploded);</span>
<a href="#l23.1615"></a><span id="l23.1615">   PR_ExplodeTime(b, PR_LocalTimeParameters, &amp;bExploded);</span>
<a href="#l23.1616"></a><span id="l23.1616">   return NS_OK;</span>
<a href="#l23.1617"></a><span id="l23.1617"> }</span>
<a href="#l23.1618"></a><span id="l23.1618"> </span>
<a href="#l23.1619"></a><span id="l23.1619" class="difflineminus">-</span>
<a href="#l23.1620"></a><span id="l23.1620" class="difflineminus">-nsresult nsMsgSearchTerm::MatchDate (PRTime dateToMatch, bool *pResult)</span>
<a href="#l23.1621"></a><span id="l23.1621" class="difflineminus">-{</span>
<a href="#l23.1622"></a><span id="l23.1622" class="difflineplus">+nsresult nsMsgSearchTerm::MatchDate(PRTime dateToMatch, bool *pResult) {</span>
<a href="#l23.1623"></a><span id="l23.1623">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1624"></a><span id="l23.1624"> </span>
<a href="#l23.1625"></a><span id="l23.1625">   nsresult rv = NS_OK;</span>
<a href="#l23.1626"></a><span id="l23.1626">   bool result = false;</span>
<a href="#l23.1627"></a><span id="l23.1627"> </span>
<a href="#l23.1628"></a><span id="l23.1628">   PRExplodedTime tmToMatch, tmThis;</span>
<a href="#l23.1629"></a><span id="l23.1629" class="difflineminus">-  if (NS_SUCCEEDED(GetLocalTimes(dateToMatch, m_value.u.date, tmToMatch, tmThis)))</span>
<a href="#l23.1630"></a><span id="l23.1630" class="difflineminus">-  {</span>
<a href="#l23.1631"></a><span id="l23.1631" class="difflineminus">-    switch (m_operator)</span>
<a href="#l23.1632"></a><span id="l23.1632" class="difflineminus">-    {</span>
<a href="#l23.1633"></a><span id="l23.1633" class="difflineminus">-    case nsMsgSearchOp::IsBefore:</span>
<a href="#l23.1634"></a><span id="l23.1634" class="difflineminus">-      if (tmToMatch.tm_year &lt; tmThis.tm_year ||</span>
<a href="#l23.1635"></a><span id="l23.1635" class="difflineminus">-         (tmToMatch.tm_year == tmThis.tm_year &amp;&amp;</span>
<a href="#l23.1636"></a><span id="l23.1636" class="difflineminus">-           tmToMatch.tm_yday &lt; tmThis.tm_yday))</span>
<a href="#l23.1637"></a><span id="l23.1637" class="difflineminus">-        result = true;</span>
<a href="#l23.1638"></a><span id="l23.1638" class="difflineminus">-      break;</span>
<a href="#l23.1639"></a><span id="l23.1639" class="difflineminus">-    case nsMsgSearchOp::IsAfter:</span>
<a href="#l23.1640"></a><span id="l23.1640" class="difflineminus">-      if (tmToMatch.tm_year &gt; tmThis.tm_year ||</span>
<a href="#l23.1641"></a><span id="l23.1641" class="difflineminus">-         (tmToMatch.tm_year == tmThis.tm_year &amp;&amp;</span>
<a href="#l23.1642"></a><span id="l23.1642" class="difflineminus">-           tmToMatch.tm_yday &gt; tmThis.tm_yday))</span>
<a href="#l23.1643"></a><span id="l23.1643" class="difflineminus">-        result = true;</span>
<a href="#l23.1644"></a><span id="l23.1644" class="difflineminus">-      break;</span>
<a href="#l23.1645"></a><span id="l23.1645" class="difflineminus">-    case nsMsgSearchOp::Is:</span>
<a href="#l23.1646"></a><span id="l23.1646" class="difflineminus">-      if (tmThis.tm_year == tmToMatch.tm_year &amp;&amp;</span>
<a href="#l23.1647"></a><span id="l23.1647" class="difflineminus">-          tmThis.tm_month == tmToMatch.tm_month &amp;&amp;</span>
<a href="#l23.1648"></a><span id="l23.1648" class="difflineminus">-          tmThis.tm_mday == tmToMatch.tm_mday)</span>
<a href="#l23.1649"></a><span id="l23.1649" class="difflineminus">-        result = true;</span>
<a href="#l23.1650"></a><span id="l23.1650" class="difflineminus">-      break;</span>
<a href="#l23.1651"></a><span id="l23.1651" class="difflineminus">-    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1652"></a><span id="l23.1652" class="difflineminus">-      if (tmThis.tm_year != tmToMatch.tm_year ||</span>
<a href="#l23.1653"></a><span id="l23.1653" class="difflineminus">-          tmThis.tm_month != tmToMatch.tm_month ||</span>
<a href="#l23.1654"></a><span id="l23.1654" class="difflineminus">-          tmThis.tm_mday != tmToMatch.tm_mday)</span>
<a href="#l23.1655"></a><span id="l23.1655" class="difflineminus">-        result = true;</span>
<a href="#l23.1656"></a><span id="l23.1656" class="difflineminus">-      break;</span>
<a href="#l23.1657"></a><span id="l23.1657" class="difflineminus">-    default:</span>
<a href="#l23.1658"></a><span id="l23.1658" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1659"></a><span id="l23.1659" class="difflineminus">-      NS_ERROR(&quot;invalid compare op for dates&quot;);</span>
<a href="#l23.1660"></a><span id="l23.1660" class="difflineplus">+  if (NS_SUCCEEDED(</span>
<a href="#l23.1661"></a><span id="l23.1661" class="difflineplus">+          GetLocalTimes(dateToMatch, m_value.u.date, tmToMatch, tmThis))) {</span>
<a href="#l23.1662"></a><span id="l23.1662" class="difflineplus">+    switch (m_operator) {</span>
<a href="#l23.1663"></a><span id="l23.1663" class="difflineplus">+      case nsMsgSearchOp::IsBefore:</span>
<a href="#l23.1664"></a><span id="l23.1664" class="difflineplus">+        if (tmToMatch.tm_year &lt; tmThis.tm_year ||</span>
<a href="#l23.1665"></a><span id="l23.1665" class="difflineplus">+            (tmToMatch.tm_year == tmThis.tm_year &amp;&amp;</span>
<a href="#l23.1666"></a><span id="l23.1666" class="difflineplus">+             tmToMatch.tm_yday &lt; tmThis.tm_yday))</span>
<a href="#l23.1667"></a><span id="l23.1667" class="difflineplus">+          result = true;</span>
<a href="#l23.1668"></a><span id="l23.1668" class="difflineplus">+        break;</span>
<a href="#l23.1669"></a><span id="l23.1669" class="difflineplus">+      case nsMsgSearchOp::IsAfter:</span>
<a href="#l23.1670"></a><span id="l23.1670" class="difflineplus">+        if (tmToMatch.tm_year &gt; tmThis.tm_year ||</span>
<a href="#l23.1671"></a><span id="l23.1671" class="difflineplus">+            (tmToMatch.tm_year == tmThis.tm_year &amp;&amp;</span>
<a href="#l23.1672"></a><span id="l23.1672" class="difflineplus">+             tmToMatch.tm_yday &gt; tmThis.tm_yday))</span>
<a href="#l23.1673"></a><span id="l23.1673" class="difflineplus">+          result = true;</span>
<a href="#l23.1674"></a><span id="l23.1674" class="difflineplus">+        break;</span>
<a href="#l23.1675"></a><span id="l23.1675" class="difflineplus">+      case nsMsgSearchOp::Is:</span>
<a href="#l23.1676"></a><span id="l23.1676" class="difflineplus">+        if (tmThis.tm_year == tmToMatch.tm_year &amp;&amp;</span>
<a href="#l23.1677"></a><span id="l23.1677" class="difflineplus">+            tmThis.tm_month == tmToMatch.tm_month &amp;&amp;</span>
<a href="#l23.1678"></a><span id="l23.1678" class="difflineplus">+            tmThis.tm_mday == tmToMatch.tm_mday)</span>
<a href="#l23.1679"></a><span id="l23.1679" class="difflineplus">+          result = true;</span>
<a href="#l23.1680"></a><span id="l23.1680" class="difflineplus">+        break;</span>
<a href="#l23.1681"></a><span id="l23.1681" class="difflineplus">+      case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1682"></a><span id="l23.1682" class="difflineplus">+        if (tmThis.tm_year != tmToMatch.tm_year ||</span>
<a href="#l23.1683"></a><span id="l23.1683" class="difflineplus">+            tmThis.tm_month != tmToMatch.tm_month ||</span>
<a href="#l23.1684"></a><span id="l23.1684" class="difflineplus">+            tmThis.tm_mday != tmToMatch.tm_mday)</span>
<a href="#l23.1685"></a><span id="l23.1685" class="difflineplus">+          result = true;</span>
<a href="#l23.1686"></a><span id="l23.1686" class="difflineplus">+        break;</span>
<a href="#l23.1687"></a><span id="l23.1687" class="difflineplus">+      default:</span>
<a href="#l23.1688"></a><span id="l23.1688" class="difflineplus">+        rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1689"></a><span id="l23.1689" class="difflineplus">+        NS_ERROR(&quot;invalid compare op for dates&quot;);</span>
<a href="#l23.1690"></a><span id="l23.1690">     }</span>
<a href="#l23.1691"></a><span id="l23.1691">   }</span>
<a href="#l23.1692"></a><span id="l23.1692">   *pResult = result;</span>
<a href="#l23.1693"></a><span id="l23.1693">   return rv;</span>
<a href="#l23.1694"></a><span id="l23.1694"> }</span>
<a href="#l23.1695"></a><span id="l23.1695"> </span>
<a href="#l23.1696"></a><span id="l23.1696" class="difflineminus">-</span>
<a href="#l23.1697"></a><span id="l23.1697" class="difflineminus">-nsresult nsMsgSearchTerm::MatchAge (PRTime msgDate, bool *pResult)</span>
<a href="#l23.1698"></a><span id="l23.1698" class="difflineminus">-{</span>
<a href="#l23.1699"></a><span id="l23.1699" class="difflineplus">+nsresult nsMsgSearchTerm::MatchAge(PRTime msgDate, bool *pResult) {</span>
<a href="#l23.1700"></a><span id="l23.1700">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1701"></a><span id="l23.1701"> </span>
<a href="#l23.1702"></a><span id="l23.1702">   bool result = false;</span>
<a href="#l23.1703"></a><span id="l23.1703">   nsresult rv = NS_OK;</span>
<a href="#l23.1704"></a><span id="l23.1704"> </span>
<a href="#l23.1705"></a><span id="l23.1705">   PRTime now = PR_Now();</span>
<a href="#l23.1706"></a><span id="l23.1706">   PRTime cutOffDay = now - m_value.u.age * PR_USEC_PER_DAY;</span>
<a href="#l23.1707"></a><span id="l23.1707"> </span>
<a href="#l23.1708"></a><span id="l23.1708">   bool cutOffDayInTheFuture = m_value.u.age &lt; 0;</span>
<a href="#l23.1709"></a><span id="l23.1709"> </span>
<a href="#l23.1710"></a><span id="l23.1710">   // So now cutOffDay is the PRTime cut-off point.</span>
<a href="#l23.1711"></a><span id="l23.1711">   // Any msg with a time less than that will be past the age.</span>
<a href="#l23.1712"></a><span id="l23.1712"> </span>
<a href="#l23.1713"></a><span id="l23.1713" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1714"></a><span id="l23.1714" class="difflineminus">-  {</span>
<a href="#l23.1715"></a><span id="l23.1715" class="difflineminus">-    case nsMsgSearchOp::IsGreaterThan: // is older than, or more in the future</span>
<a href="#l23.1716"></a><span id="l23.1716" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1717"></a><span id="l23.1717" class="difflineplus">+    case nsMsgSearchOp::IsGreaterThan:  // is older than, or more in the future</span>
<a href="#l23.1718"></a><span id="l23.1718">       if ((!cutOffDayInTheFuture &amp;&amp; msgDate &lt; cutOffDay) ||</span>
<a href="#l23.1719"></a><span id="l23.1719">           (cutOffDayInTheFuture &amp;&amp; msgDate &gt; cutOffDay))</span>
<a href="#l23.1720"></a><span id="l23.1720">         result = true;</span>
<a href="#l23.1721"></a><span id="l23.1721">       break;</span>
<a href="#l23.1722"></a><span id="l23.1722" class="difflineminus">-    case nsMsgSearchOp::IsLessThan: // is younger than, or less in the future</span>
<a href="#l23.1723"></a><span id="l23.1723" class="difflineplus">+    case nsMsgSearchOp::IsLessThan:  // is younger than, or less in the future</span>
<a href="#l23.1724"></a><span id="l23.1724">       if ((!cutOffDayInTheFuture &amp;&amp; msgDate &gt; cutOffDay) ||</span>
<a href="#l23.1725"></a><span id="l23.1725">           (cutOffDayInTheFuture &amp;&amp; msgDate &lt; cutOffDay))</span>
<a href="#l23.1726"></a><span id="l23.1726">         result = true;</span>
<a href="#l23.1727"></a><span id="l23.1727">       break;</span>
<a href="#l23.1728"></a><span id="l23.1728">     case nsMsgSearchOp::Is:</span>
<a href="#l23.1729"></a><span id="l23.1729">       PRExplodedTime msgDateExploded;</span>
<a href="#l23.1730"></a><span id="l23.1730">       PRExplodedTime cutOffDayExploded;</span>
<a href="#l23.1731"></a><span id="l23.1731" class="difflineminus">-      if (NS_SUCCEEDED(GetLocalTimes(msgDate, cutOffDay, msgDateExploded, cutOffDayExploded)))</span>
<a href="#l23.1732"></a><span id="l23.1732" class="difflineminus">-      {</span>
<a href="#l23.1733"></a><span id="l23.1733" class="difflineplus">+      if (NS_SUCCEEDED(GetLocalTimes(msgDate, cutOffDay, msgDateExploded,</span>
<a href="#l23.1734"></a><span id="l23.1734" class="difflineplus">+                                     cutOffDayExploded))) {</span>
<a href="#l23.1735"></a><span id="l23.1735">         if ((msgDateExploded.tm_mday == cutOffDayExploded.tm_mday) &amp;&amp;</span>
<a href="#l23.1736"></a><span id="l23.1736">             (msgDateExploded.tm_month == cutOffDayExploded.tm_month) &amp;&amp;</span>
<a href="#l23.1737"></a><span id="l23.1737">             (msgDateExploded.tm_year == cutOffDayExploded.tm_year))</span>
<a href="#l23.1738"></a><span id="l23.1738">           result = true;</span>
<a href="#l23.1739"></a><span id="l23.1739">       }</span>
<a href="#l23.1740"></a><span id="l23.1740">       break;</span>
<a href="#l23.1741"></a><span id="l23.1741">     default:</span>
<a href="#l23.1742"></a><span id="l23.1742">       rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1743"></a><span id="l23.1743">       NS_ERROR(&quot;invalid compare op for msg age&quot;);</span>
<a href="#l23.1744"></a><span id="l23.1744">   }</span>
<a href="#l23.1745"></a><span id="l23.1745">   *pResult = result;</span>
<a href="#l23.1746"></a><span id="l23.1746">   return rv;</span>
<a href="#l23.1747"></a><span id="l23.1747"> }</span>
<a href="#l23.1748"></a><span id="l23.1748"> </span>
<a href="#l23.1749"></a><span id="l23.1749" class="difflineminus">-</span>
<a href="#l23.1750"></a><span id="l23.1750" class="difflineminus">-nsresult nsMsgSearchTerm::MatchSize (uint32_t sizeToMatch, bool *pResult)</span>
<a href="#l23.1751"></a><span id="l23.1751" class="difflineminus">-{</span>
<a href="#l23.1752"></a><span id="l23.1752" class="difflineplus">+nsresult nsMsgSearchTerm::MatchSize(uint32_t sizeToMatch, bool *pResult) {</span>
<a href="#l23.1753"></a><span id="l23.1753">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1754"></a><span id="l23.1754"> </span>
<a href="#l23.1755"></a><span id="l23.1755">   nsresult rv = NS_OK;</span>
<a href="#l23.1756"></a><span id="l23.1756">   bool result = false;</span>
<a href="#l23.1757"></a><span id="l23.1757">   // We reduce the sizeToMatch rather than supplied size</span>
<a href="#l23.1758"></a><span id="l23.1758">   // as then we can do an exact match on the displayed value</span>
<a href="#l23.1759"></a><span id="l23.1759">   // which will be less confusing to the user.</span>
<a href="#l23.1760"></a><span id="l23.1760">   uint32_t sizeToMatchKB = sizeToMatch;</span>
<a href="#l23.1761"></a><span id="l23.1761"> </span>
<a href="#l23.1762"></a><span id="l23.1762" class="difflineminus">-  if (sizeToMatchKB &lt; 1024)</span>
<a href="#l23.1763"></a><span id="l23.1763" class="difflineminus">-    sizeToMatchKB = 1024;</span>
<a href="#l23.1764"></a><span id="l23.1764" class="difflineplus">+  if (sizeToMatchKB &lt; 1024) sizeToMatchKB = 1024;</span>
<a href="#l23.1765"></a><span id="l23.1765"> </span>
<a href="#l23.1766"></a><span id="l23.1766">   sizeToMatchKB /= 1024;</span>
<a href="#l23.1767"></a><span id="l23.1767"> </span>
<a href="#l23.1768"></a><span id="l23.1768" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1769"></a><span id="l23.1769" class="difflineminus">-  {</span>
<a href="#l23.1770"></a><span id="l23.1770" class="difflineminus">-  case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l23.1771"></a><span id="l23.1771" class="difflineminus">-    if (sizeToMatchKB &gt; m_value.u.size)</span>
<a href="#l23.1772"></a><span id="l23.1772" class="difflineminus">-      result = true;</span>
<a href="#l23.1773"></a><span id="l23.1773" class="difflineminus">-    break;</span>
<a href="#l23.1774"></a><span id="l23.1774" class="difflineminus">-  case nsMsgSearchOp::IsLessThan:</span>
<a href="#l23.1775"></a><span id="l23.1775" class="difflineminus">-    if (sizeToMatchKB &lt; m_value.u.size)</span>
<a href="#l23.1776"></a><span id="l23.1776" class="difflineminus">-      result = true;</span>
<a href="#l23.1777"></a><span id="l23.1777" class="difflineminus">-    break;</span>
<a href="#l23.1778"></a><span id="l23.1778" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1779"></a><span id="l23.1779" class="difflineminus">-    if (sizeToMatchKB == m_value.u.size)</span>
<a href="#l23.1780"></a><span id="l23.1780" class="difflineminus">-      result = true;</span>
<a href="#l23.1781"></a><span id="l23.1781" class="difflineminus">-    break;</span>
<a href="#l23.1782"></a><span id="l23.1782" class="difflineminus">-  default:</span>
<a href="#l23.1783"></a><span id="l23.1783" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1784"></a><span id="l23.1784" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for size to match&quot;);</span>
<a href="#l23.1785"></a><span id="l23.1785" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1786"></a><span id="l23.1786" class="difflineplus">+    case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l23.1787"></a><span id="l23.1787" class="difflineplus">+      if (sizeToMatchKB &gt; m_value.u.size) result = true;</span>
<a href="#l23.1788"></a><span id="l23.1788" class="difflineplus">+      break;</span>
<a href="#l23.1789"></a><span id="l23.1789" class="difflineplus">+    case nsMsgSearchOp::IsLessThan:</span>
<a href="#l23.1790"></a><span id="l23.1790" class="difflineplus">+      if (sizeToMatchKB &lt; m_value.u.size) result = true;</span>
<a href="#l23.1791"></a><span id="l23.1791" class="difflineplus">+      break;</span>
<a href="#l23.1792"></a><span id="l23.1792" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.1793"></a><span id="l23.1793" class="difflineplus">+      if (sizeToMatchKB == m_value.u.size) result = true;</span>
<a href="#l23.1794"></a><span id="l23.1794" class="difflineplus">+      break;</span>
<a href="#l23.1795"></a><span id="l23.1795" class="difflineplus">+    default:</span>
<a href="#l23.1796"></a><span id="l23.1796" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1797"></a><span id="l23.1797" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for size to match&quot;);</span>
<a href="#l23.1798"></a><span id="l23.1798">   }</span>
<a href="#l23.1799"></a><span id="l23.1799">   *pResult = result;</span>
<a href="#l23.1800"></a><span id="l23.1800">   return rv;</span>
<a href="#l23.1801"></a><span id="l23.1801"> }</span>
<a href="#l23.1802"></a><span id="l23.1802"> </span>
<a href="#l23.1803"></a><span id="l23.1803" class="difflineminus">-nsresult nsMsgSearchTerm::MatchJunkStatus(const char *aJunkScore, bool *pResult)</span>
<a href="#l23.1804"></a><span id="l23.1804" class="difflineminus">-{</span>
<a href="#l23.1805"></a><span id="l23.1805" class="difflineplus">+nsresult nsMsgSearchTerm::MatchJunkStatus(const char *aJunkScore,</span>
<a href="#l23.1806"></a><span id="l23.1806" class="difflineplus">+                                          bool *pResult) {</span>
<a href="#l23.1807"></a><span id="l23.1807">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1808"></a><span id="l23.1808"> </span>
<a href="#l23.1809"></a><span id="l23.1809" class="difflineminus">-  if (m_operator == nsMsgSearchOp::IsEmpty)</span>
<a href="#l23.1810"></a><span id="l23.1810" class="difflineminus">-  {</span>
<a href="#l23.1811"></a><span id="l23.1811" class="difflineplus">+  if (m_operator == nsMsgSearchOp::IsEmpty) {</span>
<a href="#l23.1812"></a><span id="l23.1812">     *pResult = !(aJunkScore &amp;&amp; *aJunkScore);</span>
<a href="#l23.1813"></a><span id="l23.1813">     return NS_OK;</span>
<a href="#l23.1814"></a><span id="l23.1814">   }</span>
<a href="#l23.1815"></a><span id="l23.1815" class="difflineminus">-  if (m_operator == nsMsgSearchOp::IsntEmpty)</span>
<a href="#l23.1816"></a><span id="l23.1816" class="difflineminus">-  {</span>
<a href="#l23.1817"></a><span id="l23.1817" class="difflineplus">+  if (m_operator == nsMsgSearchOp::IsntEmpty) {</span>
<a href="#l23.1818"></a><span id="l23.1818">     *pResult = (aJunkScore &amp;&amp; *aJunkScore);</span>
<a href="#l23.1819"></a><span id="l23.1819">     return NS_OK;</span>
<a href="#l23.1820"></a><span id="l23.1820">   }</span>
<a href="#l23.1821"></a><span id="l23.1821"> </span>
<a href="#l23.1822"></a><span id="l23.1822">   nsMsgJunkStatus junkStatus;</span>
<a href="#l23.1823"></a><span id="l23.1823">   if (aJunkScore &amp;&amp; *aJunkScore) {</span>
<a href="#l23.1824"></a><span id="l23.1824" class="difflineminus">-      junkStatus = (atoi(aJunkScore) == nsIJunkMailPlugin::IS_SPAM_SCORE) ?</span>
<a href="#l23.1825"></a><span id="l23.1825" class="difflineminus">-        nsIJunkMailPlugin::JUNK : nsIJunkMailPlugin::GOOD;</span>
<a href="#l23.1826"></a><span id="l23.1826" class="difflineplus">+    junkStatus = (atoi(aJunkScore) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l23.1827"></a><span id="l23.1827" class="difflineplus">+                     ? nsIJunkMailPlugin::JUNK</span>
<a href="#l23.1828"></a><span id="l23.1828" class="difflineplus">+                     : nsIJunkMailPlugin::GOOD;</span>
<a href="#l23.1829"></a><span id="l23.1829">   } else {</span>
<a href="#l23.1830"></a><span id="l23.1830">     // the in UI, we only show &quot;junk&quot; or &quot;not junk&quot;</span>
<a href="#l23.1831"></a><span id="l23.1831">     // unknown, or nsIJunkMailPlugin::UNCLASSIFIED is shown as not junk</span>
<a href="#l23.1832"></a><span id="l23.1832">     // so for the search to work as expected, treat unknown as not junk</span>
<a href="#l23.1833"></a><span id="l23.1833">     junkStatus = nsIJunkMailPlugin::GOOD;</span>
<a href="#l23.1834"></a><span id="l23.1834">   }</span>
<a href="#l23.1835"></a><span id="l23.1835"> </span>
<a href="#l23.1836"></a><span id="l23.1836">   nsresult rv = NS_OK;</span>
<a href="#l23.1837"></a><span id="l23.1837">   bool matches = (junkStatus == m_value.u.junkStatus);</span>
<a href="#l23.1838"></a><span id="l23.1838"> </span>
<a href="#l23.1839"></a><span id="l23.1839" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1840"></a><span id="l23.1840" class="difflineminus">-  {</span>
<a href="#l23.1841"></a><span id="l23.1841" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1842"></a><span id="l23.1842">     case nsMsgSearchOp::Is:</span>
<a href="#l23.1843"></a><span id="l23.1843">       break;</span>
<a href="#l23.1844"></a><span id="l23.1844">     case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1845"></a><span id="l23.1845">       matches = !matches;</span>
<a href="#l23.1846"></a><span id="l23.1846">       break;</span>
<a href="#l23.1847"></a><span id="l23.1847">     default:</span>
<a href="#l23.1848"></a><span id="l23.1848">       rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1849"></a><span id="l23.1849">       matches = false;</span>
<a href="#l23.1850"></a><span id="l23.1850">       NS_ERROR(&quot;invalid compare op for junk status&quot;);</span>
<a href="#l23.1851"></a><span id="l23.1851">   }</span>
<a href="#l23.1852"></a><span id="l23.1852"> </span>
<a href="#l23.1853"></a><span id="l23.1853">   *pResult = matches;</span>
<a href="#l23.1854"></a><span id="l23.1854">   return rv;</span>
<a href="#l23.1855"></a><span id="l23.1855"> }</span>
<a href="#l23.1856"></a><span id="l23.1856"> </span>
<a href="#l23.1857"></a><span id="l23.1857" class="difflineminus">-nsresult nsMsgSearchTerm::MatchJunkScoreOrigin(const char *aJunkScoreOrigin, bool *pResult)</span>
<a href="#l23.1858"></a><span id="l23.1858" class="difflineminus">-{</span>
<a href="#l23.1859"></a><span id="l23.1859" class="difflineplus">+nsresult nsMsgSearchTerm::MatchJunkScoreOrigin(const char *aJunkScoreOrigin,</span>
<a href="#l23.1860"></a><span id="l23.1860" class="difflineplus">+                                               bool *pResult) {</span>
<a href="#l23.1861"></a><span id="l23.1861">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1862"></a><span id="l23.1862"> </span>
<a href="#l23.1863"></a><span id="l23.1863">   bool matches = false;</span>
<a href="#l23.1864"></a><span id="l23.1864">   nsresult rv = NS_OK;</span>
<a href="#l23.1865"></a><span id="l23.1865"> </span>
<a href="#l23.1866"></a><span id="l23.1866" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1867"></a><span id="l23.1867" class="difflineminus">-  {</span>
<a href="#l23.1868"></a><span id="l23.1868" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1869"></a><span id="l23.1869" class="difflineminus">-    matches = aJunkScoreOrigin &amp;&amp; m_value.utf8String.Equals(aJunkScoreOrigin);</span>
<a href="#l23.1870"></a><span id="l23.1870" class="difflineminus">-    break;</span>
<a href="#l23.1871"></a><span id="l23.1871" class="difflineminus">-  case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1872"></a><span id="l23.1872" class="difflineminus">-    matches = !aJunkScoreOrigin || !m_value.utf8String.Equals(aJunkScoreOrigin);</span>
<a href="#l23.1873"></a><span id="l23.1873" class="difflineminus">-    break;</span>
<a href="#l23.1874"></a><span id="l23.1874" class="difflineminus">-  default:</span>
<a href="#l23.1875"></a><span id="l23.1875" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1876"></a><span id="l23.1876" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for junk score origin&quot;);</span>
<a href="#l23.1877"></a><span id="l23.1877" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1878"></a><span id="l23.1878" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.1879"></a><span id="l23.1879" class="difflineplus">+      matches = aJunkScoreOrigin &amp;&amp; m_value.utf8String.Equals(aJunkScoreOrigin);</span>
<a href="#l23.1880"></a><span id="l23.1880" class="difflineplus">+      break;</span>
<a href="#l23.1881"></a><span id="l23.1881" class="difflineplus">+    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1882"></a><span id="l23.1882" class="difflineplus">+      matches =</span>
<a href="#l23.1883"></a><span id="l23.1883" class="difflineplus">+          !aJunkScoreOrigin || !m_value.utf8String.Equals(aJunkScoreOrigin);</span>
<a href="#l23.1884"></a><span id="l23.1884" class="difflineplus">+      break;</span>
<a href="#l23.1885"></a><span id="l23.1885" class="difflineplus">+    default:</span>
<a href="#l23.1886"></a><span id="l23.1886" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1887"></a><span id="l23.1887" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for junk score origin&quot;);</span>
<a href="#l23.1888"></a><span id="l23.1888">   }</span>
<a href="#l23.1889"></a><span id="l23.1889"> </span>
<a href="#l23.1890"></a><span id="l23.1890">   *pResult = matches;</span>
<a href="#l23.1891"></a><span id="l23.1891">   return rv;</span>
<a href="#l23.1892"></a><span id="l23.1892"> }</span>
<a href="#l23.1893"></a><span id="l23.1893"> </span>
<a href="#l23.1894"></a><span id="l23.1894" class="difflineminus">-nsresult nsMsgSearchTerm::MatchJunkPercent(uint32_t aJunkPercent, bool *pResult)</span>
<a href="#l23.1895"></a><span id="l23.1895" class="difflineminus">-{</span>
<a href="#l23.1896"></a><span id="l23.1896" class="difflineplus">+nsresult nsMsgSearchTerm::MatchJunkPercent(uint32_t aJunkPercent,</span>
<a href="#l23.1897"></a><span id="l23.1897" class="difflineplus">+                                           bool *pResult) {</span>
<a href="#l23.1898"></a><span id="l23.1898">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1899"></a><span id="l23.1899"> </span>
<a href="#l23.1900"></a><span id="l23.1900">   nsresult rv = NS_OK;</span>
<a href="#l23.1901"></a><span id="l23.1901">   bool result = false;</span>
<a href="#l23.1902"></a><span id="l23.1902" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1903"></a><span id="l23.1903" class="difflineminus">-  {</span>
<a href="#l23.1904"></a><span id="l23.1904" class="difflineminus">-  case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l23.1905"></a><span id="l23.1905" class="difflineminus">-    if (aJunkPercent &gt; m_value.u.junkPercent)</span>
<a href="#l23.1906"></a><span id="l23.1906" class="difflineminus">-      result = true;</span>
<a href="#l23.1907"></a><span id="l23.1907" class="difflineminus">-    break;</span>
<a href="#l23.1908"></a><span id="l23.1908" class="difflineminus">-  case nsMsgSearchOp::IsLessThan:</span>
<a href="#l23.1909"></a><span id="l23.1909" class="difflineminus">-    if (aJunkPercent &lt; m_value.u.junkPercent)</span>
<a href="#l23.1910"></a><span id="l23.1910" class="difflineminus">-      result = true;</span>
<a href="#l23.1911"></a><span id="l23.1911" class="difflineminus">-    break;</span>
<a href="#l23.1912"></a><span id="l23.1912" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1913"></a><span id="l23.1913" class="difflineminus">-    if (aJunkPercent == m_value.u.junkPercent)</span>
<a href="#l23.1914"></a><span id="l23.1914" class="difflineminus">-      result = true;</span>
<a href="#l23.1915"></a><span id="l23.1915" class="difflineminus">-    break;</span>
<a href="#l23.1916"></a><span id="l23.1916" class="difflineminus">-  default:</span>
<a href="#l23.1917"></a><span id="l23.1917" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1918"></a><span id="l23.1918" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for junk percent&quot;);</span>
<a href="#l23.1919"></a><span id="l23.1919" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1920"></a><span id="l23.1920" class="difflineplus">+    case nsMsgSearchOp::IsGreaterThan:</span>
<a href="#l23.1921"></a><span id="l23.1921" class="difflineplus">+      if (aJunkPercent &gt; m_value.u.junkPercent) result = true;</span>
<a href="#l23.1922"></a><span id="l23.1922" class="difflineplus">+      break;</span>
<a href="#l23.1923"></a><span id="l23.1923" class="difflineplus">+    case nsMsgSearchOp::IsLessThan:</span>
<a href="#l23.1924"></a><span id="l23.1924" class="difflineplus">+      if (aJunkPercent &lt; m_value.u.junkPercent) result = true;</span>
<a href="#l23.1925"></a><span id="l23.1925" class="difflineplus">+      break;</span>
<a href="#l23.1926"></a><span id="l23.1926" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.1927"></a><span id="l23.1927" class="difflineplus">+      if (aJunkPercent == m_value.u.junkPercent) result = true;</span>
<a href="#l23.1928"></a><span id="l23.1928" class="difflineplus">+      break;</span>
<a href="#l23.1929"></a><span id="l23.1929" class="difflineplus">+    default:</span>
<a href="#l23.1930"></a><span id="l23.1930" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1931"></a><span id="l23.1931" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for junk percent&quot;);</span>
<a href="#l23.1932"></a><span id="l23.1932">   }</span>
<a href="#l23.1933"></a><span id="l23.1933">   *pResult = result;</span>
<a href="#l23.1934"></a><span id="l23.1934">   return rv;</span>
<a href="#l23.1935"></a><span id="l23.1935"> }</span>
<a href="#l23.1936"></a><span id="l23.1936"> </span>
<a href="#l23.1937"></a><span id="l23.1937" class="difflineminus">-</span>
<a href="#l23.1938"></a><span id="l23.1938" class="difflineminus">-nsresult nsMsgSearchTerm::MatchLabel(nsMsgLabelValue aLabelValue, bool *pResult)</span>
<a href="#l23.1939"></a><span id="l23.1939" class="difflineminus">-{</span>
<a href="#l23.1940"></a><span id="l23.1940" class="difflineplus">+nsresult nsMsgSearchTerm::MatchLabel(nsMsgLabelValue aLabelValue,</span>
<a href="#l23.1941"></a><span id="l23.1941" class="difflineplus">+                                     bool *pResult) {</span>
<a href="#l23.1942"></a><span id="l23.1942">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1943"></a><span id="l23.1943"> </span>
<a href="#l23.1944"></a><span id="l23.1944">   nsresult rv = NS_OK;</span>
<a href="#l23.1945"></a><span id="l23.1945">   bool result = false;</span>
<a href="#l23.1946"></a><span id="l23.1946" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1947"></a><span id="l23.1947" class="difflineminus">-  {</span>
<a href="#l23.1948"></a><span id="l23.1948" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1949"></a><span id="l23.1949" class="difflineminus">-    if (m_value.u.label == aLabelValue)</span>
<a href="#l23.1950"></a><span id="l23.1950" class="difflineminus">-      result = true;</span>
<a href="#l23.1951"></a><span id="l23.1951" class="difflineminus">-    break;</span>
<a href="#l23.1952"></a><span id="l23.1952" class="difflineminus">-  case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1953"></a><span id="l23.1953" class="difflineminus">-    if (m_value.u.label != aLabelValue)</span>
<a href="#l23.1954"></a><span id="l23.1954" class="difflineminus">-      result = true;</span>
<a href="#l23.1955"></a><span id="l23.1955" class="difflineminus">-    break;</span>
<a href="#l23.1956"></a><span id="l23.1956" class="difflineminus">-  default:</span>
<a href="#l23.1957"></a><span id="l23.1957" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1958"></a><span id="l23.1958" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for label value&quot;);</span>
<a href="#l23.1959"></a><span id="l23.1959" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.1960"></a><span id="l23.1960" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.1961"></a><span id="l23.1961" class="difflineplus">+      if (m_value.u.label == aLabelValue) result = true;</span>
<a href="#l23.1962"></a><span id="l23.1962" class="difflineplus">+      break;</span>
<a href="#l23.1963"></a><span id="l23.1963" class="difflineplus">+    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1964"></a><span id="l23.1964" class="difflineplus">+      if (m_value.u.label != aLabelValue) result = true;</span>
<a href="#l23.1965"></a><span id="l23.1965" class="difflineplus">+      break;</span>
<a href="#l23.1966"></a><span id="l23.1966" class="difflineplus">+    default:</span>
<a href="#l23.1967"></a><span id="l23.1967" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1968"></a><span id="l23.1968" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for label value&quot;);</span>
<a href="#l23.1969"></a><span id="l23.1969">   }</span>
<a href="#l23.1970"></a><span id="l23.1970"> </span>
<a href="#l23.1971"></a><span id="l23.1971">   *pResult = result;</span>
<a href="#l23.1972"></a><span id="l23.1972">   return rv;</span>
<a href="#l23.1973"></a><span id="l23.1973"> }</span>
<a href="#l23.1974"></a><span id="l23.1974"> </span>
<a href="#l23.1975"></a><span id="l23.1975"> // MatchStatus () is not only used for nsMsgMessageFlags but also for</span>
<a href="#l23.1976"></a><span id="l23.1976"> // nsMsgFolderFlags (both being 'unsigned long')</span>
<a href="#l23.1977"></a><span id="l23.1977" class="difflineminus">-nsresult nsMsgSearchTerm::MatchStatus(uint32_t statusToMatch, bool *pResult)</span>
<a href="#l23.1978"></a><span id="l23.1978" class="difflineminus">-{</span>
<a href="#l23.1979"></a><span id="l23.1979" class="difflineplus">+nsresult nsMsgSearchTerm::MatchStatus(uint32_t statusToMatch, bool *pResult) {</span>
<a href="#l23.1980"></a><span id="l23.1980">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.1981"></a><span id="l23.1981"> </span>
<a href="#l23.1982"></a><span id="l23.1982">   nsresult rv = NS_OK;</span>
<a href="#l23.1983"></a><span id="l23.1983">   bool matches = (statusToMatch &amp; m_value.u.msgStatus);</span>
<a href="#l23.1984"></a><span id="l23.1984"> </span>
<a href="#l23.1985"></a><span id="l23.1985" class="difflineminus">-// nsMsgSearchOp::Is and nsMsgSearchOp::Isnt are intentionally used as</span>
<a href="#l23.1986"></a><span id="l23.1986" class="difflineminus">-// Contains and DoesntContain respectively, for legacy reasons.</span>
<a href="#l23.1987"></a><span id="l23.1987" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.1988"></a><span id="l23.1988" class="difflineminus">-  {</span>
<a href="#l23.1989"></a><span id="l23.1989" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.1990"></a><span id="l23.1990" class="difflineminus">-    break;</span>
<a href="#l23.1991"></a><span id="l23.1991" class="difflineminus">-  case nsMsgSearchOp::Isnt:</span>
<a href="#l23.1992"></a><span id="l23.1992" class="difflineminus">-    matches = !matches;</span>
<a href="#l23.1993"></a><span id="l23.1993" class="difflineminus">-    break;</span>
<a href="#l23.1994"></a><span id="l23.1994" class="difflineminus">-  default:</span>
<a href="#l23.1995"></a><span id="l23.1995" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.1996"></a><span id="l23.1996" class="difflineminus">-    matches = false;</span>
<a href="#l23.1997"></a><span id="l23.1997" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for msg status&quot;);</span>
<a href="#l23.1998"></a><span id="l23.1998" class="difflineplus">+  // nsMsgSearchOp::Is and nsMsgSearchOp::Isnt are intentionally used as</span>
<a href="#l23.1999"></a><span id="l23.1999" class="difflineplus">+  // Contains and DoesntContain respectively, for legacy reasons.</span>
<a href="#l23.2000"></a><span id="l23.2000" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.2001"></a><span id="l23.2001" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.2002"></a><span id="l23.2002" class="difflineplus">+      break;</span>
<a href="#l23.2003"></a><span id="l23.2003" class="difflineplus">+    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.2004"></a><span id="l23.2004" class="difflineplus">+      matches = !matches;</span>
<a href="#l23.2005"></a><span id="l23.2005" class="difflineplus">+      break;</span>
<a href="#l23.2006"></a><span id="l23.2006" class="difflineplus">+    default:</span>
<a href="#l23.2007"></a><span id="l23.2007" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.2008"></a><span id="l23.2008" class="difflineplus">+      matches = false;</span>
<a href="#l23.2009"></a><span id="l23.2009" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for msg status&quot;);</span>
<a href="#l23.2010"></a><span id="l23.2010">   }</span>
<a href="#l23.2011"></a><span id="l23.2011"> </span>
<a href="#l23.2012"></a><span id="l23.2012">   *pResult = matches;</span>
<a href="#l23.2013"></a><span id="l23.2013">   return rv;</span>
<a href="#l23.2014"></a><span id="l23.2014"> }</span>
<a href="#l23.2015"></a><span id="l23.2015"> </span>
<a href="#l23.2016"></a><span id="l23.2016"> /*</span>
<a href="#l23.2017"></a><span id="l23.2017">  * MatchKeyword Logic table (*pResult: + is true, - is false)</span>
<a href="#l23.2018"></a><span id="l23.2018">  *</span>
<a href="#l23.2019"></a><span id="l23.2019">  *         # Valid Tokens IsEmpty IsntEmpty Contains DoesntContain Is     Isnt</span>
<a href="#l23.2020"></a><span id="l23.2020">  *                0           +         -      -         +         -       +</span>
<a href="#l23.2021"></a><span id="l23.2021">  * Term found?                               N   Y     N   Y     N   Y   N   Y</span>
<a href="#l23.2022"></a><span id="l23.2022">  *                1           -         +    -   +     +   -     -   +   +   -</span>
<a href="#l23.2023"></a><span id="l23.2023">  *               &gt;1           -         +    -   +     +   -     -   -   +   +</span>
<a href="#l23.2024"></a><span id="l23.2024">  */</span>
<a href="#l23.2025"></a><span id="l23.2025"> // look up nsMsgSearchTerm::m_value in space-delimited keywordList</span>
<a href="#l23.2026"></a><span id="l23.2026" class="difflineminus">-nsresult nsMsgSearchTerm::MatchKeyword(const nsACString&amp; keywordList, bool *pResult)</span>
<a href="#l23.2027"></a><span id="l23.2027" class="difflineminus">-{</span>
<a href="#l23.2028"></a><span id="l23.2028" class="difflineplus">+nsresult nsMsgSearchTerm::MatchKeyword(const nsACString &amp;keywordList,</span>
<a href="#l23.2029"></a><span id="l23.2029" class="difflineplus">+                                       bool *pResult) {</span>
<a href="#l23.2030"></a><span id="l23.2030">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.2031"></a><span id="l23.2031"> </span>
<a href="#l23.2032"></a><span id="l23.2032">   bool matches = false;</span>
<a href="#l23.2033"></a><span id="l23.2033"> </span>
<a href="#l23.2034"></a><span id="l23.2034">   // special-case empty for performance reasons</span>
<a href="#l23.2035"></a><span id="l23.2035" class="difflineminus">-  if (keywordList.IsEmpty())</span>
<a href="#l23.2036"></a><span id="l23.2036" class="difflineminus">-  {</span>
<a href="#l23.2037"></a><span id="l23.2037" class="difflineminus">-    *pResult =  m_operator != nsMsgSearchOp::Contains &amp;&amp;</span>
<a href="#l23.2038"></a><span id="l23.2038" class="difflineminus">-                m_operator != nsMsgSearchOp::Is &amp;&amp;</span>
<a href="#l23.2039"></a><span id="l23.2039" class="difflineminus">-                m_operator != nsMsgSearchOp::IsntEmpty;</span>
<a href="#l23.2040"></a><span id="l23.2040" class="difflineplus">+  if (keywordList.IsEmpty()) {</span>
<a href="#l23.2041"></a><span id="l23.2041" class="difflineplus">+    *pResult = m_operator != nsMsgSearchOp::Contains &amp;&amp;</span>
<a href="#l23.2042"></a><span id="l23.2042" class="difflineplus">+               m_operator != nsMsgSearchOp::Is &amp;&amp;</span>
<a href="#l23.2043"></a><span id="l23.2043" class="difflineplus">+               m_operator != nsMsgSearchOp::IsntEmpty;</span>
<a href="#l23.2044"></a><span id="l23.2044">     return NS_OK;</span>
<a href="#l23.2045"></a><span id="l23.2045">   }</span>
<a href="#l23.2046"></a><span id="l23.2046"> </span>
<a href="#l23.2047"></a><span id="l23.2047">   // check if we can skip expensive valid keywordList test</span>
<a href="#l23.2048"></a><span id="l23.2048">   if (m_operator == nsMsgSearchOp::DoesntContain ||</span>
<a href="#l23.2049"></a><span id="l23.2049" class="difflineminus">-      m_operator == nsMsgSearchOp::Contains)</span>
<a href="#l23.2050"></a><span id="l23.2050" class="difflineminus">-  {</span>
<a href="#l23.2051"></a><span id="l23.2051" class="difflineplus">+      m_operator == nsMsgSearchOp::Contains) {</span>
<a href="#l23.2052"></a><span id="l23.2052">     nsCString keywordString(keywordList);</span>
<a href="#l23.2053"></a><span id="l23.2053">     const uint32_t kKeywordLen = m_value.utf8String.Length();</span>
<a href="#l23.2054"></a><span id="l23.2054" class="difflineminus">-    const char* matchStart = PL_strstr(keywordString.get(), m_value.utf8String.get());</span>
<a href="#l23.2055"></a><span id="l23.2055" class="difflineminus">-    while (matchStart)</span>
<a href="#l23.2056"></a><span id="l23.2056" class="difflineminus">-    {</span>
<a href="#l23.2057"></a><span id="l23.2057" class="difflineplus">+    const char *matchStart =</span>
<a href="#l23.2058"></a><span id="l23.2058" class="difflineplus">+        PL_strstr(keywordString.get(), m_value.utf8String.get());</span>
<a href="#l23.2059"></a><span id="l23.2059" class="difflineplus">+    while (matchStart) {</span>
<a href="#l23.2060"></a><span id="l23.2060">       // For a real match, matchStart must be the start of the keywordList or</span>
<a href="#l23.2061"></a><span id="l23.2061">       // preceded by a space and matchEnd must point to a \0 or space.</span>
<a href="#l23.2062"></a><span id="l23.2062" class="difflineminus">-      const char* matchEnd = matchStart + kKeywordLen;</span>
<a href="#l23.2063"></a><span id="l23.2063" class="difflineplus">+      const char *matchEnd = matchStart + kKeywordLen;</span>
<a href="#l23.2064"></a><span id="l23.2064">       if ((matchStart == keywordString.get() || matchStart[-1] == ' ') &amp;&amp;</span>
<a href="#l23.2065"></a><span id="l23.2065" class="difflineminus">-          (!*matchEnd || *matchEnd == ' '))</span>
<a href="#l23.2066"></a><span id="l23.2066" class="difflineminus">-      {</span>
<a href="#l23.2067"></a><span id="l23.2067" class="difflineplus">+          (!*matchEnd || *matchEnd == ' ')) {</span>
<a href="#l23.2068"></a><span id="l23.2068">         // found the keyword</span>
<a href="#l23.2069"></a><span id="l23.2069">         *pResult = m_operator == nsMsgSearchOp::Contains;</span>
<a href="#l23.2070"></a><span id="l23.2070">         return NS_OK;</span>
<a href="#l23.2071"></a><span id="l23.2071">       }</span>
<a href="#l23.2072"></a><span id="l23.2072">       // no match yet, so search on</span>
<a href="#l23.2073"></a><span id="l23.2073">       matchStart = PL_strstr(matchEnd, m_value.utf8String.get());</span>
<a href="#l23.2074"></a><span id="l23.2074">     }</span>
<a href="#l23.2075"></a><span id="l23.2075">     // keyword not found</span>
<a href="#l23.2076"></a><span id="l23.2076">     *pResult = m_operator == nsMsgSearchOp::DoesntContain;</span>
<a href="#l23.2077"></a><span id="l23.2077">     return NS_OK;</span>
<a href="#l23.2078"></a><span id="l23.2078">   }</span>
<a href="#l23.2079"></a><span id="l23.2079"> </span>
<a href="#l23.2080"></a><span id="l23.2080">   // Only accept valid keys in tokens.</span>
<a href="#l23.2081"></a><span id="l23.2081">   nsresult rv = NS_OK;</span>
<a href="#l23.2082"></a><span id="l23.2082">   nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l23.2083"></a><span id="l23.2083">   ParseString(keywordList, ' ', keywordArray);</span>
<a href="#l23.2084"></a><span id="l23.2084" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTagService&gt; tagService(do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.2085"></a><span id="l23.2085" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTagService&gt; tagService(</span>
<a href="#l23.2086"></a><span id="l23.2086" class="difflineplus">+      do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.2087"></a><span id="l23.2087">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2088"></a><span id="l23.2088"> </span>
<a href="#l23.2089"></a><span id="l23.2089">   // Loop through tokens in keywords</span>
<a href="#l23.2090"></a><span id="l23.2090">   uint32_t count = keywordArray.Length();</span>
<a href="#l23.2091"></a><span id="l23.2091" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l23.2092"></a><span id="l23.2092" class="difflineminus">-  {</span>
<a href="#l23.2093"></a><span id="l23.2093" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l23.2094"></a><span id="l23.2094">     // is this token a valid tag? Otherwise ignore it</span>
<a href="#l23.2095"></a><span id="l23.2095">     bool isValid;</span>
<a href="#l23.2096"></a><span id="l23.2096">     rv = tagService-&gt;IsValidKey(keywordArray[i], &amp;isValid);</span>
<a href="#l23.2097"></a><span id="l23.2097">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2098"></a><span id="l23.2098"> </span>
<a href="#l23.2099"></a><span id="l23.2099" class="difflineminus">-    if (isValid)</span>
<a href="#l23.2100"></a><span id="l23.2100" class="difflineminus">-    {</span>
<a href="#l23.2101"></a><span id="l23.2101" class="difflineplus">+    if (isValid) {</span>
<a href="#l23.2102"></a><span id="l23.2102">       // IsEmpty fails on any valid token</span>
<a href="#l23.2103"></a><span id="l23.2103" class="difflineminus">-      if (m_operator == nsMsgSearchOp::IsEmpty)</span>
<a href="#l23.2104"></a><span id="l23.2104" class="difflineminus">-      {</span>
<a href="#l23.2105"></a><span id="l23.2105" class="difflineplus">+      if (m_operator == nsMsgSearchOp::IsEmpty) {</span>
<a href="#l23.2106"></a><span id="l23.2106">         *pResult = false;</span>
<a href="#l23.2107"></a><span id="l23.2107">         return rv;</span>
<a href="#l23.2108"></a><span id="l23.2108">       }</span>
<a href="#l23.2109"></a><span id="l23.2109"> </span>
<a href="#l23.2110"></a><span id="l23.2110">       // IsntEmpty succeeds on any valid token</span>
<a href="#l23.2111"></a><span id="l23.2111" class="difflineminus">-      if (m_operator == nsMsgSearchOp::IsntEmpty)</span>
<a href="#l23.2112"></a><span id="l23.2112" class="difflineminus">-      {</span>
<a href="#l23.2113"></a><span id="l23.2113" class="difflineplus">+      if (m_operator == nsMsgSearchOp::IsntEmpty) {</span>
<a href="#l23.2114"></a><span id="l23.2114">         *pResult = true;</span>
<a href="#l23.2115"></a><span id="l23.2115">         return rv;</span>
<a href="#l23.2116"></a><span id="l23.2116">       }</span>
<a href="#l23.2117"></a><span id="l23.2117"> </span>
<a href="#l23.2118"></a><span id="l23.2118">       // Does this valid tag key match our search term?</span>
<a href="#l23.2119"></a><span id="l23.2119">       matches = keywordArray[i].Equals(m_value.utf8String);</span>
<a href="#l23.2120"></a><span id="l23.2120"> </span>
<a href="#l23.2121"></a><span id="l23.2121">       // Is or Isn't partly determined on a single unmatched token</span>
<a href="#l23.2122"></a><span id="l23.2122" class="difflineminus">-      if (!matches)</span>
<a href="#l23.2123"></a><span id="l23.2123" class="difflineminus">-      {</span>
<a href="#l23.2124"></a><span id="l23.2124" class="difflineminus">-        if (m_operator == nsMsgSearchOp::Is)</span>
<a href="#l23.2125"></a><span id="l23.2125" class="difflineminus">-        {</span>
<a href="#l23.2126"></a><span id="l23.2126" class="difflineplus">+      if (!matches) {</span>
<a href="#l23.2127"></a><span id="l23.2127" class="difflineplus">+        if (m_operator == nsMsgSearchOp::Is) {</span>
<a href="#l23.2128"></a><span id="l23.2128">           *pResult = false;</span>
<a href="#l23.2129"></a><span id="l23.2129">           return rv;</span>
<a href="#l23.2130"></a><span id="l23.2130">         }</span>
<a href="#l23.2131"></a><span id="l23.2131" class="difflineminus">-        if (m_operator == nsMsgSearchOp::Isnt)</span>
<a href="#l23.2132"></a><span id="l23.2132" class="difflineminus">-        {</span>
<a href="#l23.2133"></a><span id="l23.2133" class="difflineplus">+        if (m_operator == nsMsgSearchOp::Isnt) {</span>
<a href="#l23.2134"></a><span id="l23.2134">           *pResult = true;</span>
<a href="#l23.2135"></a><span id="l23.2135">           return rv;</span>
<a href="#l23.2136"></a><span id="l23.2136">         }</span>
<a href="#l23.2137"></a><span id="l23.2137">       }</span>
<a href="#l23.2138"></a><span id="l23.2138">     }</span>
<a href="#l23.2139"></a><span id="l23.2139">   }</span>
<a href="#l23.2140"></a><span id="l23.2140"> </span>
<a href="#l23.2141"></a><span id="l23.2141" class="difflineminus">-  if (m_operator == nsMsgSearchOp::Is)</span>
<a href="#l23.2142"></a><span id="l23.2142" class="difflineminus">-  {</span>
<a href="#l23.2143"></a><span id="l23.2143" class="difflineplus">+  if (m_operator == nsMsgSearchOp::Is) {</span>
<a href="#l23.2144"></a><span id="l23.2144">     *pResult = matches;</span>
<a href="#l23.2145"></a><span id="l23.2145">     return NS_OK;</span>
<a href="#l23.2146"></a><span id="l23.2146">   }</span>
<a href="#l23.2147"></a><span id="l23.2147"> </span>
<a href="#l23.2148"></a><span id="l23.2148" class="difflineminus">-  if (m_operator == nsMsgSearchOp::Isnt)</span>
<a href="#l23.2149"></a><span id="l23.2149" class="difflineminus">-  {</span>
<a href="#l23.2150"></a><span id="l23.2150" class="difflineplus">+  if (m_operator == nsMsgSearchOp::Isnt) {</span>
<a href="#l23.2151"></a><span id="l23.2151">     *pResult = !matches;</span>
<a href="#l23.2152"></a><span id="l23.2152">     return NS_OK;</span>
<a href="#l23.2153"></a><span id="l23.2153">   }</span>
<a href="#l23.2154"></a><span id="l23.2154"> </span>
<a href="#l23.2155"></a><span id="l23.2155" class="difflineminus">-  if (m_operator == nsMsgSearchOp::IsEmpty)</span>
<a href="#l23.2156"></a><span id="l23.2156" class="difflineminus">-  {</span>
<a href="#l23.2157"></a><span id="l23.2157" class="difflineplus">+  if (m_operator == nsMsgSearchOp::IsEmpty) {</span>
<a href="#l23.2158"></a><span id="l23.2158">     *pResult = true;</span>
<a href="#l23.2159"></a><span id="l23.2159">     return NS_OK;</span>
<a href="#l23.2160"></a><span id="l23.2160">   }</span>
<a href="#l23.2161"></a><span id="l23.2161"> </span>
<a href="#l23.2162"></a><span id="l23.2162" class="difflineminus">-  if (m_operator == nsMsgSearchOp::IsntEmpty)</span>
<a href="#l23.2163"></a><span id="l23.2163" class="difflineminus">-  {</span>
<a href="#l23.2164"></a><span id="l23.2164" class="difflineplus">+  if (m_operator == nsMsgSearchOp::IsntEmpty) {</span>
<a href="#l23.2165"></a><span id="l23.2165">     *pResult = false;</span>
<a href="#l23.2166"></a><span id="l23.2166">     return NS_OK;</span>
<a href="#l23.2167"></a><span id="l23.2167">   }</span>
<a href="#l23.2168"></a><span id="l23.2168"> </span>
<a href="#l23.2169"></a><span id="l23.2169">   // no valid match operator found</span>
<a href="#l23.2170"></a><span id="l23.2170">   *pResult = false;</span>
<a href="#l23.2171"></a><span id="l23.2171">   NS_ERROR(&quot;invalid compare op for msg status&quot;);</span>
<a href="#l23.2172"></a><span id="l23.2172">   return NS_ERROR_FAILURE;</span>
<a href="#l23.2173"></a><span id="l23.2173"> }</span>
<a href="#l23.2174"></a><span id="l23.2174"> </span>
<a href="#l23.2175"></a><span id="l23.2175" class="difflineminus">-nsresult</span>
<a href="#l23.2176"></a><span id="l23.2176" class="difflineminus">-nsMsgSearchTerm::MatchPriority (nsMsgPriorityValue priorityToMatch,</span>
<a href="#l23.2177"></a><span id="l23.2177" class="difflineminus">-                                bool *pResult)</span>
<a href="#l23.2178"></a><span id="l23.2178" class="difflineminus">-{</span>
<a href="#l23.2179"></a><span id="l23.2179" class="difflineplus">+nsresult nsMsgSearchTerm::MatchPriority(nsMsgPriorityValue priorityToMatch,</span>
<a href="#l23.2180"></a><span id="l23.2180" class="difflineplus">+                                        bool *pResult) {</span>
<a href="#l23.2181"></a><span id="l23.2181">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.2182"></a><span id="l23.2182"> </span>
<a href="#l23.2183"></a><span id="l23.2183">   nsresult rv = NS_OK;</span>
<a href="#l23.2184"></a><span id="l23.2184">   bool result = false;</span>
<a href="#l23.2185"></a><span id="l23.2185"> </span>
<a href="#l23.2186"></a><span id="l23.2186">   // Use this ugly little hack to get around the fact that enums don't have</span>
<a href="#l23.2187"></a><span id="l23.2187">   // integer compare operators</span>
<a href="#l23.2188"></a><span id="l23.2188" class="difflineminus">-  int p1 = (priorityToMatch == nsMsgPriority::none) ? (int) nsMsgPriority::normal : (int) priorityToMatch;</span>
<a href="#l23.2189"></a><span id="l23.2189" class="difflineminus">-  int p2 = (int) m_value.u.priority;</span>
<a href="#l23.2190"></a><span id="l23.2190" class="difflineplus">+  int p1 = (priorityToMatch == nsMsgPriority::none) ? (int)nsMsgPriority::normal</span>
<a href="#l23.2191"></a><span id="l23.2191" class="difflineplus">+                                                    : (int)priorityToMatch;</span>
<a href="#l23.2192"></a><span id="l23.2192" class="difflineplus">+  int p2 = (int)m_value.u.priority;</span>
<a href="#l23.2193"></a><span id="l23.2193"> </span>
<a href="#l23.2194"></a><span id="l23.2194" class="difflineminus">-  switch (m_operator)</span>
<a href="#l23.2195"></a><span id="l23.2195" class="difflineminus">-  {</span>
<a href="#l23.2196"></a><span id="l23.2196" class="difflineminus">-  case nsMsgSearchOp::IsHigherThan:</span>
<a href="#l23.2197"></a><span id="l23.2197" class="difflineminus">-    if (p1 &gt; p2)</span>
<a href="#l23.2198"></a><span id="l23.2198" class="difflineminus">-      result = true;</span>
<a href="#l23.2199"></a><span id="l23.2199" class="difflineminus">-    break;</span>
<a href="#l23.2200"></a><span id="l23.2200" class="difflineminus">-  case nsMsgSearchOp::IsLowerThan:</span>
<a href="#l23.2201"></a><span id="l23.2201" class="difflineminus">-    if (p1 &lt; p2)</span>
<a href="#l23.2202"></a><span id="l23.2202" class="difflineminus">-      result = true;</span>
<a href="#l23.2203"></a><span id="l23.2203" class="difflineminus">-    break;</span>
<a href="#l23.2204"></a><span id="l23.2204" class="difflineminus">-  case nsMsgSearchOp::Is:</span>
<a href="#l23.2205"></a><span id="l23.2205" class="difflineminus">-    if (p1 == p2)</span>
<a href="#l23.2206"></a><span id="l23.2206" class="difflineminus">-      result = true;</span>
<a href="#l23.2207"></a><span id="l23.2207" class="difflineminus">-    break;</span>
<a href="#l23.2208"></a><span id="l23.2208" class="difflineminus">-  case nsMsgSearchOp::Isnt:</span>
<a href="#l23.2209"></a><span id="l23.2209" class="difflineminus">-    if (p1 != p2)</span>
<a href="#l23.2210"></a><span id="l23.2210" class="difflineminus">-      result = true;</span>
<a href="#l23.2211"></a><span id="l23.2211" class="difflineminus">-    break;</span>
<a href="#l23.2212"></a><span id="l23.2212" class="difflineminus">-  default:</span>
<a href="#l23.2213"></a><span id="l23.2213" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l23.2214"></a><span id="l23.2214" class="difflineminus">-    NS_ERROR(&quot;invalid compare op for priority&quot;);</span>
<a href="#l23.2215"></a><span id="l23.2215" class="difflineplus">+  switch (m_operator) {</span>
<a href="#l23.2216"></a><span id="l23.2216" class="difflineplus">+    case nsMsgSearchOp::IsHigherThan:</span>
<a href="#l23.2217"></a><span id="l23.2217" class="difflineplus">+      if (p1 &gt; p2) result = true;</span>
<a href="#l23.2218"></a><span id="l23.2218" class="difflineplus">+      break;</span>
<a href="#l23.2219"></a><span id="l23.2219" class="difflineplus">+    case nsMsgSearchOp::IsLowerThan:</span>
<a href="#l23.2220"></a><span id="l23.2220" class="difflineplus">+      if (p1 &lt; p2) result = true;</span>
<a href="#l23.2221"></a><span id="l23.2221" class="difflineplus">+      break;</span>
<a href="#l23.2222"></a><span id="l23.2222" class="difflineplus">+    case nsMsgSearchOp::Is:</span>
<a href="#l23.2223"></a><span id="l23.2223" class="difflineplus">+      if (p1 == p2) result = true;</span>
<a href="#l23.2224"></a><span id="l23.2224" class="difflineplus">+      break;</span>
<a href="#l23.2225"></a><span id="l23.2225" class="difflineplus">+    case nsMsgSearchOp::Isnt:</span>
<a href="#l23.2226"></a><span id="l23.2226" class="difflineplus">+      if (p1 != p2) result = true;</span>
<a href="#l23.2227"></a><span id="l23.2227" class="difflineplus">+      break;</span>
<a href="#l23.2228"></a><span id="l23.2228" class="difflineplus">+    default:</span>
<a href="#l23.2229"></a><span id="l23.2229" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l23.2230"></a><span id="l23.2230" class="difflineplus">+      NS_ERROR(&quot;invalid compare op for priority&quot;);</span>
<a href="#l23.2231"></a><span id="l23.2231">   }</span>
<a href="#l23.2232"></a><span id="l23.2232">   *pResult = result;</span>
<a href="#l23.2233"></a><span id="l23.2233">   return rv;</span>
<a href="#l23.2234"></a><span id="l23.2234"> }</span>
<a href="#l23.2235"></a><span id="l23.2235"> </span>
<a href="#l23.2236"></a><span id="l23.2236"> // match a custom search term</span>
<a href="#l23.2237"></a><span id="l23.2237" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::MatchCustom(nsIMsgDBHdr* aHdr, bool *pResult)</span>
<a href="#l23.2238"></a><span id="l23.2238" class="difflineminus">-{</span>
<a href="#l23.2239"></a><span id="l23.2239" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::MatchCustom(nsIMsgDBHdr *aHdr, bool *pResult) {</span>
<a href="#l23.2240"></a><span id="l23.2240">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l23.2241"></a><span id="l23.2241"> </span>
<a href="#l23.2242"></a><span id="l23.2242">   nsresult rv;</span>
<a href="#l23.2243"></a><span id="l23.2243">   nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l23.2244"></a><span id="l23.2244">       do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l23.2245"></a><span id="l23.2245">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2246"></a><span id="l23.2246"> </span>
<a href="#l23.2247"></a><span id="l23.2247">   nsCOMPtr&lt;nsIMsgSearchCustomTerm&gt; customTerm;</span>
<a href="#l23.2248"></a><span id="l23.2248">   rv = filterService-&gt;GetCustomTerm(m_customId, getter_AddRefs(customTerm));</span>
<a href="#l23.2249"></a><span id="l23.2249">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2250"></a><span id="l23.2250"> </span>
<a href="#l23.2251"></a><span id="l23.2251">   if (customTerm)</span>
<a href="#l23.2252"></a><span id="l23.2252" class="difflineminus">-    return customTerm-&gt;Match(aHdr, m_value.utf8String,</span>
<a href="#l23.2253"></a><span id="l23.2253" class="difflineminus">-                             m_operator, pResult);</span>
<a href="#l23.2254"></a><span id="l23.2254" class="difflineminus">-  *pResult = false;     // default to no match if term is missing</span>
<a href="#l23.2255"></a><span id="l23.2255" class="difflineminus">-  return NS_ERROR_FAILURE; // missing custom term</span>
<a href="#l23.2256"></a><span id="l23.2256" class="difflineplus">+    return customTerm-&gt;Match(aHdr, m_value.utf8String, m_operator, pResult);</span>
<a href="#l23.2257"></a><span id="l23.2257" class="difflineplus">+  *pResult = false;         // default to no match if term is missing</span>
<a href="#l23.2258"></a><span id="l23.2258" class="difflineplus">+  return NS_ERROR_FAILURE;  // missing custom term</span>
<a href="#l23.2259"></a><span id="l23.2259"> }</span>
<a href="#l23.2260"></a><span id="l23.2260"> </span>
<a href="#l23.2261"></a><span id="l23.2261"> // set the id of a custom search term</span>
<a href="#l23.2262"></a><span id="l23.2262" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::SetCustomId(const nsACString &amp;aId)</span>
<a href="#l23.2263"></a><span id="l23.2263" class="difflineminus">-{</span>
<a href="#l23.2264"></a><span id="l23.2264" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::SetCustomId(const nsACString &amp;aId) {</span>
<a href="#l23.2265"></a><span id="l23.2265">   m_customId = aId;</span>
<a href="#l23.2266"></a><span id="l23.2266">   return NS_OK;</span>
<a href="#l23.2267"></a><span id="l23.2267"> }</span>
<a href="#l23.2268"></a><span id="l23.2268"> </span>
<a href="#l23.2269"></a><span id="l23.2269"> // get the id of a custom search term</span>
<a href="#l23.2270"></a><span id="l23.2270" class="difflineminus">-NS_IMETHODIMP nsMsgSearchTerm::GetCustomId(nsACString &amp;aResult)</span>
<a href="#l23.2271"></a><span id="l23.2271" class="difflineminus">-{</span>
<a href="#l23.2272"></a><span id="l23.2272" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::GetCustomId(nsACString &amp;aResult) {</span>
<a href="#l23.2273"></a><span id="l23.2273">   aResult = m_customId;</span>
<a href="#l23.2274"></a><span id="l23.2274">   return NS_OK;</span>
<a href="#l23.2275"></a><span id="l23.2275"> }</span>
<a href="#l23.2276"></a><span id="l23.2276"> </span>
<a href="#l23.2277"></a><span id="l23.2277" class="difflineminus">-</span>
<a href="#l23.2278"></a><span id="l23.2278"> NS_IMPL_GETSET(nsMsgSearchTerm, Attrib, nsMsgSearchAttribValue, m_attribute)</span>
<a href="#l23.2279"></a><span id="l23.2279"> NS_IMPL_GETSET(nsMsgSearchTerm, Op, nsMsgSearchOpValue, m_operator)</span>
<a href="#l23.2280"></a><span id="l23.2280"> NS_IMPL_GETSET(nsMsgSearchTerm, MatchAll, bool, m_matchAll)</span>
<a href="#l23.2281"></a><span id="l23.2281"> </span>
<a href="#l23.2282"></a><span id="l23.2282"> NS_IMETHODIMP</span>
<a href="#l23.2283"></a><span id="l23.2283" class="difflineminus">-nsMsgSearchTerm::GetValue(nsIMsgSearchValue **aResult)</span>
<a href="#l23.2284"></a><span id="l23.2284" class="difflineminus">-{</span>
<a href="#l23.2285"></a><span id="l23.2285" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.2286"></a><span id="l23.2286" class="difflineminus">-    NS_ADDREF(*aResult = new nsMsgSearchValueImpl(&amp;m_value));</span>
<a href="#l23.2287"></a><span id="l23.2287" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.2288"></a><span id="l23.2288" class="difflineminus">-}</span>
<a href="#l23.2289"></a><span id="l23.2289" class="difflineminus">-</span>
<a href="#l23.2290"></a><span id="l23.2290" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l23.2291"></a><span id="l23.2291" class="difflineminus">-nsMsgSearchTerm::SetValue(nsIMsgSearchValue* aValue)</span>
<a href="#l23.2292"></a><span id="l23.2292" class="difflineminus">-{</span>
<a href="#l23.2293"></a><span id="l23.2293" class="difflineminus">-  nsMsgResultElement::AssignValues (aValue, &amp;m_value);</span>
<a href="#l23.2294"></a><span id="l23.2294" class="difflineplus">+nsMsgSearchTerm::GetValue(nsIMsgSearchValue **aResult) {</span>
<a href="#l23.2295"></a><span id="l23.2295" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.2296"></a><span id="l23.2296" class="difflineplus">+  NS_ADDREF(*aResult = new nsMsgSearchValueImpl(&amp;m_value));</span>
<a href="#l23.2297"></a><span id="l23.2297">   return NS_OK;</span>
<a href="#l23.2298"></a><span id="l23.2298"> }</span>
<a href="#l23.2299"></a><span id="l23.2299"> </span>
<a href="#l23.2300"></a><span id="l23.2300"> NS_IMETHODIMP</span>
<a href="#l23.2301"></a><span id="l23.2301" class="difflineminus">-nsMsgSearchTerm::GetBooleanAnd(bool *aResult)</span>
<a href="#l23.2302"></a><span id="l23.2302" class="difflineminus">-{</span>
<a href="#l23.2303"></a><span id="l23.2303" class="difflineplus">+nsMsgSearchTerm::SetValue(nsIMsgSearchValue *aValue) {</span>
<a href="#l23.2304"></a><span id="l23.2304" class="difflineplus">+  nsMsgResultElement::AssignValues(aValue, &amp;m_value);</span>
<a href="#l23.2305"></a><span id="l23.2305" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.2306"></a><span id="l23.2306" class="difflineplus">+}</span>
<a href="#l23.2307"></a><span id="l23.2307" class="difflineplus">+</span>
<a href="#l23.2308"></a><span id="l23.2308" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l23.2309"></a><span id="l23.2309" class="difflineplus">+nsMsgSearchTerm::GetBooleanAnd(bool *aResult) {</span>
<a href="#l23.2310"></a><span id="l23.2310">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.2311"></a><span id="l23.2311">   *aResult = (m_booleanOp == nsMsgSearchBooleanOp::BooleanAND);</span>
<a href="#l23.2312"></a><span id="l23.2312">   return NS_OK;</span>
<a href="#l23.2313"></a><span id="l23.2313"> }</span>
<a href="#l23.2314"></a><span id="l23.2314"> </span>
<a href="#l23.2315"></a><span id="l23.2315"> NS_IMETHODIMP</span>
<a href="#l23.2316"></a><span id="l23.2316" class="difflineminus">-nsMsgSearchTerm::SetBooleanAnd(bool aValue)</span>
<a href="#l23.2317"></a><span id="l23.2317" class="difflineminus">-{</span>
<a href="#l23.2318"></a><span id="l23.2318" class="difflineplus">+nsMsgSearchTerm::SetBooleanAnd(bool aValue) {</span>
<a href="#l23.2319"></a><span id="l23.2319">   if (aValue)</span>
<a href="#l23.2320"></a><span id="l23.2320">     m_booleanOp = nsMsgSearchBooleanOperator(nsMsgSearchBooleanOp::BooleanAND);</span>
<a href="#l23.2321"></a><span id="l23.2321">   else</span>
<a href="#l23.2322"></a><span id="l23.2322">     m_booleanOp = nsMsgSearchBooleanOperator(nsMsgSearchBooleanOp::BooleanOR);</span>
<a href="#l23.2323"></a><span id="l23.2323">   return NS_OK;</span>
<a href="#l23.2324"></a><span id="l23.2324"> }</span>
<a href="#l23.2325"></a><span id="l23.2325"> </span>
<a href="#l23.2326"></a><span id="l23.2326"> NS_IMETHODIMP</span>
<a href="#l23.2327"></a><span id="l23.2327" class="difflineminus">-nsMsgSearchTerm::GetArbitraryHeader(nsACString &amp;aResult)</span>
<a href="#l23.2328"></a><span id="l23.2328" class="difflineminus">-{</span>
<a href="#l23.2329"></a><span id="l23.2329" class="difflineplus">+nsMsgSearchTerm::GetArbitraryHeader(nsACString &amp;aResult) {</span>
<a href="#l23.2330"></a><span id="l23.2330">   aResult = m_arbitraryHeader;</span>
<a href="#l23.2331"></a><span id="l23.2331">   return NS_OK;</span>
<a href="#l23.2332"></a><span id="l23.2332"> }</span>
<a href="#l23.2333"></a><span id="l23.2333"> </span>
<a href="#l23.2334"></a><span id="l23.2334"> NS_IMETHODIMP</span>
<a href="#l23.2335"></a><span id="l23.2335" class="difflineminus">-nsMsgSearchTerm::SetArbitraryHeader(const nsACString &amp;aValue)</span>
<a href="#l23.2336"></a><span id="l23.2336" class="difflineminus">-{</span>
<a href="#l23.2337"></a><span id="l23.2337" class="difflineplus">+nsMsgSearchTerm::SetArbitraryHeader(const nsACString &amp;aValue) {</span>
<a href="#l23.2338"></a><span id="l23.2338">   m_arbitraryHeader = aValue;</span>
<a href="#l23.2339"></a><span id="l23.2339">   ToLowerCaseExceptSpecials(m_arbitraryHeader);</span>
<a href="#l23.2340"></a><span id="l23.2340">   return NS_OK;</span>
<a href="#l23.2341"></a><span id="l23.2341"> }</span>
<a href="#l23.2342"></a><span id="l23.2342"> </span>
<a href="#l23.2343"></a><span id="l23.2343"> NS_IMETHODIMP</span>
<a href="#l23.2344"></a><span id="l23.2344" class="difflineminus">-nsMsgSearchTerm::GetHdrProperty(nsACString &amp;aResult)</span>
<a href="#l23.2345"></a><span id="l23.2345" class="difflineminus">-{</span>
<a href="#l23.2346"></a><span id="l23.2346" class="difflineplus">+nsMsgSearchTerm::GetHdrProperty(nsACString &amp;aResult) {</span>
<a href="#l23.2347"></a><span id="l23.2347">   aResult = m_hdrProperty;</span>
<a href="#l23.2348"></a><span id="l23.2348">   return NS_OK;</span>
<a href="#l23.2349"></a><span id="l23.2349"> }</span>
<a href="#l23.2350"></a><span id="l23.2350"> </span>
<a href="#l23.2351"></a><span id="l23.2351"> NS_IMETHODIMP</span>
<a href="#l23.2352"></a><span id="l23.2352" class="difflineminus">-nsMsgSearchTerm::SetHdrProperty(const nsACString &amp;aValue)</span>
<a href="#l23.2353"></a><span id="l23.2353" class="difflineminus">-{</span>
<a href="#l23.2354"></a><span id="l23.2354" class="difflineplus">+nsMsgSearchTerm::SetHdrProperty(const nsACString &amp;aValue) {</span>
<a href="#l23.2355"></a><span id="l23.2355">   m_hdrProperty = aValue;</span>
<a href="#l23.2356"></a><span id="l23.2356">   ToLowerCaseExceptSpecials(m_hdrProperty);</span>
<a href="#l23.2357"></a><span id="l23.2357">   return NS_OK;</span>
<a href="#l23.2358"></a><span id="l23.2358"> }</span>
<a href="#l23.2359"></a><span id="l23.2359"> </span>
<a href="#l23.2360"></a><span id="l23.2360"> NS_IMPL_GETSET(nsMsgSearchTerm, BeginsGrouping, bool, mBeginsGrouping)</span>
<a href="#l23.2361"></a><span id="l23.2361"> NS_IMPL_GETSET(nsMsgSearchTerm, EndsGrouping, bool, mEndsGrouping)</span>
<a href="#l23.2362"></a><span id="l23.2362"> </span>
<a href="#l23.2363"></a><span id="l23.2363"> //</span>
<a href="#l23.2364"></a><span id="l23.2364"> // Certain possible standard values of a message database row also sometimes</span>
<a href="#l23.2365"></a><span id="l23.2365"> // appear as header values. To prevent a naming collision, we use all</span>
<a href="#l23.2366"></a><span id="l23.2366"> // lower case for the standard headers, and first capital when those</span>
<a href="#l23.2367"></a><span id="l23.2367"> // same strings are requested as arbitrary headers. This routine is used</span>
<a href="#l23.2368"></a><span id="l23.2368"> // when setting arbitrary headers.</span>
<a href="#l23.2369"></a><span id="l23.2369"> //</span>
<a href="#l23.2370"></a><span id="l23.2370" class="difflineminus">-void nsMsgSearchTerm::ToLowerCaseExceptSpecials(nsACString &amp;aValue)</span>
<a href="#l23.2371"></a><span id="l23.2371" class="difflineminus">-{</span>
<a href="#l23.2372"></a><span id="l23.2372" class="difflineplus">+void nsMsgSearchTerm::ToLowerCaseExceptSpecials(nsACString &amp;aValue) {</span>
<a href="#l23.2373"></a><span id="l23.2373">   if (aValue.LowerCaseEqualsLiteral(&quot;sender&quot;))</span>
<a href="#l23.2374"></a><span id="l23.2374">     aValue.AssignLiteral(&quot;Sender&quot;);</span>
<a href="#l23.2375"></a><span id="l23.2375">   else if (aValue.LowerCaseEqualsLiteral(&quot;date&quot;))</span>
<a href="#l23.2376"></a><span id="l23.2376">     aValue.AssignLiteral(&quot;Date&quot;);</span>
<a href="#l23.2377"></a><span id="l23.2377">   else if (aValue.LowerCaseEqualsLiteral(&quot;status&quot;))</span>
<a href="#l23.2378"></a><span id="l23.2378">     aValue.AssignLiteral(&quot;Status&quot;);</span>
<a href="#l23.2379"></a><span id="l23.2379">   else</span>
<a href="#l23.2380"></a><span id="l23.2380">     ToLowerCase(aValue);</span>
<a href="#l23.2381"></a><span id="l23.2381"> }</span>
<a href="#l23.2382"></a><span id="l23.2382"> </span>
<a href="#l23.2383"></a><span id="l23.2383" class="difflineminus">-</span>
<a href="#l23.2384"></a><span id="l23.2384"> //-----------------------------------------------------------------------------</span>
<a href="#l23.2385"></a><span id="l23.2385"> // nsMsgSearchScopeTerm implementation</span>
<a href="#l23.2386"></a><span id="l23.2386"> //-----------------------------------------------------------------------------</span>
<a href="#l23.2387"></a><span id="l23.2387" class="difflineminus">-nsMsgSearchScopeTerm::nsMsgSearchScopeTerm (nsIMsgSearchSession *session,</span>
<a href="#l23.2388"></a><span id="l23.2388" class="difflineminus">-                                            nsMsgSearchScopeValue attribute,</span>
<a href="#l23.2389"></a><span id="l23.2389" class="difflineminus">-                                            nsIMsgFolder *folder)</span>
<a href="#l23.2390"></a><span id="l23.2390" class="difflineminus">-{</span>
<a href="#l23.2391"></a><span id="l23.2391" class="difflineplus">+nsMsgSearchScopeTerm::nsMsgSearchScopeTerm(nsIMsgSearchSession *session,</span>
<a href="#l23.2392"></a><span id="l23.2392" class="difflineplus">+                                           nsMsgSearchScopeValue attribute,</span>
<a href="#l23.2393"></a><span id="l23.2393" class="difflineplus">+                                           nsIMsgFolder *folder) {</span>
<a href="#l23.2394"></a><span id="l23.2394">   m_attribute = attribute;</span>
<a href="#l23.2395"></a><span id="l23.2395">   m_folder = folder;</span>
<a href="#l23.2396"></a><span id="l23.2396">   m_searchServer = true;</span>
<a href="#l23.2397"></a><span id="l23.2397">   m_searchSession = do_GetWeakReference(session);</span>
<a href="#l23.2398"></a><span id="l23.2398"> }</span>
<a href="#l23.2399"></a><span id="l23.2399"> </span>
<a href="#l23.2400"></a><span id="l23.2400" class="difflineminus">-nsMsgSearchScopeTerm::nsMsgSearchScopeTerm ()</span>
<a href="#l23.2401"></a><span id="l23.2401" class="difflineminus">-{</span>
<a href="#l23.2402"></a><span id="l23.2402" class="difflineminus">-  m_searchServer = true;</span>
<a href="#l23.2403"></a><span id="l23.2403" class="difflineminus">-}</span>
<a href="#l23.2404"></a><span id="l23.2404" class="difflineplus">+nsMsgSearchScopeTerm::nsMsgSearchScopeTerm() { m_searchServer = true; }</span>
<a href="#l23.2405"></a><span id="l23.2405"> </span>
<a href="#l23.2406"></a><span id="l23.2406" class="difflineminus">-nsMsgSearchScopeTerm::~nsMsgSearchScopeTerm ()</span>
<a href="#l23.2407"></a><span id="l23.2407" class="difflineminus">-{</span>
<a href="#l23.2408"></a><span id="l23.2408" class="difflineminus">-  if (m_inputStream)</span>
<a href="#l23.2409"></a><span id="l23.2409" class="difflineminus">-    m_inputStream-&gt;Close();</span>
<a href="#l23.2410"></a><span id="l23.2410" class="difflineplus">+nsMsgSearchScopeTerm::~nsMsgSearchScopeTerm() {</span>
<a href="#l23.2411"></a><span id="l23.2411" class="difflineplus">+  if (m_inputStream) m_inputStream-&gt;Close();</span>
<a href="#l23.2412"></a><span id="l23.2412">   m_inputStream = nullptr;</span>
<a href="#l23.2413"></a><span id="l23.2413"> }</span>
<a href="#l23.2414"></a><span id="l23.2414"> </span>
<a href="#l23.2415"></a><span id="l23.2415"> NS_IMPL_ISUPPORTS(nsMsgSearchScopeTerm, nsIMsgSearchScopeTerm)</span>
<a href="#l23.2416"></a><span id="l23.2416"> </span>
<a href="#l23.2417"></a><span id="l23.2417"> NS_IMETHODIMP</span>
<a href="#l23.2418"></a><span id="l23.2418" class="difflineminus">-nsMsgSearchScopeTerm::GetFolder(nsIMsgFolder **aResult)</span>
<a href="#l23.2419"></a><span id="l23.2419" class="difflineminus">-{</span>
<a href="#l23.2420"></a><span id="l23.2420" class="difflineplus">+nsMsgSearchScopeTerm::GetFolder(nsIMsgFolder **aResult) {</span>
<a href="#l23.2421"></a><span id="l23.2421">   NS_IF_ADDREF(*aResult = m_folder);</span>
<a href="#l23.2422"></a><span id="l23.2422">   return NS_OK;</span>
<a href="#l23.2423"></a><span id="l23.2423"> }</span>
<a href="#l23.2424"></a><span id="l23.2424"> </span>
<a href="#l23.2425"></a><span id="l23.2425"> NS_IMETHODIMP</span>
<a href="#l23.2426"></a><span id="l23.2426" class="difflineminus">-nsMsgSearchScopeTerm::GetSearchSession(nsIMsgSearchSession** aResult)</span>
<a href="#l23.2427"></a><span id="l23.2427" class="difflineminus">-{</span>
<a href="#l23.2428"></a><span id="l23.2428" class="difflineplus">+nsMsgSearchScopeTerm::GetSearchSession(nsIMsgSearchSession **aResult) {</span>
<a href="#l23.2429"></a><span id="l23.2429">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l23.2430"></a><span id="l23.2430" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent (m_searchSession);</span>
<a href="#l23.2431"></a><span id="l23.2431" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; searchSession =</span>
<a href="#l23.2432"></a><span id="l23.2432" class="difflineplus">+      do_QueryReferent(m_searchSession);</span>
<a href="#l23.2433"></a><span id="l23.2433">   searchSession.forget(aResult);</span>
<a href="#l23.2434"></a><span id="l23.2434">   return NS_OK;</span>
<a href="#l23.2435"></a><span id="l23.2435"> }</span>
<a href="#l23.2436"></a><span id="l23.2436"> </span>
<a href="#l23.2437"></a><span id="l23.2437"> NS_IMETHODIMP</span>
<a href="#l23.2438"></a><span id="l23.2438"> nsMsgSearchScopeTerm::GetInputStream(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l23.2439"></a><span id="l23.2439" class="difflineminus">-                                     nsIInputStream **aInputStream)</span>
<a href="#l23.2440"></a><span id="l23.2440" class="difflineminus">-{</span>
<a href="#l23.2441"></a><span id="l23.2441" class="difflineplus">+                                     nsIInputStream **aInputStream) {</span>
<a href="#l23.2442"></a><span id="l23.2442">   NS_ENSURE_ARG_POINTER(aInputStream);</span>
<a href="#l23.2443"></a><span id="l23.2443">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l23.2444"></a><span id="l23.2444">   NS_ENSURE_TRUE(m_folder, NS_ERROR_NULL_POINTER);</span>
<a href="#l23.2445"></a><span id="l23.2445">   bool reusable;</span>
<a href="#l23.2446"></a><span id="l23.2446">   nsresult rv = m_folder-&gt;GetMsgInputStream(aMsgHdr, &amp;reusable,</span>
<a href="#l23.2447"></a><span id="l23.2447">                                             getter_AddRefs(m_inputStream));</span>
<a href="#l23.2448"></a><span id="l23.2448">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.2449"></a><span id="l23.2449">   NS_IF_ADDREF(*aInputStream = m_inputStream);</span>
<a href="#l23.2450"></a><span id="l23.2450">   return rv;</span>
<a href="#l23.2451"></a><span id="l23.2451"> }</span>
<a href="#l23.2452"></a><span id="l23.2452"> </span>
<a href="#l23.2453"></a><span id="l23.2453" class="difflineminus">-NS_IMETHODIMP nsMsgSearchScopeTerm::CloseInputStream()</span>
<a href="#l23.2454"></a><span id="l23.2454" class="difflineminus">-{</span>
<a href="#l23.2455"></a><span id="l23.2455" class="difflineminus">-  if (m_inputStream)</span>
<a href="#l23.2456"></a><span id="l23.2456" class="difflineminus">-  {</span>
<a href="#l23.2457"></a><span id="l23.2457" class="difflineplus">+NS_IMETHODIMP nsMsgSearchScopeTerm::CloseInputStream() {</span>
<a href="#l23.2458"></a><span id="l23.2458" class="difflineplus">+  if (m_inputStream) {</span>
<a href="#l23.2459"></a><span id="l23.2459">     m_inputStream-&gt;Close();</span>
<a href="#l23.2460"></a><span id="l23.2460">     m_inputStream = nullptr;</span>
<a href="#l23.2461"></a><span id="l23.2461">   }</span>
<a href="#l23.2462"></a><span id="l23.2462">   return NS_OK;</span>
<a href="#l23.2463"></a><span id="l23.2463"> }</span>
<a href="#l23.2464"></a><span id="l23.2464"> </span>
<a href="#l23.2465"></a><span id="l23.2465" class="difflineminus">-nsresult nsMsgSearchScopeTerm::TimeSlice (bool *aDone)</span>
<a href="#l23.2466"></a><span id="l23.2466" class="difflineminus">-{</span>
<a href="#l23.2467"></a><span id="l23.2467" class="difflineplus">+nsresult nsMsgSearchScopeTerm::TimeSlice(bool *aDone) {</span>
<a href="#l23.2468"></a><span id="l23.2468">   return m_adapter-&gt;Search(aDone);</span>
<a href="#l23.2469"></a><span id="l23.2469"> }</span>
<a href="#l23.2470"></a><span id="l23.2470"> </span>
<a href="#l23.2471"></a><span id="l23.2471" class="difflineminus">-nsresult nsMsgSearchScopeTerm::InitializeAdapter (nsIArray *termList)</span>
<a href="#l23.2472"></a><span id="l23.2472" class="difflineminus">-{</span>
<a href="#l23.2473"></a><span id="l23.2473" class="difflineminus">-  if (m_adapter)</span>
<a href="#l23.2474"></a><span id="l23.2474" class="difflineminus">-    return NS_OK;</span>
<a href="#l23.2475"></a><span id="l23.2475" class="difflineplus">+nsresult nsMsgSearchScopeTerm::InitializeAdapter(nsIArray *termList) {</span>
<a href="#l23.2476"></a><span id="l23.2476" class="difflineplus">+  if (m_adapter) return NS_OK;</span>
<a href="#l23.2477"></a><span id="l23.2477"> </span>
<a href="#l23.2478"></a><span id="l23.2478">   nsresult rv = NS_OK;</span>
<a href="#l23.2479"></a><span id="l23.2479"> </span>
<a href="#l23.2480"></a><span id="l23.2480" class="difflineminus">-  switch (m_attribute)</span>
<a href="#l23.2481"></a><span id="l23.2481" class="difflineminus">-  {</span>
<a href="#l23.2482"></a><span id="l23.2482" class="difflineplus">+  switch (m_attribute) {</span>
<a href="#l23.2483"></a><span id="l23.2483">     case nsMsgSearchScope::onlineMail:</span>
<a href="#l23.2484"></a><span id="l23.2484" class="difflineminus">-        m_adapter = new nsMsgSearchOnlineMail (this, termList);</span>
<a href="#l23.2485"></a><span id="l23.2485" class="difflineplus">+      m_adapter = new nsMsgSearchOnlineMail(this, termList);</span>
<a href="#l23.2486"></a><span id="l23.2486">       break;</span>
<a href="#l23.2487"></a><span id="l23.2487">     case nsMsgSearchScope::offlineMail:</span>
<a href="#l23.2488"></a><span id="l23.2488">     case nsMsgSearchScope::onlineManual:</span>
<a href="#l23.2489"></a><span id="l23.2489" class="difflineminus">-        m_adapter = new nsMsgSearchOfflineMail (this, termList);</span>
<a href="#l23.2490"></a><span id="l23.2490" class="difflineplus">+      m_adapter = new nsMsgSearchOfflineMail(this, termList);</span>
<a href="#l23.2491"></a><span id="l23.2491">       break;</span>
<a href="#l23.2492"></a><span id="l23.2492">     case nsMsgSearchScope::newsEx:</span>
<a href="#l23.2493"></a><span id="l23.2493">       NS_ASSERTION(false, &quot;not supporting newsEx yet&quot;);</span>
<a href="#l23.2494"></a><span id="l23.2494">       break;</span>
<a href="#l23.2495"></a><span id="l23.2495">     case nsMsgSearchScope::news:</span>
<a href="#l23.2496"></a><span id="l23.2496" class="difflineminus">-          m_adapter = new nsMsgSearchNews (this, termList);</span>
<a href="#l23.2497"></a><span id="l23.2497" class="difflineminus">-        break;</span>
<a href="#l23.2498"></a><span id="l23.2498" class="difflineplus">+      m_adapter = new nsMsgSearchNews(this, termList);</span>
<a href="#l23.2499"></a><span id="l23.2499" class="difflineplus">+      break;</span>
<a href="#l23.2500"></a><span id="l23.2500">     case nsMsgSearchScope::allSearchableGroups:</span>
<a href="#l23.2501"></a><span id="l23.2501">       NS_ASSERTION(false, &quot;not supporting allSearchableGroups yet&quot;);</span>
<a href="#l23.2502"></a><span id="l23.2502">       break;</span>
<a href="#l23.2503"></a><span id="l23.2503">     case nsMsgSearchScope::LDAP:</span>
<a href="#l23.2504"></a><span id="l23.2504">       NS_ASSERTION(false, &quot;not supporting LDAP yet&quot;);</span>
<a href="#l23.2505"></a><span id="l23.2505">       break;</span>
<a href="#l23.2506"></a><span id="l23.2506">     case nsMsgSearchScope::localNews:</span>
<a href="#l23.2507"></a><span id="l23.2507">     case nsMsgSearchScope::localNewsJunk:</span>
<a href="#l23.2508"></a><span id="l23.2508">     case nsMsgSearchScope::localNewsBody:</span>
<a href="#l23.2509"></a><span id="l23.2509">     case nsMsgSearchScope::localNewsJunkBody:</span>
<a href="#l23.2510"></a><span id="l23.2510" class="difflineminus">-      m_adapter = new nsMsgSearchOfflineNews (this, termList);</span>
<a href="#l23.2511"></a><span id="l23.2511" class="difflineplus">+      m_adapter = new nsMsgSearchOfflineNews(this, termList);</span>
<a href="#l23.2512"></a><span id="l23.2512">       break;</span>
<a href="#l23.2513"></a><span id="l23.2513">     default:</span>
<a href="#l23.2514"></a><span id="l23.2514">       NS_ASSERTION(false, &quot;invalid scope&quot;);</span>
<a href="#l23.2515"></a><span id="l23.2515">       rv = NS_ERROR_FAILURE;</span>
<a href="#l23.2516"></a><span id="l23.2516">   }</span>
<a href="#l23.2517"></a><span id="l23.2517"> </span>
<a href="#l23.2518"></a><span id="l23.2518" class="difflineminus">-  if (m_adapter)</span>
<a href="#l23.2519"></a><span id="l23.2519" class="difflineminus">-    rv = m_adapter-&gt;ValidateTerms ();</span>
<a href="#l23.2520"></a><span id="l23.2520" class="difflineplus">+  if (m_adapter) rv = m_adapter-&gt;ValidateTerms();</span>
<a href="#l23.2521"></a><span id="l23.2521"> </span>
<a href="#l23.2522"></a><span id="l23.2522">   return rv;</span>
<a href="#l23.2523"></a><span id="l23.2523"> }</span>
<a href="#l23.2524"></a><span id="l23.2524"> </span>
<a href="#l23.2525"></a><span id="l23.2525" class="difflineminus">-</span>
<a href="#l23.2526"></a><span id="l23.2526" class="difflineminus">-char *nsMsgSearchScopeTerm::GetStatusBarName ()</span>
<a href="#l23.2527"></a><span id="l23.2527" class="difflineminus">-{</span>
<a href="#l23.2528"></a><span id="l23.2528" class="difflineminus">-  return nullptr;</span>
<a href="#l23.2529"></a><span id="l23.2529" class="difflineminus">-}</span>
<a href="#l23.2530"></a><span id="l23.2530" class="difflineminus">-</span>
<a href="#l23.2531"></a><span id="l23.2531" class="difflineplus">+char *nsMsgSearchScopeTerm::GetStatusBarName() { return nullptr; }</span>
<a href="#l23.2532"></a><span id="l23.2532"> </span>
<a href="#l23.2533"></a><span id="l23.2533"> //-----------------------------------------------------------------------------</span>
<a href="#l23.2534"></a><span id="l23.2534"> // nsMsgResultElement implementation</span>
<a href="#l23.2535"></a><span id="l23.2535"> //-----------------------------------------------------------------------------</span>
<a href="#l23.2536"></a><span id="l23.2536"> </span>
<a href="#l23.2537"></a><span id="l23.2537" class="difflineminus">-</span>
<a href="#l23.2538"></a><span id="l23.2538" class="difflineminus">-nsMsgResultElement::nsMsgResultElement(nsIMsgSearchAdapter *adapter)</span>
<a href="#l23.2539"></a><span id="l23.2539" class="difflineminus">-{</span>
<a href="#l23.2540"></a><span id="l23.2540" class="difflineplus">+nsMsgResultElement::nsMsgResultElement(nsIMsgSearchAdapter *adapter) {</span>
<a href="#l23.2541"></a><span id="l23.2541">   m_adapter = adapter;</span>
<a href="#l23.2542"></a><span id="l23.2542"> }</span>
<a href="#l23.2543"></a><span id="l23.2543"> </span>
<a href="#l23.2544"></a><span id="l23.2544" class="difflineminus">-nsMsgResultElement::~nsMsgResultElement ()</span>
<a href="#l23.2545"></a><span id="l23.2545" class="difflineminus">-{</span>
<a href="#l23.2546"></a><span id="l23.2546" class="difflineminus">-}</span>
<a href="#l23.2547"></a><span id="l23.2547" class="difflineplus">+nsMsgResultElement::~nsMsgResultElement() {}</span>
<a href="#l23.2548"></a><span id="l23.2548"> </span>
<a href="#l23.2549"></a><span id="l23.2549" class="difflineminus">-nsresult nsMsgResultElement::AddValue (nsIMsgSearchValue *value)</span>
<a href="#l23.2550"></a><span id="l23.2550" class="difflineminus">-{</span>
<a href="#l23.2551"></a><span id="l23.2551" class="difflineplus">+nsresult nsMsgResultElement::AddValue(nsIMsgSearchValue *value) {</span>
<a href="#l23.2552"></a><span id="l23.2552">   m_valueList.AppendElement(value);</span>
<a href="#l23.2553"></a><span id="l23.2553">   return NS_OK;</span>
<a href="#l23.2554"></a><span id="l23.2554"> }</span>
<a href="#l23.2555"></a><span id="l23.2555"> </span>
<a href="#l23.2556"></a><span id="l23.2556" class="difflineminus">-nsresult nsMsgResultElement::AddValue (nsMsgSearchValue *value)</span>
<a href="#l23.2557"></a><span id="l23.2557" class="difflineminus">-{</span>
<a href="#l23.2558"></a><span id="l23.2558" class="difflineminus">-  nsMsgSearchValueImpl* valueImpl = new nsMsgSearchValueImpl(value);</span>
<a href="#l23.2559"></a><span id="l23.2559" class="difflineminus">-  delete value;               // we keep the nsIMsgSearchValue, not</span>
<a href="#l23.2560"></a><span id="l23.2560" class="difflineminus">-                              // the nsMsgSearchValue</span>
<a href="#l23.2561"></a><span id="l23.2561" class="difflineplus">+nsresult nsMsgResultElement::AddValue(nsMsgSearchValue *value) {</span>
<a href="#l23.2562"></a><span id="l23.2562" class="difflineplus">+  nsMsgSearchValueImpl *valueImpl = new nsMsgSearchValueImpl(value);</span>
<a href="#l23.2563"></a><span id="l23.2563" class="difflineplus">+  delete value;  // we keep the nsIMsgSearchValue, not</span>
<a href="#l23.2564"></a><span id="l23.2564" class="difflineplus">+                 // the nsMsgSearchValue</span>
<a href="#l23.2565"></a><span id="l23.2565">   return AddValue(valueImpl);</span>
<a href="#l23.2566"></a><span id="l23.2566"> }</span>
<a href="#l23.2567"></a><span id="l23.2567"> </span>
<a href="#l23.2568"></a><span id="l23.2568" class="difflineminus">-</span>
<a href="#l23.2569"></a><span id="l23.2569" class="difflineminus">-nsresult nsMsgResultElement::AssignValues (nsIMsgSearchValue *src, nsMsgSearchValue *dst)</span>
<a href="#l23.2570"></a><span id="l23.2570" class="difflineminus">-{</span>
<a href="#l23.2571"></a><span id="l23.2571" class="difflineplus">+nsresult nsMsgResultElement::AssignValues(nsIMsgSearchValue *src,</span>
<a href="#l23.2572"></a><span id="l23.2572" class="difflineplus">+                                          nsMsgSearchValue *dst) {</span>
<a href="#l23.2573"></a><span id="l23.2573">   NS_ENSURE_ARG_POINTER(src);</span>
<a href="#l23.2574"></a><span id="l23.2574">   NS_ENSURE_ARG_POINTER(dst);</span>
<a href="#l23.2575"></a><span id="l23.2575" class="difflineminus">-  // Yes, this could be an operator overload, but nsMsgSearchValue is totally public, so I'd</span>
<a href="#l23.2576"></a><span id="l23.2576" class="difflineminus">-  // have to define a derived class with nothing by operator=, and that seems like a bit much</span>
<a href="#l23.2577"></a><span id="l23.2577" class="difflineplus">+  // Yes, this could be an operator overload, but nsMsgSearchValue is totally</span>
<a href="#l23.2578"></a><span id="l23.2578" class="difflineplus">+  // public, so I'd have to define a derived class with nothing by operator=,</span>
<a href="#l23.2579"></a><span id="l23.2579" class="difflineplus">+  // and that seems like a bit much</span>
<a href="#l23.2580"></a><span id="l23.2580">   nsresult rv = NS_OK;</span>
<a href="#l23.2581"></a><span id="l23.2581">   src-&gt;GetAttrib(&amp;dst-&gt;attribute);</span>
<a href="#l23.2582"></a><span id="l23.2582" class="difflineminus">-  switch (dst-&gt;attribute)</span>
<a href="#l23.2583"></a><span id="l23.2583" class="difflineminus">-  {</span>
<a href="#l23.2584"></a><span id="l23.2584" class="difflineminus">-  case nsMsgSearchAttrib::Priority:</span>
<a href="#l23.2585"></a><span id="l23.2585" class="difflineminus">-    rv = src-&gt;GetPriority(&amp;dst-&gt;u.priority);</span>
<a href="#l23.2586"></a><span id="l23.2586" class="difflineminus">-    break;</span>
<a href="#l23.2587"></a><span id="l23.2587" class="difflineminus">-  case nsMsgSearchAttrib::Date:</span>
<a href="#l23.2588"></a><span id="l23.2588" class="difflineminus">-    rv = src-&gt;GetDate(&amp;dst-&gt;u.date);</span>
<a href="#l23.2589"></a><span id="l23.2589" class="difflineminus">-    break;</span>
<a href="#l23.2590"></a><span id="l23.2590" class="difflineminus">-  case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l23.2591"></a><span id="l23.2591" class="difflineminus">-  case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l23.2592"></a><span id="l23.2592" class="difflineminus">-  case nsMsgSearchAttrib::FolderFlag:</span>
<a href="#l23.2593"></a><span id="l23.2593" class="difflineminus">-  case nsMsgSearchAttrib::Uint32HdrProperty:</span>
<a href="#l23.2594"></a><span id="l23.2594" class="difflineminus">-    rv = src-&gt;GetStatus(&amp;dst-&gt;u.msgStatus);</span>
<a href="#l23.2595"></a><span id="l23.2595" class="difflineminus">-    break;</span>
<a href="#l23.2596"></a><span id="l23.2596" class="difflineminus">-  case nsMsgSearchAttrib::MessageKey:</span>
<a href="#l23.2597"></a><span id="l23.2597" class="difflineminus">-    rv = src-&gt;GetMsgKey(&amp;dst-&gt;u.key);</span>
<a href="#l23.2598"></a><span id="l23.2598" class="difflineminus">-    break;</span>
<a href="#l23.2599"></a><span id="l23.2599" class="difflineminus">-  case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l23.2600"></a><span id="l23.2600" class="difflineminus">-    rv = src-&gt;GetAge(&amp;dst-&gt;u.age);</span>
<a href="#l23.2601"></a><span id="l23.2601" class="difflineminus">-    break;</span>
<a href="#l23.2602"></a><span id="l23.2602" class="difflineminus">-  case nsMsgSearchAttrib::Label:</span>
<a href="#l23.2603"></a><span id="l23.2603" class="difflineminus">-    rv = src-&gt;GetLabel(&amp;dst-&gt;u.label);</span>
<a href="#l23.2604"></a><span id="l23.2604" class="difflineminus">-    break;</span>
<a href="#l23.2605"></a><span id="l23.2605" class="difflineminus">-  case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l23.2606"></a><span id="l23.2606" class="difflineminus">-    rv = src-&gt;GetJunkStatus(&amp;dst-&gt;u.junkStatus);</span>
<a href="#l23.2607"></a><span id="l23.2607" class="difflineminus">-    break;</span>
<a href="#l23.2608"></a><span id="l23.2608" class="difflineminus">-  case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l23.2609"></a><span id="l23.2609" class="difflineminus">-    rv = src-&gt;GetJunkPercent(&amp;dst-&gt;u.junkPercent);</span>
<a href="#l23.2610"></a><span id="l23.2610" class="difflineminus">-    break;</span>
<a href="#l23.2611"></a><span id="l23.2611" class="difflineminus">-  case nsMsgSearchAttrib::Size:</span>
<a href="#l23.2612"></a><span id="l23.2612" class="difflineminus">-    rv = src-&gt;GetSize(&amp;dst-&gt;u.size);</span>
<a href="#l23.2613"></a><span id="l23.2613" class="difflineminus">-    break;</span>
<a href="#l23.2614"></a><span id="l23.2614" class="difflineminus">-  default:</span>
<a href="#l23.2615"></a><span id="l23.2615" class="difflineminus">-    if (dst-&gt;attribute &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes)</span>
<a href="#l23.2616"></a><span id="l23.2616" class="difflineminus">-    {</span>
<a href="#l23.2617"></a><span id="l23.2617" class="difflineminus">-      NS_ASSERTION(IS_STRING_ATTRIBUTE(dst-&gt;attribute), &quot;assigning non-string result&quot;);</span>
<a href="#l23.2618"></a><span id="l23.2618" class="difflineminus">-      nsString unicodeString;</span>
<a href="#l23.2619"></a><span id="l23.2619" class="difflineminus">-      rv = src-&gt;GetStr(unicodeString);</span>
<a href="#l23.2620"></a><span id="l23.2620" class="difflineminus">-      CopyUTF16toUTF8(unicodeString, dst-&gt;utf8String);</span>
<a href="#l23.2621"></a><span id="l23.2621" class="difflineminus">-      dst-&gt;utf16String = unicodeString;</span>
<a href="#l23.2622"></a><span id="l23.2622" class="difflineminus">-    }</span>
<a href="#l23.2623"></a><span id="l23.2623" class="difflineminus">-    else</span>
<a href="#l23.2624"></a><span id="l23.2624" class="difflineminus">-      rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l23.2625"></a><span id="l23.2625" class="difflineplus">+  switch (dst-&gt;attribute) {</span>
<a href="#l23.2626"></a><span id="l23.2626" class="difflineplus">+    case nsMsgSearchAttrib::Priority:</span>
<a href="#l23.2627"></a><span id="l23.2627" class="difflineplus">+      rv = src-&gt;GetPriority(&amp;dst-&gt;u.priority);</span>
<a href="#l23.2628"></a><span id="l23.2628" class="difflineplus">+      break;</span>
<a href="#l23.2629"></a><span id="l23.2629" class="difflineplus">+    case nsMsgSearchAttrib::Date:</span>
<a href="#l23.2630"></a><span id="l23.2630" class="difflineplus">+      rv = src-&gt;GetDate(&amp;dst-&gt;u.date);</span>
<a href="#l23.2631"></a><span id="l23.2631" class="difflineplus">+      break;</span>
<a href="#l23.2632"></a><span id="l23.2632" class="difflineplus">+    case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l23.2633"></a><span id="l23.2633" class="difflineplus">+    case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l23.2634"></a><span id="l23.2634" class="difflineplus">+    case nsMsgSearchAttrib::FolderFlag:</span>
<a href="#l23.2635"></a><span id="l23.2635" class="difflineplus">+    case nsMsgSearchAttrib::Uint32HdrProperty:</span>
<a href="#l23.2636"></a><span id="l23.2636" class="difflineplus">+      rv = src-&gt;GetStatus(&amp;dst-&gt;u.msgStatus);</span>
<a href="#l23.2637"></a><span id="l23.2637" class="difflineplus">+      break;</span>
<a href="#l23.2638"></a><span id="l23.2638" class="difflineplus">+    case nsMsgSearchAttrib::MessageKey:</span>
<a href="#l23.2639"></a><span id="l23.2639" class="difflineplus">+      rv = src-&gt;GetMsgKey(&amp;dst-&gt;u.key);</span>
<a href="#l23.2640"></a><span id="l23.2640" class="difflineplus">+      break;</span>
<a href="#l23.2641"></a><span id="l23.2641" class="difflineplus">+    case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l23.2642"></a><span id="l23.2642" class="difflineplus">+      rv = src-&gt;GetAge(&amp;dst-&gt;u.age);</span>
<a href="#l23.2643"></a><span id="l23.2643" class="difflineplus">+      break;</span>
<a href="#l23.2644"></a><span id="l23.2644" class="difflineplus">+    case nsMsgSearchAttrib::Label:</span>
<a href="#l23.2645"></a><span id="l23.2645" class="difflineplus">+      rv = src-&gt;GetLabel(&amp;dst-&gt;u.label);</span>
<a href="#l23.2646"></a><span id="l23.2646" class="difflineplus">+      break;</span>
<a href="#l23.2647"></a><span id="l23.2647" class="difflineplus">+    case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l23.2648"></a><span id="l23.2648" class="difflineplus">+      rv = src-&gt;GetJunkStatus(&amp;dst-&gt;u.junkStatus);</span>
<a href="#l23.2649"></a><span id="l23.2649" class="difflineplus">+      break;</span>
<a href="#l23.2650"></a><span id="l23.2650" class="difflineplus">+    case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l23.2651"></a><span id="l23.2651" class="difflineplus">+      rv = src-&gt;GetJunkPercent(&amp;dst-&gt;u.junkPercent);</span>
<a href="#l23.2652"></a><span id="l23.2652" class="difflineplus">+      break;</span>
<a href="#l23.2653"></a><span id="l23.2653" class="difflineplus">+    case nsMsgSearchAttrib::Size:</span>
<a href="#l23.2654"></a><span id="l23.2654" class="difflineplus">+      rv = src-&gt;GetSize(&amp;dst-&gt;u.size);</span>
<a href="#l23.2655"></a><span id="l23.2655" class="difflineplus">+      break;</span>
<a href="#l23.2656"></a><span id="l23.2656" class="difflineplus">+    default:</span>
<a href="#l23.2657"></a><span id="l23.2657" class="difflineplus">+      if (dst-&gt;attribute &lt; nsMsgSearchAttrib::kNumMsgSearchAttributes) {</span>
<a href="#l23.2658"></a><span id="l23.2658" class="difflineplus">+        NS_ASSERTION(IS_STRING_ATTRIBUTE(dst-&gt;attribute),</span>
<a href="#l23.2659"></a><span id="l23.2659" class="difflineplus">+                     &quot;assigning non-string result&quot;);</span>
<a href="#l23.2660"></a><span id="l23.2660" class="difflineplus">+        nsString unicodeString;</span>
<a href="#l23.2661"></a><span id="l23.2661" class="difflineplus">+        rv = src-&gt;GetStr(unicodeString);</span>
<a href="#l23.2662"></a><span id="l23.2662" class="difflineplus">+        CopyUTF16toUTF8(unicodeString, dst-&gt;utf8String);</span>
<a href="#l23.2663"></a><span id="l23.2663" class="difflineplus">+        dst-&gt;utf16String = unicodeString;</span>
<a href="#l23.2664"></a><span id="l23.2664" class="difflineplus">+      } else</span>
<a href="#l23.2665"></a><span id="l23.2665" class="difflineplus">+        rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l23.2666"></a><span id="l23.2666">   }</span>
<a href="#l23.2667"></a><span id="l23.2667">   return rv;</span>
<a href="#l23.2668"></a><span id="l23.2668"> }</span>
<a href="#l23.2669"></a><span id="l23.2669"> </span>
<a href="#l23.2670"></a><span id="l23.2670" class="difflineminus">-</span>
<a href="#l23.2671"></a><span id="l23.2671" class="difflineminus">-nsresult nsMsgResultElement::GetValue (nsMsgSearchAttribValue attrib,</span>
<a href="#l23.2672"></a><span id="l23.2672" class="difflineminus">-                                       nsMsgSearchValue **outValue) const</span>
<a href="#l23.2673"></a><span id="l23.2673" class="difflineminus">-{</span>
<a href="#l23.2674"></a><span id="l23.2674" class="difflineplus">+nsresult nsMsgResultElement::GetValue(nsMsgSearchAttribValue attrib,</span>
<a href="#l23.2675"></a><span id="l23.2675" class="difflineplus">+                                      nsMsgSearchValue **outValue) const {</span>
<a href="#l23.2676"></a><span id="l23.2676">   nsresult rv = NS_OK;</span>
<a href="#l23.2677"></a><span id="l23.2677">   *outValue = NULL;</span>
<a href="#l23.2678"></a><span id="l23.2678"> </span>
<a href="#l23.2679"></a><span id="l23.2679" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_valueList.Length() &amp;&amp; NS_FAILED(rv); i++)</span>
<a href="#l23.2680"></a><span id="l23.2680" class="difflineminus">-  {</span>
<a href="#l23.2681"></a><span id="l23.2681" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_valueList.Length() &amp;&amp; NS_FAILED(rv); i++) {</span>
<a href="#l23.2682"></a><span id="l23.2682">     nsMsgSearchAttribValue valueAttribute;</span>
<a href="#l23.2683"></a><span id="l23.2683">     m_valueList[i]-&gt;GetAttrib(&amp;valueAttribute);</span>
<a href="#l23.2684"></a><span id="l23.2684" class="difflineminus">-    if (attrib == valueAttribute)</span>
<a href="#l23.2685"></a><span id="l23.2685" class="difflineminus">-    {</span>
<a href="#l23.2686"></a><span id="l23.2686" class="difflineplus">+    if (attrib == valueAttribute) {</span>
<a href="#l23.2687"></a><span id="l23.2687">       *outValue = new nsMsgSearchValue;</span>
<a href="#l23.2688"></a><span id="l23.2688" class="difflineminus">-      if (*outValue)</span>
<a href="#l23.2689"></a><span id="l23.2689" class="difflineminus">-      {</span>
<a href="#l23.2690"></a><span id="l23.2690" class="difflineplus">+      if (*outValue) {</span>
<a href="#l23.2691"></a><span id="l23.2691">         rv = AssignValues(m_valueList[i], *outValue);</span>
<a href="#l23.2692"></a><span id="l23.2692">         // Now this is really strange! What is this assignment doing here?</span>
<a href="#l23.2693"></a><span id="l23.2693">         rv = NS_OK;</span>
<a href="#l23.2694"></a><span id="l23.2694" class="difflineminus">-      }</span>
<a href="#l23.2695"></a><span id="l23.2695" class="difflineminus">-      else</span>
<a href="#l23.2696"></a><span id="l23.2696" class="difflineplus">+      } else</span>
<a href="#l23.2697"></a><span id="l23.2697">         rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.2698"></a><span id="l23.2698">     }</span>
<a href="#l23.2699"></a><span id="l23.2699">   }</span>
<a href="#l23.2700"></a><span id="l23.2700">   return rv;</span>
<a href="#l23.2701"></a><span id="l23.2701"> }</span>
<a href="#l23.2702"></a><span id="l23.2702"> </span>
<a href="#l23.2703"></a><span id="l23.2703" class="difflineminus">-nsresult nsMsgResultElement::GetPrettyName (nsMsgSearchValue **value)</span>
<a href="#l23.2704"></a><span id="l23.2704" class="difflineminus">-{</span>
<a href="#l23.2705"></a><span id="l23.2705" class="difflineminus">-  return GetValue (nsMsgSearchAttrib::Location, value);</span>
<a href="#l23.2706"></a><span id="l23.2706" class="difflineplus">+nsresult nsMsgResultElement::GetPrettyName(nsMsgSearchValue **value) {</span>
<a href="#l23.2707"></a><span id="l23.2707" class="difflineplus">+  return GetValue(nsMsgSearchAttrib::Location, value);</span>
<a href="#l23.2708"></a><span id="l23.2708"> }</span>
<a href="#l23.2709"></a><span id="l23.2709"> </span>
<a href="#l23.2710"></a><span id="l23.2710" class="difflineminus">-nsresult nsMsgResultElement::Open (void *window)</span>
<a href="#l23.2711"></a><span id="l23.2711" class="difflineminus">-{</span>
<a href="#l23.2712"></a><span id="l23.2712" class="difflineplus">+nsresult nsMsgResultElement::Open(void *window) {</span>
<a href="#l23.2713"></a><span id="l23.2713">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.2714"></a><span id="l23.2714"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchValue.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchValue.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -4,102 +4,95 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsMsgSearchValue.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsString.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-nsMsgSearchValueImpl::nsMsgSearchValueImpl(nsMsgSearchValue *aInitialValue)</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+nsMsgSearchValueImpl::nsMsgSearchValueImpl(nsMsgSearchValue *aInitialValue) {</span>
<a href="#l24.15"></a><span id="l24.15">   mValue = *aInitialValue;</span>
<a href="#l24.16"></a><span id="l24.16"> }</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-nsMsgSearchValueImpl::~nsMsgSearchValueImpl()</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-{</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-}</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+nsMsgSearchValueImpl::~nsMsgSearchValueImpl() {}</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23"> NS_IMPL_ISUPPORTS(nsMsgSearchValueImpl, nsIMsgSearchValue)</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-NS_IMPL_GETSET(nsMsgSearchValueImpl, Priority, nsMsgPriorityValue, mValue.u.priority)</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+NS_IMPL_GETSET(nsMsgSearchValueImpl, Priority, nsMsgPriorityValue,</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+               mValue.u.priority)</span>
<a href="#l24.28"></a><span id="l24.28"> NS_IMPL_GETSET(nsMsgSearchValueImpl, Status, uint32_t, mValue.u.msgStatus)</span>
<a href="#l24.29"></a><span id="l24.29"> NS_IMPL_GETSET(nsMsgSearchValueImpl, Size, uint32_t, mValue.u.size)</span>
<a href="#l24.30"></a><span id="l24.30"> NS_IMPL_GETSET(nsMsgSearchValueImpl, MsgKey, nsMsgKey, mValue.u.key)</span>
<a href="#l24.31"></a><span id="l24.31"> NS_IMPL_GETSET(nsMsgSearchValueImpl, Age, int32_t, mValue.u.age)</span>
<a href="#l24.32"></a><span id="l24.32"> NS_IMPL_GETSET(nsMsgSearchValueImpl, Date, PRTime, mValue.u.date)</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-NS_IMPL_GETSET(nsMsgSearchValueImpl, Attrib, nsMsgSearchAttribValue, mValue.attribute)</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+NS_IMPL_GETSET(nsMsgSearchValueImpl, Attrib, nsMsgSearchAttribValue,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+               mValue.attribute)</span>
<a href="#l24.36"></a><span id="l24.36"> NS_IMPL_GETSET(nsMsgSearchValueImpl, Label, nsMsgLabelValue, mValue.u.label)</span>
<a href="#l24.37"></a><span id="l24.37"> NS_IMPL_GETSET(nsMsgSearchValueImpl, JunkStatus, uint32_t, mValue.u.junkStatus)</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-NS_IMPL_GETSET(nsMsgSearchValueImpl, JunkPercent, uint32_t, mValue.u.junkPercent)</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+NS_IMPL_GETSET(nsMsgSearchValueImpl, JunkPercent, uint32_t,</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+               mValue.u.junkPercent)</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42"> NS_IMETHODIMP</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-nsMsgSearchValueImpl::GetFolder(nsIMsgFolder* *aResult)</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-{</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+nsMsgSearchValueImpl::GetFolder(nsIMsgFolder **aResult) {</span>
<a href="#l24.46"></a><span id="l24.46">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-  NS_ENSURE_TRUE(mValue.attribute == nsMsgSearchAttrib::FolderInfo, NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+  NS_ENSURE_TRUE(mValue.attribute == nsMsgSearchAttrib::FolderInfo,</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+                 NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.50"></a><span id="l24.50">   NS_IF_ADDREF(*aResult = mValue.u.folder);</span>
<a href="#l24.51"></a><span id="l24.51">   return NS_OK;</span>
<a href="#l24.52"></a><span id="l24.52"> }</span>
<a href="#l24.53"></a><span id="l24.53"> </span>
<a href="#l24.54"></a><span id="l24.54"> NS_IMETHODIMP</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-nsMsgSearchValueImpl::SetFolder(nsIMsgFolder* aValue)</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-{</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  NS_ENSURE_TRUE(mValue.attribute == nsMsgSearchAttrib::FolderInfo, NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+nsMsgSearchValueImpl::SetFolder(nsIMsgFolder *aValue) {</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+  NS_ENSURE_TRUE(mValue.attribute == nsMsgSearchAttrib::FolderInfo,</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+                 NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.61"></a><span id="l24.61">   mValue.u.folder = aValue;</span>
<a href="#l24.62"></a><span id="l24.62">   return NS_OK;</span>
<a href="#l24.63"></a><span id="l24.63"> }</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65"> NS_IMETHODIMP</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-nsMsgSearchValueImpl::GetStr(nsAString &amp;aResult)</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-{</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-    NS_ENSURE_TRUE(IS_STRING_ATTRIBUTE(mValue.attribute), NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    aResult = mValue.utf16String;</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+nsMsgSearchValueImpl::GetStr(nsAString &amp;aResult) {</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+  NS_ENSURE_TRUE(IS_STRING_ATTRIBUTE(mValue.attribute), NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  aResult = mValue.utf16String;</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+  return NS_OK;</span>
<a href="#l24.75"></a><span id="l24.75"> }</span>
<a href="#l24.76"></a><span id="l24.76"> </span>
<a href="#l24.77"></a><span id="l24.77"> NS_IMETHODIMP</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-nsMsgSearchValueImpl::SetStr(const nsAString &amp;aValue)</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-{</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-    NS_ENSURE_TRUE(IS_STRING_ATTRIBUTE(mValue.attribute), NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-    CopyUTF16toUTF8(aValue, mValue.utf8String);</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-    mValue.utf16String = aValue;</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+nsMsgSearchValueImpl::SetStr(const nsAString &amp;aValue) {</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+  NS_ENSURE_TRUE(IS_STRING_ATTRIBUTE(mValue.attribute), NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+  CopyUTF16toUTF8(aValue, mValue.utf8String);</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+  mValue.utf16String = aValue;</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+  return NS_OK;</span>
<a href="#l24.89"></a><span id="l24.89"> }</span>
<a href="#l24.90"></a><span id="l24.90"> </span>
<a href="#l24.91"></a><span id="l24.91"> NS_IMETHODIMP</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-nsMsgSearchValueImpl::ToString(nsAString &amp;aResult)</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-{</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-    aResult.AssignLiteral(&quot;[nsIMsgSearchValue: &quot;);</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-    if (IS_STRING_ATTRIBUTE(mValue.attribute)) {</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-        aResult.Append(mValue.utf16String);</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-        return NS_OK;</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-    }</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+nsMsgSearchValueImpl::ToString(nsAString &amp;aResult) {</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+  aResult.AssignLiteral(&quot;[nsIMsgSearchValue: &quot;);</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+  if (IS_STRING_ATTRIBUTE(mValue.attribute)) {</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+    aResult.Append(mValue.utf16String);</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+    return NS_OK;</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+  }</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-    switch (mValue.attribute) {</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+  switch (mValue.attribute) {</span>
<a href="#l24.110"></a><span id="l24.110">     case nsMsgSearchAttrib::Priority:</span>
<a href="#l24.111"></a><span id="l24.111">     case nsMsgSearchAttrib::Date:</span>
<a href="#l24.112"></a><span id="l24.112">     case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l24.113"></a><span id="l24.113">     case nsMsgSearchAttrib::MessageKey:</span>
<a href="#l24.114"></a><span id="l24.114">     case nsMsgSearchAttrib::Size:</span>
<a href="#l24.115"></a><span id="l24.115">     case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l24.116"></a><span id="l24.116">     case nsMsgSearchAttrib::FolderInfo:</span>
<a href="#l24.117"></a><span id="l24.117">     case nsMsgSearchAttrib::Label:</span>
<a href="#l24.118"></a><span id="l24.118">     case nsMsgSearchAttrib::JunkStatus:</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-    case nsMsgSearchAttrib::JunkPercent:</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-    {</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+    case nsMsgSearchAttrib::JunkPercent: {</span>
<a href="#l24.122"></a><span id="l24.122">       nsAutoString tempInt;</span>
<a href="#l24.123"></a><span id="l24.123">       tempInt.AppendInt(mValue.attribute);</span>
<a href="#l24.124"></a><span id="l24.124"> </span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-        aResult.AppendLiteral(&quot;type=&quot;);</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-        aResult.Append(tempInt);</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-    }</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-        break;</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+      aResult.AppendLiteral(&quot;type=&quot;);</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+      aResult.Append(tempInt);</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+    } break;</span>
<a href="#l24.132"></a><span id="l24.132">     default:</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-        NS_ERROR(&quot;Unknown search value type&quot;);</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-    }</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+      NS_ERROR(&quot;Unknown search value type&quot;);</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+  }</span>
<a href="#l24.137"></a><span id="l24.137"> </span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-    aResult.Append(']');</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+  aResult.Append(']');</span>
<a href="#l24.140"></a><span id="l24.140"> </span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+  return NS_OK;</span>
<a href="#l24.143"></a><span id="l24.143"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchValue.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchValue.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -5,22 +5,21 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> #ifndef __nsMsgSearchValue_h</span>
<a href="#l25.6"></a><span id="l25.6"> #define __nsMsgSearchValue_h</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsIMsgSearchValue.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsMsgSearchCore.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> class nsMsgSearchValueImpl : public nsIMsgSearchValue {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  public:</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-    explicit nsMsgSearchValueImpl(nsMsgSearchValue *aInitialValue);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-    NS_DECL_NSIMSGSEARCHVALUE</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+ public:</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  explicit nsMsgSearchValueImpl(nsMsgSearchValue *aInitialValue);</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-  private:</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-    virtual ~nsMsgSearchValueImpl();</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+  NS_DECL_NSIMSGSEARCHVALUE</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-    nsMsgSearchValue mValue;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+ private:</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+  virtual ~nsMsgSearchValueImpl();</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  nsMsgSearchValue mValue;</span>
<a href="#l25.30"></a><span id="l25.30"> };</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

