<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28873:11a79da52f31a2f90b0c168c3de9a7a72a4d90fa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 11a79da52f31a2f90b0c168c3de9a7a72a4d90fa" />
<meta property="og:url" content="/comm-central/rev/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa" />
<meta property="og:description" content="Bug 1518166 - Add thirdparty kind for building libotr libraries." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 11a79da52f31a2f90b0c168c3de9a7a72a4d90fa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">shortlog</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">files</a> |
changeset |
<a href="/comm-central/raw-rev/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">raw</a>  | <a href="/comm-central/archive/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518166">Bug 1518166</a> - Add thirdparty kind for building libotr libraries.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 28 Jan 2020 22:58:26 -0500</td></tr>

<tr>
 <td>changeset 28873</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">11a79da52f31a2f90b0c168c3de9a7a72a4d90fa</a></td>
</tr>



<tr>
<td>parent 28872</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/05deee4d94212ea3a0532e455dbc0c57eb936370">05deee4d94212ea3a0532e455dbc0c57eb936370</a>
</td>
</tr>

<tr>
<td>child 28874</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/32b795794bfa328f78f81850686241e1bbae66bf">32b795794bfa328f78f81850686241e1bbae66bf</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">17087</a></td></tr>
<tr><td>push user</td><td>thunderbird@calypsoblue.org</td></tr>
<tr><td>push date</td><td class="date age">Mon, 02 Mar 2020 20:11:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e0e05018f705 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0e05018f705af08c3b98472483c02c69d25d9ec">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0e05018f705af08c3b98472483c02c69d25d9ec&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0e05018f705af08c3b98472483c02c69d25d9ec&newProject=comm-central&newRevision=05deee4d94212ea3a0532e455dbc0c57eb936370&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0e05018f705af08c3b98472483c02c69d25d9ec&newProject=comm-central&newRevision=05deee4d94212ea3a0532e455dbc0c57eb936370&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0e05018f705af08c3b98472483c02c69d25d9ec&newProject=comm-central&newRevision=05deee4d94212ea3a0532e455dbc0c57eb936370&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518166">1518166</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518166">Bug 1518166</a> - Add thirdparty kind for building libotr libraries.

Sets up a new task to build libotr and save the built artifacts in the
Taskcluster index.
Most of the code is adapted from the toolchain kind from M-C. There are key
differences with the indexing due to the fact that the source for libotr is
in-tree rather than downloaded in a fetch task.
There is a hash calculation done for toolchain builds based on the contents
of the files involved, typically a build script and some source tar files.
Instead, the hash is based on the build script, platform, artifact name, and
revision hash. When subsequent tasks look up the artifact in the index,
the files-changed list is used to look up the most recent revision with changes
to those files in order to recalculate the hash.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/kind.yml">taskcluster/ci/thirdparty/kind.yml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/kind.yml">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/kind.yml">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/kind.yml">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/kind.yml">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/kind.yml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/libotr.yml">taskcluster/ci/thirdparty/libotr.yml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/libotr.yml">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/libotr.yml">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/libotr.yml">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/libotr.yml">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/ci/thirdparty/libotr.yml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/__init__.py">taskcluster/comm_taskgraph/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/__init__.py">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/__init__.py">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/__init__.py">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/__init__.py">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/transforms/thirdparty.py">taskcluster/comm_taskgraph/transforms/thirdparty.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/transforms/thirdparty.py">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/transforms/thirdparty.py">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/transforms/thirdparty.py">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/transforms/thirdparty.py">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/transforms/thirdparty.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/__init__.py">taskcluster/comm_taskgraph/util/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/__init__.py">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/__init__.py">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/__init__.py">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/__init__.py">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/hg.py">taskcluster/comm_taskgraph/util/hg.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/hg.py">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/hg.py">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/hg.py">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/hg.py">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/comm_taskgraph/util/hg.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/docs/kinds.rst">taskcluster/docs/kinds.rst</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/docs/kinds.rst">file</a> |
<a href="/comm-central/annotate/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/docs/kinds.rst">annotate</a> |
<a href="/comm-central/diff/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/docs/kinds.rst">diff</a> |
<a href="/comm-central/comparison/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/docs/kinds.rst">comparison</a> |
<a href="/comm-central/log/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa/taskcluster/docs/kinds.rst">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/taskcluster/ci/thirdparty/kind.yml</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+---</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+loader: taskgraph.loader.transform:loader</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+kind-dependencies:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    - toolchain</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+transforms:</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    - comm_taskgraph.transforms.thirdparty:transforms</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    - taskgraph.transforms.job:transforms</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    - taskgraph.transforms.task:transforms</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+jobs-from:</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    - libotr.yml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/taskcluster/ci/thirdparty/libotr.yml</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,76 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+---</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+job-defaults:</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    description: 'libotr library build'</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    index:</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        product: thunderbird</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    treeherder:</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+        symbol: libotr</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    worker:</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+        docker-image: {in-tree: &quot;toolchain-build&quot;}</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    when:</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+        files-changed:</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+            - comm/third_party/README.libgcrypt</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+            - comm/third_party/README.libgpg-error</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+            - comm/third_party/README.libotr</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+            - comm/third_party/libgcrypt</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+            - comm/third_party/libgpg-error</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+            - comm/third_party/libotr</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    thirdparty:</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+        script: 'build-libotr.sh'</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+        artifact: 'libotr.tar.xz'</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+libotr-linux64:</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    treeherder:</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+        platform: linux64/opt</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    thirdparty:</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+        args: ['linux64']</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    toolchain:</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+        - linux64-clang</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+        - linux64-binutils</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+libotr-linux32:</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    treeherder:</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+        platform: linux32/opt</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    thirdparty:</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+        args: ['linux32']</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    toolchain:</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        - linux64-clang</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        - linux64-binutils</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+libotr-macosx64:</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    worker:</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+        env:</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+            # We just use the browser manifest, since we don't need anything different</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+            TOOLTOOL_MANIFEST: &quot;browser/config/tooltool-manifests/macosx64/cross-releng.manifest&quot;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    treeherder:</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+        platform: osx-cross/opt</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    run:</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+        tooltool-downloads: internal</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    thirdparty:</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+        args: ['macosx64']</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    toolchain:</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+        - linux64-binutils</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+        - linux64-cctools-port</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+        - linux64-clang-macosx-cross</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+        - linux64-llvm-dsymutil</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+libotr-win32:</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    worker:</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        docker-image: {in-tree: tb-debian-mingw}</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    treeherder:</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+        platform: windows2012-32/opt</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    thirdparty:</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+        args: ['win32']</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+libotr-win64:</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    worker:</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+        docker-image: {in-tree: tb-debian-mingw}</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    treeherder:</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+        platform: windows2012-64/opt</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    thirdparty:</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+        args: ['win64']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/taskcluster/comm_taskgraph/__init__.py</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/taskcluster/comm_taskgraph/__init__.py</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -9,16 +9,17 @@ import logging</span>
<a href="#l3.4"></a><span id="l3.4"> from importlib import import_module</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> from taskgraph import GECKO</span>
<a href="#l3.7"></a><span id="l3.7"> from taskgraph.util.partials import populate_release_history</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> logger = logging.getLogger(__name__)</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> COMM = os.path.join(GECKO, 'comm')</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+COMM_SCRIPTS = os.path.join(COMM, 'taskcluster', 'scripts')</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> BALROG_PRODUCT = 'Thunderbird'</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> def register(graph_config):</span>
<a href="#l3.18"></a><span id="l3.18">     &quot;&quot;&quot;</span>
<a href="#l3.19"></a><span id="l3.19">     Import all modules that are siblings of this one, triggering decorators in</span>
<a href="#l3.20"></a><span id="l3.20">     the process.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/taskcluster/comm_taskgraph/transforms/thirdparty.py</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,192 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+#  This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+#  License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+#  file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+from __future__ import absolute_import, unicode_literals</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+from six import text_type</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+import os</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+import logging</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+from voluptuous import (</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    Optional,</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    Required,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+)</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+from mozpack import path as mozpath</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+import taskgraph</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+from taskgraph.transforms.base import (</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    TransformSequence,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+)</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+from taskgraph.util.schema import (</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    Schema,</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+)</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+from taskgraph.util.cached_tasks import (</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+    add_optimization,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+from taskgraph.util.templates import (</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    merge_to</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+)</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+from taskgraph.transforms.task import (</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    task_description_schema,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+)</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+from comm_taskgraph.util import strip_comm_prefix</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+from comm_taskgraph.util.hg import get_last_modified_revision</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+from taskgraph import GECKO</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+from .. import COMM, COMM_SCRIPTS</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+logger = logging.getLogger(__name__)</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+CACHE_TYPE = 'thirdparty.v1'</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+SCHEMA = Schema({</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    # Name of the task.</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    Required('name'): text_type,</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    # Relative path (from config.path) to the file the task was defined</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    # in.</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    Optional('job-from'): text_type,</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    # Description of the task.</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    Required('description'): text_type,</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    Optional('treeherder'): task_description_schema['treeherder'],</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    Optional('index'): task_description_schema['index'],</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    Optional('run-on-projects'): task_description_schema['run-on-projects'],</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    Optional('worker'): dict,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    # A description of how to run this job.</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    Optional('run'): dict,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+    Required('thirdparty'): {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+        Required('artifact'): text_type,</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+        Required('script'): text_type,</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+        Optional('args'): [text_type]</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    },</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    Optional('toolchain'): [text_type],</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    Required('when'): {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+        Required('files-changed'): [text_type],</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    },</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+})</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+transforms = TransformSequence()</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+transforms.add_validate(SCHEMA)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+def make_base_task(config, name, job, script, command):</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    Common config for thirdparty build tasks</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    if config.params['level'] == '3':</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+        expires = '1 year'</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+    else:</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+        expires = '28 days'</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    # To be consistent with how files-changed is used elsewhere, the</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+    # path must be relative to GECKO,</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    script_rel = mozpath.relpath(script, GECKO)</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+    return {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+        'attributes': {},</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+        'name': name,</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+        'description': job['description'],</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+        'expires-after': expires,</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+        'label': 'thirdparty-%s' % name,</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+        'run-on-projects': [],</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+        'index': {</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+            'job-name': name,</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+        },</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+        'treeherder': {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+            'kind': 'build',</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+            'tier': 1,</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+        },</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+        'run': {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+            'using': 'run-task',</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+            'checkout': True,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+            'comm-checkout': True,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+            'command': command,</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+            'sparse-profile': 'toolchain-build',</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        },</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+        'worker-type': 'b-linux',</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+        'worker': {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+            'chain-of-trust': True,</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+            'env': {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+                'WORKSPACE': '/builds/worker/workspace',</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+                'UPLOAD_DIR': '/builds/worker/artifacts',</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+            },</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+            'max-run-time': 900,</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+        },</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+        'fetches': {},</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+        'when': {</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+            'files-changed': [</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+                script_rel,</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+                config.path,</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+            ]</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+        }</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    }</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+@transforms.add</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+def process_thirdparty_build(config, jobs):</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    Set up a thirdparty library build, caching the built artifacts.</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    for job in jobs:</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+        name = job['name']</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+        thirdparty = job['thirdparty']</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+        artifact_name = thirdparty['artifact']</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+        script = os.path.join(COMM_SCRIPTS, thirdparty['script'])</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+        args = thirdparty.get('args', [])</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+        command = [script] + args</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+        task = make_base_task(config, name, job, script, command)</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+        merge_to(job['index'], task['index'])</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        merge_to(job['treeherder'], task['treeherder'])</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        merge_to(job['worker'], task['worker'])</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+        if 'run' in job:</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+            merge_to(job['run'], task['run'])</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+        if 'when' in job:</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+            merge_to(job['when'], task['when'])</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+        if 'toolchain' in job:</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+            task['fetches']['toolchain'] = job['toolchain']</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+        when = task.pop('when')</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+        if 'when' in job:</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+            merge_to(job['when'], when)</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+        # The files-changed optimization is not actually used because it</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+        # conflicts with the indexing optimization, but the same list of files</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+        # is used to look up the revision with the most recent changes in</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+        # order to calculate a hash for the index.</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+        files_changed = when['files-changed']</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+        task['worker'].setdefault('artifacts', []).append({</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+            'name': 'public/build',</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+            'path': '/builds/worker/artifacts',</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+            'type': 'directory',</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+        })</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+        if not taskgraph.fast:</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+            project = config.params['project']</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+            # Get the most recent revision with changes. files-changed paths</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+            # are relative to GECKO, so strip 'comm/' off first.</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+            files_changed = frozenset(map(lambda p: strip_comm_prefix(p), files_changed))</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+            last_changed_rev = get_last_modified_revision(COMM, files_changed)</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+            logger.info(&quot;Using artifact from rev {}.&quot;.format(last_changed_rev))</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+            cache_name = task['label'].replace('{}-'.format(config.kind), '', 1)</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+            # This adds the level to the index path automatically.</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+            add_optimization(</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+                config,</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+                task,</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+                cache_type=CACHE_TYPE,</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+                cache_name=cache_name,</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+                # Digest is based on the repo name and revision</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+                digest_data=command + [project, last_changed_rev, artifact_name],</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+            )</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+        yield task</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/taskcluster/comm_taskgraph/util/__init__.py</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+#  This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+#  License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+#  file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+def strip_comm_prefix(relpath):</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    Returns relpath with 'comm/' prefix removed.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    :param string relpath: relative path</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    :return string: stripped path</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    if relpath[:5] == 'comm/':</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        return relpath[5:]</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    else:</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+        return relpath</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/taskcluster/comm_taskgraph/util/hg.py</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,50 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+#  This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+#  License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+#  file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+from __future__ import absolute_import, print_function, unicode_literals</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+import os.path</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+import six</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+import subprocess</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+from mozbuild.util import memoize</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+from mozpack import path as mozpath</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+import logging</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+logger = logging.getLogger(__name__)</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+def is_hg_repo(root):</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    Check that a path is a Mercurial checkout.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+    :param six.text_type root: Repository root path</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+    :return boolean:</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+    dot_hg = mozpath.join(root, '.hg')</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+    if os.path.exists(root) and os.path.exists(dot_hg):</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+        return True</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    return False</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+@memoize</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+def get_last_modified_revision(root, paths):</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    Get the most recent Mercurial revision with changes to paths.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    :param six.text_type root: Repository root path</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+    :param frozenset(six.text_type) paths: Paths relative to root to check</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    :return six.text_type: Most recent revision with changes to paths</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    &quot;&quot;&quot;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+    logger.info('get_last_modified_revision called')</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    root = mozpath.abspath(root)</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    if not is_hg_repo(root):</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+        raise Exception('Not a valid Mercurial repo: {}', root)</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    if not all(map(lambda p: os.path.exists(mozpath.join(root, p)), paths)):</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+        # If any of the paths do not exist, Mercurial will throw an error.</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+        paths_repr = ', '.join(paths)</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+        raise Exception('Invalid paths specified: {}'.format(paths_repr))</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    command = ['hg', '-R', root, 'log', '--limit=1', '--template={node}'] + list(paths)</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+    return six.text_type(subprocess.check_output(command, cwd=root))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/taskcluster/docs/kinds.rst</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/taskcluster/docs/kinds.rst</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,5 +1,78 @@</span>
<a href="#l7.4"></a><span id="l7.4"> Task Kinds</span>
<a href="#l7.5"></a><span id="l7.5"> ==========</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> This section lists and documents the additional task kinds that are specific</span>
<a href="#l7.8"></a><span id="l7.8"> to Thunderbird and are implemented in it's source tree.</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+thirdparty</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+----------</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Used to build third-party dependency libraries such as libotr.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+Using</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+.....</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+- kind-dependencies:</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    Must include `toolchain`</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+- transforms:</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    Must include `comm_taskgraph.transforms.thirdparty:transforms`</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+Parameters</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+..........</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+- thirdparty:</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+    - script: Script to run, in `comm/taskcluster/scripts`</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+    - args: Optional list of arguments to pass to script</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+    - artifact: Filename of built artifact.</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+- toolchain:</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    List of toolchains needed</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+.. important::</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  Thirdparty library builds are cached between runs. They will rebuild based</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  on `files-changed` optimization. To build a new version, make a change.</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+Build Environment</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+.................</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+The build script will have a limited mozilla- checkout with a complete comm-</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+checkout at `$GECKO_PATH`. It should be treated as read-only.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+`$WORKSPACE` can be used during your build as needed. `$MOZ_FETCHES_DIR` will</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+typically be at `$WORKSPACE/fetches` and will have your toolchains unpacked</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+in separate directories.</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+When your build finishes, copy your artifacts to `$UPLOAD_DIR`.</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+When building for macOS, you must set `$TOOLTOOL_MANIFEST` in the environment</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+and set `tooltool-downloads` to `internal` in the run configuration. See the</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+build task configuration for an example.</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+Using built artifacts</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+.....................</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+TODO: Document how to configure a build task to include build artifacts from</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+a thirdparty task.</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+Example task configuration</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+..........................</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+.. code-block:: yaml</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  libfoo-linux64:</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    description: 'libfoo library'</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    index:</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      product: thunderbird</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    treeherder:</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+      symbol: libfoo</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+      platform: linux64/opt</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    worker:</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+      docker-image: {in-tree: &quot;toolchain-build&quot;}</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    when:</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+      files-changed:</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+        - comm/thirdparty/libfoo</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+        - comm/thirdparty/README.libfoo</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    thirdparty:</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      script: 'build-libfoo.sh'</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      args: ['arg1', 'arg2']</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+      artifact: 'libfoo.tar.xz'</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    toolchain:</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      - linux64-clang</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+      - linux64-binutils</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

