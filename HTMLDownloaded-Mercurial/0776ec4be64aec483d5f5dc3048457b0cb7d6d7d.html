<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6088:0776ec4be64aec483d5f5dc3048457b0cb7d6d7d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0776ec4be64aec483d5f5dc3048457b0cb7d6d7d" />
<meta property="og:url" content="/comm-central/rev/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d" />
<meta property="og:description" content="Fix bug 576746 - More Component (to NSGetModule) - Make calendar XPCOM components use new manifests and data tables." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0776ec4be64aec483d5f5dc3048457b0cb7d6d7d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">shortlog</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">files</a> |
changeset |
<a href="/comm-central/raw-rev/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">raw</a>  | <a href="/comm-central/archive/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=576746">bug 576746</a> - More Component (to NSGetModule) - Make calendar XPCOM components use new manifests and data tables.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 08 Aug 2010 16:19:31 +0200</td></tr>

<tr>
 <td>changeset 6088</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">0776ec4be64aec483d5f5dc3048457b0cb7d6d7d</a></td>
</tr>



<tr>
<td>parent 6087</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5e2cc46e715401bfd64f252d75aac6618e1b129f">5e2cc46e715401bfd64f252d75aac6618e1b129f</a>
</td>
</tr>

<tr>
<td>child 6089</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5c79111293364fc0e8b0e323139c252d8f8f8cb0">5c79111293364fc0e8b0e323139c252d8f8f8cb0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">4710</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sun, 08 Aug 2010 14:20:01 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0776ec4be64a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&newProject=comm-central&newRevision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&newProject=comm-central&newRevision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&newProject=comm-central&newRevision=0776ec4be64aec483d5f5dc3048457b0cb7d6d7d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=576746">576746</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=576746">bug 576746</a> - More Component (to NSGetModule) - Make calendar XPCOM components use new manifests and data tables.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/calItipProtocolHandler.js">calendar/lightning/components/calItipProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/calItipProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/calItipProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/calItipProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/calItipProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/calItipProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/jar.mn">calendar/lightning/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/jar.mn">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/jar.mn">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/jar.mn">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/jar.mn">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/lightning/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/Makefile.in">calendar/providers/caldav/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/Makefile.in">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/Makefile.in">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/Makefile.in">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/Makefile.in">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendarModule.js">calendar/providers/caldav/calDavCalendarModule.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendarModule.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/caldav/calDavCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/Makefile.in">calendar/providers/composite/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/Makefile.in">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/Makefile.in">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/Makefile.in">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/Makefile.in">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendarModule.js">calendar/providers/gdata/components/calGoogleCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendarModule.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendarModule.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleRequest.js">calendar/providers/gdata/components/calGoogleRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleRequest.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleRequest.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleRequest.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleRequest.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleSession.js">calendar/providers/gdata/components/calGoogleSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleSession.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleSession.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleSession.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleSession.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/gdata/components/calGoogleSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/Makefile.in">calendar/providers/ics/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/Makefile.in">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/Makefile.in">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/Makefile.in">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/Makefile.in">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendarModule.js">calendar/providers/ics/calICSCalendarModule.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendarModule.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/ics/calICSCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/Makefile.in">calendar/providers/memory/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/Makefile.in">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/Makefile.in">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/Makefile.in">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/Makefile.in">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendarModule.js">calendar/providers/memory/calMemoryCalendarModule.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendarModule.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/memory/calMemoryCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/Makefile.in">calendar/providers/storage/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/Makefile.in">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/Makefile.in">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/Makefile.in">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/Makefile.in">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendarModule.js">calendar/providers/storage/calStorageCalendarModule.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendarModule.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/storage/calStorageCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/Makefile.in">calendar/providers/wcap/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/Makefile.in">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/Makefile.in">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/Makefile.in">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/Makefile.in">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendarModule.js">calendar/providers/wcap/calWcapCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendarModule.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendarModule.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/0776ec4be64aec483d5f5dc3048457b0cb7d6d7d/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -34,41 +34,54 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.6"></a><span id="l1.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.7"></a><span id="l1.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.8"></a><span id="l1.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.9"></a><span id="l1.9">  *</span>
<a href="#l1.10"></a><span id="l1.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15"> function convertFromUnicode(aCharset, aSrc) {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    var unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    let unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.18"></a><span id="l1.18">                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l1.19"></a><span id="l1.19">     unicodeConverter.charset = aCharset;</span>
<a href="#l1.20"></a><span id="l1.20">     return unicodeConverter.ConvertFromUnicode(aSrc);</span>
<a href="#l1.21"></a><span id="l1.21"> }</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> /**</span>
<a href="#l1.24"></a><span id="l1.24">  * Constructor of calItipEmailTransport object</span>
<a href="#l1.25"></a><span id="l1.25">  */</span>
<a href="#l1.26"></a><span id="l1.26"> function calItipEmailTransport() {</span>
<a href="#l1.27"></a><span id="l1.27">     this.wrappedJSObject = this;</span>
<a href="#l1.28"></a><span id="l1.28">     this._initEmailTransport();</span>
<a href="#l1.29"></a><span id="l1.29"> }</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31"> calItipEmailTransport.prototype = {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    classID: Components.ID(&quot;{d4d7b59e-c9e0-4a7a-b5e8-5958f85515f0}&quot;),</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    classDescription: &quot;Calendar iTIP Email Transport&quot;,</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    QueryInterface: function cietQI(aIid) {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-        if (!aIid.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-            !aIid.equals(Components.interfaces.calIItipTransport))</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-        {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-        }</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+        const ifaces = [Components.interfaces.calIItipTransport,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        return ifaces;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    },</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+        return null;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    },</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    flags: 0,</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-        return this;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        return cal.doQueryInterface(this, calItipEmailTransport.prototype, aIID, null, this);</span>
<a href="#l1.58"></a><span id="l1.58">     },</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60">     mHasXpcomMail: false,</span>
<a href="#l1.61"></a><span id="l1.61">     mDefaultAccount: null,</span>
<a href="#l1.62"></a><span id="l1.62">     mDefaultIdentity: null,</span>
<a href="#l1.63"></a><span id="l1.63">     mDefaultSmtpServer: null,</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">     get scheme() {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineat">@@ -84,74 +97,74 @@ calItipEmailTransport.prototype = {</span>
<a href="#l1.67"></a><span id="l1.67">     },</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">     get type() {</span>
<a href="#l1.70"></a><span id="l1.70">         return &quot;email&quot;;</span>
<a href="#l1.71"></a><span id="l1.71">     },</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">     sendItems: function cietSI(aCount, aRecipients, aItipItem) {</span>
<a href="#l1.74"></a><span id="l1.74">         if (this.mHasXpcomMail) {</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-            LOG(&quot;sendItems: Sending Email...&quot;);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+            cal.LOG(&quot;sendItems: Sending Email...&quot;);</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-            var item = aItipItem.getItemList({})[0];</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+            let item = aItipItem.getItemList({})[0];</span>
<a href="#l1.80"></a><span id="l1.80"> </span>
<a href="#l1.81"></a><span id="l1.81">             // Get ourselves some default text - when we handle organizer properly</span>
<a href="#l1.82"></a><span id="l1.82">             // We'll need a way to configure the Common Name attribute and we should</span>
<a href="#l1.83"></a><span id="l1.83">             // use it here rather than the email address</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-            var summary = (item.getProperty(&quot;SUMMARY&quot;) || &quot;&quot;);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-            var aSubject = &quot;&quot;;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-            var aBody = &quot;&quot;;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+            let summary = (item.getProperty(&quot;SUMMARY&quot;) || &quot;&quot;);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+            let aSubject = &quot;&quot;;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+            let aBody = &quot;&quot;;</span>
<a href="#l1.91"></a><span id="l1.91">             switch (aItipItem.responseMethod) {</span>
<a href="#l1.92"></a><span id="l1.92">                 case 'REQUEST':</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-                    aSubject = calGetString(&quot;lightning&quot;,</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-                                            &quot;itipRequestSubject&quot;,</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-                                            [summary],</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                                            &quot;lightning&quot;);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-                    aBody = calGetString(&quot;lightning&quot;,</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-                                         &quot;itipRequestBody&quot;,</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-                                         [item.organizer ? item.organizer.toString() : &quot;&quot;, summary],</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-                                         &quot;lightning&quot;);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+                    aSubject = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+                                                &quot;itipRequestSubject&quot;,</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+                                                [summary],</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+                                                &quot;lightning&quot;);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+                    aBody = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+                                             &quot;itipRequestBody&quot;,</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+                                             [item.organizer ? item.organizer.toString() : &quot;&quot;, summary],</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+                                             &quot;lightning&quot;);</span>
<a href="#l1.109"></a><span id="l1.109">                     break;</span>
<a href="#l1.110"></a><span id="l1.110">                 case 'CANCEL':</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-                    aSubject = calGetString(&quot;lightning&quot;,</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-                                            &quot;itipCancelSubject&quot;,</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-                                            [summary],</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-                                            &quot;lightning&quot;);</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-                    aBody = calGetString(&quot;lightning&quot;,</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-                                         &quot;itipCancelBody&quot;,</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-                                         [item.organizer ? item.organizer.toString() : &quot;&quot;, summary],</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-                                         &quot;lightning&quot;);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+                    aSubject = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+                                                &quot;itipCancelSubject&quot;,</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+                                                [summary],</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+                                                &quot;lightning&quot;);</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+                    aBody = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+                                             &quot;itipCancelBody&quot;,</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+                                             [item.organizer ? item.organizer.toString() : &quot;&quot;, summary],</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+                                             &quot;lightning&quot;);</span>
<a href="#l1.127"></a><span id="l1.127">                     break;</span>
<a href="#l1.128"></a><span id="l1.128">                 case 'REPLY': {</span>
<a href="#l1.129"></a><span id="l1.129">                     // Get my participation status</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-                    var att = (calInstanceOf(aItipItem.targetCalendar, Components.interfaces.calISchedulingSupport)</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+                    let att = (cal.calInstanceOf(aItipItem.targetCalendar, Components.interfaces.calISchedulingSupport)</span>
<a href="#l1.132"></a><span id="l1.132">                                ? aItipItem.targetCalendar.getInvitedAttendee(item) : null);</span>
<a href="#l1.133"></a><span id="l1.133">                     if (!att &amp;&amp; aItipItem.identity) {</span>
<a href="#l1.134"></a><span id="l1.134">                         att = item.getAttendeeById(&quot;mailto:&quot; + aItipItem.identity);</span>
<a href="#l1.135"></a><span id="l1.135">                     }</span>
<a href="#l1.136"></a><span id="l1.136">                     if (!att) { // should not happen anymore</span>
<a href="#l1.137"></a><span id="l1.137">                         return;</span>
<a href="#l1.138"></a><span id="l1.138">                     }</span>
<a href="#l1.139"></a><span id="l1.139"> </span>
<a href="#l1.140"></a><span id="l1.140">                     // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l1.141"></a><span id="l1.141">                     aItipItem.setAttendeeStatus(att.id, att.participationStatus);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-                    var myPartStat = att.participationStatus;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-                    var name = att.toString();</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+                    let myPartStat = att.participationStatus;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+                    let name = att.toString();</span>
<a href="#l1.146"></a><span id="l1.146"> </span>
<a href="#l1.147"></a><span id="l1.147">                     // Generate proper body from my participation status</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-                    aSubject = calGetString(&quot;lightning&quot;,</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-                                            &quot;itipReplySubject&quot;,</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-                                            [summary],</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-                                            &quot;lightning&quot;);</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-                    aBody = calGetString(&quot;lightning&quot;,</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-                                         (myPartStat == &quot;DECLINED&quot;) ? &quot;itipReplyBodyDecline&quot;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-                                                                    : &quot;itipReplyBodyAccept&quot;,</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-                                         [name],</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-                                         &quot;lightning&quot;);</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+                    aSubject = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+                                                &quot;itipReplySubject&quot;,</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+                                                [summary],</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+                                                &quot;lightning&quot;);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+                    aBody = cal.calGetString(&quot;lightning&quot;,</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+                                             (myPartStat == &quot;DECLINED&quot;) ? &quot;itipReplyBodyDecline&quot;</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+                                                                        : &quot;itipReplyBodyAccept&quot;,</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+                                             [name],</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+                                             &quot;lightning&quot;);</span>
<a href="#l1.166"></a><span id="l1.166">                     break;</span>
<a href="#l1.167"></a><span id="l1.167">                 }</span>
<a href="#l1.168"></a><span id="l1.168">             }</span>
<a href="#l1.169"></a><span id="l1.169"> </span>
<a href="#l1.170"></a><span id="l1.170">             this._sendXpcomMail(aRecipients, aSubject, aBody, aItipItem);</span>
<a href="#l1.171"></a><span id="l1.171">         } else {</span>
<a href="#l1.172"></a><span id="l1.172">             // Sunbird case: Call user's default mailer on system.</span>
<a href="#l1.173"></a><span id="l1.173">             throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineat">@@ -178,114 +191,114 @@ calItipEmailTransport.prototype = {</span>
<a href="#l1.175"></a><span id="l1.175">                 let allIdentities = accountMgrSvc.allIdentities;</span>
<a href="#l1.176"></a><span id="l1.176">                 if (allIdentities.Count() &gt; 0) {</span>
<a href="#l1.177"></a><span id="l1.177">                     this.mDefaultIdentity = allIdentities.GetElementAt(0)</span>
<a href="#l1.178"></a><span id="l1.178">                                                          .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.179"></a><span id="l1.179">                 } else {</span>
<a href="#l1.180"></a><span id="l1.180">                     // If there are no identities, then we are in the same</span>
<a href="#l1.181"></a><span id="l1.181">                     // situation as if we didn't have Xpcom Mail.</span>
<a href="#l1.182"></a><span id="l1.182">                     this.mHasXpcomMail = false;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-                    LOG(&quot;initEmailService: No XPCOM Mail available: &quot; + e);</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+                    cal.LOG(&quot;initEmailService: No XPCOM Mail available: &quot; + e);</span>
<a href="#l1.185"></a><span id="l1.185">                 }</span>
<a href="#l1.186"></a><span id="l1.186">             }</span>
<a href="#l1.187"></a><span id="l1.187">         } catch (ex) {</span>
<a href="#l1.188"></a><span id="l1.188">             // Then we must resort to operating system specific means</span>
<a href="#l1.189"></a><span id="l1.189">             this.mHasXpcomMail = false;</span>
<a href="#l1.190"></a><span id="l1.190">         }</span>
<a href="#l1.191"></a><span id="l1.191">     },</span>
<a href="#l1.192"></a><span id="l1.192"> </span>
<a href="#l1.193"></a><span id="l1.193">     _sendXpcomMail: function cietSXM(aToList, aSubject, aBody, aItem) {</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-        var identity = null;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-        var account;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+        let identity = null;</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+        let account;</span>
<a href="#l1.198"></a><span id="l1.198">         if (aItem.targetCalendar) {</span>
<a href="#l1.199"></a><span id="l1.199">             identity = aItem.targetCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l1.200"></a><span id="l1.200">             if (identity) {</span>
<a href="#l1.201"></a><span id="l1.201">                 identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.202"></a><span id="l1.202">                 account = aItem.targetCalendar.getProperty(&quot;imip.account&quot;)</span>
<a href="#l1.203"></a><span id="l1.203">                                               .QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l1.204"></a><span id="l1.204">             } else {</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-                WARN(&quot;No email identity configured for calendar &quot; + aItem.targetCalendar.name);</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+                cal.WARN(&quot;No email identity configured for calendar &quot; + aItem.targetCalendar.name);</span>
<a href="#l1.207"></a><span id="l1.207">             }</span>
<a href="#l1.208"></a><span id="l1.208">         }</span>
<a href="#l1.209"></a><span id="l1.209">         if (!identity) { // use some default identity/account:</span>
<a href="#l1.210"></a><span id="l1.210">             identity = this.mDefaultIdentity;</span>
<a href="#l1.211"></a><span id="l1.211">             account = this.mDefaultAccount;</span>
<a href="#l1.212"></a><span id="l1.212">         }</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-        var compatMode = 0;</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+        let compatMode = 0;</span>
<a href="#l1.216"></a><span id="l1.216">         switch (aItem.autoResponse) {</span>
<a href="#l1.217"></a><span id="l1.217">             case (Components.interfaces.calIItipItem.USER): {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-                LOG(&quot;sendXpcomMail: Found USER autoResponse type.\n&quot; +</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-                    &quot;This type is currently unsupported, the compose API will always enter a text/plain\n&quot; +</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-                    &quot;or text/html part as first part of the message.\n&quot; +</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-                    &quot;This will disable OL (up to 2003) to consume the mail as an iTIP invitation showing\n&quot; +</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-                    &quot;the usual calendar buttons.&quot;);</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+                cal.LOG(&quot;sendXpcomMail: Found USER autoResponse type.\n&quot; +</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+                        &quot;This type is currently unsupported, the compose API will always enter a text/plain\n&quot; +</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+                        &quot;or text/html part as first part of the message.\n&quot; +</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+                        &quot;This will disable OL (up to 2003) to consume the mail as an iTIP invitation showing\n&quot; +</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+                        &quot;the usual calendar buttons.&quot;);</span>
<a href="#l1.228"></a><span id="l1.228">                 // To somehow have a last resort before sending spam, the user can choose to send the mail.</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-                var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+                let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.231"></a><span id="l1.231">                                               .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-                var prefCompatMode = getPrefSafe(&quot;calendar.itip.compatSendMode&quot;, 0);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-                var inoutCheck = { value: (prefCompatMode == 1) };</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+                let prefCompatMode = getPrefSafe(&quot;calendar.itip.compatSendMode&quot;, 0);</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+                let inoutCheck = { value: (prefCompatMode == 1) };</span>
<a href="#l1.236"></a><span id="l1.236">                 if (!promptService.confirmCheck(null,</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-                                                calGetString(&quot;lightning&quot;, &quot;imipSendMail.title&quot;, null, &quot;lightning&quot;),</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-                                                calGetString(&quot;lightning&quot;, &quot;imipSendMail.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-                                                calGetString(&quot;lightning&quot;, &quot;imipSendMail.Outlook2000CompatMode.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+                                                cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.title&quot;, null, &quot;lightning&quot;),</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+                                                cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+                                                cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.Outlook2000CompatMode.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l1.243"></a><span id="l1.243">                                                 inoutCheck)) {</span>
<a href="#l1.244"></a><span id="l1.244">                     break;</span>
<a href="#l1.245"></a><span id="l1.245">                 } // else go on with auto sending for now</span>
<a href="#l1.246"></a><span id="l1.246">                 compatMode = (inoutCheck.value ? 1 : 0);</span>
<a href="#l1.247"></a><span id="l1.247">                 if (compatMode != prefCompatMode) {</span>
<a href="#l1.248"></a><span id="l1.248">                     setPref(&quot;calendar.itip.compatSendMode&quot;, compatMode);</span>
<a href="#l1.249"></a><span id="l1.249">                 }</span>
<a href="#l1.250"></a><span id="l1.250">             }</span>
<a href="#l1.251"></a><span id="l1.251">             case (Components.interfaces.calIItipItem.AUTO): {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-                LOG(&quot;sendXpcomMail: Found AUTO autoResponse type.&quot;);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-                var toList = &quot;&quot;;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-                for each (var recipient in aToList) {</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+                cal.LOG(&quot;sendXpcomMail: Found AUTO autoResponse type.&quot;);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+                let toList = &quot;&quot;;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+                for each (let recipient in aToList) {</span>
<a href="#l1.258"></a><span id="l1.258">                     // Strip leading &quot;mailto:&quot; if it exists.</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-                    var rId = recipient.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+                    let rId = recipient.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l1.261"></a><span id="l1.261">                     // Prevent trailing commas.</span>
<a href="#l1.262"></a><span id="l1.262">                     if (toList.length &gt; 0) {</span>
<a href="#l1.263"></a><span id="l1.263">                         toList += &quot;, &quot;;</span>
<a href="#l1.264"></a><span id="l1.264">                     }</span>
<a href="#l1.265"></a><span id="l1.265">                     // Add this recipient id to the list.</span>
<a href="#l1.266"></a><span id="l1.266">                     toList += rId;</span>
<a href="#l1.267"></a><span id="l1.267">                 }</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-                var mailFile = this._createTempImipFile(compatMode, toList, aSubject, aBody, aItem, identity);</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+                let mailFile = this._createTempImipFile(compatMode, toList, aSubject, aBody, aItem, identity);</span>
<a href="#l1.270"></a><span id="l1.270">                 if (mailFile) {</span>
<a href="#l1.271"></a><span id="l1.271">                     // compose fields for message: from/to etc need to be specified both here and in the file</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-                    var composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+                    let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l1.274"></a><span id="l1.274">                                                   .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l1.275"></a><span id="l1.275">                     composeFields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l1.276"></a><span id="l1.276">                     composeFields.to = toList;</span>
<a href="#l1.277"></a><span id="l1.277">                     composeFields.from = identity.email;</span>
<a href="#l1.278"></a><span id="l1.278">                     composeFields.replyTo = identity.replyTo;</span>
<a href="#l1.279"></a><span id="l1.279"> </span>
<a href="#l1.280"></a><span id="l1.280">                     // xxx todo: add send/progress UI, maybe recycle</span>
<a href="#l1.281"></a><span id="l1.281">                     //           &quot;@mozilla.org/messengercompose/composesendlistener;1&quot;</span>
<a href="#l1.282"></a><span id="l1.282">                     //           and/or &quot;chrome://messenger/content/messengercompose/sendProgress.xul&quot;</span>
<a href="#l1.283"></a><span id="l1.283">                     // i.e. bug 432662</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-                    var msgSend = Components.classes[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+                    let msgSend = Components.classes[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l1.286"></a><span id="l1.286">                                             .createInstance(Components.interfaces.nsIMsgSend);</span>
<a href="#l1.287"></a><span id="l1.287">                     msgSend.sendMessageFile(identity,</span>
<a href="#l1.288"></a><span id="l1.288">                                             account.key,</span>
<a href="#l1.289"></a><span id="l1.289">                                             composeFields,</span>
<a href="#l1.290"></a><span id="l1.290">                                             mailFile,</span>
<a href="#l1.291"></a><span id="l1.291">                                             true  /* deleteSendFileOnCompletion */,</span>
<a href="#l1.292"></a><span id="l1.292">                                             false /* digest_p */,</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-                                            (getIOService().offline ? Components.interfaces.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+                                            (cal.getIOService().offline ? Components.interfaces.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l1.295"></a><span id="l1.295">                                                                     : Components.interfaces.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l1.296"></a><span id="l1.296">                                             null  /* nsIMsgDBHdr msgToReplace */,</span>
<a href="#l1.297"></a><span id="l1.297">                                             null  /* nsIMsgSendListener aListener */,</span>
<a href="#l1.298"></a><span id="l1.298">                                             null  /* nsIMsgStatusFeedback aStatusFeedback */,</span>
<a href="#l1.299"></a><span id="l1.299">                                             &quot;&quot;    /* password */);</span>
<a href="#l1.300"></a><span id="l1.300">                 }</span>
<a href="#l1.301"></a><span id="l1.301">                 break;</span>
<a href="#l1.302"></a><span id="l1.302">             }</span>
<a href="#l1.303"></a><span id="l1.303">             case (Components.interfaces.calIItipItem.NONE):</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-                LOG(&quot;sendXpcomMail: Found NONE autoResponse type.&quot;);</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+                cal.LOG(&quot;sendXpcomMail: Found NONE autoResponse type.&quot;);</span>
<a href="#l1.306"></a><span id="l1.306"> </span>
<a href="#l1.307"></a><span id="l1.307">                 // No response</span>
<a href="#l1.308"></a><span id="l1.308">                 break;</span>
<a href="#l1.309"></a><span id="l1.309">             default:</span>
<a href="#l1.310"></a><span id="l1.310">                 // Unknown autoResponse type</span>
<a href="#l1.311"></a><span id="l1.311">                 throw new Error(&quot;sendXpcomMail: &quot; +</span>
<a href="#l1.312"></a><span id="l1.312">                                 &quot;Unknown autoResponse type: &quot; +</span>
<a href="#l1.313"></a><span id="l1.313">                                 aItem.autoResponse);</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineat">@@ -303,30 +316,30 @@ calItipEmailTransport.prototype = {</span>
<a href="#l1.315"></a><span id="l1.315">                 let fieldNameLen = (header.indexOf(&quot;: &quot;) + 2);</span>
<a href="#l1.316"></a><span id="l1.316">                 return mimeConverter.encodeMimePartIIStr_UTF8(header,</span>
<a href="#l1.317"></a><span id="l1.317">                                                               false,</span>
<a href="#l1.318"></a><span id="l1.318">                                                               &quot;UTF-8&quot;,</span>
<a href="#l1.319"></a><span id="l1.319">                                                               fieldNameLen,</span>
<a href="#l1.320"></a><span id="l1.320">                                                               Components.interfaces.nsIMimeConverter.MIME_ENCODED_WORD_SIZE);</span>
<a href="#l1.321"></a><span id="l1.321">             }</span>
<a href="#l1.322"></a><span id="l1.322"> </span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-            var itemList = aItem.getItemList({});</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-            var serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+            let itemList = aItem.getItemList({});</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+            let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l1.327"></a><span id="l1.327">                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l1.328"></a><span id="l1.328">             serializer.addItems(itemList, itemList.length);</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-            var methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+            let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l1.331"></a><span id="l1.331">             methodProp.value = aItem.responseMethod;</span>
<a href="#l1.332"></a><span id="l1.332">             serializer.addProperty(methodProp);</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-            var calText = serializer.serializeToString();</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-            var utf8CalText = encodeUTF8(calText);</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+            let calText = serializer.serializeToString();</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+            let utf8CalText = encodeUTF8(calText);</span>
<a href="#l1.337"></a><span id="l1.337"> </span>
<a href="#l1.338"></a><span id="l1.338">             // Home-grown mail composition; I'd love to use nsIMimeEmitter, but it's not clear to me whether</span>
<a href="#l1.339"></a><span id="l1.339">             // it can cope with nested attachments,</span>
<a href="#l1.340"></a><span id="l1.340">             // like multipart/alternative with enclosed text/calendar and text/plain.</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-            var mailText = (&quot;MIME-version: 1.0\r\n&quot; +</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+            let mailText = (&quot;MIME-version: 1.0\r\n&quot; +</span>
<a href="#l1.343"></a><span id="l1.343">                             (aIdentity.replyTo</span>
<a href="#l1.344"></a><span id="l1.344">                              ? &quot;Return-path: &quot; + aIdentity.replyTo + &quot;\r\n&quot; : &quot;&quot;) +</span>
<a href="#l1.345"></a><span id="l1.345">                             &quot;From: &quot; + aIdentity.email + &quot;\r\n&quot; +</span>
<a href="#l1.346"></a><span id="l1.346">                             &quot;To: &quot; + aToList + &quot;\r\n&quot; +</span>
<a href="#l1.347"></a><span id="l1.347">                             &quot;Date: &quot; + (new Date()).toUTCString() + &quot;\r\n&quot; +</span>
<a href="#l1.348"></a><span id="l1.348">                             &quot;Subject: &quot; + encodeMimeHeader(aSubject.replace(/(\n|\r\n)/, &quot;|&quot;)) + &quot;\r\n&quot;);</span>
<a href="#l1.349"></a><span id="l1.349">             switch (compatMode) {</span>
<a href="#l1.350"></a><span id="l1.350">                 case 1:</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineat">@@ -363,99 +376,40 @@ calItipEmailTransport.prototype = {</span>
<a href="#l1.352"></a><span id="l1.352">                                  &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l1.353"></a><span id="l1.353">                                  &quot;Content-disposition: attachment; filename=invite.ics\r\n&quot; +</span>
<a href="#l1.354"></a><span id="l1.354">                                  &quot;\r\n&quot; +</span>
<a href="#l1.355"></a><span id="l1.355">                                  utf8CalText +</span>
<a href="#l1.356"></a><span id="l1.356">                                  &quot;\r\n\r\n&quot; +</span>
<a href="#l1.357"></a><span id="l1.357">                                  &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)--\r\n&quot;);</span>
<a href="#l1.358"></a><span id="l1.358">                     break;</span>
<a href="#l1.359"></a><span id="l1.359">             }</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-            LOG(&quot;mail text:\n&quot; + mailText);</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+            cal.LOG(&quot;mail text:\n&quot; + mailText);</span>
<a href="#l1.362"></a><span id="l1.362"> </span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-            var dirUtils = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+            let dirUtils = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l1.365"></a><span id="l1.365">                                      .createInstance(Components.interfaces.nsIProperties);</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-            var tempFile = dirUtils.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+            let tempFile = dirUtils.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l1.368"></a><span id="l1.368">             tempFile.append(&quot;itipTemp&quot;);</span>
<a href="#l1.369"></a><span id="l1.369">             tempFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l1.370"></a><span id="l1.370">                                   parseInt(&quot;0600&quot;, 8));</span>
<a href="#l1.371"></a><span id="l1.371"> </span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-            var outputStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+            let outputStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l1.374"></a><span id="l1.374">                                          .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l1.375"></a><span id="l1.375">             // Let's write the file - constants from file-utils.js</span>
<a href="#l1.376"></a><span id="l1.376">             const MODE_WRONLY   = 0x02;</span>
<a href="#l1.377"></a><span id="l1.377">             const MODE_CREATE   = 0x08;</span>
<a href="#l1.378"></a><span id="l1.378">             const MODE_TRUNCATE = 0x20;</span>
<a href="#l1.379"></a><span id="l1.379">             outputStream.init(tempFile,</span>
<a href="#l1.380"></a><span id="l1.380">                               MODE_WRONLY | MODE_CREATE | MODE_TRUNCATE,</span>
<a href="#l1.381"></a><span id="l1.381">                               parseInt(&quot;0600&quot;, 8),</span>
<a href="#l1.382"></a><span id="l1.382">                               0);</span>
<a href="#l1.383"></a><span id="l1.383">             outputStream.write(mailText, mailText.length);</span>
<a href="#l1.384"></a><span id="l1.384">             outputStream.close();</span>
<a href="#l1.385"></a><span id="l1.385"> </span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-            LOG(&quot;_createTempImipFile path: &quot; + tempFile.path);</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+            cal.LOG(&quot;_createTempImipFile path: &quot; + tempFile.path);</span>
<a href="#l1.388"></a><span id="l1.388">             return tempFile;</span>
<a href="#l1.389"></a><span id="l1.389">         } catch (exc) {</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-            ASSERT(false, exc);</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+            cal.ASSERT(false, exc);</span>
<a href="#l1.392"></a><span id="l1.392">             return null;</span>
<a href="#l1.393"></a><span id="l1.393">         }</span>
<a href="#l1.394"></a><span id="l1.394">     }</span>
<a href="#l1.395"></a><span id="l1.395"> };</span>
<a href="#l1.396"></a><span id="l1.396"> </span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-// nsIFactory</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-const calItipEmailTransportFactory = {</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-        if (outer != null)</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-        return (new calItipEmailTransport()).QueryInterface(iid);</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-    }</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-};</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-/****</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">- **** module registration</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">- ****/</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-var calItipEmailTransportModule = {</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-    mCID: Components.ID(&quot;{d4d7b59e-c9e0-4a7a-b5e8-5958f85515f0}&quot;),</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineminus">-    mContractID: &quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;,</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-    loadUtils: function itipEmailLoadUtils() {</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-        if (this.mUtilsLoaded)</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-            return;</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(this));</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-    },</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-    </span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-        compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-                                        &quot;Calendar iTIP Email Transport&quot;,</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-                                        this.mContractID,</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-                                        fileSpec,</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-                                        location,</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-                                        type);</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-    },</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-        if (!cid.equals(this.mCID))</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory))</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-        this.loadUtils();</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-        return calItipEmailTransportFactory;</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-    },</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-        return true;</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-    }</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-};</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineminus">-</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-    return calItipEmailTransportModule;</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-}</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+var NSGetModule = XPCOMUtils.generateNSGetModule([calItipEmailTransport]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l2.5"></a><span id="l2.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.6"></a><span id="l2.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.7"></a><span id="l2.7">  *</span>
<a href="#l2.8"></a><span id="l2.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.9"></a><span id="l2.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.10"></a><span id="l2.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l2.11"></a><span id="l2.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l2.12"></a><span id="l2.12">  *</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineat">@@ -15,87 +14,73 @@</span>
<a href="#l2.14"></a><span id="l2.14">  * The Original Code is Lightning code.</span>
<a href="#l2.15"></a><span id="l2.15">  *</span>
<a href="#l2.16"></a><span id="l2.16">  * The Initial Developer of the Original Code is Oracle Corporation</span>
<a href="#l2.17"></a><span id="l2.17">  * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l2.18"></a><span id="l2.18">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.19"></a><span id="l2.19">  *</span>
<a href="#l2.20"></a><span id="l2.20">  * Contributor(s):</span>
<a href="#l2.21"></a><span id="l2.21">  *   Mike Shaver &lt;shaver@mozilla.org&gt;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l2.23"></a><span id="l2.23">  *</span>
<a href="#l2.24"></a><span id="l2.24">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.25"></a><span id="l2.25">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or </span>
<a href="#l2.26"></a><span id="l2.26">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.27"></a><span id="l2.27">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.28"></a><span id="l2.28">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.29"></a><span id="l2.29">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.30"></a><span id="l2.30">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.31"></a><span id="l2.31">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.32"></a><span id="l2.32">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.33"></a><span id="l2.33">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.34"></a><span id="l2.34">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.35"></a><span id="l2.35">  *</span>
<a href="#l2.36"></a><span id="l2.36">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42"> const CI = Components.interfaces;</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44"> const ITIP_HANDLER_MIMETYPE = &quot;application/x-itip-internal&quot;;</span>
<a href="#l2.45"></a><span id="l2.45"> const ITIP_HANDLER_PROTOCOL = &quot;moz-cal-handle-itip&quot;;</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-const CAL_ITIP_PROTO_HANDLER_CID =</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    Components.ID(&quot;{6E957006-B4CE-11D9-B053-001124736B74}&quot;);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-const CAL_ITIP_PROTO_HANDLER_CONTRACTID =</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    &quot;@mozilla.org/network/protocol;1?name=&quot; + ITIP_HANDLER_PROTOCOL;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-const CALMGR_CONTRACTID = &quot;@mozilla.org/calendar/manager;1&quot;;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-const ItipProtocolHandlerFactory =</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-{</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-        if (outer != null)</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-        return (new ItipProtocolHandler()).QueryInterface(iid);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-    }</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-};</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-const CAL_ITIP_CONTENT_HANDLER_CID =</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    Components.ID(&quot;{47C31F2B-B4DE-11D9-BFE6-001124736B74}&quot;);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-const CAL_ITIP_CONTENT_HANDLER_CONTRACTID =</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    &quot;@mozilla.org/uriloader/content-handler;1?type=&quot; +</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    ITIP_HANDLER_MIMETYPE;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-const ItipContentHandlerFactory =</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-{</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-        if (outer != null)</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-        return (new ItipContentHandler()).QueryInterface(iid);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    }</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-};</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80"> function NYI()</span>
<a href="#l2.81"></a><span id="l2.81"> {</span>
<a href="#l2.82"></a><span id="l2.82">     throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.83"></a><span id="l2.83"> }</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85"> function ItipChannel(URI)</span>
<a href="#l2.86"></a><span id="l2.86"> {</span>
<a href="#l2.87"></a><span id="l2.87">    this.URI = this.originalURI = URI;</span>
<a href="#l2.88"></a><span id="l2.88"> }</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90"> ItipChannel.prototype = {</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-        if (!aIID.equals(CI.nsISupports) &amp;&amp;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-            !aIID.equals(CI.nsIChannel) &amp;&amp;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-            !aIID.equals(CI.nsIRequest))</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-        </span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-        return this;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    classID: Components.ID(&quot;{643e0328-36f6-411d-a107-16238dff9cd7}&quot;),</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/itip-channel;1&quot;,</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+    classDescription: &quot;Calendar Itip Channel&quot;,</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+        const ifaces = [Components.interfaces.nsIChannel,</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+                        Components.interfaces.nsIRequest,</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+        return ifaces;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+    },</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+        return null;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    },</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+    flags: 0,</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+        return cal.doQueryInterface(this, ItipChannel.prototype, aIID, null, this);</span>
<a href="#l2.118"></a><span id="l2.118">     },</span>
<a href="#l2.119"></a><span id="l2.119">     </span>
<a href="#l2.120"></a><span id="l2.120">     contentType: ITIP_HANDLER_MIMETYPE,</span>
<a href="#l2.121"></a><span id="l2.121">     loadAttributes: null,</span>
<a href="#l2.122"></a><span id="l2.122">     contentLength: 0,</span>
<a href="#l2.123"></a><span id="l2.123">     owner: null,</span>
<a href="#l2.124"></a><span id="l2.124">     loadGroup: null,</span>
<a href="#l2.125"></a><span id="l2.125">     notificationCallbacks: null,</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineat">@@ -114,110 +99,97 @@ ItipChannel.prototype = {</span>
<a href="#l2.127"></a><span id="l2.127">     cancel: function (status) { this.status = status; },</span>
<a href="#l2.128"></a><span id="l2.128">     suspend: NYI,</span>
<a href="#l2.129"></a><span id="l2.129">     resume: NYI,</span>
<a href="#l2.130"></a><span id="l2.130"> };</span>
<a href="#l2.131"></a><span id="l2.131"> </span>
<a href="#l2.132"></a><span id="l2.132"> function ItipProtocolHandler() { }</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134"> ItipProtocolHandler.prototype = {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-        if (!aIID.equals(CI.nsISupports) &amp;&amp;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-            !aIID.equals(CI.nsIProtocolHandler))</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    classID: Components.ID(&quot;{6e957006-b4ce-11d9-b053-001124736B74}&quot;),</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    contractID: &quot;@mozilla.org/network/protocol;1?name=&quot; + ITIP_HANDLER_PROTOCOL,</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+        const ifaces = [Components.interfaces.nsIProtocolHandler,</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+        return ifaces;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+    },</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+        return null;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    },</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    flags: 0,</span>
<a href="#l2.153"></a><span id="l2.153"> </span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-        return this;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    QueryInterface: function QI(aIID) {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+        return cal.doQueryInterface(this, ItipProtocolHandler.prototype, aIID, null, this);</span>
<a href="#l2.157"></a><span id="l2.157">     },</span>
<a href="#l2.158"></a><span id="l2.158">     </span>
<a href="#l2.159"></a><span id="l2.159">     protocolFlags: CI.nsIProtocolHandler.URI_NORELATIVE | CI.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD,</span>
<a href="#l2.160"></a><span id="l2.160">     allowPort: function () { return false; },</span>
<a href="#l2.161"></a><span id="l2.161">     isSecure: false,</span>
<a href="#l2.162"></a><span id="l2.162">     newURI: function (spec, charSet, baseURI)</span>
<a href="#l2.163"></a><span id="l2.163">     {</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-        var cls = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;];</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-        var url = cls.createInstance(CI.nsIStandardURL);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+        let cls = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;];</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+        let url = cls.createInstance(CI.nsIStandardURL);</span>
<a href="#l2.168"></a><span id="l2.168">         url.init(CI.nsIStandardURL.URLTYPE_STANDARD, 0, spec, charSet, baseURI);</span>
<a href="#l2.169"></a><span id="l2.169">         dump(&quot;Creating new URI for &quot; + spec + &quot;\n&quot;);</span>
<a href="#l2.170"></a><span id="l2.170">         return url.QueryInterface(CI.nsIURI);</span>
<a href="#l2.171"></a><span id="l2.171">     },</span>
<a href="#l2.172"></a><span id="l2.172">     </span>
<a href="#l2.173"></a><span id="l2.173">     newChannel: function (URI) {</span>
<a href="#l2.174"></a><span id="l2.174">         dump(&quot;Creating new ItipChannel for &quot; + URI + &quot;\n&quot;);</span>
<a href="#l2.175"></a><span id="l2.175">         return new ItipChannel(URI);</span>
<a href="#l2.176"></a><span id="l2.176">     },</span>
<a href="#l2.177"></a><span id="l2.177"> };</span>
<a href="#l2.178"></a><span id="l2.178"> </span>
<a href="#l2.179"></a><span id="l2.179"> function ItipContentHandler() { }</span>
<a href="#l2.180"></a><span id="l2.180"> </span>
<a href="#l2.181"></a><span id="l2.181"> ItipContentHandler.prototype = {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    classID: Components.ID(&quot;{47c31f2b-b4de-11d9-bfe6-001124736B74}&quot;),</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+    contractID: &quot;@mozilla.org/uriloader/content-handler;1?type=&quot; + ITIP_HANDLER_MIMETYPE,</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    classDescription: &quot;Lightning text/calendar content handler&quot;,</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+        const ifaces = [Components.interfaces.nsIContentHandler,</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+        return ifaces;</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    },</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+        return null;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+    },</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+    flags: 0,</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+</span>
<a href="#l2.199"></a><span id="l2.199">     QueryInterface: function (aIID) {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-        if (!aIID.equals(CI.nsISupports) &amp;&amp;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-            !aIID.equals(CI.nsIContentHandler))</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-        </span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        return this;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+        return cal.doQueryInterface(this, ItipContentHandler.prototype, aIID, null, this);</span>
<a href="#l2.206"></a><span id="l2.206">     },</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208">     handleContent: function (contentType, windowTarget, request)</span>
<a href="#l2.209"></a><span id="l2.209">     {</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-        dump(&quot;Handling some itip content, whee\n&quot;);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-        var channel = request.QueryInterface(CI.nsIChannel);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-        var uri = channel.URI.spec;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+        let channel = request.QueryInterface(CI.nsIChannel);</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+        let uri = channel.URI.spec;</span>
<a href="#l2.215"></a><span id="l2.215">         if (uri.indexOf(ITIP_HANDLER_PROTOCOL + &quot;:&quot;) != 0) {</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-            dump(&quot;unexpected uri &quot; + uri + &quot;\n&quot;);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+            cal.ERROR(&quot;Unexpected iTIP uri: &quot; + uri + &quot;\n&quot;);</span>
<a href="#l2.218"></a><span id="l2.218">             return Components.results.NS_ERROR_FAILURE;</span>
<a href="#l2.219"></a><span id="l2.219">         }</span>
<a href="#l2.220"></a><span id="l2.220">         // moz-cal-handle-itip:///?</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-        var paramString = uri.substring(ITIP_HANDLER_PROTOCOL.length + 4);</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-        var paramArray = paramString.split(&quot;&amp;&quot;);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-        var paramBlock = { };</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+        let paramString = uri.substring(ITIP_HANDLER_PROTOCOL.length + 4);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+        let paramArray = paramString.split(&quot;&amp;&quot;);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+        let paramBlock = { };</span>
<a href="#l2.227"></a><span id="l2.227">         paramArray.forEach(function (v) {</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-            var parts = v.split(&quot;=&quot;);</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+            let parts = v.split(&quot;=&quot;);</span>
<a href="#l2.230"></a><span id="l2.230">             paramBlock[parts[0]] = unescape(unescape(parts[1]));</span>
<a href="#l2.231"></a><span id="l2.231">             });</span>
<a href="#l2.232"></a><span id="l2.232">         // dump(&quot;content-handler: have params &quot; + paramBlock.toSource() + &quot;\n&quot;);</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-        var event = Components.classes[&quot;@mozilla.org/calendar/event;1&quot;].</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-            createInstance(CI.calIEvent);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-        event.icalString = paramBlock.data;</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+        let event = cal.createEvent(paramBlock.data);</span>
<a href="#l2.237"></a><span id="l2.237">         dump(&quot;Processing iTIP event '&quot; + event.title + &quot;' from &quot; +</span>
<a href="#l2.238"></a><span id="l2.238">             event.organizer.id + &quot; (&quot; + event.id + &quot;)\n&quot;);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-        var calMgr = Components.classes[CALMGR_CONTRACTID].getService(CI.calICalendarManager);</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-        var cals = calMgr.getCalendars({});</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+        let cals = calMgr.getCalendars({});</span>
<a href="#l2.243"></a><span id="l2.243">         cals[0].addItem(event, null);</span>
<a href="#l2.244"></a><span id="l2.244">     }</span>
<a href="#l2.245"></a><span id="l2.245"> };</span>
<a href="#l2.246"></a><span id="l2.246"> </span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-var myModule = {</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-        debug(&quot;*** Registering Lightning &quot; + ITIP_HANDLER_PROTOCOL + &quot;: handler\n&quot;);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-        compMgr = compMgr.QueryInterface(CI.nsIComponentRegistrar);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-        compMgr.registerFactoryLocation(CAL_ITIP_PROTO_HANDLER_CID,</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-                                        &quot;Lightning &quot; + ITIP_HANDLER_PROTOCOL + &quot;: handler&quot;,</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-                                        CAL_ITIP_PROTO_HANDLER_CONTRACTID,</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-                                        fileSpec, location, type);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-        debug(&quot;*** Registering Lightning &quot; + ITIP_HANDLER_MIMETYPE + &quot; handler\n&quot;);</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-        compMgr.registerFactoryLocation(CAL_ITIP_CONTENT_HANDLER_CID,</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-                                        &quot;Lightning &quot; + ITIP_HANDLER_MIMETYPE + &quot; handler&quot;,</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-                                        CAL_ITIP_CONTENT_HANDLER_CONTRACTID,</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-                                        fileSpec, location, type);</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-    },</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory))</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-        if (cid.equals(CAL_ITIP_PROTO_HANDLER_CID))</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-            return ItipProtocolHandlerFactory;</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-        if (cid.equals(CAL_ITIP_CONTENT_HANDLER_CID))</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-            return ItipContentHandlerFactory;</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-       throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    },</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-        return true;</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-    }</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-};</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-    return myModule;</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-}</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+var components = [ItipChannel, ItipProtocolHandler, ItipContentHandler];</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+var NSGetModule = XPCOMUtils.generateNSGetModule(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7">  *</span>
<a href="#l3.8"></a><span id="l3.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12">  *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineat">@@ -34,16 +33,19 @@</span>
<a href="#l3.14"></a><span id="l3.14">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.15"></a><span id="l3.15">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.16"></a><span id="l3.16">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.17"></a><span id="l3.17">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.18"></a><span id="l3.18">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.19"></a><span id="l3.19">  *</span>
<a href="#l3.20"></a><span id="l3.20">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+</span>
<a href="#l3.25"></a><span id="l3.25"> function makeTableRow(val) {</span>
<a href="#l3.26"></a><span id="l3.26">     return &quot;&lt;tr&gt;&lt;td&gt;&quot; + val[0] + &quot;&lt;/td&gt;&lt;td&gt;&quot; + val[1] + &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</span>
<a href="#l3.27"></a><span id="l3.27"> }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> function getLightningStringBundle()</span>
<a href="#l3.30"></a><span id="l3.30"> {</span>
<a href="#l3.31"></a><span id="l3.31">     var svc = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].</span>
<a href="#l3.32"></a><span id="l3.32">               getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineat">@@ -144,17 +146,17 @@ function createHtml(event)</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">         var eventLocation = event.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l3.36"></a><span id="l3.36">         if (eventLocation) {</span>
<a href="#l3.37"></a><span id="l3.37">             labelText = stringBundle.GetStringFromName(&quot;imipHtml.location&quot;);</span>
<a href="#l3.38"></a><span id="l3.38">             html.body.table.appendChild(createHtmlTableSection(labelText,</span>
<a href="#l3.39"></a><span id="l3.39">                                                                eventLocation));</span>
<a href="#l3.40"></a><span id="l3.40">         }</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-        var dateString = getDateFormatter().formatItemInterval(event);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+        var dateString = cal.getDateFormatter().formatItemInterval(event);</span>
<a href="#l3.44"></a><span id="l3.44">         var labelText = stringBundle.GetStringFromName(&quot;imipHtml.when&quot;);</span>
<a href="#l3.45"></a><span id="l3.45">         html.body.table.appendChild(createHtmlTableSection(labelText,</span>
<a href="#l3.46"></a><span id="l3.46">                                                            dateString));</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">         if (event.organizer &amp;&amp;</span>
<a href="#l3.49"></a><span id="l3.49">             (event.organizer.commonName || event.organizer.id))</span>
<a href="#l3.50"></a><span id="l3.50">         {</span>
<a href="#l3.51"></a><span id="l3.51">             labelText = stringBundle.GetStringFromName(&quot;imipHtml.organizer&quot;);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineat">@@ -181,41 +183,57 @@ function createHtml(event)</span>
<a href="#l3.53"></a><span id="l3.53">     }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     return html;</span>
<a href="#l3.56"></a><span id="l3.56"> }</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58"> function ltnMimeConverter() { }</span>
<a href="#l3.59"></a><span id="l3.59"> </span>
<a href="#l3.60"></a><span id="l3.60"> ltnMimeConverter.prototype = {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    classID: Components.ID(&quot;{c70acb08-464e-4e55-899d-b2c84c5409fa}&quot;),</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    contractID: &quot;@mozilla.org/lightning/mime-converter;1&quot;,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    classDescription: &quot;Lightning text/calendar handler&quot;,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        const ifaces = [Components.interfaces.nsISimpleMimeConverter,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+        return ifaces;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    },</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+        return null;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    },</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    flags: 0,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    _xpcom_categories: [{</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+        category: 'simple-mime-converters',</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+        entry: 'text/calendar'</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    }],</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+</span>
<a href="#l3.83"></a><span id="l3.83">     QueryInterface: function QI(aIID) {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-            !aIID.equals(Components.interfaces.nsISimpleMimeConverter))</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-        {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-        }</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-        return this;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        return cal.doQueryInterface(this, ltnMimeConverter.prototype, aIID, null, this);</span>
<a href="#l3.92"></a><span id="l3.92">     },</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94">     mUri: null,</span>
<a href="#l3.95"></a><span id="l3.95">     get uri() {</span>
<a href="#l3.96"></a><span id="l3.96">         return this.mUri;</span>
<a href="#l3.97"></a><span id="l3.97">     },</span>
<a href="#l3.98"></a><span id="l3.98">     set uri(aUri) {</span>
<a href="#l3.99"></a><span id="l3.99">         return (this.mUri = aUri);</span>
<a href="#l3.100"></a><span id="l3.100">     },</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102">     convertToHTML: function lmcCTH(contentType, data) {</span>
<a href="#l3.103"></a><span id="l3.103">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l3.104"></a><span id="l3.104">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l3.105"></a><span id="l3.105">         parser.parseString(data);</span>
<a href="#l3.106"></a><span id="l3.106">         let event = null;</span>
<a href="#l3.107"></a><span id="l3.107">         for each (var item in parser.getItems({})) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-            if (isEvent(item)) {</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+            if (cal.isEvent(item)) {</span>
<a href="#l3.110"></a><span id="l3.110">                 if (item.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l3.111"></a><span id="l3.111">                     // if it's a faked master, take any overridden item to get a real occurrence:</span>
<a href="#l3.112"></a><span id="l3.112">                     let exc = item.recurrenceInfo.getExceptionFor(item.startDate);</span>
<a href="#l3.113"></a><span id="l3.113">                     cal.ASSERT(exc, &quot;unexpected!&quot;);</span>
<a href="#l3.114"></a><span id="l3.114">                     if (exc) {</span>
<a href="#l3.115"></a><span id="l3.115">                         item = exc;</span>
<a href="#l3.116"></a><span id="l3.116">                     }</span>
<a href="#l3.117"></a><span id="l3.117">                 }</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineat">@@ -257,66 +275,9 @@ ltnMimeConverter.prototype = {</span>
<a href="#l3.119"></a><span id="l3.119">         } catch (e) {</span>
<a href="#l3.120"></a><span id="l3.120">             Components.utils.reportError(&quot;[ltnMimeConverter] convertToHTML: &quot; + e);</span>
<a href="#l3.121"></a><span id="l3.121">         }</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">         return html;</span>
<a href="#l3.124"></a><span id="l3.124">     }</span>
<a href="#l3.125"></a><span id="l3.125"> };</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-var myModule = {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    registerSelf: function RS(aCompMgr, aFileSpec, aLocation, aType) {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-        debug(&quot;*** Registering Lightning text/calendar handler\n&quot;);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-        var compMgr = aCompMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-        compMgr.registerFactoryLocation(this.myCID,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-                                        &quot;Lightning text/calendar handler&quot;,</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-                                        this.myContractID,</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-                                        aFileSpec,</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-                                        aLocation,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-                                        aType);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-        var catman = Components.classes[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-                               .getService(Components.interfaces.nsICategoryManager);</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-        catman.addCategoryEntry(&quot;simple-mime-converters&quot;, &quot;text/calendar&quot;,</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-                                this.myContractID, true, true);</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    },</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    mScriptsLoaded: false,</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    getClassObject: function GCO(aCompMgr, aCid, aIid) {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-        if (!this.mScriptsLoaded) {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-            Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-            cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(this));</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-            this.mScriptsLoaded = true;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-        }</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-        if (!aCid.equals(this.myCID)) {</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-        }</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-        if (!aIid.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-        }</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-        return this.myFactory;</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-    },</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-    myCID: Components.ID(&quot;{c70acb08-464e-4e55-899d-b2c84c5409fa}&quot;),</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-    myContractID: &quot;@mozilla.org/lightning/mime-converter;1&quot;,</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-    myFactory: {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-        createInstance: function mfCI(aOuter, aIid) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-            if (aOuter != null) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-                throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-            }</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-            return (new ltnMimeConverter()).QueryInterface(aIid);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-        }</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    },</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-    canUnload: function CU(aCompMgr) {</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-        return true;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    }</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-};</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-    return myModule;</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-}</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+var NSGetModule = XPCOMUtils.generateNSGetModule([ltnMimeConverter]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/lightning/jar.mn</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/lightning/jar.mn</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -60,8 +60,9 @@ calendar.jar:</span>
<a href="#l4.4"></a><span id="l4.4">     content/calendar/datetimepickers/datetimepickers.css   (/calendar/resources/content/datetimepickers/datetimepickers.css)</span>
<a href="#l4.5"></a><span id="l4.5"> *   content/calendar/datetimepickers/datetimepickers.xml   (/calendar/resources/content/datetimepickers/datetimepickers.xml)</span>
<a href="#l4.6"></a><span id="l4.6">     content/calendar/mouseoverPreviews.js                  (/calendar/resources/content/mouseoverPreviews.js)</span>
<a href="#l4.7"></a><span id="l4.7">     content/calendar/publish.js                            (/calendar/resources/content/publish.js)</span>
<a href="#l4.8"></a><span id="l4.8">     content/calendar/publishDialog.js                      (/calendar/resources/content/publishDialog.js)</span>
<a href="#l4.9"></a><span id="l4.9">     content/calendar/publishDialog.xul                     (/calendar/resources/content/publishDialog.xul)</span>
<a href="#l4.10"></a><span id="l4.10">     content/calendar/sound.wav                             (/calendar/resources/content/sound.wav)</span>
<a href="#l4.11"></a><span id="l4.11">     skin/calendar/datetimepickers/datetimepickers.css      (/calendar/resources/skin/classic/datetimepickers/datetimepickers.css)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+% resource calendar .</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/caldav/Makefile.in</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/caldav/Makefile.in</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -42,18 +42,18 @@ srcdir		= @srcdir@</span>
<a href="#l5.4"></a><span id="l5.4"> VPATH		= @srcdir@</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> MODULE = caldav</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> DIRS = public</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-EXTRA_COMPONENTS = calDavCalendarModule.js</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-EXTRA_SCRIPTS = calDavCalendar.js calDavRequestHandlers.js</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+EXTRA_COMPONENTS = calDavCalendar.js</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+EXTRA_SCRIPTS = calDavRequestHandlers.js</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l5.18"></a><span id="l5.18"> 	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l5.19"></a><span id="l5.19"> 	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> # The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l5.22"></a><span id="l5.22"> install:: $(EXTRA_SCRIPTS)</span>
<a href="#l5.23"></a><span id="l5.23"> 	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -41,16 +41,19 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.5"></a><span id="l6.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.6"></a><span id="l6.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.7"></a><span id="l6.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.8"></a><span id="l6.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.9"></a><span id="l6.9">  *</span>
<a href="#l6.10"></a><span id="l6.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l6.17"></a><span id="l6.17"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l6.18"></a><span id="l6.18"> Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> //</span>
<a href="#l6.21"></a><span id="l6.21"> // calDavCalendar.js</span>
<a href="#l6.22"></a><span id="l6.22"> //</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -97,28 +100,44 @@ const kDavResourceTypeCalendar = 2;</span>
<a href="#l6.24"></a><span id="l6.24"> // used for etag checking</span>
<a href="#l6.25"></a><span id="l6.25"> const CALDAV_ADOPT_ITEM = 1;</span>
<a href="#l6.26"></a><span id="l6.26"> const CALDAV_MODIFY_ITEM = 2;</span>
<a href="#l6.27"></a><span id="l6.27"> const CALDAV_DELETE_ITEM = 3;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29"> calDavCalendar.prototype = {</span>
<a href="#l6.30"></a><span id="l6.30">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    classID: Components.ID(&quot;{a35fc6ea-3d92-11d9-89f9-00045ace3b8d}&quot;),</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=caldav&quot;,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    classDescription: &quot;Calendar CalDAV back-end&quot;,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+        const ifaces = [Components.interfaces.calICalendarProvider,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                        Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+                        Components.interfaces.calIFreeBusyProvider,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                        Components.interfaces.nsIChannelEventSink,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+                        Components.interfaces.calIItipTransport,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                        Components.interfaces.calIChangeLog,</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+                        calICalDavCalendar,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        return ifaces;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    },</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+        return null;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    },</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    flags: 0,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+</span>
<a href="#l6.55"></a><span id="l6.55">     //</span>
<a href="#l6.56"></a><span id="l6.56">     // nsISupports interface</span>
<a href="#l6.57"></a><span id="l6.57">     //</span>
<a href="#l6.58"></a><span id="l6.58">     QueryInterface: function caldav_QueryInterface(aIID) {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-        return doQueryInterface(this, calDavCalendar.prototype, aIID,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-                                [Components.interfaces.calICalendarProvider,</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-                                 Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-                                 Components.interfaces.calIFreeBusyProvider,</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-                                 Components.interfaces.nsIChannelEventSink,</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-                                 Components.interfaces.calIItipTransport,</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-                                 Components.interfaces.calIChangeLog,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-                                 calICalDavCalendar]);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+        return cal.doQueryInterface(this, calDavCalendar.prototype, aIID, null, this);</span>
<a href="#l6.68"></a><span id="l6.68">     },</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70">     // An array of components that are supported by the server. The default is</span>
<a href="#l6.71"></a><span id="l6.71">     // to support VEVENT and VTODO, if queries for these components return a 4xx</span>
<a href="#l6.72"></a><span id="l6.72">     // error, then they will be removed from this array.</span>
<a href="#l6.73"></a><span id="l6.73">     mGenerallySupportedItemTypes: null,</span>
<a href="#l6.74"></a><span id="l6.74">     mSupportedItemTypes: null,</span>
<a href="#l6.75"></a><span id="l6.75">     suportedItemTypes: null,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineat">@@ -2473,8 +2492,27 @@ calDavObserver.prototype = {</span>
<a href="#l6.77"></a><span id="l6.77">         this.mCalendar.observers.notify(&quot;onPropertyDeleting&quot;, [aCalendar, aName]);</span>
<a href="#l6.78"></a><span id="l6.78">     },</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">     onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l6.81"></a><span id="l6.81">         this.mCalendar.readOnly = true;</span>
<a href="#l6.82"></a><span id="l6.82">         this.mCalendar.notifyError(aErrNo, aMessage);</span>
<a href="#l6.83"></a><span id="l6.83">     }</span>
<a href="#l6.84"></a><span id="l6.84"> };</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+/** Module Registration */</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+const scriptLoadOrder = [</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    &quot;calUtils.js&quot;,</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    &quot;calDavRequestHandlers.js&quot;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+];</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+function NSGetModule(cid) {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    if (!this.scriptsLoaded) {</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+        Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+                .QueryInterface(Components.interfaces.nsIResProtocolHandler)</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+                .setSubstitution(&quot;calendar&quot;, Services.io.newFileURI(__LOCATION__.parent.parent));</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+        cal.loadScripts(scriptLoadOrder, Components.utils.getGlobalForObject(this));</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+        this.scriptsLoaded = true;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    }</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+    return (XPCOMUtils.generateNSGetModule([calDavCalendar]))(cid);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendarModule.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,112 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">- *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">- *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">- * The Original Code is Oracle Corporation code.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">- *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">- *  Oracle Corporation</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">- *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">- *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">- *   Dan Mosedale &lt;dan.mosedale@oracle.com&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">- *   Mike Shaver &lt;mike.x.shaver@oracle.com&gt;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">- *   Gary van der Merwe &lt;garyvdm@gmail.com&gt;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">- *   Bruno Browning &lt;browning@uwalumni.com&gt;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">- *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">- *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">- *</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">- *</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-// nsIFactory</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-const calDavCalendarFactory = {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-            !aIID.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-        }</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-        return this;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    },</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-        if (outer != null)</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-        return (new calDavCalendar()).QueryInterface(iid);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    }</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-};</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-/****</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">- **** module registration</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">- ****/</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-var calDavCalendarModule = {</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    mCID: Components.ID(&quot;{a35fc6ea-3d92-11d9-89f9-00045ace3b8d}&quot;),</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    mContractID: &quot;@mozilla.org/calendar/calendar;1?type=caldav&quot;,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    loadUtils: function cDCM_loadUtils() {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-        if (this.mUtilsLoaded) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-            return;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-        }</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calDavCalendar.js&quot;, &quot;calDavRequestHandlers.js&quot; ],</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-                        Components.utils.getGlobalForObject(this));</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    },</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-        compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-                                        &quot;Calendar CalDAV back-end&quot;,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-                                        this.mContractID,</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-                                        fileSpec,</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-                                        location,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-                                        type);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    },</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-        if (!cid.equals(this.mCID))</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory))</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-        this.loadUtils();</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-        return calDavCalendarFactory;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-    },</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-        return true;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-    }</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-};</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-    return calDavCalendarModule;</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/providers/composite/Makefile.in</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/providers/composite/Makefile.in</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> # The Original Code is the Oracle Corporation code.</span>
<a href="#l8.5"></a><span id="l8.5"> #</span>
<a href="#l8.6"></a><span id="l8.6"> # The Initial Developer of the Original Code is Oracle Corporation.</span>
<a href="#l8.7"></a><span id="l8.7"> # Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l8.8"></a><span id="l8.8"> # the Initial Developer. All Rights Reserved.</span>
<a href="#l8.9"></a><span id="l8.9"> #</span>
<a href="#l8.10"></a><span id="l8.10"> # Contributor(s):</span>
<a href="#l8.11"></a><span id="l8.11"> #   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l8.13"></a><span id="l8.13"> #</span>
<a href="#l8.14"></a><span id="l8.14"> # Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.15"></a><span id="l8.15"> # either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.16"></a><span id="l8.16"> # the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.17"></a><span id="l8.17"> # in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.18"></a><span id="l8.18"> # of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.19"></a><span id="l8.19"> # under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.20"></a><span id="l8.20"> # use your version of this file under the terms of the MPL, indicate your</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -31,16 +31,19 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.5"></a><span id="l9.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.6"></a><span id="l9.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.7"></a><span id="l9.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.8"></a><span id="l9.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.9"></a><span id="l9.9">  *</span>
<a href="#l9.10"></a><span id="l9.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15"> //</span>
<a href="#l9.16"></a><span id="l9.16"> // calCompositeCalendar.js</span>
<a href="#l9.17"></a><span id="l9.17"> //</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> /**</span>
<a href="#l9.20"></a><span id="l9.20">  * Calendar specific utility functions</span>
<a href="#l9.21"></a><span id="l9.21">  */</span>
<a href="#l9.22"></a><span id="l9.22"> const calIOperationListener = Components.interfaces.calIOperationListener;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineat">@@ -106,45 +109,54 @@ function calCompositeCalendar () {</span>
<a href="#l9.24"></a><span id="l9.24">     this.mCalendars = new Array();</span>
<a href="#l9.25"></a><span id="l9.25">     this.mCompositeObservers = new cal.ObserverBag(Components.interfaces.calICompositeObserver);</span>
<a href="#l9.26"></a><span id="l9.26">     this.mObservers = new cal.ObserverBag(Components.interfaces.calIObserver);</span>
<a href="#l9.27"></a><span id="l9.27">     this.mDefaultCalendar = null;</span>
<a href="#l9.28"></a><span id="l9.28">     this.mStatusObserver = null;</span>
<a href="#l9.29"></a><span id="l9.29"> }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31"> calCompositeCalendar.prototype = {</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    classID: Components.ID(&quot;{aeff788d-63b0-4996-91fb-40a7654c6224}&quot;),</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=composite&quot;,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    classDescription: &quot;Composite Calendar Provider&quot;,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+        const ifaces = [Components.interfaces.calICalendarProvider,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+                        Components.interfaces.calICalendar,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+                        Components.interfaces.calICompositeCalendar,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+        return ifaces;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    },</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+        return null;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    },</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    flags: 0,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    QueryInterface: function (aIID) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+        return cal.doQueryInterface(this, calCompositeCalendar.prototype, aIID, null, this);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    },</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+</span>
<a href="#l9.55"></a><span id="l9.55">     //</span>
<a href="#l9.56"></a><span id="l9.56">     // private members</span>
<a href="#l9.57"></a><span id="l9.57">     //</span>
<a href="#l9.58"></a><span id="l9.58">     mDefaultCalendar: null,</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    //</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    // nsISupports interface</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    //</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-            !aIID.equals(Components.interfaces.calICalendarProvider) &amp;&amp;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-            !aIID.equals(Components.interfaces.calICalendar) &amp;&amp;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-            !aIID.equals(Components.interfaces.calICompositeCalendar))</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-        {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-        }</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-        return this;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-    },</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">     //</span>
<a href="#l9.76"></a><span id="l9.76">     // calICalendarProvider interface</span>
<a href="#l9.77"></a><span id="l9.77">     //</span>
<a href="#l9.78"></a><span id="l9.78">     get prefChromeOverlay() {</span>
<a href="#l9.79"></a><span id="l9.79">         return null;</span>
<a href="#l9.80"></a><span id="l9.80">     },</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82">     get displayName() {</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-        return calGetString(&quot;calendar&quot;, &quot;compositeName&quot;);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+        return cal.calGetString(&quot;calendar&quot;, &quot;compositeName&quot;);</span>
<a href="#l9.85"></a><span id="l9.85">     },</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87">     createCalendar: function comp_createCal() {</span>
<a href="#l9.88"></a><span id="l9.88">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.89"></a><span id="l9.89">     },</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91">     deleteCalendar: function comp_deleteCal(calendar, listener) {</span>
<a href="#l9.92"></a><span id="l9.92">         // You shouldn't be able to delete from the composite calendar.</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineat">@@ -171,18 +183,18 @@ calCompositeCalendar.prototype = {</span>
<a href="#l9.94"></a><span id="l9.94">         if (this.mPrefPrefix) {</span>
<a href="#l9.95"></a><span id="l9.95">             for each (let calendar in this.mCalendars) {</span>
<a href="#l9.96"></a><span id="l9.96">                 this.removeCalendar(calendar);</span>
<a href="#l9.97"></a><span id="l9.97">             }</span>
<a href="#l9.98"></a><span id="l9.98">         }</span>
<a href="#l9.99"></a><span id="l9.99">         this.mPrefPrefix = aPrefPrefix;</span>
<a href="#l9.100"></a><span id="l9.100">         this.mActivePref = aPrefPrefix + &quot;-in-composite&quot;;</span>
<a href="#l9.101"></a><span id="l9.101">         this.mDefaultPref = aPrefPrefix + &quot;-default&quot;;</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-        var mgr = getCalendarManager();</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-        var cals = mgr.getCalendars({});</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+        let mgr = cal.getCalendarManager();</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+        let cals = mgr.getCalendars({});</span>
<a href="#l9.106"></a><span id="l9.106"> </span>
<a href="#l9.107"></a><span id="l9.107">         cals.forEach(function (c) {</span>
<a href="#l9.108"></a><span id="l9.108">             if (c.getProperty(this.mActivePref))</span>
<a href="#l9.109"></a><span id="l9.109">                 this.addCalendar(c);</span>
<a href="#l9.110"></a><span id="l9.110">             if (c.getProperty(this.mDefaultPref))</span>
<a href="#l9.111"></a><span id="l9.111">                 this.setDefaultCalendar(c, false);</span>
<a href="#l9.112"></a><span id="l9.112">         }, this);</span>
<a href="#l9.113"></a><span id="l9.113">     },</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineat">@@ -332,117 +344,117 @@ calCompositeCalendar.prototype = {</span>
<a href="#l9.115"></a><span id="l9.115">     deleteProperty: function(aName) {</span>
<a href="#l9.116"></a><span id="l9.116">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.117"></a><span id="l9.117">     },</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119">     // void addObserver( in calIObserver observer );</span>
<a href="#l9.120"></a><span id="l9.120">     mCompositeObservers: null,</span>
<a href="#l9.121"></a><span id="l9.121">     mObservers: null,</span>
<a href="#l9.122"></a><span id="l9.122">     addObserver: function (aObserver) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-        if (calInstanceOf(aObserver, Components.interfaces.calICompositeObserver)) {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+        if (cal.calInstanceOf(aObserver, Components.interfaces.calICompositeObserver)) {</span>
<a href="#l9.125"></a><span id="l9.125">             this.mCompositeObservers.add(aObserver);</span>
<a href="#l9.126"></a><span id="l9.126">         }</span>
<a href="#l9.127"></a><span id="l9.127">         this.mObservers.add(aObserver);</span>
<a href="#l9.128"></a><span id="l9.128">     },</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130">     // void removeObserver( in calIObserver observer );</span>
<a href="#l9.131"></a><span id="l9.131">     removeObserver: function (aObserver) {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-        if (calInstanceOf(aObserver, Components.interfaces.calICompositeObserver)) {</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+        if (cal.calInstanceOf(aObserver, Components.interfaces.calICompositeObserver)) {</span>
<a href="#l9.134"></a><span id="l9.134">             this.mCompositeObservers.remove(aObserver);</span>
<a href="#l9.135"></a><span id="l9.135">         }</span>
<a href="#l9.136"></a><span id="l9.136">         this.mObservers.remove(aObserver);</span>
<a href="#l9.137"></a><span id="l9.137">     },</span>
<a href="#l9.138"></a><span id="l9.138"> </span>
<a href="#l9.139"></a><span id="l9.139">     refresh: function cCC_refresh() {</span>
<a href="#l9.140"></a><span id="l9.140">         if (this.mStatusObserver) {</span>
<a href="#l9.141"></a><span id="l9.141">             this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS, this.mCalendars.length);</span>
<a href="#l9.142"></a><span id="l9.142">         }</span>
<a href="#l9.143"></a><span id="l9.143">         for each (let calendar in this.enabledCalendars) {</span>
<a href="#l9.144"></a><span id="l9.144">             try {</span>
<a href="#l9.145"></a><span id="l9.145">                 if (calendar.canRefresh) {</span>
<a href="#l9.146"></a><span id="l9.146">                     this.mObserverHelper.pendingLoads[calendar.id] = true;</span>
<a href="#l9.147"></a><span id="l9.147">                     calendar.refresh();</span>
<a href="#l9.148"></a><span id="l9.148">                 }</span>
<a href="#l9.149"></a><span id="l9.149">             } catch (e) {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-                ASSERT(false, e);</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+                cal.ASSERT(false, e);</span>
<a href="#l9.152"></a><span id="l9.152">                 delete this.mObserverHelper.pendingLoads[calendar.id];</span>
<a href="#l9.153"></a><span id="l9.153">             }</span>
<a href="#l9.154"></a><span id="l9.154">         }</span>
<a href="#l9.155"></a><span id="l9.155">         // send out a single onLoad for this composite calendar,</span>
<a href="#l9.156"></a><span id="l9.156">         // although e.g. the ics provider will trigger another</span>
<a href="#l9.157"></a><span id="l9.157">         // onLoad asynchronously; we cannot rely on every calendar</span>
<a href="#l9.158"></a><span id="l9.158">         // sending an onLoad:</span>
<a href="#l9.159"></a><span id="l9.159">         this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l9.160"></a><span id="l9.160">     },</span>
<a href="#l9.161"></a><span id="l9.161"> </span>
<a href="#l9.162"></a><span id="l9.162">     // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l9.163"></a><span id="l9.163">     modifyItem: function (aNewItem, aOldItem, aListener) {</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-        ASSERT(aNewItem.calendar, &quot;Composite can't modify item with null calendar&quot;, true);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-        ASSERT(aNewItem.calendar != this, &quot;Composite can't modify item with this calendar&quot;, true);</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+        cal.ASSERT(aNewItem.calendar, &quot;Composite can't modify item with null calendar&quot;, true);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+        cal.ASSERT(aNewItem.calendar != this, &quot;Composite can't modify item with this calendar&quot;, true);</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169">         return aNewItem.calendar.modifyItem(aNewItem, aOldItem, aListener);</span>
<a href="#l9.170"></a><span id="l9.170">     },</span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172">     // void deleteItem( in string id, in calIOperationListener aListener );</span>
<a href="#l9.173"></a><span id="l9.173">     deleteItem: function (aItem, aListener) {</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-        ASSERT(aItem.calendar, &quot;Composite can't delete item with null calendar&quot;, true);</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-        ASSERT(aItem.calendar != this, &quot;Composite can't delete item with this calendar&quot;, true);</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+        cal.ASSERT(aItem.calendar, &quot;Composite can't delete item with null calendar&quot;, true);</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+        cal.ASSERT(aItem.calendar != this, &quot;Composite can't delete item with this calendar&quot;, true);</span>
<a href="#l9.178"></a><span id="l9.178"> </span>
<a href="#l9.179"></a><span id="l9.179">         return aItem.calendar.deleteItem(aItem, aListener);</span>
<a href="#l9.180"></a><span id="l9.180">     },</span>
<a href="#l9.181"></a><span id="l9.181"> </span>
<a href="#l9.182"></a><span id="l9.182">     // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l9.183"></a><span id="l9.183">     addItem: function (aItem, aListener) {</span>
<a href="#l9.184"></a><span id="l9.184">         return this.mDefaultCalendar.addItem(aItem, aListener);</span>
<a href="#l9.185"></a><span id="l9.185">     },</span>
<a href="#l9.186"></a><span id="l9.186"> </span>
<a href="#l9.187"></a><span id="l9.187">     // void getItem( in string aId, in calIOperationListener aListener );</span>
<a href="#l9.188"></a><span id="l9.188">     getItem: function (aId, aListener) {</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-        var enabledCalendars = this.enabledCalendars;</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-        var cmpListener = new calCompositeGetListenerHelper(this, aListener);</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+        let enabledCalendars = this.enabledCalendars;</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+        let cmpListener = new calCompositeGetListenerHelper(this, aListener);</span>
<a href="#l9.193"></a><span id="l9.193">         for each (let calendar in enabledCalendars) {</span>
<a href="#l9.194"></a><span id="l9.194">             try {</span>
<a href="#l9.195"></a><span id="l9.195">                 cmpListener.opGroup.add(calendar.getItem(aId, cmpListener));</span>
<a href="#l9.196"></a><span id="l9.196">             } catch (exc) {</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-                ASSERT(false, exc);</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+                cal.ASSERT(false, exc);</span>
<a href="#l9.199"></a><span id="l9.199">             }</span>
<a href="#l9.200"></a><span id="l9.200">         }</span>
<a href="#l9.201"></a><span id="l9.201">         return cmpListener.opGroup;</span>
<a href="#l9.202"></a><span id="l9.202">     },</span>
<a href="#l9.203"></a><span id="l9.203"> </span>
<a href="#l9.204"></a><span id="l9.204">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l9.205"></a><span id="l9.205">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l9.206"></a><span id="l9.206">     //                in calIOperationListener aListener );</span>
<a href="#l9.207"></a><span id="l9.207">     getItems: function (aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l9.208"></a><span id="l9.208">         // If there are no calendars, then we just call onOperationComplete</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-        var enabledCalendars = this.enabledCalendars;</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+        let enabledCalendars = this.enabledCalendars;</span>
<a href="#l9.211"></a><span id="l9.211">         if (enabledCalendars.length == 0) {</span>
<a href="#l9.212"></a><span id="l9.212">             aListener.onOperationComplete (this,</span>
<a href="#l9.213"></a><span id="l9.213">                                            Components.results.NS_OK,</span>
<a href="#l9.214"></a><span id="l9.214">                                            calIOperationListener.GET,</span>
<a href="#l9.215"></a><span id="l9.215">                                            null,</span>
<a href="#l9.216"></a><span id="l9.216">                                            null);</span>
<a href="#l9.217"></a><span id="l9.217">             return;</span>
<a href="#l9.218"></a><span id="l9.218">         }</span>
<a href="#l9.219"></a><span id="l9.219">         if (this.mStatusObserver) {</span>
<a href="#l9.220"></a><span id="l9.220">             if (this.mStatusObserver.spinning == Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l9.221"></a><span id="l9.221">                 this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.UNDETERMINED_PROGRESS, -1);</span>
<a href="#l9.222"></a><span id="l9.222">             }</span>
<a href="#l9.223"></a><span id="l9.223">         }</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-        var cmpListener = new calCompositeGetListenerHelper(this, aListener, aCount);</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+        let cmpListener = new calCompositeGetListenerHelper(this, aListener, aCount);</span>
<a href="#l9.226"></a><span id="l9.226"> </span>
<a href="#l9.227"></a><span id="l9.227">         for each (let calendar in enabledCalendars) {</span>
<a href="#l9.228"></a><span id="l9.228">             try {</span>
<a href="#l9.229"></a><span id="l9.229">                 cmpListener.opGroup.add(calendar.getItems(aItemFilter,</span>
<a href="#l9.230"></a><span id="l9.230">                                                           aCount,</span>
<a href="#l9.231"></a><span id="l9.231">                                                           aRangeStart,</span>
<a href="#l9.232"></a><span id="l9.232">                                                           aRangeEnd,</span>
<a href="#l9.233"></a><span id="l9.233">                                                           cmpListener));</span>
<a href="#l9.234"></a><span id="l9.234">             } catch (exc) {</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-                ASSERT(false, exc);</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+                cal.ASSERT(false, exc);</span>
<a href="#l9.237"></a><span id="l9.237">             }</span>
<a href="#l9.238"></a><span id="l9.238">         }</span>
<a href="#l9.239"></a><span id="l9.239">         return cmpListener.opGroup;</span>
<a href="#l9.240"></a><span id="l9.240">     },</span>
<a href="#l9.241"></a><span id="l9.241"> </span>
<a href="#l9.242"></a><span id="l9.242">     startBatch: function () {</span>
<a href="#l9.243"></a><span id="l9.243">         this.mCompositeObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l9.244"></a><span id="l9.244">     },</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineat">@@ -481,30 +493,30 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l9.246"></a><span id="l9.246">     mOpGroup: null,</span>
<a href="#l9.247"></a><span id="l9.247">     mReceivedCompletes: 0,</span>
<a href="#l9.248"></a><span id="l9.248">     mFinished: false,</span>
<a href="#l9.249"></a><span id="l9.249">     mMaxItems: 0,</span>
<a href="#l9.250"></a><span id="l9.250">     mItemsReceived: 0,</span>
<a href="#l9.251"></a><span id="l9.251"> </span>
<a href="#l9.252"></a><span id="l9.252">     get opGroup() {</span>
<a href="#l9.253"></a><span id="l9.253">         if (!this.mOpGroup) {</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-            var this_ = this;</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+            let this_ = this;</span>
<a href="#l9.256"></a><span id="l9.256">             function cancelFunc() { // operation group has been cancelled</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-                var listener = this_.mRealListener;</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+                let listener = this_.mRealListener;</span>
<a href="#l9.259"></a><span id="l9.259">                 this_.mRealListener = null;</span>
<a href="#l9.260"></a><span id="l9.260">                 if (listener) {</span>
<a href="#l9.261"></a><span id="l9.261">                     listener.onOperationComplete(</span>
<a href="#l9.262"></a><span id="l9.262">                         this_, Components.interfaces.calIErrors.OPERATION_CANCELLED,</span>
<a href="#l9.263"></a><span id="l9.263">                         calIOperationListener.GET, null, null);</span>
<a href="#l9.264"></a><span id="l9.264">                     if (this_.mCompositeCalendar.statusDisplayed) {</span>
<a href="#l9.265"></a><span id="l9.265">                         this_.mCompositeCalendar.mStatusObserver.stopMeteors();</span>
<a href="#l9.266"></a><span id="l9.266">                     }</span>
<a href="#l9.267"></a><span id="l9.267">                 }</span>
<a href="#l9.268"></a><span id="l9.268">             }</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-            this.mOpGroup = new calOperationGroup(cancelFunc);</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+            this.mOpGroup = new cal.calOperationGroup(cancelFunc);</span>
<a href="#l9.271"></a><span id="l9.271">         }</span>
<a href="#l9.272"></a><span id="l9.272">         return this.mOpGroup;</span>
<a href="#l9.273"></a><span id="l9.273">     },</span>
<a href="#l9.274"></a><span id="l9.274"> </span>
<a href="#l9.275"></a><span id="l9.275">     QueryInterface: function (aIID) {</span>
<a href="#l9.276"></a><span id="l9.276">         if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l9.277"></a><span id="l9.277">             !aIID.equals(Components.interfaces.calIOperationListener))</span>
<a href="#l9.278"></a><span id="l9.278">         {</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineat">@@ -576,67 +588,10 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l9.280"></a><span id="l9.280"> </span>
<a href="#l9.281"></a><span id="l9.281">         // send GetResults to the real listener</span>
<a href="#l9.282"></a><span id="l9.282">         this.mRealListener.onGetResult (aCalendar, aStatus, aItemType, aDetail, aCount, aItems);</span>
<a href="#l9.283"></a><span id="l9.283">         this.mItemsReceived += aCount;</span>
<a href="#l9.284"></a><span id="l9.284">     }</span>
<a href="#l9.285"></a><span id="l9.285"> </span>
<a href="#l9.286"></a><span id="l9.286"> };</span>
<a href="#l9.287"></a><span id="l9.287"> </span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-// nsIFactory</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-const calCompositeCalendarFactory = {</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-        if (outer != null)</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-        return (new calCompositeCalendar()).QueryInterface(iid);</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-    }</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-};</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-/****</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">- **** module registration</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">- ****/</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-var calCompositeCalendarModule = {</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-    mCID: Components.ID(&quot;{aeff788d-63b0-4996-91fb-40a7654c6224}&quot;),</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-    mContractID: &quot;@mozilla.org/calendar/calendar;1?type=composite&quot;,</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-    loadUtils: function compositeLoadUtils() {</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-        if (this.mUtilsLoaded)</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-            return;</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(this));</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    },</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-        compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-                                        &quot;Calendar composite provider&quot;,</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-                                        this.mContractID,</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-                                        fileSpec,</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-                                        location,</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-                                        type);</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-    },</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-        if (!cid.equals(this.mCID))</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory))</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-        this.loadUtils();</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-        return calCompositeCalendarFactory;</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-    },</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-        return true;</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-    }</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-};</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-    return calCompositeCalendarModule;</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-}</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+/** Module Registration */</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+var NSGetModule = XPCOMUtils.generateNSGetModule([calCompositeCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -32,38 +32,59 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.5"></a><span id="l10.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.6"></a><span id="l10.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.7"></a><span id="l10.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.8"></a><span id="l10.8">  *</span>
<a href="#l10.9"></a><span id="l10.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14"> /**</span>
<a href="#l10.15"></a><span id="l10.15">  * calGoogleCalendar</span>
<a href="#l10.16"></a><span id="l10.16">  * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l10.17"></a><span id="l10.17">  * Provider.</span>
<a href="#l10.18"></a><span id="l10.18">  *</span>
<a href="#l10.19"></a><span id="l10.19">  * @class</span>
<a href="#l10.20"></a><span id="l10.20">  * @constructor</span>
<a href="#l10.21"></a><span id="l10.21">  */</span>
<a href="#l10.22"></a><span id="l10.22"> function calGoogleCalendar() {</span>
<a href="#l10.23"></a><span id="l10.23">     this.initProviderBase();</span>
<a href="#l10.24"></a><span id="l10.24"> }</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> calGoogleCalendar.prototype = {</span>
<a href="#l10.27"></a><span id="l10.27">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=gdata&quot;,</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+    classID:  Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;),</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    getInterfaces: function cI_cGC_getInterfaces (count) {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+        var ifaces = [</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+            Components.interfaces.nsISupports,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+            Components.interfaces.calICalendar,</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+            Components.interfaces.calIGoogleCalendar,</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+            Components.interfaces.calISchedulingSupport,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+            Components.interfaces.calIChangeLog,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+            Components.interfaces.nsIClassInfo</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+        ];</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+        return ifaces;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    },</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+    getHelperForLanguage: function cI_cGC_getHelperForLanguage(aLanguage) {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+        return null;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    },</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    flags: 0,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+</span>
<a href="#l10.53"></a><span id="l10.53">     QueryInterface: function cGS_QueryInterface(aIID) {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-        return doQueryInterface(this,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-                                calGoogleCalendar.prototype,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-                                aIID,</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-                                null,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-                                g_classInfo[&quot;calGoogleCalendar&quot;]);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+        return cal.doQueryInterface(this, calGoogleCalendar.prototype, aIID, null, this);</span>
<a href="#l10.60"></a><span id="l10.60">     },</span>
<a href="#l10.61"></a><span id="l10.61"> </span>
<a href="#l10.62"></a><span id="l10.62">     /* Member Variables */</span>
<a href="#l10.63"></a><span id="l10.63">     mSession: null,</span>
<a href="#l10.64"></a><span id="l10.64">     mFullUri: null,</span>
<a href="#l10.65"></a><span id="l10.65">     mCalendarName: null,</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">     /*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -29,205 +29,51 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.5"></a><span id="l11.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.6"></a><span id="l11.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.7"></a><span id="l11.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.8"></a><span id="l11.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.9"></a><span id="l11.9">  *</span>
<a href="#l11.10"></a><span id="l11.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+</span>
<a href="#l11.16"></a><span id="l11.16"> // This constant is used internally to signal a failed login to the login</span>
<a href="#l11.17"></a><span id="l11.17"> // handler's response function.</span>
<a href="#l11.18"></a><span id="l11.18"> const kGOOGLE_LOGIN_FAILED = 1;</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-var g_classInfo = {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-     calGoogleCalendar: {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-        getInterfaces: function cI_cGC_getInterfaces (count) {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-            var ifaces = [</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-                Components.interfaces.nsISupports,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-                Components.interfaces.calICalendar,</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-                Components.interfaces.calIGoogleCalendar,</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-                Components.interfaces.calISchedulingSupport,</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-                Components.interfaces.calIChangeLog,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-                Components.interfaces.nsIClassInfo</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-            ];</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-            count.value = ifaces.length;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-            return ifaces;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-        },</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-        getHelperForLanguage: function cI_cGC_getHelperForLanguage(aLanguage) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-            return null;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-        },</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-        classDescription: &quot;Google Calendar Provider&quot;,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/calendar;1?type=gdata&quot;,</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-        classID:  Components.ID(&quot;{d1a6e988-4b4d-45a5-ba46-43e501ea96e3}&quot;),</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-        constructor: &quot;calGoogleCalendar&quot;,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-        flags: 0</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    },</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-    calGoogleSession: {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-        getInterfaces: function cI_cGS_getInterfaces (aCount) {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-            var ifaces = [</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-                Components.interfaces.nsISupports,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-                Components.interfaces.calIGoogleSession,</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-                Components.interfaces.nsIClassInfo</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-            ];</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-            aCount.value = ifaces.length;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-            return ifaces;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-        },</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-        getHelperForLanguage: function cI_cGS_getHelperForLanguage(aLanguage) {</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-            return null;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-        },</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-        classDescription: &quot;Google Calendar Session&quot;,</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/providers/gdata/session;1&quot;,</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-        classID:  Components.ID(&quot;{652f6233-e03f-438a-bd3b-39877f68c0f4}&quot;),</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-        constructor: &quot;calGoogleSession&quot;,</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-        flags: 0</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    },</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+/** Module Registration */</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+const calendarScriptLoadOrder = [</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    &quot;calUtils.js&quot;,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+];</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-    calGoogleSessionManager: {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-        getInterfaces: function cI_cGSM_getInterfaces (aCount) {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-            var ifaces = [</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-                Components.interfaces.nsISupports,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-                Components.interfaces.calIGoogleSessionManager,</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-                Components.interfaces.nsIClassInfo</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-            ];</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-            aCount.value = ifaces.length;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-            return ifaces;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-        },</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-        getHelperForLanguage: function cI_cGSM_getHelperForLanguage(aLanguage) {</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-            return null;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-        },</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+const gdataScriptLoadOrder = [</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+    &quot;calGoogleCalendar.js&quot;,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+    &quot;calGoogleSession.js&quot;,</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    &quot;calGoogleRequest.js&quot;,</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+    &quot;calGoogleUtils.js&quot;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+];</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-        classDescription: &quot;Google Calendar Session Manager&quot;,</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/providers/gdata/session-manager;1&quot;,</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-        classID:  Components.ID(&quot;{6a7ba1f0-f271-49b0-8e93-5ca33651b4af}&quot;),</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        constructor: &quot;calGoogleSessionManager&quot;,</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    },</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-    calGoogleRequest: {</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-        getInterfaces: function cI_cGR_getInterfaces (aCount) {</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-            var ifaces = [</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-                Components.interfaces.nsISupports,</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-                Components.interfaces.calIGoogleRequest,</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-                Components.interfaces.calIOperation,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-                Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-                Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-                Components.interfaces.nsIChannelEventSink,</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-                Components.interfaces.nsIClassInfo</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-            ];</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-            aCount.value = ifaces.length;</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-            return ifaces;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-        },</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+function NSGetModule(cid) {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    if (!this.scriptsLoaded) {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+        // First load the calendar scripts</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+        cal.loadScripts(calendarScriptLoadOrder, Components.utils.getGlobalForObject(this));</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-        getHelperForLanguage: function cI_cGR_getHelperForLanguage(aLanguage) {</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-            return null;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-        },</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-        classDescription: &quot;Google Calendar Request&quot;,</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/providers/gdata/request;1&quot;,</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-        classID:  Components.ID(&quot;{53a3438a-21bc-4a0f-b813-77a8b4f19282}&quot;),</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-        constructor: &quot;calGoogleRequest&quot;,</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-        flags: 0</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    }</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-};</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-var calGoogleCalendarModule = {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-    loadUtils: function cGCM_loadUtils() {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-        if (this.mUtilsLoaded)</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-            return;</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(this));</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-        // Now load gdata extension scripts. Note that unintuitively,</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-        // __LOCATION__.parent == . We expect to find the subscripts in ./../js</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+        // Now load gdata extension scripts. __LOCATION__ is the current</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+        // filename, so  __LOCATION__.parent == . We expect to find the</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+        // subscripts in ./../js</span>
<a href="#l11.152"></a><span id="l11.152">         let thisDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l11.153"></a><span id="l11.153">         thisDir.append(&quot;js&quot;);</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-        cal.loadScripts([&quot;calGoogleCalendar.js&quot;, &quot;calGoogleSession.js&quot;,</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-                         &quot;calGoogleRequest.js&quot;, &quot;calGoogleUtils.js&quot;],</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-                        Components.utils.getGlobalForObject(this),</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-                        thisDir);</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    },</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-    unregisterSelf: function cGCM_unregisterSelf(aComponentManager) {</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-        aComponentManager = aComponentManager</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-                            .QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-        for each (var component in g_classInfo) {</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-            aComponentManager.unregisterFactoryLocation(component.classID);</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-        }</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-    },</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-    registerSelf: function cGCM_registerSelf(aComponentManager,</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-                                             aFileSpec,</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-                                             aLocation,</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-                                             aType) {</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-        aComponentManager = aComponentManager</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-                            .QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-        for each (var component in g_classInfo) {</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-            aComponentManager.registerFactoryLocation(</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-                component.classID,</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-                component.classDescription,</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-                component.contractID,</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-                aFileSpec,</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-                aLocation,</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-                aType);</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-        }</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-    },</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+        cal.loadScripts(gdataScriptLoadOrder, Components.utils.getGlobalForObject(this), thisDir);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+        this.scriptsLoaded = true;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+    }</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-    makeFactoryFor: function cGCM_makeFactoryFor(aConstructor) {</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-        var factory = {</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-            QueryInterface: function (aIID) {</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-                if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-                    !aIID.equals(Components.interfaces.nsIFactory))</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-                    throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-                return this;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-            },</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-            createInstance: function (aOuter, aIID) {</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-                if (aOuter != null)</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-                    throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-                return (new aConstructor()).QueryInterface(aIID);</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-            }</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-        };</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-        return factory;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-    },</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    let components = [</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+        calGoogleCalendar,</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+        calGoogleSession,</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+        calGoogleSessionManager,</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+        calGoogleRequest</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    ];</span>
<a href="#l11.214"></a><span id="l11.214"> </span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-    getClassObject: function cGCM_getClassObject(aComponentManager,</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-                                                 aCID,</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-                                                 aIID) {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsIFactory))</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-        this.loadUtils();</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-        for each (var component in g_classInfo) {</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-            if (aCID.equals(component.classID)) {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-                return this.makeFactoryFor(eval(component.constructor));</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-            }</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-        }</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-        throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-    },</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-    canUnload: function(aComponentManager) {</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-        return true;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-    }</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-};</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-function NSGetModule(aComponentManager, aFileSpec) {</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-    return calGoogleCalendarModule;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+    return (XPCOMUtils.generateNSGetModule(components))(cid);</span>
<a href="#l11.239"></a><span id="l11.239"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -29,16 +29,18 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14"> /**</span>
<a href="#l12.15"></a><span id="l12.15">  * calGoogleRequest</span>
<a href="#l12.16"></a><span id="l12.16">  * This class represents a HTTP request sent to Google</span>
<a href="#l12.17"></a><span id="l12.17">  *</span>
<a href="#l12.18"></a><span id="l12.18">  * @constructor</span>
<a href="#l12.19"></a><span id="l12.19">  * @class</span>
<a href="#l12.20"></a><span id="l12.20">  */</span>
<a href="#l12.21"></a><span id="l12.21"> function calGoogleRequest(aSession) {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -79,22 +81,45 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.23"></a><span id="l12.23">     itemRangeEnd: null,</span>
<a href="#l12.24"></a><span id="l12.24">     itemFilter: null,</span>
<a href="#l12.25"></a><span id="l12.25">     itemId: null,</span>
<a href="#l12.26"></a><span id="l12.26">     calendar: null,</span>
<a href="#l12.27"></a><span id="l12.27">     newItem: null,</span>
<a href="#l12.28"></a><span id="l12.28">     oldItem: null,</span>
<a href="#l12.29"></a><span id="l12.29">     destinationCal: null,</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    /* nsIClassInfo */</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    getInterfaces: function cI_cGR_getInterfaces (aCount) {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+        var ifaces = [</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+            Components.interfaces.nsISupports,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+            Components.interfaces.calIGoogleRequest,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+            Components.interfaces.calIOperation,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+            Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+            Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+            Components.interfaces.nsIChannelEventSink,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+            Components.interfaces.nsIClassInfo</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+        ];</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+        aCount.value = ifaces.length;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+        return ifaces;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    },</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    getHelperForLanguage: function cI_cGR_getHelperForLanguage(aLanguage) {</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+        return null;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    },</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    classDescription: &quot;Google Calendar Request&quot;,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/providers/gdata/request;1&quot;,</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    classID:  Components.ID(&quot;{53a3438a-21bc-4a0f-b813-77a8b4f19282}&quot;),</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    constructor: &quot;calGoogleRequest&quot;,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    flags: 0,</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    /* nsISupports */</span>
<a href="#l12.58"></a><span id="l12.58">     QueryInterface: function cGR_QueryInterface(aIID) {</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-        return doQueryInterface(this,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-                                calGoogleRequest.prototype,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-                                aIID,</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-                                null,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-                                g_classInfo[&quot;calGoogleRequest&quot;]);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+        return cal.doQueryInterface(this, calGoogleRequest.prototype, aIID, null, this);</span>
<a href="#l12.65"></a><span id="l12.65">     },</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">     /**</span>
<a href="#l12.68"></a><span id="l12.68">      * Implement calIOperation</span>
<a href="#l12.69"></a><span id="l12.69">      */</span>
<a href="#l12.70"></a><span id="l12.70">     get isPending() {</span>
<a href="#l12.71"></a><span id="l12.71">         return (this.mLoader &amp;&amp; this.mLoader.request != null);</span>
<a href="#l12.72"></a><span id="l12.72">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -44,22 +44,38 @@ const kMANY_EVENTS = 0x7FFFFFFF;</span>
<a href="#l13.4"></a><span id="l13.4"> function calGoogleSessionManager() {</span>
<a href="#l13.5"></a><span id="l13.5">     this.wrappedJSObject = this;</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> }</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> calGoogleSessionManager.prototype = {</span>
<a href="#l13.10"></a><span id="l13.10">     mSessionMap: {},</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    getInterfaces: function cI_cGSM_getInterfaces (aCount) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+        var ifaces = [</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+            Components.interfaces.nsISupports,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+            Components.interfaces.calIGoogleSessionManager,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+            Components.interfaces.nsIClassInfo</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+        ];</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+        aCount.value = ifaces.length;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+        return ifaces;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+    },</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+    getHelperForLanguage: function cI_cGSM_getHelperForLanguage(aLanguage) {</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+        return null;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+    },</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+    classDescription: &quot;Google Calendar Session Manager&quot;,</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/providers/gdata/session-manager;1&quot;,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+    classID:  Components.ID(&quot;{6a7ba1f0-f271-49b0-8e93-5ca33651b4af}&quot;),</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+    flags: Components.interfaces.nsIClassInfo.SINGLETON,</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+</span>
<a href="#l13.32"></a><span id="l13.32">     QueryInterface: function cGSM_QueryInterface(aIID) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-        return doQueryInterface(this,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-                                calGoogleSessionManager.prototype,</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-                                aIID,</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-                                null,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-                                g_classInfo[&quot;calGoogleSessionManager&quot;]);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+        return cal.doQueryInterface(this, calGoogleSessionManager.prototype, aIID, null, this);</span>
<a href="#l13.39"></a><span id="l13.39">     },</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">     /**</span>
<a href="#l13.42"></a><span id="l13.42">      * getSessionByUsername</span>
<a href="#l13.43"></a><span id="l13.43">      * Get a Session object for the specified username. If aCreate is false,</span>
<a href="#l13.44"></a><span id="l13.44">      * null will be returned if the session doesn't exist. Otherwise, the</span>
<a href="#l13.45"></a><span id="l13.45">      * session will be created.</span>
<a href="#l13.46"></a><span id="l13.46">      *</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineat">@@ -101,23 +117,37 @@ function calGoogleSession(aUsername) {</span>
<a href="#l13.48"></a><span id="l13.48">     this.mGoogleUser = aUsername;</span>
<a href="#l13.49"></a><span id="l13.49">     this.wrappedJSObject = this;</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51">     // Register a freebusy provider for this session</span>
<a href="#l13.52"></a><span id="l13.52">     getFreeBusyService().addProvider(this);</span>
<a href="#l13.53"></a><span id="l13.53"> }</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55"> calGoogleSession.prototype = {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+    classDescription: &quot;Google Calendar Session&quot;,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/providers/gdata/session;1&quot;,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+    classID:  Components.ID(&quot;{652f6233-e03f-438a-bd3b-39877f68c0f4}&quot;),</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    getInterfaces: function cI_cGS_getInterfaces (aCount) {</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        let ifaces = [</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+            Components.interfaces.nsISupports,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+            Components.interfaces.calIGoogleSession,</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+            Components.interfaces.nsIClassInfo</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+        ];</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+        aCount.value = ifaces.length;</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+        return ifaces;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+    },</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    getHelperForLanguage: function cI_cGS_getHelperForLanguage(aLanguage) {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+        return null;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+    },</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    flags: 0,</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75">     QueryInterface: function cGS_QueryInterface(aIID) {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-        return doQueryInterface(this,</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-                                calGoogleSessionManager.prototype,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-                                aIID,</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-                                null,</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-                                g_classInfo[&quot;calGoogleSession&quot;]);</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+        return cal.doQueryInterface(this, calGoogleSession.prototype, aIID, null, this);</span>
<a href="#l13.82"></a><span id="l13.82">     },</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84">     /* Member Variables */</span>
<a href="#l13.85"></a><span id="l13.85">     mGoogleUser: null,</span>
<a href="#l13.86"></a><span id="l13.86">     // This must be |undefined|, we need this variable to be tri-state.</span>
<a href="#l13.87"></a><span id="l13.87">     mGooglePass: undefined,</span>
<a href="#l13.88"></a><span id="l13.88">     mGoogleFullName: null,</span>
<a href="#l13.89"></a><span id="l13.89">     mAuthToken: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/providers/ics/Makefile.in</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/providers/ics/Makefile.in</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -39,22 +39,13 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> DEPTH		= ../../..</span>
<a href="#l14.6"></a><span id="l14.6"> topsrcdir	= @top_srcdir@</span>
<a href="#l14.7"></a><span id="l14.7"> srcdir		= @srcdir@</span>
<a href="#l14.8"></a><span id="l14.8"> VPATH		= @srcdir@</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-MODULE = calICSalendar</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-EXTRA_COMPONENTS = calICSCalendarModule.js</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-EXTRA_SCRIPTS = calICSCalendar.js</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+MODULE = calICSCalendar</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-# The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-install:: $(EXTRA_SCRIPTS)</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+EXTRA_COMPONENTS = calICSCalendar.js</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -34,16 +34,20 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.5"></a><span id="l15.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.6"></a><span id="l15.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.7"></a><span id="l15.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.8"></a><span id="l15.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.9"></a><span id="l15.9">  *</span>
<a href="#l15.10"></a><span id="l15.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.16"></a><span id="l15.16"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> //</span>
<a href="#l15.19"></a><span id="l15.19"> // calICSCalendar.js</span>
<a href="#l15.20"></a><span id="l15.20"> //</span>
<a href="#l15.21"></a><span id="l15.21"> // This is a non-sync ics file. It reads the file pointer to by uri when set,</span>
<a href="#l15.22"></a><span id="l15.22"> // then writes it on updates. External changes to the file will be</span>
<a href="#l15.23"></a><span id="l15.23"> // ignored and overwritten.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineat">@@ -63,26 +67,44 @@ function calICSCalendar() {</span>
<a href="#l15.25"></a><span id="l15.25">     this.unmappedProperties = [];</span>
<a href="#l15.26"></a><span id="l15.26">     this.queue = new Array();</span>
<a href="#l15.27"></a><span id="l15.27">     this.mModificationActions = [];</span>
<a href="#l15.28"></a><span id="l15.28"> }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30"> calICSCalendar.prototype = {</span>
<a href="#l15.31"></a><span id="l15.31">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+    classID: Components.ID(&quot;{f8438bff-a3c9-4ed5-b23f-2663b5469abf}&quot;),</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=ics&quot;,</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+    classDescription: &quot;Calendar ICS provider&quot;,</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+        const ifaces = [Components.interfaces.calICalendarProvider,</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+                        Components.interfaces.calICalendar,</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+                        Components.interfaces.calISchedulingSupport,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+                        Components.interfaces.nsIStreamListener,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+                        Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+                        Components.interfaces.nsIChannelEventSink,</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+                        Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+        return ifaces;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    },</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+        return null;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+    },</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+    flags: 0,</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+</span>
<a href="#l15.56"></a><span id="l15.56">     mObserver: null,</span>
<a href="#l15.57"></a><span id="l15.57">     locked: false,</span>
<a href="#l15.58"></a><span id="l15.58"> </span>
<a href="#l15.59"></a><span id="l15.59">     QueryInterface: function (aIID) {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-        return doQueryInterface(this, calICSCalendar.prototype, aIID,</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-                                [Components.interfaces.calICalendarProvider,</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-                                 Components.interfaces.nsIStreamListener,</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-                                 Components.interfaces.nsIStreamLoaderObserver,</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-                                 Components.interfaces.nsIChannelEventSink,</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-                                 Components.interfaces.nsIInterfaceRequestor]);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+        return cal.doQueryInterface(this, calICSCalendar.prototype, aIID, null, this);</span>
<a href="#l15.67"></a><span id="l15.67">     },</span>
<a href="#l15.68"></a><span id="l15.68">     </span>
<a href="#l15.69"></a><span id="l15.69">     initICSCalendar: function() {</span>
<a href="#l15.70"></a><span id="l15.70">         this.mMemoryCalendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l15.71"></a><span id="l15.71">                                          .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l15.74"></a><span id="l15.74">         this.mObserver = new calICSObserver(this);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineat">@@ -1027,8 +1049,26 @@ fileHooks.prototype = {</span>
<a href="#l15.76"></a><span id="l15.76"> </span>
<a href="#l15.77"></a><span id="l15.77">     onAfterPut: function fH_onAfterPut(aChannel, aRespFunc) {</span>
<a href="#l15.78"></a><span id="l15.78">         let filechannel = this.mChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l15.79"></a><span id="l15.79">         this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l15.80"></a><span id="l15.80">         aRespFunc();</span>
<a href="#l15.81"></a><span id="l15.81">         return true;</span>
<a href="#l15.82"></a><span id="l15.82">     }</span>
<a href="#l15.83"></a><span id="l15.83"> };</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+/** Module Registration */</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+const scriptLoadOrder = [</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+    &quot;calUtils.js&quot;,</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+];</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+function NSGetModule(cid) {</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    if (!this.scriptsLoaded) {</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+        Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+                .QueryInterface(Components.interfaces.nsIResProtocolHandler)</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+                .setSubstitution(&quot;calendar&quot;, Services.io.newFileURI(__LOCATION__.parent.parent));</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+        cal.loadScripts(scriptLoadOrder, Components.utils.getGlobalForObject(this));</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+        this.scriptsLoaded = true;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+    }</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+    return (XPCOMUtils.generateNSGetModule([calICSCalendar]))(cid);</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/calendar/providers/ics/calICSCalendarModule.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,109 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- *</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">- *</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">- * License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">- *</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">- * The Original Code is mozilla calendar code.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">- *</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">- *   Michiel van Leeuwen &lt;mvl@exedo.nl&gt;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">- *</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">- *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">- *   Dan Mosedale &lt;dan.mosedale@oracle.com&gt;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">- *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">- *</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">- *</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-// nsIFactory</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-const calICSCalendarFactory = {</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-            !aIID.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-        }</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-        return this;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-    },</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-        if (outer != null)</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-        return (new calICSCalendar()).QueryInterface(iid);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-    }</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-};</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-/****</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">- **** module registration</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">- ****/</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-var calICSCalendarModule = {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-    mCID: Components.ID(&quot;{f8438bff-a3c9-4ed5-b23f-2663b5469abf}&quot;),</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-    mContractID: &quot;@mozilla.org/calendar/calendar;1?type=ics&quot;,</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-    loadUtils: function cICM_loadUtils() {</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-        if (this.mUtilsLoaded) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-            return;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-        }</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calICSCalendar.js&quot;],</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-                        Components.utils.getGlobalForObject(this));</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-    },</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-        compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-                                        &quot;Calendar ICS provider&quot;,</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-                                        this.mContractID,</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-                                        fileSpec,</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-                                        location,</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-                                        type);</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-    },</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-        if (!cid.equals(this.mCID))</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory))</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-        this.loadUtils();</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-        return calICSCalendarFactory;</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    },</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-        return true;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-    }</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-};</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-    return calICSCalendarModule;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/providers/memory/Makefile.in</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/providers/memory/Makefile.in</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -40,20 +40,11 @@ DEPTH		= ../../..</span>
<a href="#l17.4"></a><span id="l17.4"> topsrcdir	= @top_srcdir@</span>
<a href="#l17.5"></a><span id="l17.5"> srcdir		= @srcdir@</span>
<a href="#l17.6"></a><span id="l17.6"> VPATH		= @srcdir@</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> MODULE = calMemoryCalendar</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-EXTRA_COMPONENTS = calMemoryCalendarModule.js</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-EXTRA_SCRIPTS = calMemoryCalendar.js</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-# The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-install:: $(EXTRA_SCRIPTS)</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+EXTRA_COMPONENTS = calMemoryCalendar.js</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -32,67 +32,89 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.5"></a><span id="l18.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.6"></a><span id="l18.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.7"></a><span id="l18.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.8"></a><span id="l18.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.9"></a><span id="l18.9">  *</span>
<a href="#l18.10"></a><span id="l18.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+</span>
<a href="#l18.15"></a><span id="l18.15"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> //</span>
<a href="#l18.19"></a><span id="l18.19"> // calMemoryCalendar.js</span>
<a href="#l18.20"></a><span id="l18.20"> //</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> const calCalendarManagerContractID = &quot;@mozilla.org/calendar/manager;1&quot;;</span>
<a href="#l18.23"></a><span id="l18.23"> const calICalendarManager = Components.interfaces.calICalendarManager;</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25"> function calMemoryCalendar() {</span>
<a href="#l18.26"></a><span id="l18.26">     this.initProviderBase();</span>
<a href="#l18.27"></a><span id="l18.27">     this.initMemoryCalendar();</span>
<a href="#l18.28"></a><span id="l18.28"> }</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30"> calMemoryCalendar.prototype = {</span>
<a href="#l18.31"></a><span id="l18.31">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+    classID: Components.ID(&quot;{bda0dd7f-0a2f-4fcf-ba08-5517e6fbf133}&quot;),</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=memory&quot;,</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    classDescription: &quot;Calendar Memory Provider&quot;,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    getInterfaces: function getInterfaces(count) {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+        const ifaces = [Components.interfaces.calICalendar,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+                        Components.interfaces.calISchedulingSupport,</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+                        Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+                        Components.interfaces.calICalendarProvider,</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+                        Components.interfaces.nsISupports];</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+        return ifaces;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    },</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+    getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+        return null;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    },</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    flags: 0,</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+</span>
<a href="#l18.53"></a><span id="l18.53">     //</span>
<a href="#l18.54"></a><span id="l18.54">     // nsISupports interface</span>
<a href="#l18.55"></a><span id="l18.55">     // </span>
<a href="#l18.56"></a><span id="l18.56">     QueryInterface: function (aIID) {</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-        return doQueryInterface(this, calMemoryCalendar.prototype, aIID,</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-                                [Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-                                 Components.interfaces.calICalendarProvider]);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+        return cal.doQueryInterface(this, calMemoryCalendar.prototype, aIID, null, this);</span>
<a href="#l18.61"></a><span id="l18.61">     },</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63">     initMemoryCalendar: function() {</span>
<a href="#l18.64"></a><span id="l18.64">         this.mObservers = new cal.ObserverBag(Components.interfaces.calIObserver);</span>
<a href="#l18.65"></a><span id="l18.65">         this.mItems = {};</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-        this.mMetaData = new calPropertyBag();</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+        this.mMetaData = new cal.calPropertyBag();</span>
<a href="#l18.68"></a><span id="l18.68">     },</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70">     //</span>
<a href="#l18.71"></a><span id="l18.71">     // calICalendarProvider interface</span>
<a href="#l18.72"></a><span id="l18.72">     //</span>
<a href="#l18.73"></a><span id="l18.73">     get prefChromeOverlay() {</span>
<a href="#l18.74"></a><span id="l18.74">         return null;</span>
<a href="#l18.75"></a><span id="l18.75">     },</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77">     get displayName() {</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-        return calGetString(&quot;calendar&quot;, &quot;memoryName&quot;);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+        return cal.calGetString(&quot;calendar&quot;, &quot;memoryName&quot;);</span>
<a href="#l18.80"></a><span id="l18.80">     },</span>
<a href="#l18.81"></a><span id="l18.81"> </span>
<a href="#l18.82"></a><span id="l18.82">     createCalendar: function mem_createCal() {</span>
<a href="#l18.83"></a><span id="l18.83">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.84"></a><span id="l18.84">     },</span>
<a href="#l18.85"></a><span id="l18.85"> </span>
<a href="#l18.86"></a><span id="l18.86">     deleteCalendar: function mem_deleteCal(cal, listener) {</span>
<a href="#l18.87"></a><span id="l18.87">         cal = cal.wrappedJSObject;</span>
<a href="#l18.88"></a><span id="l18.88">         cal.mItems = {};</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-        cal.mMetaData = new calPropertyBag();</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+        cal.mMetaData = new cal.calPropertyBag();</span>
<a href="#l18.91"></a><span id="l18.91"> </span>
<a href="#l18.92"></a><span id="l18.92">         try {</span>
<a href="#l18.93"></a><span id="l18.93">             listener.onDeleteCalendar(cal, Components.results.NS_OK, null);</span>
<a href="#l18.94"></a><span id="l18.94">         } catch(ex) {}</span>
<a href="#l18.95"></a><span id="l18.95">     },</span>
<a href="#l18.96"></a><span id="l18.96"> </span>
<a href="#l18.97"></a><span id="l18.97">     mRelaxedMode: undefined,</span>
<a href="#l18.98"></a><span id="l18.98">     get relaxedMode() {</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineat">@@ -311,19 +333,19 @@ calMemoryCalendar.prototype = {</span>
<a href="#l18.100"></a><span id="l18.100">                                          aId,</span>
<a href="#l18.101"></a><span id="l18.101">                                          null);</span>
<a href="#l18.102"></a><span id="l18.102">             return;</span>
<a href="#l18.103"></a><span id="l18.103">         }</span>
<a href="#l18.104"></a><span id="l18.104"> </span>
<a href="#l18.105"></a><span id="l18.105">         var item = this.mItems[aId];</span>
<a href="#l18.106"></a><span id="l18.106">         var iid = null;</span>
<a href="#l18.107"></a><span id="l18.107"> </span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-        if (isEvent(item)) {</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+        if (cal.isEvent(item)) {</span>
<a href="#l18.110"></a><span id="l18.110">             iid = Components.interfaces.calIEvent;</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-        } else if (isToDo(item)) {</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+        } else if (cal.isToDo(item)) {</span>
<a href="#l18.113"></a><span id="l18.113">             iid = Components.interfaces.calITodo;</span>
<a href="#l18.114"></a><span id="l18.114">         } else {</span>
<a href="#l18.115"></a><span id="l18.115">             this.notifyOperationComplete(aListener,</span>
<a href="#l18.116"></a><span id="l18.116">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l18.117"></a><span id="l18.117">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l18.118"></a><span id="l18.118">                                          aId,</span>
<a href="#l18.119"></a><span id="l18.119">                                          &quot;Can't deduce item type based on QI&quot;);</span>
<a href="#l18.120"></a><span id="l18.120">             return;</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineat">@@ -410,22 +432,22 @@ calMemoryCalendar.prototype = {</span>
<a href="#l18.122"></a><span id="l18.122">                 typeIID = Components.interfaces.calIItemBase;</span>
<a href="#l18.123"></a><span id="l18.123">             } else if (wantEvents) {</span>
<a href="#l18.124"></a><span id="l18.124">                 typeIID = Components.interfaces.calIEvent;</span>
<a href="#l18.125"></a><span id="l18.125">             } else if (wantTodos) {</span>
<a href="#l18.126"></a><span id="l18.126">                 typeIID = Components.interfaces.calITodo;</span>
<a href="#l18.127"></a><span id="l18.127">             }</span>
<a href="#l18.128"></a><span id="l18.128">         }</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-        aRangeStart = ensureDateTime(aRangeStart);</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-        aRangeEnd = ensureDateTime(aRangeEnd);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+        aRangeStart = cal.ensureDateTime(aRangeStart);</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+        aRangeEnd = cal.ensureDateTime(aRangeEnd);</span>
<a href="#l18.134"></a><span id="l18.134"> </span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-        for (var itemIndex in this.mItems) {</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-            var item = this.mItems[itemIndex];</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-            var isEvent_ = isEvent(item);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+        for (let itemIndex in this.mItems) {</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+            let item = this.mItems[itemIndex];</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+            let isEvent_ = cal.isEvent(item);</span>
<a href="#l18.141"></a><span id="l18.141">             if (isEvent_) {</span>
<a href="#l18.142"></a><span id="l18.142">                 if (!wantEvents) {</span>
<a href="#l18.143"></a><span id="l18.143">                     continue;</span>
<a href="#l18.144"></a><span id="l18.144">                 }</span>
<a href="#l18.145"></a><span id="l18.145">             } else if (!wantTodos) {</span>
<a href="#l18.146"></a><span id="l18.146">                 continue;</span>
<a href="#l18.147"></a><span id="l18.147">             }</span>
<a href="#l18.148"></a><span id="l18.148"> </span>
<a href="#l18.149"></a><span id="l18.149" class="difflineat">@@ -436,17 +458,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l18.150"></a><span id="l18.150">                     occurrences = occurrences.filter(checkUnrespondedInvitation);</span>
<a href="#l18.151"></a><span id="l18.151">                 }</span>
<a href="#l18.152"></a><span id="l18.152">                 if (!isEvent_) {</span>
<a href="#l18.153"></a><span id="l18.153">                     occurrences = occurrences.filter(checkCompleted);</span>
<a href="#l18.154"></a><span id="l18.154">                 }</span>
<a href="#l18.155"></a><span id="l18.155">                 itemsFound = itemsFound.concat(occurrences);</span>
<a href="#l18.156"></a><span id="l18.156">             } else if ((!wantUnrespondedInvitations || checkUnrespondedInvitation(item)) &amp;&amp;</span>
<a href="#l18.157"></a><span id="l18.157">                        (isEvent_ || checkCompleted(item)) &amp;&amp;</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-                       checkIfInRange(item, aRangeStart, aRangeEnd)) {</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+                       cal.checkIfInRange(item, aRangeStart, aRangeEnd)) {</span>
<a href="#l18.160"></a><span id="l18.160">                 // This needs fixing for recurring items, e.g. DTSTART of parent may occur before aRangeStart.</span>
<a href="#l18.161"></a><span id="l18.161">                 // This will be changed with bug 416975.</span>
<a href="#l18.162"></a><span id="l18.162">                 itemsFound.push(item);</span>
<a href="#l18.163"></a><span id="l18.163">             }</span>
<a href="#l18.164"></a><span id="l18.164">             if (aCount &amp;&amp; itemsFound.length &gt;= aCount) {</span>
<a href="#l18.165"></a><span id="l18.165">                 break;</span>
<a href="#l18.166"></a><span id="l18.166">             }</span>
<a href="#l18.167"></a><span id="l18.167"> </span>
<a href="#l18.168"></a><span id="l18.168" class="difflineat">@@ -481,8 +503,11 @@ calMemoryCalendar.prototype = {</span>
<a href="#l18.169"></a><span id="l18.169">     },</span>
<a href="#l18.170"></a><span id="l18.170">     getAllMetaData: function memory_getAllMetaData(out_count,</span>
<a href="#l18.171"></a><span id="l18.171">                                                    out_ids,</span>
<a href="#l18.172"></a><span id="l18.172">                                                    out_values) {</span>
<a href="#l18.173"></a><span id="l18.173">         this.mMetaData.getAllProperties(out_ids, out_values);</span>
<a href="#l18.174"></a><span id="l18.174">         out_count.value = out_ids.value.length;</span>
<a href="#l18.175"></a><span id="l18.175">     }</span>
<a href="#l18.176"></a><span id="l18.176"> };</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+/** Module Registration */</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+var NSGetModule = XPCOMUtils.generateNSGetModule([calMemoryCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendarModule.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,106 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">- *</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">- *</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">- * License.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">- *</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">- * The Original Code is Oracle Corporation code.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">- *</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">- *  Oracle Corporation</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">- *</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">- *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">- *</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">- *</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-// nsIFactory</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-const calMemoryCalendarFactory = {</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-            !aIID.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-        }</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-        return this;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-    },</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-        if (outer != null)</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-        return (new calMemoryCalendar()).QueryInterface(iid);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-    }</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-};</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-/****</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">- **** module registration</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">- ****/</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-var calMemoryCalendarModule = {</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-    mCID: Components.ID(&quot;{bda0dd7f-0a2f-4fcf-ba08-5517e6fbf133}&quot;),</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-    mContractID: &quot;@mozilla.org/calendar/calendar;1?type=memory&quot;,</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-    loadUtils: function cMCM_loadUtils() {</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-        if (this.mUtilsLoaded) {</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-            return;</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-        }</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calMemoryCalendar.js&quot;],</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-                        Components.utils.getGlobalForObject(this));</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-    },</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-        compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-                                        &quot;Calendar in-memory back-end&quot;,</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-                                        this.mContractID,</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-                                        fileSpec,</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-                                        location,</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-                                        type);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-    },</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-        if (!cid.equals(this.mCID))</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory))</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-        this.loadUtils();</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-        return calMemoryCalendarFactory;</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-    },</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-        return true;</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-    }</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-};</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-    return calMemoryCalendarModule;</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/providers/storage/Makefile.in</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/providers/storage/Makefile.in</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -39,24 +39,15 @@ DEPTH		= ../../..</span>
<a href="#l20.4"></a><span id="l20.4"> topsrcdir	= @top_srcdir@</span>
<a href="#l20.5"></a><span id="l20.5"> srcdir		= @srcdir@</span>
<a href="#l20.6"></a><span id="l20.6"> VPATH		= @srcdir@</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> MODULE = calStorageCalendar</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-EXTRA_COMPONENTS = calStorageCalendarModule.js</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-EXTRA_SCRIPTS = calStorageCalendar.js</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+EXTRA_COMPONENTS = calStorageCalendar.js</span>
<a href="#l20.15"></a><span id="l20.15"> EXTRA_JS_MODULES = \</span>
<a href="#l20.16"></a><span id="l20.16">     calStorageHelpers.jsm \</span>
<a href="#l20.17"></a><span id="l20.17">     calStorageUpgrade.jsm \</span>
<a href="#l20.18"></a><span id="l20.18">     $(NULL)</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-libs:: $(EXTRA_SCRIPTS)</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-	if test ! -d $(FINAL_TARGET)/calendar-js; then $(NSINSTALL) -D $(FINAL_TARGET)/calendar-js; fi</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-	$(INSTALL) $^ $(FINAL_TARGET)/calendar-js</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-# The install target must use SYSINSTALL, which is NSINSTALL in copy mode.</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-install:: $(EXTRA_SCRIPTS)</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/calendar-js</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-</span>
<a href="#l20.28"></a><span id="l20.28"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -38,20 +38,22 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.5"></a><span id="l21.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.6"></a><span id="l21.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.7"></a><span id="l21.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.8"></a><span id="l21.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.9"></a><span id="l21.9">  *</span>
<a href="#l21.10"></a><span id="l21.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.17"></a><span id="l21.17"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l21.19"></a><span id="l21.19"> Components.utils.import(&quot;resource://calendar/modules/calStorageUpgrade.jsm&quot;);</span>
<a href="#l21.20"></a><span id="l21.20"> Components.utils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;);</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22"> const USECS_PER_SECOND = 1000000;</span>
<a href="#l21.23"></a><span id="l21.23"> const kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25"> //</span>
<a href="#l21.26"></a><span id="l21.26"> // calStorageCalendar</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineat">@@ -61,16 +63,38 @@ function calStorageCalendar() {</span>
<a href="#l21.28"></a><span id="l21.28">     this.initProviderBase();</span>
<a href="#l21.29"></a><span id="l21.29">     this.mItemCache = {};</span>
<a href="#l21.30"></a><span id="l21.30">     this.mRecEventCache = {};</span>
<a href="#l21.31"></a><span id="l21.31">     this.mRecTodoCache = {};</span>
<a href="#l21.32"></a><span id="l21.32"> }</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34"> calStorageCalendar.prototype = {</span>
<a href="#l21.35"></a><span id="l21.35">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+    classID: Components.ID(&quot;{b3eaa1c4-5dfe-4c0a-b62a-b3a514218461}&quot;),</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=storage&quot;,</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+    classDescription: &quot;Calendar Storage Provider&quot;,</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+    getInterfaces: function (count) {</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+        let ifaces = [</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+            Components.interfaces.nsISupports,</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+            Components.interfaces.calICalendarManager,</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+            Components.interfaces.calIStartupService,</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+            Components.interfaces.nsIObserver,</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+            Components.interfaces.nsIClassInfo</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+        ];</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+        return ifaces;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+    },</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+    getHelperForLanguage: function (language) {</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+        return null;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+    },</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+    flags: 0,</span>
<a href="#l21.58"></a><span id="l21.58">     //</span>
<a href="#l21.59"></a><span id="l21.59">     // private members</span>
<a href="#l21.60"></a><span id="l21.60">     //</span>
<a href="#l21.61"></a><span id="l21.61">     mDB: null,</span>
<a href="#l21.62"></a><span id="l21.62">     mItemCache: null,</span>
<a href="#l21.63"></a><span id="l21.63">     mRecItemCacheInited: false,</span>
<a href="#l21.64"></a><span id="l21.64">     mRecEventCache: null,</span>
<a href="#l21.65"></a><span id="l21.65">     mRecTodoCache: null,</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineat">@@ -2339,8 +2363,26 @@ calStorageCalendar.prototype = {</span>
<a href="#l21.67"></a><span id="l21.67">         }</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">         if (exception) {</span>
<a href="#l21.70"></a><span id="l21.70">             logMessage += &quot;\nException: &quot; + exception;</span>
<a href="#l21.71"></a><span id="l21.71">         }</span>
<a href="#l21.72"></a><span id="l21.72">         cal.ERROR(logMessage + &quot;\n&quot; + STACK(10));</span>
<a href="#l21.73"></a><span id="l21.73">     }</span>
<a href="#l21.74"></a><span id="l21.74"> };</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+/** Module Registration */</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+const scriptLoadOrder = [</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+    &quot;calUtils.js&quot;,</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+];</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+function NSGetModule(cid) {</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+    if (!this.scriptsLoaded) {</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+        Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+                .QueryInterface(Components.interfaces.nsIResProtocolHandler)</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+                .setSubstitution(&quot;calendar&quot;, Services.io.newFileURI(__LOCATION__.parent.parent));</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+        cal.loadScripts(scriptLoadOrder, Components.utils.getGlobalForObject(this));</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+        this.scriptsLoaded = true;</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+    }</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+    return (XPCOMUtils.generateNSGetModule([calStorageCalendar]))(cid);</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendarModule.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,111 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">- *</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">- *</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">- * License.</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">- *</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">- * The Original Code is Oracle Corporation code.</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">- *</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">- *  Oracle Corporation</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2005, 2006</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">- *</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">- *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">- *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">- *   Dan Mosedale &lt;dan.mosedale@oracle.com&gt;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">- *   Thomas Benisch &lt;thomas.benisch@sun.com&gt;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">- *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">- *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">- *</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">- *</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-// nsIFactory</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-const calStorageCalendarFactory = {</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-        if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-            !aIID.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-        }</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-        return this;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    },</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-    createInstance: function (outer, iid) {</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-        if (outer != null)</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-        return (new calStorageCalendar()).QueryInterface(iid);</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-    }</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-};</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-/****</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">- **** module registration</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">- ****/</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-var calStorageCalendarModule = {</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    mCID: Components.ID(&quot;{b3eaa1c4-5dfe-4c0a-b62a-b3a514218461}&quot;),</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-    mContractID: &quot;@mozilla.org/calendar/calendar;1?type=storage&quot;,</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-    mUtilsLoaded: false,</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-    loadUtils: function storageLoadUtils() {</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-        if (this.mUtilsLoaded)</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-            return;</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-        cal.loadScripts([&quot;calUtils.js&quot;, &quot;calStorageCalendar.js&quot;],</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-                        Components.utils.getGlobalForObject(this));</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-        this.mUtilsLoaded = true;</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-    },</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-    registerSelf: function (compMgr, fileSpec, location, type) {</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-        compMgr.registerFactoryLocation(this.mCID,</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-                                        &quot;Calendar mozStorage/SQL back-end&quot;,</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-                                        this.mContractID,</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-                                        fileSpec,</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-                                        location,</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-                                        type);</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-    },</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-    getClassObject: function (compMgr, cid, iid) {</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-        if (!cid.equals(this.mCID)) {</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-        }</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-        }</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-        this.loadUtils();</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-        return calStorageCalendarFactory;</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-    },</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-    canUnload: function(compMgr) {</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-        return true;</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-    }</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-};</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-    return calStorageCalendarModule;</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/providers/wcap/Makefile.in</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/providers/wcap/Makefile.in</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #</span>
<a href="#l23.5"></a><span id="l23.5"> # The Initial Developer of the Original Code is</span>
<a href="#l23.6"></a><span id="l23.6"> # Sun Microsystems, Inc.</span>
<a href="#l23.7"></a><span id="l23.7"> # Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l23.8"></a><span id="l23.8"> # the Initial Developer. All Rights Reserved.</span>
<a href="#l23.9"></a><span id="l23.9"> #</span>
<a href="#l23.10"></a><span id="l23.10"> # Contributor(s):</span>
<a href="#l23.11"></a><span id="l23.11"> #   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+#   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l23.13"></a><span id="l23.13"> #</span>
<a href="#l23.14"></a><span id="l23.14"> # Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l23.15"></a><span id="l23.15"> # either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l23.16"></a><span id="l23.16"> # the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l23.17"></a><span id="l23.17"> # in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l23.18"></a><span id="l23.18"> # of those above. If you wish to allow use of your version of this file only</span>
<a href="#l23.19"></a><span id="l23.19"> # under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l23.20"></a><span id="l23.20"> # use your version of this file under the terms of the MPL, indicate your</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -31,27 +31,49 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l24.5"></a><span id="l24.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l24.6"></a><span id="l24.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l24.7"></a><span id="l24.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.8"></a><span id="l24.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.9"></a><span id="l24.9">  *</span>
<a href="#l24.10"></a><span id="l24.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+</span>
<a href="#l24.14"></a><span id="l24.14"> function calWcapCalendar(/*optional*/session, /*optional*/calProps) {</span>
<a href="#l24.15"></a><span id="l24.15">     this.initProviderBase();</span>
<a href="#l24.16"></a><span id="l24.16">     this.m_session = session;</span>
<a href="#l24.17"></a><span id="l24.17">     this.m_calProps = calProps;</span>
<a href="#l24.18"></a><span id="l24.18"> }</span>
<a href="#l24.19"></a><span id="l24.19"> calWcapCalendar.prototype = {</span>
<a href="#l24.20"></a><span id="l24.20">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+    getInterfaces: function ci_wcapCalendar_getInterfaces(count) {</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+        const ifaces = [calIWcapCalendar,</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+                        calICalendar,</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+                        Components.interfaces.calISchedulingSupport,</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+                        Components.interfaces.calIChangeLog,</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+                        Components.interfaces.calICalendarProvider,</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+                        nsISupports];</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+        return ifaces;</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+    },</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+    classDescription: &quot;Sun Java System Calendar Server WCAP Provider&quot;,</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    classID: Components.ID(&quot;{cf4d93e5-af79-451a-95f3-109055b32ef0}&quot;),</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+    getHelperForLanguage: function ci_wcapCalendar_getHelperForLanguage(language) {</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+        return null;</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    },</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+    flags: 0,</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+</span>
<a href="#l24.42"></a><span id="l24.42">     // nsISupports:</span>
<a href="#l24.43"></a><span id="l24.43">     QueryInterface: function calWcapCalendar_QueryInterface(iid) {</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-        return doQueryInterface(this, calWcapCalendar.prototype, iid, null, g_classInfo.wcapCalendar);</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+        return cal.doQueryInterface(this, calWcapCalendar.prototype, iid, null, this);</span>
<a href="#l24.46"></a><span id="l24.46">     },</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48">     toString: function calWcapCalendar_toString() {</span>
<a href="#l24.49"></a><span id="l24.49">         var str = this.session.toString();</span>
<a href="#l24.50"></a><span id="l24.50">         if (this.m_calId) {</span>
<a href="#l24.51"></a><span id="l24.51">             str += (&quot;, calId=&quot; + this.calId);</span>
<a href="#l24.52"></a><span id="l24.52">         } else {</span>
<a href="#l24.53"></a><span id="l24.53">             str += &quot;, default calendar&quot;;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineat">@@ -380,9 +402,8 @@ calWcapCalendar.prototype = {</span>
<a href="#l24.55"></a><span id="l24.55">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l24.56"></a><span id="l24.56">     },</span>
<a href="#l24.57"></a><span id="l24.57"> </span>
<a href="#l24.58"></a><span id="l24.58">     getAccessControlDefinitions: function calWcapCalendar_getAccessControlDefinitions(out_count, out_users,</span>
<a href="#l24.59"></a><span id="l24.59">                                                                                       out_accessControlBits) {</span>
<a href="#l24.60"></a><span id="l24.60">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l24.61"></a><span id="l24.61">     }</span>
<a href="#l24.62"></a><span id="l24.62"> };</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -31,16 +31,19 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l25.5"></a><span id="l25.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l25.6"></a><span id="l25.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l25.7"></a><span id="l25.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l25.8"></a><span id="l25.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l25.9"></a><span id="l25.9">  *</span>
<a href="#l25.10"></a><span id="l25.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+</span>
<a href="#l25.15"></a><span id="l25.15"> //</span>
<a href="#l25.16"></a><span id="l25.16"> // init code for globals, prefs:</span>
<a href="#l25.17"></a><span id="l25.17"> //</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19"> // constants:</span>
<a href="#l25.20"></a><span id="l25.20"> const NS_OK = Components.results.NS_OK;</span>
<a href="#l25.21"></a><span id="l25.21"> const NS_ERROR_UNEXPECTED = Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l25.22"></a><span id="l25.22"> const nsIException = Components.interfaces.nsIException;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineat">@@ -84,136 +87,44 @@ function initWcapProvider() {</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25">         CACHE_LAST_RESULTS = getPref(&quot;calendar.wcap.cache_last_results&quot;, 4);</span>
<a href="#l25.26"></a><span id="l25.26">         CACHE_LAST_RESULTS_INVALIDATE = getPref(&quot;calendar.wcap.cache_last_results_invalidate&quot;, 120);</span>
<a href="#l25.27"></a><span id="l25.27">     } catch (exc) {</span>
<a href="#l25.28"></a><span id="l25.28">         logError(exc, &quot;error in init sequence&quot;);</span>
<a href="#l25.29"></a><span id="l25.29">     }</span>
<a href="#l25.30"></a><span id="l25.30"> }</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-var calWcapCalendarFactory = { // nsIFactory:</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-    lockFactory: function calWcapCalendarFactory_lockFactory(lock) {</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-    },</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-    createInstance: function calWcapCalendarFactory_createInstance(outer, iid) {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-        if (outer) {</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-            throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-        }</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-        return (new calWcapCalendar()).QueryInterface(iid);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-    }</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-};</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-var g_classInfo = {</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-    wcapCalendar: { // nsIClassInfo:</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-        getInterfaces: function ci_wcapCalendar_getInterfaces(count) {</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-            const ifaces = [calIWcapCalendar,</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-                            calICalendar,</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-                            Components.interfaces.calISchedulingSupport,</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-                            Components.interfaces.calIChangeLog,</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-                            Components.interfaces.calICalendarProvider,</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-                            Components.interfaces.nsIClassInfo,</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-                            nsISupports];</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-            count.value = ifaces.length;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-            return ifaces;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-        },</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-        classDescription: &quot;Sun Java System Calendar Server WCAP Provider&quot;,</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-        classID: Components.ID(&quot;{CF4D93E5-AF79-451a-95F3-109055B32EF0}&quot;),</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-        getHelperForLanguage: function ci_wcapCalendar_getHelperForLanguage(language) {</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-            return null;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-        },</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-        flags: 0</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-    },</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-    wcapSession: { // nsIClassInfo:</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-        getInterfaces: function ci_wcapSession_getInterfaces(count) {</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-            const ifaces = [calIWcapSession,</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-                            calIFreeBusyProvider,</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-                            calICalendarSearchProvider,</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-                            Components.interfaces.calITimezoneProvider,</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-                            Components.interfaces.calICalendarManagerObserver,</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-                            Components.interfaces.nsIClassInfo,</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-                            nsISupports];</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-            count.value = ifaces.length;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-            return ifaces;</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-        },</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-        classDescription: &quot;Sun Java System Calendar Server WCAP Session&quot;,</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/wcap/session;1&quot;,</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-        classID: Components.ID(&quot;{CBF803FD-4469-4999-AE39-367AF1C7B077}&quot;),</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-        getHelperForLanguage: function ci_wcapSession_getHelperForLanguage(language) {</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-            return null;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-        },</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-        flags: 0</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    },</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+/** Module Registration */</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+const scriptLoadOrder = [</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+    &quot;calUtils.js&quot;,</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+    &quot;calWcapUtils.js&quot;,</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+    &quot;calWcapErrors.js&quot;,</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+    &quot;calWcapRequest.js&quot;,</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+    &quot;calWcapSession.js&quot;,</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+    &quot;calWcapCalendar.js&quot;,</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+    &quot;calWcapCalendarItems.js&quot;</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+];</span>
<a href="#l25.98"></a><span id="l25.98"> </span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-    wcapNetworkRequest: { // nsIClassInfo:</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-        getInterfaces: function ci_wcapNetworkRequest_getInterfaces(count) {</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-            const ifaces = [Components.interfaces.nsIUnicharStreamLoaderObserver,</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-                            Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-                            Components.interfaces.nsIChannelEventSink,</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-                            Components.interfaces.calIOperation,</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-                            Components.interfaces.nsIClassInfo,</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-                            nsISupports];</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-            count.value = ifaces.length;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-            return ifaces;</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-        },</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-        classDescription: &quot;Sun Java System Calendar Server WCAP Network Request&quot;,</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-        contractID: &quot;@mozilla.org/calendar/wcap/network-request;1&quot;,</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-        classID: Components.ID(&quot;{E3C62B37-83CF-41EC-9872-0AF9F952430A}&quot;),</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-        getHelperForLanguage: function ci_wcapNetworkRequest_getHelperForLanguage(language) {</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-            return null;</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-        },</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-        implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-        flags: 0</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+function NSGetModule(cid) {</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+    try {</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+    if (!this.scriptsLoaded) {</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+        Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+                .QueryInterface(Components.interfaces.nsIResProtocolHandler)</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+                .setSubstitution(&quot;calendar&quot;, Services.io.newFileURI(__LOCATION__.parent.parent));</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+        cal.loadScripts(scriptLoadOrder, Components.utils.getGlobalForObject(this));</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+        initWcapProvider();</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+        this.scriptsLoaded = true;</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+</span>
<a href="#l25.129"></a><span id="l25.129">     }</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-};</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-var calWcapCalendarModule = { // nsIModule:</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-    </span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-    registerSelf: function calWcapCalendarModule_registerSelf(compMgr, fileSpec, location, type) {</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-        compMgr.registerFactoryLocation(g_classInfo.wcapCalendar.classID,</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-                                        g_classInfo.wcapCalendar.classDescription,</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-                                        g_classInfo.wcapCalendar.contractID,</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-                                        fileSpec, location, type);</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-    },</span>
<a href="#l25.141"></a><span id="l25.141"> </span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-    unregisterSelf: function calWcapCalendarModule_unregisterSelf(compMgr, fileSpec, location) {</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-        compMgr = compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineminus">-        compMgr.unregisterFactoryLocation(g_classInfo.wcapCalendar.classID, fileSpec);</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineminus">-    },</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineminus">-    m_scriptsLoaded: false,</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-    getClassObject: function calWcapCalendarModule_getClassObject(compMgr, cid, iid) {</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineminus">-        if (!this.m_scriptsLoaded) {</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineminus">-            Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-            Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-            Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineminus">-            cal.loadScripts([&quot;calUtils.js&quot;,</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineminus">-                             &quot;calWcapUtils.js&quot;, &quot;calWcapErrors.js&quot;,</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-                             &quot;calWcapRequest.js&quot;, &quot;calWcapSession.js&quot;,</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-                             &quot;calWcapCalendar.js&quot;, &quot;calWcapCalendarItems.js&quot;],</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-                            Components.utils.getGlobalForObject(this));</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineminus">-            initWcapProvider();</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineminus">-            this.m_scriptsLoaded = true;</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-        }</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+    let components = [</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+        calWcapCalendar,</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+        calWcapNetworkRequest,</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+        calWcapSession</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+    ];</span>
<a href="#l25.166"></a><span id="l25.166"> </span>
<a href="#l25.167"></a><span id="l25.167" class="difflineminus">-        if (!iid.equals(Components.interfaces.nsIFactory)) {</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-        }</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineminus">-        if (!cid.equals(g_classInfo.wcapCalendar.classID)) {</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineminus">-            throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineminus">-        }</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-        return calWcapCalendarFactory;</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-    },</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineplus">+    return (XPCOMUtils.generateNSGetModule(components))(cid);</span>
<a href="#l25.176"></a><span id="l25.176"> </span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-    canUnload: function calWcapCalendarModule_canUnload(compMgr) {</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-        return true;</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineplus">+    } catch (e) {</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineplus">+        cal.WARN(&quot;ERROR: &quot; + e);</span>
<a href="#l25.181"></a><span id="l25.181">     }</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineminus">-};</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-/** module export */</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-    return calWcapCalendarModule;</span>
<a href="#l25.187"></a><span id="l25.187"> }</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -225,18 +225,37 @@ function calWcapNetworkRequest(url, resp</span>
<a href="#l26.4"></a><span id="l26.4"> }</span>
<a href="#l26.5"></a><span id="l26.5"> calWcapNetworkRequest.prototype = {</span>
<a href="#l26.6"></a><span id="l26.6">     m_id: 0,</span>
<a href="#l26.7"></a><span id="l26.7">     m_url: null,</span>
<a href="#l26.8"></a><span id="l26.8">     m_loader: null,</span>
<a href="#l26.9"></a><span id="l26.9">     m_respFunc: null,</span>
<a href="#l26.10"></a><span id="l26.10">     m_bLogging: false,</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+    getInterfaces: function ci_wcapNetworkRequest_getInterfaces(count) {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+        const ifaces = [Components.interfaces.nsIUnicharStreamLoaderObserver,</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+                        Components.interfaces.nsIInterfaceRequestor,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+                        Components.interfaces.nsIChannelEventSink,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+                        Components.interfaces.calIOperation,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+                        nsISupports];</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+        return ifaces;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+    },</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+    classDescription: &quot;Sun Java System Calendar Server WCAP Network Request&quot;,</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/wcap/network-request;1&quot;,</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+    classID: Components.ID(&quot;{e3c62b37-83cf-41ec-9872-0af9f952430a}&quot;),</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+    getHelperForLanguage: function ci_wcapNetworkRequest_getHelperForLanguage(language) {</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+        return null;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+    },</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+    flags: 0,</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+</span>
<a href="#l26.31"></a><span id="l26.31">     QueryInterface: function calWcapNetworkRequest_QueryInterface(iid) {</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-        return doQueryInterface(this, calWcapNetworkRequest.prototype, iid, null, g_classInfo.wcapNetworkRequest);</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+        return cal.doQueryInterface(this, calWcapNetworkRequest.prototype, iid, null, this);</span>
<a href="#l26.34"></a><span id="l26.34">     },</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">     /**</span>
<a href="#l26.37"></a><span id="l26.37">      * @see nsIInterfaceRequestor</span>
<a href="#l26.38"></a><span id="l26.38">      * @see calProviderUtils.jsm</span>
<a href="#l26.39"></a><span id="l26.39">      */</span>
<a href="#l26.40"></a><span id="l26.40">     getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l26.41"></a><span id="l26.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -131,19 +131,39 @@ function calWcapSession(contextId) {</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5">     // listen for shutdown, being logged out:</span>
<a href="#l27.6"></a><span id="l27.6">     var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l27.7"></a><span id="l27.7">                                     .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l27.8"></a><span id="l27.8">     observerService.addObserver(this, &quot;quit-application&quot;, false /* don't hold weakly */);</span>
<a href="#l27.9"></a><span id="l27.9">     getCalendarManager().addObserver(this);</span>
<a href="#l27.10"></a><span id="l27.10"> }</span>
<a href="#l27.11"></a><span id="l27.11"> calWcapSession.prototype = {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+    getInterfaces: function ci_wcapSession_getInterfaces(count) {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+        const ifaces = [calIWcapSession,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+                        calIFreeBusyProvider,</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+                        calICalendarSearchProvider,</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+                        Components.interfaces.calITimezoneProvider,</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+                        Components.interfaces.calICalendarManagerObserver,</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+                        Components.interfaces.nsIClassInfo,</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+                        nsISupports];</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+        count.value = ifaces.length;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+        return ifaces;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+    },</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+    classDescription: &quot;Sun Java System Calendar Server WCAP Session&quot;,</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+    contractID: &quot;@mozilla.org/calendar/wcap/session;1&quot;,</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+    classID: Components.ID(&quot;{cbf803fd-4469-4999-ae39-367af1c7b077}&quot;),</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+    getHelperForLanguage: function ci_wcapSession_getHelperForLanguage(language) {</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+        return null;</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+    },</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+    flags: 0,</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+</span>
<a href="#l27.32"></a><span id="l27.32">     // nsISupports:</span>
<a href="#l27.33"></a><span id="l27.33">     QueryInterface: function calWcapSession_QueryInterface(iid) {</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-        return doQueryInterface(this, calWcapSession.prototype, iid, null, g_classInfo.wcapSession);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+        return cal.doQueryInterface(this, calWcapSession.prototype, iid, null, this);</span>
<a href="#l27.36"></a><span id="l27.36">     },</span>
<a href="#l27.37"></a><span id="l27.37"> </span>
<a href="#l27.38"></a><span id="l27.38">     toString: function calWcapSession_toString(msg) {</span>
<a href="#l27.39"></a><span id="l27.39">         let str = (&quot;context-id: &quot; + this.m_contextId + &quot;, uri: &quot; + (this.uri ? this.uri.spec : &quot;unknown&quot;));</span>
<a href="#l27.40"></a><span id="l27.40">         if (this.credentials.userId) {</span>
<a href="#l27.41"></a><span id="l27.41">             str += (&quot;, userId=&quot; + this.credentials.userId);</span>
<a href="#l27.42"></a><span id="l27.42">         }</span>
<a href="#l27.43"></a><span id="l27.43">         if (!this.m_sessionId) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

