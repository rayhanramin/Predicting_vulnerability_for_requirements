<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29979:5fed4272e44c69454a327cd3e206cb66288096fb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5fed4272e44c69454a327cd3e206cb66288096fb" />
<meta property="og:url" content="/comm-central/rev/5fed4272e44c69454a327cd3e206cb66288096fb" />
<meta property="og:description" content="Bug 1642795 - Ability to mark key pairs as &quot;accepted personal keys&quot; or not. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5fed4272e44c69454a327cd3e206cb66288096fb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5fed4272e44c69454a327cd3e206cb66288096fb">shortlog</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5fed4272e44c69454a327cd3e206cb66288096fb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb">files</a> |
changeset |
<a href="/comm-central/raw-rev/5fed4272e44c69454a327cd3e206cb66288096fb">raw</a>  | <a href="/comm-central/archive/5fed4272e44c69454a327cd3e206cb66288096fb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1642795">Bug 1642795</a> - Ability to mark key pairs as &quot;accepted personal keys&quot; or not. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 25 Jun 2020 23:51:10 +0200</td></tr>

<tr>
 <td>changeset 29979</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5fed4272e44c69454a327cd3e206cb66288096fb">5fed4272e44c69454a327cd3e206cb66288096fb</a></td>
</tr>



<tr>
<td>parent 29978</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8ea96899579f2d7825b1e59de31c7a967a85b6f7">8ea96899579f2d7825b1e59de31c7a967a85b6f7</a>
</td>
</tr>

<tr>
<td>child 29980</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b4dabc35781b6464fe6ed70ca7cbe339d8116ac9">b4dabc35781b6464fe6ed70ca7cbe339d8116ac9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5fed4272e44c69454a327cd3e206cb66288096fb">17625</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Thu, 25 Jun 2020 21:53:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5fed4272e44c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5fed4272e44c69454a327cd3e206cb66288096fb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5fed4272e44c69454a327cd3e206cb66288096fb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5fed4272e44c69454a327cd3e206cb66288096fb&newProject=comm-central&newRevision=5fed4272e44c69454a327cd3e206cb66288096fb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5fed4272e44c69454a327cd3e206cb66288096fb&newProject=comm-central&newRevision=5fed4272e44c69454a327cd3e206cb66288096fb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5fed4272e44c69454a327cd3e206cb66288096fb&newProject=comm-central&newRevision=5fed4272e44c69454a327cd3e206cb66288096fb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1642795">1642795</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1642795">Bug 1642795</a> - Ability to mark key pairs as &quot;accepted personal keys&quot; or not. r=PatrickBrunschwig</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/am-e2e/am-e2e.js">mail/extensions/am-e2e/am-e2e.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/am-e2e/am-e2e.js">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/am-e2e/am-e2e.js">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/am-e2e/am-e2e.js">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/am-e2e/am-e2e.js">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/am-e2e/am-e2e.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/RNP.jsm">mail/extensions/openpgp/content/modules/RNP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/RNP.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/RNP.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/RNP.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/RNP.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/RNP.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autoSetup.jsm">mail/extensions/openpgp/content/modules/autoSetup.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autoSetup.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autoSetup.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autoSetup.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autoSetup.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autoSetup.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autocrypt.jsm">mail/extensions/openpgp/content/modules/autocrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autocrypt.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autocrypt.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autocrypt.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autocrypt.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/autocrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/encryption.jsm">mail/extensions/openpgp/content/modules/encryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/encryption.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/encryption.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/encryption.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/encryption.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/encryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyObj.jsm">mail/extensions/openpgp/content/modules/keyObj.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyObj.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyObj.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyObj.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyObj.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyObj.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/sqliteDb.jsm">mail/extensions/openpgp/content/modules/sqliteDb.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/sqliteDb.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/sqliteDb.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/sqliteDb.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/sqliteDb.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/sqliteDb.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/windows.jsm">mail/extensions/openpgp/content/modules/windows.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/windows.jsm">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/windows.jsm">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/windows.jsm">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/windows.jsm">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/modules/windows.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/enigmail.ftl">mail/extensions/openpgp/content/strings/enigmail.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/enigmail.ftl">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/enigmail.ftl">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/enigmail.ftl">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/enigmail.ftl">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/enigmail.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl">mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/composeKeyStatus.js">mail/extensions/openpgp/content/ui/composeKeyStatus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/composeKeyStatus.js">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/composeKeyStatus.js">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/composeKeyStatus.js">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/composeKeyStatus.js">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/composeKeyStatus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">mail/extensions/openpgp/content/ui/keyDetailsDlg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">mail/extensions/openpgp/content/ui/oneRecipientStatus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">file</a> |
<a href="/comm-central/annotate/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">annotate</a> |
<a href="/comm-central/diff/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">diff</a> |
<a href="/comm-central/comparison/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">comparison</a> |
<a href="/comm-central/log/5fed4272e44c69454a327cd3e206cb66288096fb/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/am-e2e/am-e2e.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/am-e2e/am-e2e.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -215,17 +215,17 @@ function e2eInitializeFields() {</span>
<a href="#l1.4"></a><span id="l1.4">  * Initialize the OpenPGP settings, apply strings, and load the key radio UI.</span>
<a href="#l1.5"></a><span id="l1.5">  */</span>
<a href="#l1.6"></a><span id="l1.6"> async function initOpenPgpSettings() {</span>
<a href="#l1.7"></a><span id="l1.7">   if (!MailConstants.MOZ_OPENPGP || !BondOpenPGP.allDependenciesLoaded()) {</span>
<a href="#l1.8"></a><span id="l1.8">     return;</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">   let result = {};</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  EnigmailKeyRing.getAllSecretKeysByEmail(gIdentity.email, result);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  await EnigmailKeyRing.getAllSecretKeysByEmail(gIdentity.email, result, true);</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15">   document.l10n.setAttributes(</span>
<a href="#l1.16"></a><span id="l1.16">     document.getElementById(&quot;openPgpgDescription&quot;),</span>
<a href="#l1.17"></a><span id="l1.17">     &quot;openpgp-description&quot;,</span>
<a href="#l1.18"></a><span id="l1.18">     {</span>
<a href="#l1.19"></a><span id="l1.19">       count: result.all.length,</span>
<a href="#l1.20"></a><span id="l1.20">       identity: gIdentity.email,</span>
<a href="#l1.21"></a><span id="l1.21">     }</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -597,17 +597,17 @@ function closeNotification() {</span>
<a href="#l1.23"></a><span id="l1.23">   document.getElementById(&quot;openPgpNotification&quot;).collapsed = true;</span>
<a href="#l1.24"></a><span id="l1.24"> }</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> /**</span>
<a href="#l1.27"></a><span id="l1.27">  * Refresh the UI on init or after a successful OpenPGP Key generation.</span>
<a href="#l1.28"></a><span id="l1.28">  */</span>
<a href="#l1.29"></a><span id="l1.29"> async function reloadOpenPgpUI() {</span>
<a href="#l1.30"></a><span id="l1.30">   let result = {};</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  EnigmailKeyRing.getAllSecretKeysByEmail(gIdentity.email, result);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  await EnigmailKeyRing.getAllSecretKeysByEmail(gIdentity.email, result, true);</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   // Show the radiogroup only if the current identity has keys.</span>
<a href="#l1.35"></a><span id="l1.35">   document.getElementById(&quot;openPgpKeyList&quot;).collapsed = !result.all.length;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   // Interrupt and udpate the UI accordingly if no Key is associated with the</span>
<a href="#l1.38"></a><span id="l1.38">   // current identity.</span>
<a href="#l1.39"></a><span id="l1.39">   if (!result.all.length) {</span>
<a href="#l1.40"></a><span id="l1.40">     // Hide the selection status.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -752,17 +752,17 @@ async function reloadOpenPgpUI() {</span>
<a href="#l1.42"></a><span id="l1.42">     let typeValueContainer = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l1.43"></a><span id="l1.43">     typeValueContainer.classList.add(&quot;input-container&quot;);</span>
<a href="#l1.44"></a><span id="l1.44">     typeValueContainer.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46">     let typeValue = document.createElement(&quot;input&quot;);</span>
<a href="#l1.47"></a><span id="l1.47">     typeValue.setAttribute(&quot;type&quot;, &quot;text&quot;);</span>
<a href="#l1.48"></a><span id="l1.48">     typeValue.classList.add(&quot;plain&quot;);</span>
<a href="#l1.49"></a><span id="l1.49">     typeValue.setAttribute(&quot;readonly&quot;, &quot;readonly&quot;);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    typeValue.value = await document.l10n.formatValue(&quot;key-type-pair-2&quot;);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    typeValue.value = await document.l10n.formatValue(&quot;key-type-pair&quot;);</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">     typeValueContainer.appendChild(typeValue);</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">     grid.appendChild(typeImage);</span>
<a href="#l1.56"></a><span id="l1.56">     grid.appendChild(typeLabel);</span>
<a href="#l1.57"></a><span id="l1.57">     grid.appendChild(typeValueContainer);</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">     // Key fingerprint.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/RNP.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/RNP.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -68,51 +68,36 @@ var RNP = {</span>
<a href="#l2.4"></a><span id="l2.4">     return RNP.libLoaded;</span>
<a href="#l2.5"></a><span id="l2.5">   },</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   allDependenciesLoaded() {</span>
<a href="#l2.8"></a><span id="l2.8">     return RNP.libLoaded;</span>
<a href="#l2.9"></a><span id="l2.9">   },</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   addKeyAttributes(handle, meta, keyObj, is_subkey, forListing) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let have_secret = new ctypes.bool();</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    let key_id = new ctypes.char.ptr();</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    let fingerprint = new ctypes.char.ptr();</span>
<a href="#l2.15"></a><span id="l2.15">     let algo = new ctypes.char.ptr();</span>
<a href="#l2.16"></a><span id="l2.16">     let bits = new ctypes.uint32_t();</span>
<a href="#l2.17"></a><span id="l2.17">     let key_creation = new ctypes.uint32_t();</span>
<a href="#l2.18"></a><span id="l2.18">     let key_expiration = new ctypes.uint32_t();</span>
<a href="#l2.19"></a><span id="l2.19">     let allowed = new ctypes.bool();</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-    if (RNPLib.rnp_key_have_secret(handle, have_secret.address())) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-      throw new Error(&quot;rnp_key_have_secret failed&quot;);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    }</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    keyObj.secretAvailable = have_secret.value;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    keyObj.secretAvailable = this.getSecretAvailableFromHandle(handle);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">     if (is_subkey) {</span>
<a href="#l2.29"></a><span id="l2.29">       keyObj.type = &quot;sub&quot;;</span>
<a href="#l2.30"></a><span id="l2.30">     } else {</span>
<a href="#l2.31"></a><span id="l2.31">       keyObj.type = &quot;pub&quot;;</span>
<a href="#l2.32"></a><span id="l2.32">     }</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    if (RNPLib.rnp_key_get_keyid(handle, key_id.address())) {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-      throw new Error(&quot;rnp_key_get_keyid failed&quot;);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    }</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    keyObj.keyId = key_id.readString();</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    keyObj.keyId = this.getKeyIDFromHandle(handle);</span>
<a href="#l2.39"></a><span id="l2.39">     if (forListing) {</span>
<a href="#l2.40"></a><span id="l2.40">       keyObj.id = keyObj.keyId;</span>
<a href="#l2.41"></a><span id="l2.41">     }</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    RNPLib.rnp_buffer_destroy(key_id);</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    if (RNPLib.rnp_key_get_fprint(handle, fingerprint.address())) {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-      throw new Error(&quot;rnp_key_get_fprint failed&quot;);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    }</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    keyObj.fpr = fingerprint.readString();</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    RNPLib.rnp_buffer_destroy(fingerprint);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    keyObj.fpr = this.getFingerprintFromHandle(handle);</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">     if (RNPLib.rnp_key_get_alg(handle, algo.address())) {</span>
<a href="#l2.52"></a><span id="l2.52">       throw new Error(&quot;rnp_key_get_alg failed&quot;);</span>
<a href="#l2.53"></a><span id="l2.53">     }</span>
<a href="#l2.54"></a><span id="l2.54">     keyObj.algoSym = algo.readString();</span>
<a href="#l2.55"></a><span id="l2.55">     RNPLib.rnp_buffer_destroy(algo);</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57">     if (RNPLib.rnp_key_get_bits(handle, bits.address())) {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineat">@@ -165,40 +150,51 @@ var RNP = {</span>
<a href="#l2.59"></a><span id="l2.59">     }</span>
<a href="#l2.60"></a><span id="l2.60">     if (allowed.value) {</span>
<a href="#l2.61"></a><span id="l2.61">       keyObj.keyUseFor += &quot;a&quot;;</span>
<a href="#l2.62"></a><span id="l2.62">       meta.a = true;</span>
<a href="#l2.63"></a><span id="l2.63">     }</span>
<a href="#l2.64"></a><span id="l2.64">   },</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66">   async getKeys(onlyKeys = null) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    return this.getKeysFromFFI(RNPLib.ffi, false, onlyKeys);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    return this.getKeysFromFFI(RNPLib.ffi, false, onlyKeys, false);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  },</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  async getSecretKeys(onlyKeys = null) {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    return this.getKeysFromFFI(RNPLib.ffi, false, onlyKeys, true);</span>
<a href="#l2.73"></a><span id="l2.73">   },</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">   /* Some consumers want a different listing of keys, and expect</span>
<a href="#l2.76"></a><span id="l2.76">    * slightly different attribute names...</span>
<a href="#l2.77"></a><span id="l2.77">    * If forListing is true, we'll set those additional attributes</span>
<a href="#l2.78"></a><span id="l2.78">    * If onlyKeys is given: only returns keys in that array</span>
<a href="#l2.79"></a><span id="l2.79">    */</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  async getKeysFromFFI(ffi, forListing, onlyKeys = null) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  async getKeysFromFFI(ffi, forListing, onlyKeys = null, onlySecret = false) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    if (!!onlyKeys &amp;&amp; onlySecret) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+      throw new Error(</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+        &quot;filtering by both white list and only secret keys isn't supported&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      );</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    }</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88">     let keys = [];</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90">     if (onlyKeys) {</span>
<a href="#l2.91"></a><span id="l2.91">       for (let ki = 0; ki &lt; onlyKeys.length; ki++) {</span>
<a href="#l2.92"></a><span id="l2.92">         let handle = await this.getKeyHandleByIdentifier(ffi, onlyKeys[ki]);</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">         let keyObj = {};</span>
<a href="#l2.95"></a><span id="l2.95">         try {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-          // Parameter false: skip if this is a primary key, it will be processed together with primary key later.</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+          // Skip if it is a primary key, it will be processed together with primary key later.</span>
<a href="#l2.98"></a><span id="l2.98">           let ok = this.getKeyInfoFromHandle(</span>
<a href="#l2.99"></a><span id="l2.99">             ffi,</span>
<a href="#l2.100"></a><span id="l2.100">             handle,</span>
<a href="#l2.101"></a><span id="l2.101">             keyObj,</span>
<a href="#l2.102"></a><span id="l2.102">             false,</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-            forListing</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+            forListing,</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+            false</span>
<a href="#l2.106"></a><span id="l2.106">           );</span>
<a href="#l2.107"></a><span id="l2.107">           if (!ok) {</span>
<a href="#l2.108"></a><span id="l2.108">             continue;</span>
<a href="#l2.109"></a><span id="l2.109">           }</span>
<a href="#l2.110"></a><span id="l2.110">         } catch (ex) {</span>
<a href="#l2.111"></a><span id="l2.111">           console.log(ex);</span>
<a href="#l2.112"></a><span id="l2.112">         } finally {</span>
<a href="#l2.113"></a><span id="l2.113">           RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineat">@@ -229,23 +225,24 @@ var RNP = {</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">         if (RNPLib.rnp_locate_key(ffi, &quot;grip&quot;, grip, handle.address())) {</span>
<a href="#l2.117"></a><span id="l2.117">           throw new Error(&quot;rnp_locate_key failed&quot;);</span>
<a href="#l2.118"></a><span id="l2.118">         }</span>
<a href="#l2.119"></a><span id="l2.119">         have_handle = true;</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121">         let keyObj = {};</span>
<a href="#l2.122"></a><span id="l2.122">         try {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-          // Parameter false: skip if this is a primary key, it will be processed together with primary key later.</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+          // Skip if it is a primary key, it will be processed together with primary key later.</span>
<a href="#l2.125"></a><span id="l2.125">           let ok = this.getKeyInfoFromHandle(</span>
<a href="#l2.126"></a><span id="l2.126">             ffi,</span>
<a href="#l2.127"></a><span id="l2.127">             handle,</span>
<a href="#l2.128"></a><span id="l2.128">             keyObj,</span>
<a href="#l2.129"></a><span id="l2.129">             false,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-            forListing</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+            forListing,</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+            onlySecret</span>
<a href="#l2.133"></a><span id="l2.133">           );</span>
<a href="#l2.134"></a><span id="l2.134">           if (!ok) {</span>
<a href="#l2.135"></a><span id="l2.135">             continue;</span>
<a href="#l2.136"></a><span id="l2.136">           }</span>
<a href="#l2.137"></a><span id="l2.137">         } catch (ex) {</span>
<a href="#l2.138"></a><span id="l2.138">           console.log(ex);</span>
<a href="#l2.139"></a><span id="l2.139">         } finally {</span>
<a href="#l2.140"></a><span id="l2.140">           if (have_handle) {</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineat">@@ -259,18 +256,53 @@ var RNP = {</span>
<a href="#l2.142"></a><span id="l2.142">       }</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144">       RNPLib.rnp_identifier_iterator_destroy(iter);</span>
<a href="#l2.145"></a><span id="l2.145">     }</span>
<a href="#l2.146"></a><span id="l2.146"> </span>
<a href="#l2.147"></a><span id="l2.147">     return keys;</span>
<a href="#l2.148"></a><span id="l2.148">   },</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  getFingerprintFromHandle(handle) {</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    let fingerprint = new ctypes.char.ptr();</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    if (RNPLib.rnp_key_get_fprint(handle, fingerprint.address())) {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+      throw new Error(&quot;rnp_key_get_fprint failed&quot;);</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+    }</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    let result = fingerprint.readString();</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+    RNPLib.rnp_buffer_destroy(fingerprint);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+    return result;</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+  },</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  getKeyIDFromHandle(handle) {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+    let ctypes_key_id = new ctypes.char.ptr();</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    if (RNPLib.rnp_key_get_keyid(handle, ctypes_key_id.address())) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+      throw new Error(&quot;rnp_key_get_keyid failed&quot;);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    }</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+    let result = ctypes_key_id.readString();</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    RNPLib.rnp_buffer_destroy(ctypes_key_id);</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+    return result;</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+  },</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  getSecretAvailableFromHandle(handle) {</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+    let have_secret = new ctypes.bool();</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+    if (RNPLib.rnp_key_have_secret(handle, have_secret.address())) {</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+      throw new Error(&quot;rnp_key_have_secret failed&quot;);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+    }</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    return have_secret.value;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  },</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+</span>
<a href="#l2.178"></a><span id="l2.178">   // return false if handle refers to subkey and should be ignored</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-  getKeyInfoFromHandle(ffi, handle, keyObj, usePrimaryIfSubkey, forListing) {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  getKeyInfoFromHandle(</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+    ffi,</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    handle,</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+    keyObj,</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    usePrimaryIfSubkey,</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+    forListing,</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+    onlyIfSecret</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+  ) {</span>
<a href="#l2.188"></a><span id="l2.188">     keyObj.ownerTrust = null;</span>
<a href="#l2.189"></a><span id="l2.189">     keyObj.userId = null;</span>
<a href="#l2.190"></a><span id="l2.190">     keyObj.userIds = [];</span>
<a href="#l2.191"></a><span id="l2.191">     keyObj.subKeys = [];</span>
<a href="#l2.192"></a><span id="l2.192">     keyObj.photoAvailable = false;</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194">     let is_subkey = new ctypes.bool();</span>
<a href="#l2.195"></a><span id="l2.195">     let sub_count = new ctypes.size_t();</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineat">@@ -299,25 +331,36 @@ var RNP = {</span>
<a href="#l2.197"></a><span id="l2.197">             throw new Error(&quot;rnp_locate_key failed&quot;);</span>
<a href="#l2.198"></a><span id="l2.198">           }</span>
<a href="#l2.199"></a><span id="l2.199">           // recursively call ourselves to get primary key info</span>
<a href="#l2.200"></a><span id="l2.200">           rv = this.getKeyInfoFromHandle(</span>
<a href="#l2.201"></a><span id="l2.201">             ffi,</span>
<a href="#l2.202"></a><span id="l2.202">             newHandle,</span>
<a href="#l2.203"></a><span id="l2.203">             keyObj,</span>
<a href="#l2.204"></a><span id="l2.204">             false,</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-            forListing</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+            forListing,</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+            onlyIfSecret</span>
<a href="#l2.208"></a><span id="l2.208">           );</span>
<a href="#l2.209"></a><span id="l2.209">           RNPLib.rnp_key_handle_destroy(newHandle);</span>
<a href="#l2.210"></a><span id="l2.210">         }</span>
<a href="#l2.211"></a><span id="l2.211">         RNPLib.rnp_buffer_destroy(primary_grip);</span>
<a href="#l2.212"></a><span id="l2.212">         return rv;</span>
<a href="#l2.213"></a><span id="l2.213">       }</span>
<a href="#l2.214"></a><span id="l2.214">     }</span>
<a href="#l2.215"></a><span id="l2.215"> </span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    if (onlyIfSecret) {</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+      let have_secret = new ctypes.bool();</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+      if (RNPLib.rnp_key_have_secret(handle, have_secret.address())) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+        throw new Error(&quot;rnp_key_have_secret failed&quot;);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+      }</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+      if (!have_secret.value) {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+        return false;</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+      }</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+    }</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+</span>
<a href="#l2.226"></a><span id="l2.226">     let meta = {</span>
<a href="#l2.227"></a><span id="l2.227">       a: false,</span>
<a href="#l2.228"></a><span id="l2.228">       s: false,</span>
<a href="#l2.229"></a><span id="l2.229">       c: false,</span>
<a href="#l2.230"></a><span id="l2.230">       e: false,</span>
<a href="#l2.231"></a><span id="l2.231">     };</span>
<a href="#l2.232"></a><span id="l2.232">     this.addKeyAttributes(handle, meta, keyObj, false, forListing);</span>
<a href="#l2.233"></a><span id="l2.233"> </span>
<a href="#l2.234"></a><span id="l2.234" class="difflineat">@@ -436,17 +479,24 @@ var RNP = {</span>
<a href="#l2.235"></a><span id="l2.235">   },</span>
<a href="#l2.236"></a><span id="l2.236"> </span>
<a href="#l2.237"></a><span id="l2.237">   getKeySignatures(keyId, ignoreUnknownUid) {</span>
<a href="#l2.238"></a><span id="l2.238">     let handle = this.getKeyHandleByKeyIdOrFingerprint(</span>
<a href="#l2.239"></a><span id="l2.239">       RNPLib.ffi,</span>
<a href="#l2.240"></a><span id="l2.240">       &quot;0x&quot; + keyId</span>
<a href="#l2.241"></a><span id="l2.241">     );</span>
<a href="#l2.242"></a><span id="l2.242">     let mainKeyObj = {};</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-    this.getKeyInfoFromHandle(RNPLib.ffi, handle, mainKeyObj, false, true);</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+    this.getKeyInfoFromHandle(</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+      RNPLib.ffi,</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+      handle,</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+      mainKeyObj,</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+      false,</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+      true,</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+      false</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+    );</span>
<a href="#l2.252"></a><span id="l2.252"> </span>
<a href="#l2.253"></a><span id="l2.253">     let rList = {};</span>
<a href="#l2.254"></a><span id="l2.254"> </span>
<a href="#l2.255"></a><span id="l2.255">     try {</span>
<a href="#l2.256"></a><span id="l2.256">       let uid_count = new ctypes.size_t();</span>
<a href="#l2.257"></a><span id="l2.257">       if (RNPLib.rnp_key_get_uid_count(handle, uid_count.address())) {</span>
<a href="#l2.258"></a><span id="l2.258">         throw new Error(&quot;rnp_key_get_uid_count failed&quot;);</span>
<a href="#l2.259"></a><span id="l2.259">       }</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineat">@@ -811,17 +861,17 @@ var RNP = {</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262">     if (query_signer) {</span>
<a href="#l2.263"></a><span id="l2.263">       let key = new RNPLib.rnp_key_handle_t();</span>
<a href="#l2.264"></a><span id="l2.264">       if (RNPLib.rnp_op_verify_signature_get_key(sig, key.address())) {</span>
<a href="#l2.265"></a><span id="l2.265">         throw new Error(&quot;rnp_op_verify_signature_get_key&quot;);</span>
<a href="#l2.266"></a><span id="l2.266">       }</span>
<a href="#l2.267"></a><span id="l2.267"> </span>
<a href="#l2.268"></a><span id="l2.268">       let keyInfo = {};</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-      let ok = this.getKeyInfoFromHandle(ffi, key, keyInfo, true, false);</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+      let ok = this.getKeyInfoFromHandle(ffi, key, keyInfo, true, false, false);</span>
<a href="#l2.271"></a><span id="l2.271">       if (!ok) {</span>
<a href="#l2.272"></a><span id="l2.272">         throw new Error(&quot;getKeyInfoFromHandle failed&quot;);</span>
<a href="#l2.273"></a><span id="l2.273">       }</span>
<a href="#l2.274"></a><span id="l2.274"> </span>
<a href="#l2.275"></a><span id="l2.275">       let fromMatchesAnyUid = false;</span>
<a href="#l2.276"></a><span id="l2.276">       let fromLower = fromAddr ? fromAddr.toLowerCase() : &quot;&quot;;</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278">       for (let uid of keyInfo.userIds) {</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineat">@@ -836,17 +886,20 @@ var RNP = {</span>
<a href="#l2.280"></a><span id="l2.280">             break;</span>
<a href="#l2.281"></a><span id="l2.281">           }</span>
<a href="#l2.282"></a><span id="l2.282">         }</span>
<a href="#l2.283"></a><span id="l2.283">       }</span>
<a href="#l2.284"></a><span id="l2.284"> </span>
<a href="#l2.285"></a><span id="l2.285">       let useUndecided = true;</span>
<a href="#l2.286"></a><span id="l2.286"> </span>
<a href="#l2.287"></a><span id="l2.287">       if (keyInfo.secretAvailable) {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-        if (fromMatchesAnyUid) {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+        let isPersonal = await PgpSqliteDb2.isAcceptedAsPersonalKey(</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+          keyInfo.fpr</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+        );</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+        if (isPersonal &amp;&amp; fromMatchesAnyUid) {</span>
<a href="#l2.293"></a><span id="l2.293">           result.extStatusFlags |= EnigmailConstants.EXT_SELF_IDENTITY;</span>
<a href="#l2.294"></a><span id="l2.294">           useUndecided = false;</span>
<a href="#l2.295"></a><span id="l2.295">         } else {</span>
<a href="#l2.296"></a><span id="l2.296">           result.statusFlags |= EnigmailConstants.INVALID_RECIPIENT;</span>
<a href="#l2.297"></a><span id="l2.297">           useUndecided = true;</span>
<a href="#l2.298"></a><span id="l2.298">         }</span>
<a href="#l2.299"></a><span id="l2.299">       } else if (result.statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE) {</span>
<a href="#l2.300"></a><span id="l2.300">         if (!fromMatchesAnyUid) {</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineat">@@ -968,18 +1021,19 @@ var RNP = {</span>
<a href="#l2.302"></a><span id="l2.302"> </span>
<a href="#l2.303"></a><span id="l2.303">     RNPLib.rnp_input_destroy(input_from_memory);</span>
<a href="#l2.304"></a><span id="l2.304">     RNPLib.rnp_input_destroy(input_from_file);</span>
<a href="#l2.305"></a><span id="l2.305">     RNPLib.rnp_op_verify_destroy(verify_op);</span>
<a href="#l2.306"></a><span id="l2.306"> </span>
<a href="#l2.307"></a><span id="l2.307">     return result;</span>
<a href="#l2.308"></a><span id="l2.308">   },</span>
<a href="#l2.309"></a><span id="l2.309"> </span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-  genKey(userId, keyType, keyBits, expiryDays, passphrase) {</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+  async genKey(userId, keyType, keyBits, expiryDays, passphrase) {</span>
<a href="#l2.312"></a><span id="l2.312">     let newKeyId = &quot;&quot;;</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+    let newKeyFingerprint = &quot;&quot;;</span>
<a href="#l2.314"></a><span id="l2.314"> </span>
<a href="#l2.315"></a><span id="l2.315">     let primaryKeyType;</span>
<a href="#l2.316"></a><span id="l2.316">     let primaryKeyBits = 0;</span>
<a href="#l2.317"></a><span id="l2.317">     let subKeyType;</span>
<a href="#l2.318"></a><span id="l2.318">     let subKeyBits = 0;</span>
<a href="#l2.319"></a><span id="l2.319">     let primaryKeyCurve = null;</span>
<a href="#l2.320"></a><span id="l2.320">     let subKeyCurve = null;</span>
<a href="#l2.321"></a><span id="l2.321">     let expireSeconds = 0;</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineat">@@ -1040,22 +1094,18 @@ var RNP = {</span>
<a href="#l2.323"></a><span id="l2.323"> </span>
<a href="#l2.324"></a><span id="l2.324">     let primaryKey = new RNPLib.rnp_key_handle_t();</span>
<a href="#l2.325"></a><span id="l2.325">     if (RNPLib.rnp_op_generate_get_key(genOp, primaryKey.address())) {</span>
<a href="#l2.326"></a><span id="l2.326">       throw new Error(&quot;rnp_op_generate_get_key primary failed&quot;);</span>
<a href="#l2.327"></a><span id="l2.327">     }</span>
<a href="#l2.328"></a><span id="l2.328"> </span>
<a href="#l2.329"></a><span id="l2.329">     RNPLib.rnp_op_generate_destroy(genOp);</span>
<a href="#l2.330"></a><span id="l2.330"> </span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    let ctypes_key_id = new ctypes.char.ptr();</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-    if (RNPLib.rnp_key_get_keyid(primaryKey, ctypes_key_id.address())) {</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-      throw new Error(&quot;rnp_key_get_keyid failed&quot;);</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    }</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-    newKeyId = ctypes_key_id.readString();</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-    RNPLib.rnp_buffer_destroy(ctypes_key_id);</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+    newKeyFingerprint = this.getFingerprintFromHandle(primaryKey);</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+    newKeyId = this.getKeyIDFromHandle(primaryKey);</span>
<a href="#l2.339"></a><span id="l2.339"> </span>
<a href="#l2.340"></a><span id="l2.340">     if (</span>
<a href="#l2.341"></a><span id="l2.341">       RNPLib.rnp_op_generate_subkey_create(</span>
<a href="#l2.342"></a><span id="l2.342">         genOp.address(),</span>
<a href="#l2.343"></a><span id="l2.343">         RNPLib.ffi,</span>
<a href="#l2.344"></a><span id="l2.344">         primaryKey,</span>
<a href="#l2.345"></a><span id="l2.345">         subKeyType</span>
<a href="#l2.346"></a><span id="l2.346">       )</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineat">@@ -1103,16 +1153,19 @@ var RNP = {</span>
<a href="#l2.348"></a><span id="l2.348">         lockFailure = true;</span>
<a href="#l2.349"></a><span id="l2.349">       }</span>
<a href="#l2.350"></a><span id="l2.350">     }</span>
<a href="#l2.351"></a><span id="l2.351">     if (lockFailure) {</span>
<a href="#l2.352"></a><span id="l2.352">       throw new Error(&quot;rnp_key_lock failed&quot;);</span>
<a href="#l2.353"></a><span id="l2.353">     }</span>
<a href="#l2.354"></a><span id="l2.354"> </span>
<a href="#l2.355"></a><span id="l2.355">     RNPLib.rnp_op_generate_destroy(genOp);</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+    RNPLib.rnp_key_handle_destroy(primaryKey);</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+    await PgpSqliteDb2.acceptAsPersonalKey(newKeyFingerprint);</span>
<a href="#l2.359"></a><span id="l2.359"> </span>
<a href="#l2.360"></a><span id="l2.360">     return newKeyId;</span>
<a href="#l2.361"></a><span id="l2.361">   },</span>
<a href="#l2.362"></a><span id="l2.362"> </span>
<a href="#l2.363"></a><span id="l2.363">   saveKeyRings() {</span>
<a href="#l2.364"></a><span id="l2.364">     RNPLib.saveKeys();</span>
<a href="#l2.365"></a><span id="l2.365">   },</span>
<a href="#l2.366"></a><span id="l2.366"> </span>
<a href="#l2.367"></a><span id="l2.367" class="difflineat">@@ -1659,16 +1712,31 @@ var RNP = {</span>
<a href="#l2.368"></a><span id="l2.368">     }</span>
<a href="#l2.369"></a><span id="l2.369"> </span>
<a href="#l2.370"></a><span id="l2.370">     let senderKey = null;</span>
<a href="#l2.371"></a><span id="l2.371">     if (args.sign || args.encryptToSender) {</span>
<a href="#l2.372"></a><span id="l2.372">       senderKey = await this.getKeyHandleByIdentifier(RNPLib.ffi, args.sender);</span>
<a href="#l2.373"></a><span id="l2.373">       if (!senderKey || senderKey.isNull()) {</span>
<a href="#l2.374"></a><span id="l2.374">         return null;</span>
<a href="#l2.375"></a><span id="l2.375">       }</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+      let isPersonal = false;</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+      let senderKeySecretAvailable = this.getSecretAvailableFromHandle(</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+        senderKey</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+      );</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+      if (senderKeySecretAvailable) {</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+        let senderFpr = this.getFingerprintFromHandle(senderKey);</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+        isPersonal = await PgpSqliteDb2.isAcceptedAsPersonalKey(senderFpr);</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+      }</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+      if (!isPersonal) {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+        throw new Error(</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+          &quot;configured sender key &quot; +</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+            args.sender +</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+            &quot; isn't accepted as a personal key&quot;</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+        );</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+      }</span>
<a href="#l2.391"></a><span id="l2.391">       if (args.encryptToSender) {</span>
<a href="#l2.392"></a><span id="l2.392">         this.addSuitableEncryptKey(senderKey, op);</span>
<a href="#l2.393"></a><span id="l2.393">       }</span>
<a href="#l2.394"></a><span id="l2.394">       if (args.sign) {</span>
<a href="#l2.395"></a><span id="l2.395">         let use_sub = null;</span>
<a href="#l2.396"></a><span id="l2.396">         if (!this.isKeyUsableFor(senderKey, str_sign)) {</span>
<a href="#l2.397"></a><span id="l2.397">           use_sub = this.getSuitableSubkey(senderKey, str_sign);</span>
<a href="#l2.398"></a><span id="l2.398">           if (!use_sub) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/autoSetup.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/autoSetup.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -411,37 +411,16 @@ var EnigmailAutoSetup = {</span>
<a href="#l3.4"></a><span id="l3.4">       } catch (ex) {</span>
<a href="#l3.5"></a><span id="l3.5">         EnigmailLog.DEBUG(</span>
<a href="#l3.6"></a><span id="l3.6">           &quot;autoSetup.jsm: createAutocryptKey: error: &quot; + ex.message</span>
<a href="#l3.7"></a><span id="l3.7">         );</span>
<a href="#l3.8"></a><span id="l3.8">         resolve(null);</span>
<a href="#l3.9"></a><span id="l3.9">       }</span>
<a href="#l3.10"></a><span id="l3.10">     });</span>
<a href="#l3.11"></a><span id="l3.11">   },</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  /**</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-   * Configure Enigmail to use existing keys</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-   */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  applyExistingKeys() {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    for (let id of MailServices.accounts.allIdentities) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-      if (id.email) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-        let keyObj = EnigmailKeyRing.getSecretKeyByEmail(id.email);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-        if (keyObj) {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-          EnigmailLog.DEBUG(</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-            `autoSetup.jsm: applyExistingKeys: found key ${keyObj.keyId}\n`</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-          );</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-          id.setBoolAttribute(&quot;enablePgp&quot;, true);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-          id.setCharAttribute(&quot;pgpkeyId&quot;, &quot;0x&quot; + keyObj.fpr);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-          id.setIntAttribute(&quot;pgpKeyMode&quot;, 1);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-          id.setBoolAttribute(&quot;pgpMimeMode&quot;, true);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-          id.setBoolAttribute(&quot;pgpSignEncrypted&quot;, true);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        }</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-      }</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    }</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  },</span>
<a href="#l3.33"></a><span id="l3.33"> };</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> /**</span>
<a href="#l3.36"></a><span id="l3.36">  * Recusrively go through all folders to get a flat array of all sub-folders</span>
<a href="#l3.37"></a><span id="l3.37">  * starting with a parent folder.</span>
<a href="#l3.38"></a><span id="l3.38">  *</span>
<a href="#l3.39"></a><span id="l3.39">  * @param {nsIMsgFolder} folder:       the folder to scan</span>
<a href="#l3.40"></a><span id="l3.40">  * @param {nsIMsgFolder} msgFolderArr: An array to be filled with all folders that contain messages</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/autocrypt.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/autocrypt.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -25,30 +25,30 @@ const { EnigmailMime } = ChromeUtils.imp</span>
<a href="#l4.4"></a><span id="l4.4"> );</span>
<a href="#l4.5"></a><span id="l4.5"> const { EnigmailSqliteDb } = ChromeUtils.import(</span>
<a href="#l4.6"></a><span id="l4.6">   &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> );</span>
<a href="#l4.8"></a><span id="l4.8"> /*</span>
<a href="#l4.9"></a><span id="l4.9"> const { PromiseUtils } = ChromeUtils.import(</span>
<a href="#l4.10"></a><span id="l4.10">   &quot;resource://gre/modules/PromiseUtils.jsm&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> );</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-*/</span>
<a href="#l4.13"></a><span id="l4.13"> const { EnigmailKeyRing } = ChromeUtils.import(</span>
<a href="#l4.14"></a><span id="l4.14">   &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> );</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+*/</span>
<a href="#l4.17"></a><span id="l4.17"> const { EnigmailStreams } = ChromeUtils.import(</span>
<a href="#l4.18"></a><span id="l4.18">   &quot;chrome://openpgp/content/modules/streams.jsm&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> );</span>
<a href="#l4.20"></a><span id="l4.20"> const { EnigmailArmor } = ChromeUtils.import(</span>
<a href="#l4.21"></a><span id="l4.21">   &quot;chrome://openpgp/content/modules/armor.jsm&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> );</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+/*</span>
<a href="#l4.24"></a><span id="l4.24"> const { EnigmailStdlib } = ChromeUtils.import(</span>
<a href="#l4.25"></a><span id="l4.25">   &quot;chrome://openpgp/content/modules/stdlib.jsm&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> );</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-/*</span>
<a href="#l4.28"></a><span id="l4.28"> const { EnigmailCryptoAPI } = ChromeUtils.import(</span>
<a href="#l4.29"></a><span id="l4.29">   &quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;</span>
<a href="#l4.30"></a><span id="l4.30"> );</span>
<a href="#l4.31"></a><span id="l4.31"> */</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33"> var gCreatedSetupIds = [];</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> var EnigmailAutocrypt = {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineat">@@ -827,63 +827,16 @@ var EnigmailAutocrypt = {</span>
<a href="#l4.37"></a><span id="l4.37">   /**</span>
<a href="#l4.38"></a><span id="l4.38">    * Determine if a message id was self-created (only during same TB session)</span>
<a href="#l4.39"></a><span id="l4.39">    */</span>
<a href="#l4.40"></a><span id="l4.40">   isSelfCreatedSetupMessage(messageId) {</span>
<a href="#l4.41"></a><span id="l4.41">     return gCreatedSetupIds.includes(messageId);</span>
<a href="#l4.42"></a><span id="l4.42">   },</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">   /**</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-   * Check if an account is set up with OpenPGP and if the configured key is valid</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-   *</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-   * @param emailAddr: String - email address identifying the account</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-   *</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-   * @return Boolean: true: account is valid / false: OpenPGP not configured or key not valid</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-   */</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-  isAccountSetupForPgp(emailAddr) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    let id = EnigmailStdlib.getIdentityForEmail(</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-      EnigmailFuncs.stripEmail(emailAddr).toLowerCase()</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    );</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    let keyObj = null;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    if (!(id &amp;&amp; id.identity)) {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-      return false;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-    }</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    if (!id.identity.getBoolAttribute(&quot;enablePgp&quot;)) {</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-      return false;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    if (id.identity.getIntAttribute(&quot;pgpKeyMode&quot;) === 1) {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-      keyObj = EnigmailKeyRing.getKeyById(</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-        id.identity.getCharAttribute(&quot;pgpkeyId&quot;)</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-      );</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    } else {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-      keyObj = EnigmailKeyRing.getSecretKeyByUserId(emailAddr);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    }</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    if (!keyObj) {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-      return false;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    if (!keyObj.secretAvailable) {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-      return false;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    }</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-    let o = keyObj.getEncryptionValidity();</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    if (!o.keyValid) {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-      return false;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-    }</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-    o = keyObj.getSigningValidity();</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-    if (!o.keyValid) {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-      return false;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-    }</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-    return true;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-  },</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  /**</span>
<a href="#l4.92"></a><span id="l4.92">    * Delete the record for a user from the autocrypt keystore</span>
<a href="#l4.93"></a><span id="l4.93">    * The record with the highest precedence is deleted (i.e. type=1 before type=1g)</span>
<a href="#l4.94"></a><span id="l4.94">    */</span>
<a href="#l4.95"></a><span id="l4.95">   async deleteUser(email, type) {</span>
<a href="#l4.96"></a><span id="l4.96">     EnigmailLog.DEBUG(`autocrypt.jsm: deleteUser(${email})\n`);</span>
<a href="#l4.97"></a><span id="l4.97">     let conn = await EnigmailSqliteDb.openDatabase();</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99">     let updateStr =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -45,16 +45,19 @@ const { EnigmailKeyRing } = ChromeUtils.</span>
<a href="#l5.4"></a><span id="l5.4">   &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> );</span>
<a href="#l5.6"></a><span id="l5.6"> const { EnigmailConstants } = ChromeUtils.import(</span>
<a href="#l5.7"></a><span id="l5.7">   &quot;chrome://openpgp/content/modules/constants.jsm&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> );</span>
<a href="#l5.9"></a><span id="l5.9"> const { EnigmailCryptoAPI } = ChromeUtils.import(</span>
<a href="#l5.10"></a><span id="l5.10">   &quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> );</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+var { PgpSqliteDb2 } = ChromeUtils.import(</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> const gMimeHashAlgorithms = [</span>
<a href="#l5.17"></a><span id="l5.17">   null,</span>
<a href="#l5.18"></a><span id="l5.18">   &quot;sha1&quot;,</span>
<a href="#l5.19"></a><span id="l5.19">   &quot;ripemd160&quot;,</span>
<a href="#l5.20"></a><span id="l5.20">   &quot;sha256&quot;,</span>
<a href="#l5.21"></a><span id="l5.21">   &quot;sha384&quot;,</span>
<a href="#l5.22"></a><span id="l5.22">   &quot;sha512&quot;,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -334,91 +337,78 @@ var EnigmailEncryption = {</span>
<a href="#l5.24"></a><span id="l5.24">     console.debug(result);</span>
<a href="#l5.25"></a><span id="l5.25">     return result;</span>
<a href="#l5.26"></a><span id="l5.26">   },</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   /**</span>
<a href="#l5.29"></a><span id="l5.29">    * Determine if the sender key ID or user ID can be used for signing and/or encryption</span>
<a href="#l5.30"></a><span id="l5.30">    *</span>
<a href="#l5.31"></a><span id="l5.31">    * @param sendFlags:    Number  - the send Flags; need to contain SEND_SIGNED and/or SEND_ENCRYPTED</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-   * @param fromMailAddr: String  - the sender email address or key ID</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   * @param fromKeyId:    String  - the sender key ID</span>
<a href="#l5.34"></a><span id="l5.34">    *</span>
<a href="#l5.35"></a><span id="l5.35">    * @return Object:</span>
<a href="#l5.36"></a><span id="l5.36">    *         - keyId:    String - the found key ID, or null if fromMailAddr is not valid</span>
<a href="#l5.37"></a><span id="l5.37">    *         - errorMsg: String - the erorr message if key not valid, or null if key is valid</span>
<a href="#l5.38"></a><span id="l5.38">    */</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  determineOwnKeyUsability(sendFlags, fromMailAddr) {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  async determineOwnKeyUsability(sendFlags, fromKeyId) {</span>
<a href="#l5.41"></a><span id="l5.41">     EnigmailLog.DEBUG(</span>
<a href="#l5.42"></a><span id="l5.42">       &quot;encryption.jsm: determineOwnKeyUsability: sendFlags=&quot; +</span>
<a href="#l5.43"></a><span id="l5.43">         sendFlags +</span>
<a href="#l5.44"></a><span id="l5.44">         &quot;, sender=&quot; +</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-        fromMailAddr +</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+        fromKeyId +</span>
<a href="#l5.47"></a><span id="l5.47">         &quot;\n&quot;</span>
<a href="#l5.48"></a><span id="l5.48">     );</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    let keyList = [];</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    let foundKey = null;</span>
<a href="#l5.52"></a><span id="l5.52">     let ret = {</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-      keyId: null,</span>
<a href="#l5.54"></a><span id="l5.54">       errorMsg: null,</span>
<a href="#l5.55"></a><span id="l5.55">     };</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    if (!fromMailAddr) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    if (!fromKeyId) {</span>
<a href="#l5.59"></a><span id="l5.59">       return ret;</span>
<a href="#l5.60"></a><span id="l5.60">     }</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">     let sign = !!(sendFlags &amp; EnigmailConstants.SEND_SIGNED);</span>
<a href="#l5.63"></a><span id="l5.63">     let encrypt = !!(sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED);</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-    if (fromMailAddr.search(/^(0x)?[A-Z0-9]+$/) === 0) {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+    if (fromKeyId.search(/^(0x)?[A-Z0-9]+$/) === 0) {</span>
<a href="#l5.67"></a><span id="l5.67">       // key ID specified</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-      let key = EnigmailKeyRing.getKeyById(fromMailAddr);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-      keyList.push(key);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    } else {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-      // email address specified</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-      keyList = EnigmailKeyRing.getKeysByUserId(fromMailAddr);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+      foundKey = EnigmailKeyRing.getKeyById(fromKeyId);</span>
<a href="#l5.74"></a><span id="l5.74">     }</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    if (keyList.length === 0) {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-      ret.errorMsg = EnigmailLocale.getString(</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-        &quot;errorOwnKeyUnusable&quot;,</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-        fromMailAddr</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+    let isPersonalAndHasSecret = false;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    if (foundKey &amp;&amp; foundKey.secretAvailable) {</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+      isPersonalAndHasSecret = await PgpSqliteDb2.isAcceptedAsPersonalKey(</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+        foundKey.fpr</span>
<a href="#l5.84"></a><span id="l5.84">       );</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+    }</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+    if (!foundKey || !isPersonalAndHasSecret) {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+      ret.errorMsg = &quot;key &quot; + fromKeyId + &quot; isn't usable as a personal key&quot;;</span>
<a href="#l5.89"></a><span id="l5.89">       return ret;</span>
<a href="#l5.90"></a><span id="l5.90">     }</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+    let canSign = false;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    let canEncrypt = false;</span>
<a href="#l5.94"></a><span id="l5.94">     if (sign) {</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-      keyList = keyList.reduce(function(p, keyObj) {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-        if (keyObj &amp;&amp; keyObj.getSigningValidity().keyValid) {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-          p.push(keyObj);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-        }</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-        return p;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-      }, []);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      if (foundKey &amp;&amp; foundKey.getSigningValidity().keyValid) {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+        canSign = true;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+      }</span>
<a href="#l5.104"></a><span id="l5.104">     }</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106">     if (encrypt) {</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-      keyList = keyList.reduce(function(p, keyObj) {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-        if (keyObj &amp;&amp; keyObj.getEncryptionValidity().keyValid) {</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-          p.push(keyObj);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-        }</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-        return p;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-      }, []);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+      if (foundKey &amp;&amp; foundKey.getEncryptionValidity().keyValid) {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+        canEncrypt = true;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+      }</span>
<a href="#l5.116"></a><span id="l5.116">     }</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-    if (keyList.length === 0) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-      if (sign) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-        ret.errorMsg = EnigmailErrorHandling.determineInvSignReason(</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-          fromMailAddr</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-        );</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-      } else {</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-        ret.errorMsg = EnigmailErrorHandling.determineInvRcptReason(</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-          fromMailAddr</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-        );</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-      }</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-    } else {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-      ret.keyId = keyList[0].fpr;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+    if (sign &amp;&amp; !canSign) {</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+      ret.errorMsg = EnigmailErrorHandling.determineInvSignReason(fromKeyId);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    } else if (encrypt &amp;&amp; !canEncrypt) {</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+      ret.errorMsg = EnigmailErrorHandling.determineInvRcptReason(fromKeyId);</span>
<a href="#l5.134"></a><span id="l5.134">     }</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136">     return ret;</span>
<a href="#l5.137"></a><span id="l5.137">   },</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139">   encryptMessageStart(</span>
<a href="#l5.140"></a><span id="l5.140">     win,</span>
<a href="#l5.141"></a><span id="l5.141">     uiFlags,</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineat">@@ -440,30 +430,20 @@ var EnigmailEncryption = {</span>
<a href="#l5.143"></a><span id="l5.143">         toMailAddr +</span>
<a href="#l5.144"></a><span id="l5.144">         &quot;, hashAlgorithm=&quot; +</span>
<a href="#l5.145"></a><span id="l5.145">         hashAlgorithm +</span>
<a href="#l5.146"></a><span id="l5.146">         &quot; (&quot; +</span>
<a href="#l5.147"></a><span id="l5.147">         EnigmailData.bytesToHex(EnigmailData.pack(sendFlags, 4)) +</span>
<a href="#l5.148"></a><span id="l5.148">         &quot;)\n&quot;</span>
<a href="#l5.149"></a><span id="l5.149">     );</span>
<a href="#l5.150"></a><span id="l5.150"> </span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-    let keyUseability = this.determineOwnKeyUsability(sendFlags, fromMailAddr);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-    if (!keyUseability.keyId) {</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-      EnigmailLog.DEBUG(</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-        &quot;encryption.jsm: encryptMessageStart: own key invalid\n&quot;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-      );</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-      errorMsgObj.value = keyUseability.errorMsg;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-      statusFlagsObj.value =</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-        EnigmailConstants.INVALID_RECIPIENT |</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-        EnigmailConstants.NO_SECKEY |</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-        EnigmailConstants.DISPLAY_MESSAGE;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-      return null;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-    }</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+    // This code used to call determineOwnKeyUsability, and return on</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+    // failure. But now determineOwnKeyUsability is an async function,</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+    // and calling it from here with await results in a deadlock.</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+    // Instead we perform this check in Enigmail.msg.prepareSendMsg.</span>
<a href="#l5.169"></a><span id="l5.169"> </span>
<a href="#l5.170"></a><span id="l5.170">     var hashAlgo =</span>
<a href="#l5.171"></a><span id="l5.171">       gMimeHashAlgorithms[EnigmailPrefs.getPref(&quot;mimeHashAlgorithm&quot;)];</span>
<a href="#l5.172"></a><span id="l5.172"> </span>
<a href="#l5.173"></a><span id="l5.173">     if (hashAlgorithm) {</span>
<a href="#l5.174"></a><span id="l5.174">       hashAlgo = hashAlgorithm;</span>
<a href="#l5.175"></a><span id="l5.175">     }</span>
<a href="#l5.176"></a><span id="l5.176"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyObj.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyObj.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -201,52 +201,37 @@ class EnigmailKeyObj {</span>
<a href="#l6.4"></a><span id="l6.4">     let f = EnigmailKey.formatFpr(this.fpr);</span>
<a href="#l6.5"></a><span id="l6.5">     if (f.length === 0) {</span>
<a href="#l6.6"></a><span id="l6.6">       f = this.fpr;</span>
<a href="#l6.7"></a><span id="l6.7">     }</span>
<a href="#l6.8"></a><span id="l6.8">     return f;</span>
<a href="#l6.9"></a><span id="l6.9">   }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   /**</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-   * Is the function to set owner trust available for the key?</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-   * Requirements: The key is signed with at least medium validity level,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-   * or the secret key is available.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-   *</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-   * @return Boolean true if yes</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-   */</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  isOwnerTrustUseful() {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-    if (this.secretAvailable) {</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-      return true;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-    if (this.keyTrust.search(/^[fu]/) === 0) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-      return true;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-    }</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    return false;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-  }</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  /**</span>
<a href="#l6.30"></a><span id="l6.30">    * Determine if the public key is valid. If not, return a description why it's not</span>
<a href="#l6.31"></a><span id="l6.31">    *</span>
<a href="#l6.32"></a><span id="l6.32">    * @return Object:</span>
<a href="#l6.33"></a><span id="l6.33">    *   - keyValid: Boolean (true if key is valid)</span>
<a href="#l6.34"></a><span id="l6.34">    *   - reason: String (explanation of invalidity)</span>
<a href="#l6.35"></a><span id="l6.35">    */</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  getPubKeyValidity() {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  getPubKeyValidity(exceptionReason = null) {</span>
<a href="#l6.38"></a><span id="l6.38">     let retVal = {</span>
<a href="#l6.39"></a><span id="l6.39">       keyValid: false,</span>
<a href="#l6.40"></a><span id="l6.40">       reason: &quot;&quot;,</span>
<a href="#l6.41"></a><span id="l6.41">     };</span>
<a href="#l6.42"></a><span id="l6.42">     if (this.keyTrust.search(/r/i) &gt;= 0) {</span>
<a href="#l6.43"></a><span id="l6.43">       // public key revoked</span>
<a href="#l6.44"></a><span id="l6.44">       retVal.reason = l10n.formatValueSync(&quot;key-ring-pub-key-revoked&quot;, {</span>
<a href="#l6.45"></a><span id="l6.45">         userId: this.userId,</span>
<a href="#l6.46"></a><span id="l6.46">         keyId: &quot;0x&quot; + this.keyId,</span>
<a href="#l6.47"></a><span id="l6.47">       });</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    } else if (this.keyTrust.search(/e/i) &gt;= 0) {</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    } else if (</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+      exceptionReason != &quot;ignoreExpired&quot; &amp;&amp;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+      this.keyTrust.search(/e/i) &gt;= 0</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    ) {</span>
<a href="#l6.53"></a><span id="l6.53">       // public key expired</span>
<a href="#l6.54"></a><span id="l6.54">       retVal.reason = l10n.formatValueSync(&quot;key-ring-pub-key-expired&quot;, {</span>
<a href="#l6.55"></a><span id="l6.55">         userId: this.userId,</span>
<a href="#l6.56"></a><span id="l6.56">         keyId: &quot;0x&quot; + this.keyId,</span>
<a href="#l6.57"></a><span id="l6.57">       });</span>
<a href="#l6.58"></a><span id="l6.58">     } else if (</span>
<a href="#l6.59"></a><span id="l6.59">       this.keyTrust.search(/d/i) &gt;= 0 ||</span>
<a href="#l6.60"></a><span id="l6.60">       this.keyUseFor.search(/D/i) &gt;= 0</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineat">@@ -271,18 +256,18 @@ class EnigmailKeyObj {</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63">   /**</span>
<a href="#l6.64"></a><span id="l6.64">    * Check whether a key can be used for signing and return a description of why not</span>
<a href="#l6.65"></a><span id="l6.65">    *</span>
<a href="#l6.66"></a><span id="l6.66">    * @return Object:</span>
<a href="#l6.67"></a><span id="l6.67">    *   - keyValid: Boolean (true if key is valid)</span>
<a href="#l6.68"></a><span id="l6.68">    *   - reason: String (explanation of invalidity)</span>
<a href="#l6.69"></a><span id="l6.69">    */</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  getSigningValidity() {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-    let retVal = this.getPubKeyValidity();</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  getSigningValidity(exceptionReason = null) {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    let retVal = this.getPubKeyValidity(exceptionReason);</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">     if (!retVal.keyValid) {</span>
<a href="#l6.76"></a><span id="l6.76">       return retVal;</span>
<a href="#l6.77"></a><span id="l6.77">     }</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79">     if (!this.secretAvailable) {</span>
<a href="#l6.80"></a><span id="l6.80">       retVal.keyValid = false;</span>
<a href="#l6.81"></a><span id="l6.81">       retVal.reason = l10n.formatValueSync(&quot;key-ring-no-secret-key&quot;, {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineat">@@ -317,17 +302,17 @@ class EnigmailKeyObj {</span>
<a href="#l6.83"></a><span id="l6.83">             } else {</span>
<a href="#l6.84"></a><span id="l6.84">               // found subkey usable</span>
<a href="#l6.85"></a><span id="l6.85">               ++found;</span>
<a href="#l6.86"></a><span id="l6.86">             }</span>
<a href="#l6.87"></a><span id="l6.87">           }</span>
<a href="#l6.88"></a><span id="l6.88">         }</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">         if (!found) {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-          if (expired) {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+          if (exceptionReason != &quot;ignoreExpired&quot; &amp;&amp; expired) {</span>
<a href="#l6.93"></a><span id="l6.93">             retVal.reason = l10n.formatValueSync(</span>
<a href="#l6.94"></a><span id="l6.94">               &quot;key-ring-sign-sub-keys-expired&quot;,</span>
<a href="#l6.95"></a><span id="l6.95">               {</span>
<a href="#l6.96"></a><span id="l6.96">                 userId: this.userId,</span>
<a href="#l6.97"></a><span id="l6.97">                 keyId: &quot;0x&quot; + this.keyId,</span>
<a href="#l6.98"></a><span id="l6.98">               }</span>
<a href="#l6.99"></a><span id="l6.99">             );</span>
<a href="#l6.100"></a><span id="l6.100">           } else if (revoked) {</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineat">@@ -367,18 +352,18 @@ class EnigmailKeyObj {</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">   /**</span>
<a href="#l6.104"></a><span id="l6.104">    * Check whether a key can be used for encryption and return a description of why not</span>
<a href="#l6.105"></a><span id="l6.105">    *</span>
<a href="#l6.106"></a><span id="l6.106">    * @return Object:</span>
<a href="#l6.107"></a><span id="l6.107">    *   - keyValid: Boolean (true if key is valid)</span>
<a href="#l6.108"></a><span id="l6.108">    *   - reason: String (explanation of invalidity)</span>
<a href="#l6.109"></a><span id="l6.109">    */</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-  getEncryptionValidity() {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-    let retVal = this.getPubKeyValidity();</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  getEncryptionValidity(exceptionReason = null) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    let retVal = this.getPubKeyValidity(exceptionReason);</span>
<a href="#l6.114"></a><span id="l6.114">     if (!retVal.keyValid) {</span>
<a href="#l6.115"></a><span id="l6.115">       return retVal;</span>
<a href="#l6.116"></a><span id="l6.116">     }</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118">     if (this.keyUseFor.search(/E/) &lt; 0) {</span>
<a href="#l6.119"></a><span id="l6.119">       retVal.keyValid = false;</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121">       if (this.keyTrust.search(/u/i) &lt; 0) {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineat">@@ -408,17 +393,17 @@ class EnigmailKeyObj {</span>
<a href="#l6.123"></a><span id="l6.123">             } else {</span>
<a href="#l6.124"></a><span id="l6.124">               // found subkey usable</span>
<a href="#l6.125"></a><span id="l6.125">               ++found;</span>
<a href="#l6.126"></a><span id="l6.126">             }</span>
<a href="#l6.127"></a><span id="l6.127">           }</span>
<a href="#l6.128"></a><span id="l6.128">         }</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130">         if (!found) {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-          if (expired) {</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+          if (exceptionReason != &quot;ignoreExpired&quot; &amp;&amp; expired) {</span>
<a href="#l6.133"></a><span id="l6.133">             retVal.reason = l10n.formatValueSync(</span>
<a href="#l6.134"></a><span id="l6.134">               &quot;key-ring-enc-sub-keys-expired&quot;,</span>
<a href="#l6.135"></a><span id="l6.135">               {</span>
<a href="#l6.136"></a><span id="l6.136">                 userId: this.userId,</span>
<a href="#l6.137"></a><span id="l6.137">                 keyId: &quot;0x&quot; + this.keyId,</span>
<a href="#l6.138"></a><span id="l6.138">               }</span>
<a href="#l6.139"></a><span id="l6.139">             );</span>
<a href="#l6.140"></a><span id="l6.140">           } else if (revoked) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -100,62 +100,16 @@ var EnigmailKeyRing = {</span>
<a href="#l7.4"></a><span id="l7.4">         getSortFunction(sortColumn.toLowerCase(), gKeyListObj, sortDirection)</span>
<a href="#l7.5"></a><span id="l7.5">       );</span>
<a href="#l7.6"></a><span id="l7.6">     }</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">     return gKeyListObj;</span>
<a href="#l7.9"></a><span id="l7.9">   },</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">   /**</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-   * get a list of all (valid, usable) keys that have a secret key</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-   *</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-   * @param Boolean onlyValidKeys: if true, only filter valid usable keys</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-   *</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-   * @return Array of KeyObjects containing the found keys (sorted by userId)</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-   **/</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  getAllSecretKeys(onlyValidKeys = false) {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyRing.jsm: getAllSecretKeys()\n&quot;);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-    let res = [];</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-    this.getAllKeys(); // ensure keylist is loaded;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-    if (!onlyValidKeys) {</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-      for (let key of gKeyListObj.keyList) {</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-        if (key.secretAvailable) {</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-          res.push(key);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-        }</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-      }</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    } else {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-      for (let key of gKeyListObj.keyList) {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-        if (key.secretAvailable &amp;&amp; key.keyUseFor.search(/D/) &lt; 0) {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-          // key is not disabled and _usable_ for encryption signing and certification</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-          if (</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-            key.keyUseFor.search(/E/) &gt;= 0 &amp;&amp;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-            key.keyUseFor.search(/S/) &gt;= 0 &amp;&amp;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-            key.keyUseFor.search(/C/) &gt;= 0</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-          ) {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-            res.push(key);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-          }</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-        }</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-      }</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-    }</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    res.sort(function(a, b) {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-      if (a.userId == b.userId) {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-        return a.keyId &lt; b.keyId ? -1 : 1;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-      }</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-      return a.userId.toLowerCase() &lt; b.userId.toLowerCase() ? -1 : 1;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    });</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    return res;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  },</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  /**</span>
<a href="#l7.58"></a><span id="l7.58">    * get 1st key object that matches a given key ID or subkey ID</span>
<a href="#l7.59"></a><span id="l7.59">    *</span>
<a href="#l7.60"></a><span id="l7.60">    * @param keyId      - String: key Id with 16 characters (preferred) or 8 characters),</span>
<a href="#l7.61"></a><span id="l7.61">    *                             or fingerprint (40 or 32 characters).</span>
<a href="#l7.62"></a><span id="l7.62">    *                             Optionally preceeded with &quot;0x&quot;</span>
<a href="#l7.63"></a><span id="l7.63">    * @param noLoadKeys - Boolean [optional]: do not try to load the key list first</span>
<a href="#l7.64"></a><span id="l7.64">    *</span>
<a href="#l7.65"></a><span id="l7.65">    * @return Object - found KeyObject or null if key not found</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineat">@@ -189,17 +143,17 @@ var EnigmailKeyRing = {</span>
<a href="#l7.67"></a><span id="l7.67">    *</span>
<a href="#l7.68"></a><span id="l7.68">    * @param searchTerm   - String: a regular expression to match against all UIDs of the keys.</span>
<a href="#l7.69"></a><span id="l7.69">    *                               The search is always performed case-insensitively</span>
<a href="#l7.70"></a><span id="l7.70">    *                               An empty string will return no result</span>
<a href="#l7.71"></a><span id="l7.71">    * @param onlyValidUid - Boolean: if true (default), invalid (e.g. revoked) UIDs are not matched</span>
<a href="#l7.72"></a><span id="l7.72">    *</span>
<a href="#l7.73"></a><span id="l7.73">    * @return Array of KeyObjects with the found keys (array length is 0 if no key found)</span>
<a href="#l7.74"></a><span id="l7.74">    */</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  getKeysByUserId(searchTerm, onlyValidUid = true) {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  getKeysByUserId(searchTerm, onlyValidUid = true, allowExpired = false) {</span>
<a href="#l7.77"></a><span id="l7.77">     EnigmailLog.DEBUG(&quot;keyRing.jsm: getKeysByUserId: '&quot; + searchTerm + &quot;'\n&quot;);</span>
<a href="#l7.78"></a><span id="l7.78">     let s = new RegExp(searchTerm, &quot;i&quot;);</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     let res = [];</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">     this.getAllKeys(); // ensure keylist is loaded;</span>
<a href="#l7.83"></a><span id="l7.83"> </span>
<a href="#l7.84"></a><span id="l7.84">     if (searchTerm === &quot;&quot;) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineat">@@ -207,123 +161,117 @@ var EnigmailKeyRing = {</span>
<a href="#l7.86"></a><span id="l7.86">     }</span>
<a href="#l7.87"></a><span id="l7.87">     for (let i in gKeyListObj.keyList) {</span>
<a href="#l7.88"></a><span id="l7.88">       let k = gKeyListObj.keyList[i];</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90">       for (let j in k.userIds) {</span>
<a href="#l7.91"></a><span id="l7.91">         if (k.userIds[j].type === &quot;uid&quot; &amp;&amp; k.userIds[j].userId.search(s) &gt;= 0) {</span>
<a href="#l7.92"></a><span id="l7.92">           if (</span>
<a href="#l7.93"></a><span id="l7.93">             !onlyValidUid ||</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-            !EnigmailTrust.isInvalid(k.userIds[j].keyTrust)</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+            !EnigmailTrust.isInvalid(k.userIds[j].keyTrust) ||</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+            (allowExpired &amp;&amp; k.userIds[j].keyTrust == &quot;e&quot;)</span>
<a href="#l7.97"></a><span id="l7.97">           ) {</span>
<a href="#l7.98"></a><span id="l7.98">             res.push(k);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-            continue;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+            break;</span>
<a href="#l7.101"></a><span id="l7.101">           }</span>
<a href="#l7.102"></a><span id="l7.102">         }</span>
<a href="#l7.103"></a><span id="l7.103">       }</span>
<a href="#l7.104"></a><span id="l7.104">     }</span>
<a href="#l7.105"></a><span id="l7.105">     return res;</span>
<a href="#l7.106"></a><span id="l7.106">   },</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">   /**</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-   * Specialized function for getSecretKeyByUserId() that takes into account</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+   * Specialized function that takes into account</span>
<a href="#l7.111"></a><span id="l7.111">    * the specifics of email addresses in UIDs.</span>
<a href="#l7.112"></a><span id="l7.112">    *</span>
<a href="#l7.113"></a><span id="l7.113">    * @param emailAddr: String - email address to search for without any angulars</span>
<a href="#l7.114"></a><span id="l7.114">    *                            or names</span>
<a href="#l7.115"></a><span id="l7.115">    *</span>
<a href="#l7.116"></a><span id="l7.116">    * @return KeyObject with the found key, or null if no key found</span>
<a href="#l7.117"></a><span id="l7.117">    */</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  getSecretKeyByEmail(emailAddr) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  async getSecretKeyByEmail(emailAddr) {</span>
<a href="#l7.120"></a><span id="l7.120">     let result = {};</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-    this.getSecretKeysByEmail(emailAddr, result);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+    await this.getAllSecretKeysByEmail(emailAddr, result, true);</span>
<a href="#l7.123"></a><span id="l7.123">     return result.best;</span>
<a href="#l7.124"></a><span id="l7.124">   },</span>
<a href="#l7.125"></a><span id="l7.125"> </span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-  getSecretKeysByEmail(emailAddr, result) {</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-    // sanitize email address</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-    emailAddr = emailAddr.replace(/([\.\[\]\-\\])/g, &quot;\\$1&quot;);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    let searchTerm =</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-      &quot;(&lt;&quot; + emailAddr + &quot;&gt;| &quot; + emailAddr + &quot;$|^&quot; + emailAddr + &quot;$)&quot;;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-    this.getAllSecretKeysByUserId(searchTerm, result);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  },</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-</span>
<a href="#l7.136"></a><span id="l7.136">   /**</span>
<a href="#l7.137"></a><span id="l7.137">    * Return the full unfiltered list of keys that are specifics of email</span>
<a href="#l7.138"></a><span id="l7.138">    * addresses in UIDs.</span>
<a href="#l7.139"></a><span id="l7.139">    *</span>
<a href="#l7.140"></a><span id="l7.140">    * @param {String} emailAddr - email address to search for without any</span>
<a href="#l7.141"></a><span id="l7.141">    *   angulars or names.</span>
<a href="#l7.142"></a><span id="l7.142">    *</span>
<a href="#l7.143"></a><span id="l7.143">    * @return {Object | null} - Object with the found keys, or null.</span>
<a href="#l7.144"></a><span id="l7.144">    */</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-  getAllSecretKeysByEmail(emailAddr, result) {</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    // Sanitize email address.</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  async getAllSecretKeysByEmail(emailAddr, result, allowExpired) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    // sanitize email address</span>
<a href="#l7.149"></a><span id="l7.149">     emailAddr = emailAddr.replace(/([\.\[\]\-\\])/g, &quot;\\$1&quot;);</span>
<a href="#l7.150"></a><span id="l7.150"> </span>
<a href="#l7.151"></a><span id="l7.151">     let searchTerm =</span>
<a href="#l7.152"></a><span id="l7.152">       &quot;(&lt;&quot; + emailAddr + &quot;&gt;| &quot; + emailAddr + &quot;$|^&quot; + emailAddr + &quot;$)&quot;;</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    result.all = this.getKeysByUserId(searchTerm, false);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    await this.getAllSecretKeysByUserId(searchTerm, result, allowExpired);</span>
<a href="#l7.156"></a><span id="l7.156">   },</span>
<a href="#l7.157"></a><span id="l7.157"> </span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-  /**</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-   * get the &quot;best&quot; possible secret key for a given user ID</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-   *</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-   * @param searchTerm   - String: a regular expression to match against all UIDs of the keys.</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-   *                               The search is always performed case-insensitively</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-   * @return KeyObject with the found key, or null if no key found</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-   */</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  getSecretKeyByUserId(searchTerm) {</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-    let result = {};</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    this.getAllSecretKeysByUserId(searchTerm, result);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-    return result.best;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  },</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-  getAllSecretKeysByUserId(searchTerm, result) {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  async getAllSecretKeysByUserId(searchTerm, result, allowExpired) {</span>
<a href="#l7.173"></a><span id="l7.173">     EnigmailLog.DEBUG(</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-      &quot;keyRing.jsm: getSecretKeyByUserId: '&quot; + searchTerm + &quot;'\n&quot;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+      &quot;keyRing.jsm: getAllSecretKeysByUserId: '&quot; + searchTerm + &quot;'\n&quot;</span>
<a href="#l7.176"></a><span id="l7.176">     );</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-    let keyList = this.getKeysByUserId(searchTerm, true);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+    let keyList = this.getKeysByUserId(searchTerm, true, true);</span>
<a href="#l7.179"></a><span id="l7.179"> </span>
<a href="#l7.180"></a><span id="l7.180">     result.all = [];</span>
<a href="#l7.181"></a><span id="l7.181">     result.best = null;</span>
<a href="#l7.182"></a><span id="l7.182"> </span>
<a href="#l7.183"></a><span id="l7.183">     var nowDate = new Date();</span>
<a href="#l7.184"></a><span id="l7.184">     var nowSecondsSinceEpoch = nowDate.valueOf() / 1000;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    let bestIsExpired = false;</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187">     for (let key of keyList) {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+      if (!key.secretAvailable) {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+        continue;</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+      }</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+      let isPersonal = await PgpSqliteDb2.isAcceptedAsPersonalKey(key.fpr);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+      if (!isPersonal) {</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+        continue;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+      }</span>
<a href="#l7.195"></a><span id="l7.195">       if (</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-        key.secretAvailable &amp;&amp;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-        key.getEncryptionValidity().keyValid &amp;&amp;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-        key.getSigningValidity().keyValid</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+        key.getEncryptionValidity(&quot;ignoreExpired&quot;).keyValid &amp;&amp;</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+        key.getSigningValidity(&quot;ignoreExpired&quot;).keyValid</span>
<a href="#l7.201"></a><span id="l7.201">       ) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-        if (key.expiryTime != 0 &amp;&amp; key.expiryTime &lt; nowSecondsSinceEpoch) {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+        let thisIsExpired =</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+          key.expiryTime != 0 &amp;&amp; key.expiryTime &lt; nowSecondsSinceEpoch;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+        if (!allowExpired &amp;&amp; thisIsExpired) {</span>
<a href="#l7.206"></a><span id="l7.206">           continue;</span>
<a href="#l7.207"></a><span id="l7.207">         }</span>
<a href="#l7.208"></a><span id="l7.208">         result.all.push(key);</span>
<a href="#l7.209"></a><span id="l7.209">         if (!result.best) {</span>
<a href="#l7.210"></a><span id="l7.210">           result.best = key;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+          bestIsExpired = thisIsExpired;</span>
<a href="#l7.212"></a><span id="l7.212">         } else if (</span>
<a href="#l7.213"></a><span id="l7.213">           result.best.algoSym === key.algoSym &amp;&amp;</span>
<a href="#l7.214"></a><span id="l7.214">           result.best.keySize === key.keySize</span>
<a href="#l7.215"></a><span id="l7.215">         ) {</span>
<a href="#l7.216"></a><span id="l7.216">           if (!key.expiryTime || key.expiryTime &gt; result.best.expiryTime) {</span>
<a href="#l7.217"></a><span id="l7.217">             result.best = key;</span>
<a href="#l7.218"></a><span id="l7.218">           }</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-        } else if (</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-          result.best.algoSym.search(/^(DSA|RSA)$/) &lt; 0 &amp;&amp;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-          key.algoSym.search(/^(DSA|RSA)$/) === 0</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-        ) {</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-          // prefer RSA or DSA over ECC (long-term: change this once ECC keys are widely supported)</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-          result.best = key;</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-        } else if (key.getVirtualKeySize() &gt; result.best.getVirtualKeySize()) {</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-          result.best = key;</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+        } else if (bestIsExpired &amp;&amp; !thisIsExpired) {</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+          if (</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+            result.best.algoSym.search(/^(DSA|RSA)$/) &lt; 0 &amp;&amp;</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+            key.algoSym.search(/^(DSA|RSA)$/) === 0</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+          ) {</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+            // prefer RSA or DSA over ECC (long-term: change this once ECC keys are widely supported)</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+            result.best = key;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+            bestIsExpired = thisIsExpired;</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+          } else if (</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+            key.getVirtualKeySize() &gt; result.best.getVirtualKeySize()</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+          ) {</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+            result.best = key;</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+            bestIsExpired = thisIsExpired;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+          }</span>
<a href="#l7.241"></a><span id="l7.241">         }</span>
<a href="#l7.242"></a><span id="l7.242">       }</span>
<a href="#l7.243"></a><span id="l7.243">     }</span>
<a href="#l7.244"></a><span id="l7.244">   },</span>
<a href="#l7.245"></a><span id="l7.245"> </span>
<a href="#l7.246"></a><span id="l7.246">   /**</span>
<a href="#l7.247"></a><span id="l7.247">    * get a list of keys for a given set of (sub-) key IDs</span>
<a href="#l7.248"></a><span id="l7.248">    *</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineat">@@ -852,17 +800,22 @@ var EnigmailKeyRing = {</span>
<a href="#l7.250"></a><span id="l7.250">       // key valid for encryption?</span>
<a href="#l7.251"></a><span id="l7.251">       if (!keyObj.keyUseFor.includes(&quot;E&quot;)) {</span>
<a href="#l7.252"></a><span id="l7.252">         //EnigmailLog.DEBUG(&quot;keyRing.jsm: getValidKeyForRecipient():  skip key &quot; + keyObj.keyId + &quot; (not provided for encryption)\n&quot;);</span>
<a href="#l7.253"></a><span id="l7.253">         continue; // not valid for encryption =&gt; **** CONTINUE the LOOP</span>
<a href="#l7.254"></a><span id="l7.254">       }</span>
<a href="#l7.255"></a><span id="l7.255"> </span>
<a href="#l7.256"></a><span id="l7.256">       let acceptanceLevel;</span>
<a href="#l7.257"></a><span id="l7.257">       if (keyObj.secretAvailable) {</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-        acceptanceLevel = 3;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+        let isPersonal = await PgpSqliteDb2.isAcceptedAsPersonalKey(keyObj.fpr);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+        if (isPersonal) {</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+          acceptanceLevel = 3;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+        } else {</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+          acceptanceLevel = -1; // rejected</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+        }</span>
<a href="#l7.265"></a><span id="l7.265">       } else {</span>
<a href="#l7.266"></a><span id="l7.266">         acceptanceLevel = await this.getKeyAcceptanceLevelForEmail(</span>
<a href="#l7.267"></a><span id="l7.267">           keyObj,</span>
<a href="#l7.268"></a><span id="l7.268">           emailAddr</span>
<a href="#l7.269"></a><span id="l7.269">         );</span>
<a href="#l7.270"></a><span id="l7.270">       }</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272">       if (acceptanceLevel &lt; 1) {</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineat">@@ -932,16 +885,17 @@ var EnigmailKeyRing = {</span>
<a href="#l7.274"></a><span id="l7.274">           break;</span>
<a href="#l7.275"></a><span id="l7.275">       }</span>
<a href="#l7.276"></a><span id="l7.276">     }</span>
<a href="#l7.277"></a><span id="l7.277">     return acceptanceLevel;</span>
<a href="#l7.278"></a><span id="l7.278">   },</span>
<a href="#l7.279"></a><span id="l7.279"> </span>
<a href="#l7.280"></a><span id="l7.280">   async getKeyAcceptanceForEmail(keyObj, email) {</span>
<a href="#l7.281"></a><span id="l7.281">     let acceptanceResult = {};</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+</span>
<a href="#l7.283"></a><span id="l7.283">     try {</span>
<a href="#l7.284"></a><span id="l7.284">       await PgpSqliteDb2.getAcceptance(keyObj.fpr, email, acceptanceResult);</span>
<a href="#l7.285"></a><span id="l7.285">     } catch (ex) {</span>
<a href="#l7.286"></a><span id="l7.286">       console.debug(&quot;getAcceptance failed: &quot; + ex);</span>
<a href="#l7.287"></a><span id="l7.287">       return null;</span>
<a href="#l7.288"></a><span id="l7.288">     }</span>
<a href="#l7.289"></a><span id="l7.289"> </span>
<a href="#l7.290"></a><span id="l7.290">     if (acceptanceResult.emailDecided) {</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineat">@@ -1016,17 +970,17 @@ var EnigmailKeyRing = {</span>
<a href="#l7.292"></a><span id="l7.292">             errMsg = &quot;ProblemNoKey&quot;;</span>
<a href="#l7.293"></a><span id="l7.293">           }</span>
<a href="#l7.294"></a><span id="l7.294">           var detailsElem = {};</span>
<a href="#l7.295"></a><span id="l7.295">           detailsElem.addr = addr;</span>
<a href="#l7.296"></a><span id="l7.296">           detailsElem.msg = errMsg;</span>
<a href="#l7.297"></a><span id="l7.297">           details.errArray.push(detailsElem);</span>
<a href="#l7.298"></a><span id="l7.298">         }</span>
<a href="#l7.299"></a><span id="l7.299">         EnigmailLog.DEBUG(</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-          'keyRing.jsm: doValidKeysForAllRecipients(): return null (no single valid key found for=&quot;' +</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+          'keyRing.jsm: getValidKeysForAllRecipients(): return null (no single valid key found for=&quot;' +</span>
<a href="#l7.302"></a><span id="l7.302">             addr +</span>
<a href="#l7.303"></a><span id="l7.303">             '&quot;)\n'</span>
<a href="#l7.304"></a><span id="l7.304">         );</span>
<a href="#l7.305"></a><span id="l7.305">       }</span>
<a href="#l7.306"></a><span id="l7.306">     }</span>
<a href="#l7.307"></a><span id="l7.307">     return keyMissing;</span>
<a href="#l7.308"></a><span id="l7.308">   },</span>
<a href="#l7.309"></a><span id="l7.309"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -165,40 +165,56 @@ var PgpSqliteDb2 = {</span>
<a href="#l8.4"></a><span id="l8.4">         );</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">         /* A key might contain multiple user IDs with the same email</span>
<a href="#l8.7"></a><span id="l8.7">          * address. We add each email only once. */</span>
<a href="#l8.8"></a><span id="l8.8">         let alreadyAdded = new Set();</span>
<a href="#l8.9"></a><span id="l8.9">         let insertObj = {</span>
<a href="#l8.10"></a><span id="l8.10">           fpr: fingerprint,</span>
<a href="#l8.11"></a><span id="l8.11">         };</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        for (let email of emailArray) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-          if (!email) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-            continue;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+        if (emailArray) {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+          for (let email of emailArray) {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+            if (!email) {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+              continue;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+            }</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+            insertObj.email = email.toLowerCase();</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+            if (alreadyAdded.has(insertObj.email)) {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+              continue;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+            }</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+            alreadyAdded.add(insertObj.email);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+            await conn.execute(</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+              &quot;insert into acceptance_email values (:fpr, :email)&quot;,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+              insertObj</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+            );</span>
<a href="#l8.29"></a><span id="l8.29">           }</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-          insertObj.email = email.toLowerCase();</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-          if (alreadyAdded.has(insertObj.email)) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-            continue;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-          }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-          alreadyAdded.add(insertObj.email);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-          await conn.execute(</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-            &quot;insert into acceptance_email values (:fpr, :email)&quot;,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-            insertObj</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-          );</span>
<a href="#l8.39"></a><span id="l8.39">         }</span>
<a href="#l8.40"></a><span id="l8.40">       }</span>
<a href="#l8.41"></a><span id="l8.41">       await conn.execute(&quot;commit transaction&quot;);</span>
<a href="#l8.42"></a><span id="l8.42">       await conn.close();</span>
<a href="#l8.43"></a><span id="l8.43">     } catch (ex) {</span>
<a href="#l8.44"></a><span id="l8.44">       console.debug(ex);</span>
<a href="#l8.45"></a><span id="l8.45">       if (conn) {</span>
<a href="#l8.46"></a><span id="l8.46">         await conn.close();</span>
<a href="#l8.47"></a><span id="l8.47">       }</span>
<a href="#l8.48"></a><span id="l8.48">     }</span>
<a href="#l8.49"></a><span id="l8.49">   },</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  async acceptAsPersonalKey(fingerprint) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    this.updateAcceptance(fingerprint, null, &quot;personal&quot;);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  },</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  async deletePersonalKeyAcceptance(fingerprint) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    this.deleteAcceptance(fingerprint);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  },</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  async isAcceptedAsPersonalKey(fingerprint) {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    let result = { fingerprintAcceptance: &quot;&quot; };</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    await this.getFingerprintAcceptance(null, fingerprint, result);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    return result.fingerprintAcceptance === &quot;personal&quot;;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  },</span>
<a href="#l8.64"></a><span id="l8.64"> };</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66"> var EnigmailSqliteDb = {</span>
<a href="#l8.67"></a><span id="l8.67">   /**</span>
<a href="#l8.68"></a><span id="l8.68">    * Provide an sqlite conection object asynchronously, retrying if needed</span>
<a href="#l8.69"></a><span id="l8.69">    *</span>
<a href="#l8.70"></a><span id="l8.70">    * @return {Promise&lt;Sqlite Connection&gt;}: the Sqlite database object</span>
<a href="#l8.71"></a><span id="l8.71">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/windows.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/windows.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -414,17 +414,17 @@ var EnigmailWindows = {</span>
<a href="#l9.4"></a><span id="l9.4">    *</span>
<a href="#l9.5"></a><span id="l9.5">    * @win        - |object| holding the parent window for the dialog</span>
<a href="#l9.6"></a><span id="l9.6">    * @keyId      - |string| containing the key ID (eg. &quot;0x12345678&quot;)</span>
<a href="#l9.7"></a><span id="l9.7">    * @refresh    - |boolean| if true, cache is cleared and the key data is loaded from GnuPG</span>
<a href="#l9.8"></a><span id="l9.8">    *</span>
<a href="#l9.9"></a><span id="l9.9">    * @return  Boolean - true:  keylist needs to be refreshed</span>
<a href="#l9.10"></a><span id="l9.10">    *                  - false: no need to refresh keylist</span>
<a href="#l9.11"></a><span id="l9.11">    */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  openKeyDetails(win, keyId, refresh) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  async openKeyDetails(win, keyId, refresh) {</span>
<a href="#l9.14"></a><span id="l9.14">     if (!win) {</span>
<a href="#l9.15"></a><span id="l9.15">       win = this.getBestParentWin();</span>
<a href="#l9.16"></a><span id="l9.16">     }</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">     keyId = keyId.replace(/^0x/, &quot;&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">     if (refresh) {</span>
<a href="#l9.21"></a><span id="l9.21">       EnigmailKeyRing.clearCache();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.ftl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.ftl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -182,16 +182,24 @@ openpgp-acceptance-label =</span>
<a href="#l10.4"></a><span id="l10.4"> openpgp-acceptance-rejected-label =</span>
<a href="#l10.5"></a><span id="l10.5">     .label = No, reject this key.</span>
<a href="#l10.6"></a><span id="l10.6"> openpgp-acceptance-undecided-label =</span>
<a href="#l10.7"></a><span id="l10.7">     .label = Not yet, maybe later.</span>
<a href="#l10.8"></a><span id="l10.8"> openpgp-acceptance-unverified-label =</span>
<a href="#l10.9"></a><span id="l10.9">     .label = Yes, but I have not verified that it is the correct key.</span>
<a href="#l10.10"></a><span id="l10.10"> openpgp-acceptance-verified-label =</span>
<a href="#l10.11"></a><span id="l10.11">     .label = Yes, I've verified in person this key has the correct fingerprint.</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+key-accept-personal =</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    For this key, you have both the public and the secret part. You may use it as a personal key.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    If this key was given to you by someone else, then don't use it as a personal key.</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+key-personal-warning = Did you create this key yourself, and the displayed key ownership refers to yourself?</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+openpgp-personal-no-label =</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    .label = No, don't use it as my personal key.</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+openpgp-personal-yes-label =</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    .label = Yes, treat this key as a personal key.</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> openpgp-copy-cmd-label =</span>
<a href="#l10.22"></a><span id="l10.22">     .label = Copy</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24"> ## e2e encryption settings</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> #   $count (Number) - the number of configured keys associated with the current identity</span>
<a href="#l10.27"></a><span id="l10.27"> #   $identity (String) - the email address of the currently selected identity</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -243,26 +251,26 @@ openpgp-key-revoke-title = Revoke Key</span>
<a href="#l10.29"></a><span id="l10.29"> openpgp-key-edit-title = Change OpenPGP Key</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31"> openpgp-key-edit-date-title = Extend Expiration Date</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33"> # Strings in keyDetailsDlg.xhtml</span>
<a href="#l10.34"></a><span id="l10.34"> key-type-public = public key</span>
<a href="#l10.35"></a><span id="l10.35"> key-type-primary = primary key</span>
<a href="#l10.36"></a><span id="l10.36"> key-type-subkey = subkey</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-key-type-pair-2 = personal key (secret key and public key)</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+key-type-pair = key pair (secret key and public key)</span>
<a href="#l10.39"></a><span id="l10.39"> key-expiry-never = never</span>
<a href="#l10.40"></a><span id="l10.40"> key-usage-encrypt = Encrypt</span>
<a href="#l10.41"></a><span id="l10.41"> key-usage-sign = Sign</span>
<a href="#l10.42"></a><span id="l10.42"> key-usage-certify = Certify</span>
<a href="#l10.43"></a><span id="l10.43"> key-usage-authentication = Authentication</span>
<a href="#l10.44"></a><span id="l10.44"> key-does-not-expire = Key does not expire</span>
<a href="#l10.45"></a><span id="l10.45"> key-expired = Key expired on { $keyExpiry }</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+key-expired-simple = Key has expired</span>
<a href="#l10.47"></a><span id="l10.47"> key-revoked = Key was revoked</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-key-auto-accept-personal = You accept this key for all uses, because it is one of your personal keys. You have the secret key.</span>
<a href="#l10.49"></a><span id="l10.49"> key-do-you-accept = Do you accept this key for verifying digital signatures and for encrypting messages?</span>
<a href="#l10.50"></a><span id="l10.50"> key-accept-warning = Avoid accepting a rogue key. Use a communication channel other than email to verify the fingerprint of your correspondent's key.</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52"> # Strings enigmailMsgComposeOverlay.js</span>
<a href="#l10.53"></a><span id="l10.53"> cannot-use-own-key-because = Unable to send the message, because there is a problem with your personal key. { $problem }</span>
<a href="#l10.54"></a><span id="l10.54"> cannot-encrypt-because-missing = Unable to send this message with end-to-end encryption, because there are problems with the keys of the following recipients: { $problem }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56"> # Strings in mimeDecrypt.jsm</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/oneRecipientStatus.ftl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -16,14 +16,15 @@ openpgp-one-recipient-status-open-detail</span>
<a href="#l11.4"></a><span id="l11.4">     .label = Open details and edit acceptance…</span>
<a href="#l11.5"></a><span id="l11.5"> openpgp-one-recipient-status-discover =</span>
<a href="#l11.6"></a><span id="l11.6">     .label = Discover new or updated key</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> openpgp-one-recipient-status-instruction1 = To send an end-to-end encrypted message to a recipient, you need to obtain their OpenPGP public key and mark it as accepted.</span>
<a href="#l11.9"></a><span id="l11.9"> openpgp-one-recipient-status-instruction2 = To obtain their public key, import them from email they have sent to you and that includes it. Alternatively, you can try to discover their public key on a directory.</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> openpgp-key-own = Accepted (personal key)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+openpgp-key-secret-not-personal = Not usable</span>
<a href="#l11.13"></a><span id="l11.13"> openpgp-key-verified = Accepted (verified)</span>
<a href="#l11.14"></a><span id="l11.14"> openpgp-key-unverified = Accepted (unverifed)</span>
<a href="#l11.15"></a><span id="l11.15"> openpgp-key-undecided = Not accepted (undecided)</span>
<a href="#l11.16"></a><span id="l11.16"> openpgp-key-rejected = Not accepted (rejected)</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> openpgp-intro = Available public keys for { $key }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/composeKeyStatus.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/composeKeyStatus.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -10,16 +10,19 @@ var EnigmailKeyRing = ChromeUtils.import</span>
<a href="#l12.4"></a><span id="l12.4">   &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> ).EnigmailKeyRing;</span>
<a href="#l12.6"></a><span id="l12.6"> var { EnigmailWindows } = ChromeUtils.import(</span>
<a href="#l12.7"></a><span id="l12.7">   &quot;chrome://openpgp/content/modules/windows.jsm&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> );</span>
<a href="#l12.9"></a><span id="l12.9"> var { EnigmailKey } = ChromeUtils.import(</span>
<a href="#l12.10"></a><span id="l12.10">   &quot;chrome://openpgp/content/modules/key.jsm&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> );</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+const { PgpSqliteDb2 } = ChromeUtils.import(</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+);</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> var gListBox;</span>
<a href="#l12.17"></a><span id="l12.17"> var gViewButton;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> var gEmailAddresses = [];</span>
<a href="#l12.20"></a><span id="l12.20"> var gRowToEmail = [];</span>
<a href="#l12.21"></a><span id="l12.21"> var gMapAddressToKeyObjs = null;</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -45,18 +48,22 @@ async function setListEntries() {</span>
<a href="#l12.24"></a><span id="l12.24">   for (let addr of gEmailAddresses) {</span>
<a href="#l12.25"></a><span id="l12.25">     let emailStatus = null;</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27">     let foundKeys = gMapAddressToKeyObjs.get(addr);</span>
<a href="#l12.28"></a><span id="l12.28">     if (!foundKeys || !foundKeys.length) {</span>
<a href="#l12.29"></a><span id="l12.29">       emailStatus = &quot;openpgp-recip-missing&quot;;</span>
<a href="#l12.30"></a><span id="l12.30">     } else {</span>
<a href="#l12.31"></a><span id="l12.31">       for (let keyObj of foundKeys) {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+        let goodPersonal = false;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+        if (keyObj.secretAvailable) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+          goodPersonal = await PgpSqliteDb2.isAcceptedAsPersonalKey(keyObj.fpr);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+        }</span>
<a href="#l12.36"></a><span id="l12.36">         if (</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-          keyObj.secretAvailable ||</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+          goodPersonal ||</span>
<a href="#l12.39"></a><span id="l12.39">           keyObj.acceptance == &quot;verified&quot; ||</span>
<a href="#l12.40"></a><span id="l12.40">           keyObj.acceptance == &quot;unverified&quot;</span>
<a href="#l12.41"></a><span id="l12.41">         ) {</span>
<a href="#l12.42"></a><span id="l12.42">           emailStatus = &quot;openpgp-recip-good&quot;;</span>
<a href="#l12.43"></a><span id="l12.43">           break;</span>
<a href="#l12.44"></a><span id="l12.44">         }</span>
<a href="#l12.45"></a><span id="l12.45">       }</span>
<a href="#l12.46"></a><span id="l12.46">       if (!emailStatus) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -2223,17 +2223,17 @@ Enigmail.msg = {</span>
<a href="#l13.4"></a><span id="l13.4">         ? &quot;cannotSendEncBecauseNoOwnKey&quot;</span>
<a href="#l13.5"></a><span id="l13.5">         : &quot;cannotSendSigBecauseNoOwnKey&quot;;</span>
<a href="#l13.6"></a><span id="l13.6">       let fullAlert = EnigmailLocale.getString(msgId, [this.identity.email]);</span>
<a href="#l13.7"></a><span id="l13.7">       EnigmailDialog.alert(window, fullAlert);</span>
<a href="#l13.8"></a><span id="l13.8">       return false;</span>
<a href="#l13.9"></a><span id="l13.9">     }</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">     if (senderKeyId) {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-      let senderKeyUsable = EnigmailEncryption.determineOwnKeyUsability(</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+      let senderKeyUsable = await EnigmailEncryption.determineOwnKeyUsability(</span>
<a href="#l13.14"></a><span id="l13.14">         sendFlags,</span>
<a href="#l13.15"></a><span id="l13.15">         senderKeyId</span>
<a href="#l13.16"></a><span id="l13.16">       );</span>
<a href="#l13.17"></a><span id="l13.17">       if (senderKeyUsable.errorMsg) {</span>
<a href="#l13.18"></a><span id="l13.18">         let fullAlert = await document.l10n.formatValue(</span>
<a href="#l13.19"></a><span id="l13.19">           &quot;cannot-use-own-key-because&quot;,</span>
<a href="#l13.20"></a><span id="l13.20">           {</span>
<a href="#l13.21"></a><span id="l13.21">             problem: senderKeyUsable.errorMsg,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/keyDetailsDlg.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/keyDetailsDlg.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -21,186 +21,207 @@</span>
<a href="#l14.4"></a><span id="l14.4"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> var { uidHelper } = ChromeUtils.import(</span>
<a href="#l14.7"></a><span id="l14.7">   &quot;chrome://openpgp/content/modules/uidHelper.jsm&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> );</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> var l10n = new Localization([&quot;messenger/openpgp/enigmail.ftl&quot;], true);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+var gModePersonal = false;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14"> var gKeyId = null;</span>
<a href="#l14.15"></a><span id="l14.15"> var gUserId = null;</span>
<a href="#l14.16"></a><span id="l14.16"> var gKeyList = null;</span>
<a href="#l14.17"></a><span id="l14.17"> var gTreeFuncs = null;</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> var gAllEmails = [];</span>
<a href="#l14.20"></a><span id="l14.20"> var gFingerprint = &quot;&quot;;</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22"> var gAcceptanceRadio = null;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+var gPersonalRadio = null;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+</span>
<a href="#l14.25"></a><span id="l14.25"> var gOriginalAcceptance;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+var gOriginalPersonal;</span>
<a href="#l14.27"></a><span id="l14.27"> var gUpdateAllowed = false;</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29"> async function onLoad() {</span>
<a href="#l14.30"></a><span id="l14.30">   if (window.arguments[1]) {</span>
<a href="#l14.31"></a><span id="l14.31">     window.arguments[1].refresh = false;</span>
<a href="#l14.32"></a><span id="l14.32">   }</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">   gAcceptanceRadio = document.getElementById(&quot;acceptanceRadio&quot;);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  gPersonalRadio = document.getElementById(&quot;personalRadio&quot;);</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   gKeyId = window.arguments[0].keyId;</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   let accept = document</span>
<a href="#l14.40"></a><span id="l14.40">     .getElementById(&quot;enigmailKeyDetailsDlg&quot;)</span>
<a href="#l14.41"></a><span id="l14.41">     .getButton(&quot;accept&quot;);</span>
<a href="#l14.42"></a><span id="l14.42">   accept.focus();</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  await reloadData();</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  await reloadData(true);</span>
<a href="#l14.46"></a><span id="l14.46"> }</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48"> /***</span>
<a href="#l14.49"></a><span id="l14.49">  * Set the label text of a HTML element</span>
<a href="#l14.50"></a><span id="l14.50">  */</span>
<a href="#l14.51"></a><span id="l14.51"> function setLabel(elementId, label) {</span>
<a href="#l14.52"></a><span id="l14.52">   let node = document.getElementById(elementId);</span>
<a href="#l14.53"></a><span id="l14.53">   node.setAttribute(&quot;value&quot;, label);</span>
<a href="#l14.54"></a><span id="l14.54"> }</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-async function reloadData() {</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+async function reloadData(firstLoad) {</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  // TODO: once we support firstLoad==false, be sure to change the</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  // code below, and don't update the &quot;original&quot; variables on</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  // subsequent calls.</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+</span>
<a href="#l14.62"></a><span id="l14.62">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l14.63"></a><span id="l14.63">   if (!enigmailSvc) {</span>
<a href="#l14.64"></a><span id="l14.64">     throw new Error(&quot;GetEnigmailSvc failed&quot;);</span>
<a href="#l14.65"></a><span id="l14.65">   }</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67">   gUserId = null;</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69">   var treeChildren = document.getElementById(&quot;keyListChildren&quot;);</span>
<a href="#l14.70"></a><span id="l14.70">   var uidList = document.getElementById(&quot;additionalUid&quot;);</span>
<a href="#l14.71"></a><span id="l14.71"> </span>
<a href="#l14.72"></a><span id="l14.72">   // clean lists</span>
<a href="#l14.73"></a><span id="l14.73">   EnigCleanGuiList(treeChildren);</span>
<a href="#l14.74"></a><span id="l14.74">   EnigCleanGuiList(uidList);</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">   let keyObj = EnigmailKeyRing.getKeyById(gKeyId);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-  if (keyObj) {</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-    let keyIsExpired =</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-      keyObj.expiryTime &amp;&amp; keyObj.expiryTime &lt; Math.floor(Date.now() / 1000);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  if (!keyObj) {</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+    return;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  }</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  let acceptanceIntro1Text = &quot;&quot;;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  let acceptanceIntro2Text = &quot;&quot;;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  if (keyObj.fpr) {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+    gFingerprint = keyObj.fpr;</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+    setLabel(&quot;fingerprint&quot;, EnigmailKey.formatFpr(keyObj.fpr));</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  }</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-    let acceptanceIntroText = &quot;&quot;;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    let acceptanceWarningText = &quot;&quot;;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-    if (keyObj.secretAvailable) {</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-      document.getElementById(&quot;ownKeyCommands&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-      acceptanceIntroText = &quot;key-auto-accept-personal&quot;;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-      let value = await document.l10n.formatValue(&quot;key-type-pair-2&quot;);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-      setLabel(&quot;keyType&quot;, value);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-    } else {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-      document.getElementById(&quot;ownKeyCommands&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-      let value = await document.l10n.formatValue(&quot;key-type-public&quot;);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-      setLabel(&quot;keyType&quot;, value);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  if (keyObj.hasSubUserIds()) {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+    document.getElementById(&quot;alsoknown&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+    createUidData(uidList, keyObj);</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  } else {</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+    document.getElementById(&quot;alsoknown&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  }</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  if (keyObj.signatures) {</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+    let sigListViewObj = new SigListView(keyObj);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+    let tree = document.getElementById(&quot;signatures_tree&quot;);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+    tree.view = sigListViewObj;</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    gTreeFuncs = EnigmailCompat.getTreeCompatibleFuncs(tree, sigListViewObj);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  }</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  let subkeyListViewObj = new SubkeyListView(keyObj);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+  document.getElementById(&quot;subkeyList&quot;).view = subkeyListViewObj;</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  gUserId = keyObj.userId;</span>
<a href="#l14.121"></a><span id="l14.121"> </span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-      let isStillValid = !(</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-        keyObj.keyTrust == &quot;r&quot; ||</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-        keyObj.keyTrust == &quot;e&quot; ||</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-        keyIsExpired</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-      );</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-      if (isStillValid) {</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-        document</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-          .getElementById(&quot;acceptanceRadio&quot;)</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-          .setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-        acceptanceIntroText = &quot;key-do-you-accept&quot;;</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-        acceptanceWarningText = &quot;key-accept-warning&quot;;</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-        gUpdateAllowed = true;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  let splitUid = {};</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+  uidHelper.getPartsFromUidStr(keyObj.userId, splitUid);</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+  if (splitUid.email) {</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+    gAllEmails.push(splitUid.email);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+  }</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+  setLabel(&quot;userId&quot;, gUserId);</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+  setLabel(&quot;keyCreated&quot;, keyObj.created);</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+  let keyIsExpired =</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+    keyObj.expiryTime &amp;&amp; keyObj.expiryTime &lt; Math.floor(Date.now() / 1000);</span>
<a href="#l14.145"></a><span id="l14.145"> </span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-        let acceptanceResult = {};</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-        await PgpSqliteDb2.getFingerprintAcceptance(</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-          null,</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-          keyObj.fpr,</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-          acceptanceResult</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-        );</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-        if (</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-          &quot;fingerprintAcceptance&quot; in acceptanceResult &amp;&amp;</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-          acceptanceResult.fingerprintAcceptance != &quot;undecided&quot;</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-        ) {</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-          gOriginalAcceptance = acceptanceResult.fingerprintAcceptance;</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-        } else {</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-          gOriginalAcceptance = &quot;undecided&quot;;</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-        }</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-        gAcceptanceRadio.value = gOriginalAcceptance;</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-      }</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-    }</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-    if (keyObj.hasSubUserIds()) {</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-      document.getElementById(&quot;alsoknown&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-      createUidData(uidList, keyObj);</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-    } else {</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-      document.getElementById(&quot;alsoknown&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-    }</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+  let expiryInfo;</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+  let expireArgument = null;</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+  let expiryInfoKey = &quot;&quot;;</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+  if (keyObj.keyTrust == &quot;r&quot;) {</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+    expiryInfoKey = &quot;key-revoked&quot;;</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+  } else if (keyObj.keyTrust == &quot;e&quot; || keyIsExpired) {</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+    expiryInfoKey = &quot;key-expired&quot;;</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+    expireArgument = keyObj.expiry;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+  } else if (keyObj.expiry.length === 0) {</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    expiryInfoKey = &quot;key-does-not-expire&quot;;</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+  } else {</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+    expiryInfo = keyObj.expiry;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+  }</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  if (expiryInfoKey) {</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+    expiryInfo = l10n.formatValueSync(expiryInfoKey, {</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+      keyExpiry: expireArgument,</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+    });</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+  }</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+  setLabel(&quot;keyExpiry&quot;, expiryInfo);</span>
<a href="#l14.190"></a><span id="l14.190"> </span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-    if (keyObj.signatures) {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-      let sigListViewObj = new SigListView(keyObj);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-      let tree = document.getElementById(&quot;signatures_tree&quot;);</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-      tree.view = sigListViewObj;</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-      gTreeFuncs = EnigmailCompat.getTreeCompatibleFuncs(tree, sigListViewObj);</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    }</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-    let subkeyListViewObj = new SubkeyListView(keyObj);</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-    document.getElementById(&quot;subkeyList&quot;).view = subkeyListViewObj;</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+  gModePersonal = keyObj.secretAvailable;</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  if (gModePersonal) {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+    gPersonalRadio.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+    gAcceptanceRadio.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    document.getElementById(&quot;ownKeyCommands&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    acceptanceIntro1Text = &quot;key-accept-personal&quot;;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+    acceptanceIntro2Text = &quot;key-personal-warning&quot;;</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+    let value = l10n.formatValueSync(&quot;key-type-pair&quot;);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+    setLabel(&quot;keyType&quot;, value);</span>
<a href="#l14.209"></a><span id="l14.209"> </span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-    gUserId = keyObj.userId;</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-    let splitUid = {};</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-    uidHelper.getPartsFromUidStr(keyObj.userId, splitUid);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    if (splitUid.email) {</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-      gAllEmails.push(splitUid.email);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-    }</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-    setLabel(&quot;userId&quot;, gUserId);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-    setLabel(&quot;keyCreated&quot;, keyObj.created);</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+    gUpdateAllowed = true;</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+    gOriginalPersonal = await PgpSqliteDb2.isAcceptedAsPersonalKey(keyObj.fpr);</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+    gPersonalRadio.value = gOriginalPersonal ? &quot;personal&quot; : &quot;not_personal&quot;;</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+  } else {</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+    gPersonalRadio.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+    document.getElementById(&quot;ownKeyCommands&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+    let value = l10n.formatValueSync(&quot;key-type-public&quot;);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+    setLabel(&quot;keyType&quot;, value);</span>
<a href="#l14.228"></a><span id="l14.228"> </span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-    let expiryInfo;</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-    let expireArgument = null;</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-    let l10nUse = true;</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    if (keyObj.keyTrust == &quot;r&quot;) {</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-      expiryInfo = &quot;key-revoked&quot;;</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-      acceptanceIntroText = expiryInfo;</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-    } else if (keyObj.keyTrust == &quot;e&quot; || keyIsExpired) {</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-      expiryInfo = &quot;key-expired&quot;;</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-      expireArgument = keyObj.expiry;</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-      acceptanceIntroText = expiryInfo;</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-    } else if (keyObj.expiry.length === 0) {</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-      expiryInfo = &quot;key-does-not-expire&quot;;</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+    let isStillValid = !(</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+      keyObj.keyTrust == &quot;r&quot; ||</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+      keyObj.keyTrust == &quot;e&quot; ||</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+      keyIsExpired</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+    );</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+    if (!isStillValid) {</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+      gAcceptanceRadio.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+      if (keyObj.keyTrust == &quot;r&quot;) {</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+        acceptanceIntro1Text = &quot;key-revoked&quot;;</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+      } else if (keyObj.keyTrust == &quot;e&quot; || keyIsExpired) {</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+        acceptanceIntro1Text = &quot;key-expired-simple&quot;;</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+      }</span>
<a href="#l14.253"></a><span id="l14.253">     } else {</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-      expiryInfo = keyObj.expiry;</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-      l10nUse = false;</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-    }</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+      gAcceptanceRadio.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+      acceptanceIntro1Text = &quot;key-do-you-accept&quot;;</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+      acceptanceIntro2Text = &quot;key-accept-warning&quot;;</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+      gUpdateAllowed = true;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+      //await RNP.calculateAcceptance(keyObj.keyId, null);</span>
<a href="#l14.263"></a><span id="l14.263"> </span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-    if (acceptanceIntroText) {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-      let acceptanceIntro = document.getElementById(&quot;acceptanceIntro&quot;);</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-      document.l10n.setAttributes(acceptanceIntro, acceptanceIntroText);</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+      let acceptanceResult = {};</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+      await PgpSqliteDb2.getFingerprintAcceptance(</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+        null,</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+        keyObj.fpr,</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+        acceptanceResult</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+      );</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+      if (</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+        &quot;fingerprintAcceptance&quot; in acceptanceResult &amp;&amp;</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+        acceptanceResult.fingerprintAcceptance != &quot;undecided&quot;</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+      ) {</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+        gOriginalAcceptance = acceptanceResult.fingerprintAcceptance;</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+      } else {</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+        gOriginalAcceptance = &quot;undecided&quot;;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+      }</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+      gAcceptanceRadio.value = gOriginalAcceptance;</span>
<a href="#l14.283"></a><span id="l14.283">     }</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-    if (acceptanceWarningText) {</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-      let acceptanceExplanation = document.getElementById(</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineminus">-        &quot;acceptanceExplanation&quot;</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-      );</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-      document.l10n.setAttributes(acceptanceExplanation, acceptanceWarningText);</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-    }</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+  }</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+  if (acceptanceIntro1Text) {</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+    let acceptanceIntro1 = document.getElementById(&quot;acceptanceIntro1&quot;);</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+    document.l10n.setAttributes(acceptanceIntro1, acceptanceIntro1Text);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+  }</span>
<a href="#l14.296"></a><span id="l14.296"> </span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-    if (l10nUse) {</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-      let keyExpiryNode = document.getElementById(&quot;keyExpiry&quot;);</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-      document.l10n.setAttributes(keyExpiryNode, expiryInfo, {</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-        keyExpiry: expireArgument,</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-      });</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-    } else {</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-      setLabel(&quot;keyExpiry&quot;, expiryInfo);</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-    }</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-    if (keyObj.fpr) {</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-      gFingerprint = keyObj.fpr;</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-      setLabel(&quot;fingerprint&quot;, EnigmailKey.formatFpr(keyObj.fpr));</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-    }</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+  if (acceptanceIntro2Text) {</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+    let acceptanceIntro2 = document.getElementById(&quot;acceptanceIntro2&quot;);</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+    document.l10n.setAttributes(acceptanceIntro2, acceptanceIntro2Text);</span>
<a href="#l14.312"></a><span id="l14.312">   }</span>
<a href="#l14.313"></a><span id="l14.313"> }</span>
<a href="#l14.314"></a><span id="l14.314"> </span>
<a href="#l14.315"></a><span id="l14.315"> function createUidData(listNode, keyDetails) {</span>
<a href="#l14.316"></a><span id="l14.316">   for (let i = 1; i &lt; keyDetails.userIds.length; i++) {</span>
<a href="#l14.317"></a><span id="l14.317">     if (keyDetails.userIds[i].type === &quot;uid&quot;) {</span>
<a href="#l14.318"></a><span id="l14.318">       let item = listNode.appendItem(keyDetails.userIds[i].userId);</span>
<a href="#l14.319"></a><span id="l14.319">       item.setAttribute(&quot;label&quot;, keyDetails.userIds[i].userId);</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineat">@@ -212,23 +233,25 @@ function createUidData(listNode, keyDeta</span>
<a href="#l14.321"></a><span id="l14.321">       uidHelper.getPartsFromUidStr(keyDetails.userIds[i].userId, splitUid);</span>
<a href="#l14.322"></a><span id="l14.322">       if (splitUid.email) {</span>
<a href="#l14.323"></a><span id="l14.323">         gAllEmails.push(splitUid.email);</span>
<a href="#l14.324"></a><span id="l14.324">       }</span>
<a href="#l14.325"></a><span id="l14.325">     }</span>
<a href="#l14.326"></a><span id="l14.326">   }</span>
<a href="#l14.327"></a><span id="l14.327"> }</span>
<a href="#l14.328"></a><span id="l14.328"> </span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+/*</span>
<a href="#l14.330"></a><span id="l14.330"> function getTrustLabel(trustCode) {</span>
<a href="#l14.331"></a><span id="l14.331">   var trustTxt = EnigGetTrustLabel(trustCode);</span>
<a href="#l14.332"></a><span id="l14.332">   if (trustTxt == &quot;-&quot; || trustTxt.length === 0) {</span>
<a href="#l14.333"></a><span id="l14.333">     return l10n.formatValueSync(&quot;key-valid-unknown&quot;);</span>
<a href="#l14.334"></a><span id="l14.334">   }</span>
<a href="#l14.335"></a><span id="l14.335">   return trustTxt;</span>
<a href="#l14.336"></a><span id="l14.336"> }</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+*/</span>
<a href="#l14.338"></a><span id="l14.338"> </span>
<a href="#l14.339"></a><span id="l14.339"> function setAttr(attribute, value) {</span>
<a href="#l14.340"></a><span id="l14.340">   var elem = document.getElementById(attribute);</span>
<a href="#l14.341"></a><span id="l14.341">   if (elem) {</span>
<a href="#l14.342"></a><span id="l14.342">     elem.value = value;</span>
<a href="#l14.343"></a><span id="l14.343">   }</span>
<a href="#l14.344"></a><span id="l14.344"> }</span>
<a href="#l14.345"></a><span id="l14.345"> </span>
<a href="#l14.346"></a><span id="l14.346" class="difflineat">@@ -237,24 +260,24 @@ function enableRefresh() {</span>
<a href="#l14.347"></a><span id="l14.347"> }</span>
<a href="#l14.348"></a><span id="l14.348"> </span>
<a href="#l14.349"></a><span id="l14.349"> // ------------------ onCommand Functions  -----------------</span>
<a href="#l14.350"></a><span id="l14.350"> </span>
<a href="#l14.351"></a><span id="l14.351"> /*</span>
<a href="#l14.352"></a><span id="l14.352"> function signKey() {</span>
<a href="#l14.353"></a><span id="l14.353">   if (EnigSignKey(gUserId, gKeyId, null)) {</span>
<a href="#l14.354"></a><span id="l14.354">     enableRefresh();</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-    reloadData();</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+    reloadData(false);</span>
<a href="#l14.357"></a><span id="l14.357">   }</span>
<a href="#l14.358"></a><span id="l14.358"> }</span>
<a href="#l14.359"></a><span id="l14.359"> </span>
<a href="#l14.360"></a><span id="l14.360"> function changeExpirationDate() {</span>
<a href="#l14.361"></a><span id="l14.361">   if (EnigEditKeyExpiry([gUserId], [gKeyId])) {</span>
<a href="#l14.362"></a><span id="l14.362">     enableRefresh();</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-    reloadData();</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+    reloadData(false);</span>
<a href="#l14.365"></a><span id="l14.365">   }</span>
<a href="#l14.366"></a><span id="l14.366"> }</span>
<a href="#l14.367"></a><span id="l14.367"> */</span>
<a href="#l14.368"></a><span id="l14.368"> </span>
<a href="#l14.369"></a><span id="l14.369"> /*</span>
<a href="#l14.370"></a><span id="l14.370"> function manageUids() {</span>
<a href="#l14.371"></a><span id="l14.371">   let keyObj = EnigmailKeyRing.getKeyById(gKeyId);</span>
<a href="#l14.372"></a><span id="l14.372"> </span>
<a href="#l14.373"></a><span id="l14.373" class="difflineat">@@ -270,33 +293,33 @@ function manageUids() {</span>
<a href="#l14.374"></a><span id="l14.374">     &quot;chrome://openpgp/content/ui/enigmailManageUidDlg.xhtml&quot;,</span>
<a href="#l14.375"></a><span id="l14.375">     &quot;&quot;,</span>
<a href="#l14.376"></a><span id="l14.376">     &quot;dialog,modal,centerscreen,resizable=yes&quot;,</span>
<a href="#l14.377"></a><span id="l14.377">     inputObj,</span>
<a href="#l14.378"></a><span id="l14.378">     resultObj</span>
<a href="#l14.379"></a><span id="l14.379">   );</span>
<a href="#l14.380"></a><span id="l14.380">   if (resultObj.refresh) {</span>
<a href="#l14.381"></a><span id="l14.381">     enableRefresh();</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-    reloadData();</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+    reloadData(false);</span>
<a href="#l14.384"></a><span id="l14.384">   }</span>
<a href="#l14.385"></a><span id="l14.385"> }</span>
<a href="#l14.386"></a><span id="l14.386"> */</span>
<a href="#l14.387"></a><span id="l14.387"> </span>
<a href="#l14.388"></a><span id="l14.388"> /*</span>
<a href="#l14.389"></a><span id="l14.389"> function changePassword() {</span>
<a href="#l14.390"></a><span id="l14.390">   EnigChangeKeyPwd(gKeyId, gUserId);</span>
<a href="#l14.391"></a><span id="l14.391"> }</span>
<a href="#l14.392"></a><span id="l14.392"> */</span>
<a href="#l14.393"></a><span id="l14.393"> </span>
<a href="#l14.394"></a><span id="l14.394"> async function revokeKey() {</span>
<a href="#l14.395"></a><span id="l14.395">   /*</span>
<a href="#l14.396"></a><span id="l14.396">   EnigRevokeKey(gKeyId, gUserId, function(success) {</span>
<a href="#l14.397"></a><span id="l14.397">     if (success) {</span>
<a href="#l14.398"></a><span id="l14.398">       enableRefresh();</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineminus">-      await reloadData();</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+      await reloadData(false);</span>
<a href="#l14.401"></a><span id="l14.401">     }</span>
<a href="#l14.402"></a><span id="l14.402">   });</span>
<a href="#l14.403"></a><span id="l14.403">   */</span>
<a href="#l14.404"></a><span id="l14.404"> }</span>
<a href="#l14.405"></a><span id="l14.405"> </span>
<a href="#l14.406"></a><span id="l14.406"> function genRevocationCert() {</span>
<a href="#l14.407"></a><span id="l14.407">   EnigCreateRevokeCert(gKeyId, gUserId);</span>
<a href="#l14.408"></a><span id="l14.408"> }</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineat">@@ -629,27 +652,36 @@ SubkeyListView.prototype = {</span>
<a href="#l14.410"></a><span id="l14.410">   },</span>
<a href="#l14.411"></a><span id="l14.411"> </span>
<a href="#l14.412"></a><span id="l14.412">   toggleOpenState(row) {},</span>
<a href="#l14.413"></a><span id="l14.413"> };</span>
<a href="#l14.414"></a><span id="l14.414"> </span>
<a href="#l14.415"></a><span id="l14.415"> function sigHandleDblClick(event) {}</span>
<a href="#l14.416"></a><span id="l14.416"> </span>
<a href="#l14.417"></a><span id="l14.417"> async function onAccept() {</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-  if (gUpdateAllowed &amp;&amp; gAcceptanceRadio.value != gOriginalAcceptance) {</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-    enableRefresh();</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineplus">+  if (gModePersonal) {</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+    if (gUpdateAllowed &amp;&amp; gPersonalRadio.value != gOriginalPersonal) {</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+      enableRefresh();</span>
<a href="#l14.423"></a><span id="l14.423"> </span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-    const cApi = EnigmailCryptoAPI();</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-    cApi.sync(</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-      PgpSqliteDb2.updateAcceptance(</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+      if (gPersonalRadio.value == &quot;personal&quot;) {</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+        await PgpSqliteDb2.acceptAsPersonalKey(gFingerprint);</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+      } else {</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineplus">+        await PgpSqliteDb2.deletePersonalKeyAcceptance(gFingerprint);</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+      }</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+    }</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+  } else if (gUpdateAllowed) {</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+    if (gAcceptanceRadio.value != gOriginalAcceptance) {</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+      enableRefresh();</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+      await PgpSqliteDb2.updateAcceptance(</span>
<a href="#l14.438"></a><span id="l14.438">         gFingerprint,</span>
<a href="#l14.439"></a><span id="l14.439">         gAllEmails,</span>
<a href="#l14.440"></a><span id="l14.440">         gAcceptanceRadio.value</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineminus">-      )</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineminus">-    );</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+      );</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+    }</span>
<a href="#l14.445"></a><span id="l14.445">   }</span>
<a href="#l14.446"></a><span id="l14.446">   return true;</span>
<a href="#l14.447"></a><span id="l14.447"> }</span>
<a href="#l14.448"></a><span id="l14.448"> </span>
<a href="#l14.449"></a><span id="l14.449"> document.addEventListener(&quot;dialogaccept&quot;, async function(event) {</span>
<a href="#l14.450"></a><span id="l14.450">   let result = await onAccept();</span>
<a href="#l14.451"></a><span id="l14.451">   if (!result) {</span>
<a href="#l14.452"></a><span id="l14.452">     event.preventDefault();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -12,17 +12,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &lt;!DOCTYPE window [</span>
<a href="#l15.5"></a><span id="l15.5"> &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l15.6"></a><span id="l15.6"> %brandDTD;</span>
<a href="#l15.7"></a><span id="l15.7"> ]&gt;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> &lt;window data-l10n-id=&quot;openpgp-key-details-title&quot;</span>
<a href="#l15.10"></a><span id="l15.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l15.11"></a><span id="l15.11">         xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        style=&quot;width:60em;&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        style=&quot;min-width:60em; max-width:90em; min-height:40em&quot;</span>
<a href="#l15.14"></a><span id="l15.14">         persist=&quot;width height&quot;</span>
<a href="#l15.15"></a><span id="l15.15">         onload=&quot;onLoad();&quot;&gt;</span>
<a href="#l15.16"></a><span id="l15.16"> &lt;dialog id=&quot;enigmailKeyDetailsDlg&quot;</span>
<a href="#l15.17"></a><span id="l15.17">         buttons=&quot;accept&quot;</span>
<a href="#l15.18"></a><span id="l15.18">         data-l10n-id=&quot;openpgp-card-details-close-window-label&quot;&gt;</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/enigmailCommon.js&quot;/&gt;</span>
<a href="#l15.21"></a><span id="l15.21">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/keyDetailsDlg.js&quot;/&gt;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -87,31 +87,37 @@</span>
<a href="#l15.23"></a><span id="l15.23">     &lt;tabs id=&quot;mainTabBox&quot;&gt;</span>
<a href="#l15.24"></a><span id="l15.24">       &lt;tab id=&quot;acceptanceTab&quot; data-l10n-id=&quot;openpgp-acceptance-label&quot;/&gt;</span>
<a href="#l15.25"></a><span id="l15.25">       &lt;tab id=&quot;signaturesTab&quot; data-l10n-id=&quot;openpgp-key-details-signatures-tab&quot;/&gt;</span>
<a href="#l15.26"></a><span id="l15.26">       &lt;tab id=&quot;structureTab&quot; data-l10n-id=&quot;openpgp-key-details-structure-tab&quot;/&gt;</span>
<a href="#l15.27"></a><span id="l15.27">     &lt;/tabs&gt;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">     &lt;tabpanels flex=&quot;1&quot; id=&quot;mainTabPanel&quot;&gt;</span>
<a href="#l15.30"></a><span id="l15.30">        &lt;!-- Acceptance Tab --&gt;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-      &lt;vbox id=&quot;acceptancePanel&quot;&gt;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-        &lt;description id=&quot;acceptanceIntro&quot;/&gt;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+      &lt;vbox id=&quot;acceptancePanel&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+        &lt;description id=&quot;acceptanceIntro1&quot;/&gt;</span>
<a href="#l15.35"></a><span id="l15.35">         &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-        &lt;description id=&quot;acceptanceExplanation&quot;/&gt;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+        &lt;description id=&quot;acceptanceIntro2&quot;/&gt;</span>
<a href="#l15.38"></a><span id="l15.38">         &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.39"></a><span id="l15.39">         &lt;radiogroup id=&quot;acceptanceRadio&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l15.40"></a><span id="l15.40">           &lt;radio id=&quot;acceptRejected&quot; value=&quot;rejected&quot;</span>
<a href="#l15.41"></a><span id="l15.41">                  data-l10n-id=&quot;openpgp-acceptance-rejected-label&quot;/&gt;</span>
<a href="#l15.42"></a><span id="l15.42">           &lt;radio id=&quot;acceptUndecided&quot; value=&quot;undecided&quot;</span>
<a href="#l15.43"></a><span id="l15.43">                  data-l10n-id=&quot;openpgp-acceptance-undecided-label&quot;/&gt;</span>
<a href="#l15.44"></a><span id="l15.44">           &lt;radio id=&quot;acceptUnverified&quot; value=&quot;unverified&quot;</span>
<a href="#l15.45"></a><span id="l15.45">                  data-l10n-id=&quot;openpgp-acceptance-unverified-label&quot;/&gt;</span>
<a href="#l15.46"></a><span id="l15.46">           &lt;radio id=&quot;acceptVerified&quot; value=&quot;verified&quot;</span>
<a href="#l15.47"></a><span id="l15.47">                  data-l10n-id=&quot;openpgp-acceptance-verified-label&quot;/&gt;</span>
<a href="#l15.48"></a><span id="l15.48">         &lt;/radiogroup&gt;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+        &lt;radiogroup id=&quot;personalRadio&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+          &lt;radio id=&quot;notPersonal&quot; value=&quot;not_personal&quot;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+                 data-l10n-id=&quot;openpgp-personal-no-label&quot;/&gt;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+          &lt;radio id=&quot;yesPersonal&quot; value=&quot;personal&quot;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+                 data-l10n-id=&quot;openpgp-personal-yes-label&quot;/&gt;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+        &lt;/radiogroup&gt;</span>
<a href="#l15.55"></a><span id="l15.55">       &lt;/vbox&gt;</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">       &lt;!-- certifications tab --&gt;</span>
<a href="#l15.58"></a><span id="l15.58">       &lt;vbox id=&quot;signaturesPanel&quot;&gt;</span>
<a href="#l15.59"></a><span id="l15.59">         &lt;tree id=&quot;signatures_tree&quot; flex=&quot;1&quot;</span>
<a href="#l15.60"></a><span id="l15.60">               hidecolumnpicker=&quot;true&quot;</span>
<a href="#l15.61"></a><span id="l15.61">               ondblclick=&quot;sigHandleDblClick(event)&quot;&gt;</span>
<a href="#l15.62"></a><span id="l15.62"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/oneRecipientStatus.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/oneRecipientStatus.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -13,16 +13,19 @@ var { EnigmailWindows } = ChromeUtils.im</span>
<a href="#l16.4"></a><span id="l16.4">   &quot;chrome://openpgp/content/modules/windows.jsm&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> );</span>
<a href="#l16.6"></a><span id="l16.6"> var { EnigmailKey } = ChromeUtils.import(</span>
<a href="#l16.7"></a><span id="l16.7">   &quot;chrome://openpgp/content/modules/key.jsm&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> );</span>
<a href="#l16.9"></a><span id="l16.9"> var KeyLookupHelper = ChromeUtils.import(</span>
<a href="#l16.10"></a><span id="l16.10">   &quot;chrome://openpgp/content/modules/keyLookupHelper.jsm&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> ).KeyLookupHelper;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+const { PgpSqliteDb2 } = ChromeUtils.import(</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+);</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> var gListBox;</span>
<a href="#l16.17"></a><span id="l16.17"> var gViewButton;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> var gAddr;</span>
<a href="#l16.20"></a><span id="l16.20"> var gRowToKey = [];</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22"> async function setListEntries(keys = null) {</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineat">@@ -38,17 +41,21 @@ async function setListEntries(keys = nul</span>
<a href="#l16.24"></a><span id="l16.24">     let keyId = document.createXULElement(&quot;label&quot;);</span>
<a href="#l16.25"></a><span id="l16.25">     keyId.setAttribute(&quot;value&quot;, &quot;0x&quot; + keyObj.keyId);</span>
<a href="#l16.26"></a><span id="l16.26">     keyId.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l16.27"></a><span id="l16.27">     keyId.setAttribute(&quot;style&quot;, &quot;width: var(--keyWidth)&quot;);</span>
<a href="#l16.28"></a><span id="l16.28">     listitem.appendChild(keyId);</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30">     let acceptanceText;</span>
<a href="#l16.31"></a><span id="l16.31">     if (keyObj.secretAvailable) {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-      acceptanceText = &quot;openpgp-key-own&quot;;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+      if (await PgpSqliteDb2.isAcceptedAsPersonalKey(keyObj.fpr)) {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+        acceptanceText = &quot;openpgp-key-own&quot;;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+      } else {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+        acceptanceText = &quot;openpgp-key-secret-not-personal&quot;;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+      }</span>
<a href="#l16.38"></a><span id="l16.38">     } else {</span>
<a href="#l16.39"></a><span id="l16.39">       if (!(&quot;acceptance&quot; in keyObj)) {</span>
<a href="#l16.40"></a><span id="l16.40">         throw new Error(</span>
<a href="#l16.41"></a><span id="l16.41">           &quot;expected getMultValidKeysForMultRecipients to set acceptance&quot;</span>
<a href="#l16.42"></a><span id="l16.42">         );</span>
<a href="#l16.43"></a><span id="l16.43">       }</span>
<a href="#l16.44"></a><span id="l16.44">       switch (keyObj.acceptance) {</span>
<a href="#l16.45"></a><span id="l16.45">         case &quot;rejected&quot;:</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

