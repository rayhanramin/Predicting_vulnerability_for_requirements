<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26086:9f651d2726f2238eb10d2868ed31f24383fb935c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9f651d2726f2238eb10d2868ed31f24383fb935c" />
<meta property="og:url" content="/comm-central/rev/9f651d2726f2238eb10d2868ed31f24383fb935c" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/test/fakeserver; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9f651d2726f2238eb10d2868ed31f24383fb935c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9f651d2726f2238eb10d2868ed31f24383fb935c">shortlog</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9f651d2726f2238eb10d2868ed31f24383fb935c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c">files</a> |
changeset |
<a href="/comm-central/raw-rev/9f651d2726f2238eb10d2868ed31f24383fb935c">raw</a>  | <a href="/comm-central/archive/9f651d2726f2238eb10d2868ed31f24383fb935c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/test/fakeserver; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 14 Mar 2019 17:56:11 +1300</td></tr>

<tr>
 <td>changeset 26086</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9f651d2726f2238eb10d2868ed31f24383fb935c">9f651d2726f2238eb10d2868ed31f24383fb935c</a></td>
</tr>



<tr>
<td>parent 26085</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f1acfe40ebd1df59ffb0c6cc0b55cdce17db79dd">f1acfe40ebd1df59ffb0c6cc0b55cdce17db79dd</a>
</td>
</tr>

<tr>
<td>child 26087</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/706bbea02e7dca0de00183d752fb29c1eff7fad9">706bbea02e7dca0de00183d752fb29c1eff7fad9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9f651d2726f2238eb10d2868ed31f24383fb935c">15660</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Thu, 14 Mar 2019 04:56:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9f651d2726f2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9f651d2726f2238eb10d2868ed31f24383fb935c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9f651d2726f2238eb10d2868ed31f24383fb935c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9f651d2726f2238eb10d2868ed31f24383fb935c&newProject=comm-central&newRevision=9f651d2726f2238eb10d2868ed31f24383fb935c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9f651d2726f2238eb10d2868ed31f24383fb935c&newProject=comm-central&newRevision=9f651d2726f2238eb10d2868ed31f24383fb935c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9f651d2726f2238eb10d2868ed31f24383fb935c&newProject=comm-central&newRevision=9f651d2726f2238eb10d2868ed31f24383fb935c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/test/fakeserver; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/.eslintignore">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/.eslintignore">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/.eslintignore">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/.eslintignore">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/auth.js">mailnews/test/fakeserver/auth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/auth.js">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/auth.js">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/auth.js">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/auth.js">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/auth.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/maild.js">mailnews/test/fakeserver/maild.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/maild.js">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/maild.js">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/maild.js">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/maild.js">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/maild.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/nntpd.js">mailnews/test/fakeserver/nntpd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/nntpd.js">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/nntpd.js">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/nntpd.js">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/nntpd.js">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/nntpd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/pop3d.js">mailnews/test/fakeserver/pop3d.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/pop3d.js">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/pop3d.js">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/pop3d.js">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/pop3d.js">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/pop3d.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/smtpd.js">mailnews/test/fakeserver/smtpd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/smtpd.js">file</a> |
<a href="/comm-central/annotate/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/smtpd.js">annotate</a> |
<a href="/comm-central/diff/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/smtpd.js">diff</a> |
<a href="/comm-central/comparison/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/smtpd.js">comparison</a> |
<a href="/comm-central/log/9f651d2726f2238eb10d2868ed31f24383fb935c/mailnews/test/fakeserver/smtpd.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -39,17 +39,16 @@ mailnews/base/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/build/*</span>
<a href="#l1.5"></a><span id="l1.5"> mailnews/compose/*</span>
<a href="#l1.6"></a><span id="l1.6"> mailnews/db/*</span>
<a href="#l1.7"></a><span id="l1.7"> mailnews/imap/*</span>
<a href="#l1.8"></a><span id="l1.8"> mailnews/import/*</span>
<a href="#l1.9"></a><span id="l1.9"> mailnews/intl/*</span>
<a href="#l1.10"></a><span id="l1.10"> mailnews/jsaccount/*</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/mime/*</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/test/fakeserver/*</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> # mailnews/extensions exclusions</span>
<a href="#l1.15"></a><span id="l1.15"> mailnews/extensions/*</span>
<a href="#l1.16"></a><span id="l1.16"> !mailnews/extensions/newsblog</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> # mail exclusions</span>
<a href="#l1.19"></a><span id="l1.19"> mail/app/profile/all-thunderbird.js</span>
<a href="#l1.20"></a><span id="l1.20"> mail/app/profile/channel-prefs.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/test/fakeserver/auth.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/test/fakeserver/auth.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -11,32 +11,32 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * In fact, you could use this to implement a real server in JS :-) .</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * @author Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l2.7"></a><span id="l2.7">  */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> var EXPORTED_SYMBOLS = [</span>
<a href="#l2.10"></a><span id="l2.10">   &quot;AuthPLAIN&quot;,</span>
<a href="#l2.11"></a><span id="l2.11">   &quot;AuthLOGIN&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  &quot;AuthCRAM&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  &quot;AuthCRAM&quot;,</span>
<a href="#l2.14"></a><span id="l2.14"> ];</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> /**</span>
<a href="#l2.17"></a><span id="l2.17">  * Implements AUTH PLAIN</span>
<a href="#l2.18"></a><span id="l2.18">  * @see RFC 4616</span>
<a href="#l2.19"></a><span id="l2.19">  */</span>
<a href="#l2.20"></a><span id="l2.20"> var AuthPLAIN = {</span>
<a href="#l2.21"></a><span id="l2.21">   /**</span>
<a href="#l2.22"></a><span id="l2.22">    * Takes full PLAIN auth line, and decodes it.</span>
<a href="#l2.23"></a><span id="l2.23">    *</span>
<a href="#l2.24"></a><span id="l2.24">    * @param line {String}</span>
<a href="#l2.25"></a><span id="l2.25">    * @returns {Object { username : value, password : value } }</span>
<a href="#l2.26"></a><span id="l2.26">    * @throws {String}   error to return to client</span>
<a href="#l2.27"></a><span id="l2.27">    */</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  decodeLine: function(line) {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  decodeLine(line) {</span>
<a href="#l2.30"></a><span id="l2.30">     dump(&quot;AUTH PLAIN line -&quot; + line + &quot;-\n&quot;);</span>
<a href="#l2.31"></a><span id="l2.31">     line = atob(line); // base64 decode</span>
<a href="#l2.32"></a><span id="l2.32">     let aap = line.split(&quot;\u0000&quot;); // 0-charater is delimiter</span>
<a href="#l2.33"></a><span id="l2.33">     if (aap.length != 3)</span>
<a href="#l2.34"></a><span id="l2.34">       throw &quot;Expected three parts&quot;;</span>
<a href="#l2.35"></a><span id="l2.35">     /* aap is: authorize-id, authenticate-id, password.</span>
<a href="#l2.36"></a><span id="l2.36">        Generally, authorize-id = authenticate-id = username.</span>
<a href="#l2.37"></a><span id="l2.37">        authorize-id may thus be empty and then defaults to authenticate-id. */</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineat">@@ -49,35 +49,34 @@ var AuthPLAIN = {</span>
<a href="#l2.39"></a><span id="l2.39">       throw &quot;Expecting a authorize-id that's either the same as authenticate-id or empty&quot;;</span>
<a href="#l2.40"></a><span id="l2.40">     return result;</span>
<a href="#l2.41"></a><span id="l2.41">   },</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   /**</span>
<a href="#l2.44"></a><span id="l2.44">    * Create an AUTH PLAIN line, to allow a client to authenticate to a server.</span>
<a href="#l2.45"></a><span id="l2.45">    * Useful for tests.</span>
<a href="#l2.46"></a><span id="l2.46">    */</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  encodeLine : function(username, password)</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  encodeLine(username, password) {</span>
<a href="#l2.50"></a><span id="l2.50">     username = username.substring(0, 255);</span>
<a href="#l2.51"></a><span id="l2.51">     password = password.substring(0, 255);</span>
<a href="#l2.52"></a><span id="l2.52">     return btoa(&quot;\u0000&quot; + username + &quot;\u0000&quot; + password); // base64 encode</span>
<a href="#l2.53"></a><span id="l2.53">   },</span>
<a href="#l2.54"></a><span id="l2.54"> };</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56"> var AuthLOGIN = {</span>
<a href="#l2.57"></a><span id="l2.57">   /**</span>
<a href="#l2.58"></a><span id="l2.58">    * Takes full LOGIN auth line, and decodes it.</span>
<a href="#l2.59"></a><span id="l2.59">    * It may contain either username or password,</span>
<a href="#l2.60"></a><span id="l2.60">    * depending on state/step (first username, then pw).</span>
<a href="#l2.61"></a><span id="l2.61">    *</span>
<a href="#l2.62"></a><span id="l2.62">    * @param line {String}</span>
<a href="#l2.63"></a><span id="l2.63">    * @returns {String}   username or password</span>
<a href="#l2.64"></a><span id="l2.64">    * @throws {String}   error to return to client</span>
<a href="#l2.65"></a><span id="l2.65">    */</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-  decodeLine: function (line) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  decodeLine(line) {</span>
<a href="#l2.68"></a><span id="l2.68">     dump(&quot;AUTH LOGIN -&quot; + atob(line) + &quot;-\n&quot;);</span>
<a href="#l2.69"></a><span id="l2.69">     return atob(line); // base64 decode</span>
<a href="#l2.70"></a><span id="l2.70">   },</span>
<a href="#l2.71"></a><span id="l2.71"> };</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73"> /**</span>
<a href="#l2.74"></a><span id="l2.74">   * Implements AUTH CRAM-MD5</span>
<a href="#l2.75"></a><span id="l2.75">   * @see RFC 2195, RFC 2104</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineat">@@ -91,58 +90,55 @@ var AuthCRAM = {</span>
<a href="#l2.77"></a><span id="l2.77">    *</span>
<a href="#l2.78"></a><span id="l2.78">    * You need to store it, you'll need it to check the client response.</span>
<a href="#l2.79"></a><span id="l2.79">    *</span>
<a href="#l2.80"></a><span id="l2.80">    * @param domain {String}   Your hostname or domain,</span>
<a href="#l2.81"></a><span id="l2.81">    *    e.g. &quot;example.com&quot;, &quot;mx.example.com&quot; or just &quot;localhost&quot;.</span>
<a href="#l2.82"></a><span id="l2.82">    * @returns {String}   The challenge.</span>
<a href="#l2.83"></a><span id="l2.83">    *   It's already base64-encoded. Send it as-is to the client.</span>
<a href="#l2.84"></a><span id="l2.84">    */</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  createChallenge : function(domain)</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  createChallenge(domain) {</span>
<a href="#l2.88"></a><span id="l2.88">     var timestamp = new Date().getTime(); // unixtime</span>
<a href="#l2.89"></a><span id="l2.89">     var challenge = &quot;&lt;&quot; + timestamp + &quot;@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l2.90"></a><span id="l2.90">     dump(&quot;CRAM challenge unencoded: &quot; + challenge + &quot;\n&quot;);</span>
<a href="#l2.91"></a><span id="l2.91">     return btoa(challenge);</span>
<a href="#l2.92"></a><span id="l2.92">   },</span>
<a href="#l2.93"></a><span id="l2.93">   /**</span>
<a href="#l2.94"></a><span id="l2.94">    * Takes full CRAM-MD5 auth line, and decodes it.</span>
<a href="#l2.95"></a><span id="l2.95">    *</span>
<a href="#l2.96"></a><span id="l2.96">    * Compare the returned |digest| to the result of</span>
<a href="#l2.97"></a><span id="l2.97">    * encodeCRAMMD5(). If they match, the |username|</span>
<a href="#l2.98"></a><span id="l2.98">    * returned here is authenticated.</span>
<a href="#l2.99"></a><span id="l2.99">    *</span>
<a href="#l2.100"></a><span id="l2.100">    * @param line {String}</span>
<a href="#l2.101"></a><span id="l2.101">    * @returns {Object { username : value, digest : value } }</span>
<a href="#l2.102"></a><span id="l2.102">    * @throws {String}   error to return to client</span>
<a href="#l2.103"></a><span id="l2.103">    */</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  decodeLine : function(line)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-  {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  decodeLine(line) {</span>
<a href="#l2.107"></a><span id="l2.107">     dump(&quot;AUTH CRAM-MD5 line -&quot; + line + &quot;-\n&quot;);</span>
<a href="#l2.108"></a><span id="l2.108">     line = atob(line);</span>
<a href="#l2.109"></a><span id="l2.109">     dump(&quot;base64 decoded -&quot; + line + &quot;-\n&quot;);</span>
<a href="#l2.110"></a><span id="l2.110">     var sp = line.split(&quot; &quot;);</span>
<a href="#l2.111"></a><span id="l2.111">     if (sp.length != 2)</span>
<a href="#l2.112"></a><span id="l2.112">       throw &quot;Expected one space&quot;;</span>
<a href="#l2.113"></a><span id="l2.113">     var result = {};</span>
<a href="#l2.114"></a><span id="l2.114">     result.username = sp[0];</span>
<a href="#l2.115"></a><span id="l2.115">     result.digest = sp[1];</span>
<a href="#l2.116"></a><span id="l2.116">     return result;</span>
<a href="#l2.117"></a><span id="l2.117">   },</span>
<a href="#l2.118"></a><span id="l2.118">   /**</span>
<a href="#l2.119"></a><span id="l2.119">    * @param text {String}   server challenge (base64-encoded)</span>
<a href="#l2.120"></a><span id="l2.120">    * @param key {String}   user's password</span>
<a href="#l2.121"></a><span id="l2.121">    * @return {String}   digest as hex string</span>
<a href="#l2.122"></a><span id="l2.122">    */</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-  encodeCRAMMD5 : function(text, key)</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-  {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  encodeCRAMMD5(text, key) {</span>
<a href="#l2.126"></a><span id="l2.126">     text = atob(text); // createChallenge() returns it already encoded</span>
<a href="#l2.127"></a><span id="l2.127">     dump(&quot;encodeCRAMMD5(text: -&quot; + text + &quot;-, key: -&quot; + key + &quot;-)\n&quot;);</span>
<a href="#l2.128"></a><span id="l2.128">     const kInputLen = 64;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-    //const kHashLen = 16;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    // const kHashLen = 16;</span>
<a href="#l2.131"></a><span id="l2.131">     const kInnerPad = 0x36; // per spec</span>
<a href="#l2.132"></a><span id="l2.132">     const kOuterPad = 0x5C;</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134">     key = this.textToNumberArray(key);</span>
<a href="#l2.135"></a><span id="l2.135">     text = this.textToNumberArray(text);</span>
<a href="#l2.136"></a><span id="l2.136">     // Make sure key is exactly kDigestLen bytes long. Algo per spec.</span>
<a href="#l2.137"></a><span id="l2.137">     if (key.length &gt; kInputLen)</span>
<a href="#l2.138"></a><span id="l2.138">       key = this.md5(key); // (results in kHashLen)</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineat">@@ -151,43 +147,38 @@ var AuthCRAM = {</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141">     // MD5((key XOR outerpad) + MD5((key XOR innerpad) + text)) , per spec</span>
<a href="#l2.142"></a><span id="l2.142">     var digest = this.md5(this.xor(key, kOuterPad)</span>
<a href="#l2.143"></a><span id="l2.143">          .concat(this.md5(this.xor(key, kInnerPad)</span>
<a href="#l2.144"></a><span id="l2.144">          .concat(text))));</span>
<a href="#l2.145"></a><span id="l2.145">     return this.arrayToHexString(digest);</span>
<a href="#l2.146"></a><span id="l2.146">   },</span>
<a href="#l2.147"></a><span id="l2.147">   // Utils</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-  xor : function(binary, value)</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-  {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  xor(binary, value) {</span>
<a href="#l2.151"></a><span id="l2.151">     var result = [];</span>
<a href="#l2.152"></a><span id="l2.152">     for (var i = 0; i &lt; binary.length; i++)</span>
<a href="#l2.153"></a><span id="l2.153">       result.push(binary[i] ^ value);</span>
<a href="#l2.154"></a><span id="l2.154">     return result;</span>
<a href="#l2.155"></a><span id="l2.155">   },</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-  md5 : function(binary)</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-  {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+  md5(binary) {</span>
<a href="#l2.159"></a><span id="l2.159">     var md5 = Cc[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l2.160"></a><span id="l2.160">         .createInstance(Ci.nsICryptoHash);</span>
<a href="#l2.161"></a><span id="l2.161">     md5.init(Ci.nsICryptoHash.MD5);</span>
<a href="#l2.162"></a><span id="l2.162">     md5.update(binary, binary.length);</span>
<a href="#l2.163"></a><span id="l2.163">     return this.textToNumberArray(md5.finish(false));</span>
<a href="#l2.164"></a><span id="l2.164">   },</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-  textToNumberArray : function(text)</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-  {</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  textToNumberArray(text) {</span>
<a href="#l2.168"></a><span id="l2.168">     var array = [];</span>
<a href="#l2.169"></a><span id="l2.169">     for (var i = 0; i &lt; text.length; i++)</span>
<a href="#l2.170"></a><span id="l2.170">       array.push(text.charCodeAt(i) &amp; 0xFF); // convert string (only lower byte) to array</span>
<a href="#l2.171"></a><span id="l2.171">     return array;</span>
<a href="#l2.172"></a><span id="l2.172">   },</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-  arrayToHexString : function(binary)</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-  {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  arrayToHexString(binary) {</span>
<a href="#l2.176"></a><span id="l2.176">     var result = &quot;&quot;;</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    for (var i = 0; i &lt; binary.length; i++)</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-    {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+    for (var i = 0; i &lt; binary.length; i++) {</span>
<a href="#l2.180"></a><span id="l2.180">       if (binary[i] &gt; 255)</span>
<a href="#l2.181"></a><span id="l2.181">         throw &quot;unexpected that value &gt; 255&quot;;</span>
<a href="#l2.182"></a><span id="l2.182">       let hex = binary[i].toString(16);</span>
<a href="#l2.183"></a><span id="l2.183">       if (hex.length &lt; 2)</span>
<a href="#l2.184"></a><span id="l2.184">         hex = &quot;0&quot; + hex;</span>
<a href="#l2.185"></a><span id="l2.185">       result += hex;</span>
<a href="#l2.186"></a><span id="l2.186">     }</span>
<a href="#l2.187"></a><span id="l2.187">     return result;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,176 +1,173 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> // This file implements test IMAP servers</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> var EXPORTED_SYMBOLS = [</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-  'imapDaemon',</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-  'imapMailbox',</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  'imapMessage',</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  'IMAP_RFC3501_handler',</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  'configurations',</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  'mixinExtension',</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  'IMAP_GMAIL_extension',</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  'IMAP_MOVE_extension',</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  'IMAP_CUSTOM_extension',</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  'IMAP_RFC2197_extension',</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  'IMAP_RFC2342_extension',</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  'IMAP_RFC3348_extension',</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-  'IMAP_RFC4315_extension',</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  'IMAP_RFC5258_extension',</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  'IMAP_RFC2195_extension'</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  &quot;imapDaemon&quot;,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  &quot;imapMailbox&quot;,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  &quot;imapMessage&quot;,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  &quot;IMAP_RFC3501_handler&quot;,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  &quot;configurations&quot;,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  &quot;mixinExtension&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  &quot;IMAP_GMAIL_extension&quot;,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  &quot;IMAP_MOVE_extension&quot;,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  &quot;IMAP_CUSTOM_extension&quot;,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  &quot;IMAP_RFC2197_extension&quot;,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  &quot;IMAP_RFC2342_extension&quot;,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  &quot;IMAP_RFC3348_extension&quot;,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  &quot;IMAP_RFC4315_extension&quot;,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  &quot;IMAP_RFC5258_extension&quot;,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  &quot;IMAP_RFC2195_extension&quot;,</span>
<a href="#l3.40"></a><span id="l3.40"> ];</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-//                          IMAP DAEMON ORGANIZATION                          //</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-// The large numbers of RFCs all induce some implicit assumptions as to the   //</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-// organization of an IMAP server. Ideally, we'd like to be as inclusive as   //</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-// possible so that we can guarantee that it works for every type of server.  //</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-// Unfortunately, such all-accepting setups make generic algorithms hard to   //</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-// use; given their difficulty in a generic framework, it seems unlikely that //</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-// a server would implement such characteristics. It also seems likely that   //</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-// if mailnews had a problem with the implementation, then most clients would //</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-// see similar problems, so as to make the server widely unusable. In any     //</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-// case, if someone complains about not working on bugzilla, it can be added  //</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-// to the test suite.                                                         //</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-// So, with that in mind, this is the basic layout of the daemon:             //</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-// DAEMON                                                                     //</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-// + Namespaces: parentless mailboxes whose names are the namespace name. The //</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-//     type of the namespace is specified by the type attribute.              //</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-// + Mailboxes: imapMailbox objects with several properties. If a mailbox     //</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-// | |   property begins with a '_', then it should not be serialized because //</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-// | |   it can be discovered from other means; in particular, a '_' does not //</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-// | |   necessarily mean that it is a private property that should not be    //</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-// | |   accessed. The parent of a top-level mailbox is null, not &quot;&quot;.         //</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-// | + I18N names: RFC 3501 specifies a modified UTF-7 form for names.        //</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-// | |     However, a draft RFC makes the names UTF-8; it is expected to be   //</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-// | |     completed and implemented &quot;soon&quot;. Therefore, the correct usage is  //</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-// | |     to specify the mailbox names as one normally does in JS and the    //</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-// | |     protocol will take care of conversion itself.                      //</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-// | + Case-sensitivity: RFC 3501 takes no position on this issue, only that  //</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-// | |     a case-insensitive server must treat the base-64 parts of mailbox  //</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-// | |     names as case-sensitive. The draft UTF8 RFC says nothing on this   //</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-// | |     topic, but Crispin recommends using Unicode case-insensitivity. We //</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-// | |     therefore treat names in such manner (if the case-insensitive flag //</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-// | |     is set), in technical violation of RFC 3501.                       //</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-// | + Flags: Flags are (as confirmed by Crispin) case-insensitive. Internal  //</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-// |       flag equality, though, uses case-sensitive checks. Therefore they  //</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-// |       should be normalized to a title-case form (e.g., \Noselect).       //</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-// + Synchronization: On certain synchronizing commands, the daemon will call //</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-// |   a synchronizing function to allow manipulating code the chance to      //</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-// |   perform various (potentially expensive) actions.                       //</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-// + Messages: A message is represented internally as an annotated URI.       //</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+// IMAP DAEMON ORGANIZATION</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+// ------------------------</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+// The large numbers of RFCs all induce some implicit assumptions as to the</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+// organization of an IMAP server. Ideally, we'd like to be as inclusive as</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+// possible so that we can guarantee that it works for every type of server.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+// Unfortunately, such all-accepting setups make generic algorithms hard to</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+// use; given their difficulty in a generic framework, it seems unlikely that</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+// a server would implement such characteristics. It also seems likely that</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+// if mailnews had a problem with the implementation, then most clients would</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+// see similar problems, so as to make the server widely unusable. In any</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+// case, if someone complains about not working on bugzilla, it can be added</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+// to the test suite.</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+// So, with that in mind, this is the basic layout of the daemon:</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+// DAEMON</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+// + Namespaces: parentless mailboxes whose names are the namespace name. The</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+//     type of the namespace is specified by the type attribute.</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+// + Mailboxes: imapMailbox objects with several properties. If a mailbox</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+// | |   property begins with a '_', then it should not be serialized because</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+// | |   it can be discovered from other means; in particular, a '_' does not</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+// | |   necessarily mean that it is a private property that should not be</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+// | |   accessed. The parent of a top-level mailbox is null, not &quot;&quot;.</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+// | + I18N names: RFC 3501 specifies a modified UTF-7 form for names.</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+// | |     However, a draft RFC makes the names UTF-8; it is expected to be</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+// | |     completed and implemented &quot;soon&quot;. Therefore, the correct usage is</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+// | |     to specify the mailbox names as one normally does in JS and the</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+// | |     protocol will take care of conversion itself.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+// | + Case-sensitivity: RFC 3501 takes no position on this issue, only that</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+// | |     a case-insensitive server must treat the base-64 parts of mailbox</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+// | |     names as case-sensitive. The draft UTF8 RFC says nothing on this</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+// | |     topic, but Crispin recommends using Unicode case-insensitivity. We</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+// | |     therefore treat names in such manner (if the case-insensitive flag</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+// | |     is set), in technical violation of RFC 3501.</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+// | + Flags: Flags are (as confirmed by Crispin) case-insensitive. Internal</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+// |       flag equality, though, uses case-sensitive checks. Therefore they</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+// |       should be normalized to a title-case form (e.g., \Noselect).</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+// + Synchronization: On certain synchronizing commands, the daemon will call</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+// |   a synchronizing function to allow manipulating code the chance to</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+// |   perform various (potentially expensive) actions.</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+// + Messages: A message is represented internally as an annotated URI.</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.124"></a><span id="l3.124"> const {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l3.125"></a><span id="l3.125"> var {</span>
<a href="#l3.126"></a><span id="l3.126">   AuthPLAIN,</span>
<a href="#l3.127"></a><span id="l3.127">   AuthLOGIN,</span>
<a href="#l3.128"></a><span id="l3.128">   AuthCRAM,</span>
<a href="#l3.129"></a><span id="l3.129"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/auth.js&quot;);</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131"> function imapDaemon(flags, syncFunc) {</span>
<a href="#l3.132"></a><span id="l3.132">   this._flags = flags;</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134">   this.namespaces = [];</span>
<a href="#l3.135"></a><span id="l3.135">   this.idResponse = &quot;NIL&quot;;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-  this.root = new imapMailbox(&quot;&quot;, null, {type : IMAP_NAMESPACE_PERSONAL});</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-  this.uidvalidity = Math.round(Date.now()/1000);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  this.root = new imapMailbox(&quot;&quot;, null, {type: IMAP_NAMESPACE_PERSONAL});</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  this.uidvalidity = Math.round(Date.now() / 1000);</span>
<a href="#l3.140"></a><span id="l3.140">   this.inbox = new imapMailbox(&quot;INBOX&quot;, null, this.uidvalidity++);</span>
<a href="#l3.141"></a><span id="l3.141">   this.root.addMailbox(this.inbox);</span>
<a href="#l3.142"></a><span id="l3.142">   this.namespaces.push(this.root);</span>
<a href="#l3.143"></a><span id="l3.143">   this.syncFunc = syncFunc;</span>
<a href="#l3.144"></a><span id="l3.144">   // This can be used to cause the artificial failure of any given command.</span>
<a href="#l3.145"></a><span id="l3.145">   this.commandToFail = &quot;&quot;;</span>
<a href="#l3.146"></a><span id="l3.146">   // This can be used to simulate timeouts on large copies</span>
<a href="#l3.147"></a><span id="l3.147">   this.copySleep = 0;</span>
<a href="#l3.148"></a><span id="l3.148"> }</span>
<a href="#l3.149"></a><span id="l3.149"> imapDaemon.prototype = {</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-  synchronize : function (mailbox, update) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  synchronize(mailbox, update) {</span>
<a href="#l3.152"></a><span id="l3.152">     if (this.syncFunc)</span>
<a href="#l3.153"></a><span id="l3.153">       this.syncFunc.call(null, this);</span>
<a href="#l3.154"></a><span id="l3.154">     if (update) {</span>
<a href="#l3.155"></a><span id="l3.155">       for (var message of mailbox._messages) {</span>
<a href="#l3.156"></a><span id="l3.156">         message.recent = false;</span>
<a href="#l3.157"></a><span id="l3.157">       }</span>
<a href="#l3.158"></a><span id="l3.158">     }</span>
<a href="#l3.159"></a><span id="l3.159">   },</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-  getNamespace : function (name) {</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  getNamespace(name) {</span>
<a href="#l3.162"></a><span id="l3.162">     for (var namespace of this.namespaces) {</span>
<a href="#l3.163"></a><span id="l3.163">       if (name.indexOf(namespace.name) == 0 &amp;&amp;</span>
<a href="#l3.164"></a><span id="l3.164">           name[namespace.name.length] == namespace.delimiter)</span>
<a href="#l3.165"></a><span id="l3.165">         return namespace;</span>
<a href="#l3.166"></a><span id="l3.166">     }</span>
<a href="#l3.167"></a><span id="l3.167">     return this.root;</span>
<a href="#l3.168"></a><span id="l3.168">   },</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-  createNamespace : function (name, type) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-    var newbox = this.createMailbox(name, {type : type});</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  createNamespace(name, type) {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    var newbox = this.createMailbox(name, {type});</span>
<a href="#l3.173"></a><span id="l3.173">     this.namespaces.push(newbox);</span>
<a href="#l3.174"></a><span id="l3.174">   },</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  getMailbox : function (name) {</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+  getMailbox(name) {</span>
<a href="#l3.177"></a><span id="l3.177">     if (name == &quot;&quot;)</span>
<a href="#l3.178"></a><span id="l3.178">       return this.root;</span>
<a href="#l3.179"></a><span id="l3.179">     // INBOX is case-insensitive, no matter what</span>
<a href="#l3.180"></a><span id="l3.180">     if (name.toUpperCase().startsWith(&quot;INBOX&quot;))</span>
<a href="#l3.181"></a><span id="l3.181">       name = &quot;INBOX&quot; + name.substr(5);</span>
<a href="#l3.182"></a><span id="l3.182">     // We want to find a child who has the same name, but we don't quite know</span>
<a href="#l3.183"></a><span id="l3.183">     // what the delimiter is. The convention is that different namespaces use a</span>
<a href="#l3.184"></a><span id="l3.184">     // name starting with '#', so that's how we'll work it out.</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    if (name.startsWith('#')) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-      var root = null;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-      for (var mailbox of this.root._children) {</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+    let mailbox;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+    if (name.startsWith(&quot;#&quot;)) {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+      for (mailbox of this.root._children) {</span>
<a href="#l3.191"></a><span id="l3.191">         if (mailbox.name.indexOf(name) == 0 &amp;&amp;</span>
<a href="#l3.192"></a><span id="l3.192">             name[mailbox.name.length] == mailbox.delimiter) {</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-          root = mailbox;</span>
<a href="#l3.194"></a><span id="l3.194">           break;</span>
<a href="#l3.195"></a><span id="l3.195">         }</span>
<a href="#l3.196"></a><span id="l3.196">       }</span>
<a href="#l3.197"></a><span id="l3.197">       if (!mailbox)</span>
<a href="#l3.198"></a><span id="l3.198">         return null;</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200">       // Now we continue like normal</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-      var names = name.split(mailbox.delimiter);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+      let names = name.split(mailbox.delimiter);</span>
<a href="#l3.203"></a><span id="l3.203">       names.splice(0, 1);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-      for (var part of names) {</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+      for (let part of names) {</span>
<a href="#l3.206"></a><span id="l3.206">         mailbox = mailbox.getChild(part);</span>
<a href="#l3.207"></a><span id="l3.207">         if (!mailbox || mailbox.nonExistent)</span>
<a href="#l3.208"></a><span id="l3.208">           return null;</span>
<a href="#l3.209"></a><span id="l3.209">       }</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-      return mailbox;</span>
<a href="#l3.211"></a><span id="l3.211">     } else {</span>
<a href="#l3.212"></a><span id="l3.212">       // This is easy, just split it up using the inbox's delimiter</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-      var names = name.split(this.inbox.delimiter);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-      var mailbox = this.root;</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      let names = name.split(this.inbox.delimiter);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+      mailbox = this.root;</span>
<a href="#l3.217"></a><span id="l3.217"> </span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-      for (var part of names) {</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+      for (let part of names) {</span>
<a href="#l3.220"></a><span id="l3.220">         mailbox = mailbox.getChild(part);</span>
<a href="#l3.221"></a><span id="l3.221">         if (!mailbox || mailbox.nonExistent)</span>
<a href="#l3.222"></a><span id="l3.222">           return null;</span>
<a href="#l3.223"></a><span id="l3.223">       }</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-      return mailbox;</span>
<a href="#l3.225"></a><span id="l3.225">     }</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+    return mailbox;</span>
<a href="#l3.227"></a><span id="l3.227">   },</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-  createMailbox : function (name, oldBox) {</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+  createMailbox(name, oldBox) {</span>
<a href="#l3.230"></a><span id="l3.230">     var namespace = this.getNamespace(name);</span>
<a href="#l3.231"></a><span id="l3.231">     if (namespace.name != &quot;&quot;)</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-      name = name.substring(namespace.name.length+1);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+      name = name.substring(namespace.name.length + 1);</span>
<a href="#l3.234"></a><span id="l3.234">     var prefixes = name.split(namespace.delimiter);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    if (prefixes[prefixes.length-1] == '')</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-      var subName = prefixes.splice(prefixes.length - 2, 2)[0];</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+    var subName;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+    if (prefixes[prefixes.length - 1] == &quot;&quot;)</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+      subName = prefixes.splice(prefixes.length - 2, 2)[0];</span>
<a href="#l3.240"></a><span id="l3.240">     else</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-      var subName = prefixes.splice(prefixes.length - 1, 1)[0];</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      subName = prefixes.splice(prefixes.length - 1, 1)[0];</span>
<a href="#l3.243"></a><span id="l3.243">     var box = namespace;</span>
<a href="#l3.244"></a><span id="l3.244">     for (var component of prefixes) {</span>
<a href="#l3.245"></a><span id="l3.245">       box = box.getChild(component);</span>
<a href="#l3.246"></a><span id="l3.246">       // Yes, we won't autocreate intermediary boxes</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-      if (box == null || box.flags.indexOf('\\NoInferiors') != -1)</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+      if (box == null || box.flags.includes(&quot;\\NoInferiors&quot;))</span>
<a href="#l3.249"></a><span id="l3.249">         return false;</span>
<a href="#l3.250"></a><span id="l3.250">     }</span>
<a href="#l3.251"></a><span id="l3.251">     // If this is an imapMailbox...</span>
<a href="#l3.252"></a><span id="l3.252">     if (oldBox &amp;&amp; oldBox._children) {</span>
<a href="#l3.253"></a><span id="l3.253">       // Only delete now so we don't screw ourselves up if creation fails</span>
<a href="#l3.254"></a><span id="l3.254">       this.deleteMailbox(oldBox);</span>
<a href="#l3.255"></a><span id="l3.255">       oldBox._parent = box == this.root ? null : box;</span>
<a href="#l3.256"></a><span id="l3.256">       let newBox = new imapMailbox(subName, box, this.uidvalidity++);</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineat">@@ -182,45 +179,45 @@ imapDaemon.prototype = {</span>
<a href="#l3.258"></a><span id="l3.258">         this.inbox = new imapMailbox(&quot;INBOX&quot;, null, this.uidvalidity++);</span>
<a href="#l3.259"></a><span id="l3.259">         this.root.addMailbox(this.inbox);</span>
<a href="#l3.260"></a><span id="l3.260">       }</span>
<a href="#l3.261"></a><span id="l3.261">       oldBox.name = subName;</span>
<a href="#l3.262"></a><span id="l3.262">     } else if (oldBox) {</span>
<a href="#l3.263"></a><span id="l3.263">       // oldBox is a regular {} object, so it contains mailbox data but is not</span>
<a href="#l3.264"></a><span id="l3.264">       // a mailbox itself. Pass it into the constructor and let that deal with</span>
<a href="#l3.265"></a><span id="l3.265">       // it...</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-      var childBox = new imapMailbox(subName, box == this.root ? null : box,</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-                                     oldBox);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+      let childBox = new imapMailbox(subName, box == this.root ? null : box, oldBox);</span>
<a href="#l3.269"></a><span id="l3.269">       box.addMailbox(childBox);</span>
<a href="#l3.270"></a><span id="l3.270">       // And return the new mailbox, since this is being used by people setting</span>
<a href="#l3.271"></a><span id="l3.271">       // up the daemon.</span>
<a href="#l3.272"></a><span id="l3.272">       return childBox;</span>
<a href="#l3.273"></a><span id="l3.273">     } else {</span>
<a href="#l3.274"></a><span id="l3.274">       var creatable = hasFlag(this._flags, IMAP_FLAG_NEEDS_DELIMITER) ?</span>
<a href="#l3.275"></a><span id="l3.275">                       name[name.length - 1] == namespace.delimiter :</span>
<a href="#l3.276"></a><span id="l3.276">                       true;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-      var childBox = new imapMailbox(subName, box == this.root ? null : box,</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-        { flags : creatable ? [] : ['\\NoInferiors'],</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-          uidvalidity : this.uidvalidity++ });</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+      let childBox = new imapMailbox(subName, box == this.root ? null : box, {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+        flags: creatable ? [] : [&quot;\\NoInferiors&quot;],</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+        uidvalidity: this.uidvalidity++,</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+      });</span>
<a href="#l3.284"></a><span id="l3.284">       box.addMailbox(childBox);</span>
<a href="#l3.285"></a><span id="l3.285">     }</span>
<a href="#l3.286"></a><span id="l3.286">     return true;</span>
<a href="#l3.287"></a><span id="l3.287">   },</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-  deleteMailbox : function (mailbox) {</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+  deleteMailbox(mailbox) {</span>
<a href="#l3.290"></a><span id="l3.290">     if (mailbox._children.length == 0) {</span>
<a href="#l3.291"></a><span id="l3.291">       // We don't preserve the subscribed state for deleted mailboxes</span>
<a href="#l3.292"></a><span id="l3.292">       var parentBox = mailbox._parent == null ? this.root : mailbox._parent;</span>
<a href="#l3.293"></a><span id="l3.293">       parentBox._children.splice(parentBox._children.indexOf(mailbox), 1);</span>
<a href="#l3.294"></a><span id="l3.294">     } else {</span>
<a href="#l3.295"></a><span id="l3.295">       // clear mailbox</span>
<a href="#l3.296"></a><span id="l3.296">       mailbox._messages = [];</span>
<a href="#l3.297"></a><span id="l3.297">       mailbox.flags.push(&quot;\\Noselect&quot;);</span>
<a href="#l3.298"></a><span id="l3.298">     }</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-  }</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-}</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+  },</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+};</span>
<a href="#l3.303"></a><span id="l3.303"> </span>
<a href="#l3.304"></a><span id="l3.304"> function imapMailbox(name, parent, state) {</span>
<a href="#l3.305"></a><span id="l3.305">   this.name = name;</span>
<a href="#l3.306"></a><span id="l3.306">   this._parent = parent;</span>
<a href="#l3.307"></a><span id="l3.307">   this._children = [];</span>
<a href="#l3.308"></a><span id="l3.308">   this._messages = [];</span>
<a href="#l3.309"></a><span id="l3.309">   this._updates = [];</span>
<a href="#l3.310"></a><span id="l3.310"> </span>
<a href="#l3.311"></a><span id="l3.311" class="difflineat">@@ -243,203 +240,206 @@ function imapMailbox(name, parent, state</span>
<a href="#l3.312"></a><span id="l3.312">   this.setDefault(&quot;specialUseFlag&quot;, &quot;&quot;);</span>
<a href="#l3.313"></a><span id="l3.313">   this.setDefault(&quot;uidnext&quot;, 1);</span>
<a href="#l3.314"></a><span id="l3.314">   this.setDefault(&quot;msgflags&quot;, [&quot;\\Seen&quot;, &quot;\\Answered&quot;, &quot;\\Flagged&quot;,</span>
<a href="#l3.315"></a><span id="l3.315">                                &quot;\\Deleted&quot;, &quot;\\Draft&quot;]);</span>
<a href="#l3.316"></a><span id="l3.316">   this.setDefault(&quot;permflags&quot;, [&quot;\\Seen&quot;, &quot;\\Answered&quot;, &quot;\\Flagged&quot;,</span>
<a href="#l3.317"></a><span id="l3.317">                                 &quot;\\Deleted&quot;, &quot;\\Draft&quot;, &quot;\\*&quot;]);</span>
<a href="#l3.318"></a><span id="l3.318"> }</span>
<a href="#l3.319"></a><span id="l3.319"> imapMailbox.prototype = {</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-  setDefault : function(prop, def) {</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+  setDefault(prop, def) {</span>
<a href="#l3.322"></a><span id="l3.322">     this[prop] = prop in this ? this[prop] : def;</span>
<a href="#l3.323"></a><span id="l3.323">   },</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-  addMailbox : function (mailbox) {</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+  addMailbox(mailbox) {</span>
<a href="#l3.326"></a><span id="l3.326">     this._children.push(mailbox);</span>
<a href="#l3.327"></a><span id="l3.327">   },</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-  getChild : function (name) {</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-    var equal;</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+  getChild(name) {</span>
<a href="#l3.331"></a><span id="l3.331">     for (var mailbox of this._children) {</span>
<a href="#l3.332"></a><span id="l3.332">       if (name == mailbox.name)</span>
<a href="#l3.333"></a><span id="l3.333">         return mailbox;</span>
<a href="#l3.334"></a><span id="l3.334">     }</span>
<a href="#l3.335"></a><span id="l3.335">     return null;</span>
<a href="#l3.336"></a><span id="l3.336">   },</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-  matchKids : function (pattern) {</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+  matchKids(pattern) {</span>
<a href="#l3.339"></a><span id="l3.339">     if (pattern == &quot;&quot;)</span>
<a href="#l3.340"></a><span id="l3.340">       return this._parent ? this._parent.matchKids(&quot;&quot;) : [this];</span>
<a href="#l3.341"></a><span id="l3.341"> </span>
<a href="#l3.342"></a><span id="l3.342">     var portions = pattern.split(this.delimiter);</span>
<a href="#l3.343"></a><span id="l3.343">     var matching = [this];</span>
<a href="#l3.344"></a><span id="l3.344">     for (var folder of portions) {</span>
<a href="#l3.345"></a><span id="l3.345">       if (folder.length == 0)</span>
<a href="#l3.346"></a><span id="l3.346">         continue;</span>
<a href="#l3.347"></a><span id="l3.347"> </span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-      let generator = folder.indexOf(&quot;*&quot;) &gt;= 0 ? &quot;allChildren&quot; : &quot;_children&quot;;</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-      let possible = matching.reduce(function (arr, elem) {</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+      let generator = folder.includes(&quot;*&quot;) ? &quot;allChildren&quot; : &quot;_children&quot;;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+      let possible = matching.reduce(function(arr, elem) {</span>
<a href="#l3.352"></a><span id="l3.352">         return arr.concat(elem[generator]);</span>
<a href="#l3.353"></a><span id="l3.353">       }, []);</span>
<a href="#l3.354"></a><span id="l3.354"> </span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-      if (folder == '*' || folder == '%') {</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+      if (folder == &quot;*&quot; || folder == &quot;%&quot;) {</span>
<a href="#l3.357"></a><span id="l3.357">         matching = possible;</span>
<a href="#l3.358"></a><span id="l3.358">         continue;</span>
<a href="#l3.359"></a><span id="l3.359">       }</span>
<a href="#l3.360"></a><span id="l3.360"> </span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-      let parts = folder.split(/[*%]/).filter(function (str) {</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+      let parts = folder.split(/[*%]/).filter(function(str) {</span>
<a href="#l3.363"></a><span id="l3.363">           return str.length &gt; 0;</span>
<a href="#l3.364"></a><span id="l3.364">       });</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-      matching = possible.filter(function (mailbox) {</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+      matching = possible.filter(function(mailbox) {</span>
<a href="#l3.367"></a><span id="l3.367">         let index = 0, name = mailbox.fullName;</span>
<a href="#l3.368"></a><span id="l3.368">         for (var part of parts) {</span>
<a href="#l3.369"></a><span id="l3.369">           index = name.indexOf(part, index);</span>
<a href="#l3.370"></a><span id="l3.370">           if (index == -1)</span>
<a href="#l3.371"></a><span id="l3.371">             return false;</span>
<a href="#l3.372"></a><span id="l3.372">         }</span>
<a href="#l3.373"></a><span id="l3.373">         return true;</span>
<a href="#l3.374"></a><span id="l3.374">       });</span>
<a href="#l3.375"></a><span id="l3.375">     }</span>
<a href="#l3.376"></a><span id="l3.376">     return matching;</span>
<a href="#l3.377"></a><span id="l3.377">   },</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-  get fullName () {</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+  get fullName() {</span>
<a href="#l3.380"></a><span id="l3.380">     return (this._parent ? this._parent.fullName + this.delimiter : &quot;&quot;) +</span>
<a href="#l3.381"></a><span id="l3.381">            this.name;</span>
<a href="#l3.382"></a><span id="l3.382">   },</span>
<a href="#l3.383"></a><span id="l3.383">   get displayName() {</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-    let manager = Cc['@mozilla.org/charset-converter-manager;1']</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+    let manager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;]</span>
<a href="#l3.386"></a><span id="l3.386">                     .getService(Ci.nsICharsetConverterManager);</span>
<a href="#l3.387"></a><span id="l3.387">     // Escape backslash and double-quote with another backslash before encoding.</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-    return manager.unicodeToMutf7(this.fullName.replace(/([\\&quot;])/g, '\\$1'));</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+    return manager.unicodeToMutf7(this.fullName.replace(/([\\&quot;])/g, &quot;\\$1&quot;));</span>
<a href="#l3.390"></a><span id="l3.390">   },</span>
<a href="#l3.391"></a><span id="l3.391">   get allChildren() {</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-    return this._children.reduce(function (arr, elem) {</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+    return this._children.reduce(function(arr, elem) {</span>
<a href="#l3.394"></a><span id="l3.394">       return arr.concat(elem._allChildrenInternal);</span>
<a href="#l3.395"></a><span id="l3.395">     }, []);</span>
<a href="#l3.396"></a><span id="l3.396">   },</span>
<a href="#l3.397"></a><span id="l3.397">   get _allChildrenInternal() {</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-    return this._children.reduce(function (arr, elem) {</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+    return this._children.reduce(function(arr, elem) {</span>
<a href="#l3.400"></a><span id="l3.400">       return arr.concat(elem._allChildrenInternal);</span>
<a href="#l3.401"></a><span id="l3.401">     }, [this]);</span>
<a href="#l3.402"></a><span id="l3.402">   },</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-  addMessage : function (message) {</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+  addMessage(message) {</span>
<a href="#l3.405"></a><span id="l3.405">     this._messages.push(message);</span>
<a href="#l3.406"></a><span id="l3.406">     if (message.uid &gt;= this.uidnext)</span>
<a href="#l3.407"></a><span id="l3.407">       this.uidnext = message.uid + 1;</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-    if (this._updates.indexOf(&quot;EXISTS&quot;) == -1)</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+    if (!this._updates.includes(&quot;EXISTS&quot;))</span>
<a href="#l3.410"></a><span id="l3.410">       this._updates.push(&quot;EXISTS&quot;);</span>
<a href="#l3.411"></a><span id="l3.411">     if (&quot;__highestuid&quot; in this &amp;&amp; message.uid &gt; this.__highestuid)</span>
<a href="#l3.412"></a><span id="l3.412">       this.__highestuid = message.uid;</span>
<a href="#l3.413"></a><span id="l3.413">   },</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-  get _highestuid () {</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  get _highestuid() {</span>
<a href="#l3.416"></a><span id="l3.416">     if (&quot;__highestuid&quot; in this)</span>
<a href="#l3.417"></a><span id="l3.417">       return this.__highestuid;</span>
<a href="#l3.418"></a><span id="l3.418">     var highest = 0;</span>
<a href="#l3.419"></a><span id="l3.419">     for (var message of this._messages)</span>
<a href="#l3.420"></a><span id="l3.420">       if (message.uid &gt; highest)</span>
<a href="#l3.421"></a><span id="l3.421">         highest = message.uid;</span>
<a href="#l3.422"></a><span id="l3.422">     this.__highestuid = highest;</span>
<a href="#l3.423"></a><span id="l3.423">     return highest;</span>
<a href="#l3.424"></a><span id="l3.424">   },</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-  expunge : function () {</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+  expunge() {</span>
<a href="#l3.427"></a><span id="l3.427">     var response = &quot;&quot;;</span>
<a href="#l3.428"></a><span id="l3.428">     for (var i = 0; i &lt; this._messages.length; i++) {</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-      if (this._messages[i].flags.indexOf(&quot;\\Deleted&quot;) &gt;= 0) {</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+      if (this._messages[i].flags.includes(&quot;\\Deleted&quot;)) {</span>
<a href="#l3.431"></a><span id="l3.431">         response += &quot;* &quot; + (i + 1) + &quot; EXPUNGE\0&quot;;</span>
<a href="#l3.432"></a><span id="l3.432">         this._messages.splice(i--, 1);</span>
<a href="#l3.433"></a><span id="l3.433">       }</span>
<a href="#l3.434"></a><span id="l3.434">     }</span>
<a href="#l3.435"></a><span id="l3.435">     if (response.length &gt; 0)</span>
<a href="#l3.436"></a><span id="l3.436">       delete this.__highestuid;</span>
<a href="#l3.437"></a><span id="l3.437">     return response;</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-  }</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-}</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+  },</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+};</span>
<a href="#l3.442"></a><span id="l3.442"> </span>
<a href="#l3.443"></a><span id="l3.443"> function imapMessage(URI, uid, flags) {</span>
<a href="#l3.444"></a><span id="l3.444">   this._URI = URI;</span>
<a href="#l3.445"></a><span id="l3.445">   this.uid = uid;</span>
<a href="#l3.446"></a><span id="l3.446">   this.size = 0;</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-  this.flags = new Array;</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+  this.flags = [];</span>
<a href="#l3.449"></a><span id="l3.449">   for (let flag in flags)</span>
<a href="#l3.450"></a><span id="l3.450">     this.flags.push(flag);</span>
<a href="#l3.451"></a><span id="l3.451">   this.recent = false;</span>
<a href="#l3.452"></a><span id="l3.452"> }</span>
<a href="#l3.453"></a><span id="l3.453"> imapMessage.prototype = {</span>
<a href="#l3.454"></a><span id="l3.454">   get channel() {</span>
<a href="#l3.455"></a><span id="l3.455">     return Services.io.newChannel(this._URI,</span>
<a href="#l3.456"></a><span id="l3.456">                                   null,</span>
<a href="#l3.457"></a><span id="l3.457">                                   null,</span>
<a href="#l3.458"></a><span id="l3.458">                                   null,</span>
<a href="#l3.459"></a><span id="l3.459">                                   Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l3.460"></a><span id="l3.460">                                   null,</span>
<a href="#l3.461"></a><span id="l3.461">                                   Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l3.462"></a><span id="l3.462">                                   Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l3.463"></a><span id="l3.463">   },</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-  setFlag : function (flag) {</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-   if (this.flags.indexOf(flag) == -1)</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+  setFlag(flag) {</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+   if (!this.flags.includes(flag))</span>
<a href="#l3.468"></a><span id="l3.468">      this.flags.push(flag);</span>
<a href="#l3.469"></a><span id="l3.469">   },</span>
<a href="#l3.470"></a><span id="l3.470">   // This allows us to simulate servers that approximate the rfc822 size.</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-  setSize: function(size) {</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+  setSize(size) {</span>
<a href="#l3.473"></a><span id="l3.473">     this.size = size;</span>
<a href="#l3.474"></a><span id="l3.474">   },</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-  clearFlag : function (flag) {</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+  clearFlag(flag) {</span>
<a href="#l3.477"></a><span id="l3.477">     let index = this.flags.indexOf(flag);</span>
<a href="#l3.478"></a><span id="l3.478">     if (index != -1)</span>
<a href="#l3.479"></a><span id="l3.479">       this.flags.splice(index, 1);</span>
<a href="#l3.480"></a><span id="l3.480">   },</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-  getText : function (start, length) {</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+  getText(start, length) {</span>
<a href="#l3.483"></a><span id="l3.483">     if (!start)</span>
<a href="#l3.484"></a><span id="l3.484">       start = 0;</span>
<a href="#l3.485"></a><span id="l3.485">     if (!length)</span>
<a href="#l3.486"></a><span id="l3.486">       length = -1;</span>
<a href="#l3.487"></a><span id="l3.487">     var channel = this.channel;</span>
<a href="#l3.488"></a><span id="l3.488">     var istream = channel.open();</span>
<a href="#l3.489"></a><span id="l3.489">     var bstream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l3.490"></a><span id="l3.490">                     .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l3.491"></a><span id="l3.491">     bstream.setInputStream(istream);</span>
<a href="#l3.492"></a><span id="l3.492">     var str = bstream.readBytes(start);</span>
<a href="#l3.493"></a><span id="l3.493">     if (str.length != start)</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-      throw &quot;Erm, we didn't just pass through 8-bit&quot;;</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+      throw new Error(&quot;Erm, we didn't just pass through 8-bit&quot;);</span>
<a href="#l3.496"></a><span id="l3.496">     length = length == -1 ? istream.available() : length;</span>
<a href="#l3.497"></a><span id="l3.497">     if (length &gt; istream.available())</span>
<a href="#l3.498"></a><span id="l3.498">       length = istream.available();</span>
<a href="#l3.499"></a><span id="l3.499">     str = bstream.readBytes(length);</span>
<a href="#l3.500"></a><span id="l3.500">     return str;</span>
<a href="#l3.501"></a><span id="l3.501">   },</span>
<a href="#l3.502"></a><span id="l3.502"> </span>
<a href="#l3.503"></a><span id="l3.503">   get _partMap() {</span>
<a href="#l3.504"></a><span id="l3.504">     if (this.__partMap)</span>
<a href="#l3.505"></a><span id="l3.505">       return this.__partMap;</span>
<a href="#l3.506"></a><span id="l3.506">     var partMap = {};</span>
<a href="#l3.507"></a><span id="l3.507">     var emitter = {</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-      startPart: function imap_buildMap_startPart(partNum, headers) {</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-        var imapPartNum = partNum.replace('$','');</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+      startPart(partNum, headers) {</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+        var imapPartNum = partNum.replace(&quot;$&quot;, &quot;&quot;);</span>
<a href="#l3.512"></a><span id="l3.512">         // If there are multiple imap parts that this represents, we'll</span>
<a href="#l3.513"></a><span id="l3.513">         // overwrite with the latest. This is what we want (most deeply nested).</span>
<a href="#l3.514"></a><span id="l3.514">         partMap[imapPartNum] = [partNum, headers];</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-      }</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+      },</span>
<a href="#l3.517"></a><span id="l3.517">     };</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-    MimeParser.parseSync(this.getText(), emitter,</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-      {bodyformat: 'none', stripcontinuations: false});</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+    MimeParser.parseSync(this.getText(), emitter, {</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+      bodyformat: &quot;none&quot;,</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+      stripcontinuations: false,</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+    });</span>
<a href="#l3.524"></a><span id="l3.524">     return this.__partMap = partMap;</span>
<a href="#l3.525"></a><span id="l3.525">   },</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-  getPartHeaders: function (partNum) {</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+  getPartHeaders(partNum) {</span>
<a href="#l3.528"></a><span id="l3.528">     return this._partMap[partNum][1];</span>
<a href="#l3.529"></a><span id="l3.529">   },</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-  getPartBody: function (partNum) {</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-    var body = '';</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+  getPartBody(partNum) {</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+    var body = &quot;&quot;;</span>
<a href="#l3.534"></a><span id="l3.534">     var emitter = {</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-      deliverPartData: function (partNum, data) {</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+      deliverPartData(partNum, data) {</span>
<a href="#l3.537"></a><span id="l3.537">         body += data;</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-      }</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+      },</span>
<a href="#l3.540"></a><span id="l3.540">     };</span>
<a href="#l3.541"></a><span id="l3.541">     var mimePartNum = this._partMap[partNum][0];</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    MimeParser.parseSync(this.getText(), emitter,</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-      { pruneat: mimePartNum, bodyformat: 'raw'});</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+    MimeParser.parseSync(this.getText(), emitter, {</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+      pruneat: mimePartNum,</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+      bodyformat: &quot;raw&quot;,</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+    });</span>
<a href="#l3.548"></a><span id="l3.548">     return body;</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-  }</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-}</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+  },</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+};</span>
<a href="#l3.553"></a><span id="l3.553"> // IMAP FLAGS</span>
<a href="#l3.554"></a><span id="l3.554"> // If you don't specify any flag, no flags are set.</span>
<a href="#l3.555"></a><span id="l3.555"> /**</span>
<a href="#l3.556"></a><span id="l3.556">  * This flag represents whether or not the daemon is case-insensitive.</span>
<a href="#l3.557"></a><span id="l3.557">  */</span>
<a href="#l3.558"></a><span id="l3.558"> var IMAP_FLAG_CASE_INSENSITIVE = 1;</span>
<a href="#l3.559"></a><span id="l3.559"> /**</span>
<a href="#l3.560"></a><span id="l3.560">  * This flag represents whether or not CREATE hierarchies need a delimiter.</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineat">@@ -460,290 +460,282 @@ var IMAP_NAMESPACE_OTHER_USERS = 1;</span>
<a href="#l3.562"></a><span id="l3.562"> var IMAP_NAMESPACE_SHARED = 2;</span>
<a href="#l3.563"></a><span id="l3.563"> </span>
<a href="#l3.564"></a><span id="l3.564"> // IMAP server helpers</span>
<a href="#l3.565"></a><span id="l3.565"> var IMAP_STATE_NOT_AUTHED = 0;</span>
<a href="#l3.566"></a><span id="l3.566"> var IMAP_STATE_AUTHED = 1;</span>
<a href="#l3.567"></a><span id="l3.567"> var IMAP_STATE_SELECTED = 2;</span>
<a href="#l3.568"></a><span id="l3.568"> </span>
<a href="#l3.569"></a><span id="l3.569"> function parseCommand(text, partial) {</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+  var args = [];</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+  var current = args;</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+  var stack = [];</span>
<a href="#l3.573"></a><span id="l3.573">   if (partial) {</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-    var args = partial.args;</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-    var current = partial.current;</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-    var stack = partial.stack;</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+    args = partial.args;</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+    current = partial.current;</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+    stack = partial.stack;</span>
<a href="#l3.580"></a><span id="l3.580">     current.push(partial.text);</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-  } else {</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-    var args = [];</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-    var current = args;</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-    var stack = [];</span>
<a href="#l3.585"></a><span id="l3.585">   }</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-  var atom = '';</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+  var atom = &quot;&quot;;</span>
<a href="#l3.588"></a><span id="l3.588">   while (text.length &gt; 0) {</span>
<a href="#l3.589"></a><span id="l3.589">     let c = text[0];</span>
<a href="#l3.590"></a><span id="l3.590"> </span>
<a href="#l3.591"></a><span id="l3.591">     if (c == '&quot;') {</span>
<a href="#l3.592"></a><span id="l3.592">       let index = 1;</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-      let s = '';</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+      let s = &quot;&quot;;</span>
<a href="#l3.595"></a><span id="l3.595">       while (index &lt; text.length &amp;&amp; text[index] != '&quot;') {</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-        if (text[index] == '\\') {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+        if (text[index] == &quot;\\&quot;) {</span>
<a href="#l3.598"></a><span id="l3.598">           index++;</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-          if (text[index] != '&quot;' &amp;&amp; text[index] != '\\')</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-            throw &quot;Expected quoted character&quot;;</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+          if (text[index] != '&quot;' &amp;&amp; text[index] != &quot;\\&quot;)</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+            throw new Error(&quot;Expected quoted character&quot;);</span>
<a href="#l3.603"></a><span id="l3.603">         }</span>
<a href="#l3.604"></a><span id="l3.604">         s += text[index++];</span>
<a href="#l3.605"></a><span id="l3.605">       }</span>
<a href="#l3.606"></a><span id="l3.606">       if (index == text.length)</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-        throw &quot;Expected DQUOTE&quot;;</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+        throw new Error(&quot;Expected DQUOTE&quot;);</span>
<a href="#l3.609"></a><span id="l3.609">       current.push(s);</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-      text = text.substring(index+1);</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+      text = text.substring(index + 1);</span>
<a href="#l3.612"></a><span id="l3.612">       continue;</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-    } else if (c == '{') {</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-      let end = text.indexOf('}');</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+    } else if (c == &quot;{&quot;) {</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+      let end = text.indexOf(&quot;}&quot;);</span>
<a href="#l3.617"></a><span id="l3.617">       if (end == -1)</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-        throw &quot;Expected CLOSE_BRACKET&quot;;</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-      if (end+1 != text.length)</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-        throw &quot;Expected CRLF&quot;;</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+        throw new Error(&quot;Expected CLOSE_BRACKET&quot;);</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+      if (end + 1 != text.length)</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+        throw new Error(&quot;Expected CRLF&quot;);</span>
<a href="#l3.624"></a><span id="l3.624">       let length = parseInt(text.substring(1, end));</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-      let state = {};</span>
<a href="#l3.626"></a><span id="l3.626">       // Usable state</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-      throw { length : length, current : current, args : args, stack : stack,</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-              text : '' };</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-    } else if (c == '(') {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+      throw { length, current, args, stack, text: &quot;&quot; };</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+    } else if (c == &quot;(&quot;) {</span>
<a href="#l3.632"></a><span id="l3.632">       stack.push(current);</span>
<a href="#l3.633"></a><span id="l3.633">       current = [];</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-    } else if (c == ')') {</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+    } else if (c == &quot;)&quot;) {</span>
<a href="#l3.636"></a><span id="l3.636">       if (atom.length &gt; 0) {</span>
<a href="#l3.637"></a><span id="l3.637">         current.push(atom);</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-        atom = '';</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+        atom = &quot;&quot;;</span>
<a href="#l3.640"></a><span id="l3.640">       }</span>
<a href="#l3.641"></a><span id="l3.641">       let hold = current;</span>
<a href="#l3.642"></a><span id="l3.642">       current = stack.pop();</span>
<a href="#l3.643"></a><span id="l3.643">       if (current == undefined)</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-        throw &quot;Unexpected CLOSE_PAREN&quot;;</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+        throw new Error(&quot;Unexpected CLOSE_PAREN&quot;);</span>
<a href="#l3.646"></a><span id="l3.646">       current.push(hold);</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-    } else if (c == ' ') {</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+    } else if (c == &quot; &quot;) {</span>
<a href="#l3.649"></a><span id="l3.649">       if (atom.length &gt; 0) {</span>
<a href="#l3.650"></a><span id="l3.650">         current.push(atom);</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-        atom = '';</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+        atom = &quot;&quot;;</span>
<a href="#l3.653"></a><span id="l3.653">       }</span>
<a href="#l3.654"></a><span id="l3.654">     } else if (text.toUpperCase().startsWith(&quot;NIL&quot;) &amp;&amp;</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-               (text.length == 3 || text[3] == ' ')) {</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+               (text.length == 3 || text[3] == &quot; &quot;)) {</span>
<a href="#l3.657"></a><span id="l3.657">       current.push(null);</span>
<a href="#l3.658"></a><span id="l3.658">       text = text.substring(4);</span>
<a href="#l3.659"></a><span id="l3.659">       continue;</span>
<a href="#l3.660"></a><span id="l3.660">     } else {</span>
<a href="#l3.661"></a><span id="l3.661">       atom += c;</span>
<a href="#l3.662"></a><span id="l3.662">     }</span>
<a href="#l3.663"></a><span id="l3.663">     text = text.substring(1);</span>
<a href="#l3.664"></a><span id="l3.664">   }</span>
<a href="#l3.665"></a><span id="l3.665">   if (stack.length != 0)</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-    throw &quot;Expected CLOSE_PAREN!&quot;;</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+    throw new Error(&quot;Expected CLOSE_PAREN!&quot;);</span>
<a href="#l3.668"></a><span id="l3.668">   if (atom.length &gt; 0)</span>
<a href="#l3.669"></a><span id="l3.669">     args.push(atom);</span>
<a href="#l3.670"></a><span id="l3.670">   return args;</span>
<a href="#l3.671"></a><span id="l3.671"> }</span>
<a href="#l3.672"></a><span id="l3.672"> </span>
<a href="#l3.673"></a><span id="l3.673"> function formatArg(argument, spec) {</span>
<a href="#l3.674"></a><span id="l3.674">   // Get NILs out of the way quickly</span>
<a href="#l3.675"></a><span id="l3.675">   var nilAccepted = false;</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-  if (spec.startsWith('n') &amp;&amp; spec[1] != 'u') {</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+  if (spec.startsWith(&quot;n&quot;) &amp;&amp; spec[1] != &quot;u&quot;) {</span>
<a href="#l3.678"></a><span id="l3.678">     spec = spec.substring(1);</span>
<a href="#l3.679"></a><span id="l3.679">     nilAccepted = true;</span>
<a href="#l3.680"></a><span id="l3.680">   }</span>
<a href="#l3.681"></a><span id="l3.681">   if (argument == null) {</span>
<a href="#l3.682"></a><span id="l3.682">     if (!nilAccepted)</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-      throw &quot;Unexpected NIL!&quot;;</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+      throw new Error(&quot;Unexpected NIL!&quot;);</span>
<a href="#l3.685"></a><span id="l3.685"> </span>
<a href="#l3.686"></a><span id="l3.686">     return null;</span>
<a href="#l3.687"></a><span id="l3.687">   }</span>
<a href="#l3.688"></a><span id="l3.688"> </span>
<a href="#l3.689"></a><span id="l3.689">   // array!</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-  if (spec.startsWith('(')) {</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+  if (spec.startsWith(&quot;(&quot;)) {</span>
<a href="#l3.692"></a><span id="l3.692">     // typeof array is object. Don't ask me why.</span>
<a href="#l3.693"></a><span id="l3.693">     if (!Array.isArray(argument))</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-      throw &quot;Expected list!&quot;;</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+      throw new Error(&quot;Expected list!&quot;);</span>
<a href="#l3.696"></a><span id="l3.696">     // Strip the '(' and ')'...</span>
<a href="#l3.697"></a><span id="l3.697">     spec = spec.substring(1, spec.length - 1);</span>
<a href="#l3.698"></a><span id="l3.698">     // ... and apply to the rest</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-    return argument.map(function (item) { return formatArg(item, spec); });</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+    return argument.map(function(item) { return formatArg(item, spec); });</span>
<a href="#l3.701"></a><span id="l3.701">   }</span>
<a href="#l3.702"></a><span id="l3.702"> </span>
<a href="#l3.703"></a><span id="l3.703">   // or!</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-  var pipe = spec.indexOf('|');</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+  var pipe = spec.indexOf(&quot;|&quot;);</span>
<a href="#l3.706"></a><span id="l3.706">   if (pipe &gt; 0) {</span>
<a href="#l3.707"></a><span id="l3.707">     var first = spec.substring(0, pipe);</span>
<a href="#l3.708"></a><span id="l3.708">     try {</span>
<a href="#l3.709"></a><span id="l3.709">       return formatArg(argument, first);</span>
<a href="#l3.710"></a><span id="l3.710">     } catch (e) {</span>
<a href="#l3.711"></a><span id="l3.711">       return formatArg(argument, spec.substring(pipe + 1));</span>
<a href="#l3.712"></a><span id="l3.712">     }</span>
<a href="#l3.713"></a><span id="l3.713">   }</span>
<a href="#l3.714"></a><span id="l3.714"> </span>
<a href="#l3.715"></a><span id="l3.715">   // By now, we know that the input should be generated from an atom or string.</span>
<a href="#l3.716"></a><span id="l3.716">   if (typeof argument != &quot;string&quot;)</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-    throw &quot;Expected argument of type &quot; + spec + &quot;!&quot;;</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+    throw new Error(&quot;Expected argument of type &quot; + spec + &quot;!&quot;);</span>
<a href="#l3.719"></a><span id="l3.719"> </span>
<a href="#l3.720"></a><span id="l3.720">   if (spec == &quot;atom&quot;) {</span>
<a href="#l3.721"></a><span id="l3.721">     argument = argument.toUpperCase();</span>
<a href="#l3.722"></a><span id="l3.722">   } else if (spec == &quot;mailbox&quot;) {</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-    let manager = Cc['@mozilla.org/charset-converter-manager;1']</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+    let manager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;]</span>
<a href="#l3.725"></a><span id="l3.725">                     .getService(Ci.nsICharsetConverterManager);</span>
<a href="#l3.726"></a><span id="l3.726">     argument = manager.mutf7ToUnicode(argument);</span>
<a href="#l3.727"></a><span id="l3.727">   } else if (spec == &quot;string&quot;) {</span>
<a href="#l3.728"></a><span id="l3.728">     // Do nothing</span>
<a href="#l3.729"></a><span id="l3.729">   } else if (spec == &quot;flag&quot;) {</span>
<a href="#l3.730"></a><span id="l3.730">     argument = argument.toLowerCase();</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-    if (!('a' &lt;= argument[0] &amp;&amp; argument[0] &lt;= 'z') &amp;&amp;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-        !('A' &lt;= argument[0] &amp;&amp; argument[0] &lt;= 'Z')) {</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+    if (!(&quot;a&quot; &lt;= argument[0] &amp;&amp; argument[0] &lt;= &quot;z&quot;) &amp;&amp;</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+        !(&quot;A&quot; &lt;= argument[0] &amp;&amp; argument[0] &lt;= &quot;Z&quot;)) {</span>
<a href="#l3.735"></a><span id="l3.735">       argument = argument[0] + argument[1].toUpperCase() + argument.substr(2);</span>
<a href="#l3.736"></a><span id="l3.736">     } else {</span>
<a href="#l3.737"></a><span id="l3.737">       argument = argument[0].toUpperCase() + argument.substr(1);</span>
<a href="#l3.738"></a><span id="l3.738">     }</span>
<a href="#l3.739"></a><span id="l3.739">   } else if (spec == &quot;number&quot;) {</span>
<a href="#l3.740"></a><span id="l3.740">     if (argument == parseInt(argument))</span>
<a href="#l3.741"></a><span id="l3.741">       argument = parseInt(argument);</span>
<a href="#l3.742"></a><span id="l3.742">   } else if (spec == &quot;date&quot;) {</span>
<a href="#l3.743"></a><span id="l3.743">     if (!(/^\d{1,2}-[A-Z][a-z]{2}-\d{4}( \d{2}(:\d{2}){2} [+-]\d{4})?$/.test(</span>
<a href="#l3.744"></a><span id="l3.744">           argument)))</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-     throw &quot;Expected date!&quot;;</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-    argument = new Date(Date.parse(argument.replace(/-(?!\d{4}$)/g, ' ')));</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+     throw new Error(&quot;Expected date!&quot;);</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+    argument = new Date(Date.parse(argument.replace(/-(?!\d{4}$)/g, &quot; &quot;)));</span>
<a href="#l3.749"></a><span id="l3.749">   } else {</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-    throw &quot;Unknown spec &quot; + spec;</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+    throw new Error(&quot;Unknown spec &quot; + spec);</span>
<a href="#l3.752"></a><span id="l3.752">   }</span>
<a href="#l3.753"></a><span id="l3.753"> </span>
<a href="#l3.754"></a><span id="l3.754">   return argument;</span>
<a href="#l3.755"></a><span id="l3.755"> }</span>
<a href="#l3.756"></a><span id="l3.756"> </span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-//                              IMAP TEST SERVERS                             //</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-// Because of IMAP and the LEMONADE RFCs, we have a myriad of different       //</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-// server configurations that we should ideally be supporting. We handle them //</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-// by defining a core RFC 3501 implementation and then have different server  //</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-// extensions subclass the server through functions below. However, we also   //</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-// provide standard configurations for best handling.                         //</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-// Configurations:                                                            //</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-// * Barebones RFC 3501                                                       //</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-// * Cyrus                                                                    //</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-// * UW IMAP                                                                  //</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-// * Courier                                                                  //</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-// * Exchange                                                                 //</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-// * Dovecot                                                                  //</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-// * Zimbra                                                                   //</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-// * GMail                                                                    //</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-// KNOWN DEVIATIONS FROM RFC 3501:                                            //</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-// + The autologout timer is 3 minutes, not 30 minutes. A test with a logout  //</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-//   of 30 minutes would take a very long time if it failed.                  //</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-// + SEARCH (except for UNDELETED) and STARTTLS are not supported,            //</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-//   nor is all of FETCH.                                                     //</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-// + Concurrent mailbox access is probably compliant with a rather liberal    //</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-//   implementation of RFC 3501, although probably not what one would expect, //</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-//   and certainly not what the Dovecot IMAP server tests expect.             //</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+// IMAP TEST SERVERS</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+// -----------------</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+// Because of IMAP and the LEMONADE RFCs, we have a myriad of different</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+// server configurations that we should ideally be supporting. We handle them</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+// by defining a core RFC 3501 implementation and then have different server</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+// extensions subclass the server through functions below. However, we also</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+// provide standard configurations for best handling.</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+// Configurations:</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+// * Barebones RFC 3501</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+// * Cyrus</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+// * UW IMAP</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+// * Courier</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+// * Exchange</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+// * Dovecot</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+// * Zimbra</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+// * GMail</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+// KNOWN DEVIATIONS FROM RFC 3501:</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+// + The autologout timer is 3 minutes, not 30 minutes. A test with a logout</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+//   of 30 minutes would take a very long time if it failed.</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+// + SEARCH (except for UNDELETED) and STARTTLS are not supported,</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+//   nor is all of FETCH.</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+// + Concurrent mailbox access is probably compliant with a rather liberal</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+//   implementation of RFC 3501, although probably not what one would expect,</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+//   and certainly not what the Dovecot IMAP server tests expect.</span>
<a href="#l3.807"></a><span id="l3.807"> </span>
<a href="#l3.808"></a><span id="l3.808"> /* IMAP Fakeserver operates in a different manner than the rest of fakeserver</span>
<a href="#l3.809"></a><span id="l3.809">  * because of some differences in the protocol. Commands are dispatched through</span>
<a href="#l3.810"></a><span id="l3.810">  * onError, which parses the message into components. Like other fakeserver</span>
<a href="#l3.811"></a><span id="l3.811">  * implementations, the command property will be called, but this time with an</span>
<a href="#l3.812"></a><span id="l3.812">  * argument that is an array of data items instead of a string representing the</span>
<a href="#l3.813"></a><span id="l3.813">  * rest of the line.</span>
<a href="#l3.814"></a><span id="l3.814">  */</span>
<a href="#l3.815"></a><span id="l3.815"> function IMAP_RFC3501_handler(daemon) {</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-</span>
<a href="#l3.817"></a><span id="l3.817">   this.kUsername = &quot;user&quot;;</span>
<a href="#l3.818"></a><span id="l3.818">   this.kPassword = &quot;password&quot;;</span>
<a href="#l3.819"></a><span id="l3.819">   this.kAuthSchemes = []; // Added by RFC2195 extension. Test may modify as needed.</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-  this.kCapabilities = [/*&quot;LOGINDISABLED&quot;, &quot;STARTTLS&quot;,*/]; // Test may modify as needed.</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+  this.kCapabilities = [/* &quot;LOGINDISABLED&quot;, &quot;STARTTLS&quot;, */]; // Test may modify as needed.</span>
<a href="#l3.822"></a><span id="l3.822">   this.kUidCommands = [&quot;FETCH&quot;, &quot;STORE&quot;, &quot;SEARCH&quot;, &quot;COPY&quot;];</span>
<a href="#l3.823"></a><span id="l3.823"> </span>
<a href="#l3.824"></a><span id="l3.824">   this._daemon = daemon;</span>
<a href="#l3.825"></a><span id="l3.825">   this.closing = false;</span>
<a href="#l3.826"></a><span id="l3.826">   this.dropOnStartTLS = false;</span>
<a href="#l3.827"></a><span id="l3.827">   // map: property = auth scheme {String}, value = start function on this obj</span>
<a href="#l3.828"></a><span id="l3.828">   this._kAuthSchemeStartFunction = {};</span>
<a href="#l3.829"></a><span id="l3.829"> </span>
<a href="#l3.830"></a><span id="l3.830">   this._enabledCommands = {</span>
<a href="#l3.831"></a><span id="l3.831">     // IMAP_STATE_NOT_AUTHED</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-    0: ['CAPABILITY', 'NOOP', 'LOGOUT', 'STARTTLS', 'AUTHENTICATE', 'LOGIN'],</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+    0: [&quot;CAPABILITY&quot;, &quot;NOOP&quot;, &quot;LOGOUT&quot;, &quot;STARTTLS&quot;, &quot;AUTHENTICATE&quot;, &quot;LOGIN&quot;],</span>
<a href="#l3.834"></a><span id="l3.834">     // IMAP_STATE_AUTHED</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-    1: ['CAPABILITY', 'NOOP', 'LOGOUT', 'SELECT', 'EXAMINE', 'CREATE', 'DELETE',</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-        'RENAME', 'SUBSCRIBE', 'UNSUBSCRIBE', 'LIST', 'LSUB', 'STATUS',</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-        'APPEND'],</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+    1: [&quot;CAPABILITY&quot;, &quot;NOOP&quot;, &quot;LOGOUT&quot;, &quot;SELECT&quot;, &quot;EXAMINE&quot;, &quot;CREATE&quot;, &quot;DELETE&quot;,</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+        &quot;RENAME&quot;, &quot;SUBSCRIBE&quot;, &quot;UNSUBSCRIBE&quot;, &quot;LIST&quot;, &quot;LSUB&quot;, &quot;STATUS&quot;,</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+        &quot;APPEND&quot;],</span>
<a href="#l3.841"></a><span id="l3.841">     // IMAP_STATE_SELECTED</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-    2: ['CAPABILITY', 'NOOP', 'LOGOUT', 'SELECT', 'EXAMINE', 'CREATE', 'DELETE',</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-        'RENAME', 'SUBSCRIBE', 'UNSUBSCRIBE', 'LIST', 'LSUB', 'STATUS',</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-        'APPEND', 'CHECK', 'CLOSE', 'EXPUNGE', 'SEARCH', 'FETCH', 'STORE',</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-        'COPY', 'UID']</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+    2: [&quot;CAPABILITY&quot;, &quot;NOOP&quot;, &quot;LOGOUT&quot;, &quot;SELECT&quot;, &quot;EXAMINE&quot;, &quot;CREATE&quot;, &quot;DELETE&quot;,</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+        &quot;RENAME&quot;, &quot;SUBSCRIBE&quot;, &quot;UNSUBSCRIBE&quot;, &quot;LIST&quot;, &quot;LSUB&quot;, &quot;STATUS&quot;,</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+        &quot;APPEND&quot;, &quot;CHECK&quot;, &quot;CLOSE&quot;, &quot;EXPUNGE&quot;, &quot;SEARCH&quot;, &quot;FETCH&quot;, &quot;STORE&quot;,</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+        &quot;COPY&quot;, &quot;UID&quot;],</span>
<a href="#l3.850"></a><span id="l3.850">   };</span>
<a href="#l3.851"></a><span id="l3.851">   // Format explanation:</span>
<a href="#l3.852"></a><span id="l3.852">   // atom -&gt; UPPERCASE</span>
<a href="#l3.853"></a><span id="l3.853">   // string -&gt; don't touch!</span>
<a href="#l3.854"></a><span id="l3.854">   // mailbox -&gt; Apply -&gt;UTF16 transformation with case-insensitivity stuff</span>
<a href="#l3.855"></a><span id="l3.855">   // flag -&gt; Titlecase (or \Titlecase, $Titlecase, etc.)</span>
<a href="#l3.856"></a><span id="l3.856">   // date -&gt; Make it a JSDate object</span>
<a href="#l3.857"></a><span id="l3.857">   // number -&gt; Make it a number, if possible</span>
<a href="#l3.858"></a><span id="l3.858">   // ( ) -&gt; list, apply flags as specified</span>
<a href="#l3.859"></a><span id="l3.859">   // [ ] -&gt; optional argument.</span>
<a href="#l3.860"></a><span id="l3.860">   // x|y -&gt; either x or y format.</span>
<a href="#l3.861"></a><span id="l3.861">   // ... -&gt; variable args, don't parse</span>
<a href="#l3.862"></a><span id="l3.862">   this._argFormat = {</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-    CAPABILITY : [],</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-    NOOP : [],</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-    LOGOUT : [],</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-    STARTTLS : [],</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-    AUTHENTICATE : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-    LOGIN : [&quot;string&quot;, &quot;string&quot;],</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-    SELECT : [&quot;mailbox&quot;],</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-    EXAMINE : [&quot;mailbox&quot;],</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-    CREATE : [&quot;mailbox&quot;],</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-    DELETE : [&quot;mailbox&quot;],</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-    RENAME : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-    SUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-    UNSUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-    LIST : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-    LSUB : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-    STATUS : [&quot;mailbox&quot;, &quot;(atom)&quot;],</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-    APPEND : [&quot;mailbox&quot;, &quot;[(flag)]&quot;, &quot;[date]&quot;, &quot;string&quot;],</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-    CHECK : [],</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-    CLOSE : [],</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-    EXPUNGE : [],</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-    SEARCH : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-    FETCH : [&quot;number&quot;, &quot;atom|(atom|(atom))&quot;],</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-    STORE : [&quot;number&quot;, &quot;atom&quot;, &quot;flag|(flag)&quot;],</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-    COPY : [&quot;number&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-    UID : [&quot;atom&quot;, &quot;...&quot;]</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+    CAPABILITY: [],</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+    NOOP: [],</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+    LOGOUT: [],</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+    STARTTLS: [],</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+    AUTHENTICATE: [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+    LOGIN: [&quot;string&quot;, &quot;string&quot;],</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+    SELECT: [&quot;mailbox&quot;],</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+    EXAMINE: [&quot;mailbox&quot;],</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+    CREATE: [&quot;mailbox&quot;],</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+    DELETE: [&quot;mailbox&quot;],</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+    RENAME: [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+    SUBSCRIBE: [&quot;mailbox&quot;],</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+    UNSUBSCRIBE: [&quot;mailbox&quot;],</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+    LIST: [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+    LSUB: [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+    STATUS: [&quot;mailbox&quot;, &quot;(atom)&quot;],</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    APPEND: [&quot;mailbox&quot;, &quot;[(flag)]&quot;, &quot;[date]&quot;, &quot;string&quot;],</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+    CHECK: [],</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+    CLOSE: [],</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+    EXPUNGE: [],</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+    SEARCH: [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+    FETCH: [&quot;number&quot;, &quot;atom|(atom|(atom))&quot;],</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+    STORE: [&quot;number&quot;, &quot;atom&quot;, &quot;flag|(flag)&quot;],</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+    COPY: [&quot;number&quot;, &quot;mailbox&quot;],</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+    UID: [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l3.913"></a><span id="l3.913">   };</span>
<a href="#l3.914"></a><span id="l3.914"> </span>
<a href="#l3.915"></a><span id="l3.915">   this.resetTest();</span>
<a href="#l3.916"></a><span id="l3.916"> }</span>
<a href="#l3.917"></a><span id="l3.917"> IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.918"></a><span id="l3.918"> </span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-  resetTest : function() {</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+  resetTest() {</span>
<a href="#l3.921"></a><span id="l3.921">     this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l3.922"></a><span id="l3.922">     this._multiline = false;</span>
<a href="#l3.923"></a><span id="l3.923">     this._nextAuthFunction = undefined; // should be in RFC2195_ext, but too lazy</span>
<a href="#l3.924"></a><span id="l3.924">   },</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineminus">-  onStartup : function () {</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+  onStartup() {</span>
<a href="#l3.927"></a><span id="l3.927">     this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l3.928"></a><span id="l3.928">     return &quot;* OK IMAP4rev1 Fakeserver started up&quot;;</span>
<a href="#l3.929"></a><span id="l3.929">   },</span>
<a href="#l3.930"></a><span id="l3.930"> </span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-  ////////////////////////////////////</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-  // CENTRALIZED DISPATCH FUNCTIONS //</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-  ////////////////////////////////////</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+  // CENTRALIZED DISPATCH FUNCTIONS</span>
<a href="#l3.935"></a><span id="l3.935"> </span>
<a href="#l3.936"></a><span id="l3.936">   // IMAP sends commands in the form of &quot;tag command args&quot;, but fakeserver</span>
<a href="#l3.937"></a><span id="l3.937">   // parsing tries to call the tag, which doesn't exist. Instead, we use this</span>
<a href="#l3.938"></a><span id="l3.938">   // error method to do the actual command dispatch. Mailnews uses numbers for</span>
<a href="#l3.939"></a><span id="l3.939">   // tags, which won't impede on actual commands.</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineminus">-  onError : function (tag, realLine) {</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+  onError(tag, realLine) {</span>
<a href="#l3.942"></a><span id="l3.942">     this._tag = tag;</span>
<a href="#l3.943"></a><span id="l3.943">     var space = realLine.indexOf(&quot; &quot;);</span>
<a href="#l3.944"></a><span id="l3.944">     var command = space == -1 ? realLine : realLine.substring(0, space);</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-    realLine = space == -1 ? &quot;&quot; : realLine.substring(space+1);</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+    realLine = space == -1 ? &quot;&quot; : realLine.substring(space + 1);</span>
<a href="#l3.947"></a><span id="l3.947"> </span>
<a href="#l3.948"></a><span id="l3.948">     // Now parse realLine into an array of atoms, etc.</span>
<a href="#l3.949"></a><span id="l3.949">     try {</span>
<a href="#l3.950"></a><span id="l3.950">       var args = parseCommand(realLine);</span>
<a href="#l3.951"></a><span id="l3.951">     } catch (state) {</span>
<a href="#l3.952"></a><span id="l3.952">       if (typeof state == &quot;object&quot;) {</span>
<a href="#l3.953"></a><span id="l3.953">         this._partial = state;</span>
<a href="#l3.954"></a><span id="l3.954">         this._partial.command = command;</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineat">@@ -752,25 +744,25 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.956"></a><span id="l3.956">       }</span>
<a href="#l3.957"></a><span id="l3.957"> </span>
<a href="#l3.958"></a><span id="l3.958">       return this._tag + &quot; BAD &quot; + state;</span>
<a href="#l3.959"></a><span id="l3.959">     }</span>
<a href="#l3.960"></a><span id="l3.960"> </span>
<a href="#l3.961"></a><span id="l3.961">     // If we're here, we have a command with arguments. Dispatch!</span>
<a href="#l3.962"></a><span id="l3.962">     return this._dispatchCommand(command, args);</span>
<a href="#l3.963"></a><span id="l3.963">   },</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-  onMultiline : function (line) {</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+  onMultiline(line) {</span>
<a href="#l3.966"></a><span id="l3.966">     // A multiline arising form a literal being passed</span>
<a href="#l3.967"></a><span id="l3.967">     if (this._partial) {</span>
<a href="#l3.968"></a><span id="l3.968">       // There are two cases to be concerned with:</span>
<a href="#l3.969"></a><span id="l3.969">       // 1. The CRLF is internal or end (we want more)</span>
<a href="#l3.970"></a><span id="l3.970">       // 1a. The next line is the actual command stuff!</span>
<a href="#l3.971"></a><span id="l3.971">       // 2. The CRLF is in the middle (rest of the line is args)</span>
<a href="#l3.972"></a><span id="l3.972">       if (this._partial.length &gt;= line.length + 2) { // Case 1</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-        this._partial.text += line + '\r\n';</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+        this._partial.text += line + &quot;\r\n&quot;;</span>
<a href="#l3.975"></a><span id="l3.975">         this._partial.length -= line.length + 2;</span>
<a href="#l3.976"></a><span id="l3.976">         return undefined;</span>
<a href="#l3.977"></a><span id="l3.977">       } else if (this._partial.length != 0) {</span>
<a href="#l3.978"></a><span id="l3.978">         this._partial.text += line.substring(0, this._partial.length);</span>
<a href="#l3.979"></a><span id="l3.979">         line = line.substring(this._partial.length);</span>
<a href="#l3.980"></a><span id="l3.980">       }</span>
<a href="#l3.981"></a><span id="l3.981">       var command = this._partial.command;</span>
<a href="#l3.982"></a><span id="l3.982">       var args;</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineat">@@ -804,89 +796,90 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.984"></a><span id="l3.984">         return this._tag + &quot; BAD I'm lost. Internal server error during auth&quot;;</span>
<a href="#l3.985"></a><span id="l3.985">       }</span>
<a href="#l3.986"></a><span id="l3.986">       try {</span>
<a href="#l3.987"></a><span id="l3.987">         return this._tag + &quot; &quot; + func.call(this, line);</span>
<a href="#l3.988"></a><span id="l3.988">       } catch (e) { return this._tag + &quot; BAD &quot; + e; }</span>
<a href="#l3.989"></a><span id="l3.989">     }</span>
<a href="#l3.990"></a><span id="l3.990">     return undefined;</span>
<a href="#l3.991"></a><span id="l3.991">   },</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-  _dispatchCommand : function (command, args) {</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+  _dispatchCommand(command, args) {</span>
<a href="#l3.994"></a><span id="l3.994">     this.sendingLiteral = false;</span>
<a href="#l3.995"></a><span id="l3.995">     command = command.toUpperCase();</span>
<a href="#l3.996"></a><span id="l3.996">     if (command == this._daemon.commandToFail.toUpperCase())</span>
<a href="#l3.997"></a><span id="l3.997">       return this._tag + &quot; NO &quot; + command + &quot; failed&quot;;</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+    var response;</span>
<a href="#l3.999"></a><span id="l3.999">     if (command in this) {</span>
<a href="#l3.1000"></a><span id="l3.1000">       this._lastCommand = command;</span>
<a href="#l3.1001"></a><span id="l3.1001">       // Are we allowed to execute this command?</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-      if (this._enabledCommands[this._state].indexOf(command) == -1)</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+      if (!this._enabledCommands[this._state].includes(command))</span>
<a href="#l3.1004"></a><span id="l3.1004">         return this._tag + &quot; BAD illegal command for current state &quot; + this._state;</span>
<a href="#l3.1005"></a><span id="l3.1005"> </span>
<a href="#l3.1006"></a><span id="l3.1006">       try {</span>
<a href="#l3.1007"></a><span id="l3.1007">         // Format the arguments nicely</span>
<a href="#l3.1008"></a><span id="l3.1008">         args = this._treatArgs(args, command);</span>
<a href="#l3.1009"></a><span id="l3.1009"> </span>
<a href="#l3.1010"></a><span id="l3.1010">       // UID command by itself is not useful for PerformTest</span>
<a href="#l3.1011"></a><span id="l3.1011">       if (command == &quot;UID&quot;)</span>
<a href="#l3.1012"></a><span id="l3.1012">         this._lastCommand += &quot; &quot; + args[0];</span>
<a href="#l3.1013"></a><span id="l3.1013"> </span>
<a href="#l3.1014"></a><span id="l3.1014">         // Finally, run the thing</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-        var response = this[command](args);</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineplus">+        response = this[command](args);</span>
<a href="#l3.1017"></a><span id="l3.1017">       } catch (e) {</span>
<a href="#l3.1018"></a><span id="l3.1018">         if (typeof e == &quot;string&quot;) {</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-          var response = e;</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineplus">+          response = e;</span>
<a href="#l3.1021"></a><span id="l3.1021">         } else {</span>
<a href="#l3.1022"></a><span id="l3.1022">           throw e;</span>
<a href="#l3.1023"></a><span id="l3.1023">         }</span>
<a href="#l3.1024"></a><span id="l3.1024">       }</span>
<a href="#l3.1025"></a><span id="l3.1025">     } else {</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-      var response = &quot;BAD &quot; + command  + &quot; not implemented&quot;;</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineplus">+      response = &quot;BAD &quot; + command + &quot; not implemented&quot;;</span>
<a href="#l3.1028"></a><span id="l3.1028">     }</span>
<a href="#l3.1029"></a><span id="l3.1029"> </span>
<a href="#l3.1030"></a><span id="l3.1030">     // Add status updates</span>
<a href="#l3.1031"></a><span id="l3.1031">     if (this._selectedMailbox) {</span>
<a href="#l3.1032"></a><span id="l3.1032">       for (var update of this._selectedMailbox._updates) {</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-        var line;</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+        let line;</span>
<a href="#l3.1035"></a><span id="l3.1035">         switch (update) {</span>
<a href="#l3.1036"></a><span id="l3.1036">         case &quot;EXISTS&quot;:</span>
<a href="#l3.1037"></a><span id="l3.1037">           line = &quot;* &quot; + this._selectedMailbox._messages.length + &quot; EXISTS&quot;;</span>
<a href="#l3.1038"></a><span id="l3.1038">           break;</span>
<a href="#l3.1039"></a><span id="l3.1039">         }</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-        response = line + '\0' + response;</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+        response = line + &quot;\0&quot; + response;</span>
<a href="#l3.1042"></a><span id="l3.1042">       }</span>
<a href="#l3.1043"></a><span id="l3.1043">     }</span>
<a href="#l3.1044"></a><span id="l3.1044"> </span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-    var lines = response.split(/\u0000/);</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+    var lines = response.split(&quot;\0&quot;);</span>
<a href="#l3.1047"></a><span id="l3.1047">     response = &quot;&quot;;</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-    for (var line of lines) {</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-      if (!line.startsWith('+') &amp;&amp; !line.startsWith('*'))</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineplus">+    for (let line of lines) {</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+      if (!line.startsWith(&quot;+&quot;) &amp;&amp; !line.startsWith(&quot;*&quot;))</span>
<a href="#l3.1052"></a><span id="l3.1052">         response += this._tag + &quot; &quot;;</span>
<a href="#l3.1053"></a><span id="l3.1053">       response += line + &quot;\r\n&quot;;</span>
<a href="#l3.1054"></a><span id="l3.1054">     }</span>
<a href="#l3.1055"></a><span id="l3.1055">     return response;</span>
<a href="#l3.1056"></a><span id="l3.1056">   },</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-  _treatArgs : function (args, command) {</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+  _treatArgs(args, command) {</span>
<a href="#l3.1059"></a><span id="l3.1059">     var format = this._argFormat[command];</span>
<a href="#l3.1060"></a><span id="l3.1060">     var treatedArgs = [];</span>
<a href="#l3.1061"></a><span id="l3.1061">     for (var i = 0; i &lt; format.length; i++) {</span>
<a href="#l3.1062"></a><span id="l3.1062">       var spec = format[i];</span>
<a href="#l3.1063"></a><span id="l3.1063"> </span>
<a href="#l3.1064"></a><span id="l3.1064">       if (spec == &quot;...&quot;) {</span>
<a href="#l3.1065"></a><span id="l3.1065">         treatedArgs = treatedArgs.concat(args);</span>
<a href="#l3.1066"></a><span id="l3.1066">         args = [];</span>
<a href="#l3.1067"></a><span id="l3.1067">         break;</span>
<a href="#l3.1068"></a><span id="l3.1068">       }</span>
<a href="#l3.1069"></a><span id="l3.1069"> </span>
<a href="#l3.1070"></a><span id="l3.1070">       if (args.length == 0)</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-        if (spec.startsWith('[')) // == optional arg</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+        if (spec.startsWith(&quot;[&quot;)) // == optional arg</span>
<a href="#l3.1073"></a><span id="l3.1073">           continue;</span>
<a href="#l3.1074"></a><span id="l3.1074">         else</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-          throw &quot;BAD not enough arguments&quot;;</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+          throw new Error(&quot;BAD not enough arguments&quot;);</span>
<a href="#l3.1077"></a><span id="l3.1077"> </span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-      if (spec.startsWith('[')) {</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+      if (spec.startsWith(&quot;[&quot;)) {</span>
<a href="#l3.1080"></a><span id="l3.1080">         // We have an optional argument. See if the format matches and move on</span>
<a href="#l3.1081"></a><span id="l3.1081">         // if it doesn't. Ideally, we'd rethink our decision if a later</span>
<a href="#l3.1082"></a><span id="l3.1082">         // application turns out to be wrong, but that's ugly to do</span>
<a href="#l3.1083"></a><span id="l3.1083">         // iteratively. Should any IMAP extension require it, we'll have to</span>
<a href="#l3.1084"></a><span id="l3.1084">         // come back and change this assumption, though.</span>
<a href="#l3.1085"></a><span id="l3.1085">         spec = spec.substr(1, spec.length - 2);</span>
<a href="#l3.1086"></a><span id="l3.1086">         try {</span>
<a href="#l3.1087"></a><span id="l3.1087">           var out = formatArg(args[0], spec);</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineat">@@ -895,209 +888,204 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.1089"></a><span id="l3.1089">         }</span>
<a href="#l3.1090"></a><span id="l3.1090">         treatedArgs.push(out);</span>
<a href="#l3.1091"></a><span id="l3.1091">         args.shift();</span>
<a href="#l3.1092"></a><span id="l3.1092">         continue;</span>
<a href="#l3.1093"></a><span id="l3.1093">       }</span>
<a href="#l3.1094"></a><span id="l3.1094">       try {</span>
<a href="#l3.1095"></a><span id="l3.1095">         treatedArgs.push(formatArg(args.shift(), spec));</span>
<a href="#l3.1096"></a><span id="l3.1096">       } catch (e) {</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-        throw &quot;BAD &quot; + e;</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+        throw new Error(&quot;BAD &quot; + e);</span>
<a href="#l3.1099"></a><span id="l3.1099">       }</span>
<a href="#l3.1100"></a><span id="l3.1100">     }</span>
<a href="#l3.1101"></a><span id="l3.1101">     if (args.length != 0)</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineminus">-      throw &quot;BAD Too many arguments&quot;;</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineplus">+      throw new Error(&quot;BAD Too many arguments&quot;);</span>
<a href="#l3.1104"></a><span id="l3.1104">     return treatedArgs;</span>
<a href="#l3.1105"></a><span id="l3.1105">   },</span>
<a href="#l3.1106"></a><span id="l3.1106"> </span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineminus">-  //////////////////////////</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-  //  PROTOCOL COMMANDS   //</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-  // (ordered as in spec) //</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineminus">-  //////////////////////////</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineminus">-  CAPABILITY : function (args) {</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+  // PROTOCOL COMMANDS (ordered as in spec)</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+  CAPABILITY(args) {</span>
<a href="#l3.1115"></a><span id="l3.1115">     var capa = &quot;* CAPABILITY IMAP4rev1 &quot; + this.kCapabilities.join(&quot; &quot;);</span>
<a href="#l3.1116"></a><span id="l3.1116">     if (this.kAuthSchemes.length &gt; 0)</span>
<a href="#l3.1117"></a><span id="l3.1117">       capa += &quot; AUTH=&quot; + this.kAuthSchemes.join(&quot; AUTH=&quot;);</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineminus">-    capa += &quot;\0&quot; + &quot;OK CAPABILITY completed&quot;;</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+    capa += &quot;\0OK CAPABILITY completed&quot;;</span>
<a href="#l3.1120"></a><span id="l3.1120">     return capa;</span>
<a href="#l3.1121"></a><span id="l3.1121">   },</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineminus">-  LOGOUT : function (args) {</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+  LOGOUT(args) {</span>
<a href="#l3.1124"></a><span id="l3.1124">     this.closing = true;</span>
<a href="#l3.1125"></a><span id="l3.1125">     if (this._selectedMailbox)</span>
<a href="#l3.1126"></a><span id="l3.1126">       this._daemon.synchronize(this._selectedMailbox, !this._readOnly);</span>
<a href="#l3.1127"></a><span id="l3.1127">     this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l3.1128"></a><span id="l3.1128">     return &quot;* BYE IMAP4rev1 Logging out\0OK LOGOUT completed&quot;;</span>
<a href="#l3.1129"></a><span id="l3.1129">   },</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-  NOOP : function (args) {</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+  NOOP(args) {</span>
<a href="#l3.1132"></a><span id="l3.1132">     return &quot;OK NOOP completed&quot;;</span>
<a href="#l3.1133"></a><span id="l3.1133">   },</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-  STARTTLS : function (args) {</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineplus">+  STARTTLS(args) {</span>
<a href="#l3.1136"></a><span id="l3.1136">     // simulate annoying server that drops connection on STARTTLS</span>
<a href="#l3.1137"></a><span id="l3.1137">     if (this.dropOnStartTLS) {</span>
<a href="#l3.1138"></a><span id="l3.1138">       this.closing = true;</span>
<a href="#l3.1139"></a><span id="l3.1139">       return &quot;&quot;;</span>
<a href="#l3.1140"></a><span id="l3.1140">     }</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-    else</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-      return &quot;BAD maild doesn't support TLS ATM&quot;;</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineplus">+    return &quot;BAD maild doesn't support TLS ATM&quot;;</span>
<a href="#l3.1144"></a><span id="l3.1144">   },</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-  _nextAuthFunction : undefined,</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineminus">-  AUTHENTICATE : function (args) {</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineplus">+  _nextAuthFunction: undefined,</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineplus">+  AUTHENTICATE(args) {</span>
<a href="#l3.1149"></a><span id="l3.1149">     var scheme = args[0]; // already uppercased by type &quot;atom&quot;</span>
<a href="#l3.1150"></a><span id="l3.1150">     // |scheme| contained in |kAuthSchemes|?</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineminus">-    if (!this.kAuthSchemes.some(function (s) { return s == scheme; }))</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineplus">+    if (!this.kAuthSchemes.some(function(s) { return s == scheme; }))</span>
<a href="#l3.1153"></a><span id="l3.1153">       return &quot;-ERR AUTH &quot; + scheme + &quot; not supported&quot;;</span>
<a href="#l3.1154"></a><span id="l3.1154"> </span>
<a href="#l3.1155"></a><span id="l3.1155">     var func = this._kAuthSchemeStartFunction[scheme];</span>
<a href="#l3.1156"></a><span id="l3.1156">     if (!func || typeof(func) != &quot;function&quot;)</span>
<a href="#l3.1157"></a><span id="l3.1157">       return &quot;BAD I just pretended to implement AUTH &quot; + scheme + &quot;, but I don't&quot;;</span>
<a href="#l3.1158"></a><span id="l3.1158">     return func.apply(this, args.slice(1));</span>
<a href="#l3.1159"></a><span id="l3.1159">   },</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineminus">-  LOGIN : function (args) {</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineminus">-    if (this.kCapabilities.some(function(c) { return c == &quot;LOGINDISABLED&quot;; } ))</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineplus">+  LOGIN(args) {</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineplus">+    if (this.kCapabilities.some(function(c) { return c == &quot;LOGINDISABLED&quot;; }))</span>
<a href="#l3.1164"></a><span id="l3.1164">       return &quot;BAD old-style LOGIN is disabled, use AUTHENTICATE&quot;;</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-    if (args[0] == this.kUsername &amp;&amp;</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineminus">-        args[1] == this.kPassword) {</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineplus">+    if (args[0] == this.kUsername &amp;&amp; args[1] == this.kPassword) {</span>
<a href="#l3.1168"></a><span id="l3.1168">       this._state = IMAP_STATE_AUTHED;</span>
<a href="#l3.1169"></a><span id="l3.1169">       return &quot;OK authenticated&quot;;</span>
<a href="#l3.1170"></a><span id="l3.1170">     }</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-    else</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-      return &quot;BAD invalid password, I won't authenticate you&quot;;</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineplus">+    return &quot;BAD invalid password, I won't authenticate you&quot;;</span>
<a href="#l3.1174"></a><span id="l3.1174">   },</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineminus">-  SELECT : function (args) {</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineplus">+  SELECT(args) {</span>
<a href="#l3.1177"></a><span id="l3.1177">     var box = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1178"></a><span id="l3.1178">     if (!box)</span>
<a href="#l3.1179"></a><span id="l3.1179">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l3.1180"></a><span id="l3.1180"> </span>
<a href="#l3.1181"></a><span id="l3.1181">     if (this._selectedMailbox)</span>
<a href="#l3.1182"></a><span id="l3.1182">       this._daemon.synchronize(this._selectedMailbox, !this._readOnly);</span>
<a href="#l3.1183"></a><span id="l3.1183">     this._state = IMAP_STATE_SELECTED;</span>
<a href="#l3.1184"></a><span id="l3.1184">     this._selectedMailbox = box;</span>
<a href="#l3.1185"></a><span id="l3.1185">     this._readOnly = false;</span>
<a href="#l3.1186"></a><span id="l3.1186"> </span>
<a href="#l3.1187"></a><span id="l3.1187">     var response = &quot;* FLAGS (&quot; + box.msgflags.join(&quot; &quot;) + &quot;)\0&quot;;</span>
<a href="#l3.1188"></a><span id="l3.1188">     response += &quot;* &quot; + box._messages.length + &quot; EXISTS\0* &quot;;</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-    response += box._messages.reduce(function (count, message) {</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+    response += box._messages.reduce(function(count, message) {</span>
<a href="#l3.1191"></a><span id="l3.1191">       return count + (message.recent ? 1 : 0);</span>
<a href="#l3.1192"></a><span id="l3.1192">     }, 0);</span>
<a href="#l3.1193"></a><span id="l3.1193">     response += &quot; RECENT\0&quot;;</span>
<a href="#l3.1194"></a><span id="l3.1194">     for (var i = 0; i &lt; box._messages.length; i++) {</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-      if (box._messages[i].flags.indexOf(&quot;\\Seen&quot;) == -1) {</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineplus">+      if (!box._messages[i].flags.includes(&quot;\\Seen&quot;)) {</span>
<a href="#l3.1197"></a><span id="l3.1197">         response += &quot;* OK [UNSEEN &quot; + (i + 1) + &quot;]\0&quot;;</span>
<a href="#l3.1198"></a><span id="l3.1198">         break;</span>
<a href="#l3.1199"></a><span id="l3.1199">       }</span>
<a href="#l3.1200"></a><span id="l3.1200">     }</span>
<a href="#l3.1201"></a><span id="l3.1201">     response += &quot;* OK [PERMANENTFLAGS (&quot; + box.permflags.join(&quot; &quot;) + &quot;)]\0&quot;;</span>
<a href="#l3.1202"></a><span id="l3.1202">     response += &quot;* OK [UIDNEXT &quot; + box.uidnext + &quot;]\0&quot;;</span>
<a href="#l3.1203"></a><span id="l3.1203">     if (&quot;uidvalidity&quot; in box)</span>
<a href="#l3.1204"></a><span id="l3.1204">       response += &quot;* OK [UIDVALIDITY &quot; + box.uidvalidity + &quot;]\0&quot;;</span>
<a href="#l3.1205"></a><span id="l3.1205">     return response + &quot;OK [READ-WRITE] SELECT completed&quot;;</span>
<a href="#l3.1206"></a><span id="l3.1206">   },</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineminus">-  EXAMINE : function (args) {</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineplus">+  EXAMINE(args) {</span>
<a href="#l3.1209"></a><span id="l3.1209">     var box = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1210"></a><span id="l3.1210">     if (!box)</span>
<a href="#l3.1211"></a><span id="l3.1211">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l3.1212"></a><span id="l3.1212"> </span>
<a href="#l3.1213"></a><span id="l3.1213">     if (this._selectedMailbox)</span>
<a href="#l3.1214"></a><span id="l3.1214">       this._daemon.synchronize(this._selectedMailbox, !this._readOnly);</span>
<a href="#l3.1215"></a><span id="l3.1215">     this._state = IMAP_STATE_SELECTED;</span>
<a href="#l3.1216"></a><span id="l3.1216">     this._selectedMailbox = box;</span>
<a href="#l3.1217"></a><span id="l3.1217">     this._readOnly = true;</span>
<a href="#l3.1218"></a><span id="l3.1218"> </span>
<a href="#l3.1219"></a><span id="l3.1219">     var response = &quot;* FLAGS (&quot; + box.msgflags.join(&quot; &quot;) + &quot;)\0&quot;;</span>
<a href="#l3.1220"></a><span id="l3.1220">     response += &quot;* &quot; + box._messages.length + &quot; EXISTS\0* &quot;;</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineminus">-    response += box._messages.reduce(function (count, message) {</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineplus">+    response += box._messages.reduce(function(count, message) {</span>
<a href="#l3.1223"></a><span id="l3.1223">       return count + (message.recent ? 1 : 0);</span>
<a href="#l3.1224"></a><span id="l3.1224">     }, 0);</span>
<a href="#l3.1225"></a><span id="l3.1225">     response += &quot; RECENT\0&quot;;</span>
<a href="#l3.1226"></a><span id="l3.1226">     for (var i = 0; i &lt; box._messages.length; i++) {</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineminus">-      if (box._messages[i].flags.indexOf(&quot;\\Seen&quot;) == -1) {</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineplus">+      if (!box._messages[i].flags.includes(&quot;\\Seen&quot;)) {</span>
<a href="#l3.1229"></a><span id="l3.1229">         response += &quot;* OK [UNSEEN &quot; + (i + 1) + &quot;]\0&quot;;</span>
<a href="#l3.1230"></a><span id="l3.1230">         break;</span>
<a href="#l3.1231"></a><span id="l3.1231">       }</span>
<a href="#l3.1232"></a><span id="l3.1232">     }</span>
<a href="#l3.1233"></a><span id="l3.1233">     response += &quot;* OK [PERMANENTFLAGS (&quot; + box.permflags.join(&quot; &quot;) + &quot;)]\0&quot;;</span>
<a href="#l3.1234"></a><span id="l3.1234">     response += &quot;* OK [UIDNEXT &quot; + box.uidnext + &quot;]\0&quot;;</span>
<a href="#l3.1235"></a><span id="l3.1235">     response += &quot;* OK [UIDVALIDITY &quot; + box.uidvalidity + &quot;]\0&quot;;</span>
<a href="#l3.1236"></a><span id="l3.1236">     return response + &quot;OK [READ-ONLY] EXAMINE completed&quot;;</span>
<a href="#l3.1237"></a><span id="l3.1237">   },</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineminus">-  CREATE : function (args) {</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineplus">+  CREATE(args) {</span>
<a href="#l3.1240"></a><span id="l3.1240">     if (this._daemon.getMailbox(args[0]))</span>
<a href="#l3.1241"></a><span id="l3.1241">       return &quot;NO mailbox already exists&quot;;</span>
<a href="#l3.1242"></a><span id="l3.1242">     if (!this._daemon.createMailbox(args[0]))</span>
<a href="#l3.1243"></a><span id="l3.1243">       return &quot;NO cannot create mailbox&quot;;</span>
<a href="#l3.1244"></a><span id="l3.1244">     return &quot;OK CREATE completed&quot;;</span>
<a href="#l3.1245"></a><span id="l3.1245">   },</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineminus">-  DELETE : function (args) {</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineplus">+  DELETE(args) {</span>
<a href="#l3.1248"></a><span id="l3.1248">     var mbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1249"></a><span id="l3.1249">     if (!mbox || mbox.name == &quot;&quot;)</span>
<a href="#l3.1250"></a><span id="l3.1250">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l3.1251"></a><span id="l3.1251">     if (mbox._children.length &gt; 0) {</span>
<a href="#l3.1252"></a><span id="l3.1252">       for (let i = 0; i &lt; mbox.flags.length; i++)</span>
<a href="#l3.1253"></a><span id="l3.1253">         if (mbox.flags[i] == &quot;\\Noselect&quot;)</span>
<a href="#l3.1254"></a><span id="l3.1254">           return &quot;NO cannot delete mailbox&quot;;</span>
<a href="#l3.1255"></a><span id="l3.1255">     }</span>
<a href="#l3.1256"></a><span id="l3.1256">     this._daemon.deleteMailbox(mbox);</span>
<a href="#l3.1257"></a><span id="l3.1257">     return &quot;OK DELETE completed&quot;;</span>
<a href="#l3.1258"></a><span id="l3.1258">   },</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-  RENAME : function (args) {</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineplus">+  RENAME(args) {</span>
<a href="#l3.1261"></a><span id="l3.1261">     var mbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1262"></a><span id="l3.1262">     if (!mbox || mbox.name == &quot;&quot;)</span>
<a href="#l3.1263"></a><span id="l3.1263">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l3.1264"></a><span id="l3.1264">     if (!this._daemon.createMailbox(args[1], mbox))</span>
<a href="#l3.1265"></a><span id="l3.1265">       return &quot;NO cannot rename mailbox&quot;;</span>
<a href="#l3.1266"></a><span id="l3.1266">     return &quot;OK RENAME completed&quot;;</span>
<a href="#l3.1267"></a><span id="l3.1267">   },</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-  SUBSCRIBE : function (args) {</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineplus">+  SUBSCRIBE(args) {</span>
<a href="#l3.1270"></a><span id="l3.1270">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1271"></a><span id="l3.1271">     if (!mailbox)</span>
<a href="#l3.1272"></a><span id="l3.1272">       return &quot;NO error in subscribing&quot;;</span>
<a href="#l3.1273"></a><span id="l3.1273">     mailbox.subscribed = true;</span>
<a href="#l3.1274"></a><span id="l3.1274">     return &quot;OK SUBSCRIBE completed&quot;;</span>
<a href="#l3.1275"></a><span id="l3.1275">   },</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineminus">-  UNSUBSCRIBE : function (args) {</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineplus">+  UNSUBSCRIBE(args) {</span>
<a href="#l3.1278"></a><span id="l3.1278">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1279"></a><span id="l3.1279">     if (mailbox)</span>
<a href="#l3.1280"></a><span id="l3.1280">       mailbox.subscribed = false;</span>
<a href="#l3.1281"></a><span id="l3.1281">     return &quot;OK UNSUBSCRIBE completed&quot;;</span>
<a href="#l3.1282"></a><span id="l3.1282">   },</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineminus">-  LIST : function (args) {</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineplus">+  LIST(args) {</span>
<a href="#l3.1285"></a><span id="l3.1285">     // even though this is the LIST function for RFC 3501, code for</span>
<a href="#l3.1286"></a><span id="l3.1286">     // LIST-EXTENDED (RFC 5258) is included here to keep things simple and</span>
<a href="#l3.1287"></a><span id="l3.1287">     // avoid duplication. We can get away with this because the _treatArgs</span>
<a href="#l3.1288"></a><span id="l3.1288">     // function filters out invalid args for servers that don't support</span>
<a href="#l3.1289"></a><span id="l3.1289">     // LIST-EXTENDED before they even get here.</span>
<a href="#l3.1290"></a><span id="l3.1290"> </span>
<a href="#l3.1291"></a><span id="l3.1291">     let listFunctionName = &quot;_LIST&quot;;</span>
<a href="#l3.1292"></a><span id="l3.1292">     // check for optional list selection options argument used by LIST-EXTENDED</span>
<a href="#l3.1293"></a><span id="l3.1293">     // and other related RFCs</span>
<a href="#l3.1294"></a><span id="l3.1294">     if (args.length == 3 || (args.length &gt; 3 &amp;&amp; args[3] == &quot;RETURN&quot;)) {</span>
<a href="#l3.1295"></a><span id="l3.1295">       let selectionOptions = args.shift();</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineminus">-      selectionOptions = selectionOptions.toString().split(' ');</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineplus">+      selectionOptions = selectionOptions.toString().split(&quot; &quot;);</span>
<a href="#l3.1298"></a><span id="l3.1298">       selectionOptions.sort();</span>
<a href="#l3.1299"></a><span id="l3.1299">       for (let option of selectionOptions) {</span>
<a href="#l3.1300"></a><span id="l3.1300">         listFunctionName += &quot;_&quot; + option.replace(/-/g, &quot;_&quot;);</span>
<a href="#l3.1301"></a><span id="l3.1301">       }</span>
<a href="#l3.1302"></a><span id="l3.1302">     }</span>
<a href="#l3.1303"></a><span id="l3.1303">     // check for optional list return options argument used by LIST-EXTENDED</span>
<a href="#l3.1304"></a><span id="l3.1304">     // and other related RFCs</span>
<a href="#l3.1305"></a><span id="l3.1305">     if ((args.length &gt; 2 &amp;&amp; args[2] == &quot;RETURN&quot;) ||</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineminus">-        this.kCapabilities.indexOf(&quot;CHILDREN&quot;) &gt;= 0) {</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineplus">+        this.kCapabilities.includes(&quot;CHILDREN&quot;)) {</span>
<a href="#l3.1308"></a><span id="l3.1308">       listFunctionName += &quot;_RETURN&quot;;</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-      let returnOptions = args[3] ? args[3].toString().split(' ') : [];</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-      if ((this.kCapabilities.indexOf(&quot;CHILDREN&quot;) &gt;= 0) &amp;&amp;</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-          (returnOptions.indexOf(&quot;CHILDREN&quot;) == -1)) {</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineplus">+      let returnOptions = args[3] ? args[3].toString().split(&quot; &quot;) : [];</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineplus">+      if ((this.kCapabilities.includes(&quot;CHILDREN&quot;)) &amp;&amp;</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineplus">+          (!returnOptions.includes(&quot;CHILDREN&quot;))) {</span>
<a href="#l3.1315"></a><span id="l3.1315">         returnOptions.push(&quot;CHILDREN&quot;);</span>
<a href="#l3.1316"></a><span id="l3.1316">       }</span>
<a href="#l3.1317"></a><span id="l3.1317">       returnOptions.sort();</span>
<a href="#l3.1318"></a><span id="l3.1318">       for (let option of returnOptions) {</span>
<a href="#l3.1319"></a><span id="l3.1319">         listFunctionName += &quot;_&quot; + option.replace(/-/g, &quot;_&quot;);</span>
<a href="#l3.1320"></a><span id="l3.1320">       }</span>
<a href="#l3.1321"></a><span id="l3.1321">     }</span>
<a href="#l3.1322"></a><span id="l3.1322">     if (!this[listFunctionName])</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineminus">-      return 'BAD unknown LIST request options';</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineplus">+      return &quot;BAD unknown LIST request options&quot;;</span>
<a href="#l3.1325"></a><span id="l3.1325"> </span>
<a href="#l3.1326"></a><span id="l3.1326">     let base = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1327"></a><span id="l3.1327">     if (!base)</span>
<a href="#l3.1328"></a><span id="l3.1328">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l3.1329"></a><span id="l3.1329">     let requestedBoxes;</span>
<a href="#l3.1330"></a><span id="l3.1330">     // check for multiple mailbox patterns used by LIST-EXTENDED</span>
<a href="#l3.1331"></a><span id="l3.1331">     // and other related RFCs</span>
<a href="#l3.1332"></a><span id="l3.1332">     if (args[1].startsWith(&quot;(&quot;)) {</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineat">@@ -1110,241 +1098,238 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.1334"></a><span id="l3.1334">       let people = base.matchKids(requestedBox);</span>
<a href="#l3.1335"></a><span id="l3.1335">       for (let box of people) {</span>
<a href="#l3.1336"></a><span id="l3.1336">         response += this[listFunctionName](box);</span>
<a href="#l3.1337"></a><span id="l3.1337">       }</span>
<a href="#l3.1338"></a><span id="l3.1338">     }</span>
<a href="#l3.1339"></a><span id="l3.1339">     return response + &quot;OK LIST completed&quot;;</span>
<a href="#l3.1340"></a><span id="l3.1340">   },</span>
<a href="#l3.1341"></a><span id="l3.1341">   // _LIST is the standard LIST command response</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-  _LIST : function (aBox) {</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineplus">+  _LIST(aBox) {</span>
<a href="#l3.1344"></a><span id="l3.1344">     if (aBox.nonExistent) {</span>
<a href="#l3.1345"></a><span id="l3.1345">       return &quot;&quot;;</span>
<a href="#l3.1346"></a><span id="l3.1346">     }</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineminus">-    return '* LIST (' + aBox.flags.join(&quot; &quot;) + ') &quot;' + aBox.delimiter +</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineplus">+    return &quot;* LIST (&quot; + aBox.flags.join(&quot; &quot;) + ') &quot;' + aBox.delimiter +</span>
<a href="#l3.1349"></a><span id="l3.1349">            '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.1350"></a><span id="l3.1350">   },</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineminus">-  LSUB : function (args) {</span>
<a href="#l3.1352"></a><span id="l3.1352" class="difflineplus">+  LSUB(args) {</span>
<a href="#l3.1353"></a><span id="l3.1353">     var base = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1354"></a><span id="l3.1354">     if (!base)</span>
<a href="#l3.1355"></a><span id="l3.1355">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l3.1356"></a><span id="l3.1356">     var people = base.matchKids(args[1]);</span>
<a href="#l3.1357"></a><span id="l3.1357">     var response = &quot;&quot;;</span>
<a href="#l3.1358"></a><span id="l3.1358">     for (var box of people) {</span>
<a href="#l3.1359"></a><span id="l3.1359">       if (box.subscribed)</span>
<a href="#l3.1360"></a><span id="l3.1360">         response += '* LSUB () &quot;' + box.delimiter +</span>
<a href="#l3.1361"></a><span id="l3.1361">                     '&quot; &quot;' + box.displayName + '&quot;\0';</span>
<a href="#l3.1362"></a><span id="l3.1362">     }</span>
<a href="#l3.1363"></a><span id="l3.1363">     return response + &quot;OK LSUB completed&quot;;</span>
<a href="#l3.1364"></a><span id="l3.1364">   },</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineminus">-  STATUS : function (args) {</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineplus">+  STATUS(args) {</span>
<a href="#l3.1367"></a><span id="l3.1367">     var box = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1368"></a><span id="l3.1368">     if (!box)</span>
<a href="#l3.1369"></a><span id="l3.1369">       return &quot;NO no such mailbox exists&quot;;</span>
<a href="#l3.1370"></a><span id="l3.1370">     for (let i = 0; i &lt; box.flags.length; i++)</span>
<a href="#l3.1371"></a><span id="l3.1371">       if (box.flags[i] == &quot;\\Noselect&quot;)</span>
<a href="#l3.1372"></a><span id="l3.1372">         return &quot;NO STATUS not allowed on Noselect folder&quot;;</span>
<a href="#l3.1373"></a><span id="l3.1373">     var parts = [];</span>
<a href="#l3.1374"></a><span id="l3.1374">     for (var status of args[1]) {</span>
<a href="#l3.1375"></a><span id="l3.1375">       var line = status + &quot; &quot;;</span>
<a href="#l3.1376"></a><span id="l3.1376">       switch (status) {</span>
<a href="#l3.1377"></a><span id="l3.1377">       case &quot;MESSAGES&quot;:</span>
<a href="#l3.1378"></a><span id="l3.1378">         line += box._messages.length;</span>
<a href="#l3.1379"></a><span id="l3.1379">         break;</span>
<a href="#l3.1380"></a><span id="l3.1380">       case &quot;RECENT&quot;:</span>
<a href="#l3.1381"></a><span id="l3.1381" class="difflineminus">-        line += box._messages.reduce(function (count, message) {</span>
<a href="#l3.1382"></a><span id="l3.1382" class="difflineplus">+        line += box._messages.reduce(function(count, message) {</span>
<a href="#l3.1383"></a><span id="l3.1383">           return count + (message.recent ? 1 : 0);</span>
<a href="#l3.1384"></a><span id="l3.1384">         }, 0);</span>
<a href="#l3.1385"></a><span id="l3.1385">         break;</span>
<a href="#l3.1386"></a><span id="l3.1386">       case &quot;UIDNEXT&quot;:</span>
<a href="#l3.1387"></a><span id="l3.1387">         line += box.uidnext;</span>
<a href="#l3.1388"></a><span id="l3.1388">         break;</span>
<a href="#l3.1389"></a><span id="l3.1389">       case &quot;UIDVALIDITY&quot;:</span>
<a href="#l3.1390"></a><span id="l3.1390">         line += box.uidvalidity;</span>
<a href="#l3.1391"></a><span id="l3.1391">         break;</span>
<a href="#l3.1392"></a><span id="l3.1392">       case &quot;UNSEEN&quot;:</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineminus">-        line += box._messages.reduce(function (count, message) {</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineminus">-          return count + (message.flags.indexOf('\\Seen') == -1 ? 1 : 0);</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineplus">+        line += box._messages.reduce(function(count, message) {</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineplus">+          return count + (message.flags.includes(&quot;\\Seen&quot;) ? 0 : 1);</span>
<a href="#l3.1397"></a><span id="l3.1397">         }, 0);</span>
<a href="#l3.1398"></a><span id="l3.1398">         break;</span>
<a href="#l3.1399"></a><span id="l3.1399">       default:</span>
<a href="#l3.1400"></a><span id="l3.1400">         return &quot;BAD unknown status flag: &quot; + status;</span>
<a href="#l3.1401"></a><span id="l3.1401">       }</span>
<a href="#l3.1402"></a><span id="l3.1402">       parts.push(line);</span>
<a href="#l3.1403"></a><span id="l3.1403">     }</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineminus">-    return &quot;* STATUS \&quot;&quot; + args[0] + &quot;\&quot; (&quot; + parts.join(' ') +</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineplus">+    return &quot;* STATUS \&quot;&quot; + args[0] + &quot;\&quot; (&quot; + parts.join(&quot; &quot;) +</span>
<a href="#l3.1406"></a><span id="l3.1406">            &quot;)\0OK STATUS completed&quot;;</span>
<a href="#l3.1407"></a><span id="l3.1407">   },</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineminus">-  APPEND : function (args) {</span>
<a href="#l3.1409"></a><span id="l3.1409" class="difflineplus">+  APPEND(args) {</span>
<a href="#l3.1410"></a><span id="l3.1410">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.1411"></a><span id="l3.1411">     if (!mailbox)</span>
<a href="#l3.1412"></a><span id="l3.1412">       return &quot;NO [TRYCREATE] no such mailbox&quot;;</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineplus">+    var flags, date, text;</span>
<a href="#l3.1414"></a><span id="l3.1414">     if (args.length == 3) {</span>
<a href="#l3.1415"></a><span id="l3.1415">       if (args[1] instanceof Date) {</span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineminus">-        var flags = [];</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-        var date = args[1];</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineplus">+        flags = [];</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineplus">+        date = args[1];</span>
<a href="#l3.1420"></a><span id="l3.1420">       } else {</span>
<a href="#l3.1421"></a><span id="l3.1421" class="difflineminus">-        var flags = args[1];</span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-        var date = Date.now();</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineplus">+        flags = args[1];</span>
<a href="#l3.1424"></a><span id="l3.1424" class="difflineplus">+        date = Date.now();</span>
<a href="#l3.1425"></a><span id="l3.1425">       }</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineminus">-      var text = args[2];</span>
<a href="#l3.1427"></a><span id="l3.1427" class="difflineplus">+      text = args[2];</span>
<a href="#l3.1428"></a><span id="l3.1428">     } else if (args.length == 4) {</span>
<a href="#l3.1429"></a><span id="l3.1429" class="difflineminus">-      var flags = args[1];</span>
<a href="#l3.1430"></a><span id="l3.1430" class="difflineminus">-      var date = args[2];</span>
<a href="#l3.1431"></a><span id="l3.1431" class="difflineminus">-      var text = args[3];</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineplus">+      flags = args[1];</span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineplus">+      date = args[2];</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineplus">+      text = args[3];</span>
<a href="#l3.1435"></a><span id="l3.1435">     } else {</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineminus">-      var flags = [];</span>
<a href="#l3.1437"></a><span id="l3.1437" class="difflineminus">-      var date = Date.now();</span>
<a href="#l3.1438"></a><span id="l3.1438" class="difflineminus">-      var text = args[1];</span>
<a href="#l3.1439"></a><span id="l3.1439" class="difflineplus">+      flags = [];</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineplus">+      date = Date.now();</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineplus">+      text = args[1];</span>
<a href="#l3.1442"></a><span id="l3.1442">     }</span>
<a href="#l3.1443"></a><span id="l3.1443">     var msg = new imapMessage(&quot;data:text/plain,&quot; + encodeURI(text),</span>
<a href="#l3.1444"></a><span id="l3.1444">                               mailbox.uidnext++, flags);</span>
<a href="#l3.1445"></a><span id="l3.1445">     msg.recent = true;</span>
<a href="#l3.1446"></a><span id="l3.1446">     msg.date = date;</span>
<a href="#l3.1447"></a><span id="l3.1447">     mailbox.addMessage(msg);</span>
<a href="#l3.1448"></a><span id="l3.1448">     return &quot;OK APPEND complete&quot;;</span>
<a href="#l3.1449"></a><span id="l3.1449">   },</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineminus">-  CHECK : function (args) {</span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineplus">+  CHECK(args) {</span>
<a href="#l3.1452"></a><span id="l3.1452">     this._daemon.synchronize(this._selectedMailbox, false);</span>
<a href="#l3.1453"></a><span id="l3.1453">     return &quot;OK CHECK completed&quot;;</span>
<a href="#l3.1454"></a><span id="l3.1454">   },</span>
<a href="#l3.1455"></a><span id="l3.1455" class="difflineminus">-  CLOSE : function (args) {</span>
<a href="#l3.1456"></a><span id="l3.1456" class="difflineplus">+  CLOSE(args) {</span>
<a href="#l3.1457"></a><span id="l3.1457">     this._selectedMailbox.expunge();</span>
<a href="#l3.1458"></a><span id="l3.1458">     this._daemon.synchronize(this._selectedMailbox, !this._readOnly);</span>
<a href="#l3.1459"></a><span id="l3.1459">     this._selectedMailbox = null;</span>
<a href="#l3.1460"></a><span id="l3.1460">     this._state = IMAP_STATE_AUTHED;</span>
<a href="#l3.1461"></a><span id="l3.1461">     return &quot;OK CLOSE completed&quot;;</span>
<a href="#l3.1462"></a><span id="l3.1462">   },</span>
<a href="#l3.1463"></a><span id="l3.1463" class="difflineminus">-  EXPUNGE : function (args) {</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineplus">+  EXPUNGE(args) {</span>
<a href="#l3.1465"></a><span id="l3.1465">     // Will be either empty or LF-terminated already</span>
<a href="#l3.1466"></a><span id="l3.1466">     var response = this._selectedMailbox.expunge();</span>
<a href="#l3.1467"></a><span id="l3.1467">     this._daemon.synchronize(this._selectedMailbox);</span>
<a href="#l3.1468"></a><span id="l3.1468">     return response + &quot;OK EXPUNGE completed&quot;;</span>
<a href="#l3.1469"></a><span id="l3.1469">   },</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineminus">-  SEARCH : function (args, uid) {</span>
<a href="#l3.1471"></a><span id="l3.1471" class="difflineplus">+  SEARCH(args, uid) {</span>
<a href="#l3.1472"></a><span id="l3.1472">     if (args[0] == &quot;UNDELETED&quot;) {</span>
<a href="#l3.1473"></a><span id="l3.1473">       let response = &quot;* SEARCH&quot;;</span>
<a href="#l3.1474"></a><span id="l3.1474">       let messages = this._selectedMailbox._messages;</span>
<a href="#l3.1475"></a><span id="l3.1475">       for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l3.1476"></a><span id="l3.1476" class="difflineminus">-        if (messages[i].flags.indexOf(&quot;\\Deleted&quot;) == -1)</span>
<a href="#l3.1477"></a><span id="l3.1477" class="difflineplus">+        if (!messages[i].flags.includes(&quot;\\Deleted&quot;))</span>
<a href="#l3.1478"></a><span id="l3.1478">           response += &quot; &quot; + messages[i].uid;</span>
<a href="#l3.1479"></a><span id="l3.1479">       }</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineminus">-      response += '\0';</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineplus">+      response += &quot;\0&quot;;</span>
<a href="#l3.1482"></a><span id="l3.1482">       return response + &quot;OK SEARCH COMPLETED\0&quot;;</span>
<a href="#l3.1483"></a><span id="l3.1483">     }</span>
<a href="#l3.1484"></a><span id="l3.1484" class="difflineminus">-    else</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-      return &quot;BAD not here yet&quot;;</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineplus">+    return &quot;BAD not here yet&quot;;</span>
<a href="#l3.1487"></a><span id="l3.1487">   },</span>
<a href="#l3.1488"></a><span id="l3.1488" class="difflineminus">-  FETCH : function (args, uid) {</span>
<a href="#l3.1489"></a><span id="l3.1489" class="difflineplus">+  FETCH(args, uid) {</span>
<a href="#l3.1490"></a><span id="l3.1490">     // Step 1: Get the messages to fetch</span>
<a href="#l3.1491"></a><span id="l3.1491">     var ids = [];</span>
<a href="#l3.1492"></a><span id="l3.1492">     var messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l3.1493"></a><span id="l3.1493"> </span>
<a href="#l3.1494"></a><span id="l3.1494">     // Step 2: Ensure that the fetching items are in a neat format</span>
<a href="#l3.1495"></a><span id="l3.1495">     if (typeof args[1] == &quot;string&quot;) {</span>
<a href="#l3.1496"></a><span id="l3.1496">       if (args[1] in this.fetchMacroExpansions)</span>
<a href="#l3.1497"></a><span id="l3.1497">         args[1] = this.fetchMacroExpansions[args[1]];</span>
<a href="#l3.1498"></a><span id="l3.1498">       else</span>
<a href="#l3.1499"></a><span id="l3.1499">         args[1] = [args[1]];</span>
<a href="#l3.1500"></a><span id="l3.1500">     }</span>
<a href="#l3.1501"></a><span id="l3.1501" class="difflineminus">-    if (uid &amp;&amp; args[1].indexOf(&quot;UID&quot;) == -1)</span>
<a href="#l3.1502"></a><span id="l3.1502" class="difflineplus">+    if (uid &amp;&amp; !args[1].includes(&quot;UID&quot;))</span>
<a href="#l3.1503"></a><span id="l3.1503">       args[1].push(&quot;UID&quot;);</span>
<a href="#l3.1504"></a><span id="l3.1504"> </span>
<a href="#l3.1505"></a><span id="l3.1505">     // Step 2.1: Preprocess the item fetch stack</span>
<a href="#l3.1506"></a><span id="l3.1506">     var items = [], prefix = undefined;</span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineminus">-    for (var item of args[1]) {</span>
<a href="#l3.1508"></a><span id="l3.1508" class="difflineminus">-      if (item.indexOf('[') &gt; 0 &amp;&amp; item.indexOf(']') == -1) {</span>
<a href="#l3.1509"></a><span id="l3.1509" class="difflineplus">+    for (let item of args[1]) {</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineplus">+      if (item.indexOf(&quot;[&quot;) &gt; 0 &amp;&amp; !item.includes(&quot;]&quot;)) {</span>
<a href="#l3.1511"></a><span id="l3.1511">         // We want to append everything into an item until we find a ']'</span>
<a href="#l3.1512"></a><span id="l3.1512" class="difflineminus">-        prefix = item + ' ';</span>
<a href="#l3.1513"></a><span id="l3.1513" class="difflineplus">+        prefix = item + &quot; &quot;;</span>
<a href="#l3.1514"></a><span id="l3.1514">         continue;</span>
<a href="#l3.1515"></a><span id="l3.1515">       }</span>
<a href="#l3.1516"></a><span id="l3.1516">       if (prefix !== undefined) {</span>
<a href="#l3.1517"></a><span id="l3.1517" class="difflineminus">-        if (typeof item != &quot;string&quot; || item.indexOf(']') == -1) {</span>
<a href="#l3.1518"></a><span id="l3.1518" class="difflineminus">-          prefix += (typeof item == &quot;string&quot; ? item : '(' + item.join(' ') + ')')</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-                  + ' ';</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineplus">+        if (typeof item != &quot;string&quot; || !item.includes(&quot;]&quot;)) {</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineplus">+          prefix += (typeof item == &quot;string&quot; ? item : &quot;(&quot; + item.join(&quot; &quot;) + &quot;)&quot;) + &quot; &quot;;</span>
<a href="#l3.1522"></a><span id="l3.1522">           continue;</span>
<a href="#l3.1523"></a><span id="l3.1523">         }</span>
<a href="#l3.1524"></a><span id="l3.1524">         // Replace superfluous space with a ']'.</span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-        prefix = prefix.substr(0, prefix.length - 1) + ']';</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineplus">+        prefix = prefix.substr(0, prefix.length - 1) + &quot;]&quot;;</span>
<a href="#l3.1527"></a><span id="l3.1527">         item = prefix;</span>
<a href="#l3.1528"></a><span id="l3.1528">         prefix = undefined;</span>
<a href="#l3.1529"></a><span id="l3.1529">       }</span>
<a href="#l3.1530"></a><span id="l3.1530">       item = item.toUpperCase();</span>
<a href="#l3.1531"></a><span id="l3.1531" class="difflineminus">-      if (items.indexOf(item) == -1)</span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineplus">+      if (!items.includes(item))</span>
<a href="#l3.1533"></a><span id="l3.1533">         items.push(item);</span>
<a href="#l3.1534"></a><span id="l3.1534">     }</span>
<a href="#l3.1535"></a><span id="l3.1535"> </span>
<a href="#l3.1536"></a><span id="l3.1536">     // Step 3: Fetch time!</span>
<a href="#l3.1537"></a><span id="l3.1537">     var response = &quot;&quot;;</span>
<a href="#l3.1538"></a><span id="l3.1538">     for (var i = 0; i &lt; messages.length; i++) {</span>
<a href="#l3.1539"></a><span id="l3.1539">       response += &quot;* &quot; + ids[i] + &quot; FETCH (&quot;;</span>
<a href="#l3.1540"></a><span id="l3.1540">       var parts = [];</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineminus">-      for (var item of items) {</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineminus">-</span>
<a href="#l3.1543"></a><span id="l3.1543" class="difflineplus">+      for (let item of items) {</span>
<a href="#l3.1544"></a><span id="l3.1544">         // Brief explanation: an item like BODY[]&lt;&gt; can't be hardcoded easily,</span>
<a href="#l3.1545"></a><span id="l3.1545">         // so we go for the initial alphanumeric substring, passing in the</span>
<a href="#l3.1546"></a><span id="l3.1546">         // actual string as an optional second part.</span>
<a href="#l3.1547"></a><span id="l3.1547">         var front = item.split(/[^A-Z0-9-]/, 1)[0];</span>
<a href="#l3.1548"></a><span id="l3.1548">         var functionName = &quot;_FETCH_&quot; + front.replace(/-/g, &quot;_&quot;);</span>
<a href="#l3.1549"></a><span id="l3.1549"> </span>
<a href="#l3.1550"></a><span id="l3.1550">         if (!(functionName in this))</span>
<a href="#l3.1551"></a><span id="l3.1551">           return &quot;BAD can't fetch &quot; + front;</span>
<a href="#l3.1552"></a><span id="l3.1552">         try {</span>
<a href="#l3.1553"></a><span id="l3.1553">           parts.push(this[functionName](messages[i], item));</span>
<a href="#l3.1554"></a><span id="l3.1554">         } catch (ex) {</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineminus">-</span>
<a href="#l3.1556"></a><span id="l3.1556" class="difflineminus">-          return &quot;BAD error in fetching: &quot;+ex;</span>
<a href="#l3.1557"></a><span id="l3.1557" class="difflineplus">+          return &quot;BAD error in fetching: &quot; + ex;</span>
<a href="#l3.1558"></a><span id="l3.1558">         }</span>
<a href="#l3.1559"></a><span id="l3.1559">       }</span>
<a href="#l3.1560"></a><span id="l3.1560" class="difflineminus">-      response += parts.join(&quot; &quot;) + ')\0';</span>
<a href="#l3.1561"></a><span id="l3.1561" class="difflineplus">+      response += parts.join(&quot; &quot;) + &quot;)\0&quot;;</span>
<a href="#l3.1562"></a><span id="l3.1562">     }</span>
<a href="#l3.1563"></a><span id="l3.1563">     return response + &quot;OK FETCH completed&quot;;</span>
<a href="#l3.1564"></a><span id="l3.1564">   },</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-  STORE : function (args, uid) {</span>
<a href="#l3.1566"></a><span id="l3.1566" class="difflineplus">+  STORE(args, uid) {</span>
<a href="#l3.1567"></a><span id="l3.1567">     var ids = [];</span>
<a href="#l3.1568"></a><span id="l3.1568">     var messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l3.1569"></a><span id="l3.1569"> </span>
<a href="#l3.1570"></a><span id="l3.1570">     args[1] = args[1].toUpperCase();</span>
<a href="#l3.1571"></a><span id="l3.1571" class="difflineminus">-    var silent = args[1].includes('.SILENT', 1);</span>
<a href="#l3.1572"></a><span id="l3.1572" class="difflineplus">+    var silent = args[1].includes(&quot;.SILENT&quot;, 1);</span>
<a href="#l3.1573"></a><span id="l3.1573">     if (silent)</span>
<a href="#l3.1574"></a><span id="l3.1574" class="difflineminus">-      args[1] = args[1].substring(0, args[1].indexOf('.'));</span>
<a href="#l3.1575"></a><span id="l3.1575" class="difflineplus">+      args[1] = args[1].substring(0, args[1].indexOf(&quot;.&quot;));</span>
<a href="#l3.1576"></a><span id="l3.1576"> </span>
<a href="#l3.1577"></a><span id="l3.1577">     if (typeof args[2] != &quot;object&quot;)</span>
<a href="#l3.1578"></a><span id="l3.1578">       args[2] = [args[2]];</span>
<a href="#l3.1579"></a><span id="l3.1579"> </span>
<a href="#l3.1580"></a><span id="l3.1580">     var response = &quot;&quot;;</span>
<a href="#l3.1581"></a><span id="l3.1581">     for (var i = 0; i &lt; messages.length; i++) {</span>
<a href="#l3.1582"></a><span id="l3.1582">       var message = messages[i];</span>
<a href="#l3.1583"></a><span id="l3.1583">       switch (args[1]) {</span>
<a href="#l3.1584"></a><span id="l3.1584">       case &quot;FLAGS&quot;:</span>
<a href="#l3.1585"></a><span id="l3.1585">         message.flags = args[2];</span>
<a href="#l3.1586"></a><span id="l3.1586">         break;</span>
<a href="#l3.1587"></a><span id="l3.1587">       case &quot;+FLAGS&quot;:</span>
<a href="#l3.1588"></a><span id="l3.1588" class="difflineminus">-        for (var flag of args[2])</span>
<a href="#l3.1589"></a><span id="l3.1589" class="difflineplus">+        for (let flag of args[2])</span>
<a href="#l3.1590"></a><span id="l3.1590">           message.setFlag(flag);</span>
<a href="#l3.1591"></a><span id="l3.1591">         break;</span>
<a href="#l3.1592"></a><span id="l3.1592">       case &quot;-FLAGS&quot;:</span>
<a href="#l3.1593"></a><span id="l3.1593" class="difflineminus">-        for (var flag of args[2]) {</span>
<a href="#l3.1594"></a><span id="l3.1594" class="difflineplus">+        for (let flag of args[2]) {</span>
<a href="#l3.1595"></a><span id="l3.1595">           var index;</span>
<a href="#l3.1596"></a><span id="l3.1596">           if ((index = message.flags.indexOf(flag)) != -1)</span>
<a href="#l3.1597"></a><span id="l3.1597">             message.flags.splice(index, 1);</span>
<a href="#l3.1598"></a><span id="l3.1598">         }</span>
<a href="#l3.1599"></a><span id="l3.1599">         break;</span>
<a href="#l3.1600"></a><span id="l3.1600">       default:</span>
<a href="#l3.1601"></a><span id="l3.1601">         return &quot;BAD change what now?&quot;;</span>
<a href="#l3.1602"></a><span id="l3.1602">       }</span>
<a href="#l3.1603"></a><span id="l3.1603">       response += &quot;* &quot; + ids[i] + &quot; FETCH (FLAGS (&quot;;</span>
<a href="#l3.1604"></a><span id="l3.1604" class="difflineminus">-      response += message.flags.join(' ');</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineminus">-      response += '))\0';</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineplus">+      response += message.flags.join(&quot; &quot;);</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineplus">+      response += &quot;))\0&quot;;</span>
<a href="#l3.1608"></a><span id="l3.1608">     }</span>
<a href="#l3.1609"></a><span id="l3.1609">     if (silent)</span>
<a href="#l3.1610"></a><span id="l3.1610">       response = &quot;&quot;;</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineminus">-    return response + 'OK STORE completed';</span>
<a href="#l3.1612"></a><span id="l3.1612" class="difflineplus">+    return response + &quot;OK STORE completed&quot;;</span>
<a href="#l3.1613"></a><span id="l3.1613">   },</span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineminus">-  COPY : function (args, uid) {</span>
<a href="#l3.1615"></a><span id="l3.1615" class="difflineplus">+  COPY(args, uid) {</span>
<a href="#l3.1616"></a><span id="l3.1616">     var messages = this._parseSequenceSet(args[0], uid);</span>
<a href="#l3.1617"></a><span id="l3.1617"> </span>
<a href="#l3.1618"></a><span id="l3.1618">     var dest = this._daemon.getMailbox(args[1]);</span>
<a href="#l3.1619"></a><span id="l3.1619">     if (!dest)</span>
<a href="#l3.1620"></a><span id="l3.1620">       return &quot;NO [TRYCREATE] what mailbox?&quot;;</span>
<a href="#l3.1621"></a><span id="l3.1621"> </span>
<a href="#l3.1622"></a><span id="l3.1622">     for (var message of messages) {</span>
<a href="#l3.1623"></a><span id="l3.1623">       let newMessage = new imapMessage(message._URI, dest.uidnext++,</span>
<a href="#l3.1624"></a><span id="l3.1624" class="difflineat">@@ -1360,239 +1345,242 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.1625"></a><span id="l3.1625">       while (true) {</span>
<a href="#l3.1626"></a><span id="l3.1626">         alarm = new Date();</span>
<a href="#l3.1627"></a><span id="l3.1627">         if (alarm.getTime() - startingMSeconds &gt; this._daemon.copySleep)</span>
<a href="#l3.1628"></a><span id="l3.1628">           break;</span>
<a href="#l3.1629"></a><span id="l3.1629">       }</span>
<a href="#l3.1630"></a><span id="l3.1630">     }</span>
<a href="#l3.1631"></a><span id="l3.1631">     return &quot;OK COPY completed&quot;;</span>
<a href="#l3.1632"></a><span id="l3.1632">   },</span>
<a href="#l3.1633"></a><span id="l3.1633" class="difflineminus">-  UID : function (args) {</span>
<a href="#l3.1634"></a><span id="l3.1634" class="difflineplus">+  UID(args) {</span>
<a href="#l3.1635"></a><span id="l3.1635">     var name = args.shift();</span>
<a href="#l3.1636"></a><span id="l3.1636" class="difflineminus">-    if (this.kUidCommands.indexOf(name) == -1)</span>
<a href="#l3.1637"></a><span id="l3.1637" class="difflineplus">+    if (!this.kUidCommands.includes(name))</span>
<a href="#l3.1638"></a><span id="l3.1638">       return &quot;BAD illegal command &quot; + name;</span>
<a href="#l3.1639"></a><span id="l3.1639"> </span>
<a href="#l3.1640"></a><span id="l3.1640">     args = this._treatArgs(args, name);</span>
<a href="#l3.1641"></a><span id="l3.1641">     return this[name](args, true);</span>
<a href="#l3.1642"></a><span id="l3.1642">   },</span>
<a href="#l3.1643"></a><span id="l3.1643"> </span>
<a href="#l3.1644"></a><span id="l3.1644" class="difflineminus">-  postCommand : function (reader) {</span>
<a href="#l3.1645"></a><span id="l3.1645" class="difflineplus">+  postCommand(reader) {</span>
<a href="#l3.1646"></a><span id="l3.1646">     if (this.closing) {</span>
<a href="#l3.1647"></a><span id="l3.1647">       this.closing = false;</span>
<a href="#l3.1648"></a><span id="l3.1648">       reader.closeSocket();</span>
<a href="#l3.1649"></a><span id="l3.1649">     }</span>
<a href="#l3.1650"></a><span id="l3.1650">     if (this.sendingLiteral)</span>
<a href="#l3.1651"></a><span id="l3.1651">       reader.preventLFMunge();</span>
<a href="#l3.1652"></a><span id="l3.1652">     reader.setMultiline(this._multiline);</span>
<a href="#l3.1653"></a><span id="l3.1653">     if (this._lastCommand == reader.watchWord)</span>
<a href="#l3.1654"></a><span id="l3.1654">       reader.stopTest();</span>
<a href="#l3.1655"></a><span id="l3.1655">   },</span>
<a href="#l3.1656"></a><span id="l3.1656" class="difflineminus">-  onServerFault : function (e) {</span>
<a href="#l3.1657"></a><span id="l3.1657" class="difflineminus">-    return (&quot;_tag&quot; in this ? this._tag : '*') + ' BAD Internal server error: ' + e;</span>
<a href="#l3.1658"></a><span id="l3.1658" class="difflineplus">+  onServerFault(e) {</span>
<a href="#l3.1659"></a><span id="l3.1659" class="difflineplus">+    return (&quot;_tag&quot; in this ? this._tag : &quot;*&quot;) + &quot; BAD Internal server error: &quot; + e;</span>
<a href="#l3.1660"></a><span id="l3.1660">   },</span>
<a href="#l3.1661"></a><span id="l3.1661"> </span>
<a href="#l3.1662"></a><span id="l3.1662" class="difflineminus">-  ////////////////////////////////////</span>
<a href="#l3.1663"></a><span id="l3.1663" class="difflineminus">-  // FETCH sub commands and helpers //</span>
<a href="#l3.1664"></a><span id="l3.1664" class="difflineminus">-  ////////////////////////////////////</span>
<a href="#l3.1665"></a><span id="l3.1665" class="difflineminus">-  fetchMacroExpansions : {</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineminus">-    ALL: [&quot;FLAGS&quot;, &quot;INTERNALDATE&quot;, &quot;RFC822.SIZE&quot;, /*&quot;ENVELOPE&quot;*/],</span>
<a href="#l3.1667"></a><span id="l3.1667" class="difflineplus">+  // FETCH sub commands and helpers</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineplus">+</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineplus">+  fetchMacroExpansions: {</span>
<a href="#l3.1670"></a><span id="l3.1670" class="difflineplus">+    ALL: [&quot;FLAGS&quot;, &quot;INTERNALDATE&quot;, &quot;RFC822.SIZE&quot;/* , &quot;ENVELOPE&quot; */],</span>
<a href="#l3.1671"></a><span id="l3.1671">     FAST: [&quot;FLAGS&quot;, &quot;INTERNALDATE&quot;, &quot;RFC822.SIZE&quot;],</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineminus">-    FULL: [&quot;FLAGS&quot;, &quot;INTERNALDATE&quot;, &quot;RFC822.SIZE&quot;, /*&quot;ENVELOPE&quot;, &quot;BODY&quot;*/]</span>
<a href="#l3.1673"></a><span id="l3.1673" class="difflineplus">+    FULL: [&quot;FLAGS&quot;, &quot;INTERNALDATE&quot;, &quot;RFC822.SIZE&quot;/* , &quot;ENVELOPE&quot;, &quot;BODY&quot; */],</span>
<a href="#l3.1674"></a><span id="l3.1674">   },</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineminus">-  _parseSequenceSet : function (set, uid, ids /*optional*/) {</span>
<a href="#l3.1676"></a><span id="l3.1676" class="difflineplus">+  _parseSequenceSet(set, uid, ids /* optional */) {</span>
<a href="#l3.1677"></a><span id="l3.1677">     if (typeof set == &quot;number&quot;) {</span>
<a href="#l3.1678"></a><span id="l3.1678">       if (uid) {</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineminus">-        for (var i = 0; i &lt; this._selectedMailbox._messages.length; i++) {</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineplus">+        for (let i = 0; i &lt; this._selectedMailbox._messages.length; i++) {</span>
<a href="#l3.1681"></a><span id="l3.1681">           var message = this._selectedMailbox._messages[i];</span>
<a href="#l3.1682"></a><span id="l3.1682">           if (message.uid == set) {</span>
<a href="#l3.1683"></a><span id="l3.1683">             if (ids)</span>
<a href="#l3.1684"></a><span id="l3.1684">               ids.push(i + 1);</span>
<a href="#l3.1685"></a><span id="l3.1685">             return [message];</span>
<a href="#l3.1686"></a><span id="l3.1686">           }</span>
<a href="#l3.1687"></a><span id="l3.1687">         }</span>
<a href="#l3.1688"></a><span id="l3.1688">         return [];</span>
<a href="#l3.1689"></a><span id="l3.1689" class="difflineminus">-      } else {</span>
<a href="#l3.1690"></a><span id="l3.1690" class="difflineminus">-        if (!(set - 1 in this._selectedMailbox._messages))</span>
<a href="#l3.1691"></a><span id="l3.1691" class="difflineminus">-          return [];</span>
<a href="#l3.1692"></a><span id="l3.1692" class="difflineminus">-        if (ids)</span>
<a href="#l3.1693"></a><span id="l3.1693" class="difflineminus">-          ids.push(set);</span>
<a href="#l3.1694"></a><span id="l3.1694" class="difflineminus">-        return [this._selectedMailbox._messages[set - 1]];</span>
<a href="#l3.1695"></a><span id="l3.1695">       }</span>
<a href="#l3.1696"></a><span id="l3.1696" class="difflineplus">+      if (!((set - 1) in this._selectedMailbox._messages))</span>
<a href="#l3.1697"></a><span id="l3.1697" class="difflineplus">+        return [];</span>
<a href="#l3.1698"></a><span id="l3.1698" class="difflineplus">+      if (ids)</span>
<a href="#l3.1699"></a><span id="l3.1699" class="difflineplus">+        ids.push(set);</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineplus">+      return [this._selectedMailbox._messages[set - 1]];</span>
<a href="#l3.1701"></a><span id="l3.1701">     }</span>
<a href="#l3.1702"></a><span id="l3.1702"> </span>
<a href="#l3.1703"></a><span id="l3.1703">     var daemon = this;</span>
<a href="#l3.1704"></a><span id="l3.1704">     function part2num(part) {</span>
<a href="#l3.1705"></a><span id="l3.1705" class="difflineminus">-      if (part == '*') {</span>
<a href="#l3.1706"></a><span id="l3.1706" class="difflineplus">+      if (part == &quot;*&quot;) {</span>
<a href="#l3.1707"></a><span id="l3.1707">         if (uid)</span>
<a href="#l3.1708"></a><span id="l3.1708">           return daemon._selectedMailbox._highestuid;</span>
<a href="#l3.1709"></a><span id="l3.1709" class="difflineminus">-        else</span>
<a href="#l3.1710"></a><span id="l3.1710" class="difflineminus">-          return daemon._selectedMailbox._messages.length;</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineplus">+        return daemon._selectedMailbox._messages.length;</span>
<a href="#l3.1712"></a><span id="l3.1712">       }</span>
<a href="#l3.1713"></a><span id="l3.1713">       let re = /[0-9]/g;</span>
<a href="#l3.1714"></a><span id="l3.1714">       let num = part.match(re);</span>
<a href="#l3.1715"></a><span id="l3.1715" class="difflineminus">-      if(!num || (num.length != part.length))</span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineminus">-        throw &quot;BAD invalid UID &quot; + part;</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineplus">+      if (!num || (num.length != part.length))</span>
<a href="#l3.1718"></a><span id="l3.1718" class="difflineplus">+        throw new Error(&quot;BAD invalid UID &quot; + part);</span>
<a href="#l3.1719"></a><span id="l3.1719">       return parseInt(part);</span>
<a href="#l3.1720"></a><span id="l3.1720">     }</span>
<a href="#l3.1721"></a><span id="l3.1721"> </span>
<a href="#l3.1722"></a><span id="l3.1722">     var elements = set.split(/,/);</span>
<a href="#l3.1723"></a><span id="l3.1723">     set = [];</span>
<a href="#l3.1724"></a><span id="l3.1724">     for (var part of elements) {</span>
<a href="#l3.1725"></a><span id="l3.1725" class="difflineminus">-      if (!part.includes(':')) {</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineplus">+      if (!part.includes(&quot;:&quot;)) {</span>
<a href="#l3.1727"></a><span id="l3.1727">         set.push(part2num(part));</span>
<a href="#l3.1728"></a><span id="l3.1728">       } else {</span>
<a href="#l3.1729"></a><span id="l3.1729">         var range = part.split(/:/);</span>
<a href="#l3.1730"></a><span id="l3.1730">         range[0] = part2num(range[0]);</span>
<a href="#l3.1731"></a><span id="l3.1731">         range[1] = part2num(range[1]);</span>
<a href="#l3.1732"></a><span id="l3.1732">         if (range[0] &gt; range[1]) {</span>
<a href="#l3.1733"></a><span id="l3.1733">           let temp = range[1];</span>
<a href="#l3.1734"></a><span id="l3.1734">           range[1] = range[0];</span>
<a href="#l3.1735"></a><span id="l3.1735">           range[0] = temp;</span>
<a href="#l3.1736"></a><span id="l3.1736">         }</span>
<a href="#l3.1737"></a><span id="l3.1737">         for (let i = range[0]; i &lt;= range[1]; i++)</span>
<a href="#l3.1738"></a><span id="l3.1738">           set.push(i);</span>
<a href="#l3.1739"></a><span id="l3.1739">       }</span>
<a href="#l3.1740"></a><span id="l3.1740">     }</span>
<a href="#l3.1741"></a><span id="l3.1741">     set.sort();</span>
<a href="#l3.1742"></a><span id="l3.1742" class="difflineminus">-    for (var i = set.length - 1; i &gt; 0; i--) {</span>
<a href="#l3.1743"></a><span id="l3.1743" class="difflineplus">+    for (let i = set.length - 1; i &gt; 0; i--) {</span>
<a href="#l3.1744"></a><span id="l3.1744">       if (set[i] == set[i - 1])</span>
<a href="#l3.1745"></a><span id="l3.1745">         set.splice(i, 0);</span>
<a href="#l3.1746"></a><span id="l3.1746">     }</span>
<a href="#l3.1747"></a><span id="l3.1747"> </span>
<a href="#l3.1748"></a><span id="l3.1748">     if (!ids)</span>
<a href="#l3.1749"></a><span id="l3.1749">       ids = [];</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineplus">+    var messages;</span>
<a href="#l3.1751"></a><span id="l3.1751">     if (uid) {</span>
<a href="#l3.1752"></a><span id="l3.1752" class="difflineminus">-      var messages = this._selectedMailbox._messages.filter(function (msg, i) {</span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineminus">-        if (set.indexOf(msg.uid) == -1)</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineplus">+      messages = this._selectedMailbox._messages.filter(function(msg, i) {</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineplus">+        if (!set.includes(msg.uid))</span>
<a href="#l3.1756"></a><span id="l3.1756">           return false;</span>
<a href="#l3.1757"></a><span id="l3.1757">         ids.push(i + 1);</span>
<a href="#l3.1758"></a><span id="l3.1758">         return true;</span>
<a href="#l3.1759"></a><span id="l3.1759">       });</span>
<a href="#l3.1760"></a><span id="l3.1760">     } else {</span>
<a href="#l3.1761"></a><span id="l3.1761" class="difflineminus">-      var messages = [];</span>
<a href="#l3.1762"></a><span id="l3.1762" class="difflineplus">+      messages = [];</span>
<a href="#l3.1763"></a><span id="l3.1763">       for (var id of set) {</span>
<a href="#l3.1764"></a><span id="l3.1764">         if (id - 1 in this._selectedMailbox._messages) {</span>
<a href="#l3.1765"></a><span id="l3.1765">           ids.push(id);</span>
<a href="#l3.1766"></a><span id="l3.1766">           messages.push(this._selectedMailbox._messages[id - 1]);</span>
<a href="#l3.1767"></a><span id="l3.1767">         }</span>
<a href="#l3.1768"></a><span id="l3.1768">       }</span>
<a href="#l3.1769"></a><span id="l3.1769">     }</span>
<a href="#l3.1770"></a><span id="l3.1770">     return messages;</span>
<a href="#l3.1771"></a><span id="l3.1771">   },</span>
<a href="#l3.1772"></a><span id="l3.1772" class="difflineminus">-  _FETCH_BODY : function (message, query) {</span>
<a href="#l3.1773"></a><span id="l3.1773" class="difflineplus">+  _FETCH_BODY(message, query) {</span>
<a href="#l3.1774"></a><span id="l3.1774">     if (query == &quot;BODY&quot;)</span>
<a href="#l3.1775"></a><span id="l3.1775">       return &quot;BODYSTRUCTURE &quot; + bodystructure(message.getText(), false);</span>
<a href="#l3.1776"></a><span id="l3.1776">     // parts = [ name, section, empty, {, partial, empty } ]</span>
<a href="#l3.1777"></a><span id="l3.1777">     var parts = query.split(/[[\]&lt;&gt;]/);</span>
<a href="#l3.1778"></a><span id="l3.1778"> </span>
<a href="#l3.1779"></a><span id="l3.1779">     if (parts[0] != &quot;BODY.PEEK&quot; &amp;&amp; !this._readOnly)</span>
<a href="#l3.1780"></a><span id="l3.1780">       message.setFlag(&quot;\\Seen&quot;);</span>
<a href="#l3.1781"></a><span id="l3.1781"> </span>
<a href="#l3.1782"></a><span id="l3.1782">     if (parts[3])</span>
<a href="#l3.1783"></a><span id="l3.1783" class="difflineminus">-      parts[3] = parts[3].split(/\./).map(function (e) { return parseInt(e); });</span>
<a href="#l3.1784"></a><span id="l3.1784" class="difflineplus">+      parts[3] = parts[3].split(/\./).map(function(e) { return parseInt(e); });</span>
<a href="#l3.1785"></a><span id="l3.1785"> </span>
<a href="#l3.1786"></a><span id="l3.1786">     if (parts[1].length == 0) {</span>
<a href="#l3.1787"></a><span id="l3.1787">       // Easy case: we have BODY[], just send the message...</span>
<a href="#l3.1788"></a><span id="l3.1788" class="difflineminus">-      var response = &quot;BODY[]&quot;;</span>
<a href="#l3.1789"></a><span id="l3.1789" class="difflineplus">+      let response = &quot;BODY[]&quot;;</span>
<a href="#l3.1790"></a><span id="l3.1790" class="difflineplus">+      var text;</span>
<a href="#l3.1791"></a><span id="l3.1791">       if (parts[3]) {</span>
<a href="#l3.1792"></a><span id="l3.1792">         response += &quot;&lt;&quot; + parts[3][0] + &quot;&gt;&quot;;</span>
<a href="#l3.1793"></a><span id="l3.1793" class="difflineminus">-        var text = message.getText(parts[3][0], parts[3][1]);</span>
<a href="#l3.1794"></a><span id="l3.1794" class="difflineplus">+        text = message.getText(parts[3][0], parts[3][1]);</span>
<a href="#l3.1795"></a><span id="l3.1795">       } else {</span>
<a href="#l3.1796"></a><span id="l3.1796" class="difflineminus">-        var text = message.getText();</span>
<a href="#l3.1797"></a><span id="l3.1797" class="difflineplus">+        text = message.getText();</span>
<a href="#l3.1798"></a><span id="l3.1798">       }</span>
<a href="#l3.1799"></a><span id="l3.1799">       response += &quot; {&quot; + text.length + &quot;}\r\n&quot;;</span>
<a href="#l3.1800"></a><span id="l3.1800">       response += text;</span>
<a href="#l3.1801"></a><span id="l3.1801">       return response;</span>
<a href="#l3.1802"></a><span id="l3.1802">     }</span>
<a href="#l3.1803"></a><span id="l3.1803"> </span>
<a href="#l3.1804"></a><span id="l3.1804">     // What's inside the command?</span>
<a href="#l3.1805"></a><span id="l3.1805">     var data = /((?:\d+\.)*\d+)(?:\.([^ ]+))?/.exec(parts[1]);</span>
<a href="#l3.1806"></a><span id="l3.1806" class="difflineplus">+    var partNum;</span>
<a href="#l3.1807"></a><span id="l3.1807">     if (data) {</span>
<a href="#l3.1808"></a><span id="l3.1808" class="difflineminus">-      var partNum = data[1];</span>
<a href="#l3.1809"></a><span id="l3.1809" class="difflineplus">+      partNum = data[1];</span>
<a href="#l3.1810"></a><span id="l3.1810">       query = data[2];</span>
<a href="#l3.1811"></a><span id="l3.1811">     } else {</span>
<a href="#l3.1812"></a><span id="l3.1812" class="difflineminus">-      var partNum = &quot;&quot;;</span>
<a href="#l3.1813"></a><span id="l3.1813" class="difflineplus">+      partNum = &quot;&quot;;</span>
<a href="#l3.1814"></a><span id="l3.1814">       if (parts[1].includes(&quot; &quot;, 1))</span>
<a href="#l3.1815"></a><span id="l3.1815">         query = parts[1].substring(0, parts[1].indexOf(&quot; &quot;));</span>
<a href="#l3.1816"></a><span id="l3.1816">       else</span>
<a href="#l3.1817"></a><span id="l3.1817">         query = parts[1];</span>
<a href="#l3.1818"></a><span id="l3.1818">     }</span>
<a href="#l3.1819"></a><span id="l3.1819" class="difflineplus">+    var queryArgs;</span>
<a href="#l3.1820"></a><span id="l3.1820">     if (parts[1].includes(&quot; &quot;, 1))</span>
<a href="#l3.1821"></a><span id="l3.1821" class="difflineminus">-      var queryArgs = parseCommand(parts[1].substr(parts[1].indexOf(&quot; &quot;)))[0];</span>
<a href="#l3.1822"></a><span id="l3.1822" class="difflineplus">+      queryArgs = parseCommand(parts[1].substr(parts[1].indexOf(&quot; &quot;)))[0];</span>
<a href="#l3.1823"></a><span id="l3.1823">     else</span>
<a href="#l3.1824"></a><span id="l3.1824" class="difflineminus">-      var queryArgs = [];</span>
<a href="#l3.1825"></a><span id="l3.1825" class="difflineplus">+      queryArgs = [];</span>
<a href="#l3.1826"></a><span id="l3.1826"> </span>
<a href="#l3.1827"></a><span id="l3.1827">     // Now we have three parameters representing the part number (empty for top-</span>
<a href="#l3.1828"></a><span id="l3.1828">     // level), the subportion representing what we want to find (empty for the</span>
<a href="#l3.1829"></a><span id="l3.1829">     // body), and an array of arguments if we have a subquery. If we made an</span>
<a href="#l3.1830"></a><span id="l3.1830">     // error here, it will pop until it gets to FETCH, which will just pop at a</span>
<a href="#l3.1831"></a><span id="l3.1831">     // BAD response, which is what should happen if the query is malformed.</span>
<a href="#l3.1832"></a><span id="l3.1832">     // Now we dump it all off onto imapMessage to mess with.</span>
<a href="#l3.1833"></a><span id="l3.1833"> </span>
<a href="#l3.1834"></a><span id="l3.1834">     // Start off the response</span>
<a href="#l3.1835"></a><span id="l3.1835" class="difflineminus">-    var response = &quot;BODY[&quot; + parts[1] + &quot;]&quot;;</span>
<a href="#l3.1836"></a><span id="l3.1836" class="difflineplus">+    let response = &quot;BODY[&quot; + parts[1] + &quot;]&quot;;</span>
<a href="#l3.1837"></a><span id="l3.1837">     if (parts[3])</span>
<a href="#l3.1838"></a><span id="l3.1838">       response += &quot;&lt;&quot; + parts[3][0] + &quot;&gt;&quot;;</span>
<a href="#l3.1839"></a><span id="l3.1839">     response += &quot; &quot;;</span>
<a href="#l3.1840"></a><span id="l3.1840"> </span>
<a href="#l3.1841"></a><span id="l3.1841" class="difflineminus">-    var data = &quot;&quot;;</span>
<a href="#l3.1842"></a><span id="l3.1842" class="difflineplus">+    data = &quot;&quot;;</span>
<a href="#l3.1843"></a><span id="l3.1843">     switch (query) {</span>
<a href="#l3.1844"></a><span id="l3.1844">     case &quot;&quot;:</span>
<a href="#l3.1845"></a><span id="l3.1845">     case &quot;TEXT&quot;:</span>
<a href="#l3.1846"></a><span id="l3.1846">       data += message.getPartBody(partNum);</span>
<a href="#l3.1847"></a><span id="l3.1847">       break;</span>
<a href="#l3.1848"></a><span id="l3.1848">     case &quot;HEADER&quot;: // I believe this specifies mime for an RFC822 message only</span>
<a href="#l3.1849"></a><span id="l3.1849">       data += message.getPartHeaders(partNum).rawHeaderText + &quot;\r\n&quot;;</span>
<a href="#l3.1850"></a><span id="l3.1850">       break;</span>
<a href="#l3.1851"></a><span id="l3.1851">     case &quot;MIME&quot;:</span>
<a href="#l3.1852"></a><span id="l3.1852">       data += message.getPartHeaders(partNum).rawHeaderText + &quot;\r\n\r\n&quot;;</span>
<a href="#l3.1853"></a><span id="l3.1853">       break;</span>
<a href="#l3.1854"></a><span id="l3.1854" class="difflineminus">-    case &quot;HEADER.FIELDS&quot;:</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineminus">-      var joinList = [];</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineminus">-      var headers = message.getPartHeaders(partNum);</span>
<a href="#l3.1857"></a><span id="l3.1857" class="difflineplus">+    case &quot;HEADER.FIELDS&quot;: {</span>
<a href="#l3.1858"></a><span id="l3.1858" class="difflineplus">+      let joinList = [];</span>
<a href="#l3.1859"></a><span id="l3.1859" class="difflineplus">+      let headers = message.getPartHeaders(partNum);</span>
<a href="#l3.1860"></a><span id="l3.1860">       for (let header of queryArgs) {</span>
<a href="#l3.1861"></a><span id="l3.1861">         header = header.toLowerCase();</span>
<a href="#l3.1862"></a><span id="l3.1862">         if (headers.has(header))</span>
<a href="#l3.1863"></a><span id="l3.1863">           joinList.push(headers.getRawHeader(header).map(value =&gt;</span>
<a href="#l3.1864"></a><span id="l3.1864" class="difflineminus">-                         `${header}: ${value}`).join('\r\n'));</span>
<a href="#l3.1865"></a><span id="l3.1865" class="difflineplus">+                         `${header}: ${value}`).join(&quot;\r\n&quot;));</span>
<a href="#l3.1866"></a><span id="l3.1866">       }</span>
<a href="#l3.1867"></a><span id="l3.1867" class="difflineminus">-      data += joinList.join('\r\n') + &quot;\r\n&quot;;</span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineplus">+      data += joinList.join(&quot;\r\n&quot;) + &quot;\r\n&quot;;</span>
<a href="#l3.1869"></a><span id="l3.1869">       break;</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineminus">-    case &quot;HEADER.FIELDS.NOT&quot;:</span>
<a href="#l3.1871"></a><span id="l3.1871" class="difflineminus">-      var joinList = [];</span>
<a href="#l3.1872"></a><span id="l3.1872" class="difflineminus">-      var headers = message.getPartHeaders(partNum);</span>
<a href="#l3.1873"></a><span id="l3.1873" class="difflineplus">+    }</span>
<a href="#l3.1874"></a><span id="l3.1874" class="difflineplus">+    case &quot;HEADER.FIELDS.NOT&quot;: {</span>
<a href="#l3.1875"></a><span id="l3.1875" class="difflineplus">+      let joinList = [];</span>
<a href="#l3.1876"></a><span id="l3.1876" class="difflineplus">+      let headers = message.getPartHeaders(partNum);</span>
<a href="#l3.1877"></a><span id="l3.1877">       for (let header of headers) {</span>
<a href="#l3.1878"></a><span id="l3.1878">         if (!(header in queryArgs))</span>
<a href="#l3.1879"></a><span id="l3.1879">           joinList.push(headers.getRawHeader(header).map(value =&gt;</span>
<a href="#l3.1880"></a><span id="l3.1880" class="difflineminus">-                         `${header}: ${value}`).join('\r\n'));</span>
<a href="#l3.1881"></a><span id="l3.1881" class="difflineplus">+                         `${header}: ${value}`).join(&quot;\r\n&quot;));</span>
<a href="#l3.1882"></a><span id="l3.1882">       }</span>
<a href="#l3.1883"></a><span id="l3.1883" class="difflineminus">-      data += joinList.join('\r\n') + &quot;\r\n&quot;;</span>
<a href="#l3.1884"></a><span id="l3.1884" class="difflineplus">+      data += joinList.join(&quot;\r\n&quot;) + &quot;\r\n&quot;;</span>
<a href="#l3.1885"></a><span id="l3.1885">       break;</span>
<a href="#l3.1886"></a><span id="l3.1886" class="difflineplus">+    }</span>
<a href="#l3.1887"></a><span id="l3.1887">     default:</span>
<a href="#l3.1888"></a><span id="l3.1888">       data += message.getPartBody(partNum);</span>
<a href="#l3.1889"></a><span id="l3.1889">     }</span>
<a href="#l3.1890"></a><span id="l3.1890"> </span>
<a href="#l3.1891"></a><span id="l3.1891">     this.sendingLiteral = true;</span>
<a href="#l3.1892"></a><span id="l3.1892" class="difflineminus">-    response += '{' + data.length + '}\r\n';</span>
<a href="#l3.1893"></a><span id="l3.1893" class="difflineplus">+    response += &quot;{&quot; + data.length + &quot;}\r\n&quot;;</span>
<a href="#l3.1894"></a><span id="l3.1894">     response += data;</span>
<a href="#l3.1895"></a><span id="l3.1895">     return response;</span>
<a href="#l3.1896"></a><span id="l3.1896">   },</span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineminus">-  _FETCH_BODYSTRUCTURE : function (message, query) {</span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineplus">+  _FETCH_BODYSTRUCTURE(message, query) {</span>
<a href="#l3.1899"></a><span id="l3.1899">     return &quot;BODYSTRUCTURE &quot; + bodystructure(message.getText(), true);</span>
<a href="#l3.1900"></a><span id="l3.1900">   },</span>
<a href="#l3.1901"></a><span id="l3.1901" class="difflineminus">-  //_FETCH_ENVELOPE,</span>
<a href="#l3.1902"></a><span id="l3.1902" class="difflineminus">-  _FETCH_FLAGS : function (message) {</span>
<a href="#l3.1903"></a><span id="l3.1903" class="difflineplus">+  // _FETCH_ENVELOPE,</span>
<a href="#l3.1904"></a><span id="l3.1904" class="difflineplus">+  _FETCH_FLAGS(message) {</span>
<a href="#l3.1905"></a><span id="l3.1905">     var response = &quot;FLAGS (&quot;;</span>
<a href="#l3.1906"></a><span id="l3.1906">     response += message.flags.join(&quot; &quot;);</span>
<a href="#l3.1907"></a><span id="l3.1907">     if (message.recent)</span>
<a href="#l3.1908"></a><span id="l3.1908">       response += &quot; \\Recent&quot;;</span>
<a href="#l3.1909"></a><span id="l3.1909">     response += &quot;)&quot;;</span>
<a href="#l3.1910"></a><span id="l3.1910">     return response;</span>
<a href="#l3.1911"></a><span id="l3.1911">   },</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineminus">-  _FETCH_INTERNALDATE : function (message) {</span>
<a href="#l3.1913"></a><span id="l3.1913" class="difflineplus">+  _FETCH_INTERNALDATE(message) {</span>
<a href="#l3.1914"></a><span id="l3.1914">     let date = message.date;</span>
<a href="#l3.1915"></a><span id="l3.1915">     // Format timestamp as: &quot;%d-%b-%Y %H:%M:%S %z&quot; (%b in English).</span>
<a href="#l3.1916"></a><span id="l3.1916">     let year = date.getFullYear().toString();</span>
<a href="#l3.1917"></a><span id="l3.1917">     let month = date.toLocaleDateString(&quot;en-US&quot;, {month: &quot;short&quot;});</span>
<a href="#l3.1918"></a><span id="l3.1918">     let day = date.getDate().toString();</span>
<a href="#l3.1919"></a><span id="l3.1919">     let hours = date.getHours().toString().padStart(2, &quot;0&quot;);</span>
<a href="#l3.1920"></a><span id="l3.1920">     let minutes = date.getMinutes().toString().padStart(2, &quot;0&quot;);</span>
<a href="#l3.1921"></a><span id="l3.1921">     let seconds = date.getSeconds().toString().padStart(2, &quot;0&quot;);</span>
<a href="#l3.1922"></a><span id="l3.1922" class="difflineat">@@ -1600,17 +1588,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.1923"></a><span id="l3.1923">     let tzoff = Math.floor(Math.abs(offset) / 60) * 100 + Math.abs(offset) % 60;</span>
<a href="#l3.1924"></a><span id="l3.1924">     let timeZone = (offset &lt; 0 ? &quot;+&quot; : &quot;-&quot;) + tzoff.toString().padStart(4, &quot;0&quot;);</span>
<a href="#l3.1925"></a><span id="l3.1925"> </span>
<a href="#l3.1926"></a><span id="l3.1926">     let response = &quot;INTERNALDATE \&quot;&quot;;</span>
<a href="#l3.1927"></a><span id="l3.1927">     response += `${day}-${month}-${year} ${hours}:${minutes}:${seconds} ${timeZone}`;</span>
<a href="#l3.1928"></a><span id="l3.1928">     response += &quot;\&quot;&quot;;</span>
<a href="#l3.1929"></a><span id="l3.1929">     return response;</span>
<a href="#l3.1930"></a><span id="l3.1930">   },</span>
<a href="#l3.1931"></a><span id="l3.1931" class="difflineminus">-  _FETCH_RFC822 : function (message, query) {</span>
<a href="#l3.1932"></a><span id="l3.1932" class="difflineplus">+  _FETCH_RFC822(message, query) {</span>
<a href="#l3.1933"></a><span id="l3.1933">     if (query == &quot;RFC822&quot;)</span>
<a href="#l3.1934"></a><span id="l3.1934">       return this._FETCH_BODY(message, &quot;BODY[]&quot;).replace(&quot;BODY[]&quot;, &quot;RFC822&quot;);</span>
<a href="#l3.1935"></a><span id="l3.1935">     if (query == &quot;RFC822.HEADER&quot;)</span>
<a href="#l3.1936"></a><span id="l3.1936">       return this._FETCH_BODY(message, &quot;BODY.PEEK[HEADER]&quot;)</span>
<a href="#l3.1937"></a><span id="l3.1937">                  .replace(&quot;BODY[HEADER]&quot;, &quot;RFC822.HEADER&quot;);</span>
<a href="#l3.1938"></a><span id="l3.1938">     if (query == &quot;RFC822.TEXT&quot;)</span>
<a href="#l3.1939"></a><span id="l3.1939">       return this._FETCH_BODY(message, &quot;BODY[TEXT]&quot;)</span>
<a href="#l3.1940"></a><span id="l3.1940">                  .replace(&quot;BODY[TEXT]&quot;, &quot;RFC822.TEXT&quot;);</span>
<a href="#l3.1941"></a><span id="l3.1941" class="difflineat">@@ -1619,124 +1607,127 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.1942"></a><span id="l3.1942">       var channel = message.channel;</span>
<a href="#l3.1943"></a><span id="l3.1943">       var length = message.size ? message.size : channel.contentLength;</span>
<a href="#l3.1944"></a><span id="l3.1944">       if (length == -1) {</span>
<a href="#l3.1945"></a><span id="l3.1945">         var inputStream = channel.open();</span>
<a href="#l3.1946"></a><span id="l3.1946">         length = inputStream.available();</span>
<a href="#l3.1947"></a><span id="l3.1947">         inputStream.close();</span>
<a href="#l3.1948"></a><span id="l3.1948">       }</span>
<a href="#l3.1949"></a><span id="l3.1949">       return &quot;RFC822.SIZE &quot; + length;</span>
<a href="#l3.1950"></a><span id="l3.1950" class="difflineminus">-    } else {</span>
<a href="#l3.1951"></a><span id="l3.1951" class="difflineminus">-      throw &quot;Unknown item &quot;+query;</span>
<a href="#l3.1952"></a><span id="l3.1952">     }</span>
<a href="#l3.1953"></a><span id="l3.1953" class="difflineplus">+    throw new Error(&quot;Unknown item &quot; + query);</span>
<a href="#l3.1954"></a><span id="l3.1954">   },</span>
<a href="#l3.1955"></a><span id="l3.1955" class="difflineminus">-  _FETCH_UID : function (message) {</span>
<a href="#l3.1956"></a><span id="l3.1956" class="difflineplus">+  _FETCH_UID(message) {</span>
<a href="#l3.1957"></a><span id="l3.1957">     return &quot;UID &quot; + message.uid;</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-  }</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineminus">-}</span>
<a href="#l3.1960"></a><span id="l3.1960" class="difflineplus">+  },</span>
<a href="#l3.1961"></a><span id="l3.1961" class="difflineplus">+};</span>
<a href="#l3.1962"></a><span id="l3.1962"> </span>
<a href="#l3.1963"></a><span id="l3.1963" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.1964"></a><span id="l3.1964" class="difflineminus">-//                            IMAP4 RFC extensions                            //</span>
<a href="#l3.1965"></a><span id="l3.1965" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineminus">-// Since there are so many extensions to IMAP, and since these extensions are //</span>
<a href="#l3.1967"></a><span id="l3.1967" class="difflineminus">-// not strictly hierarchical (e.g., an RFC 2342-compliant server can also be  //</span>
<a href="#l3.1968"></a><span id="l3.1968" class="difflineminus">-// RFC 3516-compliant, but a server might only implement one of them), they   //</span>
<a href="#l3.1969"></a><span id="l3.1969" class="difflineminus">-// must be handled differently from other fakeserver implementations.         //</span>
<a href="#l3.1970"></a><span id="l3.1970" class="difflineminus">-// An extension is defined as follows: it is an object (not a function and    //</span>
<a href="#l3.1971"></a><span id="l3.1971" class="difflineminus">-// prototype pair!). This object is &quot;mixed&quot; into the handler via the helper   //</span>
<a href="#l3.1972"></a><span id="l3.1972" class="difflineminus">-// function mixinExtension, which applies appropriate magic to make the       //</span>
<a href="#l3.1973"></a><span id="l3.1973" class="difflineminus">-// handler compliant to the extension. Functions are added untransformed, but //</span>
<a href="#l3.1974"></a><span id="l3.1974" class="difflineminus">-// both arrays and objects are handled by appending the values onto the       //</span>
<a href="#l3.1975"></a><span id="l3.1975" class="difflineminus">-// original state of the handler. Semantics apply as for the base itself.     //</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.1977"></a><span id="l3.1977" class="difflineplus">+// IMAP4 RFC extensions</span>
<a href="#l3.1978"></a><span id="l3.1978" class="difflineplus">+// --------------------</span>
<a href="#l3.1979"></a><span id="l3.1979" class="difflineplus">+// Since there are so many extensions to IMAP, and since these extensions are</span>
<a href="#l3.1980"></a><span id="l3.1980" class="difflineplus">+// not strictly hierarchical (e.g., an RFC 2342-compliant server can also be</span>
<a href="#l3.1981"></a><span id="l3.1981" class="difflineplus">+// RFC 3516-compliant, but a server might only implement one of them), they</span>
<a href="#l3.1982"></a><span id="l3.1982" class="difflineplus">+// must be handled differently from other fakeserver implementations.</span>
<a href="#l3.1983"></a><span id="l3.1983" class="difflineplus">+// An extension is defined as follows: it is an object (not a function and</span>
<a href="#l3.1984"></a><span id="l3.1984" class="difflineplus">+// prototype pair!). This object is &quot;mixed&quot; into the handler via the helper</span>
<a href="#l3.1985"></a><span id="l3.1985" class="difflineplus">+// function mixinExtension, which applies appropriate magic to make the</span>
<a href="#l3.1986"></a><span id="l3.1986" class="difflineplus">+// handler compliant to the extension. Functions are added untransformed, but</span>
<a href="#l3.1987"></a><span id="l3.1987" class="difflineplus">+// both arrays and objects are handled by appending the values onto the</span>
<a href="#l3.1988"></a><span id="l3.1988" class="difflineplus">+// original state of the handler. Semantics apply as for the base itself.</span>
<a href="#l3.1989"></a><span id="l3.1989"> </span>
<a href="#l3.1990"></a><span id="l3.1990"> // Note that UIDPLUS (RFC4315) should be mixed in last (or at least after the</span>
<a href="#l3.1991"></a><span id="l3.1991"> // MOVE extension) because it changes behavior of that extension.</span>
<a href="#l3.1992"></a><span id="l3.1992"> var configurations = {</span>
<a href="#l3.1993"></a><span id="l3.1993">   Cyrus: [&quot;RFC2342&quot;, &quot;RFC2195&quot;, &quot;RFC5258&quot;],</span>
<a href="#l3.1994"></a><span id="l3.1994">   UW: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l3.1995"></a><span id="l3.1995">   Dovecot: [&quot;RFC2195&quot;, &quot;RFC5258&quot;],</span>
<a href="#l3.1996"></a><span id="l3.1996">   Zimbra: [&quot;RFC2197&quot;, &quot;RFC2342&quot;, &quot;RFC2195&quot;, &quot;RFC5258&quot;],</span>
<a href="#l3.1997"></a><span id="l3.1997">   Exchange: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l3.1998"></a><span id="l3.1998">   LEMONADE: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l3.1999"></a><span id="l3.1999">   CUSTOM1: [&quot;MOVE&quot;, &quot;RFC4315&quot;, &quot;CUSTOM&quot;],</span>
<a href="#l3.2000"></a><span id="l3.2000" class="difflineminus">-  GMail: [&quot;GMAIL&quot;, &quot;RFC2197&quot;, &quot;RFC2342&quot;, &quot;RFC3348&quot;, &quot;RFC4315&quot;]</span>
<a href="#l3.2001"></a><span id="l3.2001" class="difflineplus">+  GMail: [&quot;GMAIL&quot;, &quot;RFC2197&quot;, &quot;RFC2342&quot;, &quot;RFC3348&quot;, &quot;RFC4315&quot;],</span>
<a href="#l3.2002"></a><span id="l3.2002"> };</span>
<a href="#l3.2003"></a><span id="l3.2003"> </span>
<a href="#l3.2004"></a><span id="l3.2004"> function mixinExtension(handler, extension) {</span>
<a href="#l3.2005"></a><span id="l3.2005">   if (extension.preload)</span>
<a href="#l3.2006"></a><span id="l3.2006">     extension.preload(handler);</span>
<a href="#l3.2007"></a><span id="l3.2007"> </span>
<a href="#l3.2008"></a><span id="l3.2008">   for (var property in extension) {</span>
<a href="#l3.2009"></a><span id="l3.2009" class="difflineminus">-    if (property == 'preload')</span>
<a href="#l3.2010"></a><span id="l3.2010" class="difflineplus">+    if (property == &quot;preload&quot;)</span>
<a href="#l3.2011"></a><span id="l3.2011">       continue;</span>
<a href="#l3.2012"></a><span id="l3.2012">     if (typeof extension[property] == &quot;function&quot;) {</span>
<a href="#l3.2013"></a><span id="l3.2013">       // This is a function, so we add it to the handler</span>
<a href="#l3.2014"></a><span id="l3.2014">       handler[property] = extension[property];</span>
<a href="#l3.2015"></a><span id="l3.2015">     } else if (extension[property] instanceof Array) {</span>
<a href="#l3.2016"></a><span id="l3.2016">       // This is an array, so we append the values</span>
<a href="#l3.2017"></a><span id="l3.2017">       if (!(property in handler))</span>
<a href="#l3.2018"></a><span id="l3.2018">         handler[property] = [];</span>
<a href="#l3.2019"></a><span id="l3.2019">       handler[property] = handler[property].concat(extension[property]);</span>
<a href="#l3.2020"></a><span id="l3.2020" class="difflineplus">+    } else if (property in handler) { // This is an object, so we add in the values</span>
<a href="#l3.2021"></a><span id="l3.2021" class="difflineplus">+      // Hack to make arrays et al. work recursively</span>
<a href="#l3.2022"></a><span id="l3.2022" class="difflineplus">+      mixinExtension(handler[property], extension[property]);</span>
<a href="#l3.2023"></a><span id="l3.2023">     } else {</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineminus">-      // This is an object, so we add in the values</span>
<a href="#l3.2025"></a><span id="l3.2025" class="difflineminus">-      if (property in handler)</span>
<a href="#l3.2026"></a><span id="l3.2026" class="difflineminus">-        // Hack to make arrays et al. work recursively</span>
<a href="#l3.2027"></a><span id="l3.2027" class="difflineminus">-        mixinExtension(handler[property], extension[property]);</span>
<a href="#l3.2028"></a><span id="l3.2028" class="difflineminus">-      else</span>
<a href="#l3.2029"></a><span id="l3.2029" class="difflineminus">-        handler[property] = extension[property];</span>
<a href="#l3.2030"></a><span id="l3.2030" class="difflineplus">+      handler[property] = extension[property];</span>
<a href="#l3.2031"></a><span id="l3.2031">     }</span>
<a href="#l3.2032"></a><span id="l3.2032">   }</span>
<a href="#l3.2033"></a><span id="l3.2033"> }</span>
<a href="#l3.2034"></a><span id="l3.2034"> </span>
<a href="#l3.2035"></a><span id="l3.2035"> // Support for Gmail extensions: XLIST and X-GM-EXT-1</span>
<a href="#l3.2036"></a><span id="l3.2036"> var IMAP_GMAIL_extension = {</span>
<a href="#l3.2037"></a><span id="l3.2037" class="difflineminus">-  preload: function (toBeThis) {</span>
<a href="#l3.2038"></a><span id="l3.2038" class="difflineplus">+  preload(toBeThis) {</span>
<a href="#l3.2039"></a><span id="l3.2039">     toBeThis._preGMAIL_STORE = toBeThis.STORE;</span>
<a href="#l3.2040"></a><span id="l3.2040">     toBeThis._preGMAIL_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l3.2041"></a><span id="l3.2041">     toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l3.2042"></a><span id="l3.2042">   },</span>
<a href="#l3.2043"></a><span id="l3.2043" class="difflineminus">-  XLIST : function (args) {</span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineplus">+  XLIST(args) {</span>
<a href="#l3.2045"></a><span id="l3.2045">     // XLIST is really just SPECIAL-USE that does not conform to RFC 6154</span>
<a href="#l3.2046"></a><span id="l3.2046">     args.push(&quot;RETURN&quot;);</span>
<a href="#l3.2047"></a><span id="l3.2047">     args.push(&quot;SPECIAL-USE&quot;);</span>
<a href="#l3.2048"></a><span id="l3.2048">     return this.LIST(args);</span>
<a href="#l3.2049"></a><span id="l3.2049">   },</span>
<a href="#l3.2050"></a><span id="l3.2050" class="difflineminus">-  _LIST_RETURN_CHILDREN : function (aBox) {</span>
<a href="#l3.2051"></a><span id="l3.2051" class="difflineplus">+  _LIST_RETURN_CHILDREN(aBox) {</span>
<a href="#l3.2052"></a><span id="l3.2052">     return IMAP_RFC5258_extension._LIST_RETURN_CHILDREN(aBox);</span>
<a href="#l3.2053"></a><span id="l3.2053">   },</span>
<a href="#l3.2054"></a><span id="l3.2054" class="difflineminus">-  _LIST_RETURN_CHILDREN_SPECIAL_USE : function (aBox) {</span>
<a href="#l3.2055"></a><span id="l3.2055" class="difflineplus">+  _LIST_RETURN_CHILDREN_SPECIAL_USE(aBox) {</span>
<a href="#l3.2056"></a><span id="l3.2056">     if (aBox.nonExistent) {</span>
<a href="#l3.2057"></a><span id="l3.2057">       return &quot;&quot;;</span>
<a href="#l3.2058"></a><span id="l3.2058">     }</span>
<a href="#l3.2059"></a><span id="l3.2059" class="difflineminus">-    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l3.2060"></a><span id="l3.2060" class="difflineminus">-           ((aBox._children.length &gt; 0) ?</span>
<a href="#l3.2061"></a><span id="l3.2061" class="difflineminus">-            (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasChildren') :</span>
<a href="#l3.2062"></a><span id="l3.2062" class="difflineminus">-            ((aBox.flags.indexOf('\\NoInferiors') == -1) ?</span>
<a href="#l3.2063"></a><span id="l3.2063" class="difflineminus">-             (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasNoChildren') :</span>
<a href="#l3.2064"></a><span id="l3.2064" class="difflineminus">-             '')) +</span>
<a href="#l3.2065"></a><span id="l3.2065" class="difflineminus">-           ((aBox.specialUseFlag &amp;&amp; aBox.specialUseFlag.length &gt; 0) ?</span>
<a href="#l3.2066"></a><span id="l3.2066" class="difflineminus">-            (' ' + aBox.specialUseFlag) : '') +</span>
<a href="#l3.2067"></a><span id="l3.2067" class="difflineminus">-           ') &quot;' + aBox.delimiter +</span>
<a href="#l3.2068"></a><span id="l3.2068" class="difflineminus">-           '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2069"></a><span id="l3.2069" class="difflineplus">+</span>
<a href="#l3.2070"></a><span id="l3.2070" class="difflineplus">+    let result = &quot;* LIST (&quot; + aBox.flags.join(&quot; &quot;);</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineplus">+    if (aBox._children.length &gt; 0) {</span>
<a href="#l3.2072"></a><span id="l3.2072" class="difflineplus">+      if (aBox.flags.length &gt; 0) {</span>
<a href="#l3.2073"></a><span id="l3.2073" class="difflineplus">+        result += &quot; &quot;;</span>
<a href="#l3.2074"></a><span id="l3.2074" class="difflineplus">+      }</span>
<a href="#l3.2075"></a><span id="l3.2075" class="difflineplus">+      result += &quot;\\HasChildren&quot;;</span>
<a href="#l3.2076"></a><span id="l3.2076" class="difflineplus">+    } else if (!aBox.flags.includes(&quot;\\NoInferiors&quot;)) {</span>
<a href="#l3.2077"></a><span id="l3.2077" class="difflineplus">+      if (aBox.flags.length &gt; 0) {</span>
<a href="#l3.2078"></a><span id="l3.2078" class="difflineplus">+        result += &quot; &quot;;</span>
<a href="#l3.2079"></a><span id="l3.2079" class="difflineplus">+      }</span>
<a href="#l3.2080"></a><span id="l3.2080" class="difflineplus">+      result += &quot;\\HasNoChildren&quot;;</span>
<a href="#l3.2081"></a><span id="l3.2081" class="difflineplus">+    }</span>
<a href="#l3.2082"></a><span id="l3.2082" class="difflineplus">+    if (aBox.specialUseFlag &amp;&amp; aBox.specialUseFlag.length &gt; 0) {</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineplus">+      result += &quot; &quot; + aBox.specialUseFlag;</span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineplus">+    }</span>
<a href="#l3.2085"></a><span id="l3.2085" class="difflineplus">+    result += ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2086"></a><span id="l3.2086" class="difflineplus">+    return result;</span>
<a href="#l3.2087"></a><span id="l3.2087">   },</span>
<a href="#l3.2088"></a><span id="l3.2088" class="difflineminus">-  STORE : function (args, uid) {</span>
<a href="#l3.2089"></a><span id="l3.2089" class="difflineplus">+  STORE(args, uid) {</span>
<a href="#l3.2090"></a><span id="l3.2090">     let regex = /[+-]?FLAGS.*/;</span>
<a href="#l3.2091"></a><span id="l3.2091">     if (regex.test(args[1])) {</span>
<a href="#l3.2092"></a><span id="l3.2092">       // if we are storing flags, use the method that was overridden</span>
<a href="#l3.2093"></a><span id="l3.2093">       this._argFormat = this._preGMAIL_STORE_argFormat;</span>
<a href="#l3.2094"></a><span id="l3.2094">       args = this._treatArgs(args, &quot;STORE&quot;);</span>
<a href="#l3.2095"></a><span id="l3.2095">       return this._preGMAIL_STORE(args, uid);</span>
<a href="#l3.2096"></a><span id="l3.2096">     }</span>
<a href="#l3.2097"></a><span id="l3.2097">     // otherwise, handle gmail specific cases</span>
<a href="#l3.2098"></a><span id="l3.2098">     let ids = [];</span>
<a href="#l3.2099"></a><span id="l3.2099">     let messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l3.2100"></a><span id="l3.2100">     args[2] = formatArg(args[2], &quot;string|(string)&quot;);</span>
<a href="#l3.2101"></a><span id="l3.2101">     for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l3.2102"></a><span id="l3.2102" class="difflineminus">-      if (args[2][i].indexOf(' ') &gt; -1) {</span>
<a href="#l3.2103"></a><span id="l3.2103" class="difflineplus">+      if (args[2][i].includes(&quot; &quot;)) {</span>
<a href="#l3.2104"></a><span id="l3.2104">         args[2][i] = '&quot;' + args[2][i] + '&quot;';</span>
<a href="#l3.2105"></a><span id="l3.2105">       }</span>
<a href="#l3.2106"></a><span id="l3.2106">     }</span>
<a href="#l3.2107"></a><span id="l3.2107">     let response = &quot;&quot;;</span>
<a href="#l3.2108"></a><span id="l3.2108">     for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l3.2109"></a><span id="l3.2109">       let message = messages[i];</span>
<a href="#l3.2110"></a><span id="l3.2110">       switch (args[1]) {</span>
<a href="#l3.2111"></a><span id="l3.2111">       case &quot;X-GM-LABELS&quot;:</span>
<a href="#l3.2112"></a><span id="l3.2112" class="difflineat">@@ -1753,61 +1744,58 @@ var IMAP_GMAIL_extension = {</span>
<a href="#l3.2113"></a><span id="l3.2113">           return &quot;BAD can't store X-GM-LABELS&quot;;</span>
<a href="#l3.2114"></a><span id="l3.2114">         }</span>
<a href="#l3.2115"></a><span id="l3.2115">         break;</span>
<a href="#l3.2116"></a><span id="l3.2116">       case &quot;-X-GM-LABELS&quot;:</span>
<a href="#l3.2117"></a><span id="l3.2117">         if (message.xGmLabels) {</span>
<a href="#l3.2118"></a><span id="l3.2118">           for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l3.2119"></a><span id="l3.2119">             let idx = message.xGmLabels.indexOf(args[2][i]);</span>
<a href="#l3.2120"></a><span id="l3.2120">             if (idx != -1) {</span>
<a href="#l3.2121"></a><span id="l3.2121" class="difflineminus">-              message.xGmLabels.splice(idx,1);</span>
<a href="#l3.2122"></a><span id="l3.2122" class="difflineplus">+              message.xGmLabels.splice(idx, 1);</span>
<a href="#l3.2123"></a><span id="l3.2123">             }</span>
<a href="#l3.2124"></a><span id="l3.2124">           }</span>
<a href="#l3.2125"></a><span id="l3.2125">         } else {</span>
<a href="#l3.2126"></a><span id="l3.2126">           return &quot;BAD can't store X-GM-LABELS&quot;;</span>
<a href="#l3.2127"></a><span id="l3.2127">         }</span>
<a href="#l3.2128"></a><span id="l3.2128">         break;</span>
<a href="#l3.2129"></a><span id="l3.2129">       default:</span>
<a href="#l3.2130"></a><span id="l3.2130">         return &quot;BAD change what now?&quot;;</span>
<a href="#l3.2131"></a><span id="l3.2131">       }</span>
<a href="#l3.2132"></a><span id="l3.2132">       response += &quot;* &quot; + ids[i] + &quot; FETCH (X-GM-LABELS (&quot;;</span>
<a href="#l3.2133"></a><span id="l3.2133" class="difflineminus">-      response += message.xGmLabels.join(' ');</span>
<a href="#l3.2134"></a><span id="l3.2134" class="difflineminus">-      response += '))\0';</span>
<a href="#l3.2135"></a><span id="l3.2135" class="difflineplus">+      response += message.xGmLabels.join(&quot; &quot;);</span>
<a href="#l3.2136"></a><span id="l3.2136" class="difflineplus">+      response += &quot;))\0&quot;;</span>
<a href="#l3.2137"></a><span id="l3.2137">     }</span>
<a href="#l3.2138"></a><span id="l3.2138" class="difflineminus">-    return response + 'OK STORE completed';</span>
<a href="#l3.2139"></a><span id="l3.2139" class="difflineplus">+    return response + &quot;OK STORE completed&quot;;</span>
<a href="#l3.2140"></a><span id="l3.2140">   },</span>
<a href="#l3.2141"></a><span id="l3.2141" class="difflineminus">-  _FETCH_X_GM_MSGID : function (message) {</span>
<a href="#l3.2142"></a><span id="l3.2142" class="difflineplus">+  _FETCH_X_GM_MSGID(message) {</span>
<a href="#l3.2143"></a><span id="l3.2143">     if (message.xGmMsgid) {</span>
<a href="#l3.2144"></a><span id="l3.2144" class="difflineminus">-        return &quot;X-GM-MSGID &quot; + message.xGmMsgid;</span>
<a href="#l3.2145"></a><span id="l3.2145" class="difflineminus">-    } else {</span>
<a href="#l3.2146"></a><span id="l3.2146" class="difflineminus">-        return &quot;BAD can't fetch X-GM-MSGID&quot;;</span>
<a href="#l3.2147"></a><span id="l3.2147" class="difflineplus">+      return &quot;X-GM-MSGID &quot; + message.xGmMsgid;</span>
<a href="#l3.2148"></a><span id="l3.2148">     }</span>
<a href="#l3.2149"></a><span id="l3.2149" class="difflineplus">+    return &quot;BAD can't fetch X-GM-MSGID&quot;;</span>
<a href="#l3.2150"></a><span id="l3.2150">   },</span>
<a href="#l3.2151"></a><span id="l3.2151" class="difflineminus">-  _FETCH_X_GM_THRID : function (message) {</span>
<a href="#l3.2152"></a><span id="l3.2152" class="difflineplus">+  _FETCH_X_GM_THRID(message) {</span>
<a href="#l3.2153"></a><span id="l3.2153">     if (message.xGmThrid) {</span>
<a href="#l3.2154"></a><span id="l3.2154" class="difflineminus">-        return &quot;X-GM-THRID &quot; + message.xGmThrid;</span>
<a href="#l3.2155"></a><span id="l3.2155" class="difflineminus">-    } else {</span>
<a href="#l3.2156"></a><span id="l3.2156" class="difflineminus">-        return &quot;BAD can't fetch X-GM-THRID&quot;;</span>
<a href="#l3.2157"></a><span id="l3.2157" class="difflineplus">+      return &quot;X-GM-THRID &quot; + message.xGmThrid;</span>
<a href="#l3.2158"></a><span id="l3.2158">     }</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineplus">+    return &quot;BAD can't fetch X-GM-THRID&quot;;</span>
<a href="#l3.2160"></a><span id="l3.2160">   },</span>
<a href="#l3.2161"></a><span id="l3.2161" class="difflineminus">-  _FETCH_X_GM_LABELS : function (message) {</span>
<a href="#l3.2162"></a><span id="l3.2162" class="difflineplus">+  _FETCH_X_GM_LABELS(message) {</span>
<a href="#l3.2163"></a><span id="l3.2163">     if (message.xGmLabels) {</span>
<a href="#l3.2164"></a><span id="l3.2164" class="difflineminus">-        return &quot;X-GM-LABELS &quot; + message.xGmLabels;</span>
<a href="#l3.2165"></a><span id="l3.2165" class="difflineminus">-    } else {</span>
<a href="#l3.2166"></a><span id="l3.2166" class="difflineminus">-        return &quot;BAD can't fetch X-GM-LABELS&quot;;</span>
<a href="#l3.2167"></a><span id="l3.2167" class="difflineplus">+      return &quot;X-GM-LABELS &quot; + message.xGmLabels;</span>
<a href="#l3.2168"></a><span id="l3.2168">     }</span>
<a href="#l3.2169"></a><span id="l3.2169" class="difflineplus">+    return &quot;BAD can't fetch X-GM-LABELS&quot;;</span>
<a href="#l3.2170"></a><span id="l3.2170">   },</span>
<a href="#l3.2171"></a><span id="l3.2171">   kCapabilities: [&quot;XLIST&quot;, &quot;X-GM-EXT-1&quot;],</span>
<a href="#l3.2172"></a><span id="l3.2172" class="difflineminus">-  _argFormat : { XLIST : [&quot;mailbox&quot;, &quot;mailbox&quot;] },</span>
<a href="#l3.2173"></a><span id="l3.2173" class="difflineplus">+  _argFormat: { XLIST: [&quot;mailbox&quot;, &quot;mailbox&quot;] },</span>
<a href="#l3.2174"></a><span id="l3.2174">   // Enabled in AUTHED and SELECTED states</span>
<a href="#l3.2175"></a><span id="l3.2175" class="difflineminus">-  _enabledCommands : { 1 : [&quot;XLIST&quot;], 2 : [&quot;XLIST&quot;] }</span>
<a href="#l3.2176"></a><span id="l3.2176" class="difflineplus">+  _enabledCommands: { 1: [&quot;XLIST&quot;], 2: [&quot;XLIST&quot;] },</span>
<a href="#l3.2177"></a><span id="l3.2177"> };</span>
<a href="#l3.2178"></a><span id="l3.2178"> </span>
<a href="#l3.2179"></a><span id="l3.2179"> var IMAP_MOVE_extension = {</span>
<a href="#l3.2180"></a><span id="l3.2180" class="difflineminus">-  MOVE: function (args, uid) {</span>
<a href="#l3.2181"></a><span id="l3.2181" class="difflineplus">+  MOVE(args, uid) {</span>
<a href="#l3.2182"></a><span id="l3.2182">     let messages = this._parseSequenceSet(args[0], uid);</span>
<a href="#l3.2183"></a><span id="l3.2183"> </span>
<a href="#l3.2184"></a><span id="l3.2184">     let dest = this._daemon.getMailbox(args[1]);</span>
<a href="#l3.2185"></a><span id="l3.2185">     if (!dest)</span>
<a href="#l3.2186"></a><span id="l3.2186">       return &quot;NO [TRYCREATE] what mailbox?&quot;;</span>
<a href="#l3.2187"></a><span id="l3.2187"> </span>
<a href="#l3.2188"></a><span id="l3.2188">     for (var message of messages) {</span>
<a href="#l3.2189"></a><span id="l3.2189">       let newMessage = new imapMessage(message._URI, dest.uidnext++,</span>
<a href="#l3.2190"></a><span id="l3.2190" class="difflineat">@@ -1828,40 +1816,40 @@ var IMAP_MOVE_extension = {</span>
<a href="#l3.2191"></a><span id="l3.2191">       delete mailbox.__highestuid;</span>
<a href="#l3.2192"></a><span id="l3.2192"> </span>
<a href="#l3.2193"></a><span id="l3.2193">     return response + &quot;OK MOVE completed&quot;;</span>
<a href="#l3.2194"></a><span id="l3.2194">   },</span>
<a href="#l3.2195"></a><span id="l3.2195">   kCapabilities: [&quot;MOVE&quot;],</span>
<a href="#l3.2196"></a><span id="l3.2196">   kUidCommands: [&quot;MOVE&quot;],</span>
<a href="#l3.2197"></a><span id="l3.2197">   _argFormat: { MOVE: [&quot;number&quot;, &quot;mailbox&quot;] },</span>
<a href="#l3.2198"></a><span id="l3.2198">   // Enabled in SELECTED state</span>
<a href="#l3.2199"></a><span id="l3.2199" class="difflineminus">-  _enabledCommands: { 2: [&quot;MOVE&quot;] }</span>
<a href="#l3.2200"></a><span id="l3.2200" class="difflineplus">+  _enabledCommands: { 2: [&quot;MOVE&quot;] },</span>
<a href="#l3.2201"></a><span id="l3.2201"> };</span>
<a href="#l3.2202"></a><span id="l3.2202"> </span>
<a href="#l3.2203"></a><span id="l3.2203"> // Provides methods for testing fetchCustomAttribute and issueCustomCommand</span>
<a href="#l3.2204"></a><span id="l3.2204"> var IMAP_CUSTOM_extension = {</span>
<a href="#l3.2205"></a><span id="l3.2205" class="difflineminus">-  preload: function (toBeThis) {</span>
<a href="#l3.2206"></a><span id="l3.2206" class="difflineplus">+  preload(toBeThis) {</span>
<a href="#l3.2207"></a><span id="l3.2207">     toBeThis._preCUSTOM_STORE = toBeThis.STORE;</span>
<a href="#l3.2208"></a><span id="l3.2208">     toBeThis._preCUSTOM_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l3.2209"></a><span id="l3.2209">     toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l3.2210"></a><span id="l3.2210">   },</span>
<a href="#l3.2211"></a><span id="l3.2211" class="difflineminus">-  STORE : function (args, uid) {</span>
<a href="#l3.2212"></a><span id="l3.2212" class="difflineplus">+  STORE(args, uid) {</span>
<a href="#l3.2213"></a><span id="l3.2213">     let regex = /[+-]?FLAGS.*/;</span>
<a href="#l3.2214"></a><span id="l3.2214">     if (regex.test(args[1])) {</span>
<a href="#l3.2215"></a><span id="l3.2215">       // if we are storing flags, use the method that was overridden</span>
<a href="#l3.2216"></a><span id="l3.2216">       this._argFormat = this._preCUSTOM_STORE_argFormat;</span>
<a href="#l3.2217"></a><span id="l3.2217">       args = this._treatArgs(args, &quot;STORE&quot;);</span>
<a href="#l3.2218"></a><span id="l3.2218">       return this._preCUSTOM_STORE(args, uid);</span>
<a href="#l3.2219"></a><span id="l3.2219">     }</span>
<a href="#l3.2220"></a><span id="l3.2220">     // otherwise, handle custom attribute</span>
<a href="#l3.2221"></a><span id="l3.2221">     let ids = [];</span>
<a href="#l3.2222"></a><span id="l3.2222">     let messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l3.2223"></a><span id="l3.2223">     args[2] = formatArg(args[2], &quot;string|(string)&quot;);</span>
<a href="#l3.2224"></a><span id="l3.2224">     for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l3.2225"></a><span id="l3.2225" class="difflineminus">-      if (args[2][i].indexOf(' ') &gt; -1) {</span>
<a href="#l3.2226"></a><span id="l3.2226" class="difflineplus">+      if (args[2][i].includes(&quot; &quot;)) {</span>
<a href="#l3.2227"></a><span id="l3.2227">         args[2][i] = '&quot;' + args[2][i] + '&quot;';</span>
<a href="#l3.2228"></a><span id="l3.2228">       }</span>
<a href="#l3.2229"></a><span id="l3.2229">     }</span>
<a href="#l3.2230"></a><span id="l3.2230">     let response = &quot;&quot;;</span>
<a href="#l3.2231"></a><span id="l3.2231">     for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l3.2232"></a><span id="l3.2232">       let message = messages[i];</span>
<a href="#l3.2233"></a><span id="l3.2233">       switch (args[1]) {</span>
<a href="#l3.2234"></a><span id="l3.2234">       case &quot;X-CUSTOM-VALUE&quot;:</span>
<a href="#l3.2235"></a><span id="l3.2235" class="difflineat">@@ -1885,349 +1873,356 @@ var IMAP_CUSTOM_extension = {</span>
<a href="#l3.2236"></a><span id="l3.2236">           return &quot;BAD can't store X-CUSTOM-LIST&quot;;</span>
<a href="#l3.2237"></a><span id="l3.2237">         }</span>
<a href="#l3.2238"></a><span id="l3.2238">         break;</span>
<a href="#l3.2239"></a><span id="l3.2239">       case &quot;-X-CUSTOM-LIST&quot;:</span>
<a href="#l3.2240"></a><span id="l3.2240">         if (message.xCustomList) {</span>
<a href="#l3.2241"></a><span id="l3.2241">           for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l3.2242"></a><span id="l3.2242">             let idx = message.xCustomList.indexOf(args[2][i]);</span>
<a href="#l3.2243"></a><span id="l3.2243">             if (idx != -1) {</span>
<a href="#l3.2244"></a><span id="l3.2244" class="difflineminus">-              message.xCustomList.splice(idx,1);</span>
<a href="#l3.2245"></a><span id="l3.2245" class="difflineplus">+              message.xCustomList.splice(idx, 1);</span>
<a href="#l3.2246"></a><span id="l3.2246">             }</span>
<a href="#l3.2247"></a><span id="l3.2247">           }</span>
<a href="#l3.2248"></a><span id="l3.2248">         } else {</span>
<a href="#l3.2249"></a><span id="l3.2249">           return &quot;BAD can't store X-CUSTOM-LIST&quot;;</span>
<a href="#l3.2250"></a><span id="l3.2250">         }</span>
<a href="#l3.2251"></a><span id="l3.2251">         break;</span>
<a href="#l3.2252"></a><span id="l3.2252">       default:</span>
<a href="#l3.2253"></a><span id="l3.2253">         return &quot;BAD change what now?&quot;;</span>
<a href="#l3.2254"></a><span id="l3.2254">       }</span>
<a href="#l3.2255"></a><span id="l3.2255">       response += &quot;* &quot; + ids[i] + &quot; FETCH (X-CUSTOM-LIST (&quot;;</span>
<a href="#l3.2256"></a><span id="l3.2256" class="difflineminus">-      response += message.xCustomList.join(' ');</span>
<a href="#l3.2257"></a><span id="l3.2257" class="difflineminus">-      response += '))\0';</span>
<a href="#l3.2258"></a><span id="l3.2258" class="difflineplus">+      response += message.xCustomList.join(&quot; &quot;);</span>
<a href="#l3.2259"></a><span id="l3.2259" class="difflineplus">+      response += &quot;))\0&quot;;</span>
<a href="#l3.2260"></a><span id="l3.2260">     }</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineminus">-    return response + 'OK STORE completed';</span>
<a href="#l3.2262"></a><span id="l3.2262" class="difflineplus">+    return response + &quot;OK STORE completed&quot;;</span>
<a href="#l3.2263"></a><span id="l3.2263">   },</span>
<a href="#l3.2264"></a><span id="l3.2264" class="difflineminus">-  _FETCH_X_CUSTOM_VALUE : function (message) {</span>
<a href="#l3.2265"></a><span id="l3.2265" class="difflineplus">+  _FETCH_X_CUSTOM_VALUE(message) {</span>
<a href="#l3.2266"></a><span id="l3.2266">     if (message.xCustomValue) {</span>
<a href="#l3.2267"></a><span id="l3.2267" class="difflineminus">-        return &quot;X-CUSTOM-VALUE &quot; + message.xCustomValue;</span>
<a href="#l3.2268"></a><span id="l3.2268" class="difflineminus">-    } else {</span>
<a href="#l3.2269"></a><span id="l3.2269" class="difflineminus">-        return &quot;BAD can't fetch X-CUSTOM-VALUE&quot;;</span>
<a href="#l3.2270"></a><span id="l3.2270" class="difflineplus">+      return &quot;X-CUSTOM-VALUE &quot; + message.xCustomValue;</span>
<a href="#l3.2271"></a><span id="l3.2271">     }</span>
<a href="#l3.2272"></a><span id="l3.2272" class="difflineplus">+    return &quot;BAD can't fetch X-CUSTOM-VALUE&quot;;</span>
<a href="#l3.2273"></a><span id="l3.2273">   },</span>
<a href="#l3.2274"></a><span id="l3.2274" class="difflineminus">-  _FETCH_X_CUSTOM_LIST : function (message) {</span>
<a href="#l3.2275"></a><span id="l3.2275" class="difflineplus">+  _FETCH_X_CUSTOM_LIST(message) {</span>
<a href="#l3.2276"></a><span id="l3.2276">     if (message.xCustomList) {</span>
<a href="#l3.2277"></a><span id="l3.2277" class="difflineminus">-        return &quot;X-CUSTOM-LIST (&quot; + message.xCustomList.join(' ') + &quot;)&quot;;</span>
<a href="#l3.2278"></a><span id="l3.2278" class="difflineminus">-    } else {</span>
<a href="#l3.2279"></a><span id="l3.2279" class="difflineminus">-        return &quot;BAD can't fetch X-CUSTOM-LIST&quot;;</span>
<a href="#l3.2280"></a><span id="l3.2280" class="difflineplus">+      return &quot;X-CUSTOM-LIST (&quot; + message.xCustomList.join(&quot; &quot;) + &quot;)&quot;;</span>
<a href="#l3.2281"></a><span id="l3.2281">     }</span>
<a href="#l3.2282"></a><span id="l3.2282" class="difflineplus">+    return &quot;BAD can't fetch X-CUSTOM-LIST&quot;;</span>
<a href="#l3.2283"></a><span id="l3.2283">   },</span>
<a href="#l3.2284"></a><span id="l3.2284" class="difflineminus">-  kCapabilities: [&quot;X-CUSTOM1&quot;]</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineplus">+  kCapabilities: [&quot;X-CUSTOM1&quot;],</span>
<a href="#l3.2286"></a><span id="l3.2286"> };</span>
<a href="#l3.2287"></a><span id="l3.2287"> </span>
<a href="#l3.2288"></a><span id="l3.2288"> // RFC 2197: ID</span>
<a href="#l3.2289"></a><span id="l3.2289"> var IMAP_RFC2197_extension = {</span>
<a href="#l3.2290"></a><span id="l3.2290" class="difflineminus">-  ID : function (args) {</span>
<a href="#l3.2291"></a><span id="l3.2291" class="difflineplus">+  ID(args) {</span>
<a href="#l3.2292"></a><span id="l3.2292">     let clientID = &quot;(&quot;;</span>
<a href="#l3.2293"></a><span id="l3.2293">     for (let i of args)</span>
<a href="#l3.2294"></a><span id="l3.2294">       clientID += &quot;\&quot;&quot; + i + &quot;\&quot;&quot;;</span>
<a href="#l3.2295"></a><span id="l3.2295"> </span>
<a href="#l3.2296"></a><span id="l3.2296">     clientID += &quot;)&quot;;</span>
<a href="#l3.2297"></a><span id="l3.2297">     let clientStrings = clientID.split(&quot;,&quot;);</span>
<a href="#l3.2298"></a><span id="l3.2298">     clientID = &quot;&quot;;</span>
<a href="#l3.2299"></a><span id="l3.2299">     for (let i of clientStrings)</span>
<a href="#l3.2300"></a><span id="l3.2300" class="difflineminus">-      clientID += &quot;\&quot;&quot; + i + &quot;\&quot; &quot;</span>
<a href="#l3.2301"></a><span id="l3.2301" class="difflineplus">+      clientID += &quot;\&quot;&quot; + i + &quot;\&quot; &quot;;</span>
<a href="#l3.2302"></a><span id="l3.2302">     clientID = clientID.slice(1, clientID.length - 3);</span>
<a href="#l3.2303"></a><span id="l3.2303">     clientID += &quot;)&quot;;</span>
<a href="#l3.2304"></a><span id="l3.2304">     this._daemon.clientID = clientID;</span>
<a href="#l3.2305"></a><span id="l3.2305">     return &quot;* ID &quot; + this._daemon.idResponse + &quot;\0OK Success&quot;;</span>
<a href="#l3.2306"></a><span id="l3.2306">   },</span>
<a href="#l3.2307"></a><span id="l3.2307">   kCapabilities: [&quot;ID&quot;],</span>
<a href="#l3.2308"></a><span id="l3.2308">   _argFormat: { ID: [&quot;(string)&quot;] },</span>
<a href="#l3.2309"></a><span id="l3.2309" class="difflineminus">-  _enabledCommands : { 1 : [&quot;ID&quot;], 2 : [&quot;ID&quot;] }</span>
<a href="#l3.2310"></a><span id="l3.2310" class="difflineplus">+  _enabledCommands: { 1: [&quot;ID&quot;], 2: [&quot;ID&quot;] },</span>
<a href="#l3.2311"></a><span id="l3.2311"> };</span>
<a href="#l3.2312"></a><span id="l3.2312"> </span>
<a href="#l3.2313"></a><span id="l3.2313"> // RFC 2342: IMAP4 Namespace (NAMESPACE)</span>
<a href="#l3.2314"></a><span id="l3.2314"> var IMAP_RFC2342_extension = {</span>
<a href="#l3.2315"></a><span id="l3.2315" class="difflineminus">-  NAMESPACE : function (args) {</span>
<a href="#l3.2316"></a><span id="l3.2316" class="difflineplus">+  NAMESPACE(args) {</span>
<a href="#l3.2317"></a><span id="l3.2317">     var namespaces = [[], [], []];</span>
<a href="#l3.2318"></a><span id="l3.2318" class="difflineminus">-    for (var namespace of this._daemon.namespaces)</span>
<a href="#l3.2319"></a><span id="l3.2319" class="difflineplus">+    for (let namespace of this._daemon.namespaces) {</span>
<a href="#l3.2320"></a><span id="l3.2320">       namespaces[namespace.type].push(namespace);</span>
<a href="#l3.2321"></a><span id="l3.2321" class="difflineplus">+    }</span>
<a href="#l3.2322"></a><span id="l3.2322"> </span>
<a href="#l3.2323"></a><span id="l3.2323">     var response = &quot;* NAMESPACE&quot;;</span>
<a href="#l3.2324"></a><span id="l3.2324">     for (var type of namespaces) {</span>
<a href="#l3.2325"></a><span id="l3.2325">       if (type.length == 0) {</span>
<a href="#l3.2326"></a><span id="l3.2326">         response += &quot; NIL&quot;;</span>
<a href="#l3.2327"></a><span id="l3.2327">         continue;</span>
<a href="#l3.2328"></a><span id="l3.2328">       }</span>
<a href="#l3.2329"></a><span id="l3.2329">       response += &quot; (&quot;;</span>
<a href="#l3.2330"></a><span id="l3.2330" class="difflineminus">-      for (var namespace of type) {</span>
<a href="#l3.2331"></a><span id="l3.2331" class="difflineplus">+      for (let namespace of type) {</span>
<a href="#l3.2332"></a><span id="l3.2332">         response += &quot;(\&quot;&quot;;</span>
<a href="#l3.2333"></a><span id="l3.2333">         response += namespace.displayName;</span>
<a href="#l3.2334"></a><span id="l3.2334">         response += &quot;\&quot; \&quot;&quot;;</span>
<a href="#l3.2335"></a><span id="l3.2335">         response += namespace.delimiter;</span>
<a href="#l3.2336"></a><span id="l3.2336">         response += &quot;\&quot;)&quot;;</span>
<a href="#l3.2337"></a><span id="l3.2337">       }</span>
<a href="#l3.2338"></a><span id="l3.2338">       response += &quot;)&quot;;</span>
<a href="#l3.2339"></a><span id="l3.2339">     }</span>
<a href="#l3.2340"></a><span id="l3.2340">     response += &quot;\0OK NAMESPACE command completed&quot;;</span>
<a href="#l3.2341"></a><span id="l3.2341">     return response;</span>
<a href="#l3.2342"></a><span id="l3.2342">   },</span>
<a href="#l3.2343"></a><span id="l3.2343" class="difflineminus">-  kCapabilities : [&quot;NAMESPACE&quot;],</span>
<a href="#l3.2344"></a><span id="l3.2344" class="difflineminus">-  _argFormat : { NAMESPACE : [] },</span>
<a href="#l3.2345"></a><span id="l3.2345" class="difflineplus">+  kCapabilities: [&quot;NAMESPACE&quot;],</span>
<a href="#l3.2346"></a><span id="l3.2346" class="difflineplus">+  _argFormat: { NAMESPACE: [] },</span>
<a href="#l3.2347"></a><span id="l3.2347">   // Enabled in AUTHED and SELECTED states</span>
<a href="#l3.2348"></a><span id="l3.2348" class="difflineminus">-  _enabledCommands : { 1 : [&quot;NAMESPACE&quot;], 2 : [&quot;NAMESPACE&quot;] }</span>
<a href="#l3.2349"></a><span id="l3.2349" class="difflineplus">+  _enabledCommands: { 1: [&quot;NAMESPACE&quot;], 2: [&quot;NAMESPACE&quot;] },</span>
<a href="#l3.2350"></a><span id="l3.2350"> };</span>
<a href="#l3.2351"></a><span id="l3.2351"> </span>
<a href="#l3.2352"></a><span id="l3.2352"> // RFC 3348 Child Mailbox (CHILDREN)</span>
<a href="#l3.2353"></a><span id="l3.2353"> var IMAP_RFC3348_extension = {</span>
<a href="#l3.2354"></a><span id="l3.2354" class="difflineminus">-  kCapabilities: [&quot;CHILDREN&quot;]</span>
<a href="#l3.2355"></a><span id="l3.2355" class="difflineminus">-}</span>
<a href="#l3.2356"></a><span id="l3.2356" class="difflineplus">+  kCapabilities: [&quot;CHILDREN&quot;],</span>
<a href="#l3.2357"></a><span id="l3.2357" class="difflineplus">+};</span>
<a href="#l3.2358"></a><span id="l3.2358"> </span>
<a href="#l3.2359"></a><span id="l3.2359"> // RFC 4315: UIDPLUS</span>
<a href="#l3.2360"></a><span id="l3.2360"> var IMAP_RFC4315_extension = {</span>
<a href="#l3.2361"></a><span id="l3.2361" class="difflineminus">-  preload: function (toBeThis) {</span>
<a href="#l3.2362"></a><span id="l3.2362" class="difflineplus">+  preload(toBeThis) {</span>
<a href="#l3.2363"></a><span id="l3.2363">     toBeThis._preRFC4315UID = toBeThis.UID;</span>
<a href="#l3.2364"></a><span id="l3.2364">     toBeThis._preRFC4315APPEND = toBeThis.APPEND;</span>
<a href="#l3.2365"></a><span id="l3.2365">     toBeThis._preRFC4315COPY = toBeThis.COPY;</span>
<a href="#l3.2366"></a><span id="l3.2366">     toBeThis._preRFC4315MOVE = toBeThis.MOVE;</span>
<a href="#l3.2367"></a><span id="l3.2367">   },</span>
<a href="#l3.2368"></a><span id="l3.2368" class="difflineminus">-  UID: function (args) {</span>
<a href="#l3.2369"></a><span id="l3.2369" class="difflineplus">+  UID(args) {</span>
<a href="#l3.2370"></a><span id="l3.2370">     // XXX: UID EXPUNGE is not supported.</span>
<a href="#l3.2371"></a><span id="l3.2371">     return this._preRFC4315UID(args);</span>
<a href="#l3.2372"></a><span id="l3.2372">   },</span>
<a href="#l3.2373"></a><span id="l3.2373" class="difflineminus">-  APPEND: function (args) {</span>
<a href="#l3.2374"></a><span id="l3.2374" class="difflineplus">+  APPEND(args) {</span>
<a href="#l3.2375"></a><span id="l3.2375">     let response = this._preRFC4315APPEND(args);</span>
<a href="#l3.2376"></a><span id="l3.2376">     if (response.indexOf(&quot;OK&quot;) == 0) {</span>
<a href="#l3.2377"></a><span id="l3.2377">       let mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.2378"></a><span id="l3.2378">       let uid = mailbox.uidnext - 1;</span>
<a href="#l3.2379"></a><span id="l3.2379">       response = &quot;OK [APPENDUID &quot; + mailbox.uidvalidity + &quot; &quot; + uid + &quot;]&quot; +</span>
<a href="#l3.2380"></a><span id="l3.2380">                    response.substring(2);</span>
<a href="#l3.2381"></a><span id="l3.2381">     }</span>
<a href="#l3.2382"></a><span id="l3.2382">     return response;</span>
<a href="#l3.2383"></a><span id="l3.2383">   },</span>
<a href="#l3.2384"></a><span id="l3.2384" class="difflineminus">-  COPY: function (args) {</span>
<a href="#l3.2385"></a><span id="l3.2385" class="difflineplus">+  COPY(args) {</span>
<a href="#l3.2386"></a><span id="l3.2386">     let mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l3.2387"></a><span id="l3.2387">     if (mailbox)</span>
<a href="#l3.2388"></a><span id="l3.2388">       var first = mailbox.uidnext;</span>
<a href="#l3.2389"></a><span id="l3.2389">     let response = this._preRFC4315COPY(args);</span>
<a href="#l3.2390"></a><span id="l3.2390">     if (response.indexOf(&quot;OK&quot;) == 0) {</span>
<a href="#l3.2391"></a><span id="l3.2391">       let last = mailbox.uidnext - 1;</span>
<a href="#l3.2392"></a><span id="l3.2392">       response = &quot;OK [COPYUID &quot; + this._selectedMailbox.uidvalidity +</span>
<a href="#l3.2393"></a><span id="l3.2393">                    &quot; &quot; + args[0] + &quot; &quot; + first + &quot;:&quot; + last + &quot;]&quot; +</span>
<a href="#l3.2394"></a><span id="l3.2394">                    response.substring(2);</span>
<a href="#l3.2395"></a><span id="l3.2395">     }</span>
<a href="#l3.2396"></a><span id="l3.2396">     return response;</span>
<a href="#l3.2397"></a><span id="l3.2397">   },</span>
<a href="#l3.2398"></a><span id="l3.2398" class="difflineminus">-  MOVE: function (args) {</span>
<a href="#l3.2399"></a><span id="l3.2399" class="difflineplus">+  MOVE(args) {</span>
<a href="#l3.2400"></a><span id="l3.2400">     let mailbox = this._daemon.getMailbox(args[1]);</span>
<a href="#l3.2401"></a><span id="l3.2401">     if (mailbox)</span>
<a href="#l3.2402"></a><span id="l3.2402">       var first = mailbox.uidnext;</span>
<a href="#l3.2403"></a><span id="l3.2403">     let response = this._preRFC4315MOVE(args);</span>
<a href="#l3.2404"></a><span id="l3.2404" class="difflineminus">-    if (response.indexOf(&quot;OK MOVE&quot;) != -1) {</span>
<a href="#l3.2405"></a><span id="l3.2405" class="difflineplus">+    if (response.includes(&quot;OK MOVE&quot;)) {</span>
<a href="#l3.2406"></a><span id="l3.2406">       let last = mailbox.uidnext - 1;</span>
<a href="#l3.2407"></a><span id="l3.2407">       response =</span>
<a href="#l3.2408"></a><span id="l3.2408">         response.replace(&quot;OK MOVE&quot;,</span>
<a href="#l3.2409"></a><span id="l3.2409">                          &quot;OK [COPYUID &quot; + this._selectedMailbox.uidvalidity +</span>
<a href="#l3.2410"></a><span id="l3.2410">                             &quot; &quot; + args[0] + &quot; &quot; + first + &quot;:&quot; + last + &quot;]&quot;);</span>
<a href="#l3.2411"></a><span id="l3.2411">     }</span>
<a href="#l3.2412"></a><span id="l3.2412">     return response;</span>
<a href="#l3.2413"></a><span id="l3.2413">   },</span>
<a href="#l3.2414"></a><span id="l3.2414" class="difflineminus">-  kCapabilities: [&quot;UIDPLUS&quot;]</span>
<a href="#l3.2415"></a><span id="l3.2415" class="difflineplus">+  kCapabilities: [&quot;UIDPLUS&quot;],</span>
<a href="#l3.2416"></a><span id="l3.2416"> };</span>
<a href="#l3.2417"></a><span id="l3.2417"> </span>
<a href="#l3.2418"></a><span id="l3.2418"> // RFC 5258: LIST-EXTENDED</span>
<a href="#l3.2419"></a><span id="l3.2419"> var IMAP_RFC5258_extension = {</span>
<a href="#l3.2420"></a><span id="l3.2420" class="difflineminus">-  preload: function (toBeThis) {</span>
<a href="#l3.2421"></a><span id="l3.2421" class="difflineplus">+  preload(toBeThis) {</span>
<a href="#l3.2422"></a><span id="l3.2422">     toBeThis._argFormat.LIST = [&quot;[(atom)]&quot;, &quot;mailbox&quot;, &quot;mailbox|(mailbox)&quot;,</span>
<a href="#l3.2423"></a><span id="l3.2423">                                 &quot;[atom]&quot;, &quot;[(atom)]&quot;];</span>
<a href="#l3.2424"></a><span id="l3.2424">   },</span>
<a href="#l3.2425"></a><span id="l3.2425" class="difflineminus">-  _LIST_SUBSCRIBED : function (aBox) {</span>
<a href="#l3.2426"></a><span id="l3.2426" class="difflineplus">+  _LIST_SUBSCRIBED(aBox) {</span>
<a href="#l3.2427"></a><span id="l3.2427">     if (!aBox.subscribed) {</span>
<a href="#l3.2428"></a><span id="l3.2428">       return &quot;&quot;;</span>
<a href="#l3.2429"></a><span id="l3.2429">     }</span>
<a href="#l3.2430"></a><span id="l3.2430" class="difflineminus">-    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-           ((aBox.flags.length &gt; 0) ? ' ' : '') + '\\Subscribed' +</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineminus">-           (aBox.nonExistent ? ' \\NonExistent' : '') + ') &quot;' +</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineminus">-           aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2434"></a><span id="l3.2434" class="difflineplus">+</span>
<a href="#l3.2435"></a><span id="l3.2435" class="difflineplus">+    let result = &quot;* LIST (&quot; + aBox.flags.join(&quot; &quot;);</span>
<a href="#l3.2436"></a><span id="l3.2436" class="difflineplus">+    if (aBox.flags.length &gt; 0) {</span>
<a href="#l3.2437"></a><span id="l3.2437" class="difflineplus">+      result += &quot; &quot;;</span>
<a href="#l3.2438"></a><span id="l3.2438" class="difflineplus">+    }</span>
<a href="#l3.2439"></a><span id="l3.2439" class="difflineplus">+    result += &quot;\\Subscribed&quot;;</span>
<a href="#l3.2440"></a><span id="l3.2440" class="difflineplus">+    if (aBox.nonExistent) {</span>
<a href="#l3.2441"></a><span id="l3.2441" class="difflineplus">+      result += &quot; \\NonExistent&quot;;</span>
<a href="#l3.2442"></a><span id="l3.2442" class="difflineplus">+    }</span>
<a href="#l3.2443"></a><span id="l3.2443" class="difflineplus">+    result += ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2444"></a><span id="l3.2444" class="difflineplus">+    return result;</span>
<a href="#l3.2445"></a><span id="l3.2445">   },</span>
<a href="#l3.2446"></a><span id="l3.2446" class="difflineminus">-  _LIST_RETURN_CHILDREN : function (aBox) {</span>
<a href="#l3.2447"></a><span id="l3.2447" class="difflineplus">+  _LIST_RETURN_CHILDREN(aBox) {</span>
<a href="#l3.2448"></a><span id="l3.2448">     if (aBox.nonExistent) {</span>
<a href="#l3.2449"></a><span id="l3.2449">       return &quot;&quot;;</span>
<a href="#l3.2450"></a><span id="l3.2450">     }</span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineminus">-    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l3.2452"></a><span id="l3.2452" class="difflineminus">-           ((aBox._children.length &gt; 0) ?</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineminus">-            (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasChildren') :</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineminus">-            ((aBox.flags.indexOf('\\NoInferiors') == -1) ?</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineminus">-             (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasNoChildren') :</span>
<a href="#l3.2456"></a><span id="l3.2456" class="difflineminus">-             '')) + ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2457"></a><span id="l3.2457" class="difflineplus">+</span>
<a href="#l3.2458"></a><span id="l3.2458" class="difflineplus">+    let result = &quot;* LIST (&quot; + aBox.flags.join(&quot; &quot;);</span>
<a href="#l3.2459"></a><span id="l3.2459" class="difflineplus">+    if (aBox._children.length &gt; 0) {</span>
<a href="#l3.2460"></a><span id="l3.2460" class="difflineplus">+      if (aBox.flags.length &gt; 0) {</span>
<a href="#l3.2461"></a><span id="l3.2461" class="difflineplus">+        result += &quot; &quot;;</span>
<a href="#l3.2462"></a><span id="l3.2462" class="difflineplus">+      }</span>
<a href="#l3.2463"></a><span id="l3.2463" class="difflineplus">+      result += &quot;\\HasChildren&quot;;</span>
<a href="#l3.2464"></a><span id="l3.2464" class="difflineplus">+    } else if (!aBox.flags.includes(&quot;\\NoInferiors&quot;)) {</span>
<a href="#l3.2465"></a><span id="l3.2465" class="difflineplus">+      if (aBox.flags.length &gt; 0) {</span>
<a href="#l3.2466"></a><span id="l3.2466" class="difflineplus">+        result += &quot; &quot;;</span>
<a href="#l3.2467"></a><span id="l3.2467" class="difflineplus">+      }</span>
<a href="#l3.2468"></a><span id="l3.2468" class="difflineplus">+      result += &quot;\\HasNoChildren&quot;;</span>
<a href="#l3.2469"></a><span id="l3.2469" class="difflineplus">+    }</span>
<a href="#l3.2470"></a><span id="l3.2470" class="difflineplus">+    result += ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2471"></a><span id="l3.2471" class="difflineplus">+    return result;</span>
<a href="#l3.2472"></a><span id="l3.2472">   },</span>
<a href="#l3.2473"></a><span id="l3.2473" class="difflineminus">-  _LIST_RETURN_SUBSCRIBED : function (aBox) {</span>
<a href="#l3.2474"></a><span id="l3.2474" class="difflineplus">+  _LIST_RETURN_SUBSCRIBED(aBox) {</span>
<a href="#l3.2475"></a><span id="l3.2475">     if (aBox.nonExistent) {</span>
<a href="#l3.2476"></a><span id="l3.2476">       return &quot;&quot;;</span>
<a href="#l3.2477"></a><span id="l3.2477">     }</span>
<a href="#l3.2478"></a><span id="l3.2478" class="difflineminus">-    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l3.2479"></a><span id="l3.2479" class="difflineminus">-           (aBox.subscribed ? (((aBox.flags.length &gt; 0) ? ' ' : '') +</span>
<a href="#l3.2480"></a><span id="l3.2480" class="difflineminus">-                               '\\Subscribed') : '') +</span>
<a href="#l3.2481"></a><span id="l3.2481" class="difflineminus">-           ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2482"></a><span id="l3.2482" class="difflineplus">+</span>
<a href="#l3.2483"></a><span id="l3.2483" class="difflineplus">+    let result = &quot;* LIST (&quot; + aBox.flags.join(&quot; &quot;);</span>
<a href="#l3.2484"></a><span id="l3.2484" class="difflineplus">+    if (aBox.subscribed) {</span>
<a href="#l3.2485"></a><span id="l3.2485" class="difflineplus">+      if (aBox.flags.length &gt; 0) {</span>
<a href="#l3.2486"></a><span id="l3.2486" class="difflineplus">+        result += &quot; &quot;;</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineplus">+      }</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineplus">+      result += &quot;\\Subscribed&quot;;</span>
<a href="#l3.2489"></a><span id="l3.2489" class="difflineplus">+    }</span>
<a href="#l3.2490"></a><span id="l3.2490" class="difflineplus">+    result += ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l3.2491"></a><span id="l3.2491" class="difflineplus">+    return result;</span>
<a href="#l3.2492"></a><span id="l3.2492">   },</span>
<a href="#l3.2493"></a><span id="l3.2493">   // TODO implement _LIST_REMOTE, _LIST_RECURSIVEMATCH, _LIST_RETURN_SUBSCRIBED</span>
<a href="#l3.2494"></a><span id="l3.2494">   // and all valid combinations thereof. Currently, nsImapServerResponseParser</span>
<a href="#l3.2495"></a><span id="l3.2495">   // does not support any of these responses anyway.</span>
<a href="#l3.2496"></a><span id="l3.2496"> </span>
<a href="#l3.2497"></a><span id="l3.2497" class="difflineminus">-  kCapabilities: [&quot;LIST-EXTENDED&quot;]</span>
<a href="#l3.2498"></a><span id="l3.2498" class="difflineplus">+  kCapabilities: [&quot;LIST-EXTENDED&quot;],</span>
<a href="#l3.2499"></a><span id="l3.2499"> };</span>
<a href="#l3.2500"></a><span id="l3.2500"> </span>
<a href="#l3.2501"></a><span id="l3.2501"> /**</span>
<a href="#l3.2502"></a><span id="l3.2502">  * This implements AUTH schemes. Could be moved into RFC3501 actually.</span>
<a href="#l3.2503"></a><span id="l3.2503">  * The test can en-/disable auth schemes by modifying kAuthSchemes.</span>
<a href="#l3.2504"></a><span id="l3.2504">  */</span>
<a href="#l3.2505"></a><span id="l3.2505"> var IMAP_RFC2195_extension = {</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineminus">-  kAuthSchemes : [ &quot;CRAM-MD5&quot; , &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineplus">+  kAuthSchemes: [&quot;CRAM-MD5&quot;, &quot;PLAIN&quot;, &quot;LOGIN&quot;],</span>
<a href="#l3.2508"></a><span id="l3.2508"> </span>
<a href="#l3.2509"></a><span id="l3.2509" class="difflineminus">-  preload: function (handler) {</span>
<a href="#l3.2510"></a><span id="l3.2510" class="difflineplus">+  preload(handler) {</span>
<a href="#l3.2511"></a><span id="l3.2511">     handler._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.authCRAMStart;</span>
<a href="#l3.2512"></a><span id="l3.2512" class="difflineminus">-    handler._kAuthSchemeStartFunction[&quot;PLAIN&quot;] = this.authPLAINStart;</span>
<a href="#l3.2513"></a><span id="l3.2513" class="difflineminus">-    handler._kAuthSchemeStartFunction[&quot;LOGIN&quot;] = this.authLOGINStart;</span>
<a href="#l3.2514"></a><span id="l3.2514" class="difflineplus">+    handler._kAuthSchemeStartFunction.PLAIN = this.authPLAINStart;</span>
<a href="#l3.2515"></a><span id="l3.2515" class="difflineplus">+    handler._kAuthSchemeStartFunction.LOGIN = this.authLOGINStart;</span>
<a href="#l3.2516"></a><span id="l3.2516">   },</span>
<a href="#l3.2517"></a><span id="l3.2517"> </span>
<a href="#l3.2518"></a><span id="l3.2518" class="difflineminus">-  authPLAINStart : function (lineRest)</span>
<a href="#l3.2519"></a><span id="l3.2519" class="difflineminus">-  {</span>
<a href="#l3.2520"></a><span id="l3.2520" class="difflineplus">+  authPLAINStart(lineRest) {</span>
<a href="#l3.2521"></a><span id="l3.2521">     this._nextAuthFunction = this.authPLAINCred;</span>
<a href="#l3.2522"></a><span id="l3.2522">     this._multiline = true;</span>
<a href="#l3.2523"></a><span id="l3.2523"> </span>
<a href="#l3.2524"></a><span id="l3.2524">     return &quot;+&quot;;</span>
<a href="#l3.2525"></a><span id="l3.2525">   },</span>
<a href="#l3.2526"></a><span id="l3.2526" class="difflineminus">-  authPLAINCred : function (line)</span>
<a href="#l3.2527"></a><span id="l3.2527" class="difflineminus">-  {</span>
<a href="#l3.2528"></a><span id="l3.2528" class="difflineplus">+  authPLAINCred(line) {</span>
<a href="#l3.2529"></a><span id="l3.2529">     var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l3.2530"></a><span id="l3.2530">     if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l3.2531"></a><span id="l3.2531">         req.password == this.kPassword) {</span>
<a href="#l3.2532"></a><span id="l3.2532">       this._state = IMAP_STATE_AUTHED;</span>
<a href="#l3.2533"></a><span id="l3.2533">       return &quot;OK Hello friend! Friends give friends good advice: Next time, use CRAM-MD5&quot;;</span>
<a href="#l3.2534"></a><span id="l3.2534">     }</span>
<a href="#l3.2535"></a><span id="l3.2535" class="difflineminus">-    else {</span>
<a href="#l3.2536"></a><span id="l3.2536" class="difflineminus">-      return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2537"></a><span id="l3.2537" class="difflineminus">-    }</span>
<a href="#l3.2538"></a><span id="l3.2538" class="difflineplus">+    return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2539"></a><span id="l3.2539">   },</span>
<a href="#l3.2540"></a><span id="l3.2540"> </span>
<a href="#l3.2541"></a><span id="l3.2541" class="difflineminus">-  authCRAMStart : function (lineRest)</span>
<a href="#l3.2542"></a><span id="l3.2542" class="difflineminus">-  {</span>
<a href="#l3.2543"></a><span id="l3.2543" class="difflineplus">+  authCRAMStart(lineRest) {</span>
<a href="#l3.2544"></a><span id="l3.2544">     this._nextAuthFunction = this.authCRAMDigest;</span>
<a href="#l3.2545"></a><span id="l3.2545">     this._multiline = true;</span>
<a href="#l3.2546"></a><span id="l3.2546"> </span>
<a href="#l3.2547"></a><span id="l3.2547">     this._usedCRAMMD5Challenge = AuthCRAM.createChallenge(&quot;localhost&quot;);</span>
<a href="#l3.2548"></a><span id="l3.2548">     return &quot;+ &quot; + this._usedCRAMMD5Challenge;</span>
<a href="#l3.2549"></a><span id="l3.2549">   },</span>
<a href="#l3.2550"></a><span id="l3.2550" class="difflineminus">-  authCRAMDigest : function (line)</span>
<a href="#l3.2551"></a><span id="l3.2551" class="difflineminus">-  {</span>
<a href="#l3.2552"></a><span id="l3.2552" class="difflineplus">+  authCRAMDigest(line) {</span>
<a href="#l3.2553"></a><span id="l3.2553">     var req = AuthCRAM.decodeLine(line);</span>
<a href="#l3.2554"></a><span id="l3.2554">     var expectedDigest = AuthCRAM.encodeCRAMMD5(</span>
<a href="#l3.2555"></a><span id="l3.2555">         this._usedCRAMMD5Challenge, this.kPassword);</span>
<a href="#l3.2556"></a><span id="l3.2556">     if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l3.2557"></a><span id="l3.2557">         req.digest == expectedDigest) {</span>
<a href="#l3.2558"></a><span id="l3.2558">       this._state = IMAP_STATE_AUTHED;</span>
<a href="#l3.2559"></a><span id="l3.2559">       return &quot;OK Hello friend!&quot;;</span>
<a href="#l3.2560"></a><span id="l3.2560">     }</span>
<a href="#l3.2561"></a><span id="l3.2561" class="difflineminus">-    else {</span>
<a href="#l3.2562"></a><span id="l3.2562" class="difflineminus">-      return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2563"></a><span id="l3.2563" class="difflineminus">-    }</span>
<a href="#l3.2564"></a><span id="l3.2564" class="difflineplus">+    return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2565"></a><span id="l3.2565">   },</span>
<a href="#l3.2566"></a><span id="l3.2566"> </span>
<a href="#l3.2567"></a><span id="l3.2567" class="difflineminus">-  authLOGINStart : function (lineRest)</span>
<a href="#l3.2568"></a><span id="l3.2568" class="difflineminus">-  {</span>
<a href="#l3.2569"></a><span id="l3.2569" class="difflineplus">+  authLOGINStart(lineRest) {</span>
<a href="#l3.2570"></a><span id="l3.2570">     this._nextAuthFunction = this.authLOGINUsername;</span>
<a href="#l3.2571"></a><span id="l3.2571">     this._multiline = true;</span>
<a href="#l3.2572"></a><span id="l3.2572"> </span>
<a href="#l3.2573"></a><span id="l3.2573">     return &quot;+ &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l3.2574"></a><span id="l3.2574">   },</span>
<a href="#l3.2575"></a><span id="l3.2575" class="difflineminus">-  authLOGINUsername : function (line)</span>
<a href="#l3.2576"></a><span id="l3.2576" class="difflineminus">-  {</span>
<a href="#l3.2577"></a><span id="l3.2577" class="difflineplus">+  authLOGINUsername(line) {</span>
<a href="#l3.2578"></a><span id="l3.2578">     var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l3.2579"></a><span id="l3.2579">     if (req == this.kUsername)</span>
<a href="#l3.2580"></a><span id="l3.2580">       this._nextAuthFunction = this.authLOGINPassword;</span>
<a href="#l3.2581"></a><span id="l3.2581">     else // Don't return error yet, to not reveal valid usernames</span>
<a href="#l3.2582"></a><span id="l3.2582">       this._nextAuthFunction = this.authLOGINBadUsername;</span>
<a href="#l3.2583"></a><span id="l3.2583">     this._multiline = true;</span>
<a href="#l3.2584"></a><span id="l3.2584">     return &quot;+ &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l3.2585"></a><span id="l3.2585">   },</span>
<a href="#l3.2586"></a><span id="l3.2586" class="difflineminus">-  authLOGINBadUsername : function (line)</span>
<a href="#l3.2587"></a><span id="l3.2587" class="difflineminus">-  {</span>
<a href="#l3.2588"></a><span id="l3.2588" class="difflineplus">+  authLOGINBadUsername(line) {</span>
<a href="#l3.2589"></a><span id="l3.2589">     return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2590"></a><span id="l3.2590">   },</span>
<a href="#l3.2591"></a><span id="l3.2591" class="difflineminus">-  authLOGINPassword : function (line)</span>
<a href="#l3.2592"></a><span id="l3.2592" class="difflineminus">-  {</span>
<a href="#l3.2593"></a><span id="l3.2593" class="difflineplus">+  authLOGINPassword(line) {</span>
<a href="#l3.2594"></a><span id="l3.2594">     var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l3.2595"></a><span id="l3.2595">     if (req == this.kPassword) {</span>
<a href="#l3.2596"></a><span id="l3.2596">       this._state = IMAP_STATE_AUTHED;</span>
<a href="#l3.2597"></a><span id="l3.2597">       return &quot;OK Hello friend! Where did you pull out this old auth scheme?&quot;;</span>
<a href="#l3.2598"></a><span id="l3.2598">     }</span>
<a href="#l3.2599"></a><span id="l3.2599" class="difflineminus">-    else {</span>
<a href="#l3.2600"></a><span id="l3.2600" class="difflineminus">-      return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2601"></a><span id="l3.2601" class="difflineminus">-    }</span>
<a href="#l3.2602"></a><span id="l3.2602" class="difflineplus">+    return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l3.2603"></a><span id="l3.2603">   },</span>
<a href="#l3.2604"></a><span id="l3.2604"> };</span>
<a href="#l3.2605"></a><span id="l3.2605"> </span>
<a href="#l3.2606"></a><span id="l3.2606"> // FETCH BODYSTRUCTURE</span>
<a href="#l3.2607"></a><span id="l3.2607"> function bodystructure(msg, extension) {</span>
<a href="#l3.2608"></a><span id="l3.2608">   if (!msg || msg == &quot;&quot;)</span>
<a href="#l3.2609"></a><span id="l3.2609">     return &quot;&quot;;</span>
<a href="#l3.2610"></a><span id="l3.2610"> </span>
<a href="#l3.2611"></a><span id="l3.2611">   // Use the mime parser emitter to generate body structure data. Most of the</span>
<a href="#l3.2612"></a><span id="l3.2612">   // string will be built as we exit a part. Currently not working:</span>
<a href="#l3.2613"></a><span id="l3.2613">   // 1. Some of the fields return NIL instead of trying to calculate them.</span>
<a href="#l3.2614"></a><span id="l3.2614">   // 2. MESSAGE is missing the ENVELOPE and the lines at the end.</span>
<a href="#l3.2615"></a><span id="l3.2615" class="difflineminus">-  var bodystruct = '';</span>
<a href="#l3.2616"></a><span id="l3.2616" class="difflineplus">+  var bodystruct = &quot;&quot;;</span>
<a href="#l3.2617"></a><span id="l3.2617">   function paramToString(params) {</span>
<a href="#l3.2618"></a><span id="l3.2618">     let paramList = [];</span>
<a href="#l3.2619"></a><span id="l3.2619">     for (let [param, value] of params)</span>
<a href="#l3.2620"></a><span id="l3.2620">       paramList.push('&quot;' + param.toUpperCase() + '&quot; &quot;' + value + '&quot;');</span>
<a href="#l3.2621"></a><span id="l3.2621" class="difflineminus">-    return paramList.length == 0 ? 'NIL' : '(' + paramList.join(' ') + ')';</span>
<a href="#l3.2622"></a><span id="l3.2622" class="difflineplus">+    return paramList.length == 0 ? &quot;NIL&quot; : &quot;(&quot; + paramList.join(&quot; &quot;) + &quot;)&quot;;</span>
<a href="#l3.2623"></a><span id="l3.2623">   }</span>
<a href="#l3.2624"></a><span id="l3.2624">   var headerStack = [];</span>
<a href="#l3.2625"></a><span id="l3.2625">   var BodyStructureEmitter = {</span>
<a href="#l3.2626"></a><span id="l3.2626" class="difflineminus">-    startPart: function bodystructure_startPart(partNum, headers) {</span>
<a href="#l3.2627"></a><span id="l3.2627" class="difflineminus">-      bodystruct += '(';</span>
<a href="#l3.2628"></a><span id="l3.2628" class="difflineplus">+    startPart(partNum, headers) {</span>
<a href="#l3.2629"></a><span id="l3.2629" class="difflineplus">+      bodystruct += &quot;(&quot;;</span>
<a href="#l3.2630"></a><span id="l3.2630">       headerStack.push(headers);</span>
<a href="#l3.2631"></a><span id="l3.2631">       this.numLines = 0;</span>
<a href="#l3.2632"></a><span id="l3.2632">       this.length = 0;</span>
<a href="#l3.2633"></a><span id="l3.2633">     },</span>
<a href="#l3.2634"></a><span id="l3.2634" class="difflineminus">-    deliverPartData: function bodystructure_deliverPartData(partNum, data) {</span>
<a href="#l3.2635"></a><span id="l3.2635" class="difflineplus">+    deliverPartData(partNum, data) {</span>
<a href="#l3.2636"></a><span id="l3.2636">       this.length += data.length;</span>
<a href="#l3.2637"></a><span id="l3.2637" class="difflineminus">-      this.numLines += Array.from(data).filter(x =&gt; x == '\n').length;</span>
<a href="#l3.2638"></a><span id="l3.2638" class="difflineplus">+      this.numLines += Array.from(data).filter(x =&gt; x == &quot;\n&quot;).length;</span>
<a href="#l3.2639"></a><span id="l3.2639">     },</span>
<a href="#l3.2640"></a><span id="l3.2640" class="difflineminus">-    endPart: function bodystructure_endPart(partNum) {</span>
<a href="#l3.2641"></a><span id="l3.2641" class="difflineplus">+    endPart(partNum) {</span>
<a href="#l3.2642"></a><span id="l3.2642">       // Grab the headers from before</span>
<a href="#l3.2643"></a><span id="l3.2643">       let headers = headerStack.pop();</span>
<a href="#l3.2644"></a><span id="l3.2644">       let contentType = headers.contentType;</span>
<a href="#l3.2645"></a><span id="l3.2645">       if (contentType.mediatype == &quot;multipart&quot;) {</span>
<a href="#l3.2646"></a><span id="l3.2646">         bodystruct += ' &quot;' + contentType.subtype.toUpperCase() + '&quot;';</span>
<a href="#l3.2647"></a><span id="l3.2647">         if (extension) {</span>
<a href="#l3.2648"></a><span id="l3.2648" class="difflineminus">-          bodystruct += ' ' + paramToString(contentType);</span>
<a href="#l3.2649"></a><span id="l3.2649" class="difflineplus">+          bodystruct += &quot; &quot; + paramToString(contentType);</span>
<a href="#l3.2650"></a><span id="l3.2650">           // XXX: implement the rest</span>
<a href="#l3.2651"></a><span id="l3.2651" class="difflineminus">-          bodystruct += ' NIL NIL NIL';</span>
<a href="#l3.2652"></a><span id="l3.2652" class="difflineplus">+          bodystruct += &quot; NIL NIL NIL&quot;;</span>
<a href="#l3.2653"></a><span id="l3.2653">         }</span>
<a href="#l3.2654"></a><span id="l3.2654">       } else {</span>
<a href="#l3.2655"></a><span id="l3.2655">         bodystruct += '&quot;' + contentType.mediatype.toUpperCase() + '&quot; &quot;' +</span>
<a href="#l3.2656"></a><span id="l3.2656">           contentType.subtype.toUpperCase() + '&quot;';</span>
<a href="#l3.2657"></a><span id="l3.2657" class="difflineminus">-        bodystruct += ' ' + paramToString(contentType);</span>
<a href="#l3.2658"></a><span id="l3.2658" class="difflineplus">+        bodystruct += &quot; &quot; + paramToString(contentType);</span>
<a href="#l3.2659"></a><span id="l3.2659"> </span>
<a href="#l3.2660"></a><span id="l3.2660">         // XXX: Content ID, Content description</span>
<a href="#l3.2661"></a><span id="l3.2661" class="difflineminus">-        bodystruct += ' NIL NIL';</span>
<a href="#l3.2662"></a><span id="l3.2662" class="difflineplus">+        bodystruct += &quot; NIL NIL&quot;;</span>
<a href="#l3.2663"></a><span id="l3.2663"> </span>
<a href="#l3.2664"></a><span id="l3.2664" class="difflineminus">-        let cte = headers.has('content-transfer-encoding') ?</span>
<a href="#l3.2665"></a><span id="l3.2665" class="difflineminus">-          headers.get('content-transfer-encoding') : '7BIT';</span>
<a href="#l3.2666"></a><span id="l3.2666" class="difflineplus">+        let cte = headers.has(&quot;content-transfer-encoding&quot;) ?</span>
<a href="#l3.2667"></a><span id="l3.2667" class="difflineplus">+          headers.get(&quot;content-transfer-encoding&quot;) : &quot;7BIT&quot;;</span>
<a href="#l3.2668"></a><span id="l3.2668">         bodystruct += ' &quot;' + cte + '&quot;';</span>
<a href="#l3.2669"></a><span id="l3.2669"> </span>
<a href="#l3.2670"></a><span id="l3.2670" class="difflineminus">-        bodystruct += ' ' + this.length;</span>
<a href="#l3.2671"></a><span id="l3.2671" class="difflineplus">+        bodystruct += &quot; &quot; + this.length;</span>
<a href="#l3.2672"></a><span id="l3.2672">         if (contentType.mediatype == &quot;text&quot;)</span>
<a href="#l3.2673"></a><span id="l3.2673" class="difflineminus">-          bodystruct += ' ' + this.numLines;</span>
<a href="#l3.2674"></a><span id="l3.2674" class="difflineplus">+          bodystruct += &quot; &quot; + this.numLines;</span>
<a href="#l3.2675"></a><span id="l3.2675"> </span>
<a href="#l3.2676"></a><span id="l3.2676">         // XXX: I don't want to implement these yet</span>
<a href="#l3.2677"></a><span id="l3.2677">         if (extension)</span>
<a href="#l3.2678"></a><span id="l3.2678" class="difflineminus">-          bodystruct += ' NIL NIL NIL NIL';</span>
<a href="#l3.2679"></a><span id="l3.2679" class="difflineplus">+          bodystruct += &quot; NIL NIL NIL NIL&quot;;</span>
<a href="#l3.2680"></a><span id="l3.2680">       }</span>
<a href="#l3.2681"></a><span id="l3.2681" class="difflineminus">-      bodystruct += ')';</span>
<a href="#l3.2682"></a><span id="l3.2682" class="difflineminus">-    }</span>
<a href="#l3.2683"></a><span id="l3.2683" class="difflineplus">+      bodystruct += &quot;)&quot;;</span>
<a href="#l3.2684"></a><span id="l3.2684" class="difflineplus">+    },</span>
<a href="#l3.2685"></a><span id="l3.2685">   };</span>
<a href="#l3.2686"></a><span id="l3.2686">   MimeParser.parseSync(msg, BodyStructureEmitter, {});</span>
<a href="#l3.2687"></a><span id="l3.2687">   return bodystruct;</span>
<a href="#l3.2688"></a><span id="l3.2688"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/test/fakeserver/maild.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/test/fakeserver/maild.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,19 +4,19 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.5"></a><span id="l4.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> // Much of the original code is taken from netwerk's httpserver implementation</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> var EXPORTED_SYMBOLS = [</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  'nsMailServer',</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  'gThreadManager', // TODO: kill this export</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  'fsDebugNone', 'fsDebugAll', 'fsDebugRecv', 'fsDebugRecvSend'</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  &quot;nsMailServer&quot;,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  &quot;gThreadManager&quot;, // TODO: kill this export</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  &quot;fsDebugNone&quot;, &quot;fsDebugAll&quot;, &quot;fsDebugRecv&quot;, &quot;fsDebugRecvSend&quot;,</span>
<a href="#l4.18"></a><span id="l4.18"> ];</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> var CC = Components.Constructor;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> /**</span>
<a href="#l4.23"></a><span id="l4.23">  * The XPCOM thread manager. This declaration is obsolete and exists only</span>
<a href="#l4.24"></a><span id="l4.24">  * because deleting it breaks several dozen tests at the moment.</span>
<a href="#l4.25"></a><span id="l4.25">  */</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -35,34 +35,34 @@ var fsDebugAll = 3;</span>
<a href="#l4.27"></a><span id="l4.27"> var ServerSocket = CC(&quot;@mozilla.org/network/server-socket;1&quot;,</span>
<a href="#l4.28"></a><span id="l4.28">                         &quot;nsIServerSocket&quot;,</span>
<a href="#l4.29"></a><span id="l4.29">                         &quot;init&quot;);</span>
<a href="#l4.30"></a><span id="l4.30"> var BinaryInputStream = CC(&quot;@mozilla.org/binaryinputstream;1&quot;,</span>
<a href="#l4.31"></a><span id="l4.31">                              &quot;nsIBinaryInputStream&quot;,</span>
<a href="#l4.32"></a><span id="l4.32">                              &quot;setInputStream&quot;);</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> // Time out after 3 minutes</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-var TIMEOUT = 3*60*1000;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+var TIMEOUT = 3 * 60 * 1000;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-/******************************************************************************</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+/**</span>
<a href="#l4.40"></a><span id="l4.40">  * The main server handling class. A fake server consists of three parts, this</span>
<a href="#l4.41"></a><span id="l4.41">  * server implementation (which handles the network communication), the handler</span>
<a href="#l4.42"></a><span id="l4.42">  * (which handles the state for a connection), and the daemon (which handles</span>
<a href="#l4.43"></a><span id="l4.43">  * the state for the logical server). To make a new server, one needs to pass</span>
<a href="#l4.44"></a><span id="l4.44">  * in a function to create handlers--not the handlers themselves--and the</span>
<a href="#l4.45"></a><span id="l4.45">  * backend daemon. Since each handler presumably needs access to the logical</span>
<a href="#l4.46"></a><span id="l4.46">  * server daemon, that is passed into the handler creation function. A new</span>
<a href="#l4.47"></a><span id="l4.47">  * handler will be constructed for every connection made.</span>
<a href="#l4.48"></a><span id="l4.48">  *</span>
<a href="#l4.49"></a><span id="l4.49">  * As the core code is inherently single-threaded, it is guaranteed that all of</span>
<a href="#l4.50"></a><span id="l4.50">  * the calls to the daemon will be made on the same thread, so you do not have</span>
<a href="#l4.51"></a><span id="l4.51">  * to worry about reentrancy in daemon calls.</span>
<a href="#l4.52"></a><span id="l4.52">  *</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">- ******************************************************************************</span>
<a href="#l4.54"></a><span id="l4.54">  * Typical usage:</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+ *</span>
<a href="#l4.56"></a><span id="l4.56">  * function createHandler(daemon) {</span>
<a href="#l4.57"></a><span id="l4.57">  *   return new handler(daemon);</span>
<a href="#l4.58"></a><span id="l4.58">  * }</span>
<a href="#l4.59"></a><span id="l4.59">  * do_test_pending();</span>
<a href="#l4.60"></a><span id="l4.60">  * var server = new nsMailServer(createHandler, serverDaemon);</span>
<a href="#l4.61"></a><span id="l4.61">  * // Port to use. I tend to like using 1024 + default port number myself.</span>
<a href="#l4.62"></a><span id="l4.62">  * server.start(port);</span>
<a href="#l4.63"></a><span id="l4.63">  *</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineat">@@ -79,17 +79,17 @@ var TIMEOUT = 3*60*1000;</span>
<a href="#l4.65"></a><span id="l4.65">  * // Finished with tests</span>
<a href="#l4.66"></a><span id="l4.66">  * server.stop();</span>
<a href="#l4.67"></a><span id="l4.67">  *</span>
<a href="#l4.68"></a><span id="l4.68">  * var thread = Services.tm.currentThread;</span>
<a href="#l4.69"></a><span id="l4.69">  * while (thread.hasPendingEvents())</span>
<a href="#l4.70"></a><span id="l4.70">  *   thread.processNextEvent(true);</span>
<a href="#l4.71"></a><span id="l4.71">  *</span>
<a href="#l4.72"></a><span id="l4.72">  * do_test_finished();</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">- *****************************************************************************/</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+ */</span>
<a href="#l4.75"></a><span id="l4.75"> function nsMailServer(handlerCreator, daemon) {</span>
<a href="#l4.76"></a><span id="l4.76">   this._debug = fsDebugNone;</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78">   /** The port on which this server listens. */</span>
<a href="#l4.79"></a><span id="l4.79">   this._port = -1;</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   /** The socket associated with this. */</span>
<a href="#l4.82"></a><span id="l4.82">   this._socket = null;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineat">@@ -115,19 +115,19 @@ function nsMailServer(handlerCreator, da</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85">   /**</span>
<a href="#l4.86"></a><span id="l4.86">    * An array to hold refs to all the input streams below, so that they don't</span>
<a href="#l4.87"></a><span id="l4.87">    * get GCed</span>
<a href="#l4.88"></a><span id="l4.88">    */</span>
<a href="#l4.89"></a><span id="l4.89">   this._inputStreams = [];</span>
<a href="#l4.90"></a><span id="l4.90"> }</span>
<a href="#l4.91"></a><span id="l4.91"> nsMailServer.prototype = {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  onSocketAccepted : function (socket, trans) {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  onSocketAccepted(socket, trans) {</span>
<a href="#l4.94"></a><span id="l4.94">     if (this._debug != fsDebugNone)</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-      dump(&quot;Received Connection from &quot; + trans.host + &quot;:&quot; + trans.port + '\n');</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+      dump(&quot;Received Connection from &quot; + trans.host + &quot;:&quot; + trans.port + &quot;\n&quot;);</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">     const SEGMENT_SIZE = 1024;</span>
<a href="#l4.99"></a><span id="l4.99">     const SEGMENT_COUNT = 1024;</span>
<a href="#l4.100"></a><span id="l4.100">     var input = trans.openInputStream(0, SEGMENT_SIZE, SEGMENT_COUNT)</span>
<a href="#l4.101"></a><span id="l4.101">                      .QueryInterface(Ci.nsIAsyncInputStream);</span>
<a href="#l4.102"></a><span id="l4.102">     this._inputStreams.push(input);</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">     var handler = this._handlerCreator(this._daemon);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineat">@@ -137,71 +137,71 @@ nsMailServer.prototype = {</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">     // Note: must use main thread here, or we might get a GC that will cause</span>
<a href="#l4.108"></a><span id="l4.108">     //       threadsafety assertions.  We really need to fix XPConnect so that</span>
<a href="#l4.109"></a><span id="l4.109">     //       you can actually do things in multi-threaded JS.  :-(</span>
<a href="#l4.110"></a><span id="l4.110">     input.asyncWait(reader, 0, 0, Services.tm.mainThread);</span>
<a href="#l4.111"></a><span id="l4.111">     this._test = true;</span>
<a href="#l4.112"></a><span id="l4.112">   },</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-  onStopListening : function (socket, status) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  onStopListening(socket, status) {</span>
<a href="#l4.116"></a><span id="l4.116">     if (this._debug != fsDebugNone)</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-      dump(&quot;Connection Lost &quot; + status + '\n');</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+      dump(&quot;Connection Lost &quot; + status + &quot;\n&quot;);</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120">     this._socketClosed = true;</span>
<a href="#l4.121"></a><span id="l4.121">     // We've been killed or we've stopped, reset the handler to the original</span>
<a href="#l4.122"></a><span id="l4.122">     // state (e.g. to require authentication again).</span>
<a href="#l4.123"></a><span id="l4.123">     for (var i = 0; i &lt; this._readers.length; i++) {</span>
<a href="#l4.124"></a><span id="l4.124">       this._readers[i]._handler.resetTest();</span>
<a href="#l4.125"></a><span id="l4.125">       this._readers[i]._realCloseSocket();</span>
<a href="#l4.126"></a><span id="l4.126">     }</span>
<a href="#l4.127"></a><span id="l4.127">   },</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-  setDebugLevel : function (debug) {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+  setDebugLevel(debug) {</span>
<a href="#l4.131"></a><span id="l4.131">     this._debug = debug;</span>
<a href="#l4.132"></a><span id="l4.132">     for (var i = 0; i &lt; this._readers.length; i++)</span>
<a href="#l4.133"></a><span id="l4.133">       this._readers[i].setDebugLevel(debug);</span>
<a href="#l4.134"></a><span id="l4.134">   },</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  start : function (port=-1) {</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+  start(port = -1) {</span>
<a href="#l4.138"></a><span id="l4.138">     if (this._socket)</span>
<a href="#l4.139"></a><span id="l4.139">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">     if (port &gt; 0)</span>
<a href="#l4.142"></a><span id="l4.142">       this._port = port;</span>
<a href="#l4.143"></a><span id="l4.143">     this._socketClosed = false;</span>
<a href="#l4.144"></a><span id="l4.144"> </span>
<a href="#l4.145"></a><span id="l4.145">     var socket = new ServerSocket(this._port,</span>
<a href="#l4.146"></a><span id="l4.146">                                   true, // loopback only</span>
<a href="#l4.147"></a><span id="l4.147">                                   -1);  // default number of pending connections</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">     socket.asyncListen(this);</span>
<a href="#l4.150"></a><span id="l4.150">     this._socket = socket;</span>
<a href="#l4.151"></a><span id="l4.151">   },</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-  stop : function () {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+  stop() {</span>
<a href="#l4.155"></a><span id="l4.155">     if (!this._socket)</span>
<a href="#l4.156"></a><span id="l4.156">       return;</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158">     this._socket.close();</span>
<a href="#l4.159"></a><span id="l4.159">     this._socket = null;</span>
<a href="#l4.160"></a><span id="l4.160"> </span>
<a href="#l4.161"></a><span id="l4.161">     for (let reader of this._readers)</span>
<a href="#l4.162"></a><span id="l4.162">       reader._realCloseSocket();</span>
<a href="#l4.163"></a><span id="l4.163"> </span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-    if (this._readers.some(function (e) { return e.observer.forced }))</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    if (this._readers.some(e =&gt; e.observer.forced))</span>
<a href="#l4.166"></a><span id="l4.166">       return;</span>
<a href="#l4.167"></a><span id="l4.167"> </span>
<a href="#l4.168"></a><span id="l4.168">     // spin an event loop and wait for the socket-close notification</span>
<a href="#l4.169"></a><span id="l4.169">     let thr = Services.tm.currentThread;</span>
<a href="#l4.170"></a><span id="l4.170">     while (!this._socketClosed)</span>
<a href="#l4.171"></a><span id="l4.171">       // Don't wait for the next event, just in case there isn't one.</span>
<a href="#l4.172"></a><span id="l4.172">       thr.processNextEvent(false);</span>
<a href="#l4.173"></a><span id="l4.173">   },</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  stopTest : function () {</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  stopTest() {</span>
<a href="#l4.176"></a><span id="l4.176">     this._test = false;</span>
<a href="#l4.177"></a><span id="l4.177">   },</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179">   get port() {</span>
<a href="#l4.180"></a><span id="l4.180">     if (this._port == -1) {</span>
<a href="#l4.181"></a><span id="l4.181">       this._port = this._socket.port;</span>
<a href="#l4.182"></a><span id="l4.182">     }</span>
<a href="#l4.183"></a><span id="l4.183">     return this._port;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineat">@@ -217,71 +217,70 @@ nsMailServer.prototype = {</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">   // NON-XPCOM PUBLIC API</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188">   /**</span>
<a href="#l4.189"></a><span id="l4.189">    * Returns true if this server is not running (and is not in the process of</span>
<a href="#l4.190"></a><span id="l4.190">    * serving any requests still to be processed when the server was last</span>
<a href="#l4.191"></a><span id="l4.191">    * stopped after being run).</span>
<a href="#l4.192"></a><span id="l4.192">    */</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-  isStopped : function () {</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  isStopped() {</span>
<a href="#l4.195"></a><span id="l4.195">     return this._socketClosed;</span>
<a href="#l4.196"></a><span id="l4.196">   },</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198">   /**</span>
<a href="#l4.199"></a><span id="l4.199">    * Runs the test. It will not exit until the test has finished.</span>
<a href="#l4.200"></a><span id="l4.200">    */</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  performTest : function (watchWord) {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  performTest(watchWord) {</span>
<a href="#l4.203"></a><span id="l4.203">     this._watchWord = watchWord;</span>
<a href="#l4.204"></a><span id="l4.204"> </span>
<a href="#l4.205"></a><span id="l4.205">     let thread = Services.tm.currentThread;</span>
<a href="#l4.206"></a><span id="l4.206">     while (!this.isTestFinished())</span>
<a href="#l4.207"></a><span id="l4.207">       thread.processNextEvent(false);</span>
<a href="#l4.208"></a><span id="l4.208">   },</span>
<a href="#l4.209"></a><span id="l4.209"> </span>
<a href="#l4.210"></a><span id="l4.210">   /**</span>
<a href="#l4.211"></a><span id="l4.211">    * Returns true if the current processing test has finished.</span>
<a href="#l4.212"></a><span id="l4.212">    */</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-  isTestFinished : function() {</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  isTestFinished() {</span>
<a href="#l4.215"></a><span id="l4.215">     return this._readers.length &gt; 0 &amp;&amp; !this._test;</span>
<a href="#l4.216"></a><span id="l4.216">   },</span>
<a href="#l4.217"></a><span id="l4.217"> </span>
<a href="#l4.218"></a><span id="l4.218">   /**</span>
<a href="#l4.219"></a><span id="l4.219">    * Returns the commands run between the server and client.</span>
<a href="#l4.220"></a><span id="l4.220">    * The return is an object with two variables (us and them), both of which</span>
<a href="#l4.221"></a><span id="l4.221">    * are arrays returning the commands given by each server.</span>
<a href="#l4.222"></a><span id="l4.222">    */</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-  playTransaction : function() {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    if (this._readers.some(function (e) { return e.observer.forced; }))</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  playTransaction() {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+    if (this._readers.some(e =&gt; e.observer.forced))</span>
<a href="#l4.227"></a><span id="l4.227">       throw &quot;Server timed out!&quot;;</span>
<a href="#l4.228"></a><span id="l4.228">     if (this._readers.length == 1)</span>
<a href="#l4.229"></a><span id="l4.229">       return this._readers[0].transaction;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-    else</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-      return this._readers.map(function (e) { return e.transaction; });</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+    return this._readers.map(e =&gt; e.transaction);</span>
<a href="#l4.233"></a><span id="l4.233">   },</span>
<a href="#l4.234"></a><span id="l4.234"> </span>
<a href="#l4.235"></a><span id="l4.235">   /**</span>
<a href="#l4.236"></a><span id="l4.236">    * Prepares for the next test.</span>
<a href="#l4.237"></a><span id="l4.237">    */</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-  resetTest : function() {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-    this._readers = this._readers.filter(function (reader) {</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+  resetTest() {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+    this._readers = this._readers.filter(function(reader) {</span>
<a href="#l4.242"></a><span id="l4.242">       return reader._isRunning;</span>
<a href="#l4.243"></a><span id="l4.243">     });</span>
<a href="#l4.244"></a><span id="l4.244">     this._test = true;</span>
<a href="#l4.245"></a><span id="l4.245">     for (var i = 0; i &lt; this._readers.length; i++)</span>
<a href="#l4.246"></a><span id="l4.246">       this._readers[i]._handler.resetTest();</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-  }</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+  },</span>
<a href="#l4.249"></a><span id="l4.249"> };</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251"> function readTo(input, count, arr) {</span>
<a href="#l4.252"></a><span id="l4.252">   var old = new BinaryInputStream(input).readByteArray(count);</span>
<a href="#l4.253"></a><span id="l4.253">   Array.prototype.push.apply(arr, old);</span>
<a href="#l4.254"></a><span id="l4.254"> }</span>
<a href="#l4.255"></a><span id="l4.255"> </span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-/******************************************************************************</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+/**</span>
<a href="#l4.258"></a><span id="l4.258">  * The nsMailReader service, which reads and handles the lines.</span>
<a href="#l4.259"></a><span id="l4.259">  * All specific handling is passed off to the handler, which is responsible</span>
<a href="#l4.260"></a><span id="l4.260">  * for maintaining its own state. The following commands are required for the</span>
<a href="#l4.261"></a><span id="l4.261">  * handler object:</span>
<a href="#l4.262"></a><span id="l4.262">  * onError       Called when handler[command] does not exist with both the</span>
<a href="#l4.263"></a><span id="l4.263">  *               command and rest-of-line as arguments</span>
<a href="#l4.264"></a><span id="l4.264">  * onStartup     Called on initialization with no arguments</span>
<a href="#l4.265"></a><span id="l4.265">  * onMultiline   Called when in multiline with the entire line as an argument</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineat">@@ -296,82 +295,82 @@ function readTo(input, count, arr) {</span>
<a href="#l4.267"></a><span id="l4.267">  *</span>
<a href="#l4.268"></a><span id="l4.268">  * The return of postCommand is ignored. The return of onMultiline is a bit</span>
<a href="#l4.269"></a><span id="l4.269">  * complicated: it may or may not return a response string (returning one is</span>
<a href="#l4.270"></a><span id="l4.270">  * necessary to trigger the postCommand handler).</span>
<a href="#l4.271"></a><span id="l4.271">  *</span>
<a href="#l4.272"></a><span id="l4.272">  * This object has the following supplemental functions for use by handlers:</span>
<a href="#l4.273"></a><span id="l4.273">  * closeSocket  Performs a server-side socket closing</span>
<a href="#l4.274"></a><span id="l4.274">  * setMultiline Sets the multiline mode based on the argument</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">- *****************************************************************************/</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+ */</span>
<a href="#l4.277"></a><span id="l4.277"> function nsMailReader(server, handler, transport, debug, logTransaction) {</span>
<a href="#l4.278"></a><span id="l4.278">   this._debug = debug;</span>
<a href="#l4.279"></a><span id="l4.279">   this._server = server;</span>
<a href="#l4.280"></a><span id="l4.280">   this._buffer = [];</span>
<a href="#l4.281"></a><span id="l4.281">   this._lines = [];</span>
<a href="#l4.282"></a><span id="l4.282">   this._handler = handler;</span>
<a href="#l4.283"></a><span id="l4.283">   this._transport = transport;</span>
<a href="#l4.284"></a><span id="l4.284">   // We don't seem to properly handle large streams when the buffer gets</span>
<a href="#l4.285"></a><span id="l4.285">   // exhausted, which causes issues trying to test large messages. So just</span>
<a href="#l4.286"></a><span id="l4.286">   // allow a really big buffer.</span>
<a href="#l4.287"></a><span id="l4.287">   var output = transport.openOutputStream(Ci.nsITransport.OPEN_BLOCKING, 1024, 4096);</span>
<a href="#l4.288"></a><span id="l4.288">   this._output = output;</span>
<a href="#l4.289"></a><span id="l4.289">   if (logTransaction)</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-    this.transaction = { us : [], them : [] };</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    this.transaction = { us: [], them: [] };</span>
<a href="#l4.292"></a><span id="l4.292">   else</span>
<a href="#l4.293"></a><span id="l4.293">     this.transaction = null;</span>
<a href="#l4.294"></a><span id="l4.294"> </span>
<a href="#l4.295"></a><span id="l4.295">   // Send response line</span>
<a href="#l4.296"></a><span id="l4.296">   var response = this._handler.onStartup();</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-  response = response.replace(/([^\r])\n/g,&quot;$1\r\n&quot;);</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-  if (!response.endsWith('\n'))</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+  response = response.replace(/([^\r])\n/g, &quot;$1\r\n&quot;);</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+  if (!response.endsWith(&quot;\n&quot;))</span>
<a href="#l4.301"></a><span id="l4.301">     response = response + &quot;\r\n&quot;;</span>
<a href="#l4.302"></a><span id="l4.302">   if (this.transaction)</span>
<a href="#l4.303"></a><span id="l4.303">     this.transaction.us.push(response);</span>
<a href="#l4.304"></a><span id="l4.304">   this._output.write(response, response.length);</span>
<a href="#l4.305"></a><span id="l4.305">   this._output.flush();</span>
<a href="#l4.306"></a><span id="l4.306"> </span>
<a href="#l4.307"></a><span id="l4.307">   this._multiline = false;</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309">   this._isRunning = true;</span>
<a href="#l4.310"></a><span id="l4.310"> </span>
<a href="#l4.311"></a><span id="l4.311">   this.observer = {</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-    server : server,</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-    forced : false,</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-    notify : function (timer) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+    server,</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+    forced: false,</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+    notify(timer) {</span>
<a href="#l4.318"></a><span id="l4.318">       this.forced = true;</span>
<a href="#l4.319"></a><span id="l4.319">       this.server.stopTest();</span>
<a href="#l4.320"></a><span id="l4.320">       this.server.stop();</span>
<a href="#l4.321"></a><span id="l4.321">     },</span>
<a href="#l4.322"></a><span id="l4.322">     QueryInterface: ChromeUtils.generateQI([&quot;nsITimerCallback&quot;]),</span>
<a href="#l4.323"></a><span id="l4.323">   };</span>
<a href="#l4.324"></a><span id="l4.324">   this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance()</span>
<a href="#l4.325"></a><span id="l4.325">                                          .QueryInterface(Ci.nsITimer);</span>
<a href="#l4.326"></a><span id="l4.326">   this.timer.initWithCallback(this.observer, TIMEOUT,</span>
<a href="#l4.327"></a><span id="l4.327">                               Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l4.328"></a><span id="l4.328"> }</span>
<a href="#l4.329"></a><span id="l4.329"> nsMailReader.prototype = {</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-  _findLines : function () {</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+  _findLines() {</span>
<a href="#l4.332"></a><span id="l4.332">     var buf = this._buffer;</span>
<a href="#l4.333"></a><span id="l4.333">     for (var crlfLoc = buf.indexOf(13); crlfLoc &gt;= 0;</span>
<a href="#l4.334"></a><span id="l4.334">         crlfLoc = buf.indexOf(13, crlfLoc + 1)) {</span>
<a href="#l4.335"></a><span id="l4.335">       if (buf[crlfLoc + 1] == 10)</span>
<a href="#l4.336"></a><span id="l4.336">         break;</span>
<a href="#l4.337"></a><span id="l4.337">     }</span>
<a href="#l4.338"></a><span id="l4.338">     if (crlfLoc == -1)</span>
<a href="#l4.339"></a><span id="l4.339">       // We failed to find a newline</span>
<a href="#l4.340"></a><span id="l4.340">       return;</span>
<a href="#l4.341"></a><span id="l4.341"> </span>
<a href="#l4.342"></a><span id="l4.342">     var line = String.fromCharCode.apply(null, buf.slice(0, crlfLoc));</span>
<a href="#l4.343"></a><span id="l4.343">     this._buffer = buf.slice(crlfLoc + 2);</span>
<a href="#l4.344"></a><span id="l4.344">     this._lines.push(line);</span>
<a href="#l4.345"></a><span id="l4.345">     this._findLines();</span>
<a href="#l4.346"></a><span id="l4.346">   },</span>
<a href="#l4.347"></a><span id="l4.347"> </span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-  onInputStreamReady : function (stream) {</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+  onInputStreamReady(stream) {</span>
<a href="#l4.350"></a><span id="l4.350">     if (this.observer.forced)</span>
<a href="#l4.351"></a><span id="l4.351">       return;</span>
<a href="#l4.352"></a><span id="l4.352"> </span>
<a href="#l4.353"></a><span id="l4.353">     this.timer.cancel();</span>
<a href="#l4.354"></a><span id="l4.354">     try {</span>
<a href="#l4.355"></a><span id="l4.355">       var bytes = stream.available();</span>
<a href="#l4.356"></a><span id="l4.356">     } catch (e) {</span>
<a href="#l4.357"></a><span id="l4.357">       // Someone, not us, has closed the stream. This means we can't get any</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineat">@@ -381,90 +380,88 @@ nsMailReader.prototype = {</span>
<a href="#l4.359"></a><span id="l4.359">     }</span>
<a href="#l4.360"></a><span id="l4.360">     readTo(stream, bytes, this._buffer);</span>
<a href="#l4.361"></a><span id="l4.361">     this._findLines();</span>
<a href="#l4.362"></a><span id="l4.362"> </span>
<a href="#l4.363"></a><span id="l4.363">     while (this._lines.length &gt; 0) {</span>
<a href="#l4.364"></a><span id="l4.364">       var line = this._lines.shift();</span>
<a href="#l4.365"></a><span id="l4.365"> </span>
<a href="#l4.366"></a><span id="l4.366">       if (this._debug != fsDebugNone)</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-        dump(&quot;RECV: &quot; + line + '\n');</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+        dump(&quot;RECV: &quot; + line + &quot;\n&quot;);</span>
<a href="#l4.369"></a><span id="l4.369"> </span>
<a href="#l4.370"></a><span id="l4.370">       var response;</span>
<a href="#l4.371"></a><span id="l4.371">       try {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+        let command;</span>
<a href="#l4.373"></a><span id="l4.373">         if (this._multiline) {</span>
<a href="#l4.374"></a><span id="l4.374">           response = this._handler.onMultiline(line);</span>
<a href="#l4.375"></a><span id="l4.375"> </span>
<a href="#l4.376"></a><span id="l4.376">           if (response === undefined)</span>
<a href="#l4.377"></a><span id="l4.377">             continue;</span>
<a href="#l4.378"></a><span id="l4.378">         } else {</span>
<a href="#l4.379"></a><span id="l4.379">           // Record the transaction</span>
<a href="#l4.380"></a><span id="l4.380">           if (this.transaction)</span>
<a href="#l4.381"></a><span id="l4.381">             this.transaction.them.push(line);</span>
<a href="#l4.382"></a><span id="l4.382"> </span>
<a href="#l4.383"></a><span id="l4.383">           // Find the command and splice it out...</span>
<a href="#l4.384"></a><span id="l4.384">           var splitter = line.indexOf(&quot; &quot;);</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-          var command = splitter == -1 ? line : line.substring(0,splitter);</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-          var args = splitter == -1 ? &quot;&quot; : line.substring(splitter+1);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+          command = splitter == -1 ? line : line.substring(0, splitter);</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+          let args = splitter == -1 ? &quot;&quot; : line.substring(splitter + 1);</span>
<a href="#l4.389"></a><span id="l4.389"> </span>
<a href="#l4.390"></a><span id="l4.390">           // By convention, commands are uppercase</span>
<a href="#l4.391"></a><span id="l4.391">           command = command.toUpperCase();</span>
<a href="#l4.392"></a><span id="l4.392"> </span>
<a href="#l4.393"></a><span id="l4.393">           if (this._debug == fsDebugAll)</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-            dump(&quot;Received command &quot; + command + '\n');</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+            dump(&quot;Received command &quot; + command + &quot;\n&quot;);</span>
<a href="#l4.396"></a><span id="l4.396"> </span>
<a href="#l4.397"></a><span id="l4.397">           if (command in this._handler)</span>
<a href="#l4.398"></a><span id="l4.398">             response = this._handler[command](args);</span>
<a href="#l4.399"></a><span id="l4.399">           else</span>
<a href="#l4.400"></a><span id="l4.400">             response = this._handler.onError(command, args);</span>
<a href="#l4.401"></a><span id="l4.401">         }</span>
<a href="#l4.402"></a><span id="l4.402"> </span>
<a href="#l4.403"></a><span id="l4.403">         this._preventLFMunge = false;</span>
<a href="#l4.404"></a><span id="l4.404">         this._handler.postCommand(this);</span>
<a href="#l4.405"></a><span id="l4.405"> </span>
<a href="#l4.406"></a><span id="l4.406">         if (this.watchWord &amp;&amp; command == this.watchWord)</span>
<a href="#l4.407"></a><span id="l4.407">           this.stopTest();</span>
<a href="#l4.408"></a><span id="l4.408">       } catch (e) {</span>
<a href="#l4.409"></a><span id="l4.409">         response = this._handler.onServerFault(e);</span>
<a href="#l4.410"></a><span id="l4.410">         if (e instanceof Error) {</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-          dump(e.name + &quot;: &quot; + e.message + '\n');</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-          dump(&quot;File: &quot; + e.fileName + &quot; Line: &quot; + e.lineNumber + '\n');</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-          dump('Stack trace:\n' + e.stack);</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+          dump(e.name + &quot;: &quot; + e.message + &quot;\n&quot;);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+          dump(&quot;File: &quot; + e.fileName + &quot; Line: &quot; + e.lineNumber + &quot;\n&quot;);</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+          dump(&quot;Stack trace:\n&quot; + e.stack);</span>
<a href="#l4.417"></a><span id="l4.417">         } else {</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-          dump(&quot;Exception caught: &quot; + e + '\n');</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+          dump(&quot;Exception caught: &quot; + e + &quot;\n&quot;);</span>
<a href="#l4.420"></a><span id="l4.420">         }</span>
<a href="#l4.421"></a><span id="l4.421">       }</span>
<a href="#l4.422"></a><span id="l4.422"> </span>
<a href="#l4.423"></a><span id="l4.423">       if (!this._preventLFMunge)</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-        response = response.replace(/([^\r])\n/g,&quot;$1\r\n&quot;);</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+        response = response.replace(/([^\r])\n/g, &quot;$1\r\n&quot;);</span>
<a href="#l4.426"></a><span id="l4.426"> </span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-      if (!response.endsWith('\n'))</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+      if (!response.endsWith(&quot;\n&quot;))</span>
<a href="#l4.429"></a><span id="l4.429">        response = response + &quot;\r\n&quot;;</span>
<a href="#l4.430"></a><span id="l4.430"> </span>
<a href="#l4.431"></a><span id="l4.431">       if (this._debug == fsDebugRecvSend) {</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-        dump(&quot;SEND: &quot; + response.split(&quot; &quot;, 1)[0] + '\n');</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-      }</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-      else if (this._debug == fsDebugAll) {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+        dump(&quot;SEND: &quot; + response.split(&quot; &quot;, 1)[0] + &quot;\n&quot;);</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+      } else if (this._debug == fsDebugAll) {</span>
<a href="#l4.437"></a><span id="l4.437">         var responses = response.split(&quot;\n&quot;);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-        responses.forEach(function (line) { dump(&quot;SEND: &quot; + line + '\n'); });</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+        responses.forEach(function(line) { dump(&quot;SEND: &quot; + line + &quot;\n&quot;); });</span>
<a href="#l4.440"></a><span id="l4.440">       }</span>
<a href="#l4.441"></a><span id="l4.441"> </span>
<a href="#l4.442"></a><span id="l4.442">       if (this.transaction)</span>
<a href="#l4.443"></a><span id="l4.443">         this.transaction.us.push(response);</span>
<a href="#l4.444"></a><span id="l4.444"> </span>
<a href="#l4.445"></a><span id="l4.445">       try {</span>
<a href="#l4.446"></a><span id="l4.446">         this._output.write(response, response.length);</span>
<a href="#l4.447"></a><span id="l4.447">         this._output.flush();</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-      }</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-      catch (ex) {</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+      } catch (ex) {</span>
<a href="#l4.451"></a><span id="l4.451">         if (ex.result == Cr.NS_BASE_STREAM_CLOSED) {</span>
<a href="#l4.452"></a><span id="l4.452">           dump(&quot;Stream closed whilst sending, this may be expected\n&quot;);</span>
<a href="#l4.453"></a><span id="l4.453">           this._realCloseSocket();</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-        }</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-        else {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+        } else {</span>
<a href="#l4.457"></a><span id="l4.457">           // Some other issue, let the test see it.</span>
<a href="#l4.458"></a><span id="l4.458">           throw ex;</span>
<a href="#l4.459"></a><span id="l4.459">         }</span>
<a href="#l4.460"></a><span id="l4.460">       }</span>
<a href="#l4.461"></a><span id="l4.461"> </span>
<a href="#l4.462"></a><span id="l4.462">       if (this._signalStop) {</span>
<a href="#l4.463"></a><span id="l4.463">         this._realCloseSocket();</span>
<a href="#l4.464"></a><span id="l4.464">         this._signalStop = false;</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineat">@@ -473,40 +470,40 @@ nsMailReader.prototype = {</span>
<a href="#l4.466"></a><span id="l4.466"> </span>
<a href="#l4.467"></a><span id="l4.467">     if (this._isRunning) {</span>
<a href="#l4.468"></a><span id="l4.468">       stream.asyncWait(this, 0, 0, Services.tm.currentThread);</span>
<a href="#l4.469"></a><span id="l4.469">       this.timer.initWithCallback(this.observer, TIMEOUT,</span>
<a href="#l4.470"></a><span id="l4.470">                                   Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l4.471"></a><span id="l4.471">     }</span>
<a href="#l4.472"></a><span id="l4.472">   },</span>
<a href="#l4.473"></a><span id="l4.473"> </span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-  closeSocket : function () {</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+  closeSocket() {</span>
<a href="#l4.476"></a><span id="l4.476">     this._signalStop = true;</span>
<a href="#l4.477"></a><span id="l4.477">   },</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-  _realCloseSocket : function () {</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+  _realCloseSocket() {</span>
<a href="#l4.480"></a><span id="l4.480">     this._isRunning = false;</span>
<a href="#l4.481"></a><span id="l4.481">     this._output.close();</span>
<a href="#l4.482"></a><span id="l4.482">     this._transport.close(Cr.NS_OK);</span>
<a href="#l4.483"></a><span id="l4.483">     this._server.stopTest();</span>
<a href="#l4.484"></a><span id="l4.484">   },</span>
<a href="#l4.485"></a><span id="l4.485"> </span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-  setMultiline : function (multi) {</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+  setMultiline(multi) {</span>
<a href="#l4.488"></a><span id="l4.488">     this._multiline = multi;</span>
<a href="#l4.489"></a><span id="l4.489">   },</span>
<a href="#l4.490"></a><span id="l4.490"> </span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-  setDebugLevel : function (debug) {</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+  setDebugLevel(debug) {</span>
<a href="#l4.493"></a><span id="l4.493">     this._debug = debug;</span>
<a href="#l4.494"></a><span id="l4.494">   },</span>
<a href="#l4.495"></a><span id="l4.495"> </span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-  preventLFMunge : function () {</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+  preventLFMunge() {</span>
<a href="#l4.498"></a><span id="l4.498">     this._preventLFMunge = true;</span>
<a href="#l4.499"></a><span id="l4.499">   },</span>
<a href="#l4.500"></a><span id="l4.500"> </span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-  get watchWord () {</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+  get watchWord() {</span>
<a href="#l4.503"></a><span id="l4.503">     return this._server._watchWord;</span>
<a href="#l4.504"></a><span id="l4.504">   },</span>
<a href="#l4.505"></a><span id="l4.505"> </span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-  stopTest : function () {</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+  stopTest() {</span>
<a href="#l4.508"></a><span id="l4.508">     this._server.stopTest();</span>
<a href="#l4.509"></a><span id="l4.509">   },</span>
<a href="#l4.510"></a><span id="l4.510"> </span>
<a href="#l4.511"></a><span id="l4.511">   QueryInterface: ChromeUtils.generateQI([&quot;nsIInputStreamCallback&quot;]),</span>
<a href="#l4.512"></a><span id="l4.512"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/test/fakeserver/nntpd.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/test/fakeserver/nntpd.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,223 +1,219 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> // This file implements test NNTP servers</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> const {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> var EXPORTED_SYMBOLS = [</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-  'nntpDaemon',</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-  'newsArticle',</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  'NNTP_POSTABLE',</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  'NNTP_REAL_LENGTH',</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  'NNTP_RFC977_handler',</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  'NNTP_RFC2980_handler',</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  'NNTP_RFC3977_handler',</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-  'NNTP_Giganews_handler',</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  'NNTP_RFC4643_extension'</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  &quot;nntpDaemon&quot;,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  &quot;newsArticle&quot;,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  &quot;NNTP_POSTABLE&quot;,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  &quot;NNTP_REAL_LENGTH&quot;,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  &quot;NNTP_RFC977_handler&quot;,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  &quot;NNTP_RFC2980_handler&quot;,</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  &quot;NNTP_RFC3977_handler&quot;,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+  &quot;NNTP_Giganews_handler&quot;,</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  &quot;NNTP_RFC4643_extension&quot;,</span>
<a href="#l5.28"></a><span id="l5.28"> ];</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30"> function nntpDaemon(flags) {</span>
<a href="#l5.31"></a><span id="l5.31">   this._groups = {};</span>
<a href="#l5.32"></a><span id="l5.32">   this._messages = {};</span>
<a href="#l5.33"></a><span id="l5.33">   this._flags = flags;</span>
<a href="#l5.34"></a><span id="l5.34"> }</span>
<a href="#l5.35"></a><span id="l5.35"> nntpDaemon.prototype = {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  addGroup : function(group, postable) {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  addGroup(group, postable) {</span>
<a href="#l5.38"></a><span id="l5.38">     var flags = 0;</span>
<a href="#l5.39"></a><span id="l5.39">     if (postable)</span>
<a href="#l5.40"></a><span id="l5.40">       flags |= NNTP_POSTABLE;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    this._groups[group] = { keys : [], flags : flags, nextKey : 1};</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    this._groups[group] = { keys: [], flags, nextKey: 1 };</span>
<a href="#l5.43"></a><span id="l5.43">   },</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  addArticle : function (article) {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  addArticle(article) {</span>
<a href="#l5.46"></a><span id="l5.46">    this._messages[article.messageID] = article;</span>
<a href="#l5.47"></a><span id="l5.47">    for (let group of article.groups) {</span>
<a href="#l5.48"></a><span id="l5.48">      if (group in this._groups) {</span>
<a href="#l5.49"></a><span id="l5.49">        var key = this._groups[group].nextKey++;</span>
<a href="#l5.50"></a><span id="l5.50">        this._groups[group][key] = article;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-       this._groups[group]['keys'].push(key);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+       this._groups[group].keys.push(key);</span>
<a href="#l5.53"></a><span id="l5.53">      }</span>
<a href="#l5.54"></a><span id="l5.54">    }</span>
<a href="#l5.55"></a><span id="l5.55">   },</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  addArticleToGroup : function(article, group, key) {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  addArticleToGroup(article, group, key) {</span>
<a href="#l5.58"></a><span id="l5.58">     this._groups[group][key] = article;</span>
<a href="#l5.59"></a><span id="l5.59">     this._messages[article.messageID] = article;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    this._groups[group]['keys'].push(key);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+    this._groups[group].keys.push(key);</span>
<a href="#l5.62"></a><span id="l5.62">     if (this._groups[group].nextKey &lt;= key)</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-      this._groups[group].nextKey = key+1;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      this._groups[group].nextKey = key + 1;</span>
<a href="#l5.65"></a><span id="l5.65">   },</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  getGroup : function(group) {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  getGroup(group) {</span>
<a href="#l5.68"></a><span id="l5.68">     if (this._groups.hasOwnProperty(group))</span>
<a href="#l5.69"></a><span id="l5.69">       return this._groups[group];</span>
<a href="#l5.70"></a><span id="l5.70">     return null;</span>
<a href="#l5.71"></a><span id="l5.71">   },</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  getGroupStats : function (group) {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-    if (group['keys'].length == 0)</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  getGroupStats(group) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    if (group.keys.length == 0)</span>
<a href="#l5.76"></a><span id="l5.76">       return [0, 0, 0];</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    var min = 1&lt;&lt;30;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+    var min = 1 &lt;&lt; 30;</span>
<a href="#l5.79"></a><span id="l5.79">     var max = 0;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    group['keys'].forEach(function (key) {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    group.keys.forEach(function(key) {</span>
<a href="#l5.82"></a><span id="l5.82">         if (key &lt; min) min = key;</span>
<a href="#l5.83"></a><span id="l5.83">         if (key &gt; max) max = key;</span>
<a href="#l5.84"></a><span id="l5.84">       });</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86">     var length;</span>
<a href="#l5.87"></a><span id="l5.87">     if (hasFlag(this._flags, NNTP_REAL_LENGTH))</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-      length = group['keys'].length;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+      length = group.keys.length;</span>
<a href="#l5.90"></a><span id="l5.90">     else</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-      length = max-min+1;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+      length = max - min + 1;</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94">     return [length, min, max];</span>
<a href="#l5.95"></a><span id="l5.95">   },</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-  getArticle : function (msgid) {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  getArticle(msgid) {</span>
<a href="#l5.98"></a><span id="l5.98">     if (msgid in this._messages)</span>
<a href="#l5.99"></a><span id="l5.99">       return this._messages[msgid];</span>
<a href="#l5.100"></a><span id="l5.100">     return null;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-  }</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-}</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  },</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+};</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106"> function newsArticle(text) {</span>
<a href="#l5.107"></a><span id="l5.107">   this.headers = new Map();</span>
<a href="#l5.108"></a><span id="l5.108">   this.body = &quot;&quot;;</span>
<a href="#l5.109"></a><span id="l5.109">   this.messageID = &quot;&quot;;</span>
<a href="#l5.110"></a><span id="l5.110">   this.fullText = text;</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">   var headerMap;</span>
<a href="#l5.113"></a><span id="l5.113">   [headerMap, this.body] = MimeParser.extractHeadersAndBody(text);</span>
<a href="#l5.114"></a><span id="l5.114">   for (var [header, values] of headerMap._rawHeaders) {</span>
<a href="#l5.115"></a><span id="l5.115">     var value = values[0];</span>
<a href="#l5.116"></a><span id="l5.116">     this.headers.set(header, value);</span>
<a href="#l5.117"></a><span id="l5.117">     if (header == &quot;message-id&quot;) {</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-      var start = value.indexOf('&lt;');</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-      var end = value.indexOf('&gt;', start);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-      this.messageID = value.substring(start, end+1);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+      var start = value.indexOf(&quot;&lt;&quot;);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+      var end = value.indexOf(&quot;&gt;&quot;, start);</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      this.messageID = value.substring(start, end + 1);</span>
<a href="#l5.124"></a><span id="l5.124">     } else if (header == &quot;newsgroups&quot;) {</span>
<a href="#l5.125"></a><span id="l5.125">       this.groups = value.split(/[ \t]*,[ \t]*/);</span>
<a href="#l5.126"></a><span id="l5.126">     }</span>
<a href="#l5.127"></a><span id="l5.127">   }</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129">   // Add in non-existent fields</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-  if (!this.headers.has(&quot;lines&quot;))</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-  {</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    let lines = this.body.split('\n').length;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  if (!this.headers.has(&quot;lines&quot;)) {</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+    let lines = this.body.split(&quot;\n&quot;).length;</span>
<a href="#l5.135"></a><span id="l5.135">     this.headers.set(&quot;lines&quot;, lines);</span>
<a href="#l5.136"></a><span id="l5.136">   }</span>
<a href="#l5.137"></a><span id="l5.137"> }</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139"> /**</span>
<a href="#l5.140"></a><span id="l5.140">  * This function converts an NNTP wildmat into a regular expression.</span>
<a href="#l5.141"></a><span id="l5.141">  *</span>
<a href="#l5.142"></a><span id="l5.142">  * I don't know how accurate it is wrt i18n characters, but its primary usage</span>
<a href="#l5.143"></a><span id="l5.143">  * right now is just XPAT, where i18n effects are utterly unspecified, so I am</span>
<a href="#l5.144"></a><span id="l5.144">  * not too concerned.</span>
<a href="#l5.145"></a><span id="l5.145">  *</span>
<a href="#l5.146"></a><span id="l5.146">  * This also neglects cases where special characters are in [] blocks.</span>
<a href="#l5.147"></a><span id="l5.147">  */</span>
<a href="#l5.148"></a><span id="l5.148"> function wildmat2regex(wildmat) {</span>
<a href="#l5.149"></a><span id="l5.149">   // Special characters in regex that aren't special in wildmat</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-  wildmat = wildmat.replace(/[$+.()|{}^]/, function (str) {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+  wildmat = wildmat.replace(/[$+.()|{}^]/, function(str) {</span>
<a href="#l5.152"></a><span id="l5.152">       return &quot;\\&quot; + str;</span>
<a href="#l5.153"></a><span id="l5.153">   });</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-  wildmat = wildmat.replace(/(\\*)([*?])/, function (str, p1, p2) {</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+  wildmat = wildmat.replace(/(\\*)([*?])/, function(str, p1, p2) {</span>
<a href="#l5.156"></a><span id="l5.156">     // TODO: This function appears to be wrong on closer inspection.</span>
<a href="#l5.157"></a><span id="l5.157">     if (p1.length % 2 == 0)</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-      return p2 == '*' ? '.*' : '.';</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+      return p2 == &quot;*&quot; ? &quot;.*&quot; : &quot;.&quot;;</span>
<a href="#l5.160"></a><span id="l5.160">     return str;</span>
<a href="#l5.161"></a><span id="l5.161">   });</span>
<a href="#l5.162"></a><span id="l5.162">   return new RegExp(wildmat);</span>
<a href="#l5.163"></a><span id="l5.163"> }</span>
<a href="#l5.164"></a><span id="l5.164"> </span>
<a href="#l5.165"></a><span id="l5.165"> // NNTP FLAGS</span>
<a href="#l5.166"></a><span id="l5.166"> var NNTP_POSTABLE = 0x0001;</span>
<a href="#l5.167"></a><span id="l5.167"> </span>
<a href="#l5.168"></a><span id="l5.168"> var NNTP_REAL_LENGTH = 0x0100;</span>
<a href="#l5.169"></a><span id="l5.169"> </span>
<a href="#l5.170"></a><span id="l5.170"> function hasFlag(flags, flag) {</span>
<a href="#l5.171"></a><span id="l5.171">   return (flags &amp; flag) == flag;</span>
<a href="#l5.172"></a><span id="l5.172"> }</span>
<a href="#l5.173"></a><span id="l5.173"> </span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-//                              NNTP TEST SERVERS                             //</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-// To be comprehensive about testing and fallback, we define these varying    //</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-// levels of RFC-compliance:                                                  //</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-// * RFC 977 solely (there's not a lot there!)                                //</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-// * RFC 977 + 2980 (note that there are varying levels of this impl)         //</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-// * RFC 3977 bare bones                                                      //</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-// * RFC 3977 full                                                            //</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-// * RFC 3977 + post-3977 extensions                                          //</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-// * Giganews (Common newsserver for ISP stuff; highest importance)           //</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-// * INN 2.4 (Gold standard common implementation; second highest importance) //</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-// Note too that we want various levels of brokenness:                        //</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-// * Perm errors that require login                                           //</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-// * &quot;I can't handle that&quot; (e.g., news.mozilla.org only supports XOVER for    //</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-//   searching with XHDR)                                                     //</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-// * Naive group counts, missing articles                                     //</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-// * Limitations on what can be posted                                        //</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+// NNTP TEST SERVERS</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+// -----------------</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+// To be comprehensive about testing and fallback, we define these varying</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+// levels of RFC-compliance:</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+// * RFC 977 solely (there's not a lot there!)</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+// * RFC 977 + 2980 (note that there are varying levels of this impl)</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+// * RFC 3977 bare bones</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+// * RFC 3977 full</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+// * RFC 3977 + post-3977 extensions</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+// * Giganews (Common newsserver for ISP stuff; highest importance)</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+// * INN 2.4 (Gold standard common implementation; second highest importance)</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+// Note too that we want various levels of brokenness:</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+// * Perm errors that require login</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+// * &quot;I can't handle that&quot; (e.g., news.mozilla.org only supports XOVER for</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+//   searching with XHDR)</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+// * Naive group counts, missing articles</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+// * Limitations on what can be posted</span>
<a href="#l5.211"></a><span id="l5.211"> </span>
<a href="#l5.212"></a><span id="l5.212"> // This handler implements the bare minimum required by RFC 977. Actually, not</span>
<a href="#l5.213"></a><span id="l5.213"> // even that much: IHAVE and SLAVE are not implemented, as those two are</span>
<a href="#l5.214"></a><span id="l5.214"> // explicitly server implementations.</span>
<a href="#l5.215"></a><span id="l5.215"> function NNTP_RFC977_handler(daemon) {</span>
<a href="#l5.216"></a><span id="l5.216">   this._daemon = daemon;</span>
<a href="#l5.217"></a><span id="l5.217">   this.closing = false;</span>
<a href="#l5.218"></a><span id="l5.218">   this.resetTest();</span>
<a href="#l5.219"></a><span id="l5.219"> }</span>
<a href="#l5.220"></a><span id="l5.220"> NNTP_RFC977_handler.prototype = {</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-  resetTest : function() {</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  resetTest() {</span>
<a href="#l5.223"></a><span id="l5.223">     this.extraCommands = &quot;&quot;;</span>
<a href="#l5.224"></a><span id="l5.224">     this.articleKey = null;</span>
<a href="#l5.225"></a><span id="l5.225">     this.group = null;</span>
<a href="#l5.226"></a><span id="l5.226">   },</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-  ARTICLE : function (args) {</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+  ARTICLE(args) {</span>
<a href="#l5.229"></a><span id="l5.229">      var info = this._selectArticle(args, 220);</span>
<a href="#l5.230"></a><span id="l5.230">      if (info[0] == null)</span>
<a href="#l5.231"></a><span id="l5.231">        return info[1];</span>
<a href="#l5.232"></a><span id="l5.232"> </span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-     var response = info[1]+'\n';</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+     var response = info[1] + &quot;\n&quot;;</span>
<a href="#l5.235"></a><span id="l5.235">      response += info[0].fullText.replace(&quot;(?=\n).&quot;, &quot;..&quot;);</span>
<a href="#l5.236"></a><span id="l5.236">      response += &quot;.&quot;;</span>
<a href="#l5.237"></a><span id="l5.237">      return response;</span>
<a href="#l5.238"></a><span id="l5.238">   },</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-  BODY : function (args) {</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  BODY(args) {</span>
<a href="#l5.241"></a><span id="l5.241">      var info = this._selectArticle(args, 222);</span>
<a href="#l5.242"></a><span id="l5.242">      if (info[0] == null)</span>
<a href="#l5.243"></a><span id="l5.243">        return info[1];</span>
<a href="#l5.244"></a><span id="l5.244"> </span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-     var response = info[1]+'\n';</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-     response += info[0].body.replace(&quot;(?=\n).&quot;,&quot;..&quot;);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+     var response = info[1] + &quot;\n&quot;;</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+     response += info[0].body.replace(&quot;(?=\n).&quot;, &quot;..&quot;);</span>
<a href="#l5.249"></a><span id="l5.249">      response += &quot;.&quot;;</span>
<a href="#l5.250"></a><span id="l5.250">      return response;</span>
<a href="#l5.251"></a><span id="l5.251">   },</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-  GROUP : function(args) {</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+  GROUP(args) {</span>
<a href="#l5.254"></a><span id="l5.254">     var group = this._daemon.getGroup(args);</span>
<a href="#l5.255"></a><span id="l5.255">     if (group == null)</span>
<a href="#l5.256"></a><span id="l5.256">       return &quot;411 no such news group&quot;;</span>
<a href="#l5.257"></a><span id="l5.257"> </span>
<a href="#l5.258"></a><span id="l5.258">     this.group = group;</span>
<a href="#l5.259"></a><span id="l5.259">     this.articleKey = 0 in this.group.keys ? this.group.keys[0] : null;</span>
<a href="#l5.260"></a><span id="l5.260"> </span>
<a href="#l5.261"></a><span id="l5.261">     var stats = this._daemon.getGroupStats(group);</span>
<a href="#l5.262"></a><span id="l5.262">     return &quot;211 &quot; + stats[0] + &quot; &quot; + stats[1] + &quot; &quot; + stats[2] + &quot; &quot; + args +</span>
<a href="#l5.263"></a><span id="l5.263">            &quot; group selected&quot;;</span>
<a href="#l5.264"></a><span id="l5.264">   },</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  HEAD : function (args) {</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+  HEAD(args) {</span>
<a href="#l5.267"></a><span id="l5.267">      var info = this._selectArticle(args, 221);</span>
<a href="#l5.268"></a><span id="l5.268">      if (info[0] == null)</span>
<a href="#l5.269"></a><span id="l5.269">        return info[1];</span>
<a href="#l5.270"></a><span id="l5.270"> </span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-     var response = info[1]+'\n';</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+     var response = info[1] + &quot;\n&quot;;</span>
<a href="#l5.273"></a><span id="l5.273">      for (let [header, value] of info[0].headers)</span>
<a href="#l5.274"></a><span id="l5.274">        response += header + &quot;: &quot; + value + &quot;\n&quot;;</span>
<a href="#l5.275"></a><span id="l5.275">      response += &quot;.&quot;;</span>
<a href="#l5.276"></a><span id="l5.276">      return response;</span>
<a href="#l5.277"></a><span id="l5.277">   },</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-  HELP : function (args) {</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+  HELP(args) {</span>
<a href="#l5.280"></a><span id="l5.280">     var response = &quot;100 Why certainly, here is my help:\n&quot;;</span>
<a href="#l5.281"></a><span id="l5.281">     response += &quot;Mozilla fake NNTP RFC 977 testing server&quot;;</span>
<a href="#l5.282"></a><span id="l5.282">     response += &quot;Commands supported:\n&quot;;</span>
<a href="#l5.283"></a><span id="l5.283">     response += &quot;\tARTICLE &lt;message-id&gt; | [nnn]\n&quot;;</span>
<a href="#l5.284"></a><span id="l5.284">     response += &quot;\tBODY\n&quot;;</span>
<a href="#l5.285"></a><span id="l5.285">     response += &quot;\tGROUP group\n&quot;;</span>
<a href="#l5.286"></a><span id="l5.286">     response += &quot;\tHEAD\n&quot;;</span>
<a href="#l5.287"></a><span id="l5.287">     response += &quot;\tHELP\n&quot;;</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineat">@@ -228,131 +224,131 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l5.289"></a><span id="l5.289">     response += &quot;\tNEXT\n&quot;;</span>
<a href="#l5.290"></a><span id="l5.290">     response += &quot;\tPOST\n&quot;;</span>
<a href="#l5.291"></a><span id="l5.291">     response += &quot;\tQUIT\n&quot;;</span>
<a href="#l5.292"></a><span id="l5.292">     response += &quot;\tSTAT\n&quot;;</span>
<a href="#l5.293"></a><span id="l5.293">     response += this.extraCommands;</span>
<a href="#l5.294"></a><span id="l5.294">     response += &quot;.&quot;;</span>
<a href="#l5.295"></a><span id="l5.295">     return response;</span>
<a href="#l5.296"></a><span id="l5.296">   },</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-  LAST : function (args) {</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+  LAST(args) {</span>
<a href="#l5.299"></a><span id="l5.299">     if (this.group == null)</span>
<a href="#l5.300"></a><span id="l5.300">       return &quot;412 no newsgroup selected&quot;;</span>
<a href="#l5.301"></a><span id="l5.301">     if (this.articleKey == null)</span>
<a href="#l5.302"></a><span id="l5.302">       return &quot;420 no current article has been selected&quot;;</span>
<a href="#l5.303"></a><span id="l5.303">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l5.304"></a><span id="l5.304">   },</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-  LIST : function (args) {</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+  LIST(args) {</span>
<a href="#l5.307"></a><span id="l5.307">     var response = &quot;215 list of newsgroup follows\n&quot;;</span>
<a href="#l5.308"></a><span id="l5.308">     for (let groupname in this._daemon._groups) {</span>
<a href="#l5.309"></a><span id="l5.309">       let group = this._daemon._groups[groupname];</span>
<a href="#l5.310"></a><span id="l5.310">       let stats = this._daemon.getGroupStats(group);</span>
<a href="#l5.311"></a><span id="l5.311">       response += groupname + &quot; &quot; + stats[1] + &quot; &quot; + stats[0] + &quot; &quot; +</span>
<a href="#l5.312"></a><span id="l5.312">                   (hasFlag(group.flags, NNTP_POSTABLE) ? &quot;y&quot; : &quot;n&quot;) + &quot;\n&quot;;</span>
<a href="#l5.313"></a><span id="l5.313">     }</span>
<a href="#l5.314"></a><span id="l5.314">     response += &quot;.&quot;;</span>
<a href="#l5.315"></a><span id="l5.315">     return response;</span>
<a href="#l5.316"></a><span id="l5.316">   },</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-  NEWGROUPS : function (args) {</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+  NEWGROUPS(args) {</span>
<a href="#l5.319"></a><span id="l5.319">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l5.320"></a><span id="l5.320">   },</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-  NEWNEWS : function (args) {</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+  NEWNEWS(args) {</span>
<a href="#l5.323"></a><span id="l5.323">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l5.324"></a><span id="l5.324">   },</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-  NEXT : function (args) {</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+  NEXT(args) {</span>
<a href="#l5.327"></a><span id="l5.327">     if (this.group == null)</span>
<a href="#l5.328"></a><span id="l5.328">       return &quot;412 no newsgroup selected&quot;;</span>
<a href="#l5.329"></a><span id="l5.329">     if (this.articleKey == null)</span>
<a href="#l5.330"></a><span id="l5.330">       return &quot;420 no current article has been selected&quot;;</span>
<a href="#l5.331"></a><span id="l5.331">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l5.332"></a><span id="l5.332">   },</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-  POST : function(args) {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+  POST(args) {</span>
<a href="#l5.335"></a><span id="l5.335">     this.posting = true;</span>
<a href="#l5.336"></a><span id="l5.336">     this.post = &quot;&quot;;</span>
<a href="#l5.337"></a><span id="l5.337">     return &quot;340 Please continue&quot;;</span>
<a href="#l5.338"></a><span id="l5.338">   },</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-  QUIT : function(args) {</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+  QUIT(args) {</span>
<a href="#l5.341"></a><span id="l5.341">     this.closing = true;</span>
<a href="#l5.342"></a><span id="l5.342">     return &quot;205 closing connection - goodbye!&quot;;</span>
<a href="#l5.343"></a><span id="l5.343">   },</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-  STAT : function (args) {</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+  STAT(args) {</span>
<a href="#l5.346"></a><span id="l5.346">      var info = this._selectArticle(args, 223);</span>
<a href="#l5.347"></a><span id="l5.347">      return info[1];</span>
<a href="#l5.348"></a><span id="l5.348">   },</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-  LISTGROUP : function (args) {</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+  LISTGROUP(args) {</span>
<a href="#l5.351"></a><span id="l5.351">     // Yes, I know this isn't RFC 977, but I doubt that mailnews will ever drop</span>
<a href="#l5.352"></a><span id="l5.352">     // its requirement for this, so I'll stuff it in here anyways...</span>
<a href="#l5.353"></a><span id="l5.353">     var group = (args == &quot;&quot; ? this.group : this._daemon.getGroup(args));</span>
<a href="#l5.354"></a><span id="l5.354">     if (group == null)</span>
<a href="#l5.355"></a><span id="l5.355">       return &quot;411 This newsgroup does not exist&quot;;</span>
<a href="#l5.356"></a><span id="l5.356"> </span>
<a href="#l5.357"></a><span id="l5.357">     var response = &quot;211 Articles follow:\n&quot;;</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-    for (let key of group['keys'])</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+    for (let key of group.keys)</span>
<a href="#l5.360"></a><span id="l5.360">       response += key + &quot;\n&quot;;</span>
<a href="#l5.361"></a><span id="l5.361">     response += &quot;.\n&quot;;</span>
<a href="#l5.362"></a><span id="l5.362">     return response;</span>
<a href="#l5.363"></a><span id="l5.363">   },</span>
<a href="#l5.364"></a><span id="l5.364"> </span>
<a href="#l5.365"></a><span id="l5.365"> </span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-  onError : function (command, args) {</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  onError(command, args) {</span>
<a href="#l5.368"></a><span id="l5.368">     return &quot;500 command not recognized&quot;;</span>
<a href="#l5.369"></a><span id="l5.369">   },</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-  onServerFault: function (e) {</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+  onServerFault(e) {</span>
<a href="#l5.372"></a><span id="l5.372">     return &quot;500 internal server error: &quot; + e;</span>
<a href="#l5.373"></a><span id="l5.373">   },</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-  onStartup : function () {</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+  onStartup() {</span>
<a href="#l5.376"></a><span id="l5.376">     this.closing = false;</span>
<a href="#l5.377"></a><span id="l5.377">     this.group = null;</span>
<a href="#l5.378"></a><span id="l5.378">     this.article = null;</span>
<a href="#l5.379"></a><span id="l5.379">     this.posting = false;</span>
<a href="#l5.380"></a><span id="l5.380">     return &quot;200 posting allowed&quot;;</span>
<a href="#l5.381"></a><span id="l5.381">   },</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-  onMultiline : function (line) {</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+  onMultiline(line) {</span>
<a href="#l5.384"></a><span id="l5.384">     if (line == &quot;.&quot;) {</span>
<a href="#l5.385"></a><span id="l5.385">       if (this.posting) {</span>
<a href="#l5.386"></a><span id="l5.386">         var article = new newsArticle(this.post);</span>
<a href="#l5.387"></a><span id="l5.387">         this._daemon.addArticle(article);</span>
<a href="#l5.388"></a><span id="l5.388">         this.posting = false;</span>
<a href="#l5.389"></a><span id="l5.389">         return &quot;240 Wonderful article, your style is gorgeous!&quot;;</span>
<a href="#l5.390"></a><span id="l5.390">       }</span>
<a href="#l5.391"></a><span id="l5.391">     }</span>
<a href="#l5.392"></a><span id="l5.392"> </span>
<a href="#l5.393"></a><span id="l5.393">     if (this.posting) {</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-      if (line.startsWith('.'))</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+      if (line.startsWith(&quot;.&quot;))</span>
<a href="#l5.396"></a><span id="l5.396">         line = line.substring(1);</span>
<a href="#l5.397"></a><span id="l5.397"> </span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-      this.post += line+'\n';</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+      this.post += line + &quot;\n&quot;;</span>
<a href="#l5.400"></a><span id="l5.400">     }</span>
<a href="#l5.401"></a><span id="l5.401"> </span>
<a href="#l5.402"></a><span id="l5.402">     return undefined;</span>
<a href="#l5.403"></a><span id="l5.403">   },</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-  postCommand : function (reader) {</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+  postCommand(reader) {</span>
<a href="#l5.406"></a><span id="l5.406">     if (this.closing)</span>
<a href="#l5.407"></a><span id="l5.407">       reader.closeSocket();</span>
<a href="#l5.408"></a><span id="l5.408">     reader.setMultiline(this.posting);</span>
<a href="#l5.409"></a><span id="l5.409">   },</span>
<a href="#l5.410"></a><span id="l5.410"> </span>
<a href="#l5.411"></a><span id="l5.411">   /**</span>
<a href="#l5.412"></a><span id="l5.412">    * Selects an article based on args.</span>
<a href="#l5.413"></a><span id="l5.413">    *</span>
<a href="#l5.414"></a><span id="l5.414">    * Returns an array of objects consisting of:</span>
<a href="#l5.415"></a><span id="l5.415">    * # The selected article (or null if non was selected</span>
<a href="#l5.416"></a><span id="l5.416">    * # The first line response</span>
<a href="#l5.417"></a><span id="l5.417">    */</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-  _selectArticle : function (args, responseCode) {</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+  _selectArticle(args, responseCode) {</span>
<a href="#l5.420"></a><span id="l5.420">     var art, key;</span>
<a href="#l5.421"></a><span id="l5.421">     if (args == &quot;&quot;) {</span>
<a href="#l5.422"></a><span id="l5.422">       if (this.group == null)</span>
<a href="#l5.423"></a><span id="l5.423">         return [null, &quot;412 no newsgroup has been selected&quot;];</span>
<a href="#l5.424"></a><span id="l5.424">       if (this.articleKey == null)</span>
<a href="#l5.425"></a><span id="l5.425">         return [null, &quot;420 no current article has been selected&quot;];</span>
<a href="#l5.426"></a><span id="l5.426"> </span>
<a href="#l5.427"></a><span id="l5.427">       art = this.group[this.articleKey];</span>
<a href="#l5.428"></a><span id="l5.428">       key = this.articleKey;</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-    } else if (args.startsWith('&lt;')) {</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+    } else if (args.startsWith(&quot;&lt;&quot;)) {</span>
<a href="#l5.431"></a><span id="l5.431">       art = this._daemon.getArticle(args);</span>
<a href="#l5.432"></a><span id="l5.432">       key = 0;</span>
<a href="#l5.433"></a><span id="l5.433"> </span>
<a href="#l5.434"></a><span id="l5.434">       if (art == null)</span>
<a href="#l5.435"></a><span id="l5.435">         return [null, &quot;430 no such article found&quot;];</span>
<a href="#l5.436"></a><span id="l5.436">     } else {</span>
<a href="#l5.437"></a><span id="l5.437">       if (this.group == null)</span>
<a href="#l5.438"></a><span id="l5.438">         return [null, &quot;412 no newsgroup has been selected&quot;];</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineat">@@ -364,18 +360,18 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l5.440"></a><span id="l5.440">       } else {</span>
<a href="#l5.441"></a><span id="l5.441">         return [null, &quot;423 no such article number in this group&quot;];</span>
<a href="#l5.442"></a><span id="l5.442">       }</span>
<a href="#l5.443"></a><span id="l5.443">     }</span>
<a href="#l5.444"></a><span id="l5.444"> </span>
<a href="#l5.445"></a><span id="l5.445">     var respCode = responseCode + &quot; &quot; + key + &quot; &quot; + art.messageID +</span>
<a href="#l5.446"></a><span id="l5.446">       &quot; article selected&quot;;</span>
<a href="#l5.447"></a><span id="l5.447">     return [art, respCode];</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-  }</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-}</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+  },</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+};</span>
<a href="#l5.452"></a><span id="l5.452"> </span>
<a href="#l5.453"></a><span id="l5.453"> /**</span>
<a href="#l5.454"></a><span id="l5.454">  * Utility method to define a subclass</span>
<a href="#l5.455"></a><span id="l5.455">  *</span>
<a href="#l5.456"></a><span id="l5.456">  * @param sub   The function object of the subclass</span>
<a href="#l5.457"></a><span id="l5.457">  * @param super The function object of the superclass</span>
<a href="#l5.458"></a><span id="l5.458">  * @param def   The object definition of the subclass prototype.</span>
<a href="#l5.459"></a><span id="l5.459">  */</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineat">@@ -383,153 +379,153 @@ function subclass(sub, sup, def) {</span>
<a href="#l5.461"></a><span id="l5.461">   sub.prototype = new sup();</span>
<a href="#l5.462"></a><span id="l5.462">   for (let obj in def) {</span>
<a href="#l5.463"></a><span id="l5.463">     sub.prototype[obj] = def[obj];</span>
<a href="#l5.464"></a><span id="l5.464">   }</span>
<a href="#l5.465"></a><span id="l5.465"> }</span>
<a href="#l5.466"></a><span id="l5.466"> function subconstructor(sub, sup, ...aArgs) {</span>
<a href="#l5.467"></a><span id="l5.467">   sup.apply(sub, aArgs);</span>
<a href="#l5.468"></a><span id="l5.468">   sub.parent = new Proxy(sub, {</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-    get: function (target, name) {</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+    get(target, name) {</span>
<a href="#l5.471"></a><span id="l5.471">       let res = sup.prototype[name];</span>
<a href="#l5.472"></a><span id="l5.472">       if (typeof res === &quot;function&quot;)</span>
<a href="#l5.473"></a><span id="l5.473">         return res.bind(sub);</span>
<a href="#l5.474"></a><span id="l5.474">       return res;</span>
<a href="#l5.475"></a><span id="l5.475">     }});</span>
<a href="#l5.476"></a><span id="l5.476"> }</span>
<a href="#l5.477"></a><span id="l5.477"> function NNTP_RFC2980_handler(daemon) {</span>
<a href="#l5.478"></a><span id="l5.478">   subconstructor(this, NNTP_RFC977_handler, daemon);</span>
<a href="#l5.479"></a><span id="l5.479"> }</span>
<a href="#l5.480"></a><span id="l5.480"> subclass(NNTP_RFC2980_handler, NNTP_RFC977_handler, {</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-//NNTP_RFC2980_handler.prototype = new NNTP_RFC977_handler();</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-//var subprototype = {</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-  DATE : function (args) {</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+// NNTP_RFC2980_handler.prototype = new NNTP_RFC977_handler();</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+// var subprototype = {</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+  DATE(args) {</span>
<a href="#l5.487"></a><span id="l5.487">     return &quot;502 Command not implemented&quot;;</span>
<a href="#l5.488"></a><span id="l5.488">   },</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-  LIST : function (args) {</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+  LIST(args) {</span>
<a href="#l5.491"></a><span id="l5.491">     var index = args.indexOf(&quot; &quot;);</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-    var command = index == -1 ? args : args.substring(0,index);</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-    args = index == -1 ? &quot;&quot; : args.substring(index+1);</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+    var command = index == -1 ? args : args.substring(0, index);</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+    args = index == -1 ? &quot;&quot; : args.substring(index + 1);</span>
<a href="#l5.496"></a><span id="l5.496">     command = command.toUpperCase();</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-    if (&quot;LIST_&quot;+command in this)</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-      return this[&quot;LIST_&quot;+command](args);</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-    return this.parent.LIST(command+&quot; &quot;+args);</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+    if ((&quot;LIST_&quot; + command) in this)</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+      return this[&quot;LIST_&quot; + command](args);</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+    return this.parent.LIST(command + &quot; &quot; + args);</span>
<a href="#l5.503"></a><span id="l5.503">   },</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineminus">-  LIST_ACTIVE : function (args) {</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+  LIST_ACTIVE(args) {</span>
<a href="#l5.506"></a><span id="l5.506">     return this.parent.LIST(args);</span>
<a href="#l5.507"></a><span id="l5.507">   },</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-  MODE : function (args) {</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+  MODE(args) {</span>
<a href="#l5.510"></a><span id="l5.510">     if (args == &quot;READER&quot;)</span>
<a href="#l5.511"></a><span id="l5.511">       return this.onStartup();</span>
<a href="#l5.512"></a><span id="l5.512">     return &quot;500 What do you think you're trying to pull here?&quot;;</span>
<a href="#l5.513"></a><span id="l5.513">   },</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-  XHDR : function (args) {</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+  XHDR(args) {</span>
<a href="#l5.516"></a><span id="l5.516">     if (!this.group)</span>
<a href="#l5.517"></a><span id="l5.517">       return &quot;412 No group selected&quot;;</span>
<a href="#l5.518"></a><span id="l5.518"> </span>
<a href="#l5.519"></a><span id="l5.519">     args = args.split(&quot; &quot;);</span>
<a href="#l5.520"></a><span id="l5.520">     var header = args[0].toLowerCase();</span>
<a href="#l5.521"></a><span id="l5.521">     var found = false;</span>
<a href="#l5.522"></a><span id="l5.522">     var response = &quot;221 Headers abound\n&quot;;</span>
<a href="#l5.523"></a><span id="l5.523">     for (let key of this._filterRange(args[1], this.group.keys)) {</span>
<a href="#l5.524"></a><span id="l5.524">       if (!this.group[key].headers.has(header))</span>
<a href="#l5.525"></a><span id="l5.525">         continue;</span>
<a href="#l5.526"></a><span id="l5.526">       found = true;</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-      response += key + &quot; &quot; + this.group[key].headers.get(header) + '\n';</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+      response += key + &quot; &quot; + this.group[key].headers.get(header) + &quot;\n&quot;;</span>
<a href="#l5.529"></a><span id="l5.529">     }</span>
<a href="#l5.530"></a><span id="l5.530">     if (!found)</span>
<a href="#l5.531"></a><span id="l5.531">       return &quot;420 No such article&quot;;</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-    response += '.';</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+    response += &quot;.&quot;;</span>
<a href="#l5.534"></a><span id="l5.534">     return response;</span>
<a href="#l5.535"></a><span id="l5.535">   },</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-  XOVER : function (args) {</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+  XOVER(args) {</span>
<a href="#l5.538"></a><span id="l5.538">     if (!this.group)</span>
<a href="#l5.539"></a><span id="l5.539">       return &quot;412 No group selected&quot;;</span>
<a href="#l5.540"></a><span id="l5.540"> </span>
<a href="#l5.541"></a><span id="l5.541">     args = args.split(/ +/, 3);</span>
<a href="#l5.542"></a><span id="l5.542">     var response = &quot;224 List of articles\n&quot;;</span>
<a href="#l5.543"></a><span id="l5.543">     for (let key of this._filterRange(args[0], this.group.keys)) {</span>
<a href="#l5.544"></a><span id="l5.544">       response += key + &quot;\t&quot;;</span>
<a href="#l5.545"></a><span id="l5.545">       var article = this.group[key];</span>
<a href="#l5.546"></a><span id="l5.546">       response += article.headers.get(&quot;subject&quot;) + &quot;\t&quot; +</span>
<a href="#l5.547"></a><span id="l5.547">                   article.headers.get(&quot;from&quot;) + &quot;\t&quot; +</span>
<a href="#l5.548"></a><span id="l5.548">                   article.headers.get(&quot;date&quot;) + &quot;\t&quot; +</span>
<a href="#l5.549"></a><span id="l5.549">                   article.headers.get(&quot;message-id&quot;) + &quot;\t&quot; +</span>
<a href="#l5.550"></a><span id="l5.550">                   (article.headers.get(&quot;references&quot;) || &quot;&quot;) + &quot;\t&quot; +</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineminus">-                  article.fullText.replace(/\r?\n/,'\r\n').length + &quot;\t&quot; +</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+                  article.fullText.replace(/\r?\n/, &quot;\r\n&quot;).length + &quot;\t&quot; +</span>
<a href="#l5.553"></a><span id="l5.553">                   article.body.split(/\r?\n/).length + &quot;\t&quot; +</span>
<a href="#l5.554"></a><span id="l5.554">                   (article.headers.get(&quot;xref&quot;) || &quot;&quot;) + &quot;\n&quot;;</span>
<a href="#l5.555"></a><span id="l5.555">     }</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-    response += '.\n';</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+    response += &quot;.\n&quot;;</span>
<a href="#l5.558"></a><span id="l5.558">     return response;</span>
<a href="#l5.559"></a><span id="l5.559">   },</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineminus">-  XPAT : function (args) {</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+  XPAT(args) {</span>
<a href="#l5.562"></a><span id="l5.562">     if (!this.group)</span>
<a href="#l5.563"></a><span id="l5.563">       return &quot;412 No group selected&quot;;</span>
<a href="#l5.564"></a><span id="l5.564"> </span>
<a href="#l5.565"></a><span id="l5.565">     /* XPAT header range ... */</span>
<a href="#l5.566"></a><span id="l5.566">     args = args.split(/ +/, 3);</span>
<a href="#l5.567"></a><span id="l5.567">     let header = args[0].toLowerCase();</span>
<a href="#l5.568"></a><span id="l5.568">     let regex = wildmat2regex(args[2]);</span>
<a href="#l5.569"></a><span id="l5.569"> </span>
<a href="#l5.570"></a><span id="l5.570">     let response = &quot;221 Results follow\n&quot;;</span>
<a href="#l5.571"></a><span id="l5.571">     for (let key of this._filterRange(args[1], this.group.keys)) {</span>
<a href="#l5.572"></a><span id="l5.572">       let article = this.group[key];</span>
<a href="#l5.573"></a><span id="l5.573">       if (article.headers.has(header) &amp;&amp;</span>
<a href="#l5.574"></a><span id="l5.574">           regex.test(article.headers.get(header))) {</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineminus">-        response += key + ' ' + article.headers.get(header) + '\n';</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+        response += key + &quot; &quot; + article.headers.get(header) + &quot;\n&quot;;</span>
<a href="#l5.577"></a><span id="l5.577">       }</span>
<a href="#l5.578"></a><span id="l5.578">     }</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-    return response + '.';</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+    return response + &quot;.&quot;;</span>
<a href="#l5.581"></a><span id="l5.581">   },</span>
<a href="#l5.582"></a><span id="l5.582"> </span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-  _filterRange: function (range, keys) {</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineminus">-    let dash = range.indexOf('-');</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+  _filterRange(range, keys) {</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+    let dash = range.indexOf(&quot;-&quot;);</span>
<a href="#l5.587"></a><span id="l5.587">     let low, high;</span>
<a href="#l5.588"></a><span id="l5.588">     if (dash &lt; 0) {</span>
<a href="#l5.589"></a><span id="l5.589">       low = high = parseInt(range);</span>
<a href="#l5.590"></a><span id="l5.590">     } else {</span>
<a href="#l5.591"></a><span id="l5.591">       low = parseInt(range.substring(0, dash));</span>
<a href="#l5.592"></a><span id="l5.592">       if (dash &lt; range.length - 1)</span>
<a href="#l5.593"></a><span id="l5.593">         high = range.substring(dash + 1);</span>
<a href="#l5.594"></a><span id="l5.594">       else</span>
<a href="#l5.595"></a><span id="l5.595">         high = 1.0 / 0.0; // Everything is less than this</span>
<a href="#l5.596"></a><span id="l5.596">     }</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineminus">-    return keys.filter(function (e) { return low &lt;= e &amp;&amp; e &lt;= high; });</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-  }</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+    return keys.filter(function(e) { return low &lt;= e &amp;&amp; e &lt;= high; });</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+  },</span>
<a href="#l5.601"></a><span id="l5.601"> });</span>
<a href="#l5.602"></a><span id="l5.602"> </span>
<a href="#l5.603"></a><span id="l5.603"> function NNTP_Giganews_handler(daemon) {</span>
<a href="#l5.604"></a><span id="l5.604">   subconstructor(this, NNTP_RFC2980_handler, daemon);</span>
<a href="#l5.605"></a><span id="l5.605"> }</span>
<a href="#l5.606"></a><span id="l5.606"> subclass(NNTP_Giganews_handler, NNTP_RFC2980_handler, {</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-  XHDR : function (args) {</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+  XHDR(args) {</span>
<a href="#l5.609"></a><span id="l5.609">     var header = args.split(&quot; &quot;)[0].toLowerCase();</span>
<a href="#l5.610"></a><span id="l5.610">     if (header in [&quot;subject&quot;, &quot;from&quot;, &quot;xref&quot;, &quot;date&quot;, &quot;message-id&quot;,</span>
<a href="#l5.611"></a><span id="l5.611">                    &quot;references&quot;]) {</span>
<a href="#l5.612"></a><span id="l5.612">       return this.parent.XHDR(args);</span>
<a href="#l5.613"></a><span id="l5.613">     }</span>
<a href="#l5.614"></a><span id="l5.614">     return &quot;503 unsupported header field&quot;;</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-  }</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+  },</span>
<a href="#l5.617"></a><span id="l5.617"> });</span>
<a href="#l5.618"></a><span id="l5.618"> </span>
<a href="#l5.619"></a><span id="l5.619"> function NNTP_RFC4643_extension(daemon) {</span>
<a href="#l5.620"></a><span id="l5.620">   subconstructor(this, NNTP_RFC2980_handler, daemon);</span>
<a href="#l5.621"></a><span id="l5.621"> </span>
<a href="#l5.622"></a><span id="l5.622">   this.extraCommands += &quot;\tAUTHINFO USER\n&quot;;</span>
<a href="#l5.623"></a><span id="l5.623">   this.extraCommands += &quot;\tAUTHINFO PASS\n&quot;;</span>
<a href="#l5.624"></a><span id="l5.624"> }</span>
<a href="#l5.625"></a><span id="l5.625"> subclass(NNTP_RFC4643_extension, NNTP_RFC2980_handler, {</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-  expectedUsername : &quot;testnews&quot;,</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-  expectedPassword : &quot;newstest&quot;,</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-  requireBoth : true,</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+  expectedUsername: &quot;testnews&quot;,</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+  expectedPassword: &quot;newstest&quot;,</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+  requireBoth: true,</span>
<a href="#l5.632"></a><span id="l5.632">   authenticated: false,</span>
<a href="#l5.633"></a><span id="l5.633">   usernameReceived: false,</span>
<a href="#l5.634"></a><span id="l5.634"> </span>
<a href="#l5.635"></a><span id="l5.635" class="difflineminus">-  AUTHINFO : function (args) {</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+  AUTHINFO(args) {</span>
<a href="#l5.637"></a><span id="l5.637">     if (this.authenticated)</span>
<a href="#l5.638"></a><span id="l5.638">       return &quot;502 Command unavailable&quot;;</span>
<a href="#l5.639"></a><span id="l5.639"> </span>
<a href="#l5.640"></a><span id="l5.640">     var argSplit = args.split(&quot; &quot;);</span>
<a href="#l5.641"></a><span id="l5.641">     var action = argSplit[0];</span>
<a href="#l5.642"></a><span id="l5.642">     var param = argSplit[1];</span>
<a href="#l5.643"></a><span id="l5.643"> </span>
<a href="#l5.644"></a><span id="l5.644">     if (action == &quot;user&quot;) {</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineat">@@ -543,41 +539,40 @@ subclass(NNTP_RFC4643_extension, NNTP_RF</span>
<a href="#l5.646"></a><span id="l5.646">         return &quot;481 Authentication failed&quot;;</span>
<a href="#l5.647"></a><span id="l5.647"> </span>
<a href="#l5.648"></a><span id="l5.648">       this.usernameReceived = true;</span>
<a href="#l5.649"></a><span id="l5.649">       if (this.requireBoth)</span>
<a href="#l5.650"></a><span id="l5.650">         return &quot;381 Password required&quot;;</span>
<a href="#l5.651"></a><span id="l5.651"> </span>
<a href="#l5.652"></a><span id="l5.652">       this.authenticated = this.lastGroupTried ? this.lastGroupTried : true;</span>
<a href="#l5.653"></a><span id="l5.653">       return &quot;281 Authentication Accepted&quot;;</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-    }</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-    else if (action == &quot;pass&quot;) {</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+    } else if (action == &quot;pass&quot;) {</span>
<a href="#l5.657"></a><span id="l5.657">       if (!this.requireBoth || !this.usernameReceived)</span>
<a href="#l5.658"></a><span id="l5.658">         return &quot;482 Authentication commands issued out of sequence&quot;;</span>
<a href="#l5.659"></a><span id="l5.659"> </span>
<a href="#l5.660"></a><span id="l5.660">       this.usernameReceived = false;</span>
<a href="#l5.661"></a><span id="l5.661"> </span>
<a href="#l5.662"></a><span id="l5.662">       var expectPassword = this.lastGroupTried</span>
<a href="#l5.663"></a><span id="l5.663">         ? this._daemon.groupCredentials[this.lastGroupTried][1]</span>
<a href="#l5.664"></a><span id="l5.664">         : this.expectedPassword;</span>
<a href="#l5.665"></a><span id="l5.665">       if (param != expectPassword)</span>
<a href="#l5.666"></a><span id="l5.666">         return &quot;481 Authentication failed&quot;;</span>
<a href="#l5.667"></a><span id="l5.667"> </span>
<a href="#l5.668"></a><span id="l5.668">       this.authenticated = this.lastGroupTried ? this.lastGroupTried : true;</span>
<a href="#l5.669"></a><span id="l5.669">       return &quot;281 Authentication Accepted&quot;;</span>
<a href="#l5.670"></a><span id="l5.670">     }</span>
<a href="#l5.671"></a><span id="l5.671">     return &quot;502 Invalid Command&quot;;</span>
<a href="#l5.672"></a><span id="l5.672">   },</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineminus">-  LIST : function (args) {</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+  LIST(args) {</span>
<a href="#l5.675"></a><span id="l5.675">     if (this.authenticated) {</span>
<a href="#l5.676"></a><span id="l5.676">       return this.parent.LIST(args);</span>
<a href="#l5.677"></a><span id="l5.677">     }</span>
<a href="#l5.678"></a><span id="l5.678">     return &quot;480 Authentication required&quot;;</span>
<a href="#l5.679"></a><span id="l5.679">   },</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-  GROUP : function (args) {</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+  GROUP(args) {</span>
<a href="#l5.682"></a><span id="l5.682">     if ((this._daemon.groupCredentials != null &amp;&amp; this.authenticated == args)</span>
<a href="#l5.683"></a><span id="l5.683">         || (this._daemon.groupCredentials == null &amp;&amp; this.authenticated))</span>
<a href="#l5.684"></a><span id="l5.684">       return this.parent.GROUP(args);</span>
<a href="#l5.685"></a><span id="l5.685">     if (this._daemon.groupCredentials != null)</span>
<a href="#l5.686"></a><span id="l5.686">       this.lastGroupTried = args;</span>
<a href="#l5.687"></a><span id="l5.687">     return &quot;480 Authentication required&quot;;</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-  }</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+  },</span>
<a href="#l5.690"></a><span id="l5.690"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/test/fakeserver/pop3d.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/test/fakeserver/pop3d.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2,20 +2,20 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /**</span>
<a href="#l6.5"></a><span id="l6.5">  * Contributors:</span>
<a href="#l6.6"></a><span id="l6.6">  *   Ben Bucksch &lt;ben.bucksch beonex.com&gt; &lt;http://business.beonex.com&gt; (RFC 5034 Authentication)</span>
<a href="#l6.7"></a><span id="l6.7">  */</span>
<a href="#l6.8"></a><span id="l6.8"> /* This file implements test POP3 servers</span>
<a href="#l6.9"></a><span id="l6.9">  */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> var EXPORTED_SYMBOLS = [</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  'pop3Daemon',</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  'POP3_RFC1939_handler',</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  'POP3_RFC2449_handler',</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  'POP3_RFC5034_handler'</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  &quot;pop3Daemon&quot;,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  &quot;POP3_RFC1939_handler&quot;,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  &quot;POP3_RFC2449_handler&quot;,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  &quot;POP3_RFC5034_handler&quot;,</span>
<a href="#l6.20"></a><span id="l6.20"> ];</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.23"></a><span id="l6.23"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l6.24"></a><span id="l6.24"> var {</span>
<a href="#l6.25"></a><span id="l6.25">   AuthPLAIN,</span>
<a href="#l6.26"></a><span id="l6.26">   AuthLOGIN,</span>
<a href="#l6.27"></a><span id="l6.27">   AuthCRAM,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineat">@@ -36,26 +36,25 @@ function readFile(fileName) {</span>
<a href="#l6.29"></a><span id="l6.29">   let cwd = Services.dirsvc.get(&quot;CurWorkD&quot;, Ci.nsIFile);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">   // Try to find the file relative to either the data directory or to the</span>
<a href="#l6.32"></a><span id="l6.32">   // current working directory.</span>
<a href="#l6.33"></a><span id="l6.33">   let file = cwd.clone();</span>
<a href="#l6.34"></a><span id="l6.34">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l6.35"></a><span id="l6.35">     // Windows doesn't allow '..' in appendRelativePath,</span>
<a href="#l6.36"></a><span id="l6.36">     // so we'll have to do this the long way.</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-    if (fileName.includes('/')) {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-      let parts = fileName.split('/');</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    if (fileName.includes(&quot;/&quot;)) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+      let parts = fileName.split(&quot;/&quot;);</span>
<a href="#l6.41"></a><span id="l6.41">       for (let part of parts) {</span>
<a href="#l6.42"></a><span id="l6.42">         if (part == &quot;..&quot;)</span>
<a href="#l6.43"></a><span id="l6.43">           file = file.parent;</span>
<a href="#l6.44"></a><span id="l6.44">         else</span>
<a href="#l6.45"></a><span id="l6.45">           file.append(part);</span>
<a href="#l6.46"></a><span id="l6.46">       }</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    }</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    else {</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    } else {</span>
<a href="#l6.50"></a><span id="l6.50">       file.append(&quot;data&quot;);</span>
<a href="#l6.51"></a><span id="l6.51">       file.append(fileName);</span>
<a href="#l6.52"></a><span id="l6.52">     }</span>
<a href="#l6.53"></a><span id="l6.53">   } else {</span>
<a href="#l6.54"></a><span id="l6.54">     file.appendRelativePath(&quot;data/&quot; + fileName);</span>
<a href="#l6.55"></a><span id="l6.55">     if (!file.exists()) {</span>
<a href="#l6.56"></a><span id="l6.56">       file = cwd.clone();</span>
<a href="#l6.57"></a><span id="l6.57">       file.appendRelativePath(fileName);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineat">@@ -77,49 +76,46 @@ pop3Daemon.prototype = {</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">   /**</span>
<a href="#l6.61"></a><span id="l6.61">    * Set the messages that the POP3 daemon will provide to its clients.</span>
<a href="#l6.62"></a><span id="l6.62">    *</span>
<a href="#l6.63"></a><span id="l6.63">    * @param messages An array of either 1) strings that are filenames whose</span>
<a href="#l6.64"></a><span id="l6.64">    *     contents will be loaded from the files or 2) objects with a &quot;fileData&quot;</span>
<a href="#l6.65"></a><span id="l6.65">    *     attribute whose value is the content of the file.</span>
<a href="#l6.66"></a><span id="l6.66">    */</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  setMessages: function(messages) {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  setMessages(messages) {</span>
<a href="#l6.69"></a><span id="l6.69">     this._messages = [];</span>
<a href="#l6.70"></a><span id="l6.70">     this._totalMessageSize = 0;</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">     function addMessage(element) {</span>
<a href="#l6.73"></a><span id="l6.73">       // if it's a string, then it's a file-name.</span>
<a href="#l6.74"></a><span id="l6.74">       if (typeof element == &quot;string&quot;)</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-        this._messages.push( { fileData: readFile(element), size: -1 });</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+        this._messages.push({ fileData: readFile(element), size: -1 });</span>
<a href="#l6.77"></a><span id="l6.77">       // otherwise it's an object as dictionary already</span>
<a href="#l6.78"></a><span id="l6.78">       else</span>
<a href="#l6.79"></a><span id="l6.79">         this._messages.push(element);</span>
<a href="#l6.80"></a><span id="l6.80">     }</span>
<a href="#l6.81"></a><span id="l6.81">     messages.forEach(addMessage, this);</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83">     for (var i = 0; i &lt; this._messages.length; ++i) {</span>
<a href="#l6.84"></a><span id="l6.84">       this._messages[i].size = this._messages[i].fileData.length;</span>
<a href="#l6.85"></a><span id="l6.85">       this._messages[i].uidl = &quot;UIDL&quot; + gUIDLCount++;</span>
<a href="#l6.86"></a><span id="l6.86">       this._totalMessageSize += this._messages[i].size;</span>
<a href="#l6.87"></a><span id="l6.87">     }</span>
<a href="#l6.88"></a><span id="l6.88">   },</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  getTotalMessages: function() {</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  getTotalMessages() {</span>
<a href="#l6.91"></a><span id="l6.91">     return this._messages.length;</span>
<a href="#l6.92"></a><span id="l6.92">   },</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  getTotalMessageSize: function() {</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  getTotalMessageSize() {</span>
<a href="#l6.95"></a><span id="l6.95">     return this._totalMessageSize;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  }</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  },</span>
<a href="#l6.98"></a><span id="l6.98"> };</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-//                              POP3 TEST SERVERS                            //</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+// POP3 TEST SERVERS</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+// -----------------</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108"> var kStateAuthNeeded = 1; // Not authenticated yet, need username and password</span>
<a href="#l6.109"></a><span id="l6.109"> var kStateAuthPASS = 2; // got command USER, expecting command PASS</span>
<a href="#l6.110"></a><span id="l6.110"> var kStateTransaction = 3; // Authenticated, can fetch and delete mail</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112"> /**</span>
<a href="#l6.113"></a><span id="l6.113">  * This handler implements the bare minimum required by RFC 1939.</span>
<a href="#l6.114"></a><span id="l6.114">  * If dropOnAuthFailure is set, the server will drop the connection</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineat">@@ -131,206 +127,207 @@ function POP3_RFC1939_handler(daemon) {</span>
<a href="#l6.116"></a><span id="l6.116">   this.dropOnAuthFailure = false;</span>
<a href="#l6.117"></a><span id="l6.117">   this._multiline = false;</span>
<a href="#l6.118"></a><span id="l6.118">   this.resetTest();</span>
<a href="#l6.119"></a><span id="l6.119"> }</span>
<a href="#l6.120"></a><span id="l6.120"> POP3_RFC1939_handler.prototype = {</span>
<a href="#l6.121"></a><span id="l6.121">   kUsername: &quot;fred&quot;,</span>
<a href="#l6.122"></a><span id="l6.122">   kPassword: &quot;wilma&quot;,</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  resetTest : function() {</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  resetTest() {</span>
<a href="#l6.126"></a><span id="l6.126">     this._state = kStateAuthNeeded;</span>
<a href="#l6.127"></a><span id="l6.127">   },</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-  USER: function (args) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+  USER(args) {</span>
<a href="#l6.131"></a><span id="l6.131">     if (this._state != kStateAuthNeeded)</span>
<a href="#l6.132"></a><span id="l6.132">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.133"></a><span id="l6.133"> </span>
<a href="#l6.134"></a><span id="l6.134">     if (args == this.kUsername) {</span>
<a href="#l6.135"></a><span id="l6.135">       this._state = kStateAuthPASS;</span>
<a href="#l6.136"></a><span id="l6.136">       return &quot;+OK user recognized&quot;;</span>
<a href="#l6.137"></a><span id="l6.137">     }</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139">     return &quot;-ERR sorry, no such mailbox&quot;;</span>
<a href="#l6.140"></a><span id="l6.140">   },</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-  PASS: function (args) {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  PASS(args) {</span>
<a href="#l6.143"></a><span id="l6.143">     if (this._state != kStateAuthPASS)</span>
<a href="#l6.144"></a><span id="l6.144">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146">     if (args == this.kPassword) {</span>
<a href="#l6.147"></a><span id="l6.147">       this._state = kStateTransaction;</span>
<a href="#l6.148"></a><span id="l6.148">       return &quot;+OK maildrop locked and ready&quot;;</span>
<a href="#l6.149"></a><span id="l6.149">     }</span>
<a href="#l6.150"></a><span id="l6.150"> </span>
<a href="#l6.151"></a><span id="l6.151">     this._state = kStateAuthNeeded;</span>
<a href="#l6.152"></a><span id="l6.152">     if (this.dropOnAuthFailure)</span>
<a href="#l6.153"></a><span id="l6.153">       this.closing = true;</span>
<a href="#l6.154"></a><span id="l6.154">     return &quot;-ERR invalid password&quot;;</span>
<a href="#l6.155"></a><span id="l6.155">   },</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-  STAT: function (args) {</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+  STAT(args) {</span>
<a href="#l6.158"></a><span id="l6.158">     if (this._state != kStateTransaction)</span>
<a href="#l6.159"></a><span id="l6.159">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.160"></a><span id="l6.160"> </span>
<a href="#l6.161"></a><span id="l6.161">     return &quot;+OK &quot; + this._daemon.getTotalMessages() + &quot; &quot; +</span>
<a href="#l6.162"></a><span id="l6.162">            this._daemon.getTotalMessageSize();</span>
<a href="#l6.163"></a><span id="l6.163">   },</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  LIST: function (args) {</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  LIST(args) {</span>
<a href="#l6.166"></a><span id="l6.166">     if (this._state != kStateTransaction)</span>
<a href="#l6.167"></a><span id="l6.167">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.168"></a><span id="l6.168"> </span>
<a href="#l6.169"></a><span id="l6.169">     var result = &quot;+OK &quot; + this._daemon._messages.length + &quot; messages\r\n&quot;;</span>
<a href="#l6.170"></a><span id="l6.170">     for (var i = 0; i &lt; this._daemon._messages.length; ++i)</span>
<a href="#l6.171"></a><span id="l6.171">       result += (i + 1) + &quot; &quot; + this._daemon._messages[i].size + &quot;\r\n&quot;;</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173">     result += &quot;.&quot;;</span>
<a href="#l6.174"></a><span id="l6.174">     return result;</span>
<a href="#l6.175"></a><span id="l6.175">   },</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-  UIDL: function (args) {</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+  UIDL(args) {</span>
<a href="#l6.178"></a><span id="l6.178">     if (this._state != kStateTransaction)</span>
<a href="#l6.179"></a><span id="l6.179">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.180"></a><span id="l6.180">     let result = &quot;+OK\r\n&quot;;</span>
<a href="#l6.181"></a><span id="l6.181">     for (let i = 0; i &lt; this._daemon._messages.length; ++i)</span>
<a href="#l6.182"></a><span id="l6.182">       result += (i + 1) + &quot; &quot; + this._daemon._messages[i].uidl + &quot;\r\n&quot;;</span>
<a href="#l6.183"></a><span id="l6.183"> </span>
<a href="#l6.184"></a><span id="l6.184">     result += &quot;.&quot;;</span>
<a href="#l6.185"></a><span id="l6.185">     return result;</span>
<a href="#l6.186"></a><span id="l6.186">   },</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  RETR: function (args) {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  RETR(args) {</span>
<a href="#l6.189"></a><span id="l6.189">     if (this._state != kStateTransaction)</span>
<a href="#l6.190"></a><span id="l6.190">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192">     var result = &quot;+OK &quot; + this._daemon._messages[args - 1].size + &quot;\r\n&quot;;</span>
<a href="#l6.193"></a><span id="l6.193">     result += this._daemon._messages[args - 1].fileData;</span>
<a href="#l6.194"></a><span id="l6.194">     result += &quot;.&quot;;</span>
<a href="#l6.195"></a><span id="l6.195">     return result;</span>
<a href="#l6.196"></a><span id="l6.196">   },</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  DELE: function (args) {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+  DELE(args) {</span>
<a href="#l6.199"></a><span id="l6.199">     if (this._state != kStateTransaction)</span>
<a href="#l6.200"></a><span id="l6.200">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.201"></a><span id="l6.201">     return &quot;+OK&quot;;</span>
<a href="#l6.202"></a><span id="l6.202">   },</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-  NOOP: function (args) {</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  NOOP(args) {</span>
<a href="#l6.205"></a><span id="l6.205">     if (this._state != kStateTransaction)</span>
<a href="#l6.206"></a><span id="l6.206">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.207"></a><span id="l6.207">     return &quot;+OK&quot;;</span>
<a href="#l6.208"></a><span id="l6.208">   },</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-  RSET: function (args) {</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  RSET(args) {</span>
<a href="#l6.211"></a><span id="l6.211">     if (this._state != kStateTransaction)</span>
<a href="#l6.212"></a><span id="l6.212">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.213"></a><span id="l6.213">     this._state = kStateAuthNeeded;</span>
<a href="#l6.214"></a><span id="l6.214">     return &quot;+OK&quot;;</span>
<a href="#l6.215"></a><span id="l6.215">   },</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-  QUIT: function (args) {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+  QUIT(args) {</span>
<a href="#l6.218"></a><span id="l6.218">     // Let the client close the socket</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    //this.closing = true;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+    // this.closing = true;</span>
<a href="#l6.221"></a><span id="l6.221">     return &quot;+OK fakeserver signing off&quot;;</span>
<a href="#l6.222"></a><span id="l6.222">   },</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  onStartup: function () {</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+  onStartup() {</span>
<a href="#l6.225"></a><span id="l6.225">     this.closing = false;</span>
<a href="#l6.226"></a><span id="l6.226">     this._state = kStateAuthNeeded;</span>
<a href="#l6.227"></a><span id="l6.227">     return &quot;+OK Fake POP3 server ready&quot;;</span>
<a href="#l6.228"></a><span id="l6.228">   },</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-  onError: function (command, args) {</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+  onError(command, args) {</span>
<a href="#l6.231"></a><span id="l6.231">     return &quot;-ERR command &quot; + command + &quot; not implemented&quot;;</span>
<a href="#l6.232"></a><span id="l6.232">   },</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-  onServerFault: function (e) {</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+  onServerFault(e) {</span>
<a href="#l6.235"></a><span id="l6.235">     return &quot;-ERR internal server error: &quot; + e;</span>
<a href="#l6.236"></a><span id="l6.236">   },</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-  postCommand: function(reader) {</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+  postCommand(reader) {</span>
<a href="#l6.239"></a><span id="l6.239">     reader.setMultiline(this._multiline);</span>
<a href="#l6.240"></a><span id="l6.240">     if (this.closing)</span>
<a href="#l6.241"></a><span id="l6.241">       reader.closeSocket();</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-  }</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+  },</span>
<a href="#l6.244"></a><span id="l6.244"> };</span>
<a href="#l6.245"></a><span id="l6.245"> </span>
<a href="#l6.246"></a><span id="l6.246"> </span>
<a href="#l6.247"></a><span id="l6.247"> /**</span>
<a href="#l6.248"></a><span id="l6.248">  * This implements CAPA</span>
<a href="#l6.249"></a><span id="l6.249">  * @see RFC 2449</span>
<a href="#l6.250"></a><span id="l6.250">  *</span>
<a href="#l6.251"></a><span id="l6.251">  * Not yet implemented, but desired are: TOP, UIDL, ...</span>
<a href="#l6.252"></a><span id="l6.252">  */</span>
<a href="#l6.253"></a><span id="l6.253"> function POP3_RFC2449_handler(daemon) {</span>
<a href="#l6.254"></a><span id="l6.254">   POP3_RFC1939_handler.call(this, daemon);</span>
<a href="#l6.255"></a><span id="l6.255"> }</span>
<a href="#l6.256"></a><span id="l6.256"> POP3_RFC2449_handler.prototype = {</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-  __proto__ : POP3_RFC1939_handler.prototype, // inherit</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  __proto__: POP3_RFC1939_handler.prototype, // inherit</span>
<a href="#l6.259"></a><span id="l6.259"> </span>
<a href="#l6.260"></a><span id="l6.260">   kCapabilities: [&quot;UIDL&quot;], // the test may adapt this as necessary</span>
<a href="#l6.261"></a><span id="l6.261"> </span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-  CAPA: function (args) {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+  CAPA(args) {</span>
<a href="#l6.264"></a><span id="l6.264">     var capa = &quot;+OK List of our wanna-be capabilities follows:\r\n&quot;;</span>
<a href="#l6.265"></a><span id="l6.265">     for (var i = 0; i &lt; this.kCapabilities.length; i++)</span>
<a href="#l6.266"></a><span id="l6.266">       capa += this.kCapabilities[i] + &quot;\r\n&quot;;</span>
<a href="#l6.267"></a><span id="l6.267">     if (this.capaAdditions)</span>
<a href="#l6.268"></a><span id="l6.268">       capa += this.capaAdditions();</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-    capa += &quot;IMPLEMENTATION fakeserver\r\n&quot; + &quot;.&quot;;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+    capa += &quot;IMPLEMENTATION fakeserver\r\n.&quot;;</span>
<a href="#l6.271"></a><span id="l6.271">     return capa;</span>
<a href="#l6.272"></a><span id="l6.272">   },</span>
<a href="#l6.273"></a><span id="l6.273"> };</span>
<a href="#l6.274"></a><span id="l6.274"> </span>
<a href="#l6.275"></a><span id="l6.275"> </span>
<a href="#l6.276"></a><span id="l6.276"> /**</span>
<a href="#l6.277"></a><span id="l6.277">  * This implements the AUTH command, i.e. authentication using CRAM-MD5 etc.</span>
<a href="#l6.278"></a><span id="l6.278">  * @see RFC 5034</span>
<a href="#l6.279"></a><span id="l6.279">  * @author Ben Bucksch &lt;ben.bucksch beonex.com&gt; &lt;http://business.beonex.com&gt;</span>
<a href="#l6.280"></a><span id="l6.280">  */</span>
<a href="#l6.281"></a><span id="l6.281"> function POP3_RFC5034_handler(daemon) {</span>
<a href="#l6.282"></a><span id="l6.282">   POP3_RFC2449_handler.call(this, daemon);</span>
<a href="#l6.283"></a><span id="l6.283"> </span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-  this._kAuthSchemeStartFunction = {};</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-  this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.authCRAMStart;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-  this._kAuthSchemeStartFunction[&quot;PLAIN&quot;] = this.authPLAINStart;</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-  this._kAuthSchemeStartFunction[&quot;LOGIN&quot;] = this.authLOGINStart;</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+  this._kAuthSchemeStartFunction = {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    &quot;CRAM-MD5&quot;: this.authCRAMStart,</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    &quot;PLAIN&quot;: this.authPLAINStart,</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+    &quot;LOGIN&quot;: this.authLOGINStart,</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+  };</span>
<a href="#l6.293"></a><span id="l6.293"> }</span>
<a href="#l6.294"></a><span id="l6.294"> POP3_RFC5034_handler.prototype = {</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-  __proto__ : POP3_RFC2449_handler.prototype, // inherit</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+  __proto__: POP3_RFC2449_handler.prototype, // inherit</span>
<a href="#l6.297"></a><span id="l6.297"> </span>
<a href="#l6.298"></a><span id="l6.298">   kAuthSchemes: [ &quot;CRAM-MD5&quot;, &quot;PLAIN&quot;, &quot;LOGIN&quot; ], // the test may adapt this as necessary</span>
<a href="#l6.299"></a><span id="l6.299"> </span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-  _usedCRAMMD5Challenge : null, // not base64-encoded</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+  _usedCRAMMD5Challenge: null, // not base64-encoded</span>
<a href="#l6.302"></a><span id="l6.302"> </span>
<a href="#l6.303"></a><span id="l6.303">   // called by this.CAPA()</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-  capaAdditions : function() {</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+  capaAdditions() {</span>
<a href="#l6.306"></a><span id="l6.306">     var capa = &quot;&quot;;</span>
<a href="#l6.307"></a><span id="l6.307">     if (this.kAuthSchemes.length &gt; 0) {</span>
<a href="#l6.308"></a><span id="l6.308">       capa += &quot;SASL&quot;;</span>
<a href="#l6.309"></a><span id="l6.309">       for (var i = 0; i &lt; this.kAuthSchemes.length; i++)</span>
<a href="#l6.310"></a><span id="l6.310">         capa += &quot; &quot; + this.kAuthSchemes[i];</span>
<a href="#l6.311"></a><span id="l6.311">       capa += &quot;\r\n&quot;;</span>
<a href="#l6.312"></a><span id="l6.312">     }</span>
<a href="#l6.313"></a><span id="l6.313">     return capa;</span>
<a href="#l6.314"></a><span id="l6.314">   },</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-  AUTH: function (lineRest) {</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+  AUTH(lineRest) {</span>
<a href="#l6.317"></a><span id="l6.317">     // |lineRest| is a string containing the rest of line after &quot;AUTH &quot;</span>
<a href="#l6.318"></a><span id="l6.318">     if (this._state != kStateAuthNeeded)</span>
<a href="#l6.319"></a><span id="l6.319">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l6.320"></a><span id="l6.320"> </span>
<a href="#l6.321"></a><span id="l6.321">     // AUTH without arguments returns a list of supported schemes</span>
<a href="#l6.322"></a><span id="l6.322">     if (!lineRest) {</span>
<a href="#l6.323"></a><span id="l6.323">       var capa = &quot;+OK I like:\r\n&quot;;</span>
<a href="#l6.324"></a><span id="l6.324">       for (var i = 0; i &lt; this.kAuthSchemes.length; i++)</span>
<a href="#l6.325"></a><span id="l6.325">         capa += this.kAuthSchemes[i] + &quot;\r\n&quot;;</span>
<a href="#l6.326"></a><span id="l6.326">       capa += &quot;.\r\n&quot;;</span>
<a href="#l6.327"></a><span id="l6.327">       return capa;</span>
<a href="#l6.328"></a><span id="l6.328">     }</span>
<a href="#l6.329"></a><span id="l6.329"> </span>
<a href="#l6.330"></a><span id="l6.330">     var args = lineRest.split(&quot; &quot;);</span>
<a href="#l6.331"></a><span id="l6.331">     var scheme = args[0].toUpperCase();</span>
<a href="#l6.332"></a><span id="l6.332">     // |scheme| contained in |kAuthSchemes|?</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-    if (!this.kAuthSchemes.some(function (s) { return s == scheme; }))</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    if (!this.kAuthSchemes.some(function(s) { return s == scheme; }))</span>
<a href="#l6.335"></a><span id="l6.335">       return &quot;-ERR AUTH &quot; + scheme + &quot; not supported&quot;;</span>
<a href="#l6.336"></a><span id="l6.336"> </span>
<a href="#l6.337"></a><span id="l6.337">     var func = this._kAuthSchemeStartFunction[scheme];</span>
<a href="#l6.338"></a><span id="l6.338">     if (!func || typeof(func) != &quot;function&quot;)</span>
<a href="#l6.339"></a><span id="l6.339">       return &quot;-ERR I just pretended to implement AUTH &quot; + scheme + &quot;, but I don't&quot;;</span>
<a href="#l6.340"></a><span id="l6.340">     return func.call(this, &quot;1&quot; in args ? args[1] : undefined);</span>
<a href="#l6.341"></a><span id="l6.341">   },</span>
<a href="#l6.342"></a><span id="l6.342"> </span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-  onMultiline: function(line) {</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+  onMultiline(line) {</span>
<a href="#l6.345"></a><span id="l6.345">     if (this._nextAuthFunction) {</span>
<a href="#l6.346"></a><span id="l6.346">       var func = this._nextAuthFunction;</span>
<a href="#l6.347"></a><span id="l6.347">       this._multiline = false;</span>
<a href="#l6.348"></a><span id="l6.348">       this._nextAuthFunction = undefined;</span>
<a href="#l6.349"></a><span id="l6.349">       if (line == &quot;*&quot;) {</span>
<a href="#l6.350"></a><span id="l6.350">         return &quot;-ERR Okay, as you wish. Chicken&quot;;</span>
<a href="#l6.351"></a><span id="l6.351">       }</span>
<a href="#l6.352"></a><span id="l6.352">       if (!func || typeof(func) != &quot;function&quot;) {</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineat">@@ -342,92 +339,78 @@ POP3_RFC5034_handler.prototype = {</span>
<a href="#l6.354"></a><span id="l6.354">     }</span>
<a href="#l6.355"></a><span id="l6.355"> </span>
<a href="#l6.356"></a><span id="l6.356">     if (POP3_RFC2449_handler.prototype.onMultiline)</span>
<a href="#l6.357"></a><span id="l6.357">       return POP3_RFC2449_handler.prototype.onMultiline.call(this, line); // call parent</span>
<a href="#l6.358"></a><span id="l6.358">     return undefined;</span>
<a href="#l6.359"></a><span id="l6.359">   },</span>
<a href="#l6.360"></a><span id="l6.360"> </span>
<a href="#l6.361"></a><span id="l6.361"> </span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-  authPLAINStart : function (lineRest)</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-  {</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+  authPLAINStart(lineRest) {</span>
<a href="#l6.365"></a><span id="l6.365">     this._nextAuthFunction = this.authPLAINCred;</span>
<a href="#l6.366"></a><span id="l6.366">     this._multiline = true;</span>
<a href="#l6.367"></a><span id="l6.367"> </span>
<a href="#l6.368"></a><span id="l6.368">     return &quot;+&quot;;</span>
<a href="#l6.369"></a><span id="l6.369">   },</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-  authPLAINCred : function (line)</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-  {</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+  authPLAINCred(line) {</span>
<a href="#l6.373"></a><span id="l6.373">     var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l6.374"></a><span id="l6.374">     if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l6.375"></a><span id="l6.375">         req.password == this.kPassword) {</span>
<a href="#l6.376"></a><span id="l6.376">       this._state = kStateTransaction;</span>
<a href="#l6.377"></a><span id="l6.377">       return &quot;+OK Hello friend! Friends give friends good advice: Next time, use CRAM-MD5&quot;;</span>
<a href="#l6.378"></a><span id="l6.378">     }</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-    else {</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-      if (this.dropOnAuthFailure)</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-        this.closing = true;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-      return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-    }</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+    if (this.dropOnAuthFailure)</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+      this.closing = true;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+    return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l6.387"></a><span id="l6.387">   },</span>
<a href="#l6.388"></a><span id="l6.388"> </span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-  authCRAMStart : function (lineRest)</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-  {</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+  authCRAMStart(lineRest) {</span>
<a href="#l6.392"></a><span id="l6.392">     this._nextAuthFunction = this.authCRAMDigest;</span>
<a href="#l6.393"></a><span id="l6.393">     this._multiline = true;</span>
<a href="#l6.394"></a><span id="l6.394"> </span>
<a href="#l6.395"></a><span id="l6.395">     this._usedCRAMMD5Challenge = AuthCRAM.createChallenge(&quot;localhost&quot;);</span>
<a href="#l6.396"></a><span id="l6.396">     return &quot;+ &quot; + this._usedCRAMMD5Challenge;</span>
<a href="#l6.397"></a><span id="l6.397">   },</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-  authCRAMDigest : function (line)</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-  {</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+  authCRAMDigest(line) {</span>
<a href="#l6.401"></a><span id="l6.401">     var req = AuthCRAM.decodeLine(line);</span>
<a href="#l6.402"></a><span id="l6.402">     var expectedDigest = AuthCRAM.encodeCRAMMD5(</span>
<a href="#l6.403"></a><span id="l6.403">         this._usedCRAMMD5Challenge, this.kPassword);</span>
<a href="#l6.404"></a><span id="l6.404">     if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l6.405"></a><span id="l6.405">         req.digest == expectedDigest) {</span>
<a href="#l6.406"></a><span id="l6.406">       this._state = kStateTransaction;</span>
<a href="#l6.407"></a><span id="l6.407">       return &quot;+OK Hello friend!&quot;;</span>
<a href="#l6.408"></a><span id="l6.408">     }</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-    else {</span>
<a href="#l6.410"></a><span id="l6.410">       if (this.dropOnAuthFailure)</span>
<a href="#l6.411"></a><span id="l6.411">         this.closing = true;</span>
<a href="#l6.412"></a><span id="l6.412">       return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-    }</span>
<a href="#l6.414"></a><span id="l6.414">   },</span>
<a href="#l6.415"></a><span id="l6.415"> </span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-  authLOGINStart : function (lineRest)</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-  {</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+  authLOGINStart(lineRest) {</span>
<a href="#l6.419"></a><span id="l6.419">     this._nextAuthFunction = this.authLOGINUsername;</span>
<a href="#l6.420"></a><span id="l6.420">     this._multiline = true;</span>
<a href="#l6.421"></a><span id="l6.421"> </span>
<a href="#l6.422"></a><span id="l6.422">     return &quot;+ &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l6.423"></a><span id="l6.423">   },</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-  authLOGINUsername : function (line)</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-  {</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+  authLOGINUsername(line) {</span>
<a href="#l6.427"></a><span id="l6.427">     var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l6.428"></a><span id="l6.428">     if (req == this.kUsername)</span>
<a href="#l6.429"></a><span id="l6.429">       this._nextAuthFunction = this.authLOGINPassword;</span>
<a href="#l6.430"></a><span id="l6.430">     else // Don't return error yet, to not reveal valid usernames</span>
<a href="#l6.431"></a><span id="l6.431">       this._nextAuthFunction = this.authLOGINBadUsername;</span>
<a href="#l6.432"></a><span id="l6.432">     this._multiline = true;</span>
<a href="#l6.433"></a><span id="l6.433">     return &quot;+ &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l6.434"></a><span id="l6.434">   },</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-  authLOGINBadUsername : function (line)</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-  {</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+  authLOGINBadUsername(line) {</span>
<a href="#l6.438"></a><span id="l6.438">     if (this.dropOnAuthFailure)</span>
<a href="#l6.439"></a><span id="l6.439">       this.closing = true;</span>
<a href="#l6.440"></a><span id="l6.440">     return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l6.441"></a><span id="l6.441">   },</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-  authLOGINPassword : function (line)</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-  {</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+  authLOGINPassword(line) {</span>
<a href="#l6.445"></a><span id="l6.445">     var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l6.446"></a><span id="l6.446">     if (req == this.kPassword) {</span>
<a href="#l6.447"></a><span id="l6.447">       this._state = kStateTransaction;</span>
<a href="#l6.448"></a><span id="l6.448">       return &quot;+OK Hello friend! Where did you pull out this old auth scheme?&quot;;</span>
<a href="#l6.449"></a><span id="l6.449">     }</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-    else {</span>
<a href="#l6.451"></a><span id="l6.451">       if (this.dropOnAuthFailure)</span>
<a href="#l6.452"></a><span id="l6.452">         this.closing = true;</span>
<a href="#l6.453"></a><span id="l6.453">       return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-    }</span>
<a href="#l6.455"></a><span id="l6.455">   },</span>
<a href="#l6.456"></a><span id="l6.456"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/test/fakeserver/smtpd.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/test/fakeserver/smtpd.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,233 +1,218 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> // This file implements test SMTP servers</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> var EXPORTED_SYMBOLS = [</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-  'smtpDaemon',</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-  'SMTP_RFC2821_handler',</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+  &quot;smtpDaemon&quot;,</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+  &quot;SMTP_RFC2821_handler&quot;,</span>
<a href="#l7.12"></a><span id="l7.12"> ];</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> var {</span>
<a href="#l7.15"></a><span id="l7.15">   AuthPLAIN,</span>
<a href="#l7.16"></a><span id="l7.16">   AuthLOGIN,</span>
<a href="#l7.17"></a><span id="l7.17">   AuthCRAM,</span>
<a href="#l7.18"></a><span id="l7.18"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/auth.js&quot;);</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> function smtpDaemon(flags) {</span>
<a href="#l7.21"></a><span id="l7.21">   this._messages = {};</span>
<a href="#l7.22"></a><span id="l7.22"> }</span>
<a href="#l7.23"></a><span id="l7.23"> smtpDaemon.prototype = {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-}</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+};</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-//                              SMTP TEST SERVERS                            //</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+// SMTP TEST SERVERS</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+// -----------------</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34"> var kStateAuthNeeded = 0;</span>
<a href="#l7.35"></a><span id="l7.35"> var kStateAuthOptional = 2;</span>
<a href="#l7.36"></a><span id="l7.36"> var kStateAuthenticated = 3;</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> /**</span>
<a href="#l7.39"></a><span id="l7.39">  * This handler implements the bare minimum required by RFC 2821.</span>
<a href="#l7.40"></a><span id="l7.40">  * @see RFC 2821</span>
<a href="#l7.41"></a><span id="l7.41">  * If dropOnAuthFailure is set, the server will drop the connection</span>
<a href="#l7.42"></a><span id="l7.42">  * on authentication errors, to simulate servers that do the same.</span>
<a href="#l7.43"></a><span id="l7.43">  */</span>
<a href="#l7.44"></a><span id="l7.44"> function SMTP_RFC2821_handler(daemon) {</span>
<a href="#l7.45"></a><span id="l7.45">   this._daemon = daemon;</span>
<a href="#l7.46"></a><span id="l7.46">   this.closing = false;</span>
<a href="#l7.47"></a><span id="l7.47">   this.dropOnAuthFailure = false;</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  this._kAuthSchemeStartFunction = {};</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.authCRAMStart;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  this._kAuthSchemeStartFunction[&quot;PLAIN&quot;] = this.authPLAINStart;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  this._kAuthSchemeStartFunction[&quot;LOGIN&quot;] = this.authLOGINStart;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  this._kAuthSchemeStartFunction = {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    &quot;CRAM-MD5&quot;: this.authCRAMStart,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    &quot;PLAIN&quot;: this.authPLAINStart,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    &quot;LOGIN&quot;: this.authLOGINStart,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  };</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">   this.resetTest();</span>
<a href="#l7.60"></a><span id="l7.60"> }</span>
<a href="#l7.61"></a><span id="l7.61"> SMTP_RFC2821_handler.prototype = {</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  kAuthRequired : false,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  kUsername : &quot;testsmtp&quot;,</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  kPassword : &quot;smtptest&quot;,</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  kAuthSchemes : [ &quot;CRAM-MD5&quot;, &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  kCapabilities : [ &quot;8BITMIME&quot;, &quot;SIZE&quot; ],</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  _nextAuthFunction : undefined,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  kAuthRequired: false,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  kUsername: &quot;testsmtp&quot;,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  kPassword: &quot;smtptest&quot;,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  kAuthSchemes: [ &quot;CRAM-MD5&quot;, &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  kCapabilities: [ &quot;8BITMIME&quot;, &quot;SIZE&quot; ],</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  _nextAuthFunction: undefined,</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  resetTest : function() {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  resetTest() {</span>
<a href="#l7.77"></a><span id="l7.77">     this._state = this.kAuthRequired ? kStateAuthNeeded : kStateAuthOptional;</span>
<a href="#l7.78"></a><span id="l7.78">     this._nextAuthFunction = undefined;</span>
<a href="#l7.79"></a><span id="l7.79">     this._multiline = false;</span>
<a href="#l7.80"></a><span id="l7.80">     this.expectingData = false;</span>
<a href="#l7.81"></a><span id="l7.81">   },</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  EHLO: function (args) {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  EHLO(args) {</span>
<a href="#l7.84"></a><span id="l7.84">     var capa = &quot;250-fakeserver greets you&quot;;</span>
<a href="#l7.85"></a><span id="l7.85">     if (this.kCapabilities.length &gt; 0)</span>
<a href="#l7.86"></a><span id="l7.86">       capa += &quot;\n250-&quot; + this.kCapabilities.join(&quot;\n250-&quot;);</span>
<a href="#l7.87"></a><span id="l7.87">     if (this.kAuthSchemes.length &gt; 0)</span>
<a href="#l7.88"></a><span id="l7.88">       capa += &quot;\n250-AUTH &quot; + this.kAuthSchemes.join(&quot; &quot;);</span>
<a href="#l7.89"></a><span id="l7.89">     capa += &quot;\n250 HELP&quot;; // the odd one: no &quot;-&quot;, per RFC 2821</span>
<a href="#l7.90"></a><span id="l7.90">     return capa;</span>
<a href="#l7.91"></a><span id="l7.91">   },</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-  AUTH: function (lineRest) {</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  AUTH(lineRest) {</span>
<a href="#l7.94"></a><span id="l7.94">     if (this._state == kStateAuthenticated)</span>
<a href="#l7.95"></a><span id="l7.95">       return &quot;503 You're already authenticated&quot;;</span>
<a href="#l7.96"></a><span id="l7.96">     var args = lineRest.split(&quot; &quot;);</span>
<a href="#l7.97"></a><span id="l7.97">     var scheme = args[0].toUpperCase();</span>
<a href="#l7.98"></a><span id="l7.98">     // |scheme| contained in |kAuthSchemes|?</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-    if (!this.kAuthSchemes.some(function (s) { return s == scheme; }))</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+    if (!this.kAuthSchemes.some(function(s) { return s == scheme; }))</span>
<a href="#l7.101"></a><span id="l7.101">       return &quot;504 AUTH &quot; + scheme + &quot; not supported&quot;;</span>
<a href="#l7.102"></a><span id="l7.102">     var func = this._kAuthSchemeStartFunction[scheme];</span>
<a href="#l7.103"></a><span id="l7.103">     if (!func || typeof(func) != &quot;function&quot;)</span>
<a href="#l7.104"></a><span id="l7.104">       return &quot;504 I just pretended to implement AUTH &quot; + scheme + &quot;, but I don't&quot;;</span>
<a href="#l7.105"></a><span id="l7.105">     dump(&quot;Starting AUTH &quot; + scheme + &quot;\n&quot;);</span>
<a href="#l7.106"></a><span id="l7.106">     return func.call(this, ((args.length &gt; 1) ? args[1] : undefined));</span>
<a href="#l7.107"></a><span id="l7.107">   },</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  MAIL: function (args) {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  MAIL(args) {</span>
<a href="#l7.110"></a><span id="l7.110">     if (this._state == kStateAuthNeeded)</span>
<a href="#l7.111"></a><span id="l7.111">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l7.112"></a><span id="l7.112">     return &quot;250 ok&quot;;</span>
<a href="#l7.113"></a><span id="l7.113">   },</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  RCPT: function(args) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  RCPT(args) {</span>
<a href="#l7.116"></a><span id="l7.116">     if (this._state == kStateAuthNeeded)</span>
<a href="#l7.117"></a><span id="l7.117">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l7.118"></a><span id="l7.118">     return &quot;250 ok&quot;;</span>
<a href="#l7.119"></a><span id="l7.119">   },</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-  DATA: function(args) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  DATA(args) {</span>
<a href="#l7.122"></a><span id="l7.122">     if (this._state == kStateAuthNeeded)</span>
<a href="#l7.123"></a><span id="l7.123">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l7.124"></a><span id="l7.124">     this.expectingData = true;</span>
<a href="#l7.125"></a><span id="l7.125">     this._daemon.post = &quot;&quot;;</span>
<a href="#l7.126"></a><span id="l7.126">     return &quot;354 ok\n&quot;;</span>
<a href="#l7.127"></a><span id="l7.127">   },</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-  RSET: function (args) {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  RSET(args) {</span>
<a href="#l7.130"></a><span id="l7.130">     return &quot;250 ok\n&quot;;</span>
<a href="#l7.131"></a><span id="l7.131">   },</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  VRFY: function (args) {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  VRFY(args) {</span>
<a href="#l7.134"></a><span id="l7.134">     if (this._state == kStateAuthNeeded)</span>
<a href="#l7.135"></a><span id="l7.135">       return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l7.136"></a><span id="l7.136">     return &quot;250 ok\n&quot;;</span>
<a href="#l7.137"></a><span id="l7.137">   },</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  EXPN: function (args) {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+  EXPN(args) {</span>
<a href="#l7.140"></a><span id="l7.140">     return &quot;250 ok\n&quot;;</span>
<a href="#l7.141"></a><span id="l7.141">   },</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  HELP: function (args) {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  HELP(args) {</span>
<a href="#l7.144"></a><span id="l7.144">     return &quot;211 ok\n&quot;;</span>
<a href="#l7.145"></a><span id="l7.145">   },</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  NOOP: function (args) {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  NOOP(args) {</span>
<a href="#l7.148"></a><span id="l7.148">     return &quot;250 ok\n&quot;;</span>
<a href="#l7.149"></a><span id="l7.149">   },</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  QUIT: function (args) {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  QUIT(args) {</span>
<a href="#l7.152"></a><span id="l7.152">     this.closing = true;</span>
<a href="#l7.153"></a><span id="l7.153">     return &quot;221 done&quot;;</span>
<a href="#l7.154"></a><span id="l7.154">   },</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  onStartup: function () {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  onStartup() {</span>
<a href="#l7.157"></a><span id="l7.157">     this.closing = false;</span>
<a href="#l7.158"></a><span id="l7.158">     return &quot;220 ok&quot;;</span>
<a href="#l7.159"></a><span id="l7.159">   },</span>
<a href="#l7.160"></a><span id="l7.160"> </span>
<a href="#l7.161"></a><span id="l7.161">   /**</span>
<a href="#l7.162"></a><span id="l7.162">    * AUTH implementations</span>
<a href="#l7.163"></a><span id="l7.163">    * @see RFC 4954</span>
<a href="#l7.164"></a><span id="l7.164">    */</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  authPLAINStart : function (lineRest)</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-  {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  authPLAINStart(lineRest) {</span>
<a href="#l7.168"></a><span id="l7.168">     if (lineRest) // all in one command, called initial client response, see RFC 4954</span>
<a href="#l7.169"></a><span id="l7.169">       return this.authPLAINCred(lineRest);</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171">     this._nextAuthFunction = this.authPLAINCred;</span>
<a href="#l7.172"></a><span id="l7.172">     this._multiline = true;</span>
<a href="#l7.173"></a><span id="l7.173"> </span>
<a href="#l7.174"></a><span id="l7.174">     return &quot;334 &quot;;</span>
<a href="#l7.175"></a><span id="l7.175">   },</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-  authPLAINCred : function (line)</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-  {</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+  authPLAINCred(line) {</span>
<a href="#l7.179"></a><span id="l7.179">     var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l7.180"></a><span id="l7.180">     if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l7.181"></a><span id="l7.181">         req.password == this.kPassword) {</span>
<a href="#l7.182"></a><span id="l7.182">       this._state = kStateAuthenticated;</span>
<a href="#l7.183"></a><span id="l7.183">       return &quot;235 2.7.0 Hello friend! Friends give friends good advice: Next time, use CRAM-MD5&quot;;</span>
<a href="#l7.184"></a><span id="l7.184">     }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-    else {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-      if (this.dropOnAuthFailure)</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-        this.closing = true;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-      return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-    }</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+    if (this.dropOnAuthFailure)</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+      this.closing = true;</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+    return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.193"></a><span id="l7.193">   },</span>
<a href="#l7.194"></a><span id="l7.194"> </span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  authCRAMStart : function (lineRest)</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  {</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  authCRAMStart(lineRest) {</span>
<a href="#l7.198"></a><span id="l7.198">     this._nextAuthFunction = this.authCRAMDigest;</span>
<a href="#l7.199"></a><span id="l7.199">     this._multiline = true;</span>
<a href="#l7.200"></a><span id="l7.200"> </span>
<a href="#l7.201"></a><span id="l7.201">     this._usedCRAMMD5Challenge = AuthCRAM.createChallenge(&quot;localhost&quot;);</span>
<a href="#l7.202"></a><span id="l7.202">     return &quot;334 &quot; + this._usedCRAMMD5Challenge;</span>
<a href="#l7.203"></a><span id="l7.203">   },</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-  authCRAMDigest : function (line)</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-  {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  authCRAMDigest(line) {</span>
<a href="#l7.207"></a><span id="l7.207">     var req = AuthCRAM.decodeLine(line);</span>
<a href="#l7.208"></a><span id="l7.208">     var expectedDigest = AuthCRAM.encodeCRAMMD5(</span>
<a href="#l7.209"></a><span id="l7.209">         this._usedCRAMMD5Challenge, this.kPassword);</span>
<a href="#l7.210"></a><span id="l7.210">     if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l7.211"></a><span id="l7.211">         req.digest == expectedDigest) {</span>
<a href="#l7.212"></a><span id="l7.212">       this._state = kStateAuthenticated;</span>
<a href="#l7.213"></a><span id="l7.213">       return &quot;235 2.7.0 Hello friend!&quot;;</span>
<a href="#l7.214"></a><span id="l7.214">     }</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    else {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-      if (this.dropOnAuthFailure)</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-        this.closing = true;</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-      return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-    }</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+    if (this.dropOnAuthFailure)</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+      this.closing = true;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.223"></a><span id="l7.223">   },</span>
<a href="#l7.224"></a><span id="l7.224"> </span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-  authLOGINStart : function (lineRest)</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-  {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  authLOGINStart(lineRest) {</span>
<a href="#l7.228"></a><span id="l7.228">     this._nextAuthFunction = this.authLOGINUsername;</span>
<a href="#l7.229"></a><span id="l7.229">     this._multiline = true;</span>
<a href="#l7.230"></a><span id="l7.230"> </span>
<a href="#l7.231"></a><span id="l7.231">     return &quot;334 &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l7.232"></a><span id="l7.232">   },</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-  authLOGINUsername : function (line)</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-  {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  authLOGINUsername(line) {</span>
<a href="#l7.236"></a><span id="l7.236">     var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l7.237"></a><span id="l7.237">     if (req == this.kUsername)</span>
<a href="#l7.238"></a><span id="l7.238">       this._nextAuthFunction = this.authLOGINPassword;</span>
<a href="#l7.239"></a><span id="l7.239">     else // Don't return error yet, to not reveal valid usernames</span>
<a href="#l7.240"></a><span id="l7.240">       this._nextAuthFunction = this.authLOGINBadUsername;</span>
<a href="#l7.241"></a><span id="l7.241">     this._multiline = true;</span>
<a href="#l7.242"></a><span id="l7.242">     return &quot;334 &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l7.243"></a><span id="l7.243">   },</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-  authLOGINBadUsername : function (line)</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-  {</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+  authLOGINBadUsername(line) {</span>
<a href="#l7.247"></a><span id="l7.247">     if (this.dropOnAuthFailure)</span>
<a href="#l7.248"></a><span id="l7.248">       this.closing = true;</span>
<a href="#l7.249"></a><span id="l7.249">     return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.250"></a><span id="l7.250">   },</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-  authLOGINPassword : function (line)</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-  {</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+  authLOGINPassword(line) {</span>
<a href="#l7.254"></a><span id="l7.254">     var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l7.255"></a><span id="l7.255">     if (req == this.kPassword) {</span>
<a href="#l7.256"></a><span id="l7.256">       this._state = kStateAuthenticated;</span>
<a href="#l7.257"></a><span id="l7.257">       return &quot;235 2.7.0 Hello friend! Where did you pull out this old auth scheme?&quot;;</span>
<a href="#l7.258"></a><span id="l7.258">     }</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-    else {</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-      if (this.dropOnAuthFailure)</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-        this.closing = true;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-      return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-    }</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    if (this.dropOnAuthFailure)</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+      this.closing = true;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+    return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l7.267"></a><span id="l7.267">   },</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  onError: function (command, args) {</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  onError(command, args) {</span>
<a href="#l7.271"></a><span id="l7.271">     return &quot;500 Command &quot; + command + &quot; not recognized\n&quot;;</span>
<a href="#l7.272"></a><span id="l7.272">   },</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-  onServerFault: function (e) {</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+  onServerFault(e) {</span>
<a href="#l7.275"></a><span id="l7.275">     return &quot;451 Internal server error: &quot; + e;</span>
<a href="#l7.276"></a><span id="l7.276">   },</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-  onMultiline: function(line) {</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+  onMultiline(line) {</span>
<a href="#l7.279"></a><span id="l7.279">     if (this._nextAuthFunction) {</span>
<a href="#l7.280"></a><span id="l7.280">       var func = this._nextAuthFunction;</span>
<a href="#l7.281"></a><span id="l7.281">       this._multiline = false;</span>
<a href="#l7.282"></a><span id="l7.282">       this._nextAuthFunction = undefined;</span>
<a href="#l7.283"></a><span id="l7.283">       if (line == &quot;*&quot;) { // abort, per RFC 4954 and others</span>
<a href="#l7.284"></a><span id="l7.284">         return &quot;501 Okay, as you wish. Chicken&quot;;</span>
<a href="#l7.285"></a><span id="l7.285">       }</span>
<a href="#l7.286"></a><span id="l7.286">       if (!func || typeof(func) != &quot;function&quot;) {</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineat">@@ -241,21 +226,21 @@ SMTP_RFC2821_handler.prototype = {</span>
<a href="#l7.288"></a><span id="l7.288">       if (this.expectingData) {</span>
<a href="#l7.289"></a><span id="l7.289">         this.expectingData = false;</span>
<a href="#l7.290"></a><span id="l7.290">         return &quot;250 Wonderful article, your style is gorgeous!&quot;;</span>
<a href="#l7.291"></a><span id="l7.291">       }</span>
<a href="#l7.292"></a><span id="l7.292">       return &quot;503 Huch? How did you get here?&quot;;</span>
<a href="#l7.293"></a><span id="l7.293">     }</span>
<a href="#l7.294"></a><span id="l7.294"> </span>
<a href="#l7.295"></a><span id="l7.295">     if (this.expectingData) {</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-      if (line.startsWith('.'))</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+      if (line.startsWith(&quot;.&quot;))</span>
<a href="#l7.298"></a><span id="l7.298">         line = line.substring(1);</span>
<a href="#l7.299"></a><span id="l7.299">       // This uses CR LF to match with the specification</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-      this._daemon.post += line + '\r\n';</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+      this._daemon.post += line + &quot;\r\n&quot;;</span>
<a href="#l7.302"></a><span id="l7.302">     }</span>
<a href="#l7.303"></a><span id="l7.303">     return undefined;</span>
<a href="#l7.304"></a><span id="l7.304">   },</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-  postCommand: function(reader) {</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  postCommand(reader) {</span>
<a href="#l7.307"></a><span id="l7.307">     if (this.closing)</span>
<a href="#l7.308"></a><span id="l7.308">       reader.closeSocket();</span>
<a href="#l7.309"></a><span id="l7.309">     reader.setMultiline(this._multiline || this.expectingData);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-  }</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-}</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+  },</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+};</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

