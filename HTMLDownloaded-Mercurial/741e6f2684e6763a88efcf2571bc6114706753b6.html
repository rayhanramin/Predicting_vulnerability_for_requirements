<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15217:741e6f2684e6763a88efcf2571bc6114706753b6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 741e6f2684e6763a88efcf2571bc6114706753b6" />
<meta property="og:url" content="/comm-central/rev/741e6f2684e6763a88efcf2571bc6114706753b6" />
<meta property="og:description" content="Bug 955260 - Add an easy way to copy an account specific debug log, IRC protocol, r=florian." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 741e6f2684e6763a88efcf2571bc6114706753b6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/741e6f2684e6763a88efcf2571bc6114706753b6">shortlog</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/741e6f2684e6763a88efcf2571bc6114706753b6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6">files</a> |
changeset |
<a href="/comm-central/raw-rev/741e6f2684e6763a88efcf2571bc6114706753b6">raw</a>  | <a href="/comm-central/archive/741e6f2684e6763a88efcf2571bc6114706753b6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955260">Bug 955260</a> - Add an easy way to copy an account specific debug log, IRC protocol, r=florian.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 28 Nov 2012 01:35:16 +0100</td></tr>

<tr>
 <td>changeset 15217</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/741e6f2684e6763a88efcf2571bc6114706753b6">741e6f2684e6763a88efcf2571bc6114706753b6</a></td>
</tr>



<tr>
<td>parent 15216</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0bb47f36a1704aaefcfaa9b26deef97d5d8eba78">0bb47f36a1704aaefcfaa9b26deef97d5d8eba78</a>
</td>
</tr>

<tr>
<td>child 15218</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5dcdaeffaf9533e791cfbc230f1b54d1b86de5b8">5dcdaeffaf9533e791cfbc230f1b54d1b86de5b8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=741e6f2684e6763a88efcf2571bc6114706753b6">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955260">955260</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955260">Bug 955260</a> - Add an easy way to copy an account specific debug log, IRC protocol, r=florian.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircBase.jsm">chat/protocols/irc/ircBase.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircBase.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircBase.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircBase.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircBase.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircBase.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCAP.jsm">chat/protocols/irc/ircCAP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCAP.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCAP.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCAP.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCAP.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCAP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCTCP.jsm">chat/protocols/irc/ircCTCP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCTCP.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCTCP.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCTCP.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCTCP.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircCTCP.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircDCC.jsm">chat/protocols/irc/ircDCC.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircDCC.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircDCC.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircDCC.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircDCC.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircDCC.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircHandlers.jsm">chat/protocols/irc/ircHandlers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircHandlers.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircHandlers.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircHandlers.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircHandlers.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircHandlers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircISUPPORT.jsm">chat/protocols/irc/ircISUPPORT.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircISUPPORT.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircISUPPORT.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircISUPPORT.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircISUPPORT.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircISUPPORT.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircSASL.jsm">chat/protocols/irc/ircSASL.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircSASL.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircSASL.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircSASL.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircSASL.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircSASL.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircServices.jsm">chat/protocols/irc/ircServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircServices.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircServices.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircServices.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircServices.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircUtils.jsm">chat/protocols/irc/ircUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircUtils.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircUtils.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircUtils.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircUtils.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircWatchMonitor.jsm">chat/protocols/irc/ircWatchMonitor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircWatchMonitor.jsm">file</a> |
<a href="/comm-central/annotate/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircWatchMonitor.jsm">annotate</a> |
<a href="/comm-central/diff/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircWatchMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircWatchMonitor.jsm">comparison</a> |
<a href="/comm-central/log/741e6f2684e6763a88efcf2571bc6114706753b6/chat/protocols/irc/ircWatchMonitor.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/protocols/irc/irc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -24,17 +24,17 @@ Cu.import(&quot;resource:///modules/socket.js</span>
<a href="#l1.4"></a><span id="l1.4">  *   host       The user's hostname, note that this can be undefined.</span>
<a href="#l1.5"></a><span id="l1.5">  *   source     A &quot;nicely&quot; formatted combination of user &amp; host, which is</span>
<a href="#l1.6"></a><span id="l1.6">  *              &lt;user&gt;@&lt;host&gt; or &lt;user&gt; if host is undefined.</span>
<a href="#l1.7"></a><span id="l1.7">  * Otherwise if it's from a server:</span>
<a href="#l1.8"></a><span id="l1.8">  *   servername This is the address of the server as a host (e.g.</span>
<a href="#l1.9"></a><span id="l1.9">  *              irc.mozilla.org) or an IPv4 address (e.g. 1.2.3.4) or IPv6</span>
<a href="#l1.10"></a><span id="l1.10">  *              address (e.g. 3ffe:1900:4545:3:200:f8ff:fe21:67cf).</span>
<a href="#l1.11"></a><span id="l1.11">  */</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-function ircMessage(aData) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+function ircMessage(aData, aAccount) {</span>
<a href="#l1.14"></a><span id="l1.14">   let message = {rawMessage: aData};</span>
<a href="#l1.15"></a><span id="l1.15">   let temp, prefix;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   // Splits the raw string into four parts (the second is required), the command</span>
<a href="#l1.18"></a><span id="l1.18">   // is required. A raw string looks like:</span>
<a href="#l1.19"></a><span id="l1.19">   //   [&quot;:&quot; &lt;prefix&gt; &quot; &quot;] &lt;command&gt; [&quot; &quot; &lt;parameter&gt;]* [&quot;:&quot; &lt;last parameter&gt;]</span>
<a href="#l1.20"></a><span id="l1.20">   //     &lt;prefix&gt;: :(&lt;server name&gt; | &lt;nickname&gt; [[&quot;!&quot; &lt;user&gt;] &quot;@&quot; &lt;host&gt;])</span>
<a href="#l1.21"></a><span id="l1.21">   //     &lt;command&gt;: /[^ ]+/</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -282,18 +282,18 @@ ircChannel.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">     if (this._account.normalize(aOldNick) == this._account.normalize(this.nick)) {</span>
<a href="#l1.24"></a><span id="l1.24">       // If this is the user's nick, change it.</span>
<a href="#l1.25"></a><span id="l1.25">       this.nick = aNewNick;</span>
<a href="#l1.26"></a><span id="l1.26">       // If the account was disconnected, it's OK the user is not a participant.</span>
<a href="#l1.27"></a><span id="l1.27">       if (!isParticipant)</span>
<a href="#l1.28"></a><span id="l1.28">         return;</span>
<a href="#l1.29"></a><span id="l1.29">     }</span>
<a href="#l1.30"></a><span id="l1.30">     else if (!isParticipant) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      ERROR(&quot;Trying to rename nick that doesn't exist! &quot; + aOldNick + &quot; to &quot; +</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-            aNewNick);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      this.ERROR(&quot;Trying to rename nick that doesn't exist! &quot; + aOldNick +</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+                 &quot; to &quot; + aNewNick);</span>
<a href="#l1.35"></a><span id="l1.35">       return;</span>
<a href="#l1.36"></a><span id="l1.36">     }</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">     // Get the original ircParticipant and then remove it.</span>
<a href="#l1.39"></a><span id="l1.39">     let participant = this.getParticipant(aOldNick);</span>
<a href="#l1.40"></a><span id="l1.40">     this.removeParticipant(aOldNick);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">     // Update the nickname and add it under the new nick.</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineat">@@ -330,31 +330,31 @@ ircChannel.prototype = {</span>
<a href="#l1.44"></a><span id="l1.44">     this._participants = {};</span>
<a href="#l1.45"></a><span id="l1.45">   },</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   setMode: function(aNewMode, aModeParams, aSetter) {</span>
<a href="#l1.48"></a><span id="l1.48">     const hostMaskExp = /^.+!.+@.+$/;</span>
<a href="#l1.49"></a><span id="l1.49">     function getNextParam() {</span>
<a href="#l1.50"></a><span id="l1.50">       // If there's no next parameter, throw a warning.</span>
<a href="#l1.51"></a><span id="l1.51">       if (!aModeParams.length) {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-        WARN(&quot;Mode parameter expected!&quot;);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        this.WARN(&quot;Mode parameter expected!&quot;);</span>
<a href="#l1.54"></a><span id="l1.54">         return undefined;</span>
<a href="#l1.55"></a><span id="l1.55">       }</span>
<a href="#l1.56"></a><span id="l1.56">       return aModeParams.pop();</span>
<a href="#l1.57"></a><span id="l1.57">     }</span>
<a href="#l1.58"></a><span id="l1.58">     function peekNextParam() {</span>
<a href="#l1.59"></a><span id="l1.59">       // Non-destructively gets the next param.</span>
<a href="#l1.60"></a><span id="l1.60">       if (!aModeParams.length)</span>
<a href="#l1.61"></a><span id="l1.61">         return undefined;</span>
<a href="#l1.62"></a><span id="l1.62">       return aModeParams.slice(-1)[0];</span>
<a href="#l1.63"></a><span id="l1.63">     }</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">     // Are modes being added or removed?</span>
<a href="#l1.66"></a><span id="l1.66">     if (aNewMode[0] != &quot;+&quot; &amp;&amp; aNewMode[0] != &quot;-&quot;) {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-      WARN(&quot;Invalid mode string: &quot; + aNewMode);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+      this.WARN(&quot;Invalid mode string: &quot; + aNewMode);</span>
<a href="#l1.69"></a><span id="l1.69">       return;</span>
<a href="#l1.70"></a><span id="l1.70">     }</span>
<a href="#l1.71"></a><span id="l1.71">     let addNewMode = aNewMode[0] == &quot;+&quot;;</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">     // Check each mode being added and update the user.</span>
<a href="#l1.74"></a><span id="l1.74">     let channelModes = [];</span>
<a href="#l1.75"></a><span id="l1.75">     let userModes = {};</span>
<a href="#l1.76"></a><span id="l1.76">     let msg;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineat">@@ -420,17 +420,17 @@ ircChannel.prototype = {</span>
<a href="#l1.78"></a><span id="l1.78">       }</span>
<a href="#l1.79"></a><span id="l1.79">       // TODO From RFC 2811: a, i, m, n, q, p, s, r, t, l, e, I.</span>
<a href="#l1.80"></a><span id="l1.80"> </span>
<a href="#l1.81"></a><span id="l1.81">       // Keep track of the channel modes in the order they were received.</span>
<a href="#l1.82"></a><span id="l1.82">       channelModes.unshift(aNewMode[i]);</span>
<a href="#l1.83"></a><span id="l1.83">     }</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85">     if (aModeParams.length)</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-      WARN(&quot;Unused mode parameters: &quot; + aModeParams.join(&quot;, &quot;));</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      this.WARN(&quot;Unused mode parameters: &quot; + aModeParams.join(&quot;, &quot;));</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89">     // Update the mode of each participant.</span>
<a href="#l1.90"></a><span id="l1.90">     for (let nick in userModes)</span>
<a href="#l1.91"></a><span id="l1.91">       this.getParticipant(nick).setMode(addNewMode, userModes[nick], aSetter);</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">     if (!channelModes.length)</span>
<a href="#l1.94"></a><span id="l1.94">       return;</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96" class="difflineat">@@ -580,47 +580,48 @@ ircSocket.prototype = {</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98">   _initCharsetConverter: function() {</span>
<a href="#l1.99"></a><span id="l1.99">     this._converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l1.100"></a><span id="l1.100">                         .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l1.101"></a><span id="l1.101">     try {</span>
<a href="#l1.102"></a><span id="l1.102">       this._converter.charset = this._account._encoding;</span>
<a href="#l1.103"></a><span id="l1.103">     } catch (e) {</span>
<a href="#l1.104"></a><span id="l1.104">       delete this._converter;</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-      ERROR(&quot;Failed to set character set to: &quot; + this._account._encoding + &quot; for &quot; +</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-            this._account.name + &quot;.&quot;);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+      this.ERROR(&quot;Failed to set character set to: &quot; + this._account._encoding +</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+                 &quot; for &quot; + this._account.name + &quot;.&quot;);</span>
<a href="#l1.109"></a><span id="l1.109">     }</span>
<a href="#l1.110"></a><span id="l1.110">   },</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">   // Implement Section 5 of RFC 2812.</span>
<a href="#l1.113"></a><span id="l1.113">   onDataReceived: function(aRawMessage) {</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-    DEBUG(aRawMessage);</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    this.DEBUG(aRawMessage);</span>
<a href="#l1.116"></a><span id="l1.116">     if (this._converter) {</span>
<a href="#l1.117"></a><span id="l1.117">       try {</span>
<a href="#l1.118"></a><span id="l1.118">         aRawMessage = this._converter.ConvertToUnicode(aRawMessage);</span>
<a href="#l1.119"></a><span id="l1.119">       } catch (e) {</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-        WARN(&quot;This message doesn't seem to be &quot; + this._account._encoding +</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-             &quot; encoded: &quot; + aRawMessage);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+        this.WARN(&quot;This message doesn't seem to be &quot; + this._account._encoding +</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+                  &quot; encoded: &quot; + aRawMessage);</span>
<a href="#l1.124"></a><span id="l1.124">         // Unfortunately, if the unicode converter failed once,</span>
<a href="#l1.125"></a><span id="l1.125">         // it will keep failing so we need to reinitialize it.</span>
<a href="#l1.126"></a><span id="l1.126">         this._initCharsetConverter();</span>
<a href="#l1.127"></a><span id="l1.127">       }</span>
<a href="#l1.128"></a><span id="l1.128">     }</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">     // Low level dequote: replace quote character \020 followed by 0, n, r or</span>
<a href="#l1.131"></a><span id="l1.131">     // \020 with a \0, \n, \r or \020, respectively. Any other character is</span>
<a href="#l1.132"></a><span id="l1.132">     // replaced with itself.</span>
<a href="#l1.133"></a><span id="l1.133">     const lowDequote = {&quot;0&quot;: &quot;\0&quot;, &quot;n&quot;: &quot;\n&quot;, &quot;r&quot;: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot;};</span>
<a href="#l1.134"></a><span id="l1.134">     aRawMessage = aRawMessage.replace(/\x10./g,</span>
<a href="#l1.135"></a><span id="l1.135">       function(aStr) lowDequote[aStr[1]] || aStr[1]);</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137">     try {</span>
<a href="#l1.138"></a><span id="l1.138">       // If nothing handled the message, throw a warning.</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-      if (!ircHandlers.handleMessage(this._account, new ircMessage(aRawMessage)))</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-        WARN(&quot;Unhandled IRC message: &quot; + aRawMessage);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+    if (!ircHandlers.handleMessage(this._account,</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+                                   new ircMessage(aRawMessage, this._account)))</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+      this.WARN(&quot;Unhandled IRC message: &quot; + aRawMessage);</span>
<a href="#l1.144"></a><span id="l1.144">     } catch (e) {</span>
<a href="#l1.145"></a><span id="l1.145">       // Catch the error, display it and hope the connection can continue with</span>
<a href="#l1.146"></a><span id="l1.146">       // this message in error. Errors are also caught inside of handleMessage,</span>
<a href="#l1.147"></a><span id="l1.147">       // but we expect to handle message parsing errors here.</span>
<a href="#l1.148"></a><span id="l1.148">       ERROR(e);</span>
<a href="#l1.149"></a><span id="l1.149">     }</span>
<a href="#l1.150"></a><span id="l1.150">   },</span>
<a href="#l1.151"></a><span id="l1.151">   onConnection: function() {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineat">@@ -628,36 +629,40 @@ ircSocket.prototype = {</span>
<a href="#l1.153"></a><span id="l1.153">   },</span>
<a href="#l1.154"></a><span id="l1.154"> </span>
<a href="#l1.155"></a><span id="l1.155">   // Throw errors if the socket has issues.</span>
<a href="#l1.156"></a><span id="l1.156">   onConnectionClosed: function () {</span>
<a href="#l1.157"></a><span id="l1.157">     if (!this._account.imAccount || this._account.disconnecting ||</span>
<a href="#l1.158"></a><span id="l1.158">         this._account.disconnected)</span>
<a href="#l1.159"></a><span id="l1.159">       return;</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-    ERROR(&quot;Connection closed by server.&quot;);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+    this.ERROR(&quot;Connection closed by server.&quot;);</span>
<a href="#l1.163"></a><span id="l1.163">     this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l1.164"></a><span id="l1.164">                                   _(&quot;connection.error.lost&quot;));</span>
<a href="#l1.165"></a><span id="l1.165">   },</span>
<a href="#l1.166"></a><span id="l1.166">   onConnectionReset: function () {</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-    ERROR(&quot;Connection reset.&quot;);</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+    this.ERROR(&quot;Connection reset.&quot;);</span>
<a href="#l1.169"></a><span id="l1.169">     this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l1.170"></a><span id="l1.170">                                   _(&quot;connection.error.lost&quot;));</span>
<a href="#l1.171"></a><span id="l1.171">   },</span>
<a href="#l1.172"></a><span id="l1.172">   onConnectionTimedOut: function() {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-    ERROR(&quot;Connection timed out.&quot;);</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+    this.ERROR(&quot;Connection timed out.&quot;);</span>
<a href="#l1.175"></a><span id="l1.175">     this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l1.176"></a><span id="l1.176">                                   _(&quot;connection.error.timeOut&quot;));</span>
<a href="#l1.177"></a><span id="l1.177">   },</span>
<a href="#l1.178"></a><span id="l1.178">   onBadCertificate: function(aNSSErrorMessage) {</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-    ERROR(&quot;bad certificate: &quot; + aNSSErrorMessage);</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+    this.ERROR(&quot;bad certificate: &quot; + aNSSErrorMessage);</span>
<a href="#l1.181"></a><span id="l1.181">     this._account.gotDisconnected(Ci.prplIAccount.ERROR_CERT_OTHER_ERROR,</span>
<a href="#l1.182"></a><span id="l1.182">                                   aNSSErrorMessage);</span>
<a href="#l1.183"></a><span id="l1.183">   },</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  log: LOG</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+  get DEBUG() this._account.DEBUG,</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+  get LOG() this._account.LOG,</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+  get WARN() this._account.WARN,</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  get ERROR() this._account.ERROR</span>
<a href="#l1.190"></a><span id="l1.190"> };</span>
<a href="#l1.191"></a><span id="l1.191"> </span>
<a href="#l1.192"></a><span id="l1.192"> function ircAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l1.193"></a><span id="l1.193">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l1.194"></a><span id="l1.194"> }</span>
<a href="#l1.195"></a><span id="l1.195"> ircAccountBuddy.prototype = {</span>
<a href="#l1.196"></a><span id="l1.196">   __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198" class="difflineat">@@ -759,17 +764,17 @@ ircAccount.prototype = {</span>
<a href="#l1.199"></a><span id="l1.199">   // Tell the server about status changes. IRC is only away or not away;</span>
<a href="#l1.200"></a><span id="l1.200">   // consider the away, idle and unavailable status type to be away.</span>
<a href="#l1.201"></a><span id="l1.201">   isAway: false,</span>
<a href="#l1.202"></a><span id="l1.202">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l1.203"></a><span id="l1.203">     if (aTopic != &quot;status-changed&quot;)</span>
<a href="#l1.204"></a><span id="l1.204">       return;</span>
<a href="#l1.205"></a><span id="l1.205"> </span>
<a href="#l1.206"></a><span id="l1.206">     let {statusType: type, statusText: text} = this.imAccount.statusInfo;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-    DEBUG(&quot;New status received:\ntype = &quot; + type + &quot;\ntext = &quot; + text);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    this.DEBUG(&quot;New status received:\ntype = &quot; + type + &quot;\ntext = &quot; + text);</span>
<a href="#l1.209"></a><span id="l1.209"> </span>
<a href="#l1.210"></a><span id="l1.210">     // Tell the server to mark us as away.</span>
<a href="#l1.211"></a><span id="l1.211">     if (type &lt; Ci.imIStatusInfo.STATUS_AVAILABLE) {</span>
<a href="#l1.212"></a><span id="l1.212">       // We have to have a string in order to set IRC as AWAY.</span>
<a href="#l1.213"></a><span id="l1.213">       if (!text) {</span>
<a href="#l1.214"></a><span id="l1.214">         // If no status is given, use the the default idle/away message.</span>
<a href="#l1.215"></a><span id="l1.215">         const IDLE_PREF_BRANCH = &quot;messenger.status.&quot;;</span>
<a href="#l1.216"></a><span id="l1.216">         const IDLE_PREF = &quot;defaultIdleAwayMessage&quot;;</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineat">@@ -1183,17 +1188,17 @@ ircAccount.prototype = {</span>
<a href="#l1.218"></a><span id="l1.218">   // Temporarily stores the prplIChatRoomFieldValues passed to joinChat for</span>
<a href="#l1.219"></a><span id="l1.219">   // each channel to enable later reconnections.</span>
<a href="#l1.220"></a><span id="l1.220">   _chatRoomFieldsList: {},</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222">   // aComponents implements prplIChatRoomFieldValues.</span>
<a href="#l1.223"></a><span id="l1.223">   joinChat: function(aComponents) {</span>
<a href="#l1.224"></a><span id="l1.224">     let channel = aComponents.getValue(&quot;channel&quot;);</span>
<a href="#l1.225"></a><span id="l1.225">     if (!channel) {</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-      ERROR(&quot;joinChat called without a channel name.&quot;);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+      this.ERROR(&quot;joinChat called without a channel name.&quot;);</span>
<a href="#l1.228"></a><span id="l1.228">       return;</span>
<a href="#l1.229"></a><span id="l1.229">     }</span>
<a href="#l1.230"></a><span id="l1.230">     let params = [channel];</span>
<a href="#l1.231"></a><span id="l1.231">     let key = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l1.232"></a><span id="l1.232">     if (key)</span>
<a href="#l1.233"></a><span id="l1.233">       params.push(key);</span>
<a href="#l1.234"></a><span id="l1.234">     let defaultName = key ? channel + &quot; &quot; + key : channel;</span>
<a href="#l1.235"></a><span id="l1.235">     this._chatRoomFieldsList[this.normalize(channel)] =</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineat">@@ -1235,33 +1240,33 @@ ircAccount.prototype = {</span>
<a href="#l1.237"></a><span id="l1.237">   removeConversation: function(aConversationName) {</span>
<a href="#l1.238"></a><span id="l1.238">     if (this.hasConversation(aConversationName))</span>
<a href="#l1.239"></a><span id="l1.239">       delete this._conversations[this.normalize(aConversationName)];</span>
<a href="#l1.240"></a><span id="l1.240">   },</span>
<a href="#l1.241"></a><span id="l1.241"> </span>
<a href="#l1.242"></a><span id="l1.242">   // This builds the message string that will be sent to the server.</span>
<a href="#l1.243"></a><span id="l1.243">   buildMessage: function(aCommand, aParams) {</span>
<a href="#l1.244"></a><span id="l1.244">     if (!aCommand) {</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-      ERROR(&quot;IRC messages must have a command.&quot;);</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+      this.ERROR(&quot;IRC messages must have a command.&quot;);</span>
<a href="#l1.247"></a><span id="l1.247">       return null;</span>
<a href="#l1.248"></a><span id="l1.248">     }</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250">     // Ensure a command is only characters or numbers.</span>
<a href="#l1.251"></a><span id="l1.251">     if (!/^[A-Z0-9]+$/i.test(aCommand)) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-      ERROR(&quot;IRC command invalid: &quot; + aCommand);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      this.ERROR(&quot;IRC command invalid: &quot; + aCommand);</span>
<a href="#l1.254"></a><span id="l1.254">       return null;</span>
<a href="#l1.255"></a><span id="l1.255">     }</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257">     let message = aCommand;</span>
<a href="#l1.258"></a><span id="l1.258">     // If aParams is empty, then use an empty array. If aParams is not an array,</span>
<a href="#l1.259"></a><span id="l1.259">     // consider it to be a single parameter and put it into an array.</span>
<a href="#l1.260"></a><span id="l1.260">     let params = !aParams ? [] : Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l1.261"></a><span id="l1.261">     if (params.length) {</span>
<a href="#l1.262"></a><span id="l1.262">       if (params.slice(0, -1).some(function(p) p.indexOf(&quot; &quot;) != -1)) {</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-        ERROR(&quot;IRC parameters cannot have spaces: &quot; + params.slice(0, -1));</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+        this.ERROR(&quot;IRC parameters cannot have spaces: &quot; + params.slice(0, -1));</span>
<a href="#l1.265"></a><span id="l1.265">         return null;</span>
<a href="#l1.266"></a><span id="l1.266">       }</span>
<a href="#l1.267"></a><span id="l1.267">       // Join the parameters with spaces. There are three cases in which the</span>
<a href="#l1.268"></a><span id="l1.268">       // last parameter (&quot;trailing&quot; in RFC 2812) must be prepended with a colon:</span>
<a href="#l1.269"></a><span id="l1.269">       //  1. If the last parameter contains a space.</span>
<a href="#l1.270"></a><span id="l1.270">       //  2. If the first character of the last parameter is a colon.</span>
<a href="#l1.271"></a><span id="l1.271">       //  3. If the last parameter is an empty string.</span>
<a href="#l1.272"></a><span id="l1.272">       let trailing = params.slice(-1)[0];</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineat">@@ -1291,29 +1296,29 @@ ircAccount.prototype = {</span>
<a href="#l1.274"></a><span id="l1.274">     if (!this._socket || !this._socket.isConnected) {</span>
<a href="#l1.275"></a><span id="l1.275">       this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l1.276"></a><span id="l1.276">                            _(&quot;connection.error.lost&quot;));</span>
<a href="#l1.277"></a><span id="l1.277">     }</span>
<a href="#l1.278"></a><span id="l1.278"> </span>
<a href="#l1.279"></a><span id="l1.279">     let length = this.countBytes(aMessage) + 2;</span>
<a href="#l1.280"></a><span id="l1.280">     if (length &gt; this.maxMessageLength) {</span>
<a href="#l1.281"></a><span id="l1.281">       // Log if the message is too long, but try to send it anyway.</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      WARN(&quot;Message length too long (&quot; + length + &quot; &gt; &quot; +</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-           this.maxMessageLength + &quot;\n&quot; + aMessage);</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+      this.WARN(&quot;Message length too long (&quot; + length + &quot; &gt; &quot; +</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+                this.maxMessageLength + &quot;\n&quot; + aMessage);</span>
<a href="#l1.286"></a><span id="l1.286">     }</span>
<a href="#l1.287"></a><span id="l1.287"> </span>
<a href="#l1.288"></a><span id="l1.288">     try {</span>
<a href="#l1.289"></a><span id="l1.289">       this._socket.sendString(aMessage, this._encoding, aLoggedData);</span>
<a href="#l1.290"></a><span id="l1.290">     } catch (e) {</span>
<a href="#l1.291"></a><span id="l1.291">       try {</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-        WARN(&quot;Failed to convert &quot; + aMessage + &quot; from Unicode to &quot; +</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-             this._encoding + &quot;.&quot;);</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+        this.WARN(&quot;Failed to convert &quot; + aMessage + &quot; from Unicode to &quot; +</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+                  this._encoding + &quot;.&quot;);</span>
<a href="#l1.296"></a><span id="l1.296">         this._socket.sendData(aMessage, aLoggedData);</span>
<a href="#l1.297"></a><span id="l1.297">       } catch(e) {</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-        ERROR(&quot;Socket error: &quot; + e);</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+        this.ERROR(&quot;Socket error: &quot; + e);</span>
<a href="#l1.300"></a><span id="l1.300">         this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l1.301"></a><span id="l1.301">                              _(&quot;connection.error.lost&quot;));</span>
<a href="#l1.302"></a><span id="l1.302">       }</span>
<a href="#l1.303"></a><span id="l1.303">     }</span>
<a href="#l1.304"></a><span id="l1.304">   },</span>
<a href="#l1.305"></a><span id="l1.305"> </span>
<a href="#l1.306"></a><span id="l1.306">   // CTCP messages are \001&lt;COMMAND&gt; [&lt;parameters&gt;]*\001.</span>
<a href="#l1.307"></a><span id="l1.307">   sendCTCPMessage: function(aCommand, aParams, aTarget, aIsNotice) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/irc/ircBase.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/irc/ircBase.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -139,17 +139,17 @@ function tryNewNick(aAccount, aMessage) </span>
<a href="#l2.4"></a><span id="l2.4">     // the user attempted to change to a version of the nick with a lower or</span>
<a href="#l2.5"></a><span id="l2.5">     // absent number suffix, and this failed.</span>
<a href="#l2.6"></a><span id="l2.6">     let msg = _(&quot;message.nick.fail&quot;, aAccount._nickname);</span>
<a href="#l2.7"></a><span id="l2.7">     for each (let conversation in aAccount._conversations)</span>
<a href="#l2.8"></a><span id="l2.8">       conversation.writeMessage(aAccount._nickname, msg, {system: true});</span>
<a href="#l2.9"></a><span id="l2.9">     return true;</span>
<a href="#l2.10"></a><span id="l2.10">   }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  LOG(aMessage.params[1] + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  aAccount.LOG(aMessage.params[1] + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l2.14"></a><span id="l2.14">   aAccount.sendMessage(&quot;NICK&quot;, newNick); // Nick message.</span>
<a href="#l2.15"></a><span id="l2.15">   return true;</span>
<a href="#l2.16"></a><span id="l2.16"> }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> // See RFCs 2811 &amp; 2812 (which obsoletes RFC 1459) for a description of these</span>
<a href="#l2.19"></a><span id="l2.19"> // commands.</span>
<a href="#l2.20"></a><span id="l2.20"> var ircBase = {</span>
<a href="#l2.21"></a><span id="l2.21">   // Parameters</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -160,17 +160,18 @@ var ircBase = {</span>
<a href="#l2.23"></a><span id="l2.23">   // The IRC commands that can be handled.</span>
<a href="#l2.24"></a><span id="l2.24">   commands: {</span>
<a href="#l2.25"></a><span id="l2.25">     &quot;ERROR&quot;: function(aMessage) {</span>
<a href="#l2.26"></a><span id="l2.26">       // ERROR &lt;error message&gt;</span>
<a href="#l2.27"></a><span id="l2.27">       // Client connection has been terminated.</span>
<a href="#l2.28"></a><span id="l2.28">       if (!this.disconnecting) {</span>
<a href="#l2.29"></a><span id="l2.29">         // We received an ERROR message when we weren't expecting it, this is</span>
<a href="#l2.30"></a><span id="l2.30">         // probably the server giving us a ping timeout.</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        ERROR(&quot;Received unexpected ERROR response:\n&quot; + aMessage.params[0]);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+        this.ERROR(&quot;Received unexpected ERROR response:\n&quot; +</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+                   aMessage.params[0]);</span>
<a href="#l2.34"></a><span id="l2.34">         this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l2.35"></a><span id="l2.35">                              _(&quot;connection.error.lost&quot;));</span>
<a href="#l2.36"></a><span id="l2.36">       }</span>
<a href="#l2.37"></a><span id="l2.37">       else {</span>
<a href="#l2.38"></a><span id="l2.38">         // We received an ERROR message when expecting it (i.e. we've sent a</span>
<a href="#l2.39"></a><span id="l2.39">         // QUIT command).</span>
<a href="#l2.40"></a><span id="l2.40">         clearTimeout(this._quitTimer);</span>
<a href="#l2.41"></a><span id="l2.41">         delete this._quitTimer;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineat">@@ -179,17 +180,18 @@ var ircBase = {</span>
<a href="#l2.43"></a><span id="l2.43">       }</span>
<a href="#l2.44"></a><span id="l2.44">       return true;</span>
<a href="#l2.45"></a><span id="l2.45">     },</span>
<a href="#l2.46"></a><span id="l2.46">     &quot;INVITE&quot;: function(aMessage) {</span>
<a href="#l2.47"></a><span id="l2.47">       // INVITE &lt;nickname&gt; &lt;channel&gt;</span>
<a href="#l2.48"></a><span id="l2.48">       if (Services.prefs.getIntPref(&quot;messenger.conversations.autoAcceptChatInvitations&quot;) == 1) {</span>
<a href="#l2.49"></a><span id="l2.49">         // Auto-accept the invite.</span>
<a href="#l2.50"></a><span id="l2.50">         this.joinChat(this.getChatRoomDefaultFieldValues(aMessage.params[1]));</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-        LOG(&quot;Received invite for &quot; + aMessage.params[1] + &quot;, auto-accepting.&quot;);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+        this.LOG(&quot;Received invite for &quot; + aMessage.params[1] +</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+                 &quot;, auto-accepting.&quot;);</span>
<a href="#l2.54"></a><span id="l2.54">       }</span>
<a href="#l2.55"></a><span id="l2.55">       // Otherwise, just notify the user.</span>
<a href="#l2.56"></a><span id="l2.56">       this.getConversation(aMessage.params[1])</span>
<a href="#l2.57"></a><span id="l2.57">           .writeMessage(aMessage.nickname,</span>
<a href="#l2.58"></a><span id="l2.58">                         _(&quot;message.inviteReceived&quot;, aMessage.nickname,</span>
<a href="#l2.59"></a><span id="l2.59">                           aMessage.params[1]), {system: true});</span>
<a href="#l2.60"></a><span id="l2.60">       return true;</span>
<a href="#l2.61"></a><span id="l2.61">     },</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineat">@@ -217,17 +219,18 @@ var ircBase = {</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">           // Ensure chatRoomFields information is available for reconnection.</span>
<a href="#l2.65"></a><span id="l2.65">           let nName = this.normalize(channelName);</span>
<a href="#l2.66"></a><span id="l2.66">           if (hasOwnProperty(this._chatRoomFieldsList, nName)) {</span>
<a href="#l2.67"></a><span id="l2.67">             conversation._chatRoomFields = this._chatRoomFieldsList[nName];</span>
<a href="#l2.68"></a><span id="l2.68">             delete this._chatRoomFieldsList[nName];</span>
<a href="#l2.69"></a><span id="l2.69">           }</span>
<a href="#l2.70"></a><span id="l2.70">           else {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-            WARN(&quot;Opening a MUC without storing its prplIChatRoomFieldValues first.&quot;);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+            this.WARN(&quot;Opening a MUC without storing its &quot; +</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+                      &quot;prplIChatRoomFieldValues first.&quot;);</span>
<a href="#l2.74"></a><span id="l2.74">             conversation._chatRoomFields =</span>
<a href="#l2.75"></a><span id="l2.75">               this.getChatRoomDefaultFieldValues(channelName);</span>
<a href="#l2.76"></a><span id="l2.76">           }</span>
<a href="#l2.77"></a><span id="l2.77">         }</span>
<a href="#l2.78"></a><span id="l2.78">         else {</span>
<a href="#l2.79"></a><span id="l2.79">           // Don't worry about adding ourself, RPL_NAMES takes care of that</span>
<a href="#l2.80"></a><span id="l2.80">           // case.</span>
<a href="#l2.81"></a><span id="l2.81">           conversation.getParticipant(aMessage.nickname, true);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineat">@@ -1012,17 +1015,17 @@ var ircBase = {</span>
<a href="#l2.83"></a><span id="l2.83">       return serverMessage(this, aMessage);</span>
<a href="#l2.84"></a><span id="l2.84">     },</span>
<a href="#l2.85"></a><span id="l2.85">     &quot;382&quot;: function(aMessage) { // RPL_REHASHING</span>
<a href="#l2.86"></a><span id="l2.86">       // &lt;config file&gt; :Rehashing</span>
<a href="#l2.87"></a><span id="l2.87">       return serverMessage(this, aMessage);</span>
<a href="#l2.88"></a><span id="l2.88">     },</span>
<a href="#l2.89"></a><span id="l2.89">     &quot;383&quot;: function(aMessage) { // RPL_YOURESERVICE</span>
<a href="#l2.90"></a><span id="l2.90">       // You are service &lt;servicename&gt;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      WARN(&quot;Received \&quot;You are a service\&quot; message.&quot;);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+      this.WARN(&quot;Received \&quot;You are a service\&quot; message.&quot;);</span>
<a href="#l2.93"></a><span id="l2.93">       return true;</span>
<a href="#l2.94"></a><span id="l2.94">     },</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96">     /*</span>
<a href="#l2.97"></a><span id="l2.97">      * Info</span>
<a href="#l2.98"></a><span id="l2.98">      */</span>
<a href="#l2.99"></a><span id="l2.99">     &quot;384&quot;: function(aMessage) { // RPL_MYPORTIS</span>
<a href="#l2.100"></a><span id="l2.100">       // Non-generic</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineat">@@ -1112,42 +1115,42 @@ var ircBase = {</span>
<a href="#l2.102"></a><span id="l2.102">     &quot;409&quot;: function(aMessage) { // ERR_NOORIGIN</span>
<a href="#l2.103"></a><span id="l2.103">       // :No origin specified</span>
<a href="#l2.104"></a><span id="l2.104">       // TODO failed PING/PONG message, this should never occur?</span>
<a href="#l2.105"></a><span id="l2.105">       return false;</span>
<a href="#l2.106"></a><span id="l2.106">     },</span>
<a href="#l2.107"></a><span id="l2.107">     &quot;411&quot;: function(aMessage) { // ERR_NORECIPIENT</span>
<a href="#l2.108"></a><span id="l2.108">       // :No recipient given (&lt;command&gt;)</span>
<a href="#l2.109"></a><span id="l2.109">       // If this happens a real error with the protocol occurred.</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-      ERROR(&quot;ERR_NORECIPIENT: No recipient given for PRIVMSG.&quot;);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+      this.ERROR(&quot;ERR_NORECIPIENT: No recipient given for PRIVMSG.&quot;);</span>
<a href="#l2.112"></a><span id="l2.112">       return true;</span>
<a href="#l2.113"></a><span id="l2.113">     },</span>
<a href="#l2.114"></a><span id="l2.114">     &quot;412&quot;: function(aMessage) { // ERR_NOTEXTTOSEND</span>
<a href="#l2.115"></a><span id="l2.115">       // :No text to send</span>
<a href="#l2.116"></a><span id="l2.116">       // If this happens a real error with the protocol occurred: we should</span>
<a href="#l2.117"></a><span id="l2.117">       // always block the user from sending empty messages.</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-      ERROR(&quot;ERR_NOTEXTTOSEND: No text to send for PRIVMSG.&quot;);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+      this.ERROR(&quot;ERR_NOTEXTTOSEND: No text to send for PRIVMSG.&quot;);</span>
<a href="#l2.120"></a><span id="l2.120">       return true;</span>
<a href="#l2.121"></a><span id="l2.121">     },</span>
<a href="#l2.122"></a><span id="l2.122">     &quot;413&quot;: function(aMessage) { // ERR_NOTOPLEVEL</span>
<a href="#l2.123"></a><span id="l2.123">       // &lt;mask&gt; :No toplevel domain specified</span>
<a href="#l2.124"></a><span id="l2.124">       // If this response is received, a real error occurred in the protocol.</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-      ERROR(&quot;ERR_NOTOPLEVEL: Toplevel domain not specified.&quot;);</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+      this.ERROR(&quot;ERR_NOTOPLEVEL: Toplevel domain not specified.&quot;);</span>
<a href="#l2.127"></a><span id="l2.127">       return true;</span>
<a href="#l2.128"></a><span id="l2.128">     },</span>
<a href="#l2.129"></a><span id="l2.129">     &quot;414&quot;: function(aMessage) { // ERR_WILDTOPLEVEL</span>
<a href="#l2.130"></a><span id="l2.130">       // &lt;mask&gt; :Wildcard in toplevel domain</span>
<a href="#l2.131"></a><span id="l2.131">       // If this response is received, a real error occurred in the protocol.</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-      ERROR(&quot;ERR_WILDTOPLEVEL: Wildcard toplevel domain specified.&quot;);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+      this.ERROR(&quot;ERR_WILDTOPLEVEL: Wildcard toplevel domain specified.&quot;);</span>
<a href="#l2.134"></a><span id="l2.134">       return true;</span>
<a href="#l2.135"></a><span id="l2.135">     },</span>
<a href="#l2.136"></a><span id="l2.136">     &quot;415&quot;: function(aMessage) { // ERR_BADMASK</span>
<a href="#l2.137"></a><span id="l2.137">       // &lt;mask&gt; :Bad Server/host mask</span>
<a href="#l2.138"></a><span id="l2.138">       // If this response is received, a real error occurred in the protocol.</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-      ERROR(&quot;ERR_BADMASK: Bad server/host mask specified.&quot;);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+      this.ERROR(&quot;ERR_BADMASK: Bad server/host mask specified.&quot;);</span>
<a href="#l2.141"></a><span id="l2.141">       return true;</span>
<a href="#l2.142"></a><span id="l2.142">     },</span>
<a href="#l2.143"></a><span id="l2.143">     &quot;421&quot;: function(aMessage) { // ERR_UNKNOWNCOMMAND</span>
<a href="#l2.144"></a><span id="l2.144">       // &lt;command&gt; :Unknown command</span>
<a href="#l2.145"></a><span id="l2.145">       // TODO This shouldn't occur.</span>
<a href="#l2.146"></a><span id="l2.146">       return false;</span>
<a href="#l2.147"></a><span id="l2.147">     },</span>
<a href="#l2.148"></a><span id="l2.148">     &quot;422&quot;: function(aMessage) { // ERR_NOMOTD</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineat">@@ -1171,18 +1174,18 @@ var ircBase = {</span>
<a href="#l2.150"></a><span id="l2.150">       return false;</span>
<a href="#l2.151"></a><span id="l2.151">     },</span>
<a href="#l2.152"></a><span id="l2.152">     &quot;432&quot;: function(aMessage) { // ERR_ERRONEUSNICKNAME</span>
<a href="#l2.153"></a><span id="l2.153">       // &lt;nick&gt; :Erroneous nickname</span>
<a href="#l2.154"></a><span id="l2.154">       let msg = _(&quot;error.erroneousNickname&quot;, aMessage.params[1]);</span>
<a href="#l2.155"></a><span id="l2.155">       serverErrorMessage(this, aMessage, msg);</span>
<a href="#l2.156"></a><span id="l2.156">       if (this._requestedNickname == this._accountNickname) {</span>
<a href="#l2.157"></a><span id="l2.157">         // The account has been set up with an illegal nickname.</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-        ERROR(&quot;Erroneous nickname &quot; + aMessage.params[1] + &quot;: &quot; +</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-              aMessage.params[2]);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+        this.ERROR(&quot;Erroneous nickname &quot; + aMessage.params[1] + &quot;: &quot; +</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+                   aMessage.params[2]);</span>
<a href="#l2.162"></a><span id="l2.162">         this.gotDisconnected(Ci.prplIAccount.ERROR_INVALID_USERNAME, msg);</span>
<a href="#l2.163"></a><span id="l2.163">       }</span>
<a href="#l2.164"></a><span id="l2.164">       else {</span>
<a href="#l2.165"></a><span id="l2.165">         // Reset original nickname to the account nickname in case of</span>
<a href="#l2.166"></a><span id="l2.166">         // later reconnections.</span>
<a href="#l2.167"></a><span id="l2.167">         this._requestedNickname = this._accountNickname;</span>
<a href="#l2.168"></a><span id="l2.168">       }</span>
<a href="#l2.169"></a><span id="l2.169">       return true;</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineat">@@ -1203,18 +1206,18 @@ var ircBase = {</span>
<a href="#l2.171"></a><span id="l2.171">     },</span>
<a href="#l2.172"></a><span id="l2.172">     &quot;441&quot;: function(aMessage) { // ERR_USERNOTINCHANNEL</span>
<a href="#l2.173"></a><span id="l2.173">       // &lt;nick&gt; &lt;channel&gt; :They aren't on that channel</span>
<a href="#l2.174"></a><span id="l2.174">       // TODO</span>
<a href="#l2.175"></a><span id="l2.175">       return false;</span>
<a href="#l2.176"></a><span id="l2.176">     },</span>
<a href="#l2.177"></a><span id="l2.177">     &quot;442&quot;: function(aMessage) { // ERR_NOTONCHANNEL</span>
<a href="#l2.178"></a><span id="l2.178">       // &lt;channel&gt; :You're not on that channel</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-      ERROR(&quot;A command affecting &quot; + aMessage.params[1] +</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-            &quot; failed because you aren't in that channel.&quot;);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+      this.ERROR(&quot;A command affecting &quot; + aMessage.params[1] +</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+                 &quot; failed because you aren't in that channel.&quot;);</span>
<a href="#l2.183"></a><span id="l2.183">       return true;</span>
<a href="#l2.184"></a><span id="l2.184">     },</span>
<a href="#l2.185"></a><span id="l2.185">     &quot;443&quot;: function(aMessage) { // ERR_USERONCHANNEL</span>
<a href="#l2.186"></a><span id="l2.186">       // &lt;user&gt; &lt;channel&gt; :is already on channel</span>
<a href="#l2.187"></a><span id="l2.187">       // TODO</span>
<a href="#l2.188"></a><span id="l2.188">       return false;</span>
<a href="#l2.189"></a><span id="l2.189">     },</span>
<a href="#l2.190"></a><span id="l2.190">     &quot;444&quot;: function(aMessage) { // ERR_NOLOGIN</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineat">@@ -1231,17 +1234,17 @@ var ircBase = {</span>
<a href="#l2.192"></a><span id="l2.192">       // :USERS has been disabled</span>
<a href="#l2.193"></a><span id="l2.193">       // TODO Disabled all buddy list etc.</span>
<a href="#l2.194"></a><span id="l2.194">       return false;</span>
<a href="#l2.195"></a><span id="l2.195">     },</span>
<a href="#l2.196"></a><span id="l2.196">     &quot;451&quot;: function(aMessage) { // ERR_NOTREGISTERED</span>
<a href="#l2.197"></a><span id="l2.197">       // :You have not registered</span>
<a href="#l2.198"></a><span id="l2.198">       // If the server doesn't understand CAP it might return this error.</span>
<a href="#l2.199"></a><span id="l2.199">       if (aMessage.params[0] == &quot;CAP&quot;) {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-        LOG(&quot;Server doesn't support CAP.&quot;);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+        this.LOG(&quot;Server doesn't support CAP.&quot;);</span>
<a href="#l2.202"></a><span id="l2.202">         return true;</span>
<a href="#l2.203"></a><span id="l2.203">       }</span>
<a href="#l2.204"></a><span id="l2.204">       // TODO</span>
<a href="#l2.205"></a><span id="l2.205">       return false;</span>
<a href="#l2.206"></a><span id="l2.206">     },</span>
<a href="#l2.207"></a><span id="l2.207">     &quot;461&quot;: function(aMessage) { // ERR_NEEDMOREPARAMS</span>
<a href="#l2.208"></a><span id="l2.208">       // &lt;command&gt; :Not enough parameters</span>
<a href="#l2.209"></a><span id="l2.209">       // TODO</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/irc/ircCAP.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/irc/ircCAP.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -73,13 +73,13 @@ var ircCAP = {</span>
<a href="#l3.4"></a><span id="l3.4">       // If no CAP handlers were added, just tell the server we're done.</span>
<a href="#l3.5"></a><span id="l3.5">       if (!this._caps.length)</span>
<a href="#l3.6"></a><span id="l3.6">         this.sendMessage(&quot;CAP&quot;, &quot;END&quot;);</span>
<a href="#l3.7"></a><span id="l3.7">       return handled;</span>
<a href="#l3.8"></a><span id="l3.8">     },</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">     &quot;410&quot;: function(aMessage) { // ERR_INVALIDCAPCMD</span>
<a href="#l3.11"></a><span id="l3.11">       // &lt;unrecognized subcommand&gt; :Invalid CAP subcommand</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      WARN(&quot;Invalid subcommand: &quot; + aMessage.params[1]);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      this.WARN(&quot;Invalid subcommand: &quot; + aMessage.params[1]);</span>
<a href="#l3.14"></a><span id="l3.14">       return true;</span>
<a href="#l3.15"></a><span id="l3.15">     }</span>
<a href="#l3.16"></a><span id="l3.16">   }</span>
<a href="#l3.17"></a><span id="l3.17"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -122,47 +122,47 @@ var ctcpBase = {</span>
<a href="#l4.4"></a><span id="l4.4">           .writeMessage(aMessage.nickname || aMessage.servername,</span>
<a href="#l4.5"></a><span id="l4.5">                         &quot;/me &quot; + aMessage.ctcp.param,</span>
<a href="#l4.6"></a><span id="l4.6">                         {incoming: true});</span>
<a href="#l4.7"></a><span id="l4.7">       return true;</span>
<a href="#l4.8"></a><span id="l4.8">     },</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">     // Used when an error needs to be replied with.</span>
<a href="#l4.11"></a><span id="l4.11">     &quot;ERRMSG&quot;: function(aMessage) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      WARN(aMessage.nickname + &quot; failed to handle CTCP message: &quot; +</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-           aMessage.ctcp.param);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+      this.WARN(aMessage.nickname + &quot; failed to handle CTCP message: &quot; +</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                aMessage.ctcp.param);</span>
<a href="#l4.16"></a><span id="l4.16">       return true;</span>
<a href="#l4.17"></a><span id="l4.17">     },</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">     // Returns the user's full name, and idle time.</span>
<a href="#l4.20"></a><span id="l4.20">     &quot;FINGER&quot;: function(aMessage) false,</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     // Dynamic master index of what a client knows.</span>
<a href="#l4.23"></a><span id="l4.23">     &quot;CLIENTINFO&quot;: function(aMessage) false,</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     // Used to measure the delay of the IRC network between clients.</span>
<a href="#l4.26"></a><span id="l4.26">     &quot;PING&quot;: function(aMessage) {</span>
<a href="#l4.27"></a><span id="l4.27">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l4.28"></a><span id="l4.28">         // PING timestamp</span>
<a href="#l4.29"></a><span id="l4.29">         // Received PING request, send PING response.</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-        LOG(&quot;Received PING request from &quot; + aMessage.nickname +</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-            &quot;. Sending PING response: \&quot;&quot; + aMessage.ctcp.param + &quot;\&quot;.&quot;);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+        this.LOG(&quot;Received PING request from &quot; + aMessage.nickname +</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+                 &quot;. Sending PING response: \&quot;&quot; + aMessage.ctcp.param + &quot;\&quot;.&quot;);</span>
<a href="#l4.34"></a><span id="l4.34">         this.sendCTCPMessage(&quot;PING&quot;, aMessage.ctcp.param, aMessage.nickname,</span>
<a href="#l4.35"></a><span id="l4.35">                               true);</span>
<a href="#l4.36"></a><span id="l4.36">       }</span>
<a href="#l4.37"></a><span id="l4.37">       else {</span>
<a href="#l4.38"></a><span id="l4.38">         // PING timestamp</span>
<a href="#l4.39"></a><span id="l4.39">         // Received PING response, display to the user.</span>
<a href="#l4.40"></a><span id="l4.40">         let sentTime = new Date(aMessage.ctcp.param);</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">         // The received timestamp is invalid</span>
<a href="#l4.43"></a><span id="l4.43">         if (isNaN(sentTime)) {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-          WARN(aMessage.nickname +</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-               &quot; returned an invalid timestamp from a CTCP PING: &quot; +</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-               aMessage.ctcp.param);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+          this.WARN(aMessage.nickname +</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+                    &quot; returned an invalid timestamp from a CTCP PING: &quot; +</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+                    aMessage.ctcp.param);</span>
<a href="#l4.50"></a><span id="l4.50">           return false;</span>
<a href="#l4.51"></a><span id="l4.51">         }</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">         // Find the delay in seconds.</span>
<a href="#l4.54"></a><span id="l4.54">         let delay = (Date.now() - sentTime) / 1000;</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">         let message = PluralForm.get(delay, _(&quot;ctcp.ping&quot;, aMessage.nickname))</span>
<a href="#l4.57"></a><span id="l4.57">                                 .replace(&quot;#2&quot;, delay);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineat">@@ -179,18 +179,18 @@ var ctcpBase = {</span>
<a href="#l4.59"></a><span id="l4.59">     &quot;SOURCE&quot;: function(aMessage) false,</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">     // Gets the local date and time from other clients.</span>
<a href="#l4.62"></a><span id="l4.62">     &quot;TIME&quot;: function(aMessage) {</span>
<a href="#l4.63"></a><span id="l4.63">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l4.64"></a><span id="l4.64">         // TIME</span>
<a href="#l4.65"></a><span id="l4.65">         // Received a TIME request, send a human readable response.</span>
<a href="#l4.66"></a><span id="l4.66">         let now = (new Date()).toString();</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-        LOG(&quot;Received TIME request from &quot; + aMessage.nickname +</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-            &quot;. Sending TIME response: \&quot;&quot; + now + &quot;\&quot;.&quot;);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+        this.LOG(&quot;Received TIME request from &quot; + aMessage.nickname +</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+                 &quot;. Sending TIME response: \&quot;&quot; + now + &quot;\&quot;.&quot;);</span>
<a href="#l4.71"></a><span id="l4.71">         this.sendCTCPMessage(&quot;TIME&quot;, &quot;:&quot; + now, aMessage.nickname, true);</span>
<a href="#l4.72"></a><span id="l4.72">       }</span>
<a href="#l4.73"></a><span id="l4.73">       else {</span>
<a href="#l4.74"></a><span id="l4.74">         // TIME :&lt;human-readable-time-string&gt;</span>
<a href="#l4.75"></a><span id="l4.75">         // Received a TIME reply, display it.</span>
<a href="#l4.76"></a><span id="l4.76">         // Remove the : prefix, if it exists and display the result.</span>
<a href="#l4.77"></a><span id="l4.77">         let time = aMessage.ctcp.param.slice(aMessage.ctcp.param[0] == &quot;:&quot;);</span>
<a href="#l4.78"></a><span id="l4.78">         this.getConversation(aMessage.nickname)</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineat">@@ -205,18 +205,18 @@ var ctcpBase = {</span>
<a href="#l4.80"></a><span id="l4.80">     &quot;USERINFO&quot;: function(aMessage) false,</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">     // The version and type of the client.</span>
<a href="#l4.83"></a><span id="l4.83">     &quot;VERSION&quot;: function(aMessage) {</span>
<a href="#l4.84"></a><span id="l4.84">       if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l4.85"></a><span id="l4.85">         // VERSION</span>
<a href="#l4.86"></a><span id="l4.86">         // Received VERSION request, send VERSION response.</span>
<a href="#l4.87"></a><span id="l4.87">         let version = Services.appinfo.name + &quot; &quot; + Services.appinfo.version;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-        LOG(&quot;Received VERSION request from &quot; + aMessage.nickname +</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-            &quot;. Sending VERSION response: \&quot;&quot; + version + &quot;\&quot;.&quot;);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+        this.LOG(&quot;Received VERSION request from &quot; + aMessage.nickname +</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+                 &quot;. Sending VERSION response: \&quot;&quot; + version + &quot;\&quot;.&quot;);</span>
<a href="#l4.92"></a><span id="l4.92">         this.sendCTCPMessage(&quot;VERSION&quot;, version, aMessage.nickname, true);</span>
<a href="#l4.93"></a><span id="l4.93">       }</span>
<a href="#l4.94"></a><span id="l4.94">       else if (aMessage.command == &quot;NOTICE&quot; &amp;&amp; aMessage.ctcp.param.length) {</span>
<a href="#l4.95"></a><span id="l4.95">         // VERSION #:#:#</span>
<a href="#l4.96"></a><span id="l4.96">         // Received VERSION response, display to the user.</span>
<a href="#l4.97"></a><span id="l4.97">         let response = _(&quot;ctcp.version&quot;, aMessage.nickname,</span>
<a href="#l4.98"></a><span id="l4.98">                          aMessage.ctcp.param);</span>
<a href="#l4.99"></a><span id="l4.99">         this.getConversation(aMessage.nickname)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,38 +15,39 @@ const Cu = Components.utils;</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l5.6"></a><span id="l5.6"> Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l5.7"></a><span id="l5.7"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> // Parse a CTCP message into a DCC message. A DCC message is a CTCP message of</span>
<a href="#l5.10"></a><span id="l5.10"> // the form:</span>
<a href="#l5.11"></a><span id="l5.11"> //   DCC &lt;type&gt; &lt;argument&gt; &lt;address&gt; &lt;port&gt; [&lt;size&gt;]</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-function DCCMessage(aMessage) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+function DCCMessage(aMessage, aAccount) {</span>
<a href="#l5.14"></a><span id="l5.14">   let message = aMessage;</span>
<a href="#l5.15"></a><span id="l5.15">   let params = message.ctcp.param.split(&quot; &quot;);</span>
<a href="#l5.16"></a><span id="l5.16">   if (params.length &lt; 4) {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    ERROR(&quot;Not enough DCC parameters:\n&quot; + JSON.stringify(aMessage));</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    aAccount.ERROR(&quot;Not enough DCC parameters:\n&quot; + JSON.stringify(aMessage));</span>
<a href="#l5.19"></a><span id="l5.19">     return null;</span>
<a href="#l5.20"></a><span id="l5.20">   }</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">   try {</span>
<a href="#l5.23"></a><span id="l5.23">     // Address, port and size should be treated as unsigned long, unsigned short</span>
<a href="#l5.24"></a><span id="l5.24">     // and unsigned long, respectively. The protocol is designed to handle</span>
<a href="#l5.25"></a><span id="l5.25">     // further arguements, if necessary.</span>
<a href="#l5.26"></a><span id="l5.26">     message.ctcp.dcc = {</span>
<a href="#l5.27"></a><span id="l5.27">       type: params[0],</span>
<a href="#l5.28"></a><span id="l5.28">       argument: params[1],</span>
<a href="#l5.29"></a><span id="l5.29">       address: new Number(params[2]),</span>
<a href="#l5.30"></a><span id="l5.30">       port: new Number(params[3]),</span>
<a href="#l5.31"></a><span id="l5.31">       size: params.length == 5 ? new Number(params[4]) : null,</span>
<a href="#l5.32"></a><span id="l5.32">       furtherArguments: params.length &gt; 5 ? params.slice(5) : []</span>
<a href="#l5.33"></a><span id="l5.33">     };</span>
<a href="#l5.34"></a><span id="l5.34">   } catch (e) {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    ERROR(&quot;Error parsing DCC parameters:\n&quot; + JSON.stringify(aMessage));</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    aAccount.ERROR(&quot;Error parsing DCC parameters:\n&quot; +</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+                   JSON.stringify(aMessage));</span>
<a href="#l5.38"></a><span id="l5.38">     return null;</span>
<a href="#l5.39"></a><span id="l5.39">   }</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">   return message;</span>
<a href="#l5.42"></a><span id="l5.42"> }</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44"> // This is the DCC handler for CTCP, it will call each DCC handler.</span>
<a href="#l5.45"></a><span id="l5.45"> var ctcpDCC = {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineat">@@ -58,12 +59,12 @@ var ctcpDCC = {</span>
<a href="#l5.47"></a><span id="l5.47">   commands: {</span>
<a href="#l5.48"></a><span id="l5.48">     // Handle a DCC message by parsing the message and executing any handlers.</span>
<a href="#l5.49"></a><span id="l5.49">     &quot;DCC&quot;: function(aMessage) {</span>
<a href="#l5.50"></a><span id="l5.50">       // If there are no DCC handlers, then don't parse the DCC message.</span>
<a href="#l5.51"></a><span id="l5.51">       if (!ircHandlers.hasDCCHandlers)</span>
<a href="#l5.52"></a><span id="l5.52">         return false;</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">       // Parse the message and attempt to handle it.</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-      return ircHandlers.handleDCCMessage(this, DCCMessage(aMessage));</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      return ircHandlers.handleDCCMessage(this, DCCMessage(aMessage, aAccount));</span>
<a href="#l5.57"></a><span id="l5.57">     }</span>
<a href="#l5.58"></a><span id="l5.58">   }</span>
<a href="#l5.59"></a><span id="l5.59"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -36,21 +36,23 @@ var ircHandlers = {</span>
<a href="#l6.4"></a><span id="l6.4">   _dccHandlers: [],</span>
<a href="#l6.5"></a><span id="l6.5">   // Object to hold the Services handlers, expects the same fields as</span>
<a href="#l6.6"></a><span id="l6.6">   // _ircHandlers.</span>
<a href="#l6.7"></a><span id="l6.7">   _servicesHandlers: [],</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   _registerHandler: function(aArray, aHandler) {</span>
<a href="#l6.10"></a><span id="l6.10">     // Protect ourselves from adding broken handlers.</span>
<a href="#l6.11"></a><span id="l6.11">     if (!(&quot;commands&quot; in aHandler)) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-      ERROR(&quot;IRC handlers must have a \&quot;commands\&quot; property: &quot; + aHandler.name);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      Cu.reportError(new Error(&quot;IRC handlers must have a \&quot;commands\&quot; &quot; +</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                               &quot;property: &quot; + aHandler.name));</span>
<a href="#l6.15"></a><span id="l6.15">       return false;</span>
<a href="#l6.16"></a><span id="l6.16">     }</span>
<a href="#l6.17"></a><span id="l6.17">     if (!(&quot;isEnabled&quot; in aHandler)) {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-      ERROR(&quot;IRC handlers must have a \&quot;isEnabled\&quot; property: &quot; + aHandler.name);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+      Cu.reportError(new Error(&quot;IRC handlers must have a \&quot;isEnabled\&quot; &quot; +</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+                               &quot;property: &quot; + aHandler.name));</span>
<a href="#l6.21"></a><span id="l6.21">       return false;</span>
<a href="#l6.22"></a><span id="l6.22">     }</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">     aArray.push(aHandler);</span>
<a href="#l6.25"></a><span id="l6.25">     aArray.sort(function(a, b) b.priority - a.priority);</span>
<a href="#l6.26"></a><span id="l6.26">     return true;</span>
<a href="#l6.27"></a><span id="l6.27">   },</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29" class="difflineat">@@ -94,24 +96,25 @@ var ircHandlers = {</span>
<a href="#l6.30"></a><span id="l6.30">     for each (let handler in aHandlers) {</span>
<a href="#l6.31"></a><span id="l6.31">       try {</span>
<a href="#l6.32"></a><span id="l6.32">         // Attempt to execute the command, by checking if the handler has the</span>
<a href="#l6.33"></a><span id="l6.33">         // command.</span>
<a href="#l6.34"></a><span id="l6.34">         // Parse the command with the JavaScript account object as &quot;this&quot;.</span>
<a href="#l6.35"></a><span id="l6.35">         if (handler.isEnabled.call(aAccount) &amp;&amp;</span>
<a href="#l6.36"></a><span id="l6.36">             hasOwnProperty(handler.commands, aCommand) &amp;&amp;</span>
<a href="#l6.37"></a><span id="l6.37">             handler.commands[aCommand].call(aAccount, aMessage)) {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-          DEBUG(JSON.stringify(aMessage));</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+          aAccount.DEBUG(JSON.stringify(aMessage));</span>
<a href="#l6.40"></a><span id="l6.40">           return true;</span>
<a href="#l6.41"></a><span id="l6.41">         }</span>
<a href="#l6.42"></a><span id="l6.42">       } catch (e) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-        // We want to catch an error here because one of our handlers are broken,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-        // if we don't catch the error, the whole IRC plug-in will die.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-        ERROR(&quot;Error running command &quot; + aCommand + &quot; with handler &quot; +</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-              handler.name + &quot;:\n&quot; + JSON.stringify(aMessage) + &quot;\n&quot; + e);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        // We want to catch an error here because one of our handlers are</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+        // broken, if we don't catch the error, the whole IRC plug-in will die.</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+        aAccount.ERROR(&quot;Error running command &quot; + aCommand + &quot; with handler &quot; +</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+                       handler.name + &quot;:\n&quot; + JSON.stringify(aMessage) + &quot;\n&quot; +</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+                       e);</span>
<a href="#l6.52"></a><span id="l6.52">       }</span>
<a href="#l6.53"></a><span id="l6.53">     }</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55">     return false;</span>
<a href="#l6.56"></a><span id="l6.56">   },</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">   handleMessage: function(aAccount, aMessage)</span>
<a href="#l6.59"></a><span id="l6.59">     this._handleMessage(this._ircHandlers, aAccount, aMessage,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -159,51 +159,51 @@ var isupportBase = {</span>
<a href="#l7.4"></a><span id="l7.4">       this.userPrefixToModeMap = {};</span>
<a href="#l7.5"></a><span id="l7.5">       // A null value specifier indicates that no prefixes are supported.</span>
<a href="#l7.6"></a><span id="l7.6">       if (!value.length)</span>
<a href="#l7.7"></a><span id="l7.7">         return true;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">       let matches = /\(([a-z]*)\)(.*)/i.exec(value);</span>
<a href="#l7.10"></a><span id="l7.10">       if (!matches) {</span>
<a href="#l7.11"></a><span id="l7.11">         // The pattern doesn't match.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        WARN(&quot;Invalid PREFIX value: &quot; + value);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        this.WARN(&quot;Invalid PREFIX value: &quot; + value);</span>
<a href="#l7.14"></a><span id="l7.14">         return false;</span>
<a href="#l7.15"></a><span id="l7.15">       }</span>
<a href="#l7.16"></a><span id="l7.16">       if (matches[1].length != matches[2].length) {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-        WARN(&quot;Invalid PREFIX value, does not provide one-to-one mapping:&quot; +</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-             value);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+        this.WARN(&quot;Invalid PREFIX value, does not provide one-to-one mapping:&quot; +</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+                  value);</span>
<a href="#l7.21"></a><span id="l7.21">         return false;</span>
<a href="#l7.22"></a><span id="l7.22">       }</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">       for (let i = 0; i &lt; matches[2].length; i++)</span>
<a href="#l7.25"></a><span id="l7.25">         this.userPrefixToModeMap[matches[2][i]] = matches[1][i];</span>
<a href="#l7.26"></a><span id="l7.26">       return true;</span>
<a href="#l7.27"></a><span id="l7.27">     },</span>
<a href="#l7.28"></a><span id="l7.28">     &quot;SAFELIST&quot;: function(aMessage) false,</span>
<a href="#l7.29"></a><span id="l7.29">     &quot;STATUSMSG&quot;: function(aMessage) false,</span>
<a href="#l7.30"></a><span id="l7.30">     &quot;STD&quot;: function(aMessage) {</span>
<a href="#l7.31"></a><span id="l7.31">       // This was never updated as the RFC was never formalized.</span>
<a href="#l7.32"></a><span id="l7.32">       if (aMessage.isupport.value != &quot;rfcnnnn&quot;)</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-        WARN(&quot;Unknown ISUPPORT numeric form: &quot; + aMessage.isupport.value);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+        this.WARN(&quot;Unknown ISUPPORT numeric form: &quot; + aMessage.isupport.value);</span>
<a href="#l7.35"></a><span id="l7.35">       return true;</span>
<a href="#l7.36"></a><span id="l7.36">     },</span>
<a href="#l7.37"></a><span id="l7.37">     &quot;TARGMAX&quot;: function(aMessage) {</span>
<a href="#l7.38"></a><span id="l7.38">       // TARGMAX=&lt;command&gt;:&lt;max targets&gt;[,&lt;command&gt;:&lt;max targets&gt;]*</span>
<a href="#l7.39"></a><span id="l7.39">       if (aMessage.isupport.useDefault) {</span>
<a href="#l7.40"></a><span id="l7.40">         this.maxTargets = 1;</span>
<a href="#l7.41"></a><span id="l7.41">         return true;</span>
<a href="#l7.42"></a><span id="l7.42">       }</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">       this.maxTargets = {};</span>
<a href="#l7.45"></a><span id="l7.45">       let commands = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l7.46"></a><span id="l7.46">       for (let i = 0; i &lt; commands.length; i++) {</span>
<a href="#l7.47"></a><span id="l7.47">         let [command, limitStr] = commands[i].split(&quot;=&quot;);</span>
<a href="#l7.48"></a><span id="l7.48">         let limit = limitStr ? new Number(limit) : Infinity;</span>
<a href="#l7.49"></a><span id="l7.49">         if (isNaN(limit)) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-          WARN(&quot;Invalid maximum number of targets: &quot; + limitStr);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+          this.WARN(&quot;Invalid maximum number of targets: &quot; + limitStr);</span>
<a href="#l7.52"></a><span id="l7.52">           continue;</span>
<a href="#l7.53"></a><span id="l7.53">         }</span>
<a href="#l7.54"></a><span id="l7.54">         this.maxTargets[command] = limit;</span>
<a href="#l7.55"></a><span id="l7.55">       }</span>
<a href="#l7.56"></a><span id="l7.56">       return true;</span>
<a href="#l7.57"></a><span id="l7.57">     },</span>
<a href="#l7.58"></a><span id="l7.58">     &quot;TOPICLEN&quot;: function(aMessage) {</span>
<a href="#l7.59"></a><span id="l7.59">       // TOPICLEN=&lt;number&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/protocols/irc/ircSASL.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/protocols/irc/ircSASL.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -19,18 +19,18 @@ var ircSASL = {</span>
<a href="#l8.4"></a><span id="l8.4">   priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l8.5"></a><span id="l8.5">   isEnabled: function() true,</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   commands: {</span>
<a href="#l8.8"></a><span id="l8.8">     &quot;AUTHENTICATE&quot;: function(aMessage) {</span>
<a href="#l8.9"></a><span id="l8.9">       // Expect an empty response, if something different is received abort.</span>
<a href="#l8.10"></a><span id="l8.10">       if (aMessage.params[0] != &quot;+&quot;) {</span>
<a href="#l8.11"></a><span id="l8.11">         this.sendMessage(&quot;AUTHENTICATE&quot;, &quot;*&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        WARN(&quot;Aborting SASL authentication, unexpected message received:\n&quot; +</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-             aMessage.rawMessage);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+        this.WARN(&quot;Aborting SASL authentication, unexpected message &quot; +</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                  &quot;received:\n&quot; + aMessage.rawMessage);</span>
<a href="#l8.16"></a><span id="l8.16">         return true;</span>
<a href="#l8.17"></a><span id="l8.17">       }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">       // An authentication identity, authorization identity and password are</span>
<a href="#l8.20"></a><span id="l8.20">       // used, separated by null.</span>
<a href="#l8.21"></a><span id="l8.21">       let data = [this._requestedNickname, this._requestedNickname,</span>
<a href="#l8.22"></a><span id="l8.22">                   this.imAccount.password].join(&quot;\0&quot;);</span>
<a href="#l8.23"></a><span id="l8.23">       // btoa for Unicode, see https://developer.mozilla.org/en-US/docs/DOM/window.btoa</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineat">@@ -38,51 +38,51 @@ var ircSASL = {</span>
<a href="#l8.25"></a><span id="l8.25">       this.sendMessage(&quot;AUTHENTICATE&quot;, base64Data,</span>
<a href="#l8.26"></a><span id="l8.26">                        &quot;AUTHENTICATE &lt;base64 encoded nick, user and password not logged&gt;&quot;);</span>
<a href="#l8.27"></a><span id="l8.27">       return true;</span>
<a href="#l8.28"></a><span id="l8.28">     },</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">     &quot;900&quot;: function(aMessage) {</span>
<a href="#l8.31"></a><span id="l8.31">       // Now logged in.</span>
<a href="#l8.32"></a><span id="l8.32">       this.isAuthenticated = true;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-      LOG(&quot;SASL authentication successful.&quot;);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+      this.LOG(&quot;SASL authentication successful.&quot;);</span>
<a href="#l8.35"></a><span id="l8.35">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l8.36"></a><span id="l8.36">       return true;</span>
<a href="#l8.37"></a><span id="l8.37">     },</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">     &quot;903&quot;: function(aMessage) {</span>
<a href="#l8.40"></a><span id="l8.40">       // Authentication was successful.</span>
<a href="#l8.41"></a><span id="l8.41">       return true;</span>
<a href="#l8.42"></a><span id="l8.42">     },</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">     &quot;904&quot;: function(aMessage) {</span>
<a href="#l8.45"></a><span id="l8.45">       // AUTHENTICATE message failed.</span>
<a href="#l8.46"></a><span id="l8.46">       // Only PLAIN is currently supported, so fail here.</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-      WARN(&quot;The server does not support SASL PLAIN authentication.&quot;);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+      this.WARN(&quot;The server does not support SASL PLAIN authentication.&quot;);</span>
<a href="#l8.49"></a><span id="l8.49">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l8.50"></a><span id="l8.50">       return true;</span>
<a href="#l8.51"></a><span id="l8.51">     },</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">     &quot;905&quot;: function(aMessage) {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-      ERROR(&quot;Authentication with SASL failed.&quot;);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      this.ERROR(&quot;Authentication with SASL failed.&quot;);</span>
<a href="#l8.56"></a><span id="l8.56">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l8.57"></a><span id="l8.57">       return true;</span>
<a href="#l8.58"></a><span id="l8.58">     },</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60">     &quot;906&quot;: function(aMessage) {</span>
<a href="#l8.61"></a><span id="l8.61">       // The client completed registration before SASL authentication completed.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-      ERROR(&quot;Registration completed before SASL authentication completed.&quot;);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+      this.ERROR(&quot;Registration completed before SASL authentication completed.&quot;);</span>
<a href="#l8.64"></a><span id="l8.64">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l8.65"></a><span id="l8.65">       return true;</span>
<a href="#l8.66"></a><span id="l8.66">     },</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">     &quot;907&quot;: function(aMessage) {</span>
<a href="#l8.69"></a><span id="l8.69">       // Response if client attempts to AUTHENTICATE after successful</span>
<a href="#l8.70"></a><span id="l8.70">       // authentication.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-      ERROR(&quot;Attempting SASL authentication twice?!&quot;);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+      this.ERROR(&quot;Attempting SASL authentication twice?!&quot;);</span>
<a href="#l8.73"></a><span id="l8.73">       this.removeCAP(&quot;sasl&quot;);</span>
<a href="#l8.74"></a><span id="l8.74">       return true;</span>
<a href="#l8.75"></a><span id="l8.75">     }</span>
<a href="#l8.76"></a><span id="l8.76">   }</span>
<a href="#l8.77"></a><span id="l8.77"> };</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79"> var capSASL = {</span>
<a href="#l8.80"></a><span id="l8.80">   name: &quot;SASL CAP&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/protocols/irc/ircServices.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/protocols/irc/ircServices.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -106,17 +106,17 @@ var ircServices = {</span>
<a href="#l9.4"></a><span id="l9.4">       // IDENTIFY failed, try NICKSERV IDENTIFY.</span>
<a href="#l9.5"></a><span id="l9.5">       if (aMessage.params[1] == &quot;IDENTIFY&quot; &amp;&amp; this.imAccount.password &amp;&amp;</span>
<a href="#l9.6"></a><span id="l9.6">           this.shouldAuthenticate &amp;&amp; !this.isAuthenticated) {</span>
<a href="#l9.7"></a><span id="l9.7">         this.sendMessage(&quot;NICKSERV&quot;, [&quot;IDENTIFY&quot;, this.imAccount.password],</span>
<a href="#l9.8"></a><span id="l9.8">                          &quot;NICKSERV IDENTIFY &lt;password not logged&gt;&quot;);</span>
<a href="#l9.9"></a><span id="l9.9">         return true;</span>
<a href="#l9.10"></a><span id="l9.10">       }</span>
<a href="#l9.11"></a><span id="l9.11">       if (aMessage.params[1] == &quot;NICKSERV&quot;) {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-        WARN(&quot;NICKSERV command does not exist.&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+        this.WARN(&quot;NICKSERV command does not exist.&quot;);</span>
<a href="#l9.14"></a><span id="l9.14">         return true;</span>
<a href="#l9.15"></a><span id="l9.15">       }</span>
<a href="#l9.16"></a><span id="l9.16">       return false;</span>
<a href="#l9.17"></a><span id="l9.17">     }</span>
<a href="#l9.18"></a><span id="l9.18">   }</span>
<a href="#l9.19"></a><span id="l9.19"> };</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> var servicesBase = {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -159,17 +159,17 @@ var servicesBase = {</span>
<a href="#l9.23"></a><span id="l9.23">         return false;</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">       // If we have a queue of messages, we're waiting for authentication.</span>
<a href="#l9.26"></a><span id="l9.26">       if (this.nickservMessageQueue) {</span>
<a href="#l9.27"></a><span id="l9.27">         if (text == &quot;Password accepted - you are now recognized.&quot; || // Anope.</span>
<a href="#l9.28"></a><span id="l9.28">             text.slice(0, 28) == &quot;You are now identified for \x02&quot;) { // Atheme.</span>
<a href="#l9.29"></a><span id="l9.29">           // Password successfully accepted by NickServ, don't display the</span>
<a href="#l9.30"></a><span id="l9.30">           // queued messages.</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-          LOG(&quot;Successfully authenticated with NickServ.&quot;);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+          this.LOG(&quot;Successfully authenticated with NickServ.&quot;);</span>
<a href="#l9.33"></a><span id="l9.33">           this.isAuthenticated = true;</span>
<a href="#l9.34"></a><span id="l9.34">           clearTimeout(this.nickservAuthTimeout);</span>
<a href="#l9.35"></a><span id="l9.35">           delete this.nickservAuthTimeout;</span>
<a href="#l9.36"></a><span id="l9.36">           delete this.nickservMessageQueue;</span>
<a href="#l9.37"></a><span id="l9.37">         }</span>
<a href="#l9.38"></a><span id="l9.38">         else {</span>
<a href="#l9.39"></a><span id="l9.39">           // Queue any other messages that occur during the timeout so they</span>
<a href="#l9.40"></a><span id="l9.40">           // appear in the proper order.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -177,17 +177,17 @@ var servicesBase = {</span>
<a href="#l9.42"></a><span id="l9.42">         }</span>
<a href="#l9.43"></a><span id="l9.43">         return true;</span>
<a href="#l9.44"></a><span id="l9.44">       }</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">       // NickServ wants us to identify.</span>
<a href="#l9.47"></a><span id="l9.47">       if (text == &quot;This nick is owned by someone else.  Please choose another.&quot; || // Anope.</span>
<a href="#l9.48"></a><span id="l9.48">           text == &quot;This nickname is registered and protected.  If it is your&quot; || // Anope (SECURE enabled).</span>
<a href="#l9.49"></a><span id="l9.49">           text == &quot;This nickname is registered. Please choose a different nickname, or identify via \x02/msg NickServ identify &lt;password&gt;\x02.&quot;) { // Atheme.</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-        LOG(&quot;Authentication requested by NickServ.&quot;);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+        this.LOG(&quot;Authentication requested by NickServ.&quot;);</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">         // Wait one second before showing the message to the user (giving the</span>
<a href="#l9.54"></a><span id="l9.54">         // the server time to process the log-in).</span>
<a href="#l9.55"></a><span id="l9.55">         this.nickservMessageQueue = [aMessage];</span>
<a href="#l9.56"></a><span id="l9.56">         this.nickservAuthTimeout = setTimeout(function() {</span>
<a href="#l9.57"></a><span id="l9.57">           this.isHandlingQueuedMessages = true;</span>
<a href="#l9.58"></a><span id="l9.58">           this.nickservMessageQueue.every(function(aMessage)</span>
<a href="#l9.59"></a><span id="l9.59">             ircHandlers.handleMessage(this, aMessage), this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,20 +1,18 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-const EXPORTED_SYMBOLS = [&quot;DEBUG&quot;, &quot;LOG&quot;, &quot;WARN&quot;, &quot;ERROR&quot;, &quot;_&quot;,</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-                          &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;_&quot;, &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;,</span>
<a href="#l10.11"></a><span id="l10.11">                           &quot;conversationErrorMessage&quot;];</span>
<a href="#l10.12"></a><span id="l10.12"> </span>
<a href="#l10.13"></a><span id="l10.13"> const {classes: Cc, interfaces: Ci} = Components;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> Components.utils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-initLogModule(&quot;irc&quot;, this);</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18"> XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l10.19"></a><span id="l10.19">   l10nHelper(&quot;chrome://chat/locale/irc.properties&quot;)</span>
<a href="#l10.20"></a><span id="l10.20"> );</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l10.23"></a><span id="l10.23">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l10.24"></a><span id="l10.24">   return function(aTXT) cs.scanTXT(aTXT, cs.kEntities);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/protocols/irc/ircWatchMonitor.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -45,18 +45,18 @@ function trackBuddyWatch(aNicks) {</span>
<a href="#l11.4"></a><span id="l11.4">   let nicks = (Array.isArray(aNicks) ? aNicks : [aNicks])</span>
<a href="#l11.5"></a><span id="l11.5">                     .map(function(aNick) &quot;+&quot; + aNick);</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">   if (!nicks.length)</span>
<a href="#l11.8"></a><span id="l11.8">     return;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   let newWatchLength = this.watchLength + nicks.length;</span>
<a href="#l11.11"></a><span id="l11.11">   if (newWatchLength &gt; this.maxWatchLength) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    WARN(&quot;Attempting to WATCH &quot; + newWatchLength + &quot; nicks; maximum size is &quot; +</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-         this.maxWatchLength + &quot;.&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    this.WARN(&quot;Attempting to WATCH &quot; + newWatchLength +</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+              &quot; nicks; maximum size is &quot; + this.maxWatchLength + &quot;.&quot;);</span>
<a href="#l11.16"></a><span id="l11.16">     // TODO We should trim the list and add the extra users to an ISON queue,</span>
<a href="#l11.17"></a><span id="l11.17">     // but that's not currently implemented, so just hope the server doesn't</span>
<a href="#l11.18"></a><span id="l11.18">     // enforce it's own limit.</span>
<a href="#l11.19"></a><span id="l11.19">   }</span>
<a href="#l11.20"></a><span id="l11.20">   this.watchLength = newWatchLength;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">   // Watch away as well as online.</span>
<a href="#l11.23"></a><span id="l11.23">   let params = [];</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -166,17 +166,18 @@ var ircWATCH = {</span>
<a href="#l11.25"></a><span id="l11.25">       // :*1&lt;nick&gt; *( &quot; &quot; &lt;nick&gt; )</span>
<a href="#l11.26"></a><span id="l11.26">       // We don't want ircBase to interfere with us, so override the ISON</span>
<a href="#l11.27"></a><span id="l11.27">       // handler to do nothing.</span>
<a href="#l11.28"></a><span id="l11.28">       return true;</span>
<a href="#l11.29"></a><span id="l11.29">     },</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">     &quot;512&quot;: function(aMessage) { // ERR_TOOMANYWATCH</span>
<a href="#l11.32"></a><span id="l11.32">       // Maximum size for WATCH-list is &lt;watchlimit&gt; entries</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-      ERROR(&quot;Maximum size for WATCH list exceeded (&quot; + this.watchLength + &quot;).&quot;);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+      this.ERROR(&quot;Maximum size for WATCH list exceeded (&quot; + this.watchLength +</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+                 &quot;).&quot;);</span>
<a href="#l11.36"></a><span id="l11.36">       return true;</span>
<a href="#l11.37"></a><span id="l11.37">     },</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">     &quot;598&quot;: function(aMessage) { // RPL_GONEAWAY</span>
<a href="#l11.40"></a><span id="l11.40">       // &lt;nickname&gt; &lt;username&gt; &lt;hostname&gt; &lt;awaysince&gt; :is now away</span>
<a href="#l11.41"></a><span id="l11.41">       return setStatus(this, aMessage.params[1], &quot;AWAY&quot;);</span>
<a href="#l11.42"></a><span id="l11.42">     },</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44" class="difflineat">@@ -275,18 +276,18 @@ var isupportMONITOR = {</span>
<a href="#l11.45"></a><span id="l11.45"> function trackBuddyMonitor(aNicks) {</span>
<a href="#l11.46"></a><span id="l11.46">   let nicks = Array.isArray(aNicks) ? aNicks : [aNicks];</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   if (!nicks.length)</span>
<a href="#l11.49"></a><span id="l11.49">     return;</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">   let newMonitorLength = this.monitorLength + nicks.length;</span>
<a href="#l11.52"></a><span id="l11.52">   if (newMonitorLength &gt; this.maxMonitorLength) {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    WARN(&quot;Attempting to MONITOR &quot; + newMonitorLength +</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-         &quot; nicks; maximum size is &quot; + this.maxMonitorLength + &quot;.&quot;);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    this.WARN(&quot;Attempting to MONITOR &quot; + newMonitorLength +</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+              &quot; nicks; maximum size is &quot; + this.maxMonitorLength + &quot;.&quot;);</span>
<a href="#l11.57"></a><span id="l11.57">     // TODO We should trim the list and add the extra users to an ISON queue,</span>
<a href="#l11.58"></a><span id="l11.58">     // but that's not currently implemented, so just hope the server doesn't</span>
<a href="#l11.59"></a><span id="l11.59">     // enforce it's own limit.</span>
<a href="#l11.60"></a><span id="l11.60">   }</span>
<a href="#l11.61"></a><span id="l11.61">   this.monitorLength = newMonitorLength;</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63">   let params = [];</span>
<a href="#l11.64"></a><span id="l11.64">   let maxLength = this.maxMessageLength - 2 -</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineat">@@ -366,13 +367,14 @@ var ircMONITOR = {</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">     &quot;733&quot;: function(aMessage) { // RPL_ENDOFMONLIST</span>
<a href="#l11.68"></a><span id="l11.68">       // :&lt;server&gt; 733 &lt;nick&gt; :End of MONITOR list</span>
<a href="#l11.69"></a><span id="l11.69">       return false;</span>
<a href="#l11.70"></a><span id="l11.70">     },</span>
<a href="#l11.71"></a><span id="l11.71"> </span>
<a href="#l11.72"></a><span id="l11.72">     &quot;734&quot;: function(aMessage) { // ERR_MONLISTFULL</span>
<a href="#l11.73"></a><span id="l11.73">       // :&lt;server&gt; 734 &lt;nick&gt; &lt;limit&gt; &lt;nicks&gt; :Monitor list is full.</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-      ERROR(&quot;Maximum size for MONITOR list exceeded (&quot; + this.params[1] + &quot;).&quot;);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+      this.ERROR(&quot;Maximum size for MONITOR list exceeded (&quot; + this.params[1] +</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+                 &quot;).&quot;);</span>
<a href="#l11.77"></a><span id="l11.77">       return true;</span>
<a href="#l11.78"></a><span id="l11.78">     }</span>
<a href="#l11.79"></a><span id="l11.79">   }</span>
<a href="#l11.80"></a><span id="l11.80"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

