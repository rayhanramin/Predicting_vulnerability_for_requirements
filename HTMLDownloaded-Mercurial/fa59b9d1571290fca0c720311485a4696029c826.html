<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20193:fa59b9d1571290fca0c720311485a4696029c826</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fa59b9d1571290fca0c720311485a4696029c826" />
<meta property="og:url" content="/comm-central/rev/fa59b9d1571290fca0c720311485a4696029c826" />
<meta property="og:description" content="Bug 503360 - Better queries for asynchronous location bar" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fa59b9d1571290fca0c720311485a4696029c826 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fa59b9d1571290fca0c720311485a4696029c826">shortlog</a> |
<a href="/comm-central/log/fa59b9d1571290fca0c720311485a4696029c826">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fa59b9d1571290fca0c720311485a4696029c826">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fa59b9d1571290fca0c720311485a4696029c826">files</a> |
changeset |
<a href="/comm-central/raw-rev/fa59b9d1571290fca0c720311485a4696029c826">raw</a>  | <a href="/comm-central/archive/fa59b9d1571290fca0c720311485a4696029c826.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=503360">Bug 503360</a> - Better queries for asynchronous location bar
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#99;&#111;&#32;&#66;&#111;&#110;&#97;&#114;&#100;&#111;&#32;&#60;&#109;&#97;&#107;&#55;&#55;&#64;&#98;&#111;&#110;&#97;&#114;&#100;&#111;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 13 Jul 2009 12:19:16 -0700</td></tr>

<tr>
 <td>changeset 20193</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fa59b9d1571290fca0c720311485a4696029c826">fa59b9d1571290fca0c720311485a4696029c826</a></td>
</tr>



<tr>
<td>parent 20192</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9041bec64e15e5e1821a2edc64cf80dbcf848348">9041bec64e15e5e1821a2edc64cf80dbcf848348</a>
</td>
</tr>

<tr>
<td>child 20194</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/44fe52ed4bfd8c9bbd68fd7dab5c835d04444664">44fe52ed4bfd8c9bbd68fd7dab5c835d04444664</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fa59b9d1571290fca0c720311485a4696029c826">12352</a></td></tr>
<tr><td>push user</td><td>philip.chee@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 27 Sep 2016 08:56:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9bd937fc0c12 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=503360">503360</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=503360">Bug 503360</a> - Better queries for asynchronous location bar
This creates a better query based on what the asynchronous implementation of
AutoComplete does.  It also limits the amount of work to be done so we don't
filter more results than we have to (even if it is happening on a background thread).
r=sdwilsh</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fa59b9d1571290fca0c720311485a4696029c826/suite/common/places/src/nsPlacesAutoComplete.js">suite/common/places/src/nsPlacesAutoComplete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fa59b9d1571290fca0c720311485a4696029c826/suite/common/places/src/nsPlacesAutoComplete.js">file</a> |
<a href="/comm-central/annotate/fa59b9d1571290fca0c720311485a4696029c826/suite/common/places/src/nsPlacesAutoComplete.js">annotate</a> |
<a href="/comm-central/diff/fa59b9d1571290fca0c720311485a4696029c826/suite/common/places/src/nsPlacesAutoComplete.js">diff</a> |
<a href="/comm-central/comparison/fa59b9d1571290fca0c720311485a4696029c826/suite/common/places/src/nsPlacesAutoComplete.js">comparison</a> |
<a href="/comm-central/log/fa59b9d1571290fca0c720311485a4696029c826/suite/common/places/src/nsPlacesAutoComplete.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/places/src/nsPlacesAutoComplete.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/places/src/nsPlacesAutoComplete.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -100,21 +100,16 @@ const kQueryIndexQueryType = 9;</span>
<a href="#l1.4"></a><span id="l1.4"> const kQueryTypeKeyword = 0;</span>
<a href="#l1.5"></a><span id="l1.5"> const kQueryTypeFiltered = 1;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> // This separator is used as an RTL-friendly way to split the title and tags.</span>
<a href="#l1.8"></a><span id="l1.8"> // It can also be used by an nsIAutoCompleteResult consumer to re-split the</span>
<a href="#l1.9"></a><span id="l1.9"> // &quot;comment&quot; back into the title and the tag.</span>
<a href="#l1.10"></a><span id="l1.10"> const kTitleTagsSeparator = &quot; \u2013 &quot;;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// The list of columns in the moz_places table that we use in our queries.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-const kMozPlacesColumns =</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  &quot;id, url, title, rev_host, visit_count, hidden, typed, favicon_id, &quot; +</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  &quot;frecency, last_visit_date&quot;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-</span>
<a href="#l1.17"></a><span id="l1.17"> const kBrowserUrlbarBranch = &quot;browser.urlbar.&quot;;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.20"></a><span id="l1.20"> //// Global Functions</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> /**</span>
<a href="#l1.23"></a><span id="l1.23">  * Generates the SQL subquery to get the best favicon for a given revhost.  This</span>
<a href="#l1.24"></a><span id="l1.24">  * is the favicon for the most recent visit.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineat">@@ -209,33 +204,34 @@ function nsPlacesAutoComplete()</span>
<a href="#l1.26"></a><span id="l1.26">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.27"></a><span id="l1.27">   //// Shared Constants for Smart Getters</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   // Define common pieces of various queries.</span>
<a href="#l1.30"></a><span id="l1.30">   // TODO bug 412736 in case of a frecency tie, break it with h.typed and</span>
<a href="#l1.31"></a><span id="l1.31">   // h.visit_count which is better than nothing.  This is slow, so not doing it</span>
<a href="#l1.32"></a><span id="l1.32">   // yet...</span>
<a href="#l1.33"></a><span id="l1.33">   // Note: h.frecency is only selected because we need it for ordering.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  const SQL_BASE =</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-    &quot;SELECT h.url, h.title, f.url, &quot; + kBookTagSQLFragment + &quot;, h.visit_count, &quot; +</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-           &quot;h.typed, h.id, :query_type &quot; +</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    &quot;FROM ( &quot; +</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-      &quot;SELECT &quot; + kMozPlacesColumns + &quot; FROM moz_places_temp &quot; +</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-      &quot;UNION ALL &quot; +</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-      &quot;SELECT &quot; + kMozPlacesColumns + &quot; FROM moz_places &quot; +</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      &quot;WHERE +id NOT IN (SELECT id FROM moz_places_temp) &quot; +</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-      &quot;ORDER BY frecency DESC &quot; +</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    &quot;) AS h &quot; +</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-    &quot;LEFT OUTER JOIN moz_favicons f &quot; +</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    &quot;ON f.id = h.favicon_id &quot; +</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    &quot;WHERE h.frecency &lt;&gt; 0 &quot; +</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    &quot;AND AUTOCOMPLETE_MATCH(:searchString, h.url, IFNULL(bookmark, h.title), &quot; +</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-                           &quot;tags, h.visit_count, h.typed, parent, &quot; +</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-                           &quot;:matchBehavior, :searchBehavior) &quot; +</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    &quot;{ADDITIONAL_CONDITIONS}&quot;;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  function sql_base_fragment(aTableName) {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    return &quot;SELECT h.url, h.title, f.url, &quot; + kBookTagSQLFragment + &quot;, &quot; +</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                  &quot;h.visit_count, h.typed, h.id, :query_type, h.frecency &quot; +</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+           &quot;FROM &quot; + aTableName + &quot; h &quot; +</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+           &quot;LEFT OUTER JOIN moz_favicons f ON f.id = h.favicon_id &quot; +</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+           &quot;WHERE h.frecency &lt;&gt; 0 &quot; +</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+           &quot;AND AUTOCOMPLETE_MATCH(:searchString, h.url, &quot; +</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+                                  &quot;IFNULL(bookmark, h.title), tags, &quot; +</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+                                  &quot;h.visit_count, h.typed, parent, &quot; +</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+                                  &quot;:matchBehavior, :searchBehavior) &quot; +</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+          &quot;{ADDITIONAL_CONDITIONS} &quot;;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  }</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  const SQL_BASE = sql_base_fragment(&quot;moz_places_temp&quot;) +</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+                   &quot;UNION ALL &quot; +</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+                   sql_base_fragment(&quot;moz_places&quot;) +</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+                   &quot;AND +h.id NOT IN (SELECT id FROM moz_places_temp) &quot; +</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                   &quot;ORDER BY h.frecency DESC &quot; +</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+                   &quot;LIMIT :maxResults&quot;;</span>
<a href="#l1.69"></a><span id="l1.69"> </span>
<a href="#l1.70"></a><span id="l1.70">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.71"></a><span id="l1.71">   //// Smart Getters</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">   this.__defineGetter__(&quot;_db&quot;, function() {</span>
<a href="#l1.74"></a><span id="l1.74">     delete this._db;</span>
<a href="#l1.75"></a><span id="l1.75">     return this._db = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l1.76"></a><span id="l1.76">                       getService(Ci.nsPIPlacesDatabase).</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineat">@@ -804,16 +800,20 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.78"></a><span id="l1.78">       params.parent = this._bs.tagsFolder;</span>
<a href="#l1.79"></a><span id="l1.79">       params.query_type = kQueryTypeFiltered;</span>
<a href="#l1.80"></a><span id="l1.80">       params.matchBehavior = aMatchBehavior;</span>
<a href="#l1.81"></a><span id="l1.81">       params.searchBehavior = this._behavior;</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">       // We only want to search the tokens that we are left with - not the</span>
<a href="#l1.84"></a><span id="l1.84">       // original search string.</span>
<a href="#l1.85"></a><span id="l1.85">       params.searchString = aTokens.join(&quot; &quot;);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      // Limit the query to the the maximum number of desired results.</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+      // This way we can avoid doing more work than needed.</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+      params.maxResults = this._maxRichResults;</span>
<a href="#l1.90"></a><span id="l1.90">     }</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92">     return query;</span>
<a href="#l1.93"></a><span id="l1.93">   },</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">   /**</span>
<a href="#l1.96"></a><span id="l1.96">    * Obtains the keyword query with the properly bound parameters.</span>
<a href="#l1.97"></a><span id="l1.97">    *</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

