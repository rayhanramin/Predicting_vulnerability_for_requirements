<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9581:946cf51e832725b778ac63e566d45e88b30f33a2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 946cf51e832725b778ac63e566d45e88b30f33a2" />
<meta property="og:url" content="/comm-central/rev/946cf51e832725b778ac63e566d45e88b30f33a2" />
<meta property="og:description" content="Bug 731262 - Warning cleanup part 2. r=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 946cf51e832725b778ac63e566d45e88b30f33a2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/946cf51e832725b778ac63e566d45e88b30f33a2">shortlog</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/946cf51e832725b778ac63e566d45e88b30f33a2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2">files</a> |
changeset |
<a href="/comm-central/raw-rev/946cf51e832725b778ac63e566d45e88b30f33a2">raw</a>  | <a href="/comm-central/archive/946cf51e832725b778ac63e566d45e88b30f33a2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=731262">Bug 731262</a> - Warning cleanup part 2. r=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#73;&#114;&#118;&#105;&#110;&#103;&#32;&#82;&#101;&#105;&#100;&#32;&#60;&#105;&#114;&#118;&#105;&#110;&#103;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 10 Feb 2012 16:25:59 -0500</td></tr>

<tr>
 <td>changeset 9581</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/946cf51e832725b778ac63e566d45e88b30f33a2">946cf51e832725b778ac63e566d45e88b30f33a2</a></td>
</tr>



<tr>
<td>parent 9580</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0683a22dac2b2936542fa3fef62d3adbfcdbdf24">0683a22dac2b2936542fa3fef62d3adbfcdbdf24</a>
</td>
</tr>

<tr>
<td>child 9582</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b7630ce0ad582e2cf3f5437fff581e706b2b0256">b7630ce0ad582e2cf3f5437fff581e706b2b0256</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=946cf51e832725b778ac63e566d45e88b30f33a2">7315</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 08 Mar 2012 00:46:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@946cf51e8327 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=946cf51e832725b778ac63e566d45e88b30f33a2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=946cf51e832725b778ac63e566d45e88b30f33a2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=946cf51e832725b778ac63e566d45e88b30f33a2&newProject=comm-central&newRevision=1bb9b9a58eeae9ef2f94ed9796e643d95a6ff8d5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=946cf51e832725b778ac63e566d45e88b30f33a2&newProject=comm-central&newRevision=1bb9b9a58eeae9ef2f94ed9796e643d95a6ff8d5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=946cf51e832725b778ac63e566d45e88b30f33a2&newProject=comm-central&newRevision=1bb9b9a58eeae9ef2f94ed9796e643d95a6ff8d5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=731262">731262</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=731262">Bug 731262</a> - Warning cleanup part 2. r=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.h">mailnews/base/util/nsMsgProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.h">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.h">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.h">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.h">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/base/util/nsMsgProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.h">mailnews/local/src/nsPop3Protocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.h">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.h">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.h">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.h">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/local/src/nsPop3Protocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.h">mailnews/news/src/nsNNTPProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.h">file</a> |
<a href="/comm-central/annotate/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.h">annotate</a> |
<a href="/comm-central/diff/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.h">diff</a> |
<a href="/comm-central/comparison/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.h">comparison</a> |
<a href="/comm-central/log/946cf51e832725b778ac63e566d45e88b30f33a2/mailnews/news/src/nsNNTPProtocol.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -5453,17 +5453,19 @@ nsMsgViewIndex nsMsgDBView::FindParentIn</span>
<a href="#l1.4"></a><span id="l1.4">       break;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     msgHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l1.7"></a><span id="l1.7">   }</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">   return startOfThreadViewIndex;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-nsresult nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr, nsMsgKey parentKey, PRInt32 level, nsMsgViewIndex *viewIndex, PRUint32 *pNumListed)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+nsresult nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr, nsMsgKey parentKey,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+                                           PRUint32 level, nsMsgViewIndex *viewIndex,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                                           PRUint32 *pNumListed)</span>
<a href="#l1.16"></a><span id="l1.16"> {</span>
<a href="#l1.17"></a><span id="l1.17">   nsresult rv = NS_OK;</span>
<a href="#l1.18"></a><span id="l1.18">   nsCOMPtr &lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l1.19"></a><span id="l1.19">   threadHdr-&gt;EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));</span>
<a href="#l1.20"></a><span id="l1.20">   PRUint32 numChildren;</span>
<a href="#l1.21"></a><span id="l1.21">   (void) threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.22"></a><span id="l1.22">   NS_ASSERTION(numChildren, &quot;Empty thread in view/db&quot;);</span>
<a href="#l1.23"></a><span id="l1.23">   if (!numChildren)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -364,26 +364,25 @@ nsresult nsMsgProtocol::CloseSocket()</span>
<a href="#l2.4"></a><span id="l2.4"> * Writes the data contained in dataBuffer into the current output stream. It also informs</span>
<a href="#l2.5"></a><span id="l2.5"> * the transport layer that this data is now available for transmission.</span>
<a href="#l2.6"></a><span id="l2.6"> * Returns a positive number for success, 0 for failure (not all the bytes were written to the</span>
<a href="#l2.7"></a><span id="l2.7"> * stream, etc). We need to make another pass through this file to install an error system (mscott)</span>
<a href="#l2.8"></a><span id="l2.8"> *</span>
<a href="#l2.9"></a><span id="l2.9"> * No logging is done in the base implementation, so aSuppressLogging is ignored.</span>
<a href="#l2.10"></a><span id="l2.10"> */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-PRInt32 nsMsgProtocol::SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+nsresult nsMsgProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l2.14"></a><span id="l2.14"> {</span>
<a href="#l2.15"></a><span id="l2.15">   PRUint32 writeCount = 0;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  PRInt32 status = 0;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  //  NS_PRECONDITION(m_outputStream, &quot;oops....we don't have an output stream...how did that happen?&quot;);</span>
<a href="#l2.19"></a><span id="l2.19">   if (dataBuffer &amp;&amp; m_outputStream)</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    status = m_outputStream-&gt;Write(dataBuffer, PL_strlen(dataBuffer), &amp;writeCount);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  return status;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    return m_outputStream-&gt;Write(dataBuffer, PL_strlen(dataBuffer), &amp;writeCount);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    // TODO make sure all the bytes in PL_strlen(dataBuffer) were written</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  else</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l2.27"></a><span id="l2.27"> }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> // Whenever data arrives from the connection, core netlib notifices the protocol by calling</span>
<a href="#l2.30"></a><span id="l2.30"> // OnDataAvailable. We then read and process the incoming data from the input stream.</span>
<a href="#l2.31"></a><span id="l2.31"> NS_IMETHODIMP nsMsgProtocol::OnDataAvailable(nsIRequest *request, nsISupports *ctxt, nsIInputStream *inStr, PRUint32 sourceOffset, PRUint32 count)</span>
<a href="#l2.32"></a><span id="l2.32"> {</span>
<a href="#l2.33"></a><span id="l2.33">   // right now, this really just means turn around and churn through the state machine</span>
<a href="#l2.34"></a><span id="l2.34">   nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(ctxt);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineat">@@ -870,17 +869,18 @@ nsresult nsMsgProtocol::PostMessage(nsIU</span>
<a href="#l2.36"></a><span id="l2.36">       line.Insert('.', 0);</span>
<a href="#l2.37"></a><span id="l2.37">     line.Append(NS_LITERAL_CSTRING(CRLF));</span>
<a href="#l2.38"></a><span id="l2.38">     outputBuffer.Append(line);</span>
<a href="#l2.39"></a><span id="l2.39">     // test hack by mscott. If our buffer is almost full, then</span>
<a href="#l2.40"></a><span id="l2.40">     // send it off &amp; reset ourselves</span>
<a href="#l2.41"></a><span id="l2.41">     // to make more room.</span>
<a href="#l2.42"></a><span id="l2.42">     if (outputBuffer.Length() &gt; POST_DATA_BUFFER_SIZE || !more)</span>
<a href="#l2.43"></a><span id="l2.43">     {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      SendData(url, outputBuffer.get());</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+      rv = SendData(outputBuffer.get());</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.47"></a><span id="l2.47">       // does this keep the buffer around? That would be best.</span>
<a href="#l2.48"></a><span id="l2.48">       // Maybe SetLength(0) instead?</span>
<a href="#l2.49"></a><span id="l2.49">       outputBuffer.Truncate();</span>
<a href="#l2.50"></a><span id="l2.50">     }</span>
<a href="#l2.51"></a><span id="l2.51">   } while (more);</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53">   return NS_OK;</span>
<a href="#l2.54"></a><span id="l2.54"> }</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineat">@@ -1329,17 +1329,19 @@ nsresult nsMsgAsyncWriteProtocol::Update</span>
<a href="#l2.56"></a><span id="l2.56">   else</span>
<a href="#l2.57"></a><span id="l2.57">     mSuspendedReadBytes += aNewBytes;</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">   return NS_OK;</span>
<a href="#l2.60"></a><span id="l2.60"> }</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62"> nsresult nsMsgAsyncWriteProtocol::PostDataFinished()</span>
<a href="#l2.63"></a><span id="l2.63"> {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  SendData(nsnull, &quot;.&quot; CRLF);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  nsresult rv = SendData(&quot;.&quot; CRLF);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    return rv;</span>
<a href="#l2.68"></a><span id="l2.68">   mGenerateProgressNotifications = false;</span>
<a href="#l2.69"></a><span id="l2.69">   mPostDataStream = nsnull;</span>
<a href="#l2.70"></a><span id="l2.70">   return NS_OK;</span>
<a href="#l2.71"></a><span id="l2.71"> }</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73"> nsresult nsMsgAsyncWriteProtocol::ProcessIncomingPostData(nsIInputStream *inStr, PRUint32 count)</span>
<a href="#l2.74"></a><span id="l2.74"> {</span>
<a href="#l2.75"></a><span id="l2.75">   if (!m_socketIsOpen) return NS_OK; // kick out if the socket was canceled</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineat">@@ -1549,21 +1551,20 @@ void nsMsgAsyncWriteProtocol::UpdateProg</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78">     // XXX not sure if m_request is correct here</span>
<a href="#l2.79"></a><span id="l2.79">     webProgressListener-&gt;OnProgressChange(nsnull, m_request, mNumBytesPosted, mFilePostSize, mNumBytesPosted, mFilePostSize);</span>
<a href="#l2.80"></a><span id="l2.80">   }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">   return;</span>
<a href="#l2.83"></a><span id="l2.83"> }</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-PRInt32 nsMsgAsyncWriteProtocol::SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l2.87"></a><span id="l2.87"> {</span>
<a href="#l2.88"></a><span id="l2.88">   this-&gt;mAsyncBuffer.Append(dataBuffer);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  mAsyncOutStream-&gt;AsyncWait(mProvider, 0, 0, mProviderThread);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  return mAsyncOutStream-&gt;AsyncWait(mProvider, 0, 0, mProviderThread);</span>
<a href="#l2.92"></a><span id="l2.92"> }</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94"> #define MSGS_URL    &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96"> PRUnichar *FormatStringWithHostNameByID(PRInt32 stringID, nsIMsgMailNewsUrl *msgUri)</span>
<a href="#l2.97"></a><span id="l2.97"> {</span>
<a href="#l2.98"></a><span id="l2.98">   if (!msgUri)</span>
<a href="#l2.99"></a><span id="l2.99">     return nsnull;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -144,17 +144,17 @@ protected:</span>
<a href="#l3.4"></a><span id="l3.4">   virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream, </span>
<a href="#l3.5"></a><span id="l3.5">                   PRUint32 sourceOffset, PRUint32 length) = 0;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   // SendData -- Writes the data contained in dataBuffer into the current output stream. </span>
<a href="#l3.8"></a><span id="l3.8">   // It also informs the transport layer that this data is now available for transmission.</span>
<a href="#l3.9"></a><span id="l3.9">   // Returns a positive number for success, 0 for failure (not all the bytes were written to the</span>
<a href="#l3.10"></a><span id="l3.10">   // stream, etc). </span>
<a href="#l3.11"></a><span id="l3.11">     // aSuppressLogging is a hint that sensitive data is being sent and should not be logged</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  virtual PRInt32 SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   virtual nsresult PostMessage(nsIURI* url, nsIFile* aPostFile);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   virtual nsresult InitFromURI(nsIURI *aUrl);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   nsresult DoNtlmStep1(const char *username, const char *password, nsCString &amp;response);</span>
<a href="#l3.20"></a><span id="l3.20">   nsresult DoNtlmStep2(nsCString &amp;commandResponse, nsCString &amp;response);</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -218,17 +218,17 @@ public:</span>
<a href="#l3.23"></a><span id="l3.23">   nsMsgAsyncWriteProtocol(nsIURI * aURL);</span>
<a href="#l3.24"></a><span id="l3.24">   virtual ~nsMsgAsyncWriteProtocol(); </span>
<a href="#l3.25"></a><span id="l3.25">   </span>
<a href="#l3.26"></a><span id="l3.26">   // temporary over ride...</span>
<a href="#l3.27"></a><span id="l3.27">   virtual nsresult PostMessage(nsIURI* url, nsIFile *postFile);</span>
<a href="#l3.28"></a><span id="l3.28">   </span>
<a href="#l3.29"></a><span id="l3.29">   // over ride the following methods from the base class</span>
<a href="#l3.30"></a><span id="l3.30">   virtual nsresult SetupTransportState();</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  virtual PRInt32 SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l3.33"></a><span id="l3.33">   nsCString mAsyncBuffer;</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">   // if we suspended the asynch write while waiting for more data to write then this will be TRUE</span>
<a href="#l3.36"></a><span id="l3.36">   bool mSuspendedWrite;</span>
<a href="#l3.37"></a><span id="l3.37">   nsCOMPtr&lt;nsIRequest&gt;     m_WriteRequest;</span>
<a href="#l3.38"></a><span id="l3.38">   nsCOMPtr&lt;nsIAsyncOutputStream&gt;    mAsyncOutStream;</span>
<a href="#l3.39"></a><span id="l3.39">   nsCOMPtr&lt;nsIOutputStreamCallback&gt; mProvider;</span>
<a href="#l3.40"></a><span id="l3.40">   nsCOMPtr&lt;nsIThread&gt;               mProviderThread;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -559,19 +559,17 @@ PRInt32 nsSmtpProtocol::ExtensionLoginRe</span>
<a href="#l4.4"></a><span id="l4.4">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l4.5"></a><span id="l4.5">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l4.6"></a><span id="l4.6">   }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   nsCAutoString buffer(&quot;EHLO &quot;);</span>
<a href="#l4.9"></a><span id="l4.9">   AppendHelloArgument(buffer);</span>
<a href="#l4.10"></a><span id="l4.10">   buffer += CRLF;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  status = SendData(url, buffer.get());</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  status = SendData(buffer.get());</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.18"></a><span id="l4.18">   m_nextStateAfterResponse = SMTP_SEND_EHLO_RESPONSE;</span>
<a href="#l4.19"></a><span id="l4.19">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   return(status);</span>
<a href="#l4.22"></a><span id="l4.22"> }</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -669,32 +667,30 @@ PRInt32 nsSmtpProtocol::SendHeloResponse</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   if(TestFlag(SMTP_EHLO_SIZE_ENABLED))</span>
<a href="#l4.27"></a><span id="l4.27">   {</span>
<a href="#l4.28"></a><span id="l4.28">     buffer.Append(&quot; SIZE=&quot;);</span>
<a href="#l4.29"></a><span id="l4.29">     buffer.AppendInt(m_totalMessageSize);</span>
<a href="#l4.30"></a><span id="l4.30">   }</span>
<a href="#l4.31"></a><span id="l4.31">   buffer += CRLF;</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  status = SendData(url, buffer.get());</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  status = SendData(buffer.get());</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">   m_nextStateAfterResponse = SMTP_SEND_MAIL_RESPONSE;</span>
<a href="#l4.41"></a><span id="l4.41">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   return(status);</span>
<a href="#l4.44"></a><span id="l4.44"> }</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> PRInt32 nsSmtpProtocol::SendEhloResponse(nsIInputStream * inputStream, PRUint32 length)</span>
<a href="#l4.47"></a><span id="l4.47"> {</span>
<a href="#l4.48"></a><span id="l4.48">     PRInt32 status = 0;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">     if (m_responseCode != 250)</span>
<a href="#l4.52"></a><span id="l4.52">     {</span>
<a href="#l4.53"></a><span id="l4.53">         /* EHLO must not be implemented by the server, so fall back to the HELO case</span>
<a href="#l4.54"></a><span id="l4.54">          * if command is unrecognized or unimplemented.</span>
<a href="#l4.55"></a><span id="l4.55">          */</span>
<a href="#l4.56"></a><span id="l4.56">         if (m_responseCode == 500 || m_responseCode == 502)</span>
<a href="#l4.57"></a><span id="l4.57">         {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineat">@@ -708,17 +704,17 @@ PRInt32 nsSmtpProtocol::SendEhloResponse</span>
<a href="#l4.59"></a><span id="l4.59">                 m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l4.60"></a><span id="l4.60">                 return(NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS);</span>
<a href="#l4.61"></a><span id="l4.61">             }</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">             nsCAutoString buffer(&quot;HELO &quot;);</span>
<a href="#l4.64"></a><span id="l4.64">             AppendHelloArgument(buffer);</span>
<a href="#l4.65"></a><span id="l4.65">             buffer += CRLF;</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-            status = SendData(url, buffer.get());</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+            status = SendData(buffer.get());</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70">             m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.71"></a><span id="l4.71">             m_nextStateAfterResponse = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l4.72"></a><span id="l4.72">             SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.73"></a><span id="l4.73">             return (status);</span>
<a href="#l4.74"></a><span id="l4.74">         }</span>
<a href="#l4.75"></a><span id="l4.75">         /* e.g. getting 421 &quot;Server says unauthorized, bye&quot; or</span>
<a href="#l4.76"></a><span id="l4.76">          * 501 &quot;Syntax error in EHLOs parameters or arguments&quot;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineat">@@ -958,34 +954,33 @@ void nsSmtpProtocol::ResetAuthMethods()</span>
<a href="#l4.78"></a><span id="l4.78">   m_currentAuthMethod = 0;</span>
<a href="#l4.79"></a><span id="l4.79">   m_failedAuthMethods = 0;</span>
<a href="#l4.80"></a><span id="l4.80"> }</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82"> PRInt32 nsSmtpProtocol::ProcessAuth()</span>
<a href="#l4.83"></a><span id="l4.83"> {</span>
<a href="#l4.84"></a><span id="l4.84">     PRInt32 status = 0;</span>
<a href="#l4.85"></a><span id="l4.85">     nsCAutoString buffer;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     if (!m_tlsEnabled)</span>
<a href="#l4.89"></a><span id="l4.89">     {</span>
<a href="#l4.90"></a><span id="l4.90">         if (TestFlag(SMTP_EHLO_STARTTLS_ENABLED))</span>
<a href="#l4.91"></a><span id="l4.91">         {</span>
<a href="#l4.92"></a><span id="l4.92">             // Do not try to combine SMTPS with STARTTLS.</span>
<a href="#l4.93"></a><span id="l4.93">             // If nsMsgSocketType::SSL is set,</span>
<a href="#l4.94"></a><span id="l4.94">             // we are alrady using a secure connection.</span>
<a href="#l4.95"></a><span id="l4.95">             // Do not attempt to do STARTTLS,</span>
<a href="#l4.96"></a><span id="l4.96">             // even if server offers it.</span>
<a href="#l4.97"></a><span id="l4.97">             if (m_prefSocketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l4.98"></a><span id="l4.98">                 m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l4.99"></a><span id="l4.99">             {</span>
<a href="#l4.100"></a><span id="l4.100">                 buffer = &quot;STARTTLS&quot;;</span>
<a href="#l4.101"></a><span id="l4.101">                 buffer += CRLF;</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-                status = SendData(url, buffer.get());</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+                status = SendData(buffer.get());</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">                 m_tlsInitiated = true;</span>
<a href="#l4.107"></a><span id="l4.107"> </span>
<a href="#l4.108"></a><span id="l4.108">                 m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.109"></a><span id="l4.109">                 m_nextStateAfterResponse = SMTP_TLS_RESPONSE;</span>
<a href="#l4.110"></a><span id="l4.110">                 SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.111"></a><span id="l4.111">                 return status;</span>
<a href="#l4.112"></a><span id="l4.112">             }</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineat">@@ -1008,17 +1003,17 @@ PRInt32 nsSmtpProtocol::ProcessAuth()</span>
<a href="#l4.114"></a><span id="l4.114">     m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l4.115"></a><span id="l4.115">     // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l4.116"></a><span id="l4.116">     m_responseCode = 250;</span>
<a href="#l4.117"></a><span id="l4.117">   }</span>
<a href="#l4.118"></a><span id="l4.118">   else if (m_currentAuthMethod == SMTP_AUTH_EXTERNAL_ENABLED)</span>
<a href="#l4.119"></a><span id="l4.119">   {</span>
<a href="#l4.120"></a><span id="l4.120">     buffer = &quot;AUTH EXTERNAL =&quot;;</span>
<a href="#l4.121"></a><span id="l4.121">     buffer += CRLF;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    SendData(url, buffer.get());</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+    SendData(buffer.get());</span>
<a href="#l4.124"></a><span id="l4.124">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.125"></a><span id="l4.125">     m_nextStateAfterResponse = SMTP_AUTH_EXTERNAL_RESPONSE;</span>
<a href="#l4.126"></a><span id="l4.126">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.127"></a><span id="l4.127">     return NS_OK;</span>
<a href="#l4.128"></a><span id="l4.128">   }</span>
<a href="#l4.129"></a><span id="l4.129">   else if (m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED)</span>
<a href="#l4.130"></a><span id="l4.130">   {</span>
<a href="#l4.131"></a><span id="l4.131">     m_nextState = SMTP_SEND_AUTH_GSSAPI_FIRST;</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineat">@@ -1215,18 +1210,17 @@ PRInt32 nsSmtpProtocol::AuthGSSAPIFirst(</span>
<a href="#l4.133"></a><span id="l4.133">     return 0;</span>
<a href="#l4.134"></a><span id="l4.134">   }</span>
<a href="#l4.135"></a><span id="l4.135">   else</span>
<a href="#l4.136"></a><span id="l4.136">     command.Append(resp);</span>
<a href="#l4.137"></a><span id="l4.137">   command.Append(CRLF);</span>
<a href="#l4.138"></a><span id="l4.138">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.139"></a><span id="l4.139">   m_nextStateAfterResponse = SMTP_SEND_AUTH_GSSAPI_STEP;</span>
<a href="#l4.140"></a><span id="l4.140">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-  return SendData(url, command.get());</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  return SendData(command.get());</span>
<a href="#l4.144"></a><span id="l4.144"> }</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146"> // GSSAPI may consist of multiple round trips</span>
<a href="#l4.147"></a><span id="l4.147"> </span>
<a href="#l4.148"></a><span id="l4.148"> PRInt32 nsSmtpProtocol::AuthGSSAPIStep()</span>
<a href="#l4.149"></a><span id="l4.149"> {</span>
<a href="#l4.150"></a><span id="l4.150">   PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: GSSAPI auth step 2&quot;));</span>
<a href="#l4.151"></a><span id="l4.151">   NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED, &quot;called in invalid state&quot;);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineat">@@ -1243,18 +1237,17 @@ PRInt32 nsSmtpProtocol::AuthGSSAPIStep()</span>
<a href="#l4.153"></a><span id="l4.153">   if (NS_FAILED(rv))</span>
<a href="#l4.154"></a><span id="l4.154">     cmd = &quot;*&quot;;</span>
<a href="#l4.155"></a><span id="l4.155">   cmd += CRLF;</span>
<a href="#l4.156"></a><span id="l4.156"> </span>
<a href="#l4.157"></a><span id="l4.157">   m_nextStateAfterResponse = (rv == NS_SUCCESS_AUTH_FINISHED)?SMTP_AUTH_LOGIN_RESPONSE:SMTP_SEND_AUTH_GSSAPI_STEP;</span>
<a href="#l4.158"></a><span id="l4.158">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.159"></a><span id="l4.159">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.160"></a><span id="l4.160"> </span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-  return SendData(url, cmd.get());</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  return SendData(cmd.get());</span>
<a href="#l4.164"></a><span id="l4.164"> }</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167"> // LOGIN and MSN consist of three steps (MSN not through the mechanism</span>
<a href="#l4.168"></a><span id="l4.168"> // but by non-RFC2821 compliant implementation in MS servers) not two as</span>
<a href="#l4.169"></a><span id="l4.169"> // PLAIN or CRAM-MD5, so we've to start here and continue with AuthStep1</span>
<a href="#l4.170"></a><span id="l4.170"> // if the server responds with with a 3xx code to &quot;AUTH LOGIN&quot; or &quot;AUTH MSN&quot;</span>
<a href="#l4.171"></a><span id="l4.171"> PRInt32 nsSmtpProtocol::AuthLoginStep0()</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineat">@@ -1264,17 +1257,17 @@ PRInt32 nsSmtpProtocol::AuthLoginStep0()</span>
<a href="#l4.173"></a><span id="l4.173">         &quot;called in invalid state&quot;);</span>
<a href="#l4.174"></a><span id="l4.174">     PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: MSN or LOGIN auth, step 0&quot;));</span>
<a href="#l4.175"></a><span id="l4.175">     nsCAutoString command(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED</span>
<a href="#l4.176"></a><span id="l4.176">         ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l4.177"></a><span id="l4.177">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.178"></a><span id="l4.178">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_STEP0_RESPONSE;</span>
<a href="#l4.179"></a><span id="l4.179">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.180"></a><span id="l4.180"> </span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-    return SendData(m_url, command.get());</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+    return SendData(command.get());</span>
<a href="#l4.183"></a><span id="l4.183"> }</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185"> PRInt32 nsSmtpProtocol::AuthLoginStep0Response()</span>
<a href="#l4.186"></a><span id="l4.186"> {</span>
<a href="#l4.187"></a><span id="l4.187">     NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l4.188"></a><span id="l4.188">         m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l4.189"></a><span id="l4.189">         &quot;called in invalid state&quot;);</span>
<a href="#l4.190"></a><span id="l4.190">     // need the test to be here instead in AuthLoginResponse() to</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineat">@@ -1352,18 +1345,17 @@ PRInt32 nsSmtpProtocol::AuthLoginStep1()</span>
<a href="#l4.192"></a><span id="l4.192">     PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;LOGIN auth&quot;));</span>
<a href="#l4.193"></a><span id="l4.193">     base64Str = PL_Base64Encode(username.get(),</span>
<a href="#l4.194"></a><span id="l4.194">         username.Length(), nsnull);</span>
<a href="#l4.195"></a><span id="l4.195">     PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, base64Str);</span>
<a href="#l4.196"></a><span id="l4.196">   }</span>
<a href="#l4.197"></a><span id="l4.197">   else</span>
<a href="#l4.198"></a><span id="l4.198">     return (NS_ERROR_COMMUNICATIONS_ERROR);</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  status = SendData(url, buffer, true);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  status = SendData(buffer, true);</span>
<a href="#l4.203"></a><span id="l4.203">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.204"></a><span id="l4.204">   m_nextStateAfterResponse = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l4.205"></a><span id="l4.205">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.206"></a><span id="l4.206">   NS_Free(base64Str);</span>
<a href="#l4.207"></a><span id="l4.207"> </span>
<a href="#l4.208"></a><span id="l4.208">   return (status);</span>
<a href="#l4.209"></a><span id="l4.209"> }</span>
<a href="#l4.210"></a><span id="l4.210"> </span>
<a href="#l4.211"></a><span id="l4.211" class="difflineat">@@ -1442,18 +1434,17 @@ PRInt32 nsSmtpProtocol::AuthLoginStep2()</span>
<a href="#l4.212"></a><span id="l4.212">       PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;PLAIN/LOGIN auth, step 2&quot;));</span>
<a href="#l4.213"></a><span id="l4.213">       char *base64Str = PL_Base64Encode(password.get(), password.Length(), nsnull);</span>
<a href="#l4.214"></a><span id="l4.214">       PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, base64Str);</span>
<a href="#l4.215"></a><span id="l4.215">       NS_Free(base64Str);</span>
<a href="#l4.216"></a><span id="l4.216">     }</span>
<a href="#l4.217"></a><span id="l4.217">     else</span>
<a href="#l4.218"></a><span id="l4.218">       return NS_ERROR_COMMUNICATIONS_ERROR;</span>
<a href="#l4.219"></a><span id="l4.219"> </span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-    status = SendData(url, buffer, true);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    status = SendData(buffer, true);</span>
<a href="#l4.223"></a><span id="l4.223">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.224"></a><span id="l4.224">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l4.225"></a><span id="l4.225">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.226"></a><span id="l4.226">     return (status);</span>
<a href="#l4.227"></a><span id="l4.227">   }</span>
<a href="#l4.228"></a><span id="l4.228"> </span>
<a href="#l4.229"></a><span id="l4.229">   return -1;</span>
<a href="#l4.230"></a><span id="l4.230"> }</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineat">@@ -1544,18 +1535,17 @@ PRInt32 nsSmtpProtocol::SendMailResponse</span>
<a href="#l4.232"></a><span id="l4.232">     }</span>
<a href="#l4.233"></a><span id="l4.233">     else</span>
<a href="#l4.234"></a><span id="l4.234">     {</span>
<a href="#l4.235"></a><span id="l4.235">       buffer = &quot;RCPT TO:&lt;&quot;;</span>
<a href="#l4.236"></a><span id="l4.236">       buffer += m_addresses;</span>
<a href="#l4.237"></a><span id="l4.237">       buffer += &quot;&gt;&quot;;</span>
<a href="#l4.238"></a><span id="l4.238">       buffer += CRLF;</span>
<a href="#l4.239"></a><span id="l4.239">     }</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-    status = SendData(url, buffer.get());</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    status = SendData(buffer.get());</span>
<a href="#l4.243"></a><span id="l4.243"> </span>
<a href="#l4.244"></a><span id="l4.244">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.245"></a><span id="l4.245">     m_nextStateAfterResponse = SMTP_SEND_RCPT_RESPONSE;</span>
<a href="#l4.246"></a><span id="l4.246">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.247"></a><span id="l4.247"> </span>
<a href="#l4.248"></a><span id="l4.248">     return(status);</span>
<a href="#l4.249"></a><span id="l4.249"> }</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251" class="difflineat">@@ -1593,37 +1583,36 @@ PRInt32 nsSmtpProtocol::SendRecipientRes</span>
<a href="#l4.252"></a><span id="l4.252">     m_responseCode = 250;</span>
<a href="#l4.253"></a><span id="l4.253">     m_nextState = SMTP_SEND_MAIL_RESPONSE;</span>
<a href="#l4.254"></a><span id="l4.254">     return(0);</span>
<a href="#l4.255"></a><span id="l4.255">   }</span>
<a href="#l4.256"></a><span id="l4.256"> </span>
<a href="#l4.257"></a><span id="l4.257">   /* else send the DATA command */</span>
<a href="#l4.258"></a><span id="l4.258">   buffer = &quot;DATA&quot;;</span>
<a href="#l4.259"></a><span id="l4.259">   buffer += CRLF;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-  status = SendData(url, buffer.get());</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+  status = SendData(buffer.get());</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.265"></a><span id="l4.265">   m_nextStateAfterResponse = SMTP_SEND_DATA_RESPONSE;</span>
<a href="#l4.266"></a><span id="l4.266">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l4.267"></a><span id="l4.267"> </span>
<a href="#l4.268"></a><span id="l4.268">   return(status);</span>
<a href="#l4.269"></a><span id="l4.269"> }</span>
<a href="#l4.270"></a><span id="l4.270"> </span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-PRInt32 nsSmtpProtocol::SendData(nsIURI *url, const char *dataBuffer, bool aSuppressLogging)</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+nsresult nsSmtpProtocol::SendData(const char *dataBuffer, bool aSuppressLogging)</span>
<a href="#l4.274"></a><span id="l4.274"> {</span>
<a href="#l4.275"></a><span id="l4.275">   if (!dataBuffer) return -1;</span>
<a href="#l4.276"></a><span id="l4.276"> </span>
<a href="#l4.277"></a><span id="l4.277">   if (!aSuppressLogging) {</span>
<a href="#l4.278"></a><span id="l4.278">       PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;SMTP Send: %s&quot;, dataBuffer));</span>
<a href="#l4.279"></a><span id="l4.279">   } else {</span>
<a href="#l4.280"></a><span id="l4.280">       PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l4.281"></a><span id="l4.281">   }</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-  return nsMsgAsyncWriteProtocol::SendData(url, dataBuffer);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+  return nsMsgAsyncWriteProtocol::SendData(dataBuffer);</span>
<a href="#l4.284"></a><span id="l4.284"> }</span>
<a href="#l4.285"></a><span id="l4.285"> </span>
<a href="#l4.286"></a><span id="l4.286"> </span>
<a href="#l4.287"></a><span id="l4.287"> PRInt32 nsSmtpProtocol::SendDataResponse()</span>
<a href="#l4.288"></a><span id="l4.288"> {</span>
<a href="#l4.289"></a><span id="l4.289">   PRInt32 status = 0;</span>
<a href="#l4.290"></a><span id="l4.290">   char *command = nsnull;</span>
<a href="#l4.291"></a><span id="l4.291"> </span>
<a href="#l4.292"></a><span id="l4.292" class="difflineat">@@ -1716,18 +1705,17 @@ PRInt32 nsSmtpProtocol::SendMessageRespo</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294">   /* else */</span>
<a href="#l4.295"></a><span id="l4.295">   return SendQuit();</span>
<a href="#l4.296"></a><span id="l4.296"> }</span>
<a href="#l4.297"></a><span id="l4.297"> </span>
<a href="#l4.298"></a><span id="l4.298"> PRInt32 nsSmtpProtocol::SendQuit()</span>
<a href="#l4.299"></a><span id="l4.299"> {</span>
<a href="#l4.300"></a><span id="l4.300">   m_sendDone = true;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-  SendData(url, &quot;QUIT&quot;CRLF); // send a quit command to close the connection with the server.</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+  SendData(&quot;QUIT&quot;CRLF); // send a quit command to close the connection with the server.</span>
<a href="#l4.304"></a><span id="l4.304">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.305"></a><span id="l4.305">   m_nextStateAfterResponse = SMTP_DONE;</span>
<a href="#l4.306"></a><span id="l4.306">   return(0);</span>
<a href="#l4.307"></a><span id="l4.307"> }</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309"> nsresult nsSmtpProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer )</span>
<a href="#l4.310"></a><span id="l4.310"> {</span>
<a href="#l4.311"></a><span id="l4.311">   if (!aURL)</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineat">@@ -1962,19 +1950,18 @@ nsresult nsSmtpProtocol::LoadUrl(nsIURI </span>
<a href="#l4.313"></a><span id="l4.313">         break;</span>
<a href="#l4.314"></a><span id="l4.314">     }</span>
<a href="#l4.315"></a><span id="l4.315"> </span>
<a href="#l4.316"></a><span id="l4.316">     /* check for errors during load and call error</span>
<a href="#l4.317"></a><span id="l4.317">     * state if found</span>
<a href="#l4.318"></a><span id="l4.318">     */</span>
<a href="#l4.319"></a><span id="l4.319">     if(status &lt; 0 &amp;&amp; m_nextState != SMTP_FREE)</span>
<a href="#l4.320"></a><span id="l4.320">     {</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-      nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l4.322"></a><span id="l4.322">       // send a quit command to close the connection with the server.</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-      if (SendData(url, &quot;QUIT&quot;CRLF) == NS_OK)</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+      if (SendData(&quot;QUIT&quot;CRLF) == NS_OK)</span>
<a href="#l4.325"></a><span id="l4.325">       {</span>
<a href="#l4.326"></a><span id="l4.326">         m_nextState = SMTP_RESPONSE;</span>
<a href="#l4.327"></a><span id="l4.327">         m_nextStateAfterResponse = SMTP_ERROR_DONE;</span>
<a href="#l4.328"></a><span id="l4.328">       }</span>
<a href="#l4.329"></a><span id="l4.329">       else</span>
<a href="#l4.330"></a><span id="l4.330">       {</span>
<a href="#l4.331"></a><span id="l4.331">       m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l4.332"></a><span id="l4.332">       /* don't exit! loop around again and do the free case */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -109,17 +109,17 @@ class nsSmtpProtocol : public nsMsgAsync</span>
<a href="#l5.4"></a><span id="l5.4"> public:</span>
<a href="#l5.5"></a><span id="l5.5">     NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     // Creating a protocol instance requires the URL which needs to be run.</span>
<a href="#l5.8"></a><span id="l5.8">     nsSmtpProtocol(nsIURI * aURL);</span>
<a href="#l5.9"></a><span id="l5.9">     virtual ~nsSmtpProtocol();</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">     virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer = nsnull);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    virtual PRInt32 SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.16"></a><span id="l5.16">     // we suppport the nsIStreamListener interface </span>
<a href="#l5.17"></a><span id="l5.17">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">     // stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away. </span>
<a href="#l5.20"></a><span id="l5.20">     NS_IMETHOD OnStopRequest(nsIRequest *request, nsISupports *ctxt, nsresult status);</span>
<a href="#l5.21"></a><span id="l5.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1347,57 +1347,57 @@ nsPop3Protocol::Error(PRInt32 err_code)</span>
<a href="#l6.4"></a><span id="l6.4">             }</span>
<a href="#l6.5"></a><span id="l6.5">         }</span>
<a href="#l6.6"></a><span id="l6.6">     }</span>
<a href="#l6.7"></a><span id="l6.7">     m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l6.8"></a><span id="l6.8">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l6.9"></a><span id="l6.9">     return -1;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-PRInt32 nsPop3Protocol::SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+nsresult nsPop3Protocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l6.14"></a><span id="l6.14"> {</span>
<a href="#l6.15"></a><span id="l6.15">   // remove any leftover bytes in the line buffer</span>
<a href="#l6.16"></a><span id="l6.16">   // this can happen if the last message line doesn't end with a (CR)LF</span>
<a href="#l6.17"></a><span id="l6.17">   // or a server sent two reply lines</span>
<a href="#l6.18"></a><span id="l6.18">   m_lineStreamBuffer-&gt;ClearBuffer();</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  PRInt32 result = nsMsgProtocol::SendData(aURL, dataBuffer);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  nsresult result = nsMsgProtocol::SendData(dataBuffer);</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   if (!aSuppressLogging)</span>
<a href="#l6.24"></a><span id="l6.24">       PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;SEND: %s&quot;, dataBuffer));</span>
<a href="#l6.25"></a><span id="l6.25">   else</span>
<a href="#l6.26"></a><span id="l6.26">       PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  if (result &gt;= 0) // yeah this sucks...i need an error code....</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  if (NS_SUCCEEDED(result)) // yeah this sucks...i need an error code....</span>
<a href="#l6.30"></a><span id="l6.30">   {</span>
<a href="#l6.31"></a><span id="l6.31">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.32"></a><span id="l6.32">     m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l6.33"></a><span id="l6.33">   }</span>
<a href="#l6.34"></a><span id="l6.34">   else</span>
<a href="#l6.35"></a><span id="l6.35">   {</span>
<a href="#l6.36"></a><span id="l6.36">     m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l6.37"></a><span id="l6.37">     PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;SendData faild: %lx&quot;, result));</span>
<a href="#l6.38"></a><span id="l6.38">   }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  return 0;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  return result;</span>
<a href="#l6.42"></a><span id="l6.42"> }</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44"> /*</span>
<a href="#l6.45"></a><span id="l6.45">  * POP3 AUTH extension</span>
<a href="#l6.46"></a><span id="l6.46">  */</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> PRInt32 nsPop3Protocol::SendAuth()</span>
<a href="#l6.49"></a><span id="l6.49"> {</span>
<a href="#l6.50"></a><span id="l6.50">   if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l6.51"></a><span id="l6.51">     return(Error(POP3_SERVER_ERROR));</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">   nsCAutoString command(&quot;AUTH&quot; CRLF);</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55">   m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_RESPONSE;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  return SendData(m_url, command.get());</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  return SendData(command.get());</span>
<a href="#l6.58"></a><span id="l6.58"> }</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60"> PRInt32 nsPop3Protocol::AuthResponse(nsIInputStream* inputStream,</span>
<a href="#l6.61"></a><span id="l6.61">                              PRUint32 length)</span>
<a href="#l6.62"></a><span id="l6.62"> {</span>
<a href="#l6.63"></a><span id="l6.63">     char * line;</span>
<a href="#l6.64"></a><span id="l6.64">     PRUint32 ln = 0;</span>
<a href="#l6.65"></a><span id="l6.65">     nsresult rv;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineat">@@ -1481,17 +1481,17 @@ PRInt32 nsPop3Protocol::SendCapa()</span>
<a href="#l6.67"></a><span id="l6.67"> {</span>
<a href="#l6.68"></a><span id="l6.68">     PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendCapa()&quot;));</span>
<a href="#l6.69"></a><span id="l6.69">     if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l6.70"></a><span id="l6.70">         return(Error(POP3_SERVER_ERROR));</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">     nsCAutoString command(&quot;CAPA&quot; CRLF);</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">     m_pop3ConData-&gt;next_state_after_response = POP3_CAPA_RESPONSE;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    return SendData(m_url, command.get());</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    return SendData(command.get());</span>
<a href="#l6.77"></a><span id="l6.77"> }</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79"> PRInt32 nsPop3Protocol::CapaResponse(nsIInputStream* inputStream,</span>
<a href="#l6.80"></a><span id="l6.80">                              PRUint32 length)</span>
<a href="#l6.81"></a><span id="l6.81"> {</span>
<a href="#l6.82"></a><span id="l6.82">     char * line;</span>
<a href="#l6.83"></a><span id="l6.83">     PRUint32 ln = 0;</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85" class="difflineat">@@ -1773,17 +1773,17 @@ PRInt32 nsPop3Protocol::ProcessAuth()</span>
<a href="#l6.86"></a><span id="l6.86">       if(TestCapFlag(POP3_HAS_STLS))</span>
<a href="#l6.87"></a><span id="l6.87">       {</span>
<a href="#l6.88"></a><span id="l6.88">         if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l6.89"></a><span id="l6.89">             m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l6.90"></a><span id="l6.90">         {</span>
<a href="#l6.91"></a><span id="l6.91">             nsCAutoString command(&quot;STLS&quot; CRLF);</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">             m_pop3ConData-&gt;next_state_after_response = POP3_TLS_RESPONSE;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-            return SendData(m_url, command.get());</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+            return SendData(command.get());</span>
<a href="#l6.96"></a><span id="l6.96">         }</span>
<a href="#l6.97"></a><span id="l6.97">       }</span>
<a href="#l6.98"></a><span id="l6.98">       else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l6.99"></a><span id="l6.99">       {</span>
<a href="#l6.100"></a><span id="l6.100">           m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l6.101"></a><span id="l6.101">           return(Error(NS_ERROR_COULD_NOT_CONNECT_VIA_TLS));</span>
<a href="#l6.102"></a><span id="l6.102">       }</span>
<a href="#l6.103"></a><span id="l6.103">     }</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineat">@@ -1981,17 +1981,17 @@ PRInt32 nsPop3Protocol::NextAuthStep()</span>
<a href="#l6.105"></a><span id="l6.105"> // so we've to start here and continue in SendUsername if the server</span>
<a href="#l6.106"></a><span id="l6.106"> // responds + to &quot;AUTH LOGIN&quot;</span>
<a href="#l6.107"></a><span id="l6.107"> PRInt32 nsPop3Protocol::AuthLogin()</span>
<a href="#l6.108"></a><span id="l6.108"> {</span>
<a href="#l6.109"></a><span id="l6.109">     nsCAutoString command(&quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l6.110"></a><span id="l6.110">     m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l6.111"></a><span id="l6.111">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    return SendData(m_url, command.get());</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+    return SendData(command.get());</span>
<a href="#l6.115"></a><span id="l6.115"> }</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117"> PRInt32 nsPop3Protocol::AuthLoginResponse()</span>
<a href="#l6.118"></a><span id="l6.118"> {</span>
<a href="#l6.119"></a><span id="l6.119">     // need the test to be here instead in NextAuthStep() to</span>
<a href="#l6.120"></a><span id="l6.120">     // differentiate between command AUTH LOGIN failed and</span>
<a href="#l6.121"></a><span id="l6.121">     // sending username using LOGIN mechanism failed.</span>
<a href="#l6.122"></a><span id="l6.122">     if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineat">@@ -2013,17 +2013,17 @@ PRInt32 nsPop3Protocol::AuthLoginRespons</span>
<a href="#l6.124"></a><span id="l6.124"> // responds + to &quot;AUTH NTLM&quot;</span>
<a href="#l6.125"></a><span id="l6.125"> PRInt32 nsPop3Protocol::AuthNtlm()</span>
<a href="#l6.126"></a><span id="l6.126"> {</span>
<a href="#l6.127"></a><span id="l6.127">     nsCAutoString command (m_currentAuthMethod == POP3_HAS_AUTH_MSN</span>
<a href="#l6.128"></a><span id="l6.128">           ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH NTLM&quot; CRLF);</span>
<a href="#l6.129"></a><span id="l6.129">     m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_NTLM_RESPONSE;</span>
<a href="#l6.130"></a><span id="l6.130">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.131"></a><span id="l6.131"> </span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-    return SendData(m_url, command.get());</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+    return SendData(command.get());</span>
<a href="#l6.134"></a><span id="l6.134"> }</span>
<a href="#l6.135"></a><span id="l6.135"> </span>
<a href="#l6.136"></a><span id="l6.136"> PRInt32 nsPop3Protocol::AuthNtlmResponse()</span>
<a href="#l6.137"></a><span id="l6.137"> {</span>
<a href="#l6.138"></a><span id="l6.138">     // need the test to be here instead in NextAuthStep() to</span>
<a href="#l6.139"></a><span id="l6.139">     // differentiate between command AUTH NTLM failed and</span>
<a href="#l6.140"></a><span id="l6.140">     // sending username using NTLM mechanism failed.</span>
<a href="#l6.141"></a><span id="l6.141">     if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineat">@@ -2051,17 +2051,17 @@ PRInt32 nsPop3Protocol::AuthGSSAPI()</span>
<a href="#l6.143"></a><span id="l6.143">         nsresult rv;</span>
<a href="#l6.144"></a><span id="l6.144">         server-&gt;GetRealHostName(hostName);</span>
<a href="#l6.145"></a><span id="l6.145">         service.Append(hostName);</span>
<a href="#l6.146"></a><span id="l6.146">         rv = DoGSSAPIStep1(service.get(), m_username.get(), cmd);</span>
<a href="#l6.147"></a><span id="l6.147">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.148"></a><span id="l6.148">             m_GSSAPICache.Assign(cmd);</span>
<a href="#l6.149"></a><span id="l6.149">             m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_FIRST;</span>
<a href="#l6.150"></a><span id="l6.150">             m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-            return SendData(m_url, &quot;AUTH GSSAPI&quot; CRLF);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+            return SendData(&quot;AUTH GSSAPI&quot; CRLF);</span>
<a href="#l6.153"></a><span id="l6.153">         }</span>
<a href="#l6.154"></a><span id="l6.154">     }</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156">     MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l6.157"></a><span id="l6.157">     m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l6.158"></a><span id="l6.158">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l6.159"></a><span id="l6.159">     return NS_OK;</span>
<a href="#l6.160"></a><span id="l6.160"> }</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineat">@@ -2080,31 +2080,31 @@ PRInt32 nsPop3Protocol::AuthGSSAPIRespon</span>
<a href="#l6.162"></a><span id="l6.162"> </span>
<a href="#l6.163"></a><span id="l6.163">     nsresult rv;</span>
<a href="#l6.164"></a><span id="l6.164"> </span>
<a href="#l6.165"></a><span id="l6.165">     m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_STEP;</span>
<a href="#l6.166"></a><span id="l6.166">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168">     if (first) {</span>
<a href="#l6.169"></a><span id="l6.169">         m_GSSAPICache += CRLF;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-        rv = SendData(m_url, m_GSSAPICache.get());</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+        rv = SendData(m_GSSAPICache.get());</span>
<a href="#l6.172"></a><span id="l6.172">         m_GSSAPICache.Truncate();</span>
<a href="#l6.173"></a><span id="l6.173">     }</span>
<a href="#l6.174"></a><span id="l6.174">     else {</span>
<a href="#l6.175"></a><span id="l6.175">         nsCAutoString cmd;</span>
<a href="#l6.176"></a><span id="l6.176">         PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;GSSAPI step 2&quot;));</span>
<a href="#l6.177"></a><span id="l6.177">         rv = DoGSSAPIStep2(m_commandResponse, cmd);</span>
<a href="#l6.178"></a><span id="l6.178">         if (NS_FAILED(rv))</span>
<a href="#l6.179"></a><span id="l6.179">             cmd = &quot;*&quot;;</span>
<a href="#l6.180"></a><span id="l6.180">         if (rv == NS_SUCCESS_AUTH_FINISHED) {</span>
<a href="#l6.181"></a><span id="l6.181">             m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l6.182"></a><span id="l6.182">             m_password_already_sent = true;</span>
<a href="#l6.183"></a><span id="l6.183">         }</span>
<a href="#l6.184"></a><span id="l6.184">         cmd += CRLF;</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-        rv = SendData(m_url, cmd.get());</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+        rv = SendData(cmd.get());</span>
<a href="#l6.187"></a><span id="l6.187">     }</span>
<a href="#l6.188"></a><span id="l6.188"> </span>
<a href="#l6.189"></a><span id="l6.189">     return rv;</span>
<a href="#l6.190"></a><span id="l6.190"> }</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192"> PRInt32 nsPop3Protocol::SendUsername()</span>
<a href="#l6.193"></a><span id="l6.193"> {</span>
<a href="#l6.194"></a><span id="l6.194">     PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendUsername()&quot;));</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineat">@@ -2153,17 +2153,17 @@ PRInt32 nsPop3Protocol::SendUsername()</span>
<a href="#l6.196"></a><span id="l6.196">     }</span>
<a href="#l6.197"></a><span id="l6.197"> </span>
<a href="#l6.198"></a><span id="l6.198">     cmd += CRLF;</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200">     m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l6.201"></a><span id="l6.201"> </span>
<a href="#l6.202"></a><span id="l6.202">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.203"></a><span id="l6.203"> </span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-    return SendData(m_url, cmd.get());</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+    return SendData(cmd.get());</span>
<a href="#l6.206"></a><span id="l6.206"> }</span>
<a href="#l6.207"></a><span id="l6.207"> </span>
<a href="#l6.208"></a><span id="l6.208"> PRInt32 nsPop3Protocol::SendPassword()</span>
<a href="#l6.209"></a><span id="l6.209"> {</span>
<a href="#l6.210"></a><span id="l6.210">   PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendPassword()&quot;));</span>
<a href="#l6.211"></a><span id="l6.211">   if (m_username.IsEmpty())</span>
<a href="#l6.212"></a><span id="l6.212">     return(Error(POP3_USERNAME_UNDEFINED));</span>
<a href="#l6.213"></a><span id="l6.213"> </span>
<a href="#l6.214"></a><span id="l6.214" class="difflineat">@@ -2309,33 +2309,33 @@ PRInt32 nsPop3Protocol::SendPassword()</span>
<a href="#l6.215"></a><span id="l6.215">   //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217">   m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l6.218"></a><span id="l6.218"> </span>
<a href="#l6.219"></a><span id="l6.219">   m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.220"></a><span id="l6.220"> </span>
<a href="#l6.221"></a><span id="l6.221">   m_password_already_sent = true;</span>
<a href="#l6.222"></a><span id="l6.222">   m_lastPasswordSent = m_passwordResult;</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  return SendData(m_url, cmd.get(), true);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+  return SendData(cmd.get(), true);</span>
<a href="#l6.225"></a><span id="l6.225"> }</span>
<a href="#l6.226"></a><span id="l6.226"> </span>
<a href="#l6.227"></a><span id="l6.227"> PRInt32 nsPop3Protocol::SendStatOrGurl(bool sendStat)</span>
<a href="#l6.228"></a><span id="l6.228"> {</span>
<a href="#l6.229"></a><span id="l6.229">   nsCAutoString cmd;</span>
<a href="#l6.230"></a><span id="l6.230">   if (sendStat)</span>
<a href="#l6.231"></a><span id="l6.231">   {</span>
<a href="#l6.232"></a><span id="l6.232">     cmd  = &quot;STAT&quot; CRLF;</span>
<a href="#l6.233"></a><span id="l6.233">     m_pop3ConData-&gt;next_state_after_response = POP3_GET_STAT;</span>
<a href="#l6.234"></a><span id="l6.234">   }</span>
<a href="#l6.235"></a><span id="l6.235">   else</span>
<a href="#l6.236"></a><span id="l6.236">   {</span>
<a href="#l6.237"></a><span id="l6.237">     cmd = &quot;GURL&quot; CRLF;</span>
<a href="#l6.238"></a><span id="l6.238">     m_pop3ConData-&gt;next_state_after_response = POP3_GURL_RESPONSE;</span>
<a href="#l6.239"></a><span id="l6.239">   }</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-  return SendData(m_url, cmd.get());</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+  return SendData(cmd.get());</span>
<a href="#l6.242"></a><span id="l6.242"> }</span>
<a href="#l6.243"></a><span id="l6.243"> </span>
<a href="#l6.244"></a><span id="l6.244"> </span>
<a href="#l6.245"></a><span id="l6.245"> PRInt32</span>
<a href="#l6.246"></a><span id="l6.246"> nsPop3Protocol::SendStat()</span>
<a href="#l6.247"></a><span id="l6.247"> {</span>
<a href="#l6.248"></a><span id="l6.248">   return SendStatOrGurl(true);</span>
<a href="#l6.249"></a><span id="l6.249"> }</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineat">@@ -2480,17 +2480,17 @@ PRInt32 nsPop3Protocol::SendList()</span>
<a href="#l6.251"></a><span id="l6.251"> </span>
<a href="#l6.252"></a><span id="l6.252"> </span>
<a href="#l6.253"></a><span id="l6.253">     m_pop3ConData-&gt;msg_info = (Pop3MsgInfo *)</span>
<a href="#l6.254"></a><span id="l6.254">       PR_CALLOC(sizeof(Pop3MsgInfo) * m_pop3ConData-&gt;number_of_messages);</span>
<a href="#l6.255"></a><span id="l6.255">     if (!m_pop3ConData-&gt;msg_info)</span>
<a href="#l6.256"></a><span id="l6.256">         return(MK_OUT_OF_MEMORY);</span>
<a href="#l6.257"></a><span id="l6.257">     m_pop3ConData-&gt;next_state_after_response = POP3_GET_LIST;</span>
<a href="#l6.258"></a><span id="l6.258">     m_listpos = 0;</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-    return SendData(m_url, &quot;LIST&quot;CRLF);</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+    return SendData(&quot;LIST&quot;CRLF);</span>
<a href="#l6.261"></a><span id="l6.261"> }</span>
<a href="#l6.262"></a><span id="l6.262"> </span>
<a href="#l6.263"></a><span id="l6.263"> </span>
<a href="#l6.264"></a><span id="l6.264"> </span>
<a href="#l6.265"></a><span id="l6.265"> PRInt32</span>
<a href="#l6.266"></a><span id="l6.266"> nsPop3Protocol::GetList(nsIInputStream* inputStream,</span>
<a href="#l6.267"></a><span id="l6.267">                         PRUint32 length)</span>
<a href="#l6.268"></a><span id="l6.268"> {</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineat">@@ -2654,17 +2654,17 @@ PRInt32 nsPop3Protocol::HandleNoUidListA</span>
<a href="#l6.270"></a><span id="l6.270"> */</span>
<a href="#l6.271"></a><span id="l6.271"> PRInt32 nsPop3Protocol::SendXtndXlstMsgid()</span>
<a href="#l6.272"></a><span id="l6.272"> {</span>
<a href="#l6.273"></a><span id="l6.273">   if (TestCapFlag(POP3_HAS_XTND_XLST | POP3_XTND_XLST_UNDEFINED))</span>
<a href="#l6.274"></a><span id="l6.274">   {</span>
<a href="#l6.275"></a><span id="l6.275">     m_pop3ConData-&gt;next_state_after_response = POP3_GET_XTND_XLST_MSGID;</span>
<a href="#l6.276"></a><span id="l6.276">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.277"></a><span id="l6.277">     m_listpos = 0;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-    return SendData(m_url, &quot;XTND XLST Message-Id&quot; CRLF);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    return SendData(&quot;XTND XLST Message-Id&quot; CRLF);</span>
<a href="#l6.280"></a><span id="l6.280">   }</span>
<a href="#l6.281"></a><span id="l6.281">   else</span>
<a href="#l6.282"></a><span id="l6.282">     return HandleNoUidListAvailable();</span>
<a href="#l6.283"></a><span id="l6.283"> }</span>
<a href="#l6.284"></a><span id="l6.284"> </span>
<a href="#l6.285"></a><span id="l6.285"> </span>
<a href="#l6.286"></a><span id="l6.286"> /* km</span>
<a href="#l6.287"></a><span id="l6.287">  *</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineat">@@ -2780,17 +2780,17 @@ nsPop3Protocol::GetXtndXlstMsgid(nsIInpu</span>
<a href="#l6.289"></a><span id="l6.289"> </span>
<a href="#l6.290"></a><span id="l6.290"> PRInt32 nsPop3Protocol::SendUidlList()</span>
<a href="#l6.291"></a><span id="l6.291"> {</span>
<a href="#l6.292"></a><span id="l6.292">     if (TestCapFlag(POP3_HAS_UIDL | POP3_UIDL_UNDEFINED))</span>
<a href="#l6.293"></a><span id="l6.293">     {</span>
<a href="#l6.294"></a><span id="l6.294">       m_pop3ConData-&gt;next_state_after_response = POP3_GET_UIDL_LIST;</span>
<a href="#l6.295"></a><span id="l6.295">       m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l6.296"></a><span id="l6.296">       m_listpos = 0;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-      return SendData(m_url,&quot;UIDL&quot; CRLF);</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+      return SendData(&quot;UIDL&quot; CRLF);</span>
<a href="#l6.299"></a><span id="l6.299">     }</span>
<a href="#l6.300"></a><span id="l6.300">     else</span>
<a href="#l6.301"></a><span id="l6.301">       return SendXtndXlstMsgid();</span>
<a href="#l6.302"></a><span id="l6.302"> }</span>
<a href="#l6.303"></a><span id="l6.303"> </span>
<a href="#l6.304"></a><span id="l6.304"> </span>
<a href="#l6.305"></a><span id="l6.305"> PRInt32 nsPop3Protocol::GetUidlList(nsIInputStream* inputStream,</span>
<a href="#l6.306"></a><span id="l6.306">                             PRUint32 length)</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineat">@@ -3200,32 +3200,32 @@ PRInt32 nsPop3Protocol::SendTop()</span>
<a href="#l6.308"></a><span id="l6.308">    {</span>
<a href="#l6.309"></a><span id="l6.309">      m_pop3ConData-&gt;next_state_after_response = POP3_TOP_RESPONSE;</span>
<a href="#l6.310"></a><span id="l6.310">      m_pop3ConData-&gt;cur_msg_size = -1;</span>
<a href="#l6.311"></a><span id="l6.311"> </span>
<a href="#l6.312"></a><span id="l6.312">      /* zero the bytes received in message in preparation for</span>
<a href="#l6.313"></a><span id="l6.313">      * the next</span>
<a href="#l6.314"></a><span id="l6.314">      */</span>
<a href="#l6.315"></a><span id="l6.315">      m_bytesInMsgReceived = 0;</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-     status = SendData(m_url,cmd);</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+     status = SendData(cmd);</span>
<a href="#l6.318"></a><span id="l6.318">    }</span>
<a href="#l6.319"></a><span id="l6.319">    PR_Free(cmd);</span>
<a href="#l6.320"></a><span id="l6.320">    return status;</span>
<a href="#l6.321"></a><span id="l6.321"> }</span>
<a href="#l6.322"></a><span id="l6.322"> </span>
<a href="#l6.323"></a><span id="l6.323"> /* send the xsender command</span>
<a href="#l6.324"></a><span id="l6.324">  */</span>
<a href="#l6.325"></a><span id="l6.325"> PRInt32 nsPop3Protocol::SendXsender()</span>
<a href="#l6.326"></a><span id="l6.326"> {</span>
<a href="#l6.327"></a><span id="l6.327">   char * cmd = PR_smprintf(&quot;XSENDER %ld&quot; CRLF, m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l6.328"></a><span id="l6.328">   PRInt32 status = -1;</span>
<a href="#l6.329"></a><span id="l6.329">   if (cmd)</span>
<a href="#l6.330"></a><span id="l6.330">   {</span>
<a href="#l6.331"></a><span id="l6.331">     m_pop3ConData-&gt;next_state_after_response = POP3_XSENDER_RESPONSE;</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-    status = SendData(m_url, cmd);</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+    status = SendData(cmd);</span>
<a href="#l6.334"></a><span id="l6.334">     PR_Free(cmd);</span>
<a href="#l6.335"></a><span id="l6.335">   }</span>
<a href="#l6.336"></a><span id="l6.336">   return status;</span>
<a href="#l6.337"></a><span id="l6.337"> }</span>
<a href="#l6.338"></a><span id="l6.338"> </span>
<a href="#l6.339"></a><span id="l6.339"> PRInt32 nsPop3Protocol::XsenderResponse()</span>
<a href="#l6.340"></a><span id="l6.340"> {</span>
<a href="#l6.341"></a><span id="l6.341">     m_pop3ConData-&gt;seenFromHeader = false;</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineat">@@ -3281,17 +3281,17 @@ nsPop3Protocol::SendRetr()</span>
<a href="#l6.343"></a><span id="l6.343">                           m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l6.344"></a><span id="l6.344">                           finalString);</span>
<a href="#l6.345"></a><span id="l6.345"> </span>
<a href="#l6.346"></a><span id="l6.346">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't format string&quot;);</span>
<a href="#l6.347"></a><span id="l6.347">       if (m_statusFeedback)</span>
<a href="#l6.348"></a><span id="l6.348">         m_statusFeedback-&gt;ShowStatusString(finalString);</span>
<a href="#l6.349"></a><span id="l6.349">     }</span>
<a href="#l6.350"></a><span id="l6.350"> </span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    status = SendData(m_url, cmd);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+    status = SendData(cmd);</span>
<a href="#l6.353"></a><span id="l6.353">   } // if cmd</span>
<a href="#l6.354"></a><span id="l6.354">   PR_Free(cmd);</span>
<a href="#l6.355"></a><span id="l6.355">   return status;</span>
<a href="#l6.356"></a><span id="l6.356"> }</span>
<a href="#l6.357"></a><span id="l6.357"> </span>
<a href="#l6.358"></a><span id="l6.358"> /* digest the message</span>
<a href="#l6.359"></a><span id="l6.359">  */</span>
<a href="#l6.360"></a><span id="l6.360"> PRInt32</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineat">@@ -3640,17 +3640,17 @@ PRInt32 nsPop3Protocol::SendDele()</span>
<a href="#l6.362"></a><span id="l6.362">     /* increment the last accessed message since we have now read it</span>
<a href="#l6.363"></a><span id="l6.363">      */</span>
<a href="#l6.364"></a><span id="l6.364">     char * cmd = PR_smprintf(&quot;DELE %ld&quot; CRLF, m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l6.365"></a><span id="l6.365">     m_pop3ConData-&gt;last_accessed_msg++;</span>
<a href="#l6.366"></a><span id="l6.366">     PRInt32 status = -1;</span>
<a href="#l6.367"></a><span id="l6.367">     if (cmd)</span>
<a href="#l6.368"></a><span id="l6.368">     {</span>
<a href="#l6.369"></a><span id="l6.369">       m_pop3ConData-&gt;next_state_after_response = POP3_DELE_RESPONSE;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-      status = SendData(m_url, cmd);</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+      status = SendData(cmd);</span>
<a href="#l6.372"></a><span id="l6.372">     }</span>
<a href="#l6.373"></a><span id="l6.373">     PR_Free(cmd);</span>
<a href="#l6.374"></a><span id="l6.374">     return status;</span>
<a href="#l6.375"></a><span id="l6.375"> }</span>
<a href="#l6.376"></a><span id="l6.376"> </span>
<a href="#l6.377"></a><span id="l6.377"> PRInt32 nsPop3Protocol::DeleResponse()</span>
<a href="#l6.378"></a><span id="l6.378"> {</span>
<a href="#l6.379"></a><span id="l6.379">   Pop3UidlHost *host = NULL;</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineat">@@ -4054,17 +4054,17 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l6.381"></a><span id="l6.381">                                               m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l6.382"></a><span id="l6.382">                                               statusString);</span>
<a href="#l6.383"></a><span id="l6.383">             if (NS_SUCCEEDED(rv))</span>
<a href="#l6.384"></a><span id="l6.384">               UpdateStatusWithString(statusString.get());</span>
<a href="#l6.385"></a><span id="l6.385">           }</span>
<a href="#l6.386"></a><span id="l6.386">         }</span>
<a href="#l6.387"></a><span id="l6.387">       }</span>
<a href="#l6.388"></a><span id="l6.388"> </span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-      status = SendData(mailnewsurl, &quot;QUIT&quot; CRLF);</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+      status = SendData(&quot;QUIT&quot; CRLF);</span>
<a href="#l6.391"></a><span id="l6.391">       m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l6.392"></a><span id="l6.392">       m_pop3ConData-&gt;next_state_after_response = POP3_QUIT_RESPONSE;</span>
<a href="#l6.393"></a><span id="l6.393">       break;</span>
<a href="#l6.394"></a><span id="l6.394"> </span>
<a href="#l6.395"></a><span id="l6.395">     case POP3_QUIT_RESPONSE:</span>
<a href="#l6.396"></a><span id="l6.396">       if(m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l6.397"></a><span id="l6.397">       {</span>
<a href="#l6.398"></a><span id="l6.398">       /*  the QUIT succeeded.  We can now flush the state in popstate.dat which</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -338,17 +338,17 @@ private:</span>
<a href="#l7.4"></a><span id="l7.4">   PRInt32  m_totalFolderSize;</span>
<a href="#l7.5"></a><span id="l7.5">   PRInt32  m_totalDownloadSize; /* Number of bytes we're going to</span>
<a href="#l7.6"></a><span id="l7.6">                                     download.  Might be much less</span>
<a href="#l7.7"></a><span id="l7.7">                                     than the total_folder_size. */</span>
<a href="#l7.8"></a><span id="l7.8">   PRInt32 m_totalBytesReceived; // total # bytes received for the connection</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l7.11"></a><span id="l7.11">                                         PRUint32 sourceOffset, PRUint32 length);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  virtual PRInt32 SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   virtual const char* GetType() {return &quot;pop3&quot;;}</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">   nsCOMPtr&lt;nsIURI&gt; m_url;</span>
<a href="#l7.18"></a><span id="l7.18">   nsCOMPtr&lt;nsIPop3Sink&gt; m_nsIPop3Sink;</span>
<a href="#l7.19"></a><span id="l7.19">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; m_pop3Server;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   nsMsgLineStreamBuffer   * m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1310,26 +1310,26 @@ nsNNTPProtocol::ParseURL(nsIURI *aURL, n</span>
<a href="#l8.4"></a><span id="l8.4"> }</span>
<a href="#l8.5"></a><span id="l8.5"> /*</span>
<a href="#l8.6"></a><span id="l8.6">  * Writes the data contained in dataBuffer into the current output stream. It also informs</span>
<a href="#l8.7"></a><span id="l8.7">  * the transport layer that this data is now available for transmission.</span>
<a href="#l8.8"></a><span id="l8.8">  * Returns a positive number for success, 0 for failure (not all the bytes were written to the</span>
<a href="#l8.9"></a><span id="l8.9">  * stream, etc). We need to make another pass through this file to install an error system (mscott)</span>
<a href="#l8.10"></a><span id="l8.10">  */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-PRInt32 nsNNTPProtocol::SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+nsresult nsNNTPProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l8.14"></a><span id="l8.14"> {</span>
<a href="#l8.15"></a><span id="l8.15">     if (!aSuppressLogging) {</span>
<a href="#l8.16"></a><span id="l8.16">         NNTP_LOG_WRITE(dataBuffer);</span>
<a href="#l8.17"></a><span id="l8.17">     }</span>
<a href="#l8.18"></a><span id="l8.18">     else {</span>
<a href="#l8.19"></a><span id="l8.19">         PR_LOG(NNTP, out, (&quot;(%p) Logging suppressed for this command (it probably contained authentication information)&quot;, this));</span>
<a href="#l8.20"></a><span id="l8.20">     }</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  return nsMsgProtocol::SendData(aURL, dataBuffer); // base class actually transmits the data</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  return nsMsgProtocol::SendData(dataBuffer); // base class actually transmits the data</span>
<a href="#l8.24"></a><span id="l8.24"> }</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> /* gets the response code from the nntp server and the</span>
<a href="#l8.27"></a><span id="l8.27">  * response line</span>
<a href="#l8.28"></a><span id="l8.28">  *</span>
<a href="#l8.29"></a><span id="l8.29">  * returns the TCP return code from the read</span>
<a href="#l8.30"></a><span id="l8.30">  */</span>
<a href="#l8.31"></a><span id="l8.31"> PRInt32 nsNNTPProtocol::NewsResponse(nsIInputStream * inputStream, PRUint32 length)</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineat">@@ -1410,20 +1410,18 @@ PRInt32 nsNNTPProtocol::LoginResponse()</span>
<a href="#l8.33"></a><span id="l8.33">   m_nntpServer-&gt;SetPostingAllowed(postingAllowed);</span>
<a href="#l8.34"></a><span id="l8.34">   m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l8.35"></a><span id="l8.35">   return(0);  /* good */</span>
<a href="#l8.36"></a><span id="l8.36"> }</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> PRInt32 nsNNTPProtocol::SendModeReader()</span>
<a href="#l8.39"></a><span id="l8.39"> {</span>
<a href="#l8.40"></a><span id="l8.40">   nsresult rv = NS_OK;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL,&amp;rv);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  rv = SendData(mailnewsurl, NNTP_CMD_MODE_READER);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  rv = SendData(NNTP_CMD_MODE_READER);</span>
<a href="#l8.47"></a><span id="l8.47">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.48"></a><span id="l8.48">     m_nextStateAfterResponse = NNTP_SEND_MODE_READER_RESPONSE;</span>
<a href="#l8.49"></a><span id="l8.49">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.52"></a><span id="l8.52">     return rv;</span>
<a href="#l8.53"></a><span id="l8.53"> }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineat">@@ -1455,19 +1453,17 @@ PRInt32 nsNNTPProtocol::SendModeReaderRe</span>
<a href="#l8.56"></a><span id="l8.56">   }</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">   return(0);</span>
<a href="#l8.59"></a><span id="l8.59"> }</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61"> PRInt32 nsNNTPProtocol::SendListExtensions()</span>
<a href="#l8.62"></a><span id="l8.62"> {</span>
<a href="#l8.63"></a><span id="l8.63">   PRInt32 status = 0;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-  if (url)</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    status = SendData(url, NNTP_CMD_LIST_EXTENSIONS);</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  status = SendData(NNTP_CMD_LIST_EXTENSIONS);</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.70"></a><span id="l8.70">   m_nextStateAfterResponse = SEND_LIST_EXTENSIONS_RESPONSE;</span>
<a href="#l8.71"></a><span id="l8.71">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.72"></a><span id="l8.72">   return status;</span>
<a href="#l8.73"></a><span id="l8.73"> }</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75"> PRInt32 nsNNTPProtocol::SendListExtensionsResponse(nsIInputStream * inputStream, PRUint32 length)</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineat">@@ -1516,19 +1512,17 @@ PRInt32 nsNNTPProtocol::SendListSearches</span>
<a href="#l8.77"></a><span id="l8.77"> {</span>
<a href="#l8.78"></a><span id="l8.78">     nsresult rv;</span>
<a href="#l8.79"></a><span id="l8.79">     bool searchable=false;</span>
<a href="#l8.80"></a><span id="l8.80">   PRInt32 status = 0;</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82">     rv = m_nntpServer-&gt;QueryExtension(&quot;SEARCH&quot;,&amp;searchable);</span>
<a href="#l8.83"></a><span id="l8.83">     if (NS_SUCCEEDED(rv) &amp;&amp; searchable)</span>
<a href="#l8.84"></a><span id="l8.84">   {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-      status = SendData(mailnewsurl, NNTP_CMD_LIST_SEARCHES);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    status = SendData(NNTP_CMD_LIST_SEARCHES);</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.91"></a><span id="l8.91">     m_nextStateAfterResponse = SEND_LIST_SEARCHES_RESPONSE;</span>
<a href="#l8.92"></a><span id="l8.92">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.93"></a><span id="l8.93">   }</span>
<a href="#l8.94"></a><span id="l8.94">   else</span>
<a href="#l8.95"></a><span id="l8.95">   {</span>
<a href="#l8.96"></a><span id="l8.96">     /* since SEARCH isn't supported, move on to GET */</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineat">@@ -1581,19 +1575,17 @@ PRInt32 nsNNTPProtocol::SendListSearches</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99">   PR_FREEIF(line);</span>
<a href="#l8.100"></a><span id="l8.100">   return status;</span>
<a href="#l8.101"></a><span id="l8.101"> }</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103"> PRInt32 nsNNTPProtocol::SendListSearchHeaders()</span>
<a href="#l8.104"></a><span id="l8.104"> {</span>
<a href="#l8.105"></a><span id="l8.105">   PRInt32 status = 0;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-    status = SendData(mailnewsurl, NNTP_CMD_LIST_SEARCH_FIELDS);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+  status = SendData(NNTP_CMD_LIST_SEARCH_FIELDS);</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.112"></a><span id="l8.112">   m_nextStateAfterResponse = NNTP_LIST_SEARCH_HEADERS_RESPONSE;</span>
<a href="#l8.113"></a><span id="l8.113">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   return status;</span>
<a href="#l8.116"></a><span id="l8.116"> }</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118" class="difflineat">@@ -1628,19 +1620,17 @@ PRInt32 nsNNTPProtocol::GetProperties()</span>
<a href="#l8.119"></a><span id="l8.119"> {</span>
<a href="#l8.120"></a><span id="l8.120">     nsresult rv;</span>
<a href="#l8.121"></a><span id="l8.121">     bool setget=false;</span>
<a href="#l8.122"></a><span id="l8.122">   PRInt32 status = 0;</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124">     rv = m_nntpServer-&gt;QueryExtension(&quot;SETGET&quot;,&amp;setget);</span>
<a href="#l8.125"></a><span id="l8.125">     if (NS_SUCCEEDED(rv) &amp;&amp; setget)</span>
<a href="#l8.126"></a><span id="l8.126">   {</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-      status = SendData(mailnewsurl, NNTP_CMD_GET_PROPERTIES);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    status = SendData(NNTP_CMD_GET_PROPERTIES);</span>
<a href="#l8.131"></a><span id="l8.131">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.132"></a><span id="l8.132">     m_nextStateAfterResponse = NNTP_GET_PROPERTIES_RESPONSE;</span>
<a href="#l8.133"></a><span id="l8.133">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.134"></a><span id="l8.134">   }</span>
<a href="#l8.135"></a><span id="l8.135">   else</span>
<a href="#l8.136"></a><span id="l8.136">   {</span>
<a href="#l8.137"></a><span id="l8.137">     /* since GET isn't supported, move on LIST SUBSCRIPTIONS */</span>
<a href="#l8.138"></a><span id="l8.138">     m_nextState = SEND_LIST_SUBSCRIPTIONS;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineat">@@ -1697,19 +1687,17 @@ PRInt32 nsNNTPProtocol::SendListSubscrip</span>
<a href="#l8.140"></a><span id="l8.140">     nsresult rv;</span>
<a href="#l8.141"></a><span id="l8.141">     bool searchable=false;</span>
<a href="#l8.142"></a><span id="l8.142">     rv = m_nntpServer-&gt;QueryExtension(&quot;LISTSUBSCR&quot;,&amp;listsubscr);</span>
<a href="#l8.143"></a><span id="l8.143">     if (NS_SUCCEEDED(rv) &amp;&amp; listsubscr)</span>
<a href="#l8.144"></a><span id="l8.144"> #else</span>
<a href="#l8.145"></a><span id="l8.145">   if (0)</span>
<a href="#l8.146"></a><span id="l8.146"> #endif</span>
<a href="#l8.147"></a><span id="l8.147">   {</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-      status = SendData(mailnewsurl, NNTP_CMD_LIST_SUBSCRIPTIONS);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    status = SendData(NNTP_CMD_LIST_SUBSCRIPTIONS);</span>
<a href="#l8.152"></a><span id="l8.152">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.153"></a><span id="l8.153">     m_nextStateAfterResponse = SEND_LIST_SUBSCRIPTIONS_RESPONSE;</span>
<a href="#l8.154"></a><span id="l8.154">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.155"></a><span id="l8.155">   }</span>
<a href="#l8.156"></a><span id="l8.156">   else</span>
<a href="#l8.157"></a><span id="l8.157">   {</span>
<a href="#l8.158"></a><span id="l8.158">     /* since LIST SUBSCRIPTIONS isn't supported, move on to real work */</span>
<a href="#l8.159"></a><span id="l8.159">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineat">@@ -1905,21 +1893,19 @@ PRInt32 nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l8.161"></a><span id="l8.161">       NS_MsgSACat(&amp;command,&quot;&lt;&quot;);</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163">     NS_MsgSACat(&amp;command, m_messageID.get());</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165">     if (PL_strchr(command+8, '&gt;')==0)</span>
<a href="#l8.166"></a><span id="l8.166">       NS_MsgSACat(&amp;command,&quot;&gt;&quot;);</span>
<a href="#l8.167"></a><span id="l8.167">   }</span>
<a href="#l8.168"></a><span id="l8.168"> </span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-    NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-    status = SendData(mailnewsurl, command);</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-    PR_Free(command);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+  NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  status = SendData(command);</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  PR_Free(command);</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.179"></a><span id="l8.179">   if (m_typeWanted != SEARCH_WANTED)</span>
<a href="#l8.180"></a><span id="l8.180">     m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l8.181"></a><span id="l8.181">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.182"></a><span id="l8.182">     return(status);</span>
<a href="#l8.183"></a><span id="l8.183"> } /* sent first command */</span>
<a href="#l8.184"></a><span id="l8.184"> </span>
<a href="#l8.185"></a><span id="l8.185" class="difflineat">@@ -2072,19 +2058,17 @@ PRInt32 nsNNTPProtocol::SendGroupForArti</span>
<a href="#l8.186"></a><span id="l8.186"> </span>
<a href="#l8.187"></a><span id="l8.187">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l8.188"></a><span id="l8.188"> </span>
<a href="#l8.189"></a><span id="l8.189">   PR_snprintf(outputBuffer,</span>
<a href="#l8.190"></a><span id="l8.190">       OUTPUT_BUFFER_SIZE,</span>
<a href="#l8.191"></a><span id="l8.191">       &quot;GROUP %.512s&quot; CRLF,</span>
<a href="#l8.192"></a><span id="l8.192">       groupname.get());</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-    status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+  status = SendData(outputBuffer);</span>
<a href="#l8.198"></a><span id="l8.198"> </span>
<a href="#l8.199"></a><span id="l8.199">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.200"></a><span id="l8.200">   m_nextStateAfterResponse = NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE;</span>
<a href="#l8.201"></a><span id="l8.201">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.202"></a><span id="l8.202">   return(status);</span>
<a href="#l8.203"></a><span id="l8.203"> }</span>
<a href="#l8.204"></a><span id="l8.204"> </span>
<a href="#l8.205"></a><span id="l8.205"> nsresult</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineat">@@ -2118,19 +2102,17 @@ PRInt32 nsNNTPProtocol::SendGroupForArti</span>
<a href="#l8.207"></a><span id="l8.207"> </span>
<a href="#l8.208"></a><span id="l8.208"> </span>
<a href="#l8.209"></a><span id="l8.209"> PRInt32 nsNNTPProtocol::SendArticleNumber()</span>
<a href="#l8.210"></a><span id="l8.210"> {</span>
<a href="#l8.211"></a><span id="l8.211">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l8.212"></a><span id="l8.212">   PRInt32 status = 0;</span>
<a href="#l8.213"></a><span id="l8.213">   PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;ARTICLE %lu&quot; CRLF, m_key);</span>
<a href="#l8.214"></a><span id="l8.214"> </span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-    status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+  status = SendData(outputBuffer);</span>
<a href="#l8.219"></a><span id="l8.219"> </span>
<a href="#l8.220"></a><span id="l8.220">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.221"></a><span id="l8.221">     m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l8.222"></a><span id="l8.222">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224">     return(status);</span>
<a href="#l8.225"></a><span id="l8.225"> }</span>
<a href="#l8.226"></a><span id="l8.226"> </span>
<a href="#l8.227"></a><span id="l8.227" class="difflineat">@@ -2422,19 +2404,17 @@ PRInt32 nsNNTPProtocol::BeginAuthorizati</span>
<a href="#l8.228"></a><span id="l8.228">     return 0;</span>
<a href="#l8.229"></a><span id="l8.229">   }</span>
<a href="#l8.230"></a><span id="l8.230"> </span>
<a href="#l8.231"></a><span id="l8.231">   NS_MsgSACopy(&amp;command, &quot;AUTHINFO user &quot;);</span>
<a href="#l8.232"></a><span id="l8.232">   PR_LOG(NNTP, PR_LOG_ALWAYS,(&quot;(%p) use %s as the username&quot;, this, username.get()));</span>
<a href="#l8.233"></a><span id="l8.233">   NS_MsgSACat(&amp;command, username.get());</span>
<a href="#l8.234"></a><span id="l8.234">   NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l8.235"></a><span id="l8.235"> </span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-    status = SendData(mailnewsurl, command);</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+  status = SendData(command);</span>
<a href="#l8.240"></a><span id="l8.240"> </span>
<a href="#l8.241"></a><span id="l8.241">   PR_Free(command);</span>
<a href="#l8.242"></a><span id="l8.242"> </span>
<a href="#l8.243"></a><span id="l8.243">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.244"></a><span id="l8.244">   m_nextStateAfterResponse = NNTP_AUTHORIZE_RESPONSE;</span>
<a href="#l8.245"></a><span id="l8.245"> </span>
<a href="#l8.246"></a><span id="l8.246">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.247"></a><span id="l8.247"> </span>
<a href="#l8.248"></a><span id="l8.248" class="difflineat">@@ -2487,19 +2467,17 @@ PRInt32 nsNNTPProtocol::AuthorizationRes</span>
<a href="#l8.249"></a><span id="l8.249">     rv = m_newsFolder-&gt;GetGroupPassword(password);</span>
<a href="#l8.250"></a><span id="l8.250">     if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l8.251"></a><span id="l8.251">       return MK_NNTP_AUTH_FAILED;</span>
<a href="#l8.252"></a><span id="l8.252"> </span>
<a href="#l8.253"></a><span id="l8.253">     NS_MsgSACopy(&amp;command, &quot;AUTHINFO pass &quot;);</span>
<a href="#l8.254"></a><span id="l8.254">     NS_MsgSACat(&amp;command, password.get());</span>
<a href="#l8.255"></a><span id="l8.255">     NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l8.256"></a><span id="l8.256"> </span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-      status = SendData(mailnewsurl, command, true);</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    status = SendData(command, true);</span>
<a href="#l8.261"></a><span id="l8.261"> </span>
<a href="#l8.262"></a><span id="l8.262">     PR_FREEIF(command);</span>
<a href="#l8.263"></a><span id="l8.263"> </span>
<a href="#l8.264"></a><span id="l8.264">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.265"></a><span id="l8.265">     m_nextStateAfterResponse = NNTP_PASSWORD_RESPONSE;</span>
<a href="#l8.266"></a><span id="l8.266">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.267"></a><span id="l8.267"> </span>
<a href="#l8.268"></a><span id="l8.268">     return status;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineat">@@ -3177,19 +3155,17 @@ PRInt32 nsNNTPProtocol::XoverSend()</span>
<a href="#l8.270"></a><span id="l8.270">         &quot;XOVER %d-%d&quot; CRLF,</span>
<a href="#l8.271"></a><span id="l8.271">         m_firstArticle,</span>
<a href="#l8.272"></a><span id="l8.272">         m_lastArticle);</span>
<a href="#l8.273"></a><span id="l8.273"> </span>
<a href="#l8.274"></a><span id="l8.274">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.275"></a><span id="l8.275">     m_nextStateAfterResponse = NNTP_XOVER_RESPONSE;</span>
<a href="#l8.276"></a><span id="l8.276">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.277"></a><span id="l8.277"> </span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-    status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+  status = SendData(outputBuffer);</span>
<a href="#l8.282"></a><span id="l8.282">   return status;</span>
<a href="#l8.283"></a><span id="l8.283"> }</span>
<a href="#l8.284"></a><span id="l8.284"> </span>
<a href="#l8.285"></a><span id="l8.285"> /* see if the xover response is going to return us data</span>
<a href="#l8.286"></a><span id="l8.286">  * if the proper code isn't returned then assume xover</span>
<a href="#l8.287"></a><span id="l8.287">  * isn't supported and use</span>
<a href="#l8.288"></a><span id="l8.288">  * normal read_group</span>
<a href="#l8.289"></a><span id="l8.289">  */</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineat">@@ -3311,18 +3287,17 @@ PRInt32 nsNNTPProtocol::XhdrSend()</span>
<a href="#l8.291"></a><span id="l8.291">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l8.292"></a><span id="l8.292">   PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;XHDR %s %d-%d&quot; CRLF,</span>
<a href="#l8.293"></a><span id="l8.293">               header.get(), m_firstArticle, m_lastArticle);</span>
<a href="#l8.294"></a><span id="l8.294"> </span>
<a href="#l8.295"></a><span id="l8.295">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.296"></a><span id="l8.296">   m_nextStateAfterResponse = NNTP_XHDR_RESPONSE;</span>
<a href="#l8.297"></a><span id="l8.297">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.298"></a><span id="l8.298"> </span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-  return mailnewsurl ? SendData(mailnewsurl, outputBuffer) : 0;</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+  return SendData(outputBuffer);</span>
<a href="#l8.302"></a><span id="l8.302"> }</span>
<a href="#l8.303"></a><span id="l8.303"> </span>
<a href="#l8.304"></a><span id="l8.304"> PRInt32 nsNNTPProtocol::XhdrResponse(nsIInputStream *inputStream)</span>
<a href="#l8.305"></a><span id="l8.305"> {</span>
<a href="#l8.306"></a><span id="l8.306">   if (m_responseCode != MK_NNTP_RESPONSE_XHDR_OK)</span>
<a href="#l8.307"></a><span id="l8.307">   {</span>
<a href="#l8.308"></a><span id="l8.308">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l8.309"></a><span id="l8.309">     // The reasoning behind setting this flag and not an XHDR flag is that we</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineat">@@ -3388,21 +3363,17 @@ PRInt32 nsNNTPProtocol::ReadHeaders()</span>
<a href="#l8.311"></a><span id="l8.311">     PR_snprintf(outputBuffer,</span>
<a href="#l8.312"></a><span id="l8.312">       OUTPUT_BUFFER_SIZE,</span>
<a href="#l8.313"></a><span id="l8.313">       &quot;HEAD %ld&quot; CRLF,</span>
<a href="#l8.314"></a><span id="l8.314">       m_articleNumber++);</span>
<a href="#l8.315"></a><span id="l8.315">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.316"></a><span id="l8.316">     m_nextStateAfterResponse = NNTP_READ_GROUP_RESPONSE;</span>
<a href="#l8.317"></a><span id="l8.317"> </span>
<a href="#l8.318"></a><span id="l8.318">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-      return SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-    else</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-      return 0;</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+    return SendData(outputBuffer);</span>
<a href="#l8.325"></a><span id="l8.325">   }</span>
<a href="#l8.326"></a><span id="l8.326"> }</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328"> /* See if the &quot;HEAD&quot; command was successful</span>
<a href="#l8.329"></a><span id="l8.329"> */</span>
<a href="#l8.330"></a><span id="l8.330"> </span>
<a href="#l8.331"></a><span id="l8.331"> PRInt32 nsNNTPProtocol::ReadNewsgroupResponse()</span>
<a href="#l8.332"></a><span id="l8.332"> {</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineat">@@ -3550,18 +3521,17 @@ PRInt32 nsNNTPProtocol::PostMessageInFil</span>
<a href="#l8.334"></a><span id="l8.334"> </span>
<a href="#l8.335"></a><span id="l8.335">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.336"></a><span id="l8.336"> </span>
<a href="#l8.337"></a><span id="l8.337">     // for now, we are always done at this point..we aren't making multiple</span>
<a href="#l8.338"></a><span id="l8.338">     // calls to post data...</span>
<a href="#l8.339"></a><span id="l8.339"> </span>
<a href="#l8.340"></a><span id="l8.340">     // always issue a '.' and CRLF when we are done...</span>
<a href="#l8.341"></a><span id="l8.341">     PL_strcpy(m_dataBuf, &quot;.&quot; CRLF);</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-    if (url)</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-      SendData(url, m_dataBuf);</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+    SendData(m_dataBuf);</span>
<a href="#l8.345"></a><span id="l8.345"> #ifdef UNREADY_CODE</span>
<a href="#l8.346"></a><span id="l8.346">     NET_Progress(CE_WINDOW_ID,</span>
<a href="#l8.347"></a><span id="l8.347">                  XP_GetString(XP_MESSAGE_SENT_WAITING_MAIL_REPLY));</span>
<a href="#l8.348"></a><span id="l8.348"> #endif /* UNREADY_CODE */</span>
<a href="#l8.349"></a><span id="l8.349">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.350"></a><span id="l8.350">     m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l8.351"></a><span id="l8.351">     return(0);</span>
<a href="#l8.352"></a><span id="l8.352"> }</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineat">@@ -3618,19 +3588,17 @@ PRInt32 nsNNTPProtocol::CheckForArticle(</span>
<a href="#l8.354"></a><span id="l8.354">      posting attempt (which is already in ce-&gt;URL_s-&gt;error_msg). */</span>
<a href="#l8.355"></a><span id="l8.355">   return MK_NNTP_ERROR_MESSAGE;</span>
<a href="#l8.356"></a><span id="l8.356">   }</span>
<a href="#l8.357"></a><span id="l8.357"> }</span>
<a href="#l8.358"></a><span id="l8.358"> </span>
<a href="#l8.359"></a><span id="l8.359"> PRInt32 nsNNTPProtocol::StartCancel()</span>
<a href="#l8.360"></a><span id="l8.360"> {</span>
<a href="#l8.361"></a><span id="l8.361">   PRInt32 status = 0;</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-    status = SendData(mailnewsurl, NNTP_CMD_POST);</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+  status = SendData(NNTP_CMD_POST);</span>
<a href="#l8.366"></a><span id="l8.366"> </span>
<a href="#l8.367"></a><span id="l8.367">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.368"></a><span id="l8.368">   m_nextStateAfterResponse = NEWS_DO_CANCEL;</span>
<a href="#l8.369"></a><span id="l8.369">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.370"></a><span id="l8.370">   return (status);</span>
<a href="#l8.371"></a><span id="l8.371"> }</span>
<a href="#l8.372"></a><span id="l8.372"> </span>
<a href="#l8.373"></a><span id="l8.373"> bool nsNNTPProtocol::CheckIfAuthor(nsISupports *aElement, void *data)</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineat">@@ -3866,19 +3834,17 @@ reported here */</span>
<a href="#l8.375"></a><span id="l8.375">                        &quot;References: %s&quot; CRLF</span>
<a href="#l8.376"></a><span id="l8.376">                        &quot;%s&quot; /* otherHeaders, already with CRLF */</span>
<a href="#l8.377"></a><span id="l8.377">                        CRLF /* body separator */</span>
<a href="#l8.378"></a><span id="l8.378">                        &quot;%s&quot; /* body, already with CRLF */</span>
<a href="#l8.379"></a><span id="l8.379">                        &quot;.&quot; CRLF, /* trailing message terminator &quot;.&quot; */</span>
<a href="#l8.380"></a><span id="l8.380">                        cancelInfo.from.get(), newsgroups, subject, id,</span>
<a href="#l8.381"></a><span id="l8.381">                        otherHeaders.get(), body);</span>
<a href="#l8.382"></a><span id="l8.382"> </span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-      status = SendData(mailnewsurl, data);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+    status = SendData(data);</span>
<a href="#l8.387"></a><span id="l8.387">     PR_Free (data);</span>
<a href="#l8.388"></a><span id="l8.388">     if (status &lt; 0) {</span>
<a href="#l8.389"></a><span id="l8.389">       nsCAutoString errorText;</span>
<a href="#l8.390"></a><span id="l8.390">       errorText.AppendInt(status);</span>
<a href="#l8.391"></a><span id="l8.391">       AlertError(MK_TCP_WRITE_ERROR, errorText.get());</span>
<a href="#l8.392"></a><span id="l8.392">       failure = true;</span>
<a href="#l8.393"></a><span id="l8.393">       goto FAIL;</span>
<a href="#l8.394"></a><span id="l8.394">     }</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineat">@@ -3935,19 +3901,17 @@ PRInt32 nsNNTPProtocol::XPATSend()</span>
<a href="#l8.396"></a><span id="l8.396">     endOfTerm = PL_strchr(command, '/');</span>
<a href="#l8.397"></a><span id="l8.397">     if (endOfTerm)</span>
<a href="#l8.398"></a><span id="l8.398">       *endOfTerm = '\0';</span>
<a href="#l8.399"></a><span id="l8.399">     NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l8.400"></a><span id="l8.400"> </span>
<a href="#l8.401"></a><span id="l8.401">     unescapedCommand = MSG_UnEscapeSearchUrl(command);</span>
<a href="#l8.402"></a><span id="l8.402"> </span>
<a href="#l8.403"></a><span id="l8.403">     /* send one term off to the server */</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-      status = SendData(mailnewsurl, unescapedCommand);</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+    status = SendData(unescapedCommand);</span>
<a href="#l8.408"></a><span id="l8.408"> </span>
<a href="#l8.409"></a><span id="l8.409">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.410"></a><span id="l8.410">     m_nextStateAfterResponse = NNTP_XPAT_RESPONSE;</span>
<a href="#l8.411"></a><span id="l8.411">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.412"></a><span id="l8.412"> </span>
<a href="#l8.413"></a><span id="l8.413">     PR_Free(command);</span>
<a href="#l8.414"></a><span id="l8.414">     PR_Free(unescapedCommand);</span>
<a href="#l8.415"></a><span id="l8.415">   }</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineat">@@ -4030,19 +3994,17 @@ PRInt32 nsNNTPProtocol::ListPrettyNames(</span>
<a href="#l8.417"></a><span id="l8.417">   PRInt32 status = 0;</span>
<a href="#l8.418"></a><span id="l8.418"> </span>
<a href="#l8.419"></a><span id="l8.419">   m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l8.420"></a><span id="l8.420">   PR_snprintf(outputBuffer,</span>
<a href="#l8.421"></a><span id="l8.421">     OUTPUT_BUFFER_SIZE,</span>
<a href="#l8.422"></a><span id="l8.422">     &quot;LIST PRETTYNAMES %.512s&quot; CRLF,</span>
<a href="#l8.423"></a><span id="l8.423">     group_name.get());</span>
<a href="#l8.424"></a><span id="l8.424"> </span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-    status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+  status = SendData(outputBuffer);</span>
<a href="#l8.429"></a><span id="l8.429">   NNTP_LOG_NOTE(outputBuffer);</span>
<a href="#l8.430"></a><span id="l8.430">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.431"></a><span id="l8.431">   m_nextStateAfterResponse = NNTP_LIST_PRETTY_NAMES_RESPONSE;</span>
<a href="#l8.432"></a><span id="l8.432"> </span>
<a href="#l8.433"></a><span id="l8.433">   return status;</span>
<a href="#l8.434"></a><span id="l8.434"> }</span>
<a href="#l8.435"></a><span id="l8.435"> </span>
<a href="#l8.436"></a><span id="l8.436"> PRInt32 nsNNTPProtocol::ListPrettyNamesResponse(nsIInputStream * inputStream, PRUint32 length)</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineat">@@ -4124,19 +4086,17 @@ PRInt32 nsNNTPProtocol::ListXActive()</span>
<a href="#l8.438"></a><span id="l8.438">   PRInt32 status = 0;</span>
<a href="#l8.439"></a><span id="l8.439">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l8.440"></a><span id="l8.440"> </span>
<a href="#l8.441"></a><span id="l8.441">   PR_snprintf(outputBuffer,</span>
<a href="#l8.442"></a><span id="l8.442">     OUTPUT_BUFFER_SIZE,</span>
<a href="#l8.443"></a><span id="l8.443">     &quot;LIST XACTIVE %.512s&quot; CRLF,</span>
<a href="#l8.444"></a><span id="l8.444">     group_name.get());</span>
<a href="#l8.445"></a><span id="l8.445"> </span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-    status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+  status = SendData(outputBuffer);</span>
<a href="#l8.450"></a><span id="l8.450"> </span>
<a href="#l8.451"></a><span id="l8.451">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.452"></a><span id="l8.452">   m_nextStateAfterResponse = NNTP_LIST_XACTIVE_RESPONSE;</span>
<a href="#l8.453"></a><span id="l8.453"> </span>
<a href="#l8.454"></a><span id="l8.454">   return status;</span>
<a href="#l8.455"></a><span id="l8.455"> }</span>
<a href="#l8.456"></a><span id="l8.456"> </span>
<a href="#l8.457"></a><span id="l8.457"> PRInt32 nsNNTPProtocol::ListXActiveResponse(nsIInputStream * inputStream, PRUint32 length)</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineat">@@ -4281,19 +4241,17 @@ PRInt32 nsNNTPProtocol::SendListGroup()</span>
<a href="#l8.459"></a><span id="l8.459">     newsgroupName.get());</span>
<a href="#l8.460"></a><span id="l8.460"> </span>
<a href="#l8.461"></a><span id="l8.461">   m_articleList = do_CreateInstance(NS_NNTPARTICLELIST_CONTRACTID, &amp;rv);</span>
<a href="#l8.462"></a><span id="l8.462">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.463"></a><span id="l8.463"> </span>
<a href="#l8.464"></a><span id="l8.464">   rv = m_articleList-&gt;Initialize(m_newsFolder);</span>
<a href="#l8.465"></a><span id="l8.465">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.466"></a><span id="l8.466"> </span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-  if (mailnewsurl)</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-    status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+  status = SendData(outputBuffer);</span>
<a href="#l8.471"></a><span id="l8.471"> </span>
<a href="#l8.472"></a><span id="l8.472">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l8.473"></a><span id="l8.473">   m_nextStateAfterResponse = NNTP_LIST_GROUP_RESPONSE;</span>
<a href="#l8.474"></a><span id="l8.474">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l8.475"></a><span id="l8.475"> </span>
<a href="#l8.476"></a><span id="l8.476">   return status;</span>
<a href="#l8.477"></a><span id="l8.477"> }</span>
<a href="#l8.478"></a><span id="l8.478"> </span>
<a href="#l8.479"></a><span id="l8.479" class="difflineat">@@ -4797,17 +4755,17 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l8.480"></a><span id="l8.480">   } /* end big while */</span>
<a href="#l8.481"></a><span id="l8.481"> </span>
<a href="#l8.482"></a><span id="l8.482">   return NS_OK; /* keep going */</span>
<a href="#l8.483"></a><span id="l8.483"> }</span>
<a href="#l8.484"></a><span id="l8.484"> </span>
<a href="#l8.485"></a><span id="l8.485"> NS_IMETHODIMP nsNNTPProtocol::CloseConnection()</span>
<a href="#l8.486"></a><span id="l8.486"> {</span>
<a href="#l8.487"></a><span id="l8.487">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) ClosingConnection&quot;,this));</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-  SendData(nsnull, NNTP_CMD_QUIT); // this will cause OnStopRequest get called, which will call CloseSocket()</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+  SendData(NNTP_CMD_QUIT); // this will cause OnStopRequest get called, which will call CloseSocket()</span>
<a href="#l8.490"></a><span id="l8.490">   // break some cycles</span>
<a href="#l8.491"></a><span id="l8.491">   CleanupNewsgroupList();</span>
<a href="#l8.492"></a><span id="l8.492"> </span>
<a href="#l8.493"></a><span id="l8.493">   if (m_nntpServer) {</span>
<a href="#l8.494"></a><span id="l8.494">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l8.495"></a><span id="l8.495">     m_nntpServer = nsnull;</span>
<a href="#l8.496"></a><span id="l8.496">   }</span>
<a href="#l8.497"></a><span id="l8.497">   CloseSocket();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -204,17 +204,17 @@ private:</span>
<a href="#l9.4"></a><span id="l9.4">    * advised to suspend the request before using this state.</span>
<a href="#l9.5"></a><span id="l9.5">    */</span>
<a href="#l9.6"></a><span id="l9.6">   virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l9.7"></a><span id="l9.7">     PRUint32 sourceOffset, PRUint32 length);</span>
<a href="#l9.8"></a><span id="l9.8">   virtual nsresult CloseSocket();</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   // we have our own implementation of SendData which writes to the nntp log</span>
<a href="#l9.11"></a><span id="l9.11">   // and then calls the base class to transmit the data</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  PRInt32 SendData(nsIURI * aURL, const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   nsresult CleanupAfterRunningUrl();</span>
<a href="#l9.16"></a><span id="l9.16">   void Cleanup(); //free char* member variables</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   void ParseHeaderForCancel(char *buf);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   virtual const char* GetType() {return &quot;nntp&quot;;}</span>
<a href="#l9.21"></a><span id="l9.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

