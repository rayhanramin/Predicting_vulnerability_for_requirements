<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2569:58ff5d78d1d48d387abe22bc4be6cc80a8a59887</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 58ff5d78d1d48d387abe22bc4be6cc80a8a59887" />
<meta property="og:url" content="/comm-central/rev/58ff5d78d1d48d387abe22bc4be6cc80a8a59887" />
<meta property="og:description" content="Bug 474701 - new search entry in default mail toolbar. v2 view wrapper abstraction with many unit tests. r/sr=bienvenu." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 58ff5d78d1d48d387abe22bc4be6cc80a8a59887 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/58ff5d78d1d48d387abe22bc4be6cc80a8a59887">shortlog</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/58ff5d78d1d48d387abe22bc4be6cc80a8a59887">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887">files</a> |
changeset |
<a href="/comm-central/raw-rev/58ff5d78d1d48d387abe22bc4be6cc80a8a59887">raw</a>  | <a href="/comm-central/archive/58ff5d78d1d48d387abe22bc4be6cc80a8a59887.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474701">Bug 474701</a> - new search entry in default mail toolbar. v2 view wrapper abstraction with many unit tests. r/sr=bienvenu.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 06 May 2009 00:39:35 -0700</td></tr>

<tr>
 <td>changeset 2569</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/58ff5d78d1d48d387abe22bc4be6cc80a8a59887">58ff5d78d1d48d387abe22bc4be6cc80a8a59887</a></td>
</tr>



<tr>
<td>parent 2568</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/89407652b9a1cd8021efe506fd1b79fe6bb41d7e">89407652b9a1cd8021efe506fd1b79fe6bb41d7e</a>
</td>
</tr>

<tr>
<td>child 2570</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6e3d055f97889c8117b7ddf56a27a52c372fc263">6e3d055f97889c8117b7ddf56a27a52c372fc263</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=58ff5d78d1d48d387abe22bc4be6cc80a8a59887">2091</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 06 May 2009 07:39:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6e3d055f9788 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6e3d055f97889c8117b7ddf56a27a52c372fc263">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6e3d055f97889c8117b7ddf56a27a52c372fc263&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6e3d055f97889c8117b7ddf56a27a52c372fc263&newProject=comm-central&newRevision=58ff5d78d1d48d387abe22bc4be6cc80a8a59887&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6e3d055f97889c8117b7ddf56a27a52c372fc263&newProject=comm-central&newRevision=58ff5d78d1d48d387abe22bc4be6cc80a8a59887&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6e3d055f97889c8117b7ddf56a27a52c372fc263&newProject=comm-central&newRevision=58ff5d78d1d48d387abe22bc4be6cc80a8a59887&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474701">474701</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474701">Bug 474701</a> - new search entry in default mail toolbar. v2 view wrapper abstraction with many unit tests. r/sr=bienvenu.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/resources/content/virtualFolderProperties.js">mailnews/base/resources/content/virtualFolderProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/resources/content/virtualFolderProperties.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/resources/content/virtualFolderProperties.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/resources/content/virtualFolderProperties.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/resources/content/virtualFolderProperties.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/resources/content/virtualFolderProperties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/Makefile.in">mailnews/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/dbViewWrapper.js">mailnews/base/src/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/mailViewManager.js">mailnews/base/src/mailViewManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/mailViewManager.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/mailViewManager.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/mailViewManager.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/mailViewManager.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/mailViewManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/quickSearchManager.js">mailnews/base/src/quickSearchManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/quickSearchManager.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/quickSearchManager.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/quickSearchManager.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/quickSearchManager.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/quickSearchManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/searchSpec.js">mailnews/base/src/searchSpec.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/searchSpec.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/searchSpec.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/searchSpec.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/searchSpec.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/searchSpec.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/virtualFolderWrapper.js">mailnews/base/src/virtualFolderWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/virtualFolderWrapper.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/virtualFolderWrapper.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/virtualFolderWrapper.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/virtualFolderWrapper.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/src/virtualFolderWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_logic.js">mailnews/base/test/unit/test_viewWrapper_logic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_logic.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_logic.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_logic.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_logic.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_logic.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_realFolder.js">mailnews/base/test/unit/test_viewWrapper_realFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_realFolder.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_realFolder.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_realFolder.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_realFolder.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_realFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/util/iteratorUtils.jsm">mailnews/base/util/iteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/util/iteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/util/iteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/util/iteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/util/iteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/base/util/iteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/db/gloda/modules/gloda.js">mailnews/db/gloda/modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/db/gloda/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/db/gloda/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/db/gloda/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/db/gloda/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/db/gloda/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/asyncTestUtils.js">mailnews/test/resources/asyncTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/asyncTestUtils.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/asyncTestUtils.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/asyncTestUtils.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/asyncTestUtils.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/asyncTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageGenerator.js">mailnews/test/resources/messageGenerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageGenerator.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageGenerator.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageGenerator.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageGenerator.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageGenerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageModifier.js">mailnews/test/resources/messageModifier.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageModifier.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageModifier.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageModifier.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageModifier.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/messageModifier.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/viewWrapperTestUtils.js">mailnews/test/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/mailnews/test/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/suite/mailnews/commandglue.js">suite/mailnews/commandglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/suite/mailnews/commandglue.js">file</a> |
<a href="/comm-central/annotate/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/suite/mailnews/commandglue.js">annotate</a> |
<a href="/comm-central/diff/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/suite/mailnews/commandglue.js">diff</a> |
<a href="/comm-central/comparison/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/suite/mailnews/commandglue.js">comparison</a> |
<a href="/comm-central/log/58ff5d78d1d48d387abe22bc4be6cc80a8a59887/suite/mailnews/commandglue.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/resources/content/virtualFolderProperties.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/resources/content/virtualFolderProperties.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,16 +32,18 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.6"></a><span id="l1.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.7"></a><span id="l1.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.8"></a><span id="l1.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.9"></a><span id="l1.9">  *</span>
<a href="#l1.10"></a><span id="l1.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Component.utils.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> var gPickedFolder;</span>
<a href="#l1.15"></a><span id="l1.15"> var gMailView = null;</span>
<a href="#l1.16"></a><span id="l1.16"> var msgWindow; // important, don't change the name of this variable. it's really a global used by commandglue.js</span>
<a href="#l1.17"></a><span id="l1.17"> var gSearchTermSession; // really an in memory temporary filter we use to read in and write out the search terms</span>
<a href="#l1.18"></a><span id="l1.18"> var gSearchFolderURIs = &quot;&quot;;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> function onLoad()</span>
<a href="#l1.21"></a><span id="l1.21"> {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -225,17 +227,19 @@ function onOK()</span>
<a href="#l1.23"></a><span id="l1.23">         Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.24"></a><span id="l1.24">                   .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l1.25"></a><span id="l1.25">       promptService.alert(window, null,</span>
<a href="#l1.26"></a><span id="l1.26">                           messengerBundle.getString('folderExists'));</span>
<a href="#l1.27"></a><span id="l1.27">       return false;</span>
<a href="#l1.28"></a><span id="l1.28">     }</span>
<a href="#l1.29"></a><span id="l1.29">     </span>
<a href="#l1.30"></a><span id="l1.30">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    CreateVirtualFolder(name, parentFolder, gSearchFolderURIs, gSearchTermSession.searchTerms, searchOnline);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    VirtualFolderHelper.createVirtualFolder(</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      name, parentFolder, gSearchFolderURIs, gSearchTermSession.searchTerms,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      searchOnline);</span>
<a href="#l1.35"></a><span id="l1.35">   }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   return true;</span>
<a href="#l1.38"></a><span id="l1.38"> }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40"> function onCancel()</span>
<a href="#l1.41"></a><span id="l1.41"> {</span>
<a href="#l1.42"></a><span id="l1.42">   // close the window</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -170,16 +170,24 @@ DEFINES         += -DMOZ_LDAP_XPCOM</span>
<a href="#l2.4"></a><span id="l2.4"> endif</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> EXPORTS = \</span>
<a href="#l2.7"></a><span id="l2.7"> 		nsMsgRDFDataSource.h \</span>
<a href="#l2.8"></a><span id="l2.8"> 		nsMsgRDFUtils.h \</span>
<a href="#l2.9"></a><span id="l2.9"> 		nsMailDirServiceDefs.h \</span>
<a href="#l2.10"></a><span id="l2.10"> 		$(NULL)</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+		dbViewWrapper.js \</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+		mailViewManager.js \</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+		quickSearchManager.js \</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+		searchSpec.js \</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+		virtualFolderWrapper.js \</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+		$(NULL)</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20"> # we don't want the shared lib, but we want to force the creation of a static lib.</span>
<a href="#l2.21"></a><span id="l2.21"> FORCE_STATIC_LIB = 1</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> ifdef MOZ_MOVEMAIL</span>
<a href="#l2.26"></a><span id="l2.26"> DEFINES	+= -DHAVE_MOVEMAIL</span>
<a href="#l2.27"></a><span id="l2.27"> endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,1206 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ *</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ *</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ *</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+EXPORTED_SYMBOLS = ['DBViewWrapper', 'IDBViewWrapperListener'];</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+Cu.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+Cu.import(&quot;resource://app/modules/searchSpec.js&quot;);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+Cu.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+const nsMsgViewType = Ci.nsMsgViewType;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+const nsMsgViewFlagsType = Ci.nsMsgViewFlagsType;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+const nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+/**</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+ * Helper singleton for DBViewWrapper that tells instances when something</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+ *  interesting is happening to the folder(s) they care about.  The rationale</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+ *  for this is to:</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+ * - reduce listener overhead (although arguably the events we listen to are</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ *     fairly rare)</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+ * - make testing / verification easier by centralizing and exposing listeners.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+ *</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+ */</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+var FolderNotificationHelper = {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  /**</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+   * Maps URIs of pending folder loads to the DBViewWrapper instances that</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+   *  are waiting on the loads.  The value is a list of instances in case</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+   *  a quick-clicking user is able to do something unexpected.</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+   */</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  _pendingFolderUriToViewWrapperLists: {},</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  /**</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+   * Map URIs of folders to view wrappers interested in hearing about their</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+   *  deletion.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+   */</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  _interestedWrappers: {},</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  /**</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+   * Initialize our listeners.  We currently don't bother cleaning these up</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+   *  because we are a singleton and if anyone imports us, they probably want</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+   *  us for as long as their application so shall live.</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+   */</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  _init: function FolderNotificationHelper__init() {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    let atomService =</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+      Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+        .getService(Ci.nsIAtomService);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+      this._kFolderLoadedAtom = atomService.getAtom(&quot;FolderLoaded&quot;);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    // register with the session for our folded loaded notifications</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    let mailSession =</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+      Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    mailSession.AddFolderListener(this,</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+                                  Ci.nsIFolderListener.event);</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    // register with the notification service for deleted folder notifications</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+    let notificationService =</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+      Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+        .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+    notificationService.addListener(this,</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+      Ci.nsIMsgFolderNotificationService.folderDeleted |</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+      // we need to track renames because we key off of URIs. frick.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+      Ci.nsIMsgFolderNotificationService.folderRenamed |</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+      Ci.nsIMsgFolderNotificationService.folderMoveCopyCompleted);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  },</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  /**</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+   * Call updateFolder, and assuming all goes well, request that the provided</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+   *  FolderDisplayWidget be notified when the folder is loaded.  This method</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+   *  performs the updateFolder call for you so there is less chance of leaking.</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+   * In the event the updateFolder call fails, we will propagate the exception.</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+   */</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  updateFolderAndNotifyOnLoad:</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+      function FolderNotificationHelper_notifyOnLoad(aFolder,</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+                                                     aFolderDisplay,</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+                                                     aMsgWindow) {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+    // set up our datastructure first in case of wacky event sequences</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    let folderURI = aFolder.URI;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+    let wrappers = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    if (wrappers == null)</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+      wrappers = this._pendingFolderUriToViewWrapperLists[folderURI] = [];</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+    wrappers.push(aFolderDisplay);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+    try {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+      aFolder.updateFolder(aMsgWindow);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+    }</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+    catch (ex) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+      // uh-oh, that didn't work.  tear down the data structure...</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+      wrappers.pop();</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+      if (wrappers.length == 0)</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+        delete this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      throw ex;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    }</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  },</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  /**</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+   * Request notification of every little thing these folders do.</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+   *</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+   * @param aFolders The folders.</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+   * @param aNotherFolder A folder that may or may not be in aFolders.</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+   * @param aViewWrapper The view wrapper that is up to no good.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+   */</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  stalkFolders: function FolderNotificationHelper_stalkFolders(</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+      aFolders, aNotherFolder, aViewWrapper) {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+    let folders = aFolders.concat();</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+    if (aNotherFolder &amp;&amp; folders.indexOf(aNotherFolder) == -1)</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+      folders.push(aNotherFolder);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    for each (let [, folder] in Iterator(aFolders)) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+      let wrappers = this._interestedWrappers[folder.URI];</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+      if (wrappers == null)</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+        wrappers = this._interestedWrappers[folder.URI] = [];</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+      wrappers.push(aViewWrapper);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+    }</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  },</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  /**</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+   * Removal helper for use by removeNotifications.</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+   *</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+   * @param aTable The table mapping URIs to list of view wrappers.</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+   * @param aFolder The folder we care about.</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+   * @param aViewWrapper The view wrapper of interest.</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+   */</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  _removeWrapperFromListener: function(aTable, aFolder, aViewWrapper) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+    let wrappers = aTable[aFolder.URI];</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+    if (wrappers) {</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+      let index = wrappers.indexOf(aViewWrapper);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+      if (index &gt;= 0)</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+      wrappers.splice(index, 1);</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+      if (wrappers.length == 0)</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+        delete aTable[aFolder.URI];</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    }</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+  },</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+  /**</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+   * Remove notification requests on the provided folders by the given view</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+   *  wrapper.</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+   */</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  removeNotifications: function FolderNotificationHelper_removeNotifications(</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+      aFolders, aViewWrapper) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+    for each (let [, folder] in Iterator(aFolders)) {</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+      this._removeWrapperFromListener(</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+        this._interestedWrappers, folder, aViewWrapper);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+      this._removeWrapperFromListener(</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+        this._pendingFolderUriToViewWrapperLists, folder, aViewWrapper);</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    }</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  },</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+  /**</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+   * @return true if there are any listeners still registered.  This is intended</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+   *     to support debugging code.  If you are not debug code, you are a bad</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+   *     person/code.</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+   */</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  haveListeners: function FolderNotificationHelper_haveListeners() {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+    for each (let [folderURI, wrappers] in</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+              Iterator(this._pendingFolderUriToViewWrapperLists)) {</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+      return true;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+    }</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    for each (let [folderURI, wrappers] in</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+              Iterator(this._interestedWrappers)) {</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+      return true;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+    }</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+    return false;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  },</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+  /* ***** Notifications ***** */</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+      aFolder, aEvent) {</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+    if (aEvent == this._kFolderLoadedAtom) {</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+      let folderURI = aFolder.URI;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+      let widgets = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+      if (widgets) {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+        for each (let [, widget] in Iterator(widgets)) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+          // we are friends, this is an explicit relationship.</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+          // (we don't use a generic callback mechanism because the 'this' stuff</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+          //  gets ugly and no one else should be hooking in at this level.)</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+          try {</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+            widget._folderLoaded(aFolder);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+          }</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+          catch (ex) {</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+            dump(&quot;``` EXCEPTION DURING NOTIFY: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+                 ex.lineNumber + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+          }</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+        }</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+        delete this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+      }</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+    }</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+  },</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+  _folderMoveHelper: function(aOldFolder, aNewFolder) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+    let oldURI = aOldFolder.URI;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+    let newURI = aNewFolder.URI;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    // fix up our listener tables.</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+    if (oldURI in this._pendingFolderUriToViewWrapperLists) {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+      this._pendingFolderUriToViewWrapperLists[newURI] =</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+        this._pendingFolderUriToViewWrapperLists[oldURI];</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+      delete this._pendingFolderUriToViewWrapperLists[oldURI];</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+    }</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+    if (oldURI in this._interestedWrappers) {</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+      this._interestedWrappers[newURI] =</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+        this._interestedWrappers[oldURI];</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      delete this._interestedWrappers[oldURI];</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+    }</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+    let wrappers = this._interestedWrappers[newURI];</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+    if (wrappers) {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+      // clone the list to avoid confusing mutation by listeners</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+      for each (let [, wrapper] in Iterator(wrappers.concat())) {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+        wrapper._folderMoved(aOldFolder, aNewFolder);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+      }</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+      // if the folder is deleted, it's not going to get deleted again.</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+      delete this._interestedWrappers[aFolder.URI];</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+    }</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  },</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  /**</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+   * Update our URI mapping tables when renames happen.</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+   */</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  folderRenamed: function FolderNotificationHelper_folderRenamed(aOrigFolder,</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+                                                                 aNewFolder) {</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+    this._folderMoveHelper(aOrigFolder, aNewFolder);</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  },</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  folderMoveCopyCompleted:</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+      function FolderNotificationHelper_folderMoveCopyCompleted(aMove,</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+                                                                aSrcFolder,</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+                                                                aDestFolder) {</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+     if (aMove) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+       let aNewFolder = aDestFolder.getChildNamed(aSrcFolder.prettyName);</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+       this._folderMoveHelper(aSrcFolder, aNewFolder);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+     }</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+  },</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  folderDeleted: function FolderNotificationHelper_folderDeleted(aFolder) {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+    let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+    if (wrappers) {</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+      // clone the list to avoid confusing mutation by listeners</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+      for each (let [, wrapper] in Iterator(wrappers.concat())) {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+        wrapper._folderDeleted(aFolder);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+      }</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+      // if the folder is deleted, it's not going to get deleted again.</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+      delete this._interestedWrappers[aFolder.URI];</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+    }</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+  },</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+};</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+FolderNotificationHelper._init();</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+/**</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+ * Defines the DBViewWrapper listener interface.  This class exists exclusively</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+ *  for documentation purposes and should never be instantiated.</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+ */</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+function IDBViewWrapperListener() {</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+}</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+IDBViewWrapperListener.prototype = {</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+  // uh, this is secretly exposed for debug purposes.  DO NOT LOOK AT ME!</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+  _FNH: FolderNotificationHelper,</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+  /* ===== Exposure of UI Globals ===== */</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+  messenger: null,</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+  msgWindow: null,</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  threadPaneCommandUpdater: null,</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  /* ===== Guidance ===== */</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+  /**</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+   * Indicate whether mail view settings should be used/honored.  A UI oddity</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+   *  is that we only have mail views be sticky if its combo box UI is visible.</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+   *  (Without the view combobox, it may not be obvious that the mail is</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+   *  filtered.)</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+   */</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+  get shouldUseMailViews() {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+    return false;</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+  },</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+  /**</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+   * Should we defer displaying the messages in this folder until after we have</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+   *  talked to the server?  This is for our poor man's password protection</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+   *  via the &quot;mail.password_protect_local_cache&quot; pref.  We add this specific</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+   *  check rather than internalizing the logic in the wrapper because the</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+   *  password protection is a shoddy UI-only protection.</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+   */</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+  get shouldDeferMessageDisplayUntilAfterServerConnect() {</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+    return false;</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  },</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+  /**</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+   * Should we mark all messages in a folder as read on exit?</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+   * This is nominally controlled by the &quot;mailnews.mark_message_read.SERVERTYPE&quot;</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+   *  preference (on a per-server-type basis).</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+   * For the record, this functionality should not remotely be in the core.</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+   *</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+   * @param aMsgFolder The folder we are leaving and are unsure if we should</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+   *     mark all its messages read.  I pass the folder instead of the server</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+   *     type because having a crazy feature like this will inevitably lead to</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+   *     a more full-featured crazy feature (why not on a per-folder basis, eh?)</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+   * @return true if we should mark all the dudes as read, false if not.</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+   */</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+  shouldMarkMessagesReadOnLeavingFolder: function (aMsgFolder) {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+    return false;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+  },</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+  /* ===== Event Notifications ===== */</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+  /* === Status Changes === */</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+  /**</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+   * We tell you when we start and stop loading the folder.  This is a good</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+   *  time to mess with the hour-glass cursor machinery if you are inclined to</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+   *  do so.</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+   */</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+  onFolderLoading: function (aIsFolderLoading) {</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+  },</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+  /**</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+   * We tell you when we start and stop searching.  This is a good time to mess</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+   *  with progress spinners (meteors) and the like, if you are so inclined.</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+   */</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+  onSearching: function (aIsSearching) {</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+  },</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+  /**</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+   * This event is generated when a new view has been created.  It is intended</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+   *  to be used to provide the MsgCreateDBView notification so that custom</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+   *  columns can add themselves to the view.</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+   * The notification is not generated by the DBViewWrapper itself because this</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+   *  is fundamentally a UI issue.  Additionally, because the MsgCreateDBView</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+   *  notification consumers assume gDBView whose exposure is affected by tabs,</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+   *  the tab logic needs to be involved.</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+   */</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+  onCreatedView: function() {</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+  },</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+  /**</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+   * Generated when the folder is being entered for display.  This is the chance</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+   *  for the listener to affect any UI-related changes to the folder required.</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+   *  Currently, this just means setting the header cache size (which needs to</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+   *  be proportional to the number of lines in the tree view, and is thus a</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+   *  UI issue.)</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+   */</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+  onDisplayingFolder: function() {</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+  },</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+  /**</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+   * Things to do once all the messages that should show up in a folder have</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+   *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+   *  For a (multi-folder) virtual folder, this happens when the search</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+   *  completes.</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+   */</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+  onAllMessagesLoaded: function() {</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+  },</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+  /**</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+   * The mail view changed.  The mail view widget is likely to care about this.</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+   */</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+  onMailViewChanged: function () {</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+  },</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+};</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+/**</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+ * Encapsulates everything related to working with our nsIMsgDBView</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+ *  implementations.</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+ */</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+function DBViewWrapper(aListener) {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+  this.displayedFolder = null;</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+  this.listener = aListener;</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+  this._underlyingData = this.kUnderlyingNone;</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+  this._underlyingFolders = null;</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  this._viewUpdateDepth = 0;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  this._mailViewIndex = MailViewConstants.kViewItemAll;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+  this._mailViewData = null;</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+  this._specialView = null;</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+  this._sort = [];</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+  this._viewFlags = 0;</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+  this.dbView = null;</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+  this.search = null;</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+  this._folderLoading = false;</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+  this._searching = false;</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+}</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+DBViewWrapper.prototype = {</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+  /* = constants explaining the nature of the underlying data = */</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+  /**</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+   * We currently don't have any underlying data.</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+   */</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+  kUnderlyingNone: 0,</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+  /**</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+   * The underlying data source is a single folder.</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+   */</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+  kUnderlyingRealFolder: 1,</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+  /**</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+   * The underlying data source is a virtual folder that is operating over</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+   *  multiple underlying folders.</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+   */</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+  kUnderlyingMultipleFolder: 2,</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+  /**</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+   * Our data source is transient, most likely a gloda search that crammed the</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+   *  results into us.</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+   */</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+  kUnderlyingSynthetic: 3,</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+  /**</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+   * @return true if the folder being displayed is backed by a single 'real'</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+   *     folder.  This folder can be a saved search on that folder or just</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+   *     an outright un-filtered display of that folder.</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+   */</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+  get isSingleFolder() {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+    return this._underlyingData == this.kUnderlyingRealFolder;</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+  },</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+  /**</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+   * @return true if the folder being displayed is a virtual folder backed by</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+   *     multiple 'real' folders.  This corresponds to a cross-folder saved</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+   *     search.</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+   */</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+  get isMultiFolder() {</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+    return this._underlyingData == this.kUnderlyingMultipleFolder;</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+  },</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+  /**</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+   * @return true if the folder being displayed is not a real folder at all,</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+   *     but rather the result of an un-scoped search, such as a gloda search.</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+   */</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+  get isSynthetic() {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+    return this._underlyingData == this.kUnderlyingSynthetic;</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+  },</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+  /**</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+   * Refresh the view by re-creating the view.  You would do this to get rid of</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+   *  messages that no longer match the view but are kept around for view</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+   *  stability reasons.  (In other words, in an unread-messages view, you would</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+   *  go insane if when you clicked on a message it immediately disappeared</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+   *  because it no longer matched.)</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+   * This method was adding for testing purposes and does not have a (legacy) UI</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+   *  reason for existing.  (The 'open' method is intended to behave identically</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+   *  to the legacy UI if you click on the currently displayed folder.)</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+   */</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+  refresh: function DBViewWrapper_refresh() {</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+  },</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+  /**</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+   * Close the current view.  You would only do this if you want to clean up all</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+   *  the resources associated with this view wrapper.  You would not do this</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+   *  for UI reasons like the user de-selecting the node in the tree; we should</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+   *  always be displaying something when used in a UI context!</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+   *</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+   * @param aFolderIsDead If true, tells us not to try and tidy up on our way</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+   *     out by virtue of the fact that the folder is dead and should not be</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+   *     messed with.</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+   */</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+  close: function DBViewWrapper_close(aFolderIsDead) {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+    if (this._underlyingFolders)</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+      FolderNotificationHelper.removeNotifications(this._underlyingFolders,</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+                                                   this);</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+    if (this.displayedFolder != null) {</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+      // onLeavingFolder does all the application-level stuff related to leaving</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+      //  the folder (marking as read, etc.)  We only do this when the folder</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+      //  is not dead (for obvious reasons).</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+      if (!aFolderIsDead)</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+        this.onLeavingFolder();</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+      this.displayedFolder = null;</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+      this.folderLoading = false;</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+    }</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+    // kill off the view and its search association</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+    if (this.dbView) {</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+      this.search.dissociateView(this.dbView);</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+      this.dbView.close();</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+      this.dbView = null;</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+    }</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+    this._underlyingData = this.kUnderlyingNone;</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+    this._underlyingFolders = null;</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+    this._mailViewIndex = MailViewConstants.kViewItemAll;</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+    this._mailViewData = null;</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+    this._specialView = null;</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+    this._sort = [];</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+    this._viewFlags = 0;</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+    this.search = null;</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+  },</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+  /**</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+   * Open the passed-in folder.</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+   */</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+  open: function DBViewWrapper_open(aFolder) {</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+    if (aFolder == null) {</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+      this.close();</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+      return;</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+    }</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+    // If we are in the same folder, there is nothing to do unless we are a</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+    //  virtual folder.  Virtual folders apparently want to try and get updated.</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+    if (this.displayedFolder == aFolder) {</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+      if (!this.isVirtual)</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+        return;</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+      // note: we intentionally (for consistency with old code, not that the</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+      //  code claimed to have a good reason) fall through here and call</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+      //  onLeavingFolder via close even though that's debatable in this case.</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+    }</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+    this.close();</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+    this.displayedFolder = aFolder;</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+    this._enteredFolder = false;</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+    this.search = new SearchSpec(this);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+    this._sortOrder = [];</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+    if (aFolder.isServer) {</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+      this._showServer();</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+      return;</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+    }</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+    this.beginViewUpdate();</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+    let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+    if (msgDatabase) {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+      let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+      // - retrieve persisted sort information</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+      this._sort = [[dbFolderInfo.sortType, dbFolderInfo.sortOrder]];</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+      // - retrieve persisted display settings</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+      this._viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+      // - retrieve virtual folder configuration</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+      if (aFolder.flags &amp; nsMsgFolderFlags.Virtual) {</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+        let virtFolder = VirtualFolderHelper.wrapVirtualFolder(aFolder);</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+        this._underlyingFolders = virtFolder.searchFolders;</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+        this._underlyingData = (this._underlyingFolders.length &gt; 1) ?</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+                               this.kUnderlyingMultipleFolder :</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+                               this.kUnderlyingRealFolder;</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+        // figure out if we are using online IMAP searching</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+        this.search.onlineSearch = virtFolder.onlineSearch;</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+        // retrieve and chew the search query</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+        this.search.virtualFolderTerms = virtFolder.searchTerms;</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+      }</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+      else {</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+        this._underlyingData = this.kUnderlyingRealFolder;</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+        this._underlyingFolders = [this.displayedFolder];</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+      }</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+      FolderNotificationHelper.stalkFolders(this._underlyingFolders,</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+                                            this.displayedFolder,</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+                                            this);</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+      // - retrieve mail view configuration</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+      if (this.listener.shouldUseMailViews) {</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+        // if there is a view tag (basically &quot;:tagname&quot;), then it's a</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+        //  mailview tag.  clearly.</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+        let mailViewTag = dbFolderInfo.getCharProperty(</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+                            MailViewConstants.kViewCurrentTag);</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+        if (mailViewTag &amp;&amp; mailViewTag != &quot;0&quot;) {</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineplus">+          // the tag gets stored with a &quot;:&quot; on the front, presumably done</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+          //  as a means of name-spacing that was never subsequently leveraged.</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+          if (mailViewTag[0] == &quot;:&quot;)</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+            mailViewTag = mailViewTag.substr(1);</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+          // (the true is so we don't persist)</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+          this.setMailView(MailViewConstants.kViewItemTags, mailViewTag, true);</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+        }</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+        // otherwise it's just an index. we kinda-sorta migrate from old-school</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+        //  $label tags, except someone reused one of the indices for</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+        //  kViewItemNotDeleted, which means that $label2 can no longer be</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+        //  migrated.</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+        else {</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+          let mailViewIndex = dbFolderInfo.getUint32Property(</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+                                MailViewConstants.kViewCurrent,</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+                                MailViewConstants.kViewItemAll);</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+          // label migration per above</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+          if ((mailViewIndex == MailViewConstants.kViewItemTags) ||</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+              ((MailViewConstants.kViewItemTags + 2 &lt;= mailViewIndex) &amp;&amp;</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+               (mailViewIndex &lt; MailViewConstants.kViewItemVirtual)))</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+            this.setMailView(MailViewConstants.kViewItemTags,</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+                             &quot;$label&quot; + (mailViewIndex-1));</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+          else</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+            this.setMailView(mailViewIndex);</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+        }</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+      }</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+    }</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+    if (this.shouldShowMessagesForFolderImmediately())</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+      this._enterFolder();</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+    this.folderLoading = true;</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+    if (!this.isVirtual)</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+      FolderNotificationHelper.updateFolderAndNotifyOnLoad(</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+        this.displayedFolder, this, this.listener.msgWindow);</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+  },</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+  get folderLoading() {</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+    return this._folderLoading;</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+  },</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+  set folderLoading(aFolderLoading) {</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+    if (this._folderLoading == aFolderLoading)</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+      return;</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+    this._folderLoading = aFolderLoading;</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+    this.listener.onFolderLoading(aFolderLoading);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineplus">+  },</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+  get searching() {</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+    return this._searching;</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineplus">+  },</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+  set searching(aSearching) {</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+    if (aSearching == this._searching)</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+      return;</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+    this._searching = aSearching;</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+    this.listener.onSearching(aSearching);</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+    // If we were searching but now are not, send an onAllMessagesLoaded</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+    //  notification.  This is the first time a virtual folder will see</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+    //  this message if this search is a result of opening the folder.</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+    if (!aSearching)</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+      this.listener.onAllMessagesLoaded();</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+  },</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+   /**</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+   * Do we want to show the messages immediately, or should we wait for</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+   *  updateFolder to complete?  The historical heuristic is:</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+   * - Virtual folders get shown immediately (and updateFolder has no</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+   *   meaning for them anyways.)</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+   * - A folder for which &quot;manyHeadersToDownload&quot; is true waits on</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+   *   updateFolder.  It will return true if the database does not yet exist</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+   *   (presumably because the user has never looked in the folder), or if the</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+   *   database exists and the number of total messages (current and pending)</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+   *   is &lt;= 0 (which I presume means no messages or a bunch pending</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+   *   deletion?)</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+   * - Wait on updateFolder if our poor man's security via</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+   *   &quot;mail.password_protect_local_cache&quot; preference is enabled and the</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+   *   server requires a password to login.  This is accomplished by asking our</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+   *   listener via shouldDeferMessageDisplayUntilAfterServerConnect.  Note that</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+   *   there is an obvious hole in this logic because of the virtual folder case</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+   *   above.</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+   *</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+   * @pre this.folderDisplayed is the folder we are talking about.</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+   *</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+   * @return true if the folder should be shown immediately, false if we should</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+   *     wait for updateFolder to complete.</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+   */</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+  shouldShowMessagesForFolderImmediately:</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+      function DBViewWrapper_showShowMessagesForFolderImmediately() {</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+    return (this.isVirtual ||</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineplus">+            !(this.displayedFolder.manyHeadersToDownload ||</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+              this.listener.shouldDeferMessageDisplayUntilAfterServerConnect));</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+  },</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+  /**</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+   * Creates a view appropriate to the current settings of the folder display</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+   *  widget, returning it.  The caller is responsible to assign the result to</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+   *  this.dbView (or whatever it wants to do with it.)</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+   */</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+  _createView: function DBViewWrapper__createView() {</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+    let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot;;</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+    let viewFlags = this._viewFlags;</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+    // real folders are subject to the most interest set of possibilities...</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+    if (this._underlyingData == this.kUnderlyingRealFolder) {</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+      // quick-search inherits from threaded which inherits from group, so this</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+      //  is right to choose it first.</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+      if (this.search.hasSearchTerms)</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+        dbviewContractId += &quot;quicksearch&quot;;</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+      else if (this.showGroupedBySort)</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+        dbviewContractId += &quot;group&quot;;</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+      else if (this.specialViewThreadsWithUnread)</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+        dbviewContractId += &quot;threadswithunread&quot;;</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+      else if (this.specialViewWatchedThreadsWithUnread)</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+        dbviewContractId += &quot;watchedthreadswithunread&quot;;</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+      else</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+        dbviewContractId += &quot;threaded&quot;;</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+    }</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+    // if we're dealing with virtual folders, the answer is always an xfvf</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+    else if (this._underlyingData == this.kUnderlyingMultipleFolder) {</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+      dbviewContractId += &quot;xfvf&quot;;</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+    }</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+    else if (this._underlyingData == this.kUnderlyingSynthetic) {</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+      dbviewContractId += &quot;search&quot;;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+    }</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+    let dbView = Cc[dbviewContractId]</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+                   .createInstance(Ci.nsIMsgDBView);</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+    dbView.init(this.listener.messenger, this.listener.msgWindow,</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+                this.listener.threadPaneCommandUpdater);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+    // use the least-specific sort so we can clock them back through to build up</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+    //  the correct sort order...</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+    let [sortType, sortOrder] = this._sort[this._sort.length-1];</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+    let outCount = {};</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+    // when the underlying folder is a single real folder (virtual or no), we</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+    //  tell the view about the underlying folder.</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+    if (this.isSingleFolder) {</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+      dbView.open(this._underlyingFolders[0], sortType, sortOrder, viewFlags,</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+                  outCount);</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+      // but if it's a virtual folder, we need to tell the db view about the</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+      //  the display (virtual) folder so it can store all the view-specific</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+      //  data there (things like the active mail view and such that go in</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+      //  dbFolderInfo.)</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+      if (this.isVirtual)</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+        dbView.viewFolder = this.displayedFolder;</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+    }</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+    // when we're dealing with a multi-folder virtual folder, we just tell the</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+    //  db view about the display folder.  (It gets its own XFVF view, so it</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+    //  knows what to do.)</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+    else {</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+      dbView.open(this.displayedFolder, sortType, sortOrder, viewFlags,</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+                  outCount);</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+    }</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+    // clock through the rest of the sorts, if there are any</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+    for (let iSort = this._sort.length - 2; iSort &gt;=0; iSort--) {</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+      [sortType, sortOrder] = this._sort[iSort];</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+      dbView.sort(sortType, sortOrder);</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+    }</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+    return dbView;</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+  },</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+  /**</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+   * Callback method invoked by FolderNotificationHelper when our folder is</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+   *  loaded.  Assuming we are still interested in the folder, we enter the</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+   *  folder via _enterFolder.</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+   */</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+  _folderLoaded: function DBViewWrapper__folderLoaded(aFolder) {</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+    if (aFolder == this.displayedFolder) {</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+      this.folderLoading = false;</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+      this._enterFolder();</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+    }</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+  },</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+  /**</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+   * Enter this.displayedFolder if we have not yet entered it.</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+   *</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+   * Things we do on entering a folder:</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+   * - clear the folder's biffState!</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+   * - set the message database's header cache size</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+   */</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+  _enterFolder: function DBViewWrapper__enterFolder() {</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+    if (this._enteredFolder)</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+      return;</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+    this.displayedFolder.biffState =</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+      Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+    this.listener.onDisplayingFolder();</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+    this.endViewUpdate();</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+    // Single folders get their notification immediately.  This covers both</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+    //  folders that are non-virtual folder as well as virtual folders backed by</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+    //  a single folder.  This leaves out cross-folder virtual folders and</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+    //  synthetic searches.</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+    if (this.isSingleFolder)</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+      this.listener.onAllMessagesLoaded();</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+    this._enteredFolder = true;</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+  },</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+  /**</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+   * Renames, moves to the trash, it's all crazy.  We have to update all our</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+   *  references when this happens.</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+   */</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+  _folderMoved: function DBViewWrapper__folderMoved(aOldFolder, aNewFolder) {</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+    if (aOldFolder == this.displayedFolder)</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+      this.displayedFolder = aNewFolder;</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+    // indexOf does't work for this (reliably)</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+    for each (let [i,underlyingFolder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+      if (aOldFolder == underlyingFolder) {</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+        this._underlyingFolders[i] = aNewFolder;</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+        break;</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+      }</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+    }</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+    // re-populate the view.</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+  },</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+  /**</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+   * FolderNotificationHelper tells us when folders we care about are deleted</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+   *  (because we asked it to in |open|).  If it was the folder we were</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+   *  displaying (real or virtual), this closes it.  If we are virtual and</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+   *  backed by a single folder, this closes us.  If we are backed by multiple</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+   *  folders, we just update ourselves.  (Currently, cross-folder views are</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+   *  not clever enough to purge the mooted messages, so we need to do this to</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+   *  help them out.)</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+   * We do not update virtual folder definitions as a result of deletion; we are</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+   *  a display abstraction.  That (hopefully) happens elsewhere.</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+   */</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+  _folderDeleted: function DBViewWrapper__folderDeleted(aFolder) {</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+    if (aFolder == this.displayedFolder) {</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+      this.close();</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+      return;</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+    }</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+    // indexOf does't work for this (reliably)</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+    for each (let [i,underlyingFolder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+      if (aFolder == underlyingFolder) {</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+        this._underlyingFolders.splice(i,1);</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineplus">+        break;</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+      }</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+    }</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+    if (this._underlyingFolders.length == 0) {</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+      this.close();</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+      return;</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+    }</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+    // if we are virtual, this will update the search session which draws its</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+    //  search scopes from this._underlyingFolders anyways.</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  },</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineplus">+  /**</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineplus">+   * Apply accumulated changes to the view.  If we are in a batch, we do</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+   *  nothing, relying on endDisplayUpdate to call us.</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+   */</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+  _applyViewChanges: function DBViewWrapper__applyViewChanges() {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+    // if we are in a batch, wait for endDisplayUpdate to be called to get us</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+    //  out to zero.</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+    if (this._viewUpdateDepth)</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+      return;</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+    // make the dbView stop being a search listener if it is one</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+    if (this.dbView)</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+      this.search.dissociateView(this.dbView);</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+    this.dbView = this._createView();</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+    this.listener.onCreatedView();</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+    // this ends up being a no-op if there are no search terms</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+    this.search.associateView(this.dbView);</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+  },</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+  /**</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+   * Check if the folder or (optionally) one of its ancestors has any one of the</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+   *  provided flags set.</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+   *</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+   * In the event there is a folder with both the SentMail and Inbox flags set,</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+   *  it will be treated as an Inbox, and not as a SentMail folder.</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+   *</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+   * @param {nsIMsgFolder} aMsgFolder The folder whose flags you want to check.</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+   * @param {Number} aFlags A set of nsMsgFolderFlags you want to check for.</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+   * @param {bool} aCheckAncestors Whether we should check the folder's ancestor</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+   *     if the folder itself does not posess the flags.</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+   *</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+   * @return true if msgFolder has any of the provided flags set.  If msgFolder</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+   *     does not, but checkAncestors is true, we will check the ancestors too.</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+   */</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+  _isSpecialFolder: function DBViewWrapper_isSpecialFolder(</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+      aMsgFolder, aFlags, aCheckAncestors)</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+  {</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    if (!aMsgFolder)</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+      return false;</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+    else if ((aMsgFolder.flags &amp; aFlags) == 0) {</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+      let parentMsgFolder = aMsgFolder.parentMsgFolder;</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+      if (parentMsgFolder &amp;&amp; aCheckAncestors)</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+        return this._isSpecialFolder(parentMsgFolder, aFlags, true);</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+      else</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+        return false;</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+    }</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+    else {</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineplus">+      // the user can set their INBOX to be their SENT folder.</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineplus">+      // in that case, we want this folder to act like an INBOX,</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+      // and not a SENT folder</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+      const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+      return !((aFlags &amp; nsMsgFolderFlags.SentMail) &amp;&amp;</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+               (aMsgFolder.flags &amp; nsMsgFolderFlags.Inbox));</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+    }</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+  },</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+  OUTGOING_FOLDER_FLAGS: nsMsgFolderFlags.SentMail |</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+                         nsMsgFolderFlags.Drafts |</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+                         nsMsgFolderFlags.Queue |</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+                         nsMsgFolderFlags.Template,</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+  /**</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+   * @return true if the folder is not known to be a special outgoing folder</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+   *     or the descendent of a special outgoing folder.</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+   */</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+  get isIncomingFolder() {</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+    return !this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+                                  this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+                                  true);</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+  },</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+  /**</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+   * @return true if the folder is an outgoing folder by virtue of being a</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+   *     sent mail folder, drafts folder, queue folder, or template folder,</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+   *     or being a sub-folder of one of those types of folders.</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+   */</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+  get isOutgoingFolder() {</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+    return !this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+                                  this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+                                  true);</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+  },</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineplus">+  get isVirtual() {</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+    return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+                   (this.displayedFolder.flags &amp; nsMsgFolderFlags.Virtual));</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+  },</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineplus">+</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineplus">+  beginViewUpdate: function DBViewWrapper_beginViewUpdate() {</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+    this._viewUpdateDepth++;</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+  },</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+  endViewUpdate: function DBViewWrapper_endViewUpdate() {</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+    if (--this._viewUpdateDepth == 0) {</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+      this._applyViewChanges();</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+    }</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+  },</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+  /**</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+   * Explicit sort command.  We ignore all previous sort state and only apply</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+   *  what you tell us.  If you want implied secondary sort, use |magicSort|.</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+   * You must use this sort command, and never directly call the sort commands</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+   *  on the underlying db view!  If you do not, make sure to fight us every</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+   *   step of the way, because we will keep clobbering your manually applied</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+   *   sort.</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+   */</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineplus">+  sort: function DBViewWrapper_sort(aSortType, aSortOrder,</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+                                    aSecondaryType, aSecondaryOrder) {</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+    this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+    if (aSecondaryType != null &amp;&amp; aSecondaryOrder != null)</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+      this._sort.push([aSecondaryType, aSecondaryOrder]);</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineplus">+    // if we are not in a view update, invoke the sort.</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineplus">+    if ((this._viewUpdateDepth == 0) &amp;&amp; this.dbView) {</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineplus">+      for (let iSort = this._sort.length - 1; iSort &gt;=0; iSort--) {</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+        // apply them in the reverse order</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+        let [sortType, sortOrder] = this._sort[iSort];</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+        this.dbView.sort(sortType, sortOrder);</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+      }</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+    }</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+    // (if we are in a view update, then a new view will be created when the</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineplus">+    //  update ends, and it will just use the new sort order anyways.)</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+  },</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+  /**</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+   * Accumulates implied secondary sorts based on multiple calls to this method.</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+   *  This is intended to be hooked up to be controlled by the UI.</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineplus">+   * Because we are lazy, we actually just poke the view's sort method and save</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+   *  the apparent secondary sort.  This also allows perfect compliance with the</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+   *  way this used to be implemented!</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+   */</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineplus">+  magicSort: function DBViewWrapper_magicSort(aSortType, aSortOrder) {</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+    if (this.dbView) {</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+      this.dbView.sort(aSortType, aSortOrder);</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+      // so, the thing we just set obviously will be there</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+      this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+      // there is only a secondary sort if it's not none and not the same.</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+      if (this.dbView.secondarySortType != nsMsgViewSortType.byNone &amp;&amp;</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+          this.dbView.secondarySortType != aSortType)</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineplus">+        this._sort.push([this.dbView.secondarySortType,</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineplus">+                         this.dbView.secondarySortOrder]);</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineplus">+    }</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineplus">+  },</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineplus">+</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineplus">+  get showGroupedBySort() {</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineplus">+  },</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineplus">+  set showGroupedBySort(aShowGroupBySort) {</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineplus">+    if (this.showGroupedBySort != aShowGroupBySort) {</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineplus">+      if (aShowGroupBySort)</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+        this._viewFlags |= nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineplus">+      else</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineplus">+        this._viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineplus">+      // lose the threading bit...</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineplus">+      this._viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineplus">+      this._applyViewChanges();</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineplus">+    }</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineplus">+  },</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineplus">+  get showIgnored() {</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineplus">+    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kShowIgnored);</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineplus">+  },</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineplus">+  set showIgnored(aShowIgnored) {</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+    if (this.showIgnored != aShowIgnored) {</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+      if (aShowIgnored)</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+        this._viewFlags |= nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+      else</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+        this._viewFlags &amp;= ~nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+      this._applyViewChanges();</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+    }</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+  },</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineplus">+</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+  get showThreaded() {</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineplus">+    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineplus">+  },</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+  set showThreaded(aShowThreaded) {</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+    if (this.showThreaded != aShowThreaded) {</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineplus">+      if (aShowThreaded)</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineplus">+        this._viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineplus">+      else</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineplus">+        this._viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+      // lose the group bit...</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineplus">+      this._viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+      this._applyViewChanges();</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+    }</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineplus">+  },</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineplus">+  get showUnreadOnly() {</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly);</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineplus">+  },</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineplus">+  set showUnreadOnly(aShowUnreadOnly) {</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineplus">+    if (this.showUnreadOnly != aShowUnreadOnly) {</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+      if (aShowUnreadOnly)</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+        this._viewFlags |= nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+      else</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+        this._viewFlags &amp;= ~nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+      this._applyViewChanges();</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+    }</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+  },</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineplus">+  /**</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineplus">+   * Read-only attribute indicating if a 'special view' is in use.  There are</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineplus">+   *  two special views in existence, both of which are concerned about</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineplus">+   *  showing you threads that have any unread messages in them.  They are views</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineplus">+   *  rather than search predicates because the search mechanism is not capable</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineplus">+   *  of expressing such a thing.  (Or at least it didn't use to be?  We might</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineplus">+   *  be able to whip something up these days...)</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+   */</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineplus">+  get specialView() {</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineplus">+    return this._specialView != null;</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineplus">+  },</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+  /**</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineplus">+   * Private helper for use by the specialView* setters that handles the common</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineplus">+   *  logic.  We don't want this method to be public because we want it to be</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+   *  feasible for the view hierarchy and its enumerations to go away without</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineplus">+   *  code outside this class having to care so much.</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineplus">+   */</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineplus">+  _setSpecialView: function DBViewWrapper__setSpecialView(aViewEnum) {</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineplus">+    // special views simply cannot work for virtual folders.  explode.</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineplus">+    if (this.isVirtual)</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+      throw new Exception(&quot;Virtual folders cannot use special views!&quot;);</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineplus">+    this.beginViewUpdate();</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+    // all special views imply a threaded view</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineplus">+    this.showThreaded = true;</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+    this._specialView = aViewEnum;</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineplus">+    this.search.clear();</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineplus">+    this.endViewUpdate();</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineplus">+  },</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineplus">+  /**</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineplus">+   * @return true if the special view that shows threads with unread messages</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineplus">+   *     in them is active.</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineplus">+   */</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineplus">+  get specialViewThreadsWithUnread() {</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+    return this._specialView == nsMsgViewType.eShowThreadsWithUnread;</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineplus">+  },</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineplus">+  /**</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineplus">+   * If true is assigned, attempts to enable the special view that shows threads</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineplus">+   *  with unread messages in them.  This will not work on virtual folders</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineplus">+   *  because of the inheritance hierarchy.</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineplus">+   * Any mechanism that requires search terms (quick search, mailviews) will be</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineplus">+   *  reset/disabled when enabling this view.</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+   */</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineplus">+  set specialViewThreadsWithUnread(aSpecial) {</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+    this._setSpecialView(nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+  },</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+  /**</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+   * @return true if the special view that shows watched threads with unread</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+   *     messages in them is active.</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+   */</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+  get specialViewWatchedThreadsWithUnread() {</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+    return this._specialView == nsMsgViewType.eShowWatchedThreadsWithUnread;</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineplus">+  },</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineplus">+  /**</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineplus">+   * If true is assigned, attempts to enable the special view that shows watched</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+   *  threads with unread messages in them.  This will not work on virtual</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineplus">+   *  folders because of the inheritance hierarchy.</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineplus">+   * Any mechanism that requires search terms (quick search, mailviews) will be</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+   *  reset/disabled when enabling this view.</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+   */</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineplus">+  set specialViewWatchedThreadsWithUnread(aSpecial) {</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+    this._setSpecialView(nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineplus">+  },</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineplus">+</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineplus">+  get mailViewIndex() {</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineplus">+    return this._mailViewIndex;</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineplus">+  },</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineplus">+  get mailViewData() {</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineplus">+    return this._mailViewData;</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineplus">+  },</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineplus">+</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineplus">+  /**</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineplus">+   * Set the current mail view to the given mail view index with the provided</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineplus">+   *  data (normally only used for the 'tag' mail views.)  We persist the state</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineplus">+   *  change</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineplus">+   *</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineplus">+   * @param aMailViewIndex The view to use, one of the kViewItem* constants from</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineplus">+   *     msgViewPickerOverlay.js OR the name of a custom view.  (It's really up</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineplus">+   *     to MailViewManager.getMailViewByIndex...)</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineplus">+   * @param aData Some piece of data appropriate to the mail view, currently</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineplus">+   *     this is only used for the tag name for kViewItemTags (sans the &quot;:&quot;).</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+   * @param aDoNotPersist If true, we don't save this change to the db folder</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineplus">+   *     info.  This is intended for internal use only.</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineplus">+   */</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineplus">+  setMailView: function DBViewWrapper_setMailView(aMailViewIndex, aData,</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+                                                  aDoNotPersist) {</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineplus">+    let mailViewDef = MailViewManager.getMailViewByIndex(aMailViewIndex);</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineplus">+</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineplus">+    this._mailViewIndex = aMailViewIndex;</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineplus">+    this._mailViewData = aData;</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineplus">+</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineplus">+    // - update the search terms (this triggers the view update)</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineplus">+    this.search.viewTerms = mailViewDef.makeTerms(this.search.session,</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineplus">+                                                  aData);</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineplus">+</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineplus">+    // - persist the view to the folder.</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineplus">+    if (!aDoNotPersist) {</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineplus">+      let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineplus">+      if (msgDatabase) {</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineplus">+        let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineplus">+        dbFolderInfo.setUint32Property(MailViewConstants.kViewCurrent,</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineplus">+                                       this._mailViewIndex);</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineplus">+        // _mailViewData attempts to be sane and be the tag name, as opposed to</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineplus">+        //  magic-value &quot;:&quot;-prefixed value historically stored on disk.  Because</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineplus">+        //  we want to be forwards and backwards compatible, we put this back on</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineplus">+        //  when we persist it.  It's not like the property is really generic</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineplus">+        //  anyways.</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineplus">+        dbFolderInfo.setCharProperty(</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineplus">+          MailViewConstants.kViewCurrentTag,</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineplus">+          this._mailViewData ? (&quot;:&quot; + this._mailViewData) : &quot;&quot;);</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineplus">+      }</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineplus">+    }</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineplus">+</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineplus">+    // we don't need to notify the view picker to update because the makeActive that</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineplus">+    //  cascades out of the view update will do it for us.</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineplus">+  },</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineplus">+</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineplus">+</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineplus">+  /**</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineplus">+   * Perform application-level behaviors related to leaving a folder that have</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineplus">+   *  nothing to do with our abstraction.</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineplus">+   *</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineplus">+   * Things we do on leaving a folder:</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineplus">+   * - Mark the folder's messages as no longer new</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineplus">+   * - Mark all messages read in the folder _if so configured_.</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+   */</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineplus">+  onLeavingFolder: function DBViewWrapper_onLeavingFolder() {</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+    this.displayedFolder.clearNewMessages();</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineplus">+    this.displayedFolder.hasNewMessages = false;</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+    try {</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineplus">+      // For legacy reasons, we support marking all messages as read when we</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineplus">+      //  leave a folder based on the server type.  It's this listener's job</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineplus">+      //  to do the legwork to figure out if this is desired.</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineplus">+      //</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineplus">+      // Mark all messages of aFolder as read:</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineplus">+      // We can't use the command controller, because it is already tuned in to</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineplus">+      // the new folder, so we just mimic its behaviour wrt</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineplus">+      // goDoCommand('cmd_markAllRead').</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineplus">+      if (this.dbView &amp;&amp;</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineplus">+          this.listener.shouldDeferMessageDisplayUntilAfterServerConnect(</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineplus">+            this.displayedFolder.server.type))</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineplus">+        this.dbView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineplus">+    }</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineplus">+    catch(e){/* ignore */}</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineplus">+  },</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineplus">+};</span>
<a href="#l3.1211"></a><span id="l3.1211">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/base/src/mailViewManager.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,212 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is mozilla.org Code.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2002</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *   Scott MacGregor &lt;mscott@netscape.com&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ *   Karsten Düsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ *</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+ *</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+EXPORTED_SYMBOLS = ['MailViewManager', 'MailViewConstants'];</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+var nsMsgSearchScope  = Ci.nsMsgSearchScope;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+var nsMsgSearchOp     = Ci.nsMsgSearchOp;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+var nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+/**</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+ * Put the MailViewConstants in an object so we can export them to</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+ *  msgViewPickerOverlay in one blob without contaminating everyone's address</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+ *  space who might want to import us.</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+ */</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+var MailViewConstants = {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  // tag views have kViewTagMarker + their key as value</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  kViewItemAll: 0,</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  kViewItemUnread: 1,</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  kViewItemTags: 2, // former labels used values 2-6</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  kViewItemNotDeleted: 3,</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  // not a real view! a sentinel value to pop up a dialog</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  kViewItemVirtual: 7,</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  // not a real view! a sentinel value to pop up a dialog</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  kViewItemCustomize: 8,</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  kViewItemFirstCustom: 9,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  kViewCurrent: &quot;current-view&quot;,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  kViewCurrentTag: &quot;current-view-tag&quot;,</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  kViewTagMarker: &quot;:&quot;,</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+};</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+/**</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+ * MailViews are view 'filters' implemented using search terms.  DBViewWrapper</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+ *  uses the SearchSpec class to combine the search terms of the mailview with</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+ *  those of the virtual folder (if applicable) and the quicksearch (if</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+ *  applicable).</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+ */</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+var MailViewManager = {</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  _views: {},</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  _customMailViews: Cc[&quot;@mozilla.org/messenger/mailviewlist;1&quot;]</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+                      .getService(Components.interfaces.nsIMsgMailViewList),</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  /**</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+   * Define one of the built-in mail-views.  If you want to define your own</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+   *  view, you need to define a custom view using nsIMsgMailViewList.</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+   *</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+   * We define our own little view definition abstraction because some day this</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+   *  functionality may want to be generalized to be usable by gloda as well.</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+   *</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+   * @param aViewDef The view definition, three attributes are required:</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+   * - name: A string name for the view, for debugging purposes only.  This</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+   *         should not be localized!</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+   * - index: The index to assign to the view.</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+   * - makeTerms: A function to invoke that returns a list of search terms.</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+   */</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  defineView: function MailViewManager_defineView(aViewDef) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    this._views[aViewDef.index] = aViewDef;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  },</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  /**</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+   * Wrap a custom view into our cute little view abstraction.  We do not cache</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+   *  these because views should not change often enough for it to matter from</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+   *  a performance perspective, but they will change enough to make stale</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+   *  caches a potential issue.</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+   */</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  _wrapCustomView: function MailViewManager_wrapCustomView(aCustomViewIndex) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    let mailView = this._customMailViews.getMailViewAt(aCustomViewIndex);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    return {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      name: mailView.prettyName, // since the user created it it's localized</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+      index: aCustomViewIndex,</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      makeTerms: function(aSession, aData) {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+        return mailView.searchTerms;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+      }</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    };</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  _findCustomViewByName: function MailViewManager_findCustomViewByName(aName) {</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    let count = this._customMailViews.mailViewCount;</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    for (let i = 0; i &lt; count; i++) {</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+      let mailView = this._customMailViews.getMailViewAt(i);</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+      if (mailView.mailViewName == aName)</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+        return this._wrapCustomView(i);</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    }</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    throw Exception(&quot;No custom view with name: &quot; + aName);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  },</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  /**</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+   * Return the view definition associated with the given view index.</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+   *</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+   * @param aViewIndex If the value is an integer it references the built-in</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+   *      view with the view index from MailViewConstants, or if the index</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+   *      is &gt;= MailViewConstants.kViewItemFirstCustom, it is a reference to</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+   *      a custom view definition.  If the value is a string, it is the name</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+   *      of a custom view.  The string case is mainly intended for testing</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+   *      purposes.</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+   */</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  getMailViewByIndex: function MailViewManager_getMailViewByIndex(aViewIndex) {</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    if (typeof(aViewIndex) == &quot;string&quot;)</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+      return this._findCustomViewByName(aViewIndex);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    if (aViewIndex &lt; MailViewConstants.kViewItemFirstCustom)</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+      return this._views[aViewIndex];</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+    else</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+      return this._wrapCustomView(aViewIndex -</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+                                  MailViewConstants.kViewItemFirstCustom);</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  },</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+};</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+MailViewManager.defineView({</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  name: &quot;all mail&quot;, // debugging assistance only! not localized!</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+  index: MailViewConstants.kViewItemAll,</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  makeTerms: function(aSession, aData) {</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    return null;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  }</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+});</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+MailViewManager.defineView({</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+  name: &quot;new mail / unread&quot;, // debugging assistance only! not localized!</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  index: MailViewConstants.kViewItemUnread,</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  makeTerms: function(aSession, aData) {</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+    let term = aSession.createTerm();</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+    let value = term.value;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    value.status = nsMsgMessageFlags.Read;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+    term.value = value;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+    term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    term.booleanAnd = true;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    return [term];</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+  }</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+});</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+MailViewManager.defineView({</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+  name: &quot;tags&quot;, // debugging assistance only! not localized!</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  index: MailViewConstants.kViewItemTags,</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  makeTerms: function(aSession, aKeyword) {</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    let term = aSession.createTerm();</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    let value = term.value;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    value.str = aKeyword;</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    value.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    term.value = value;</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+    term.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+    term.op = nsMsgSearchOp.Contains;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+    term.booleanAnd = true;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+    return [term];</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  }</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+});</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+MailViewManager.defineView({</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+  name: &quot;not deleted&quot;, // debugging assistance only! not localized!</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  index: MailViewConstants.kViewItemNotDeleted,</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+  makeTerms: function(aSession, aKeyword) {</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+    let term = aSession.createTerm();</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    let value = term.value;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+    value.status = nsMsgMessageFlags.IMAPDeleted;</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+    term.value = value;</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+    term.booleanAnd = true;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+    return [term];</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  }</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/base/src/quickSearchManager.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,186 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ *</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * License.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ *</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+ *</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+ *</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+ *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ *</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+ *</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+/*</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+ * This file mimics mailViewManager.js.  It shares the same idiom of creating</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+ *  lists of search terms, and so is really quite similar.  Except the term</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+ *  Manager is all wrong; however, we keep it for parallel construction and</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+ *  ease of searching.</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+ */</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+EXPORTED_SYMBOLS = ['QuickSearchManager', 'QuickSearchConstants'];</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+/**</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+ * Constants originally found in searchBar.js bundled together into a single</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+ *  name-space contribution.</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+ *</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+ * These constants are used by quick-search-menupopup.  The state of</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+ *  quick-search-menupopup is persisted to localstore.rdf, so new values need</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+ *  new constants.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+ */</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+var QuickSearchConstants = {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  kQuickSearchSubject: 0,</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  kQuickSearchFrom: 1,</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+  kQuickSearchFromOrSubject: 2,</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  kQuickSearchBody: 3,</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  // there used to be a kQuickSearchHighlight = 4, apparently removed</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  kQuickSearchRecipient: 5,</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  kQuickSearchRecipientOrSubject: 6,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+};</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+/**</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+ * All quick search logic that takes us from a search string (and search mode)</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+ *  to a set of search terms goes in here.  Check out FolderDisplayWidget for</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+ *  display concerns involving views, or DBViewWrapper and SearchSpec for the</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+ *  actual nsIMsgDBView-related logic.</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+ */</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+var QuickSearchManager = {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  /**</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+   * Create the search terms for the given quick-search configuration.  This is</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+   *  intended to basically be directly used in the service of the UI without</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+   *  pre-processing.  If you want to add extra logic, probably add it in here</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+   *  (with appropriate refactoring.)</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+   * Callers should strongly consider using DBViewWrapper's search attribute</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+   *  (which is a SearchSpec)'s quickSearch method which in turn calls us.  The</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+   *  DBViewWrapper may in turn be embedded in a FolderDisplayWidget.  So an</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+   *  example usage might be:</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+   *</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+   * gFolderDisplay.view.search.quickSearch(</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+   *   QuickSearchConstants.kQuickSearchSubject, &quot;foo|bar&quot;);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+   *</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+   * @param aTermCreator A nsIMsgSearchSession or other interface with a</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+   *     createTerm method.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+   * @param aSearchMode One of the QuickSearchConstants.kQuickSearch* search</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+   *     mode constants specifying what parts of the message to search on.</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+   * @param aSearchString The search string, consisting of sub-strings delimited</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+   *     by '|' to be OR-ed together.  Given the string &quot;foo&quot; we search for</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+   *     messages containing &quot;foo&quot;.  Given the string &quot;foo|bar&quot;, we search for</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+   *     messages containing &quot;foo&quot; or &quot;bar&quot;.</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+   * @return a list of nsIMsgSearch term instances representing the search as</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+   *     defined by the arguments.</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+   */</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  createSearchTerms: function QuickSearchManager_createSearchTerms(</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+      aTermCreator, aSearchMode, aSearchString) {</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+    let searchTerms = [];</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+    let termList = aSearchString.split(&quot;|&quot;);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+    for (var i = 0; i &lt; termList.length; i ++)</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+    {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+      // if the term is empty, skip it</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+      if (termList[i] == &quot;&quot;)</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+        continue;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      // create, fill, and append the subject term</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+      let term;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+      let value;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+      // if our search criteria is subject or subject|from then add a term for</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+      // the subject</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+      if (aSearchMode == QuickSearchConstants.kQuickSearchSubject ||</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+          aSearchMode == QuickSearchConstants.kQuickSearchFromOrSubject ||</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+          aSearchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject)</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+      {</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+        term = aTermCreator.createTerm();</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+        value = term.value;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+        value.str = termList[i];</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+        term.value = value;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+        term.attrib = nsMsgSearchAttrib.Subject;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+        term.booleanAnd = false;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+        searchTerms.push(term);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+      }</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+      if (aSearchMode == QuickSearchConstants.kQuickSearchBody)</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+      {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+        // what do we do for news and imap users that aren't configured for offline use?</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+        // in these cases the body search will never return any matches. Should we try to</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+        // see if body is a valid search scope in this particular case before doing the search?</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+        // should we switch back to a subject/from search behind the scenes?</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+        term = aTermCreator.createTerm();</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+        value = term.value;</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+        value.str = termList[i];</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+        term.value = value;</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+        term.attrib = nsMsgSearchAttrib.Body;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+        term.booleanAnd = false;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+        searchTerms.push(term);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+      }</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+      // create, fill, and append the from (or recipient) term</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+      if (aSearchMode == QuickSearchConstants.kQuickSearchFrom ||</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+          aSearchMode == QuickSearchConstants.kQuickSearchFromOrSubject)</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+      {</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+        term = aTermCreator.createTerm();</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+        value = term.value;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+        value.str = termList[i];</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+        term.value = value;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+        term.attrib = nsMsgSearchAttrib.Sender;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+        term.booleanAnd = false;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+        searchTerms.push(term);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+      }</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+      // create, fill, and append the recipient</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+      if (aSearchMode == QuickSearchConstants.kQuickSearchRecipient ||</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+          aSearchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject)</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+      {</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+        term = aTermCreator.createTerm();</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+        value = term.value;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+        value.str = termList[i];</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+        term.value = value;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+        term.attrib = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+        term.booleanAnd = false;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+        searchTerms.push(term);</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+      }</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+    }</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+    return searchTerms;</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  }</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+};</span>
<a href="#l5.191"></a><span id="l5.191">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/base/src/searchSpec.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,396 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ *</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * License.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ *</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+EXPORTED_SYMBOLS = ['SearchSpec'];</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+Cu.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+Cu.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+const nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+const nsIMsgLocalMailFolder = Ci.nsIMsgLocalMailFolder;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+/**</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+ * Wrapper abstraction around a view's search session.  This is basically a</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+ *  friend class of FolderDisplayWidget and is privy to some of its internals.</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+ */</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+function SearchSpec(aFolderDisplayWidget) {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  this.owner = aFolderDisplayWidget;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  this._viewTerms = null;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  this._virtualFolderTerms = null;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  this._userTerms = null;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  this._session = null;</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  this._sessionListener = null;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  this._listenersRegistered = false;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+}</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+SearchSpec.prototype = {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  get hasSearchTerms() {</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    return this._viewTerms || this._virtualFolderTerms || this._userTerms;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  },</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  get hasOnlyVirtualTerms() {</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    return this._virtualFolderTerms &amp;&amp; !this._viewTerms &amp;&amp; !this._userTerms;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  },</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  /**</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+   * On-demand creation of the nsIMsgSearchSession.  Automatically creates a</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+   *  SearchSpecListener at the same time and registers it as a listener.  The</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+   *  DBViewWrapper is responsible for adding (and removing) the db view</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+   *  as a listener.</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+   *</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+   * Code should only access this attribute when it wants to manipulate the</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+   *  session.  Callers should use hasSearchTerms if they want to determine if</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+   *  a search session is required.</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+   */</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  get session() {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    if (this._session == null) {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+      this._session =</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+        Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+                  .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    }</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    return this._session;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  },</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  /**</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+   * (Potentially) add the db view as a search listener and kick off the search.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+   *  We only do that if we have search terms.  The intent is to allow you to</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+   *  call this all the time, even if you don't need to.</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+   * DBViewWrapper._applyViewChanges used to handle a lot more of this, but our</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+   *  need to make sure that the session listener gets added after the DBView</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+   *  caused us to introduce this method.  (We want the DB View's OnDone method</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+   *  to run before our listener, as it may do important work.)</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+   */</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  associateView: function(aDBView) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+    if (this.hasSearchTerms) {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+      this.updateSession();</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+      if (!this._sessionListener)</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+        this._sessionListener = new SearchSpecListener(this);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+      this.session.registerListener(aDBView);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+      aDBView.searchSession = this._session;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+      this._session.registerListener(this._sessionListener);</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+      this._listenersRegistered = true;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+      this.owner.searching = true;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+      this.session.search(this.owner.listener.msgWindow);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    }</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  },</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  /**</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+   * Stop any active search and stop the db view being a search listener (if it</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+   *  is one).</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+   */</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  dissociateView: function(aDBView) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+    if (this.owner.searching)</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+      this.session.interruptSearch();</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+    if (this._listenersRegistered) {</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+      this._session.unregisterListener(this._sessionListener);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+      this._session.unregisterListener(aDBView);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+      aDBView.searchSession = null;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+      this._listenersRegistered = false;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+    }</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+  },</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  /**</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+   * Given a list of terms, mutate them so that they form a single boolean</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+   *  group.</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+   *</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+   * @param aTerms The search terms</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+   * @param aCloneTerms Do we need to clone the terms?</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+   */</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+  _groupifyTerms: function SearchSpec__groupifyTerms(aTerms, aCloneTerms) {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    let iTerm = 0, term;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+    let outTerms = aCloneTerms ? [] : aTerms;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    for (term in fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+      if (aCloneTerms) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+        let cloneTerm = this.session.createTerm();</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+        cloneTerm.value = term.value;</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+        cloneTerm.attrib = term.attrib;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+        cloneTerm.arbitraryHeader = term.arbitraryHeader;</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+        cloneTerm.op = term.op;</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+        cloneTerm.booleanAnd = term.booleanAnd;</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+        term = cloneTerm;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+        outTerms.push(term);</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+      }</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+      if (iTerm == 0) {</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+        term.beginsGrouping = true;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+        term.booleanAnd = true;</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+      }</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+      iTerm++;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+    }</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+    if (term)</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+      term.endsGrouping = true;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+    return outTerms;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+  },</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+  /**</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+   * Set search terms that are defined by the 'view', which translates to that</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+   *  weird combo-box that lets you view your unread messages, messages by tag,</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+   *  messages that aren't deleted, etc.</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+   *</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+   * @param aViewTerms The list of terms.  We take ownership and mutate it.</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+   */</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  set viewTerms(aViewTerms) {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    if (aViewTerms)</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+      this._viewTerms = this._groupifyTerms(aViewTerms);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+    else</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+      this._viewTerms = null;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+    this.owner._applyViewChanges();</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+  },</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  /**</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+   * Set search terms that are defined by the 'virtual folder' definition.  This</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+   *  could also be thought of as the 'saved search' part of a saved search.</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+   *</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+   * @param aVirtualFolderTerms The list of terms.  We make our own copy and</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+   *     do not mutate yours.</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+   */</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+  set virtualFolderTerms(aVirtualFolderTerms) {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+    if (aVirtualFolderTerms)</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+      // we need to clone virtual folder terms because they are pulled from a</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+      //  persistent location rather than created on demand</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+      this._virtualFolderTerms = this._groupifyTerms(aVirtualFolderTerms,</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+                                                     true);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+    else</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+      this._virtualFolderTerms = null;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+    this.owner._applyViewChanges();</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  },</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+  /**</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+   * Set the terms that the user is explicitly searching on.  These will be</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+   *  augmented with the 'context' search terms potentially provided by</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+   *  viewTerms and virtualFolderTerms.</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+   *</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+   * @param aUserTerms The list of terms.  We take ownership and mutate it.</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+   */</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  set userTerms(aUserTerms) {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    if (aUserTerms)</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+      this._userTerms = this._groupifyTerms(aUserTerms);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+    else</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+      this._userTerms = null;</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+    this.owner._applyViewChanges();</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  },</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+  /**</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+   * Apply a quick-search for the given search mode using the given search</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+   *  string.  All of the hard work is done by</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+   *  QuickSearchManager.createSearchTerms; we mainly just assign the result to</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+   *  our userTerms property.</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+   *</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+   * @param aSearchMode One of the QuickSearchConstants.kQuickSearch* search</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+   *     mode constants specifying what parts of the message to search on.</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+   * @param aSearchString The search string, consisting of sub-strings delimited</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+   *     by '|' to be OR-ed together.  Given the string &quot;foo&quot; we search for</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+   *     messages containing &quot;foo&quot;.  Given the string &quot;foo|bar&quot;, we search for</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+   *     messages containing &quot;foo&quot; or &quot;bar&quot;.</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+   */</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+  quickSearch: function SearchSpec_quickSearch(aSearchMode, aSearchString) {</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+    this.userTerms = QuickSearchManager.createSearchTerms(</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+      this._session, aSearchMode, aSearchString);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+  },</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+  clear: function SearchSpec_clear() {</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+    if (this.hasSearchTerms) {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+      this._viewTerms = null;</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+      this._virtualFolderTerms = null;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+      this._userTerms = null;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+      this.owner._applyViewChanges();</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+    }</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+  },</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+  get onlineSearch() {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+    return this._onlineSearch;</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+  },</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+  set onlineSearch(aOnlineSearch) {</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+    this._onlineSearch = aOnlineSearch;</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+  },</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+  /**</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+   * Populate the search session using viewTerms, virtualFolderTerms, and</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+   *  userTerms.  The way this works is that each of the 'context' sets of</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+   *  terms gets wrapped into a group which is boolean anded together with</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+   *  everything else.</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+   */</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+  updateSession: function SearchSpec_applySearch() {</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+    let session = this.session;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+    // clear out our current terms and scope</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+    session.searchTerms.QueryInterface(Ci.nsISupportsArray).Clear();</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+    session.clearScopes();</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+    // -- apply terms</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+    if (this._virtualFolderTerms) {</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+      for each (let term in fixIterator(this._virtualFolderTerms,</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+                                        nsIMsgSearchTerm)) {</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+        session.appendTerm(term);</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+      }</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+    }</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+    if (this._viewTerms) {</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+      for each (let term in fixIterator(this._viewTerms,</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+                                        nsIMsgSearchTerm)) {</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+        session.appendTerm(term);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+      }</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+    }</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+    if (this._userTerms) {</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+      for each (let term in fixIterator(this._userTerms,</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+                                        nsIMsgSearchTerm)) {</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+        session.appendTerm(term);</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+      }</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+    }</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    // -- apply scopes</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    // if the folder is local, the folder is marked for offline access, or we</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+    //  are offline, then perform an offline search.</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    // otherwise, rely on the server's search scope. if we were more thorough,</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+    //  we could try and figure out what operands cause us to fall back toward</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+    //  online usage.  (quick search previously specialized this by virtue of</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+    //  having a very limited set of terms in use.)</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+                      .getService(Ci.nsIIOService);</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+    for each (let [, folder] in Iterator(this.owner._underlyingFolders)) {</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+      let scope;</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+      if ((folder instanceof nsIMsgLocalMailFolder) ||</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+        (folder.flags &amp; nsMsgFolderFlags.Offline) ||</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+          ioService.offline)</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+        scope = nsMsgSearchScope.offlineMail;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+      else</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+        scope = folder.server.searchScope;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+      session.addScopeTerm(scope, folder);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+    }</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+  },</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+  prettyStringOfSearchTerms: function(aSearchTerms) {</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+    if (aSearchTerms == null)</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+      return '      (none)\n';</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+    let s = '';</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+    for each (let term in fixIterator(aSearchTerms, nsIMsgSearchTerm)) {</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+      s += '      ' + term.termAsString + '\n';</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+    }</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+    return s;</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+  },</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+  prettyString: function() {</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+    let s = '  Search Terms:\n';</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+    s += '    Virtual Folder Terms:\n';</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+    s += this.prettyStringOfSearchTerms(this._virtualFolderTerms);</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+    s += '    View Terms:\n';</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+    s += this.prettyStringOfSearchTerms(this._viewTerms);</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+    s += '    User Terms:\n';</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+    s += this.prettyStringOfSearchTerms(this._userTerms);</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+    s += '    Scope (Folders):\n';</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+    for each (let [, folder] in Iterator(this.owner._underlyingFolders)) {</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+      s += '      ' + folder.prettyName + '\n';</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    }</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+    return s;</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+  },</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+};</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+/**</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+ * An nsIMsgSearchNotify listener for searches, primarily to keep the UI</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+ *  up-to-date.  The db view itself always gets added as a listener and does</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+ *  the heavy lifting.</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+ *</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+ * The one notable thing we do is help single-folder virtual folders out by</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+ *  tracking and updating their total and unread message counts.  Our logic</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+ *  is simple and is not clever enough to deal with the user reading messages</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+ *  as they are displayed.  However, this is not a major issue for single-folder</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+ *  searches because they should complete very quickly.  (Note: I am documenting</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+ *  reality here, not implementing and rationalizing.)</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+ */</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+function SearchSpecListener(aSearchSpec) {</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+  this.searchSpec = aSearchSpec;</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+}</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+SearchSpecListener.prototype = {</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+  onNewSearch: function SearchSpecListener_onNewSearch() {</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+    // searching should already be true by the time this happens.  if it's not,</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+    //  it means some code is poking at the search session.  bad!</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    if (!this.searchSpec.owner.searching) {</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+      dump(&quot;Search originated from unknown initiator! Confusion!\n&quot;);</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+      this.searchSpec.owner.searching = true;</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+    }</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+    // we track total/unread messages to help out single-folder virtual folders</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+    this.totalMessages = 0;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+    this.unreadMessages = 0;</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+  },</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+  onSearchHit: function SearchSpecListener_onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+    this.totalMessages++;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+    if (!aMsgHdr.isRead)</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+      this.unreadMessages++;</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+  },</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+  onSearchDone: function SearchSpecListener_onSearchDone(aStatus) {</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+    let viewWrapper = this.searchSpec.owner;</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+    let folder = viewWrapper.displayedFolder;</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+    // Save message counts if it's a virtual folder and there are no additional</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+    //  constraints contaminating the virtual folder results.</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+    // The old code did this every time, for both cross-folder (multi-folder)</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+    //  virtual folders and single-folder backed virtual folders.  However,</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+    //  nsMsgXFVirtualFolderDBView already does this (and does a better job of</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+    //  it), so we only do this for single virtual folders.</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+    if (viewWrapper.isVirtual &amp;&amp; viewWrapper.isSingleFolder) {</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+      let msgDatabase = folder.msgDatabase;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+      if (msgDatabase) {</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+        let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+        dbFolderInfo.numUnreadMessages = this.unreadMessages;</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+        dbFolderInfo.numMessages = this.totalMessages;</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+        // passing true compels it to use the new message counts we just set.</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+        // this call also flushes to the folder cache.</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+        folder.updateSummaryTotals(true);</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+        const MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+        msgDatabase.Commit(MSG_DB_LARGE_COMMIT);</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+      }</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+    }</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+    viewWrapper.searching = false;</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+  },</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+};</span>
<a href="#l6.401"></a><span id="l6.401">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,229 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ *</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ *</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ *   Håkan Waara (hwaara@chello.se)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ *   David Bienvenu (bienvenu@nventure.com)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ *   Jeremy Morton (bugzilla@game-point.net)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ *</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+ *</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+/*</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+ * Wrap everything about virtual folders.</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+ */</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+EXPORTED_SYMBOLS = ['VirtualFolderHelper'];</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+Cu.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+var VirtualFolderHelper = {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  /**</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+   * Create a new virtual folder (an actual nsIMsgFolder that did not previously</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+   *  exist), wrapping it in a VirtualFolderWrapper, and returning that wrapper.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+   *</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+   * If the call to addSubfolder fails (and therefore throws), we will NOT catch</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+   *  it.</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+   *</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+   * @param aFolderName The name of the new folder to create.</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+   * @param aParentFolder The folder in which to create the search folder.</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+   * @param aSearchFolders A list of nsIMsgFolders that you want to use as the</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+   *     sources for the virtual folder OR a string that is the already '|'</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+   *     delimited list of folder URIs to use.</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+   * @param aSearchTerms The search terms to use for the virtual folder.</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+   * @param aOnlineSearch Should the search attempt to use the server's search</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+   *     capabilities when possible and appropriate?</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+   *</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+   * @return The VirtualFolderWrapper wrapping the newly created folder.  You</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+   *     would probably only want this for its virtualFolder attribute which has</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+   *     the nsIMsgFolder we created.  Be careful about accessing any of the</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+   *     other attributes, as they will bring its message database back to life.</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+   */</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  createNewVirtualFolder: function (aFolderName, aParentFolder, aSearchFolders,</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                                    aSearchTerms, aOnlineSearch) {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    let msgFolder = aParentFolder.addSubfolder(aFolderName);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    msgFolder.prettyName = aFolderName;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    msgFolder.setFlag(Ci.nsMsgFolderFlags.Virtual);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    let wrappedVirt = new VirtualFolderWrapper(msgFolder);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    wrappedVirt.searchTerms = aSearchTerms;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    wrappedVirt.searchFolders = aSearchFolders;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    wrappedVirt.onlineSearch = aOnlineSearch;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    let msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    msgDatabase.summaryValid = true;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    msgDatabase.Close(true);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+    aParentFolder.NotifyItemAdded(msgFolder);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+      .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+      .saveVirtualFolders();</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    return wrappedVirt;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  },</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  /**</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+   * Given an existing nsIMsgFolder that is a virtual folder, wrap it into a</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+   *  VirtualFolderWrapper.</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+   */</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  wrapVirtualFolder: function (aMsgFolder) {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    return new VirtualFolderWrapper(aMsgFolder);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  },</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+};</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+/**</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+ * Abstracts dealing with the properties of a virtual folder that differentiate</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+ *  it from a non-virtual folder.  A virtual folder is an odd duck.  When</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+ *  holding an nsIMsgFolder that is a virtual folder, it is distinguished by</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+ *  the virtual flag and a number of properties that tell us the string</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+ *  representation of its search, the folders it searches over, and whether we</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+ *  use online searching or not.</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+ * Virtual folders and their defining attributes are loaded from</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+ *  virtualFolders.dat (in the profile directory) by the account manager at</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+ *  startup, (re-)creating them if need be.  It also saves them back to the</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+ *  file at shutdown.  The most important thing the account manager does is to</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+ *  create VirtualFolderChangeListener instances that are registered with the</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+ *  message database service.  This means that if one of the databases for the</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+ *  folders that the virtual folder includes is opened for some reason (for</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+ *  example, new messages are added to the folder because of a filter or they</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+ *  are delivered there), the virtual folder gets a chance to know about this</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+ *  and update the virtual folder's &quot;cache&quot; of information, such as the message</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+ *  counts or the presence of the message in the folder.</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+ * The odd part is that a lot of the virtual folder logic also happens as a</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+ *  result of the nsMsgDBView subclasses being told the search query and the</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+ *  underlying folders.  This makes for an odd collaboration of UI and backend</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+ *  logic.</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+ *</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+ * Justification for this class:  Virtual folders aren't all that complex, but</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+ *  they are complex enough that we don't want to have the same code duplicated</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+ *  all over the place.  We also don't want to have a loose assembly of global</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+ *  functions for working with them.  So here we are.</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+ *</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+ * Important! Accessing any of our attributes results in the message database</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+ *  being loaded so that we can access the dBFolderInfo associated with the</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+ *  database.  The message database is not automatically forgotten by the</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+ *  folder, which can lead to an (effective) memory leak.  Please make sure</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+ *  that you are playing your part in not leaking memory by only using the</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+ *  wrapper when you have a serious need to access the database, and by</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+ *  forcing the folder to forget about the database when you are done by</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+ *  setting the database to null (unless you know with confidence someone else</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+ *  definitely wants the database around and will clean it up.)</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+ */</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+function VirtualFolderWrapper(aVirtualFolder) {</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  this.virtualFolder = aVirtualFolder;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+};</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+VirtualFolderWrapper.prototype = {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  /**</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+   * @return the list of nsIMsgFolders that this virtual folder is a</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+   *     search over.</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+   */</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  get searchFolders() {</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+                       .getService(Ci.nsIRDFService);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+    let virtualFolderUris =</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+      this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;).split(&quot;|&quot;);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+    let folders = [];</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    for each (let [, folderURI] in Iterator(virtualFolderUris)) {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+      folders.push(rdfService.GetResource(folderURI)</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+                             .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    }</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+    return folders;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  },</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  set searchFolders(aFolders) {</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+    if (typeof(aFolders) == &quot;string&quot;) {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+      this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, aFolders);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    }</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    else {</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+      let uris = [folder.URI for each ([, folder] in Iterator(aFolders))];</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+      this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, uris.join(&quot;|&quot;));</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    }</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  },</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  /**</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+   * @return the list of search terms that define this virtual folder.</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+   */</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  get searchTerms() {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+    let filterService =</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+      Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+        .getService(Ci.nsIMsgFilterService);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    // Temporary means it doesn't get exposed to the UI and doesn't get saved to</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+    //  disk.  Which is good, because this is just a trick to parse the string</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    //  into search terms.</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+    let filterList = filterService.getTempFilterList(this.virtualFolder);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    let tempFilter = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    filterList.parseCondition(tempFilter, this.searchString);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    return tempFilter.searchTerms;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  },</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  /**</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+   * Set the search string for this virtual folder to the stringified version of</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+   *  the provided list of search terms.</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+   */</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+  set searchTerms(aTerms) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    let condition = &quot;&quot;;</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+    for (let term in fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+      if (condition.length)</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+        condition += &quot; &quot;;</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+      if (term.matchAll) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+        condition = &quot;ALL&quot;;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+        break;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+      }</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+      condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+      condition += term.termAsString + &quot;)&quot;;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+    }</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    this.searchString = condition;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  },</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  get searchString() {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    return this.dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  },</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  set searchString(aSearchString) {</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+    this.dbFolderInfo.setCharProperty(&quot;searchStr&quot;, aSearchString);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  },</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  get onlineSearch() {</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+    return this.dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+  },</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  set onlineSearch(aOnlineSearch) {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    this.dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, aOnlineSearch);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  },</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  get dbFolderInfo() {</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+    return this.virtualFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  }</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_logic.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,170 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+/**</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ * Verify that flipping between threading and grouped by sort settings properly</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ *  clears the other flag.  (Because they're mutually exclusive, you see.)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ */</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+function test_threading_grouping_mutual_exclusion () {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  viewWrapper.showThreaded = true;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  assert_true(viewWrapper.showThreaded,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+              &quot;view should be threaded&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  assert_false(viewWrapper.showGroupedBySort,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+               &quot;view should not be grouped by sort&quot;);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  viewWrapper.showGroupedBySort = true;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  assert_false(viewWrapper.showThreaded,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+               &quot;view should not be threaded&quot;);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  assert_true(viewWrapper.showGroupedBySort,</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+              &quot;view should be grouped by sort&quot;);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+}</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+/**</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * Do a quick test of primary sorting to make sure we're actually changing the</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ *  sort order.  (However, we are not responsible for verifying correctness of</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ *  the sort.)</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ */</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+function test_sort_primary() {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  // we need to put messages in the folder or the sort logic doesn't actually</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  //  save the sort state. (this is the C++ view's fault.)</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  let [folder, msgSet] = make_folder_with_sets(1);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  viewWrapper.sort(Ci.nsMsgViewSortType.byDate,</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+                   Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  assert_equals(viewWrapper.dbView.sortType, Ci.nsMsgViewSortType.byDate,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+                &quot;sort should be by date&quot;, true);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  assert_equals(viewWrapper.dbView.sortOrder, Ci.nsMsgViewSortOrder.ascending,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+                &quot;sort order should be ascending&quot;, true);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  viewWrapper.sort(Ci.nsMsgViewSortType.byAuthor,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+                   Ci.nsMsgViewSortOrder.descending);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  assert_equals(viewWrapper.dbView.sortType, Ci.nsMsgViewSortType.byAuthor,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+                &quot;sort should be by author&quot;, true);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  assert_equals(viewWrapper.dbView.sortOrder, Ci.nsMsgViewSortOrder.descending,</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+                &quot;sort order should be descending&quot;, true);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+}</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+/**</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+ * Verify that we handle explicit secondary sorts correctly.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+ */</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+function test_sort_secondary_explicit() {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  // we need to put messages in the folder or the sort logic doesn't actually</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  //  save the sort state. (this is the C++ view's fault.)</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  let [folder, msgSet] = make_folder_with_sets(1);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  viewWrapper.sort(Ci.nsMsgViewSortType.byAuthor,</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+                   Ci.nsMsgViewSortOrder.ascending,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+                   Ci.nsMsgViewSortType.bySubject,</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+                   Ci.nsMsgViewSortOrder.descending</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+                   );</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  // check once for what we just did, then again after refreshing to make</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  //  sure the sort order 'stuck'</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  for (let i = 0; i &lt; 2; i++) {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    assert_equals(viewWrapper.dbView.sortType, Ci.nsMsgViewSortType.byAuthor,</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+                  &quot;sort should be by author&quot;);</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    assert_equals(viewWrapper.dbView.sortOrder, Ci.nsMsgViewSortOrder.ascending,</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                  &quot;sort order should be ascending&quot;);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    assert_equals(viewWrapper.dbView.secondarySortType,</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+                  Ci.nsMsgViewSortType.bySubject,</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+                  &quot;secondary sort should be by subject&quot;);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    assert_equals(viewWrapper.dbView.secondarySortOrder,</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                  Ci.nsMsgViewSortOrder.descending,</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+                  &quot;secondary sort order should be descending&quot;);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    viewWrapper.refresh();</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  }</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+}</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+/**</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+ * Verify that we handle implicit secondary sorts correctly.</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+ * An implicit secondary sort is when we sort by Y, then we sort by X, and it's</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+ *  okay to have the effective sort of [X, Y].  The UI has/wants this, so, uh,</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+ *  let's make sure we obey its assumptions unless we have gone and made the UI</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+ *  be explicit about these things.  We can't simply depend on the view to do</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+ *  this for us.  Why?  Because we re-create the view all the bloody time.</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+ */</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+function test_sort_secondary_implicit() {</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  // we need to put messages in the folder or the sort logic doesn't actually</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  //  save the sort state. (this is the C++ view's fault.)</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  let [folder, msgSet] = make_folder_with_sets(1);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  viewWrapper.magicSort(Ci.nsMsgViewSortType.bySubject,</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+                        Ci.nsMsgViewSortOrder.descending);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  viewWrapper.magicSort(Ci.nsMsgViewSortType.byAuthor,</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+                        Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  // check once for what we just did, then again after refreshing to make</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  //  sure the sort order 'stuck'</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  for (let i = 0; i &lt; 2; i++) {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    assert_equals(viewWrapper.dbView.sortType, Ci.nsMsgViewSortType.byAuthor,</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+                  &quot;sort should be by author&quot;);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    assert_equals(viewWrapper.dbView.sortOrder, Ci.nsMsgViewSortOrder.ascending,</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+                  &quot;sort order should be ascending&quot;);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+    assert_equals(viewWrapper.dbView.secondarySortType,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+                  Ci.nsMsgViewSortType.bySubject,</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+                  &quot;secondary sort should be by subject&quot;);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    assert_equals(viewWrapper.dbView.secondarySortOrder,</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+                  Ci.nsMsgViewSortOrder.descending,</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+                  &quot;secondary sort order should be descending&quot;);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+    viewWrapper.refresh();</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  }</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+}</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+/**</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+ * Verify that mailview changes are properly persisted but that we only use them</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+ *  when the listener indicates we should use them (because the widget is</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+ *  presumably visible).</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+ */</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+function test_mailviews_persistence() {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  // open the folder, ensure it is using the default mail view</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+  do_check_eq(viewWrapper.mailViewIndex, MailViewConstants.kViewItemAll);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  // set the view so as to be persisted</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  viewWrapper.setMailView(MailViewConstants.kViewItemUnread);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  // ...but first make sure it took at all</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+  do_check_eq(viewWrapper.mailViewIndex, MailViewConstants.kViewItemUnread);</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+  // close, re-open and verify it took</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  do_check_eq(viewWrapper.mailViewIndex, MailViewConstants.kViewItemUnread);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+  // close, turn off the mailview usage indication by the listener...</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  gMockViewWrapperListener.shouldUseMailViews = false;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  // ...open and verify that it did not take!</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  do_check_eq(viewWrapper.mailViewIndex, MailViewConstants.kViewItemAll);</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  // put the mailview setting back so other tests work</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  gMockViewWrapperListener.shouldUseMailViews = true;</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+}</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+var tests = [</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+  test_threading_grouping_mutual_exclusion,</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+  test_sort_primary,</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  test_sort_secondary_explicit,</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  test_sort_secondary_implicit,</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+  test_mailviews_persistence,</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+];</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+function run_test() {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,595 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/**</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * Test DBViewWrapper against a single local folder.  Try and test all the</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ *  features we can without having a fake newsgroup.  (Some features are</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ *  newsgroup specific.)</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ */</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+/* ===== Real Folder, no features ===== */</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+/**</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+ * Open a pre-populated real folder, make sure all the messages show up.</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ */</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+function test_real_folder_load() {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  let [msgFolder, msgSet] = make_folder_with_sets(1);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  yield async_view_open(viewWrapper, msgFolder);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  verify_messages_in_view(msgSet, viewWrapper);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+}</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+/**</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ * Open a real folder, add some messages, make sure they show up, remove some</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+ *  messages, make sure they go away.</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+ */</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+function test_real_folder_update() {</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  // start with an empty folder</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  let msgFolder = make_empty_folder();</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  yield async_view_open(viewWrapper, msgFolder);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  verify_empty_view(viewWrapper);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  // add messages (none -&gt; some)</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  let [setOne] = make_new_sets_in_folder(msgFolder, 1);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  verify_messages_in_view(setOne, viewWrapper);</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  // add more messages! (some -&gt; more)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  let [setTwo] = make_new_sets_in_folder(msgFolder, 1);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  verify_messages_in_view([setOne, setTwo], viewWrapper);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  // remove the first set of messages (more -&gt; some)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  yield async_delete_messages(setOne);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  verify_messages_in_view(setTwo, viewWrapper);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  // remove the second set of messages (some -&gt; none)</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  yield async_delete_messages(setTwo);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  verify_empty_view(viewWrapper);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+}</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+/**</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+ * Open a real folder, verify, open another folder, verify.  We are testing</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+ *  ability to change folders without exploding.</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+ */</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+function test_real_folder_load_after_real_folder_load() {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  let [folderOne, setOne] = make_folder_with_sets(1);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  yield async_view_open(viewWrapper, folderOne);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  verify_messages_in_view(setOne, viewWrapper);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  let [folderTwo, setTwo] = make_folder_with_sets(1);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  yield async_view_open(viewWrapper, folderTwo);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  verify_messages_in_view(setTwo, viewWrapper);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+}</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+/* ===== Real Folder, Threading Modes ==== */</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+function test_real_folder_threading_unthreaded() {</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  // create a single maximally nested thread.</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  const count = 10;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  let messageSet =</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+    new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  // verify that we are not threaded (or grouped)</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  viewWrapper.showThreaded = false;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+  verify_view_level_histogram({0: count}, viewWrapper);</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+}</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+function test_real_folder_threading_threaded() {</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  // create a single maximally nested thread.</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  const count = 10;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  let messageSet =</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+  add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  // verify that we are threaded (in such a way that we can't be grouped)</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+  viewWrapper.showThreaded = true;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  view_expand_all(viewWrapper);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  let expectedHisto = {};</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+  for (let i = 0; i &lt; count; i++)</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+    expectedHisto[i] = 1;</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  verify_view_level_histogram(expectedHisto, viewWrapper);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+}</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+function test_real_folder_threading_grouped_by_sort() {</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  // create some messages that belong to the 'in this week' bucket when sorting</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  //  by date and grouping by date.</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  const count = 5;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  let [folder, messageSet] = make_folder_with_sets([</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    {count: count, age: {days: 2}, age_incr: {mins: 1}}]);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  // group-by-sort sorted by date</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  viewWrapper.beginViewUpdate();</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  viewWrapper.showGroupedBySort = true;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  viewWrapper.sort(Ci.nsMsgViewSortType.byDate,</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+                   Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+  viewWrapper.endViewUpdate();</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  // expand everyone</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  view_expand_all(viewWrapper);</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+  // make sure the level depths are correct</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+  verify_view_level_histogram({0: 1, 1: count}, viewWrapper);</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+  // and make sure the first dude is a dummy</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+  verify_view_row_at_index_is_dummy(viewWrapper, 0);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+}</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+/* ===== Real Folder, View Flags ===== */</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+/*</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+ * We cannot test the ignored flag for a local folder because we cannot ignore</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+ *  threads in a local folder.  Only newsgroups can do that and that's not</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+ *  easily testable at this time.</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+ */</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+/**</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+ * Test the kUnreadOnly flag usage.  This functionality is equivalent to the</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+ *  mailview kViewItemUnread case, so it uses roughly the same test as</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+ *  test_real_folder_mail_views_unread.</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+ */</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+function test_real_folder_flags_show_unread() {</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  let [folder, setOne, setTwo] = make_folder_with_sets(2);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+  // everything is unread to start with! #1</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+  viewWrapper.showUnreadOnly = true;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+  verify_messages_in_view([setOne, setTwo], viewWrapper);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  // add some more things (unread!), make sure they appear. #2</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+  let [setThree] = make_new_sets_in_folder(folder, 1);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  verify_messages_in_view([setOne, setTwo, setThree], viewWrapper);</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  // make some things read, make sure they disappear. #3 (after refresh)</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+  setTwo.setRead(true);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+  viewWrapper.refresh(); // refresh to get the messages to disappear</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+  verify_messages_in_view([setOne, setThree], viewWrapper);</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+  // make those things un-read again. #2</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+  setTwo.setRead(false);</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+  viewWrapper.refresh(); // QUICKSEARCH-VIEW-LIMITATION-REMOVE or not?</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+  verify_messages_in_view([setOne, setTwo, setThree], viewWrapper);</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+}</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+/* ===== Real Folder, Mail Views ===== */</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+/*</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+ * For these tests, we are testing the filtering logic, not grouping or sorting</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+ *  logic.  The view tests are responsible for that stuff.  We test that:</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+ *</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+ * 1) The view is populated correctly on open.</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+ * 2) The view adds things that become relevant.</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+ * 3) The view removes things that are no longer relevant.  Because views like</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+ *    to be stable (read: messages don't disappear as you look at them), this</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+ *    requires refreshing the view (unless the message has been deleted).</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+ */</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+/**</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+ * Test the kViewItemUnread mail-view case.  This functionality is equivalent</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+ *  to the kUnreadOnly view flag case, so it uses roughly the same test as</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+ *  test_real_folder_flags_show_unread.</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+ */</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+function test_real_folder_mail_views_unread() {</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+  let [folder, setOne, setTwo] = make_folder_with_sets(2);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+  // everything is unread to start with! #1</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemUnread);</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+  verify_messages_in_view([setOne, setTwo], viewWrapper);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+  // add some more things (unread!), make sure they appear. #2</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+  let [setThree] = make_new_sets_in_folder(folder, 1);</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+  verify_messages_in_view([setOne, setTwo, setThree], viewWrapper);</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+  // make some things read, make sure they disappear. #3 (after refresh)</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+  setTwo.setRead(true);</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+  viewWrapper.refresh(); // refresh to get the messages to disappear</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+  verify_messages_in_view([setOne, setThree], viewWrapper);</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+  // make those things un-read again. #2</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+  setTwo.setRead(false);</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+  viewWrapper.refresh(); // QUICKSEARCH-VIEW-LIMITATION-REMOVE</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+  verify_messages_in_view([setOne, setTwo, setThree], viewWrapper);</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+}</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+function test_real_folder_mail_views_tags() {</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+  // setup the initial set with the tag</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+  let [folder, setOne, setTwo] = make_folder_with_sets(2);</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+  setOne.addTag('$label1');</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+  // open, apply mail view constraint, see those messages</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemTags, '$label1');</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+  verify_messages_in_view(setOne, viewWrapper);</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+  // add some more with the tag</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+  setTwo.addTag('$label1');</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+  // make sure they showed up</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+  viewWrapper.refresh(); // QUICKSEARCH-VIEW-LIMITATION-REMOVE</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+  verify_messages_in_view([setOne, setTwo], viewWrapper);</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+  // remove them all</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+  setOne.removeTag('$label1');</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+  setTwo.removeTag('$label1');</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+  // make sure they all disappeared. #3</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+  viewWrapper.refresh();</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+  verify_empty_view(viewWrapper);</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+}</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+function test_real_folder_mail_views_not_deleted() {</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+  // not sure how to test this in the absence of an IMAP account with the IMAP</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+  //  deletion model...</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+  punt();</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+}</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+function test_real_folder_mail_views_custom_people_i_know() {</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+  // blurg. address book.</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+  punt();</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+}</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+// recent mail = less than 1 day</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+function test_real_folder_mail_views_custom_recent_mail() {</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+  // create a set that meets the threshold and a set that does not</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+  let [folder, setRecent, setOld] = make_folder_with_sets([</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+    {age: {mins: 0}},</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+    {age: {days: 2}, age_incr: {mins: 1}},</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+  ]);</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+  // open the folder, ensure only the recent guys show. #1</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, &quot;Recent Mail&quot;);</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+  verify_messages_in_view(setRecent, viewWrapper);</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+  // add two more sets, one that meets, and one that doesn't. #2</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+  let [setMoreRecent, setMoreOld] = make_new_sets_in_folder(folder, [</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+    {age: {mins: 0}},</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+    {age: {days: 2, hours: 1}, age_incr: {mins: 1}},</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+  ]);</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+  // make sure that all we see is our previous recent set and our new recent set</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+  verify_messages_in_view([setRecent, setMoreRecent], viewWrapper);</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+  // we aren't going to mess with the system clock, so no #3.</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+  // (we are assuming that the underlying code handles message deletion.  also,</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+  //  we are taking the position that message timestamps should not change.)</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+}</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+function test_real_folder_mail_views_custom_last_5_days() {</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+  // create a set that meets the threshold and a set that does not</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+  let [folder, setRecent, setOld] = make_folder_with_sets([</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+    {age: {days: 2}, age_incr: {mins: 1}},</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+    {age: {days: 6}, age_incr: {mins: 1}},</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineplus">+  ]);</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+  // open the folder, ensure only the recent guys show. #1</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, &quot;Last 5 Days&quot;);</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+  verify_messages_in_view(setRecent, viewWrapper);</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineplus">+</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+  // add two more sets, one that meets, and one that doesn't. #2</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+  let [setMoreRecent, setMoreOld] = make_new_sets_in_folder(folder, [</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+    {age: {mins: 0}},</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+    {age: {days: 5, hours: 1}, age_incr: {mins: 1}},</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+  ]);</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+  // make sure that all we see is our previous recent set and our new recent set</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+  verify_messages_in_view([setRecent, setMoreRecent], viewWrapper);</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+  // we aren't going to mess with the system clock, so no #3.</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+  // (we are assuming that the underlying code handles message deletion.  also,</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineplus">+  //  we are taking the position that message timestamps should not change.)</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+}</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineplus">+function test_real_folder_mail_views_custom_not_junk() {</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+  let [folder, setJunk, setNotJunk] = make_folder_with_sets(2);</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+  setJunk.setJunk(true);</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+  setNotJunk.setJunk(false);</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+  // open, see non-junk messages. #1</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, &quot;Not Junk&quot;);</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineplus">+  verify_messages_in_view(setNotJunk, viewWrapper);</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+  // add some more messages, have them be non-junk for now. #2</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+  let [setFlippy] = make_new_sets_in_folder(folder, 1);</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+  setFlippy.setJunk(false);</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+  viewWrapper.refresh(); // QUICKSEARCH-VIEW-LIMITATION-REMOVE</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+  verify_messages_in_view([setNotJunk, setFlippy], viewWrapper);</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+  // oops! they should be junk! #3</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+  setFlippy.setJunk(true);</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+  viewWrapper.refresh();</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+  verify_messages_in_view(setNotJunk, viewWrapper);</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+}</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+function test_real_folder_mail_views_custom_has_attachments() {</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineplus">+</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineplus">+  let attachSetDef = {attachments: [{filename: 'foo.png',</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+                                     contentType: 'image/png',</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+                                     encoding: 'base64', charset: null,</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+                                     body: 'YWJj\n', format: null}]};</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+  let noAttachSetDef = {};</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+  let [folder, setNoAttach, setAttach] =</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+    make_folder_with_sets([noAttachSetDef, attachSetDef]);</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, &quot;Has Attachments&quot;);</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+  verify_messages_in_view(setAttach, viewWrapper);</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+  let [setMoreAttach, setMoreNoAttach] =</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+    make_new_sets_in_folder(folder, [attachSetDef, noAttachSetDef]);</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+  verify_messages_in_view([setAttach, setMoreAttach], viewWrapper);</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+}</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+/* ===== Real Folder, Quick Search ===== */</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+/*</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+ * Quick-search testing is aligned according to the UI exposure, even though</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+ *  this is arguably some redundancy from a coverage perspective.</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+ *</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+ * The message generator does not generate strings containing &quot;foo&quot;, &quot;bar&quot;, or</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+ *  &quot;baz&quot; on its own, so it is okay to use these as test things ourselves.</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+ */</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+function test_real_folder_quick_search_subject () {</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+  // add a &quot;foo&quot; set and a &quot;bar&quot; set</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  let [folder, setFoo, setBar] = make_folder_with_sets([</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+    {subject: &quot;foo is a word&quot;}, {subject: &quot;bar is also a word&quot;}]);</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+  // quick-search on 'foo'</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+                                 &quot;foo&quot;);</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+  verify_messages_in_view(setFoo, viewWrapper);</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+  // quick-search on 'foo' or 'bar'</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineplus">+                                 &quot;foo|bar&quot;);</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineplus">+  verify_messages_in_view([setFoo, setBar], viewWrapper);</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+  // add a &quot;bar foo&quot; set (matches) and a &quot;nopers&quot; set (should not match)</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+  let [setFooBar, setNopers] = make_new_sets_in_folder(folder, [</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+    {subject: &quot;bar foo&quot;}, {subject: &quot;nopers&quot;}]);</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+  verify_messages_in_view([setFoo, setBar, setFooBar], viewWrapper);</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+}</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineplus">+function test_real_folder_quick_search_subject_or_from () {</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineplus">+</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+  let whoFoo = make_person_with_word_in_name(&quot;foo&quot;);</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+  let whoBar = make_person_with_word_in_address(&quot;bar&quot;);</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+  let [folder, subjFoo, fromFoo, subjBar, fromBar, setNopers] =</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineplus">+    make_folder_with_sets([{subject: &quot;foo&quot;}, {from: whoFoo},</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineplus">+                           {subject: &quot;bar&quot;}, {from: whoBar},</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineplus">+                           {}]);</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+  // search on &quot;foo&quot;</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchFromOrSubject,</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+                                 &quot;foo&quot;);</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+  verify_messages_in_view([subjFoo, fromFoo], viewWrapper);</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+  // search on &quot;foo&quot; or &quot;bar&quot;</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchFromOrSubject,</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineplus">+                                 &quot;foo|bar&quot;);</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+  verify_messages_in_view([subjFoo, fromFoo, subjBar, fromBar], viewWrapper);</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineplus">+}</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+function test_real_folder_quick_search_to_or_cc () {</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+  let whoFoo = make_person_with_word_in_name(&quot;foo&quot;);</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+  let whoBar = make_person_with_word_in_address(&quot;bar&quot;);</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+  let [folder, toFoo, ccFoo, toBar, ccBar, setNopers] =</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+    make_folder_with_sets([{to: [whoFoo]}, {cc: [whoFoo]},</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+                           {to: [whoBar]}, {cc: [whoBar]},</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineplus">+                           {}]);</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+  // search on &quot;foo&quot;</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchRecipient,</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+                                 &quot;foo&quot;);</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+  verify_messages_in_view([toFoo, ccFoo], viewWrapper);</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+  // search on &quot;foo&quot; or &quot;bar&quot;</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchRecipient,</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+                                 &quot;foo|bar&quot;);</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+  verify_messages_in_view([toFoo, ccFoo, toBar, ccBar], viewWrapper);</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+}</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+function test_real_folder_quick_search_subject_to_or_cc () {</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+  let whoFoo = make_person_with_word_in_name(&quot;foo&quot;);</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+  let whoBar = make_person_with_word_in_address(&quot;bar&quot;);</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+  let [folder, subjFoo, toFoo, ccFoo, subjBar, toBar, ccBar, setNopers] =</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+    make_folder_with_sets([{subject: &quot;foo&quot;}, {to: [whoFoo]}, {cc: [whoFoo]},</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+                           {subject: &quot;bar&quot;}, {to: [whoBar]}, {cc: [whoBar]},</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+                           {}]);</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+  // search on &quot;foo&quot;</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+  yield async_view_quick_search(viewWrapper,</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+    QuickSearchConstants.kQuickSearchRecipientOrSubject, &quot;foo&quot;);</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+  verify_messages_in_view([subjFoo, toFoo, ccFoo], viewWrapper);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+  // search on &quot;foo&quot; or &quot;bar&quot;</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+  yield async_view_quick_search(viewWrapper,</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+    QuickSearchConstants.kQuickSearchRecipientOrSubject, &quot;foo|bar&quot;);</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+  verify_messages_in_view([subjFoo, toFoo, ccFoo, subjBar, toBar, ccBar],</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+                          viewWrapper);</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+}</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+/**</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+ * The UI says &quot;entire message&quot;, but we search the body.</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+ */</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+function test_real_folder_quick_search_body () {</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+  let [folder, bodyFoo, bodyBar] =</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+    make_folder_with_sets([{body: {body: &quot;foo&quot;}},</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineplus">+                           {body: {body: &quot;bar&quot;}},</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+                           {}]);</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+  // search on &quot;foo&quot;</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchBody,</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+                                 &quot;foo&quot;);</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineplus">+  verify_messages_in_view(bodyFoo, viewWrapper);</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+  // search on &quot;bar&quot;</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchBody,</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+                                 &quot;foo|bar&quot;);</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+  verify_messages_in_view([bodyFoo, bodyBar], viewWrapper);</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+}</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+/* ===== Real Folder, Mail View and Quick Search Together */</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineplus">+/*</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineplus">+ * No need to be exhaustive here, just prove the machinery works with a mail</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+ *  view and a quick search at the same time.</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+ */</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+/**</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+ * We'll use the unread mail view with a subject quick search.</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineplus">+ */</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+function test_real_folder_mail_view_and_quick_search() {</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineplus">+  let [folder, fooOne, fooTwo, noneOne] = make_folder_with_sets([</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+    {subject: &quot;foo 1&quot;}, {subject: &quot;foo 2&quot;}, {}]);</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineplus">+</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+  // everything is unread to start with</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemUnread);</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineplus">+  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineplus">+                          &quot;foo&quot;);</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+  verify_messages_in_view([fooOne, fooTwo], viewWrapper);</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+  // add some more things (unread!), make sure they appear. #2</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+  let [fooThree, noneTwo] = make_new_sets_in_folder(folder, [</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+    {subject: &quot;foo 3&quot;}, {}]);</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+  verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+  // make some things read, make sure they disappear. #3 (after refresh)</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+  fooTwo.setRead(true);</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+  viewWrapper.refresh(); // refresh to get the messages to disappear</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineplus">+  verify_messages_in_view([fooOne, fooThree], viewWrapper);</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+  // make those things un-read again. #2</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+  fooTwo.setRead(false);</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+  viewWrapper.refresh(); // QUICKSEARCH-VIEW-LIMITATION-REMOVE</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+  verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+}</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineplus">+</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+/* ===== Real Folder, Special Views ===== */</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineplus">+function test_real_folder_special_views_threads_with_unread() {</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+  // create two maximally nested threads and add them to the folder.</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+  const count = 10;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+  let setThreadOne =</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+    new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+  let setThreadTwo =</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+    new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+  add_sets_to_folder(folder, [setThreadOne, setThreadTwo]);</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+  // open the view, set it to this special view</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineplus">+  viewWrapper.specialViewThreadsWithUnread = true;</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineplus">+  view_expand_all(viewWrapper);</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+  // no one is read at this point, make sure both threads show up.</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+  verify_messages_in_view([setThreadOne, setThreadTwo], viewWrapper);</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+  // mark both threads read, make sure they disappear (after a refresh)</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+  setThreadOne.setRead(true);</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+  setThreadTwo.setRead(true);</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+  viewWrapper.refresh();</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+  verify_empty_view(viewWrapper);</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+  // make the first thread visible by marking his last message unread</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+  setThreadOne.slice(-1).setRead(false);</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineplus">+  viewWrapper.refresh();</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+  view_expand_all(viewWrapper);</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineplus">+  verify_messages_in_view(setThreadOne, viewWrapper);</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineplus">+</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineplus">+  // make the second thread visible by marking some message in the middle</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+  setThreadTwo.slice(5, 6).setRead(false);</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineplus">+  viewWrapper.refresh();</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+  view_expand_all(viewWrapper);</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+  verify_messages_in_view([setThreadOne, setThreadTwo], viewWrapper);</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+}</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+var tests = [</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+  test_real_folder_load,</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+  test_real_folder_update,</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+  test_real_folder_load_after_real_folder_load,</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+  // - threading modes</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+  test_real_folder_threading_unthreaded,</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+  test_real_folder_threading_threaded,</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+  test_real_folder_threading_grouped_by_sort,</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+  // - view flags</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+  // (we cannot test ignored flags in local folders)</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+  test_real_folder_flags_show_unread,</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+  // - mail views: test the actual views</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineplus">+  test_real_folder_mail_views_unread,</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineplus">+  test_real_folder_mail_views_tags,</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineplus">+  test_real_folder_mail_views_not_deleted,</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineplus">+  // - mail views: test the custom views</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+  test_real_folder_mail_views_custom_people_i_know,</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+  test_real_folder_mail_views_custom_recent_mail,</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineplus">+  test_real_folder_mail_views_custom_last_5_days,</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineplus">+  test_real_folder_mail_views_custom_not_junk,</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineplus">+  test_real_folder_mail_views_custom_has_attachments,</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+  // - quick search</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+  test_real_folder_quick_search_subject,</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineplus">+  test_real_folder_quick_search_subject_or_from,</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineplus">+  test_real_folder_quick_search_to_or_cc,</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineplus">+  test_real_folder_quick_search_subject_to_or_cc,</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineplus">+  test_real_folder_quick_search_body,</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineplus">+  // - mail views with quick search</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+  test_real_folder_mail_view_and_quick_search,</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineplus">+  // - special views</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+  test_real_folder_special_views_threads_with_unread,</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+  // (we cannot test the watched threads with unread case in local folders)</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+];</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+function run_test() {</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,414 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/**</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * Test DBViewWrapper against virtual folders.</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ *</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * Things we do not test and our rationalizations:</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ * - threading stuff.  This is not the view wrapper's problem.  That is the db</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ *   view's problem!  (We test it in the real folder to make sure we are telling</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ *   it to do things correctly.)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ * - view flags.  Again, it's a db view issue once we're sure we set the bits.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * - special view with threads.  same deal.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ *</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * We could test all these things, but my patch is way behind schedule...</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ */</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+/**</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * Make sure we open a virtual folder backed by a single underlying folder</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ *  correctly; no constraints.</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ */</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+function test_virtual_folder_single_load_no_pred() {</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  let [folderOne, setOne] = make_folder_with_sets(1);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne], {});</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  do_check_true(viewWrapper.isVirtual, true);</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  verify_messages_in_view(setOne, viewWrapper);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+}</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+/**</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+ * Make sure we open a virtual folder backed by a single underlying folder</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ *  correctly; one constraint.</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ */</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+function test_virtual_folder_single_load_simple_pred() {</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  let [folderOne, oneSubjFoo, oneNopers] = make_folder_with_sets([</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne],</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+                                       {subject: &quot;foo&quot;});</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  verify_messages_in_view(oneSubjFoo, viewWrapper);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+}</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+/**</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+ * Make sure we open a virtual folder backed by a single underlying folder</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+ *  correctly; two constraints ANDed together.</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+ */</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+function test_virtual_folder_single_load_complex_pred() {</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  let whoBar = make_person_with_word_in_name(&quot;bar&quot;);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  let [folderOne, oneSubjOnly, oneFromOnly, oneBoth, oneNone] =</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    make_folder_with_sets([{subject: &quot;foo&quot;}, {from: whoBar},</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+                           {subject: &quot;foo&quot;, from: whoBar}, {}]);</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne],</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+                                       {subject: &quot;foo&quot;, from: &quot;bar&quot;},</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                                       /* and? */ true);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  verify_messages_in_view(oneBoth, viewWrapper);</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+}</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+/**</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+ * Open a single-backed virtual folder, verify, open another single-backed</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+ *  virtual folder, verify.  We are testing our ability to change folders</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+ *  without exploding.</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+ */</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+function test_virtual_folder_single_load_after_load() {</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  let [folderOne, oneSubjFoo, oneNopers] = make_folder_with_sets([</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+  let virtOne = make_virtual_folder([folderOne],</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+                                    {subject: &quot;foo&quot;});</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  // use &quot;bar&quot; instead of &quot;foo&quot; to make sure constraints are properly changing</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  let [folderTwo, twoSubjBar, twoNopers] = make_folder_with_sets([</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+    {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+  let virtTwo = make_virtual_folder([folderTwo],</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+                                    {subject: &quot;bar&quot;});</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+  yield async_view_open(viewWrapper, virtTwo);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+  verify_messages_in_view([twoSubjBar], viewWrapper);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+}</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+/**</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+ * Make sure we open a virtual folder backed by multiple underlying folders</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+ *  correctly; no constraints.</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+ */</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+function test_virtual_folder_multi_load_no_pred() {</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+  let [folderOne, setOne] = make_folder_with_sets(1);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  let [folderTwo, setTwo] = make_folder_with_sets(1);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne, folderTwo], {});</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+  verify_messages_in_view([setOne, setTwo], viewWrapper);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+}</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+/**</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+ * Make sure we open a virtual folder backed by multiple underlying folders</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+ *  correctly; one constraint.</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+ */</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+function test_virtual_folder_multi_load_simple_pred() {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+  let [folderOne, oneSubjFoo, oneNopers] = make_folder_with_sets([</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+  let [folderTwo, twoSubjFoo, twoNopers] = make_folder_with_sets([</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne, folderTwo],</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+                                       {subject: &quot;foo&quot;});</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  verify_messages_in_view([oneSubjFoo, twoSubjFoo], viewWrapper);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+}</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+/**</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+ * Make sure we open a virtual folder backed by multiple underlying folders</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+ *  correctly; two constraints ANDed together.</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+ */</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+function test_virtual_folder_multi_load_complex_pred() {</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+  let whoBar = make_person_with_word_in_name(&quot;bar&quot;);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  let [folderOne, oneSubjOnly, oneFromOnly, oneBoth, oneNone] =</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    make_folder_with_sets([{subject: &quot;foo&quot;}, {from: whoBar},</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+                           {subject: &quot;foo&quot;, from: whoBar}, {}]);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+  let [folderTwo, twoSubjOnly, twoFromOnly, twoBoth, twoNone] =</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    make_folder_with_sets([{subject: &quot;foo&quot;}, {from: whoBar},</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+                           {subject: &quot;foo&quot;, from: whoBar}, {}]);</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne, folderTwo],</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+                                       {subject: &quot;foo&quot;, from: &quot;bar&quot;},</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+                                       /* and? */ true);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+  verify_messages_in_view([oneBoth, twoBoth], viewWrapper);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+}</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+function test_virtual_folder_multi_load_alotta_folders_no_pred() {</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+  const folderCount = 4;</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+  const messageCount = 64;</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+  let [folders, setOne] = make_folders_with_sets(folderCount,</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+                                                 [{count: messageCount}]);</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+  let virtFolder = make_virtual_folder(folders, {});</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+  verify_messages_in_view([setOne], viewWrapper);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+}</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+function test_virtual_folder_multi_load_alotta_folders_simple_pred() {</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+  const folderCount = 16;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+  const messageCount = 256;</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+  let [folders, setOne] = make_folders_with_sets(folderCount,</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+    [{subject: &quot;foo&quot;, count: messageCount}]);</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+  let virtFolder = make_virtual_folder(folders, {subject: &quot;foo&quot;});</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+  verify_messages_in_view([setOne], viewWrapper);</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+}</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+/**</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+ * Make sure that opening a virtual folder backed by multiple real folders, then</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+ *  opening another virtual folder of the same variety works without explosions.</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+ */</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+function test_virtual_folder_multi_load_after_load() {</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+  let [foldersOne, oneSubjFoo, oneNopers] = make_folders_with_sets(2, [</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+  let virtOne = make_virtual_folder(foldersOne, {subject: &quot;foo&quot;});</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+  yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+  // use &quot;bar&quot; instead of &quot;foo&quot; to make sure constraints are properly changing</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+  let [foldersTwo, twoSubjBar, twoNopers] = make_folders_with_sets(3, [</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+    {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+  let virtTwo = make_virtual_folder(foldersTwo,</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+                                    {subject: &quot;bar&quot;});</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+  yield async_view_open(viewWrapper, virtTwo);</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+  verify_messages_in_view([twoSubjBar], viewWrapper);</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+  yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+  verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+}</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+/**</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+ * Make sure that opening a virtual folder backed by a single real folder, then</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+ *  a multi-backed one, then the single-backed one again doesn't explode.</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+ *</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+ * This is just test_virtual_folder_multi_load_after_load with foldersOne told</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+ *  to create just a single folder.</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+ */</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+function test_virtual_folder_combo_load_after_load() {</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+  let [foldersOne, oneSubjFoo, oneNopers] = make_folders_with_sets(1, [</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+  let virtOne = make_virtual_folder(foldersOne, {subject: &quot;foo&quot;});</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+  yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+  verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+  // use &quot;bar&quot; instead of &quot;foo&quot; to make sure constraints are properly changing</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+  let [foldersTwo, twoSubjBar, twoNopers] = make_folders_with_sets(3, [</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+    {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+  let virtTwo = make_virtual_folder(foldersTwo,</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+                                    {subject: &quot;bar&quot;});</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+  yield async_view_open(viewWrapper, virtTwo);</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+  verify_messages_in_view([twoSubjBar], viewWrapper);</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+  yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+  verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+}</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+/**</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+ * Verify that if one of the folders backing our virtual folder is deleted that</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+ *  we do not explode.  Then verify that if we remove the rest of them that the</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+ *  view wrapper closes itself.</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+ */</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+function test_virtual_folder_underlying_folder_deleted() {</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+  let [folderOne, oneSubjFoo, oneNopers] = make_folder_with_sets([</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+  let [folderTwo, twoSubjFoo, twoNopers] = make_folder_with_sets([</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+    {subject: &quot;foo&quot;}, {}]);</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+  let virtFolder = make_virtual_folder([folderOne, folderTwo],</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+                                       {subject: &quot;foo&quot;});</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+  // bam!</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+  delete_folder(folderOne);</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+  // only messages from the surviving folder should be present</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+  verify_messages_in_view([twoSubjFoo], viewWrapper);</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+  // bam! bam!</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+  delete_folder(folderTwo);</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+  // now the view wrapper should have closed itself.</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+  do_check_eq(null, viewWrapper.displayedFolder);</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+}</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+/* ===== Virtual Folder, Mail Views ===== */</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+/*</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+ * We do not need to test all of the mail view permutations, realFolder</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+ *  already did that.  We just need to make sure it works at all.</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+ */</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+function test_virtual_folder_mail_views_unread(aNumFolders) {</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+  let [folders, fooOne, fooTwo, nopeOne, nopeTwo] = make_folders_with_sets(</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+    aNumFolders, [{subject: &quot;foo 1&quot;}, {subject: &quot;foo 2&quot;}, {}, {}]);</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+  let virtFolder = make_virtual_folder(folders, {subject: &quot;foo&quot;});</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+  // everything is unread to start with!</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemUnread);</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+  verify_messages_in_view([fooOne, fooTwo], viewWrapper);</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+  // add some more things (unread!), make sure they appear.</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+  let [fooThree, nopeThree] = make_new_sets_in_folders(folders,</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+    [{subject: &quot;foo 3&quot;}, {}]);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+  verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+  // make some things read, make sure they disappear. (after a refresh)</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+  fooTwo.setRead(true);</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+  yield async_view_refresh(viewWrapper);</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+  verify_messages_in_view([fooOne, fooThree], viewWrapper);</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+  // make those things un-read again.</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+  fooTwo.setRead(false);</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+  // I thought this was a quick search limitation, but XFVF needs it to, at</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+  //  least for the unread case.</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+  yield async_view_refresh(viewWrapper);</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+  verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+}</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+/* ===== Virtual Folder, Quick Search  ===== */</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+/*</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+ * We do not need to test all of the quick search permutations, realFolder</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+ *  already did that.  We just need to make sure that quick search works</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+ *  with single-folder and multi-folder virtual folders.  Additionally, we</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+ *  need to make sure that it works for simple and complex virtual folders.</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+ * We handle the single and multi folder cases with the same test code, just</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+ *  parameterized over the number of folders.  We use 4 folders for the multi</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+ *  folder case to encourage the time slicing logic to split itself up.</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+ */</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+function test_virtual_folder_param_quick_search_simple(aNumFolders) {</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+  // venn it up.  virtual folder search on &quot;foo&quot;, actual search will be on &quot;bar&quot;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+  let [folders, subjFooBar, subjFoo, subjBar, nopers] =</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+    make_folders_with_sets(aNumFolders,</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+      [{subject: &quot;foo bar&quot;}, {subject: &quot;foo&quot;}, {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+  let virt = make_virtual_folder(folders, {subject: &quot;foo&quot;});</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+  yield async_view_open(viewWrapper, virt);</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+  verify_messages_in_view([subjFooBar, subjFoo], viewWrapper);</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+  yield async_view_quick_search(viewWrapper,</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+                                QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+                                &quot;bar&quot;);</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+  verify_messages_in_view([subjFooBar], viewWrapper);</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+}</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+function test_virtual_folder_param_quick_search_complex(aNumFolders) {</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+  let whoBaz = make_person_with_word_in_address(&quot;baz&quot;);</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+  // virtual folder is on &quot;foo&quot; and &quot;baz&quot;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+  // quick search is on &quot;bar&quot;</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+  let [folders, fooBarBaz, fooBar, fooBaz, foo, barBaz, bar, baz, nopers] =</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+    make_folders_with_sets(aNumFolders,</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+      [{subject: &quot;foo bar&quot;, from: whoBaz}, {subject: &quot;foo bar&quot;},</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+       {subject: &quot;foo&quot;, from: whoBaz}, {subject: &quot;foo&quot;},</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+       {subject: &quot;bar&quot;, from: whoBaz}, {subject: &quot;bar&quot;},</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+       {from: whoBaz}, {}]);</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+  let virt = make_virtual_folder(folders, {subject: &quot;foo&quot;, from: &quot;baz&quot;}, true);</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+  yield async_view_open(viewWrapper, virt);</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+  verify_messages_in_view([fooBarBaz, fooBaz], viewWrapper);</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+  yield async_view_quick_search(viewWrapper,</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+                                QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+                                &quot;bar&quot;);</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+  verify_messages_in_view([fooBarBaz], viewWrapper);</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+}</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+/* ===== Virtual Folder, Mail View and Quick Search ===== */</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+function test_virtual_folder_param_mail_view_and_quick_search(aNumFolders) {</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+  // virtual folder search on &quot;foo&quot;</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+  // quick search on &quot;bar&quot;</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+  let [folders, fooBarOne, fooBarTwo, foo, bar, nopers] =</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+    make_folders_with_sets(aNumFolders,</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+      [{subject: &quot;foo bar 1&quot;}, {subject: &quot;foo bar 2&quot;}, {subject: &quot;foo&quot;},</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+       {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+  let virt = make_virtual_folder(folders, {subject: &quot;foo&quot;});</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+  yield async_view_open(viewWrapper, virt);</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemUnread);</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+  yield async_view_quick_search(viewWrapper,</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+                                QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+                                &quot;bar&quot;);</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+  verify_messages_in_view([fooBarOne, fooBarTwo], viewWrapper);</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+  fooBarTwo.setRead(true);</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+  yield async_view_refresh(viewWrapper);</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+  verify_messages_in_view(fooBarOne, viewWrapper);</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+}</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+var tests = [</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+  // -- single-folder backed virtual folder</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+  test_virtual_folder_single_load_no_pred,</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+  test_virtual_folder_single_load_simple_pred,</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+  test_virtual_folder_single_load_complex_pred,</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+  test_virtual_folder_single_load_after_load,</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+  // -- multi-folder backed virtual folder</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+  test_virtual_folder_multi_load_no_pred,</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+  test_virtual_folder_multi_load_simple_pred,</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+  test_virtual_folder_multi_load_complex_pred,</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+  test_virtual_folder_multi_load_alotta_folders_no_pred,</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+  test_virtual_folder_multi_load_alotta_folders_simple_pred,</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+  test_virtual_folder_multi_load_after_load,</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+  // -- mixture of single-backed and multi-backed</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+  test_virtual_folder_combo_load_after_load,</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+  // -- rare/edge cases!</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+  test_virtual_folder_underlying_folder_deleted,</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+  // -- mail views (parameterized)</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+  parameterizeTest(test_virtual_folder_mail_views_unread, [1, 4]),</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+  // -- quick search (parameterized for single and multi folder cases)</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+  parameterizeTest(test_virtual_folder_param_quick_search_simple, [1, 4]),</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+  parameterizeTest(test_virtual_folder_param_quick_search_complex, [1, 4]),</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+  // -- mail view with quick search</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+  parameterizeTest(test_virtual_folder_param_mail_view_and_quick_search,[1, 4]),</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+];</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineplus">+function run_test() {</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -61,26 +61,26 @@ let Ci = Components.interfaces;</span>
<a href="#l11.4"></a><span id="l11.4">  *         var array = [a for each (a in fixIterator(xpcomEnumerator))];</span>
<a href="#l11.5"></a><span id="l11.5">  */</span>
<a href="#l11.6"></a><span id="l11.6"> function fixIterator(aEnum, aIface) {</span>
<a href="#l11.7"></a><span id="l11.7">   // is it a javascript array?  We can't do instanceof because we, as a module,</span>
<a href="#l11.8"></a><span id="l11.8">   //  get our own copy of Array, which is guaranteed distinct from our caller's</span>
<a href="#l11.9"></a><span id="l11.9">   //  Array instance.  So we test for .length</span>
<a href="#l11.10"></a><span id="l11.10">   if (aEnum.length) {</span>
<a href="#l11.11"></a><span id="l11.11">     if (!aIface)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      return Iterator(aEnum);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    else // use a cool generator expression</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+      return (o for ([, o] in Iterator(aEnum)));</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+    else</span>
<a href="#l11.16"></a><span id="l11.16">       return (o.QueryInterface(aIface) for ([,o] in Iterator(aEnum)));</span>
<a href="#l11.17"></a><span id="l11.17">   }</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   // is it a javascript Iterator?  same deal on instanceof</span>
<a href="#l11.20"></a><span id="l11.20">   if (aEnum.next) {</span>
<a href="#l11.21"></a><span id="l11.21">     if (!aIface)</span>
<a href="#l11.22"></a><span id="l11.22">       return aEnum;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-    else // use a cool generator expression</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+    else</span>
<a href="#l11.25"></a><span id="l11.25">       return (o.QueryInterface(aIface) for (o in aEnum));</span>
<a href="#l11.26"></a><span id="l11.26">   }</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   let face = aIface || Ci.nsISupports;</span>
<a href="#l11.29"></a><span id="l11.29">   // Figure out which kind of iterator we have</span>
<a href="#l11.30"></a><span id="l11.30">   if (aEnum instanceof Ci.nsISupportsArray) {</span>
<a href="#l11.31"></a><span id="l11.31">     let iter = function() {</span>
<a href="#l11.32"></a><span id="l11.32">       let count = aEnum.Count();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -287,17 +287,17 @@ var Gloda = {</span>
<a href="#l12.4"></a><span id="l12.4">    *</span>
<a href="#l12.5"></a><span id="l12.5">    * @return The collection that will receive the results.</span>
<a href="#l12.6"></a><span id="l12.6">    */</span>
<a href="#l12.7"></a><span id="l12.7">   getMessageCollectionForHeaders: function gloda_ns_getMessagesForHeaders(</span>
<a href="#l12.8"></a><span id="l12.8">       aHeaders, aListener, aData) {</span>
<a href="#l12.9"></a><span id="l12.9">     // group the headers by the folder they are found in</span>
<a href="#l12.10"></a><span id="l12.10">     let headersByFolder = {};</span>
<a href="#l12.11"></a><span id="l12.11">     let iter;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    for (let [, header] in fixIterator(aHeaders)) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    for (let header in fixIterator(aHeaders)) {</span>
<a href="#l12.14"></a><span id="l12.14">       let folderURI = header.folder.URI;</span>
<a href="#l12.15"></a><span id="l12.15">       let headersForFolder = headersByFolder[folderURI];</span>
<a href="#l12.16"></a><span id="l12.16">       if (headersForFolder === undefined)</span>
<a href="#l12.17"></a><span id="l12.17">         headersByFolder[folderURI] = [header];</span>
<a href="#l12.18"></a><span id="l12.18">       else</span>
<a href="#l12.19"></a><span id="l12.19">         headersForFolder.push(header);</span>
<a href="#l12.20"></a><span id="l12.20">     }</span>
<a href="#l12.21"></a><span id="l12.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/test/resources/asyncTestUtils.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/test/resources/asyncTestUtils.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -25,44 +25,69 @@ var asyncCopyListener = {</span>
<a href="#l13.4"></a><span id="l13.4">   SetMessageKey: function(aMsgKey) {},</span>
<a href="#l13.5"></a><span id="l13.5">   GetMessageId: function() {},</span>
<a href="#l13.6"></a><span id="l13.6">   OnStopCopy: function(aStatus) {</span>
<a href="#l13.7"></a><span id="l13.7">     async_driver();</span>
<a href="#l13.8"></a><span id="l13.8">   }</span>
<a href="#l13.9"></a><span id="l13.9"> };</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> /**</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">- * Delete one or synthetic messages from gTestFolder.  The arguments can be one</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Delete one or more synthetic messages.  If using SyntheticMessageSets, call</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ *  once for each SyntheticMessageSet.  Otherwise, we take synthetic message</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ *  instances that are assumed to live in gTestFolder.  The arguments can be one</span>
<a href="#l13.16"></a><span id="l13.16">  *  or more synthetic message instances or a singe list of synthetic messages.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">- *  (Synthetic messages are from messageGenerator.js)</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ *  (Synthetic messages are from messageGenerator.js, SyntheticMessageSets are</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *  from messageModifier.js)</span>
<a href="#l13.20"></a><span id="l13.20">  *</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">- * Usage example:</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * Usage example using a SyntheticMessageSet (which defines the folder):</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ *  yield async_delete_messages(syntheticMessageSet);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *  yield async_delete_messages(new SyntheticMessageSet(folder, [synMsg]);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * Usage example assuming gTestFolder:</span>
<a href="#l13.26"></a><span id="l13.26">  *  yield async_delete_messages(synMsg);</span>
<a href="#l13.27"></a><span id="l13.27">  *  yield async_delete_messages(synMsg1, synMsg2);</span>
<a href="#l13.28"></a><span id="l13.28">  *  yield async_delete_messages([synMsg1, synMsg2]);</span>
<a href="#l13.29"></a><span id="l13.29">  */</span>
<a href="#l13.30"></a><span id="l13.30"> function async_delete_messages() {</span>
<a href="#l13.31"></a><span id="l13.31">   let synMessages;</span>
<a href="#l13.32"></a><span id="l13.32">   if (arguments.length &gt; 1)</span>
<a href="#l13.33"></a><span id="l13.33">     synMessages = arguments;</span>
<a href="#l13.34"></a><span id="l13.34">   else if (arguments[0].length)</span>
<a href="#l13.35"></a><span id="l13.35">     synMessages = arguments[0];</span>
<a href="#l13.36"></a><span id="l13.36">   else</span>
<a href="#l13.37"></a><span id="l13.37">     synMessages = [arguments[0]];</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  let msgDatabase = gTestFolder.msgDatabase;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  synMessages.forEach(function (synMsg) {</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-    let hdr = msgDatabase.getMsgHdrForMessageID(synMsg.messageId);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    array.appendElement(hdr, false);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  });</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  if (synMessages.length == 0)</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+    do_throw(&quot;You need to tell us to delete at least one thing!&quot;);</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  gTestFolder.deleteMessages(array, null, false, true, asyncCopyListener, true);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-  return false;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  // SyntheticMessageSet case</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  if (synMessages[0].synMessages) {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    let messageSet = synMessages[0];</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+    // because synthetic message sets</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    return async_run({func: function () {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+        for (let [folder, xpcomHdrArray] in</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+             messageSet.foldersWithXpcomHdrArrays) {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+          folder.deleteMessages(xpcomHdrArray, null, false, true,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+                                asyncCopyListener, true);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+          yield false;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        }</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      },</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+    });</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  }</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  // a list of synthetic messages case</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  else {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    let msgDatabase = gTestFolder.msgDatabase;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+    let hdrArr = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    synMessages.forEach(function (synMsg) {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+      hdrArr.appendElement(msgDatabase.getMsgHdrForMessageID(synMsg.messageId),</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+                           false);</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    });</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    gTestFolder.deleteMessages(hdrArr, null, false, true, asyncCopyListener,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+                               true);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    return false;</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  }</span>
<a href="#l13.77"></a><span id="l13.77"> }</span>
<a href="#l13.78"></a><span id="l13.78"> </span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80"> var asyncGeneratorStack = [];</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82"> /**</span>
<a href="#l13.83"></a><span id="l13.83">  * Run a function that may or may not be a generator.  All functions, generator</span>
<a href="#l13.84"></a><span id="l13.84">  *  or not, must return false if they do not want the async_driver to run the</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineat">@@ -81,51 +106,160 @@ var asyncGeneratorStack = [];</span>
<a href="#l13.86"></a><span id="l13.86">  * Usage example:</span>
<a href="#l13.87"></a><span id="l13.87">  *  yield async_run({func: a_normal_function});</span>
<a href="#l13.88"></a><span id="l13.88">  *  yield async_run({func: a_generator_function});</span>
<a href="#l13.89"></a><span id="l13.89">  *  yield async_run({dis: Foo, func: Foo.func, args: [1, 2, 3]});</span>
<a href="#l13.90"></a><span id="l13.90">  */</span>
<a href="#l13.91"></a><span id="l13.91"> function async_run(aArgs) {</span>
<a href="#l13.92"></a><span id="l13.92">   let result = aArgs.func.apply(aArgs.dis || null, aArgs.args || []);</span>
<a href="#l13.93"></a><span id="l13.93">   if (result &amp;&amp; result.next) {</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-    asyncGeneratorStack.push(result);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+    asyncGeneratorStack.push([result, aArgs.func.name]);</span>
<a href="#l13.96"></a><span id="l13.96">     return _async_driver();</span>
<a href="#l13.97"></a><span id="l13.97">   }</span>
<a href="#l13.98"></a><span id="l13.98">   else {</span>
<a href="#l13.99"></a><span id="l13.99">     if (result === undefined)</span>
<a href="#l13.100"></a><span id="l13.100">       return true;</span>
<a href="#l13.101"></a><span id="l13.101">     else</span>
<a href="#l13.102"></a><span id="l13.102">       return result;</span>
<a href="#l13.103"></a><span id="l13.103">   }</span>
<a href="#l13.104"></a><span id="l13.104"> }</span>
<a href="#l13.105"></a><span id="l13.105"> </span>
<a href="#l13.106"></a><span id="l13.106"> /**</span>
<a href="#l13.107"></a><span id="l13.107">  * Function to kick off/resume asynchronous processing.  Any function invoked by</span>
<a href="#l13.108"></a><span id="l13.108">  *  async_run that returns/yields false at any point is responsible for ensuring</span>
<a href="#l13.109"></a><span id="l13.109">  *  async_driver() is called again once the async operation completes.</span>
<a href="#l13.110"></a><span id="l13.110">  *</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">- * Note: This function actually schedules the real driver to run after a timeout.</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">- *  This is to ensure that if you call us from a notification event that all the</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">- *  other things getting notified get a chance to do their work before we actually</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">- *  continue execution.  It also keeps our stack traces cleaner.</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+ * Note: This function actually schedules the real driver to run after a</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+ *  timeout. This is to ensure that if you call us from a notification event</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+ *  that all the other things getting notified get a chance to do their work</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+ *  before we actually continue execution.  It also keeps our stack traces</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+ *  cleaner.</span>
<a href="#l13.120"></a><span id="l13.120">  */</span>
<a href="#l13.121"></a><span id="l13.121"> function async_driver() {</span>
<a href="#l13.122"></a><span id="l13.122">   do_timeout_function(0, _async_driver);</span>
<a href="#l13.123"></a><span id="l13.123"> }</span>
<a href="#l13.124"></a><span id="l13.124"> </span>
<a href="#l13.125"></a><span id="l13.125"> // the real driver!</span>
<a href="#l13.126"></a><span id="l13.126"> function _async_driver() {</span>
<a href="#l13.127"></a><span id="l13.127">   let curGenerator;</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-  while ((curGenerator = asyncGeneratorStack[asyncGeneratorStack.length-1])) {</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+  while (asyncGeneratorStack.length) {</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+    curGenerator = asyncGeneratorStack[asyncGeneratorStack.length-1][0];</span>
<a href="#l13.131"></a><span id="l13.131">     try {</span>
<a href="#l13.132"></a><span id="l13.132">       while (curGenerator.next()) {</span>
<a href="#l13.133"></a><span id="l13.133">       }</span>
<a href="#l13.134"></a><span id="l13.134">       return false;</span>
<a href="#l13.135"></a><span id="l13.135">     }</span>
<a href="#l13.136"></a><span id="l13.136">     catch (ex) {</span>
<a href="#l13.137"></a><span id="l13.137">       if (ex != StopIteration) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+        dump(&quot;*******************************************\n&quot;);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+        dump(&quot;Generator explosion!\n&quot;);</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+        dump(&quot;Unhappiness at: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;\n&quot;);</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+        dump(&quot;Because: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+        dump(&quot;**** Async Generator Stack source functions:\n&quot;);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+        for (let i = asyncGeneratorStack.length - 1; i &gt;= 0; i--) {</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+          dump(&quot;  &quot; + asyncGeneratorStack[i][1] + &quot;\n&quot;);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+        }</span>
<a href="#l13.146"></a><span id="l13.146">         do_throw(ex);</span>
<a href="#l13.147"></a><span id="l13.147">       }</span>
<a href="#l13.148"></a><span id="l13.148">       asyncGeneratorStack.pop();</span>
<a href="#l13.149"></a><span id="l13.149">     }</span>
<a href="#l13.150"></a><span id="l13.150">   }</span>
<a href="#l13.151"></a><span id="l13.151">   return true;</span>
<a href="#l13.152"></a><span id="l13.152"> }</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+var ASYNC_TEST_RUNNER_HELPERS = [];</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+/**</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+ * If you are test helper code using asyncTestUtils, then you might want to</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+ *  provide a helper object.  We will let you do things after each test</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+ *  completes, and if a test times out, etc.</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+ *</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+ * @param aHelper A helper object which may have the following functions:</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+ * - postTest: This gets called after each test completes.</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+ * - onTimeout: This gets called if a test times out.</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+ */</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+function async_test_runner_register_helper(aHelper) {</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+  ASYNC_TEST_RUNNER_HELPERS.push(aHelper);</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+}</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+function _async_test_runner_postTest() {</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+  for each (let [, helper] in Iterator(ASYNC_TEST_RUNNER_HELPERS)) {</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+    if (helper.postTest)</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+      helper.postTest();</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+  }</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+}</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+function _async_test_runner_timeout() {</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+  for each (let [, helper] in Iterator(ASYNC_TEST_RUNNER_HELPERS)) {</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    try {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+      if (helper.onTimeout)</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+        helper.onTimeout();</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+    }</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+    catch (ex) {</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+      dump(&quot;warning: helper failure: (&quot; + ex.fileName + &quot;:&quot; + ex.lineNumber +</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+           &quot;): &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+    }</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+  }</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+  do_throw('Timeout running test, and we want you to have the log.');</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+}</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+/**</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+ * Purely decorative function to help explain to people reading lists of tests</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+ *  using async_run_tests what is going on.  We just return a tuple of our</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+ *  arguments and _async_test_runner understands what to do with this, namely</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+ *  to run the test once for each element in the aParameters list.  If the</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+ *  elements in the aParameters list have a 'name' attribute, it will get</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+ *  printed out to help figure out what is actually happening.</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+ */</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+function parameterizeTest(aTestFunc, aParameters) {</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+  return [aTestFunc, aParameters];</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+}</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+DEFAULT_LONGEST_TEST_RUN_CONCEIVABLE_SECS = 60;</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+function async_run_tests(aTests, aLongestTestRunTimeConceivableInSecs) {</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+  if (aLongestTestRunTimeConceivableInSecs == null)</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+    aLongestTestRunTimeConceivableInSecs =</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+        DEFAULT_LONGEST_TEST_RUN_CONCEIVABLE_SECS;</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+  do_timeout(aLongestTestRunTimeConceivableInSecs * 1000,</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+      &quot;_async_test_runner_timeout();&quot;);</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+  do_test_pending();</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+  async_run({func: _async_test_runner, args: [aTests]});</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+}</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+function _async_test_runner(aTests) {</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+  for each (let [, test] in Iterator(aTests)) {</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+    // parameterized?</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+    if (test.length) {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+      let [testFunc, parameters] = test;</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+      for each (let [, parameter] in Iterator(parameters)) {</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+        let paramDesc, args;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+        if (typeof(parameter) == &quot;object&quot;) {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+          if (parameter.length) {</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+            paramDesc = parameter.toString();</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+            args = parameter;</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+          }</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+          else {</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+            paramDesc = parameter.name;</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+            args = [parameter];</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+          }</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+        }</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+        else {</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+          paramDesc = parameter.toString();</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+          args = [parameter];</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+        }</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+        dump(&quot;=== Running test: &quot; + testFunc.name + &quot; Parameter: &quot; +</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+             paramDesc + &quot;\n&quot;);</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+        yield async_run({func: testFunc, args: args});</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+        _async_test_runner_postTest();</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+      }</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+    }</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+    else {</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+      dump(&quot;=== Running test: &quot; + test.name + &quot;\n&quot;);</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+      yield async_run({func: test});</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+      _async_test_runner_postTest();</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+    }</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+  }</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+  dump(&quot;=== (Done With Tests)\n&quot;);</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+  do_test_finished();</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/test/resources/messageGenerator.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/test/resources/messageGenerator.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -742,17 +742,21 @@ MessageGenerator.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4">    * @param aArgs An object with any of the following attributes provided:</span>
<a href="#l14.5"></a><span id="l14.5">    *     age: A dictionary with potential attributes 'minutes', 'hours', 'days',</span>
<a href="#l14.6"></a><span id="l14.6">    *         'weeks' to specify the message be created that far in the past.</span>
<a href="#l14.7"></a><span id="l14.7">    *     attachments: A list of dictionaries suitable for passing to</span>
<a href="#l14.8"></a><span id="l14.8">    *         syntheticPartLeaf, plus a 'body' attribute that has already been</span>
<a href="#l14.9"></a><span id="l14.9">    *         encoded.  Line chopping is on you FOR NOW.</span>
<a href="#l14.10"></a><span id="l14.10">    *     body: A dictionary suitable for passing to SyntheticPart plus a 'body'</span>
<a href="#l14.11"></a><span id="l14.11">    *         attribute that has already been encoded (if encoding is required).</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-   *         Line chopping is on you FOR NOW.</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+   *         Line chopping is on you FOR NOW.  Alternately, use bodyPart.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+   *     bodyPart: A SyntheticPart to uses as the body.  If you provide an</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+   *         attachments value, this part will be wrapped in a multipart/mixed</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+   *         to also hold your attachments.  (You can put attachments in the</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+   *         bodyPart directly if you want and not use attachments.)</span>
<a href="#l14.18"></a><span id="l14.18">    *     callerData: A value to propagate to the callerData attribute on the</span>
<a href="#l14.19"></a><span id="l14.19">    *         resulting message.</span>
<a href="#l14.20"></a><span id="l14.20">    *     inReplyTo: the SyntheticMessage this message should be in reply-to.</span>
<a href="#l14.21"></a><span id="l14.21">    *         If that message was in reply to another message, we will</span>
<a href="#l14.22"></a><span id="l14.22">    *         appropriately compensate for that.</span>
<a href="#l14.23"></a><span id="l14.23">    *     replyAll: a boolean indicating whether this should be a reply-to-all or</span>
<a href="#l14.24"></a><span id="l14.24">    *         just to the author of the message.  (er, to-only, not cc.)</span>
<a href="#l14.25"></a><span id="l14.25">    *     subject: The subject to use; you are responsible for doing any encoding</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineat">@@ -784,16 +788,18 @@ MessageGenerator.prototype = {</span>
<a href="#l14.27"></a><span id="l14.27">                                    [srcMsg.headers[&quot;Message-Id&quot;]]);</span>
<a href="#l14.28"></a><span id="l14.28">     }</span>
<a href="#l14.29"></a><span id="l14.29">     else {</span>
<a href="#l14.30"></a><span id="l14.30">       msg.parent = null;</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32">       msg.subject = aArgs.subject || this.makeSubject();</span>
<a href="#l14.33"></a><span id="l14.33">       msg.from = aArgs.from || this.makeNameAndAddress();</span>
<a href="#l14.34"></a><span id="l14.34">       msg.to = aArgs.to || this.makeNamesAndAddresses(aArgs.toCount || 1);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+      if (aArgs.cc)</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+        msg.cc = aArgs.cc;</span>
<a href="#l14.37"></a><span id="l14.37">     }</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">     msg.children = [];</span>
<a href="#l14.40"></a><span id="l14.40">     msg.messageId = this.makeMessageId(msg);</span>
<a href="#l14.41"></a><span id="l14.41">     if (aArgs.age) {</span>
<a href="#l14.42"></a><span id="l14.42">       let age = aArgs.age;</span>
<a href="#l14.43"></a><span id="l14.43">       // start from 'now'</span>
<a href="#l14.44"></a><span id="l14.44">       let ts = new Date().valueOf();</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineat">@@ -828,17 +834,71 @@ MessageGenerator.prototype = {</span>
<a href="#l14.46"></a><span id="l14.46">       bodyPart = new SyntheticPartMultiMixed(parts);</span>
<a href="#l14.47"></a><span id="l14.47">     }</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49">     msg.bodyPart = bodyPart;</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">     msg.callerData = aArgs.callerData;</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53">     return msg;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  }</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  },</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  MAKE_MESSAGES_DEFAULTS: {</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+    count: 10,</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  },</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  MAKE_MESSAGES_PROPAGATE: ['attachments', 'body', 'cc', 'from', 'subject', 'to'],</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  /**</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+   * Given a set definition, produce a list of synthetic messages.</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+   *</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+   * The set definition supports the following attributes:</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+   *  count: The number of messages to create.</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+   *  age: As used by makeMessage.</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+   *  age_incr: Similar to age, but used to increment the values in the age</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+   *      dictionary (assuming a value of zero if omitted).</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+   *</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+   * Also supported are the following attributes as defined by makeMessage:</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+   *  attachments, body, from, subject, to</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+   *</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+   * If omitted, the following defaults are used:</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+   *  count: 10</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+   */</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  makeMessages: function MessageGenerator_makeMessages(aSetDef) {</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    let messages = [];</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+    let args = {};</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+    // zero out all the age_incr fields in age (if present)</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+    if (aSetDef.age_incr) {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+      args.age = {};</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+      for (let [unit, delta] in Iterator(aSetDef.age_incr))</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+        args.age[unit] = 0;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+    }</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+    // copy over the initial values from age (if present)</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    if (aSetDef.age) {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+      args.age = args.age || {};</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+      for (let [unit, value] in Iterator(aSetDef.age))</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+        args.age[unit] = value;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+    }</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    // just copy over any attributes found from MAKE_MESSAGES_PROPAGATE</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    for each (let [, propAttrName] in Iterator(this.MAKE_MESSAGES_PROPAGATE)) {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+      if (aSetDef[propAttrName])</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+        args[propAttrName] = aSetDef[propAttrName];</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    }</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+    let count = aSetDef.count || this.MAKE_MESSAGES_DEFAULTS.count;</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    for (let iMsg = 0; iMsg &lt; count; iMsg++) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+      messages.push(this.makeMessage(args));</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+      if (aSetDef.age_incr) {</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+        for (let [unit, delta] in Iterator(aSetDef.age_incr))</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+          args.age[unit] += delta;</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+      }</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+    }</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+    return messages;</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+  },</span>
<a href="#l14.110"></a><span id="l14.110"> };</span>
<a href="#l14.111"></a><span id="l14.111"> </span>
<a href="#l14.112"></a><span id="l14.112"> /**</span>
<a href="#l14.113"></a><span id="l14.113">  * Repository of generative message scenarios.  Uses the magic bindMethods</span>
<a href="#l14.114"></a><span id="l14.114">  *  function below to allow you to reference methods/attributes without worrying</span>
<a href="#l14.115"></a><span id="l14.115">  *  about how those methods will get the right 'this' pointer if passed as</span>
<a href="#l14.116"></a><span id="l14.116">  *  simply a function argument to someone.  So if you do:</span>
<a href="#l14.117"></a><span id="l14.117">  *  foo = messageScenarioFactory.method, followed by foo(...), it will be</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mailnews/test/resources/messageModifier.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,181 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ *</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ *</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * License.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ *</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+ *</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ *</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+/*</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+ * This file provides a number of methods for modifying (synthetic) messages</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+ *  for testing purposes.</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+ */</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+/**</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+ * Represents a set of synthetic messages, also supporting insertion into and</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+ *  tracking of the message folders to which they belong.  This then allows</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+ *  mutations of the messages (in their folders) for testing purposes.</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+ *</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+ * In general, you would create a synthetic message set by passing in only a</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+ *  list of synthetic messages, and then add then messages to nsIMsgFolders by</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+ *  using one of the addMessage* methods.  This will populate the aMsgFolders</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+ *  and aFolderIndices values.  (They are primarily intended for reasons of</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+ *  slicing, but people who know what they are doing can also use them.)</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+ *</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+ * @param aSynMessage The synthetic messages that should belong to this set.</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+ * @param aMsgFolders Optional nsIMsgDBFolder or list of folders.</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+ * @param aFolderIndices Optional list where each value is an index into the</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+ *     msgFolders attribute, specifying what folder the message can be found</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+ *     in.  The value may also be null if the message has not yet been</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+ *     inserted into a folder.</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+ */</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+function SyntheticMessageSet(aSynMessages, aMsgFolders, aFolderIndices) {</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  this.synMessages = aSynMessages;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  if (aMsgFolders == null)</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+    this.msgFolders = [];</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  else if (!('length' in aMsgFolders))</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+    this.msgFolders = [aMsgFolders];</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  else</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+    this.msgFolders = aMsgFolders;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  if (aFolderIndices == null)</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+    this.folderIndices = [null for each (blah in Iterator(aSynMessages))];</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  else</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+    this.folderIndices = aFolderIndices;</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+}</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+SyntheticMessageSet.prototype = {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  addMessageToFolderByIndex: function(aFolder, aMessageIndex) {</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+    let aFolderIndex = this.msgFolders.indexOf(aFolder);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+    if (aFolderIndex == -1)</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+      aFolderIndex = this.msgFolders.push(aFolder) - 1;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+    this.folderIndices[aMessageIndex] = aFolderIndex;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+    aFolder.addMessage(this.synMessages[aMessageIndex].toMboxString());</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+  },</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+  /**</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+   * @return a JS list of the message headers for all messages inserted into a</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+   *     folder.</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+   */</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  get msgHdrs() {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+    let msgDatabases = [folder.msgDatabase for each</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+                        ([, folder] in Iterator(this.msgFolders))];</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+    for (let [iMsg, synMsg] in Iterator(this.synMessages)) {</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+      let folderIndex = this.folderIndices[iMsg];</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+      if (folderIndex != null)</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+        yield msgDatabases[folderIndex].getMsgHdrForMessageID(synMsg.messageId);</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+    }</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  },</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+  /**</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+   * @return an nsIMutableArray of the message headers for all messages inserted</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+   *     into a folder.</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+   */</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+  get xpcomHdrArray() {</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+    return toXPCOMArray(this.msgHdrs,</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+                        Components.interfaces.nsIMutableArray);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+  },</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+  /**</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+   * @return a list where each item is a list with two elements; the first is</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+   *     an nsIMsgFolder, and the second is a list of all of the nsIMsgDBHdrs</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+   *     for the synthetic messages in the set inserted into that folder.</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+   */</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+  get foldersWithMsgHdrs() {</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+    let results = [[folder, []] for each</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+                   ([, folder] in Iterator(this.msgFolders))];</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+    for (let [iMsg, synMsg] in Iterator(this.synMessages)) {</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+      let folderIndex = this.folderIndices[iMsg];</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+      if (folderIndex != null) {</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+        let [folder, msgHdrs] = results[folderIndex];</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+        msgHdrs.push(folder.msgDatabase.getMsgHdrForMessageID(synMsg.messageId));</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+      }</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+    }</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+    return results;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  },</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  /**</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+   * @return a generator that yields [nsIMsgFolder, nsIMutableArray of the</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+   *     messages from the set in that folder].</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+   */</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  get foldersWithXpcomHdrArrays() {</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+    for (let [, [folder, msgHdrs]] in Iterator(this.foldersWithMsgHdrs)) {</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+      yield [folder, toXPCOMArray(msgHdrs,</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+                                  Components.interfaces.nsIMutableArray)];</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+    }</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+  },</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  setRead: function(aRead) {</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+    for each (let msgHdr in this.msgHdrs) {</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+      msgHdr.markRead(aRead);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+    }</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+  },</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+  setStarred: function(aStarred) {</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+    for each (let msgHdr in this.msgHdrs) {</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+      msgHdr.markFlagged(aRead);</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+    }</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  },</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+  addTag: function(aTagName) {</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+    for (let [folder, xpcomHdrArray] in this.foldersWithXpcomHdrArrays) {</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+      folder.addKeywordsToMessages(xpcomHdrArray, aTagName);</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+    }</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+  },</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+  removeTag: function(aTagName) {</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+    for (let [folder, xpcomHdrArray] in this.foldersWithXpcomHdrArrays) {</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+      folder.removeKeywordsFromMessages(xpcomHdrArray, aTagName);</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+    }</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  },</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+  /**</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+   * Sets the junk score for the messages to junk/non-junk.  It does not</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+   *  involve the bayesian classifier because we really don't want it</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+   *  affecting our unit tests!  (Unless we were testing the bayesian</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+   *  classifier.  Which I'm conveniently not.  Feel free to add a</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+   *  &quot;setJunkForRealsies&quot; method if you are.)</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+   */</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+  setJunk: function(aIsJunk) {</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+    let junkscore = aIsJunk ? &quot;100&quot; : &quot;0&quot;;</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+    for each (let msgHdr in this.msgHdrs) {</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+      msgHdr.setStringProperty(&quot;junkscore&quot;, junkscore);</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+    };</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+  },</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+  /**</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+   * Slice the message set using the exact Array.slice semantics (because we</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+   *  call Array.slice).</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+   */</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+  slice: function() {</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+    let slicedMessages = this.synMessages.slice.apply(this.synMessages,</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+                                                      arguments);</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+    let slicedIndices = this.folderIndices.slice.apply(this.folderIndices,</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+                                                       arguments);</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+    return new SyntheticMessageSet(slicedMessages, this.msgFolders,</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+                                   slicedIndices);</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+  }</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,617 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/dbViewWrapper.js&quot;);</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+// something less sucky than do_check_true</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+function assert_true(aBeTrue, aWhy, aDumpView) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  if (!aBeTrue) {</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+    if (aDumpView)</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+      dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  }</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+}</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+function assert_false(aBeFalse, aWhy, aDumpView) {</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+  if (aBeFalse) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+    if (aDumpView)</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+      dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+  }</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+}</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+function assert_equals(aA, aB, aWhy, aDumpView) {</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  if (aA != aB) {</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+    if (aDumpView)</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+      dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  }</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+}</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+var gFakeCommandUpdater = {</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+  updateCommandStatus : function()</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+  {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  },</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+  {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  },</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+  updateNextMessageAfterDelete : function()</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+  {</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+  }</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+};</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+var gMockViewWrapperListener = {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  __proto__: IDBViewWrapperListener.prototype,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  shouldUseMailViews: true,</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+  shouldDeferMessageDisplayUntilAfterServerConnect: false,</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  messenger: null,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+  // use no message window!</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+  msgWindow: null,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+  threadPaneCommandUpdater: gFakeCommandUpdater,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  // event handlers</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+  onAllMessagesLoaded: function() {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+    dump(&quot;ALL LOADED\n&quot;);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+    if (this.pendingLoad) {</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+      this.pendingLoad = false;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+      async_driver();</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    }</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+  },</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+};</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+function punt() {</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  dump(&quot;  ******************************\n&quot;);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  dump(&quot;  *** PUNTING! implement me! ***\n&quot;);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  dump(&quot;  ******************************\n&quot;);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+}</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+/**</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+ * Track our resources used by each test.  This is so we can keep our memory</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+ *  usage low by forcing things to be forgotten about (or even nuked) once</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+ *  a test completes, but also so we can provide useful information about the</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+ *  state of things if a test times out.</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+ */</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+var VWTU_testHelper = {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  active_view_wrappers: [],</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+  active_real_folders: [],</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+  active_virtual_folders: [],</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+  postTest: function () {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+    // close all the views we opened</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    this.active_view_wrappers.forEach(function (wrapper) {</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+      wrapper.close();</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    });</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    // verify that the notification helper has no outstanding listeners.</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+    if (IDBViewWrapperListener.prototype._FNH.haveListeners())</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+      do_throw(&quot;FolderNotificationHelper has listeners, but should not.&quot;);</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+    // force the folder to forget about the message database</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+    this.active_real_folders.forEach(function (folder) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+      folder.msgDatabase = null;</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+    });</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+    this.active_view_wrappers.splice(0);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    this.active_real_folders.splice(0);</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+    this.active_virtual_folders.splice();</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  },</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+  onTimeout: function () {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+    dump(&quot;-----------------------------------------------------------\n&quot;);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+    dump(&quot;Active things at time of timeout:\n&quot;);</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    for each (let [, folder] in Iterator(this.active_real_folders)) {</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+      dump(&quot;Real folder: &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    }</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+    for each (let [, virtFolder] in Iterator(this.active_virtual_folders)) {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+      dump(&quot;Virtual folder: &quot; + virtFolder.prettyName + &quot;\n&quot;);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+    }</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+    for each (let [i, viewWrapper] in Iterator(this.active_view_wrappers)) {</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+      dump(&quot;-----------------------------------\n&quot;);</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+      dump(&quot;Active view wrapper &quot; + i + &quot;\n&quot;);</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+      dump_view_state(viewWrapper);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+    }</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+  }</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+};</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+async_test_runner_register_helper(VWTU_testHelper);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+function make_view_wrapper() {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+  let wrapper = new DBViewWrapper(gMockViewWrapperListener);</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+  VWTU_testHelper.active_view_wrappers.push(wrapper);</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+  return wrapper;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+}</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+/**</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+ * Open a folder for view display.  This is an async operation, relying on the</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+ *  onAllMessagesLoaded notification to get he test going again.</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+ */</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+function async_view_open(aViewWrapper, aFolder) {</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+  aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+  aViewWrapper.open(aFolder);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+  return false;</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+}</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+function async_view_set_mail_view(aViewWrapper, aMailViewIndex, aData) {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+  aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+  aViewWrapper.setMailView(aMailViewIndex, aData);</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  return false;</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+}</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+function async_view_quick_search(aViewWrapper, aSearchMode, aSearchString) {</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+  aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+  aViewWrapper.search.quickSearch(aSearchMode, aSearchString);</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+  return false;</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+}</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+function async_view_refresh(aViewWrapper) {</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+  aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+  aViewWrapper.refresh();</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+  return false;</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+}</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+/**</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+ * Call endViewUpdate on your wrapper in the async idiom.  This is essential if</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+ *  you are doing things to a cross-folder view which does its searching in a</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+ *  time-sliced fashion.  In such a case, you would call beginViewUpdate</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+ *  manually, then poke at the view, then call us to end the view update.</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+ */</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+function async_view_end_update(aViewWrapper) {</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+  aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+  aViewWrapper.endViewUpdate();</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+  return false;</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+}</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+var gNextUniqueFolderId = 0;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+/**</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+ * Create and return an empty local folder.  If you want to delete this folder</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+ *  you must call delete_folder to kill it!</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+ */</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+function make_empty_folder() {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+  let name = &quot;gabba&quot; + gNextUniqueFolderId++;</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+  let testFolder = gLocalIncomingServer.rootMsgFolder.addSubfolder(name);</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+  // track it for cleanup or error reporting (if the test hangs)</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+  VWTU_testHelper.active_real_folders.push(testFolder);</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+  return testFolder;</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+}</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+function delete_folder(aFolder) {</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+  VWTU_testHelper.active_real_folders.splice(</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+    VWTU_testHelper.active_real_folders.indexOf(aFolder), 1);</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+  // deleting tries to be helpful and move the folder to the trash...</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+  aFolder.parent.deleteSubFolders(</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+    toXPCOMArray([aFolder], Ci.nsIMutableArray), null);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+  // ...so now the stupid folder is in the stupid trash</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+  // let's empty the trash, then, shall we?</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+  // (for local folders it doesn't matter who we call this on.)</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+  aFolder.emptyTrash(null, null);</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+}</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+SEARCH_TERM_MAP_HELPER = {</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+  subject: Components.interfaces.nsMsgSearchAttrib.Subject,</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+  body: Components.interfaces.nsMsgSearchAttrib.Body,</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+  from: Components.interfaces.nsMsgSearchAttrib.Sender,</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+  to: Components.interfaces.nsMsgSearchAttrib.To,</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+  cc: Components.interfaces.nsMsgSearchAttrib.CC,</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+  recipient: Components.interfaces.nsMsgSearchAttrib.ToOrCC,</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+  involves: Components.interfaces.nsMsgSearchAttrib.AllAddresses,</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+  age: Components.interfaces.nsMsgSearchAttrib.AgeInDays,</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+  tags: Components.interfaces.nsMsgSearchAttrib.Keywords,</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+};</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+/**</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+ * Create and return a virtual folder.</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+ *</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+ * @param aFolders The real folders this virtual folder should draw from.</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+ * @param aSearchDef The search definition to use to build the list of search</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+ *     terms that populate this virtual folder.  Keys should be stuff from</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+ *     SEARCH_TERM_MAP_HELPER and values should be strings to search for within</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+ *     those attribute things.</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+ * @param aBooleanAnd Should the search terms be and-ed together.</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+ */</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+function make_virtual_folder(aFolders, aSearchDef, aBooleanAnd) {</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+  let name = &quot;virt&quot; + gNextUniqueFolderId++;</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+  let terms = [];</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+  let termCreator = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+                              .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+  for each (let [key, val] in Iterator(aSearchDef)) {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+    let term = termCreator.createTerm();</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+    let value = term.value;</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+    value.str = val;</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+    term.value = value;</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+    term.attrib = SEARCH_TERM_MAP_HELPER[key];</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+    term.op = Components.interfaces.nsMsgSearchOp.Contains;</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+    term.booleanAnd = Boolean(aBooleanAnd);</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+    terms.push(term);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+  }</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+  // create an ALL case if we didn't add any terms</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+  if (terms.length == 0) {</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+    let term = termCreator.createTerm();</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+    term.matchAll = true;</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+    terms.push(term);</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+  }</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+  let wrapped = VirtualFolderHelper.createNewVirtualFolder(</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+    name, gLocalIncomingServer.rootMsgFolder, aFolders, terms,</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+    /* online */ false);</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+  // track it for cleanup or error reporting (if the test hangs)</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+  VWTU_testHelper.active_virtual_folders.push(wrapped.virtualFolder);</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+  return wrapped.virtualFolder;</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+}</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+/**</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+ * For assistance in debugging, dump information about a message header.</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+ */</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+function dump_message_header(aMsgHdr) {</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+  dump(&quot;  Subject: &quot; + aMsgHdr.mime2DecodedSubject + &quot;\n&quot;);</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+  dump(&quot;  Date: &quot; + new Date(aMsgHdr.date / 1000) + &quot;\n&quot;);</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+  dump(&quot;  Author: &quot; + aMsgHdr.mime2DecodedAuthor + &quot;\n&quot;);</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+  dump(&quot;  Recipients: &quot; + aMsgHdr.mime2DecodedRecipients + &quot;\n&quot;);</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+  let junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+  dump(&quot;  Read: &quot; + aMsgHdr.isRead + &quot;   Flagged: &quot; + aMsgHdr.isFlagged +</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+       &quot;   Killed: &quot; + aMsgHdr.isKilled + &quot;   Junk: &quot; + (junkScore == &quot;100&quot;) +</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+       &quot;\n&quot;);</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+  dump(&quot;  Keywords: &quot; + aMsgHdr.getStringProperty(&quot;Keywords&quot;) + &quot;\n&quot;);</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+  dump(&quot;  Folder: &quot; + aMsgHdr.folder.prettyName +</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+       &quot;  Key: &quot; + aMsgHdr.messageKey + &quot;\n&quot;);</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+}</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+var WHITESPACE = &quot;                                              &quot;;</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+var MSG_VIEW_FLAG_DUMMY = 0x20000000;</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+function dump_view_contents(aViewWrapper) {</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+  let dbView = aViewWrapper.dbView;</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+  let treeView = aViewWrapper.dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+  let rowCount = treeView.rowCount;</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+  dump(&quot;********* Current View Contents\n&quot;);</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+  for (let iViewIndex = 0; iViewIndex &lt; rowCount; iViewIndex++) {</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+    let level = treeView.getLevel(iViewIndex);</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+    let viewFlags = dbView.viewFlags;</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+    let flags = dbView.getFlagsAt(iViewIndex);</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+    let msgHdr = dbView.getMsgHdrAt(iViewIndex);</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+    let s = WHITESPACE.substr(0, level * 2);</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+    if (treeView.isContainer(iViewIndex))</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+      s += treeView.isContainerOpen(iViewIndex) ? &quot;- &quot; : &quot;+ &quot;;</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+    else</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+      s += &quot;. &quot;;</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+    //s += treeView.getCellText(iViewIndex, )</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+    if (flags &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+      s += &quot;dummy: &quot;;</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+    s += msgHdr.mime2DecodedSubject;</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+    s += &quot; [&quot; + msgHdr.folder.prettyName + &quot;,&quot; + msgHdr.messageKey + &quot;]&quot;;</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+    dump(s + &quot;\n&quot;);</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+  }</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+  dump(&quot;********* end view contents\n&quot;);</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+}</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+function _lookupValueNameInInterface(aValue, aInterface) {</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+  for each (let [key, value] in Iterator(aInterface)) {</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+    if (value == aValue)</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+      return key;</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+  }</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+  return &quot;unknown: &quot; + aValue;</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+}</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+function dump_view_state(aViewWrapper, aDoNotDumpContents) {</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+  if (aViewWrapper.dbView == null) {</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+    dump(&quot;no nsIMsgDBView instance!\n&quot;);</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+    return;</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+  }</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+  if (!aDoNotDumpContents)</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+    dump_view_contents(aViewWrapper);</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+  dump(&quot;View: &quot; + aViewWrapper.dbView + &quot;\n&quot;);</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+  dump(&quot;  View Type: &quot; +</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+       _lookupValueNameInInterface(aViewWrapper.dbView.viewType,</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+                                   Components.interfaces.nsMsgViewType) +</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+       &quot;   &quot; +</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+       &quot;View Flags: &quot; + aViewWrapper.dbView.viewFlags + &quot;\n&quot;);</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+  dump(&quot;  Sort Type: &quot; +</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+       _lookupValueNameInInterface(aViewWrapper.dbView.sortType,</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+                                   Components.interfaces.nsMsgViewSortType) +</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+       &quot;   &quot; +</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+       &quot;Sort Order: &quot; +</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+       _lookupValueNameInInterface(aViewWrapper.dbView.sortOrder,</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+                                   Components.interfaces.nsMsgViewSortOrder) +</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+       &quot;\n&quot;);</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+  dump(aViewWrapper.search.prettyString());</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+}</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+/**</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+ * Verify that the messages in the provided SyntheticMessageSets are the only</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+ *  visible messages in the provided DBViewWrapper. If dummy headers are present</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+ *  in the view for group-by-sort, the code will ensure that the dummy header's</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+ *  underlying header corresponds to a message in the synthetic sets.  However,</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+ *  you should generally not rely on this code to test for anything involving</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+ *  dummy headers.</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+ *</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+ * In the event the view does not contain all of the messages from the provided</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+ *  sets or contains messages not in the provided sets, do_throw will be invoked</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+ *  with a human readable explanation of the problem.</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+ *</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineplus">+ * @param aSynSets A single SyntheticMessageSet or a list of</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineplus">+ *     SyntheticMessageSets.</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+ * @param aViewWrapper The DBViewWrapper whose contents you want to validate.</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+ */</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+function verify_messages_in_view(aSynSets, aViewWrapper) {</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+  if (!('length' in aSynSets))</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+    aSynSets = [aSynSets];</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+  // - Iterate over all the message sets, retrieving the message header.  Use</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+  //  this to construct a URI to populate a dictionary mapping.</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+  let synMessageURIs = {}; // map URI to message header</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+  for each (let [, messageSet] in Iterator(aSynSets)) {</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+    for each (let msgHdr in Iterator(messageSet.msgHdrs)) {</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+      synMessageURIs[msgHdr.folder.getUriForMsg(msgHdr)] = msgHdr;</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+    }</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineplus">+  }</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineplus">+</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+  // - Iterate over the contents of the view, nulling out values in</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+  //  synMessageURIs for found messages, and exploding for missing ones.</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+  let dbView = aViewWrapper.dbView;</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+  let treeView = aViewWrapper.dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineplus">+  let rowCount = treeView.rowCount;</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineplus">+</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+  for (let iViewIndex = 0; iViewIndex &lt; rowCount; iViewIndex++) {</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+    let msgHdr = dbView.getMsgHdrAt(iViewIndex);</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+    let uri = msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+    // expected hit, null it out. (in the dummy case, we will just null out</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+    //  twice, which is also why we do an 'in' test and not a value test.</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+    if (uri in synMessageURIs) {</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+      synMessageURIs[uri] = null;</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+    }</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+    // the view is showing a message that should not be shown, explode.</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+    else {</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+      dump(&quot;The view is showing the following message header and should not&quot; +</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+           &quot; be:\n&quot;);</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+      dump_message_header(msgHdr);</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+      dump(&quot;View State:\n&quot;);</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+      dump_view_state(aViewWrapper);</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+      do_throw(&quot;view contains header that should not be present!&quot;);</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+    }</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineplus">+  }</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+  // - Iterate over our URI set and make sure every message got nulled out.</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+  for each (let [, msgHdr] in Iterator(synMessageURIs)) {</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineplus">+    if (msgHdr != null) {</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+      dump(&quot;************************\n&quot;);</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+      dump(&quot;The view should have included the following message header but&quot; +</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+           &quot; did not:\n&quot;);</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+      dump_message_header(msgHdr);</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+      dump(&quot;View State:\n&quot;);</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+      dump_view_state(aViewWrapper);</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+      do_throw(&quot;view does not contain a header that should be present!&quot;);</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+    }</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+  }</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+}</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+/**</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+ * Assert if the view wrapper is displaying any messages.</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+ */</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+function verify_empty_view(aViewWrapper) {</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+  verify_messages_in_view([], aViewWrapper);</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+}</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+/**</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+ * Build a histogram of the treeview levels and verify it matches the expected</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+ *  histogram.  Oddly enough, I find this to be a reasonable and concise way to</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineplus">+ *  verify that threading mode is enabled.  Keep in mind that this file is</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+ *  currently not used to test the actual thread logic.  If/when that day comes,</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+ *  something less eccentric is certainly the way that should be tested.</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineplus">+ */</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineplus">+function verify_view_level_histogram(aExpectedHisto, aViewWrapper) {</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+  let dbView = aViewWrapper.dbView;</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineplus">+  let treeView = aViewWrapper.dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+  let rowCount = treeView.rowCount;</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineplus">+</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+  let actualHisto = {};</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+  for (let iViewIndex = 0; iViewIndex &lt; rowCount; iViewIndex++) {</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+    let level = treeView.getLevel(iViewIndex);</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+    actualHisto[level] = (actualHisto[level] || 0) + 1;</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+  }</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineplus">+  for (let [level, count] in Iterator(aExpectedHisto)) {</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+    if (actualHisto[level] != count) {</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+      dump_view_state(aViewWrapper);</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineplus">+      dump(&quot;*******************\n&quot;);</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+      dump(&quot;Expected count for histogram level &quot; + level + &quot; was &quot; + count +</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+           &quot; but got &quot; + actualHisto[level] + &quot;\n&quot;);</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+      do_throw(&quot;View histogram does not match!&quot;);</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineplus">+    }</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineplus">+  }</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+}</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+/**</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineplus">+ * Given a view wrapper and one or more view indices, verify that there is a</span>
<a href="#l16.429"></a><span id="l16.429" class="difflineplus">+ *  dummy header at each provided index.</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineplus">+ *</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineplus">+ * @param aViewWrapper The view wrapper in question</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineplus">+ * @param ... View indices to check.</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+ */</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+function verify_view_row_at_index_is_dummy(aViewWrapper) {</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+  for (let iArg = 1; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+    let viewIndex = arguments[iArg];</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineplus">+    let flags = aViewWrapper.dbView.getFlagsAt(viewIndex);</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+    if (!(flags &amp; MSG_VIEW_FLAG_DUMMY)) {</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+      dump_view_state(aViewWrapper);</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+      do_throw(&quot;Expected a dummy header at view index &quot; + viewIndex);</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+    }</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+  }</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+}</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+/**</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineplus">+ * Expand all nodes in the view wrapper.  This is a debug helper function</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+ *  because there's no good reason to have it be on the view wrapper at this</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineplus">+ *  time.</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+ */</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+function view_expand_all(aViewWrapper) {</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+  // we can't use the command because it has assertions about having a tree.</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+  aViewWrapper._viewFlags |= Ci.nsMsgViewFlagsType.kExpandAll;</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+  aViewWrapper._applyViewChanges();</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+}</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+/**</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+ * Create a new local folder, populating it with messages according to the set</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+ *  definition provided.</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+ *</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+ * @param aSynSetDefs A synthetic set definition, as appropriate to pass to</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineplus">+ *     make_new_sets_in_folder.</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineplus">+ * @return A list whose first element is the nsIMsgLocalMailFolder created and</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineplus">+ *     whose subsequent items are the SyntheticMessageSets used to populate the</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineplus">+ *     folder (as returned by make_new_sets_in_folder).</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+ */</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+function make_folder_with_sets(aSynSetDefs) {</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineplus">+  let msgFolder = make_empty_folder();</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineplus">+  let results = make_new_sets_in_folder(msgFolder, aSynSetDefs);</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+  results.unshift(msgFolder);</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+  return results;</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+}</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+/**</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+ * Create multiple new local folders, populating them with messages according to</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+ *  the set definitions provided.  Differs from make_folder_with_sets by taking</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineplus">+ *  the number of folders to create and return the list of created folders as</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+ *  the first element in the returned list.  This method is simple enough that</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+ *  the limited code duplication is deemed acceptable in support of readability.</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+ *</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+ * @param aSynSetDefs A synthetic set definition, as appropriate to pass to</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+ *     make_new_sets_in_folder.</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+ * @return A list whose first element is the nsIMsgLocalMailFolder created and</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+ *     whose subsequent items are the SyntheticMessageSets used to populate the</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineplus">+ *     folder (as returned by make_new_sets_in_folder).</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineplus">+ */</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineplus">+function make_folders_with_sets(aFolderCount, aSynSetDefs) {</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+  let msgFolders = [];</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+  for (let i = 0; i &lt; aFolderCount; i++)</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+    msgFolders.push(make_empty_folder());</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+  let results = make_new_sets_in_folders(msgFolders, aSynSetDefs);</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+  results.unshift(msgFolders);</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+  return results;</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+}</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+var gMessageScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+/**</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+ * Given one or more existing local folder, create new message sets and add them</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineplus">+ *  to the folders using</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineplus">+ *</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+ * @param aMsgFolders A single nsIMsgLocalMailFolder or a list of them.  The</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+ *     synthetic messages will be added to the folder(s).</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+ * @param aSynSetDefs Either an integer describing the number of sets of</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineplus">+ *     messages to create (using default parameters), or a list of set</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineplus">+ *     definition objects as defined by MessageGenerator.makeMessages.</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+ * @return A list of SyntheticMessageSet objects, each corresponding to the</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+ *     entry in aSynSetDefs (or implied if an integer was passed).</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+ */</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+function make_new_sets_in_folders(aMsgFolders, aSynSetDefs) {</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+  // is it just a count of the number of plain vanilla sets to create?</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineplus">+  if (typeof(aSynSetDefs) == &quot;number&quot;) {</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineplus">+    let setCount = aSynSetDefs;</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineplus">+    aSynSetDefs = [];</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineplus">+    for (let iSet = 0; iSet &lt; setCount; iSet++)</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineplus">+      aSynSetDefs.push({});</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineplus">+  }</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+  // now it must be a list of set descriptors</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineplus">+  // - create the synthetic message sets</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+  let messageSets = [];</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+  for each (let [, synSetDef] in Iterator(aSynSetDefs)) {</span>
<a href="#l16.523"></a><span id="l16.523" class="difflineplus">+    let messages = gMessageGenerator.makeMessages(synSetDef);</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineplus">+    messageSets.push(new SyntheticMessageSet(messages));</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineplus">+  }</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineplus">+</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineplus">+  // - add the messages to the folders (interleaving them)</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+  add_sets_to_folders(aMsgFolders, messageSets);</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+  return messageSets;</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineplus">+}</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineplus">+/** singular folder alias for single-folder users' readability */</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineplus">+let make_new_sets_in_folder = make_new_sets_in_folders;</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineplus">+</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineplus">+/**</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+ * An iterator that generates an infinite sequence of its argument.  So</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+ *  _looperator(1, 2, 3) will generate the iteration stream: [1, 2, 3, 1, 2, 3,</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+ *  1, 2, 3, ...].  For use by add_sets_across_folders.</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineplus">+ */</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+function _looperator(aList) {</span>
<a href="#l16.541"></a><span id="l16.541" class="difflineplus">+  if (aList.length == 0)</span>
<a href="#l16.542"></a><span id="l16.542" class="difflineplus">+    throw Exception(&quot;aList must have at least one item!&quot;);</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineplus">+</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+  let i = 0, length = aList.length;</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineplus">+  while (true) {</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineplus">+    yield aList[i];</span>
<a href="#l16.547"></a><span id="l16.547" class="difflineplus">+    i = (i + 1) % length;</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineplus">+  }</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineplus">+}</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineplus">+</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineplus">+/**</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineplus">+ * Spreads the messages in aMessageSets across the folders in aMsgFolders.  Each</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineplus">+ *  message set is spread in a round-robin fashion across all folders.  At the</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineplus">+ *  same time, each message-sets insertion is interleaved with the other message</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineplus">+ *  sets.  This distributes message across multiple folders for useful</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineplus">+ *  cross-folder threading testing (via the round robin) while also hopefully</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineplus">+ *  avoiding making things pathologically easy for the code under test (by way</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineplus">+ *  of the interleaving.)</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+ *</span>
<a href="#l16.560"></a><span id="l16.560" class="difflineplus">+ * For example, given the following 2 input message sets:</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineplus">+ *  message set 'lower': [a b c d e f]</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineplus">+ *  message set 'upper': [A B C D E F G H]</span>
<a href="#l16.563"></a><span id="l16.563" class="difflineplus">+ *</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineplus">+ * across 2 folders:</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineplus">+ *  folder 1: [a A c C e E G]</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineplus">+ *  folder 2: [b B d D f F H</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineplus">+ * across 3 folders:</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+ *  folder 1: [a A d D G]</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineplus">+ *  folder 2: [b B e E H]</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineplus">+ *  folder 3: [c C f F]</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineplus">+ *</span>
<a href="#l16.572"></a><span id="l16.572" class="difflineplus">+ * @param aMsgFolders An nsIMsgLocalMailFolder to add the message sets to or a</span>
<a href="#l16.573"></a><span id="l16.573" class="difflineplus">+ *     list of them.</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineplus">+ * @param aMessageSets A list of SyntheticMessageSets.</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineplus">+ */</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineplus">+function add_sets_to_folders(aMsgFolders, aMessageSets) {</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineplus">+  if (!('length' in aMsgFolders))</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineplus">+    aMsgFolders = [aMsgFolders];</span>
<a href="#l16.579"></a><span id="l16.579" class="difflineplus">+</span>
<a href="#l16.580"></a><span id="l16.580" class="difflineplus">+  for each (let [, folder] in Iterator(aMsgFolders)) {</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineplus">+    if (!(folder instanceof Components.interfaces.nsIMsgLocalMailFolder))</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineplus">+      throw Exception(&quot;All folders in aMsgFolders must be local folders!&quot;);</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineplus">+  }</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineplus">+</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+  let iterFolders = _looperator(aMsgFolders);</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineplus">+</span>
<a href="#l16.587"></a><span id="l16.587" class="difflineplus">+  let iPerSet = 0, folder = iterFolders.next();</span>
<a href="#l16.588"></a><span id="l16.588" class="difflineplus">+  // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineplus">+  let didSomething;</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineplus">+  do {</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineplus">+    didSomething = false;</span>
<a href="#l16.592"></a><span id="l16.592" class="difflineplus">+    // for each message set, if it is not out of messages, add the message</span>
<a href="#l16.593"></a><span id="l16.593" class="difflineplus">+    for each (let [, messageSet] in Iterator(aMessageSets)) {</span>
<a href="#l16.594"></a><span id="l16.594" class="difflineplus">+      if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l16.595"></a><span id="l16.595" class="difflineplus">+        messageSet.addMessageToFolderByIndex(folder, iPerSet);</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineplus">+        didSomething = true;</span>
<a href="#l16.597"></a><span id="l16.597" class="difflineplus">+      }</span>
<a href="#l16.598"></a><span id="l16.598" class="difflineplus">+    }</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineplus">+    iPerSet++;</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineplus">+    folder = iterFolders.next();</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineplus">+  } while (didSomething);</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineplus">+}</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineplus">+/** singular function name for understandability of single-folder users */</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineplus">+let add_sets_to_folder = add_sets_to_folders;</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineplus">+</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineplus">+/**</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineplus">+ * Create a name and address pair where the provided word is part of the name.</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineplus">+ */</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+function make_person_with_word_in_name(aWord) {</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+  let dude = gMessageGenerator.makeNameAndAddress();</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineplus">+  return [aWord, dude[1]];</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineplus">+}</span>
<a href="#l16.613"></a><span id="l16.613" class="difflineplus">+</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineplus">+/**</span>
<a href="#l16.615"></a><span id="l16.615" class="difflineplus">+ * Create a name and address pair where the provided word is part of the mail</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineplus">+ *  address.</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineplus">+ */</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineplus">+function make_person_with_word_in_address(aWord) {</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineplus">+  let dude = gMessageGenerator.makeNameAndAddress();</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineplus">+  return [dude[0], aWord + &quot;@madeup.nul&quot;];</span>
<a href="#l16.621"></a><span id="l16.621" class="difflineplus">+}</span>
<a href="#l16.622"></a><span id="l16.622">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/mailnews/commandglue.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/mailnews/commandglue.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1007,50 +1007,16 @@ function getSearchTermString(searchTerms</span>
<a href="#l17.4"></a><span id="l17.4">         break;</span>
<a href="#l17.5"></a><span id="l17.5">     }</span>
<a href="#l17.6"></a><span id="l17.6">     condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l17.7"></a><span id="l17.7">     condition += term.termAsString + ')';</span>
<a href="#l17.8"></a><span id="l17.8">   }</span>
<a href="#l17.9"></a><span id="l17.9">   return condition;</span>
<a href="#l17.10"></a><span id="l17.10"> }</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-function  CreateVirtualFolder(newName, parentFolder, searchFolderURIs, searchTerms, searchOnline)</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-{</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  // ### need to make sure view/folder doesn't exist.</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-  if (searchFolderURIs &amp;&amp; (searchFolderURIs != &quot;&quot;) &amp;&amp; newName &amp;&amp; (newName != &quot;&quot;)) </span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-  {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    try</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-    {</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-      var newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-      newFolder.setFlag(Components.interfaces.nsMsgFolderFlags.Virtual);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-      var vfdb = newFolder.msgDatabase;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-      var searchTermString = getSearchTermString(searchTerms);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-      var dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-      // set the view string as a property of the db folder info</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-      // set the original folder name as well.</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-      dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-      dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-      dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-      vfdb.summaryValid = true;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-      vfdb.Close(true);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-      parentFolder.NotifyItemAdded(newFolder);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-      var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-      accountManager.saveVirtualFolders();</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    }</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-    catch(e)</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-    {</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-      throw(e); // so that the dialog does not automatically close</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-      dump (&quot;Exception : creating virtual folder \n&quot;);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-    }</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-  }</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-  else </span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-  {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    dump(&quot;no name or nothing selected\n&quot;);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-  }   </span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-}</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> var searchSessionContractID = &quot;@mozilla.org/messenger/searchSession;1&quot;;</span>
<a href="#l17.48"></a><span id="l17.48"> var gSearchView;</span>
<a href="#l17.49"></a><span id="l17.49"> var gSearchSession;</span>
<a href="#l17.50"></a><span id="l17.50"> </span>
<a href="#l17.51"></a><span id="l17.51"> var nsIMsgFolder = Components.interfaces.nsIMsgFolder;</span>
<a href="#l17.52"></a><span id="l17.52"> var nsIMsgWindow = Components.interfaces.nsIMsgWindow;</span>
<a href="#l17.53"></a><span id="l17.53"> var nsIMsgRDFDataSource = Components.interfaces.nsIMsgRDFDataSource;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

