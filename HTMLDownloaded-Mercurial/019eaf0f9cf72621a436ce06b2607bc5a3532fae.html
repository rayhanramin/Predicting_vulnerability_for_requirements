<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28366:019eaf0f9cf72621a436ce06b2607bc5a3532fae</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 019eaf0f9cf72621a436ce06b2607bc5a3532fae" />
<meta property="og:url" content="/comm-central/rev/019eaf0f9cf72621a436ce06b2607bc5a3532fae" />
<meta property="og:description" content="Bug 440377 - Implement new recipients address fields. r=mkmelin, ui-review=Paenglab" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 019eaf0f9cf72621a436ce06b2607bc5a3532fae 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/019eaf0f9cf72621a436ce06b2607bc5a3532fae">shortlog</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/019eaf0f9cf72621a436ce06b2607bc5a3532fae">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae">files</a> |
changeset |
<a href="/comm-central/raw-rev/019eaf0f9cf72621a436ce06b2607bc5a3532fae">raw</a>  | <a href="/comm-central/archive/019eaf0f9cf72621a436ce06b2607bc5a3532fae.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=440377">Bug 440377</a> - Implement new recipients address fields. r=mkmelin, ui-review=Paenglab
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#32;&#67;&#97;&#115;&#116;&#101;&#108;&#108;&#97;&#110;&#105;&#32;&#60;&#97;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Dec 2019 11:58:10 +0200</td></tr>

<tr>
 <td>changeset 28366</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/019eaf0f9cf72621a436ce06b2607bc5a3532fae">019eaf0f9cf72621a436ce06b2607bc5a3532fae</a></td>
</tr>



<tr>
<td>parent 28365</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c10cbc3c87fb2004d7ca3ae2525cf4be48bf377c">c10cbc3c87fb2004d7ca3ae2525cf4be48bf377c</a>
</td>
</tr>

<tr>
<td>child 28367</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8157030f14a55019fa7bbeb4e0bd9f9228c73f2d">8157030f14a55019fa7bbeb4e0bd9f9228c73f2d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=019eaf0f9cf72621a436ce06b2607bc5a3532fae">16799</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 12 Dec 2019 09:58:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@019eaf0f9cf7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=019eaf0f9cf72621a436ce06b2607bc5a3532fae">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&newProject=comm-central&newRevision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&newProject=comm-central&newRevision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&newProject=comm-central&newRevision=019eaf0f9cf72621a436ce06b2607bc5a3532fae&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=440377">440377</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=440377">Bug 440377</a> - Implement new recipients address fields. r=mkmelin, ui-review=Paenglab</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailWidgets.js">mail/base/content/mailWidgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailWidgets.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailWidgets.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailWidgets.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailWidgets.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/base/content/mailWidgets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abEditListDialog.xul">mail/components/addrbook/content/abEditListDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abEditListDialog.xul">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abEditListDialog.xul">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abEditListDialog.xul">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abEditListDialog.xul">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abEditListDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abMailListDialog.xul">mail/components/addrbook/content/abMailListDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abMailListDialog.xul">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abMailListDialog.xul">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abMailListDialog.xul">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abMailListDialog.xul">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/addrbook/content/abMailListDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/addressingWidgetOverlay.js">mail/components/compose/content/addressingWidgetOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/addressingWidgetOverlay.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/addressingWidgetOverlay.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/addressingWidgetOverlay.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/addressingWidgetOverlay.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/addressingWidgetOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/messengercompose.xul">mail/components/compose/content/messengercompose.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/messengercompose.xul">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/messengercompose.xul">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/messengercompose.xul">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/messengercompose.xul">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/components/compose/content/messengercompose.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/extensions/smime/content/msgCompSMIMEOverlay.js">mail/extensions/smime/content/msgCompSMIMEOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/extensions/smime/content/msgCompSMIMEOverlay.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/extensions/smime/content/msgCompSMIMEOverlay.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/extensions/smime/content/msgCompSMIMEOverlay.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/extensions/smime/content/msgCompSMIMEOverlay.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/extensions/smime/content/msgCompSMIMEOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd">mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_addressWidgets.js">mail/test/browser/composition/browser_addressWidgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_addressWidgets.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_addressWidgets.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_addressWidgets.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_addressWidgets.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_addressWidgets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_draftIdentity.js">mail/test/browser/composition/browser_draftIdentity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_draftIdentity.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_draftIdentity.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_draftIdentity.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_draftIdentity.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_draftIdentity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_focus.js">mail/test/browser/composition/browser_focus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_focus.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_focus.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_focus.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_focus.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_focus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_replyAddresses.js">mail/test/browser/composition/browser_replyAddresses.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_replyAddresses.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_replyAddresses.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_replyAddresses.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_replyAddresses.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_replyAddresses.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_sendButton.js">mail/test/browser/composition/browser_sendButton.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_sendButton.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_sendButton.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_sendButton.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_sendButton.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/composition/browser_sendButton.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-address-widgets.js">mail/test/mozmill/composition/test-address-widgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-address-widgets.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-address-widgets.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-address-widgets.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-address-widgets.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-address-widgets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-draft-identity.js">mail/test/mozmill/composition/test-draft-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-draft-identity.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-draft-identity.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-draft-identity.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-draft-identity.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-draft-identity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-focus.js">mail/test/mozmill/composition/test-focus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-focus.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-focus.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-focus.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-focus.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-focus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-reply-addresses.js">mail/test/mozmill/composition/test-reply-addresses.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-reply-addresses.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-reply-addresses.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-reply-addresses.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-reply-addresses.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-reply-addresses.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-send-button.js">mail/test/mozmill/composition/test-send-button.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-send-button.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-send-button.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-send-button.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-send-button.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/composition/test-send-button.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/message-header/test-reply-identity.js">mail/test/mozmill/message-header/test-reply-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/message-header/test-reply-identity.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/message-header/test-reply-identity.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/message-header/test-reply-identity.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/message-header/test-reply-identity.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/message-header/test-reply-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/shared-modules/ComposeHelpers.jsm">mail/test/mozmill/shared-modules/ComposeHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/shared-modules/ComposeHelpers.jsm">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/shared-modules/ComposeHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/shared-modules/ComposeHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/shared-modules/ComposeHelpers.jsm">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/test/mozmill/shared-modules/ComposeHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/linux/mail/compose/messengercompose.css">mail/themes/linux/mail/compose/messengercompose.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/linux/mail/compose/messengercompose.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/linux/mail/compose/messengercompose.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/linux/mail/compose/messengercompose.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/linux/mail/compose/messengercompose.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/linux/mail/compose/messengercompose.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/osx/mail/compose/messengercompose.css">mail/themes/osx/mail/compose/messengercompose.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/osx/mail/compose/messengercompose.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/osx/mail/compose/messengercompose.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/osx/mail/compose/messengercompose.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/osx/mail/compose/messengercompose.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/osx/mail/compose/messengercompose.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/compacttheme.css">mail/themes/shared/mail/compacttheme.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/compacttheme.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/compacttheme.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/compacttheme.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/compacttheme.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/compacttheme.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/input-fields.css">mail/themes/shared/mail/input-fields.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/input-fields.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/input-fields.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/input-fields.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/input-fields.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/input-fields.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/messengercompose.css">mail/themes/shared/mail/messengercompose.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/messengercompose.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/messengercompose.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/messengercompose.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/messengercompose.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/shared/mail/messengercompose.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/compose/messengercompose.css">mail/themes/windows/mail/compose/messengercompose.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/compose/messengercompose.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/compose/messengercompose.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/compose/messengercompose.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/compose/messengercompose.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/compose/messengercompose.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/messenger.css">mail/themes/windows/mail/messenger.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/messenger.css">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/messenger.css">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/messenger.css">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/messenger.css">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mail/themes/windows/mail/messenger.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mailnews/addrbook/content/abMailListDialog.js">mailnews/addrbook/content/abMailListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mailnews/addrbook/content/abMailListDialog.js">file</a> |
<a href="/comm-central/annotate/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mailnews/addrbook/content/abMailListDialog.js">annotate</a> |
<a href="/comm-central/diff/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mailnews/addrbook/content/abMailListDialog.js">diff</a> |
<a href="/comm-central/comparison/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mailnews/addrbook/content/abMailListDialog.js">comparison</a> |
<a href="/comm-central/log/019eaf0f9cf72621a436ce06b2607bc5a3532fae/mailnews/addrbook/content/abMailListDialog.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -261,16 +261,17 @@ function ComposeMessage(type, format, fo</span>
<a href="#l1.4"></a><span id="l1.4">           let hdrIdentity = MailUtils.getIdentityForHeader(</span>
<a href="#l1.5"></a><span id="l1.5">             hdr,</span>
<a href="#l1.6"></a><span id="l1.6">             type,</span>
<a href="#l1.7"></a><span id="l1.7">             findDeliveredToIdentityEmail(hdr)</span>
<a href="#l1.8"></a><span id="l1.8">           );</span>
<a href="#l1.9"></a><span id="l1.9">           if (ignoreQuote) {</span>
<a href="#l1.10"></a><span id="l1.10">             type += msgComposeType.ReplyIgnoreQuote;</span>
<a href="#l1.11"></a><span id="l1.11">           }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13">           MailServices.compose.OpenComposeWindow(</span>
<a href="#l1.14"></a><span id="l1.14">             null,</span>
<a href="#l1.15"></a><span id="l1.15">             hdr,</span>
<a href="#l1.16"></a><span id="l1.16">             messageUri,</span>
<a href="#l1.17"></a><span id="l1.17">             type,</span>
<a href="#l1.18"></a><span id="l1.18">             format,</span>
<a href="#l1.19"></a><span id="l1.19">             hdrIdentity,</span>
<a href="#l1.20"></a><span id="l1.20">             msgWindow</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWidgets.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWidgets.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,37 +1,44 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /**</span>
<a href="#l2.5"></a><span id="l2.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+/* import-globals-from ../../components/compose/content/addressingWidgetOverlay.js */</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+</span>
<a href="#l2.11"></a><span id="l2.11"> /* global MozElements */</span>
<a href="#l2.12"></a><span id="l2.12"> /* global MozXULElement */</span>
<a href="#l2.13"></a><span id="l2.13"> /* global openUILink */</span>
<a href="#l2.14"></a><span id="l2.14"> /* global MessageIdClick */</span>
<a href="#l2.15"></a><span id="l2.15"> /* global onClickEmailStar */</span>
<a href="#l2.16"></a><span id="l2.16"> /* global onClickEmailPresence */</span>
<a href="#l2.17"></a><span id="l2.17"> /* global gFolderDisplay */</span>
<a href="#l2.18"></a><span id="l2.18"> /* global UpdateEmailNodeDetails */</span>
<a href="#l2.19"></a><span id="l2.19"> /* global PluralForm */</span>
<a href="#l2.20"></a><span id="l2.20"> /* global UpdateExtraAddressProcessing */</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+/* global getSiblingPills setFocusOnFirstPill getAllPills getAllSelectedPills onRecipientsChanged */</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> // Wrap in a block to prevent leaking to window scope.</span>
<a href="#l2.24"></a><span id="l2.24"> {</span>
<a href="#l2.25"></a><span id="l2.25">   const { Services } = ChromeUtils.import(</span>
<a href="#l2.26"></a><span id="l2.26">     &quot;resource://gre/modules/Services.jsm&quot;</span>
<a href="#l2.27"></a><span id="l2.27">   );</span>
<a href="#l2.28"></a><span id="l2.28">   const { MailUtils } = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l2.29"></a><span id="l2.29">   const { MailServices } = ChromeUtils.import(</span>
<a href="#l2.30"></a><span id="l2.30">     &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l2.31"></a><span id="l2.31">   );</span>
<a href="#l2.32"></a><span id="l2.32">   const { DBViewWrapper } = ChromeUtils.import(</span>
<a href="#l2.33"></a><span id="l2.33">     &quot;resource:///modules/DBViewWrapper.jsm&quot;</span>
<a href="#l2.34"></a><span id="l2.34">   );</span>
<a href="#l2.35"></a><span id="l2.35">   const { TagUtils } = ChromeUtils.import(&quot;resource:///modules/TagUtils.jsm&quot;);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  var { MimeParser } = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  var { DisplayNameUtils } = ChromeUtils.import(</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    &quot;resource:///modules/DisplayNameUtils.jsm&quot;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  );</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   class MozMailHeaderfield extends MozXULElement {</span>
<a href="#l2.42"></a><span id="l2.42">     connectedCallback() {</span>
<a href="#l2.43"></a><span id="l2.43">       this.setAttribute(&quot;context&quot;, &quot;copyPopup&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">       this.classList.add(&quot;headerValue&quot;);</span>
<a href="#l2.45"></a><span id="l2.45">     }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">     set headerValue(val) {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -1742,9 +1749,464 @@</span>
<a href="#l2.49"></a><span id="l2.49">         child.width = width;</span>
<a href="#l2.50"></a><span id="l2.50">       }</span>
<a href="#l2.51"></a><span id="l2.51">     }</span>
<a href="#l2.52"></a><span id="l2.52">   }</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   customElements.define(&quot;attachment-list&quot;, MozAttachmentlist, {</span>
<a href="#l2.55"></a><span id="l2.55">     extends: &quot;richlistbox&quot;,</span>
<a href="#l2.56"></a><span id="l2.56">   });</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  /**</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   * The MailAddressPill widget is used to display the email addresses in the</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+   * messengercompose.xul window.</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+   *</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+   * @extends {MozXULElement}</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+   */</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  class MailAddressPill extends MozXULElement {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    static get inheritedAttributes() {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+      return {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+        &quot;.pill-label&quot;: &quot;crop,value=label&quot;,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+      };</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    }</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    connectedCallback() {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      if (this.hasChildNodes() || this.delayConnectedCallback()) {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+        return;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      }</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+      // Used to store the html:input element from where the pill was generated.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+      this.originalInput;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+      this.classList.add(&quot;address-pill&quot;);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+      this.setAttribute(&quot;context&quot;, &quot;emailAddressPillPopup&quot;);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+      this.setAttribute(&quot;allowevents&quot;, &quot;true&quot;);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+      this.pillLabel = document.createXULElement(&quot;label&quot;);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+      this.pillLabel.classList.add(&quot;pill-label&quot;);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+      this.pillDeleteImage = document.createXULElement(&quot;image&quot;);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      this.pillDeleteImage.classList.add(&quot;delete-pill-icon&quot;);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      this.appendChild(this.pillLabel);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+      this._setupEmailInput();</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+      this.appendChild(this.pillDeleteImage);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+      this._setupEventListeners();</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+      this.initializeAttributeInheritance();</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+      // @implements {nsIObserver}</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+      this.inputObserver = {</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+        observe: (subject, topic, data) =&gt; {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+          if (topic == &quot;autocomplete-did-enter-text&quot;) {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+            this.updatePill();</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+          }</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+        },</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+      };</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+      Services.obs.addObserver(</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+        this.inputObserver,</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+        &quot;autocomplete-did-enter-text&quot;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+      );</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+      // Remove the observer on window unload as the disconnectedCallback()</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+      // will never be called when closing a window, so we might therefore</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+      // leak if XPCOM isn't smart enough.</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+      window.addEventListener(</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+        &quot;unload&quot;,</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+        () =&gt; {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+          this.removeObserver();</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+        },</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+        { once: true }</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+      );</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    }</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    get emailAddress() {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+      return this.getAttribute(&quot;emailAddress&quot;);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+    }</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    set emailAddress(val) {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+      this.setAttribute(&quot;emailAddress&quot;, val);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    }</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    get label() {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+      return this.getAttribute(&quot;label&quot;);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+    }</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    set label(val) {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+      this.setAttribute(&quot;label&quot;, val);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    }</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+    get fullAddress() {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      return this.getAttribute(&quot;fullAddress&quot;);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    }</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    set fullAddress(val) {</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+      this.setAttribute(&quot;fullAddress&quot;, val);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+    }</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    get displayName() {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+      return this.getAttribute(&quot;displayName&quot;);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    }</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    set displayName(val) {</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+      this.setAttribute(&quot;displayName&quot;, val);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    }</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+    /**</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+     * Check if the pill is currently in &quot;Edit Mode&quot;, meaning the label is</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+     * hidden and the html:input field is visible.</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+     *</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+     * @returns {boolean} True if the pill is currently being edited.</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+     */</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+    get isEditing() {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+      return !this.emailInput.hasAttribute(&quot;hidden&quot;);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    }</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    get fragment() {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+      if (!this.constructor.hasOwnProperty(&quot;_fragment&quot;)) {</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+        this.constructor._fragment = MozXULElement.parseXULToFragment(`</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+          &lt;html:input is=&quot;autocomplete-input&quot;</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+                      type=&quot;text&quot;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+                      class=&quot;${this.originalInput.getAttribute(</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+                        &quot;class&quot;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+                      )} input-pill&quot;</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+                      disableonsend=&quot;true&quot;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+                      aria-labelledby=&quot;${this.originalInput.getAttribute(</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+                        &quot;aria-labelledby&quot;</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+                      )}&quot;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+                      autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+                      autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+                      timeout=&quot;300&quot;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+                      maxrows=&quot;6&quot;</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+                      completedefaultindex=&quot;true&quot;</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+                      forcecomplete=&quot;true&quot;</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+                      completeselectedindex=&quot;true&quot;</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+                      minresultsforpopup=&quot;2&quot;</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+                      ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+                      hidden=&quot;hidden&quot;/&gt;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+        `);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+      }</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+      return document.importNode(this.constructor._fragment, true);</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    }</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    _setupEmailInput() {</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+      this.appendChild(this.fragment);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+      this.emailInput = this.querySelector(`input[is=&quot;autocomplete-input&quot;]`);</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+      this.emailInput.value = this.fullAddress;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+      let params = JSON.parse(</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+        this.emailInput.getAttribute(&quot;autocompletesearchparam&quot;)</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+      );</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+      params.type = this.originalInput.getAttribute(&quot;recipienttype&quot;);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+      this.emailInput.setAttribute(</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+        &quot;autocompletesearchparam&quot;,</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+        JSON.stringify(params)</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+      );</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+      this.appendChild(this.emailInput);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    }</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+    _setupEventListeners() {</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+      this.addEventListener(&quot;click&quot;, this);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+      this.addEventListener(&quot;dblclick&quot;, this);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+      this.addEventListener(&quot;keypress&quot;, this);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+      this.emailInput.addEventListener(&quot;keypress&quot;, event =&gt; {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+        this.finishEditing(event);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+      });</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+      this.emailInput.addEventListener(&quot;blur&quot;, () =&gt; {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+        this.updatePill();</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+      });</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      this.pillDeleteImage.addEventListener(&quot;click&quot;, () =&gt; {</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+        this.removePills();</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+      });</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+    }</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+    handleEvent(event) {</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+      switch (event.type) {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+        case &quot;click&quot;:</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+          this.checkSelected(event);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+          break;</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+        case &quot;dblclick&quot;:</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+          this.startEditing(event);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+          break;</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+        case &quot;keypress&quot;:</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+          this.handleKeyPress(event);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+          break;</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+      }</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    }</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    handleKeyPress(event) {</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+      if (this.isEditing) {</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+        return;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+      }</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+      switch (event.key) {</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+        case &quot; &quot;:</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+          this.checkSelected(event);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+          break;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+        case &quot;Enter&quot;:</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+        case &quot;F2&quot;: // For Windows users</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+          this.startEditing(event);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+          break;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+        case &quot;Delete&quot;:</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+        case &quot;Backspace&quot;:</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+          this.removePills();</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+          break;</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+        case &quot;ArrowLeft&quot;:</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+          if (this.previousElementSibling) {</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+            this.previousElementSibling.focus();</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+            this.checkKeyboardSelected(event, this.previousElementSibling);</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+          }</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+          break;</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+        case &quot;ArrowRight&quot;:</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+          if (this.nextElementSibling.hasAttribute(&quot;hidden&quot;)) {</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+            this.nextElementSibling.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+            this.nextElementSibling.focus();</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+            break;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+          }</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+          this.nextElementSibling.focus();</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+          this.checkKeyboardSelected(event, this.nextElementSibling);</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+          break;</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+        case &quot;Home&quot;:</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+          this.removeAttribute(&quot;selected&quot;);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+          setFocusOnFirstPill(this);</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+          break;</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+        case &quot;End&quot;:</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+          this.originalInput.focus();</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+          break;</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+        case &quot;Tab&quot;:</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+          for (let pill of getSiblingPills(this)) {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+            pill.removeAttribute(&quot;selected&quot;);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+          }</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+          break;</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+        case &quot;a&quot;:</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+          if (event.ctrlKey || event.metaKey) {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+            this.selectPills();</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+          }</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+          break;</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+        case &quot;c&quot;:</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+          if (event.ctrlKey || event.metaKey) {</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+            copyEmailNewsAddress(this);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+          }</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+          break;</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+        case &quot;x&quot;:</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+          if (event.ctrlKey || event.metaKey) {</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+            copyEmailNewsAddress(this);</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+            deleteAddressPill(this);</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+          }</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+          break;</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+      }</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+    }</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+    selectPills() {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+      for (let pill of getSiblingPills(this)) {</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+        pill.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+      }</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+    }</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+    clearSelected() {</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+      for (let pill of getAllPills()) {</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+        pill.removeAttribute(&quot;selected&quot;);</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+      }</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+    }</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+    checkSelected(event) {</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+      if (</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+        this.isEditing ||</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+        (this.hasAttribute(&quot;selected&quot;) &amp;&amp; event.which == 3)</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+      ) {</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+        return;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+      }</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+      if (!event.ctrlKey &amp;&amp; !event.metaKey &amp;&amp; event.key != &quot; &quot;) {</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+        this.clearSelected();</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+      }</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+      this.toggleAttribute(&quot;selected&quot;);</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+      if (!this.hasAttribute(&quot;selected&quot;) &amp;&amp; event.key != &quot; &quot;) {</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+        this.blur();</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+      } else {</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+        this.focus();</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+      }</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+    }</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+    checkKeyboardSelected(event, element) {</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+      if (event.shiftKey) {</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+        if (this.hasAttribute(&quot;selected&quot;) &amp;&amp; element.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+          this.removeAttribute(&quot;selected&quot;);</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+          return;</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+        }</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+        this.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+        element.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+      } else if (!event.ctrlKey) {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+        this.clearSelected();</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+      }</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+    }</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+    /**</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+     * When a &quot;Delete&quot; action is triggered, we need to check if other pills are</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+     * currently selected and delete them all.</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+     */</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+    removePills() {</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+      for (let pill of getAllSelectedPills()) {</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+        pill.remove();</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+      }</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+      this.originalInput.focus();</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+      this.remove();</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+      onRecipientsChanged();</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+    }</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    /**</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+     * Simple email address validation.</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+     *</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+     * @param {String} address - An email address.</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+     */</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+    isValidAddress(address) {</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+      return address.includes(&quot;@&quot;, 1) &amp;&amp; !address.endsWith(&quot;@&quot;);</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+    }</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+    /**</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+     * Convert the pill into &quot;Edit Mode&quot;, meaning hiding the label and showing</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+     * the html:input element.</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+     *</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+     * @param {Event} event - The DOM Event.</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+     */</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    startEditing(event) {</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+      if (this.isEditing) {</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+        return;</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      }</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+      for (let pill of getAllPills()) {</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+        pill.finishEditing();</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+      }</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+      // We need to set the min and max width before hiding and showing the</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+      // child nodes in order to prevent unwanted jumps in the resizing of the</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+      // edited pill. Both properties are necessary to handle flexbox.</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+      this.style.setProperty(&quot;max-width&quot;, `${this.clientWidth}px`);</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+      this.style.setProperty(&quot;min-width&quot;, `${this.clientWidth}px`);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+      this.classList.add(&quot;editing&quot;);</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+      this.pillLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+      this.pillDeleteImage.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+      this.emailInput.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+      this.emailInput.focus();</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+      // In case the original address is shorter than the input field child node</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+      // force resize the pill container to prevent overflows.</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+      if (this.emailInput.clientWidth &gt; this.clientWidth) {</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+        this.style.setProperty(&quot;max-width&quot;, `${this.emailInput.clientWidth}px`);</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+        this.style.setProperty(&quot;min-width&quot;, `${this.emailInput.clientWidth}px`);</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+      } else {</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+        this.style.setProperty(&quot;max-width&quot;, `${this.clientWidth}px`);</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+        this.style.setProperty(&quot;min-width&quot;, `${this.clientWidth}px`);</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+      }</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+    }</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+    /**</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+     * Revert the pill UI to a regular selectable element, meaning the label is</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+     * visible and the html:input field is hidden.</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+     *</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+     * @param {Event} event - The DOM Event.</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+     */</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+    finishEditing(event = null) {</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+      let key = event ? event.key : &quot;Escape&quot;;</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+      switch (key) {</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+        case &quot;Escape&quot;:</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+          this.emailInput.value = this.fullAddress;</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+          this.resetPill();</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+          break;</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+        case &quot;Delete&quot;:</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+        case &quot;Backspace&quot;:</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+          if (!this.emailInput.value.trim() &amp;&amp; !event.repeat) {</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineplus">+            this.originalInput.focus();</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+            this.remove();</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+          }</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+          break;</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+      }</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+    }</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+    updatePill() {</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+      let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+        this.emailInput.value</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+      );</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+      if (!addresses[0]) {</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+        this.originalInput.focus();</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+        this.remove();</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+        return;</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+      }</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+      this.label = addresses[0].toString();</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+      this.emailAddress = addresses[0].email || &quot;&quot;;</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+      this.fullAddress = addresses[0].toString();</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+      this.displayName = addresses[0].name || &quot;&quot;;</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+      // We need to detach the autocomplete Controller to prevent the input</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+      // to be filled with the previously selected address when the &quot;blur&quot;</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+      // event gets triggered.</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+      this.emailInput.detachController();</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+      // Attach it again to enable autocomplete.</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+      this.emailInput.attachController();</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+      this.resetPill();</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+    }</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+    resetPill() {</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+      let isValid = this.isValidAddress(this.emailAddress);</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+      let listNames = MimeParser.parseHeaderField(</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+        this.fullAddress,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+        MimeParser.HEADER_ADDRESS</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+      );</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+      let isMailingList =</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+        listNames.length &gt; 0 &amp;&amp;</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+        MailServices.ab.mailListNameExists(listNames[0].name);</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+      let isNewsgroup = this.originalInput.classList.contains(&quot;nntp-input&quot;);</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+      this.classList.toggle(</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+        &quot;error&quot;,</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineplus">+        !isValid &amp;&amp; !isMailingList &amp;&amp; !isNewsgroup</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+      );</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+      let emailCard = DisplayNameUtils.getCardForEmail(this.emailAddress);</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+      this.classList.toggle(</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+        &quot;warning&quot;,</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+        isValid &amp;&amp; !emailCard.card &amp;&amp; !isMailingList &amp;&amp; !isNewsgroup</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+      );</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+      this.style.removeProperty(&quot;max-width&quot;);</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+      this.style.removeProperty(&quot;min-width&quot;);</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+      this.classList.remove(&quot;editing&quot;);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+      this.pillLabel.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+      this.pillDeleteImage.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+      this.emailInput.setAttribute(&quot;hidden&quot;, &quot;hidden&quot;);</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+      this.originalInput.focus();</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+    }</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+    removeObserver() {</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+      Services.obs.removeObserver(</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+        this.inputObserver,</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+        &quot;autocomplete-did-enter-text&quot;</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+      );</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+    }</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+  }</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+  customElements.define(&quot;mail-address-pill&quot;, MailAddressPill);</span>
<a href="#l2.512"></a><span id="l2.512"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/abEditListDialog.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/abEditListDialog.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -16,17 +16,16 @@</span>
<a href="#l3.4"></a><span id="l3.4">         ondrop=&quot;DropOnAddressListTree(event);&quot;&gt;</span>
<a href="#l3.5"></a><span id="l3.5"> &lt;dialog id=&quot;ablistWindow&quot;&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   &lt;stringbundle id=&quot;bundle_addressBook&quot; src=&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;/&gt;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   &lt;script src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">   &lt;script src=&quot;chrome://global/content/editMenuOverlay.js&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   &lt;!-- move needed functions into a single js file --&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  &lt;script src=&quot;chrome://messenger/content/messengercompose/addressingWidgetOverlay.js&quot;/&gt;</span>
<a href="#l3.13"></a><span id="l3.13">   &lt;script src=&quot;chrome://messenger/content/addressbook/abCommon.js&quot;/&gt;</span>
<a href="#l3.14"></a><span id="l3.14">   &lt;script src=&quot;chrome://messenger/content/addressbook/abMailListDialog.js&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   &lt;vbox id=&quot;editlist&quot;&gt;</span>
<a href="#l3.17"></a><span id="l3.17">     &lt;hbox id=&quot;ListNameContainer&quot; align=&quot;center&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18">       &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l3.19"></a><span id="l3.19">       &lt;label control=&quot;ListName&quot; value=&quot;&amp;ListName.label;&quot; accesskey=&quot;&amp;ListName.accesskey;&quot; class=&quot;CardEditLabel&quot;/&gt;</span>
<a href="#l3.20"></a><span id="l3.20">       &lt;hbox class=&quot;CardEditWidth input-container&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/addrbook/content/abMailListDialog.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/addrbook/content/abMailListDialog.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -16,17 +16,16 @@</span>
<a href="#l4.4"></a><span id="l4.4">         ondrop=&quot;DropOnAddressListTree(event);&quot;&gt;</span>
<a href="#l4.5"></a><span id="l4.5"> &lt;dialog id=&quot;ablistWindow&quot;&gt;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   &lt;stringbundle id=&quot;bundle_addressBook&quot; src=&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;/&gt;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   &lt;script src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l4.10"></a><span id="l4.10">   &lt;script src=&quot;chrome://global/content/editMenuOverlay.js&quot;/&gt;</span>
<a href="#l4.11"></a><span id="l4.11">   &lt;!-- move needed functions into a single js file --&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  &lt;script src=&quot;chrome://messenger/content/messengercompose/addressingWidgetOverlay.js&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13">   &lt;script src=&quot;chrome://messenger/content/addressbook/abCommon.js&quot;/&gt;</span>
<a href="#l4.14"></a><span id="l4.14">   &lt;script src=&quot;chrome://messenger/content/addressbook/abMailListDialog.js&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15">   &lt;script&gt;&lt;![CDATA[</span>
<a href="#l4.16"></a><span id="l4.16">     document.addEventListener(&quot;dialogaccept&quot;, MailListOKButton);</span>
<a href="#l4.17"></a><span id="l4.17">   ]]&gt;&lt;/script&gt;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l4.20"></a><span id="l4.20">     &lt;label control=&quot;abPopup&quot; value=&quot;&amp;addToAddressBook.label;&quot; accesskey=&quot;&amp;addToAddressBook.accesskey;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-/* global MozElements */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/* global MozElements getSiblingPills */</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> /* import-globals-from ../../../../mailnews/addrbook/content/abDragDrop.js */</span>
<a href="#l5.12"></a><span id="l5.12"> /* import-globals-from ../../../base/content/mailCore.js */</span>
<a href="#l5.13"></a><span id="l5.13"> /* import-globals-from ../../../base/content/utilityOverlay.js */</span>
<a href="#l5.14"></a><span id="l5.14"> /* import-globals-from addressingWidgetOverlay.js */</span>
<a href="#l5.15"></a><span id="l5.15"> /* import-globals-from ComposerCommands.js */</span>
<a href="#l5.16"></a><span id="l5.16"> /* import-globals-from editor.js */</span>
<a href="#l5.17"></a><span id="l5.17"> /* import-globals-from editorUtilities.js */</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineat">@@ -81,19 +81,16 @@ var gAutoSaving;</span>
<a href="#l5.19"></a><span id="l5.19"> var gCurrentIdentity;</span>
<a href="#l5.20"></a><span id="l5.20"> var defaultSaveOperation;</span>
<a href="#l5.21"></a><span id="l5.21"> var gSendOperationInProgress;</span>
<a href="#l5.22"></a><span id="l5.22"> var gSaveOperationInProgress;</span>
<a href="#l5.23"></a><span id="l5.23"> var gCloseWindowAfterSave;</span>
<a href="#l5.24"></a><span id="l5.24"> var gSavedSendNowKey;</span>
<a href="#l5.25"></a><span id="l5.25"> var gSendFormat;</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-var gMsgIdentityElement;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-var gMsgAddressingWidgetTreeElement;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-var gMsgSubjectElement;</span>
<a href="#l5.30"></a><span id="l5.30"> var gMsgAttachmentElement;</span>
<a href="#l5.31"></a><span id="l5.31"> var gMsgHeadersToolbarElement;</span>
<a href="#l5.32"></a><span id="l5.32"> // TODO: Maybe the following two variables can be combined.</span>
<a href="#l5.33"></a><span id="l5.33"> var gManualAttachmentReminder;</span>
<a href="#l5.34"></a><span id="l5.34"> var gDisableAttachmentReminder;</span>
<a href="#l5.35"></a><span id="l5.35"> var gComposeType;</span>
<a href="#l5.36"></a><span id="l5.36"> var gLanguageObserver;</span>
<a href="#l5.37"></a><span id="l5.37"> var gBodyFromArgs;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineat">@@ -124,16 +121,37 @@ var gAutoSaveInterval;</span>
<a href="#l5.39"></a><span id="l5.39"> var gAutoSaveTimeout;</span>
<a href="#l5.40"></a><span id="l5.40"> var gAutoSaveKickedIn;</span>
<a href="#l5.41"></a><span id="l5.41"> var gEditingDraft;</span>
<a href="#l5.42"></a><span id="l5.42"> var gAttachmentsSize;</span>
<a href="#l5.43"></a><span id="l5.43"> var gNumUploadingAttachments;</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45"> var kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+// Observer for the autocomplete input.</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+const inputObserver = {</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  observe: (subject, topic, data) =&gt; {</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    if (topic == &quot;autocomplete-did-enter-text&quot;) {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      let input = subject.QueryInterface(Ci.nsIAutoCompleteInput)</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+        .wrappedJSObject;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      let element = document.getElementById(input.id);</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+      // The observer is triggered also from within an already existing pill.</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      // Since the autocomplete-input inside a pill doesn't have an ID, we can</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+      // interrupt this method if no element was selected, or the element has</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      // the .input-pill class.</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+      if (!element || element.classList.contains(&quot;input-pill&quot;)) {</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+        return;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      }</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      // Trigger the pill creation.</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+      recipientAddPill(element);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+    }</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  },</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+};</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+</span>
<a href="#l5.68"></a><span id="l5.68"> function InitializeGlobalVariables() {</span>
<a href="#l5.69"></a><span id="l5.69">   gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">   gMsgCompose = null;</span>
<a href="#l5.72"></a><span id="l5.72">   gOriginalMsgURI = null;</span>
<a href="#l5.73"></a><span id="l5.73">   gWindowLocked = false;</span>
<a href="#l5.74"></a><span id="l5.74">   gContentChanged = false;</span>
<a href="#l5.75"></a><span id="l5.75">   gSubjectChanged = false;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineat">@@ -158,30 +176,36 @@ function InitializeGlobalVariables() {</span>
<a href="#l5.77"></a><span id="l5.77">   gAttachVCardOptionChanged = false;</span>
<a href="#l5.78"></a><span id="l5.78">   gAttachmentsSize = 0;</span>
<a href="#l5.79"></a><span id="l5.79">   gNumUploadingAttachments = 0;</span>
<a href="#l5.80"></a><span id="l5.80">   // eslint-disable-next-line no-global-assign</span>
<a href="#l5.81"></a><span id="l5.81">   msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;].createInstance(</span>
<a href="#l5.82"></a><span id="l5.82">     Ci.nsIMsgWindow</span>
<a href="#l5.83"></a><span id="l5.83">   );</span>
<a href="#l5.84"></a><span id="l5.84">   MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  // Add the observer.</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  Services.obs.addObserver(inputObserver, &quot;autocomplete-did-enter-text&quot;);</span>
<a href="#l5.88"></a><span id="l5.88"> }</span>
<a href="#l5.89"></a><span id="l5.89"> InitializeGlobalVariables();</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91"> function ReleaseGlobalVariables() {</span>
<a href="#l5.92"></a><span id="l5.92">   gCurrentIdentity = null;</span>
<a href="#l5.93"></a><span id="l5.93">   gCharsetConvertManager = null;</span>
<a href="#l5.94"></a><span id="l5.94">   gMsgCompose = null;</span>
<a href="#l5.95"></a><span id="l5.95">   gOriginalMsgURI = null;</span>
<a href="#l5.96"></a><span id="l5.96">   gMessenger = null;</span>
<a href="#l5.97"></a><span id="l5.97">   gDisableAttachmentReminder = false;</span>
<a href="#l5.98"></a><span id="l5.98">   _gComposeBundle = null;</span>
<a href="#l5.99"></a><span id="l5.99">   MailServices.mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l5.100"></a><span id="l5.100">   // eslint-disable-next-line no-global-assign</span>
<a href="#l5.101"></a><span id="l5.101">   msgWindow = null;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  // Remove the observer.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  Services.obs.removeObserver(inputObserver, &quot;autocomplete-did-enter-text&quot;);</span>
<a href="#l5.105"></a><span id="l5.105"> }</span>
<a href="#l5.106"></a><span id="l5.106"> </span>
<a href="#l5.107"></a><span id="l5.107"> // Notification box shown at the bottom of the window.</span>
<a href="#l5.108"></a><span id="l5.108"> var gNotification = {};</span>
<a href="#l5.109"></a><span id="l5.109"> XPCOMUtils.defineLazyGetter(gNotification, &quot;notificationbox&quot;, () =&gt; {</span>
<a href="#l5.110"></a><span id="l5.110">   return new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l5.111"></a><span id="l5.111">     element.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l5.112"></a><span id="l5.112">     element.setAttribute(&quot;notificationside&quot;, &quot;bottom&quot;);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineat">@@ -290,17 +314,17 @@ function SidebarGetState() {</span>
<a href="#l5.114"></a><span id="l5.114">  */</span>
<a href="#l5.115"></a><span id="l5.115"> function preparePrintPreviewTitleHeader() {</span>
<a href="#l5.116"></a><span id="l5.116">   // For title header of print (preview), use message content document title</span>
<a href="#l5.117"></a><span id="l5.117">   // if existing, otherwise message subject. To apply the message subject,</span>
<a href="#l5.118"></a><span id="l5.118">   // we temporarily change the title of message content document before going</span>
<a href="#l5.119"></a><span id="l5.119">   // into print preview (workaround for bug 1396455).</span>
<a href="#l5.120"></a><span id="l5.120">   let msgDocument = getBrowser().contentDocument;</span>
<a href="#l5.121"></a><span id="l5.121">   let msgSubject =</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-    GetMsgSubjectElement().value.trim() ||</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    document.getElementById(&quot;msgSubject&quot;).value.trim() ||</span>
<a href="#l5.124"></a><span id="l5.124">     getComposeBundle().getString(&quot;defaultSubject&quot;);</span>
<a href="#l5.125"></a><span id="l5.125">   gChromeState.msgDocumentHadTitle = !!msgDocument.querySelector(&quot;title&quot;);</span>
<a href="#l5.126"></a><span id="l5.126">   gChromeState.msgDocumentTitle = msgDocument.title;</span>
<a href="#l5.127"></a><span id="l5.127">   msgDocument.title = msgDocument.title || msgSubject;</span>
<a href="#l5.128"></a><span id="l5.128"> }</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130"> /**</span>
<a href="#l5.131"></a><span id="l5.131">  * When going in and out of Print Preview, hide or show respective UI elements.</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineat">@@ -423,17 +447,17 @@ var stateListener = {</span>
<a href="#l5.133"></a><span id="l5.133">       // and restore it later.</span>
<a href="#l5.134"></a><span id="l5.134">       let editor = GetCurrentEditor();</span>
<a href="#l5.135"></a><span id="l5.135">       let selection = editor.selection;</span>
<a href="#l5.136"></a><span id="l5.136">       let range = selection.getRangeAt(0);</span>
<a href="#l5.137"></a><span id="l5.137">       let start = range.startOffset;</span>
<a href="#l5.138"></a><span id="l5.138">       let startNode = range.startContainer;</span>
<a href="#l5.139"></a><span id="l5.139"> </span>
<a href="#l5.140"></a><span id="l5.140">       editor.enableUndo(false);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-      let identityList = GetMsgIdentityElement();</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+      let identityList = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l5.143"></a><span id="l5.143">       identityList.selectedItem = identityList.getElementsByAttribute(</span>
<a href="#l5.144"></a><span id="l5.144">         &quot;identitykey&quot;,</span>
<a href="#l5.145"></a><span id="l5.145">         gMsgCompose.identity.key</span>
<a href="#l5.146"></a><span id="l5.146">       )[0];</span>
<a href="#l5.147"></a><span id="l5.147">       LoadIdentity(false);</span>
<a href="#l5.148"></a><span id="l5.148"> </span>
<a href="#l5.149"></a><span id="l5.149">       editor.enableUndo(true);</span>
<a href="#l5.150"></a><span id="l5.150">       editor.resetModificationCount();</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineat">@@ -2316,16 +2340,17 @@ function ComposeFieldsReady() {</span>
<a href="#l5.152"></a><span id="l5.152">   if (!gMsgCompose.composeHTML) {</span>
<a href="#l5.153"></a><span id="l5.153">     try {</span>
<a href="#l5.154"></a><span id="l5.154">       gMsgCompose.editor.QueryInterface(Ci.nsIPlaintextEditor).wrapWidth =</span>
<a href="#l5.155"></a><span id="l5.155">         gMsgCompose.wrapLength;</span>
<a href="#l5.156"></a><span id="l5.156">     } catch (e) {</span>
<a href="#l5.157"></a><span id="l5.157">       dump(&quot;### textEditor.wrapWidth exception text: &quot; + e + &quot; - failed\n&quot;);</span>
<a href="#l5.158"></a><span id="l5.158">     }</span>
<a href="#l5.159"></a><span id="l5.159">   }</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+</span>
<a href="#l5.161"></a><span id="l5.161">   CompFields2Recipients(gMsgCompose.compFields);</span>
<a href="#l5.162"></a><span id="l5.162">   SetComposeWindowTitle();</span>
<a href="#l5.163"></a><span id="l5.163">   updateEditableFields(false);</span>
<a href="#l5.164"></a><span id="l5.164"> }</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166"> // checks if the passed in string is a mailto url, if it is, generates nsIMsgComposeParams</span>
<a href="#l5.167"></a><span id="l5.167"> // for the url and returns them.</span>
<a href="#l5.168"></a><span id="l5.168"> function handleMailtoArgs(mailtoUrl) {</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineat">@@ -2888,30 +2913,17 @@ function ComposeStartup(aParams) {</span>
<a href="#l5.170"></a><span id="l5.170">   gLanguageObserver.observe(document.documentElement, { attributes: true });</span>
<a href="#l5.171"></a><span id="l5.171"> </span>
<a href="#l5.172"></a><span id="l5.172">   // Observe dictionary removals.</span>
<a href="#l5.173"></a><span id="l5.173">   dictionaryRemovalObserver.addObserver();</span>
<a href="#l5.174"></a><span id="l5.174"> </span>
<a href="#l5.175"></a><span id="l5.175">   document.addEventListener(&quot;paste&quot;, onPasteOrDrop);</span>
<a href="#l5.176"></a><span id="l5.176">   document.addEventListener(&quot;drop&quot;, onPasteOrDrop);</span>
<a href="#l5.177"></a><span id="l5.177"> </span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  // Workaround for missing inbuilt funcionality of &lt;menulist&gt; to restore</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-  // visibility when focused and receiving key presses while scrolled out of view.</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  // Note: Unrelated key presses (e.g. access keys for other UI elements)</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-  // typically do not fire keyup on the menulist as focus will have shifted.</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  // Some false positives like function or OS keys might occur; we accept that.</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-  // Alt+CursorDown will still show the dropdown in the wrong place.</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-  let addressingWidget = GetMsgAddressingWidgetTreeElement();</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-  addressingWidget.addEventListener(&quot;keyup&quot;, event =&gt; {</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-    if (event.target.classList.contains(&quot;aw-menulist&quot;)) {</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-      addressingWidget.ensureElementIsVisible(event.target);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-    }</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  });</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-  let identityList = GetMsgIdentityElement();</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+  let identityList = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l5.193"></a><span id="l5.193">   if (identityList) {</span>
<a href="#l5.194"></a><span id="l5.194">     FillIdentityList(identityList);</span>
<a href="#l5.195"></a><span id="l5.195">   }</span>
<a href="#l5.196"></a><span id="l5.196"> </span>
<a href="#l5.197"></a><span id="l5.197">   if (!params) {</span>
<a href="#l5.198"></a><span id="l5.198">     // This code will go away soon as now arguments are passed to the window using a object of type nsMsgComposeParams instead of a string</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200">     params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineat">@@ -3257,17 +3269,17 @@ function ComposeStartup(aParams) {</span>
<a href="#l5.202"></a><span id="l5.202">       body = body.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l5.203"></a><span id="l5.203">       gMsgCompose.compFields.body =</span>
<a href="#l5.204"></a><span id="l5.204">         '&lt;br /&gt;&lt;a href=&quot;' + body + '&quot;&gt;' + cleanBody + &quot;&lt;/a&gt;&lt;br /&gt;&quot;;</span>
<a href="#l5.205"></a><span id="l5.205">     } else {</span>
<a href="#l5.206"></a><span id="l5.206">       gMsgCompose.compFields.body = &quot;\n&lt;&quot; + body + &quot;&gt;\n&quot;;</span>
<a href="#l5.207"></a><span id="l5.207">     }</span>
<a href="#l5.208"></a><span id="l5.208">   }</span>
<a href="#l5.209"></a><span id="l5.209"> </span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-  GetMsgSubjectElement().value = gMsgCompose.compFields.subject;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  document.getElementById(&quot;msgSubject&quot;).value = gMsgCompose.compFields.subject;</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213">   AddAttachments(gMsgCompose.compFields.attachments, null, false);</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215">   if (Services.prefs.getBoolPref(&quot;mail.compose.show_attachment_pane&quot;)) {</span>
<a href="#l5.216"></a><span id="l5.216">     toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l5.217"></a><span id="l5.217">   }</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219">   document</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineat">@@ -3375,36 +3387,40 @@ function WizCallback(state) {</span>
<a href="#l5.221"></a><span id="l5.221">     ComposeStartup(null);</span>
<a href="#l5.222"></a><span id="l5.222">   } else {</span>
<a href="#l5.223"></a><span id="l5.223">     // The account wizard is still closing so we can't close just yet</span>
<a href="#l5.224"></a><span id="l5.224">     setTimeout(MsgComposeCloseWindow, 0);</span>
<a href="#l5.225"></a><span id="l5.225">   }</span>
<a href="#l5.226"></a><span id="l5.226"> }</span>
<a href="#l5.227"></a><span id="l5.227"> </span>
<a href="#l5.228"></a><span id="l5.228"> function ComposeLoad() {</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-  var other_headers = Services.prefs.getCharPref(</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+  let otherHeaders = Services.prefs.getCharPref(</span>
<a href="#l5.231"></a><span id="l5.231">     &quot;mail.compose.other.header&quot;,</span>
<a href="#l5.232"></a><span id="l5.232">     &quot;&quot;</span>
<a href="#l5.233"></a><span id="l5.233">   );</span>
<a href="#l5.234"></a><span id="l5.234"> </span>
<a href="#l5.235"></a><span id="l5.235">   AddMessageComposeOfflineQuitObserver();</span>
<a href="#l5.236"></a><span id="l5.236"> </span>
<a href="#l5.237"></a><span id="l5.237">   setupAutocomplete();</span>
<a href="#l5.238"></a><span id="l5.238"> </span>
<a href="#l5.239"></a><span id="l5.239">   try {</span>
<a href="#l5.240"></a><span id="l5.240">     SetupCommandUpdateHandlers();</span>
<a href="#l5.241"></a><span id="l5.241">     // This will do migration, or create a new account if we need to.</span>
<a href="#l5.242"></a><span id="l5.242">     // We also want to open the account wizard if no identities are found</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    var state = verifyAccounts(WizCallback, true);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-    if (other_headers) {</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-      var selectNode = document.getElementById(&quot;addressCol1#1&quot;);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-      var other_headers_Array = other_headers.split(&quot;,&quot;);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-      for (let i = 0; i &lt; other_headers_Array.length; i++) {</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-        selectNode.appendItem(other_headers_Array[i] + &quot;:&quot;, &quot;addr_other&quot;);</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+    let state = verifyAccounts(WizCallback, true);</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+    if (otherHeaders) {</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+      let addressingWidgetLabels = document.getElementById(</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+        &quot;addressingWidgetLabels&quot;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+      );</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+      let recipientsContainer = document.getElementById(&quot;recipientsContainer&quot;);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+      for (let header of otherHeaders.split(&quot;,&quot;)) {</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+        addressingWidgetLabels.appendChild(createRecipientLabel(header));</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+        recipientsContainer.appendChild(createRecipientRow(header));</span>
<a href="#l5.261"></a><span id="l5.261">       }</span>
<a href="#l5.262"></a><span id="l5.262">     }</span>
<a href="#l5.263"></a><span id="l5.263">     if (state) {</span>
<a href="#l5.264"></a><span id="l5.264">       ComposeStartup(null);</span>
<a href="#l5.265"></a><span id="l5.265">     }</span>
<a href="#l5.266"></a><span id="l5.266">   } catch (ex) {</span>
<a href="#l5.267"></a><span id="l5.267">     Cu.reportError(ex);</span>
<a href="#l5.268"></a><span id="l5.268">     Services.prompt.alert(</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineat">@@ -3420,17 +3436,16 @@ function ComposeLoad() {</span>
<a href="#l5.270"></a><span id="l5.270">   ToolbarIconColor.init();</span>
<a href="#l5.271"></a><span id="l5.271"> </span>
<a href="#l5.272"></a><span id="l5.272">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l5.273"></a><span id="l5.273">   var toolbox = document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l5.274"></a><span id="l5.274">   toolbox.customizeDone = function(aEvent) {</span>
<a href="#l5.275"></a><span id="l5.275">     MailToolboxCustomizeDone(aEvent, &quot;CustomizeComposeToolbar&quot;);</span>
<a href="#l5.276"></a><span id="l5.276">   };</span>
<a href="#l5.277"></a><span id="l5.277"> </span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-  awInitializeNumberOfRowsShown();</span>
<a href="#l5.279"></a><span id="l5.279">   updateAttachmentPane();</span>
<a href="#l5.280"></a><span id="l5.280">   attachmentBucketMarkEmptyBucket();</span>
<a href="#l5.281"></a><span id="l5.281"> }</span>
<a href="#l5.282"></a><span id="l5.282"> </span>
<a href="#l5.283"></a><span id="l5.283"> function ComposeUnload() {</span>
<a href="#l5.284"></a><span id="l5.284">   // Send notification that the window is going away completely.</span>
<a href="#l5.285"></a><span id="l5.285">   document</span>
<a href="#l5.286"></a><span id="l5.286">     .getElementById(&quot;msgcomposeWindow&quot;)</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineat">@@ -3485,16 +3500,151 @@ function SetDocumentCharacterSet(aCharse</span>
<a href="#l5.288"></a><span id="l5.288">     gMsgCompose.SetDocumentCharset(aCharset);</span>
<a href="#l5.289"></a><span id="l5.289">     updateEncodingInStatusBar();</span>
<a href="#l5.290"></a><span id="l5.290">   } else {</span>
<a href="#l5.291"></a><span id="l5.291">     dump(&quot;Compose has not been created!\n&quot;);</span>
<a href="#l5.292"></a><span id="l5.292">   }</span>
<a href="#l5.293"></a><span id="l5.293"> }</span>
<a href="#l5.294"></a><span id="l5.294"> </span>
<a href="#l5.295"></a><span id="l5.295"> /**</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+ * Create the recipient label to add in the messenger compose dialog.</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+ *</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+ * @param {string} labelID - The unique identifier of the email header.</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+ * @returns {XULelement} The newly create XUL label.</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+ */</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+function createRecipientLabel(labelID) {</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+  let label = document.createXULElement(&quot;label&quot;);</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+  label.setAttribute(&quot;id&quot;, labelID);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+  label.textContent = labelID;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+  label.addEventListener(&quot;click&quot;, () =&gt; {</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+    showAddressRow(label, `addressRow${labelID}`);</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+  });</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+  label.addEventListener(&quot;keypress&quot;, event =&gt; {</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+    showAddressRowKeyPress(event, label, `addressRow${labelID}`);</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+  });</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+  label.setAttribute(&quot;control&quot;, `${labelID}AddrInput`);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+  // Necessary to allow focus via TAB key.</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+  label.setAttribute(&quot;tabindex&quot;, 0);</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+  let newImage = document.createXULElement(&quot;image&quot;);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+  newImage.classList.add(&quot;new-icon&quot;);</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+  label.prepend(newImage);</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+  return label;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+}</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+/**</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+ * Create a new recipient row container with the input autocomplete.</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+ *</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+ * @param {string} labelID - The unique identifier of the email header.</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+ * @returns {XULElement} - The newly created recipient row.</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+ */</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+function createRecipientRow(labelID) {</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+  let row = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+  row.setAttribute(&quot;id&quot;, `addressRow${labelID}`);</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+  row.classList.add(&quot;addressingWidgetItem&quot;, &quot;address-row&quot;, &quot;hidden&quot;);</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+  let firstCol = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+  firstCol.setAttribute(&quot;align&quot;, &quot;start&quot;);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+  firstCol.classList.add(&quot;aw-firstColBox&quot;);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+  let firstLabel = document.createXULElement(&quot;label&quot;);</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+  firstLabel.addEventListener(&quot;click&quot;, () =&gt; {</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+    hideAddressRow(firstLabel, labelID);</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+  });</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+  firstLabel.addEventListener(&quot;keypress&quot;, event =&gt; {</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+    if (event.key == &quot;Enter&quot;) {</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+      hideAddressRow(firstLabel, labelID);</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+    }</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+  });</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+  // Necessary to allow focus via TAB key.</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+  firstLabel.setAttribute(&quot;tabindex&quot;, 0);</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+  let closeImage = document.createXULElement(&quot;image&quot;);</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+  closeImage.classList.add(&quot;close-icon&quot;);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+  firstLabel.appendChild(closeImage);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+  firstCol.appendChild(firstLabel);</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+  let secondCol = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+  secondCol.setAttribute(&quot;align&quot;, &quot;start&quot;);</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+  secondCol.setAttribute(&quot;pack&quot;, &quot;end&quot;);</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+  secondCol.setAttribute(</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+    &quot;style&quot;,</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+    getComposeBundle().getString(&quot;headersSpaceStyle&quot;)</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+  );</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+  secondCol.classList.add(&quot;address-label-container&quot;);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+  let secondLabel = document.createXULElement(&quot;label&quot;);</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  secondLabel.setAttribute(&quot;id&quot;, `${labelID}AddrLabel`);</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  secondLabel.value = labelID;</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+  secondLabel.setAttribute(&quot;control&quot;, `${labelID}AddrInput`);</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+  secondCol.appendChild(secondLabel);</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+  let container = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+  container.setAttribute(&quot;id&quot;, `${labelID}AddrContainer`);</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+  container.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+  container.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+  container.classList.add(</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+    &quot;input-container&quot;,</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+    &quot;wrap-container&quot;,</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+    &quot;address-container&quot;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+  );</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+  container.addEventListener(&quot;click&quot;, focusAddressInput);</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+  let input = document.createElement(&quot;input&quot;, {</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+    is: &quot;autocomplete-input&quot;,</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+  });</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+  input.setAttribute(&quot;id&quot;, `${labelID}AddrInput`);</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+  input.setAttribute(&quot;type&quot;, &quot;text&quot;);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+  input.classList.add(&quot;plain&quot;, &quot;address-input&quot;, &quot;nntp-input&quot;);</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+  input.setAttribute(&quot;disableonsend&quot;, true);</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+  input.setAttribute(&quot;autocompletesearch&quot;, &quot;mydomain addrbook ldap news&quot;);</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+  input.setAttribute(&quot;autocompletesearchparam&quot;, &quot;{}&quot;);</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+  input.setAttribute(&quot;timeout&quot;, 300);</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  input.setAttribute(&quot;maxrows&quot;, 6);</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+  input.setAttribute(&quot;completedefaultindex&quot;, true);</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  input.setAttribute(&quot;forcecomplete&quot;, true);</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+  input.setAttribute(&quot;completeselectedindex&quot;, true);</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+  input.setAttribute(&quot;minresultsforpopup&quot;, 2);</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+  input.setAttribute(&quot;ignoreblurwhilesearching&quot;, true);</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+  input.addEventListener(&quot;focus&quot;, () =&gt; {</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+    highlightAddressContainer(input);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+  });</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+  input.addEventListener(&quot;blur&quot;, () =&gt; {</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+    resetAddressContainer(input);</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+  });</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+  input.addEventListener(&quot;keypress&quot;, event =&gt; {</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+    recipientKeyPress(event, input);</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+  });</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+  input.setAttribute(&quot;recipienttype&quot;, &quot;addr_other&quot;);</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+  input.setAttribute(&quot;size&quot;, 1);</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+  let highlightNonMatches = Services.prefs.getBoolPref(</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+    &quot;mail.autoComplete.highlightNonMatches&quot;</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+  );</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+  setupAutocompleteInput(input, highlightNonMatches);</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+  container.appendChild(input);</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+  row.appendChild(firstCol);</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+  row.appendChild(secondCol);</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+  row.appendChild(container);</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+  return row;</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+}</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+/**</span>
<a href="#l5.431"></a><span id="l5.431">  * Return the full display string for any non-default text encoding of the</span>
<a href="#l5.432"></a><span id="l5.432">  * current composition (friendly name plus official character set name).</span>
<a href="#l5.433"></a><span id="l5.433">  * For the default text encoding, return empty string (&quot;&quot;), to reduce</span>
<a href="#l5.434"></a><span id="l5.434">  * ux-complexity, e.g. for the default Status Bar display.</span>
<a href="#l5.435"></a><span id="l5.435">  * Note: The default is retrieved from mailnews.send_default_charset.</span>
<a href="#l5.436"></a><span id="l5.436">  *</span>
<a href="#l5.437"></a><span id="l5.437">  * @return string representation of non-default charset, otherwise &quot;&quot;.</span>
<a href="#l5.438"></a><span id="l5.438">  */</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineat">@@ -3530,20 +3680,20 @@ function DoSpellCheckBeforeSend() {</span>
<a href="#l5.440"></a><span id="l5.440">  * Handles message sending operations.</span>
<a href="#l5.441"></a><span id="l5.441">  * @param msgType nsIMsgCompDeliverMode of the operation.</span>
<a href="#l5.442"></a><span id="l5.442">  */</span>
<a href="#l5.443"></a><span id="l5.443"> function GenericSendMessage(msgType) {</span>
<a href="#l5.444"></a><span id="l5.444">   var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446">   Recipients2CompFields(msgCompFields);</span>
<a href="#l5.447"></a><span id="l5.447">   let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-    GetMsgIdentityElement().value</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+    document.getElementById(&quot;msgIdentity&quot;).value</span>
<a href="#l5.450"></a><span id="l5.450">   );</span>
<a href="#l5.451"></a><span id="l5.451">   msgCompFields.from = MailServices.headerParser.makeMimeHeader(addresses);</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-  var subject = GetMsgSubjectElement().value;</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+  var subject = document.getElementById(&quot;msgSubject&quot;).value;</span>
<a href="#l5.454"></a><span id="l5.454">   msgCompFields.subject = subject;</span>
<a href="#l5.455"></a><span id="l5.455">   Attachments2CompFields(msgCompFields);</span>
<a href="#l5.456"></a><span id="l5.456">   // Some other msgCompFields have already been updated instantly in their respective</span>
<a href="#l5.457"></a><span id="l5.457">   // toggle functions, e.g. ToggleReturnReceipt(), ToggleDSN(),  ToggleAttachVCard(),</span>
<a href="#l5.458"></a><span id="l5.458">   // and toggleAttachmentReminder().</span>
<a href="#l5.459"></a><span id="l5.459"> </span>
<a href="#l5.460"></a><span id="l5.460">   let sending =</span>
<a href="#l5.461"></a><span id="l5.461">     msgType == Ci.nsIMsgCompDeliverMode.Now ||</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineat">@@ -3579,17 +3729,17 @@ function GenericSendMessage(msgType) {</span>
<a href="#l5.463"></a><span id="l5.463">     }</span>
<a href="#l5.464"></a><span id="l5.464"> </span>
<a href="#l5.465"></a><span id="l5.465">     // Strip trailing spaces and long consecutive WSP sequences from the</span>
<a href="#l5.466"></a><span id="l5.466">     // subject line to prevent getting only WSP chars on a folded line.</span>
<a href="#l5.467"></a><span id="l5.467">     let fixedSubject = subject.replace(/\s{74,}/g, &quot;    &quot;).trimRight();</span>
<a href="#l5.468"></a><span id="l5.468">     if (fixedSubject != subject) {</span>
<a href="#l5.469"></a><span id="l5.469">       subject = fixedSubject;</span>
<a href="#l5.470"></a><span id="l5.470">       msgCompFields.subject = fixedSubject;</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-      GetMsgSubjectElement().value = fixedSubject;</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+      document.getElementById(&quot;msgSubject&quot;).value = fixedSubject;</span>
<a href="#l5.473"></a><span id="l5.473">     }</span>
<a href="#l5.474"></a><span id="l5.474"> </span>
<a href="#l5.475"></a><span id="l5.475">     // Remind the person if there isn't a subject</span>
<a href="#l5.476"></a><span id="l5.476">     if (subject == &quot;&quot;) {</span>
<a href="#l5.477"></a><span id="l5.477">       if (</span>
<a href="#l5.478"></a><span id="l5.478">         Services.prompt.confirmEx(</span>
<a href="#l5.479"></a><span id="l5.479">           window,</span>
<a href="#l5.480"></a><span id="l5.480">           getComposeBundle().getString(&quot;subjectEmptyTitle&quot;),</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineat">@@ -3600,17 +3750,17 @@ function GenericSendMessage(msgType) {</span>
<a href="#l5.482"></a><span id="l5.482">               Services.prompt.BUTTON_POS_1,</span>
<a href="#l5.483"></a><span id="l5.483">           getComposeBundle().getString(&quot;sendWithEmptySubjectButton&quot;),</span>
<a href="#l5.484"></a><span id="l5.484">           getComposeBundle().getString(&quot;cancelSendingButton&quot;),</span>
<a href="#l5.485"></a><span id="l5.485">           null,</span>
<a href="#l5.486"></a><span id="l5.486">           null,</span>
<a href="#l5.487"></a><span id="l5.487">           { value: 0 }</span>
<a href="#l5.488"></a><span id="l5.488">         ) == 1</span>
<a href="#l5.489"></a><span id="l5.489">       ) {</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-        GetMsgSubjectElement().focus();</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+        document.getElementById(&quot;msgSubject&quot;).focus();</span>
<a href="#l5.492"></a><span id="l5.492">         return;</span>
<a href="#l5.493"></a><span id="l5.493">       }</span>
<a href="#l5.494"></a><span id="l5.494">     }</span>
<a href="#l5.495"></a><span id="l5.495"> </span>
<a href="#l5.496"></a><span id="l5.496">     // Attachment Reminder: Alert the user if</span>
<a href="#l5.497"></a><span id="l5.497">     //  - the user requested &quot;Remind me later&quot; from either the notification bar or the menu</span>
<a href="#l5.498"></a><span id="l5.498">     //    (alert regardless of the number of files already attached: we can't guess for how many</span>
<a href="#l5.499"></a><span id="l5.499">     //    or which files users want the reminder, and guessing wrong will annoy them a lot), OR</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineat">@@ -3847,53 +3997,74 @@ function GenericSendMessage(msgType) {</span>
<a href="#l5.501"></a><span id="l5.501">  *</span>
<a href="#l5.502"></a><span id="l5.502">  * @param aAddress  The address string to check.</span>
<a href="#l5.503"></a><span id="l5.503">  */</span>
<a href="#l5.504"></a><span id="l5.504"> function isValidAddress(aAddress) {</span>
<a href="#l5.505"></a><span id="l5.505">   return aAddress.includes(&quot;@&quot;, 1) &amp;&amp; !aAddress.endsWith(&quot;@&quot;);</span>
<a href="#l5.506"></a><span id="l5.506"> }</span>
<a href="#l5.507"></a><span id="l5.507"> </span>
<a href="#l5.508"></a><span id="l5.508"> /**</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+ * Force the focus on the autocomplete input if the user clicks on an empty</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+ * area of the address container.</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+ *</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+ * @param {Event} event - the event triggered by the click.</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+ */</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+function focusAddressInput(event) {</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+  let container = event.originalTarget;</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+  if (container.classList.contains(&quot;address-container&quot;)) {</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+    container</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+      .querySelector(`input[is=&quot;autocomplete-input&quot;][recipienttype]`)</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+      .focus();</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+  }</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+}</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+/**</span>
<a href="#l5.524"></a><span id="l5.524">  * Keep the Send buttons disabled until any recipient is entered.</span>
<a href="#l5.525"></a><span id="l5.525">  */</span>
<a href="#l5.526"></a><span id="l5.526"> function updateSendLock() {</span>
<a href="#l5.527"></a><span id="l5.527">   gSendLocked = true;</span>
<a href="#l5.528"></a><span id="l5.528">   if (!gMsgCompose) {</span>
<a href="#l5.529"></a><span id="l5.529">     return;</span>
<a href="#l5.530"></a><span id="l5.530">   }</span>
<a href="#l5.531"></a><span id="l5.531"> </span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-  const mailTypes = [&quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_bcc&quot;];</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-  // Enable the send buttons if anything usable was entered into at least one</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-  // recipient field.</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-  for (let row = 1; row &lt;= top.MAX_RECIPIENTS; row++) {</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-    let popupValue = awGetPopupElement(row).value;</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-    let inputValue = awGetInputElement(row).value.trim();</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-    if (mailTypes.includes(popupValue)) {</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-      if (isValidAddress(inputValue)) {</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-        // a properly looking email address</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+  const addressRows = [</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+    &quot;toAddrContainer&quot;,</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+    &quot;ccAddrContainer&quot;,</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+    &quot;bccAddrContainer&quot;,</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+    &quot;newsgroupsAddrContainer&quot;,</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+  ];</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+  for (let parentID of addressRows) {</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+    if (!gSendLocked) {</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+      break;</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+    }</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+    let parent = document.getElementById(parentID);</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+    if (!parent) {</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+      continue;</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+    }</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+    for (let address of parent.querySelectorAll(&quot;.address-pill&quot;)) {</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+      let listNames = MimeParser.parseHeaderField(</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+        address.fullAddress,</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+        MimeParser.HEADER_ADDRESS</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+      );</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+      let isMailingList =</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+        listNames.length &gt; 0 &amp;&amp;</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+        MailServices.ab.mailListNameExists(listNames[0].name);</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+      if (</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+        isValidAddress(address.emailAddress) ||</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+        isMailingList ||</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+        address.originalInput.classList.contains(&quot;nntp-input&quot;)</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+      ) {</span>
<a href="#l5.574"></a><span id="l5.574">         gSendLocked = false;</span>
<a href="#l5.575"></a><span id="l5.575">         break;</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-      } else {</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineminus">-        // a valid mailing list name in some or our addressbooks</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineminus">-        let listNames = MimeParser.parseHeaderField(</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-          inputValue,</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-          MimeParser.HEADER_ADDRESS</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineminus">-        );</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineminus">-        if (</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-          listNames.length &gt; 0 &amp;&amp;</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineminus">-          MailServices.ab.mailListNameExists(listNames[0].name)</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineminus">-        ) {</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineminus">-          gSendLocked = false;</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-          break;</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineminus">-        }</span>
<a href="#l5.589"></a><span id="l5.589">       }</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-    } else if (popupValue == &quot;addr_newsgroups&quot; &amp;&amp; inputValue != &quot;&quot;) {</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-      gSendLocked = false;</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-      break;</span>
<a href="#l5.593"></a><span id="l5.593">     }</span>
<a href="#l5.594"></a><span id="l5.594">   }</span>
<a href="#l5.595"></a><span id="l5.595"> }</span>
<a href="#l5.596"></a><span id="l5.596"> </span>
<a href="#l5.597"></a><span id="l5.597"> /**</span>
<a href="#l5.598"></a><span id="l5.598">  * Check if the entered addresses are valid and alert the user if they are not.</span>
<a href="#l5.599"></a><span id="l5.599">  *</span>
<a href="#l5.600"></a><span id="l5.600">  * @param aMsgCompFields  A nsIMsgCompFields object containing the fields to check.</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineat">@@ -4029,18 +4200,19 @@ function Save() {</span>
<a href="#l5.602"></a><span id="l5.602">       break;</span>
<a href="#l5.603"></a><span id="l5.603">     default:</span>
<a href="#l5.604"></a><span id="l5.604">       SaveAsDraft(false);</span>
<a href="#l5.605"></a><span id="l5.605">       break;</span>
<a href="#l5.606"></a><span id="l5.606">   }</span>
<a href="#l5.607"></a><span id="l5.607"> }</span>
<a href="#l5.608"></a><span id="l5.608"> </span>
<a href="#l5.609"></a><span id="l5.609"> function SaveAsFile(saveAs) {</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-  var subject = GetMsgSubjectElement().value;</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-  GetCurrentEditorElement().contentDocument.title = subject;</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+  GetCurrentEditorElement().contentDocument.title = document.getElementById(</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+    &quot;msgSubject&quot;</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+  ).value;</span>
<a href="#l5.615"></a><span id="l5.615"> </span>
<a href="#l5.616"></a><span id="l5.616">   if (gMsgCompose.bodyConvertible() == Ci.nsIMsgCompConvertible.Plain) {</span>
<a href="#l5.617"></a><span id="l5.617">     SaveDocument(saveAs, false, &quot;text/plain&quot;);</span>
<a href="#l5.618"></a><span id="l5.618">   } else {</span>
<a href="#l5.619"></a><span id="l5.619">     SaveDocument(saveAs, false, &quot;text/html&quot;);</span>
<a href="#l5.620"></a><span id="l5.620">   }</span>
<a href="#l5.621"></a><span id="l5.621">   defaultSaveOperation = &quot;file&quot;;</span>
<a href="#l5.622"></a><span id="l5.622"> }</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineat">@@ -4288,23 +4460,16 @@ var spellCheckReadyObserver = {</span>
<a href="#l5.624"></a><span id="l5.624">     this._clearPendingWords();</span>
<a href="#l5.625"></a><span id="l5.625">   },</span>
<a href="#l5.626"></a><span id="l5.626"> </span>
<a href="#l5.627"></a><span id="l5.627">   _clearPendingWords() {</span>
<a href="#l5.628"></a><span id="l5.628">     this._ignoreWords.length = 0;</span>
<a href="#l5.629"></a><span id="l5.629">   },</span>
<a href="#l5.630"></a><span id="l5.630"> };</span>
<a href="#l5.631"></a><span id="l5.631"> </span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-function onAddressColCommand(aAddressWidgetId) {</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-  gContentChanged = true;</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-  let row = aAddressWidgetId.slice(aAddressWidgetId.lastIndexOf(&quot;#&quot;) + 1);</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineminus">-  awSetAutoComplete(row);</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineminus">-  updateSendCommands(true);</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-}</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-</span>
<a href="#l5.639"></a><span id="l5.639"> /**</span>
<a href="#l5.640"></a><span id="l5.640">  * Called if the list of recipients changed in any way.</span>
<a href="#l5.641"></a><span id="l5.641">  *</span>
<a href="#l5.642"></a><span id="l5.642">  * @param aAutomatic  Set to true if the change of recipients was invoked</span>
<a href="#l5.643"></a><span id="l5.643">  *                    programmatically and should not be considered a change</span>
<a href="#l5.644"></a><span id="l5.644">  *                    of message content.</span>
<a href="#l5.645"></a><span id="l5.645">  */</span>
<a href="#l5.646"></a><span id="l5.646"> function onRecipientsChanged(aAutomatic) {</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineat">@@ -4428,19 +4593,19 @@ function ComposeChangeLanguage(aLang) {</span>
<a href="#l5.648"></a><span id="l5.648">       spellChecker.SetCurrentDictionary(aLang);</span>
<a href="#l5.649"></a><span id="l5.649"> </span>
<a href="#l5.650"></a><span id="l5.650">       // now check the document over again with the new dictionary</span>
<a href="#l5.651"></a><span id="l5.651">       if (gSpellChecker.enabled) {</span>
<a href="#l5.652"></a><span id="l5.652">         gSpellChecker.mInlineSpellChecker.spellCheckRange(null);</span>
<a href="#l5.653"></a><span id="l5.653"> </span>
<a href="#l5.654"></a><span id="l5.654">         // Also force a recheck of the subject. If for some reason the spell</span>
<a href="#l5.655"></a><span id="l5.655">         // checker isn't ready yet, don't auto-create it, hence pass 'false'.</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-        let inlineSpellChecker = GetMsgSubjectElement().editor.getInlineSpellChecker(</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineminus">-          false</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineminus">-        );</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+        let inlineSpellChecker = document</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+          .getElementById(&quot;msgSubject&quot;)</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+          .editor.getInlineSpellChecker(false);</span>
<a href="#l5.662"></a><span id="l5.662">         if (inlineSpellChecker) {</span>
<a href="#l5.663"></a><span id="l5.663">           inlineSpellChecker.spellCheckRange(null);</span>
<a href="#l5.664"></a><span id="l5.664">         }</span>
<a href="#l5.665"></a><span id="l5.665">       }</span>
<a href="#l5.666"></a><span id="l5.666">     }</span>
<a href="#l5.667"></a><span id="l5.667">   }</span>
<a href="#l5.668"></a><span id="l5.668"> }</span>
<a href="#l5.669"></a><span id="l5.669"> </span>
<a href="#l5.670"></a><span id="l5.670" class="difflineat">@@ -4601,17 +4766,17 @@ function FillIdentityList(menulist) {</span>
<a href="#l5.671"></a><span id="l5.671">   menulist.menupopup.appendChild(document.createXULElement(&quot;menuseparator&quot;));</span>
<a href="#l5.672"></a><span id="l5.672">   menulist.menupopup</span>
<a href="#l5.673"></a><span id="l5.673">     .appendChild(document.createXULElement(&quot;menuitem&quot;))</span>
<a href="#l5.674"></a><span id="l5.674">     .setAttribute(&quot;command&quot;, &quot;cmd_customizeFromAddress&quot;);</span>
<a href="#l5.675"></a><span id="l5.675"> }</span>
<a href="#l5.676"></a><span id="l5.676"> </span>
<a href="#l5.677"></a><span id="l5.677"> function getCurrentAccountKey() {</span>
<a href="#l5.678"></a><span id="l5.678">   // Get the account's key.</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineminus">-  let identityList = GetMsgIdentityElement();</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineplus">+  let identityList = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l5.681"></a><span id="l5.681">   return identityList.getAttribute(&quot;accountkey&quot;);</span>
<a href="#l5.682"></a><span id="l5.682"> }</span>
<a href="#l5.683"></a><span id="l5.683"> </span>
<a href="#l5.684"></a><span id="l5.684"> function getCurrentIdentityKey() {</span>
<a href="#l5.685"></a><span id="l5.685">   // Get the identity key.</span>
<a href="#l5.686"></a><span id="l5.686">   return gCurrentIdentity.key;</span>
<a href="#l5.687"></a><span id="l5.687"> }</span>
<a href="#l5.688"></a><span id="l5.688"> </span>
<a href="#l5.689"></a><span id="l5.689" class="difflineat">@@ -4619,22 +4784,22 @@ function getIdentityForKey(key) {</span>
<a href="#l5.690"></a><span id="l5.690">   return MailServices.accounts.getIdentity(key);</span>
<a href="#l5.691"></a><span id="l5.691"> }</span>
<a href="#l5.692"></a><span id="l5.692"> </span>
<a href="#l5.693"></a><span id="l5.693"> function getCurrentIdentity() {</span>
<a href="#l5.694"></a><span id="l5.694">   return getIdentityForKey(getCurrentIdentityKey());</span>
<a href="#l5.695"></a><span id="l5.695"> }</span>
<a href="#l5.696"></a><span id="l5.696"> </span>
<a href="#l5.697"></a><span id="l5.697"> function AdjustFocus() {</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineminus">-  let element = awGetInputElement(awGetNumberOfRecipients());</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+  let element = document.getElementById(&quot;toAddrInput&quot;);</span>
<a href="#l5.700"></a><span id="l5.700">   if (element.value == &quot;&quot;) {</span>
<a href="#l5.701"></a><span id="l5.701">     // Focus last row of addressing widget.</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineminus">-    awSetFocusTo(element);</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+    element.focus();</span>
<a href="#l5.704"></a><span id="l5.704">   } else {</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineminus">-    element = GetMsgSubjectElement();</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+    element = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l5.707"></a><span id="l5.707">     if (element.value == &quot;&quot;) {</span>
<a href="#l5.708"></a><span id="l5.708">       // Focus subject.</span>
<a href="#l5.709"></a><span id="l5.709">       element.focus();</span>
<a href="#l5.710"></a><span id="l5.710">     } else {</span>
<a href="#l5.711"></a><span id="l5.711">       // Focus message body.</span>
<a href="#l5.712"></a><span id="l5.712">       SetMsgBodyFrameFocus();</span>
<a href="#l5.713"></a><span id="l5.713">     }</span>
<a href="#l5.714"></a><span id="l5.714">   }</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineat">@@ -4646,17 +4811,17 @@ function AdjustFocus() {</span>
<a href="#l5.716"></a><span id="l5.716">  * @param isPrintPreview (optional) true:  Set title for 'Print Preview' window.</span>
<a href="#l5.717"></a><span id="l5.717">  *                                  false: Set title for 'Write' window (default).</span>
<a href="#l5.718"></a><span id="l5.718">  */</span>
<a href="#l5.719"></a><span id="l5.719"> function SetComposeWindowTitle(isPrintPreview = false) {</span>
<a href="#l5.720"></a><span id="l5.720">   let aStringName = isPrintPreview</span>
<a href="#l5.721"></a><span id="l5.721">     ? &quot;windowTitlePrintPreview&quot;</span>
<a href="#l5.722"></a><span id="l5.722">     : &quot;windowTitleWrite&quot;;</span>
<a href="#l5.723"></a><span id="l5.723">   let subject =</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-    GetMsgSubjectElement().value.trim() ||</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+    document.getElementById(&quot;msgSubject&quot;).value.trim() ||</span>
<a href="#l5.726"></a><span id="l5.726">     getComposeBundle().getString(&quot;defaultSubject&quot;);</span>
<a href="#l5.727"></a><span id="l5.727">   let brandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l5.728"></a><span id="l5.728">   let brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l5.729"></a><span id="l5.729">   let newTitle = getComposeBundle().getFormattedString(aStringName, [</span>
<a href="#l5.730"></a><span id="l5.730">     subject,</span>
<a href="#l5.731"></a><span id="l5.731">     brandShortName,</span>
<a href="#l5.732"></a><span id="l5.732">   ]);</span>
<a href="#l5.733"></a><span id="l5.733">   document.title = newTitle;</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineat">@@ -6178,24 +6343,17 @@ function hideIrrelevantAddressingOptions</span>
<a href="#l5.735"></a><span id="l5.735">     Ci.nsIMsgAccount</span>
<a href="#l5.736"></a><span id="l5.736">   )) {</span>
<a href="#l5.737"></a><span id="l5.737">     if (account.incomingServer.type == &quot;nntp&quot;) {</span>
<a href="#l5.738"></a><span id="l5.738">       hideNews = false;</span>
<a href="#l5.739"></a><span id="l5.739">     }</span>
<a href="#l5.740"></a><span id="l5.740">   }</span>
<a href="#l5.741"></a><span id="l5.741">   // If there is no News (NNTP) account existing then</span>
<a href="#l5.742"></a><span id="l5.742">   // hide the Newsgroup and Followup-To recipient type in all the menulists.</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineminus">-  let addrWidget = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineminus">-  // Only really touch the News related items we know about.</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineminus">-  let newsTypes = addrWidget.querySelectorAll(</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineminus">-    'menuitem[value=&quot;addr_newsgroups&quot;], menuitem[value=&quot;addr_followup&quot;]'</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineminus">-  );</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-  // Collapsing the menuitem only prevents it getting chosen, it does not</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineminus">-  // affect the menulist widget display when Newsgroup is already selected.</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineminus">-  for (let item of newsTypes) {</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+  for (let item of document.querySelectorAll(&quot;.nntp-label&quot;)) {</span>
<a href="#l5.752"></a><span id="l5.752">     item.collapsed = hideNews;</span>
<a href="#l5.753"></a><span id="l5.753">   }</span>
<a href="#l5.754"></a><span id="l5.754"> }</span>
<a href="#l5.755"></a><span id="l5.755"> </span>
<a href="#l5.756"></a><span id="l5.756"> function LoadIdentity(startup) {</span>
<a href="#l5.757"></a><span id="l5.757">   var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l5.758"></a><span id="l5.758">   var prevIdentity = gCurrentIdentity;</span>
<a href="#l5.759"></a><span id="l5.759"> </span>
<a href="#l5.760"></a><span id="l5.760" class="difflineat">@@ -6209,22 +6367,23 @@ function LoadIdentity(startup) {</span>
<a href="#l5.761"></a><span id="l5.761">       gCurrentIdentity = MailServices.accounts.getIdentity(idKey);</span>
<a href="#l5.762"></a><span id="l5.762"> </span>
<a href="#l5.763"></a><span id="l5.763">       // Set the account key value on the menu list.</span>
<a href="#l5.764"></a><span id="l5.764">       accountKey = identityElement.selectedItem.getAttribute(&quot;accountkey&quot;);</span>
<a href="#l5.765"></a><span id="l5.765">       identityElement.setAttribute(&quot;accountkey&quot;, accountKey);</span>
<a href="#l5.766"></a><span id="l5.766">       hideIrrelevantAddressingOptions(accountKey);</span>
<a href="#l5.767"></a><span id="l5.767">     }</span>
<a href="#l5.768"></a><span id="l5.768"> </span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-    let maxRecipients = awGetNumberOfRecipients();</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineminus">-    for (let i = 1; i &lt;= maxRecipients; i++) {</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineminus">-      let params = JSON.parse(awGetInputElement(i).searchParam);</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+    for (let input of document.querySelectorAll(</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+      &quot;.pop-imap-input,.nntp-input&quot;</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+    )) {</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+      let params = JSON.parse(input.searchParam);</span>
<a href="#l5.776"></a><span id="l5.776">       params.idKey = idKey;</span>
<a href="#l5.777"></a><span id="l5.777">       params.accountKey = accountKey;</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineminus">-      awGetInputElement(i).searchParam = JSON.stringify(params);</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+      input.searchParam = JSON.stringify(params);</span>
<a href="#l5.780"></a><span id="l5.780">     }</span>
<a href="#l5.781"></a><span id="l5.781"> </span>
<a href="#l5.782"></a><span id="l5.782">     if (!startup &amp;&amp; prevIdentity &amp;&amp; idKey != prevIdentity.key) {</span>
<a href="#l5.783"></a><span id="l5.783">       var prevReplyTo = prevIdentity.replyTo;</span>
<a href="#l5.784"></a><span id="l5.784">       var prevCc = &quot;&quot;;</span>
<a href="#l5.785"></a><span id="l5.785">       var prevBcc = &quot;&quot;;</span>
<a href="#l5.786"></a><span id="l5.786">       var prevReceipt = prevIdentity.requestReturnReceipt;</span>
<a href="#l5.787"></a><span id="l5.787">       var prevDSN = prevIdentity.DSN;</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineat">@@ -6248,17 +6407,16 @@ function LoadIdentity(startup) {</span>
<a href="#l5.789"></a><span id="l5.789">       if (gCurrentIdentity.doCc) {</span>
<a href="#l5.790"></a><span id="l5.790">         newCc += gCurrentIdentity.doCcList;</span>
<a href="#l5.791"></a><span id="l5.791">       }</span>
<a href="#l5.792"></a><span id="l5.792"> </span>
<a href="#l5.793"></a><span id="l5.793">       if (gCurrentIdentity.doBcc) {</span>
<a href="#l5.794"></a><span id="l5.794">         newBcc += gCurrentIdentity.doBccList;</span>
<a href="#l5.795"></a><span id="l5.795">       }</span>
<a href="#l5.796"></a><span id="l5.796"> </span>
<a href="#l5.797"></a><span id="l5.797" class="difflineminus">-      var needToCleanUp = false;</span>
<a href="#l5.798"></a><span id="l5.798">       var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l5.799"></a><span id="l5.799"> </span>
<a href="#l5.800"></a><span id="l5.800">       if (</span>
<a href="#l5.801"></a><span id="l5.801">         !gReceiptOptionChanged &amp;&amp;</span>
<a href="#l5.802"></a><span id="l5.802">         prevReceipt == msgCompFields.returnReceipt &amp;&amp;</span>
<a href="#l5.803"></a><span id="l5.803">         prevReceipt != newReceipt</span>
<a href="#l5.804"></a><span id="l5.804">       ) {</span>
<a href="#l5.805"></a><span id="l5.805">         msgCompFields.returnReceipt = newReceipt;</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineat">@@ -6285,93 +6443,85 @@ function LoadIdentity(startup) {</span>
<a href="#l5.807"></a><span id="l5.807">       ) {</span>
<a href="#l5.808"></a><span id="l5.808">         msgCompFields.attachVCard = newAttachVCard;</span>
<a href="#l5.809"></a><span id="l5.809">         document</span>
<a href="#l5.810"></a><span id="l5.810">           .getElementById(&quot;cmd_attachVCard&quot;)</span>
<a href="#l5.811"></a><span id="l5.811">           .setAttribute(&quot;checked&quot;, msgCompFields.attachVCard);</span>
<a href="#l5.812"></a><span id="l5.812">       }</span>
<a href="#l5.813"></a><span id="l5.813"> </span>
<a href="#l5.814"></a><span id="l5.814">       if (newReplyTo != prevReplyTo) {</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineminus">-        needToCleanUp = true;</span>
<a href="#l5.816"></a><span id="l5.816">         if (prevReplyTo != &quot;&quot;) {</span>
<a href="#l5.817"></a><span id="l5.817">           awRemoveRecipients(msgCompFields, &quot;addr_reply&quot;, prevReplyTo);</span>
<a href="#l5.818"></a><span id="l5.818">         }</span>
<a href="#l5.819"></a><span id="l5.819">         if (newReplyTo != &quot;&quot;) {</span>
<a href="#l5.820"></a><span id="l5.820">           awAddRecipients(msgCompFields, &quot;addr_reply&quot;, newReplyTo);</span>
<a href="#l5.821"></a><span id="l5.821">         }</span>
<a href="#l5.822"></a><span id="l5.822">       }</span>
<a href="#l5.823"></a><span id="l5.823"> </span>
<a href="#l5.824"></a><span id="l5.824">       let toAddrs = new Set(</span>
<a href="#l5.825"></a><span id="l5.825">         msgCompFields.splitRecipients(msgCompFields.to, true)</span>
<a href="#l5.826"></a><span id="l5.826">       );</span>
<a href="#l5.827"></a><span id="l5.827">       let ccAddrs = new Set(</span>
<a href="#l5.828"></a><span id="l5.828">         msgCompFields.splitRecipients(msgCompFields.cc, true)</span>
<a href="#l5.829"></a><span id="l5.829">       );</span>
<a href="#l5.830"></a><span id="l5.830"> </span>
<a href="#l5.831"></a><span id="l5.831">       if (newCc != prevCc) {</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineminus">-        needToCleanUp = true;</span>
<a href="#l5.833"></a><span id="l5.833">         if (prevCc) {</span>
<a href="#l5.834"></a><span id="l5.834">           awRemoveRecipients(msgCompFields, &quot;addr_cc&quot;, prevCc);</span>
<a href="#l5.835"></a><span id="l5.835">         }</span>
<a href="#l5.836"></a><span id="l5.836">         if (newCc) {</span>
<a href="#l5.837"></a><span id="l5.837">           // Ensure none of the Ccs are already in To.</span>
<a href="#l5.838"></a><span id="l5.838">           let cc2 = msgCompFields.splitRecipients(newCc, true);</span>
<a href="#l5.839"></a><span id="l5.839">           newCc = cc2.filter(x =&gt; !toAddrs.has(x)).join(&quot;, &quot;);</span>
<a href="#l5.840"></a><span id="l5.840">           awAddRecipients(msgCompFields, &quot;addr_cc&quot;, newCc);</span>
<a href="#l5.841"></a><span id="l5.841">         }</span>
<a href="#l5.842"></a><span id="l5.842">       }</span>
<a href="#l5.843"></a><span id="l5.843"> </span>
<a href="#l5.844"></a><span id="l5.844">       if (newBcc != prevBcc) {</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineminus">-        needToCleanUp = true;</span>
<a href="#l5.846"></a><span id="l5.846">         if (prevBcc) {</span>
<a href="#l5.847"></a><span id="l5.847">           awRemoveRecipients(msgCompFields, &quot;addr_bcc&quot;, prevBcc);</span>
<a href="#l5.848"></a><span id="l5.848">         }</span>
<a href="#l5.849"></a><span id="l5.849">         if (newBcc) {</span>
<a href="#l5.850"></a><span id="l5.850">           // Ensure none of the Bccs are already in To or Cc.</span>
<a href="#l5.851"></a><span id="l5.851">           let bcc2 = msgCompFields.splitRecipients(newBcc, true);</span>
<a href="#l5.852"></a><span id="l5.852">           let toCcAddrs = new Set([...toAddrs, ...ccAddrs]);</span>
<a href="#l5.853"></a><span id="l5.853">           newBcc = bcc2.filter(x =&gt; !toCcAddrs.has(x)).join(&quot;, &quot;);</span>
<a href="#l5.854"></a><span id="l5.854">           awAddRecipients(msgCompFields, &quot;addr_bcc&quot;, newBcc);</span>
<a href="#l5.855"></a><span id="l5.855">         }</span>
<a href="#l5.856"></a><span id="l5.856">       }</span>
<a href="#l5.857"></a><span id="l5.857"> </span>
<a href="#l5.858"></a><span id="l5.858" class="difflineminus">-      if (needToCleanUp) {</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineminus">-        awCleanupRows();</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-      }</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineminus">-</span>
<a href="#l5.862"></a><span id="l5.862">       try {</span>
<a href="#l5.863"></a><span id="l5.863">         gMsgCompose.identity = gCurrentIdentity;</span>
<a href="#l5.864"></a><span id="l5.864">       } catch (ex) {</span>
<a href="#l5.865"></a><span id="l5.865">         dump(&quot;### Cannot change the identity: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l5.866"></a><span id="l5.866">       }</span>
<a href="#l5.867"></a><span id="l5.867"> </span>
<a href="#l5.868"></a><span id="l5.868">       var event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l5.869"></a><span id="l5.869">       event.initEvent(&quot;compose-from-changed&quot;, false, true);</span>
<a href="#l5.870"></a><span id="l5.870">       document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l5.871"></a><span id="l5.871"> </span>
<a href="#l5.872"></a><span id="l5.872">       gComposeNotificationBar.clearIdentityWarning();</span>
<a href="#l5.873"></a><span id="l5.873">     }</span>
<a href="#l5.874"></a><span id="l5.874"> </span>
<a href="#l5.875"></a><span id="l5.875">     if (!startup) {</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-      if (Services.prefs.getBoolPref(&quot;mail.autoComplete.highlightNonMatches&quot;)) {</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-        document.getElementById(&quot;addressCol2#1&quot;).highlightNonMatches = true;</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineminus">-      }</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineminus">-</span>
<a href="#l5.880"></a><span id="l5.880">       // Only do this if we aren't starting up...</span>
<a href="#l5.881"></a><span id="l5.881">       // It gets done as part of startup already.</span>
<a href="#l5.882"></a><span id="l5.882">       addRecipientsToIgnoreList(gCurrentIdentity.fullAddress);</span>
<a href="#l5.883"></a><span id="l5.883"> </span>
<a href="#l5.884"></a><span id="l5.884">       // If the From field is editable, reset the address from the identity.</span>
<a href="#l5.885"></a><span id="l5.885">       if (identityElement.editable) {</span>
<a href="#l5.886"></a><span id="l5.886">         identityElement.value = identityElement.selectedItem.value;</span>
<a href="#l5.887"></a><span id="l5.887">         identityElement.placeholder = getComposeBundle().getFormattedString(</span>
<a href="#l5.888"></a><span id="l5.888">           &quot;msgIdentityPlaceholder&quot;,</span>
<a href="#l5.889"></a><span id="l5.889">           [identityElement.selectedItem.value]</span>
<a href="#l5.890"></a><span id="l5.890">         );</span>
<a href="#l5.891"></a><span id="l5.891">       }</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+      SetMsgToRecipientElementFocus();</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineplus">+      onRecipientsChanged(true);</span>
<a href="#l5.895"></a><span id="l5.895">     }</span>
<a href="#l5.896"></a><span id="l5.896">   }</span>
<a href="#l5.897"></a><span id="l5.897"> }</span>
<a href="#l5.898"></a><span id="l5.898"> </span>
<a href="#l5.899"></a><span id="l5.899"> function MakeFromFieldEditable(ignoreWarning) {</span>
<a href="#l5.900"></a><span id="l5.900">   let bundle = getComposeBundle();</span>
<a href="#l5.901"></a><span id="l5.901">   if (</span>
<a href="#l5.902"></a><span id="l5.902">     !ignoreWarning &amp;&amp;</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineat">@@ -6411,30 +6561,65 @@ function MakeFromFieldEditable(ignoreWar</span>
<a href="#l5.904"></a><span id="l5.904">   identityElement.select();</span>
<a href="#l5.905"></a><span id="l5.905">   identityElement.placeholder = bundle.getFormattedString(</span>
<a href="#l5.906"></a><span id="l5.906">     &quot;msgIdentityPlaceholder&quot;,</span>
<a href="#l5.907"></a><span id="l5.907">     [identityElement.selectedItem.value]</span>
<a href="#l5.908"></a><span id="l5.908">   );</span>
<a href="#l5.909"></a><span id="l5.909"> }</span>
<a href="#l5.910"></a><span id="l5.910"> </span>
<a href="#l5.911"></a><span id="l5.911"> function setupAutocomplete() {</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineminus">-  var autoCompleteWidget = document.getElementById(&quot;addressCol2#1&quot;);</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineminus">-  try {</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineminus">-    // Request that input that isn't matched be highlighted.</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-    // This element then gets cloned for subsequent rows, so they should</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-    // honor it as well.</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;mail.autoComplete.highlightNonMatches&quot;)) {</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-      autoCompleteWidget.highlightNonMatches = true;</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-    }</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineminus">-  } catch (ex) {}</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineplus">+  let highlightNonMatches = Services.prefs.getBoolPref(</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+    &quot;mail.autoComplete.highlightNonMatches&quot;</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineplus">+  );</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineplus">+</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineplus">+  for (let input of document.querySelectorAll(&quot;.pop-imap-input,.nntp-input&quot;)) {</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineplus">+    setupAutocompleteInput(input, highlightNonMatches);</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+  }</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineplus">+}</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineplus">+</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineplus">+function setupAutocompleteInput(input, highlightNonMatches) {</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineplus">+  let params = JSON.parse(input.getAttribute(&quot;autocompletesearchparam&quot;));</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineplus">+  params.type = input.getAttribute(&quot;recipienttype&quot;);</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+  input.setAttribute(&quot;autocompletesearchparam&quot;, JSON.stringify(params));</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+  // This method overrides the autocomplete binding's openPopup (essentially</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineplus">+  // duplicating the logic from the autocomplete popup binding's</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineplus">+  // openAutocompletePopup method), modifying it so that the popup is aligned</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineplus">+  // and sized based on the parentNode of the input field.</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineplus">+  input.openPopup = () =&gt; {</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineplus">+    if (input.focused) {</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineplus">+      input.popup.openAutocompletePopup(</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineplus">+        input.nsIAutocompleteInput,</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineplus">+        input.closest(&quot;.address-container&quot;)</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+      );</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineplus">+    }</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+  };</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineplus">+</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineplus">+  // Request that input that isn't matched be highlighted.</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+  input.highlightNonMatches = highlightNonMatches;</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+}</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineplus">+</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+/**</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineplus">+ * Select all the pills in the same recipient container if they exist.</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineplus">+ *</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineplus">+ * @param {HTMLElement} input - The autocomplete input field.</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineplus">+ */</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineplus">+function selectRecipientPills(input) {</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+  let previous = input.previousElementSibling;</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+  if (previous &amp;&amp; previous.tagName == &quot;mail-address-pill&quot;) {</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+    for (let pill of getSiblingPills(input)) {</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineplus">+      pill.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineplus">+    }</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineplus">+    previous.focus();</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineplus">+  }</span>
<a href="#l5.965"></a><span id="l5.965"> }</span>
<a href="#l5.966"></a><span id="l5.966"> </span>
<a href="#l5.967"></a><span id="l5.967"> function fromKeyPress(event) {</span>
<a href="#l5.968"></a><span id="l5.968">   if (event.keyCode == KeyEvent.DOM_VK_RETURN) {</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineminus">-    awSetFocusTo(awGetInputElement(1));</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineplus">+    document.getElementById(&quot;toAddrInput&quot;).focus();</span>
<a href="#l5.971"></a><span id="l5.971">   }</span>
<a href="#l5.972"></a><span id="l5.972"> }</span>
<a href="#l5.973"></a><span id="l5.973"> </span>
<a href="#l5.974"></a><span id="l5.974"> function subjectKeyPress(event) {</span>
<a href="#l5.975"></a><span id="l5.975">   gSubjectChanged = true;</span>
<a href="#l5.976"></a><span id="l5.976">   if (event.keyCode == KeyEvent.DOM_VK_RETURN) {</span>
<a href="#l5.977"></a><span id="l5.977">     SetMsgBodyFrameFocus();</span>
<a href="#l5.978"></a><span id="l5.978">   }</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineat">@@ -6841,26 +7026,26 @@ function DisplaySaveFolderDlg(folderURI)</span>
<a href="#l5.980"></a><span id="l5.980">       checkbox</span>
<a href="#l5.981"></a><span id="l5.981">     );</span>
<a href="#l5.982"></a><span id="l5.982">     try {</span>
<a href="#l5.983"></a><span id="l5.983">       gCurrentIdentity.showSaveMsgDlg = !checkbox.value;</span>
<a href="#l5.984"></a><span id="l5.984">     } catch (e) {}</span>
<a href="#l5.985"></a><span id="l5.985">   }</span>
<a href="#l5.986"></a><span id="l5.986"> }</span>
<a href="#l5.987"></a><span id="l5.987"> </span>
<a href="#l5.988"></a><span id="l5.988" class="difflineminus">-function SetMsgAddressingWidgetTreeElementFocus() {</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineminus">-  awSetFocusTo(awGetInputElement(awGetNumberOfRecipients()));</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineplus">+function SetMsgToRecipientElementFocus() {</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineplus">+  document.getElementById(&quot;toAddrInput&quot;).focus();</span>
<a href="#l5.992"></a><span id="l5.992"> }</span>
<a href="#l5.993"></a><span id="l5.993"> </span>
<a href="#l5.994"></a><span id="l5.994"> function SetMsgIdentityElementFocus() {</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineminus">-  GetMsgIdentityElement().focus();</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineplus">+  document.getElementById(&quot;msgIdentity&quot;).focus();</span>
<a href="#l5.997"></a><span id="l5.997"> }</span>
<a href="#l5.998"></a><span id="l5.998"> </span>
<a href="#l5.999"></a><span id="l5.999"> function SetMsgSubjectElementFocus() {</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineminus">-  GetMsgSubjectElement().focus();</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+  document.getElementById(&quot;msgSubject&quot;).focus();</span>
<a href="#l5.1002"></a><span id="l5.1002"> }</span>
<a href="#l5.1003"></a><span id="l5.1003"> </span>
<a href="#l5.1004"></a><span id="l5.1004"> function SetMsgAttachmentElementFocus() {</span>
<a href="#l5.1005"></a><span id="l5.1005">   // Caveat: Callers must ensure that attachment pane is visible.</span>
<a href="#l5.1006"></a><span id="l5.1006">   GetMsgAttachmentElement().focus();</span>
<a href="#l5.1007"></a><span id="l5.1007"> }</span>
<a href="#l5.1008"></a><span id="l5.1008"> </span>
<a href="#l5.1009"></a><span id="l5.1009"> /**</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineat">@@ -6883,42 +7068,16 @@ function focusContactsSidebarSearchInput</span>
<a href="#l5.1011"></a><span id="l5.1011"> </span>
<a href="#l5.1012"></a><span id="l5.1012"> function SetMsgBodyFrameFocus() {</span>
<a href="#l5.1013"></a><span id="l5.1013">   // window.content.focus() fails to blur the currently focused element</span>
<a href="#l5.1014"></a><span id="l5.1014">   document.commandDispatcher.advanceFocusIntoSubtree(</span>
<a href="#l5.1015"></a><span id="l5.1015">     document.getElementById(&quot;appcontent&quot;)</span>
<a href="#l5.1016"></a><span id="l5.1016">   );</span>
<a href="#l5.1017"></a><span id="l5.1017"> }</span>
<a href="#l5.1018"></a><span id="l5.1018"> </span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineminus">-function GetMsgAddressingWidgetTreeElement() {</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineminus">-  if (!gMsgAddressingWidgetTreeElement) {</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineminus">-    gMsgAddressingWidgetTreeElement = document.getElementById(</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineminus">-      &quot;addressingWidget&quot;</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineminus">-    );</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineminus">-  }</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineminus">-</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineminus">-  return gMsgAddressingWidgetTreeElement;</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineminus">-}</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineminus">-</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineminus">-function GetMsgIdentityElement() {</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineminus">-  if (!gMsgIdentityElement) {</span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineminus">-    gMsgIdentityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineminus">-  }</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineminus">-</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineminus">-  return gMsgIdentityElement;</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineminus">-}</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineminus">-</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineminus">-function GetMsgSubjectElement() {</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineminus">-  if (!gMsgSubjectElement) {</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineminus">-    gMsgSubjectElement = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineminus">-  }</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineminus">-</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineminus">-  return gMsgSubjectElement;</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineminus">-}</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineminus">-</span>
<a href="#l5.1045"></a><span id="l5.1045"> function GetMsgAttachmentElement() {</span>
<a href="#l5.1046"></a><span id="l5.1046">   if (!gMsgAttachmentElement) {</span>
<a href="#l5.1047"></a><span id="l5.1047">     gMsgAttachmentElement = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l5.1048"></a><span id="l5.1048">   }</span>
<a href="#l5.1049"></a><span id="l5.1049"> </span>
<a href="#l5.1050"></a><span id="l5.1050">   return gMsgAttachmentElement;</span>
<a href="#l5.1051"></a><span id="l5.1051"> }</span>
<a href="#l5.1052"></a><span id="l5.1052"> </span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineat">@@ -6959,72 +7118,69 @@ function GetMsgHeadersToolbarElement() {</span>
<a href="#l5.1054"></a><span id="l5.1054"> /**</span>
<a href="#l5.1055"></a><span id="l5.1055">  * Determine which element of the fast-track focus ring has focus.</span>
<a href="#l5.1056"></a><span id="l5.1056">  * Note that only elements of the fast-track focus ring will be returned.</span>
<a href="#l5.1057"></a><span id="l5.1057">  *</span>
<a href="#l5.1058"></a><span id="l5.1058">  * @return an element node of the fast-track focus ring if the node or one of</span>
<a href="#l5.1059"></a><span id="l5.1059">  *         its descendants has focus, otherwise null.</span>
<a href="#l5.1060"></a><span id="l5.1060">  */</span>
<a href="#l5.1061"></a><span id="l5.1061"> function WhichElementHasFocus() {</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineminus">-  let msgIdentityElement = GetMsgIdentityElement();</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineminus">-  let msgAddressingWidgetTreeElement = GetMsgAddressingWidgetTreeElement();</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineminus">-  let msgSubjectElement = GetMsgSubjectElement();</span>
<a href="#l5.1065"></a><span id="l5.1065">   let msgAttachmentElement = GetMsgAttachmentElement();</span>
<a href="#l5.1066"></a><span id="l5.1066">   let abContactsPanelElement = sidebarDocumentGetElementById(&quot;abContactsPanel&quot;);</span>
<a href="#l5.1067"></a><span id="l5.1067"> </span>
<a href="#l5.1068"></a><span id="l5.1068">   if (top.document.commandDispatcher.focusedWindow == window.content) {</span>
<a href="#l5.1069"></a><span id="l5.1069">     return window.content;</span>
<a href="#l5.1070"></a><span id="l5.1070">   }</span>
<a href="#l5.1071"></a><span id="l5.1071"> </span>
<a href="#l5.1072"></a><span id="l5.1072">   let currentNode = top.document.commandDispatcher.focusedElement;</span>
<a href="#l5.1073"></a><span id="l5.1073">   while (currentNode) {</span>
<a href="#l5.1074"></a><span id="l5.1074">     if (</span>
<a href="#l5.1075"></a><span id="l5.1075" class="difflineminus">-      currentNode == msgIdentityElement ||</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineminus">-      currentNode == msgAddressingWidgetTreeElement ||</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineminus">-      currentNode == msgSubjectElement ||</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+      currentNode == document.getElementById(&quot;msgIdentity&quot;) ||</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineplus">+      currentNode == document.getElementById(&quot;toAddrInput&quot;) ||</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineplus">+      currentNode == document.getElementById(&quot;msgSubject&quot;) ||</span>
<a href="#l5.1081"></a><span id="l5.1081">       currentNode == msgAttachmentElement ||</span>
<a href="#l5.1082"></a><span id="l5.1082">       currentNode == abContactsPanelElement</span>
<a href="#l5.1083"></a><span id="l5.1083">     ) {</span>
<a href="#l5.1084"></a><span id="l5.1084">       return currentNode;</span>
<a href="#l5.1085"></a><span id="l5.1085">     }</span>
<a href="#l5.1086"></a><span id="l5.1086">     currentNode = currentNode.parentNode;</span>
<a href="#l5.1087"></a><span id="l5.1087">   }</span>
<a href="#l5.1088"></a><span id="l5.1088"> </span>
<a href="#l5.1089"></a><span id="l5.1089">   return null;</span>
<a href="#l5.1090"></a><span id="l5.1090"> }</span>
<a href="#l5.1091"></a><span id="l5.1091"> </span>
<a href="#l5.1092"></a><span id="l5.1092"> /**</span>
<a href="#l5.1093"></a><span id="l5.1093">  * Fast-track focus ring: Switch focus between important (not all) elements</span>
<a href="#l5.1094"></a><span id="l5.1094">  * in the message compose window. Ctrl+[Shift+]Tab | [Shift+]F6 on Windows.</span>
<a href="#l5.1095"></a><span id="l5.1095">  *</span>
<a href="#l5.1096"></a><span id="l5.1096">  * The default element to switch to when going in either direction (with or</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineminus">- * without shift key pressed) is the AddressingWidgetTreeElement.</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineplus">+ * without shift key pressed) is the ToRecipientElement.</span>
<a href="#l5.1099"></a><span id="l5.1099">  *</span>
<a href="#l5.1100"></a><span id="l5.1100">  * The only exception is when the MsgHeadersToolbar is collapsed,</span>
<a href="#l5.1101"></a><span id="l5.1101">  * then the focus will always be on the body of the message.</span>
<a href="#l5.1102"></a><span id="l5.1102">  */</span>
<a href="#l5.1103"></a><span id="l5.1103"> function SwitchElementFocus(event) {</span>
<a href="#l5.1104"></a><span id="l5.1104">   let focusedElement = WhichElementHasFocus();</span>
<a href="#l5.1105"></a><span id="l5.1105"> </span>
<a href="#l5.1106"></a><span id="l5.1106">   if (!focusedElement) {</span>
<a href="#l5.1107"></a><span id="l5.1107">     // None of the pre-defined focus ring elements has focus: This should never</span>
<a href="#l5.1108"></a><span id="l5.1108">     // happen with the default installation, but might happen with add-ons.</span>
<a href="#l5.1109"></a><span id="l5.1109">     // In that case, default to focusing the address widget as the first element</span>
<a href="#l5.1110"></a><span id="l5.1110">     // of the focus ring.</span>
<a href="#l5.1111"></a><span id="l5.1111" class="difflineminus">-    SetMsgAddressingWidgetTreeElementFocus();</span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineplus">+    SetMsgToRecipientElementFocus();</span>
<a href="#l5.1113"></a><span id="l5.1113">     return;</span>
<a href="#l5.1114"></a><span id="l5.1114">   }</span>
<a href="#l5.1115"></a><span id="l5.1115"> </span>
<a href="#l5.1116"></a><span id="l5.1116">   if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l5.1117"></a><span id="l5.1117">     // Backwards focus ring: e.g. Ctrl+Shift+Tab | Shift+F6</span>
<a href="#l5.1118"></a><span id="l5.1118">     switch (focusedElement) {</span>
<a href="#l5.1119"></a><span id="l5.1119" class="difflineminus">-      case gMsgAddressingWidgetTreeElement:</span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineplus">+      case document.getElementById(&quot;toAddrInput&quot;):</span>
<a href="#l5.1121"></a><span id="l5.1121">         SetMsgIdentityElementFocus();</span>
<a href="#l5.1122"></a><span id="l5.1122">         break;</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineminus">-      case gMsgIdentityElement:</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineplus">+      case document.getElementById(&quot;msgIdentity&quot;):</span>
<a href="#l5.1125"></a><span id="l5.1125">         // Focus the search input of contacts side bar if that's available,</span>
<a href="#l5.1126"></a><span id="l5.1126">         // otherwise focus message body.</span>
<a href="#l5.1127"></a><span id="l5.1127">         if (sidebar_is_hidden() || !focusContactsSidebarSearchInput()) {</span>
<a href="#l5.1128"></a><span id="l5.1128">           SetMsgBodyFrameFocus();</span>
<a href="#l5.1129"></a><span id="l5.1129">         }</span>
<a href="#l5.1130"></a><span id="l5.1130">         break;</span>
<a href="#l5.1131"></a><span id="l5.1131">       case sidebarDocumentGetElementById(&quot;abContactsPanel&quot;):</span>
<a href="#l5.1132"></a><span id="l5.1132">         SetMsgBodyFrameFocus();</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineat">@@ -7036,27 +7192,27 @@ function SwitchElementFocus(event) {</span>
<a href="#l5.1134"></a><span id="l5.1134">         } else {</span>
<a href="#l5.1135"></a><span id="l5.1135">           SetMsgSubjectElementFocus();</span>
<a href="#l5.1136"></a><span id="l5.1136">         }</span>
<a href="#l5.1137"></a><span id="l5.1137">         break;</span>
<a href="#l5.1138"></a><span id="l5.1138">       case gMsgAttachmentElement:</span>
<a href="#l5.1139"></a><span id="l5.1139">         SetMsgSubjectElementFocus();</span>
<a href="#l5.1140"></a><span id="l5.1140">         break;</span>
<a href="#l5.1141"></a><span id="l5.1141">       default:</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineminus">-        // gMsgSubjectElement</span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineminus">-        SetMsgAddressingWidgetTreeElementFocus();</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineplus">+        // document.getElementById(&quot;msgSubject&quot;)</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineplus">+        SetMsgToRecipientElementFocus();</span>
<a href="#l5.1146"></a><span id="l5.1146">         break;</span>
<a href="#l5.1147"></a><span id="l5.1147">     }</span>
<a href="#l5.1148"></a><span id="l5.1148">   } else {</span>
<a href="#l5.1149"></a><span id="l5.1149">     // Forwards focus ring: e.g. Ctrl+Tab | F6</span>
<a href="#l5.1150"></a><span id="l5.1150">     switch (focusedElement) {</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineminus">-      case gMsgAddressingWidgetTreeElement:</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineplus">+      case document.getElementById(&quot;toAddrInput&quot;):</span>
<a href="#l5.1153"></a><span id="l5.1153">         SetMsgSubjectElementFocus();</span>
<a href="#l5.1154"></a><span id="l5.1154">         break;</span>
<a href="#l5.1155"></a><span id="l5.1155" class="difflineminus">-      case gMsgSubjectElement:</span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineplus">+      case document.getElementById(&quot;msgSubject&quot;):</span>
<a href="#l5.1157"></a><span id="l5.1157">         // Only set focus to the attachment element if it is shown.</span>
<a href="#l5.1158"></a><span id="l5.1158">         if (!document.getElementById(&quot;attachments-box&quot;).collapsed) {</span>
<a href="#l5.1159"></a><span id="l5.1159">           SetMsgAttachmentElementFocus();</span>
<a href="#l5.1160"></a><span id="l5.1160">         } else {</span>
<a href="#l5.1161"></a><span id="l5.1161">           SetMsgBodyFrameFocus();</span>
<a href="#l5.1162"></a><span id="l5.1162">         }</span>
<a href="#l5.1163"></a><span id="l5.1163">         break;</span>
<a href="#l5.1164"></a><span id="l5.1164">       case gMsgAttachmentElement:</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineat">@@ -7068,18 +7224,18 @@ function SwitchElementFocus(event) {</span>
<a href="#l5.1166"></a><span id="l5.1166">         if (sidebar_is_hidden() || !focusContactsSidebarSearchInput()) {</span>
<a href="#l5.1167"></a><span id="l5.1167">           SetMsgIdentityElementFocus();</span>
<a href="#l5.1168"></a><span id="l5.1168">         }</span>
<a href="#l5.1169"></a><span id="l5.1169">         break;</span>
<a href="#l5.1170"></a><span id="l5.1170">       case sidebarDocumentGetElementById(&quot;abContactsPanel&quot;):</span>
<a href="#l5.1171"></a><span id="l5.1171">         SetMsgIdentityElementFocus();</span>
<a href="#l5.1172"></a><span id="l5.1172">         break;</span>
<a href="#l5.1173"></a><span id="l5.1173">       default:</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineminus">-        // gMsgIdentityElement</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineminus">-        SetMsgAddressingWidgetTreeElementFocus();</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineplus">+        // document.getElementById(&quot;msgIdentity&quot;)</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineplus">+        SetMsgToRecipientElementFocus();</span>
<a href="#l5.1178"></a><span id="l5.1178">         break;</span>
<a href="#l5.1179"></a><span id="l5.1179">     }</span>
<a href="#l5.1180"></a><span id="l5.1180">   }</span>
<a href="#l5.1181"></a><span id="l5.1181"> }</span>
<a href="#l5.1182"></a><span id="l5.1182"> </span>
<a href="#l5.1183"></a><span id="l5.1183"> function sidebarCloseButtonOnCommand() {</span>
<a href="#l5.1184"></a><span id="l5.1184">   toggleAddressPicker();</span>
<a href="#l5.1185"></a><span id="l5.1185"> }</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineat">@@ -7163,17 +7319,17 @@ function toggleAddressPicker(aFocus = tr</span>
<a href="#l5.1187"></a><span id="l5.1187">     // Contacts sidebar and then the main window/frame does not respond to accesskeys.</span>
<a href="#l5.1188"></a><span id="l5.1188">     // This may be fixed by bug 570835.</span>
<a href="#l5.1189"></a><span id="l5.1189">     let composerBox = document.getElementById(&quot;headers-parent&quot;);</span>
<a href="#l5.1190"></a><span id="l5.1190">     let focusedElement =</span>
<a href="#l5.1191"></a><span id="l5.1191">       composerBox.querySelector(&quot;:focus&quot;) ||</span>
<a href="#l5.1192"></a><span id="l5.1192">       composerBox.querySelector('[focused=&quot;true&quot;]');</span>
<a href="#l5.1193"></a><span id="l5.1193">     if (focusedElement) {</span>
<a href="#l5.1194"></a><span id="l5.1194">       focusedElement.focus();</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineminus">-    } else if (!GetMsgSubjectElement().value) {</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineplus">+    } else if (!document.getElementById(&quot;msgSubject&quot;).value) {</span>
<a href="#l5.1197"></a><span id="l5.1197">       SetMsgSubjectElementFocus();</span>
<a href="#l5.1198"></a><span id="l5.1198">     } else {</span>
<a href="#l5.1199"></a><span id="l5.1199">       SetMsgBodyFrameFocus();</span>
<a href="#l5.1200"></a><span id="l5.1200">     }</span>
<a href="#l5.1201"></a><span id="l5.1201">   }</span>
<a href="#l5.1202"></a><span id="l5.1202"> }</span>
<a href="#l5.1203"></a><span id="l5.1203"> </span>
<a href="#l5.1204"></a><span id="l5.1204"> // Public method called by addons.</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineat">@@ -7271,21 +7427,19 @@ var gAttachmentNotifier = {</span>
<a href="#l5.1206"></a><span id="l5.1206">       attributes: true,</span>
<a href="#l5.1207"></a><span id="l5.1207">       childList: true,</span>
<a href="#l5.1208"></a><span id="l5.1208">       characterData: true,</span>
<a href="#l5.1209"></a><span id="l5.1209">       subtree: true,</span>
<a href="#l5.1210"></a><span id="l5.1210">     });</span>
<a href="#l5.1211"></a><span id="l5.1211"> </span>
<a href="#l5.1212"></a><span id="l5.1212">     // Add an input event listener for the subject field since there</span>
<a href="#l5.1213"></a><span id="l5.1213">     // are ways of changing its value without key presses.</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineminus">-    GetMsgSubjectElement().addEventListener(</span>
<a href="#l5.1215"></a><span id="l5.1215" class="difflineminus">-      &quot;input&quot;,</span>
<a href="#l5.1216"></a><span id="l5.1216" class="difflineminus">-      this.subjectObserver,</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineminus">-      true</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineminus">-    );</span>
<a href="#l5.1219"></a><span id="l5.1219" class="difflineplus">+    document</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineplus">+      .getElementById(&quot;msgSubject&quot;)</span>
<a href="#l5.1221"></a><span id="l5.1221" class="difflineplus">+      .addEventListener(&quot;input&quot;, this.subjectObserver, true);</span>
<a href="#l5.1222"></a><span id="l5.1222"> </span>
<a href="#l5.1223"></a><span id="l5.1223">     // We could have been opened with a draft message already containing</span>
<a href="#l5.1224"></a><span id="l5.1224">     // some keywords, so run the checker once to pick them up.</span>
<a href="#l5.1225"></a><span id="l5.1225">     this.event.notify();</span>
<a href="#l5.1226"></a><span id="l5.1226">   },</span>
<a href="#l5.1227"></a><span id="l5.1227"> </span>
<a href="#l5.1228"></a><span id="l5.1228">   // Timer based function triggered by the inputEventListener</span>
<a href="#l5.1229"></a><span id="l5.1229">   // for the subject field.</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineat">@@ -7403,17 +7557,17 @@ var gAttachmentNotifier = {</span>
<a href="#l5.1231"></a><span id="l5.1231">     );</span>
<a href="#l5.1232"></a><span id="l5.1232">     let fwdIndex = mailData.indexOf(fwdText);</span>
<a href="#l5.1233"></a><span id="l5.1233">     if (fwdIndex &gt; 0) {</span>
<a href="#l5.1234"></a><span id="l5.1234">       mailData = mailData.substring(0, fwdIndex);</span>
<a href="#l5.1235"></a><span id="l5.1235">     }</span>
<a href="#l5.1236"></a><span id="l5.1236"> </span>
<a href="#l5.1237"></a><span id="l5.1237">     // Prepend the subject to see if the subject contains any attachment</span>
<a href="#l5.1238"></a><span id="l5.1238">     // keywords too, after making sure that the subject has changed.</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineminus">-    let subject = GetMsgSubjectElement().value;</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineplus">+    let subject = document.getElementById(&quot;msgSubject&quot;).value;</span>
<a href="#l5.1241"></a><span id="l5.1241">     if (</span>
<a href="#l5.1242"></a><span id="l5.1242">       subject &amp;&amp;</span>
<a href="#l5.1243"></a><span id="l5.1243">       (gSubjectChanged ||</span>
<a href="#l5.1244"></a><span id="l5.1244">         (gEditingDraft &amp;&amp;</span>
<a href="#l5.1245"></a><span id="l5.1245">           (gComposeType == Ci.nsIMsgCompType.New ||</span>
<a href="#l5.1246"></a><span id="l5.1246">             gComposeType == Ci.nsIMsgCompType.NewsPost ||</span>
<a href="#l5.1247"></a><span id="l5.1247">             gComposeType == Ci.nsIMsgCompType.Draft ||</span>
<a href="#l5.1248"></a><span id="l5.1248">             gComposeType == Ci.nsIMsgCompType.Template ||</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineat">@@ -7487,17 +7641,17 @@ function removeQueryPart(aURL, aQuery) {</span>
<a href="#l5.1250"></a><span id="l5.1250"> function InitEditor() {</span>
<a href="#l5.1251"></a><span id="l5.1251">   var editor = GetCurrentEditor();</span>
<a href="#l5.1252"></a><span id="l5.1252"> </span>
<a href="#l5.1253"></a><span id="l5.1253">   // Set eEditorMailMask flag to avoid using content prefs for spell checker,</span>
<a href="#l5.1254"></a><span id="l5.1254">   // otherwise dictionary setting in preferences is ignored and dictionary is</span>
<a href="#l5.1255"></a><span id="l5.1255">   // inconsistent in subject and message body.</span>
<a href="#l5.1256"></a><span id="l5.1256">   let eEditorMailMask = Ci.nsIPlaintextEditor.eEditorMailMask;</span>
<a href="#l5.1257"></a><span id="l5.1257">   editor.flags |= eEditorMailMask;</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineminus">-  GetMsgSubjectElement().editor.flags |= eEditorMailMask;</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+  document.getElementById(&quot;msgSubject&quot;).editor.flags |= eEditorMailMask;</span>
<a href="#l5.1260"></a><span id="l5.1260"> </span>
<a href="#l5.1261"></a><span id="l5.1261">   // Control insertion of line breaks.</span>
<a href="#l5.1262"></a><span id="l5.1262">   editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(</span>
<a href="#l5.1263"></a><span id="l5.1263">     &quot;editor.CR_creates_new_p&quot;</span>
<a href="#l5.1264"></a><span id="l5.1264">   );</span>
<a href="#l5.1265"></a><span id="l5.1265">   editor.document.execCommand(</span>
<a href="#l5.1266"></a><span id="l5.1266">     &quot;defaultparagraphseparator&quot;,</span>
<a href="#l5.1267"></a><span id="l5.1267">     false,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/compose/content/addressingWidgetOverlay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/compose/content/addressingWidgetOverlay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,1346 +1,781 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l6.5"></a><span id="l6.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> /* import-globals-from MsgComposeCommands.js */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-top.MAX_RECIPIENTS = 1; // For the initial listitem created in the XUL.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-var inputElementType = &quot;&quot;;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-var selectElementType = &quot;&quot;;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-var selectElementIndexTable = null;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-var gNumberOfCols = 0;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+var { MimeParser } = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+var { DisplayNameUtils } = ChromeUtils.import(</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  &quot;resource:///modules/DisplayNameUtils.jsm&quot;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+);</span>
<a href="#l6.25"></a><span id="l6.25"> var gDragService = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;].getService(</span>
<a href="#l6.26"></a><span id="l6.26">   Ci.nsIDragService</span>
<a href="#l6.27"></a><span id="l6.27"> );</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-var test_addresses_sequence = false;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-if (</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  Services.prefs.getPrefType(&quot;mail.debug.test_addresses_sequence&quot;) ==</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  Ci.nsIPrefBranch.PREF_BOOL</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  test_addresses_sequence = Services.prefs.getBoolPref(</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-    &quot;mail.debug.test_addresses_sequence&quot;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  );</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-}</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-function awGetNumberOfCols() {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  if (gNumberOfCols == 0) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    var listCols = listbox.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    gNumberOfCols = listCols.length;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    if (!gNumberOfCols) {</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-      // If no cols defined, that means we have only one!</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-      gNumberOfCols = 1;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    }</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  }</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  return gNumberOfCols;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-}</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-</span>
<a href="#l6.54"></a><span id="l6.54"> /**</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">- * Adjust the default and minimum number of visible recipient rows for addressingWidget</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+ * Convert all the written recipients into string and store them into the</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+ * msgCompFields array to be printed in the message header.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+ *</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+ * @param {Array} msgCompFields - The array containing all the recipients.</span>
<a href="#l6.60"></a><span id="l6.60">  */</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-function awInitializeNumberOfRowsShown() {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  let msgHeadersToolbar = document.getElementById(&quot;MsgHeadersToolbar&quot;);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  let addressingWidget = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-  let awNumRowsShownDefault = Services.prefs.getIntPref(</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    &quot;mail.compose.addresswidget.numRowsShownDefault&quot;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  );</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  // Work around bug 966655: extraHeight 2 pixels for msgHeadersToolbar ensures</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  // visibility of recipient rows per awNumRowsShownDefault and prevents scrollbar</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  // on empty Address Widget, depending on OS screen resolution dpi scaling</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  // (&gt; 100%; thresholds differ).</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  let extraHeight = 2;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  // Set minimum number of rows shown for address widget, per hardwired</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-  // rows=&quot;1&quot; attribute of addressingWidget, to prevent resizing the</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  // subject and format toolbar over the address widget.</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  // This lets users shrink the address widget to one row (with delicate UX)</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  // and thus maximize the space available for composition body,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  // especially on small screens.</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  let toolbarRect = msgHeadersToolbar.getBoundingClientRect();</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  msgHeadersToolbar.minHeight = toolbarRect.height;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  msgHeadersToolbar.height =</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    toolbarRect.height +</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-    addressingWidget.getBoundingClientRect().height *</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-      (awNumRowsShownDefault - 1) +</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-    extraHeight;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  // Update addressingWidget internals.</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-  awCreateOrRemoveDummyRows();</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-}</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-// TODO: replace awGetSelectItemIndex with recipient type index constants</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-function awGetSelectItemIndex(itemData) {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  if (selectElementIndexTable == null) {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    selectElementIndexTable = {};</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-    var selectElem = document.getElementById(&quot;addressCol1#1&quot;);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-    for (var i = 0; i &lt; selectElem.menupopup.children.length; i++) {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-      var aData = selectElem.menupopup.children[i].getAttribute(&quot;value&quot;);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-      selectElementIndexTable[aData] = i;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-    }</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  }</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  return selectElementIndexTable[itemData];</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-}</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-</span>
<a href="#l6.108"></a><span id="l6.108"> function Recipients2CompFields(msgCompFields) {</span>
<a href="#l6.109"></a><span id="l6.109">   if (!msgCompFields) {</span>
<a href="#l6.110"></a><span id="l6.110">     throw new Error(</span>
<a href="#l6.111"></a><span id="l6.111">       &quot;Message Compose Error: msgCompFields is null (ExtractRecipients)&quot;</span>
<a href="#l6.112"></a><span id="l6.112">     );</span>
<a href="#l6.113"></a><span id="l6.113">   }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  var i = 1;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  var addrTo = &quot;&quot;;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  var addrCc = &quot;&quot;;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-  var addrBcc = &quot;&quot;;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-  var addrReply = &quot;&quot;;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  var addrNg = &quot;&quot;;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  var addrFollow = &quot;&quot;;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  var to_Sep = &quot;&quot;;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-  var cc_Sep = &quot;&quot;;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  var bcc_Sep = &quot;&quot;;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-  var reply_Sep = &quot;&quot;;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  var ng_Sep = &quot;&quot;;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-  var follow_Sep = &quot;&quot;;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  let addrTo = &quot;&quot;;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  let addrCc = &quot;&quot;;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+  let addrBcc = &quot;&quot;;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+  let addrReply = &quot;&quot;;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+  let addrNg = &quot;&quot;;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+  let addrFollow = &quot;&quot;;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+  let to_Sep = &quot;&quot;;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+  let cc_Sep = &quot;&quot;;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  let bcc_Sep = &quot;&quot;;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+  let reply_Sep = &quot;&quot;;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+  let ng_Sep = &quot;&quot;;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+  let follow_Sep = &quot;&quot;;</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-  var recipientType;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  var inputField;</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-  var fieldValue;</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-  var recipient;</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-  while ((inputField = awGetInputElement(i))) {</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-    fieldValue = inputField.value;</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-    if (fieldValue != &quot;&quot;) {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-      recipientType = awGetPopupElement(i).value;</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-      recipient = null;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  for (let pill of document.getElementsByTagName(&quot;mail-address-pill&quot;)) {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    let fieldValue = pill.fullAddress;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+    let headerParser = MailServices.headerParser;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+    let recipient = headerParser</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+      .makeFromDisplayAddress(fieldValue)</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+      .map(fullValue =&gt;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+        headerParser.makeMimeAddress(fullValue.name, fullValue.email)</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+      )</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+      .join(&quot;, &quot;);</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-      switch (recipientType) {</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-        case &quot;addr_to&quot;:</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-        case &quot;addr_cc&quot;:</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-        case &quot;addr_bcc&quot;:</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-        case &quot;addr_reply&quot;:</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-          try {</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-            let headerParser = MailServices.headerParser;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-            recipient = headerParser</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-              .makeFromDisplayAddress(fieldValue)</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-              .map(fullValue =&gt;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-                headerParser.makeMimeAddress(fullValue.name, fullValue.email)</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-              )</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-              .join(&quot;, &quot;);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-          } catch (ex) {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-            recipient = fieldValue;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-          }</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-          break;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-      }</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-      switch (recipientType) {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-        case &quot;addr_to&quot;:</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-          addrTo += to_Sep + recipient;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-          to_Sep = &quot;,&quot;;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-          break;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-        case &quot;addr_cc&quot;:</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-          addrCc += cc_Sep + recipient;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-          cc_Sep = &quot;,&quot;;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-          break;</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-        case &quot;addr_bcc&quot;:</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-          addrBcc += bcc_Sep + recipient;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-          bcc_Sep = &quot;,&quot;;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-          break;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-        case &quot;addr_reply&quot;:</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-          addrReply += reply_Sep + recipient;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-          reply_Sep = &quot;,&quot;;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-          break;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-        case &quot;addr_newsgroups&quot;:</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-          addrNg += ng_Sep + fieldValue;</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-          ng_Sep = &quot;,&quot;;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-          break;</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-        case &quot;addr_followup&quot;:</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-          addrFollow += follow_Sep + fieldValue;</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-          follow_Sep = &quot;,&quot;;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-          break;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-        case &quot;addr_other&quot;:</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-          let headerName = awGetPopupElement(i).label;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-          headerName = headerName.substring(0, headerName.indexOf(&quot;:&quot;));</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-          msgCompFields.setRawHeader(headerName, fieldValue, null);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-          break;</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-      }</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+    // Each pill knows from which recipient they were generated</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    // (addr_to, addrs_bcc, etc.).</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+    let recipientType = pill.getAttribute(&quot;recipienttype&quot;);</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    switch (recipientType) {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+      case &quot;addr_to&quot;:</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+        addrTo += to_Sep + recipient;</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+        to_Sep = &quot;,&quot;;</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+        break;</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+      case &quot;addr_cc&quot;:</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+        addrCc += cc_Sep + recipient;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+        cc_Sep = &quot;,&quot;;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+        break;</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+      case &quot;addr_bcc&quot;:</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+        addrBcc += bcc_Sep + recipient;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+        bcc_Sep = &quot;,&quot;;</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+        break;</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+      case &quot;addr_reply&quot;:</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+        addrReply += reply_Sep + recipient;</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+        reply_Sep = &quot;,&quot;;</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+        break;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+      case &quot;addr_newsgroups&quot;:</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+        addrNg += ng_Sep + recipient;</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+        ng_Sep = &quot;,&quot;;</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+        break;</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+      case &quot;addr_followup&quot;:</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+        addrFollow += follow_Sep + recipient;</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+        follow_Sep = &quot;,&quot;;</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+        break;</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+      case &quot;addr_other&quot;:</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+        let label = pill.emailInput.getAttribute(&quot;aria-labelledby&quot;);</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+        msgCompFields.setRawHeader(label, recipient, null);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+        break;</span>
<a href="#l6.242"></a><span id="l6.242">     }</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    i++;</span>
<a href="#l6.244"></a><span id="l6.244">   }</span>
<a href="#l6.245"></a><span id="l6.245"> </span>
<a href="#l6.246"></a><span id="l6.246">   msgCompFields.to = addrTo;</span>
<a href="#l6.247"></a><span id="l6.247">   msgCompFields.cc = addrCc;</span>
<a href="#l6.248"></a><span id="l6.248">   msgCompFields.bcc = addrBcc;</span>
<a href="#l6.249"></a><span id="l6.249">   msgCompFields.replyTo = addrReply;</span>
<a href="#l6.250"></a><span id="l6.250">   msgCompFields.newsgroups = addrNg;</span>
<a href="#l6.251"></a><span id="l6.251">   msgCompFields.followupTo = addrFollow;</span>
<a href="#l6.252"></a><span id="l6.252"> }</span>
<a href="#l6.253"></a><span id="l6.253"> </span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+/**</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+ * Convert all the recipients coming from a message header into pills.</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+ *</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+ * @param {Array} msgCompFields - The array containing all the recipients.</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+ */</span>
<a href="#l6.259"></a><span id="l6.259"> function CompFields2Recipients(msgCompFields) {</span>
<a href="#l6.260"></a><span id="l6.260">   if (msgCompFields) {</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-    let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-    let templateNode = listbox.getItemAtIndex(0);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-    templateNode.remove();</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+    let msgReplyTo = msgCompFields.replyTo</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+      ? MailServices.headerParser.parseEncodedHeader(msgCompFields.replyTo)</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+      : null;</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+    let msgTo = msgCompFields.to</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+      ? MailServices.headerParser.parseEncodedHeader(msgCompFields.to)</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+      : null;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+    let msgCC = msgCompFields.cc</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+      ? MailServices.headerParser.parseEncodedHeader(msgCompFields.cc)</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+      : null;</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+    let msgBCC = msgCompFields.bcc</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+      ? MailServices.headerParser.parseEncodedHeader(msgCompFields.bcc)</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+      : null;</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+    let msgNewsgroups = msgCompFields.newsgroups;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+    let msgFollowupTo = msgCompFields.followupTo</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+      ? MailServices.headerParser.parseEncodedHeader(msgCompFields.followupTo)</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+      : null;</span>
<a href="#l6.280"></a><span id="l6.280"> </span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    top.MAX_RECIPIENTS = 0;</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-    let msgReplyTo = msgCompFields.replyTo;</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    let msgTo = msgCompFields.to;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-    let msgCC = msgCompFields.cc;</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-    let msgBCC = msgCompFields.bcc;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-    let msgNewsgroups = msgCompFields.newsgroups;</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-    let msgFollowupTo = msgCompFields.followupTo;</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-    let havePrimaryRecipient = false;</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    // Populate all the recipients with the proper values.</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    // We need to force the focus() on each input to trigger the attachment</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+    // of the autocomplete mController.</span>
<a href="#l6.292"></a><span id="l6.292">     if (msgReplyTo) {</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-      awSetInputAndPopupFromArray(</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-        msgCompFields.splitRecipients(msgReplyTo, false),</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-        &quot;addr_reply&quot;,</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-        listbox,</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-        templateNode</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-      );</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-    }</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-    if (msgTo) {</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-      let rcp = msgCompFields.splitRecipients(msgTo, false);</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-      if (rcp.length) {</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-        awSetInputAndPopupFromArray(rcp, &quot;addr_to&quot;, listbox, templateNode);</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-        havePrimaryRecipient = true;</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-      }</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+      showAddressRow(document.getElementById(&quot;addr_reply&quot;), &quot;addressRowReply&quot;);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+      let input = document.getElementById(&quot;replyAddrInput&quot;);</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+      input.focus();</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+      input.value = msgReplyTo.join(&quot;, &quot;);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+      recipientAddPill(input, true);</span>
<a href="#l6.311"></a><span id="l6.311">     }</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-    if (msgCC) {</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-      awSetInputAndPopupFromArray(</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-        msgCompFields.splitRecipients(msgCC, false),</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-        &quot;addr_cc&quot;,</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-        listbox,</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-        templateNode</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-      );</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-    }</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-    if (msgBCC) {</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-      awSetInputAndPopupFromArray(</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-        msgCompFields.splitRecipients(msgBCC, false),</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-        &quot;addr_bcc&quot;,</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-        listbox,</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-        templateNode</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-      );</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-    }</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-    if (msgNewsgroups) {</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-      awSetInputAndPopup(</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-        msgNewsgroups,</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-        &quot;addr_newsgroups&quot;,</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-        listbox,</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-        templateNode</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-      );</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-      havePrimaryRecipient = true;</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-    }</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-    if (msgFollowupTo) {</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-      awSetInputAndPopup(msgFollowupTo, &quot;addr_followup&quot;, listbox, templateNode);</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+    if (msgTo) {</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+      let input = document.getElementById(&quot;toAddrInput&quot;);</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+      input.focus();</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+      input.value = msgTo.join(&quot;, &quot;);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+      recipientAddPill(input, true);</span>
<a href="#l6.345"></a><span id="l6.345">     }</span>
<a href="#l6.346"></a><span id="l6.346"> </span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-    // If it's a new message, we need to add an extra empty recipient.</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-    if (!havePrimaryRecipient) {</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-      _awSetInputAndPopup(&quot;&quot;, &quot;addr_to&quot;, listbox, templateNode);</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+    if (msgCC) {</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+      showAddressRow(document.getElementById(&quot;addr_cc&quot;), &quot;addressRowCc&quot;);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+      let input = document.getElementById(&quot;ccAddrInput&quot;);</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+      input.focus();</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+      input.value = msgCC.join(&quot;, &quot;);</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+      recipientAddPill(input, true);</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+    }</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    if (msgBCC) {</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+      showAddressRow(document.getElementById(&quot;addr_bcc&quot;), &quot;addressRowBcc&quot;);</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+      let input = document.getElementById(&quot;bccAddrInput&quot;);</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+      input.focus();</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+      input.value = msgBCC.join(&quot;, &quot;);</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+      recipientAddPill(input, true);</span>
<a href="#l6.364"></a><span id="l6.364">     }</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-    awFitDummyRows(2);</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+    if (msgNewsgroups) {</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+      showAddressRow(</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+        document.getElementById(&quot;addr_newsgroups&quot;),</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+        &quot;addressRowNewsgroups&quot;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+      );</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+      let input = document.getElementById(&quot;newsgroupsAddrInput&quot;);</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+      input.focus();</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+      input.value = msgNewsgroups;</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+      recipientAddPill(input, true);</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+    }</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+    if (msgFollowupTo) {</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+      showAddressRow(</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+        document.getElementById(&quot;addr_followup&quot;),</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+        &quot;addressRowFollowup&quot;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+      );</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+      let input = document.getElementById(&quot;followupAddrInput&quot;);</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+      input.focus();</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+      input.value = msgFollowupTo.join(&quot;, &quot;);</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+      recipientAddPill(input, true);</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+    }</span>
<a href="#l6.388"></a><span id="l6.388"> </span>
<a href="#l6.389"></a><span id="l6.389">     // CompFields2Recipients is called whenever a user replies or edits an existing message. We want to</span>
<a href="#l6.390"></a><span id="l6.390">     // add all of the non-empty recipients for this message to the ignore list for spell check</span>
<a href="#l6.391"></a><span id="l6.391">     let currentAddress = gCurrentIdentity ? gCurrentIdentity.fullAddress : &quot;&quot;;</span>
<a href="#l6.392"></a><span id="l6.392">     addRecipientsToIgnoreList(</span>
<a href="#l6.393"></a><span id="l6.393">       [currentAddress, msgTo, msgCC, msgBCC].filter(adr =&gt; adr).join(&quot;, &quot;)</span>
<a href="#l6.394"></a><span id="l6.394">     );</span>
<a href="#l6.395"></a><span id="l6.395">   }</span>
<a href="#l6.396"></a><span id="l6.396"> }</span>
<a href="#l6.397"></a><span id="l6.397"> </span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-function awSetInputAndPopupId(inputElem, popupElem, rowNumber) {</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-  popupElem.id = &quot;addressCol1#&quot; + rowNumber;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-  inputElem.id = &quot;addressCol2#&quot; + rowNumber;</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-  inputElem.setAttribute(&quot;aria-labelledby&quot;, popupElem.id);</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-  inputElem.popup.addEventListener(&quot;click&quot;, () =&gt; {</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-    awReturnHit(inputElem);</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-  });</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-}</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-</span>
<a href="#l6.407"></a><span id="l6.407"> /**</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">- * Set value of the recipient input field at row rowNumber and set up</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">- * the recipient type menulist.</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+ * Clear a specific recipient row if is visible and pills are present. This is</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+ * commonly used when loading a new identity.</span>
<a href="#l6.412"></a><span id="l6.412">  *</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">- * @param inputElem                 recipient input element</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">- * @param inputValue                recipient value (address)</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">- * @param popupElem                 recipient type menulist element</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">- * @param popupValue</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">- * @param aNotifyRecipientsChanged  Notify that the recipients have changed.</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">- *                                  Generally we notify unless recipients are</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">- *                                  added in batch when the caller takes care</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">- *                                  of the notification.</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+ * @param {Array} msgCompFields - The array containing all the recipient fields.</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+ * @param {string} recipientType - Which recipient needs to be cleared.</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+ * @param {Array} recipientsList - The array containing the old recipients.</span>
<a href="#l6.424"></a><span id="l6.424">  */</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-function awSetInputAndPopupValue(</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-  inputElem,</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-  inputValue,</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-  popupElem,</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-  popupValue,</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-  rowNumber,</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-  aNotifyRecipientsChanged = true</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-) {</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-  inputElem.value = inputValue.trimLeft();</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-  popupElem.selectedItem =</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-    popupElem.menupopup.children[awGetSelectItemIndex(popupValue)];</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-  // TODO: can there be a row without ID yet?</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-  if (rowNumber &gt;= 0) {</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-    awSetInputAndPopupId(inputElem, popupElem, rowNumber);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-  }</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-  _awSetAutoComplete(popupElem, inputElem);</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-  if (aNotifyRecipientsChanged) {</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-    onRecipientsChanged(true);</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-  }</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-}</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-function _awSetInputAndPopup(inputValue, popupValue, parentNode, templateNode) {</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-  top.MAX_RECIPIENTS++;</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-  var newNode = templateNode.cloneNode(true);</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-  parentNode.appendChild(newNode); // we need to insert the new node before we set the value of the select element!</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-  var input = newNode.querySelector(`input[is=&quot;autocomplete-input&quot;]`);</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-  var select = newNode.querySelector(&quot;menulist&quot;);</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-  if (input &amp;&amp; select) {</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-    awSetInputAndPopupValue(</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-      input,</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-      inputValue,</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-      select,</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-      popupValue,</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">-      top.MAX_RECIPIENTS</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-    );</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">-  }</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">-}</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-function awSetInputAndPopup(inputValue, popupValue, parentNode, templateNode) {</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-  if (inputValue &amp;&amp; popupValue) {</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-    var addressArray = inputValue.split(&quot;,&quot;);</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-    for (var index = 0; index &lt; addressArray.length; index++) {</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-      _awSetInputAndPopup(</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-        addressArray[index],</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-        popupValue,</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-        parentNode,</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-        templateNode</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-      );</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-    }</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-  }</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-}</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-function awSetInputAndPopupFromArray(</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-  inputArray,</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-  popupValue,</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-  parentNode,</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-  templateNode</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-) {</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-  if (popupValue) {</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-    for (let recipient of inputArray) {</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">-      _awSetInputAndPopup(recipient, popupValue, parentNode, templateNode);</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-    }</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-  }</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-}</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-</span>
<a href="#l6.497"></a><span id="l6.497"> function awRemoveRecipients(msgCompFields, recipientType, recipientsList) {</span>
<a href="#l6.498"></a><span id="l6.498">   if (!msgCompFields || !recipientsList) {</span>
<a href="#l6.499"></a><span id="l6.499">     return;</span>
<a href="#l6.500"></a><span id="l6.500">   }</span>
<a href="#l6.501"></a><span id="l6.501"> </span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-  var recipientArray = msgCompFields.splitRecipients(recipientsList, false);</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+  let element;</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+  switch (recipientType) {</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+    case &quot;addr_cc&quot;:</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+      element = document.getElementById(&quot;ccAddrInput&quot;);</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+      break;</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+    case &quot;addr_bcc&quot;:</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+      element = document.getElementById(&quot;bccAddrInput&quot;);</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+      break;</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+    case &quot;addr_reply&quot;:</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+      element = document.getElementById(&quot;replyAddrInput&quot;);</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+      break;</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+    case &quot;addr_to&quot;:</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+    default:</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+      element = document.getElementById(&quot;toAddrInput&quot;);</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+      break;</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+  }</span>
<a href="#l6.519"></a><span id="l6.519"> </span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-  for (var index = 0; index &lt; recipientArray.length; index++) {</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-    for (var row = 1; row &lt;= top.MAX_RECIPIENTS; row++) {</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-      var popup = awGetPopupElement(row);</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-      if (popup.value == recipientType) {</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-        var input = awGetInputElement(row);</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-        if (input.value == recipientArray[index]) {</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-          awSetInputAndPopupValue(input, &quot;&quot;, popup, &quot;addr_to&quot;, -1);</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-          break;</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-        }</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-      }</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-    }</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+  let container = element.closest(&quot;.address-container&quot;);</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+  for (let pill of container.querySelectorAll(&quot;mail-address-pill&quot;)) {</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+    pill.remove();</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+  }</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+  // Reset the original input.</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+  let input = container.querySelector(`input[is=&quot;autocomplete-input&quot;]`);</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+  input.value = &quot;&quot;;</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+  if (recipientType != &quot;addr_to&quot;) {</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+    container.classList.add(&quot;hidden&quot;);</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+    document.getElementById(recipientType).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.543"></a><span id="l6.543">   }</span>
<a href="#l6.544"></a><span id="l6.544"> }</span>
<a href="#l6.545"></a><span id="l6.545"> </span>
<a href="#l6.546"></a><span id="l6.546"> /**</span>
<a href="#l6.547"></a><span id="l6.547">  * Adds a batch of new rows matching recipientType and drops in the list of addresses.</span>
<a href="#l6.548"></a><span id="l6.548">  *</span>
<a href="#l6.549"></a><span id="l6.549">  * @param msgCompFields  A nsIMsgCompFields object that is only used as a helper,</span>
<a href="#l6.550"></a><span id="l6.550">  *                       it will not get the addresses appended.</span>
<a href="#l6.551"></a><span id="l6.551">  * @param recipientType  Type of recipient, e.g. &quot;addr_to&quot;.</span>
<a href="#l6.552"></a><span id="l6.552">  * @param recipientList  A string of addresses to add.</span>
<a href="#l6.553"></a><span id="l6.553">  */</span>
<a href="#l6.554"></a><span id="l6.554"> function awAddRecipients(msgCompFields, recipientType, recipientsList) {</span>
<a href="#l6.555"></a><span id="l6.555">   if (!msgCompFields || !recipientsList) {</span>
<a href="#l6.556"></a><span id="l6.556">     return;</span>
<a href="#l6.557"></a><span id="l6.557">   }</span>
<a href="#l6.558"></a><span id="l6.558"> </span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-  var recipientArray = msgCompFields.splitRecipients(recipientsList, false);</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-  awAddRecipientsArray(recipientType, recipientArray);</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineplus">+  awAddRecipientsArray(</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineplus">+    recipientType,</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineplus">+    msgCompFields.splitRecipients(recipientsList, false)</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineplus">+  );</span>
<a href="#l6.565"></a><span id="l6.565"> }</span>
<a href="#l6.566"></a><span id="l6.566"> </span>
<a href="#l6.567"></a><span id="l6.567"> /**</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">- * Adds a batch of new rows matching recipientType and drops in the array of addresses.</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+ * Adds a batch of new recipient pill matching recipientType</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineplus">+ * and drops in the array of addresses.</span>
<a href="#l6.571"></a><span id="l6.571">  *</span>
<a href="#l6.572"></a><span id="l6.572">  * @param aRecipientType  Type of recipient, e.g. &quot;addr_to&quot;.</span>
<a href="#l6.573"></a><span id="l6.573">  * @param aAddressArray   An array of recipient addresses (strings) to add.</span>
<a href="#l6.574"></a><span id="l6.574">  */</span>
<a href="#l6.575"></a><span id="l6.575"> function awAddRecipientsArray(aRecipientType, aAddressArray) {</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-  // Find rows that are empty so that we can fill them.</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-  let emptyRows = [];</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-  for (let row = 1; row &lt;= top.MAX_RECIPIENTS; row++) {</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-    if (awGetInputElement(row).value == &quot;&quot;) {</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-      emptyRows.push(row);</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-    }</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineplus">+  let label = document.getElementById(aRecipientType);</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineplus">+  let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineplus">+    aAddressArray</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineplus">+  );</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineplus">+  let element = document.getElementById(label.getAttribute(&quot;control&quot;));</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineplus">+</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+  if (label &amp;&amp; element.closest(&quot;.address-row&quot;).classList.contains(&quot;hidden&quot;)) {</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineplus">+    label.click();</span>
<a href="#l6.590"></a><span id="l6.590">   }</span>
<a href="#l6.591"></a><span id="l6.591"> </span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-  // Push the new recipients into the found empty rows or append new rows when needed.</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-  let row = 1;</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-  for (let address of aAddressArray) {</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-    if (emptyRows.length &gt; 0) {</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-      row = emptyRows.shift();</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-    } else {</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-      awAppendNewRow(false);</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-      row = top.MAX_RECIPIENTS;</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-    }</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-    awSetInputAndPopupValue(</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-      awGetInputElement(row),</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-      address,</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-      awGetPopupElement(row),</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-      aRecipientType,</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-      row,</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-      false</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-    );</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineplus">+  for (let address of addresses) {</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+    let pill = createRecipientPill(element, address);</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+    element.closest(&quot;.address-container&quot;).insertBefore(pill, element);</span>
<a href="#l6.613"></a><span id="l6.613">   }</span>
<a href="#l6.614"></a><span id="l6.614"> </span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-  // Be sure we still have an empty row left.</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-  if (</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-    emptyRows.length == 0 &amp;&amp;</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-    awGetInputElement(top.MAX_RECIPIENTS).value != &quot;&quot;</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-  ) {</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-    // Insert empty row at the end and focus.</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-    awAppendNewRow(true);</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-    awSetInputAndPopupValue(</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-      awGetInputElement(top.MAX_RECIPIENTS),</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-      &quot;&quot;,</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-      awGetPopupElement(top.MAX_RECIPIENTS),</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-      aRecipientType,</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-      top.MAX_RECIPIENTS,</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-      false</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-    );</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-  } else {</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-    // Focus the next empty row, if any, or the pre-existing empty last row.</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-    row = emptyRows.length &gt; 0 ? emptyRows.shift() : top.MAX_RECIPIENTS;</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-    awSetFocusTo(awGetInputElement(row));</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineplus">+  if (element.id != &quot;replyAddrInput&quot;) {</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineplus">+    onRecipientsChanged();</span>
<a href="#l6.636"></a><span id="l6.636">   }</span>
<a href="#l6.637"></a><span id="l6.637"> </span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-  onRecipientsChanged(true);</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-</span>
<a href="#l6.640"></a><span id="l6.640">   // Add the recipients to our spell check ignore list.</span>
<a href="#l6.641"></a><span id="l6.641">   addRecipientsToIgnoreList(aAddressArray.join(&quot;, &quot;));</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-}</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-/**</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">- * Adds a new row matching recipientType and drops in the single address.</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">- *</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">- * This is mostly used by addons, even though they should use AddRecipient().</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">- *</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">- * @param aRecipientType  Type of recipient, e.g. addr_to.</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">- * @param aAddress        A string with recipient address.</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">- */</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-function awAddRecipient(aRecipientType, aAddress) {</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-  awAddRecipientsArray(aRecipientType, [aAddress]);</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-}</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-function awTestRowSequence() {</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-  /*</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-    This function is for debug and testing purpose only, normal user should not run it!</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-    Every time we insert or delete a row, we must be sure we didn't break the ID sequence of</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-    the addressing widget rows. This function will run a quick test to see if the sequence still ok</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-    You need to define the pref mail.debug.test_addresses_sequence to true in order to activate it</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-  */</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-  if (!test_addresses_sequence) {</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-    return true;</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-  }</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-  // Debug code to verify the sequence is still good.</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-  let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-  let listitems = listbox.itemChildren;</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-  if (listitems.length &gt;= top.MAX_RECIPIENTS) {</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-    for (let i = 1; i &lt;= listitems.length; i++) {</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-      let item = listitems[i - 1];</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-      let inputID = item</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-        .querySelector(`input[is=&quot;autocomplete-input&quot;]`)</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-        .id.split(&quot;#&quot;)[1];</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-      let menulist = item.querySelector(&quot;menulist&quot;);</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-      // In some places like the mailing list dialog there is no menulist,</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-      // and so no popupID that needs to be kept in sequence.</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-      let popupID = menulist &amp;&amp; menulist.id.split(&quot;#&quot;)[1];</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-      if (inputID != i || (popupID &amp;&amp; popupID != i)) {</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-        dump(</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-          `#ERROR: sequence broken at row ${i}, ` +</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-            `inputID=${inputID}, popupID=${popupID}\n`</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-        );</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-        return false;</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-      }</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-      dump(&quot;---SEQUENCE OK---\n&quot;);</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-      return true;</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-    }</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-  } else {</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-    dump(</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-      `#ERROR: listitems.length(${listitems.length}) &lt; ` +</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-        `top.MAX_RECIPIENTS(${top.MAX_RECIPIENTS})\n`</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-    );</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-  }</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-  return false;</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-}</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-function awCleanupRows() {</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-  var maxRecipients = top.MAX_RECIPIENTS;</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-  var rowID = 1;</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineminus">-  for (var row = 1; row &lt;= maxRecipients; row++) {</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineminus">-    var inputElem = awGetInputElement(row);</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineminus">-    if (inputElem.value == &quot;&quot; &amp;&amp; row &lt; maxRecipients) {</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-      awRemoveRow(awGetRowByInputElement(inputElem));</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-    } else {</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-      awSetInputAndPopupId(inputElem, awGetPopupElement(row), rowID);</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-      rowID++;</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-    }</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-  }</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-  awTestRowSequence();</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-}</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-function awDeleteRow(rowToDelete) {</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-  // When we delete a row, we must reset the id of other rows in order to not break the sequence.</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-  var maxRecipients = top.MAX_RECIPIENTS;</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-  awRemoveRow(rowToDelete);</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-  // assume 2 column update (input and popup)</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-  for (var row = rowToDelete + 1; row &lt;= maxRecipients; row++) {</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-    awSetInputAndPopupId(</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-      awGetInputElement(row),</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-      awGetPopupElement(row),</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-      row - 1</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">-    );</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">-  }</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">-</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineminus">-  awTestRowSequence();</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineminus">-}</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineminus">-</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">-function awClickEmptySpace(target, setFocus) {</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">-  if (</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-    document.getElementById(&quot;addressCol2#1&quot;).disabled ||</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-    target == null ||</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-    target.localName != &quot;hbox&quot;</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-  ) {</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineminus">-    return;</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineminus">-  }</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-  let lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineminus">-</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-  if (lastInput &amp;&amp; lastInput.value) {</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-    awAppendNewRow(setFocus);</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineminus">-  } else if (setFocus) {</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineminus">-    awSetFocusTo(lastInput);</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineminus">-  }</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-}</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">-</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-function awReturnHit(inputElement) {</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-  let row = awGetRowByInputElement(inputElement);</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineminus">-  let nextInput = awGetInputElement(row + 1);</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineminus">-</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-  if (!nextInput) {</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">-    if (inputElement.value) {</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">-      awAppendNewRow(true);</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">-    } else {</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-      // No address entered, switch to Subject field</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-      let subjectField = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-      subjectField.select();</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-      subjectField.focus();</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-    }</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-  } else {</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-    nextInput.select();</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-    awSetFocusTo(nextInput);</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-  }</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">-  // be sure to add the user add recipient to our ignore list</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineminus">-  // when the user hits enter in an autocomplete widget...</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">-  addRecipientsToIgnoreList(inputElement.value);</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineminus">-}</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">-</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">-function awDeleteAddressOnClick(deleteAddressElement) {</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">-  awDeleteHit(</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">-    deleteAddressElement.parentNode.parentNode.querySelector(</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-      &quot;.textbox-addressingWidget&quot;</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-    ),</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-    true</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-  );</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-}</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-/**</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">- * Delete recipient row (addressingWidgetItem) from UI.</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">- *</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">- * @param {&lt;html:input&gt;} inputElement  the recipient input element</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineminus">- *                                     (textbox-addressingWidget) whose parent</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineminus">- *                                     row (addressingWidgetItem) will be deleted.</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineminus">- * @param {boolean} deleteForward  true: focus next row after deleting the row</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">- *                                 false: focus previous row after deleting the row</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineminus">- */</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineminus">-function awDeleteHit(inputElement, deleteForward = false) {</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-  let row = awGetRowByInputElement(inputElement);</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineminus">-</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineminus">-  // Don't delete the row if it's the last one remaining; just reset it.</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineminus">-  if (top.MAX_RECIPIENTS &lt;= 1) {</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineminus">-    inputElement.value = &quot;&quot;;</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-    return;</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-  }</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-  // Set the focus to the input field of the next/previous row according to</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-  // the direction of deleting if possible.</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-  // Note: awSetFocusTo() is asynchronous, i.e. we'll focus after row removal.</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-  if (</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-    (!deleteForward &amp;&amp; row &gt; 1) ||</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-    (deleteForward &amp;&amp; row == top.MAX_RECIPIENTS)</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-  ) {</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-    // We're deleting backwards, but not the first row,</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineminus">-    // or forwards on the last row: Focus previous row.</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineminus">-    awSetFocusTo(awGetInputElement(row - 1));</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineminus">-  } else {</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-    // We're deleting forwards, but not the last row,</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-    // or backwards on the first row: Focus next row.</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineminus">-    awSetFocusTo(awGetInputElement(row + 1));</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineminus">-  }</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineminus">-</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineminus">-  // Delete the row.</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineminus">-  awDeleteRow(row);</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineminus">-}</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineminus">-</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-// If we add a menulist to the DOM, it has some child nodes added to it</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-// by the menulist custom element. If we then clone the menulist and add</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineminus">-// it to the DOM again, more child nodes are added and we end up with</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineminus">-// bug 1525828. This function clones any menulist as it originally was.</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-function _menulistFriendlyClone(element) {</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-  let clone = element.cloneNode(false);</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-  if (element.localName == &quot;menulist&quot;) {</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-    clone.appendChild(element.menupopup.cloneNode(true));</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-    return clone;</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-  }</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-  for (let child of element.children) {</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-    clone.appendChild(_menulistFriendlyClone(child));</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-  }</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-  return clone;</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineminus">-}</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineminus">-</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineminus">-function awAppendNewRow(setFocus) {</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineminus">-  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineminus">-  var listitem1 = awGetListItem(1);</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineminus">-</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-  if (listbox &amp;&amp; listitem1) {</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-    var lastRecipientType = awGetPopupElement(top.MAX_RECIPIENTS).value;</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineminus">-</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-    var nextDummy = awGetNextDummyRow();</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineminus">-    var newNode = _menulistFriendlyClone(listitem1);</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineminus">-    if (nextDummy) {</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-      listbox.replaceChild(newNode, nextDummy);</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-    } else {</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-      listbox.appendChild(newNode);</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-    }</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-    top.MAX_RECIPIENTS++;</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-    var input = newNode.querySelector(`input[is=&quot;autocomplete-input&quot;]`);</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineminus">-    if (input) {</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-      input.value = &quot;&quot;;</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineminus">-</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineminus">-      // Reset autocomplete attribute &quot;nomatch&quot; so we don't cause red addresses</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-      // on a cloned row.</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-      input.removeAttribute(&quot;nomatch&quot;);</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineminus">-    }</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineminus">-    var select = newNode.querySelector(&quot;menulist&quot;);</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineminus">-    if (select) {</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineminus">-      // It only makes sense to clone some field types; others</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-      // should not be cloned, since it just makes the user have</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-      // to go to the trouble of selecting something else. In such</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-      // cases let's default to 'To' (a reasonable default since</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-      // we already default to 'To' on the first dummy field of</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-      // a new message).</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">-      switch (lastRecipientType) {</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-        case &quot;addr_reply&quot;:</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-        case &quot;addr_other&quot;:</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-          select.selectedIndex = awGetSelectItemIndex(&quot;addr_to&quot;);</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-          break;</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-        case &quot;addr_followup&quot;:</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineminus">-          select.selectedIndex = awGetSelectItemIndex(&quot;addr_newsgroups&quot;);</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-          break;</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-        default:</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-          // e.g. &quot;addr_to&quot;,&quot;addr_cc&quot;,&quot;addr_bcc&quot;,&quot;addr_newsgroups&quot;:</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineminus">-          select.selectedIndex = awGetSelectItemIndex(lastRecipientType);</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineminus">-      }</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineminus">-</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineminus">-      awSetInputAndPopupId(input, select, top.MAX_RECIPIENTS);</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineminus">-</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineminus">-      if (input) {</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineminus">-        _awSetAutoComplete(select, input);</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-      }</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-    }</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineminus">-    // Focus the new input widget</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineminus">-    if (setFocus &amp;&amp; input) {</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-      awSetFocusTo(input);</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineminus">-    }</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-  }</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-}</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-// functions for accessing the elements in the addressing widget</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineminus">-/**</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">- * Returns the recipient type popup for a row.</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">- *</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineminus">- * @param row  Index of the recipient row to return. Starts at 1.</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineminus">- * @return     This returns the menulist (not its child menupopup), despite the function name.</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">- */</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">-function awGetPopupElement(row) {</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineminus">-  return document.getElementById(&quot;addressCol1#&quot; + row);</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-}</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-/**</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">- * Returns the recipient inputbox for a row.</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">- *</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">- * @param row  Index of the recipient row to return. Starts at 1.</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">- * @return     This returns the input element.</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">- */</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-function awGetInputElement(row) {</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-  return document.getElementById(&quot;addressCol2#&quot; + row);</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-}</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-function awGetElementByCol(row, col) {</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-  var colID = &quot;addressCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-  return document.getElementById(colID);</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-}</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-function awGetListItem(row) {</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-  if (listbox &amp;&amp; row &gt; 0) {</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-    return listbox.getItemAtIndex(row - 1);</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-  }</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineminus">-</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineminus">-  return null;</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-}</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-/**</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">- * @param inputElement  The recipient input element.</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineminus">- * @return              The row index (starting from 1) where the input element</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">- *                      is found. 0 if the element is not found.</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">- */</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">-function awGetRowByInputElement(inputElement) {</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-  if (!inputElement) {</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">-    return 0;</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineminus">-  }</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">-</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">-  var listitem = inputElement.parentNode.parentNode;</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">-  return (</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">-    document.getElementById(&quot;addressingWidget&quot;).getIndexOfItem(listitem) + 1</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineminus">-  );</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-}</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineminus">-// Copy Node - copy this node and insert ahead of the (before) node.  Append to end if before=0</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-function awCopyNode(node, parentNode, beforeNode) {</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-  var newNode = node.cloneNode(true);</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-  if (beforeNode) {</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-    parentNode.insertBefore(newNode, beforeNode);</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-  } else {</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-    parentNode.appendChild(newNode);</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-  }</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">-</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-  return newNode;</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-}</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-function awRemoveRow(row) {</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">-  awGetListItem(row).remove();</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-  awFitDummyRows();</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-  top.MAX_RECIPIENTS--;</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-}</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-/**</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">- * Set focus to the specified element, typically a recipient input element.</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">- * We do this asynchronously to allow other processes like adding or removing rows</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">- * to complete before shifting focus.</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">- *</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">- * @param element  the element to receive focus asynchronously</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">- */</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-function awSetFocusTo(element) {</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-  // Remember the (input) element to focus for asynchronous focusing, so that we</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-  // play safe if this gets called again and the original element gets removed</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-  // before we can focus it.</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-  top.awInputToFocus = element;</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-  setTimeout(_awSetFocusTo, 0);</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-}</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-function _awSetFocusTo() {</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineminus">-  top.awInputToFocus.focus();</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineminus">-}</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-// Deprecated - use awSetFocusTo() instead.</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-// ### TODO: This function should be removed if we're sure addons aren't using it.</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-function awSetFocus(row, inputElement) {</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-  awSetFocusTo(inputElement);</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-}</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineminus">-function awGetNumberOfRecipients() {</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-  return top.MAX_RECIPIENTS;</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineplus">+  calculateHeaderHeight();</span>
<a href="#l6.1002"></a><span id="l6.1002"> }</span>
<a href="#l6.1003"></a><span id="l6.1003"> </span>
<a href="#l6.1004"></a><span id="l6.1004"> function DragOverAddressingWidget(event) {</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-  var validFlavor = false;</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-  var dragSession = (dragSession = gDragService.getCurrentSession());</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineplus">+  let dragSession = (dragSession = gDragService.getCurrentSession());</span>
<a href="#l6.1008"></a><span id="l6.1008"> </span>
<a href="#l6.1009"></a><span id="l6.1009">   if (dragSession.isDataFlavorSupported(&quot;text/x-moz-address&quot;)) {</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-    validFlavor = true;</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-  }</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineminus">-</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-  if (validFlavor) {</span>
<a href="#l6.1014"></a><span id="l6.1014">     dragSession.canDrop = true;</span>
<a href="#l6.1015"></a><span id="l6.1015">   }</span>
<a href="#l6.1016"></a><span id="l6.1016"> }</span>
<a href="#l6.1017"></a><span id="l6.1017"> </span>
<a href="#l6.1018"></a><span id="l6.1018"> function DropOnAddressingWidget(event) {</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-  var dragSession = gDragService.getCurrentSession();</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineplus">+  let dragSession = gDragService.getCurrentSession();</span>
<a href="#l6.1021"></a><span id="l6.1021"> </span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-  var trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineplus">+  let trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(</span>
<a href="#l6.1024"></a><span id="l6.1024">     Ci.nsITransferable</span>
<a href="#l6.1025"></a><span id="l6.1025">   );</span>
<a href="#l6.1026"></a><span id="l6.1026">   trans.init(getLoadContext());</span>
<a href="#l6.1027"></a><span id="l6.1027">   trans.addDataFlavor(&quot;text/x-moz-address&quot;);</span>
<a href="#l6.1028"></a><span id="l6.1028"> </span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-  for (var i = 0; i &lt; dragSession.numDropItems; ++i) {</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineplus">+  for (let i = 0; i &lt; dragSession.numDropItems; ++i) {</span>
<a href="#l6.1031"></a><span id="l6.1031">     dragSession.getData(trans, i);</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-    var dataObj = {};</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-    var bestFlavor = {};</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineplus">+    let dataObj = {};</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineplus">+    let bestFlavor = {};</span>
<a href="#l6.1036"></a><span id="l6.1036">     trans.getAnyTransferData(bestFlavor, dataObj);</span>
<a href="#l6.1037"></a><span id="l6.1037">     if (dataObj) {</span>
<a href="#l6.1038"></a><span id="l6.1038">       dataObj = dataObj.value.QueryInterface(Ci.nsISupportsString);</span>
<a href="#l6.1039"></a><span id="l6.1039">     }</span>
<a href="#l6.1040"></a><span id="l6.1040">     if (!dataObj) {</span>
<a href="#l6.1041"></a><span id="l6.1041">       continue;</span>
<a href="#l6.1042"></a><span id="l6.1042">     }</span>
<a href="#l6.1043"></a><span id="l6.1043"> </span>
<a href="#l6.1044"></a><span id="l6.1044">     // pull the address out of the data object</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-    var address = dataObj.data.substring(0, dataObj.length);</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineplus">+    let address = dataObj.data.substring(0, dataObj.length);</span>
<a href="#l6.1047"></a><span id="l6.1047">     if (!address) {</span>
<a href="#l6.1048"></a><span id="l6.1048">       continue;</span>
<a href="#l6.1049"></a><span id="l6.1049">     }</span>
<a href="#l6.1050"></a><span id="l6.1050"> </span>
<a href="#l6.1051"></a><span id="l6.1051">     DropRecipient(event.target, address);</span>
<a href="#l6.1052"></a><span id="l6.1052">   }</span>
<a href="#l6.1053"></a><span id="l6.1053"> }</span>
<a href="#l6.1054"></a><span id="l6.1054"> </span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineplus">+/**</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineplus">+ * Find the autocomplete input when an address is dropped in the compose header.</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineplus">+ *</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineplus">+ * @param {XULElement} target - The element where an address was dropped.</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineplus">+ * @param {string} recipient - The email address dragged by the user.</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineplus">+ */</span>
<a href="#l6.1061"></a><span id="l6.1061"> function DropRecipient(target, recipient) {</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-  // break down and add each address</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineminus">-  return parseAndAddAddresses(</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-    recipient,</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-    awGetPopupElement(top.MAX_RECIPIENTS).value</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-  );</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-}</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-function _awSetAutoComplete(selectElem, inputElem) {</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-  let params = JSON.parse(inputElem.getAttribute(&quot;autocompletesearchparam&quot;));</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-  params.type = selectElem.value;</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-  inputElem.setAttribute(&quot;autocompletesearchparam&quot;, JSON.stringify(params));</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-}</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineplus">+  let input;</span>
<a href="#l6.1075"></a><span id="l6.1075"> </span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-function awSetAutoComplete(rowNumber) {</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-  var inputElem = awGetInputElement(rowNumber);</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-  var selectElem = awGetPopupElement(rowNumber);</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-  _awSetAutoComplete(selectElem, inputElem);</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-}</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-function awRecipientOnFocus(inputElement) {</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-  inputElement.select();</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-}</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineplus">+  if (target.tagName == &quot;label&quot; &amp;&amp; target.hasAttribute(&quot;control&quot;)) {</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineplus">+    input = document.getElementById(target.getAttribute(&quot;control&quot;));</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineplus">+  } else {</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineplus">+    let container = target.classList.contains(&quot;address-row&quot;)</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineplus">+      ? target</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineplus">+      : target.closest(&quot;hbox.address-row&quot;);</span>
<a href="#l6.1091"></a><span id="l6.1091"> </span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-/**</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">- * Handles keypress events for the email address inputs (that auto-fill)</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">- * in the Address Book Mailing List dialogs. When a comma-separated list of</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">- * addresses is entered on one row, split them into one address per row. Only</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">- * add a new blank row on &quot;Enter&quot; key. On &quot;Tab&quot; key focus moves to the &quot;Cancel&quot;</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">- * button.</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">- *</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">- * @param {KeyboardEvent} event  The DOM keypress event.</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineminus">- * @param {Element} element      The element that triggered the keypress event.</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineminus">- */</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineminus">-function awAbRecipientKeyPress(event, element) {</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-  if (event.key != &quot;Enter&quot; &amp;&amp; event.key != &quot;Tab&quot;) {</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineplus">+    if (!container) {</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineplus">+      return;</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineplus">+    }</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineplus">+    input = container.querySelector(</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineplus">+      `.address-container &gt; input[is=&quot;autocomplete-input&quot;]`</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineplus">+    );</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineplus">+  }</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineplus">+</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineplus">+  if (!input || !input.hasAttribute(&quot;is&quot;)) {</span>
<a href="#l6.1113"></a><span id="l6.1113">     return;</span>
<a href="#l6.1114"></a><span id="l6.1114">   }</span>
<a href="#l6.1115"></a><span id="l6.1115"> </span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-  if (!element.value) {</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-    if (event.key == &quot;Enter&quot;) {</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-      awReturnHit(element);</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-    }</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-  } else {</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineminus">-    let inputElement = element;</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineminus">-    let originalRow = awGetRowByInputElement(element);</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineminus">-    let row;</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineminus">-    let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineminus">-      element.value</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineminus">-    );</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineplus">+  let recipientType =</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineplus">+    input.getAttribute(&quot;recipienttype&quot;) != &quot;addr_other&quot;</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineplus">+      ? input.getAttribute(&quot;recipienttype&quot;)</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineplus">+      : input.getAttribute(&quot;aria-labelledby&quot;);</span>
<a href="#l6.1131"></a><span id="l6.1131"> </span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-    if (addresses.length &gt; 1) {</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineminus">-      // Collect any existing addresses from the following rows so we don't</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-      // simply overwrite them.</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-      row = originalRow + 1;</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-      inputElement = awGetInputElement(row);</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineminus">-      while (inputElement) {</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineminus">-        if (inputElement.value) {</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-          addresses.push(inputElement.value);</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-          inputElement.value = &quot;&quot;;</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-        }</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineminus">-        row += 1;</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineminus">-        inputElement = awGetInputElement(row);</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineminus">-      }</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineminus">-    }</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineplus">+  awAddRecipientsArray(recipientType, [recipient]);</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineplus">+}</span>
<a href="#l6.1149"></a><span id="l6.1149"> </span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineminus">-    // Insert the addresses, adding new rows if needed.</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">-    row = originalRow;</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineminus">-    let needNewRows = false;</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineminus">-</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineminus">-    for (let address of addresses) {</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineminus">-      if (needNewRows) {</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineminus">-        inputElement = awAppendNewRow(false);</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineminus">-      } else {</span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineminus">-        inputElement = awGetInputElement(row);</span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">-        if (!inputElement) {</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">-          needNewRows = true;</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">-          inputElement = awAppendNewRow(false);</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineminus">-        }</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineminus">-      }</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineplus">+function awSizerListen() {</span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineplus">+  // when splitter is clicked, fill in necessary dummy rows each time</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineplus">+  // the mouse is moved.</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineplus">+  document.addEventListener(&quot;mousemove&quot;, awSizerMouseMove, true);</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineplus">+  document.addEventListener(&quot;mouseup&quot;, awSizerMouseUp, {</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineplus">+    capture: false,</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineplus">+    once: true,</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineplus">+  });</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineplus">+}</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineplus">+// Add the overflow scroll attribute to the recipients container.</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineplus">+function awSizerMouseMove() {</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineplus">+  document.getElementById(&quot;recipientsContainer&quot;).classList.add(&quot;overflow&quot;);</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineplus">+}</span>
<a href="#l6.1177"></a><span id="l6.1177"> </span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineminus">-      if (inputElement) {</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineminus">-        inputElement.value = address;</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-      }</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineminus">-      row += 1;</span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineminus">-    }</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineplus">+function awSizerMouseUp() {</span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineplus">+  document.removeEventListener(&quot;mousemove&quot;, awSizerMouseMove, true);</span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineplus">+}</span>
<a href="#l6.1186"></a><span id="l6.1186"> </span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineminus">-    if (event.key == &quot;Enter&quot;) {</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineminus">-      // Prevent the dialog from closing. &quot;Enter&quot; inserted a new row instead.</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineminus">-      event.preventDefault();</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineminus">-      awReturnHit(inputElement);</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineminus">-    } else if (event.key == &quot;Tab&quot;) {</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineminus">-      // Focus the last row to let &quot;Tab&quot; move focus to the &quot;Cancel&quot; button.</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-      let lastRow = row - 1;</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineminus">-      awGetInputElement(lastRow).focus();</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineminus">-    }</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineminus">-  }</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineplus">+// Returns the load context for the current window</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineplus">+function getLoadContext() {</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineplus">+  return window.docShell.QueryInterface(Ci.nsILoadContext);</span>
<a href="#l6.1200"></a><span id="l6.1200"> }</span>
<a href="#l6.1201"></a><span id="l6.1201"> </span>
<a href="#l6.1202"></a><span id="l6.1202"> /**</span>
<a href="#l6.1203"></a><span id="l6.1203">  * Handles keypress events for the email address inputs (that auto-fill)</span>
<a href="#l6.1204"></a><span id="l6.1204">  * in the Message Compose window.</span>
<a href="#l6.1205"></a><span id="l6.1205">  *</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineminus">- * @param event       The DOM keypress event</span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineminus">- * @param element     The element that triggered the keypress event</span>
<a href="#l6.1208"></a><span id="l6.1208" class="difflineplus">+ * @param {Event} event - The DOM keypress event.</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineplus">+ * @param {HTMLElement} element - The element that triggered the keypress event.</span>
<a href="#l6.1210"></a><span id="l6.1210">  */</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineminus">-function awRecipientKeyPress(event, element) {</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineplus">+function recipientKeyPress(event, element) {</span>
<a href="#l6.1213"></a><span id="l6.1213">   switch (event.key) {</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineplus">+    case &quot;a&quot;:</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineplus">+      // Select all the pills if the input is empty.</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineplus">+      if ((event.ctrlKey || event.metaKey) &amp;&amp; !element.value.trim()) {</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineplus">+        selectRecipientPills(element);</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineplus">+      }</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineplus">+      break;</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineplus">+    case &quot;,&quot;:</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineplus">+      event.preventDefault();</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineplus">+      element.handleEnter(event);</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineplus">+      break;</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineplus">+    case &quot;Home&quot;:</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineplus">+    case &quot;End&quot;:</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineplus">+    case &quot;ArrowLeft&quot;:</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineplus">+    case &quot;Backspace&quot;:</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineplus">+      if (!element.value.trim() &amp;&amp; !event.repeat) {</span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineplus">+        let pills = element</span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineplus">+          .closest(&quot;.address-container&quot;)</span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineplus">+          .querySelectorAll(&quot;mail-address-pill&quot;);</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineplus">+        if (pills.length) {</span>
<a href="#l6.1233"></a><span id="l6.1233" class="difflineplus">+          let key = event.key == &quot;Home&quot; ? 0 : pills.length - 1;</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineplus">+          pills[key].focus();</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineplus">+          pills[key].checkKeyboardSelected(event, pills[key]);</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineplus">+        }</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineplus">+      }</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineplus">+      break;</span>
<a href="#l6.1239"></a><span id="l6.1239">     case &quot;Enter&quot;:</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineplus">+      // No address entered, move focus to Subject field.</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineplus">+      if (!element.value.trim()) {</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineplus">+        document.getElementById(&quot;msgSubject&quot;).focus();</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineplus">+        return;</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineplus">+      }</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineplus">+      break;</span>
<a href="#l6.1246"></a><span id="l6.1246">     case &quot;Tab&quot;:</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineminus">-      // If the recipient input text contains a comma (we also convert pasted</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineminus">-      // line feeds into commas), check if multiple recipients and add them</span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineminus">-      // accordingly. Handle semicolons too.</span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineminus">-      if (element.value.includes(&quot;,&quot;) || element.value.includes(&quot;;&quot;)) {</span>
<a href="#l6.1251"></a><span id="l6.1251" class="difflineminus">-        let addresses = element.value;</span>
<a href="#l6.1252"></a><span id="l6.1252" class="difflineminus">-        element.value = &quot;&quot;; // Clear out the current line so we don't try to autocomplete it.</span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineminus">-        parseAndAddAddresses(</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineminus">-          addresses,</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineminus">-          awGetPopupElement(awGetRowByInputElement(element)).value</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineminus">-        );</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineminus">-      } else if (event.key == &quot;Tab&quot;) {</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-        // Single recipient added via Tab key:</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineminus">-        // Add the recipient to our spellcheck ignore list.</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineminus">-        // For Enter key, this is done in awReturnHit().</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineminus">-        addRecipientsToIgnoreList(element.value);</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineminus">-      } else if (event.key == &quot;Enter&quot;) {</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineminus">-        awReturnHit(element);</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineplus">+      // Trigger the autocomplete controller only if we have a value</span>
<a href="#l6.1265"></a><span id="l6.1265" class="difflineplus">+      // to prevent interfering with the natural change of focus on Tab.</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineplus">+      if (element.value.trim()) {</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineplus">+        event.preventDefault();</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineplus">+        element.handleEnter(event);</span>
<a href="#l6.1269"></a><span id="l6.1269">       }</span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineplus">+      break;</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineplus">+  }</span>
<a href="#l6.1272"></a><span id="l6.1272"> </span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineminus">-      break;</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineplus">+  // Don't alter the field size if any arrow key is triggered.</span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineplus">+  if ([37, 38, 39, 40].includes(event.keyCode)) {</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineplus">+    return;</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineplus">+  }</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineplus">+</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineplus">+  let size = parseInt(element.getAttribute(&quot;size&quot;));</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineplus">+  // Change the min size of the input field on typing.</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineplus">+  if (event.key == &quot;Backspace&quot; &amp;&amp; size &gt; 1) {</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineplus">+    element.setAttribute(&quot;size&quot;, size - 1);</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineplus">+  } else {</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineplus">+    element.setAttribute(&quot;size&quot;, size + 1);</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineplus">+  }</span>
<a href="#l6.1286"></a><span id="l6.1286" class="difflineplus">+}</span>
<a href="#l6.1287"></a><span id="l6.1287" class="difflineplus">+</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineplus">+/**</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineplus">+ * Add a new &quot;address-pill&quot; to the parent recipient container.</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineplus">+ *</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineplus">+ * @param {HTMLElement} element - The element that triggered the keypress event.</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineplus">+ * @param {boolean} [automatic=false] - Set to true if the change of recipients</span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineplus">+ *   was invoked programmatically and should not be considered a change of</span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineplus">+ *   message content.</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineplus">+ */</span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineplus">+function recipientAddPill(element, automatic = false) {</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineplus">+  if (!element.value.trim()) {</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineplus">+    return;</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineplus">+  }</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineplus">+</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineplus">+  let parent = document.getElementById(</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineplus">+    element.closest(&quot;.address-container&quot;).id</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineplus">+  );</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineplus">+  let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineplus">+    element.value</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineplus">+  );</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineplus">+</span>
<a href="#l6.1308"></a><span id="l6.1308" class="difflineplus">+  for (let address of addresses) {</span>
<a href="#l6.1309"></a><span id="l6.1309" class="difflineplus">+    let pill = createRecipientPill(element, address);</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineplus">+    parent.insertBefore(pill, element);</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineplus">+</span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineplus">+    // Be sure to add the user add recipient to our ignore list</span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineplus">+    // when the user hits enter in an autocomplete widget...</span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineplus">+    addRecipientsToIgnoreList(element.value);</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineplus">+  }</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineplus">+</span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineplus">+  // Reset the input element.</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineplus">+  element.removeAttribute(&quot;nomatch&quot;);</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineplus">+  element.setAttribute(&quot;size&quot;, 1);</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineplus">+  element.value = &quot;&quot;;</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineplus">+</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineplus">+  // We need to detach the autocomplete Controller to prevent the input</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineplus">+  // to be filled with the previously selected address when the &quot;blur&quot; event</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineplus">+  // gets triggered.</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineplus">+  element.detachController();</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineplus">+  // Attach it again to enable autocomplete.</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineplus">+  element.attachController();</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineplus">+</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineplus">+  onRecipientsChanged(automatic);</span>
<a href="#l6.1330"></a><span id="l6.1330" class="difflineplus">+  calculateHeaderHeight();</span>
<a href="#l6.1331"></a><span id="l6.1331" class="difflineplus">+}</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineplus">+</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineplus">+/**</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineplus">+ * Create a new recipient pill.</span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineplus">+ *</span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineplus">+ * @param {HTMLElement} element - The original autocomplete input that generated</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineplus">+ *   the pill.</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineplus">+ * @param {Array} address - The array containing the recipient's info.</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineplus">+ * @returns {XULElement} The newly created pill element.</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineplus">+ */</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineplus">+function createRecipientPill(element, address) {</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineplus">+  let pill = document.createXULElement(&quot;mail-address-pill&quot;);</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineplus">+</span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineplus">+  pill.originalInput = element;</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineplus">+  pill.label = address.toString();</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineplus">+  pill.emailAddress = address.email || &quot;&quot;;</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineplus">+  pill.fullAddress = address.toString();</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineplus">+  pill.displayName = address.name || &quot;&quot;;</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineplus">+  pill.setAttribute(&quot;recipienttype&quot;, element.getAttribute(&quot;recipienttype&quot;));</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineplus">+</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineplus">+  let listNames = MimeParser.parseHeaderField(</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineplus">+    address.toString(),</span>
<a href="#l6.1353"></a><span id="l6.1353" class="difflineplus">+    MimeParser.HEADER_ADDRESS</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineplus">+  );</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineplus">+  let isMailingList =</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineplus">+    listNames.length &gt; 0 &amp;&amp;</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineplus">+    MailServices.ab.mailListNameExists(listNames[0].name);</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineplus">+  let isNewsgroup = element.classList.contains(&quot;nntp-input&quot;);</span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineplus">+</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineplus">+  pill.classList.toggle(</span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineplus">+    &quot;error&quot;,</span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineplus">+    !isValidAddress(address.email) &amp;&amp; !isMailingList &amp;&amp; !isNewsgroup</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineplus">+  );</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineplus">+</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineplus">+  let emailCard = DisplayNameUtils.getCardForEmail(address.email);</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineplus">+  pill.classList.toggle(</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineplus">+    &quot;warning&quot;,</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineplus">+    isValidAddress(address.email) &amp;&amp;</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineplus">+      !emailCard.card &amp;&amp;</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineplus">+      !isMailingList &amp;&amp;</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineplus">+      !isNewsgroup</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineplus">+  );</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineplus">+</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineplus">+  return pill;</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineplus">+}</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineplus">+</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineplus">+/**</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineplus">+ * Force a focused styling on the recipient container of the currently</span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineplus">+ * selected input element.</span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineplus">+ *</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineplus">+ * @param {HTMLElement} element - The element receving focus.</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineplus">+ */</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineplus">+function highlightAddressContainer(element) {</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineplus">+  element.closest(&quot;.address-container&quot;).setAttribute(&quot;focused&quot;, &quot;true&quot;);</span>
<a href="#l6.1385"></a><span id="l6.1385" class="difflineplus">+  deselectAllPills();</span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineplus">+}</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineplus">+</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineplus">+/**</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineplus">+ * Deselect any previously selected pills.</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineplus">+ */</span>
<a href="#l6.1391"></a><span id="l6.1391" class="difflineplus">+function deselectAllPills() {</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineplus">+  for (let pill of document.querySelectorAll(`mail-address-pill[selected]`)) {</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineplus">+    pill.removeAttribute(&quot;selected&quot;);</span>
<a href="#l6.1394"></a><span id="l6.1394">   }</span>
<a href="#l6.1395"></a><span id="l6.1395"> }</span>
<a href="#l6.1396"></a><span id="l6.1396"> </span>
<a href="#l6.1397"></a><span id="l6.1397"> /**</span>
<a href="#l6.1398"></a><span id="l6.1398" class="difflineminus">- * Handle keydown event on a recipient input.</span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineminus">- * Enables recipient row deletion with DEL or BACKSPACE and</span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineminus">- * recipient list navigation with cursor up/down.</span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineplus">+ * Remove the focused styling from the recipient container and create</span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineplus">+ * address pills if valid recipients were written.</span>
<a href="#l6.1403"></a><span id="l6.1403">  *</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineminus">- * Note that the keydown event fires for ALL keys, so this may affect</span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineminus">- * autocomplete as user enters a recipient text.</span>
<a href="#l6.1406"></a><span id="l6.1406" class="difflineplus">+ * @param {HTMLElement} element - The element losing focus.</span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineplus">+ */</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineplus">+function resetAddressContainer(element) {</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineplus">+  let address = element.value.trim();</span>
<a href="#l6.1410"></a><span id="l6.1410" class="difflineplus">+  let listNames = MimeParser.parseHeaderField(</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineplus">+    address,</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineplus">+    MimeParser.HEADER_ADDRESS</span>
<a href="#l6.1413"></a><span id="l6.1413" class="difflineplus">+  );</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineplus">+  let isMailingList =</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineplus">+    listNames.length &gt; 0 &amp;&amp;</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineplus">+    MailServices.ab.mailListNameExists(listNames[0].name);</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineplus">+</span>
<a href="#l6.1418"></a><span id="l6.1418" class="difflineplus">+  if (</span>
<a href="#l6.1419"></a><span id="l6.1419" class="difflineplus">+    address &amp;&amp;</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineplus">+    (isValidAddress(address) ||</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineplus">+      isMailingList ||</span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineplus">+      element.classList.contains(&quot;nntp-input&quot;))</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineplus">+  ) {</span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineplus">+    recipientAddPill(element);</span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineplus">+  }</span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineplus">+</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineplus">+  // Reset the input size if no pill was created.</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineplus">+  if (!address) {</span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineplus">+    element.setAttribute(&quot;size&quot;, 1);</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineplus">+  }</span>
<a href="#l6.1431"></a><span id="l6.1431" class="difflineplus">+  element.closest(&quot;.address-container&quot;).removeAttribute(&quot;focused&quot;);</span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineplus">+}</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineplus">+</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineplus">+/**</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineplus">+ * Trigger the startEditing() method of the mail-address-pill element.</span>
<a href="#l6.1436"></a><span id="l6.1436">  *</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineminus">- * @param {keydown event} event  the keydown event fired on a recipient input</span>
<a href="#l6.1438"></a><span id="l6.1438" class="difflineminus">- * @param {&lt;html:input&gt;} inputElement  the recipient input element</span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineminus">- *                                     on which the event fired (textbox-addressingWidget)</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineplus">+ * @param {XULlement} element - The element from which the context menu was</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineplus">+ *   opened.</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineplus">+ * @param {Event} event - The DOM event.</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineplus">+ */</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineplus">+function editAddressPill(element, event) {</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineplus">+  element.closest(&quot;mail-address-pill&quot;).startEditing(event);</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineplus">+}</span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineplus">+</span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineplus">+/**</span>
<a href="#l6.1449"></a><span id="l6.1449" class="difflineplus">+ * Copy the selected pills email address.</span>
<a href="#l6.1450"></a><span id="l6.1450" class="difflineplus">+ *</span>
<a href="#l6.1451"></a><span id="l6.1451" class="difflineplus">+ * @param {XULElement} element - The element from which the context menu was</span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineplus">+ *   opened.</span>
<a href="#l6.1453"></a><span id="l6.1453">  */</span>
<a href="#l6.1454"></a><span id="l6.1454" class="difflineminus">-function awRecipientKeyDown(event, inputElement) {</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineminus">-  switch (event.key) {</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineminus">-    // Enable deletion of empty recipient rows.</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineminus">-    case &quot;Delete&quot;:</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineminus">-    case &quot;Backspace&quot;:</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineminus">-      if (inputElement.textLength == 1 &amp;&amp; event.repeat) {</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineminus">-        // User is holding down Delete or Backspace to delete recipient text</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineminus">-        // inline and is now deleting the last character: Set flag to</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineminus">-        // temporarily block row deletion.</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineminus">-        top.awRecipientInlineDelete = true;</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineminus">-      }</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineminus">-      if (!inputElement.value &amp;&amp; !event.altKey) {</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">-        // When user presses DEL or BACKSPACE on an empty row, and it's not an</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineminus">-        // ongoing inline deletion, and not ALT+BACKSPACE for input undo,</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineminus">-        // we delete the row.</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineminus">-        if (top.awRecipientInlineDelete &amp;&amp; !event.repeat) {</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineminus">-          // User has released and re-pressed Delete or Backspace key</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineminus">-          // after holding them down to delete recipient text inline:</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineminus">-          // unblock row deletion.</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineminus">-          top.awRecipientInlineDelete = false;</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineminus">-        }</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineminus">-        if (!top.awRecipientInlineDelete) {</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineminus">-          let deleteForward = event.key == &quot;Delete&quot;;</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineminus">-          awDeleteHit(inputElement, deleteForward);</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineminus">-        }</span>
<a href="#l6.1479"></a><span id="l6.1479" class="difflineminus">-      }</span>
<a href="#l6.1480"></a><span id="l6.1480" class="difflineminus">-      break;</span>
<a href="#l6.1481"></a><span id="l6.1481" class="difflineplus">+function copyEmailNewsAddress(element) {</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineplus">+  let allAddresses = [];</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineplus">+  for (let pill of getAllSelectedPills(element.closest(&quot;mail-address-pill&quot;))) {</span>
<a href="#l6.1484"></a><span id="l6.1484" class="difflineplus">+    allAddresses.push(pill.fullAddress);</span>
<a href="#l6.1485"></a><span id="l6.1485" class="difflineplus">+  }</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineplus">+</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineplus">+  let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;].getService(</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineplus">+    Ci.nsIClipboardHelper</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineplus">+  );</span>
<a href="#l6.1490"></a><span id="l6.1490" class="difflineplus">+  clipboard.copyString(allAddresses.join(&quot;, &quot;));</span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineplus">+}</span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineplus">+</span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineplus">+/**</span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineplus">+ * Cut the selected pills email address.</span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineplus">+ *</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineplus">+ * @param {XULElement} element - The element from which the context menu was</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineplus">+ *   opened.</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineplus">+ */</span>
<a href="#l6.1499"></a><span id="l6.1499" class="difflineplus">+function cutEmailNewsAddress(element) {</span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineplus">+  copyEmailNewsAddress(element);</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineplus">+  deleteAddressPill(element);</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineplus">+}</span>
<a href="#l6.1503"></a><span id="l6.1503"> </span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineminus">-    // Enable browsing the list of recipients up and down with cursor keys.</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineminus">-    case &quot;ArrowDown&quot;:</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineminus">-    case &quot;ArrowUp&quot;:</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineminus">-      // Only browse recipients if the autocomplete popup is not open.</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineminus">-      if (!inputElement.popupOpen) {</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-        let row = awGetRowByInputElement(inputElement);</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineminus">-        let down = event.key == &quot;ArrowDown&quot;;</span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineminus">-        let noEdgeRow = down ? row &lt; top.MAX_RECIPIENTS : row &gt; 1;</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineminus">-        if (noEdgeRow) {</span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineminus">-          let targetRow = down ? row + 1 : row - 1;</span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineminus">-          awSetFocusTo(awGetInputElement(targetRow));</span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineminus">-        }</span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineminus">-      }</span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineminus">-      break;</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineplus">+/**</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineplus">+ * Delete the selected pill/pills.</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineplus">+ *</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineplus">+ * @param {XULElement} element - The element from which the context menu was</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineplus">+ *   opened.</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineplus">+ */</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineplus">+function deleteAddressPill(element) {</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineplus">+  let firstPill = element.closest(&quot;mail-address-pill&quot;);</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineplus">+</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineplus">+  // We need to store the input location before removing the pills.</span>
<a href="#l6.1528"></a><span id="l6.1528" class="difflineplus">+  let input = firstPill</span>
<a href="#l6.1529"></a><span id="l6.1529" class="difflineplus">+    .closest(&quot;.address-container&quot;)</span>
<a href="#l6.1530"></a><span id="l6.1530" class="difflineplus">+    .querySelector(`input[is=&quot;autocomplete-input&quot;][recipienttype]`);</span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineplus">+</span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineplus">+  for (let pill of getAllSelectedPills(firstPill)) {</span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineplus">+    pill.remove();</span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineplus">+  }</span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineplus">+</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineplus">+  input.focus();</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineplus">+  onRecipientsChanged();</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineplus">+}</span>
<a href="#l6.1539"></a><span id="l6.1539" class="difflineplus">+</span>
<a href="#l6.1540"></a><span id="l6.1540" class="difflineplus">+/**</span>
<a href="#l6.1541"></a><span id="l6.1541" class="difflineplus">+ * Handle the keypress event on the labels to show the container row</span>
<a href="#l6.1542"></a><span id="l6.1542" class="difflineplus">+ * of an hidden recipient (Cc, Bcc, etc.).</span>
<a href="#l6.1543"></a><span id="l6.1543" class="difflineplus">+ *</span>
<a href="#l6.1544"></a><span id="l6.1544" class="difflineplus">+ * @param {Event} event - The DOM keypress event.</span>
<a href="#l6.1545"></a><span id="l6.1545" class="difflineplus">+ * @param {XULelement} label - The clicked label to hide.</span>
<a href="#l6.1546"></a><span id="l6.1546" class="difflineplus">+ * @param {string} rowID - The ID of the container to reveal.</span>
<a href="#l6.1547"></a><span id="l6.1547" class="difflineplus">+ */</span>
<a href="#l6.1548"></a><span id="l6.1548" class="difflineplus">+function showAddressRowKeyPress(event, label, rowID) {</span>
<a href="#l6.1549"></a><span id="l6.1549" class="difflineplus">+  if (event.key == &quot;Enter&quot;) {</span>
<a href="#l6.1550"></a><span id="l6.1550" class="difflineplus">+    showAddressRow(label, rowID);</span>
<a href="#l6.1551"></a><span id="l6.1551">   }</span>
<a href="#l6.1552"></a><span id="l6.1552"> }</span>
<a href="#l6.1553"></a><span id="l6.1553"> </span>
<a href="#l6.1554"></a><span id="l6.1554" class="difflineminus">-/* ::::::::::: addressing widget dummy rows ::::::::::::::::: */</span>
<a href="#l6.1555"></a><span id="l6.1555" class="difflineplus">+/**</span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineplus">+ * Show the container row of an hidden recipient (Cc, Bcc, etc.).</span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineplus">+ *</span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineplus">+ * @param {XULelement} label - The clicked label to hide.</span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineplus">+ * @param {string} rowID - The ID of the container to reveal.</span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineplus">+ */</span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineplus">+function showAddressRow(label, rowID) {</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineplus">+  let container = document.getElementById(rowID);</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineplus">+  let input = container.querySelector(`input[is=&quot;autocomplete-input&quot;]`);</span>
<a href="#l6.1564"></a><span id="l6.1564"> </span>
<a href="#l6.1565"></a><span id="l6.1565" class="difflineminus">-var gAWContentHeight = 0;</span>
<a href="#l6.1566"></a><span id="l6.1566" class="difflineminus">-var gAWRowHeight = 0;</span>
<a href="#l6.1567"></a><span id="l6.1567" class="difflineminus">-</span>
<a href="#l6.1568"></a><span id="l6.1568" class="difflineminus">-function awFitDummyRows() {</span>
<a href="#l6.1569"></a><span id="l6.1569" class="difflineminus">-  awCalcContentHeight();</span>
<a href="#l6.1570"></a><span id="l6.1570" class="difflineminus">-  awCreateOrRemoveDummyRows();</span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineplus">+  container.classList.remove(&quot;hidden&quot;);</span>
<a href="#l6.1572"></a><span id="l6.1572" class="difflineplus">+  label.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l6.1573"></a><span id="l6.1573" class="difflineplus">+  input.focus();</span>
<a href="#l6.1574"></a><span id="l6.1574"> }</span>
<a href="#l6.1575"></a><span id="l6.1575"> </span>
<a href="#l6.1576"></a><span id="l6.1576" class="difflineminus">-function awCreateOrRemoveDummyRows() {</span>
<a href="#l6.1577"></a><span id="l6.1577" class="difflineminus">-  let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.1578"></a><span id="l6.1578" class="difflineminus">-  let listboxHeight = listbox.getBoundingClientRect().height;</span>
<a href="#l6.1579"></a><span id="l6.1579" class="difflineplus">+/**</span>
<a href="#l6.1580"></a><span id="l6.1580" class="difflineplus">+ * Hide the container row of a recipient (Cc, Bcc, etc.).</span>
<a href="#l6.1581"></a><span id="l6.1581" class="difflineplus">+ * The container can't be hidden if previously typed addresses are listed.</span>
<a href="#l6.1582"></a><span id="l6.1582" class="difflineplus">+ *</span>
<a href="#l6.1583"></a><span id="l6.1583" class="difflineplus">+ * @param {XULelement} element - The clicked label.</span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineplus">+ * @param {string} labelID - The ID of the label to show.</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineplus">+ */</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineplus">+function hideAddressRow(element, labelID) {</span>
<a href="#l6.1587"></a><span id="l6.1587" class="difflineplus">+  let container = element.closest(&quot;.address-row&quot;);</span>
<a href="#l6.1588"></a><span id="l6.1588" class="difflineplus">+  let fieldName = container.querySelector(&quot;.address-label-container &gt; label&quot;);</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineplus">+  let confirmTitle = getComposeBundle().getFormattedString(</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineplus">+    &quot;confirmRemoveRecipientRowTitle&quot;,</span>
<a href="#l6.1591"></a><span id="l6.1591" class="difflineplus">+    [fieldName.value]</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineplus">+  );</span>
<a href="#l6.1593"></a><span id="l6.1593" class="difflineplus">+  let confirmBody = getComposeBundle().getFormattedString(</span>
<a href="#l6.1594"></a><span id="l6.1594" class="difflineplus">+    &quot;confirmRemoveRecipientRowBody&quot;,</span>
<a href="#l6.1595"></a><span id="l6.1595" class="difflineplus">+    [fieldName.value]</span>
<a href="#l6.1596"></a><span id="l6.1596" class="difflineplus">+  );</span>
<a href="#l6.1597"></a><span id="l6.1597"> </span>
<a href="#l6.1598"></a><span id="l6.1598" class="difflineminus">-  // remove rows to remove scrollbar</span>
<a href="#l6.1599"></a><span id="l6.1599" class="difflineminus">-  let kids = listbox.querySelectorAll(&quot;[_isDummyRow]&quot;);</span>
<a href="#l6.1600"></a><span id="l6.1600" class="difflineminus">-  for (</span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineminus">-    let i = kids.length - 1;</span>
<a href="#l6.1602"></a><span id="l6.1602" class="difflineminus">-    gAWContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0;</span>
<a href="#l6.1603"></a><span id="l6.1603" class="difflineminus">-    --i</span>
<a href="#l6.1604"></a><span id="l6.1604" class="difflineplus">+  let pills = container.querySelectorAll(&quot;mail-address-pill&quot;);</span>
<a href="#l6.1605"></a><span id="l6.1605" class="difflineplus">+  // Ask the user to confirm the removal of all the typed addresses.</span>
<a href="#l6.1606"></a><span id="l6.1606" class="difflineplus">+  if (</span>
<a href="#l6.1607"></a><span id="l6.1607" class="difflineplus">+    pills.length &amp;&amp;</span>
<a href="#l6.1608"></a><span id="l6.1608" class="difflineplus">+    !Services.prompt.confirm(null, confirmTitle, confirmBody)</span>
<a href="#l6.1609"></a><span id="l6.1609">   ) {</span>
<a href="#l6.1610"></a><span id="l6.1610" class="difflineminus">-    gAWContentHeight -= gAWRowHeight;</span>
<a href="#l6.1611"></a><span id="l6.1611" class="difflineminus">-    kids[i].remove();</span>
<a href="#l6.1612"></a><span id="l6.1612" class="difflineplus">+    return;</span>
<a href="#l6.1613"></a><span id="l6.1613">   }</span>
<a href="#l6.1614"></a><span id="l6.1614"> </span>
<a href="#l6.1615"></a><span id="l6.1615" class="difflineminus">-  // add rows to fill space</span>
<a href="#l6.1616"></a><span id="l6.1616" class="difflineminus">-  if (gAWRowHeight) {</span>
<a href="#l6.1617"></a><span id="l6.1617" class="difflineminus">-    while (gAWContentHeight + gAWRowHeight &lt; listboxHeight) {</span>
<a href="#l6.1618"></a><span id="l6.1618" class="difflineminus">-      awCreateDummyItem(listbox);</span>
<a href="#l6.1619"></a><span id="l6.1619" class="difflineminus">-      gAWContentHeight += gAWRowHeight;</span>
<a href="#l6.1620"></a><span id="l6.1620" class="difflineplus">+  for (let pill of pills) {</span>
<a href="#l6.1621"></a><span id="l6.1621" class="difflineplus">+    pill.remove();</span>
<a href="#l6.1622"></a><span id="l6.1622" class="difflineplus">+  }</span>
<a href="#l6.1623"></a><span id="l6.1623" class="difflineplus">+</span>
<a href="#l6.1624"></a><span id="l6.1624" class="difflineplus">+  // Reset the original input.</span>
<a href="#l6.1625"></a><span id="l6.1625" class="difflineplus">+  let input = container.querySelector(`input[is=&quot;autocomplete-input&quot;]`);</span>
<a href="#l6.1626"></a><span id="l6.1626" class="difflineplus">+  input.value = &quot;&quot;;</span>
<a href="#l6.1627"></a><span id="l6.1627" class="difflineplus">+</span>
<a href="#l6.1628"></a><span id="l6.1628" class="difflineplus">+  container.classList.add(&quot;hidden&quot;);</span>
<a href="#l6.1629"></a><span id="l6.1629" class="difflineplus">+  document.getElementById(labelID).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.1630"></a><span id="l6.1630" class="difflineplus">+</span>
<a href="#l6.1631"></a><span id="l6.1631" class="difflineplus">+  onRecipientsChanged();</span>
<a href="#l6.1632"></a><span id="l6.1632" class="difflineplus">+}</span>
<a href="#l6.1633"></a><span id="l6.1633" class="difflineplus">+</span>
<a href="#l6.1634"></a><span id="l6.1634" class="difflineplus">+/**</span>
<a href="#l6.1635"></a><span id="l6.1635" class="difflineplus">+ * Calculate the height of the composer header area every time a pill is created.</span>
<a href="#l6.1636"></a><span id="l6.1636" class="difflineplus">+ * If the height is bigger than 2/3 of the compose window heigh, enable overflow.</span>
<a href="#l6.1637"></a><span id="l6.1637" class="difflineplus">+ */</span>
<a href="#l6.1638"></a><span id="l6.1638" class="difflineplus">+function calculateHeaderHeight() {</span>
<a href="#l6.1639"></a><span id="l6.1639" class="difflineplus">+  let container = document.getElementById(&quot;msgheaderstoolbar-box&quot;);</span>
<a href="#l6.1640"></a><span id="l6.1640" class="difflineplus">+  if (container.classList.contains(&quot;overflow&quot;)) {</span>
<a href="#l6.1641"></a><span id="l6.1641" class="difflineplus">+    return;</span>
<a href="#l6.1642"></a><span id="l6.1642" class="difflineplus">+  }</span>
<a href="#l6.1643"></a><span id="l6.1643" class="difflineplus">+</span>
<a href="#l6.1644"></a><span id="l6.1644" class="difflineplus">+  if (container.clientHeight &gt;= window.outerHeight * 0.7) {</span>
<a href="#l6.1645"></a><span id="l6.1645" class="difflineplus">+    document.getElementById(&quot;recipientsContainer&quot;).classList.add(&quot;overflow&quot;);</span>
<a href="#l6.1646"></a><span id="l6.1646" class="difflineplus">+</span>
<a href="#l6.1647"></a><span id="l6.1647" class="difflineplus">+    let header = document.getElementById(&quot;headers-box&quot;);</span>
<a href="#l6.1648"></a><span id="l6.1648" class="difflineplus">+    if (!header.hasAttribute(&quot;height&quot;)) {</span>
<a href="#l6.1649"></a><span id="l6.1649" class="difflineplus">+      header.setAttribute(&quot;height&quot;, 300);</span>
<a href="#l6.1650"></a><span id="l6.1650">     }</span>
<a href="#l6.1651"></a><span id="l6.1651">   }</span>
<a href="#l6.1652"></a><span id="l6.1652"> }</span>
<a href="#l6.1653"></a><span id="l6.1653"> </span>
<a href="#l6.1654"></a><span id="l6.1654" class="difflineminus">-function awCalcContentHeight() {</span>
<a href="#l6.1655"></a><span id="l6.1655" class="difflineminus">-  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.1656"></a><span id="l6.1656" class="difflineminus">-  var items = listbox.itemChildren;</span>
<a href="#l6.1657"></a><span id="l6.1657" class="difflineminus">-</span>
<a href="#l6.1658"></a><span id="l6.1658" class="difflineminus">-  gAWContentHeight = 0;</span>
<a href="#l6.1659"></a><span id="l6.1659" class="difflineminus">-  if (items.length &gt; 0) {</span>
<a href="#l6.1660"></a><span id="l6.1660" class="difflineminus">-    // all rows are forced to a uniform height in xul listboxes, so</span>
<a href="#l6.1661"></a><span id="l6.1661" class="difflineminus">-    // find the first listitem with a boxObject and use it as precedent</span>
<a href="#l6.1662"></a><span id="l6.1662" class="difflineminus">-    var i = 0;</span>
<a href="#l6.1663"></a><span id="l6.1663" class="difflineminus">-    do {</span>
<a href="#l6.1664"></a><span id="l6.1664" class="difflineminus">-      gAWRowHeight = items[i].getBoundingClientRect().height;</span>
<a href="#l6.1665"></a><span id="l6.1665" class="difflineminus">-      ++i;</span>
<a href="#l6.1666"></a><span id="l6.1666" class="difflineminus">-    } while (i &lt; items.length &amp;&amp; !gAWRowHeight);</span>
<a href="#l6.1667"></a><span id="l6.1667" class="difflineminus">-    gAWContentHeight = gAWRowHeight * items.length;</span>
<a href="#l6.1668"></a><span id="l6.1668" class="difflineminus">-  }</span>
<a href="#l6.1669"></a><span id="l6.1669" class="difflineminus">-}</span>
<a href="#l6.1670"></a><span id="l6.1670" class="difflineminus">-</span>
<a href="#l6.1671"></a><span id="l6.1671" class="difflineminus">-function awCreateDummyItem(aParent) {</span>
<a href="#l6.1672"></a><span id="l6.1672" class="difflineminus">-  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l6.1673"></a><span id="l6.1673" class="difflineminus">-  var item = listbox.getItemAtIndex(0);</span>
<a href="#l6.1674"></a><span id="l6.1674" class="difflineminus">-</span>
<a href="#l6.1675"></a><span id="l6.1675" class="difflineminus">-  var titem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l6.1676"></a><span id="l6.1676" class="difflineminus">-  titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l6.1677"></a><span id="l6.1677" class="difflineminus">-  titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l6.1678"></a><span id="l6.1678" class="difflineminus">-  titem.style.height = item.getBoundingClientRect().height + &quot;px&quot;;</span>
<a href="#l6.1679"></a><span id="l6.1679" class="difflineminus">-</span>
<a href="#l6.1680"></a><span id="l6.1680" class="difflineminus">-  for (let i = 0; i &lt; awGetNumberOfCols(); i++) {</span>
<a href="#l6.1681"></a><span id="l6.1681" class="difflineminus">-    let cell = awCreateDummyCell(titem);</span>
<a href="#l6.1682"></a><span id="l6.1682" class="difflineminus">-    if (item.children[i].hasAttribute(&quot;style&quot;)) {</span>
<a href="#l6.1683"></a><span id="l6.1683" class="difflineminus">-      cell.setAttribute(&quot;style&quot;, item.children[i].getAttribute(&quot;style&quot;));</span>
<a href="#l6.1684"></a><span id="l6.1684" class="difflineminus">-    }</span>
<a href="#l6.1685"></a><span id="l6.1685" class="difflineminus">-    if (item.children[i].hasAttribute(&quot;flex&quot;)) {</span>
<a href="#l6.1686"></a><span id="l6.1686" class="difflineminus">-      cell.setAttribute(&quot;flex&quot;, item.children[i].getAttribute(&quot;flex&quot;));</span>
<a href="#l6.1687"></a><span id="l6.1687" class="difflineminus">-    }</span>
<a href="#l6.1688"></a><span id="l6.1688" class="difflineminus">-  }</span>
<a href="#l6.1689"></a><span id="l6.1689" class="difflineminus">-</span>
<a href="#l6.1690"></a><span id="l6.1690" class="difflineminus">-  if (aParent) {</span>
<a href="#l6.1691"></a><span id="l6.1691" class="difflineminus">-    aParent.appendChild(titem);</span>
<a href="#l6.1692"></a><span id="l6.1692" class="difflineminus">-  }</span>
<a href="#l6.1693"></a><span id="l6.1693" class="difflineminus">-</span>
<a href="#l6.1694"></a><span id="l6.1694" class="difflineminus">-  return titem;</span>
<a href="#l6.1695"></a><span id="l6.1695" class="difflineminus">-}</span>
<a href="#l6.1696"></a><span id="l6.1696" class="difflineminus">-</span>
<a href="#l6.1697"></a><span id="l6.1697" class="difflineminus">-function awCreateDummyCell(aParent) {</span>
<a href="#l6.1698"></a><span id="l6.1698" class="difflineminus">-  var cell = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l6.1699"></a><span id="l6.1699" class="difflineminus">-  cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l6.1700"></a><span id="l6.1700" class="difflineminus">-  if (aParent) {</span>
<a href="#l6.1701"></a><span id="l6.1701" class="difflineminus">-    aParent.appendChild(cell);</span>
<a href="#l6.1702"></a><span id="l6.1702" class="difflineminus">-  }</span>
<a href="#l6.1703"></a><span id="l6.1703" class="difflineminus">-</span>
<a href="#l6.1704"></a><span id="l6.1704" class="difflineminus">-  return cell;</span>
<a href="#l6.1705"></a><span id="l6.1705" class="difflineminus">-}</span>
<a href="#l6.1706"></a><span id="l6.1706" class="difflineminus">-</span>
<a href="#l6.1707"></a><span id="l6.1707" class="difflineminus">-function awGetNextDummyRow() {</span>
<a href="#l6.1708"></a><span id="l6.1708" class="difflineminus">-  // gets the next row from the top down</span>
<a href="#l6.1709"></a><span id="l6.1709" class="difflineminus">-  return document.querySelector(&quot;#addressingWidget &gt; [_isDummyRow]&quot;);</span>
<a href="#l6.1710"></a><span id="l6.1710" class="difflineminus">-}</span>
<a href="#l6.1711"></a><span id="l6.1711" class="difflineminus">-</span>
<a href="#l6.1712"></a><span id="l6.1712" class="difflineminus">-function awSizerListen() {</span>
<a href="#l6.1713"></a><span id="l6.1713" class="difflineminus">-  // when splitter is clicked, fill in necessary dummy rows each time the mouse is moved</span>
<a href="#l6.1714"></a><span id="l6.1714" class="difflineminus">-  awCalcContentHeight(); // precalculate</span>
<a href="#l6.1715"></a><span id="l6.1715" class="difflineminus">-  document.addEventListener(&quot;mousemove&quot;, awSizerMouseMove, true);</span>
<a href="#l6.1716"></a><span id="l6.1716" class="difflineminus">-  document.addEventListener(&quot;mouseup&quot;, awSizerMouseUp, {</span>
<a href="#l6.1717"></a><span id="l6.1717" class="difflineminus">-    capture: false,</span>
<a href="#l6.1718"></a><span id="l6.1718" class="difflineminus">-    once: true,</span>
<a href="#l6.1719"></a><span id="l6.1719" class="difflineminus">-  });</span>
<a href="#l6.1720"></a><span id="l6.1720" class="difflineminus">-}</span>
<a href="#l6.1721"></a><span id="l6.1721" class="difflineminus">-</span>
<a href="#l6.1722"></a><span id="l6.1722" class="difflineminus">-function awSizerMouseMove() {</span>
<a href="#l6.1723"></a><span id="l6.1723" class="difflineminus">-  awCreateOrRemoveDummyRows(2);</span>
<a href="#l6.1724"></a><span id="l6.1724" class="difflineminus">-}</span>
<a href="#l6.1725"></a><span id="l6.1725" class="difflineminus">-</span>
<a href="#l6.1726"></a><span id="l6.1726" class="difflineminus">-function awSizerMouseUp() {</span>
<a href="#l6.1727"></a><span id="l6.1727" class="difflineminus">-  document.removeEventListener(&quot;mousemove&quot;, awSizerMouseMove, true);</span>
<a href="#l6.1728"></a><span id="l6.1728" class="difflineminus">-}</span>
<a href="#l6.1729"></a><span id="l6.1729" class="difflineminus">-</span>
<a href="#l6.1730"></a><span id="l6.1730" class="difflineminus">-// Given an arbitrary block of text like a comma delimited list of names or a names separated by spaces,</span>
<a href="#l6.1731"></a><span id="l6.1731" class="difflineminus">-// we will try to autocomplete each of the names and then take the FIRST match for each name, adding it the</span>
<a href="#l6.1732"></a><span id="l6.1732" class="difflineminus">-// addressing widget on the compose window.</span>
<a href="#l6.1733"></a><span id="l6.1733" class="difflineminus">-</span>
<a href="#l6.1734"></a><span id="l6.1734" class="difflineminus">-var gAutomatedAutoCompleteListener = null;</span>
<a href="#l6.1735"></a><span id="l6.1735" class="difflineminus">-</span>
<a href="#l6.1736"></a><span id="l6.1736" class="difflineminus">-function parseAndAddAddresses(addressText, recipientType) {</span>
<a href="#l6.1737"></a><span id="l6.1737" class="difflineminus">-  // strip any leading &gt;&gt; characters inserted by the autocomplete widget</span>
<a href="#l6.1738"></a><span id="l6.1738" class="difflineminus">-  var strippedAddresses = addressText.replace(/.* &gt;&gt; /, &quot;&quot;);</span>
<a href="#l6.1739"></a><span id="l6.1739" class="difflineminus">-</span>
<a href="#l6.1740"></a><span id="l6.1740" class="difflineminus">-  let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l6.1741"></a><span id="l6.1741" class="difflineminus">-    strippedAddresses</span>
<a href="#l6.1742"></a><span id="l6.1742" class="difflineminus">-  );</span>
<a href="#l6.1743"></a><span id="l6.1743" class="difflineminus">-</span>
<a href="#l6.1744"></a><span id="l6.1744" class="difflineminus">-  if (addresses.length &gt; 0) {</span>
<a href="#l6.1745"></a><span id="l6.1745" class="difflineminus">-    // we need to set up our own autocomplete session and search for results</span>
<a href="#l6.1746"></a><span id="l6.1746" class="difflineminus">-    if (!gAutomatedAutoCompleteListener) {</span>
<a href="#l6.1747"></a><span id="l6.1747" class="difflineminus">-      gAutomatedAutoCompleteListener = new AutomatedAutoCompleteHandler();</span>
<a href="#l6.1748"></a><span id="l6.1748" class="difflineminus">-    }</span>
<a href="#l6.1749"></a><span id="l6.1749" class="difflineminus">-</span>
<a href="#l6.1750"></a><span id="l6.1750" class="difflineminus">-    gAutomatedAutoCompleteListener.init(</span>
<a href="#l6.1751"></a><span id="l6.1751" class="difflineminus">-      addresses.map(addr =&gt; addr.toString()),</span>
<a href="#l6.1752"></a><span id="l6.1752" class="difflineminus">-      recipientType</span>
<a href="#l6.1753"></a><span id="l6.1753" class="difflineminus">-    );</span>
<a href="#l6.1754"></a><span id="l6.1754" class="difflineminus">-  }</span>
<a href="#l6.1755"></a><span id="l6.1755" class="difflineplus">+/**</span>
<a href="#l6.1756"></a><span id="l6.1756" class="difflineplus">+ * Move the focus on the first pill from the same .address-container.</span>
<a href="#l6.1757"></a><span id="l6.1757" class="difflineplus">+ *</span>
<a href="#l6.1758"></a><span id="l6.1758" class="difflineplus">+ * @param {XULElement} pill - The mail-address-pill element.</span>
<a href="#l6.1759"></a><span id="l6.1759" class="difflineplus">+ */</span>
<a href="#l6.1760"></a><span id="l6.1760" class="difflineplus">+function setFocusOnFirstPill(pill) {</span>
<a href="#l6.1761"></a><span id="l6.1761" class="difflineplus">+  pill.closest(&quot;.address-container&quot;).firstElementChild.focus();</span>
<a href="#l6.1762"></a><span id="l6.1762"> }</span>
<a href="#l6.1763"></a><span id="l6.1763"> </span>
<a href="#l6.1764"></a><span id="l6.1764" class="difflineminus">-function AutomatedAutoCompleteHandler() {}</span>
<a href="#l6.1765"></a><span id="l6.1765" class="difflineminus">-</span>
<a href="#l6.1766"></a><span id="l6.1766" class="difflineminus">-// state driven self contained object which will autocomplete a block of addresses without any UI.</span>
<a href="#l6.1767"></a><span id="l6.1767" class="difflineminus">-// force picks the first match and adds it to the addressing widget, then goes on to the next</span>
<a href="#l6.1768"></a><span id="l6.1768" class="difflineminus">-// name to complete.</span>
<a href="#l6.1769"></a><span id="l6.1769" class="difflineminus">-</span>
<a href="#l6.1770"></a><span id="l6.1770" class="difflineminus">-AutomatedAutoCompleteHandler.prototype = {</span>
<a href="#l6.1771"></a><span id="l6.1771" class="difflineminus">-  param: this,</span>
<a href="#l6.1772"></a><span id="l6.1772" class="difflineminus">-  sessionName: null,</span>
<a href="#l6.1773"></a><span id="l6.1773" class="difflineminus">-  namesToComplete: null,</span>
<a href="#l6.1774"></a><span id="l6.1774" class="difflineminus">-  numNamesToComplete: 0,</span>
<a href="#l6.1775"></a><span id="l6.1775" class="difflineminus">-  indexIntoNames: 0,</span>
<a href="#l6.1776"></a><span id="l6.1776" class="difflineminus">-  finalAddresses: null,</span>
<a href="#l6.1777"></a><span id="l6.1777" class="difflineminus">-</span>
<a href="#l6.1778"></a><span id="l6.1778" class="difflineminus">-  numSessionsToSearch: 0,</span>
<a href="#l6.1779"></a><span id="l6.1779" class="difflineminus">-  numSessionsSearched: 0,</span>
<a href="#l6.1780"></a><span id="l6.1780" class="difflineminus">-  recipientType: null,</span>
<a href="#l6.1781"></a><span id="l6.1781" class="difflineminus">-  searchResults: null,</span>
<a href="#l6.1782"></a><span id="l6.1782" class="difflineminus">-</span>
<a href="#l6.1783"></a><span id="l6.1783" class="difflineminus">-  init(namesToComplete, recipientType) {</span>
<a href="#l6.1784"></a><span id="l6.1784" class="difflineminus">-    this.indexIntoNames = 0;</span>
<a href="#l6.1785"></a><span id="l6.1785" class="difflineminus">-    this.numNamesToComplete = namesToComplete.length;</span>
<a href="#l6.1786"></a><span id="l6.1786" class="difflineminus">-    this.namesToComplete = namesToComplete;</span>
<a href="#l6.1787"></a><span id="l6.1787" class="difflineminus">-    this.finalAddresses = [];</span>
<a href="#l6.1788"></a><span id="l6.1788" class="difflineminus">-</span>
<a href="#l6.1789"></a><span id="l6.1789" class="difflineminus">-    this.recipientType = recipientType ? recipientType : &quot;addr_to&quot;;</span>
<a href="#l6.1790"></a><span id="l6.1790" class="difflineminus">-</span>
<a href="#l6.1791"></a><span id="l6.1791" class="difflineminus">-    // set up the auto complete sessions to use</span>
<a href="#l6.1792"></a><span id="l6.1792" class="difflineminus">-    this.autoCompleteNextAddress();</span>
<a href="#l6.1793"></a><span id="l6.1793" class="difflineminus">-  },</span>
<a href="#l6.1794"></a><span id="l6.1794" class="difflineminus">-</span>
<a href="#l6.1795"></a><span id="l6.1795" class="difflineminus">-  autoCompleteNextAddress() {</span>
<a href="#l6.1796"></a><span id="l6.1796" class="difflineminus">-    this.numSessionsToSearch = 0;</span>
<a href="#l6.1797"></a><span id="l6.1797" class="difflineminus">-    this.numSessionsSearched = 0;</span>
<a href="#l6.1798"></a><span id="l6.1798" class="difflineminus">-    this.searchResults = [];</span>
<a href="#l6.1799"></a><span id="l6.1799" class="difflineplus">+// #TODO: The getSiblingPills(), getAllPills(), and getAllSelectedPills()</span>
<a href="#l6.1800"></a><span id="l6.1800" class="difflineplus">+// methods are not a good way to handle these scenarios, and they should be</span>
<a href="#l6.1801"></a><span id="l6.1801" class="difflineplus">+// moved into their own CE. See Bug 1601740</span>
<a href="#l6.1802"></a><span id="l6.1802"> </span>
<a href="#l6.1803"></a><span id="l6.1803" class="difflineminus">-    if (this.indexIntoNames &lt; this.numNamesToComplete) {</span>
<a href="#l6.1804"></a><span id="l6.1804" class="difflineminus">-      if (this.namesToComplete[this.indexIntoNames]) {</span>
<a href="#l6.1805"></a><span id="l6.1805" class="difflineminus">-        /* XXX This is used to work, until switching to the new toolkit broke it</span>
<a href="#l6.1806"></a><span id="l6.1806" class="difflineminus">-         We should fix it see bug 456550.</span>
<a href="#l6.1807"></a><span id="l6.1807" class="difflineminus">-      if (!this.namesToComplete[this.indexIntoNames].includes('@')) // don't autocomplete if address has an @ sign in it</span>
<a href="#l6.1808"></a><span id="l6.1808" class="difflineminus">-      {</span>
<a href="#l6.1809"></a><span id="l6.1809" class="difflineminus">-        // make sure total session count is updated before we kick off ANY actual searches</span>
<a href="#l6.1810"></a><span id="l6.1810" class="difflineminus">-        if (gAutocompleteSession)</span>
<a href="#l6.1811"></a><span id="l6.1811" class="difflineminus">-          this.numSessionsToSearch++;</span>
<a href="#l6.1812"></a><span id="l6.1812" class="difflineminus">-</span>
<a href="#l6.1813"></a><span id="l6.1813" class="difflineminus">-        if (gLDAPSession &amp;&amp; gCurrentAutocompleteDirectory)</span>
<a href="#l6.1814"></a><span id="l6.1814" class="difflineminus">-          this.numSessionsToSearch++;</span>
<a href="#l6.1815"></a><span id="l6.1815" class="difflineminus">-</span>
<a href="#l6.1816"></a><span id="l6.1816" class="difflineminus">-        if (gAutocompleteSession)</span>
<a href="#l6.1817"></a><span id="l6.1817" class="difflineminus">-        {</span>
<a href="#l6.1818"></a><span id="l6.1818" class="difflineminus">-           gAutocompleteSession.onAutoComplete(this.namesToComplete[this.indexIntoNames], null, this);</span>
<a href="#l6.1819"></a><span id="l6.1819" class="difflineminus">-           // AB searches are actually synchronous. So by the time we get here we have already looked up results.</span>
<a href="#l6.1820"></a><span id="l6.1820" class="difflineminus">-</span>
<a href="#l6.1821"></a><span id="l6.1821" class="difflineminus">-           // if we WERE going to also do an LDAP lookup, then check to see if we have a valid match in the AB, if we do</span>
<a href="#l6.1822"></a><span id="l6.1822" class="difflineminus">-           // don't bother with the LDAP search too just return</span>
<a href="#l6.1823"></a><span id="l6.1823" class="difflineminus">-</span>
<a href="#l6.1824"></a><span id="l6.1824" class="difflineminus">-           if (gLDAPSession &amp;&amp; gCurrentAutocompleteDirectory &amp;&amp; this.searchResults[0] &amp;&amp; this.searchResults[0].defaultItemIndex != -1)</span>
<a href="#l6.1825"></a><span id="l6.1825" class="difflineminus">-           {</span>
<a href="#l6.1826"></a><span id="l6.1826" class="difflineminus">-             this.processAllResults();</span>
<a href="#l6.1827"></a><span id="l6.1827" class="difflineminus">-             return;</span>
<a href="#l6.1828"></a><span id="l6.1828" class="difflineminus">-           }</span>
<a href="#l6.1829"></a><span id="l6.1829" class="difflineminus">-        }</span>
<a href="#l6.1830"></a><span id="l6.1830" class="difflineminus">-</span>
<a href="#l6.1831"></a><span id="l6.1831" class="difflineminus">-        if (gLDAPSession &amp;&amp; gCurrentAutocompleteDirectory)</span>
<a href="#l6.1832"></a><span id="l6.1832" class="difflineminus">-          gLDAPSession.onStartLookup(this.namesToComplete[this.indexIntoNames], null, this);</span>
<a href="#l6.1833"></a><span id="l6.1833" class="difflineminus">-      }</span>
<a href="#l6.1834"></a><span id="l6.1834" class="difflineminus">-      */</span>
<a href="#l6.1835"></a><span id="l6.1835" class="difflineminus">-</span>
<a href="#l6.1836"></a><span id="l6.1836" class="difflineminus">-        if (!this.numSessionsToSearch) {</span>
<a href="#l6.1837"></a><span id="l6.1837" class="difflineminus">-          // LDAP and ab are turned off, so leave text alone.</span>
<a href="#l6.1838"></a><span id="l6.1838" class="difflineminus">-          this.processAllResults();</span>
<a href="#l6.1839"></a><span id="l6.1839" class="difflineminus">-        }</span>
<a href="#l6.1840"></a><span id="l6.1840" class="difflineminus">-      }</span>
<a href="#l6.1841"></a><span id="l6.1841" class="difflineminus">-    } else {</span>
<a href="#l6.1842"></a><span id="l6.1842" class="difflineminus">-      this.finish();</span>
<a href="#l6.1843"></a><span id="l6.1843" class="difflineminus">-    }</span>
<a href="#l6.1844"></a><span id="l6.1844" class="difflineminus">-  },</span>
<a href="#l6.1845"></a><span id="l6.1845" class="difflineplus">+/**</span>
<a href="#l6.1846"></a><span id="l6.1846" class="difflineplus">+ * Return all the pills from the same .address-container.</span>
<a href="#l6.1847"></a><span id="l6.1847" class="difflineplus">+ *</span>
<a href="#l6.1848"></a><span id="l6.1848" class="difflineplus">+ * @param {XULElement} pill - The mail-address-pill element.</span>
<a href="#l6.1849"></a><span id="l6.1849" class="difflineplus">+ * @return {Array} Array of mail-address-pill elements.</span>
<a href="#l6.1850"></a><span id="l6.1850" class="difflineplus">+ */</span>
<a href="#l6.1851"></a><span id="l6.1851" class="difflineplus">+function getSiblingPills(pill) {</span>
<a href="#l6.1852"></a><span id="l6.1852" class="difflineplus">+  return pill</span>
<a href="#l6.1853"></a><span id="l6.1853" class="difflineplus">+    .closest(&quot;.address-container&quot;)</span>
<a href="#l6.1854"></a><span id="l6.1854" class="difflineplus">+    .querySelectorAll(&quot;mail-address-pill&quot;);</span>
<a href="#l6.1855"></a><span id="l6.1855" class="difflineplus">+}</span>
<a href="#l6.1856"></a><span id="l6.1856"> </span>
<a href="#l6.1857"></a><span id="l6.1857" class="difflineminus">-  onStatus(aStatus) {},</span>
<a href="#l6.1858"></a><span id="l6.1858" class="difflineminus">-</span>
<a href="#l6.1859"></a><span id="l6.1859" class="difflineminus">-  onAutoComplete(aResults, aStatus) {</span>
<a href="#l6.1860"></a><span id="l6.1860" class="difflineminus">-    // store the results until all sessions are done and have reported in</span>
<a href="#l6.1861"></a><span id="l6.1861" class="difflineminus">-    if (aResults) {</span>
<a href="#l6.1862"></a><span id="l6.1862" class="difflineminus">-      this.searchResults[this.numSessionsSearched] = aResults;</span>
<a href="#l6.1863"></a><span id="l6.1863" class="difflineminus">-    }</span>
<a href="#l6.1864"></a><span id="l6.1864" class="difflineminus">-</span>
<a href="#l6.1865"></a><span id="l6.1865" class="difflineminus">-    this.numSessionsSearched++; // bump our counter</span>
<a href="#l6.1866"></a><span id="l6.1866" class="difflineminus">-</span>
<a href="#l6.1867"></a><span id="l6.1867" class="difflineminus">-    if (this.numSessionsToSearch &lt;= this.numSessionsSearched) {</span>
<a href="#l6.1868"></a><span id="l6.1868" class="difflineminus">-      // We are all done.</span>
<a href="#l6.1869"></a><span id="l6.1869" class="difflineminus">-      setTimeout(gAutomatedAutoCompleteListener.processAllResults, 0);</span>
<a href="#l6.1870"></a><span id="l6.1870" class="difflineminus">-    }</span>
<a href="#l6.1871"></a><span id="l6.1871" class="difflineminus">-  },</span>
<a href="#l6.1872"></a><span id="l6.1872" class="difflineminus">-</span>
<a href="#l6.1873"></a><span id="l6.1873" class="difflineminus">-  processAllResults() {</span>
<a href="#l6.1874"></a><span id="l6.1874" class="difflineminus">-    // Take the first result and add it to the compose window</span>
<a href="#l6.1875"></a><span id="l6.1875" class="difflineminus">-    var addressToAdd;</span>
<a href="#l6.1876"></a><span id="l6.1876" class="difflineminus">-</span>
<a href="#l6.1877"></a><span id="l6.1877" class="difflineminus">-    // loop through the results looking for the non default case (default case is the address book with only one match, the default domain)</span>
<a href="#l6.1878"></a><span id="l6.1878" class="difflineminus">-    var sessionIndex;</span>
<a href="#l6.1879"></a><span id="l6.1879" class="difflineminus">-</span>
<a href="#l6.1880"></a><span id="l6.1880" class="difflineminus">-    var searchResultsForSession;</span>
<a href="#l6.1881"></a><span id="l6.1881" class="difflineminus">-</span>
<a href="#l6.1882"></a><span id="l6.1882" class="difflineminus">-    for (sessionIndex in this.searchResults) {</span>
<a href="#l6.1883"></a><span id="l6.1883" class="difflineminus">-      searchResultsForSession = this.searchResults[sessionIndex];</span>
<a href="#l6.1884"></a><span id="l6.1884" class="difflineminus">-      if (</span>
<a href="#l6.1885"></a><span id="l6.1885" class="difflineminus">-        searchResultsForSession &amp;&amp;</span>
<a href="#l6.1886"></a><span id="l6.1886" class="difflineminus">-        searchResultsForSession.defaultItemIndex &gt; -1</span>
<a href="#l6.1887"></a><span id="l6.1887" class="difflineminus">-      ) {</span>
<a href="#l6.1888"></a><span id="l6.1888" class="difflineminus">-        addressToAdd = searchResultsForSession.items.queryElementAt(</span>
<a href="#l6.1889"></a><span id="l6.1889" class="difflineminus">-          searchResultsForSession.defaultItemIndex,</span>
<a href="#l6.1890"></a><span id="l6.1890" class="difflineminus">-          Ci.nsIAutoCompleteItem</span>
<a href="#l6.1891"></a><span id="l6.1891" class="difflineminus">-        ).value;</span>
<a href="#l6.1892"></a><span id="l6.1892" class="difflineminus">-        break;</span>
<a href="#l6.1893"></a><span id="l6.1893" class="difflineminus">-      }</span>
<a href="#l6.1894"></a><span id="l6.1894" class="difflineminus">-    }</span>
<a href="#l6.1895"></a><span id="l6.1895" class="difflineplus">+/**</span>
<a href="#l6.1896"></a><span id="l6.1896" class="difflineplus">+ * Return all the pills currently available in the document.</span>
<a href="#l6.1897"></a><span id="l6.1897" class="difflineplus">+ *</span>
<a href="#l6.1898"></a><span id="l6.1898" class="difflineplus">+ * @return {Array} Array of mail-address-pill elements.</span>
<a href="#l6.1899"></a><span id="l6.1899" class="difflineplus">+ */</span>
<a href="#l6.1900"></a><span id="l6.1900" class="difflineplus">+function getAllPills() {</span>
<a href="#l6.1901"></a><span id="l6.1901" class="difflineplus">+  return document.querySelectorAll(&quot;mail-address-pill&quot;);</span>
<a href="#l6.1902"></a><span id="l6.1902" class="difflineplus">+}</span>
<a href="#l6.1903"></a><span id="l6.1903"> </span>
<a href="#l6.1904"></a><span id="l6.1904" class="difflineminus">-    // still no match? loop through looking for the -1 default index</span>
<a href="#l6.1905"></a><span id="l6.1905" class="difflineminus">-    if (!addressToAdd) {</span>
<a href="#l6.1906"></a><span id="l6.1906" class="difflineminus">-      for (sessionIndex in this.searchResults) {</span>
<a href="#l6.1907"></a><span id="l6.1907" class="difflineminus">-        searchResultsForSession = this.searchResults[sessionIndex];</span>
<a href="#l6.1908"></a><span id="l6.1908" class="difflineminus">-        if (</span>
<a href="#l6.1909"></a><span id="l6.1909" class="difflineminus">-          searchResultsForSession &amp;&amp;</span>
<a href="#l6.1910"></a><span id="l6.1910" class="difflineminus">-          searchResultsForSession.defaultItemIndex == -1</span>
<a href="#l6.1911"></a><span id="l6.1911" class="difflineminus">-        ) {</span>
<a href="#l6.1912"></a><span id="l6.1912" class="difflineminus">-          addressToAdd = searchResultsForSession.items.queryElementAt(</span>
<a href="#l6.1913"></a><span id="l6.1913" class="difflineminus">-            0,</span>
<a href="#l6.1914"></a><span id="l6.1914" class="difflineminus">-            Ci.nsIAutoCompleteItem</span>
<a href="#l6.1915"></a><span id="l6.1915" class="difflineminus">-          ).value;</span>
<a href="#l6.1916"></a><span id="l6.1916" class="difflineminus">-          break;</span>
<a href="#l6.1917"></a><span id="l6.1917" class="difflineminus">-        }</span>
<a href="#l6.1918"></a><span id="l6.1918" class="difflineminus">-      }</span>
<a href="#l6.1919"></a><span id="l6.1919" class="difflineminus">-    }</span>
<a href="#l6.1920"></a><span id="l6.1920" class="difflineplus">+/**</span>
<a href="#l6.1921"></a><span id="l6.1921" class="difflineplus">+ * Return all the selected pills currently available in the document.</span>
<a href="#l6.1922"></a><span id="l6.1922" class="difflineplus">+ *</span>
<a href="#l6.1923"></a><span id="l6.1923" class="difflineplus">+ * @return {Array} Array of selected mail-address-pill elements.</span>
<a href="#l6.1924"></a><span id="l6.1924" class="difflineplus">+ */</span>
<a href="#l6.1925"></a><span id="l6.1925" class="difflineplus">+function getAllSelectedPills() {</span>
<a href="#l6.1926"></a><span id="l6.1926" class="difflineplus">+  return document.querySelectorAll(`mail-address-pill[selected]`);</span>
<a href="#l6.1927"></a><span id="l6.1927" class="difflineplus">+}</span>
<a href="#l6.1928"></a><span id="l6.1928"> </span>
<a href="#l6.1929"></a><span id="l6.1929" class="difflineminus">-    // no matches anywhere...just use what we were given</span>
<a href="#l6.1930"></a><span id="l6.1930" class="difflineminus">-    if (!addressToAdd) {</span>
<a href="#l6.1931"></a><span id="l6.1931" class="difflineminus">-      addressToAdd = this.namesToComplete[this.indexIntoNames];</span>
<a href="#l6.1932"></a><span id="l6.1932" class="difflineminus">-    }</span>
<a href="#l6.1933"></a><span id="l6.1933" class="difflineminus">-</span>
<a href="#l6.1934"></a><span id="l6.1934" class="difflineminus">-    this.finalAddresses.push(addressToAdd);</span>
<a href="#l6.1935"></a><span id="l6.1935" class="difflineminus">-</span>
<a href="#l6.1936"></a><span id="l6.1936" class="difflineminus">-    this.indexIntoNames++;</span>
<a href="#l6.1937"></a><span id="l6.1937" class="difflineminus">-    this.autoCompleteNextAddress();</span>
<a href="#l6.1938"></a><span id="l6.1938" class="difflineminus">-  },</span>
<a href="#l6.1939"></a><span id="l6.1939" class="difflineminus">-</span>
<a href="#l6.1940"></a><span id="l6.1940" class="difflineminus">-  finish() {</span>
<a href="#l6.1941"></a><span id="l6.1941" class="difflineminus">-    // This will now append all the recipients, set the focus on a new</span>
<a href="#l6.1942"></a><span id="l6.1942" class="difflineminus">-    // available row, and make sure it is visible.</span>
<a href="#l6.1943"></a><span id="l6.1943" class="difflineminus">-    awAddRecipientsArray(this.recipientType, this.finalAddresses);</span>
<a href="#l6.1944"></a><span id="l6.1944" class="difflineminus">-  },</span>
<a href="#l6.1945"></a><span id="l6.1945" class="difflineminus">-</span>
<a href="#l6.1946"></a><span id="l6.1946" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIAutoCompleteListener&quot;]),</span>
<a href="#l6.1947"></a><span id="l6.1947" class="difflineminus">-};</span>
<a href="#l6.1948"></a><span id="l6.1948" class="difflineminus">-</span>
<a href="#l6.1949"></a><span id="l6.1949" class="difflineminus">-// Returns the load context for the current window</span>
<a href="#l6.1950"></a><span id="l6.1950" class="difflineminus">-function getLoadContext() {</span>
<a href="#l6.1951"></a><span id="l6.1951" class="difflineminus">-  return window.docShell.QueryInterface(Ci.nsILoadContext);</span>
<a href="#l6.1952"></a><span id="l6.1952" class="difflineminus">-}</span>
<a href="#l6.1953"></a><span id="l6.1953" class="difflineplus">+// #END TODO</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/compose/content/messengercompose.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/compose/content/messengercompose.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -738,16 +738,32 @@</span>
<a href="#l7.4"></a><span id="l7.4">            onpopupshowing=&quot;onBlockedContentOptionsShowing(event);&quot;&gt;</span>
<a href="#l7.5"></a><span id="l7.5"> &lt;/menupopup&gt;</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> &lt;menupopup id=&quot;languageMenuList&quot;</span>
<a href="#l7.8"></a><span id="l7.8">            oncommand=&quot;ChangeLanguage(event);&quot;</span>
<a href="#l7.9"></a><span id="l7.9">            onpopupshowing=&quot;OnShowDictionaryMenu(event.target);&quot;&gt;</span>
<a href="#l7.10"></a><span id="l7.10"> &lt;/menupopup&gt;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+&lt;menupopup id=&quot;emailAddressPillPopup&quot; class=&quot;emailAddressPopup&quot;&gt;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  &lt;menuitem id=&quot;editAddressPill&quot; label=&quot;&amp;editMenu.label;&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+            accesskey=&quot;&amp;editMenu.accesskey;&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+            oncommand=&quot;editAddressPill(document.popupNode, event)&quot;/&gt;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  &lt;menuitem id=&quot;menu_cut&quot; label=&quot;&amp;cutCmd.label;&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+            accesskey=&quot;&amp;cutCmd.accesskey;&quot;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+            oncommand=&quot;cutEmailNewsAddress(document.popupNode)&quot;/&gt;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  &lt;menuitem id=&quot;menu_copy&quot; label=&quot;&amp;copyCmd.label;&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+            accesskey=&quot;&amp;copyCmd.accesskey;&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+            oncommand=&quot;copyEmailNewsAddress(document.popupNode)&quot;/&gt;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  &lt;menuitem id=&quot;menu_delete&quot; label=&quot;&amp;deleteCmd.label;&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+            accesskey=&quot;&amp;deleteCmd.accesskey;&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+            oncommand=&quot;deleteAddressPill(document.popupNode)&quot;/&gt;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+&lt;/menupopup&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28"> #ifdef XP_MACOSX</span>
<a href="#l7.29"></a><span id="l7.29">   &lt;vbox id=&quot;titlebar&quot;&gt;</span>
<a href="#l7.30"></a><span id="l7.30">     &lt;hbox id=&quot;titlebar-content&quot;&gt;</span>
<a href="#l7.31"></a><span id="l7.31">       &lt;spacer id=&quot;titlebar-spacer&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l7.32"></a><span id="l7.32">       &lt;hbox id=&quot;titlebar-buttonbox-container&quot; align=&quot;start&quot;&gt;</span>
<a href="#l7.33"></a><span id="l7.33">         &lt;hbox id=&quot;titlebar-buttonbox&quot;&gt;</span>
<a href="#l7.34"></a><span id="l7.34">           &lt;toolbarbutton class=&quot;titlebar-button&quot; id=&quot;titlebar-min&quot; oncommand=&quot;window.minimize();&quot;/&gt;</span>
<a href="#l7.35"></a><span id="l7.35">           &lt;toolbarbutton class=&quot;titlebar-button&quot; id=&quot;titlebar-max&quot; oncommand=&quot;onTitlebarMaxClick();&quot;/&gt;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineat">@@ -1976,90 +1992,299 @@</span>
<a href="#l7.37"></a><span id="l7.37">              customizable=&quot;true&quot; nowindowdrag=&quot;true&quot;</span>
<a href="#l7.38"></a><span id="l7.38">              ondragover=&quot;nsDragAndDrop.dragOver(event, envelopeDragObserver);&quot;</span>
<a href="#l7.39"></a><span id="l7.39">              ondrop=&quot;nsDragAndDrop.drop(event, envelopeDragObserver);&quot;</span>
<a href="#l7.40"></a><span id="l7.40">              ondragexit=&quot;nsDragAndDrop.dragExit(event, envelopeDragObserver);&quot;&gt;</span>
<a href="#l7.41"></a><span id="l7.41">       &lt;hbox id=&quot;msgheaderstoolbar-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l7.42"></a><span id="l7.42">         &lt;vbox flex=&quot;1&quot; id=&quot;addresses-box&quot;&gt;</span>
<a href="#l7.43"></a><span id="l7.43">           &lt;hbox id=&quot;top-gradient-box&quot;&gt;</span>
<a href="#l7.44"></a><span id="l7.44">             &lt;hbox class=&quot;aw-firstColBox&quot;/&gt;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-            &lt;hbox id=&quot;identityLabel-box&quot; align=&quot;center&quot; pack=&quot;end&quot; style=&quot;&amp;headersSpace.style;&quot;&gt;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-              &lt;label id=&quot;identityLabel&quot; value=&quot;&amp;fromAddr.label;&quot;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+            &lt;hbox id=&quot;identityLabel-box&quot; align=&quot;center&quot;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                  pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+              &lt;label id=&quot;identityLabel&quot; value=&quot;&amp;fromAddr2.label;&quot;</span>
<a href="#l7.50"></a><span id="l7.50">                      accesskey=&quot;&amp;fromAddr.accesskey;&quot; control=&quot;msgIdentity&quot;/&gt;</span>
<a href="#l7.51"></a><span id="l7.51">             &lt;/hbox&gt;</span>
<a href="#l7.52"></a><span id="l7.52">             &lt;menulist is=&quot;menulist-editable&quot; id=&quot;msgIdentity&quot;</span>
<a href="#l7.53"></a><span id="l7.53">                       type=&quot;description&quot; flex=&quot;1&quot;</span>
<a href="#l7.54"></a><span id="l7.54">                       disableautoselect=&quot;true&quot; onkeypress=&quot;fromKeyPress(event);&quot;</span>
<a href="#l7.55"></a><span id="l7.55">                       oncommand=&quot;LoadIdentity(false);&quot; disableonsend=&quot;true&quot;&gt;</span>
<a href="#l7.56"></a><span id="l7.56">               &lt;menupopup id=&quot;msgIdentityPopup&quot;/&gt;</span>
<a href="#l7.57"></a><span id="l7.57">             &lt;/menulist&gt;</span>
<a href="#l7.58"></a><span id="l7.58">           &lt;/hbox&gt;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-          &lt;richlistbox id=&quot;addressingWidget&quot; flex=&quot;1&quot; seltype=&quot;multiple&quot;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-                       onclick=&quot;awClickEmptySpace(event.originalTarget, true)&quot;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-                       disableonsend=&quot;true&quot;&gt;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-            &lt;treecols hidden=&quot;true&quot;&gt;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-              &lt;treecol id=&quot;firstcol-addressingWidget&quot;/&gt;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-              &lt;treecol id=&quot;typecol-addressingWidget&quot; style=&quot;&amp;headersSpace.style;&quot;/&gt;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-              &lt;treecol id=&quot;textcol-addressingWidget&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-            &lt;/treecols&gt;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-            &lt;richlistitem class=&quot;addressingWidgetItem&quot; allowevents=&quot;true&quot;&gt;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-              &lt;hbox class=&quot;aw-firstColBox&quot; align=&quot;center&quot;&gt;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-                &lt;image class=&quot;deleteAddress close-icon&quot;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-                       onclick=&quot;awDeleteAddressOnClick(this);&quot;/&gt;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+          &lt;vbox id=&quot;recipientsContainer&quot; class=&quot;recipients-container&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+            &lt;hbox id=&quot;addressRowTo&quot; class=&quot;addressingWidgetItem address-row&quot;&gt;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+              &lt;hbox class=&quot;aw-firstColBox&quot;/&gt;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+              &lt;hbox class=&quot;address-label-container&quot; align=&quot;top&quot;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+                    pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+                &lt;label id=&quot;toAddrLabel&quot; value=&quot;&amp;toAddr2.label;&quot;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+                       control=&quot;toAddrInput&quot;/&gt;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+              &lt;hbox id=&quot;toAddrContainer&quot; flex=&quot;1&quot; align=&quot;center&quot;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+                    class=&quot;input-container wrap-container address-container&quot;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+                    onclick=&quot;focusAddressInput(event);&quot;&gt;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;toAddrInput&quot;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+                            type=&quot;text&quot;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+                            class=&quot;plain address-input pop-imap-input&quot;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+                            disableonsend=&quot;true&quot;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+                            aria-labelledby=&quot;toAddrLabel&quot;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+                            autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+                            autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+                            timeout=&quot;300&quot;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+                            maxrows=&quot;6&quot;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+                            completedefaultindex=&quot;true&quot;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+                            forcecomplete=&quot;true&quot;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+                            completeselectedindex=&quot;true&quot;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+                            minresultsforpopup=&quot;2&quot;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+                            ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+                            onfocus=&quot;highlightAddressContainer(this);&quot;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+                            onblur=&quot;resetAddressContainer(this);&quot;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+                            onkeypress=&quot;recipientKeyPress(event, this);&quot;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+                            recipienttype=&quot;addr_to&quot;</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+                            size=&quot;1&quot;/&gt;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+            &lt;hbox id=&quot;addressRowCc&quot; class=&quot;addressingWidgetItem address-row hidden&quot;&gt;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+              &lt;hbox class=&quot;aw-firstColBox&quot; align=&quot;top&quot;&gt;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+                &lt;label onclick=&quot;hideAddressRow(this, 'addr_cc');&quot;</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+                       onkeypress=&quot;if (event.key == 'Enter') { hideAddressRow(this, 'addr_cc'); }&quot;&gt;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+                  &lt;image class=&quot;close-icon&quot;/&gt;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+                &lt;/label&gt;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+              &lt;hbox class=&quot;address-label-container&quot; align=&quot;top&quot;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+                    pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+                &lt;label id=&quot;ccAddrLabel&quot; value=&quot;&amp;ccAddr2.label;&quot;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+                       control=&quot;ccAddrInput&quot;/&gt;</span>
<a href="#l7.116"></a><span id="l7.116">               &lt;/hbox&gt;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-              &lt;hbox class=&quot;addressingWidgetCell&quot; align=&quot;center&quot; style=&quot;&amp;headersSpace.style;&quot;&gt;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-                &lt;menulist id=&quot;addressCol1#1&quot; disableonsend=&quot;true&quot;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-                          class=&quot;aw-menulist&quot; flex=&quot;1&quot;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-                          oncommand=&quot;onAddressColCommand(this.id);&quot;&gt;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                  &lt;menupopup&gt;</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-                    &lt;menuitem value=&quot;addr_to&quot; label=&quot;&amp;toAddr.label;&quot;/&gt;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-                    &lt;menuitem value=&quot;addr_cc&quot; label=&quot;&amp;ccAddr.label;&quot;/&gt;</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-                    &lt;menuitem value=&quot;addr_bcc&quot; label=&quot;&amp;bccAddr.label;&quot;/&gt;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-                    &lt;menuitem value=&quot;addr_reply&quot; label=&quot;&amp;replyAddr.label;&quot;/&gt;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-                    &lt;menuitem value=&quot;addr_newsgroups&quot; label=&quot;&amp;newsgroupsAddr.label;&quot;/&gt;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-                    &lt;menuitem value=&quot;addr_followup&quot; label=&quot;&amp;followupAddr.label;&quot;/&gt;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-                  &lt;/menupopup&gt;</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-                &lt;/menulist&gt;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+              &lt;hbox id=&quot;ccAddrContainer&quot; flex=&quot;1&quot; align=&quot;center&quot;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+                    class=&quot;input-container wrap-container address-container&quot;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+                    onclick=&quot;focusAddressInput(event);&quot;&gt;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;ccAddrInput&quot;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+                            type=&quot;text&quot;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+                            class=&quot;plain address-input pop-imap-input&quot;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+                            disableonsend=&quot;true&quot;</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+                            aria-labelledby=&quot;ccAddrLabel&quot;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+                            autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+                            autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+                            timeout=&quot;300&quot;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+                            maxrows=&quot;6&quot;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+                            completedefaultindex=&quot;true&quot;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+                            forcecomplete=&quot;true&quot;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+                            completeselectedindex=&quot;true&quot;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+                            minresultsforpopup=&quot;2&quot;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+                            ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+                            onfocus=&quot;highlightAddressContainer(this);&quot;</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+                            onblur=&quot;resetAddressContainer(this);&quot;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+                            onkeypress=&quot;recipientKeyPress(event, this);&quot;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+                            recipienttype=&quot;addr_cc&quot;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+                            size=&quot;1&quot;/&gt;</span>
<a href="#l7.152"></a><span id="l7.152">               &lt;/hbox&gt;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-              &lt;hbox class=&quot;addressingWidgetCell input-container&quot; flex=&quot;1&quot; role=&quot;combobox&quot;&gt;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;addressCol2#1&quot;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-                            class=&quot;plain textbox-addressingWidget uri-element&quot;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-                            aria-labelledby=&quot;addressCol1#1&quot;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+            &lt;hbox id=&quot;addressRowBcc&quot; class=&quot;addressingWidgetItem address-row hidden&quot;&gt;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+              &lt;hbox class=&quot;aw-firstColBox&quot; align=&quot;top&quot;&gt;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+                &lt;label onclick=&quot;hideAddressRow(this, 'addr_bcc');&quot;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+                       onkeypress=&quot;if (event.key == 'Enter') { hideAddressRow(this, 'addr_bcc'); }&quot;&gt;</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+                  &lt;image class=&quot;close-icon&quot;/&gt;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+                &lt;/label&gt;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+              &lt;hbox class=&quot;address-label-container&quot; align=&quot;top&quot;</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+                    pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+                &lt;label id=&quot;bccAddrLabel&quot; value=&quot;&amp;bccAddr2.label;&quot;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+                       control=&quot;bccAddrInput&quot;/&gt;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+              &lt;hbox id=&quot;bccAddrContainer&quot; flex=&quot;1&quot; align=&quot;center&quot;</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+                    class=&quot;input-container wrap-container address-container&quot;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+                    onclick=&quot;focusAddressInput(event);&quot;&gt;</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;bccAddrInput&quot;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+                            type=&quot;text&quot;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+                            class=&quot;plain address-input pop-imap-input&quot;</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+                            disableonsend=&quot;true&quot;</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+                            aria-labelledby=&quot;bccAddrLabel&quot;</span>
<a href="#l7.179"></a><span id="l7.179">                             autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l7.180"></a><span id="l7.180">                             autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l7.181"></a><span id="l7.181">                             timeout=&quot;300&quot;</span>
<a href="#l7.182"></a><span id="l7.182">                             maxrows=&quot;6&quot;</span>
<a href="#l7.183"></a><span id="l7.183">                             completedefaultindex=&quot;true&quot;</span>
<a href="#l7.184"></a><span id="l7.184">                             forcecomplete=&quot;true&quot;</span>
<a href="#l7.185"></a><span id="l7.185">                             completeselectedindex=&quot;true&quot;</span>
<a href="#l7.186"></a><span id="l7.186">                             minresultsforpopup=&quot;2&quot;</span>
<a href="#l7.187"></a><span id="l7.187">                             ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-                            onfocus=&quot;awRecipientOnFocus(this);&quot;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-                            onchange=&quot;onRecipientsChanged();&quot;</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-                            oninput=&quot;onRecipientsChanged();&quot;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-                            onkeypress=&quot;awRecipientKeyPress(event, this)&quot;</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-                            onkeydown=&quot;awRecipientKeyDown(event, this)&quot;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-                            disableonsend=&quot;true&quot;/&gt;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+                            onfocus=&quot;highlightAddressContainer(this);&quot;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+                            onblur=&quot;resetAddressContainer(this);&quot;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+                            onkeypress=&quot;recipientKeyPress(event, this);&quot;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+                            recipienttype=&quot;addr_bcc&quot;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+                            size=&quot;1&quot;/&gt;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+            &lt;hbox id=&quot;addressRowReply&quot; class=&quot;addressingWidgetItem address-row hidden&quot;&gt;</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+              &lt;hbox class=&quot;aw-firstColBox&quot; align=&quot;top&quot;&gt;</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+                &lt;label onclick=&quot;hideAddressRow(this, 'addr_reply');&quot;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+                       onkeypress=&quot;if (event.key == 'Enter') { hideAddressRow(this, 'addr_reply'); }&quot;&gt;</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+                  &lt;image class=&quot;close-icon&quot;/&gt;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+                &lt;/label&gt;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+              &lt;hbox class=&quot;address-label-container&quot; align=&quot;top&quot;</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+                    pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+                &lt;label id=&quot;replyAddrLabel&quot; value=&quot;&amp;replyAddr2.label;&quot;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+                       control=&quot;replyAddrInput&quot;/&gt;</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+              &lt;hbox id=&quot;replyAddrContainer&quot; flex=&quot;1&quot; align=&quot;center&quot;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+                    class=&quot;input-container wrap-container address-container&quot;</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+                    onclick=&quot;focusAddressInput(event);&quot;&gt;</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;replyAddrInput&quot;</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+                            type=&quot;text&quot;</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                            class=&quot;plain address-input pop-imap-input&quot;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+                            disableonsend=&quot;true&quot;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+                            aria-labelledby=&quot;replyAddrLabel&quot;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+                            autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+                            autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+                            timeout=&quot;300&quot;</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+                            maxrows=&quot;6&quot;</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+                            completedefaultindex=&quot;true&quot;</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+                            forcecomplete=&quot;true&quot;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+                            completeselectedindex=&quot;true&quot;</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+                            minresultsforpopup=&quot;2&quot;</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+                            ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+                            onfocus=&quot;highlightAddressContainer(this);&quot;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+                            onblur=&quot;resetAddressContainer(this);&quot;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+                            onkeypress=&quot;recipientKeyPress(event, this);&quot;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+                            recipienttype=&quot;addr_reply&quot;</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+                            size=&quot;1&quot;/&gt;</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+            &lt;hbox id=&quot;addressRowNewsgroups&quot; class=&quot;addressingWidgetItem address-row hidden&quot;&gt;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+              &lt;hbox class=&quot;aw-firstColBox&quot; align=&quot;top&quot;&gt;</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+                &lt;label onclick=&quot;hideAddressRow(this, 'addr_newsgroups');&quot;</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+                       onkeypress=&quot;if (event.key == 'Enter') { hideAddressRow(this, 'addr_newsgroups'); }&quot;&gt;</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+                  &lt;image class=&quot;close-icon&quot;/&gt;</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+                &lt;/label&gt;</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+              &lt;hbox class=&quot;address-label-container&quot; align=&quot;top&quot;</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+                    pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+                &lt;label id=&quot;newsgroupsAddrLabel&quot; value=&quot;&amp;newsgroupsAddr2.label;&quot;</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+                       control=&quot;newsgroupsAddrInput&quot;/&gt;</span>
<a href="#l7.250"></a><span id="l7.250">               &lt;/hbox&gt;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-            &lt;/richlistitem&gt;</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-          &lt;/richlistbox&gt;</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+              &lt;hbox id=&quot;newsgroupsAddrContainer&quot; flex=&quot;1&quot; align=&quot;center&quot;</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+                    class=&quot;input-container wrap-container address-container&quot;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+                    onclick=&quot;focusAddressInput(event);&quot;&gt;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;newsgroupsAddrInput&quot;</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+                            type=&quot;text&quot;</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+                            class=&quot;plain address-input nntp-input&quot;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+                            disableonsend=&quot;true&quot;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+                            aria-labelledby=&quot;newsgroupsAddrLabel&quot;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+                            autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+                            autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+                            timeout=&quot;300&quot;</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+                            maxrows=&quot;6&quot;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+                            completedefaultindex=&quot;true&quot;</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+                            forcecomplete=&quot;true&quot;</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+                            completeselectedindex=&quot;true&quot;</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+                            minresultsforpopup=&quot;2&quot;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+                            ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+                            onfocus=&quot;highlightAddressContainer(this);&quot;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+                            onblur=&quot;resetAddressContainer(this);&quot;</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+                            onkeypress=&quot;recipientKeyPress(event, this);&quot;</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+                            recipienttype=&quot;addr_newsgroups&quot;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+                            size=&quot;1&quot;/&gt;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+            &lt;hbox id=&quot;addressRowFollowup&quot; class=&quot;addressingWidgetItem address-row hidden&quot;&gt;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+              &lt;hbox class=&quot;aw-firstColBox&quot; align=&quot;top&quot;&gt;</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+                &lt;label onclick=&quot;hideAddressRow(this, 'addr_followup');&quot;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+                       onkeypress=&quot;if (event.key == 'Enter') { hideAddressRow(this, 'addr_followup'); }&quot;&gt;</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+                  &lt;image class=&quot;close-icon&quot;/&gt;</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+                &lt;/label&gt;</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+              &lt;hbox class=&quot;address-label-container&quot; align=&quot;top&quot;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+                    pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+                &lt;label id=&quot;followupAddrLabel&quot; value=&quot;&amp;followupAddr2.label;&quot;</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+                       control=&quot;followupAddrInput&quot;/&gt;</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+              &lt;hbox id=&quot;followupAddrContainer&quot; flex=&quot;1&quot; align=&quot;center&quot;</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+                    class=&quot;input-container wrap-container address-container&quot;</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+                    onclick=&quot;focusAddressInput(event);&quot;&gt;</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+                &lt;html:input is=&quot;autocomplete-input&quot; id=&quot;followupAddrInput&quot;</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+                            type=&quot;text&quot;</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+                            class=&quot;plain address-input nntp-input&quot;</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+                            disableonsend=&quot;true&quot;</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+                            aria-labelledby=&quot;followupAddrLabel&quot;</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+                            autocompletesearch=&quot;mydomain addrbook ldap news&quot;</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+                            autocompletesearchparam=&quot;{}&quot;</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+                            timeout=&quot;300&quot;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+                            maxrows=&quot;6&quot;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+                            completedefaultindex=&quot;true&quot;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+                            forcecomplete=&quot;true&quot;</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+                            completeselectedindex=&quot;true&quot;</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+                            minresultsforpopup=&quot;2&quot;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+                            ignoreblurwhilesearching=&quot;true&quot;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+                            onfocus=&quot;highlightAddressContainer(this);&quot;</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+                            onblur=&quot;resetAddressContainer(this);&quot;</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+                            onkeypress=&quot;recipientKeyPress(event, this);&quot;</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+                            recipienttype=&quot;addr_followup&quot;</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+                            size=&quot;1&quot;/&gt;</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+          &lt;hbox class=&quot;addressingWidgetItem&quot;&gt;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+            &lt;hbox class=&quot;aw-firstColBox&quot;/&gt;</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+            &lt;hbox class=&quot;address-label-container&quot; style=&quot;&amp;headersSpace2.style;&quot;/&gt;</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+            &lt;hbox id=&quot;addressingWidgetLabels&quot; class=&quot;address-extra-recipients&quot;</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+                  flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+              &lt;label id=&quot;addr_to&quot; control=&quot;toAddrInput&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+              &lt;label id=&quot;addr_cc&quot; onclick=&quot;showAddressRow(this, 'addressRowCc')&quot;</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+                     onkeypress=&quot;showAddressRowKeyPress(event, this, 'addressRowCc')&quot;</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+                     control=&quot;ccAddrInput&quot;&gt;</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+                &lt;image class=&quot;new-icon&quot;/&gt;&amp;ccAddr2.label;</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+              &lt;/label&gt;</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+              &lt;label id=&quot;addr_bcc&quot; onclick=&quot;showAddressRow(this, 'addressRowBcc')&quot;</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+                     onkeypress=&quot;showAddressRowKeyPress(event, this, 'addressRowBcc')&quot;</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+                     control=&quot;bccAddrInput&quot;&gt;</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+                &lt;image class=&quot;new-icon&quot;/&gt;&amp;bccAddr2.label;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+              &lt;/label&gt;</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+              &lt;label id=&quot;addr_reply&quot; onclick=&quot;showAddressRow(this, 'addressRowReply')&quot;</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+                     onkeypress=&quot;showAddressRowKeyPress(event, this, 'addressRowReply')&quot;</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+                     control=&quot;replyAddrInput&quot;&gt;</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+                &lt;image class=&quot;new-icon&quot;/&gt;&amp;replyAddr2.label;</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+              &lt;/label&gt;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+              &lt;label id=&quot;addr_newsgroups&quot; onclick=&quot;showAddressRow(this, 'addressRowNewsgroups')&quot;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+                     onkeypress=&quot;showAddressRowKeyPress(event, this, 'addressRowNewsgroups')&quot;</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+                     control=&quot;newsgroupsAddrInput&quot; class=&quot;nntp-label&quot;&gt;</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+                &lt;image class=&quot;new-icon&quot;/&gt;&amp;newsgroupsAddr2.label;</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+              &lt;/label&gt;</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+              &lt;label id=&quot;addr_followup&quot; onclick=&quot;showAddressRow(this, 'addressRowFollowup')&quot;</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+                     onkeypress=&quot;showAddressRowKeyPress(event, this, 'addressRowFollowup')&quot;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+                     control=&quot;followupAddrInput&quot; class=&quot;nntp-label&quot;&gt;</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+                &lt;image class=&quot;new-icon&quot;/&gt;&amp;followupAddr2.label;</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+              &lt;/label&gt;</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+</span>
<a href="#l7.350"></a><span id="l7.350">           &lt;hbox id=&quot;subject-box&quot;&gt;</span>
<a href="#l7.351"></a><span id="l7.351">             &lt;hbox class=&quot;aw-firstColBox&quot;/&gt;</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-            &lt;hbox align=&quot;center&quot; pack=&quot;end&quot; style=&quot;&amp;headersSpace.style;&quot;&gt;</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-              &lt;label id=&quot;subjectLabel&quot; value=&quot;&amp;subject.label;&quot; accesskey=&quot;&amp;subject.accesskey;&quot; control=&quot;msgSubject&quot;/&gt;</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+            &lt;hbox id=&quot;subjectLabel-box&quot; align=&quot;center&quot;</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+                  pack=&quot;end&quot; style=&quot;&amp;headersSpace2.style;&quot;&gt;</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+              &lt;label id=&quot;subjectLabel&quot; value=&quot;&amp;subject2.label;&quot;</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+                     accesskey=&quot;&amp;subject.accesskey;&quot; control=&quot;msgSubject&quot;/&gt;</span>
<a href="#l7.358"></a><span id="l7.358">             &lt;/hbox&gt;</span>
<a href="#l7.359"></a><span id="l7.359">             &lt;hbox flex=&quot;1&quot; align=&quot;center&quot; class=&quot;input-container&quot;&gt;</span>
<a href="#l7.360"></a><span id="l7.360">               &lt;moz-input-box spellcheck=&quot;true&quot; style=&quot;flex: 1;&quot;&gt;</span>
<a href="#l7.361"></a><span id="l7.361">                 &lt;html:input id=&quot;msgSubject&quot;</span>
<a href="#l7.362"></a><span id="l7.362">                             type=&quot;text&quot;</span>
<a href="#l7.363"></a><span id="l7.363">                             class=&quot;input-inline textbox-input&quot;</span>
<a href="#l7.364"></a><span id="l7.364">                             disableonsend=&quot;true&quot;</span>
<a href="#l7.365"></a><span id="l7.365">                             oninput=&quot;gContentChanged = true; SetComposeWindowTitle();&quot;</span>
<a href="#l7.366"></a><span id="l7.366">                             onkeypress=&quot;subjectKeyPress(event);&quot;</span>
<a href="#l7.367"></a><span id="l7.367">                             aria-labelledby=&quot;subjectLabel&quot;</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+                            onfocus=&quot;deselectAllPills();&quot;</span>
<a href="#l7.369"></a><span id="l7.369">                             style=&quot;-moz-box-flex: 1;&quot;/&gt;</span>
<a href="#l7.370"></a><span id="l7.370">                 &lt;/moz-input-box&gt;</span>
<a href="#l7.371"></a><span id="l7.371">             &lt;/hbox&gt;</span>
<a href="#l7.372"></a><span id="l7.372">           &lt;/hbox&gt;</span>
<a href="#l7.373"></a><span id="l7.373">         &lt;/vbox&gt;</span>
<a href="#l7.374"></a><span id="l7.374">         &lt;splitter id=&quot;attachmentbucket-sizer&quot;</span>
<a href="#l7.375"></a><span id="l7.375">                   collapsed=&quot;true&quot;</span>
<a href="#l7.376"></a><span id="l7.376">                   collapse=&quot;after&quot;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineat">@@ -2133,17 +2358,18 @@</span>
<a href="#l7.378"></a><span id="l7.378">             type=&quot;content&quot;</span>
<a href="#l7.379"></a><span id="l7.379">             primary=&quot;true&quot;</span>
<a href="#l7.380"></a><span id="l7.380">             src=&quot;about:blank&quot;</span>
<a href="#l7.381"></a><span id="l7.381">             name=&quot;browser.message.body&quot;</span>
<a href="#l7.382"></a><span id="l7.382">             aria-label=&quot;&amp;aria.message.bodyName;&quot;</span>
<a href="#l7.383"></a><span id="l7.383">             minheight=&quot;100&quot;</span>
<a href="#l7.384"></a><span id="l7.384">             flex=&quot;1&quot;</span>
<a href="#l7.385"></a><span id="l7.385">             ondblclick=&quot;EditorDblClick(event);&quot;</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-            context=&quot;msgComposeContext&quot;/&gt;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+            context=&quot;msgComposeContext&quot;</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+            onclick=&quot;deselectAllPills();&quot;/&gt;</span>
<a href="#l7.389"></a><span id="l7.389">     &lt;findbar id=&quot;FindToolbar&quot; browserid=&quot;content-frame&quot;/&gt;</span>
<a href="#l7.390"></a><span id="l7.390">   &lt;/vbox&gt;</span>
<a href="#l7.391"></a><span id="l7.391"> </span>
<a href="#l7.392"></a><span id="l7.392">   &lt;/vbox&gt;</span>
<a href="#l7.393"></a><span id="l7.393">   &lt;/hbox&gt;</span>
<a href="#l7.394"></a><span id="l7.394">   &lt;panel id=&quot;customizeToolbarSheetPopup&quot; noautohide=&quot;true&quot;&gt;</span>
<a href="#l7.395"></a><span id="l7.395">     &lt;iframe id=&quot;customizeToolbarSheetIFrame&quot;</span>
<a href="#l7.396"></a><span id="l7.396">             style=&quot;&amp;dialog.dimensions;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -229,17 +229,17 @@ function showMessageComposeSecurityStatu</span>
<a href="#l8.4"></a><span id="l8.4">   Recipients2CompFields(gMsgCompose.compFields);</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   window.openDialog(</span>
<a href="#l8.7"></a><span id="l8.7">     &quot;chrome://messenger-smime/content/msgCompSecurityInfo.xul&quot;,</span>
<a href="#l8.8"></a><span id="l8.8">     &quot;&quot;,</span>
<a href="#l8.9"></a><span id="l8.9">     &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l8.10"></a><span id="l8.10">     {</span>
<a href="#l8.11"></a><span id="l8.11">       compFields: gMsgCompose.compFields,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      subject: GetMsgSubjectElement().value,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      subject: document.getElementById(&quot;msgSubject&quot;).value,</span>
<a href="#l8.14"></a><span id="l8.14">       smFields: gSMFields,</span>
<a href="#l8.15"></a><span id="l8.15">       isSigningCertAvailable:</span>
<a href="#l8.16"></a><span id="l8.16">         gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;) != &quot;&quot;,</span>
<a href="#l8.17"></a><span id="l8.17">       isEncryptionCertAvailable:</span>
<a href="#l8.18"></a><span id="l8.18">         gCurrentIdentity.getUnicharAttribute(&quot;encryption_cert_name&quot;) != &quot;&quot;,</span>
<a href="#l8.19"></a><span id="l8.19">       currentIdentity: gCurrentIdentity,</span>
<a href="#l8.20"></a><span id="l8.20">     }</span>
<a href="#l8.21"></a><span id="l8.21">   );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -475,8 +475,18 @@ blockedContentPrefLabel=Options</span>
<a href="#l9.4"></a><span id="l9.4"> blockedContentPrefAccesskey=O</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> blockedContentPrefLabelUnix=Preferences</span>
<a href="#l9.7"></a><span id="l9.7"> blockedContentPrefAccesskeyUnix=P</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> ## Identity matching warning notification bar.</span>
<a href="#l9.10"></a><span id="l9.10"> ## LOCALIZATION NOTE(identityWarning): %S will be replaced with the identity name.</span>
<a href="#l9.11"></a><span id="l9.11"> identityWarning=A unique identity matching the From address was not found. The message will be sent using the current From field and settings from identity %S.</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+## Recipient pills fileds.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+## LOCALIZATION NOTE(confirmRemoveRecipientRowTitle): %S will be replaced with the field name.</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+confirmRemoveRecipientRowTitle=Remove %S</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+## LOCALIZATION NOTE(confirmRemoveRecipientRowTitle): %S will be replaced with the field name.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+confirmRemoveRecipientRowBody=All the addresses in the %S field will be removed. Do you want to proceed?</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+## LOCALIZATION NOTE headersSpaceStyle is for aligning label of a newly create recipient row.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+## It should be larger than the largest Header label and identical to &amp;headersSpace2.style;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+headersSpaceStyle=width: 8em</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messengercompose/messengercompose.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -250,28 +250,28 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &lt;!ENTITY spellingButton.tooltip &quot;Check spelling of selection or entire message&quot;&gt;</span>
<a href="#l10.5"></a><span id="l10.5"> &lt;!ENTITY saveButton.tooltip &quot;Save this message&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> &lt;!ENTITY cutButton.tooltip              &quot;Cut&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> &lt;!ENTITY copyButton.tooltip             &quot;Copy&quot;&gt;</span>
<a href="#l10.8"></a><span id="l10.8"> &lt;!ENTITY pasteButton.tooltip            &quot;Paste&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9"> &lt;!ENTITY printButton.tooltip &quot;Print this message&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> &lt;!-- Headers --&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-&lt;!--LOCALIZATION NOTE headersSpace.style is for aligning  the From:, To: and</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+&lt;!--LOCALIZATION NOTE headersSpaces.style is for aligning  the From:, To: and</span>
<a href="#l10.14"></a><span id="l10.14">     Subject: rows. It should be larger than the largest Header label  --&gt;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-&lt;!ENTITY headersSpace.style &quot;width: 9em;&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-&lt;!ENTITY fromAddr.label &quot;From:&quot;&gt;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+&lt;!ENTITY headersSpace2.style &quot;width: 8em;&quot;&gt;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+&lt;!ENTITY fromAddr2.label &quot;From&quot;&gt;</span>
<a href="#l10.19"></a><span id="l10.19"> &lt;!ENTITY fromAddr.accesskey &quot;r&quot;&gt;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-&lt;!ENTITY toAddr.label &quot;To:&quot;&gt;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-&lt;!ENTITY ccAddr.label &quot;Cc:&quot;&gt;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-&lt;!ENTITY bccAddr.label &quot;Bcc:&quot;&gt;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-&lt;!ENTITY replyAddr.label &quot;Reply-To:&quot;&gt;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-&lt;!ENTITY newsgroupsAddr.label &quot;Newsgroup:&quot;&gt;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-&lt;!ENTITY followupAddr.label &quot;Followup-To:&quot;&gt;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-&lt;!ENTITY subject.label &quot;Subject:&quot;&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+&lt;!ENTITY toAddr2.label &quot;To&quot;&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+&lt;!ENTITY ccAddr2.label &quot;Cc&quot;&gt;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+&lt;!ENTITY bccAddr2.label &quot;Bcc&quot;&gt;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+&lt;!ENTITY replyAddr2.label &quot;Reply-To&quot;&gt;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+&lt;!ENTITY newsgroupsAddr2.label &quot;Newsgroup&quot;&gt;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+&lt;!ENTITY followupAddr2.label &quot;Followup-To&quot;&gt;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+&lt;!ENTITY subject2.label &quot;Subject&quot;&gt;</span>
<a href="#l10.34"></a><span id="l10.34"> &lt;!ENTITY subject.accesskey &quot;S&quot;&gt;</span>
<a href="#l10.35"></a><span id="l10.35"> &lt;!-- LOCALIZATION NOTE (attachments.accesskey) This access key character should</span>
<a href="#l10.36"></a><span id="l10.36">      be taken from the strings of attachmentCount in composeMsgs.properties.</span>
<a href="#l10.37"></a><span id="l10.37">      Please ensure that this access key is unique: Do not duplicate any other</span>
<a href="#l10.38"></a><span id="l10.38">      first-level access keys of the compose window, e.g. those of main menu,</span>
<a href="#l10.39"></a><span id="l10.39">      buttons, or labels (message headers, contacts side bar, attachment reminder</span>
<a href="#l10.40"></a><span id="l10.40">      bar). --&gt;</span>
<a href="#l10.41"></a><span id="l10.41"> &lt;!ENTITY attachments.accesskey &quot;m&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/browser/composition/browser_addressWidgets.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/browser/composition/browser_addressWidgets.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -46,31 +46,19 @@ add_task(function setupModule(module) {</span>
<a href="#l11.4"></a><span id="l11.4"> });</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> /**</span>
<a href="#l11.7"></a><span id="l11.7">  * Check if the address type items are in the wished state.</span>
<a href="#l11.8"></a><span id="l11.8">  *</span>
<a href="#l11.9"></a><span id="l11.9">  * @param aItemsEnabled  List of item values that should be enabled (uncollapsed).</span>
<a href="#l11.10"></a><span id="l11.10">  */</span>
<a href="#l11.11"></a><span id="l11.11"> function check_address_types_state(aItemsEnabled) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  let addr_types = cwc</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    .e(&quot;addressingWidget&quot;)</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-    .querySelectorAll(&quot;menuitem[value]&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  let addr_types = cwc.e(&quot;addressingWidgetLabels&quot;).querySelectorAll(&quot;label&quot;);</span>
<a href="#l11.16"></a><span id="l11.16">   for (let item of addr_types) {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-    Assert.ok(</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-      item.collapsed != aItemsEnabled.includes(item.getAttribute(&quot;value&quot;))</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    );</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-  }</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  // Even if the currently selected type is collaped,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  // the containing menulist should never be collapsed.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  let addr_lists = cwc.e(&quot;addressingWidget&quot;).querySelectorAll(&quot;menulist&quot;);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  for (let list in addr_lists) {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-    Assert.ok(!list.collapsed);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-    Assert.ok(!list.disabled);</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+    Assert.ok(item.collapsed != aItemsEnabled.includes(item.id));</span>
<a href="#l11.29"></a><span id="l11.29">   }</span>
<a href="#l11.30"></a><span id="l11.30"> }</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32"> /**</span>
<a href="#l11.33"></a><span id="l11.33">  * With only a POP3 account, no News related address types should be enabled.</span>
<a href="#l11.34"></a><span id="l11.34">  */</span>
<a href="#l11.35"></a><span id="l11.35"> function check_mail_address_types() {</span>
<a href="#l11.36"></a><span id="l11.36">   check_address_types_state([&quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_reply&quot;, &quot;addr_bcc&quot;]);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineat">@@ -157,24 +145,17 @@ add_task(function test_address_types() {</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">   let NNTPidentity = accountNNTP.defaultIdentity.key;</span>
<a href="#l11.40"></a><span id="l11.40">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l11.41"></a><span id="l11.41">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l11.42"></a><span id="l11.42">     { identitykey: NNTPidentity },</span>
<a href="#l11.43"></a><span id="l11.43">   ]);</span>
<a href="#l11.44"></a><span id="l11.44">   check_nntp_address_types();</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  // In a News account, choose &quot;Newsgroup:&quot; as the address type.</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  cwc.click(cwc.eid(&quot;addressCol1#1&quot;));</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  cwc.click_menus_in_sequence(cwc.e(&quot;addressCol1#1&quot;).menupopup, [</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    { value: &quot;addr_newsgroups&quot; },</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  ]);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  check_nntp_address_types();</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-  // And switch back to the POP3 account.</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  // Switch back to the POP3 account.</span>
<a href="#l11.55"></a><span id="l11.55">   let POP3identity = accountPOP3.defaultIdentity.key;</span>
<a href="#l11.56"></a><span id="l11.56">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l11.57"></a><span id="l11.57">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l11.58"></a><span id="l11.58">     { identitykey: POP3identity },</span>
<a href="#l11.59"></a><span id="l11.59">   ]);</span>
<a href="#l11.60"></a><span id="l11.60">   check_nntp_address_types();</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62">   close_compose_window(cwc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/browser/composition/browser_draftIdentity.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/browser/composition/browser_draftIdentity.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -82,17 +82,17 @@ add_task(function setupModule(module) {</span>
<a href="#l12.4"></a><span id="l12.4">  * @return {integer}  The index (position) of the created message in the drafts folder.</span>
<a href="#l12.5"></a><span id="l12.5">  */</span>
<a href="#l12.6"></a><span id="l12.6"> function create_draft(aFrom, aIdKey) {</span>
<a href="#l12.7"></a><span id="l12.7">   let msgCount = gDrafts.getTotalMessages(false);</span>
<a href="#l12.8"></a><span id="l12.8">   let source =</span>
<a href="#l12.9"></a><span id="l12.9">     &quot;From - Wed Mar 01 01:02:03 2017\n&quot; +</span>
<a href="#l12.10"></a><span id="l12.10">     &quot;X-Mozilla-Status: 0000\n&quot; +</span>
<a href="#l12.11"></a><span id="l12.11">     &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    &quot;X-Mozilla-Keys:                                                                                 \n&quot; +</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    &quot;X-Mozilla-Keys:\n&quot; +</span>
<a href="#l12.14"></a><span id="l12.14">     &quot;FCC: mailbox://nobody@Local%20Folders/Sent\n&quot; +</span>
<a href="#l12.15"></a><span id="l12.15">     (aIdKey</span>
<a href="#l12.16"></a><span id="l12.16">       ? // prettier-ignore</span>
<a href="#l12.17"></a><span id="l12.17">         `X-Identity-Key: ${aIdKey}\n` +</span>
<a href="#l12.18"></a><span id="l12.18">         `X-Account-Key: ${gAccount.key}\n`</span>
<a href="#l12.19"></a><span id="l12.19">       : &quot;&quot;) +</span>
<a href="#l12.20"></a><span id="l12.20">     `From: ${aFrom}\n` +</span>
<a href="#l12.21"></a><span id="l12.21">     &quot;To: nobody@example.invalid\n&quot; +</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -129,17 +129,17 @@ function checkCompIdentity(cwc, aIdentit</span>
<a href="#l12.23"></a><span id="l12.23">     &quot;The From account is not correctly selected&quot;</span>
<a href="#l12.24"></a><span id="l12.24">   );</span>
<a href="#l12.25"></a><span id="l12.25">   Assert.equal(</span>
<a href="#l12.26"></a><span id="l12.26">     cwc.window.getCurrentIdentityKey(),</span>
<a href="#l12.27"></a><span id="l12.27">     aIdentityKey,</span>
<a href="#l12.28"></a><span id="l12.28">     &quot;The From identity is not correctly selected&quot;</span>
<a href="#l12.29"></a><span id="l12.29">   );</span>
<a href="#l12.30"></a><span id="l12.30">   Assert.equal(</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    cwc.window.GetMsgIdentityElement().value,</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    cwc.window.document.getElementById(&quot;msgIdentity&quot;).value,</span>
<a href="#l12.33"></a><span id="l12.33">     aFrom,</span>
<a href="#l12.34"></a><span id="l12.34">     &quot;The From value was initialized to an unexpected value&quot;</span>
<a href="#l12.35"></a><span id="l12.35">   );</span>
<a href="#l12.36"></a><span id="l12.36"> }</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38"> /**</span>
<a href="#l12.39"></a><span id="l12.39">  * Bug 394216</span>
<a href="#l12.40"></a><span id="l12.40">  * Test that starting a new message from a draft with various combinations</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/browser/composition/browser_focus.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/browser/composition/browser_focus.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -22,17 +22,17 @@ var { mc } = ChromeUtils.import(</span>
<a href="#l13.4"></a><span id="l13.4">  * elements forward and backward.</span>
<a href="#l13.5"></a><span id="l13.5">  *</span>
<a href="#l13.6"></a><span id="l13.6">  * @param controller the compose window controller</span>
<a href="#l13.7"></a><span id="l13.7">  * @param attachmentsExpanded true if the attachment pane is expanded</span>
<a href="#l13.8"></a><span id="l13.8">  * @param ctrlTab true if we should use Ctrl+Tab to cycle, false if we should</span>
<a href="#l13.9"></a><span id="l13.9">  *                use F6</span>
<a href="#l13.10"></a><span id="l13.10">  */</span>
<a href="#l13.11"></a><span id="l13.11"> function check_element_cycling(controller, attachmentsExpanded, ctrlTab) {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  let addressingElement = controller.e(&quot;addressingWidget&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  let addressingElement = controller.e(&quot;toAddrInput&quot;);</span>
<a href="#l13.14"></a><span id="l13.14">   let subjectElement = controller.e(&quot;msgSubject&quot;);</span>
<a href="#l13.15"></a><span id="l13.15">   let attachmentElement = controller.e(&quot;attachmentBucket&quot;);</span>
<a href="#l13.16"></a><span id="l13.16">   let contentElement = controller.window.content;</span>
<a href="#l13.17"></a><span id="l13.17">   let identityElement = controller.e(&quot;msgIdentity&quot;);</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">   let key = ctrlTab ? &quot;VK_TAB&quot; : &quot;VK_F6&quot;;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">   // We start on the addressing widget and go from there.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/browser/composition/browser_replyAddresses.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/browser/composition/browser_replyAddresses.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -79,44 +79,32 @@ function checkReply(aReplyFunction, aExp</span>
<a href="#l14.4"></a><span id="l14.4">   checkToAddresses(rwc, aExpectedFields);</span>
<a href="#l14.5"></a><span id="l14.5">   close_compose_window(rwc);</span>
<a href="#l14.6"></a><span id="l14.6"> }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> /**</span>
<a href="#l14.9"></a><span id="l14.9">  * Helper to check that the reply window has the expected address fields.</span>
<a href="#l14.10"></a><span id="l14.10">  */</span>
<a href="#l14.11"></a><span id="l14.11"> function checkToAddresses(replyWinController, expectedFields) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  let addressingWidgetItems = replyWinController.window.document.querySelectorAll(</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-    &quot;#addressingWidget .addressingWidgetItem&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  let rows = replyWinController.window.document.querySelectorAll(</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    &quot;#recipientsContainer .address-row:not(.hidden)&quot;</span>
<a href="#l14.16"></a><span id="l14.16">   );</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18">   let obtainedFields = [];</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  for (let i = 0; i &lt; addressingWidgetItems.length; i++) {</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-    let addrTypePopup = addressingWidgetItems[i].querySelector(&quot;menupopup&quot;);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-    let addrTextbox = addressingWidgetItems[i].querySelector(</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-      `input[is=&quot;autocomplete-input&quot;]`</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+  for (let row of rows) {</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+    let addrTextbox = row.querySelector(</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+      `input[is=&quot;autocomplete-input&quot;][recipienttype]`</span>
<a href="#l14.26"></a><span id="l14.26">     );</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-    let selectedIndex = addrTypePopup.parentNode.selectedIndex;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-    let typeMenuitems = addrTypePopup.children;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    let addrType =</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-      selectedIndex != -1</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-        ? typeMenuitems[selectedIndex].value</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-        : typeMenuitems[0].value;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    let addresses = [];</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    for (let pill of row.querySelectorAll(&quot;mail-address-pill&quot;)) {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+      addresses.push(pill.fullAddress);</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+    }</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-    if (!addrTextbox.value) {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-      continue;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-    }</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    let addresses = obtainedFields[addrType];</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    if (addresses) {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-      addresses.push(addrTextbox.value);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-    } else {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-      addresses = [addrTextbox.value];</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-    }</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    obtainedFields[addrType] = addresses;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    obtainedFields[addrTextbox.getAttribute(&quot;recipienttype&quot;)] = addresses;</span>
<a href="#l14.50"></a><span id="l14.50">   }</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52">   // Check what we expect is there.</span>
<a href="#l14.53"></a><span id="l14.53">   for (let type in expectedFields) {</span>
<a href="#l14.54"></a><span id="l14.54">     let expected = expectedFields[type];</span>
<a href="#l14.55"></a><span id="l14.55">     let obtained = obtainedFields[type];</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">     for (let i = 0; i &lt; expected.length; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/browser/composition/browser_sendButton.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/browser/composition/browser_sendButton.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -25,16 +25,17 @@ var {</span>
<a href="#l15.4"></a><span id="l15.4">   click_tree_row,</span>
<a href="#l15.5"></a><span id="l15.5">   FAKE_SERVER_HOSTNAME,</span>
<a href="#l15.6"></a><span id="l15.6">   get_special_folder,</span>
<a href="#l15.7"></a><span id="l15.7"> } = ChromeUtils.import(</span>
<a href="#l15.8"></a><span id="l15.8">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> );</span>
<a href="#l15.10"></a><span id="l15.10"> var {</span>
<a href="#l15.11"></a><span id="l15.11">   clear_recipient,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  get_first_pill,</span>
<a href="#l15.13"></a><span id="l15.13">   close_compose_window,</span>
<a href="#l15.14"></a><span id="l15.14">   open_compose_new_mail,</span>
<a href="#l15.15"></a><span id="l15.15">   setup_msg_contents,</span>
<a href="#l15.16"></a><span id="l15.16">   toggle_recipient_type,</span>
<a href="#l15.17"></a><span id="l15.17"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l15.18"></a><span id="l15.18"> var { wait_for_frame_load } = ChromeUtils.import(</span>
<a href="#l15.19"></a><span id="l15.19">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> );</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -89,55 +90,52 @@ function check_send_commands_state(aCwc,</span>
<a href="#l15.22"></a><span id="l15.22">  * by the user.</span>
<a href="#l15.23"></a><span id="l15.23">  */</span>
<a href="#l15.24"></a><span id="l15.24"> add_task(function test_send_enabled_manual_address() {</span>
<a href="#l15.25"></a><span id="l15.25">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l15.26"></a><span id="l15.26">   // On an empty window, Send must be disabled.</span>
<a href="#l15.27"></a><span id="l15.27">   check_send_commands_state(cwc, false);</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">   // On valid &quot;To:&quot; addressee input, Send must be enabled.</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_to&quot;);</span>
<a href="#l15.31"></a><span id="l15.31">   setup_msg_contents(cwc, &quot; recipient@fake.invalid &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l15.32"></a><span id="l15.32">   check_send_commands_state(cwc, true);</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   // When the addressee is not in To, Cc, Bcc or Newsgroup, disable Send again.</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_reply&quot;);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  clear_recipient(cwc);</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  cwc.click(cwc.eid(&quot;addr_reply&quot;));</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  setup_msg_contents(cwc, &quot; recipient@fake.invalid &quot;, &quot;&quot;, &quot;&quot;, &quot;replyAddrInput&quot;);</span>
<a href="#l15.39"></a><span id="l15.39">   check_send_commands_state(cwc, false);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">   clear_recipient(cwc);</span>
<a href="#l15.42"></a><span id="l15.42">   check_send_commands_state(cwc, false);</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">   // Bug 1296535</span>
<a href="#l15.45"></a><span id="l15.45">   // Try some other invalid and valid recipient strings:</span>
<a href="#l15.46"></a><span id="l15.46">   // - random string that is no email.</span>
<a href="#l15.47"></a><span id="l15.47">   setup_msg_contents(cwc, &quot; recipient@&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l15.48"></a><span id="l15.48">   check_send_commands_state(cwc, false);</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_cc&quot;);</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+  cwc.click(cwc.eid(&quot;addr_cc&quot;));</span>
<a href="#l15.52"></a><span id="l15.52">   check_send_commands_state(cwc, false);</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  // We change focus from recipient type box to recipient input box.</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  // One click on the recipient input box selects the whole typed string (bug 1527547).</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-  cwc.click(cwc.eid(&quot;addressCol2#1&quot;), 200, 5);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-  // On macOS the focus is automatically returned to the input box after operating</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  // the type box and no focus event is fired. So the recipient is not selected</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  // and the caret is after the last typed character (where we left off).</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    // Click subject and then back to recipient input to see that it gets selected.</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-    cwc.click(cwc.eid(&quot;msgSubject&quot;));</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-    cwc.click(cwc.eid(&quot;addressCol2#1&quot;));</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-  }</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-  Assert.equal(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 0);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  // End of selection counts the length of the &quot; recipient@&quot; string from above.</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  Assert.equal(cwc.e(&quot;addressCol2#1&quot;).selectionEnd, 11);</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-  // Another click after the recipient deselects it to allow typing.</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-  cwc.click(cwc.eid(&quot;addressCol2#1&quot;), 200, 5);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-  Assert.equal(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 11);</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  // This types additional characters into the recipient.</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  setup_msg_contents(cwc, &quot;domain.invalid&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  // Select the newly generated pill.</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  cwc.click(get_first_pill(cwc));</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  // Delete the selected pill.</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  cwc.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  // Confirm the address row is now empty.</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  Assert.ok(!get_first_pill(cwc).length);</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  // Confirm the send button is disabled.</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  check_send_commands_state(cwc, false);</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  // Add multiple recipients.</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  setup_msg_contents(</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+    cwc,</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+    &quot;recipient@domain.invalid, info@somedomain.extension, name@incomplete&quot;,</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+    &quot;&quot;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  );</span>
<a href="#l15.88"></a><span id="l15.88">   check_send_commands_state(cwc, true);</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90">   clear_recipient(cwc);</span>
<a href="#l15.91"></a><span id="l15.91">   check_send_commands_state(cwc, false);</span>
<a href="#l15.92"></a><span id="l15.92"> </span>
<a href="#l15.93"></a><span id="l15.93">   // - a mailinglist in addressbook</span>
<a href="#l15.94"></a><span id="l15.94">   // Button is enabled without checking whether it contains valid addresses.</span>
<a href="#l15.95"></a><span id="l15.95">   let defaultAB = MailServices.ab.getDirectory(&quot;jsaddrbook://abook.sqlite&quot;);</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineat">@@ -152,18 +150,19 @@ add_task(function test_send_enabled_manu</span>
<a href="#l15.97"></a><span id="l15.97"> </span>
<a href="#l15.98"></a><span id="l15.98">   setup_msg_contents(cwc, &quot;emptyList &lt;list&gt; &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l15.99"></a><span id="l15.99">   check_send_commands_state(cwc, true);</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101">   clear_recipient(cwc);</span>
<a href="#l15.102"></a><span id="l15.102">   check_send_commands_state(cwc, false);</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">   // - some string as a newsgroup</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_newsgroups&quot;);</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-  setup_msg_contents(cwc, &quot;newsgroup &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  cwc.e(&quot;addr_newsgroups&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+  cwc.click(cwc.eid(&quot;addr_newsgroups&quot;));</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+  setup_msg_contents(cwc, &quot;newsgroup &quot;, &quot;&quot;, &quot;&quot;, &quot;newsgroupsAddrInput&quot;);</span>
<a href="#l15.110"></a><span id="l15.110">   check_send_commands_state(cwc, true);</span>
<a href="#l15.111"></a><span id="l15.111"> </span>
<a href="#l15.112"></a><span id="l15.112">   close_compose_window(cwc);</span>
<a href="#l15.113"></a><span id="l15.113"> });</span>
<a href="#l15.114"></a><span id="l15.114"> </span>
<a href="#l15.115"></a><span id="l15.115"> /**</span>
<a href="#l15.116"></a><span id="l15.116">  * Bug 431217</span>
<a href="#l15.117"></a><span id="l15.117">  * Test that the Send buttons are properly enabled if an addressee is prefilled</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineat">@@ -174,20 +173,19 @@ add_task(function test_send_enabled_pref</span>
<a href="#l15.119"></a><span id="l15.119">   let identity = account.defaultIdentity;</span>
<a href="#l15.120"></a><span id="l15.120">   identity.doCc = true;</span>
<a href="#l15.121"></a><span id="l15.121">   identity.doCcList = &quot;Auto@recipient.invalid&quot;;</span>
<a href="#l15.122"></a><span id="l15.122"> </span>
<a href="#l15.123"></a><span id="l15.123">   // In that case the recipient is input, enabled Send.</span>
<a href="#l15.124"></a><span id="l15.124">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l15.125"></a><span id="l15.125">   check_send_commands_state(cwc, true);</span>
<a href="#l15.126"></a><span id="l15.126"> </span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-  // Press backspace to remove the recipient. No other valid one is there,</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-  // Send should become disabled.</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-  cwc.e(&quot;addressCol2#1&quot;).select();</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  cwc.keypress(null, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  // Clear the CC list.</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  clear_recipient(cwc);</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  // No other pill is there. Send should become disabled.</span>
<a href="#l15.134"></a><span id="l15.134">   check_send_commands_state(cwc, false);</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136">   close_compose_window(cwc);</span>
<a href="#l15.137"></a><span id="l15.137">   identity.doCcList = &quot;&quot;;</span>
<a href="#l15.138"></a><span id="l15.138">   identity.doCc = false;</span>
<a href="#l15.139"></a><span id="l15.139"> });</span>
<a href="#l15.140"></a><span id="l15.140"> </span>
<a href="#l15.141"></a><span id="l15.141"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -6,19 +6,21 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * This tests some commands on messages via the UI. But we specifically check,</span>
<a href="#l16.5"></a><span id="l16.5">  * whether the commands have an effect in the message store on disk, i.e. the</span>
<a href="#l16.6"></a><span id="l16.6">  * markings on the messages are stored in the msgStore, not only in the database.</span>
<a href="#l16.7"></a><span id="l16.7">  * For now, it checks for bug 840418.</span>
<a href="#l16.8"></a><span id="l16.8">  */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> &quot;use strict&quot;;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-var { open_compose_with_forward, open_compose_with_reply } = ChromeUtils.import(</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+var {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  open_compose_with_forward,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  open_compose_with_reply,</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+  setup_msg_contents,</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+} = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l16.20"></a><span id="l16.20"> var {</span>
<a href="#l16.21"></a><span id="l16.21">   be_in_folder,</span>
<a href="#l16.22"></a><span id="l16.22">   create_folder,</span>
<a href="#l16.23"></a><span id="l16.23">   empty_folder,</span>
<a href="#l16.24"></a><span id="l16.24">   get_special_folder,</span>
<a href="#l16.25"></a><span id="l16.25">   make_new_sets_in_folder,</span>
<a href="#l16.26"></a><span id="l16.26">   mc,</span>
<a href="#l16.27"></a><span id="l16.27">   press_delete,</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineat">@@ -218,17 +220,17 @@ function reply_forward_message(aMsgRow, </span>
<a href="#l16.29"></a><span id="l16.29">   let cwc;</span>
<a href="#l16.30"></a><span id="l16.30">   if (aReply) {</span>
<a href="#l16.31"></a><span id="l16.31">     // Reply to the message.</span>
<a href="#l16.32"></a><span id="l16.32">     cwc = open_compose_with_reply();</span>
<a href="#l16.33"></a><span id="l16.33">   } else {</span>
<a href="#l16.34"></a><span id="l16.34">     // Forward the message.</span>
<a href="#l16.35"></a><span id="l16.35">     cwc = open_compose_with_forward();</span>
<a href="#l16.36"></a><span id="l16.36">     // Type in some recipient.</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-    cwc.type(cwc.eid(&quot;addressCol2#1&quot;), &quot;somewhere@host.invalid&quot;);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+    setup_msg_contents(cwc, &quot;somewhere@host.invalid&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l16.39"></a><span id="l16.39">   }</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41">   // Send it later.</span>
<a href="#l16.42"></a><span id="l16.42">   plan_for_window_close(cwc);</span>
<a href="#l16.43"></a><span id="l16.43">   // Ctrl+Shift+Return = Send Later</span>
<a href="#l16.44"></a><span id="l16.44">   cwc.keypress(cwc.eid(&quot;content-frame&quot;), &quot;VK_RETURN&quot;, {</span>
<a href="#l16.45"></a><span id="l16.45">     shiftKey: true,</span>
<a href="#l16.46"></a><span id="l16.46">     accelKey: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-address-widgets.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-address-widgets.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -51,31 +51,19 @@ function setupModule(module) {</span>
<a href="#l17.4"></a><span id="l17.4"> function teardownModule(module) {}</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> /**</span>
<a href="#l17.7"></a><span id="l17.7">  * Check if the address type items are in the wished state.</span>
<a href="#l17.8"></a><span id="l17.8">  *</span>
<a href="#l17.9"></a><span id="l17.9">  * @param aItemsEnabled  List of item values that should be enabled (uncollapsed).</span>
<a href="#l17.10"></a><span id="l17.10">  */</span>
<a href="#l17.11"></a><span id="l17.11"> function check_address_types_state(aItemsEnabled) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  let addr_types = cwc</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    .e(&quot;addressingWidget&quot;)</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-    .querySelectorAll(&quot;menuitem[value]&quot;);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  let addr_types = cwc.e(&quot;addressingWidgetLabels&quot;).querySelectorAll(&quot;label&quot;);</span>
<a href="#l17.16"></a><span id="l17.16">   for (let item of addr_types) {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    assert_true(</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-      item.collapsed != aItemsEnabled.includes(item.getAttribute(&quot;value&quot;))</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-    );</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-  }</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-  // Even if the currently selected type is collaped,</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-  // the containing menulist should never be collapsed.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  let addr_lists = cwc.e(&quot;addressingWidget&quot;).querySelectorAll(&quot;menulist&quot;);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-  for (let list in addr_lists) {</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-    assert_false(list.collapsed);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    assert_false(list.disabled);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+    assert_true(item.collapsed != aItemsEnabled.includes(item.id));</span>
<a href="#l17.29"></a><span id="l17.29">   }</span>
<a href="#l17.30"></a><span id="l17.30"> }</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32"> /**</span>
<a href="#l17.33"></a><span id="l17.33">  * With only a POP3 account, no News related address types should be enabled.</span>
<a href="#l17.34"></a><span id="l17.34">  */</span>
<a href="#l17.35"></a><span id="l17.35"> function check_mail_address_types() {</span>
<a href="#l17.36"></a><span id="l17.36">   check_address_types_state([&quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_reply&quot;, &quot;addr_bcc&quot;]);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineat">@@ -162,24 +150,17 @@ function test_address_types() {</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">   let NNTPidentity = accountNNTP.defaultIdentity.key;</span>
<a href="#l17.40"></a><span id="l17.40">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l17.41"></a><span id="l17.41">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l17.42"></a><span id="l17.42">     { identitykey: NNTPidentity },</span>
<a href="#l17.43"></a><span id="l17.43">   ]);</span>
<a href="#l17.44"></a><span id="l17.44">   check_nntp_address_types();</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-  // In a News account, choose &quot;Newsgroup:&quot; as the address type.</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  cwc.click(cwc.eid(&quot;addressCol1#1&quot;));</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-  cwc.click_menus_in_sequence(cwc.e(&quot;addressCol1#1&quot;).menupopup, [</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    { value: &quot;addr_newsgroups&quot; },</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-  ]);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  check_nntp_address_types();</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-  // And switch back to the POP3 account.</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+  // Switch back to the POP3 account.</span>
<a href="#l17.55"></a><span id="l17.55">   let POP3identity = accountPOP3.defaultIdentity.key;</span>
<a href="#l17.56"></a><span id="l17.56">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l17.57"></a><span id="l17.57">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l17.58"></a><span id="l17.58">     { identitykey: POP3identity },</span>
<a href="#l17.59"></a><span id="l17.59">   ]);</span>
<a href="#l17.60"></a><span id="l17.60">   check_nntp_address_types();</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62">   close_compose_window(cwc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-draft-identity.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-draft-identity.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -130,17 +130,17 @@ function checkCompIdentity(cwc, aIdentit</span>
<a href="#l18.4"></a><span id="l18.4">     &quot;The From account is not correctly selected&quot;</span>
<a href="#l18.5"></a><span id="l18.5">   );</span>
<a href="#l18.6"></a><span id="l18.6">   assert_equals(</span>
<a href="#l18.7"></a><span id="l18.7">     cwc.window.getCurrentIdentityKey(),</span>
<a href="#l18.8"></a><span id="l18.8">     aIdentityKey,</span>
<a href="#l18.9"></a><span id="l18.9">     &quot;The From identity is not correctly selected&quot;</span>
<a href="#l18.10"></a><span id="l18.10">   );</span>
<a href="#l18.11"></a><span id="l18.11">   assert_equals(</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    cwc.window.GetMsgIdentityElement().value,</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    cwc.window.document.getElementById(&quot;msgIdentity&quot;).value,</span>
<a href="#l18.14"></a><span id="l18.14">     aFrom,</span>
<a href="#l18.15"></a><span id="l18.15">     &quot;The From value was initialized to an unexpected value&quot;</span>
<a href="#l18.16"></a><span id="l18.16">   );</span>
<a href="#l18.17"></a><span id="l18.17"> }</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> /**</span>
<a href="#l18.20"></a><span id="l18.20">  * Bug 394216</span>
<a href="#l18.21"></a><span id="l18.21">  * Test that starting a new message from a draft with various combinations</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-focus.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-focus.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -22,17 +22,17 @@ var { assert_equals, mc } = ChromeUtils.</span>
<a href="#l19.4"></a><span id="l19.4">  * elements forward and backward.</span>
<a href="#l19.5"></a><span id="l19.5">  *</span>
<a href="#l19.6"></a><span id="l19.6">  * @param controller the compose window controller</span>
<a href="#l19.7"></a><span id="l19.7">  * @param attachmentsExpanded true if the attachment pane is expanded</span>
<a href="#l19.8"></a><span id="l19.8">  * @param ctrlTab true if we should use Ctrl+Tab to cycle, false if we should</span>
<a href="#l19.9"></a><span id="l19.9">  *                use F6</span>
<a href="#l19.10"></a><span id="l19.10">  */</span>
<a href="#l19.11"></a><span id="l19.11"> function check_element_cycling(controller, attachmentsExpanded, ctrlTab) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  let addressingElement = controller.e(&quot;addressingWidget&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  let addressingElement = controller.e(&quot;toAddrInput&quot;);</span>
<a href="#l19.14"></a><span id="l19.14">   let subjectElement = controller.e(&quot;msgSubject&quot;);</span>
<a href="#l19.15"></a><span id="l19.15">   let attachmentElement = controller.e(&quot;attachmentBucket&quot;);</span>
<a href="#l19.16"></a><span id="l19.16">   let contentElement = controller.window.content;</span>
<a href="#l19.17"></a><span id="l19.17">   let identityElement = controller.e(&quot;msgIdentity&quot;);</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   let key = ctrlTab ? &quot;VK_TAB&quot; : &quot;VK_F6&quot;;</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21">   // We start on the addressing widget and go from there.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -78,44 +78,32 @@ function checkReply(aReplyFunction, aExp</span>
<a href="#l20.4"></a><span id="l20.4">   checkToAddresses(rwc, aExpectedFields);</span>
<a href="#l20.5"></a><span id="l20.5">   close_compose_window(rwc);</span>
<a href="#l20.6"></a><span id="l20.6"> }</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> /**</span>
<a href="#l20.9"></a><span id="l20.9">  * Helper to check that the reply window has the expected address fields.</span>
<a href="#l20.10"></a><span id="l20.10">  */</span>
<a href="#l20.11"></a><span id="l20.11"> function checkToAddresses(replyWinController, expectedFields) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  let addressingWidgetItems = replyWinController.window.document.querySelectorAll(</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-    &quot;#addressingWidget .addressingWidgetItem&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  let rows = replyWinController.window.document.querySelectorAll(</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+    &quot;#recipientsContainer .address-row:not(.hidden)&quot;</span>
<a href="#l20.16"></a><span id="l20.16">   );</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">   let obtainedFields = [];</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  for (let i = 0; i &lt; addressingWidgetItems.length; i++) {</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-    let addrTypePopup = addressingWidgetItems[i].querySelector(&quot;menupopup&quot;);</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-    let addrTextbox = addressingWidgetItems[i].querySelector(</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-      `input[is=&quot;autocomplete-input&quot;]`</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+  for (let row of rows) {</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+    let addrTextbox = row.querySelector(</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+      `input[is=&quot;autocomplete-input&quot;][recipienttype]`</span>
<a href="#l20.26"></a><span id="l20.26">     );</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-    let selectedIndex = addrTypePopup.parentNode.selectedIndex;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-    let typeMenuitems = addrTypePopup.children;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-    let addrType =</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-      selectedIndex != -1</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-        ? typeMenuitems[selectedIndex].value</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-        : typeMenuitems[0].value;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+    let addresses = [];</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+    for (let pill of row.querySelectorAll(&quot;mail-address-pill&quot;)) {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+      addresses.push(pill.fullAddress);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    }</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-    if (!addrTextbox.value) {</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-      continue;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    }</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-    let addresses = obtainedFields[addrType];</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-    if (addresses) {</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-      addresses.push(addrTextbox.value);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-    } else {</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-      addresses = [addrTextbox.value];</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-    }</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-    obtainedFields[addrType] = addresses;</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+    obtainedFields[addrTextbox.getAttribute(&quot;recipienttype&quot;)] = addresses;</span>
<a href="#l20.50"></a><span id="l20.50">   }</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52">   // Check what we expect is there.</span>
<a href="#l20.53"></a><span id="l20.53">   for (let type in expectedFields) {</span>
<a href="#l20.54"></a><span id="l20.54">     let expected = expectedFields[type];</span>
<a href="#l20.55"></a><span id="l20.55">     let obtained = obtainedFields[type];</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57">     for (let i = 0; i &lt; expected.length; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -28,16 +28,17 @@ var {</span>
<a href="#l21.4"></a><span id="l21.4">   click_tree_row,</span>
<a href="#l21.5"></a><span id="l21.5">   FAKE_SERVER_HOSTNAME,</span>
<a href="#l21.6"></a><span id="l21.6">   get_special_folder,</span>
<a href="#l21.7"></a><span id="l21.7"> } = ChromeUtils.import(</span>
<a href="#l21.8"></a><span id="l21.8">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> );</span>
<a href="#l21.10"></a><span id="l21.10"> var {</span>
<a href="#l21.11"></a><span id="l21.11">   clear_recipient,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+  get_first_pill,</span>
<a href="#l21.13"></a><span id="l21.13">   close_compose_window,</span>
<a href="#l21.14"></a><span id="l21.14">   open_compose_new_mail,</span>
<a href="#l21.15"></a><span id="l21.15">   setup_msg_contents,</span>
<a href="#l21.16"></a><span id="l21.16">   toggle_recipient_type,</span>
<a href="#l21.17"></a><span id="l21.17"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l21.18"></a><span id="l21.18"> var { wait_for_frame_load } = ChromeUtils.import(</span>
<a href="#l21.19"></a><span id="l21.19">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l21.20"></a><span id="l21.20"> );</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineat">@@ -98,55 +99,53 @@ function check_send_commands_state(aCwc,</span>
<a href="#l21.22"></a><span id="l21.22">  * by the user.</span>
<a href="#l21.23"></a><span id="l21.23">  */</span>
<a href="#l21.24"></a><span id="l21.24"> function test_send_enabled_manual_address() {</span>
<a href="#l21.25"></a><span id="l21.25">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l21.26"></a><span id="l21.26">   // On an empty window, Send must be disabled.</span>
<a href="#l21.27"></a><span id="l21.27">   check_send_commands_state(cwc, false);</span>
<a href="#l21.28"></a><span id="l21.28"> </span>
<a href="#l21.29"></a><span id="l21.29">   // On valid &quot;To:&quot; addressee input, Send must be enabled.</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_to&quot;);</span>
<a href="#l21.31"></a><span id="l21.31">   setup_msg_contents(cwc, &quot; recipient@fake.invalid &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l21.32"></a><span id="l21.32">   check_send_commands_state(cwc, true);</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34">   // When the addressee is not in To, Cc, Bcc or Newsgroup, disable Send again.</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_reply&quot;);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+  clear_recipient(cwc);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+  cwc.click(cwc.eid(&quot;addr_reply&quot;));</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+  setup_msg_contents(cwc, &quot; recipient@fake.invalid &quot;, &quot;&quot;, &quot;&quot;, &quot;replyAddrInput&quot;);</span>
<a href="#l21.39"></a><span id="l21.39">   check_send_commands_state(cwc, false);</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41">   clear_recipient(cwc);</span>
<a href="#l21.42"></a><span id="l21.42">   check_send_commands_state(cwc, false);</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44">   // Bug 1296535</span>
<a href="#l21.45"></a><span id="l21.45">   // Try some other invalid and valid recipient strings:</span>
<a href="#l21.46"></a><span id="l21.46">   // - random string that is no email.</span>
<a href="#l21.47"></a><span id="l21.47">   setup_msg_contents(cwc, &quot; recipient@&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l21.48"></a><span id="l21.48">   check_send_commands_state(cwc, false);</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_cc&quot;);</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+  cwc.click(cwc.eid(&quot;addr_cc&quot;));</span>
<a href="#l21.52"></a><span id="l21.52">   check_send_commands_state(cwc, false);</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  // We change focus from recipient type box to recipient input box.</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  // One click on the recipient input box selects the whole typed string (bug 1527547).</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  cwc.click(cwc.eid(&quot;addressCol2#1&quot;), 200, 5);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  // On macOS the focus is automatically returned to the input box after operating</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-  // the type box and no focus event is fired. So the recipient is not selected</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  // and the caret is after the last typed character (where we left off).</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-  if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-    // Click subject and then back to recipient input to see that it gets selected.</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-    cwc.click(cwc.eid(&quot;msgSubject&quot;));</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-    cwc.click(cwc.eid(&quot;addressCol2#1&quot;));</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  }</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-  assert_equals(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 0);</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  // End of selection counts the length of the &quot; recipient@&quot; string from above.</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  assert_equals(cwc.e(&quot;addressCol2#1&quot;).selectionEnd, 11);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-  // Another click after the recipient deselects it to allow typing.</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-  cwc.click(cwc.eid(&quot;addressCol2#1&quot;), 200, 5);</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-  assert_equals(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 11);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  // This types additional characters into the recipient.</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-  setup_msg_contents(cwc, &quot;domain.invalid&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+  // Select the newly generated pill.</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+  cwc.click(get_first_pill(cwc));</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  // Delete the selected pill.</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+  cwc.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+  // Confirm the address row is now empty.</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+  assert_true(!get_first_pill(cwc).length);</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+  // Confirm the send button is disabled.</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+  check_send_commands_state(cwc, false);</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+  // Add multiple recipients.</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+  setup_msg_contents(</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+    cwc,</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+    &quot;recipient@domain.invalid, info@somedomain.extension, name@incomplete&quot;,</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+    &quot;&quot;</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+  );</span>
<a href="#l21.89"></a><span id="l21.89">   check_send_commands_state(cwc, true);</span>
<a href="#l21.90"></a><span id="l21.90"> </span>
<a href="#l21.91"></a><span id="l21.91">   clear_recipient(cwc);</span>
<a href="#l21.92"></a><span id="l21.92">   check_send_commands_state(cwc, false);</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94">   // - a mailinglist in addressbook</span>
<a href="#l21.95"></a><span id="l21.95">   // Button is enabled without checking whether it contains valid addresses.</span>
<a href="#l21.96"></a><span id="l21.96">   let defaultAB = MailServices.ab.getDirectory(&quot;jsaddrbook://abook.sqlite&quot;);</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineat">@@ -161,18 +160,19 @@ function test_send_enabled_manual_addres</span>
<a href="#l21.98"></a><span id="l21.98"> </span>
<a href="#l21.99"></a><span id="l21.99">   setup_msg_contents(cwc, &quot;emptyList &lt;list&gt; &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l21.100"></a><span id="l21.100">   check_send_commands_state(cwc, true);</span>
<a href="#l21.101"></a><span id="l21.101"> </span>
<a href="#l21.102"></a><span id="l21.102">   clear_recipient(cwc);</span>
<a href="#l21.103"></a><span id="l21.103">   check_send_commands_state(cwc, false);</span>
<a href="#l21.104"></a><span id="l21.104"> </span>
<a href="#l21.105"></a><span id="l21.105">   // - some string as a newsgroup</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-  toggle_recipient_type(cwc, &quot;addr_newsgroups&quot;);</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-  setup_msg_contents(cwc, &quot;newsgroup &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+  cwc.e(&quot;addr_newsgroups&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+  cwc.click(cwc.eid(&quot;addr_newsgroups&quot;));</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+  setup_msg_contents(cwc, &quot;newsgroup &quot;, &quot;&quot;, &quot;&quot;, &quot;newsgroupsAddrInput&quot;);</span>
<a href="#l21.111"></a><span id="l21.111">   check_send_commands_state(cwc, true);</span>
<a href="#l21.112"></a><span id="l21.112"> </span>
<a href="#l21.113"></a><span id="l21.113">   close_compose_window(cwc);</span>
<a href="#l21.114"></a><span id="l21.114"> }</span>
<a href="#l21.115"></a><span id="l21.115"> </span>
<a href="#l21.116"></a><span id="l21.116"> /**</span>
<a href="#l21.117"></a><span id="l21.117">  * Bug 431217</span>
<a href="#l21.118"></a><span id="l21.118">  * Test that the Send buttons are properly enabled if an addressee is prefilled</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineat">@@ -183,20 +183,19 @@ function test_send_enabled_prefilled_add</span>
<a href="#l21.120"></a><span id="l21.120">   let identity = account.defaultIdentity;</span>
<a href="#l21.121"></a><span id="l21.121">   identity.doCc = true;</span>
<a href="#l21.122"></a><span id="l21.122">   identity.doCcList = &quot;Auto@recipient.invalid&quot;;</span>
<a href="#l21.123"></a><span id="l21.123"> </span>
<a href="#l21.124"></a><span id="l21.124">   // In that case the recipient is input, enabled Send.</span>
<a href="#l21.125"></a><span id="l21.125">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l21.126"></a><span id="l21.126">   check_send_commands_state(cwc, true);</span>
<a href="#l21.127"></a><span id="l21.127"> </span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-  // Press backspace to remove the recipient. No other valid one is there,</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-  // Send should become disabled.</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-  cwc.e(&quot;addressCol2#1&quot;).select();</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineminus">-  cwc.keypress(null, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+  // Clear the CC list.</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+  clear_recipient(cwc);</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineplus">+  // No other pill is there. Send should become disabled.</span>
<a href="#l21.135"></a><span id="l21.135">   check_send_commands_state(cwc, false);</span>
<a href="#l21.136"></a><span id="l21.136"> </span>
<a href="#l21.137"></a><span id="l21.137">   close_compose_window(cwc);</span>
<a href="#l21.138"></a><span id="l21.138">   identity.doCcList = &quot;&quot;;</span>
<a href="#l21.139"></a><span id="l21.139">   identity.doCc = false;</span>
<a href="#l21.140"></a><span id="l21.140"> }</span>
<a href="#l21.141"></a><span id="l21.141"> </span>
<a href="#l21.142"></a><span id="l21.142"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -6,19 +6,21 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * This tests some commands on messages via the UI. But we specifically check,</span>
<a href="#l22.5"></a><span id="l22.5">  * whether the commands have an effect in the message store on disk, i.e. the</span>
<a href="#l22.6"></a><span id="l22.6">  * markings on the messages are stored in the msgStore, not only in the database.</span>
<a href="#l22.7"></a><span id="l22.7">  * For now, it checks for bug 840418.</span>
<a href="#l22.8"></a><span id="l22.8">  */</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> &quot;use strict&quot;;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var { open_compose_with_forward, open_compose_with_reply } = ChromeUtils.import(</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+var {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+  open_compose_with_forward,</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+  open_compose_with_reply,</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+  setup_msg_contents,</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+} = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l22.20"></a><span id="l22.20"> var {</span>
<a href="#l22.21"></a><span id="l22.21">   assert_equals,</span>
<a href="#l22.22"></a><span id="l22.22">   assert_false,</span>
<a href="#l22.23"></a><span id="l22.23">   assert_not_equals,</span>
<a href="#l22.24"></a><span id="l22.24">   assert_true,</span>
<a href="#l22.25"></a><span id="l22.25">   be_in_folder,</span>
<a href="#l22.26"></a><span id="l22.26">   create_folder,</span>
<a href="#l22.27"></a><span id="l22.27">   empty_folder,</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineat">@@ -222,17 +224,17 @@ function reply_forward_message(aMsgRow, </span>
<a href="#l22.29"></a><span id="l22.29">   let cwc;</span>
<a href="#l22.30"></a><span id="l22.30">   if (aReply) {</span>
<a href="#l22.31"></a><span id="l22.31">     // Reply to the message.</span>
<a href="#l22.32"></a><span id="l22.32">     cwc = open_compose_with_reply();</span>
<a href="#l22.33"></a><span id="l22.33">   } else {</span>
<a href="#l22.34"></a><span id="l22.34">     // Forward the message.</span>
<a href="#l22.35"></a><span id="l22.35">     cwc = open_compose_with_forward();</span>
<a href="#l22.36"></a><span id="l22.36">     // Type in some recipient.</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-    cwc.type(cwc.eid(&quot;addressCol2#1&quot;), &quot;somewhere@host.invalid&quot;);</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+    setup_msg_contents(cwc, &quot;somewhere@host.invalid&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l22.39"></a><span id="l22.39">   }</span>
<a href="#l22.40"></a><span id="l22.40"> </span>
<a href="#l22.41"></a><span id="l22.41">   // Send it later.</span>
<a href="#l22.42"></a><span id="l22.42">   plan_for_window_close(cwc);</span>
<a href="#l22.43"></a><span id="l22.43">   // Ctrl+Shift+Return = Send Later</span>
<a href="#l22.44"></a><span id="l22.44">   cwc.keypress(cwc.eid(&quot;content-frame&quot;), &quot;VK_RETURN&quot;, {</span>
<a href="#l22.45"></a><span id="l22.45">     shiftKey: true,</span>
<a href="#l22.46"></a><span id="l22.46">     accelKey: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -163,17 +163,17 @@ function test_reply_matching_only_delive</span>
<a href="#l23.4"></a><span id="l23.4">   be_in_folder(testFolder);</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6">   let msg = select_click_row(1);</span>
<a href="#l23.7"></a><span id="l23.7">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">   let replyWin = open_compose_with_reply();</span>
<a href="#l23.10"></a><span id="l23.10">   // Should have selected the second id, which is listed in Delivered-To:.</span>
<a href="#l23.11"></a><span id="l23.11">   checkReply(replyWin, identity2Email);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  close_compose_window(replyWin);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  close_compose_window(replyWin, false /* no prompt*/);</span>
<a href="#l23.14"></a><span id="l23.14"> }</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16"> function test_reply_matching_subaddress() {</span>
<a href="#l23.17"></a><span id="l23.17">   be_in_folder(testFolder);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19">   let msg = select_click_row(2);</span>
<a href="#l23.20"></a><span id="l23.20">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l23.21"></a><span id="l23.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/ComposeHelpers.jsm</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/ComposeHelpers.jsm</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -13,16 +13,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l24.4"></a><span id="l24.4">   &quot;open_compose_with_forward_as_attachments&quot;,</span>
<a href="#l24.5"></a><span id="l24.5">   &quot;open_compose_with_edit_as_new&quot;,</span>
<a href="#l24.6"></a><span id="l24.6">   &quot;open_compose_with_element_click&quot;,</span>
<a href="#l24.7"></a><span id="l24.7">   &quot;open_compose_from_draft&quot;,</span>
<a href="#l24.8"></a><span id="l24.8">   &quot;close_compose_window&quot;,</span>
<a href="#l24.9"></a><span id="l24.9">   &quot;wait_for_compose_window&quot;,</span>
<a href="#l24.10"></a><span id="l24.10">   &quot;setup_msg_contents&quot;,</span>
<a href="#l24.11"></a><span id="l24.11">   &quot;clear_recipient&quot;,</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  &quot;get_first_pill&quot;,</span>
<a href="#l24.13"></a><span id="l24.13">   &quot;toggle_recipient_type&quot;,</span>
<a href="#l24.14"></a><span id="l24.14">   &quot;create_msg_attachment&quot;,</span>
<a href="#l24.15"></a><span id="l24.15">   &quot;add_attachments&quot;,</span>
<a href="#l24.16"></a><span id="l24.16">   &quot;add_cloud_attachments&quot;,</span>
<a href="#l24.17"></a><span id="l24.17">   &quot;delete_attachment&quot;,</span>
<a href="#l24.18"></a><span id="l24.18">   &quot;get_compose_body&quot;,</span>
<a href="#l24.19"></a><span id="l24.19">   &quot;type_in_composer&quot;,</span>
<a href="#l24.20"></a><span id="l24.20">   &quot;assert_previous_text&quot;,</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineat">@@ -312,37 +313,59 @@ function wait_for_compose_window(aContro</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23"> /**</span>
<a href="#l24.24"></a><span id="l24.24">  * Fills in the given message recipient/subject/body into the right widgets.</span>
<a href="#l24.25"></a><span id="l24.25">  *</span>
<a href="#l24.26"></a><span id="l24.26">  * @param aCwc   Compose window controller.</span>
<a href="#l24.27"></a><span id="l24.27">  * @param aAddr  Recipient to fill in.</span>
<a href="#l24.28"></a><span id="l24.28">  * @param aSubj  Subject to fill in.</span>
<a href="#l24.29"></a><span id="l24.29">  * @param aBody  Message body to fill in.</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+ * @param inputID  The input field to fill in.</span>
<a href="#l24.31"></a><span id="l24.31">  */</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-function setup_msg_contents(aCwc, aAddr, aSubj, aBody) {</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  aCwc.type(aCwc.eid(&quot;addressCol2#1&quot;), aAddr);</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+function setup_msg_contents(</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  aCwc,</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  aAddr,</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+  aSubj,</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+  aBody,</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+  inputID = &quot;toAddrInput&quot;</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+) {</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+  aCwc.type(aCwc.eid(inputID), aAddr);</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+  aCwc.keypress(aCwc.eid(inputID), &quot;VK_RETURN&quot;, {});</span>
<a href="#l24.43"></a><span id="l24.43">   aCwc.type(aCwc.eid(&quot;msgSubject&quot;), aSubj);</span>
<a href="#l24.44"></a><span id="l24.44">   aCwc.type(aCwc.eid(&quot;content-frame&quot;), aBody);</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+  // Wait 1 second for the pill to be created.</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+  aCwc.sleep(1000);</span>
<a href="#l24.48"></a><span id="l24.48"> }</span>
<a href="#l24.49"></a><span id="l24.49"> </span>
<a href="#l24.50"></a><span id="l24.50"> /**</span>
<a href="#l24.51"></a><span id="l24.51">  * Remove the recipient by typing backspaces.</span>
<a href="#l24.52"></a><span id="l24.52">  *</span>
<a href="#l24.53"></a><span id="l24.53">  * @param aController    Compose window controller.</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">- * @param aRecipientRow  The compose widget row containing recipient to remove.</span>
<a href="#l24.55"></a><span id="l24.55">  */</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-function clear_recipient(aController, aRecipientRow = 1) {</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  let recipientElem = aController.window.awGetInputElement(aRecipientRow);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-  while (recipientElem.value != &quot;&quot;) {</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-    aController.keypress(new elib.Elem(recipientElem), &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+function clear_recipient(aController) {</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+  for (let pill of aController.window.document.querySelectorAll(</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+    &quot;mail-address-pill&quot;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+  )) {</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+    aController.keypress(new elib.Elem(pill), &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l24.65"></a><span id="l24.65">   }</span>
<a href="#l24.66"></a><span id="l24.66"> }</span>
<a href="#l24.67"></a><span id="l24.67"> </span>
<a href="#l24.68"></a><span id="l24.68"> /**</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+ * Return the first available recipient pill.</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+ *</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+ * @param aController - Compose window controller.</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+ */</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+function get_first_pill(aController) {</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+  return new elib.Elem(</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+    aController.window.document.querySelector(&quot;mail-address-pill&quot;)</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+  );</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+}</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+/**</span>
<a href="#l24.80"></a><span id="l24.80">  * Change recipient type in compose widget.</span>
<a href="#l24.81"></a><span id="l24.81">  *</span>
<a href="#l24.82"></a><span id="l24.82">  * @param aController    Compose window controller.</span>
<a href="#l24.83"></a><span id="l24.83">  * @param aType          The recipient type, e.g. &quot;addr_to&quot;.</span>
<a href="#l24.84"></a><span id="l24.84">  * @param aRecipientRow  The compose widget row containing recipient to remove.</span>
<a href="#l24.85"></a><span id="l24.85">  */</span>
<a href="#l24.86"></a><span id="l24.86"> function toggle_recipient_type(aController, aType, aRecipientRow = 1) {</span>
<a href="#l24.87"></a><span id="l24.87">   let addrType = aController.window.awGetPopupElement(aRecipientRow);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/themes/linux/mail/compose/messengercompose.css</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/themes/linux/mail/compose/messengercompose.css</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -131,144 +131,32 @@ menulist:-moz-locale-dir(rtl) &gt; .menulis</span>
<a href="#l25.4"></a><span id="l25.4">   padding-inline-end: 2px;</span>
<a href="#l25.5"></a><span id="l25.5"> }</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> #attachmentBucketCloseButton {</span>
<a href="#l25.8"></a><span id="l25.8">   padding: 0 1px;</span>
<a href="#l25.9"></a><span id="l25.9"> }</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> #subjectLabel {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+  margin-bottom: 0;</span>
<a href="#l25.13"></a><span id="l25.13">   margin-inline-end: 6px;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-  padding-bottom: 1px;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-}</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-#subject-box {</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-  margin-inline-start: -2px;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-}</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-#msgSubject {</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-  margin-top: 0;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-  margin-inline-start: 6px;</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  margin-inline-end: 5px;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-  background-color: inherit;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-  border-bottom-color: var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-  padding: 3px 2px;</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-  padding-inline-start: 5px !important;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-}</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-#msgSubject:hover,</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-#msgSubject:focus {</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-  background-color: -moz-field;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-  border-color: var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l25.38"></a><span id="l25.38"> }</span>
<a href="#l25.39"></a><span id="l25.39"> </span>
<a href="#l25.40"></a><span id="l25.40"> /* ::::: autocomplete icons ::::: */</span>
<a href="#l25.41"></a><span id="l25.41"> </span>
<a href="#l25.42"></a><span id="l25.42"> .ac-site-icon {</span>
<a href="#l25.43"></a><span id="l25.43">   display: -moz-box;</span>
<a href="#l25.44"></a><span id="l25.44">   margin: 1px 5px;</span>
<a href="#l25.45"></a><span id="l25.45"> }</span>
<a href="#l25.46"></a><span id="l25.46"> </span>
<a href="#l25.47"></a><span id="l25.47"> .autocomplete-richlistitem[type=&quot;subscribed-news&quot;] &gt; .ac-site-icon {</span>
<a href="#l25.48"></a><span id="l25.48">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l25.49"></a><span id="l25.49">   -moz-image-region: rect(208px 16px 224px 0);</span>
<a href="#l25.50"></a><span id="l25.50"> }</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-/* ::::: addressing widget ::::: */</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-#addressingWidget {</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-  -moz-user-focus: none;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-  width: 0;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-  margin-top: 0;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-  margin-bottom: 0;</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-  padding-inline-end: 1px;</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-  border: none;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-  background-color: transparent;</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-}</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-.addressingWidgetItem,</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-.dummy-row {</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-  background-color: transparent !important;</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-  color: inherit !important;</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-}</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-.textbox-addressingWidget,</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-.dummy-row-cell:last-child {</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-  padding: 3px 2px !important;</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-  padding-inline-start: 5px !important;</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-  border: solid 1px transparent !important;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-  border-bottom-color: var(--toolbarbutton-hover-bordercolor) !important;</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">- }</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-.addressingWidgetCell:nth-child(2),</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-.dummy-row-cell:nth-child(2) {</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-  border-bottom-color: transparent;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-}</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-.textbox-addressingWidget:focus,</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-.textbox-addressingWidget:hover {</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-  background-color: -moz-field;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-  border-color: var(--toolbarbutton-hover-bordercolor) !important;</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-}</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-.deleteAddress {</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-  margin-inline-start: 0;</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-  margin-bottom: initial;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-}</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-.addressingWidgetCell:hover &gt; .aw-menulist:not([open=&quot;true&quot;]) + .deleteAddress {</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-  margin-inline-start: 5px;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-  width: 18px;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-}</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-.aw-menulist {</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-  font: inherit;</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-  margin: 0;</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-  margin-inline-start: 1px;</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-  margin-inline-end: 7px;</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-  padding-inline-end: 0;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-  outline: 1px solid transparent;</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-  outline-offset: -3px;</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-}</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-.aw-menulist &gt; .menulist-label-box {</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-  margin: -3px 1px;</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-  padding-inline-start: 12px;</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-  padding-inline-end: 0;</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-  background-position: left;</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-}</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-.aw-menulist:-moz-locale-dir(rtl) &gt; .menulist-label-box {</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-  background-position: right;</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-}</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-.aw-menulist:focus {</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-  outline-color: -moz-DialogText;</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-  outline-style: dotted;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-}</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-.aw-menulist &gt; .menulist-label-box &gt; .menulist-label {</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-  margin: 0 3px !important;</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-  text-align: end;</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-}</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-.aw-menulist &gt; .menulist-label-box &gt; .menulist-icon {</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-  margin-inline-start: 2px;</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-}</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-.aw-menulist &gt; .menulist-dropmarker {</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-  height: 11px;</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-}</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-</span>
<a href="#l25.141"></a><span id="l25.141"> #composeContentBox {</span>
<a href="#l25.142"></a><span id="l25.142">   background-color: -moz-dialog;</span>
<a href="#l25.143"></a><span id="l25.143">   box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2) inset;</span>
<a href="#l25.144"></a><span id="l25.144"> }</span>
<a href="#l25.145"></a><span id="l25.145"> </span>
<a href="#l25.146"></a><span id="l25.146"> #composeContentBox:-moz-window-inactive {</span>
<a href="#l25.147"></a><span id="l25.147">   box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1) inset;</span>
<a href="#l25.148"></a><span id="l25.148"> }</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineat">@@ -291,59 +179,46 @@ menulist:-moz-locale-dir(rtl) &gt; .menulis</span>
<a href="#l25.150"></a><span id="l25.150">   text-shadow: none;</span>
<a href="#l25.151"></a><span id="l25.151">   padding-top: 3px;</span>
<a href="#l25.152"></a><span id="l25.152"> }</span>
<a href="#l25.153"></a><span id="l25.153"> </span>
<a href="#l25.154"></a><span id="l25.154"> #addresses-box {</span>
<a href="#l25.155"></a><span id="l25.155">   padding-top: 4px;</span>
<a href="#l25.156"></a><span id="l25.156"> }</span>
<a href="#l25.157"></a><span id="l25.157"> </span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+.address-label-container {</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+  padding-top: 6px;</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+}</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+.address-pill {</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+  padding-block: 2px;</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+}</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+.address-pill label {</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+  margin-block: 0;</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+}</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineplus">+</span>
<a href="#l25.170"></a><span id="l25.170"> #identityLabel-box {</span>
<a href="#l25.171"></a><span id="l25.171">   margin-top: 1px;</span>
<a href="#l25.172"></a><span id="l25.172"> }</span>
<a href="#l25.173"></a><span id="l25.173"> </span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-#identityLabel {</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-  margin-inline-end: 8px</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-}</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-</span>
<a href="#l25.179"></a><span id="l25.179"> #msgIdentity {</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineminus">-  margin-right: 5px;</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-  margin-bottom: 0;</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-  padding-top: 2px;</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-  padding-bottom: 2px;</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-  padding-inline-start: 2px;</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-  padding-inline-end: 20px;</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-  font: inherit;</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-  border-bottom-color: var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineminus">-  background-color: transparent;</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+  margin-block: 2px 0;</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+  padding-block: 4px;</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+  padding-inline: 2px 20px;</span>
<a href="#l25.195"></a><span id="l25.195">   background-repeat: no-repeat;</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineminus">-  background-position: calc( 100% - 5px);</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineplus">+  background-position: calc(100% - 5px);</span>
<a href="#l25.198"></a><span id="l25.198">   background-size: 9px 7px;</span>
<a href="#l25.199"></a><span id="l25.199">   background-image: url(&quot;chrome://messenger/skin/icons/toolbarbutton-arrow.svg&quot;);</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineminus">-  -moz-context-properties: fill;</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineminus">-  fill: currentColor;</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l25.203"></a><span id="l25.203"> }</span>
<a href="#l25.204"></a><span id="l25.204"> </span>
<a href="#l25.205"></a><span id="l25.205"> #msgIdentity:-moz-locale-dir(rtl) {</span>
<a href="#l25.206"></a><span id="l25.206">   background-position: 5px;</span>
<a href="#l25.207"></a><span id="l25.207"> }</span>
<a href="#l25.208"></a><span id="l25.208"> </span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-#msgIdentity:hover,</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineminus">-#msgIdentity:focus,</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineminus">-#msgIdentity:focus-within,</span>
<a href="#l25.212"></a><span id="l25.212" class="difflineminus">-#msgIdentity[focused=&quot;true&quot;] {</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineminus">-  background-color: -moz-field;</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineminus">-  border-color: var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineminus">-}</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineminus">-</span>
<a href="#l25.217"></a><span id="l25.217"> #msgIdentity &gt; .menulist-label-box {</span>
<a href="#l25.218"></a><span id="l25.218">   background: none;</span>
<a href="#l25.219"></a><span id="l25.219">   padding-inline-end: initial;</span>
<a href="#l25.220"></a><span id="l25.220"> }</span>
<a href="#l25.221"></a><span id="l25.221"> </span>
<a href="#l25.222"></a><span id="l25.222"> #msgIdentity &gt; html|input.menulist-input {</span>
<a href="#l25.223"></a><span id="l25.223">   -moz-appearance: none;</span>
<a href="#l25.224"></a><span id="l25.224">   padding-top: 1px;</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineat">@@ -360,16 +235,17 @@ menulist:-moz-locale-dir(rtl) &gt; .menulis</span>
<a href="#l25.226"></a><span id="l25.226"> </span>
<a href="#l25.227"></a><span id="l25.227"> /* ::::: format toolbar ::::: */</span>
<a href="#l25.228"></a><span id="l25.228"> </span>
<a href="#l25.229"></a><span id="l25.229"> #FormatToolbar {</span>
<a href="#l25.230"></a><span id="l25.230">   -moz-appearance: none;</span>
<a href="#l25.231"></a><span id="l25.231">   color: WindowText;</span>
<a href="#l25.232"></a><span id="l25.232">   margin-left: 3px;</span>
<a href="#l25.233"></a><span id="l25.233">   margin-right: 3px;</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineplus">+  padding-block: 4px;</span>
<a href="#l25.235"></a><span id="l25.235"> }</span>
<a href="#l25.236"></a><span id="l25.236"> </span>
<a href="#l25.237"></a><span id="l25.237"> .formatting-button {</span>
<a href="#l25.238"></a><span id="l25.238">   margin: 1px;</span>
<a href="#l25.239"></a><span id="l25.239"> }</span>
<a href="#l25.240"></a><span id="l25.240"> </span>
<a href="#l25.241"></a><span id="l25.241"> toolbarbutton.formatting-button {</span>
<a href="#l25.242"></a><span id="l25.242">   -moz-appearance: none;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/themes/osx/mail/compose/messengercompose.css</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/themes/osx/mail/compose/messengercompose.css</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -91,48 +91,35 @@ toolbar[nowindowdrag=&quot;true&quot;] {</span>
<a href="#l26.4"></a><span id="l26.4">   text-shadow: none;</span>
<a href="#l26.5"></a><span id="l26.5">   border-bottom: 0 solid;</span>
<a href="#l26.6"></a><span id="l26.6"> }</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> #addresses-box {</span>
<a href="#l26.9"></a><span id="l26.9">   padding-top: 5px;</span>
<a href="#l26.10"></a><span id="l26.10"> }</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+#identityLabel-box {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  margin-top: 3px;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+}</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+</span>
<a href="#l26.16"></a><span id="l26.16"> #msgIdentity {</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-  margin: 0;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-  margin-inline-end: 1px;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-  padding-inline-start: 3px;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-  padding-inline-end: 12px;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-  line-height: 1;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-  border-bottom-color: #C6C6C6;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-  border-radius: 2px;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-  background-color: transparent;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+  margin-block: 2px 0;</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+  margin-inline-start: 4px;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+  padding-block: 3px;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+  padding-inline-end: 20px;</span>
<a href="#l26.31"></a><span id="l26.31">   background-repeat: no-repeat;</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  background-position: calc(100% - 3px) center;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  background-position: calc(100% - 5px);</span>
<a href="#l26.34"></a><span id="l26.34">   background-size: 9px 7px;</span>
<a href="#l26.35"></a><span id="l26.35">   background-image: url(&quot;chrome://messenger/skin/icons/toolbarbutton-arrow.svg&quot;);</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  -moz-context-properties: fill;</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-  fill: currentColor;</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l26.39"></a><span id="l26.39"> }</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41"> #msgIdentity:-moz-locale-dir(rtl) {</span>
<a href="#l26.42"></a><span id="l26.42">   background-position: 3px center;</span>
<a href="#l26.43"></a><span id="l26.43"> }</span>
<a href="#l26.44"></a><span id="l26.44"> </span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-#msgIdentity:hover,</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-#msgIdentity:focus,</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-#msgIdentity:focus-within,</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-#msgIdentity[focused=&quot;true&quot;] {</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  background-color: white;</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  border-color: #C6C6C6;</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-}</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-</span>
<a href="#l26.53"></a><span id="l26.53"> #msgIdentity &gt; html|input.menulist-input {</span>
<a href="#l26.54"></a><span id="l26.54">   color: inherit;</span>
<a href="#l26.55"></a><span id="l26.55">   padding-inline-start: 3px;</span>
<a href="#l26.56"></a><span id="l26.56"> }</span>
<a href="#l26.57"></a><span id="l26.57"> </span>
<a href="#l26.58"></a><span id="l26.58"> #msgIdentity[is=&quot;menulist-editable&quot;][editable=&quot;true&quot;] &gt; menupopup {</span>
<a href="#l26.59"></a><span id="l26.59">   -moz-appearance: menupopup;</span>
<a href="#l26.60"></a><span id="l26.60">   margin-inline-start: 0;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineat">@@ -141,20 +128,16 @@ toolbar[nowindowdrag=&quot;true&quot;] {</span>
<a href="#l26.62"></a><span id="l26.62"> #msgIdentity[is=&quot;menulist-editable&quot;][editable=&quot;true&quot;] &gt; menupopup &gt; menuitem {</span>
<a href="#l26.63"></a><span id="l26.63">   -moz-appearance: menuitem;</span>
<a href="#l26.64"></a><span id="l26.64"> }</span>
<a href="#l26.65"></a><span id="l26.65"> </span>
<a href="#l26.66"></a><span id="l26.66"> #msgIdentityPopup {</span>
<a href="#l26.67"></a><span id="l26.67">   margin-inline-start: initial;</span>
<a href="#l26.68"></a><span id="l26.68"> }</span>
<a href="#l26.69"></a><span id="l26.69"> </span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-#addresses-box {</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  margin: 4px 6px;</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-}</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-</span>
<a href="#l26.74"></a><span id="l26.74"> #attachments-header-box {</span>
<a href="#l26.75"></a><span id="l26.75">   min-height: 28px;</span>
<a href="#l26.76"></a><span id="l26.76"> }</span>
<a href="#l26.77"></a><span id="l26.77"> </span>
<a href="#l26.78"></a><span id="l26.78"> #attachmentBucketCount {</span>
<a href="#l26.79"></a><span id="l26.79">   padding-top: 2px;</span>
<a href="#l26.80"></a><span id="l26.80"> }</span>
<a href="#l26.81"></a><span id="l26.81"> </span>
<a href="#l26.82"></a><span id="l26.82" class="difflineat">@@ -180,41 +163,43 @@ toolbar[nowindowdrag=&quot;true&quot;] {</span>
<a href="#l26.83"></a><span id="l26.83">   margin-bottom: -1px;</span>
<a href="#l26.84"></a><span id="l26.84">   margin-inline-start: -3px;</span>
<a href="#l26.85"></a><span id="l26.85">   margin-inline-end: 3px;</span>
<a href="#l26.86"></a><span id="l26.86">   padding-inline-end: 5px;</span>
<a href="#l26.87"></a><span id="l26.87">   border-inline-end: 1px solid #9b9b9b;</span>
<a href="#l26.88"></a><span id="l26.88"> }</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90"> #subjectLabel {</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-  margin-top: 0;</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-  margin-bottom: 4px;</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineplus">+  margin-top: 3px;</span>
<a href="#l26.94"></a><span id="l26.94">   margin-inline-end: 6px;</span>
<a href="#l26.95"></a><span id="l26.95"> }</span>
<a href="#l26.96"></a><span id="l26.96"> </span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-#msgSubject {</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-  margin-top: 0;</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-  margin-inline-start: 0;</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-  margin-inline-end: 1px;</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-  min-height: 20px;</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineminus">-  background-color: inherit;</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-  border-bottom-color: #c6c6c6;</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-  border-radius: 2px;</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-  padding: 1px 2px;</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-  padding-inline-start: 5px;</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+#msgIdentity:focus,</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+#msgIdentity:focus-within,</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+#msgSubject:focus,</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+.address-container[focused=&quot;true&quot;] {</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineplus">+  border-color: -moz-mac-focusring;</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineplus">+  box-shadow: var(--focus-ring-box-shadow);</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineplus">+}</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineplus">+</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineplus">+.address-label-container {</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+  padding-top: 7px;</span>
<a href="#l26.120"></a><span id="l26.120"> }</span>
<a href="#l26.121"></a><span id="l26.121"> </span>
<a href="#l26.122"></a><span id="l26.122" class="difflineminus">-#msgSubject:hover,</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineminus">-#msgSubject:focus {</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineminus">-  background-color: white;</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineminus">-  background-image: none;</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-  border-color: #c6c6c6;</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+.address-pill {</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+  padding-block: 2px;</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+}</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+.address-pill label {</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+  margin-block: 0;</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineplus">+}</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineplus">+</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineplus">+.address-extra-recipients label:focus:not(:hover),</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineplus">+.aw-firstColBox label:focus:not(:hover) image {</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+  outline: 2px dashed -moz-mac-focusring;</span>
<a href="#l26.138"></a><span id="l26.138"> }</span>
<a href="#l26.139"></a><span id="l26.139"> </span>
<a href="#l26.140"></a><span id="l26.140"> /* ::::: autocomplete icons ::::: */</span>
<a href="#l26.141"></a><span id="l26.141"> </span>
<a href="#l26.142"></a><span id="l26.142"> .ac-site-icon {</span>
<a href="#l26.143"></a><span id="l26.143">   display: -moz-box;</span>
<a href="#l26.144"></a><span id="l26.144">   margin: 2px 5px;</span>
<a href="#l26.145"></a><span id="l26.145"> }</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineat">@@ -235,111 +220,16 @@ toolbar[nowindowdrag=&quot;true&quot;] {</span>
<a href="#l26.147"></a><span id="l26.147">   }</span>
<a href="#l26.148"></a><span id="l26.148"> }</span>
<a href="#l26.149"></a><span id="l26.149"> </span>
<a href="#l26.150"></a><span id="l26.150"> .autocomplete-richlistitem[type=&quot;subscribed-news&quot;] &gt; .ac-site-icon {</span>
<a href="#l26.151"></a><span id="l26.151">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l26.152"></a><span id="l26.152">   -moz-image-region: rect(0 160px 16px 144px);</span>
<a href="#l26.153"></a><span id="l26.153"> }</span>
<a href="#l26.154"></a><span id="l26.154"> </span>
<a href="#l26.155"></a><span id="l26.155" class="difflineminus">-/* ::::: addressing widget ::::: */</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineminus">-</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineminus">-#addressingWidget {</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineminus">-  -moz-user-focus: none;</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineminus">-  width: 0;</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineminus">-  margin: 0;</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-  padding-inline-end: 1px;</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-  border: none;</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-  background-color: transparent;</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-}</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineminus">-</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineminus">-.addressingWidgetItem,</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineminus">-.dummy-row {</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineminus">-  background-color: inherit !important;</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineminus">-  color: inherit !important;</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineminus">-}</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineminus">-</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-.textbox-addressingWidget,</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-.dummy-row-cell:last-child {</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-  border: 1px solid transparent !important;</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineminus">-  border-bottom-color: #C6C6C6 !important;</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineminus">-  border-top-left-radius: 2px;</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineminus">-  border-bottom-right-radius: 2px;</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineminus">-  min-height: 20px;</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineminus">-  margin-top: 1px !important;</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineminus">-  margin-bottom: 1px !important;</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineminus">-  padding: 1px 3px !important;</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineminus">-  padding-inline-start: 6px !important;</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineminus">-}</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineminus">-.textbox-addressingWidget:focus,</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineminus">-.textbox-addressingWidget:hover {</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineminus">-  background-color: white;</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineminus">-  background-image: none;</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineminus">-  border-color: #C6C6C6 !important;</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineminus">-}</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineminus">-</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineminus">-.deleteAddress {</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineminus">-  margin-inline-end: 0;</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineminus">-}</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineminus">-</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineminus">-.addressingWidgetCell:hover &gt; .aw-menulist:not([open=&quot;true&quot;]) + .deleteAddress {</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineminus">-  margin-inline-end: 3px;</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineminus">-  width: 18px;</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineminus">-}</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineminus">-.aw-menulist {</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineminus">-  -moz-box-pack: center;</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineminus">-  margin: 1px;</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineminus">-  margin-inline-end: 4px;</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineminus">-  border-radius: 2px;</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineminus">-  background: var(--toolbarbutton-active-background);</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-  border-color: var(--toolbarbutton-active-bordercolor);</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/toolbarbutton-arrow.svg&quot;);</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-  -moz-context-properties: fill;</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-  fill: currentColor;</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-  transition: background-color .25s ease-in;</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-}</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-.aw-menulist:-moz-locale-dir(rtl) {</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineminus">-  background-position: calc(100% - 3px) center;</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineminus">-}</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineminus">-</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineminus">-.aw-menulist[open=&quot;true&quot;] {</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-  background: var(--toolbarbutton-active-background);</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-  border-color: var(--toolbarbutton-active-bordercolor);</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-  box-shadow: var(--toolbarbutton-active-boxshadow);</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-}</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineminus">-.aw-menulist:focus {</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-  border-color: -moz-mac-focusring;</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-  box-shadow: 0 0 1.5px 1px -moz-mac-focusring;</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-}</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-.aw-menulist &gt; .menulist-label-box &gt; .menulist-icon {</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineminus">-  width: 9px;</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineminus">-  height: 7px;</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineminus">-  margin-inline-start: 2px;</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineminus">-}</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineminus">-.aw-menulist  &gt; .menulist-label-box &gt; .menulist-label {</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-  margin: 1px 1px 0 !important;</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-  text-align: end;</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineminus">-}</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineminus">-</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-.aw-menulist &gt; .menulist-dropmarker {</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-  display: none;</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-}</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-</span>
<a href="#l26.250"></a><span id="l26.250"> .menulist-description {</span>
<a href="#l26.251"></a><span id="l26.251">   color: #999;</span>
<a href="#l26.252"></a><span id="l26.252"> }</span>
<a href="#l26.253"></a><span id="l26.253"> </span>
<a href="#l26.254"></a><span id="l26.254"> /* ::::: compose toolbar sizer ::::: */</span>
<a href="#l26.255"></a><span id="l26.255"> </span>
<a href="#l26.256"></a><span id="l26.256"> #compose-toolbar-sizer {</span>
<a href="#l26.257"></a><span id="l26.257">   position: relative;</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineat">@@ -352,17 +242,17 @@ toolbar[nowindowdrag=&quot;true&quot;] {</span>
<a href="#l26.259"></a><span id="l26.259">   background-color: transparent;</span>
<a href="#l26.260"></a><span id="l26.260"> }</span>
<a href="#l26.261"></a><span id="l26.261"> </span>
<a href="#l26.262"></a><span id="l26.262"> /* ::::: format toolbar ::::: */</span>
<a href="#l26.263"></a><span id="l26.263"> </span>
<a href="#l26.264"></a><span id="l26.264"> #FormatToolbar {</span>
<a href="#l26.265"></a><span id="l26.265">   border-bottom: none;</span>
<a href="#l26.266"></a><span id="l26.266">   background-color: rgb(242, 242, 242) !important;</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-  padding-top: 2px;</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineplus">+  padding-block: 4px;</span>
<a href="#l26.269"></a><span id="l26.269">   margin-left: 3px;</span>
<a href="#l26.270"></a><span id="l26.270">   margin-right: 3px;</span>
<a href="#l26.271"></a><span id="l26.271"> }</span>
<a href="#l26.272"></a><span id="l26.272"> </span>
<a href="#l26.273"></a><span id="l26.273"> #FormatToolbar toolbarseparator {</span>
<a href="#l26.274"></a><span id="l26.274">   background-image: none;</span>
<a href="#l26.275"></a><span id="l26.275"> }</span>
<a href="#l26.276"></a><span id="l26.276"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/themes/shared/mail/compacttheme.css</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/themes/shared/mail/compacttheme.css</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -101,42 +101,49 @@</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5">   --toolbarbutton-active-background: var(--lwt-toolbarbutton-active-background);</span>
<a href="#l27.6"></a><span id="l27.6">   --toolbarbutton-active-bordercolor: var(--lwt-toolbarbutton-active-background);</span>
<a href="#l27.7"></a><span id="l27.7">   --toolbarbutton-active-boxshadow: 0 0 0 1px var(--lwt-toolbarbutton-active-background) inset;</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9">   scrollbar-color: rgba(249,249,250,.4) rgba(20,20,25,.3);</span>
<a href="#l27.10"></a><span id="l27.10"> }</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#MsgHeadersToolbar,</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-#addressingWidget,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-.aw-menulist {</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+#MsgHeadersToolbar {</span>
<a href="#l27.16"></a><span id="l27.16">   color: inherit;</span>
<a href="#l27.17"></a><span id="l27.17"> }</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19"> #msgIdentity,</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-#msgSubject,</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-.textbox-addressingWidget,</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-.dummy-row-cell:last-child {</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+#msgSubject {</span>
<a href="#l27.24"></a><span id="l27.24">   border-bottom-color: var(--composer-header-border-color) !important;</span>
<a href="#l27.25"></a><span id="l27.25">   color: var(--lwt-text-color);</span>
<a href="#l27.26"></a><span id="l27.26"> }</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28"> #msgIdentity:hover,</span>
<a href="#l27.29"></a><span id="l27.29"> #msgIdentity:focus,</span>
<a href="#l27.30"></a><span id="l27.30"> #msgIdentity:focus-within,</span>
<a href="#l27.31"></a><span id="l27.31"> #msgSubject:hover,</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-#msgSubject:focus,</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-.textbox-addressingWidget:hover,</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-.textbox-addressingWidget:focus {</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+#msgSubject:focus {</span>
<a href="#l27.36"></a><span id="l27.36">   background-color: var(--lwt-toolbar-field-background-color);</span>
<a href="#l27.37"></a><span id="l27.37">   color: var(--lwt-toolbar-field-color);</span>
<a href="#l27.38"></a><span id="l27.38">   border-color: var(--lwt-toolbar-field-border-color) !important;</span>
<a href="#l27.39"></a><span id="l27.39"> }</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+#msgIdentity,</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+#msgSubject,</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+.address-container {</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+  background-color: var(--lwt-toolbar-field-background-color);</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+  color: var(--lwt-toolbar-field-color);</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+}</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+#msgIdentity:focus,</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+#msgSubject:focus,</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+.address-container[focused=&quot;true&quot;] {</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+  border-color: Highlight !important;</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+}</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+</span>
<a href="#l27.54"></a><span id="l27.54"> :root[lwt-popup-brighttext] panel[type=&quot;autocomplete-richlistbox&quot;]:-moz-lwtheme {</span>
<a href="#l27.55"></a><span id="l27.55">   margin-top: -1px;</span>
<a href="#l27.56"></a><span id="l27.56">   padding: 2px 0;</span>
<a href="#l27.57"></a><span id="l27.57">   background: var(--autocomplete-popup-background);</span>
<a href="#l27.58"></a><span id="l27.58">   color: var(--autocomplete-popup-color);</span>
<a href="#l27.59"></a><span id="l27.59">   border-color: var(--autocomplete-popup-border-color);</span>
<a href="#l27.60"></a><span id="l27.60">   scrollbar-color: rgba(249,249,250,.4) rgba(20,20,25,.3);</span>
<a href="#l27.61"></a><span id="l27.61"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/themes/shared/mail/input-fields.css</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/themes/shared/mail/input-fields.css</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -36,16 +36,20 @@ html|input.input-inline-color {</span>
<a href="#l28.4"></a><span id="l28.4">   align-items: center;</span>
<a href="#l28.5"></a><span id="l28.5">   flex-wrap: nowrap;</span>
<a href="#l28.6"></a><span id="l28.6"> }</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> .input-container.items-stretch {</span>
<a href="#l28.9"></a><span id="l28.9">   align-items: stretch;</span>
<a href="#l28.10"></a><span id="l28.10"> }</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+.input-container.wrap-container {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  flex-wrap: wrap;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+}</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+</span>
<a href="#l28.16"></a><span id="l28.16"> .input-container html|input:not([type=&quot;number&quot;]):not([type=&quot;color&quot;]),</span>
<a href="#l28.17"></a><span id="l28.17"> .input-container .label-inline,</span>
<a href="#l28.18"></a><span id="l28.18"> .input-container .spacer-inline {</span>
<a href="#l28.19"></a><span id="l28.19">   flex: 1;</span>
<a href="#l28.20"></a><span id="l28.20"> }</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22"> html|input[type=&quot;number&quot;].input-number-inline {</span>
<a href="#l28.23"></a><span id="l28.23">   flex: 1 !important;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/themes/shared/mail/messengercompose.css</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/themes/shared/mail/messengercompose.css</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -29,65 +29,60 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5">   --toolbarbutton-active-background: var(--lwt-toolbarbutton-active-background);</span>
<a href="#l29.6"></a><span id="l29.6">   --toolbarbutton-active-bordercolor: var(--lwt-toolbarbutton-active-background);</span>
<a href="#l29.7"></a><span id="l29.7">   --toolbarbutton-active-boxshadow: 0 0 0 1px var(--lwt-toolbarbutton-active-background) inset;</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9">   scrollbar-color: rgba(249,249,250,.4) rgba(20,20,25,.3);</span>
<a href="#l29.10"></a><span id="l29.10"> }</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] #MsgHeadersToolbar,</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] #addressingWidget,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .aw-menulist {</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] #MsgHeadersToolbar {</span>
<a href="#l29.16"></a><span id="l29.16">   color: inherit;</span>
<a href="#l29.17"></a><span id="l29.17"> }</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19"> :root[lwt-default-theme-in-dark-mode] #msgIdentity,</span>
<a href="#l29.20"></a><span id="l29.20"> :root[lwt-default-theme-in-dark-mode] #msgSubject,</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget,</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .dummy-row-cell:last-child {</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] .address-container {</span>
<a href="#l29.24"></a><span id="l29.24">   border-bottom-color: var(--composer-header-border-color) !important;</span>
<a href="#l29.25"></a><span id="l29.25">   color: var(--lwt-text-color);</span>
<a href="#l29.26"></a><span id="l29.26"> }</span>
<a href="#l29.27"></a><span id="l29.27"> </span>
<a href="#l29.28"></a><span id="l29.28"> :root[lwt-default-theme-in-dark-mode] #msgIdentity:hover,</span>
<a href="#l29.29"></a><span id="l29.29"> :root[lwt-default-theme-in-dark-mode] #msgIdentity:focus,</span>
<a href="#l29.30"></a><span id="l29.30"> :root[lwt-default-theme-in-dark-mode] #msgIdentity:focus-within,</span>
<a href="#l29.31"></a><span id="l29.31"> :root[lwt-default-theme-in-dark-mode] #msgSubject:hover,</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] #msgSubject:focus,</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget:hover,</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget:focus {</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] #msgSubject:focus {</span>
<a href="#l29.36"></a><span id="l29.36">   background-color: var(--lwt-toolbar-field-background-color);</span>
<a href="#l29.37"></a><span id="l29.37">   color: var(--lwt-toolbar-field-color);</span>
<a href="#l29.38"></a><span id="l29.38">   border-color: var(--lwt-toolbar-field-border-color) !important;</span>
<a href="#l29.39"></a><span id="l29.39"> }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget &gt;</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] .address-container &gt;</span>
<a href="#l29.43"></a><span id="l29.43">   .autocomplete-result-popupset {</span>
<a href="#l29.44"></a><span id="l29.44">   -moz-appearance: none;</span>
<a href="#l29.45"></a><span id="l29.45">   margin-top: -1px;</span>
<a href="#l29.46"></a><span id="l29.46">   background: var(--autocomplete-popup-background);</span>
<a href="#l29.47"></a><span id="l29.47">   color: var(--autocomplete-popup-color);</span>
<a href="#l29.48"></a><span id="l29.48"> }</span>
<a href="#l29.49"></a><span id="l29.49"> </span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] .address-container</span>
<a href="#l29.52"></a><span id="l29.52">   panel[type=&quot;autocomplete-richlistbox&quot;] {</span>
<a href="#l29.53"></a><span id="l29.53">   padding: 2px 0;</span>
<a href="#l29.54"></a><span id="l29.54">   color: inherit;</span>
<a href="#l29.55"></a><span id="l29.55">   background-color: inherit;</span>
<a href="#l29.56"></a><span id="l29.56">   border-color: var(--autocomplete-popup-border-color);</span>
<a href="#l29.57"></a><span id="l29.57"> }</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] .address-container</span>
<a href="#l29.61"></a><span id="l29.61">   .autocomplete-richlistbox {</span>
<a href="#l29.62"></a><span id="l29.62">   color: inherit;</span>
<a href="#l29.63"></a><span id="l29.63">   background-color: inherit;</span>
<a href="#l29.64"></a><span id="l29.64"> }</span>
<a href="#l29.65"></a><span id="l29.65"> </span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-:root[lwt-default-theme-in-dark-mode] .textbox-addressingWidget</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+:root[lwt-default-theme-in-dark-mode] .address-container</span>
<a href="#l29.68"></a><span id="l29.68">   .autocomplete-richlistitem[selected] {</span>
<a href="#l29.69"></a><span id="l29.69">   background: #0a84ff;</span>
<a href="#l29.70"></a><span id="l29.70">   color: #fff;</span>
<a href="#l29.71"></a><span id="l29.71"> }</span>
<a href="#l29.72"></a><span id="l29.72"> </span>
<a href="#l29.73"></a><span id="l29.73"> /* Rules to help integrate WebExtension buttons */</span>
<a href="#l29.74"></a><span id="l29.74"> </span>
<a href="#l29.75"></a><span id="l29.75"> .webextension-browser-action &gt; .toolbarbutton-badge-stack &gt; .toolbarbutton-icon {</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineat">@@ -335,48 +330,20 @@</span>
<a href="#l29.77"></a><span id="l29.77"> </span>
<a href="#l29.78"></a><span id="l29.78"> .menulist-description {</span>
<a href="#l29.79"></a><span id="l29.79">   font-style: italic;</span>
<a href="#l29.80"></a><span id="l29.80">   color: GrayText;</span>
<a href="#l29.81"></a><span id="l29.81">   margin-inline-start: 1ex !important;</span>
<a href="#l29.82"></a><span id="l29.82"> }</span>
<a href="#l29.83"></a><span id="l29.83"> </span>
<a href="#l29.84"></a><span id="l29.84"> .aw-firstColBox,</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-#firstcol-addressingWidget,</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineminus">-.dummy-row-cell:first-child {</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+#firstcol-addressingWidget {</span>
<a href="#l29.88"></a><span id="l29.88">   width: 21px;</span>
<a href="#l29.89"></a><span id="l29.89"> }</span>
<a href="#l29.90"></a><span id="l29.90"> </span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-.deleteAddress {</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-  cursor: default;</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-  margin-inline-end: 3px;</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-  width: 18px;</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-  height: 18px;</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-  transition-property: width, margin-inline-end;</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-  transition-duration: 50ms, 50ms;</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-  transition-timing-function: ease-in-out, ease-in-out;</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-}</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-.addressingWidgetItem:not(:hover):not(:focus-within) .aw-menulist {</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-  border-color: transparent;</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-  background: transparent;</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-}</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-.addressingWidgetItem:not(:hover):not(:focus-within) .deleteAddress,</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-.addressingWidgetItem:not(:hover):not(:focus-within) .aw-menulist &gt; .menulist-label-box {</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineminus">-  fill: transparent;</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineminus">-}</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-.aw-menulist:focus,</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-.aw-menulist[focused=&quot;true&quot;] {</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineminus">-  background: var(--toolbarbutton-active-background);</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineminus">-  border-color: var(--toolbarbutton-active-bordercolor);</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineminus">-}</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineminus">-</span>
<a href="#l29.118"></a><span id="l29.118"> /* :::: Format toolbar :::: */</span>
<a href="#l29.119"></a><span id="l29.119"> </span>
<a href="#l29.120"></a><span id="l29.120"> /*</span>
<a href="#l29.121"></a><span id="l29.121">  * Removed from global.css in bug 1484949. It's needed so the formatting</span>
<a href="#l29.122"></a><span id="l29.122">  * toolbar is not disabled while a dropdown (paragraph format or font) is active.</span>
<a href="#l29.123"></a><span id="l29.123">  */</span>
<a href="#l29.124"></a><span id="l29.124"> .toolbar-focustarget {</span>
<a href="#l29.125"></a><span id="l29.125">   -moz-user-focus: ignore !important;</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineat">@@ -478,8 +445,279 @@</span>
<a href="#l29.127"></a><span id="l29.127">   margin-inline-start: 0;</span>
<a href="#l29.128"></a><span id="l29.128">   text-decoration: underline;</span>
<a href="#l29.129"></a><span id="l29.129">   cursor: pointer;</span>
<a href="#l29.130"></a><span id="l29.130"> }</span>
<a href="#l29.131"></a><span id="l29.131"> </span>
<a href="#l29.132"></a><span id="l29.132"> #attachmentNotificationBox &gt; hbox &gt; .messageImage {</span>
<a href="#l29.133"></a><span id="l29.133">   background-image: url(&quot;chrome://messenger/skin/icons/attach.svg&quot;);</span>
<a href="#l29.134"></a><span id="l29.134"> }</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineplus">+</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineplus">+#identityLabel,</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineplus">+.address-label-container label {</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineplus">+  margin-inline-end: 6px</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineplus">+}</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineplus">+</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineplus">+#msgIdentity {</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+  -moz-appearance: none;</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineplus">+  -moz-box-align: center;</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineplus">+  font: inherit;</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineplus">+  margin-inline-end: 8px;</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineplus">+  border: 1px solid var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineplus">+  border-radius: 2px;</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineplus">+  background-color: -moz-field;</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineplus">+  -moz-context-properties: fill;</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineplus">+  fill: currentColor;</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineplus">+  transition: border .2s, box-shadow .2s;</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+}</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineplus">+</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineplus">+#msgSubject {</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineplus">+  -moz-appearance: none;</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineplus">+  margin-top: 0;</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineplus">+  margin-inline: 4px 8px;</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineplus">+  background-color: -moz-field;</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineplus">+  border: 1px solid var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineplus">+  border-radius: 2px;</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+  padding-block: 5px;</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineplus">+  padding-inline: 4px 2px;</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+  transition: border .2s, box-shadow .2s;</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineplus">+}</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineplus">+</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineplus">+.recipients-container {</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+  display: block;</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineplus">+  /* Necessary for unwanted overflow while resizing the message header */</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineplus">+  height: 0;</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineplus">+}</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineplus">+</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineplus">+.recipients-container.overflow {</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineplus">+  overflow-y: auto;</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineplus">+}</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineplus">+</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineplus">+.address-row {</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineplus">+  display: flex;</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineplus">+  flex: 1;</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineplus">+  margin-block: 5px;</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+  margin-inline-end: 8px;</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineplus">+  align-items: self-start;</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineplus">+}</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineplus">+</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineplus">+.address-row &gt; .aw-firstColBox {</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineplus">+  transition: opacity .2s ease;</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineplus">+  opacity: 0;</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineplus">+}</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineplus">+</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineplus">+.address-row:hover &gt; .aw-firstColBox,</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineplus">+.address-row:focus &gt; .aw-firstColBox,</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineplus">+.address-row:focus-within &gt; .aw-firstColBox {</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineplus">+  opacity: 1;</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineplus">+}</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineplus">+</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineplus">+.address-row.hidden {</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+  display: none;</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineplus">+}</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineplus">+</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineplus">+.address-container {</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineplus">+  flex: 1;</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineplus">+  margin-inline-start: 4px;</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineplus">+  margin-inline-end: 0;</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineplus">+  padding: 1px 4px;</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineplus">+  border: solid 1px var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineplus">+  border-radius: 2px;</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+  background-color: -moz-field;</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+  transition: border .2s, box-shadow .2s;</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineplus">+  cursor: text;</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineplus">+}</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineplus">+</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineplus">+#msgSubject,</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineplus">+#msgIdentity,</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineplus">+.address-container {</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineplus">+  min-height: 30px;</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineplus">+}</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineplus">+</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineplus">+.address-input {</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineplus">+  color: inherit;</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineplus">+}</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineplus">+</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineplus">+.address-pill {</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineplus">+  display: flex;</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineplus">+  align-items: center;</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineplus">+  border-radius: 9999px;</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineplus">+  margin-inline-end: 2px;</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineplus">+  margin-block: 2px;</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineplus">+  background-color: rgba(0,0,0,0.1);</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineplus">+  transition: color .2s ease, background-color .2s ease, box-shadow .2s ease;</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineplus">+  -moz-user-focus: normal;</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineplus">+  cursor: default;</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineplus">+  box-shadow: inset 0 0 0 2px transparent;</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineplus">+}</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineplus">+</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+.address-pill label,</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineplus">+.address-pill .delete-pill-icon {</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineplus">+  -moz-user-focus: none;</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineplus">+  cursor: default;</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+}</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineplus">+.delete-pill-icon {</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineplus">+  width: 1.25em;</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineplus">+  height: 1.25em;</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineplus">+  margin-inline-end: 2px;</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineplus">+  padding: 3px;</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineplus">+  border-radius: 50%;</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineplus">+  background-color: rgba(0,0,0,0.1);</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/stop.svg&quot;);</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineplus">+  -moz-context-properties: fill;</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+  fill: currentColor;</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineplus">+  transition: color .2s ease, background-color .2s ease;</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineplus">+}</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineplus">+</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineplus">+.address-pill:hover:not(.editing),</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineplus">+.address-pill:focus:not(.editing) {</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineplus">+  box-shadow: inset 0 0 0 2px rgba(0,0,0,0.3);</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+}</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineplus">+</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineplus">+.address-pill.editing {</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineplus">+  flex: 1;</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineplus">+  background-color: transparent;</span>
<a href="#l29.261"></a><span id="l29.261" class="difflineplus">+  padding-inline: 6px;</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineplus">+  box-shadow: inset 0 0 0 2px Highlight;</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineplus">+  min-height: calc(1.25em + 4px); /* needed to not shrink in edit mode */</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineplus">+}</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineplus">+</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill:not(.editing) {</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineplus">+  background-color: rgba(0,0,0,0.3);</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineplus">+}</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineplus">+</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill:hover:not(.editing),</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill:focus:not(.editing) {</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineplus">+  background-color: rgba(0,0,0,0.35);</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineplus">+}</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineplus">+</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineplus">+.address-pill.error {</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineplus">+  color: #a4000f;</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineplus">+  background-color: rgba(255,0,0,0.1);</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineplus">+}</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineplus">+</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineplus">+.address-pill.error:hover:not(.editing),</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineplus">+.address-pill.error:focus:not(.editing) {</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineplus">+  background-color: rgba(255,0,0,0.15);</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineplus">+}</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineplus">+</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.error:not(.editing) {</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineplus">+  color: #e10216;</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineplus">+  background-color: #3e0006;</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineplus">+}</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineplus">+</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.error:hover:not(.editing),</span>
<a href="#l29.291"></a><span id="l29.291" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.error:focus:not(.editing)  {</span>
<a href="#l29.292"></a><span id="l29.292" class="difflineplus">+  background-color: #310005;</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineplus">+}</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineplus">+</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineplus">+.address-pill.warning {</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineplus">+  color: #a44900;</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineplus">+  background-color: rgba(255,130,0,0.1);</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineplus">+}</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineplus">+</span>
<a href="#l29.300"></a><span id="l29.300" class="difflineplus">+.address-pill.warning:hover:not(.editing),</span>
<a href="#l29.301"></a><span id="l29.301" class="difflineplus">+.address-pill.warning:focus:not(.editing) {</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineplus">+  background-color: rgba(255,130,0,0.15);</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineplus">+}</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineplus">+</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.warning:not(.editing) {</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineplus">+  color: #fe7100;</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineplus">+  background-color: #341700;</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineplus">+}</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineplus">+</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.warning:hover:not(.editing),</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.warning:focus:not(.editing)  {</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineplus">+  background-color: #301500;</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineplus">+}</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineplus">+</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineplus">+.address-pill[selected]:not(.editing),</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill[selected]:not(.editing),</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineplus">+.address-pill.warning[selected]:not(.editing),</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.warning[selected]:not(.editing),</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineplus">+.address-pill.error[selected]:not(.editing),</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-pill.error[selected]:not(.editing) {</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineplus">+  color: HighlightText;</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineplus">+  background-color: Highlight;</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineplus">+}</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineplus">+</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineplus">+#MsgHeadersToolbar[brighttext] .delete-pill-icon {</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineplus">+  background-color: rgba(255, 255, 255, 0.1);</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineplus">+}</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineplus">+</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+.delete-pill-icon:hover,</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineplus">+#MsgHeadersToolbar[brighttext] .delete-pill-icon:hover {</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineplus">+  background-color: HighlightText;</span>
<a href="#l29.332"></a><span id="l29.332" class="difflineplus">+  color: Highlight;</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineplus">+}</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineplus">+</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineplus">+.address-extra-recipients {</span>
<a href="#l29.336"></a><span id="l29.336" class="difflineplus">+  margin-inline-end: 8px;</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineplus">+}</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineplus">+</span>
<a href="#l29.339"></a><span id="l29.339" class="difflineplus">+.address-extra-recipients label {</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineplus">+  margin-top: 0;</span>
<a href="#l29.341"></a><span id="l29.341" class="difflineplus">+  margin-bottom: 6px;</span>
<a href="#l29.342"></a><span id="l29.342" class="difflineplus">+  transition: color 0.2s;</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineplus">+  margin-inline-end: 12px;</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineplus">+}</span>
<a href="#l29.345"></a><span id="l29.345" class="difflineplus">+</span>
<a href="#l29.346"></a><span id="l29.346" class="difflineplus">+.new-icon {</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineplus">+  -moz-appearance: none;</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineplus">+  -moz-context-properties: fill, fill-opacity;</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineplus">+  list-style-image: url(chrome://messenger/skin/icons/new.svg);</span>
<a href="#l29.350"></a><span id="l29.350" class="difflineplus">+  color: inherit !important;</span>
<a href="#l29.351"></a><span id="l29.351" class="difflineplus">+  fill: currentColor;</span>
<a href="#l29.352"></a><span id="l29.352" class="difflineplus">+  fill-opacity: 1;</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineplus">+  width: 15px;</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineplus">+  height: 15px;</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineplus">+  background-color: rgba(0,0,0,0.1);</span>
<a href="#l29.356"></a><span id="l29.356" class="difflineplus">+  border-radius: 50%;</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineplus">+  padding: 3px;</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineplus">+  vertical-align: sub;</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineplus">+  display: inline-block;</span>
<a href="#l29.360"></a><span id="l29.360" class="difflineplus">+  margin-inline-end: 4px;</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineplus">+}</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineplus">+</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineplus">+#MsgHeadersToolbar[brighttext] .new-icon {</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineplus">+  background-color: rgba(255, 255, 255, 0.1);</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineplus">+}</span>
<a href="#l29.366"></a><span id="l29.366" class="difflineplus">+</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineplus">+.address-extra-recipients label:hover,</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineplus">+.aw-firstColBox label:hover {</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineplus">+  cursor: pointer;</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineplus">+  color: Highlight;</span>
<a href="#l29.371"></a><span id="l29.371" class="difflineplus">+}</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineplus">+</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineplus">+.aw-firstColBox label:hover .close-icon {</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineplus">+  fill-opacity: 0.1;</span>
<a href="#l29.375"></a><span id="l29.375" class="difflineplus">+}</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineplus">+</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineplus">+.aw-firstColBox label {</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineplus">+  margin-top: 4px;</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineplus">+  margin-bottom: 0;</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineplus">+}</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineplus">+</span>
<a href="#l29.382"></a><span id="l29.382" class="difflineplus">+.address-extra-recipients label:focus:not(:hover),</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineplus">+.aw-firstColBox label:focus:not(:hover) image {</span>
<a href="#l29.384"></a><span id="l29.384" class="difflineplus">+  outline: 2px dashed Highlight;</span>
<a href="#l29.385"></a><span id="l29.385" class="difflineplus">+}</span>
<a href="#l29.386"></a><span id="l29.386" class="difflineplus">+</span>
<a href="#l29.387"></a><span id="l29.387" class="difflineplus">+#msgIdentity:hover,</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineplus">+#msgSubject:hover,</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineplus">+.address-container:hover  {</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineplus">+  border-color: rgba(0,0,0,0.5);</span>
<a href="#l29.391"></a><span id="l29.391" class="difflineplus">+}</span>
<a href="#l29.392"></a><span id="l29.392" class="difflineplus">+</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineplus">+#MsgHeadersToolbar[brighttext] #msgIdentity:hover,</span>
<a href="#l29.394"></a><span id="l29.394" class="difflineplus">+#MsgHeadersToolbar[brighttext] #msgSubject:hover,</span>
<a href="#l29.395"></a><span id="l29.395" class="difflineplus">+#MsgHeadersToolbar[brighttext] .address-container:hover  {</span>
<a href="#l29.396"></a><span id="l29.396" class="difflineplus">+  border-color: rgba(255, 255, 255, 0.3);</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineplus">+}</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineplus">+</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineplus">+#msgIdentity:focus,</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineplus">+#msgIdentity:focus-within,</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineplus">+#msgIdentity[focused=&quot;true&quot;],</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineplus">+#msgSubject:focus,</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineplus">+.address-container[focused=&quot;true&quot;] {</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineplus">+  border-color: Highlight;</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/themes/windows/mail/compose/messengercompose.css</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/themes/windows/mail/compose/messengercompose.css</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -91,161 +91,95 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #msgheaderstoolbar-box {</span>
<a href="#l30.5"></a><span id="l30.5">   padding-bottom: 2px;</span>
<a href="#l30.6"></a><span id="l30.6"> }</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> #addresses-box {</span>
<a href="#l30.9"></a><span id="l30.9">   padding-top: 4px;</span>
<a href="#l30.10"></a><span id="l30.10"> }</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-#msgIdentity {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  background-color: transparent;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-  min-height: 25px;</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-  line-height: 1;</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-  box-shadow: none;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-  margin-inline-end: 5px;</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-  padding-inline-start: 3px !important;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-  background-image: none;</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+#subjectLabel {</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+  margin-bottom: 0;</span>
<a href="#l30.25"></a><span id="l30.25"> }</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27"> @media (-moz-windows-default-theme: 0) {</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-  #msgIdentity {</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-    border-bottom-color: ThreeDShadow;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  #msgSubject:not(:-moz-lwtheme),</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+  #msgIdentity:not(:-moz-lwtheme),</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  .address-container:not(:-moz-lwtheme) {</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+    --toolbarbutton-hover-bordercolor: ThreeDShadow;</span>
<a href="#l30.34"></a><span id="l30.34">   }</span>
<a href="#l30.35"></a><span id="l30.35"> </span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-  #msgIdentity:hover,</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-  #msgIdentity:focus,</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-  #msgIdentity:focus-within,</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-  #msgIdentity[focused=&quot;true&quot;] {</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-    background-color: -moz-field;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-    border-color: ThreeDShadow;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+  #msgSubject:not(:-moz-lwtheme):hover,</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+  #msgIdentity:not(:-moz-lwtheme):hover,</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+  .address-container:not(:-moz-lwtheme):hover {</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+    --toolbarbutton-hover-bordercolor: ThreeDDarkShadow;</span>
<a href="#l30.46"></a><span id="l30.46">   }</span>
<a href="#l30.47"></a><span id="l30.47"> }</span>
<a href="#l30.48"></a><span id="l30.48"> </span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+#identityLabel-box {</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+  margin-top: 1px;</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+}</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+#msgIdentity {</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+  line-height: 1;</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+  box-shadow: none;</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+  padding-inline-start: 3px !important;</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+}</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+</span>
<a href="#l30.59"></a><span id="l30.59"> #msgIdentity:-moz-focusring:not([open=&quot;true&quot;]) &gt; .menulist-label-box {</span>
<a href="#l30.60"></a><span id="l30.60">   outline: none;</span>
<a href="#l30.61"></a><span id="l30.61"> }</span>
<a href="#l30.62"></a><span id="l30.62"> </span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-#msgSubject {</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-  margin-top: 0;</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-  margin-inline-end: 5px;</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-  background-color: inherit;</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-  padding: 2px;</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-  padding-inline-start: 5px;</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-}</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-@media (-moz-windows-default-theme) {</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-  #msgSubject {</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-    border-bottom-color: #a9b7c9;</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+@media (-moz-windows-default-theme: 0) {</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+  #msgIdentity &gt; .menulist-label-box {</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+    background-color: transparent !important;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+    color: inherit !important;</span>
<a href="#l30.81"></a><span id="l30.81">   }</span>
<a href="#l30.82"></a><span id="l30.82"> </span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-  #msgSubject:hover,</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-  #msgSubject:focus {</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-    background-color: -moz-field;</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-    border-color: #a9b7c9;</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-  }</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-}</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-@media (-moz-windows-default-theme: 0) {</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-  #msgSubject {</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-    border-bottom-color: ThreeDShadow;</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+  #msgIdentity &gt; .menulist-dropmarker,</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+  #msgIdentity &gt; .menulist-dropmarker[disabled=&quot;true&quot;] {</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+    -moz-appearance: none;</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+    list-style-image: url(&quot;chrome://messenger/skin/icons/toolbarbutton-arrow.svg&quot;);</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+    -moz-context-properties: fill;</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+    fill: currentColor;</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+    margin-top: 0;</span>
<a href="#l30.100"></a><span id="l30.100">   }</span>
<a href="#l30.101"></a><span id="l30.101"> </span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-  #msgSubject:hover,</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-  #msgSubject:focus {</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-    background-color: -moz-field;</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-    border-color: ThreeDShadow;</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+  .menulist-dropmarker::part(icon) {</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+    width: 9px;</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+    height: 7px;</span>
<a href="#l30.109"></a><span id="l30.109">   }</span>
<a href="#l30.110"></a><span id="l30.110"> }</span>
<a href="#l30.111"></a><span id="l30.111"> </span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-/* ::::: addressing widget ::::: */</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-#addressingWidget {</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-  -moz-user-focus: none;</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-  width: 0;</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-  border: none;</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-  background-color: transparent;</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-  margin-bottom: 0;</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-  padding-inline-end: 1px;</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+#msgIdentity &gt; html|input.menulist-input {</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+  background-color: inherit;</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+  color: inherit;</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+  margin: 2px 0;</span>
<a href="#l30.127"></a><span id="l30.127"> }</span>
<a href="#l30.128"></a><span id="l30.128"> </span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-#addressingWidget &gt; .addressingWidgetItem,</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-#addressingWidget &gt; .dummy-row {</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-  border-style: none;</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-  background: none;</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-  color: inherit;</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-  box-shadow: none;</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-}</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">-#addressingWidget &gt; .addressingWidgetItem {</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineminus">-  padding-top: 0;</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineminus">-  padding-bottom: 2px;</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineminus">-}</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineminus">-</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-.textbox-addressingWidget,</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-.dummy-row-cell:last-child {</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-  margin-bottom: 2px !important;</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-  padding: 2px !important;</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineminus">-  padding-inline-start: 5px !important;</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-  border: 1px solid transparent !important;</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineminus">-  transition: border .2s, background-color .2s;</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+.address-label-container {</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+  padding-top: 5px;</span>
<a href="#l30.151"></a><span id="l30.151"> }</span>
<a href="#l30.152"></a><span id="l30.152"> </span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-@media (-moz-windows-default-theme: 0) {</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-  .textbox-addressingWidget,</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-    .dummy-row-cell:last-child {</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-    border-bottom-color: ThreeDShadow !important;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-    margin-inline-end: 1px !important;</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">-  }</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">-</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-  .textbox-addressingWidget:hover,</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-  .textbox-addressingWidget:focus {</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">-    background-color: -moz-field;</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-    border-color: ThreeDShadow !important;</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-  }</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-}</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-.addressingWidgetCell:nth-child(2),</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-.dummy-row-cell:nth-child(2) {</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-  border-bottom-color: transparent;</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+#msgSubject {</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+  margin-top: 0;</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+  padding: 2px;</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+  padding-inline-start: 5px;</span>
<a href="#l30.174"></a><span id="l30.174"> }</span>
<a href="#l30.175"></a><span id="l30.175"> </span>
<a href="#l30.176"></a><span id="l30.176" class="difflineminus">-.deleteAddress {</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-  margin-inline-end: 0;</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-}</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+@media (-moz-windows-default-theme) {</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+  #msgSubject,</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+  #msgIdentity,</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+  .address-container {</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+    border-radius: 0;</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+  }</span>
<a href="#l30.186"></a><span id="l30.186"> </span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-.aw-menulist {</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-  -moz-box-pack: center;</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-  color: ButtonText;</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-  margin: 0 1px 2px;</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-  margin-inline-end: 4px;</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-  padding: 3px 0 !important;</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-}</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-.aw-menulist:-moz-focusring:not([open=&quot;true&quot;]) &gt; .menulist-label-box {</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-  outline: none;</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-}</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-.aw-menulist &gt; .menulist-label-box {</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-  margin: 0;</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-}</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-.aw-menulist &gt; .menulist-dropmarker {</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-  display: none;</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+  #msgIdentity[is=&quot;menulist-editable&quot;][editable=&quot;true&quot;] &gt; .menulist-dropmarker {</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+    margin-inline: 3px -3px;</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+  }</span>
<a href="#l30.210"></a><span id="l30.210"> }</span>
<a href="#l30.211"></a><span id="l30.211"> </span>
<a href="#l30.212"></a><span id="l30.212"> /* ::::: format toolbar ::::: */</span>
<a href="#l30.213"></a><span id="l30.213"> </span>
<a href="#l30.214"></a><span id="l30.214"> #FormatToolbox {</span>
<a href="#l30.215"></a><span id="l30.215">   -moz-appearance: none;</span>
<a href="#l30.216"></a><span id="l30.216"> }</span>
<a href="#l30.217"></a><span id="l30.217"> </span>
<a href="#l30.218"></a><span id="l30.218" class="difflineat">@@ -568,42 +502,16 @@ toolbar:not(:-moz-lwtheme) {</span>
<a href="#l30.219"></a><span id="l30.219"> #compose-toolbox &gt; toolbar:not([type=&quot;menubar&quot;]) {</span>
<a href="#l30.220"></a><span id="l30.220">   padding: 2px 1px;</span>
<a href="#l30.221"></a><span id="l30.221"> }</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223"> #compose-toolbox &gt; toolbar:not([type=&quot;menubar&quot;]):-moz-lwtheme {</span>
<a href="#l30.224"></a><span id="l30.224">   text-shadow: none;</span>
<a href="#l30.225"></a><span id="l30.225"> }</span>
<a href="#l30.226"></a><span id="l30.226"> </span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-#msgIdentity &gt; html|input.menulist-input {</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-  background-color: inherit;</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-  color: inherit;</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-  margin: 2px 0;</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-}</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-@media (-moz-windows-default-theme) {</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-  #msgIdentity {</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-    border-radius: 0;</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">-    border-bottom-color: #a9b7c9;</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">-  }</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineminus">-</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineminus">-  #msgIdentity:hover,</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineminus">-  #msgIdentity:focus,</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineminus">-  #msgIdentity:focus-within,</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-  #msgIdentity[focused=&quot;true&quot;] {</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineminus">-    background-color: -moz-field;</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineminus">-    border-color: #a9b7c9;</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-  }</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-  #msgIdentity[is=&quot;menulist-editable&quot;][editable=&quot;true&quot;] &gt; .menulist-dropmarker {</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-    margin-inline-start: 3px;</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-    margin-inline-end: -3px;</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">-  }</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">-}</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-</span>
<a href="#l30.253"></a><span id="l30.253"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l30.254"></a><span id="l30.254"> </span>
<a href="#l30.255"></a><span id="l30.255"> @media (-moz-windows-default-theme) {</span>
<a href="#l30.256"></a><span id="l30.256">   menulist {</span>
<a href="#l30.257"></a><span id="l30.257">     -moz-appearance: none;</span>
<a href="#l30.258"></a><span id="l30.258">     margin: 1px 4px;</span>
<a href="#l30.259"></a><span id="l30.259">     padding: 1px 5px;</span>
<a href="#l30.260"></a><span id="l30.260">   }</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineat">@@ -629,46 +537,29 @@ toolbar:not(:-moz-lwtheme) {</span>
<a href="#l30.262"></a><span id="l30.262">   min-height: 0;</span>
<a href="#l30.263"></a><span id="l30.263">   height: 5px;</span>
<a href="#l30.264"></a><span id="l30.264">   margin-top: -5px;</span>
<a href="#l30.265"></a><span id="l30.265">   border-top-width: 0;</span>
<a href="#l30.266"></a><span id="l30.266">   border-bottom-color: var(--splitter-color);</span>
<a href="#l30.267"></a><span id="l30.267">   background-color: transparent;</span>
<a href="#l30.268"></a><span id="l30.268"> }</span>
<a href="#l30.269"></a><span id="l30.269"> </span>
<a href="#l30.270"></a><span id="l30.270" class="difflineminus">-#subjectLabel {</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-  margin-top: 0;</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">-}</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineminus">-</span>
<a href="#l30.274"></a><span id="l30.274"> /* ::::: autocomplete icons ::::: */</span>
<a href="#l30.275"></a><span id="l30.275"> </span>
<a href="#l30.276"></a><span id="l30.276"> .ac-site-icon {</span>
<a href="#l30.277"></a><span id="l30.277">   display: -moz-box;</span>
<a href="#l30.278"></a><span id="l30.278">   margin: 1px 5px;</span>
<a href="#l30.279"></a><span id="l30.279"> }</span>
<a href="#l30.280"></a><span id="l30.280"> </span>
<a href="#l30.281"></a><span id="l30.281"> .autocomplete-richlistitem[type=&quot;subscribed-news&quot;] &gt; .ac-site-icon {</span>
<a href="#l30.282"></a><span id="l30.282">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder.png&quot;);</span>
<a href="#l30.283"></a><span id="l30.283">   -moz-image-region: rect(0 160px 16px 144px);</span>
<a href="#l30.284"></a><span id="l30.284"> }</span>
<a href="#l30.285"></a><span id="l30.285"> </span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-/* ::::: addressing widget ::::: */</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-</span>
<a href="#l30.288"></a><span id="l30.288"> @media (-moz-windows-default-theme) {</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-  .textbox-addressingWidget,</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-  .dummy-row-cell:last-child {</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-    border-bottom-color: #a9b7c9 !important;</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-  }</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-  .textbox-addressingWidget:hover,</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-  .textbox-addressingWidget:focus {</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-    background-color: -moz-field;</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineminus">-    border-color: #a9b7c9 !important;</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineminus">-  }</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineminus">-</span>
<a href="#l30.300"></a><span id="l30.300">   menulist,</span>
<a href="#l30.301"></a><span id="l30.301">   menulist[disabled=&quot;true&quot;] {</span>
<a href="#l30.302"></a><span id="l30.302">     color: inherit;</span>
<a href="#l30.303"></a><span id="l30.303">     border: 1px solid;</span>
<a href="#l30.304"></a><span id="l30.304">     background: var(--toolbarbutton-hover-background);</span>
<a href="#l30.305"></a><span id="l30.305">     border-color: var(--toolbarbutton-hover-bordercolor);</span>
<a href="#l30.306"></a><span id="l30.306">     box-shadow: var(--toolbarbutton-hover-boxshadow);</span>
<a href="#l30.307"></a><span id="l30.307">     transition-property: background-color, border-color, box-shadow;</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineat">@@ -700,54 +591,16 @@ toolbar:not(:-moz-lwtheme) {</span>
<a href="#l30.309"></a><span id="l30.309">   }</span>
<a href="#l30.310"></a><span id="l30.310"> </span>
<a href="#l30.311"></a><span id="l30.311">   .menulist-dropmarker::part(icon) {</span>
<a href="#l30.312"></a><span id="l30.312">     width: 9px;</span>
<a href="#l30.313"></a><span id="l30.313">     height: 7px;</span>
<a href="#l30.314"></a><span id="l30.314">   }</span>
<a href="#l30.315"></a><span id="l30.315"> }</span>
<a href="#l30.316"></a><span id="l30.316"> </span>
<a href="#l30.317"></a><span id="l30.317" class="difflineminus">-.aw-menulist {</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/toolbarbutton-arrow.svg&quot;);</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-  -moz-context-properties: fill;</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineminus">-  fill: currentColor;</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-}</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineminus">-</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-.aw-menulist &gt; .menulist-label-box &gt; .menulist-icon {</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-  width: 9px;</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-  height: 7px;</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineminus">-  margin-inline-start: 2px;</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineminus">-}</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">-</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineminus">-@media (-moz-windows-default-theme: 0) {</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineminus">-  .aw-menulist {</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-    background-color: rgba(128, 128, 128, .3);</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-    border: 1px solid ThreeDShadow;</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-    transition: background-color .25s ease-in;</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-  }</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineminus">-  .aw-menulist:hover {</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-    background-color: rgba(128, 128, 128, .45);</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-  }</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineminus">-</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineminus">-  .aw-menulist:focus:not([open=&quot;true&quot;]) &gt; .menulist-label-box {</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineminus">-    background-color: inherit;</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-    color: inherit;</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineminus">-  }</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineminus">-}</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-.aw-menulist &gt; .menulist-label-box {</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineminus">-  margin: -1px 0;</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-}</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineminus">-</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineminus">-.aw-menulist &gt; .menulist-label-box &gt; .menulist-label {</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineminus">-  margin: 0 3px !important;</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-  text-align: end;</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">-}</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-</span>
<a href="#l30.355"></a><span id="l30.355"> /* ::::: address book sidebar ::::: */</span>
<a href="#l30.356"></a><span id="l30.356"> </span>
<a href="#l30.357"></a><span id="l30.357"> #sidebar-box .sidebar-header {</span>
<a href="#l30.358"></a><span id="l30.358">   border-bottom: 1px solid ThreeDShadow;</span>
<a href="#l30.359"></a><span id="l30.359">   border-top: 1px solid ThreeDHighlight;</span>
<a href="#l30.360"></a><span id="l30.360"> }</span>
<a href="#l30.361"></a><span id="l30.361"> </span>
<a href="#l30.362"></a><span id="l30.362"> @media (-moz-windows-default-theme) {</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineat">@@ -782,20 +635,16 @@ toolbar:not(:-moz-lwtheme) {</span>
<a href="#l30.364"></a><span id="l30.364">   menulist {</span>
<a href="#l30.365"></a><span id="l30.365">     border-radius: 2px;</span>
<a href="#l30.366"></a><span id="l30.366">   }</span>
<a href="#l30.367"></a><span id="l30.367"> </span>
<a href="#l30.368"></a><span id="l30.368">   menulist[open=&quot;true&quot;] {</span>
<a href="#l30.369"></a><span id="l30.369">     text-shadow: none;</span>
<a href="#l30.370"></a><span id="l30.370">     transition: none;</span>
<a href="#l30.371"></a><span id="l30.371">   }</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineminus">-</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineminus">-  .aw-menulist {</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-    box-shadow: none;</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-  }</span>
<a href="#l30.376"></a><span id="l30.376"> }</span>
<a href="#l30.377"></a><span id="l30.377"> </span>
<a href="#l30.378"></a><span id="l30.378"> @media (-moz-windows-glass) {</span>
<a href="#l30.379"></a><span id="l30.379">   #compose-toolbox:not(:-moz-lwtheme) {</span>
<a href="#l30.380"></a><span id="l30.380">     color: black;</span>
<a href="#l30.381"></a><span id="l30.381">     text-shadow: 0 0 .7em white, 0 0 .7em white, 0 1px 0 rgba(255, 255, 255, .4);</span>
<a href="#l30.382"></a><span id="l30.382">   }</span>
<a href="#l30.383"></a><span id="l30.383"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/themes/windows/mail/messenger.css</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/themes/windows/mail/messenger.css</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -21,17 +21,17 @@</span>
<a href="#l31.4"></a><span id="l31.4">   --toolbar-non-lwt-bgimage: linear-gradient(rgba(255,255,255,.15), rgba(255,255,255,.15));</span>
<a href="#l31.5"></a><span id="l31.5">   --toolbar-bgcolor: var(--toolbar-non-lwt-bgcolor);</span>
<a href="#l31.6"></a><span id="l31.6">   --toolbar-bgimage: var(--toolbar-non-lwt-bgimage);</span>
<a href="#l31.7"></a><span id="l31.7">   --chrome-content-separator-color: ThreeDShadow;</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9">   --toolbarbutton-border-radius: 2px;</span>
<a href="#l31.10"></a><span id="l31.10">   --toolbarbutton-icon-fill-opacity: .85;</span>
<a href="#l31.11"></a><span id="l31.11">   --toolbarbutton-hover-background: rgba(0, 0, 0, .1);</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  --toolbarbutton-hover-bordercolor: rgba(0, 0, 0, .1);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  --toolbarbutton-hover-bordercolor: rgba(0, 0, 0, .25);</span>
<a href="#l31.14"></a><span id="l31.14">   --toolbarbutton-header-bordercolor: rgba(0, 0, 0, .1);</span>
<a href="#l31.15"></a><span id="l31.15">   --toolbarbutton-hover-boxshadow: none;</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">   --toolbarbutton-active-background: rgba(0, 0, 0, .15);</span>
<a href="#l31.18"></a><span id="l31.18">   --toolbarbutton-active-bordercolor: rgba(0, 0, 0, .15);</span>
<a href="#l31.19"></a><span id="l31.19">   --toolbarbutton-active-boxshadow: 0 0 0 1px rgba(0, 0, 0, .15) inset;</span>
<a href="#l31.20"></a><span id="l31.20"> </span>
<a href="#l31.21"></a><span id="l31.21">   --toolbarbutton-checkedhover-backgroundcolor: rgba(0, 0, 0, .2);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/addrbook/content/abMailListDialog.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/addrbook/content/abMailListDialog.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -20,16 +20,31 @@ top.MAX_RECIPIENTS = 1;</span>
<a href="#l32.4"></a><span id="l32.4"> var inputElementType = &quot;&quot;;</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6"> var gListCard;</span>
<a href="#l32.7"></a><span id="l32.7"> var gEditList;</span>
<a href="#l32.8"></a><span id="l32.8"> var gOldListName = &quot;&quot;;</span>
<a href="#l32.9"></a><span id="l32.9"> var gLoadListeners = [];</span>
<a href="#l32.10"></a><span id="l32.10"> var gSaveListeners = [];</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+var gAWContentHeight = 0;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+var gAWRowHeight = 0;</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+var gNumberOfCols = 0;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+var test_addresses_sequence = false;</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+if (</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+  Services.prefs.getPrefType(&quot;mail.debug.test_addresses_sequence&quot;) ==</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+  Ci.nsIPrefBranch.PREF_BOOL</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+) {</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+  test_addresses_sequence = Services.prefs.getBoolPref(</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+    &quot;mail.debug.test_addresses_sequence&quot;</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+  );</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+}</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+</span>
<a href="#l32.27"></a><span id="l32.27"> try {</span>
<a href="#l32.28"></a><span id="l32.28">   var gDragService = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;].getService(</span>
<a href="#l32.29"></a><span id="l32.29">     Ci.nsIDragService</span>
<a href="#l32.30"></a><span id="l32.30">   );</span>
<a href="#l32.31"></a><span id="l32.31"> } catch (e) {}</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33"> // Returns the load context for the current window</span>
<a href="#l32.34"></a><span id="l32.34"> function getLoadContext() {</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineat">@@ -457,20 +472,67 @@ function awAppendNewRow(setFocus) {</span>
<a href="#l32.36"></a><span id="l32.36">       awSetFocusTo(input);</span>
<a href="#l32.37"></a><span id="l32.37">     }</span>
<a href="#l32.38"></a><span id="l32.38">   }</span>
<a href="#l32.39"></a><span id="l32.39">   return input;</span>
<a href="#l32.40"></a><span id="l32.40"> }</span>
<a href="#l32.41"></a><span id="l32.41"> </span>
<a href="#l32.42"></a><span id="l32.42"> // functions for accessing the elements in the addressing widget</span>
<a href="#l32.43"></a><span id="l32.43"> </span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+/**</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+ * Returns the recipient type popup for a row.</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+ *</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+ * @param {String} row - Index of the recipient row to return. Starts at 1.</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+ * @return {HTMLElement} This returns the menulist (not its child menupopup),</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+ *   despite the function name.</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+ */</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+function awGetPopupElement(row) {</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+  return document.getElementById(&quot;addressCol1#&quot; + row);</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+}</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+/**</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+ * Returns the recipient inputbox for a row.</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+ *</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+ * @param row  Index of the recipient row to return. Starts at 1.</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+ * @return     This returns the input element.</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+ */</span>
<a href="#l32.61"></a><span id="l32.61"> function awGetInputElement(row) {</span>
<a href="#l32.62"></a><span id="l32.62">   return document.getElementById(&quot;addressCol1#&quot; + row);</span>
<a href="#l32.63"></a><span id="l32.63"> }</span>
<a href="#l32.64"></a><span id="l32.64"> </span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+function awGetElementByCol(row, col) {</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  var colID = &quot;addressCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+  return document.getElementById(colID);</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+}</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+function awGetListItem(row) {</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+  if (listbox &amp;&amp; row &gt; 0) {</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+    return listbox.getItemAtIndex(row - 1);</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+  }</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+  return null;</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+}</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+/**</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+ * @param inputElement  The recipient input element.</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+ * @return              The row index (starting from 1) where the input element</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+ *                      is found. 0 if the element is not found.</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+ */</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+function awGetRowByInputElement(inputElement) {</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+  if (!inputElement) {</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+    return 0;</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+  }</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+  var listitem = inputElement.parentNode.parentNode;</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+  return (</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+    document.getElementById(&quot;addressingWidget&quot;).getIndexOfItem(listitem) + 1</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+  );</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+}</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+</span>
<a href="#l32.95"></a><span id="l32.95"> function DragOverAddressListTree(event) {</span>
<a href="#l32.96"></a><span id="l32.96">   var dragSession = gDragService.getCurrentSession();</span>
<a href="#l32.97"></a><span id="l32.97"> </span>
<a href="#l32.98"></a><span id="l32.98">   // XXX add support for other flavors here</span>
<a href="#l32.99"></a><span id="l32.99">   if (dragSession.isDataFlavorSupported(&quot;text/x-moz-address&quot;)) {</span>
<a href="#l32.100"></a><span id="l32.100">     dragSession.canDrop = true;</span>
<a href="#l32.101"></a><span id="l32.101">   }</span>
<a href="#l32.102"></a><span id="l32.102"> }</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineat">@@ -576,8 +638,356 @@ function NotifyLoadListeners(aMailingLis</span>
<a href="#l32.104"></a><span id="l32.104"> </span>
<a href="#l32.105"></a><span id="l32.105"> /* Notifies all save listeners.</span>
<a href="#l32.106"></a><span id="l32.106">  */</span>
<a href="#l32.107"></a><span id="l32.107"> function NotifySaveListeners(aMailingList) {</span>
<a href="#l32.108"></a><span id="l32.108">   for (let i = 0; i &lt; gSaveListeners.length; i++) {</span>
<a href="#l32.109"></a><span id="l32.109">     gSaveListeners[i](aMailingList, document);</span>
<a href="#l32.110"></a><span id="l32.110">   }</span>
<a href="#l32.111"></a><span id="l32.111"> }</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+/**</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+ * Handles keypress events for the email address inputs (that auto-fill)</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+ * in the Address Book Mailing List dialogs. When a comma-separated list of</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+ * addresses is entered on one row, split them into one address per row. Only</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+ * add a new blank row on &quot;Enter&quot; key. On &quot;Tab&quot; key focus moves to the &quot;Cancel&quot;</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+ * button.</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+ *</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+ * @param {KeyboardEvent} event  The DOM keypress event.</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+ * @param {Element} element      The element that triggered the keypress event.</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+ */</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineplus">+function awAbRecipientKeyPress(event, element) {</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+  if (event.key != &quot;Enter&quot; &amp;&amp; event.key != &quot;Tab&quot;) {</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+    return;</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+  }</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+  if (!element.value) {</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+    if (event.key == &quot;Enter&quot;) {</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+      awReturnHit(element);</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+    }</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+  } else {</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+    let inputElement = element;</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+    let originalRow = awGetRowByInputElement(element);</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+    let row;</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+    let addresses = MailServices.headerParser.makeFromDisplayAddress(</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+      element.value</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+    );</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+    if (addresses.length &gt; 1) {</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+      // Collect any existing addresses from the following rows so we don't</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+      // simply overwrite them.</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+      row = originalRow + 1;</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+      inputElement = awGetInputElement(row);</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+      while (inputElement) {</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+        if (inputElement.value) {</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+          addresses.push(inputElement.value);</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+          inputElement.value = &quot;&quot;;</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+        }</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+        row += 1;</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+        inputElement = awGetInputElement(row);</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+      }</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+    }</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+    // Insert the addresses, adding new rows if needed.</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+    row = originalRow;</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineplus">+    let needNewRows = false;</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineplus">+</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineplus">+    for (let address of addresses) {</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineplus">+      if (needNewRows) {</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineplus">+        inputElement = awAppendNewRow(false);</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineplus">+      } else {</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineplus">+        inputElement = awGetInputElement(row);</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineplus">+        if (!inputElement) {</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineplus">+          needNewRows = true;</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineplus">+          inputElement = awAppendNewRow(false);</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+        }</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+      }</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineplus">+      if (inputElement) {</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineplus">+        inputElement.value = address;</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineplus">+      }</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineplus">+      row += 1;</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineplus">+    }</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineplus">+    if (event.key == &quot;Enter&quot;) {</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineplus">+      // Prevent the dialog from closing. &quot;Enter&quot; inserted a new row instead.</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineplus">+      event.preventDefault();</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+      awReturnHit(inputElement);</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+    } else if (event.key == &quot;Tab&quot;) {</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+      // Focus the last row to let &quot;Tab&quot; move focus to the &quot;Cancel&quot; button.</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+      let lastRow = row - 1;</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+      awGetInputElement(lastRow).focus();</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+    }</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineplus">+  }</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+}</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineplus">+/**</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineplus">+ * Handle keydown event on a recipient input.</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineplus">+ * Enables recipient row deletion with DEL or BACKSPACE and</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineplus">+ * recipient list navigation with cursor up/down.</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineplus">+ *</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineplus">+ * Note that the keydown event fires for ALL keys, so this may affect</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineplus">+ * autocomplete as user enters a recipient text.</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineplus">+ *</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineplus">+ * @param {keydown event} event  the keydown event fired on a recipient input</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineplus">+ * @param {&lt;html:input&gt;} inputElement  the recipient input element</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+ *                                     on which the event fired (textbox-addressingWidget)</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineplus">+ */</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineplus">+function awRecipientKeyDown(event, inputElement) {</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineplus">+  switch (event.key) {</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineplus">+    // Enable deletion of empty recipient rows.</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineplus">+    case &quot;Delete&quot;:</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineplus">+    case &quot;Backspace&quot;:</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineplus">+      if (inputElement.textLength == 1 &amp;&amp; event.repeat) {</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineplus">+        // User is holding down Delete or Backspace to delete recipient text</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineplus">+        // inline and is now deleting the last character: Set flag to</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineplus">+        // temporarily block row deletion.</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineplus">+        top.awRecipientInlineDelete = true;</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineplus">+      }</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineplus">+      if (!inputElement.value &amp;&amp; !event.altKey) {</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineplus">+        // When user presses DEL or BACKSPACE on an empty row, and it's not an</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineplus">+        // ongoing inline deletion, and not ALT+BACKSPACE for input undo,</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineplus">+        // we delete the row.</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineplus">+        if (top.awRecipientInlineDelete &amp;&amp; !event.repeat) {</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineplus">+          // User has released and re-pressed Delete or Backspace key</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineplus">+          // after holding them down to delete recipient text inline:</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineplus">+          // unblock row deletion.</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineplus">+          top.awRecipientInlineDelete = false;</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineplus">+        }</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineplus">+        if (!top.awRecipientInlineDelete) {</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineplus">+          let deleteForward = event.key == &quot;Delete&quot;;</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineplus">+          awDeleteHit(inputElement, deleteForward);</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineplus">+        }</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineplus">+      }</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineplus">+      break;</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineplus">+</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineplus">+    // Enable browsing the list of recipients up and down with cursor keys.</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineplus">+    case &quot;ArrowDown&quot;:</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineplus">+    case &quot;ArrowUp&quot;:</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineplus">+      // Only browse recipients if the autocomplete popup is not open.</span>
<a href="#l32.233"></a><span id="l32.233" class="difflineplus">+      if (!inputElement.popupOpen) {</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineplus">+        let row = awGetRowByInputElement(inputElement);</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineplus">+        let down = event.key == &quot;ArrowDown&quot;;</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineplus">+        let noEdgeRow = down ? row &lt; top.MAX_RECIPIENTS : row &gt; 1;</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineplus">+        if (noEdgeRow) {</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineplus">+          let targetRow = down ? row + 1 : row - 1;</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineplus">+          awSetFocusTo(awGetInputElement(targetRow));</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineplus">+        }</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineplus">+      }</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineplus">+      break;</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineplus">+  }</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineplus">+}</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineplus">+</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineplus">+/**</span>
<a href="#l32.247"></a><span id="l32.247" class="difflineplus">+ * Delete recipient row (addressingWidgetItem) from UI.</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineplus">+ *</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineplus">+ * @param {&lt;html:input&gt;} inputElement  the recipient input element</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineplus">+ *                                     (textbox-addressingWidget) whose parent</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineplus">+ *                                     row (addressingWidgetItem) will be deleted.</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineplus">+ * @param {boolean} deleteForward  true: focus next row after deleting the row</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineplus">+ *                                 false: focus previous row after deleting the row</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineplus">+ */</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineplus">+function awDeleteHit(inputElement, deleteForward = false) {</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineplus">+  let row = awGetRowByInputElement(inputElement);</span>
<a href="#l32.257"></a><span id="l32.257" class="difflineplus">+</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineplus">+  // Don't delete the row if it's the last one remaining; just reset it.</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineplus">+  if (top.MAX_RECIPIENTS &lt;= 1) {</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineplus">+    inputElement.value = &quot;&quot;;</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineplus">+    return;</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineplus">+  }</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineplus">+</span>
<a href="#l32.264"></a><span id="l32.264" class="difflineplus">+  // Set the focus to the input field of the next/previous row according to</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineplus">+  // the direction of deleting if possible.</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineplus">+  // Note: awSetFocusTo() is asynchronous, i.e. we'll focus after row removal.</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineplus">+  if (</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineplus">+    (!deleteForward &amp;&amp; row &gt; 1) ||</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineplus">+    (deleteForward &amp;&amp; row == top.MAX_RECIPIENTS)</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineplus">+  ) {</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineplus">+    // We're deleting backwards, but not the first row,</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineplus">+    // or forwards on the last row: Focus previous row.</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineplus">+    awSetFocusTo(awGetInputElement(row - 1));</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineplus">+  } else {</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineplus">+    // We're deleting forwards, but not the last row,</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineplus">+    // or backwards on the first row: Focus next row.</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineplus">+    awSetFocusTo(awGetInputElement(row + 1));</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineplus">+  }</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineplus">+</span>
<a href="#l32.280"></a><span id="l32.280" class="difflineplus">+  // Delete the row.</span>
<a href="#l32.281"></a><span id="l32.281" class="difflineplus">+  awDeleteRow(row);</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineplus">+}</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineplus">+</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineplus">+function awTestRowSequence() {</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineplus">+  /*</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineplus">+    This function is for debug and testing purpose only, normal user should not run it!</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineplus">+</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineplus">+    Every time we insert or delete a row, we must be sure we didn't break the ID sequence of</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineplus">+    the addressing widget rows. This function will run a quick test to see if the sequence still ok</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineplus">+</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineplus">+    You need to define the pref mail.debug.test_addresses_sequence to true in order to activate it</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineplus">+  */</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineplus">+</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineplus">+  if (!test_addresses_sequence) {</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineplus">+    return true;</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineplus">+  }</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineplus">+</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineplus">+  // Debug code to verify the sequence is still good.</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineplus">+</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineplus">+  let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineplus">+  let listitems = listbox.itemChildren;</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineplus">+  if (listitems.length &gt;= top.MAX_RECIPIENTS) {</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineplus">+    for (let i = 1; i &lt;= listitems.length; i++) {</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineplus">+      let item = listitems[i - 1];</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineplus">+      let inputID = item</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineplus">+        .querySelector(`input[is=&quot;autocomplete-input&quot;]`)</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineplus">+        .id.split(&quot;#&quot;)[1];</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineplus">+      let menulist = item.querySelector(&quot;menulist&quot;);</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineplus">+      // In some places like the mailing list dialog there is no menulist,</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineplus">+      // and so no popupID that needs to be kept in sequence.</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineplus">+      let popupID = menulist &amp;&amp; menulist.id.split(&quot;#&quot;)[1];</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineplus">+      if (inputID != i || (popupID &amp;&amp; popupID != i)) {</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineplus">+        dump(</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineplus">+          `#ERROR: sequence broken at row ${i}, ` +</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineplus">+            `inputID=${inputID}, popupID=${popupID}\n`</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineplus">+        );</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineplus">+        return false;</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineplus">+      }</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineplus">+      dump(&quot;---SEQUENCE OK---\n&quot;);</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineplus">+      return true;</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineplus">+    }</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineplus">+  } else {</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineplus">+    dump(</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineplus">+      `#ERROR: listitems.length(${listitems.length}) &lt; ` +</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineplus">+        `top.MAX_RECIPIENTS(${top.MAX_RECIPIENTS})\n`</span>
<a href="#l32.326"></a><span id="l32.326" class="difflineplus">+    );</span>
<a href="#l32.327"></a><span id="l32.327" class="difflineplus">+  }</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineplus">+</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineplus">+  return false;</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineplus">+}</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineplus">+</span>
<a href="#l32.332"></a><span id="l32.332" class="difflineplus">+function awRemoveRow(row) {</span>
<a href="#l32.333"></a><span id="l32.333" class="difflineplus">+  awGetListItem(row).remove();</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineplus">+  awFitDummyRows();</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineplus">+</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineplus">+  top.MAX_RECIPIENTS--;</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineplus">+}</span>
<a href="#l32.338"></a><span id="l32.338" class="difflineplus">+</span>
<a href="#l32.339"></a><span id="l32.339" class="difflineplus">+function awGetNumberOfCols() {</span>
<a href="#l32.340"></a><span id="l32.340" class="difflineplus">+  if (gNumberOfCols == 0) {</span>
<a href="#l32.341"></a><span id="l32.341" class="difflineplus">+    var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineplus">+    var listCols = listbox.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineplus">+    gNumberOfCols = listCols.length;</span>
<a href="#l32.344"></a><span id="l32.344" class="difflineplus">+    if (!gNumberOfCols) {</span>
<a href="#l32.345"></a><span id="l32.345" class="difflineplus">+      // If no cols defined, that means we have only one!</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineplus">+      gNumberOfCols = 1;</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineplus">+    }</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineplus">+  }</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineplus">+</span>
<a href="#l32.350"></a><span id="l32.350" class="difflineplus">+  return gNumberOfCols;</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineplus">+}</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineplus">+</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineplus">+function awCreateDummyItem(aParent) {</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineplus">+  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineplus">+  var item = listbox.getItemAtIndex(0);</span>
<a href="#l32.356"></a><span id="l32.356" class="difflineplus">+</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineplus">+  var titem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineplus">+  titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineplus">+  titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineplus">+  titem.style.height = item.getBoundingClientRect().height + &quot;px&quot;;</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineplus">+</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineplus">+  for (let i = 0; i &lt; awGetNumberOfCols(); i++) {</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineplus">+    let cell = awCreateDummyCell(titem);</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineplus">+    if (item.children[i].hasAttribute(&quot;style&quot;)) {</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineplus">+      cell.setAttribute(&quot;style&quot;, item.children[i].getAttribute(&quot;style&quot;));</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineplus">+    }</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineplus">+    if (item.children[i].hasAttribute(&quot;flex&quot;)) {</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineplus">+      cell.setAttribute(&quot;flex&quot;, item.children[i].getAttribute(&quot;flex&quot;));</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineplus">+    }</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineplus">+  }</span>
<a href="#l32.371"></a><span id="l32.371" class="difflineplus">+</span>
<a href="#l32.372"></a><span id="l32.372" class="difflineplus">+  if (aParent) {</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineplus">+    aParent.appendChild(titem);</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineplus">+  }</span>
<a href="#l32.375"></a><span id="l32.375" class="difflineplus">+</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineplus">+  return titem;</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineplus">+}</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineplus">+</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineplus">+function awFitDummyRows() {</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineplus">+  awCalcContentHeight();</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineplus">+  awCreateOrRemoveDummyRows();</span>
<a href="#l32.382"></a><span id="l32.382" class="difflineplus">+}</span>
<a href="#l32.383"></a><span id="l32.383" class="difflineplus">+</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineplus">+function awCreateOrRemoveDummyRows() {</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineplus">+  let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineplus">+  let listboxHeight = listbox.getBoundingClientRect().height;</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineplus">+</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineplus">+  // remove rows to remove scrollbar</span>
<a href="#l32.389"></a><span id="l32.389" class="difflineplus">+  let kids = listbox.querySelectorAll(&quot;[_isDummyRow]&quot;);</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineplus">+  for (</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineplus">+    let i = kids.length - 1;</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineplus">+    gAWContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0;</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineplus">+    --i</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineplus">+  ) {</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineplus">+    gAWContentHeight -= gAWRowHeight;</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineplus">+    kids[i].remove();</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineplus">+  }</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineplus">+</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineplus">+  // add rows to fill space</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineplus">+  if (gAWRowHeight) {</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineplus">+    while (gAWContentHeight + gAWRowHeight &lt; listboxHeight) {</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineplus">+      awCreateDummyItem(listbox);</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineplus">+      gAWContentHeight += gAWRowHeight;</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineplus">+    }</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineplus">+  }</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineplus">+}</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineplus">+</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineplus">+function awCalcContentHeight() {</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineplus">+  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineplus">+  var items = listbox.itemChildren;</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineplus">+</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineplus">+  gAWContentHeight = 0;</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineplus">+  if (items.length &gt; 0) {</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineplus">+    // all rows are forced to a uniform height in xul listboxes, so</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineplus">+    // find the first listitem with a boxObject and use it as precedent</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineplus">+    var i = 0;</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineplus">+    do {</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineplus">+      gAWRowHeight = items[i].getBoundingClientRect().height;</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineplus">+      ++i;</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineplus">+    } while (i &lt; items.length &amp;&amp; !gAWRowHeight);</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineplus">+    gAWContentHeight = gAWRowHeight * items.length;</span>
<a href="#l32.422"></a><span id="l32.422" class="difflineplus">+  }</span>
<a href="#l32.423"></a><span id="l32.423" class="difflineplus">+}</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineplus">+</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineplus">+/* ::::::::::: addressing widget dummy rows ::::::::::::::::: */</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineplus">+</span>
<a href="#l32.427"></a><span id="l32.427" class="difflineplus">+function awCreateDummyCell(aParent) {</span>
<a href="#l32.428"></a><span id="l32.428" class="difflineplus">+  var cell = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l32.429"></a><span id="l32.429" class="difflineplus">+  cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l32.430"></a><span id="l32.430" class="difflineplus">+  if (aParent) {</span>
<a href="#l32.431"></a><span id="l32.431" class="difflineplus">+    aParent.appendChild(cell);</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineplus">+  }</span>
<a href="#l32.433"></a><span id="l32.433" class="difflineplus">+</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineplus">+  return cell;</span>
<a href="#l32.435"></a><span id="l32.435" class="difflineplus">+}</span>
<a href="#l32.436"></a><span id="l32.436" class="difflineplus">+</span>
<a href="#l32.437"></a><span id="l32.437" class="difflineplus">+function awGetNextDummyRow() {</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineplus">+  // gets the next row from the top down</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineplus">+  return document.querySelector(&quot;#addressingWidget &gt; [_isDummyRow]&quot;);</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineplus">+}</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineplus">+</span>
<a href="#l32.442"></a><span id="l32.442" class="difflineplus">+/**</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineplus">+ * Set focus to the specified element, typically a recipient input element.</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineplus">+ * We do this asynchronously to allow other processes like adding or removing rows</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineplus">+ * to complete before shifting focus.</span>
<a href="#l32.446"></a><span id="l32.446" class="difflineplus">+ *</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineplus">+ * @param element  the element to receive focus asynchronously</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineplus">+ */</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineplus">+function awSetFocusTo(element) {</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineplus">+  // Remember the (input) element to focus for asynchronous focusing, so that we</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineplus">+  // play safe if this gets called again and the original element gets removed</span>
<a href="#l32.452"></a><span id="l32.452" class="difflineplus">+  // before we can focus it.</span>
<a href="#l32.453"></a><span id="l32.453" class="difflineplus">+  top.awInputToFocus = element;</span>
<a href="#l32.454"></a><span id="l32.454" class="difflineplus">+  setTimeout(_awSetFocusTo, 0);</span>
<a href="#l32.455"></a><span id="l32.455" class="difflineplus">+}</span>
<a href="#l32.456"></a><span id="l32.456" class="difflineplus">+</span>
<a href="#l32.457"></a><span id="l32.457" class="difflineplus">+function _awSetFocusTo() {</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineplus">+  top.awInputToFocus.focus();</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

