<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26805:0146e4f2fdaf0c60393d24808e76047e0b7ee32a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0146e4f2fdaf0c60393d24808e76047e0b7ee32a" />
<meta property="og:url" content="/comm-central/rev/0146e4f2fdaf0c60393d24808e76047e0b7ee32a" />
<meta property="og:description" content="Bug 1550487 - OTR: Implement per-account preferences UI. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0146e4f2fdaf0c60393d24808e76047e0b7ee32a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0146e4f2fdaf0c60393d24808e76047e0b7ee32a">shortlog</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0146e4f2fdaf0c60393d24808e76047e0b7ee32a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a">files</a> |
changeset |
<a href="/comm-central/raw-rev/0146e4f2fdaf0c60393d24808e76047e0b7ee32a">raw</a>  | <a href="/comm-central/archive/0146e4f2fdaf0c60393d24808e76047e0b7ee32a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1550487">Bug 1550487</a> - OTR: Implement per-account preferences UI. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 04 Jun 2019 22:57:54 +0200</td></tr>

<tr>
 <td>changeset 26805</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0146e4f2fdaf0c60393d24808e76047e0b7ee32a">0146e4f2fdaf0c60393d24808e76047e0b7ee32a</a></td>
</tr>



<tr>
<td>parent 26804</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/653cffcb9c305b8a3db751210cc84c991b9298c8">653cffcb9c305b8a3db751210cc84c991b9298c8</a>
</td>
</tr>

<tr>
<td>child 26806</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fe88d825d3c671d9b24f56f1477e30302c7cebca">fe88d825d3c671d9b24f56f1477e30302c7cebca</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0146e4f2fdaf0c60393d24808e76047e0b7ee32a">16003</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Jun 2019 21:56:17 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b12420c26104 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b12420c26104dd203307856e5086cb3139493c89">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b12420c26104dd203307856e5086cb3139493c89&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b12420c26104dd203307856e5086cb3139493c89&newProject=comm-central&newRevision=72186adac207b27578a212a09fb4da7a235d97df&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b12420c26104dd203307856e5086cb3139493c89&newProject=comm-central&newRevision=72186adac207b27578a212a09fb4da7a235d97df&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b12420c26104dd203307856e5086cb3139493c89&newProject=comm-central&newRevision=72186adac207b27578a212a09fb4da7a235d97df&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1550487">1550487</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1550487">Bug 1550487</a> - OTR: Implement per-account preferences UI. r=mkmelin

Contains UI code by Alessandro Castellani &lt;alessandro@thunderbird.net&gt;

Differential Revision: <a href="https://phabricator.services.mozilla.com/D32837">https://phabricator.services.mozilla.com/D32837</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/jar.mn">chat/content/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/jar.mn">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/jar.mn">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/jar.mn">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/jar.mn">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-add-fingerprint.xul">chat/content/otr-add-fingerprint.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-add-fingerprint.xul">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-add-fingerprint.xul">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-add-fingerprint.xul">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-add-fingerprint.xul">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-add-fingerprint.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-auth.xul">chat/content/otr-auth.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-auth.xul">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-auth.xul">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-auth.xul">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-auth.xul">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-auth.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.js">chat/content/otr-finger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.js">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.js">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.js">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.js">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.xul">chat/content/otr-finger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.xul">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.xul">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.xul">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.xul">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-finger.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.js">chat/content/otr-generate-key.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.js">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.js">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.js">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.js">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.xul">chat/content/otr-generate-key.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.xul">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.xul">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.xul">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.xul">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr-generate-key.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/am-im-otr.ftl">chat/content/otr/am-im-otr.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/am-im-otr.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/am-im-otr.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/am-im-otr.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/am-im-otr.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/am-im-otr.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/auth.ftl">chat/content/otr/auth.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/auth.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/auth.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/auth.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/auth.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/auth.ftl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/chat.ftl">chat/content/otr/chat.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/chat.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/chat.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/chat.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/chat.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/chat.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/finger.ftl">chat/content/otr/finger.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/finger.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/finger.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/finger.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/finger.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/finger.ftl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/generate-key.ftl">chat/content/otr/generate-key.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/generate-key.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/generate-key.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/generate-key.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/generate-key.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/generate-key.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otr.ftl">chat/content/otr/otr.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otr.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otr.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otr.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otr.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otr.ftl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otrUI.ftl">chat/content/otr/otrUI.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otrUI.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otrUI.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otrUI.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otrUI.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/content/otr/otrUI.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/locales/jar.mn">chat/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTR.jsm">chat/modules/OTR.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTR.jsm">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTR.jsm">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTR.jsm">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTR.jsm">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTR.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRLib.jsm">chat/modules/OTRLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRLib.jsm">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRLib.jsm">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRLib.jsm">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRLib.jsm">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRUI.jsm">chat/modules/OTRUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRUI.jsm">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRUI.jsm">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRUI.jsm">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRUI.jsm">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/chat/modules/OTRUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.js">mail/components/im/content/am-im.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.js">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.js">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.js">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.js">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.xul">mail/components/im/content/am-im.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.xul">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.xul">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.xul">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.xul">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/content/am-im.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/imIncomingServer.js">mail/components/im/imIncomingServer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/imIncomingServer.js">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/imIncomingServer.js">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/imIncomingServer.js">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/imIncomingServer.js">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/components/im/imIncomingServer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/en-US/messenger/preferences/am-im.ftl">mail/locales/en-US/messenger/preferences/am-im.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/en-US/messenger/preferences/am-im.ftl">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/en-US/messenger/preferences/am-im.ftl">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/en-US/messenger/preferences/am-im.ftl">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/en-US/messenger/preferences/am-im.ftl">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/en-US/messenger/preferences/am-im.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/0146e4f2fdaf0c60393d24808e76047e0b7ee32a/mail/locales/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/content/jar.mn</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/content/jar.mn</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -11,11 +11,13 @@ chat.jar:</span>
<a href="#l1.4"></a><span id="l1.4"> 	content/chat/chat-account-richlistitem.js</span>
<a href="#l1.5"></a><span id="l1.5"> *	content/chat/imtooltip.xml</span>
<a href="#l1.6"></a><span id="l1.6"> 	content/chat/conversation-browser.js</span>
<a href="#l1.7"></a><span id="l1.7"> 	content/chat/conv.html</span>
<a href="#l1.8"></a><span id="l1.8"> 	content/chat/otr-add-fingerprint.js</span>
<a href="#l1.9"></a><span id="l1.9"> 	content/chat/otr-add-fingerprint.xul</span>
<a href="#l1.10"></a><span id="l1.10"> 	content/chat/otr-auth.js</span>
<a href="#l1.11"></a><span id="l1.11"> 	content/chat/otr-auth.xul</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+	content/chat/otr-finger.js</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+	content/chat/otr-finger.xul</span>
<a href="#l1.14"></a><span id="l1.14"> 	content/chat/otr-generate-key.js</span>
<a href="#l1.15"></a><span id="l1.15"> 	content/chat/otr-generate-key.xul</span>
<a href="#l1.16"></a><span id="l1.16"> 	content/chat/otrWorker.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/content/otr-add-fingerprint.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/content/otr-add-fingerprint.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -16,17 +16,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">         xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l2.5"></a><span id="l2.5">         buttons=&quot;accept,cancel&quot;</span>
<a href="#l2.6"></a><span id="l2.6">         buttondisabledaccept=&quot;true&quot;&gt;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   &lt;linkset&gt;</span>
<a href="#l2.9"></a><span id="l2.9">     &lt;html:link rel=&quot;localization&quot; href=&quot;messenger/otr/add-finger.ftl&quot;/&gt;</span>
<a href="#l2.10"></a><span id="l2.10">   &lt;/linkset&gt;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://chat/content/otr-add-fingerprint.js&quot;/&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  &lt;script src=&quot;chrome://chat/content/otr-add-fingerprint.js&quot;/&gt;</span>
<a href="#l2.14"></a><span id="l2.14">   &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l2.15"></a><span id="l2.15">     &lt;label data-l10n-id=&quot;otr-add-finger-tooltip&quot; control=&quot;name&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l2.16"></a><span id="l2.16">     &lt;hbox id=&quot;fingerBox&quot; align=&quot;baseline&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l2.17"></a><span id="l2.17">       &lt;label data-l10n-id=&quot;otr-add-finger-fingerprint&quot; control=&quot;name&quot;/&gt;</span>
<a href="#l2.18"></a><span id="l2.18">       &lt;textbox id=&quot;finger&quot; oninput=&quot;otrAddFinger.oninput(this)&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l2.19"></a><span id="l2.19">     &lt;/hbox&gt;</span>
<a href="#l2.20"></a><span id="l2.20">   &lt;/vbox&gt;</span>
<a href="#l2.21"></a><span id="l2.21"> &lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/content/otr-auth.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/content/otr-auth.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">   onload=&quot;otrAuth.onload()&quot;</span>
<a href="#l3.5"></a><span id="l3.5">   buttons=&quot;accept,cancel,help&quot;</span>
<a href="#l3.6"></a><span id="l3.6">   buttondisabledaccept=&quot;true&quot;&gt;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   &lt;linkset&gt;</span>
<a href="#l3.9"></a><span id="l3.9">     &lt;html:link rel=&quot;localization&quot; href=&quot;messenger/otr/auth.ftl&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">   &lt;/linkset&gt;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://chat/content/otr-auth.js&quot; /&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  &lt;script src=&quot;chrome://chat/content/otr-auth.js&quot; /&gt;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   &lt;groupbox id=&quot;how&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l3.16"></a><span id="l3.16">     &lt;label&gt;&lt;html:h4 data-l10n-id=&quot;auth-how&quot;/&gt;&lt;/label&gt;</span>
<a href="#l3.17"></a><span id="l3.17">     &lt;menulist id=&quot;howOption&quot; oncommand=&quot;otrAuth.how();&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18">       &lt;menupopup&gt;</span>
<a href="#l3.19"></a><span id="l3.19">         &lt;menuitem data-l10n-id=&quot;auth-questionAndAnswer-label&quot; value=&quot;questionAndAnswer&quot; /&gt;</span>
<a href="#l3.20"></a><span id="l3.20">         &lt;menuitem data-l10n-id=&quot;auth-sharedSecret-label&quot; value=&quot;sharedSecret&quot; /&gt;</span>
<a href="#l3.21"></a><span id="l3.21">         &lt;menuitem data-l10n-id=&quot;auth-manualVerification-label&quot; value=&quot;manualVerification&quot; /&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/chat/content/otr-finger.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,126 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+const {LocalizationSync} =</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  ChromeUtils.import(&quot;resource://gre/modules/Localization.jsm&quot;, {});</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+const syncL10n = new LocalizationSync([</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  &quot;messenger/otr/finger.ftl&quot;,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+]);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+var [account] = window.arguments;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+var gFingers;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+var fingerTreeView = {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  selection: null,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  rowCount: 0,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  setTree(tree) {},</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  getImageSrc(row, column) {},</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  getProgressMode(row, column) {},</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  getCellValue(row, column) {},</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  getCellText(row, column) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    let finger = gFingers[row];</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+    switch (column.id) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+      case &quot;verified&quot;: {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+        let id = finger.trust ? &quot;finger-yes&quot; : &quot;finger-no&quot;;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+        return syncL10n.formatValue(id);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      }</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      default:</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+        return finger[column.id] || &quot;&quot;;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  },</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  isSeparator(index) { return false; },</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  isSorted() { return false; },</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  isContainer(index) { return false; },</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  cycleHeader(column) {},</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  getRowProperties(row) { return &quot;&quot;; },</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  getColumnProperties(column) { return &quot;&quot;; },</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  getCellProperties(row, column) { return &quot;&quot;; },</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+};</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+function getSelections(tree) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  let selections = [];</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  let selection = tree.view.selection;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  if (selection) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    let count = selection.getRangeCount();</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    let min = {};</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    let max = {};</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    for (let i = 0; i &lt; count; i++) {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      selection.getRangeAt(i, min, max);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+      for (let k = min.value; k &lt;= max.value; k++) {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+        if (k != -1)</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+          selections[selections.length] = k;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      }</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    }</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  return selections;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+}</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+var fingerTree;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+var otrFinger = {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  onload() {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    fingerTree = document.getElementById(&quot;fingerTree&quot;);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    gFingers = OTR.knownFingerprints(account);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    fingerTreeView.rowCount = gFingers.length;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    fingerTree.view = fingerTreeView;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  },</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  select() {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    let selections = getSelections(fingerTree);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+    document.getElementById(&quot;remove&quot;).disabled = !selections.length;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  },</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  remove() {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    fingerTreeView.selection.selectEventsSuppressed = true;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    // mark fingers for removal</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+    getSelections(fingerTree).forEach(function(sel) {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+      gFingers[sel].purge = true;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+    });</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    this.commonRemove();</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  },</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  removeAll() {</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    let confirmAllTitle = syncL10n.formatValue(&quot;finger-remove-all-title&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+    let confirmAllText = syncL10n.formatValue(&quot;finger-remove-all-message&quot;);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    let buttonPressed =</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+      Services.prompt.confirmEx(window, confirmAllTitle, confirmAllText,</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+        Services.prompt.BUTTON_POS_1_DEFAULT +</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+          Services.prompt.STD_OK_CANCEL_BUTTONS +</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+          Services.prompt.BUTTON_DELAY_ENABLE,</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+        0, 0, 0, null, {});</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    if (buttonPressed != 0) {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+      return;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    }</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+    for (let j = 0; j &lt; gFingers.length; j++) {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+      gFingers[j].purge = true;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    }</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    this.commonRemove();</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  },</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  commonRemove() {</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    // OTR.forgetFingerprints will null out removed fingers.</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    let removalComplete = OTR.forgetFingerprints(gFingers);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    for (let j = 0; j &lt; gFingers.length; j++) {</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+      if (gFingers[j] === null) {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+        let k = j;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+        while (k &lt; gFingers.length &amp;&amp; gFingers[k] === null) {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+          k++;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+        }</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+        gFingers.splice(j, k - j);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+        fingerTreeView.rowCount -= k - j;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+        fingerTree.rowCountChanged(j, j - k);  // negative</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+      }</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    }</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+    fingerTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    if (!removalComplete) {</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      let infoTitle = syncL10n.formatValue(&quot;finger-subset-title&quot;);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+      let infoText = syncL10n.formatValue(&quot;finger-subset-message&quot;);</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+      Services.prompt.alert(window, infoTitle, infoText);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    }</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  },</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/chat/content/otr-finger.xul</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot; ?&gt;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&lt;!DOCTYPE dialog&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+&lt;dialog</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  id=&quot;otr-fingerwindow&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  data-l10n-id=&quot;otr-finger&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  data-l10n-attrs=&quot;buttonlabelaccept&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  onload=&quot;otrFinger.onload()&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  buttons=&quot;accept&quot;&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  &lt;linkset&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    &lt;html:link rel=&quot;localization&quot; href=&quot;messenger/otr/finger.ftl&quot;/&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  &lt;/linkset&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  &lt;script src=&quot;chrome://chat/content/otr-finger.js&quot;/&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  &lt;label data-l10n-id=&quot;finger-intro&quot; /&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  &lt;vbox id=&quot;fingerprints&quot; class=&quot;contentPane&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    &lt;tree id=&quot;fingerTree&quot;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+          flex=&quot;1&quot;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+          width=&quot;800&quot;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+          style=&quot;height: 20em;&quot;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+          onselect=&quot;otrFinger.select()&quot;&gt;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+      &lt;treecols&gt;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+        &lt;treecol id=&quot;screenname&quot; data-l10n-id=&quot;finger-screenName&quot; flex=&quot;20&quot; /&gt;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+        &lt;treecol id=&quot;fingerprint&quot; data-l10n-id=&quot;finger-fingerprint&quot; flex=&quot;120&quot; /&gt;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+        &lt;treecol id=&quot;verified&quot; data-l10n-id=&quot;finger-verified&quot; flex=&quot;10&quot; /&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+      &lt;/treecols&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+      &lt;treechildren/&gt;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    &lt;/tree&gt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    &lt;hbox&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+      &lt;button id=&quot;remove&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+              data-l10n-id=&quot;finger-remove&quot;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+              disabled=&quot;true&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+              oncommand=&quot;otrFinger.remove()&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      &lt;button id=&quot;remove-all&quot;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+              data-l10n-id=&quot;finger-remove-all&quot;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+              oncommand=&quot;otrFinger.removeAll()&quot;/&gt;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/content/otr-generate-key.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/content/otr-generate-key.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,28 +1,47 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> const {</span>
<a href="#l6.9"></a><span id="l6.9">   XPCOMUtils,</span>
<a href="#l6.10"></a><span id="l6.10">   l10nHelper,</span>
<a href="#l6.11"></a><span id="l6.11"> } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> const {OTR} = ChromeUtils.import(&quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> var otrPriv = {</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">   async onload() {</span>
<a href="#l6.18"></a><span id="l6.18">     let args = window.arguments[0].wrappedJSObject;</span>
<a href="#l6.19"></a><span id="l6.19">     let priv = document.getElementById(&quot;priv&quot;);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+    let protocolNameToShow;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    // args.protocol is the normalized protocol name.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+    // However, we don't want to show normalized names like &quot;jabber&quot;,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    // but want to show the terms used in the UI like &quot;XMPP&quot;.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+    let protocols = Services.core.getProtocols();</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    while (protocols.hasMoreElements()) {</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+      let protocol = protocols.getNext();</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+      if (protocol.normalizedName === args.protocol) {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+        protocolNameToShow = protocol.name;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+        break;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+      }</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    }</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    if (!protocolNameToShow) {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+      protocolNameToShow = args.protocol;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    }</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+</span>
<a href="#l6.40"></a><span id="l6.40">     let text = await document.l10n.formatValue(</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-      &quot;otr-genkey-account&quot;, {name: args.account, protocol: OTR.protocolName(args.protocol)});</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+      &quot;otr-genkey-account&quot;, {name: args.account, protocol: protocolNameToShow});</span>
<a href="#l6.43"></a><span id="l6.43">     priv.textContent = text;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-console.log(&quot;genkey: &quot; + text);</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">     OTR.generatePrivateKey(args.account, args.protocol).then(function() {</span>
<a href="#l6.47"></a><span id="l6.47">       document.documentElement.getButton(&quot;accept&quot;).disabled = false;</span>
<a href="#l6.48"></a><span id="l6.48">       document.documentElement.acceptDialog();</span>
<a href="#l6.49"></a><span id="l6.49">     }).catch(async function(err) {</span>
<a href="#l6.50"></a><span id="l6.50">       priv.textContent = await document.l10n.formatValue(</span>
<a href="#l6.51"></a><span id="l6.51">           &quot;otr-genkey-failed&quot;, {error: String(err)});</span>
<a href="#l6.52"></a><span id="l6.52">       document.documentElement.getButton(&quot;accept&quot;).disabled = false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/content/otr-generate-key.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/content/otr-generate-key.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -17,12 +17,12 @@</span>
<a href="#l7.4"></a><span id="l7.4">   buttons=&quot;accept&quot;</span>
<a href="#l7.5"></a><span id="l7.5">   onload=&quot;otrPriv.onload()&quot;</span>
<a href="#l7.6"></a><span id="l7.6">   buttondisabledaccept=&quot;true&quot;&gt;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">   &lt;linkset&gt;</span>
<a href="#l7.9"></a><span id="l7.9">     &lt;html:link rel=&quot;localization&quot; href=&quot;messenger/otr/generate-key.ftl&quot;/&gt;</span>
<a href="#l7.10"></a><span id="l7.10">   &lt;/linkset&gt;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://chat/content/otr-generate-key.js&quot; /&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  &lt;script src=&quot;chrome://chat/content/otr-generate-key.js&quot; /&gt;</span>
<a href="#l7.14"></a><span id="l7.14">   &lt;description id=&quot;priv&quot; style=&quot;width: 300px; white-space: pre-wrap;&quot;&gt;&lt;/description&gt;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> &lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/chat/content/otr/am-im-otr.ftl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+account-encryption =</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+    .label = End-to-end Encryption</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+account-otr-label = Off-the-Record Messaging (OTR)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+account-otr-description = { -brand-short-name } supports end-to-end encryption of one-to-one conversations to prevent third parties from eavesdropping on a conversation. End-to-end encryption is available when your conversation partner also uses software that supports OTR.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+otr-encryption-title = Verified Encryption</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+otr-encryption-caption = To enable others to verify your identity in OTR chats, share your own OTR fingerprint using an outside (out-of-band) communication channel.</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+otr-fingerprint-label = Your Fingerprint:</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+view-fingerprint-button =</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    .label = Manage Fingerprints Of Contacts</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    .accesskey = F</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+otr-settings-title = OTR Settings</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+otr-requireEncryption =</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    .label = Require end-to-end encryption for one-to-one conversations</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+otr-verifyNudge =</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    .label = Always remind me to verify an unverified contact</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+otr-notYetAvailable = not yet available</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/content/otr/auth.ftl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/content/otr/auth.ftl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -13,17 +13,17 @@ auth-title = Verify the identity of { $n</span>
<a href="#l9.4"></a><span id="l9.4"> # Variables:</span>
<a href="#l9.5"></a><span id="l9.5"> #   $own_name (String) - the user's own screen name</span>
<a href="#l9.6"></a><span id="l9.6"> auth-your-fp-value = Fingerprint for you, { $own_name }:</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> # Variables:</span>
<a href="#l9.9"></a><span id="l9.9"> #   $their_name (String) - the screen name of a chat contact</span>
<a href="#l9.10"></a><span id="l9.10"> auth-their-fp-value = Purported fingerprint for { $their_name }:</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-auth-help = Verifying a contact's identity helps ensure that the person you are talking to is who they claim to be.</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+auth-help = Verifying a contact's identity helps ensure that the conversation is truly private, making it very difficult for a third party to eavesdrop or manipulate the conversation.</span>
<a href="#l9.14"></a><span id="l9.14"> auth-helpTitle = Verification help</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> auth-questionReceived = This is the question asked by your contact:</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> auth-yes =</span>
<a href="#l9.19"></a><span id="l9.19">     .label = Yes</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> auth-no =</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -39,21 +39,21 @@ auth-manualVerification-label =</span>
<a href="#l9.23"></a><span id="l9.23">     .label = { auth-manualVerification }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> auth-questionAndAnswer-label =</span>
<a href="#l9.26"></a><span id="l9.26">     .label = { auth-questionAndAnswer }</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28"> auth-sharedSecret-label =</span>
<a href="#l9.29"></a><span id="l9.29">     .label = { auth-sharedSecret }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-auth-manualInstruction = To verify the fingerprint, contact your conversation partner via some other authenticated channel, such as the telephone or GPG-signed email. Both conversation partners should tell the other person their fingerprint. If the fingerprint matches, you should indicate in the dialog below that you have verified the fingerprint.</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+auth-manualInstruction = To verify the fingerprint, contact your intended conversation partner via some other authenticated channel, such as OpenPGP-signed email or over the phone. You should both tell each other your fingerprints. If the fingerprint matches, you should indicate in the dialog below that you have verified the fingerprint.</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34"> auth-how = How would you like to verify your contact's identity?</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36"> auth-qaInstruction = To verify their identity, pick a question whose answer is known only to you and your contact. Enter this question and answer, then wait for your contact to enter the answer as well. If the answers do not match, then you may be talking to an imposter.</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-auth-secretInstruction = To verify their identity, pick a secret known only to you and your contact. Enter this secret, then wait for your contact to enter it as well. If the secrets do not match, then you may be talking to an imposter.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+auth-secretInstruction = To verify their identity, pick a secret known only to you and your contact. Don't use the same Internet connection to exchange the secret. Enter this secret, then wait for your contact to enter it as well. If the secrets do not match, then you may be talking to an imposter.</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-auth-question = Enter question here:</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+auth-question = Enter a question:</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-auth-answer = Enter secret answer here (case sensitive):</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+auth-answer = Enter the secret answer (case sensitive):</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-auth-secret = Enter secret here:</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+auth-secret = Enter the secret:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/content/otr/chat.ftl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/content/otr/chat.ftl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,19 +1,19 @@</span>
<a href="#l10.4"></a><span id="l10.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> state-label = Encryption Status:</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-start-text = Start private conversation</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+start-text = Start an encrypted conversation</span>
<a href="#l10.12"></a><span id="l10.12"> </span>
<a href="#l10.13"></a><span id="l10.13"> start-label =</span>
<a href="#l10.14"></a><span id="l10.14">     .label = { start-text }</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> start-tooltip =</span>
<a href="#l10.17"></a><span id="l10.17">     .tooltiptext = { start-text }</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> end-label =</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    .label = End private conversation</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+    .label = End the encrypted conversation</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> auth-label =</span>
<a href="#l10.24"></a><span id="l10.24">     .label = Verify your contact's identity</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/chat/content/otr/finger.ftl</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+otr-finger =</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+    .buttonlabelaccept = Close</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+    .title = Previously seen OTR fingerprints</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+finger-intro = A list of OTR key fingerprints from encrypted chats with your conversation partners.</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+finger-screenName =</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    .label = Contact</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+finger-verified =</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+    .label = Verification Status</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+finger-fingerprint =</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    .label = Fingerprint</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+finger-remove =</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+    .label = Remove Selected</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+finger-remove-all =</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+    .label = Remove All</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+finger-yes = Verified</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+finger-no = Unverified</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+finger-subset-title = Removing fingerprints</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+finger-subset-message = At least one fingerprint couldn't be removed, because you have an active conversation with the respective conversation partner.</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+finger-remove-all-title = Removing all fingerprints</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+finger-remove-all-message = Are you sure you want to remove all previously seen fingerprints? As a consequence, all previous OTR identity verifications will be lost. This operation cannot be undone.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/content/otr/generate-key.ftl</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/content/otr/generate-key.ftl</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -4,13 +4,13 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> otr-generate-key =</span>
<a href="#l12.6"></a><span id="l12.6">     .title = Generating private key</span>
<a href="#l12.7"></a><span id="l12.7">     .buttonlabelaccept = Done</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> # Variables:</span>
<a href="#l12.10"></a><span id="l12.10"> #   $name (String) - the name of the user's own chat account</span>
<a href="#l12.11"></a><span id="l12.11"> #   $protocol (String) - the chat communication protocol used by that account</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-otr-genkey-account = Generating private key for { $name }({ $protocol }) </span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+otr-genkey-account = Generating private key for { $name } ({ $protocol }) </span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> # Variables:</span>
<a href="#l12.16"></a><span id="l12.16"> #   $error (String) - contains an error message that describes the cause of the failure</span>
<a href="#l12.17"></a><span id="l12.17"> otr-genkey-failed = Generating key failed: { $error }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/content/otr/otr.ftl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/content/otr/otr.ftl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.5"></a><span id="l13.5"> msgevent-encryption_required_part1 = You attempted to send an unencrypted message to { $name }. As a policy, unencrypted messages are not allowed.</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> msgevent-encryption_required_part2 = Attempting to start a private conversation. Your message will be retransmitted when the private conversation starts.</span>
<a href="#l13.8"></a><span id="l13.8"> msgevent-encryption_error = An error occurred when encrypting your message. The message was not sent.</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> # Variables:</span>
<a href="#l13.11"></a><span id="l13.11"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-msgevent-connection_ended = { $name } has already closed their private connection to you. Your message was not sent. Either end your private conversation, or restart it.</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+msgevent-connection_ended = { $name } has already closed their encrypted connection to you. To avoid that you accidentally send a message without encryption, your message was not sent. Please end your encrypted conversation, or restart it.</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> # Variables:</span>
<a href="#l13.16"></a><span id="l13.16"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.17"></a><span id="l13.17"> msgevent-setup_error = An error occured while setting up a private conversation with { $name }.</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> # Do not translate 'OTR' (name of an encryption protocol)</span>
<a href="#l13.20"></a><span id="l13.20"> msgevent-msg_reflected = You are receiving your own OTR messages. You are either trying to talk to yourself, or someone is reflecting your messages back at you.</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -42,17 +42,17 @@ msgevent-rcvdmsg_malformed = We received</span>
<a href="#l13.23"></a><span id="l13.23"> msgevent-log_heartbeat_rcvd = Heartbeat received from { $name }.</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> # A Heartbeat is a technical message used to keep a connection alive.</span>
<a href="#l13.26"></a><span id="l13.26"> # Variables:</span>
<a href="#l13.27"></a><span id="l13.27"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.28"></a><span id="l13.28"> msgevent-log_heartbeat_sent = Heartbeat sent to { $name }.</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30"> # Do not translate 'OTR' (name of an encryption protocol)</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-msgevent-rcvdmsg_general_err = An OTR error occured.</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+msgevent-rcvdmsg_general_err = An unexpected error occurred while trying to protect your conversation using OTR.</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34"> # Variables:</span>
<a href="#l13.35"></a><span id="l13.35"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.36"></a><span id="l13.36"> #   $msg (string) - the message that was received.</span>
<a href="#l13.37"></a><span id="l13.37"> msgevent-rcvdmsg_unencrypted = The following message received from { $name } was not encrypted: { $msg }</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39"> # Do not translate 'OTR' (name of an encryption protocol)</span>
<a href="#l13.40"></a><span id="l13.40"> # Variables:</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -64,39 +64,33 @@ msgevent-rcvdmsg_unrecognized = We recei</span>
<a href="#l13.42"></a><span id="l13.42"> msgevent-rcvdmsg_for_other_instance = { $name } has sent a message intended for a different session. If you are logged in multiple times, another session may have received the message.</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44"> # Variables:</span>
<a href="#l13.45"></a><span id="l13.45"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.46"></a><span id="l13.46"> context-gone_secure_private = Private conversation with { $name } started.</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48"> # Variables:</span>
<a href="#l13.49"></a><span id="l13.49"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-context-gone_secure_unverified = Private conversation with { $name } started. However, their identity has not been verified.</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+context-gone_secure_unverified = Encrypted, but unverified conversation with { $name } started.</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53"> # Variables:</span>
<a href="#l13.54"></a><span id="l13.54"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-context-still_secure = Successfully refreshed the private conversation with { $name }.</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+context-still_secure = Successfully refreshed the encrypted conversation with { $name }.</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-error-enc = Error occurred encrypting message.</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+error-enc = An error occurred while encrypting the message.</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61"> # Variables:</span>
<a href="#l13.62"></a><span id="l13.62"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.63"></a><span id="l13.63"> error-not_priv = You sent encrypted data to { $name }, who wasn't expecting it.</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65"> error-unreadable = You transmitted an unreadable encrypted message.</span>
<a href="#l13.66"></a><span id="l13.66"> error-malformed = You transmitted a malformed data message.</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68"> resent = [resent]</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70"> # Variables:</span>
<a href="#l13.71"></a><span id="l13.71"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-tlv-disconnected = { $name } has ended their private conversation with you; you should do the same.</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+tlv-disconnected = { $name } has ended their encrypted conversation with you; you should do the same.</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75"> # Do not translate &quot;Off-the-Record&quot; and &quot;OTR&quot; which is the name of an encryption protocol</span>
<a href="#l13.76"></a><span id="l13.76"> # Variables:</span>
<a href="#l13.77"></a><span id="l13.77"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-query-msg = { $name } has requested an Off-the-Record (OTR) private conversation. However, you do not have a plugin to support that. See https://en.wikipedia.org/wiki/Off-the-Record_Messaging for more information.</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-trust-unused = Unused</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-trust-not_private = Not Private</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-trust-unverified = Unverified</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-trust-private = Private</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-trust-finished = Finished</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+query-msg = { $name } has requested an Off-the-Record (OTR) encrypted conversation. However, you do not have a plugin to support that. See https://en.wikipedia.org/wiki/Off-the-Record_Messaging for more information.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/content/otr/otrUI.ftl</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/content/otr/otrUI.ftl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l14.4"></a><span id="l14.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-start-label = Start private conversation</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-refresh-label = Refresh private conversation</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+start-label = Start an encrypted conversation</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+refresh-label = Refresh the encrypted conversation</span>
<a href="#l14.12"></a><span id="l14.12"> auth-label = Verify your contact's identity</span>
<a href="#l14.13"></a><span id="l14.13"> reauth-label = Reverify your contact's identity</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> auth-cancel = Cancel</span>
<a href="#l14.16"></a><span id="l14.16"> auth-cancelAccessKey = C</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> auth-error = An error occurred while verifying your contact's identity.</span>
<a href="#l14.19"></a><span id="l14.19"> auth-success = Verifying your contact's identity completed successfully.</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineat">@@ -19,43 +19,47 @@ auth-waiting = Waiting for contact to complete verification </span>
<a href="#l14.21"></a><span id="l14.21"> finger-verify = Verify</span>
<a href="#l14.22"></a><span id="l14.22"> finger-verify-accessKey = V</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24"> # Do not translate 'OTR' (name of an encryption protocol)</span>
<a href="#l14.25"></a><span id="l14.25"> buddycontextmenu-label = Add Contact's OTR Fingerprint</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> # Variables:</span>
<a href="#l14.28"></a><span id="l14.28"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-alert-start = Attempting to start a private conversation with { $name }.</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+alert-start = Attempting to start an encrypted conversation with { $name }.</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32"> # Variables:</span>
<a href="#l14.33"></a><span id="l14.33"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-alert-refresh = Attempting to refresh the private conversation with { $name }.</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+alert-refresh = Attempting to refresh the encrypted conversation with { $name }.</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37"> # Variables:</span>
<a href="#l14.38"></a><span id="l14.38"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-alert-gone_insecure = Private conversation with { $name } ended.</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+alert-gone_insecure = The encrypted conversation with { $name } ended.</span>
<a href="#l14.41"></a><span id="l14.41"> </span>
<a href="#l14.42"></a><span id="l14.42"> # Variables:</span>
<a href="#l14.43"></a><span id="l14.43"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.44"></a><span id="l14.44"> finger-unseen = The identity of { $name } has not been verified yet. Casual eavesdropping is not possible, but with some effort someone could be listening in. You should verify this contact's identity.</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+# Variables:</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+#   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+finger-seen={ $name } is contacting you from an unrecognized computer. Casual eavesdropping is not possible, but with some effort someone could be listening in. You should verify this contact's identity.</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50"> state-not_private = The current conversation is not private.</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52"> # Variables:</span>
<a href="#l14.53"></a><span id="l14.53"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-state-unverified = The current conversation is private but the identity of { $name } has not been verified.</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+state-unverified = The current conversation is encrypted but the identity of { $name } has not been verified.</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57"> # Variables:</span>
<a href="#l14.58"></a><span id="l14.58"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-state-private = The current conversation is private and the identity of { $name } has been verified.</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+state-private = The identity of { $name } has been verified. The current conversation is encrypted and private.</span>
<a href="#l14.61"></a><span id="l14.61"> </span>
<a href="#l14.62"></a><span id="l14.62"> # Variables:</span>
<a href="#l14.63"></a><span id="l14.63"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-state-finished = { $name } has ended their private conversation with you; you should do the same.</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+state-finished = { $name } has ended their encrypted conversation with you; you should do the same.</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67"> state-not_private-label = Insecure</span>
<a href="#l14.68"></a><span id="l14.68"> state-unverified-label = Unverified</span>
<a href="#l14.69"></a><span id="l14.69"> state-private-label = Private</span>
<a href="#l14.70"></a><span id="l14.70"> state-finished-label = Finished</span>
<a href="#l14.71"></a><span id="l14.71"> </span>
<a href="#l14.72"></a><span id="l14.72"> # Variables:</span>
<a href="#l14.73"></a><span id="l14.73"> #   $name (String) - the screen name of a chat contact person</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/locales/jar.mn</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/locales/jar.mn</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -17,16 +17,8 @@</span>
<a href="#l15.4"></a><span id="l15.4"> 	locale/@AB_CD@/chat/irc.properties	(%irc.properties)</span>
<a href="#l15.5"></a><span id="l15.5"> 	locale/@AB_CD@/chat/logger.properties	(%logger.properties)</span>
<a href="#l15.6"></a><span id="l15.6"> 	locale/@AB_CD@/chat/matrix.properties	(%matrix.properties)</span>
<a href="#l15.7"></a><span id="l15.7"> 	locale/@AB_CD@/chat/skype.properties	(%skype.properties)</span>
<a href="#l15.8"></a><span id="l15.8"> 	locale/@AB_CD@/chat/status.properties	(%status.properties)</span>
<a href="#l15.9"></a><span id="l15.9"> 	locale/@AB_CD@/chat/twitter.properties	(%twitter.properties)</span>
<a href="#l15.10"></a><span id="l15.10"> 	locale/@AB_CD@/chat/xmpp.properties	(%xmpp.properties)</span>
<a href="#l15.11"></a><span id="l15.11"> 	locale/@AB_CD@/chat/yahoo.properties	(%yahoo.properties)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#	locale/@AB_CD@/chat/otr-auth.dtd	(%otr-auth.dtd)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#	locale/@AB_CD@/chat/otr-auth.properties	(%otr-auth.properties)</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-#	locale/@AB_CD@/chat/otr-add-finger.dtd	(%otr-add-finger.dtd)</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-#	locale/@AB_CD@/chat/otr-add-finger.properties	(%otr-add-finger.properties)</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-#	locale/@AB_CD@/chat/otr.properties	(%otr.properties)</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-#	locale/@AB_CD@/chat/otr-generate-key.dtd	(%otr-generate-key.dtd)</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-#	locale/@AB_CD@/chat/otr-generate-key.properties	(%otr-generate-key.properties)</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-#	locale/@AB_CD@/chat/otrUI.properties	(%otrUI.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/modules/OTR.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/modules/OTR.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> const { LocalizationSync } =</span>
<a href="#l16.6"></a><span id="l16.6">   ChromeUtils.import(&quot;resource://gre/modules/Localization.jsm&quot;, {});</span>
<a href="#l16.7"></a><span id="l16.7"> const {BasePromiseWorker} = ChromeUtils.import(&quot;resource://gre/modules/PromiseWorker.jsm&quot;);</span>
<a href="#l16.8"></a><span id="l16.8"> const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> const {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> const {CLib} = ChromeUtils.import(&quot;resource:///modules/CLib.jsm&quot;);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-const {OTRLib} = ChromeUtils.import(&quot;resource:///modules/OTRLib.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+const {OTRLibLoader} = ChromeUtils.import(&quot;resource:///modules/OTRLib.jsm&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> var workerPath = &quot;chrome://chat/content/otrWorker.js&quot;;</span>
<a href="#l16.15"></a><span id="l16.15"> const {OTRHelpers} = ChromeUtils.import(&quot;resource:///modules/OTRHelpers.jsm&quot;);</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> const syncL10n = new LocalizationSync([</span>
<a href="#l16.18"></a><span id="l16.18">   &quot;messenger/otr/otr.ftl&quot;,</span>
<a href="#l16.19"></a><span id="l16.19"> ]);</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> function _str(id) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -54,31 +54,16 @@ function trustFingerprint(fingerprint) {</span>
<a href="#l16.23"></a><span id="l16.23"> // they are, 0 if you think they aren't, -1 if you're not sure.</span>
<a href="#l16.24"></a><span id="l16.24"> function isOnline(conv) {</span>
<a href="#l16.25"></a><span id="l16.25">   let ret = -1;</span>
<a href="#l16.26"></a><span id="l16.26">   if (conv.buddy)</span>
<a href="#l16.27"></a><span id="l16.27">     ret = conv.buddy.online ? 1 : 0;</span>
<a href="#l16.28"></a><span id="l16.28">   return ret;</span>
<a href="#l16.29"></a><span id="l16.29"> }</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-// Use the protocol name in user facing strings. See trac #16490</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-var names;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-function protocolName(aNormalizedName) {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  if (!names) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-    names = new Map();</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-    let protocols = Services.core.getProtocols();</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-    while (protocols.hasMoreElements()) {</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-      let protocol = protocols.getNext();</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-      names.set(protocol.normalizedName, protocol.name);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-    }</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  }</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  return names.get(aNormalizedName) || aNormalizedName;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-}</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-</span>
<a href="#l16.46"></a><span id="l16.46"> // OTRLib context wrapper</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48"> function Context(context) {</span>
<a href="#l16.49"></a><span id="l16.49">   this._context = context;</span>
<a href="#l16.50"></a><span id="l16.50"> }</span>
<a href="#l16.51"></a><span id="l16.51"> </span>
<a href="#l16.52"></a><span id="l16.52"> Context.prototype = {</span>
<a href="#l16.53"></a><span id="l16.53">   constructor: Context,</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineat">@@ -88,23 +73,29 @@ Context.prototype = {</span>
<a href="#l16.55"></a><span id="l16.55">   get msgstate() { return this._context.contents.msgstate; },</span>
<a href="#l16.56"></a><span id="l16.56">   get fingerprint() { return this._context.contents.active_fingerprint; },</span>
<a href="#l16.57"></a><span id="l16.57">   get trust() { return trustFingerprint(this.fingerprint); },</span>
<a href="#l16.58"></a><span id="l16.58"> };</span>
<a href="#l16.59"></a><span id="l16.59"> </span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61"> // otr module</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+var OTRLib;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+</span>
<a href="#l16.65"></a><span id="l16.65"> var OTR = {</span>
<a href="#l16.66"></a><span id="l16.66"> </span>
<a href="#l16.67"></a><span id="l16.67">   hasRan: false,</span>
<a href="#l16.68"></a><span id="l16.68">   libLoaded: false,</span>
<a href="#l16.69"></a><span id="l16.69">   once() {</span>
<a href="#l16.70"></a><span id="l16.70">     this.hasRan = true;</span>
<a href="#l16.71"></a><span id="l16.71">     try {</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+      OTRLib = OTRLibLoader.init();</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+      if (!OTRLib) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+        return;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+      }</span>
<a href="#l16.76"></a><span id="l16.76">       if (OTRLib &amp;&amp; OTRLib.init()) {</span>
<a href="#l16.77"></a><span id="l16.77">         this.initUiOps();</span>
<a href="#l16.78"></a><span id="l16.78">         OTR.libLoaded = true;</span>
<a href="#l16.79"></a><span id="l16.79">       }</span>
<a href="#l16.80"></a><span id="l16.80">     } catch (e) {</span>
<a href="#l16.81"></a><span id="l16.81">       console.log(e);</span>
<a href="#l16.82"></a><span id="l16.82">     }</span>
<a href="#l16.83"></a><span id="l16.83">   },</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineat">@@ -117,18 +108,16 @@ var OTR = {</span>
<a href="#l16.85"></a><span id="l16.85">     opts = opts || {};</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87">     if (!this.hasRan)</span>
<a href="#l16.88"></a><span id="l16.88">       this.once();</span>
<a href="#l16.89"></a><span id="l16.89"> </span>
<a href="#l16.90"></a><span id="l16.90">     if (!OTR.libLoaded)</span>
<a href="#l16.91"></a><span id="l16.91">       return;</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-    this.verifyNudge = !!opts.verifyNudge;</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-    this.setPolicy(opts.requireEncryption);</span>
<a href="#l16.95"></a><span id="l16.95">     this.userstate = OTRLib.otrl_userstate_create();</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97">     // A map of UIConvs, keyed on the target.id</span>
<a href="#l16.98"></a><span id="l16.98">     this._convos = new Map();</span>
<a href="#l16.99"></a><span id="l16.99">     this._observers = [];</span>
<a href="#l16.100"></a><span id="l16.100">     this._buffer = [];</span>
<a href="#l16.101"></a><span id="l16.101">     this._poll_timer = null;</span>
<a href="#l16.102"></a><span id="l16.102"> </span>
<a href="#l16.103"></a><span id="l16.103" class="difflineat">@@ -159,26 +148,16 @@ var OTR = {</span>
<a href="#l16.104"></a><span id="l16.104">     }</span>
<a href="#l16.105"></a><span id="l16.105">     this._buffer = null;</span>
<a href="#l16.106"></a><span id="l16.106">   },</span>
<a href="#l16.107"></a><span id="l16.107"> </span>
<a href="#l16.108"></a><span id="l16.108">   log(msg) {</span>
<a href="#l16.109"></a><span id="l16.109">     this.notifyObservers(msg, &quot;otr:log&quot;);</span>
<a href="#l16.110"></a><span id="l16.110">   },</span>
<a href="#l16.111"></a><span id="l16.111"> </span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-  protocolName,</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-  setPolicy(requireEncryption) {</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-    if (!OTR.libLoaded)</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-      return;</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-    this.policy = requireEncryption</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-      ? OTRLib.OTRL_POLICY_ALWAYS</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-      : OTRLib.OTRL_POLICY_OPPORTUNISTIC;</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-  },</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-</span>
<a href="#l16.122"></a><span id="l16.122">   // load stored files from my profile</span>
<a href="#l16.123"></a><span id="l16.123">   loadFiles() {</span>
<a href="#l16.124"></a><span id="l16.124">     return Promise.all([</span>
<a href="#l16.125"></a><span id="l16.125">       OS.File.exists(this.privateKeyPath).then((exists) =&gt; {</span>
<a href="#l16.126"></a><span id="l16.126">         if (exists &amp;&amp; OTRLib.otrl_privkey_read(</span>
<a href="#l16.127"></a><span id="l16.127">           this.userstate, this.privateKeyPath</span>
<a href="#l16.128"></a><span id="l16.128">         )) throw new Error(&quot;Failed to read private keys.&quot;);</span>
<a href="#l16.129"></a><span id="l16.129">       }),</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineat">@@ -238,19 +217,22 @@ var OTR = {</span>
<a href="#l16.131"></a><span id="l16.131">     let fingerprint = OTRLib.otrl_privkey_fingerprint(</span>
<a href="#l16.132"></a><span id="l16.132">       this.userstate, new OTRLib.fingerprint_t(), account, protocol</span>
<a href="#l16.133"></a><span id="l16.133">     );</span>
<a href="#l16.134"></a><span id="l16.134">     return fingerprint.isNull() ? null : fingerprint.readString();</span>
<a href="#l16.135"></a><span id="l16.135">   },</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137">   // return a human readable string for a fingerprint</span>
<a href="#l16.138"></a><span id="l16.138">   hashToHuman(fingerprint) {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-    let hash = fingerprint.contents.fingerprint;</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-    if (hash.isNull())</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-      throw Error(&quot;No fingerprint found.&quot;);</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+    let hash;</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+    try {</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+      hash = fingerprint.contents.fingerprint;</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+    } catch (e) {}</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+    if (!hash || hash.isNull())</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+      throw new Error(&quot;No fingerprint found.&quot;);</span>
<a href="#l16.148"></a><span id="l16.148">     let human = new OTRLib.fingerprint_t();</span>
<a href="#l16.149"></a><span id="l16.149">     OTRLib.otrl_privkey_hash_to_human(human, hash);</span>
<a href="#l16.150"></a><span id="l16.150">     return human.readString();</span>
<a href="#l16.151"></a><span id="l16.151">   },</span>
<a href="#l16.152"></a><span id="l16.152"> </span>
<a href="#l16.153"></a><span id="l16.153">   base64encode(data, dataLen) {</span>
<a href="#l16.154"></a><span id="l16.154">     // CData objects are initialized with zeroes.  The plus one gives us</span>
<a href="#l16.155"></a><span id="l16.155">     // our null byte so that readString below is safe.</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineat">@@ -276,106 +258,96 @@ var OTR = {</span>
<a href="#l16.157"></a><span id="l16.157">     } else if (level === OTR.trustState.TRUST_UNVERIFIED) {</span>
<a href="#l16.158"></a><span id="l16.158">       return OTR.trustState.TRUST_UNVERIFIED;</span>
<a href="#l16.159"></a><span id="l16.159">     } else if (level === OTR.trustState.TRUST_FINISHED) {</span>
<a href="#l16.160"></a><span id="l16.160">       return OTR.trustState.TRUST_FINISHED;</span>
<a href="#l16.161"></a><span id="l16.161">     }</span>
<a href="#l16.162"></a><span id="l16.162">     return OTR.trustState.TRUST_NOT_PRIVATE;</span>
<a href="#l16.163"></a><span id="l16.163">   },</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-  getStatus(level) {</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-    switch (level) {</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-    case OTR.trustState.TRUST_NOT_PRIVATE:</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-      return _str(&quot;trust-not_private&quot;);</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-    case OTR.trustState.TRUST_UNVERIFIED:</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-      return _str(&quot;trust-unverified&quot;);</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-    case OTR.trustState.TRUST_PRIVATE:</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-      return _str(&quot;trust-private&quot;);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-    case OTR.trustState.TRUST_FINISHED:</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-      return _str(&quot;trust-finished&quot;);</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-    }</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-    throw new Error(&quot;unknown level&quot;);</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-  },</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-  // get list of known fingerprints</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-  knownFingerprints() {</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+  // Fetch list of known fingerprints, either for the given account,</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+  // or for all accounts, if parameter is null.</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+  knownFingerprints(forAccount) {</span>
<a href="#l16.184"></a><span id="l16.184">     let fps = [];</span>
<a href="#l16.185"></a><span id="l16.185">     for (</span>
<a href="#l16.186"></a><span id="l16.186">       let context = this.userstate.contents.context_root;</span>
<a href="#l16.187"></a><span id="l16.187">       !context.isNull();</span>
<a href="#l16.188"></a><span id="l16.188">       context = context.contents.next</span>
<a href="#l16.189"></a><span id="l16.189">     ) {</span>
<a href="#l16.190"></a><span id="l16.190">       // skip child contexts</span>
<a href="#l16.191"></a><span id="l16.191">       if (!comparePointers(context.contents.m_context, context))</span>
<a href="#l16.192"></a><span id="l16.192">         continue;</span>
<a href="#l16.193"></a><span id="l16.193">       let wContext = new Context(context);</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+      if (forAccount) {</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+        if (forAccount.normalizedName != wContext.account ||</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+            forAccount.protocol.normalizedName != wContext.protocol) {</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+          continue;</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+        }</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+      }</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+</span>
<a href="#l16.202"></a><span id="l16.202">       for (</span>
<a href="#l16.203"></a><span id="l16.203">         let fingerprint = context.contents.fingerprint_root.next;</span>
<a href="#l16.204"></a><span id="l16.204">         !fingerprint.isNull();</span>
<a href="#l16.205"></a><span id="l16.205">         fingerprint = fingerprint.contents.next</span>
<a href="#l16.206"></a><span id="l16.206">       ) {</span>
<a href="#l16.207"></a><span id="l16.207">         let trust = trustFingerprint(fingerprint);</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-        let used = false;</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-        let best_level = OTR.trustState.TRUST_NOT_PRIVATE;</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-        for (</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-          let context_itr = context;</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-          !context_itr.isNull() &amp;&amp;</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-            comparePointers(context_itr.contents.m_context, context);</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-          context_itr = context_itr.contents.next</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-        ) {</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-          if (comparePointers(</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-            context_itr.contents.active_fingerprint, fingerprint</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-          )) {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-            used = true;</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-            best_level = OTR.getTrustLevel(new Context(context_itr));</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-          }</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-        }</span>
<a href="#l16.223"></a><span id="l16.223">         fps.push({</span>
<a href="#l16.224"></a><span id="l16.224">           fpointer: fingerprint.contents.address(),</span>
<a href="#l16.225"></a><span id="l16.225">           fingerprint: OTR.hashToHuman(fingerprint),</span>
<a href="#l16.226"></a><span id="l16.226">           screenname: wContext.username,</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-          account: wContext.account,</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-          protocol: wContext.protocol,</span>
<a href="#l16.229"></a><span id="l16.229">           trust,</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-          status: used ? OTR.getStatus(best_level) : _str(&quot;trust-unused&quot;),</span>
<a href="#l16.231"></a><span id="l16.231">           purge: false,</span>
<a href="#l16.232"></a><span id="l16.232">         });</span>
<a href="#l16.233"></a><span id="l16.233">       }</span>
<a href="#l16.234"></a><span id="l16.234">     }</span>
<a href="#l16.235"></a><span id="l16.235">     return fps;</span>
<a href="#l16.236"></a><span id="l16.236">   },</span>
<a href="#l16.237"></a><span id="l16.237"> </span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+  /**</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+   * Returns true, if all requested fps were removed.</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+   * Returns false, if at least one fps couldn't get removed,</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+   * because it's currently actively used.</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+   */</span>
<a href="#l16.243"></a><span id="l16.243">   forgetFingerprints(fps) {</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+    let result = true;</span>
<a href="#l16.245"></a><span id="l16.245">     let write = false;</span>
<a href="#l16.246"></a><span id="l16.246">     fps.forEach(function(obj, i) {</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-      if (!obj.purge)</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+      if (!obj.purge) {</span>
<a href="#l16.249"></a><span id="l16.249">         return;</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+      }</span>
<a href="#l16.251"></a><span id="l16.251">       obj.purge = false;  // reset early</span>
<a href="#l16.252"></a><span id="l16.252">       let fingerprint = obj.fpointer;</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-      if (fingerprint.isNull())</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+      if (fingerprint.isNull()) {</span>
<a href="#l16.255"></a><span id="l16.255">         return;</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-      // don't do anything if fp is active and we're in an encrypted state</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+      }</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+      // don't remove if fp is active and we're in an encrypted state</span>
<a href="#l16.259"></a><span id="l16.259">       let context = fingerprint.contents.context.contents.m_context;</span>
<a href="#l16.260"></a><span id="l16.260">       for (</span>
<a href="#l16.261"></a><span id="l16.261">         let context_itr = context;</span>
<a href="#l16.262"></a><span id="l16.262">         !context_itr.isNull() &amp;&amp;</span>
<a href="#l16.263"></a><span id="l16.263">           comparePointers(context_itr.contents.m_context, context);</span>
<a href="#l16.264"></a><span id="l16.264">         context_itr = context_itr.contents.next</span>
<a href="#l16.265"></a><span id="l16.265">       ) {</span>
<a href="#l16.266"></a><span id="l16.266">         if (</span>
<a href="#l16.267"></a><span id="l16.267">           context_itr.contents.msgstate === OTRLib.messageState.OTRL_MSGSTATE_ENCRYPTED &amp;&amp;</span>
<a href="#l16.268"></a><span id="l16.268">           comparePointers(context_itr.contents.active_fingerprint, fingerprint)</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-        ) return;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+        ) {</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+          result = false;</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+          return;</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+        }</span>
<a href="#l16.274"></a><span id="l16.274">       }</span>
<a href="#l16.275"></a><span id="l16.275">       write = true;</span>
<a href="#l16.276"></a><span id="l16.276">       OTRLib.otrl_context_forget_fingerprint(fingerprint, 1);</span>
<a href="#l16.277"></a><span id="l16.277">       fps[i] = null;  // null out removed fps</span>
<a href="#l16.278"></a><span id="l16.278">     });</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-    if (write)</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+    if (write) {</span>
<a href="#l16.281"></a><span id="l16.281">       OTR.writeFingerprints();</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+    }</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+    return result;</span>
<a href="#l16.284"></a><span id="l16.284">   },</span>
<a href="#l16.285"></a><span id="l16.285"> </span>
<a href="#l16.286"></a><span id="l16.286">   addFingerprint(context, hex) {</span>
<a href="#l16.287"></a><span id="l16.287">     let fingerprint = new OTRLib.hash_t();</span>
<a href="#l16.288"></a><span id="l16.288">     if (hex.length != 40) throw new Error(&quot;Invalid fingerprint value.&quot;);</span>
<a href="#l16.289"></a><span id="l16.289">     let bytes = hex.match(/.{1,2}/g);</span>
<a href="#l16.290"></a><span id="l16.290">     for (let i = 0; i &lt; 20; i++)</span>
<a href="#l16.291"></a><span id="l16.291">       fingerprint[i] = parseInt(bytes[i], 16);</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineat">@@ -486,20 +458,29 @@ var OTR = {</span>
<a href="#l16.293"></a><span id="l16.293">     if (remove) {</span>
<a href="#l16.294"></a><span id="l16.294">       let uiConv = this.getUIConvFromConv(conv);</span>
<a href="#l16.295"></a><span id="l16.295">       if (uiConv)</span>
<a href="#l16.296"></a><span id="l16.296">         this.removeConversation(uiConv);</span>
<a href="#l16.297"></a><span id="l16.297">     } else</span>
<a href="#l16.298"></a><span id="l16.298">       this.notifyObservers(this.getContext(conv), &quot;otr:disconnected&quot;);</span>
<a href="#l16.299"></a><span id="l16.299">   },</span>
<a href="#l16.300"></a><span id="l16.300"> </span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+  getAccountPref(prefName, accountId, defaultVal) {</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+    return Services.prefs.getBoolPref(</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+      &quot;messenger.account.&quot; + accountId + &quot;.options.&quot; + prefName,</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+      defaultVal);</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+  },</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+</span>
<a href="#l16.307"></a><span id="l16.307">   sendQueryMsg(conv) {</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+    let req = this.getAccountPref(&quot;otrRequireEncryption&quot;,</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+      conv.account.id, OTR.defaultOtrRequireEncryption());</span>
<a href="#l16.310"></a><span id="l16.310">     let query = OTRLib.otrl_proto_default_query_msg(</span>
<a href="#l16.311"></a><span id="l16.311">       conv.account.normalizedName,</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineminus">-      this.policy</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+      req ?</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+        OTRLib.OTRL_POLICY_ALWAYS : OTRLib.OTRL_POLICY_OPPORTUNISTIC</span>
<a href="#l16.315"></a><span id="l16.315">     );</span>
<a href="#l16.316"></a><span id="l16.316">     if (query.isNull()) {</span>
<a href="#l16.317"></a><span id="l16.317">       Cu.reportError(new Error(&quot;Sending query message failed.&quot;));</span>
<a href="#l16.318"></a><span id="l16.318">       return;</span>
<a href="#l16.319"></a><span id="l16.319">     }</span>
<a href="#l16.320"></a><span id="l16.320">     // Use the default msg to format the version.</span>
<a href="#l16.321"></a><span id="l16.321">     // We don't supprt v1 of the protocol so this should be fine.</span>
<a href="#l16.322"></a><span id="l16.322">     let queryMsg = /^\?OTR.*?\?/.exec(query.readString())[0] + &quot;\n&quot;;</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineat">@@ -529,110 +510,172 @@ var OTR = {</span>
<a href="#l16.324"></a><span id="l16.324">         break;</span>
<a href="#l16.325"></a><span id="l16.325">       case OTRLib.messageState.OTRL_MSGSTATE_FINISHED:</span>
<a href="#l16.326"></a><span id="l16.326">         level = this.trustState.TRUST_FINISHED;</span>
<a href="#l16.327"></a><span id="l16.327">         break;</span>
<a href="#l16.328"></a><span id="l16.328">     }</span>
<a href="#l16.329"></a><span id="l16.329">     return level;</span>
<a href="#l16.330"></a><span id="l16.330">   },</span>
<a href="#l16.331"></a><span id="l16.331"> </span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+  defaultOtrRequireEncryption() {</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+    return false;</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+  },</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineplus">+</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineplus">+  defaultOtrVerifyNudge() {</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+    return true;</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+  },</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+  getPrefBranchFromWrappedContext(wContext) {</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+    for (let acc of Services.accounts.getAccounts()) {</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+      if (wContext.account == acc.normalizedName &amp;&amp;</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+          wContext.protocol == acc.protocol.normalizedName) {</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+        return acc.prefBranch;</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+      }</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+    }</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+    return null;</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+  },</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+</span>
<a href="#l16.350"></a><span id="l16.350">   // uiOps callbacks</span>
<a href="#l16.351"></a><span id="l16.351"> </span>
<a href="#l16.352"></a><span id="l16.352" class="difflineminus">-  // Return the OTR policy for the given context.</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+  /**</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+   * Return the OTR policy for the given context.</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+   */</span>
<a href="#l16.356"></a><span id="l16.356">   policy_cb(opdata, context) {</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineminus">-    return this.policy;</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+    let wContext = new Context(context);</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+    let pb = OTR.getPrefBranchFromWrappedContext(wContext);</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+    if (!pb) {</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+      return new ctypes.unsigned_int(0);</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+    }</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+    let prefRequire = pb.getBoolPref(&quot;options.otrRequireEncryption&quot;,</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+      OTR.defaultOtrRequireEncryption());</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+    return prefRequire ? OTRLib.OTRL_POLICY_ALWAYS</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+                       : OTRLib.OTRL_POLICY_OPPORTUNISTIC;</span>
<a href="#l16.367"></a><span id="l16.367">   },</span>
<a href="#l16.368"></a><span id="l16.368"> </span>
<a href="#l16.369"></a><span id="l16.369" class="difflineminus">-  // Create a private key for the given accountname/protocol if desired.</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+  /**</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+   * Create a private key for the given accountname/protocol if desired.</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+   */</span>
<a href="#l16.373"></a><span id="l16.373">   create_privkey_cb(opdata, accountname, protocol) {</span>
<a href="#l16.374"></a><span id="l16.374">     let args = {</span>
<a href="#l16.375"></a><span id="l16.375">       account: accountname.readString(),</span>
<a href="#l16.376"></a><span id="l16.376">       protocol: protocol.readString(),</span>
<a href="#l16.377"></a><span id="l16.377">     };</span>
<a href="#l16.378"></a><span id="l16.378">     this.notifyObservers(args, &quot;otr:generate&quot;);</span>
<a href="#l16.379"></a><span id="l16.379">   },</span>
<a href="#l16.380"></a><span id="l16.380"> </span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-  // Report whether you think the given user is online. Return 1 if you think</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineminus">-  // they are, 0 if you think they aren't, -1 if you're not sure.</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+  /**</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+   * Report whether you think the given user is online. Return 1 if you</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+   * think they are, 0 if you think they aren't, -1 if you're not sure.</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+   */</span>
<a href="#l16.387"></a><span id="l16.387">   is_logged_in_cb(opdata, accountname, protocol, recipient) {</span>
<a href="#l16.388"></a><span id="l16.388">     let conv = this.getUIConvForRecipient(</span>
<a href="#l16.389"></a><span id="l16.389">       accountname.readString(),</span>
<a href="#l16.390"></a><span id="l16.390">       protocol.readString(),</span>
<a href="#l16.391"></a><span id="l16.391">       recipient.readString()</span>
<a href="#l16.392"></a><span id="l16.392">     ).target;</span>
<a href="#l16.393"></a><span id="l16.393">     return isOnline(conv);</span>
<a href="#l16.394"></a><span id="l16.394">   },</span>
<a href="#l16.395"></a><span id="l16.395"> </span>
<a href="#l16.396"></a><span id="l16.396" class="difflineminus">-  // Send the given IM to the given recipient from the given</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineminus">-  // accountname/protocol.</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+  /**</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+   * Send the given IM to the given recipient from the given</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+   * accountname/protocol.</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineplus">+   */</span>
<a href="#l16.402"></a><span id="l16.402">   inject_message_cb(opdata, accountname, protocol, recipient, message) {</span>
<a href="#l16.403"></a><span id="l16.403">     let aMsg = message.readString();</span>
<a href="#l16.404"></a><span id="l16.404">     this.log(&quot;inject_message_cb (msglen:&quot; + aMsg.length + &quot;): &quot; + aMsg);</span>
<a href="#l16.405"></a><span id="l16.405">     this.getUIConvForRecipient(</span>
<a href="#l16.406"></a><span id="l16.406">       accountname.readString(),</span>
<a href="#l16.407"></a><span id="l16.407">       protocol.readString(),</span>
<a href="#l16.408"></a><span id="l16.408">       recipient.readString()</span>
<a href="#l16.409"></a><span id="l16.409">     ).target.sendMsg(aMsg);</span>
<a href="#l16.410"></a><span id="l16.410">   },</span>
<a href="#l16.411"></a><span id="l16.411"> </span>
<a href="#l16.412"></a><span id="l16.412" class="difflineminus">-  // A new fingerprint for the given user has been received.</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+  /**</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+   * new fingerprint for the given user has been received.</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+   */</span>
<a href="#l16.416"></a><span id="l16.416">   new_fingerprint_cb(opdata, us, accountname, protocol, username, fingerprint) {</span>
<a href="#l16.417"></a><span id="l16.417">     let context = OTRLib.otrl_context_find(</span>
<a href="#l16.418"></a><span id="l16.418">       us, username, accountname, protocol,</span>
<a href="#l16.419"></a><span id="l16.419">       OTRLib.instag.OTRL_INSTAG_MASTER, 1, null, null, null</span>
<a href="#l16.420"></a><span id="l16.420">     );</span>
<a href="#l16.421"></a><span id="l16.421"> </span>
<a href="#l16.422"></a><span id="l16.422">     let seen = false;</span>
<a href="#l16.423"></a><span id="l16.423">     let fp = context.contents.fingerprint_root.next;</span>
<a href="#l16.424"></a><span id="l16.424">     while (!fp.isNull()) {</span>
<a href="#l16.425"></a><span id="l16.425">       if (CLib.memcmp(fingerprint, fp.contents.fingerprint, new ctypes.size_t(20))) {</span>
<a href="#l16.426"></a><span id="l16.426">         seen = true;</span>
<a href="#l16.427"></a><span id="l16.427">         break;</span>
<a href="#l16.428"></a><span id="l16.428">       }</span>
<a href="#l16.429"></a><span id="l16.429">       fp = fp.contents.next;</span>
<a href="#l16.430"></a><span id="l16.430">     }</span>
<a href="#l16.431"></a><span id="l16.431"> </span>
<a href="#l16.432"></a><span id="l16.432" class="difflineplus">+    let wContext = new Context(context);</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+    let prefNudge = OTR.defaultOtrVerifyNudge();</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+    let pb = OTR.getPrefBranchFromWrappedContext(wContext);</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+    if (pb) {</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+      prefNudge = pb.getBoolPref(&quot;options.otrVerifyNudge&quot;,</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineplus">+        OTR.defaultOtrVerifyNudge());</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+    }</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+</span>
<a href="#l16.440"></a><span id="l16.440">     // Only nudge on new fingerprint, as opposed to always.</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineminus">-    if (!this.verifyNudge)</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineminus">-      this.notifyObservers(new Context(context), &quot;otr:unverified&quot;,</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+    if (!prefNudge)</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+      this.notifyObservers(wContext, &quot;otr:unverified&quot;,</span>
<a href="#l16.445"></a><span id="l16.445">         (seen ? &quot;seen&quot; : &quot;unseen&quot;));</span>
<a href="#l16.446"></a><span id="l16.446">   },</span>
<a href="#l16.447"></a><span id="l16.447"> </span>
<a href="#l16.448"></a><span id="l16.448" class="difflineminus">-  // The list of known fingerprints has changed.  Write them to disk.</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineplus">+  /**</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+   * The list of known fingerprints has changed.  Write them to disk.</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+   */</span>
<a href="#l16.452"></a><span id="l16.452">   write_fingerprint_cb(opdata) {</span>
<a href="#l16.453"></a><span id="l16.453">     this.writeFingerprints();</span>
<a href="#l16.454"></a><span id="l16.454">   },</span>
<a href="#l16.455"></a><span id="l16.455"> </span>
<a href="#l16.456"></a><span id="l16.456" class="difflineminus">-  // A ConnContext has entered a secure state.</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+  /**</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+   * A ConnContext has entered a secure state.</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+   */</span>
<a href="#l16.460"></a><span id="l16.460">   gone_secure_cb(opdata, context) {</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineminus">-    context = new Context(context);</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineminus">-    let strid = &quot;context-gone_secure_&quot; + (context.trust ? &quot;private&quot; : &quot;unverified&quot;);</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineminus">-    this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineminus">-    this.sendAlert(context, _strArgs(strid, {name: context.username}));</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineminus">-    if (this.verifyNudge &amp;&amp; !context.trust)</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineminus">-      this.notifyObservers(context, &quot;otr:unverified&quot;, &quot;unseen&quot;);</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+    let wContext = new Context(context);</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineplus">+    let prefNudge = OTR.defaultOtrVerifyNudge();</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineplus">+    let pb = OTR.getPrefBranchFromWrappedContext(wContext);</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+    if (pb) {</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+      prefNudge = pb.getBoolPref(&quot;options.otrVerifyNudge&quot;,</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+        OTR.defaultOtrVerifyNudge());</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+    }</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+    let strid = &quot;context-gone_secure_&quot; + (wContext.trust ? &quot;private&quot; : &quot;unverified&quot;);</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+    this.notifyObservers(wContext, &quot;otr:msg-state&quot;);</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+    this.sendAlert(wContext, _strArgs(strid, {name: wContext.username}));</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineplus">+    if (prefNudge &amp;&amp; !wContext.trust)</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+      this.notifyObservers(wContext, &quot;otr:unverified&quot;, &quot;unseen&quot;);</span>
<a href="#l16.479"></a><span id="l16.479">   },</span>
<a href="#l16.480"></a><span id="l16.480"> </span>
<a href="#l16.481"></a><span id="l16.481" class="difflineminus">-  // A ConnContext has left a secure state.</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+  /**</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+   * A ConnContext has left a secure state.</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+   */</span>
<a href="#l16.485"></a><span id="l16.485">   gone_insecure_cb(opdata, context) {</span>
<a href="#l16.486"></a><span id="l16.486">     // This isn't used. See: https://bugs.otr.im/lib/libotr/issues/48</span>
<a href="#l16.487"></a><span id="l16.487">   },</span>
<a href="#l16.488"></a><span id="l16.488"> </span>
<a href="#l16.489"></a><span id="l16.489" class="difflineminus">-  // We have completed an authentication, using the D-H keys we already knew.</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineminus">-  // is_reply indicates whether we initiated the AKE.</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+  /**</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+   * We have completed an authentication, using the D-H keys we already</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+   * knew.</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+   *</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+   * @param is_reply    indicates whether we initiated the AKE.</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+   */</span>
<a href="#l16.497"></a><span id="l16.497">   still_secure_cb(opdata, context, is_reply) {</span>
<a href="#l16.498"></a><span id="l16.498">     // Indicate the private conversation was refreshed.</span>
<a href="#l16.499"></a><span id="l16.499">     if (!is_reply) {</span>
<a href="#l16.500"></a><span id="l16.500">       context = new Context(context);</span>
<a href="#l16.501"></a><span id="l16.501">       this.notifyObservers(context, &quot;otr:msg-state&quot;);</span>
<a href="#l16.502"></a><span id="l16.502">       this.sendAlert(context, _strArgs(&quot;context-still_secure&quot;, {name: context.username}));</span>
<a href="#l16.503"></a><span id="l16.503">     }</span>
<a href="#l16.504"></a><span id="l16.504">   },</span>
<a href="#l16.505"></a><span id="l16.505"> </span>
<a href="#l16.506"></a><span id="l16.506" class="difflineminus">-  // Find the maximum message size supported by this protocol.</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+  /**</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+   * Find the maximum message size supported by this protocol.</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+   */</span>
<a href="#l16.510"></a><span id="l16.510">   max_message_size_cb(opdata, context) {</span>
<a href="#l16.511"></a><span id="l16.511">     context = new Context(context);</span>
<a href="#l16.512"></a><span id="l16.512">     // These values are, for the most part, from pidgin-otr's mms_table.</span>
<a href="#l16.513"></a><span id="l16.513">     switch (context.protocol) {</span>
<a href="#l16.514"></a><span id="l16.514">     case &quot;irc&quot;:</span>
<a href="#l16.515"></a><span id="l16.515">     case &quot;prpl-irc&quot;:</span>
<a href="#l16.516"></a><span id="l16.516">       return 417;</span>
<a href="#l16.517"></a><span id="l16.517">     case &quot;facebook&quot;:</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineat">@@ -654,23 +697,27 @@ var OTR = {</span>
<a href="#l16.519"></a><span id="l16.519">       return 2343;</span>
<a href="#l16.520"></a><span id="l16.520">     case &quot;prpl-novell&quot;:</span>
<a href="#l16.521"></a><span id="l16.521">       return 1792;</span>
<a href="#l16.522"></a><span id="l16.522">     default:</span>
<a href="#l16.523"></a><span id="l16.523">       return 0;</span>
<a href="#l16.524"></a><span id="l16.524">     }</span>
<a href="#l16.525"></a><span id="l16.525">   },</span>
<a href="#l16.526"></a><span id="l16.526"> </span>
<a href="#l16.527"></a><span id="l16.527" class="difflineminus">-  // We received a request from the buddy to use the current &quot;extra&quot; symmetric</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineminus">-  // key.</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+  /**</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+   * We received a request from the buddy to use the current &quot;extra&quot;</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineplus">+   * symmetric key.</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineplus">+   */</span>
<a href="#l16.533"></a><span id="l16.533">   received_symkey_cb(opdata, context, use, usedata, usedatalen, symkey) {</span>
<a href="#l16.534"></a><span id="l16.534">     // Ignore until we have a use.</span>
<a href="#l16.535"></a><span id="l16.535">   },</span>
<a href="#l16.536"></a><span id="l16.536"> </span>
<a href="#l16.537"></a><span id="l16.537" class="difflineminus">-  // Return a string according to the error event.</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+  /**</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineplus">+   * Return a string according to the error event.</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+   */</span>
<a href="#l16.541"></a><span id="l16.541">   otr_error_message_cb(opdata, context, err_code) {</span>
<a href="#l16.542"></a><span id="l16.542">     context = new Context(context);</span>
<a href="#l16.543"></a><span id="l16.543">     let msg;</span>
<a href="#l16.544"></a><span id="l16.544">     switch (err_code) {</span>
<a href="#l16.545"></a><span id="l16.545">     case OTRLib.errorCode.OTRL_ERRCODE_ENCRYPTION_ERROR:</span>
<a href="#l16.546"></a><span id="l16.546">       msg = _str(&quot;error-enc&quot;);</span>
<a href="#l16.547"></a><span id="l16.547">       break;</span>
<a href="#l16.548"></a><span id="l16.548">     case OTRLib.errorCode.OTRL_ERRCODE_MSG_NOT_IN_PRIVATE:</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineat">@@ -683,34 +730,42 @@ var OTR = {</span>
<a href="#l16.550"></a><span id="l16.550">       msg = _str(&quot;error-malformed&quot;);</span>
<a href="#l16.551"></a><span id="l16.551">       break;</span>
<a href="#l16.552"></a><span id="l16.552">     default:</span>
<a href="#l16.553"></a><span id="l16.553">       return null;</span>
<a href="#l16.554"></a><span id="l16.554">     }</span>
<a href="#l16.555"></a><span id="l16.555">     return CLib.strdup(msg);</span>
<a href="#l16.556"></a><span id="l16.556">   },</span>
<a href="#l16.557"></a><span id="l16.557"> </span>
<a href="#l16.558"></a><span id="l16.558" class="difflineminus">-  // Deallocate a string returned by otr_error_message_cb.</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+  /**</span>
<a href="#l16.560"></a><span id="l16.560" class="difflineplus">+   * Deallocate a string returned by otr_error_message_cb.</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineplus">+   */</span>
<a href="#l16.562"></a><span id="l16.562">   otr_error_message_free_cb(opdata, err_msg) {</span>
<a href="#l16.563"></a><span id="l16.563">     if (!err_msg.isNull())</span>
<a href="#l16.564"></a><span id="l16.564">       CLib.free(err_msg);</span>
<a href="#l16.565"></a><span id="l16.565">   },</span>
<a href="#l16.566"></a><span id="l16.566"> </span>
<a href="#l16.567"></a><span id="l16.567" class="difflineminus">-  // Return a string that will be prefixed to any resent message.</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+  /**</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineplus">+   * Return a string that will be prefixed to any resent message.</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineplus">+   */</span>
<a href="#l16.571"></a><span id="l16.571">   resent_msg_prefix_cb(opdata, context) {</span>
<a href="#l16.572"></a><span id="l16.572">     return CLib.strdup(_str(&quot;resent&quot;));</span>
<a href="#l16.573"></a><span id="l16.573">   },</span>
<a href="#l16.574"></a><span id="l16.574"> </span>
<a href="#l16.575"></a><span id="l16.575" class="difflineminus">-  // Deallocate a string returned by resent_msg_prefix.</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineplus">+  /**</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineplus">+   * Deallocate a string returned by resent_msg_prefix.</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineplus">+   */</span>
<a href="#l16.579"></a><span id="l16.579">   resent_msg_prefix_free_cb(opdata, prefix) {</span>
<a href="#l16.580"></a><span id="l16.580">     if (!prefix.isNull())</span>
<a href="#l16.581"></a><span id="l16.581">       CLib.free(prefix);</span>
<a href="#l16.582"></a><span id="l16.582">   },</span>
<a href="#l16.583"></a><span id="l16.583"> </span>
<a href="#l16.584"></a><span id="l16.584" class="difflineminus">-  // Update the authentication UI with respect to SMP events.</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+  /**</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineplus">+   * Update the authentication UI with respect to SMP events.</span>
<a href="#l16.587"></a><span id="l16.587" class="difflineplus">+   */</span>
<a href="#l16.588"></a><span id="l16.588">   handle_smp_event_cb(opdata, smp_event, context, progress_percent, question) {</span>
<a href="#l16.589"></a><span id="l16.589">     context = new Context(context);</span>
<a href="#l16.590"></a><span id="l16.590">     switch (smp_event) {</span>
<a href="#l16.591"></a><span id="l16.591">     case OTRLib.smpEvent.OTRL_SMPEVENT_NONE:</span>
<a href="#l16.592"></a><span id="l16.592">       break;</span>
<a href="#l16.593"></a><span id="l16.593">     case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_ANSWER:</span>
<a href="#l16.594"></a><span id="l16.594">     case OTRLib.smpEvent.OTRL_SMPEVENT_ASK_FOR_SECRET:</span>
<a href="#l16.595"></a><span id="l16.595">       this.notifyObservers({</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineat">@@ -732,18 +787,20 @@ var OTR = {</span>
<a href="#l16.597"></a><span id="l16.597">     case OTRLib.smpEvent.OTRL_SMPEVENT_ERROR:</span>
<a href="#l16.598"></a><span id="l16.598">       OTR.abortSMP(context);</span>
<a href="#l16.599"></a><span id="l16.599">       break;</span>
<a href="#l16.600"></a><span id="l16.600">     default:</span>
<a href="#l16.601"></a><span id="l16.601">       this.log(&quot;smp event: &quot; + smp_event);</span>
<a href="#l16.602"></a><span id="l16.602">     }</span>
<a href="#l16.603"></a><span id="l16.603">   },</span>
<a href="#l16.604"></a><span id="l16.604"> </span>
<a href="#l16.605"></a><span id="l16.605" class="difflineminus">-  // Handle and send the appropriate message(s) to the sender/recipient</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineminus">-  // depending on the message events.</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineplus">+  /**</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineplus">+   * Handle and send the appropriate message(s) to the sender/recipient</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+   * depending on the message events.</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+   */</span>
<a href="#l16.611"></a><span id="l16.611">   handle_msg_event_cb(opdata, msg_event, context, message, err) {</span>
<a href="#l16.612"></a><span id="l16.612">     context = new Context(context);</span>
<a href="#l16.613"></a><span id="l16.613">     switch (msg_event) {</span>
<a href="#l16.614"></a><span id="l16.614">     case OTRLib.messageEvent.OTRL_MSGEVENT_NONE:</span>
<a href="#l16.615"></a><span id="l16.615">       break;</span>
<a href="#l16.616"></a><span id="l16.616">     case OTRLib.messageEvent.OTRL_MSGEVENT_ENCRYPTION_REQUIRED:</span>
<a href="#l16.617"></a><span id="l16.617">       this.sendAlert(context, _strArgs(&quot;msgevent-encryption_required_part1&quot;, {name: context.username}));</span>
<a href="#l16.618"></a><span id="l16.618">       this.sendAlert(context, _str(&quot;msgevent-encryption_required_part2&quot;));</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineat">@@ -791,37 +848,42 @@ var OTR = {</span>
<a href="#l16.620"></a><span id="l16.620">     case OTRLib.messageEvent.OTRL_MSGEVENT_RCVDMSG_FOR_OTHER_INSTANCE:</span>
<a href="#l16.621"></a><span id="l16.621">       this.log(_strArgs(&quot;msgevent-rcvdmsg_for_other_instance&quot;, {name: context.username}));</span>
<a href="#l16.622"></a><span id="l16.622">       break;</span>
<a href="#l16.623"></a><span id="l16.623">     default:</span>
<a href="#l16.624"></a><span id="l16.624">       this.log(&quot;msg event: &quot; + msg_event);</span>
<a href="#l16.625"></a><span id="l16.625">     }</span>
<a href="#l16.626"></a><span id="l16.626">   },</span>
<a href="#l16.627"></a><span id="l16.627"> </span>
<a href="#l16.628"></a><span id="l16.628" class="difflineminus">-  // Create an instance tag for the given accountname/protocol if desired.</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineplus">+  /**</span>
<a href="#l16.630"></a><span id="l16.630" class="difflineplus">+   * Create an instance tag for the given accountname/protocol if</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineplus">+   * desired.</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineplus">+   */</span>
<a href="#l16.633"></a><span id="l16.633">   create_instag_cb(opdata, accountname, protocol) {</span>
<a href="#l16.634"></a><span id="l16.634">     this.generateInstanceTag(accountname.readString(), protocol.readString());</span>
<a href="#l16.635"></a><span id="l16.635">   },</span>
<a href="#l16.636"></a><span id="l16.636"> </span>
<a href="#l16.637"></a><span id="l16.637" class="difflineminus">-  // When timer_control is called, turn off any existing periodic timer.</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineminus">-  // Additionally, if interval &gt; 0, set a new periodic timer to go off every</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineminus">-  // interval seconds.</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineplus">+  /**</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineplus">+   * When timer_control is called, turn off any existing periodic timer.</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineplus">+   * Additionally, if interval &gt; 0, set a new periodic timer to go off</span>
<a href="#l16.643"></a><span id="l16.643" class="difflineplus">+   * every interval seconds.</span>
<a href="#l16.644"></a><span id="l16.644" class="difflineplus">+   */</span>
<a href="#l16.645"></a><span id="l16.645">   timer_control_cb(opdata, interval) {</span>
<a href="#l16.646"></a><span id="l16.646">     if (this._poll_timer) {</span>
<a href="#l16.647"></a><span id="l16.647">       clearInterval(this._poll_timer);</span>
<a href="#l16.648"></a><span id="l16.648">       this._poll_timer = null;</span>
<a href="#l16.649"></a><span id="l16.649">     }</span>
<a href="#l16.650"></a><span id="l16.650">     if (interval &gt; 0) {</span>
<a href="#l16.651"></a><span id="l16.651">       this._poll_timer = setInterval(() =&gt; {</span>
<a href="#l16.652"></a><span id="l16.652">         OTRLib.otrl_message_poll(this.userstate, this.uiOps.address(), null);</span>
<a href="#l16.653"></a><span id="l16.653">       }, interval * 1000);</span>
<a href="#l16.654"></a><span id="l16.654">     }</span>
<a href="#l16.655"></a><span id="l16.655">   },</span>
<a href="#l16.656"></a><span id="l16.656"> </span>
<a href="#l16.657"></a><span id="l16.657" class="difflineminus">-  // uiOps</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineplus">+  // end of uiOps</span>
<a href="#l16.659"></a><span id="l16.659"> </span>
<a href="#l16.660"></a><span id="l16.660">   initUiOps() {</span>
<a href="#l16.661"></a><span id="l16.661">     this.uiOps = new OTRLib.OtrlMessageAppOps();</span>
<a href="#l16.662"></a><span id="l16.662"> </span>
<a href="#l16.663"></a><span id="l16.663">     let methods = [</span>
<a href="#l16.664"></a><span id="l16.664">       &quot;policy&quot;,</span>
<a href="#l16.665"></a><span id="l16.665">       &quot;create_privkey&quot;,</span>
<a href="#l16.666"></a><span id="l16.666">       &quot;is_logged_in&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/modules/OTRLib.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/modules/OTRLib.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -34,39 +34,51 @@ function tryLoadOTR(name, suffix) {</span>
<a href="#l17.4"></a><span id="l17.4">       libotrPath = filename;</span>
<a href="#l17.5"></a><span id="l17.5">       console.log(&quot;===&gt; trying to load &quot; +</span>
<a href="#l17.6"></a><span id="l17.6">         libotrPath + &quot; from system's standard locations&quot;);</span>
<a href="#l17.7"></a><span id="l17.7">       libotr = ctypes.open(libotrPath);</span>
<a href="#l17.8"></a><span id="l17.8">     } catch (e) {}</span>
<a href="#l17.9"></a><span id="l17.9">   }</span>
<a href="#l17.10"></a><span id="l17.10"> }</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-if (!libotr &amp;&amp; (systemOS === &quot;winnt&quot; || systemOS === &quot;darwin&quot;)) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  // otr.5.dll or otr.5.dylib</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  tryLoadOTR(&quot;otr.5&quot;, &quot;&quot;);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-}</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+function loadExternalOTRLib() {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  if (!libotr &amp;&amp; (systemOS === &quot;winnt&quot; || systemOS === &quot;darwin&quot;)) {</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+    // otr.5.dll or otr.5.dylib</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+    tryLoadOTR(&quot;otr.5&quot;, &quot;&quot;);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  }</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+  if (!libotr &amp;&amp; systemOS === &quot;winnt&quot;) {</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+    // otr-5.dll</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+    tryLoadOTR(&quot;otr-5&quot;, &quot;&quot;);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  }</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-if (!libotr &amp;&amp; systemOS === &quot;winnt&quot;) {</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  // otr-5.dll</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-  tryLoadOTR(&quot;otr-5&quot;, &quot;&quot;);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  if (!libotr &amp;&amp; systemOS === &quot;winnt&quot;) {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+    // libotr-5.dll</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+    tryLoadOTR(&quot;libotr-5&quot;, &quot;&quot;);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  }</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  if (!libotr &amp;&amp; !(systemOS === &quot;winnt&quot;) &amp;&amp; !(systemOS === &quot;darwin&quot;)) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    // libotr.so.5</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+    tryLoadOTR(&quot;otr&quot;, &quot;.5&quot;);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  }</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+  if (!libotr) {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+    tryLoadOTR(&quot;otr&quot;, &quot;&quot;);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+  }</span>
<a href="#l17.43"></a><span id="l17.43"> }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-if (!libotr &amp;&amp; systemOS === &quot;winnt&quot;) {</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-  // libotr-5.dll</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  tryLoadOTR(&quot;libotr-5&quot;, &quot;&quot;);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-}</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-if (!libotr &amp;&amp; !(systemOS === &quot;winnt&quot;) &amp;&amp; !(systemOS === &quot;darwin&quot;)) {</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  // libotr.so.5</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-  tryLoadOTR(&quot;otr&quot;, &quot;.5&quot;);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-}</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-if (!libotr) {</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  tryLoadOTR(&quot;otr&quot;, &quot;&quot;);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-}</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+var OTRLibLoader = {</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+  init() {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    loadExternalOTRLib();</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+    if (libotr) {</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+      enableOTRLibJS();</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    }</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+    return OTRLib;</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  },</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+};</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68"> // Helper function to open files with the path properly encoded.</span>
<a href="#l17.69"></a><span id="l17.69"> var callWithFILEp = function() {</span>
<a href="#l17.70"></a><span id="l17.70">   // Windows filenames are in UTF-16.</span>
<a href="#l17.71"></a><span id="l17.71">   let charType = (systemOS === &quot;winnt&quot;) ? &quot;jschar&quot; : &quot;char&quot;;</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73">   let args = Array.from(arguments);</span>
<a href="#l17.74"></a><span id="l17.74">   let func = args.shift() + &quot;_FILEp&quot;;</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineat">@@ -379,17 +391,20 @@ const OTRL_POLICY_SEND_WHITESPACE_TAG = </span>
<a href="#l17.76"></a><span id="l17.76"> const OTRL_POLICY_WHITESPACE_START_AKE = 0x20;</span>
<a href="#l17.77"></a><span id="l17.77"> </span>
<a href="#l17.78"></a><span id="l17.78"> // const OTRL_POLICY_ERROR_START_AKE = 0x40;</span>
<a href="#l17.79"></a><span id="l17.79"> // Disabled to avoid automatic resend and MITM, as explained in</span>
<a href="#l17.80"></a><span id="l17.80"> // https://github.com/arlolra/ctypes-otr/issues/55</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82"> var OTRLib;</span>
<a href="#l17.83"></a><span id="l17.83"> </span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-if (libotr) OTRLib = {</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+function enableOTRLibJS() {</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  // this must be delayed until after &quot;libotr&quot; is initialized</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+  OTRLib = {</span>
<a href="#l17.89"></a><span id="l17.89"> </span>
<a href="#l17.90"></a><span id="l17.90">   path: libotrPath,</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92">   // libotr API version</span>
<a href="#l17.93"></a><span id="l17.93">   otrl_version,</span>
<a href="#l17.94"></a><span id="l17.94"> </span>
<a href="#l17.95"></a><span id="l17.95">   init() {</span>
<a href="#l17.96"></a><span id="l17.96">     // console.log(&quot;===&gt; OTRLib.init()\n&quot;);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineat">@@ -905,14 +920,14 @@ if (libotr) OTRLib = {</span>
<a href="#l17.98"></a><span id="l17.98">   ),</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100">   // Deallocate a chain of TLVs.</span>
<a href="#l17.101"></a><span id="l17.101">   otrl_tlv_free: libotr.declare(</span>
<a href="#l17.102"></a><span id="l17.102">     &quot;otrl_tlv_free&quot;, abi, ctypes.void_t,</span>
<a href="#l17.103"></a><span id="l17.103">     OtrlTLV.ptr</span>
<a href="#l17.104"></a><span id="l17.104">   ),</span>
<a href="#l17.105"></a><span id="l17.105"> </span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-};</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+  };</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+}</span>
<a href="#l17.110"></a><span id="l17.110"> </span>
<a href="#l17.111"></a><span id="l17.111"> // exports</span>
<a href="#l17.112"></a><span id="l17.112"> </span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;OTRLib&quot;];</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;OTRLibLoader&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/modules/OTRUI.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/modules/OTRUI.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -86,41 +86,28 @@ function initStrings() {</span>
<a href="#l18.4"></a><span id="l18.4">       class: &quot;finished&quot;,</span>
<a href="#l18.5"></a><span id="l18.5">     }],</span>
<a href="#l18.6"></a><span id="l18.6">   ]);</span>
<a href="#l18.7"></a><span id="l18.7"> }</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> var windowRefs = new Map();</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> var OTRUI = {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  enabled: false,</span>
<a href="#l18.13"></a><span id="l18.13">   stringsLoaded: false,</span>
<a href="#l18.14"></a><span id="l18.14">   globalDoc: null,</span>
<a href="#l18.15"></a><span id="l18.15">   visibleConv: null,</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  debug: true,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+  debug: false,</span>
<a href="#l18.19"></a><span id="l18.19">   logMsg(msg) {</span>
<a href="#l18.20"></a><span id="l18.20">     if (!OTRUI.debug)</span>
<a href="#l18.21"></a><span id="l18.21">       return;</span>
<a href="#l18.22"></a><span id="l18.22">     Services.console.logStringMessage(msg);</span>
<a href="#l18.23"></a><span id="l18.23">   },</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-  prefs: null,</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  setPrefs() {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-    let branch = &quot;chat.otr.&quot;;</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-    let prefs = {</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-      requireEncryption: false,</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-      verifyNudge: true,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-    };</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    let defaults = Services.prefs.getDefaultBranch(branch);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    Object.keys(prefs).forEach(function(key) {</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-      defaults.setBoolPref(key, prefs[key]);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    });</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    OTRUI.prefs = Services.prefs.getBranch(branch);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  },</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-</span>
<a href="#l18.39"></a><span id="l18.39">   addMenuObserver() {</span>
<a href="#l18.40"></a><span id="l18.40">     let iter = Services.ww.getWindowEnumerator();</span>
<a href="#l18.41"></a><span id="l18.41">     while (iter.hasMoreElements())</span>
<a href="#l18.42"></a><span id="l18.42">       OTRUI.addMenus(iter.getNext());</span>
<a href="#l18.43"></a><span id="l18.43">     Services.obs.addObserver(OTRUI, &quot;domwindowopened&quot;);</span>
<a href="#l18.44"></a><span id="l18.44">   },</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46">   removeMenuObserver() {</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineat">@@ -196,37 +183,36 @@ var OTRUI = {</span>
<a href="#l18.48"></a><span id="l18.48">   },</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50">   async init() {</span>
<a href="#l18.51"></a><span id="l18.51">     if (!OTRUI.stringsLoaded) {</span>
<a href="#l18.52"></a><span id="l18.52">       initStrings();</span>
<a href="#l18.53"></a><span id="l18.53">       OTRUI.stringsLoaded = true;</span>
<a href="#l18.54"></a><span id="l18.54">     }</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    // console.log(&quot;====&gt; OTRUI init\n&quot;);</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    OTRUI.setPrefs();</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-    OTR.init({</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-      requireEncryption: OTRUI.prefs.getBoolPref(&quot;requireEncryption&quot;),</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-      verifyNudge: OTRUI.prefs.getBoolPref(&quot;verifyNudge&quot;),</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-    });</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+    this.debug = Services.prefs.getBoolPref(&quot;chat.otr.trace&quot;, false);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+    OTR.init({});</span>
<a href="#l18.65"></a><span id="l18.65">     if (!OTR.libLoaded) {</span>
<a href="#l18.66"></a><span id="l18.66">       return;</span>
<a href="#l18.67"></a><span id="l18.67">     }</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    this.enabled = true;</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+</span>
<a href="#l18.71"></a><span id="l18.71">     OTR.addObserver(OTRUI);</span>
<a href="#l18.72"></a><span id="l18.72">     OTR.loadFiles().then(function() {</span>
<a href="#l18.73"></a><span id="l18.73">       Services.obs.addObserver(OTR, &quot;new-ui-conversation&quot;);</span>
<a href="#l18.74"></a><span id="l18.74">       // Disabled until #76 is resolved.</span>
<a href="#l18.75"></a><span id="l18.75">       // Services.obs.addObserver(OTRUI, &quot;contact-added&quot;, false);</span>
<a href="#l18.76"></a><span id="l18.76">       Services.obs.addObserver(OTRUI, &quot;account-added&quot;);</span>
<a href="#l18.77"></a><span id="l18.77">       // Services.obs.addObserver(OTRUI, &quot;contact-signed-off&quot;, false);</span>
<a href="#l18.78"></a><span id="l18.78">       Services.obs.addObserver(OTRUI, &quot;conversation-loaded&quot;);</span>
<a href="#l18.79"></a><span id="l18.79">       Services.obs.addObserver(OTRUI, &quot;conversation-closed&quot;);</span>
<a href="#l18.80"></a><span id="l18.80">       Services.obs.addObserver(OTRUI, &quot;prpl-quit&quot;);</span>
<a href="#l18.81"></a><span id="l18.81"> </span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-      OTRUI.prefs.addObserver(&quot;&quot;, OTRUI);</span>
<a href="#l18.83"></a><span id="l18.83">       let conversations = Services.conversations.getConversations();</span>
<a href="#l18.84"></a><span id="l18.84">       while (conversations.hasMoreElements()) {</span>
<a href="#l18.85"></a><span id="l18.85">       let aConv = conversations.getNext();</span>
<a href="#l18.86"></a><span id="l18.86">       OTRUI.initConv(aConv);</span>
<a href="#l18.87"></a><span id="l18.87">       }</span>
<a href="#l18.88"></a><span id="l18.88">       OTRUI.addMenuObserver();</span>
<a href="#l18.89"></a><span id="l18.89">     }).catch(function(err) {</span>
<a href="#l18.90"></a><span id="l18.90">       // console.log(&quot;===&gt; &quot; + err + &quot;\n&quot;);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineat">@@ -245,29 +231,16 @@ var OTRUI = {</span>
<a href="#l18.92"></a><span id="l18.92">         continue;</span>
<a href="#l18.93"></a><span id="l18.93">       if (!OTR.disconnect(conv, true)) {</span>
<a href="#l18.94"></a><span id="l18.94">         allGood = false;</span>
<a href="#l18.95"></a><span id="l18.95">       }</span>
<a href="#l18.96"></a><span id="l18.96">     }</span>
<a href="#l18.97"></a><span id="l18.97">     return allGood;</span>
<a href="#l18.98"></a><span id="l18.98">   },</span>
<a href="#l18.99"></a><span id="l18.99"> </span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-  changePref(aMsg) {</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-    switch (aMsg) {</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-    case &quot;requireEncryption&quot;:</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-      OTR.setPolicy(OTRUI.prefs.getBoolPref(&quot;requireEncryption&quot;));</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-      break;</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-    case &quot;verifyNudge&quot;:</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-      OTR.verifyNudge = OTRUI.prefs.getBoolPref(&quot;verifyNudge&quot;);</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-      break;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-    default:</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-      OTRUI.logMsg(aMsg);</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-    }</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-  },</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-</span>
<a href="#l18.113"></a><span id="l18.113">   openAuth(window, name, mode, uiConv, contactInfo) {</span>
<a href="#l18.114"></a><span id="l18.114">     let otrAuth = this.globalDoc.querySelector(&quot;.otr-auth&quot;);</span>
<a href="#l18.115"></a><span id="l18.115">     otrAuth.disabled = true;</span>
<a href="#l18.116"></a><span id="l18.116">     let win = window.openDialog(</span>
<a href="#l18.117"></a><span id="l18.117">       authDialog,</span>
<a href="#l18.118"></a><span id="l18.118">       &quot;auth=&quot; + name,</span>
<a href="#l18.119"></a><span id="l18.119">       &quot;centerscreen,resizable=no,minimizable=no&quot;,</span>
<a href="#l18.120"></a><span id="l18.120">       mode,</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineat">@@ -652,76 +625,75 @@ var OTRUI = {</span>
<a href="#l18.122"></a><span id="l18.122">   },</span>
<a href="#l18.123"></a><span id="l18.123"> </span>
<a href="#l18.124"></a><span id="l18.124">   observe(aObject, aTopic, aMsg) {</span>
<a href="#l18.125"></a><span id="l18.125">     let doc;</span>
<a href="#l18.126"></a><span id="l18.126">     // console.log(&quot;====&gt; observing topic: &quot; + aTopic + &quot; with msg: &quot; + aMsg);</span>
<a href="#l18.127"></a><span id="l18.127">     // console.log(aObject);</span>
<a href="#l18.128"></a><span id="l18.128"> </span>
<a href="#l18.129"></a><span id="l18.129">     switch (aTopic) {</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-    case &quot;nsPref:changed&quot;:</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-      OTRUI.changePref(aMsg);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-      break;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-    case &quot;conversation-loaded&quot;:</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-      doc = aObject.ownerDocument;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-      let windowtype = doc.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-      if (windowtype !== &quot;mail:3pane&quot;) {</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-        return;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-      }</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-      OTRUI.addButton(aObject);</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-      break;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-    case &quot;conversation-closed&quot;:</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-      if (aObject.isChat)</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-        return;</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-      this.globalBox.removeAllNotifications();</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-      OTRUI.closeAuth(OTR.getContext(aObject));</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-      OTRUI.disconnect(aObject);</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-      break;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-    // case &quot;contact-signed-off&quot;:</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineminus">-    //  break;</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-    case &quot;prpl-quit&quot;:</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-      OTRUI.disconnect(null);</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-      break;</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-    case &quot;domwindowopened&quot;:</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-      OTRUI.addMenus(aObject);</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-      break;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-    case &quot;otr:generate&quot;:</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-      OTRUI.generate(aObject);</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-      break;</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-    case &quot;otr:disconnected&quot;:</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-    case &quot;otr:msg-state&quot;:</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-      if (aTopic === &quot;otr:disconnected&quot; ||</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-          OTR.trust(aObject) !== OTR.trustState.TRUST_UNVERIFIED) {</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-        OTRUI.closeAuth(aObject);</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-        OTRUI.closeUnverified(aObject);</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-        OTRUI.closeVerification(aObject);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-      }</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-      OTRUI.setMsgState(null, aObject, this.globalDoc, false);</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-      break;</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-    case &quot;otr:unverified&quot;:</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-      OTRUI.notifyUnverified(aObject, aMsg);</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-      break;</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-    case &quot;otr:trust-state&quot;:</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-      OTRUI.alertTrust(aObject);</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-      break;</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-    case &quot;otr:log&quot;:</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-      OTRUI.logMsg(&quot;otr: &quot; + aObject);</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-      break;</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-    case &quot;account-added&quot;:</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-      OTRUI.onAccountCreated(aObject);</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-      break;</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-    case &quot;contact-added&quot;:</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-      OTRUI.onContactAdded(aObject);</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-      break;</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-    case &quot;otr:auth-ask&quot;:</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-      OTRUI.askAuth(aObject);</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-      break;</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-    case &quot;otr:auth-update&quot;:</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-      OTRUI.updateAuth(aObject);</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-      break;</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+      case &quot;nsPref:changed&quot;:</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+        break;</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+      case &quot;conversation-loaded&quot;:</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+        doc = aObject.ownerDocument;</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+        let windowtype = doc.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+        if (windowtype !== &quot;mail:3pane&quot;) {</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+          return;</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+        }</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+        OTRUI.addButton(aObject);</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+        break;</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+      case &quot;conversation-closed&quot;:</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+        if (aObject.isChat)</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+          return;</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+        this.globalBox.removeAllNotifications();</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+        OTRUI.closeAuth(OTR.getContext(aObject));</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+        OTRUI.disconnect(aObject);</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+        break;</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+      // case &quot;contact-signed-off&quot;:</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+      //  break;</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+      case &quot;prpl-quit&quot;:</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+        OTRUI.disconnect(null);</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+        break;</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+      case &quot;domwindowopened&quot;:</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+        OTRUI.addMenus(aObject);</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+        break;</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+      case &quot;otr:generate&quot;:</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+        OTRUI.generate(aObject);</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+        break;</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+      case &quot;otr:disconnected&quot;:</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+      case &quot;otr:msg-state&quot;:</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+        if (aTopic === &quot;otr:disconnected&quot; ||</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+            OTR.trust(aObject) !== OTR.trustState.TRUST_UNVERIFIED) {</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+          OTRUI.closeAuth(aObject);</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+          OTRUI.closeUnverified(aObject);</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+          OTRUI.closeVerification(aObject);</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+        }</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+        OTRUI.setMsgState(null, aObject, this.globalDoc, false);</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+        break;</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+      case &quot;otr:unverified&quot;:</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+        OTRUI.notifyUnverified(aObject, aMsg);</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+        break;</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+      case &quot;otr:trust-state&quot;:</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+        OTRUI.alertTrust(aObject);</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+        break;</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+      case &quot;otr:log&quot;:</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+        OTRUI.logMsg(&quot;otr: &quot; + aObject);</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+        break;</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+      case &quot;account-added&quot;:</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+        OTRUI.onAccountCreated(aObject);</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+        break;</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+      case &quot;contact-added&quot;:</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+        OTRUI.onContactAdded(aObject);</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineplus">+        break;</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineplus">+      case &quot;otr:auth-ask&quot;:</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+        OTRUI.askAuth(aObject);</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+        break;</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+      case &quot;otr:auth-update&quot;:</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineplus">+        OTRUI.updateAuth(aObject);</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineplus">+        break;</span>
<a href="#l18.249"></a><span id="l18.249">     }</span>
<a href="#l18.250"></a><span id="l18.250">   },</span>
<a href="#l18.251"></a><span id="l18.251"> </span>
<a href="#l18.252"></a><span id="l18.252">   initConv(binding) {</span>
<a href="#l18.253"></a><span id="l18.253">     OTR.addConversation(binding._conv);</span>
<a href="#l18.254"></a><span id="l18.254">     OTRUI.addButton(binding);</span>
<a href="#l18.255"></a><span id="l18.255">   },</span>
<a href="#l18.256"></a><span id="l18.256"> </span>
<a href="#l18.257"></a><span id="l18.257" class="difflineat">@@ -744,15 +716,14 @@ var OTRUI = {</span>
<a href="#l18.258"></a><span id="l18.258">     Services.obs.removeObserver(OTRUI, &quot;conversation-loaded&quot;);</span>
<a href="#l18.259"></a><span id="l18.259">     Services.obs.removeObserver(OTRUI, &quot;conversation-closed&quot;);</span>
<a href="#l18.260"></a><span id="l18.260">     Services.obs.removeObserver(OTRUI, &quot;prpl-quit&quot;);</span>
<a href="#l18.261"></a><span id="l18.261"> </span>
<a href="#l18.262"></a><span id="l18.262">     let conversations = Services.conversations.getConversations();</span>
<a href="#l18.263"></a><span id="l18.263">     while (conversations.hasMoreElements()) {</span>
<a href="#l18.264"></a><span id="l18.264">       OTRUI.resetConv(conversations.getNext());</span>
<a href="#l18.265"></a><span id="l18.265">     }</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-    OTRUI.prefs.removeObserver(&quot;&quot;, OTRUI);</span>
<a href="#l18.267"></a><span id="l18.267">     OTR.removeObserver(OTRUI);</span>
<a href="#l18.268"></a><span id="l18.268">     OTR.close();</span>
<a href="#l18.269"></a><span id="l18.269">     OTRUI.removeMenuObserver();</span>
<a href="#l18.270"></a><span id="l18.270">   },</span>
<a href="#l18.271"></a><span id="l18.271"> </span>
<a href="#l18.272"></a><span id="l18.272"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/components/im/content/am-im.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/components/im/content/am-im.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,25 +1,40 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.5"></a><span id="l19.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.6"></a><span id="l19.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> // chat/content/imAccountOptionsHelper.js</span>
<a href="#l19.9"></a><span id="l19.9"> /* globals accountOptionsHelper */</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;OTRUI&quot;, &quot;resource:///modules/OTRUI.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;OTR&quot;, &quot;resource:///modules/OTR.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16"> var autoJoinPref = &quot;autoJoin&quot;;</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> function onPreInit(aAccount, aAccountValue) {</span>
<a href="#l19.19"></a><span id="l19.19">   account.init(aAccount.incomingServer.wrappedJSObject.imAccount);</span>
<a href="#l19.20"></a><span id="l19.20"> }</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> var account = {</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-  init(aAccount) {</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+  async init(aAccount) {</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+    let title = document.querySelector(&quot;.dialogheader .dialogheader-title&quot;);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+    let defaultTitle = title.getAttribute(&quot;defaultTitle&quot;);</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+    let titleValue;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+    if (aAccount.name) {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+      titleValue = defaultTitle + &quot; - &lt;&quot; + aAccount.name + &quot;&gt;&quot;;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+    } else {</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+      titleValue = defaultTitle;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+    }</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+    title.setAttribute(&quot;value&quot;, titleValue);</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+    document.title = titleValue;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+</span>
<a href="#l19.38"></a><span id="l19.38">     this.account = aAccount;</span>
<a href="#l19.39"></a><span id="l19.39">     this.proto = this.account.protocol;</span>
<a href="#l19.40"></a><span id="l19.40">     document.getElementById(&quot;accountName&quot;).value = this.account.name;</span>
<a href="#l19.41"></a><span id="l19.41">     document.getElementById(&quot;protocolName&quot;).value = this.proto.name || this.proto.id;</span>
<a href="#l19.42"></a><span id="l19.42">     document.getElementById(&quot;protocolIcon&quot;).src =</span>
<a href="#l19.43"></a><span id="l19.43">       this.proto.iconBaseURI + &quot;icon48.png&quot;;</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">     let password = document.getElementById(&quot;server.password&quot;);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineat">@@ -37,20 +52,35 @@ var account = {</span>
<a href="#l19.47"></a><span id="l19.47">       } catch (e) {</span>
<a href="#l19.48"></a><span id="l19.48">         passwordBox.hidden = true;</span>
<a href="#l19.49"></a><span id="l19.49">         password.removeAttribute(&quot;wsm_persist&quot;);</span>
<a href="#l19.50"></a><span id="l19.50">       }</span>
<a href="#l19.51"></a><span id="l19.51">     }</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">     document.getElementById(&quot;server.alias&quot;).value = this.account.alias;</span>
<a href="#l19.54"></a><span id="l19.54"> </span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+    if (OTRUI.enabled) {</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+      document.getElementById(&quot;imTabOTR&quot;).hidden = false;</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+      document.getElementById(&quot;server.otrVerifyNudge&quot;).value = this.account.otrVerifyNudge;</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+      document.getElementById(&quot;server.otrRequireEncryption&quot;).value = this.account.otrRequireEncryption;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+      let fpa = this.account.normalizedName;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+      let fpp = this.account.protocol.normalizedName;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+      let fp = OTR.privateKeyFingerprint(fpa, fpp);</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+      if (!fp) {</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+        OTR.generatePrivateKey(fpa, fpp);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+        fp = await document.l10n.formatValue(&quot;otr-notYetAvailable&quot;);</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+      }</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+      document.getElementById(&quot;otrFingerprint&quot;).value = fp;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    }</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+</span>
<a href="#l19.70"></a><span id="l19.70">     let protoId = this.proto.id;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-    let canAutoJoin =</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-      protoId == &quot;prpl-irc&quot; || protoId == &quot;prpl-jabber&quot; || protoId == &quot;prpl-gtalk&quot;;</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-    document.getElementById(&quot;optionalSeparator&quot;).hidden = !canAutoJoin;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+    let canAutoJoin = protoId == &quot;prpl-irc&quot; ||</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+                      protoId == &quot;prpl-jabber&quot; ||</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+                      protoId == &quot;prpl-gtalk&quot;;</span>
<a href="#l19.77"></a><span id="l19.77">     document.getElementById(&quot;autojoinBox&quot;).hidden = !canAutoJoin;</span>
<a href="#l19.78"></a><span id="l19.78">     let autojoin = document.getElementById(&quot;server.autojoin&quot;);</span>
<a href="#l19.79"></a><span id="l19.79">     if (canAutoJoin)</span>
<a href="#l19.80"></a><span id="l19.80">       autojoin.setAttribute(&quot;wsm_persist&quot;, &quot;true&quot;);</span>
<a href="#l19.81"></a><span id="l19.81">     else</span>
<a href="#l19.82"></a><span id="l19.82">       autojoin.removeAttribute(&quot;wsm_persist&quot;);</span>
<a href="#l19.83"></a><span id="l19.83"> </span>
<a href="#l19.84"></a><span id="l19.84">     this.prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineat">@@ -90,9 +120,22 @@ var account = {</span>
<a href="#l19.86"></a><span id="l19.86">       // Force textbox XBL binding attachment by forcing layout,</span>
<a href="#l19.87"></a><span id="l19.87">       // otherwise setFormElementValue from AccountManager.js sets</span>
<a href="#l19.88"></a><span id="l19.88">       // properties that don't exist when restoring values.</span>
<a href="#l19.89"></a><span id="l19.89">       document.getElementById(&quot;protoSpecific&quot;).getBoundingClientRect();</span>
<a href="#l19.90"></a><span id="l19.90">     } else if (!haveOptions) {</span>
<a href="#l19.91"></a><span id="l19.91">       advanced.hidden = true;</span>
<a href="#l19.92"></a><span id="l19.92">     }</span>
<a href="#l19.93"></a><span id="l19.93">   },</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+  viewFingerprintKeys() {</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    window.openDialog(&quot;chrome://chat/content/otr-finger.xul&quot;, &quot;&quot;,</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+                      &quot;chrome,modal,titlebar,centerscreen&quot;, this.account);</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+  },</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+  updateRequireEncryption() {</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+    console.log(&quot;require&quot;);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+  },</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+  updateVerifyNudge() {</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    console.log(&quot;verify&quot;);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+  },</span>
<a href="#l19.107"></a><span id="l19.107"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/components/im/content/am-im.xul</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/components/im/content/am-im.xul</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,52 +1,128 @@</span>
<a href="#l20.4"></a><span id="l20.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l20.5"></a><span id="l20.5"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/content/bindings.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-&lt;!DOCTYPE window SYSTEM &quot;chrome://messenger/locale/am-im.dtd&quot;&gt;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/accountManage.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-&lt;page xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-  id=&quot;account&quot;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-  title=&quot;&amp;accountWindow.title;&quot;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  buttons=&quot;accept,cancel&quot;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  onload=&quot;parent.onPanelLoaded('am-im.xul');&quot;&gt;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+  &lt;!ENTITY % imDTD SYSTEM &quot;chrome://messenger/locale/am-im.dtd&quot;&gt;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+  &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+  %imDTD;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+  %brandDTD;</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+]&gt;</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+&lt;page xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+      xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+      id=&quot;account&quot;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+      title=&quot;&amp;accountWindow.title;&quot;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+      buttons=&quot;accept,cancel&quot;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+      onload=&quot;parent.onPanelLoaded('am-im.xul');&quot;&gt;</span>
<a href="#l20.33"></a><span id="l20.33">   &lt;script src=&quot;chrome://chat/content/imAccountOptionsHelper.js&quot;/&gt;</span>
<a href="#l20.34"></a><span id="l20.34">   &lt;script src=&quot;chrome://messenger/content/am-im.js&quot;/&gt;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  &lt;hbox&gt;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-    &lt;image id=&quot;protocolIcon&quot;/&gt;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-      &lt;label id=&quot;accountName&quot; crop=&quot;end&quot; class=&quot;header&quot;/&gt;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-      &lt;label id=&quot;protocolName&quot;/&gt;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  &lt;separator/&gt;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  &lt;linkset&gt;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+    &lt;html:link rel=&quot;localization&quot; href=&quot;branding/brand.ftl&quot;/&gt;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+    &lt;html:link rel=&quot;localization&quot; href=&quot;messenger/preferences/am-im.ftl&quot;/&gt;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+    &lt;html:link rel=&quot;localization&quot; href=&quot;messenger/otr/am-im-otr.ftl&quot;/&gt;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+  &lt;/linkset&gt;</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  &lt;hbox id=&quot;passwordBox&quot; equalsize=&quot;always&quot; align=&quot;baseline&quot;&gt;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-    &lt;label value=&quot;&amp;account.password;&quot; control=&quot;server.password&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-    &lt;textbox id=&quot;server.password&quot; flex=&quot;1&quot; type=&quot;password&quot;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-             preftype=&quot;wstring&quot; genericattr=&quot;true&quot;/&gt;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  &lt;separator class=&quot;groove&quot;/&gt;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-  &lt;hbox id=&quot;aliasBox&quot; equalsize=&quot;always&quot; align=&quot;baseline&quot;&gt;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-    &lt;label value=&quot;&amp;account.alias;&quot; control=&quot;server.alias&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-    &lt;textbox id=&quot;server.alias&quot; flex=&quot;1&quot; preftype=&quot;wstring&quot;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-             wsm_persist=&quot;true&quot; genericattr=&quot;true&quot;/&gt;</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+  &lt;hbox class=&quot;dialogheader&quot;&gt;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+    &lt;label class=&quot;dialogheader-title&quot; defaultTitle=&quot;&amp;accountWindow.title;&quot;/&gt;</span>
<a href="#l20.63"></a><span id="l20.63">   &lt;/hbox&gt;</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  &lt;separator class=&quot;groove&quot; hidden=&quot;true&quot; id=&quot;optionalSeparator&quot;/&gt;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  &lt;groupbox&gt;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+      &lt;image id=&quot;protocolIcon&quot;/&gt;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+      &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+        &lt;label id=&quot;accountName&quot; crop=&quot;end&quot; class=&quot;header&quot;/&gt;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+        &lt;label id=&quot;protocolName&quot;/&gt;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+      &lt;/vbox&gt;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+  &lt;/groupbox&gt;</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+  &lt;groupbox&gt;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+    &lt;tabbox id=&quot;imTabbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+      &lt;tabs&gt;</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+          &lt;tab id=&quot;imTabGeneral&quot; label=&quot;&amp;account.general;&quot;/&gt;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+          &lt;tab id=&quot;imTabOTR&quot; data-l10n-id=&quot;account-encryption&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+      &lt;/tabs&gt;</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+      &lt;tabpanels flex=&quot;1&quot;&gt;</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+        &lt;tabpanel orient=&quot;vertical&quot;&gt;</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+          &lt;label class=&quot;header&quot; data-l10n-id=&quot;account-settingsTitle&quot; /&gt;</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+          &lt;hbox id=&quot;passwordBox&quot; equalsize=&quot;always&quot; align=&quot;baseline&quot;&gt;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+            &lt;label value=&quot;&amp;account.password;&quot; control=&quot;server.password&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+            &lt;textbox id=&quot;server.password&quot; flex=&quot;1&quot; type=&quot;password&quot;</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+                     preftype=&quot;wstring&quot; genericattr=&quot;true&quot;/&gt;</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+          &lt;hbox id=&quot;aliasBox&quot; equalsize=&quot;always&quot; align=&quot;baseline&quot;&gt;</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+            &lt;label value=&quot;&amp;account.alias;&quot; control=&quot;server.alias&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+            &lt;textbox id=&quot;server.alias&quot; flex=&quot;1&quot; preftype=&quot;wstring&quot;</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+                     wsm_persist=&quot;true&quot; genericattr=&quot;true&quot;/&gt;</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+          &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+          &lt;vbox id=&quot;autojoinBox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+            &lt;label class=&quot;header&quot; data-l10n-id=&quot;account-channelTitle&quot; /&gt;</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+            &lt;vbox&gt;</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+              &lt;label value=&quot;&amp;account.autojoin;&quot; control=&quot;server.autojoin&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+              &lt;textbox id=&quot;server.autojoin&quot; flex=&quot;1&quot; preftype=&quot;wstring&quot; genericattr=&quot;true&quot;/&gt;</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+            &lt;/vbox&gt;</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+            &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+          &lt;vbox id=&quot;advanced&quot;&gt;</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+            &lt;label class=&quot;header&quot;&gt;&amp;account.advanced;&lt;/label&gt;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+            &lt;caption label=&quot;&amp;account.advanced;&quot;/&gt;</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+            &lt;vbox id=&quot;protoSpecific&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+        &lt;/tabpanel&gt;</span>
<a href="#l20.110"></a><span id="l20.110"> </span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-  &lt;vbox id=&quot;autojoinBox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-    &lt;label value=&quot;&amp;account.autojoin;&quot; control=&quot;server.autojoin&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-    &lt;textbox id=&quot;server.autojoin&quot; flex=&quot;1&quot; preftype=&quot;wstring&quot; genericattr=&quot;true&quot;/&gt;</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-  &lt;/vbox&gt;</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+        &lt;tabpanel orient=&quot;vertical&quot;&gt;</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+          &lt;label class=&quot;header&quot; data-l10n-id=&quot;account-otr-label&quot; /&gt;</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+          &lt;description data-l10n-id=&quot;account-otr-description&quot; /&gt;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+          &lt;separator/&gt;</span>
<a href="#l20.120"></a><span id="l20.120"> </span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-  &lt;groupbox id=&quot;advanced&quot;&gt;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-    &lt;caption label=&quot;&amp;account.advanced;&quot;/&gt;</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-    &lt;vbox id=&quot;protoSpecific&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+          &lt;vbox&gt;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+            &lt;label class=&quot;header&quot; data-l10n-id=&quot;otr-settings-title&quot; /&gt;</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+            &lt;checkbox id=&quot;server.otrRequireEncryption&quot;</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+                      data-l10n-id=&quot;otr-requireEncryption&quot;</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+                      crop=&quot;end&quot;</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+                      oncommand=&quot;account.updateRequireEncryption();&quot;</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+                      wsm_persist=&quot;true&quot;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+                      preftype=&quot;bool&quot;</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+                      genericattr=&quot;true&quot;</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+                      /&gt;</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+            &lt;checkbox id=&quot;server.otrVerifyNudge&quot;</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+                      data-l10n-id=&quot;otr-verifyNudge&quot;</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+                      crop=&quot;end&quot;</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+                      oncommand=&quot;account.updateVerifyNudge();&quot;</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+                      wsm_persist=&quot;true&quot;</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+                      preftype=&quot;bool&quot;</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+                      genericattr=&quot;true&quot;</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+                      /&gt;</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+          &lt;separator/&gt;</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+          &lt;vbox&gt;</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+            &lt;label class=&quot;header&quot; data-l10n-id=&quot;otr-encryption-title&quot; /&gt;</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+            &lt;label data-l10n-id=&quot;otr-encryption-caption&quot; /&gt;</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+            &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+            &lt;hbox align=&quot;baseline&quot;&gt;</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+              &lt;label data-l10n-id=&quot;otr-fingerprint-label&quot; /&gt;</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+              &lt;textbox id=&quot;otrFingerprint&quot;</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+                          readonly=&quot;true&quot;</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+                          flex=&quot;1&quot;/&gt;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+            &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+            &lt;hbox pack=&quot;start&quot;&gt;</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+              &lt;button id=&quot;viewFingerprintButton&quot;</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+                      data-l10n-id=&quot;view-fingerprint-button&quot;</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+                      oncommand=&quot;account.viewFingerprintKeys();&quot;/&gt;</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+            &lt;/hbox&gt;</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+        &lt;/tabpanel&gt;</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+      &lt;/tabpanels&gt;</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+    &lt;/tabbox&gt;</span>
<a href="#l20.166"></a><span id="l20.166">   &lt;/groupbox&gt;</span>
<a href="#l20.167"></a><span id="l20.167"> &lt;/page&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/components/im/imIncomingServer.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/components/im/imIncomingServer.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -160,19 +160,26 @@ imIncomingServer.prototype = {</span>
<a href="#l21.4"></a><span id="l21.4">         &quot;messenger.account.&quot; + this.imAccount.id + &quot;.options.&quot; + aPrefName;</span>
<a href="#l21.5"></a><span id="l21.5">       return Services.prefs.getIntPref(prefName);</span>
<a href="#l21.6"></a><span id="l21.6">     } catch (x) {</span>
<a href="#l21.7"></a><span id="l21.7">       return this._getDefault(aPrefName);</span>
<a href="#l21.8"></a><span id="l21.8">     }</span>
<a href="#l21.9"></a><span id="l21.9">   },</span>
<a href="#l21.10"></a><span id="l21.10">   _defaultOptionValues: null,</span>
<a href="#l21.11"></a><span id="l21.11">   _getDefault(aPrefName) {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+    if (aPrefName == &quot;otrVerifyNudge&quot;) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+      return true;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+    }</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+    if (aPrefName == &quot;otrRequireEncryption&quot;) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+      return false;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+    }</span>
<a href="#l21.18"></a><span id="l21.18">     if (this._defaultOptionValues)</span>
<a href="#l21.19"></a><span id="l21.19">       return this._defaultOptionValues[aPrefName];</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+</span>
<a href="#l21.22"></a><span id="l21.22">     this._defaultOptionValues = {};</span>
<a href="#l21.23"></a><span id="l21.23">     let options = this.imAccount.protocol.getOptions();</span>
<a href="#l21.24"></a><span id="l21.24">     while (options.hasMoreElements()) {</span>
<a href="#l21.25"></a><span id="l21.25">       let opt = options.getNext();</span>
<a href="#l21.26"></a><span id="l21.26">       let type = opt.type;</span>
<a href="#l21.27"></a><span id="l21.27">       if (type == opt.typeBool)</span>
<a href="#l21.28"></a><span id="l21.28">         this._defaultOptionValues[opt.name] = opt.getBool();</span>
<a href="#l21.29"></a><span id="l21.29">       else if (type == opt.typeInt)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/mail/locales/en-US/messenger/preferences/am-im.ftl</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+account-settingsTitle = Authentication Settings</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+account-channelTitle = Default Channels</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -7,16 +7,18 @@</span>
<a href="#l23.4"></a><span id="l23.4"> # having to create the same entry for each locale.</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> #filter substitution</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> [localization] @AB_CD@.jar:</span>
<a href="#l23.9"></a><span id="l23.9">   # When ready for l10n, move chat/content/otr/*.ftl</span>
<a href="#l23.10"></a><span id="l23.10">   #                        to mail/locales/en-US/messenger/otr/</span>
<a href="#l23.11"></a><span id="l23.11">   # and remove the following otr/ lines.</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+  messenger/otr/am-im-otr.ftl                                           (../../chat/content/otr/am-im-otr.ftl)</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  messenger/otr/finger.ftl                                              (../../chat/content/otr/finger.ftl)</span>
<a href="#l23.14"></a><span id="l23.14">   messenger/otr/add-finger.ftl                                          (../../chat/content/otr/add-finger.ftl)</span>
<a href="#l23.15"></a><span id="l23.15">   messenger/otr/auth.ftl                                                (../../chat/content/otr/auth.ftl)</span>
<a href="#l23.16"></a><span id="l23.16">   messenger/otr/chat.ftl                                                (../../chat/content/otr/chat.ftl)</span>
<a href="#l23.17"></a><span id="l23.17">   messenger/otr/generate-key.ftl                                        (../../chat/content/otr/generate-key.ftl)</span>
<a href="#l23.18"></a><span id="l23.18">   messenger/otr/otr.ftl                                                 (../../chat/content/otr/otr.ftl)</span>
<a href="#l23.19"></a><span id="l23.19">   messenger/otr/otrUI.ftl                                               (../../chat/content/otr/otrUI.ftl)</span>
<a href="#l23.20"></a><span id="l23.20">   messenger                                                             (%messenger/**/*.ftl)</span>
<a href="#l23.21"></a><span id="l23.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

