<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28325:cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1" />
<meta property="og:url" content="/comm-central/rev/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1" />
<meta property="og:description" content="Bug 1579020 - Remove WCAP provider. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">shortlog</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">files</a> |
changeset |
<a href="/comm-central/raw-rev/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">raw</a>  | <a href="/comm-central/archive/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1579020">Bug 1579020</a> - Remove WCAP provider. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 05 Dec 2019 11:55:21 +0200</td></tr>

<tr>
 <td>changeset 28325</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1</a></td>
</tr>



<tr>
<td>parent 28324</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/98d3639a346e8049888368e789e56c58f6273153">98d3639a346e8049888368e789e56c58f6273153</a>
</td>
</tr>

<tr>
<td>child 28326</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d68773e96e3e57ea5525ebee96ad97d9f373f76e">d68773e96e3e57ea5525ebee96ad97d9f373f76e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">16771</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 05 Dec 2019 09:56:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@cf982e0a8b1b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1&newProject=comm-central&newRevision=98d3639a346e8049888368e789e56c58f6273153&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1&newProject=comm-central&newRevision=98d3639a346e8049888368e789e56c58f6273153&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1&newProject=comm-central&newRevision=98d3639a346e8049888368e789e56c58f6273153&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1579020">1579020</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1579020">Bug 1579020</a> - Remove WCAP provider. r=darktrojan</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/modules/utils/calDataUtils.jsm">calendar/base/modules/utils/calDataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/modules/utils/calDataUtils.jsm">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/modules/utils/calDataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/modules/utils/calDataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/modules/utils/calDataUtils.jsm">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/modules/utils/calDataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/public/calIErrors.idl">calendar/base/public/calIErrors.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/public/calIErrors.idl">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/public/calIErrors.idl">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/public/calIErrors.idl">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/public/calIErrors.idl">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/base/public/calIErrors.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/calendar.dtd">calendar/locales/en-US/chrome/calendar/calendar.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/calendar.dtd">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/calendar.dtd">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/calendar.dtd">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/calendar.dtd">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/calendar.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/providers/wcap/wcap.properties">calendar/locales/en-US/chrome/calendar/providers/wcap/wcap.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/providers/wcap/wcap.properties">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/providers/wcap/wcap.properties">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/en-US/chrome/calendar/providers/wcap/wcap.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/jar.mn">calendar/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/moz.build">calendar/providers/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/moz.build">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/moz.build">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/moz.build">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/moz.build">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.js">calendar/providers/wcap/calWcapCalendarModule.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.manifest">calendar/providers/wcap/calWcapCalendarModule.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.manifest">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.manifest">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapCalendarModule.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapErrors.js">calendar/providers/wcap/calWcapErrors.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapErrors.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapErrors.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapErrors.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/moz.build">calendar/providers/wcap/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/moz.build">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/moz.build">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapCalendar.idl">calendar/providers/wcap/public/calIWcapCalendar.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapCalendar.idl">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapCalendar.idl">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapCalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapErrors.idl">calendar/providers/wcap/public/calIWcapErrors.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapErrors.idl">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapErrors.idl">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapErrors.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapSession.idl">calendar/providers/wcap/public/calIWcapSession.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapSession.idl">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapSession.idl">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/calIWcapSession.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/moz.build">calendar/providers/wcap/public/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/moz.build">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/moz.build">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/providers/wcap/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/resources/content/calendarCreation.xul">calendar/resources/content/calendarCreation.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/resources/content/calendarCreation.xul">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/resources/content/calendarCreation.xul">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/resources/content/calendarCreation.xul">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/resources/content/calendarCreation.xul">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/resources/content/calendarCreation.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/test/modules/CalendarUtils.jsm">calendar/test/modules/CalendarUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/test/modules/CalendarUtils.jsm">file</a> |
<a href="/comm-central/annotate/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/test/modules/CalendarUtils.jsm">annotate</a> |
<a href="/comm-central/diff/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/test/modules/CalendarUtils.jsm">diff</a> |
<a href="/comm-central/comparison/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/test/modules/CalendarUtils.jsm">comparison</a> |
<a href="/comm-central/log/cf982e0a8b1ba0e45b3f2de6084ed9eb799e74c1/calendar/test/modules/CalendarUtils.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/utils/calDataUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/utils/calDataUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -292,17 +292,17 @@ var caldata = {</span>
<a href="#l1.4"></a><span id="l1.4">    * Use to compare two objects which are not of type calIItemBase, in order</span>
<a href="#l1.5"></a><span id="l1.5">    * to avoid the js-wrapping issues mentioned above.</span>
<a href="#l1.6"></a><span id="l1.6">    *</span>
<a href="#l1.7"></a><span id="l1.7">    * @param aObject        first object to be compared</span>
<a href="#l1.8"></a><span id="l1.8">    * @param aOtherObject   second object to be compared</span>
<a href="#l1.9"></a><span id="l1.9">    * @param aIID           IID to use in comparison, undefined/null defaults to nsISupports</span>
<a href="#l1.10"></a><span id="l1.10">    */</span>
<a href="#l1.11"></a><span id="l1.11">   compareObjects: function(aObject, aOtherObject, aIID) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    // xxx todo: seems to work fine e.g. for WCAP, but I still mistrust this trickery...</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // xxx todo: seems to work fine, but I still mistrust this trickery...</span>
<a href="#l1.14"></a><span id="l1.14">     //           Anybody knows an official API that could be used for this purpose?</span>
<a href="#l1.15"></a><span id="l1.15">     //           For what reason do clients need to pass aIID since</span>
<a href="#l1.16"></a><span id="l1.16">     //           every XPCOM object has to implement nsISupports?</span>
<a href="#l1.17"></a><span id="l1.17">     //           XPCOM (like COM, like UNO, ...) defines that QueryInterface *only* needs to return</span>
<a href="#l1.18"></a><span id="l1.18">     //           the very same pointer for nsISupports during its lifetime.</span>
<a href="#l1.19"></a><span id="l1.19">     if (!aIID) {</span>
<a href="#l1.20"></a><span id="l1.20">       aIID = Ci.nsISupports;</span>
<a href="#l1.21"></a><span id="l1.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/public/calIErrors.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/public/calIErrors.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -92,21 +92,21 @@ interface calIErrors : nsISupports</span>
<a href="#l2.4"></a><span id="l2.4">   const unsigned long ICS_PARSE = ICS_ERROR_BASE + 5;</span>
<a href="#l2.5"></a><span id="l2.5">   const unsigned long ICS_INTERNAL = ICS_ERROR_BASE + 6;</span>
<a href="#l2.6"></a><span id="l2.6">   const unsigned long ICS_FILE = ICS_ERROR_BASE + 7;</span>
<a href="#l2.7"></a><span id="l2.7">   const unsigned long ICS_USAGE = ICS_ERROR_BASE + 8;</span>
<a href="#l2.8"></a><span id="l2.8">   const unsigned long ICS_UNIMPLEMENTED = ICS_ERROR_BASE + 9;</span>
<a href="#l2.9"></a><span id="l2.9">   const unsigned long ICS_UNKNOWN = ICS_ERROR_BASE + 10;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   /**</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-   * WCAP specific errors, defined in</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-   * calendar/providers/wcap/public/calIWcapErrors.idl</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-   * Range claimed is [ERROR_BASE + 0x200, ERROR_BASE + 0x300)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+   * Range for former WCAP provider. This could be re-used now in theory, but</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+   * you might as well just add to the end.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+   * Range previously claimed is [ERROR_BASE + 0x200, ERROR_BASE + 0x300)</span>
<a href="#l2.18"></a><span id="l2.18">    */</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  const unsigned long WCAP_ERROR_BASE = ERROR_BASE + 0x200;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  const unsigned long EX_WCAP_ERROR_BASE = ERROR_BASE + 0x200;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   /**</span>
<a href="#l2.23"></a><span id="l2.23">    * (Cal)DAV specific errors</span>
<a href="#l2.24"></a><span id="l2.24">    * Range is [ERROR_BASE + 0x301, ERROR_BASE + 0x399]</span>
<a href="#l2.25"></a><span id="l2.25">    */</span>
<a href="#l2.26"></a><span id="l2.26">   const unsigned long DAV_ERROR_BASE = ERROR_BASE + 0x301;</span>
<a href="#l2.27"></a><span id="l2.27">   const unsigned long DAV_NOT_DAV = DAV_ERROR_BASE +  0;</span>
<a href="#l2.28"></a><span id="l2.28">   const unsigned long DAV_DAV_NOT_CALDAV = DAV_ERROR_BASE + 1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/calendar.dtd</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/calendar/calendar.dtd</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -348,17 +348,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> &lt;!-- Calendar Server Dialog --&gt;</span>
<a href="#l3.5"></a><span id="l3.5"> &lt;!ENTITY calendar.server.dialog.title.edit          &quot;Edit Calendar&quot;&gt;</span>
<a href="#l3.6"></a><span id="l3.6"> &lt;!ENTITY calendar.server.dialog.name.label          &quot;Calendar Name:&quot;&gt;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> &lt;!-- Calendar Properties --&gt;</span>
<a href="#l3.9"></a><span id="l3.9"> &lt;!ENTITY calendarproperties.color.label                    &quot;Color:&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> &lt;!ENTITY calendarproperties.webdav.label                   &quot;iCalendar (ICS)&quot;&gt;</span>
<a href="#l3.11"></a><span id="l3.11"> &lt;!ENTITY calendarproperties.caldav.label                   &quot;CalDAV&quot;&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-&lt;!ENTITY calendarproperties.wcap.label                     &quot;Sun Java System Calendar Server (WCAP)&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13"> &lt;!ENTITY calendarproperties.format.label                   &quot;Format:&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14"> &lt;!ENTITY calendarproperties.location.label                 &quot;Location:&quot;&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> &lt;!ENTITY calendarproperties.refreshInterval.label          &quot;Refresh Calendar:&quot;&gt;</span>
<a href="#l3.16"></a><span id="l3.16"> &lt;!ENTITY calendarproperties.refreshInterval.manual.label   &quot;Manually&quot;&gt;</span>
<a href="#l3.17"></a><span id="l3.17"> &lt;!ENTITY calendarproperties.name.label                     &quot;Name:&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18"> &lt;!ENTITY calendarproperties.readonly.label                 &quot;Read Only&quot;&gt;</span>
<a href="#l3.19"></a><span id="l3.19"> &lt;!ENTITY calendarproperties.firealarms.label               &quot;Show Reminders&quot;&gt;</span>
<a href="#l3.20"></a><span id="l3.20"> &lt;!ENTITY calendarproperties.cache3.label                   &quot;Offline Support&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/providers/wcap/wcap.properties</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,23 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-# args: host</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-accessingServerFailedError.text=Cannot access server %1$S!</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-loginFailed.text=Login failed or invalid session Id.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-accessDenied.text=The user is denied access.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-# args: host</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-noHttpsConfirmation.text=Insecure login on %1$S!\nContinue?</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-noHttpsConfirmation.check.text=Don't ask again.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-noHttpsConfirmation.label=Warning!</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-# args: host, prodId, serverVersion, wcapVersion</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-insufficientWcapVersionConfirmation.text=Server %1$S (%2$S, v%3$S, WCAP v%4$S) doesn't support a sufficient WCAP version! The required version is at least 3.0.0.\nContinue?</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-insufficientWcapVersionConfirmation.label=Insufficient WCAP version!</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-loginDialog.label=Calendar Server Password Required</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-privateItem.title.text=Private</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-confidentialItem.title.text=Confidential</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-busyItem.title.text=Busy</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/locales/jar.mn</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/locales/jar.mn</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -27,16 +27,15 @@ calendar-@AB_CD@.jar:</span>
<a href="#l5.4"></a><span id="l5.4">     migration.dtd                                (%chrome/calendar/migration.dtd)</span>
<a href="#l5.5"></a><span id="l5.5">     migration.properties                         (%chrome/calendar/migration.properties)</span>
<a href="#l5.6"></a><span id="l5.6">     preferences/alarms.dtd                       (%chrome/calendar/preferences/alarms.dtd)</span>
<a href="#l5.7"></a><span id="l5.7">     preferences/categories.dtd                   (%chrome/calendar/preferences/categories.dtd)</span>
<a href="#l5.8"></a><span id="l5.8">     preferences/general.dtd                      (%chrome/calendar/preferences/general.dtd)</span>
<a href="#l5.9"></a><span id="l5.9">     preferences/preferences.dtd                  (%chrome/calendar/preferences/preferences.dtd)</span>
<a href="#l5.10"></a><span id="l5.10">     preferences/views.dtd                        (%chrome/calendar/preferences/views.dtd)</span>
<a href="#l5.11"></a><span id="l5.11">     provider-uninstall.dtd                       (%chrome/calendar/provider-uninstall.dtd)</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    wcap.properties                              (%chrome/calendar/providers/wcap/wcap.properties)</span>
<a href="#l5.13"></a><span id="l5.13">     timezones.properties                         (%chrome/calendar/timezones.properties)</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> lightning-@AB_CD@.jar:</span>
<a href="#l5.16"></a><span id="l5.16"> % locale lightning @AB_CD@ %</span>
<a href="#l5.17"></a><span id="l5.17">     lightning-toolbar.dtd                        (%chrome/lightning/lightning-toolbar.dtd)</span>
<a href="#l5.18"></a><span id="l5.18">     lightning.dtd                                (%chrome/lightning/lightning.dtd)</span>
<a href="#l5.19"></a><span id="l5.19">     lightning.properties                         (%chrome/lightning/lightning.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/moz.build</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/moz.build</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,11 +4,9 @@</span>
<a href="#l6.4"></a><span id="l6.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> DIRS += [</span>
<a href="#l6.7"></a><span id="l6.7">     'caldav',</span>
<a href="#l6.8"></a><span id="l6.8">     'composite',</span>
<a href="#l6.9"></a><span id="l6.9">     'ics',</span>
<a href="#l6.10"></a><span id="l6.10">     'memory',</span>
<a href="#l6.11"></a><span id="l6.11">     'storage',</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    'wcap',</span>
<a href="#l6.13"></a><span id="l6.13"> ]</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,387 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-/* import-globals-from calWcapCalendarModule.js */</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-/**</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">- * The calendar provider class for WCAP calendars. Usually instantiated through</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">- * the calendar manager, but may also be created by the wcap session, hence the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">- * following optional parameters.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">- *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">- * @param session       (optional) The calWcapSession for this calendar</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">- * @param calProps      (optional) The XML node containing the WCAP calendar properties</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">- */</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-function calWcapCalendar(session, calProps) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  this.initProviderBase();</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  this.m_session = session;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  this.m_calProps = calProps;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-}</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-var calWcapCalendarClassID = Components.ID(&quot;{cf4d93e5-af79-451a-95f3-109055b32ef0}&quot;);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-var calWcapCalendarInterfaces = [</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  calIWcapCalendar,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-  calICalendar,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  Ci.calISchedulingSupport,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  Ci.calIChangeLog,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  Ci.calICalendarProvider,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-];</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-calWcapCalendar.prototype = {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  classID: calWcapCalendarClassID,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  QueryInterface: cal.generateQI(calWcapCalendarInterfaces),</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  classInfo: cal.generateCI({</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-    classID: calWcapCalendarClassID,</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-    classDescription: &quot;Sun Java System Calendar Server WCAP Provider&quot;,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-    interfaces: calWcapCalendarInterfaces,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  }),</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  toString: function() {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-    let str = this.session.toString();</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    if (this.m_calId) {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-      str += &quot;, calId=&quot; + this.calId;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    } else {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-      str += &quot;, default calendar&quot;;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-    }</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    return str;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  },</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  notifyError_: function(err, msg, context) {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    let rc = getResultCode(err);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    switch (rc) {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-      case calIWcapErrors.WCAP_COMPONENT_NOT_FOUND:</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-      case NS_ERROR_OFFLINE:</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-        return;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-      default:</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-        msg = errorToString(err);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-        log(&quot;error: &quot; + msg, context);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-        break;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-    }</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    this.__proto__.__proto__.notifyError.apply(</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-      this,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-      err instanceof Ci.nsIException</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        ? [err.result, err.message]</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-        : [isNaN(err) ? Cr.NS_ERROR_FAILURE : err, msg]</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    );</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  },</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  notifyError: function(err, msg) {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    this.notifyError_(err, msg, this);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  },</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-  // calICalendarProvider:</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  get prefChromeOverlay() {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    return null;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  },</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  // displayName attribute already part of calIWcapCalendar</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  createCalendar: function(name, url, listener) {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  },</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  deleteCalendar: function(calendar, listener) {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  },</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  getCalendar: function(url) {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  },</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-  // calICalendar:</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-  get name() {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    let name = this.getProperty(&quot;name&quot;);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    if (!name) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-      name = this.displayName;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-    }</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-    return name;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-  },</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-  set name(aValue) {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-    return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-  },</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-  get type() {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-    return &quot;wcap&quot;;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-  },</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  m_uri: null,</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  get uri() {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-    return this.m_uri;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-  },</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-  set uri(thatUri) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-    this.m_uri = thatUri;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    let path = thatUri.pathQueryRef;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-    let qmPos = path.indexOf(&quot;?&quot;);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-    if (qmPos != -1) {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-      let pos = path.indexOf(&quot;?calid=&quot;, qmPos);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-      if (pos != -1) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-        let start = pos + &quot;?calid=&quot;.length;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-        let end = path.indexOf(&quot;&amp;&quot;, start);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-        this.m_calId = decodeURIComponent(path.substring(start, end == -1 ? path.length : end));</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-      }</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-    }</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-    return this.uri;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-  },</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-    switch (aName) {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-      case &quot;cache.supported&quot;:</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-        return true;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-      case &quot;timezones.provider&quot;:</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-        return this.m_session &amp;&amp; this.session.isLoggedIn ? this.session : null;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      case &quot;organizerId&quot;:</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-        return this.ownerId;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-      case &quot;organizerCN&quot;:</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-        return this.getCalendarProperties(&quot;X-S1CS-CALPROPS-COMMON-NAME&quot;);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-      case &quot;itip.disableRevisionChecks&quot;:</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-        return true;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-      case &quot;capabilities.timezones.floating.supported&quot;:</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-      case &quot;capabilities.timezones.UTC.supported&quot;:</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-      case &quot;capabilities.attachments.supported&quot;:</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-      case &quot;capabilities.alarms.popup.supported&quot;:</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-        // CS cannot store X-props reliably</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-        // (thus writing X-MOZ stamps etc is not possible).</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-        // Popup alarms not available no matter what; wtf.</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-        return false;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-      case &quot;capabilities.alarms.actionValues&quot;:</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-        return [&quot;EMAIL&quot;];</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-      case &quot;capabilities.alarms.maxCount&quot;:</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-        return 1;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    }</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-    let value = this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    switch (aName) {</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-      case &quot;readOnly&quot;:</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-        if (value === null) {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-          // tweak readOnly default to true for non-owned calendars,</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-          // all secondary calendars to readOnly unless we're logged in</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-          value =</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-            this.m_session &amp;&amp; this.session.isLoggedIn</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-              ? !this.isOwnedCalendar</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-              : !this.isDefaultCalendar;</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-        }</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-        break;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-      case &quot;calendar-main-in-composite&quot;:</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-        if (value === null &amp;&amp; !this.isDefaultCalendar) {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-          // tweak in-composite to false for secondary calendars:</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-          value = false;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-        }</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-        break;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-    }</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    return value;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  },</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  setProperty: function(aName, aValue) {</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-    switch (aName) {</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-      case &quot;disabled&quot;:</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-        if (this.isDefaultCalendar) {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-          // disabling/enabling the default calendar will enable/disable all calendars</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-          // belonging to the same session:</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-          for (let calendar of this.session.getRegisteredCalendars()) {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-            if (!calendar.isDefaultCalendar) {</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-              calendar.setProperty(&quot;disabled&quot;, aValue);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-            }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-          }</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-        }</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-      // falls through</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-      default:</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-        this.__proto__.__proto__.setProperty.apply(this, arguments);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-        break;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-    }</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-  },</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-  notifyObservers: function(func, args) {</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    if (g_bShutdown) {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-      return;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    }</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-    this.observers.notify(func, args);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-  },</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-  // xxx todo: batch currently not used</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-  startBatch: function() {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-    this.notifyObservers(&quot;onStartBatch&quot;);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-  },</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-  endBatch: function() {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-    this.notifyObservers(&quot;onEndBatch&quot;);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-  },</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-  get canRefresh() {</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    return true;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-  },</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-  refresh: function() {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    log(&quot;refresh.&quot;, this);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-    // invalidate cached results:</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    delete this.m_cachedResults;</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-    // notify about refreshed calendar:</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    this.notifyObservers(&quot;onLoad&quot;, [this]);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-  },</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-  issueNetworkRequest: function(</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-    request,</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-    respFunc,</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-    dataConvFunc,</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-    wcapCommand,</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-    params,</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-    accessRights</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-  ) {</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-    let self = this;</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-    // - bootstrap problem: no cal_props, no access check, no default calId</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-    // - assure being logged in, thus the default cal_props are available</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-    // - every subscribed calendar will come along with cal_props</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-    return this.session.getSessionId(request, (err, sessionId) =&gt; {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-      try {</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-        if (err) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-          throw err;</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-        }</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-        self.assureAccess(accessRights);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-        params += &quot;&amp;calid=&quot; + encodeURIComponent(self.calId);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-        self.session.issueNetworkRequest(request, respFunc, dataConvFunc, wcapCommand, params);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-      } catch (exc) {</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-        request.execSubRespFunc(respFunc, exc);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-      }</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-    });</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-  },</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  // calIWcapCalendar:</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-  m_session: null,</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-  get session() {</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    if (!this.m_session) {</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-      this.m_session = getWcapSessionFor(this);</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-    }</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-    return this.m_session;</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-  },</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-  m_calId: null,</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-  get calId() {</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-    return this.m_calId || this.session.defaultCalId;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-  },</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-  get ownerId() {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-    let owner = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-PRIMARY-OWNER&quot;);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-    if (owner.length == 0) {</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-      let calId = this.calId;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-      log(&quot;cannot determine primary owner of calendar &quot; + calId, this);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-      // fallback to calId prefix:</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-      let nColon = calId.indexOf(&quot;:&quot;);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-      if (nColon &gt;= 0) {</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-        calId = calId.substring(0, nColon);</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-      }</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-      return calId;</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-    }</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-    return owner[0];</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-  },</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-  get description() {</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-    let descr = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-DESCRIPTION&quot;);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-    if (descr.length == 0) {</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-      // fallback to display name:</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-      return this.displayName;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-    }</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-    return descr[0];</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-  },</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">-  get displayName() {</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-    let displayName = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-NAME&quot;);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-    if (displayName.length == 0) {</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-      // fallback to common name:</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-      displayName = this.getCalendarProperties(&quot;X-S1CS-CALPROPS-COMMON-NAME&quot;);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-      if (displayName.length == 0) {</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-        displayName = [this.calId];</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-      }</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-    }</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-    return displayName[0];</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-  },</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-  get isOwnedCalendar() {</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    if (this.isDefaultCalendar) {</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-      return true; // default calendar is owned</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-    }</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-    return this.ownerId == this.session.userId;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-  },</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-  get isDefaultCalendar() {</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-    return !this.m_calId;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-  },</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-  m_calProps: null,</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-  getCalendarProperties: function(propName) {</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-    if (!this.m_calProps) {</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-      log(&quot;soft error: no calprops available, most possibly not logged in.&quot;, this);</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-    }</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-    let ret = filterXmlNodes(propName, this.m_calProps);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    return ret;</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-  },</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-  get defaultTimezone() {</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-    let tzid = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-TZID&quot;);</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-    if (tzid.length &gt; 0) {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-      // first try server-configured tz:</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-      return tzid[0];</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-    } else {</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-      logWarning(&quot;defaultTimezone: cannot get X-NSCP-CALPROPS-TZID!&quot;, this);</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-      // try to use local one if supported:</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-      tzid = cal.getTimezoneService().defaultTimezone.tzid;</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-      return this.session.getTimezone(tzid) ? tzid : &quot;UTC&quot;;</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-    }</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-  },</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-  getAlignedTzid: function(timezone) {</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-    let tzid = timezone.tzid;</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-    // check whether it is one cs supports:</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-    if (timezone.isFloating || !this.session.getTimezone(tzid)) {</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-      log(&quot;not a supported timezone: &quot; + tzid);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-      // bug 435436:</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-      // xxx todo: we could further on search for a matching region,</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-      //           e.g. CET (in TZNAME), but for now stick to</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-      //           user's default if not supported directly</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-      let ret = this.defaultTimezone;</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-      // use calendar's default:</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-      log(tzid + &quot; not supported, falling back to default: &quot; + ret, this);</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-      return ret;</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-    }</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-    return tzid;</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-  },</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-  checkAccess: function(accessControlBits) {</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-    // xxx todo: take real acl into account</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-    // for now, optimistically assuming that everybody has full access, server will check:</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-    let granted = calIWcapCalendar.AC_FULL;</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-    if (this.getProperty(&quot;readOnly&quot;)) {</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-      granted &amp;= ~(calIWcapCalendar.AC_COMP_WRITE | calIWcapCalendar.AC_PROP_WRITE);</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-    }</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-    // check whether every bit fits:</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-    return (accessControlBits &amp; granted) == accessControlBits;</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-  },</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-  assureAccess: function(accessControlBits) {</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-    if (</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-      !this.checkAccess(</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-        accessControlBits &amp; (calIWcapCalendar.AC_COMP_WRITE | calIWcapCalendar.AC_PROP_WRITE)</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-      )</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-    ) {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-      // throw different error code for read-only:</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-      throw new Components.Exception(</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-        errorToString(calIErrors.CAL_IS_READONLY),</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-        calIErrors.CAL_IS_READONLY</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-      );</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-    }</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    if (!this.checkAccess(accessControlBits)) {</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-      throw new Components.Exception(</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-        errorToString(calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR),</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-        calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-      );</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-      // xxx todo: throwing different error here, no</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-      //           calIErrors.CAL_IS_READONLY anymore</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-    }</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-  },</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-  defineAccessControl: function(userId, accessControlBits) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-  },</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  resetAccessControl: function(userId) {</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-  },</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-  getAccessControlDefinitions: function(out_count, out_users, out_accessControlBits) {</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-  },</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,1559 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-/* import-globals-from calWcapCalendarModule.js */</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-calWcapCalendar.prototype.encodeAttendee = function(att) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    log(&quot;attendee.icalProperty.icalString=&quot; + att.icalProperty.icalString, this);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  }</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  function encodeAttr(val, attr, params) {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-    if (val &amp;&amp; val.length &gt; 0) {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-      if (params.length &gt; 0) {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-        params += &quot;^&quot;;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-      }</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-      if (attr) {</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-        params += attr + &quot;=&quot;;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-      }</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-      params += encodeURIComponent(val);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-    }</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    return params;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-  }</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  let params = encodeAttr(att.rsvp, &quot;RSVP&quot;, &quot;&quot;);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  params = encodeAttr(att.participationStatus, &quot;PARTSTAT&quot;, params);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  params = encodeAttr(att.role, &quot;ROLE&quot;, params);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  let commonName = att.commonName;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  if (commonName) {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-    params = encodeAttr(commonName.replace(/[;:]/g, &quot; &quot;), &quot;CN&quot;, params); // remove ';' and ':' from CN</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  }</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  return encodeAttr(att.id, null, params);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-};</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-calWcapCalendar.prototype.getRecurrenceParams = function(</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  item,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  out_rrules,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  out_rdates,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  out_exrules,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  out_exdates</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  // recurrences:</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  out_rrules.value = [];</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  out_rdates.value = [];</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  out_exrules.value = [];</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  out_exdates.value = [];</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  if (item.recurrenceInfo) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    let rItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    for (let rItem of rItems) {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-      let isNeg = rItem.isNegative;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-      let rRuleInstance = cal.wrapInstance(rItem, Ci.calIRecurrenceRule);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-      let rDateInstance = cal.wrapInstance(rItem, Ci.calIRecurrenceDate);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-      if (rRuleInstance) {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-        let rule = '&quot;' + encodeURIComponent(rRuleInstance.icalProperty.valueAsIcalString) + '&quot;';</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-        if (isNeg) {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-          out_exrules.value.push(rule);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-        } else {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-          out_rrules.value.push(rule);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-        }</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-      } else if (rDateInstance) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-        // cs does not accept DATEs here:</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-        if (isNeg) {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-          out_exdates.value.push(getIcalUTC(cal.dtz.ensureDateTime(rDateInstance.date)));</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-        } else {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-          out_rdates.value.push(getIcalUTC(cal.dtz.ensureDateTime(rDateInstance.date)));</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-        }</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-      } else {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-        this.notifyError(</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-          NS_ERROR_UNEXPECTED,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-          &quot;don't know how to handle this recurrence item: &quot; + rItem.valueAsIcalString</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-        );</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-      }</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    }</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  }</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-};</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-function sameStringSet(list, list_) {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  return list.length == list_.length &amp;&amp; list.every(x =&gt; list_.some(y =&gt; x == y));</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-}</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-calWcapCalendar.prototype.encodeRecurrenceParams = function(item, oldItem, excludeExdates) {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  let rrules = {};</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  let rdates = {};</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  let exrules = {};</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  let exdates = {};</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-  this.getRecurrenceParams(item, rrules, rdates, exrules, exdates);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-  if (oldItem) {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-    // actually only write changes if an old item has been changed, because</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    // cs recreates the whole series if a rule has changed.</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    // xxx todo: one problem is left when a master only holds EXDATEs,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-    //           and effectively no item is present anymore.</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-    //           cs seems not to clean up automatically, but it does when</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-    //           when deleting an occurrence {id, rec-id}!</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-    //           So this still leaves the question open why deleteOccurrence</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-    //           does not directly call deleteItem rather than modifyItem,</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-    //           which leads to a much cleaner usage.</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-    //           I assume this mimic has been chosen for easier undo/redo</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-    //           support (Undo would then have to distinguish whether</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-    //           it has previously deleted an occurrence or ordinary item:</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-    //            - entering an exception again</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-    //            - or adding an item)</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    //           Currently it can just modifyItem(newItem/oldItem) back.</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-    let rrules_ = {};</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-    let rdates_ = {};</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-    let exrules_ = {};</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-    let exdates_ = {};</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-    this.getRecurrenceParams(oldItem, rrules_, rdates_, exrules_, exdates_);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-    if (sameStringSet(rrules.value, rrules_.value)) {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-      rrules.value = null; // don't write</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-    }</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    if (sameStringSet(rdates.value, rdates_.value)) {</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-      rdates.value = null; // don't write</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    }</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-    if (sameStringSet(exrules.value, exrules.value)) {</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-      exrules.value = null; // don't write</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-    }</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-    if (excludeExdates || sameStringSet(exdates.value, exdates_.value)) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-      exdates.value = null; // don't write</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    }</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-  }</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-  let ret = &quot;&quot;;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  if (rrules.value) {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-    ret += &quot;&amp;rrules=&quot; + rrules.value.join(&quot;;&quot;);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  }</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-  if (rdates.value) {</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-    ret += &quot;&amp;rdates=&quot; + rdates.value.join(&quot;;&quot;);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-  }</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-  if (exrules.value) {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-    ret += &quot;&amp;exrules=&quot; + exrules.value.join(&quot;;&quot;);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-  }</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-  if (!excludeExdates &amp;&amp; exdates.value) {</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-    ret += &quot;&amp;exdates=&quot; + exdates.value.join(&quot;;&quot;);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-  }</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-  return ret;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-  // xxx todo:</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-  // rchange=1: expand recurrences,</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-  // or whether to replace the rrule, ambiguous documentation!!!</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-  // check with store(with no uid) upon adoptItem() which behaves strange</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-  // if rchange=0 is set!</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-};</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-calWcapCalendar.prototype.getAlarmParams = function(item) {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-  let params = null;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-  // xxx TODO ALARMSUPPORT check if WCAP supports multiple alarms</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-  let alarms = item.getAlarms().filter(x =&gt; x.action == &quot;EMAIL&quot;);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-  let alarm = alarms.length &gt; 0 &amp;&amp; alarms[0];</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-  if (alarm) {</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-    let alarmStart = cal.alarms.calculateAlarmOffset(item, alarm);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-      // cs does not support explicit RELATED=END when</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-      // both start|entry and end|due are written</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-      let dur = item.duration;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-      if (dur) {</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-        // both given</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-        alarmStart = alarmStart.clone();</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-        alarmStart.addDuration(dur);</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-      } // else only end|due is set, alarm makes little sense though</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-    }</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    let emails = &quot;&quot;;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    if (item.hasProperty(&quot;alarmEmailAddress&quot;)) {</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-      emails = encodeURIComponent(item.getProperty(&quot;alarmEmailAddress&quot;));</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-    } else {</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-      emails = this.session</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-        .getDefaultAlarmEmails({})</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-        .map(encodeURIComponent)</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-        .join(&quot;;&quot;);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-    }</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-    if (emails.length &gt; 0) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-      params = &quot;&amp;alarmStart=&quot; + alarmStart.icalString;</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-      params += &quot;&amp;alarmEmails=&quot; + emails;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-    }</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-    // else popup</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-  }</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-  if (!params) {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-    // clear popup, email alarm:</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-    params = &quot;&amp;alarmStart=&amp;alarmPopup=&amp;alarmEmails=&quot;;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-  }</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-  return params;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-};</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-// why ever, X-S1CS-EMAIL is unsupported though documented</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-// for get_calprops... WTF.</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-function getCalId(att) {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-  return att ? att.getProperty(&quot;X-S1CS-CALID&quot;) : null;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-}</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-function getAttendeeByCalId(atts, calId) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-  for (let att of atts) {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-    if (getCalId(att) == calId) {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-      return att;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-    }</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-  }</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-  return null;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-}</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-calWcapCalendar.prototype.isInvitation = function(item) {</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-  if (!this.session.isLoggedIn) {</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-    return false; // don't know</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-  }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-  let calId = this.calId;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-  let orgCalId = getCalId(item.organizer);</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-  if (!orgCalId || orgCalId == calId) {</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-    return false;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-  }</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-  return this.getInvitedAttendee(item) != null;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-};</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-calWcapCalendar.prototype.getInvitedAttendee = function(item) {</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-  let att = getAttendeeByCalId(item.getAttendees(), this.calId);</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-  if (!att) {</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-    // try to find mail address</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-    let prefMail = this.session.getUserPreferences(&quot;X-NSCP-WCAP-PREF-mail&quot;);</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-    if (prefMail.length &gt; 0 &amp;&amp; prefMail[0].length &gt; 0) {</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-      att = item.getAttendeeById(&quot;mailto:&quot; + prefMail[0]);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-    }</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-  }</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-  return att;</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-};</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-calWcapCalendar.prototype.canNotify = function(method, item) {</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-  if (!this.session.isLoggedIn) {</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-    return false;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-  }</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-  let calId = this.calId;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-  switch (method) {</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-    case &quot;REQUEST&quot;:</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-    case &quot;CANCEL&quot;:</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-      // when creating new items, mind that organizer's id</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-      return (</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-        !item.organizer || // might yet not be set</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-        item.organizer.id == calId || // or is set to raw calId</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-        getCalId(item.organizer) == calId</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-      );</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-    case &quot;REPLY&quot;: // only if we we're invited from cs, and find matching X-S1CS-CALID:</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-      return getAttendeeByCalId(item.getAttendees(), calId) != null;</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-    default:</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-      return false;</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-  }</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-};</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-function equalDatetimes(one, two) {</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-  return (!one &amp;&amp; !two) || (one &amp;&amp; two &amp;&amp; one.isDate == two.isDate &amp;&amp; one.compare(two) == 0);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-}</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-function identicalDatetimes(one, two) {</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-  return (</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-    (!one &amp;&amp; !two) ||</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-    (equalDatetimes(one, two) &amp;&amp; cal.data.compareObjects(one.timezone, two.timezone))</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-  );</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-}</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-// @return null if nothing has changed else value to be written</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-function diffProperty(newItem, oldItem, propName) {</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-  let val = newItem.getProperty(propName);</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-  let oldVal = oldItem ? oldItem.getProperty(propName) : null;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-  if (val === null) {</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-    // force being set when - no old item, eg when adding new item</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-    //                      - property is to be deleted</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-    if (!oldItem || oldVal) {</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-      val = &quot;&quot;;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-    }</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-  } else {</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-    val = val.replace(/(\r\n)|\n/g, &quot;\r\n&quot;);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-    if (oldVal) {</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-      oldVal = oldVal.replace(/(\r\n)|\n/g, &quot;\r\n&quot;);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-    }</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-    if (val == oldVal) {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-      val = null;</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-    }</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-  }</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-  return val;</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-}</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-/* eslint-disable no-unused-vars */</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-var METHOD_PUBLISH = 1;</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-var METHOD_REQUEST = 2;</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-var METHOD_REPLY = 4;</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-var METHOD_CANCEL = 8;</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-var METHOD_UPDATE = 256;</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-/* eslint-enable no-unused-vars */</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-calWcapCalendar.prototype.storeItem = function(bAddItem, item, oldItem, request) {</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-  function getOrgId(orgItem) {</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-    return orgItem &amp;&amp; orgItem.organizer &amp;&amp; orgItem.organizer.id ? orgItem.organizer.id : null;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-  }</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-  function encodeCategories(cats) {</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-    cats = cats.concat([]);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-    cats.sort();</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-    return cats.join(&quot;;&quot;);</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-  }</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-  function getPrivacy(pitem) {</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-    return pitem.privacy &amp;&amp; pitem.privacy != &quot;&quot; ? pitem.privacy : &quot;PUBLIC&quot;;</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-  }</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-  let encodeAttendees = atts =&gt; {</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-    function attendeeSort(one, two) {</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-      one = one.id;</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-      two = two.id;</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-      if (one == two) {</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-        return 0;</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-      }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-      return one &lt; two ? -1 : 1;</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-    }</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-    atts = atts.concat([]);</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-    atts.sort(attendeeSort);</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-    return atts.map(this.encodeAttendee, this).join(&quot;;&quot;);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-  };</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-  let getAttachments = attitem =&gt; {</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-    let ret;</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-    let attachments = attitem.attachments;</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-    if (attachments) {</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-      let strings = [];</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-      for (let att of attachments) {</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-        let wrappedAtt = cal.wrapInstance(att, Ci.calIAttachment);</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-        if (typeof att == &quot;string&quot;) {</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-          strings.push(encodeURIComponent(att));</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-        } else if (wrappedAtt &amp;&amp; wrappedAtt.uri) {</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-          strings.push(encodeURIComponent(wrappedAtt.uri.spec));</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-        } else {</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-          // xxx todo</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-          logError(&quot;only URLs supported as attachment, not: &quot; + att, this);</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-        }</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-      }</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-      strings.sort();</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-      ret = strings.join(&quot;;&quot;);</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-    }</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-    return ret || &quot;&quot;;</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-  };</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-  let bIsEvent = cal.item.isEvent(item);</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-  let bIsParent = isParent(item);</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-  let method = METHOD_PUBLISH;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-  let bNoSmtpNotify = false;</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-  let params = &quot;&quot;;</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-  let calId = this.calId;</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-  if (!bAddItem &amp;&amp; this.isInvitation(item)) {</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-    // REPLY</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-    method = METHOD_REPLY;</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-    let att = getAttendeeByCalId(item.getAttendees(), calId);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-    if (att) {</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-      log(&quot;attendee: &quot; + att.icalProperty.icalString, this);</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-      let oldAtt = null;</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-      if (oldItem) {</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-        oldAtt = getAttendeeByCalId(oldItem.getAttendees(), calId);</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-      }</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-      if (!oldAtt || att.participationStatus != oldAtt.participationStatus) {</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-        // REPLY first for just this calendar:</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-        params +=</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-          &quot;&amp;attendees=PARTSTAT=&quot; + att.participationStatus + &quot;^&quot; + encodeURIComponent(att.id);</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-      }</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-    }</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-  } else {</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-    // PUBLISH, REQUEST</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-    // workarounds for server bugs concerning recurrences/exceptions:</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-    // - if first occurrence is an exception</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-    //   and an EXDATE for that occurrence ought to be written,</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-    //   then the master item's data is replaced with that EXDATEd exception. WTF.</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-    // - if start/end date is being written on master, the previously EXDATEd</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-    //   exception overwrites master, why ever.</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    // So in these cases: write all data of master.</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-    let bIsAllDay = false;</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-    let dtstart, dtend;</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-    if (bIsEvent) {</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-      dtstart = item.startDate;</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-      dtend = item.endDate;</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-      bIsAllDay = dtstart.isDate &amp;&amp; dtend.isDate;</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-      if (</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-        !oldItem ||</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-        !identicalDatetimes(dtstart, oldItem.startDate) ||</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-        !identicalDatetimes(dtend, oldItem.endDate)</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-      ) {</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-        params += &quot;&amp;dtstart=&quot; + getIcalUTC(dtstart); // timezone will be set with tzid param</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-        params += &quot;&amp;dtend=&quot; + getIcalUTC(dtend);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-        params += bIsAllDay ? &quot;&amp;isAllDay=1&quot; : &quot;&amp;isAllDay=0&quot;;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-        if (bIsParent &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-          oldItem = null; // recurrence/exceptions hack: write whole master</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-        }</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-      }</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-    } else {</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-      // calITodo</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-      // xxx todo: dtstart is mandatory for cs, so if this is</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-      //           undefined, assume an allDay todo???</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-      dtstart = item.entryDate;</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-      dtend = item.dueDate;</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-      // cs bug: enforce DUE (set to DTSTART) if alarm is set</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-      if (!dtend &amp;&amp; item.getAlarms().length) {</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-        dtend = dtstart;</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-      }</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-      bIsAllDay = dtstart &amp;&amp; dtstart.isDate;</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-      if (</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-        !oldItem ||</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-        !identicalDatetimes(dtstart, oldItem.entryDate) ||</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-        !identicalDatetimes(dtend, oldItem.dueDate)</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-      ) {</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-        params += &quot;&amp;dtstart=&quot; + getIcalUTC(dtstart); // timezone will be set with tzid param</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-        params += &quot;&amp;due=&quot; + getIcalUTC(dtend); // timezone will be set with tzid param</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-        params += bIsAllDay ? &quot;&amp;isAllDay=1&quot; : &quot;&amp;isAllDay=0&quot;;</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-        if (bIsParent &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-          oldItem = null; // recurrence/exceptions hack: write whole master</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-        }</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">-      }</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-    }</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-    if (bIsParent) {</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-      let recParams = this.encodeRecurrenceParams(item, oldItem, !bAddItem /* exclude EXDATEs */);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-      if (recParams.length &gt; 0) {</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-        oldItem = null; // recurrence/exceptions hack: write whole master</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-        params += recParams;</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-      }</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-    }</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-    let orgCalId = getCalId(item.organizer);</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-    if (!orgCalId) {</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-      // new events yet don't have X-S1CS-CALID set on ORGANIZER or this is outbound iTIP</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-      let orgId = getOrgId(item);</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-      if (!orgId || orgId.toLowerCase().replace(/^mailto:/, &quot;&quot;) == this.ownerId.toLowerCase()) {</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-        orgCalId = calId; // own event</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-      } // else outbound</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-    }</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-    let attendees = item.getAttendees();</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-    if (attendees.length &gt; 0) {</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-      // xxx todo: why ever, X-S1CS-EMAIL is unsupported though documented for calprops... WTF.</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-      let attParam = encodeAttendees(attendees);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-      if (!oldItem || attParam != encodeAttendees(oldItem.getAttendees())) {</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-        params += &quot;&amp;attendees=&quot; + attParam;</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-      }</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-      if (orgCalId == calId) {</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-        method = METHOD_REQUEST;</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-      } else {</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-        method = METHOD_UPDATE;</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-        bNoSmtpNotify = true;</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-      }</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-    } else if (oldItem &amp;&amp; oldItem.getAttendees().length &gt; 0) {</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-      // else using just PUBLISH</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-      params += &quot;&amp;attendees=&quot;; // clear attendees</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-    }</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-    if (orgCalId) {</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-      if (!oldItem || orgCalId != getCalId(oldItem.organizer)) {</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-        params += &quot;&amp;orgCalid=&quot; + encodeURIComponent(orgCalId);</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-      }</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-    } else {</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-      // might be a copy of an iTIP invitation:</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-      let orgEmail = getOrgId(item);</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-      if (!oldItem || getOrgId(oldItem) != orgEmail) {</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-        params += &quot;&amp;orgEmail=&quot; + encodeURIComponent(orgEmail);</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-      }</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-    }</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-    let val = item.title;</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-    if (!oldItem || val != oldItem.title) {</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-      params += &quot;&amp;summary=&quot; + encodeURIComponent(val);</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-    }</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-    let categories = item.getCategories();</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-    let catParam = encodeCategories(categories);</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-    if (!oldItem || catParam != encodeCategories(oldItem.getCategories())) {</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-      params += &quot;&amp;categories=&quot; + catParam;</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-    }</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-    val = diffProperty(item, oldItem, &quot;DESCRIPTION&quot;);</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-    if (val !== null) {</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-      params += &quot;&amp;desc=&quot; + encodeURIComponent(val);</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-    }</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-    val = diffProperty(item, oldItem, &quot;LOCATION&quot;);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-    if (val !== null) {</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-      params += &quot;&amp;location=&quot; + encodeURIComponent(val);</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-    }</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-    val = diffProperty(item, oldItem, &quot;URL&quot;);</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-    if (val !== null) {</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-      params += &quot;&amp;icsUrl=&quot; + encodeURIComponent(val);</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-    }</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-    // xxx todo: default prio is 0 (5 in sjs cs)</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-    val = item.priority;</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-    if (!oldItem || val != oldItem.priority) {</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-      params += &quot;&amp;priority=&quot; + encodeURIComponent(val);</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-    }</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-    let icsClass = getPrivacy(item);</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-    if (!oldItem || icsClass != getPrivacy(oldItem)) {</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-      params += &quot;&amp;icsClass=&quot; + icsClass;</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-    }</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-    if (!oldItem || item.status != oldItem.status) {</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-      switch (item.status) {</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-        case &quot;CONFIRMED&quot;:</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-          params += &quot;&amp;status=0&quot;;</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-          break;</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-        case &quot;CANCELLED&quot;:</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-          params += &quot;&amp;status=1&quot;;</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-          break;</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-        case &quot;TENTATIVE&quot;:</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-          params += &quot;&amp;status=2&quot;;</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-          break;</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-        case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-          params += &quot;&amp;status=3&quot;;</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-          break;</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-        case &quot;COMPLETED&quot;:</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-          params += &quot;&amp;status=4&quot;;</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-          break;</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-        case &quot;IN-PROCESS&quot;:</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-          params += &quot;&amp;status=5&quot;;</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-          break;</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-        case &quot;DRAFT&quot;:</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-          params += &quot;&amp;status=6&quot;;</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-          break;</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-        case &quot;FINAL&quot;:</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-          params += &quot;&amp;status=7&quot;;</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-          break;</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-        default:</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-          // reset to default</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-          params += bIsEvent ? &quot;&amp;status=0&quot; : &quot;&amp;status=3&quot;;</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-          break;</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-      }</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-    }</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-    val = diffProperty(item, oldItem, &quot;TRANSP&quot;);</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-    if (val !== null) {</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-      switch (val) {</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-        case &quot;TRANSPARENT&quot;:</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineminus">-          params += &quot;&amp;transparent=1&quot;;</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineminus">-          break;</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-        case &quot;OPAQUE&quot;:</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-          params += &quot;&amp;transparent=0&quot;;</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-          break;</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-        default:</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-          params += &quot;&amp;transparent=&quot; + (icsClass == &quot;PRIVATE&quot; || bIsAllDay ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-          break;</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-      }</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-    }</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-    if (!bIsEvent) {</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineminus">-      if (!oldItem || item.percentComplete != oldItem.percentComplete) {</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-        params += &quot;&amp;percent=&quot; + item.percentComplete.toString(10);</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-      }</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-      if (!oldItem || !equalDatetimes(item.completedDate, oldItem.completedDate)) {</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-        params += &quot;&amp;completed=&quot; + getIcalUTC(item.completedDate);</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-      }</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-    }</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-    // attachment urls:</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-    val = getAttachments(item);</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-    if (!oldItem || val != getAttachments(oldItem)) {</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineminus">-      params += &quot;&amp;attachments=&quot; + val;</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-    }</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-  } // PUBLISH, REQUEST</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-  let alarmParams = this.getAlarmParams(item);</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-  if (!oldItem || this.getAlarmParams(oldItem) != alarmParams) {</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-    if (method == METHOD_REQUEST &amp;&amp; params.length == 0) {</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-      // assure no email notifications about this change:</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-      bNoSmtpNotify = true;</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineminus">-    }</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineminus">-    params += alarmParams;</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-  }</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-  if (params.length == 0) {</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-    log(&quot;no change at all.&quot;, this);</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-    if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-      log(&quot;old item:\n&quot; + oldItem.icalString + &quot;\n\nnew item:\n&quot; + item.icalString, this);</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineminus">-    }</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineminus">-    request.execRespFunc(null, item);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-  } else {</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-    // cs does not support separate timezones for start and end, just pick one for tzid param:</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineminus">-    let someDate = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineminus">-    if (someDate &amp;&amp; !someDate.timezone.isUTC) {</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineminus">-      params += &quot;&amp;tzid=&quot; + encodeURIComponent(this.getAlignedTzid(someDate.timezone));</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineminus">-    }</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineminus">-</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-    if (item.id) {</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-      params += &quot;&amp;uid=&quot; + encodeURIComponent(item.id);</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-    }</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-    // be picky about create/modify, if possible:</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-    // WCAP_STORE_TYPE_CREATE, WCAP_STORE_TYPE_MODIFY</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-    if (bAddItem) {</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineminus">-      params += &quot;&amp;storetype=1&quot;;</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineminus">-    } else if (oldItem) {</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineminus">-      params += &quot;&amp;storetype=2&quot;;</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineminus">-    } // else we don't know exactly, so don't check</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-    if (bIsParent) {</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-      params += &quot;&amp;mod=4&quot;; // THIS AND ALL INSTANCES</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-    } else {</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-      params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.dtz.ensureDateTime(item.recurrenceId)); // THIS INSTANCE</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-    }</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-    params += &quot;&amp;method=&quot; + method;</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-    if (bNoSmtpNotify) {</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-      params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-    }</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-    params += &quot;&amp;replace=1&quot;; // (update) don't append to any lists</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-    params += &quot;&amp;fetch=1&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-    params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-    let netRespFunc = (err, icalRootComp) =&gt; {</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-      if (err) {</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-        throw err;</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-      }</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-      let items = this.parseItems(</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-        icalRootComp,</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-        calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-        0,</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-        null,</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-        null,</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-        true /* bLeaveMutable */</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-      );</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-      if (items.length != 1) {</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-        this.notifyError(NS_ERROR_UNEXPECTED, &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-      }</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-      let newItem = items[0];</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-      this.tunnelXProps(newItem, item);</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-      newItem.makeImmutable();</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineminus">-      // invalidate cached results:</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-      delete this.m_cachedResults;</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineminus">-      // xxx todo: may log request status</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineminus">-      request.execRespFunc(null, newItem);</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-    };</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-    this.issueNetworkRequest(</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-      request,</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-      netRespFunc,</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-      stringToIcal,</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-      bIsEvent ? &quot;storeevents&quot; : &quot;storetodos&quot;,</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-      params,</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-      calIWcapCalendar.AC_COMP_READ | calIWcapCalendar.AC_COMP_WRITE</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-    );</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-  }</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-};</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-calWcapCalendar.prototype.tunnelXProps = function(destItem, srcItem) {</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-  // xxx todo: temp workaround for bug in calItemBase.js</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-  if (!isParent(srcItem)) {</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-    return;</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-  }</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-  // tunnel alarm X-MOZ-SNOOZE only if alarm is still set:</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-  // TODO ALARMSUPPORT still needed when showing alarms as EMAIL for wcap?</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-  let hasAlarms = destItem.getAlarms().length;</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-  for (let [name, value] of srcItem.properties) {</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-    try {</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-      if (name.startsWith(&quot;X-MOZ-&quot;)) {</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-        switch (name) {</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-          // keep snooze stamps for occurrences only and if alarm is still set:</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-          case &quot;X-MOZ-SNOOZE-TIME&quot;:</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-            if (!hasAlarms) {</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-              break; // alarm has been reset</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-            }</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-          // falls through</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-          default:</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineminus">-            if (LOG_LEVEL &gt; 1) {</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-              log(&quot;tunneling &quot; + name + &quot;=&quot; + value, this);</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineminus">-            }</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineminus">-            destItem.setProperty(name, value);</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineminus">-            break;</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineminus">-        }</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-      }</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-    } catch (exc) {</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineminus">-      logError(exc, this);</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-    }</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineminus">-  }</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineminus">-};</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-calWcapCalendar.prototype.adoptItem = function(item, listener) {</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-  let request = new calWcapRequest((oprequest, err, newItem) =&gt; {</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-    this.notifyOperationComplete(</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-      listener,</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-      getResultCode(err),</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-      calIOperationListener.ADD,</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-      err ? item.id : newItem.id,</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-      err ? err : newItem</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-    );</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-    if (!err &amp;&amp; this == this.superCalendar) {</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-      this.notifyObservers(&quot;onAddItem&quot;, [newItem]);</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-    }</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-  }, log(&quot;adoptItem() call: &quot; + item.title, this));</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-  try {</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-    this.storeItem(true /* bAddItem */, item, null, request);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-  } catch (exc) {</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineminus">-    request.execRespFunc(exc);</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-  }</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-  return request;</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-};</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-calWcapCalendar.prototype.addItem = function(item, listener) {</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-  this.adoptItem(item.clone(), listener);</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-};</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-calWcapCalendar.prototype.modifyItem = function(newItem, oldItem, listener) {</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-  let request = new calWcapRequest((oprequest, err, item) =&gt; {</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-    this.notifyOperationComplete(</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-      listener,</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-      getResultCode(err),</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-      calIOperationListener.MODIFY,</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-      newItem.id,</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-      err ? err : item</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-    );</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-    if (!err &amp;&amp; this == this.superCalendar) {</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-      this.notifyObservers(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-    }</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-  }, log(&quot;modifyItem() call: &quot; + newItem.id, this));</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-  try {</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-    if (!newItem.id) {</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-      throw new Components.Exception(&quot;new item has no id!&quot;);</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineminus">-    }</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineminus">-    let oldItem_ = oldItem;</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-    if (isParent(newItem)) {</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-      // Due to a cs bug, EXDATEs cannot be passed with store, thus make a two-step delete then store.</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-      // First check if EXDATEs are passed or have been modified:</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-      let exdates = {};</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-      this.getRecurrenceParams(newItem, {}, {}, {}, exdates);</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-      if (oldItem) {</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-        let exdates_ = {};</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-        this.getRecurrenceParams(oldItem_, {}, {}, {}, exdates_);</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-        // only use added elements</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-        exdates.value = exdates.value.filter(elem =&gt; !exdates_.value.some(elem_ =&gt; elem_ == elem));</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-      } // else in case no oldItem is passed, nevertheless try to delete the EXDATEs</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-      if (exdates.value.length &gt; 0) {</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-        let params = &quot;&amp;uid=&quot;;</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-        // all deletes on the same item:</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-        for (let i = exdates.value.length - 1; i &gt;= 0; i--) {</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-          params += encodeURIComponent(newItem.id);</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-          if (i &gt; 0) {</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-            params += &quot;;&quot;;</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-          }</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-        }</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-        params += &quot;&amp;mod=1&amp;rid=&quot; + exdates.value.join(&quot;;&quot;);</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-        let orgCalId = getCalId(newItem.organizer);</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-        if (!orgCalId || orgCalId != this.calId) {</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-          // item does not belong to this user, so don't notify:</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-          params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-        }</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-        params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-        request.lockPending();</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-        this.issueNetworkRequest(</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-          request,</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-          (err, xml) =&gt; {</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-            try {</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-              // ignore any error and continue storing the item:</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-              if (LOG_LEVEL &gt; 0) {</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-                log(</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-                  &quot;modifyItem EXDATEs: &quot; + (xml ? getWcapRequestStatusString(xml) : &quot;failed!&quot;),</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-                  this</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-                );</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-              }</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-              // invalidate cached results:</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-              delete this.m_cachedResults;</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-              this.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-            } finally {</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-              request.unlockPending();</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-            }</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-          },</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-          stringToXml,</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-          cal.item.isEvent(newItem) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-          params,</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-          calIWcapCalendar.AC_COMP_WRITE</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-        );</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-        return request;</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-      }</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-    } else if (</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-      oldItem &amp;&amp;</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-      !oldItem.parentItem.recurrenceInfo.getExceptionFor(newItem.recurrenceId)</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-    ) {</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-      // pass null for oldItem when creating new exceptions, write whole item:</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-      oldItem_ = null;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-    }</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineminus">-    this.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-  } catch (exc) {</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-    request.execRespFunc(exc);</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-  }</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-  return request;</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineminus">-};</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineminus">-</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-calWcapCalendar.prototype.deleteItem = function(item, listener) {</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-  let request = new calWcapRequest((oprequest, err) =&gt; {</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-    // xxx todo: need to notify about each deleted item if multiple?</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineminus">-    this.notifyOperationComplete(</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-      listener,</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineminus">-      getResultCode(err),</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineminus">-      calIOperationListener.DELETE,</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-      item.id,</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-      err ? err : item</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-    );</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineminus">-    if (!err &amp;&amp; this == this.superCalendar) {</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-      this.notifyObservers(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    }</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-  }, log(&quot;deleteItem() call: &quot; + item.id, this));</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-  try {</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-    if (!item.id) {</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-      throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-    }</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-    let params = &quot;&amp;uid=&quot; + encodeURIComponent(item.id);</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-    if (isParent(item)) {</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-      // delete THIS AND ALL:</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-      params += &quot;&amp;mod=4&amp;rid=0&quot;;</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-    } else {</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-      // delete THIS INSTANCE:</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineminus">-      // cs does not accept DATE here:</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-      params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.dtz.ensureDateTime(item.recurrenceId));</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-    }</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-    let orgCalId = getCalId(item.organizer);</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-    if (!orgCalId || orgCalId != this.calId) {</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-      // item does not belong to this user, so don't notify:</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-      params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-    }</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-    params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-    this.issueNetworkRequest(</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-      request,</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-      (err, xml) =&gt; {</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-        if (err) {</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-          throw err;</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">-        }</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">-        // invalidate cached results:</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-        delete this.m_cachedResults;</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-        if (LOG_LEVEL &gt; 0) {</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-          log(&quot;deleteItem(): &quot; + getWcapRequestStatusString(xml), this);</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-        }</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-      },</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">-      stringToXml,</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-      cal.item.isEvent(item) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineminus">-      params,</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-      calIWcapCalendar.AC_COMP_WRITE</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-    );</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-  } catch (exc) {</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-    request.execRespFunc(exc);</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-  }</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-  return request;</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineminus">-};</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineminus">-</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineminus">-calWcapCalendar.prototype.patchTimezone = function(subComp, attr, xpropOrTz) {</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineminus">-  let date = subComp[attr];</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-  // if TZID parameter present (all-day items), it takes precedence:</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-  if (date &amp;&amp; (date.timezone.isUTC || date.timezone.isFloating)) {</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineminus">-    if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineminus">-      log(attr + &quot; is &quot; + date, this);</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineminus">-    }</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-    let timezone;</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-    if (typeof xpropOrTz == &quot;string&quot;) {</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-      let tzid = subComp.getFirstProperty(xpropOrTz);</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-      if (tzid) {</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-        timezone = this.session.getTimezone(tzid.value);</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-        cal.ASSERT(timezone, &quot;timezone not found: &quot; + tzid);</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-      }</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-    } else {</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-      timezone = xpropOrTz;</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-    }</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-    if (timezone) {</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-      if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineminus">-        log(</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-          &quot;patching &quot; + xpropOrTz + &quot;: from &quot; + date + &quot; to &quot; + date.getInTimezone(timezone),</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-          this</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-        );</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineminus">-      }</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-      date = date.getInTimezone(timezone);</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-      subComp[attr] = date;</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-    }</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-  }</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-  return date;</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-};</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineminus">-</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineminus">-calWcapCalendar.prototype.parseItems = function(</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineminus">-  icalRootComp,</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-  itemFilter,</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-  maxResults,</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-  rangeStart,</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-  rangeEnd,</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-  bLeaveMutable</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-) {</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-  let items = [];</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-  let unexpandedItems = [];</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineminus">-  let uid2parent = {};</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-  let excItems = [];</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-  let fakedParents = {};</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-  let componentType = &quot;ANY&quot;;</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">-  switch (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_ALL) {</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineminus">-    case calICalendar.ITEM_FILTER_TYPE_TODO:</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-      componentType = &quot;VTODO&quot;;</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-      break;</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-    case calICalendar.ITEM_FILTER_TYPE_EVENT:</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-      componentType = &quot;VEVENT&quot;;</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-      break;</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-  }</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-  let recurrenceBound = this.session.recurrenceBound;</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-  for (let subComp of cal.iterate.icalComponent(icalRootComp, componentType)) {</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-    let organizer = subComp.getFirstProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-    if (organizer &amp;&amp; organizer.getParameter(&quot;SENT-BY&quot;)) {</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-      // has SENT-BY</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-      // &amp;emailorcalid=1 sets wrong email, workaround setting calid...</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-      let id = organizer.getParameter(&quot;X-S1CS-CALID&quot;);</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-      if (id) {</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-        organizer.value = id;</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-      }</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-    }</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-    let dtstart = this.patchTimezone(subComp, &quot;startTime&quot;, &quot;X-NSCP-DTSTART-TZID&quot;);</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineminus">-</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineminus">-    let item = null;</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineminus">-    switch (subComp.componentType) {</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-      case &quot;VEVENT&quot;: {</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-        this.patchTimezone(subComp, &quot;endTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DTEND-TZID&quot;);</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-        item = cal.createEvent();</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-        item.icalComponent = subComp;</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineminus">-        break;</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineminus">-      }</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-      case &quot;VTODO&quot;: {</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineminus">-        this.patchTimezone(subComp, &quot;dueTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DUE-TZID&quot;);</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineminus">-        item = cal.createTodo();</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineminus">-        item.icalComponent = subComp;</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineminus">-        switch (itemFilter &amp; calICalendar.ITEM_FILTER_COMPLETED_ALL) {</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineminus">-          case calICalendar.ITEM_FILTER_COMPLETED_YES:</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineminus">-            if (!item.isCompleted) {</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineminus">-              item = null;</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineminus">-            }</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineminus">-            break;</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineminus">-          case calICalendar.ITEM_FILTER_COMPLETED_NO:</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-            if (item.isCompleted) {</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineminus">-              item = null;</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-            }</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-            break;</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineminus">-        }</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineminus">-        break;</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineminus">-      }</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineminus">-    }</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineminus">-    if (item) {</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineminus">-      if (!item.title) {</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineminus">-        // assumed to look at a subscribed calendar,</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineminus">-        // so patch title for private items:</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">-        switch (item.privacy) {</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">-          case &quot;PRIVATE&quot;:</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-            item.title = g_privateItemTitle;</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-            break;</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">-          case &quot;CONFIDENTIAL&quot;:</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-            item.title = g_confidentialItemTitle;</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">-            break;</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineminus">-        }</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineminus">-      }</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineminus">-</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineminus">-      item.calendar = this.superCalendar;</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineminus">-      let rid = item.recurrenceId;</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineminus">-      if (rid) {</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineminus">-        rid = rid.getInTimezone(dtstart.timezone);</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineminus">-        item.recurrenceId = rid;</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineminus">-        if (LOG_LEVEL &gt; 1) {</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-          log(</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-            &quot;exception item: &quot; + item.title + &quot;\nrid=&quot; + getIcalUTC(rid) + &quot;\nitem.id=&quot; + item.id,</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-            this</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-          );</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineminus">-        }</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineminus">-        excItems.push(item);</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineminus">-      } else if (item.recurrenceInfo) {</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineminus">-        unexpandedItems.push(item);</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineminus">-        uid2parent[item.id] = item;</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineminus">-      } else if (</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-        (maxResults == 0 || items.length &lt; maxResults) &amp;&amp;</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineminus">-        cal.item.checkIfInRange(item, rangeStart, rangeEnd)</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineminus">-      ) {</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineminus">-        if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-          log(&quot;item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-        }</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineminus">-        if (!bLeaveMutable) {</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineminus">-          item.makeImmutable();</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-        }</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineminus">-        items.push(item);</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineminus">-      }</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineminus">-    }</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineminus">-  }</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineminus">-  // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineminus">-  for (let item of excItems) {</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineminus">-    let parent = uid2parent[item.id];</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineminus">-</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineminus">-    if (!parent) {</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-      // a parentless one, fake a master and override it's occurrence</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineminus">-      parent = cal.item.isEvent(item) ? cal.createEvent() : cal.createTodo();</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineminus">-      parent.id = item.id;</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineminus">-      parent.calendar = this.superCalendar;</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-      parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineminus">-      parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineminus">-      parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineminus">-      fakedParents[item.id] = true;</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineminus">-      uid2parent[item.id] = parent;</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineminus">-      items.push(parent);</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineminus">-    }</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-    if (item.id in fakedParents) {</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-      let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].createInstance(</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineminus">-        Ci.calIRecurrenceDate</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineminus">-      );</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineminus">-      rdate.date = item.recurrenceId;</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineminus">-      parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineminus">-    }</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineminus">-</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-    let recStartDate = parent.recurrenceStartDate;</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-    if (recStartDate &amp;&amp; recStartDate.isDate &amp;&amp; !item.recurrenceId.isDate) {</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-      // cs ought to return proper all-day RECURRENCE-ID!</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineminus">-      // get into startDate's timezone before cutting:</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineminus">-      let rid = item.recurrenceId.getInTimezone(recStartDate.timezone);</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineminus">-      rid.isDate = true;</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineminus">-      item.recurrenceId = rid;</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineminus">-    }</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineminus">-</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineminus">-    parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-  }</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-  if (itemFilter &amp; calICalendar.ITEM_FILTER_CLASS_OCCURRENCES) {</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-    for (let item of unexpandedItems) {</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-      if (maxResults != 0 &amp;&amp; items.length &gt;= maxResults) {</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-        break;</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-      }</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineminus">-      let recStartDate = item.recurrenceStartDate;</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineminus">-      if (recStartDate &amp;&amp; !recStartDate.isDate) {</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineminus">-        recStartDate = null;</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-      }</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineminus">-      let recItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineminus">-      for (let recItem of recItems) {</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-        // cs bug: workaround missing COUNT</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineminus">-        let rRuleInstance = cal.wrapInstance(recItem, Ci.calIRecurrenceRule);</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineminus">-        let rDateInstance = cal.wrapInstance(recItem, Ci.calIRecurrenceDate);</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-        if (rRuleInstance) {</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-          recItem = rRuleInstance;</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-          if (!recItem.isFinite &amp;&amp; !recItem.isNegative) {</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineminus">-            recItem.count = recurrenceBound;</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineminus">-          }</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineminus">-        } else if (recStartDate &amp;&amp; rDateInstance) {</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineminus">-          // cs bug: always uses DATE-TIME even though the master item is all-day DATE:</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-          //         get into startDate's timezone before cutting:</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineminus">-          recItem = rDateInstance;</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineminus">-          let date = recItem.date.getInTimezone(recStartDate.timezone);</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineminus">-          date.isDate = true;</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-          recItem.date = date;</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-        }</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineminus">-      }</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineminus">-</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineminus">-      if (!bLeaveMutable) {</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-        item.makeImmutable();</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineminus">-      }</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineminus">-      let occurrences = item.recurrenceInfo.getOccurrences(</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineminus">-        rangeStart,</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineminus">-        rangeEnd,</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineminus">-        maxResults == 0 ? 0 : maxResults - items.length,</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineminus">-        {}</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineminus">-      );</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineminus">-      if (LOG_LEVEL &gt; 1) {</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineminus">-        log(</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineminus">-          &quot;item: &quot; + item.title + &quot; has &quot; + occurrences.length.toString() + &quot; occurrences.&quot;,</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineminus">-          this</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineminus">-        );</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineminus">-        if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineminus">-          log(&quot;master item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineminus">-          for (let occ of occurrences) {</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineminus">-            log(&quot;item: &quot; + occ.title + &quot;\n&quot; + occ.icalString, this);</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineminus">-          }</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineminus">-        }</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineminus">-      }</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineminus">-      // only proxies returned:</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineminus">-      items = items.concat(occurrences);</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineminus">-    }</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-  } else {</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-    if (maxResults != 0 &amp;&amp; items.length + unexpandedItems.length &gt; maxResults) {</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-      unexpandedItems.length = maxResults - items.length;</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineminus">-    }</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineminus">-    if (!bLeaveMutable) {</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineminus">-      for (let item of unexpandedItems) {</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-        item.makeImmutable();</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-      }</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-    }</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineminus">-    if (LOG_LEVEL &gt; 2) {</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineminus">-      for (let item of unexpandedItems) {</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineminus">-        log(&quot;item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineminus">-      }</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineminus">-    }</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineminus">-    items = items.concat(unexpandedItems);</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineminus">-  }</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineminus">-</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineminus">-  if (LOG_LEVEL &gt; 1) {</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineminus">-    log(&quot;parseItems(): returning &quot; + items.length + &quot; items&quot;, this);</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineminus">-  }</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineminus">-  return items;</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineminus">-};</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineminus">-</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineminus">-calWcapCalendar.prototype.getItem = function(id, listener) {</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineminus">-  let request = new calWcapRequest((oprequest, err, item) =&gt; {</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineminus">-    if (</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineminus">-      checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) ||</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineminus">-      checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineminus">-    ) {</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineminus">-      // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineminus">-      err = NS_OK;</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineminus">-    }</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-    this.notifyOperationComplete(</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineminus">-      listener,</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineminus">-      getResultCode(err),</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineminus">-      calIOperationListener.GET,</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineminus">-      item ? item.id : null,</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineminus">-      err || item</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineminus">-    );</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineminus">-  }, log(&quot;getItem() call: id=&quot; + id, this));</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineminus">-</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineminus">-  try {</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineminus">-    if (!id) {</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineminus">-      throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l8.1128"></a><span id="l8.1128" class="difflineminus">-    }</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineminus">-    let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-    params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&amp;uid=&quot;;</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineminus">-    params += encodeURIComponent(id);</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineminus">-</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineminus">-    // most common: try events first</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-    this.issueNetworkRequest(</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineminus">-      request,</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineminus">-      (err, eventRootComp) =&gt; {</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineminus">-        let notifyResult = rootComp =&gt; {</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-          let items = this.parseItems(rootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineminus">-          if (items.length &lt; 1) {</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineminus">-            throw new Components.Exception(&quot;no such item!&quot;);</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineminus">-          }</span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineminus">-          if (items.length &gt; 1) {</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineminus">-            this.notifyError(NS_ERROR_UNEXPECTED, &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineminus">-          }</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineminus">-          if (listener) {</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineminus">-            listener.onGetResult(</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-              this.superCalendar,</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-              NS_OK,</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineminus">-              calIItemBase,</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineminus">-              log(&quot;getItem(): success. id=&quot; + id, this),</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineminus">-              items</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineminus">-            );</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineminus">-          }</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineminus">-          request.execRespFunc(null, items[0]);</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineminus">-        };</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineminus">-        if (err) {</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineminus">-          if (</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineminus">-            !checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) &amp;&amp;</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineminus">-            !checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineminus">-          ) {</span>
<a href="#l8.1161"></a><span id="l8.1161" class="difflineminus">-            throw err;</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineminus">-          }</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-          // try todos:</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-          this.issueNetworkRequest(</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineminus">-            request,</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineminus">-            (fetcherr, todoRootComp) =&gt; {</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineminus">-              if (fetcherr) {</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-                throw fetcherr;</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineminus">-              }</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineminus">-              notifyResult(todoRootComp);</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineminus">-            },</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineminus">-            stringToIcal,</span>
<a href="#l8.1173"></a><span id="l8.1173" class="difflineminus">-            &quot;fetchtodos_by_id&quot;,</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineminus">-            params,</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-            calIWcapCalendar.AC_COMP_READ</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineminus">-          );</span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineminus">-        } else {</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineminus">-          notifyResult(eventRootComp);</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineminus">-        }</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-      },</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-      stringToIcal,</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineminus">-      &quot;fetchevents_by_id&quot;,</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineminus">-      params,</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-      calIWcapCalendar.AC_COMP_READ</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineminus">-    );</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineminus">-  } catch (exc) {</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineminus">-    request.execRespFunc(exc);</span>
<a href="#l8.1188"></a><span id="l8.1188" class="difflineminus">-  }</span>
<a href="#l8.1189"></a><span id="l8.1189" class="difflineminus">-  return request;</span>
<a href="#l8.1190"></a><span id="l8.1190" class="difflineminus">-};</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineminus">-function getItemFilterParams(itemFilter) {</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineminus">-  let params = &quot;&quot;;</span>
<a href="#l8.1194"></a><span id="l8.1194" class="difflineminus">-  switch (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_ALL) {</span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineminus">-    case calICalendar.ITEM_FILTER_TYPE_TODO:</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineminus">-      params += &quot;&amp;component-type=todo&quot;;</span>
<a href="#l8.1197"></a><span id="l8.1197" class="difflineminus">-      break;</span>
<a href="#l8.1198"></a><span id="l8.1198" class="difflineminus">-    case calICalendar.ITEM_FILTER_TYPE_EVENT:</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineminus">-      params += &quot;&amp;component-type=event&quot;;</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineminus">-      break;</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineminus">-  }</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineminus">-</span>
<a href="#l8.1203"></a><span id="l8.1203" class="difflineminus">-  let compstate = &quot;&quot;;</span>
<a href="#l8.1204"></a><span id="l8.1204" class="difflineminus">-  //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REPLY_DECLINED)</span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineminus">-  //         compstate += &quot;;REPLY-DECLINED&quot;;</span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineminus">-  //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REPLY_ACCEPTED)</span>
<a href="#l8.1207"></a><span id="l8.1207" class="difflineminus">-  //         compstate += &quot;;REPLY-ACCEPTED&quot;;</span>
<a href="#l8.1208"></a><span id="l8.1208" class="difflineminus">-  //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REQUEST_COMPLETED)</span>
<a href="#l8.1209"></a><span id="l8.1209" class="difflineminus">-  //         compstate += &quot;;REQUEST-COMPLETED&quot;;</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineminus">-  if (itemFilter &amp; calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) {</span>
<a href="#l8.1211"></a><span id="l8.1211" class="difflineminus">-    compstate += &quot;;REQUEST-NEEDS-ACTION&quot;;</span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineminus">-  }</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineminus">-  //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REQUEST_NEEDSNOACTION) {</span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineminus">-  //         compstate += &quot;;REQUEST-NEEDSNOACTION&quot;;</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineminus">-  //     }</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineminus">-  //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REQUEST_PENDING)</span>
<a href="#l8.1217"></a><span id="l8.1217" class="difflineminus">-  //         compstate += &quot;;REQUEST-PENDING&quot;;</span>
<a href="#l8.1218"></a><span id="l8.1218" class="difflineminus">-  //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REQUEST_WAITFORREPLY)</span>
<a href="#l8.1219"></a><span id="l8.1219" class="difflineminus">-  //         compstate += &quot;;REQUEST-WAITFORREPLY&quot;;</span>
<a href="#l8.1220"></a><span id="l8.1220" class="difflineminus">-  if (compstate.length &gt; 0) {</span>
<a href="#l8.1221"></a><span id="l8.1221" class="difflineminus">-    params += &quot;&amp;compstate=&quot; + compstate.substr(1);</span>
<a href="#l8.1222"></a><span id="l8.1222" class="difflineminus">-  }</span>
<a href="#l8.1223"></a><span id="l8.1223" class="difflineminus">-  return params;</span>
<a href="#l8.1224"></a><span id="l8.1224" class="difflineminus">-}</span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineminus">-</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineminus">-calWcapCalendar.prototype.getItems = function(</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineminus">-  itemFilter,</span>
<a href="#l8.1228"></a><span id="l8.1228" class="difflineminus">-  maxResults,</span>
<a href="#l8.1229"></a><span id="l8.1229" class="difflineminus">-  rangeStart,</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineminus">-  rangeEnd,</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineminus">-  listener</span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-) {</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-  rangeStart = cal.dtz.ensureDateTime(rangeStart);</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-  rangeEnd = cal.dtz.ensureDateTime(rangeEnd);</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineminus">-  let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineminus">-  let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineminus">-</span>
<a href="#l8.1238"></a><span id="l8.1238" class="difflineminus">-  let request = new calWcapRequest((oprequest, err, data) =&gt; {</span>
<a href="#l8.1239"></a><span id="l8.1239" class="difflineminus">-    log(&quot;getItems() complete: &quot; + errorToString(err), this);</span>
<a href="#l8.1240"></a><span id="l8.1240" class="difflineminus">-    this.notifyOperationComplete(</span>
<a href="#l8.1241"></a><span id="l8.1241" class="difflineminus">-      listener,</span>
<a href="#l8.1242"></a><span id="l8.1242" class="difflineminus">-      getResultCode(err),</span>
<a href="#l8.1243"></a><span id="l8.1243" class="difflineminus">-      calIOperationListener.GET,</span>
<a href="#l8.1244"></a><span id="l8.1244" class="difflineminus">-      null,</span>
<a href="#l8.1245"></a><span id="l8.1245" class="difflineminus">-      err</span>
<a href="#l8.1246"></a><span id="l8.1246" class="difflineminus">-    );</span>
<a href="#l8.1247"></a><span id="l8.1247" class="difflineminus">-  }, log(&quot;getItems():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) + &quot;,\n\tmaxResults=&quot; + maxResults + &quot;,\n\trangeStart=&quot; + zRangeStart + &quot;,\n\trangeEnd=&quot; + zRangeEnd, this));</span>
<a href="#l8.1248"></a><span id="l8.1248" class="difflineminus">-</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineminus">-  if (this.aboutToBeUnregistered) {</span>
<a href="#l8.1250"></a><span id="l8.1250" class="difflineminus">-    // limiting the amount of network traffic while unregistering</span>
<a href="#l8.1251"></a><span id="l8.1251" class="difflineminus">-    log(&quot;being unregistered, no results.&quot;, this);</span>
<a href="#l8.1252"></a><span id="l8.1252" class="difflineminus">-    request.execRespFunc(null, []);</span>
<a href="#l8.1253"></a><span id="l8.1253" class="difflineminus">-    return request;</span>
<a href="#l8.1254"></a><span id="l8.1254" class="difflineminus">-  }</span>
<a href="#l8.1255"></a><span id="l8.1255" class="difflineminus">-</span>
<a href="#l8.1256"></a><span id="l8.1256" class="difflineminus">-  // m_cachedResults holds the last data retrieval. This is especially useful when</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineminus">-  // switching on multiple subcriptions: the composite calendar multiplexes getItems()</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineminus">-  // calls to all composited calendars over and over again, most often on the same</span>
<a href="#l8.1259"></a><span id="l8.1259" class="difflineminus">-  // date range (as the user usually looks at the same view).</span>
<a href="#l8.1260"></a><span id="l8.1260" class="difflineminus">-  // This will most likely vanish when a better caching is implemented in the views,</span>
<a href="#l8.1261"></a><span id="l8.1261" class="difflineminus">-  // or WCAP local storage caching has sufficient performance.</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineminus">-  // The cached results will be invalidated after 2 minutes to reflect incoming invitations.</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineminus">-  if (CACHE_LAST_RESULTS &gt; 0 &amp;&amp; this.m_cachedResults) {</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineminus">-    for (let entry of this.m_cachedResults) {</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineminus">-      if (</span>
<a href="#l8.1266"></a><span id="l8.1266" class="difflineminus">-        itemFilter == entry.itemFilter &amp;&amp;</span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineminus">-        equalDatetimes(rangeStart, entry.rangeStart) &amp;&amp;</span>
<a href="#l8.1268"></a><span id="l8.1268" class="difflineminus">-        equalDatetimes(rangeEnd, entry.rangeEnd)</span>
<a href="#l8.1269"></a><span id="l8.1269" class="difflineminus">-      ) {</span>
<a href="#l8.1270"></a><span id="l8.1270" class="difflineminus">-        log(&quot;reusing last getItems() cached data.&quot;, this);</span>
<a href="#l8.1271"></a><span id="l8.1271" class="difflineminus">-        if (listener) {</span>
<a href="#l8.1272"></a><span id="l8.1272" class="difflineminus">-          listener.onGetResult(</span>
<a href="#l8.1273"></a><span id="l8.1273" class="difflineminus">-            this.superCalendar,</span>
<a href="#l8.1274"></a><span id="l8.1274" class="difflineminus">-            NS_OK,</span>
<a href="#l8.1275"></a><span id="l8.1275" class="difflineminus">-            calIItemBase,</span>
<a href="#l8.1276"></a><span id="l8.1276" class="difflineminus">-            &quot;getItems()&quot;,</span>
<a href="#l8.1277"></a><span id="l8.1277" class="difflineminus">-            entry.results</span>
<a href="#l8.1278"></a><span id="l8.1278" class="difflineminus">-          );</span>
<a href="#l8.1279"></a><span id="l8.1279" class="difflineminus">-        }</span>
<a href="#l8.1280"></a><span id="l8.1280" class="difflineminus">-        request.execRespFunc(null, entry.results);</span>
<a href="#l8.1281"></a><span id="l8.1281" class="difflineminus">-        return request;</span>
<a href="#l8.1282"></a><span id="l8.1282" class="difflineminus">-      }</span>
<a href="#l8.1283"></a><span id="l8.1283" class="difflineminus">-    }</span>
<a href="#l8.1284"></a><span id="l8.1284" class="difflineminus">-  }</span>
<a href="#l8.1285"></a><span id="l8.1285" class="difflineminus">-</span>
<a href="#l8.1286"></a><span id="l8.1286" class="difflineminus">-  try {</span>
<a href="#l8.1287"></a><span id="l8.1287" class="difflineminus">-    let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l8.1288"></a><span id="l8.1288" class="difflineminus">-    // setting component-type, compstate filters:</span>
<a href="#l8.1289"></a><span id="l8.1289" class="difflineminus">-    params += getItemFilterParams(itemFilter);</span>
<a href="#l8.1290"></a><span id="l8.1290" class="difflineminus">-    if (maxResults &gt; 0) {</span>
<a href="#l8.1291"></a><span id="l8.1291" class="difflineminus">-      params += &quot;&amp;maxResults=&quot; + maxResults;</span>
<a href="#l8.1292"></a><span id="l8.1292" class="difflineminus">-    }</span>
<a href="#l8.1293"></a><span id="l8.1293" class="difflineminus">-    params += &quot;&amp;dtstart=&quot; + zRangeStart;</span>
<a href="#l8.1294"></a><span id="l8.1294" class="difflineminus">-    params += &quot;&amp;dtend=&quot; + zRangeEnd;</span>
<a href="#l8.1295"></a><span id="l8.1295" class="difflineminus">-</span>
<a href="#l8.1296"></a><span id="l8.1296" class="difflineminus">-    this.issueNetworkRequest(</span>
<a href="#l8.1297"></a><span id="l8.1297" class="difflineminus">-      request,</span>
<a href="#l8.1298"></a><span id="l8.1298" class="difflineminus">-      (err, icalRootComp) =&gt; {</span>
<a href="#l8.1299"></a><span id="l8.1299" class="difflineminus">-        if (err) {</span>
<a href="#l8.1300"></a><span id="l8.1300" class="difflineminus">-          if (checkErrorCode(err, calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR)) {</span>
<a href="#l8.1301"></a><span id="l8.1301" class="difflineminus">-            // try free-busy times:</span>
<a href="#l8.1302"></a><span id="l8.1302" class="difflineminus">-            if (</span>
<a href="#l8.1303"></a><span id="l8.1303" class="difflineminus">-              listener &amp;&amp;</span>
<a href="#l8.1304"></a><span id="l8.1304" class="difflineminus">-              itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_EVENT &amp;&amp;</span>
<a href="#l8.1305"></a><span id="l8.1305" class="difflineminus">-              rangeStart &amp;&amp;</span>
<a href="#l8.1306"></a><span id="l8.1306" class="difflineminus">-              rangeEnd</span>
<a href="#l8.1307"></a><span id="l8.1307" class="difflineminus">-            ) {</span>
<a href="#l8.1308"></a><span id="l8.1308" class="difflineminus">-              let freeBusyListener = {</span>
<a href="#l8.1309"></a><span id="l8.1309" class="difflineminus">-                // calIGenericOperationListener:</span>
<a href="#l8.1310"></a><span id="l8.1310" class="difflineminus">-                onResult: function(oprequest, result) {</span>
<a href="#l8.1311"></a><span id="l8.1311" class="difflineminus">-                  if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l8.1312"></a><span id="l8.1312" class="difflineminus">-                    throw oprequest.status;</span>
<a href="#l8.1313"></a><span id="l8.1313" class="difflineminus">-                  }</span>
<a href="#l8.1314"></a><span id="l8.1314" class="difflineminus">-                  let items = [];</span>
<a href="#l8.1315"></a><span id="l8.1315" class="difflineminus">-                  for (let entry of result) {</span>
<a href="#l8.1316"></a><span id="l8.1316" class="difflineminus">-                    let item = cal.createEvent();</span>
<a href="#l8.1317"></a><span id="l8.1317" class="difflineminus">-                    item.id = g_busyPhantomItemUuidPrefix + getIcalUTC(entry.interval.start);</span>
<a href="#l8.1318"></a><span id="l8.1318" class="difflineminus">-                    item.calendar = this.superCalendar;</span>
<a href="#l8.1319"></a><span id="l8.1319" class="difflineminus">-                    item.title = g_busyItemTitle;</span>
<a href="#l8.1320"></a><span id="l8.1320" class="difflineminus">-                    item.startDate = entry.interval.start;</span>
<a href="#l8.1321"></a><span id="l8.1321" class="difflineminus">-                    item.endDate = entry.interval.end;</span>
<a href="#l8.1322"></a><span id="l8.1322" class="difflineminus">-                    item.makeImmutable();</span>
<a href="#l8.1323"></a><span id="l8.1323" class="difflineminus">-                    items.push(item);</span>
<a href="#l8.1324"></a><span id="l8.1324" class="difflineminus">-                  }</span>
<a href="#l8.1325"></a><span id="l8.1325" class="difflineminus">-                  listener.onGetResult(</span>
<a href="#l8.1326"></a><span id="l8.1326" class="difflineminus">-                    this.superCalendar,</span>
<a href="#l8.1327"></a><span id="l8.1327" class="difflineminus">-                    NS_OK,</span>
<a href="#l8.1328"></a><span id="l8.1328" class="difflineminus">-                    calIItemBase,</span>
<a href="#l8.1329"></a><span id="l8.1329" class="difflineminus">-                    &quot;getItems()/free-busy&quot;,</span>
<a href="#l8.1330"></a><span id="l8.1330" class="difflineminus">-                    items</span>
<a href="#l8.1331"></a><span id="l8.1331" class="difflineminus">-                  );</span>
<a href="#l8.1332"></a><span id="l8.1332" class="difflineminus">-                }.bind(this),</span>
<a href="#l8.1333"></a><span id="l8.1333" class="difflineminus">-              };</span>
<a href="#l8.1334"></a><span id="l8.1334" class="difflineminus">-              request.attachSubRequest(</span>
<a href="#l8.1335"></a><span id="l8.1335" class="difflineminus">-                this.session.getFreeBusyIntervals(</span>
<a href="#l8.1336"></a><span id="l8.1336" class="difflineminus">-                  this.calId,</span>
<a href="#l8.1337"></a><span id="l8.1337" class="difflineminus">-                  rangeStart,</span>
<a href="#l8.1338"></a><span id="l8.1338" class="difflineminus">-                  rangeEnd,</span>
<a href="#l8.1339"></a><span id="l8.1339" class="difflineminus">-                  calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l8.1340"></a><span id="l8.1340" class="difflineminus">-                  freeBusyListener</span>
<a href="#l8.1341"></a><span id="l8.1341" class="difflineminus">-                )</span>
<a href="#l8.1342"></a><span id="l8.1342" class="difflineminus">-              );</span>
<a href="#l8.1343"></a><span id="l8.1343" class="difflineminus">-            }</span>
<a href="#l8.1344"></a><span id="l8.1344" class="difflineminus">-          } else {</span>
<a href="#l8.1345"></a><span id="l8.1345" class="difflineminus">-            throw err;</span>
<a href="#l8.1346"></a><span id="l8.1346" class="difflineminus">-          }</span>
<a href="#l8.1347"></a><span id="l8.1347" class="difflineminus">-        } else if (listener) {</span>
<a href="#l8.1348"></a><span id="l8.1348" class="difflineminus">-          let items = this.parseItems(icalRootComp, itemFilter, maxResults, rangeStart, rangeEnd);</span>
<a href="#l8.1349"></a><span id="l8.1349" class="difflineminus">-</span>
<a href="#l8.1350"></a><span id="l8.1350" class="difflineminus">-          if (CACHE_LAST_RESULTS &gt; 0) {</span>
<a href="#l8.1351"></a><span id="l8.1351" class="difflineminus">-            // auto invalidate after X minutes:</span>
<a href="#l8.1352"></a><span id="l8.1352" class="difflineminus">-            if (!this.m_cachedResultsTimer) {</span>
<a href="#l8.1353"></a><span id="l8.1353" class="difflineminus">-              let callback = {</span>
<a href="#l8.1354"></a><span id="l8.1354" class="difflineminus">-                notify: function(timer) {</span>
<a href="#l8.1355"></a><span id="l8.1355" class="difflineminus">-                  if (!this.m_cachedResults) {</span>
<a href="#l8.1356"></a><span id="l8.1356" class="difflineminus">-                    return;</span>
<a href="#l8.1357"></a><span id="l8.1357" class="difflineminus">-                  }</span>
<a href="#l8.1358"></a><span id="l8.1358" class="difflineminus">-                  let now = new Date().getTime();</span>
<a href="#l8.1359"></a><span id="l8.1359" class="difflineminus">-                  // sort out old entries:</span>
<a href="#l8.1360"></a><span id="l8.1360" class="difflineminus">-                  let entries = [];</span>
<a href="#l8.1361"></a><span id="l8.1361" class="difflineminus">-                  for (let i = 0; i &lt; this.m_cachedResults.length; ++i) {</span>
<a href="#l8.1362"></a><span id="l8.1362" class="difflineminus">-                    let entry = this.m_cachedResults[i];</span>
<a href="#l8.1363"></a><span id="l8.1363" class="difflineminus">-                    if (now - entry.stamp &lt; CACHE_LAST_RESULTS_INVALIDATE * 1000) {</span>
<a href="#l8.1364"></a><span id="l8.1364" class="difflineminus">-                      entries.push(entry);</span>
<a href="#l8.1365"></a><span id="l8.1365" class="difflineminus">-                    } else {</span>
<a href="#l8.1366"></a><span id="l8.1366" class="difflineminus">-                      log(</span>
<a href="#l8.1367"></a><span id="l8.1367" class="difflineminus">-                        &quot;invalidating cached entry:\n\trangeStart=&quot; +</span>
<a href="#l8.1368"></a><span id="l8.1368" class="difflineminus">-                          getIcalUTC(entry.rangeStart) +</span>
<a href="#l8.1369"></a><span id="l8.1369" class="difflineminus">-                          &quot;\n\trangeEnd=&quot; +</span>
<a href="#l8.1370"></a><span id="l8.1370" class="difflineminus">-                          getIcalUTC(entry.rangeEnd),</span>
<a href="#l8.1371"></a><span id="l8.1371" class="difflineminus">-                        this</span>
<a href="#l8.1372"></a><span id="l8.1372" class="difflineminus">-                      );</span>
<a href="#l8.1373"></a><span id="l8.1373" class="difflineminus">-                    }</span>
<a href="#l8.1374"></a><span id="l8.1374" class="difflineminus">-                  }</span>
<a href="#l8.1375"></a><span id="l8.1375" class="difflineminus">-                  this.m_cachedResults = entries;</span>
<a href="#l8.1376"></a><span id="l8.1376" class="difflineminus">-                }.bind(this),</span>
<a href="#l8.1377"></a><span id="l8.1377" class="difflineminus">-              };</span>
<a href="#l8.1378"></a><span id="l8.1378" class="difflineminus">-              // sort out freq:</span>
<a href="#l8.1379"></a><span id="l8.1379" class="difflineminus">-              let freq = Math.min(</span>
<a href="#l8.1380"></a><span id="l8.1380" class="difflineminus">-                20, // default: 20secs</span>
<a href="#l8.1381"></a><span id="l8.1381" class="difflineminus">-                Math.max(1, CACHE_LAST_RESULTS_INVALIDATE)</span>
<a href="#l8.1382"></a><span id="l8.1382" class="difflineminus">-              );</span>
<a href="#l8.1383"></a><span id="l8.1383" class="difflineminus">-              log(&quot;cached results sort out timer freq: &quot; + freq, this);</span>
<a href="#l8.1384"></a><span id="l8.1384" class="difflineminus">-              this.m_cachedResultsTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l8.1385"></a><span id="l8.1385" class="difflineminus">-              this.m_cachedResultsTimer.initWithCallback(</span>
<a href="#l8.1386"></a><span id="l8.1386" class="difflineminus">-                callback,</span>
<a href="#l8.1387"></a><span id="l8.1387" class="difflineminus">-                freq * 1000,</span>
<a href="#l8.1388"></a><span id="l8.1388" class="difflineminus">-                Ci.nsITimer.TYPE_REPEATING_SLACK</span>
<a href="#l8.1389"></a><span id="l8.1389" class="difflineminus">-              );</span>
<a href="#l8.1390"></a><span id="l8.1390" class="difflineminus">-            }</span>
<a href="#l8.1391"></a><span id="l8.1391" class="difflineminus">-            if (!this.m_cachedResults) {</span>
<a href="#l8.1392"></a><span id="l8.1392" class="difflineminus">-              this.m_cachedResults = [];</span>
<a href="#l8.1393"></a><span id="l8.1393" class="difflineminus">-            }</span>
<a href="#l8.1394"></a><span id="l8.1394" class="difflineminus">-            let cacheEntry = {</span>
<a href="#l8.1395"></a><span id="l8.1395" class="difflineminus">-              stamp: new Date().getTime(),</span>
<a href="#l8.1396"></a><span id="l8.1396" class="difflineminus">-              itemFilter: itemFilter,</span>
<a href="#l8.1397"></a><span id="l8.1397" class="difflineminus">-              rangeStart: rangeStart ? rangeStart.clone() : null,</span>
<a href="#l8.1398"></a><span id="l8.1398" class="difflineminus">-              rangeEnd: rangeEnd ? rangeEnd.clone() : null,</span>
<a href="#l8.1399"></a><span id="l8.1399" class="difflineminus">-              results: items,</span>
<a href="#l8.1400"></a><span id="l8.1400" class="difflineminus">-            };</span>
<a href="#l8.1401"></a><span id="l8.1401" class="difflineminus">-            this.m_cachedResults.unshift(cacheEntry);</span>
<a href="#l8.1402"></a><span id="l8.1402" class="difflineminus">-            if (this.m_cachedResults.length &gt; CACHE_LAST_RESULTS) {</span>
<a href="#l8.1403"></a><span id="l8.1403" class="difflineminus">-              this.m_cachedResults.length = CACHE_LAST_RESULTS;</span>
<a href="#l8.1404"></a><span id="l8.1404" class="difflineminus">-            }</span>
<a href="#l8.1405"></a><span id="l8.1405" class="difflineminus">-          }</span>
<a href="#l8.1406"></a><span id="l8.1406" class="difflineminus">-</span>
<a href="#l8.1407"></a><span id="l8.1407" class="difflineminus">-          listener.onGetResult(this.superCalendar, NS_OK, calIItemBase, &quot;getItems()&quot;, items);</span>
<a href="#l8.1408"></a><span id="l8.1408" class="difflineminus">-        }</span>
<a href="#l8.1409"></a><span id="l8.1409" class="difflineminus">-      },</span>
<a href="#l8.1410"></a><span id="l8.1410" class="difflineminus">-      stringToIcal,</span>
<a href="#l8.1411"></a><span id="l8.1411" class="difflineminus">-      &quot;fetchcomponents_by_range&quot;,</span>
<a href="#l8.1412"></a><span id="l8.1412" class="difflineminus">-      params,</span>
<a href="#l8.1413"></a><span id="l8.1413" class="difflineminus">-      calIWcapCalendar.AC_COMP_READ</span>
<a href="#l8.1414"></a><span id="l8.1414" class="difflineminus">-    );</span>
<a href="#l8.1415"></a><span id="l8.1415" class="difflineminus">-  } catch (exc) {</span>
<a href="#l8.1416"></a><span id="l8.1416" class="difflineminus">-    request.execRespFunc(exc);</span>
<a href="#l8.1417"></a><span id="l8.1417" class="difflineminus">-  }</span>
<a href="#l8.1418"></a><span id="l8.1418" class="difflineminus">-  return request;</span>
<a href="#l8.1419"></a><span id="l8.1419" class="difflineminus">-};</span>
<a href="#l8.1420"></a><span id="l8.1420" class="difflineminus">-</span>
<a href="#l8.1421"></a><span id="l8.1421" class="difflineminus">-calWcapCalendar.prototype.offlineStorage = null;</span>
<a href="#l8.1422"></a><span id="l8.1422" class="difflineminus">-</span>
<a href="#l8.1423"></a><span id="l8.1423" class="difflineminus">-calWcapCalendar.prototype.resetLog = function() {</span>
<a href="#l8.1424"></a><span id="l8.1424" class="difflineminus">-  this.deleteProperty(&quot;replay.last_stamp&quot;);</span>
<a href="#l8.1425"></a><span id="l8.1425" class="difflineminus">-};</span>
<a href="#l8.1426"></a><span id="l8.1426" class="difflineminus">-</span>
<a href="#l8.1427"></a><span id="l8.1427" class="difflineminus">-calWcapCalendar.prototype.replayChangesOn = function(listener) {</span>
<a href="#l8.1428"></a><span id="l8.1428" class="difflineminus">-  let itemFilter = calICalendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l8.1429"></a><span id="l8.1429" class="difflineminus">-  let dtFrom = getDatetimeFromIcalString(this.getProperty(&quot;replay.last_stamp&quot;));</span>
<a href="#l8.1430"></a><span id="l8.1430" class="difflineminus">-  let now = getTime(); // new stamp for this sync</span>
<a href="#l8.1431"></a><span id="l8.1431" class="difflineminus">-</span>
<a href="#l8.1432"></a><span id="l8.1432" class="difflineminus">-  let request_ = new calWcapRequest((request, err) =&gt; {</span>
<a href="#l8.1433"></a><span id="l8.1433" class="difflineminus">-    if (err) {</span>
<a href="#l8.1434"></a><span id="l8.1434" class="difflineminus">-      logError(&quot;error replaying changes: &quot; + errorToString(err));</span>
<a href="#l8.1435"></a><span id="l8.1435" class="difflineminus">-      this.notifyError(err);</span>
<a href="#l8.1436"></a><span id="l8.1436" class="difflineminus">-    } else {</span>
<a href="#l8.1437"></a><span id="l8.1437" class="difflineminus">-      log(&quot;replay succeeded.&quot;, this);</span>
<a href="#l8.1438"></a><span id="l8.1438" class="difflineminus">-      this.setProperty(&quot;replay.last_stamp&quot;, getIcalUTC(now));</span>
<a href="#l8.1439"></a><span id="l8.1439" class="difflineminus">-      log(&quot;new replay stamp: &quot; + getIcalUTC(now), this);</span>
<a href="#l8.1440"></a><span id="l8.1440" class="difflineminus">-    }</span>
<a href="#l8.1441"></a><span id="l8.1441" class="difflineminus">-    if (listener) {</span>
<a href="#l8.1442"></a><span id="l8.1442" class="difflineminus">-      listener.onResult(request, null);</span>
<a href="#l8.1443"></a><span id="l8.1443" class="difflineminus">-    }</span>
<a href="#l8.1444"></a><span id="l8.1444" class="difflineminus">-  }, log(&quot;replayChangesOn():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) + &quot;\n\tdtFrom=&quot; + getIcalUTC(dtFrom), this));</span>
<a href="#l8.1445"></a><span id="l8.1445" class="difflineminus">-</span>
<a href="#l8.1446"></a><span id="l8.1446" class="difflineminus">-  try {</span>
<a href="#l8.1447"></a><span id="l8.1447" class="difflineminus">-    let writeListener = {</span>
<a href="#l8.1448"></a><span id="l8.1448" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l8.1449"></a><span id="l8.1449" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l8.1450"></a><span id="l8.1450" class="difflineminus">-      onOperationComplete: function(aCalendar, status, opType, id, detail) {</span>
<a href="#l8.1451"></a><span id="l8.1451" class="difflineminus">-        if (!Components.isSuccessCode(status)) {</span>
<a href="#l8.1452"></a><span id="l8.1452" class="difflineminus">-          request.execRespFunc(status); // any error on writing breaks whole operation</span>
<a href="#l8.1453"></a><span id="l8.1453" class="difflineminus">-        }</span>
<a href="#l8.1454"></a><span id="l8.1454" class="difflineminus">-      },</span>
<a href="#l8.1455"></a><span id="l8.1455" class="difflineminus">-    };</span>
<a href="#l8.1456"></a><span id="l8.1456" class="difflineminus">-    let request = new calWcapRequest((err, data) =&gt; {</span>
<a href="#l8.1457"></a><span id="l8.1457" class="difflineminus">-      let modifiedIds = {};</span>
<a href="#l8.1458"></a><span id="l8.1458" class="difflineminus">-      for (let item of request.m_modifiedItems) {</span>
<a href="#l8.1459"></a><span id="l8.1459" class="difflineminus">-        let dtCreated = item.getProperty(&quot;CREATED&quot;);</span>
<a href="#l8.1460"></a><span id="l8.1460" class="difflineminus">-        let bAdd = !dtCreated || !dtFrom || dtCreated.compare(dtFrom) &gt;= 0;</span>
<a href="#l8.1461"></a><span id="l8.1461" class="difflineminus">-        modifiedIds[item.id] = true;</span>
<a href="#l8.1462"></a><span id="l8.1462" class="difflineminus">-        if (bAdd) {</span>
<a href="#l8.1463"></a><span id="l8.1463" class="difflineminus">-          log(&quot;replayChangesOn(): new item &quot; + item.id, this);</span>
<a href="#l8.1464"></a><span id="l8.1464" class="difflineminus">-          if (this.offlineStorage) {</span>
<a href="#l8.1465"></a><span id="l8.1465" class="difflineminus">-            this.offlineStorage.addItem(item, writeListener);</span>
<a href="#l8.1466"></a><span id="l8.1466" class="difflineminus">-          }</span>
<a href="#l8.1467"></a><span id="l8.1467" class="difflineminus">-        } else {</span>
<a href="#l8.1468"></a><span id="l8.1468" class="difflineminus">-          log(&quot;replayChangesOn(): modified item &quot; + item.id, this);</span>
<a href="#l8.1469"></a><span id="l8.1469" class="difflineminus">-          if (this.offlineStorage) {</span>
<a href="#l8.1470"></a><span id="l8.1470" class="difflineminus">-            this.modifyItem(item, null, writeListener);</span>
<a href="#l8.1471"></a><span id="l8.1471" class="difflineminus">-          }</span>
<a href="#l8.1472"></a><span id="l8.1472" class="difflineminus">-        }</span>
<a href="#l8.1473"></a><span id="l8.1473" class="difflineminus">-      }</span>
<a href="#l8.1474"></a><span id="l8.1474" class="difflineminus">-      for (let item of request.m_deletedItems) {</span>
<a href="#l8.1475"></a><span id="l8.1475" class="difflineminus">-        // don't delete anything that has been touched by lastmods:</span>
<a href="#l8.1476"></a><span id="l8.1476" class="difflineminus">-        if (modifiedIds[item.id]) {</span>
<a href="#l8.1477"></a><span id="l8.1477" class="difflineminus">-          log(&quot;replayChangesOn(): skipping deletion of &quot; + item.id, this);</span>
<a href="#l8.1478"></a><span id="l8.1478" class="difflineminus">-        } else if (isParent(item)) {</span>
<a href="#l8.1479"></a><span id="l8.1479" class="difflineminus">-          log(&quot;replayChangesOn(): deleted item &quot; + item.id, this);</span>
<a href="#l8.1480"></a><span id="l8.1480" class="difflineminus">-          if (this.offlineStorage) {</span>
<a href="#l8.1481"></a><span id="l8.1481" class="difflineminus">-            this.offlineStorage.deleteItem(item, writeListener);</span>
<a href="#l8.1482"></a><span id="l8.1482" class="difflineminus">-          }</span>
<a href="#l8.1483"></a><span id="l8.1483" class="difflineminus">-        } else {</span>
<a href="#l8.1484"></a><span id="l8.1484" class="difflineminus">-          // modify parent instead of</span>
<a href="#l8.1485"></a><span id="l8.1485" class="difflineminus">-          // straight-forward deleteItem(). WTF.</span>
<a href="#l8.1486"></a><span id="l8.1486" class="difflineminus">-          let parent = item.parentItem.clone();</span>
<a href="#l8.1487"></a><span id="l8.1487" class="difflineminus">-          parent.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l8.1488"></a><span id="l8.1488" class="difflineminus">-          log(&quot;replayChangesOn(): modified parent &quot; + parent.id, this);</span>
<a href="#l8.1489"></a><span id="l8.1489" class="difflineminus">-          if (this.offlineStorage) {</span>
<a href="#l8.1490"></a><span id="l8.1490" class="difflineminus">-            this.offlineStorage.modifyItem(parent, item, writeListener);</span>
<a href="#l8.1491"></a><span id="l8.1491" class="difflineminus">-          }</span>
<a href="#l8.1492"></a><span id="l8.1492" class="difflineminus">-        }</span>
<a href="#l8.1493"></a><span id="l8.1493" class="difflineminus">-      }</span>
<a href="#l8.1494"></a><span id="l8.1494" class="difflineminus">-    }, &quot;replayChangesOn() netFinishedRespFunc&quot;);</span>
<a href="#l8.1495"></a><span id="l8.1495" class="difflineminus">-    request_.attachSubRequest(request);</span>
<a href="#l8.1496"></a><span id="l8.1496" class="difflineminus">-</span>
<a href="#l8.1497"></a><span id="l8.1497" class="difflineminus">-    // assure being logged in to calc server times:</span>
<a href="#l8.1498"></a><span id="l8.1498" class="difflineminus">-    this.session.getSessionId(request, (err, sessionId) =&gt; {</span>
<a href="#l8.1499"></a><span id="l8.1499" class="difflineminus">-      try {</span>
<a href="#l8.1500"></a><span id="l8.1500" class="difflineminus">-        if (err) {</span>
<a href="#l8.1501"></a><span id="l8.1501" class="difflineminus">-          throw err;</span>
<a href="#l8.1502"></a><span id="l8.1502" class="difflineminus">-        }</span>
<a href="#l8.1503"></a><span id="l8.1503" class="difflineminus">-        let params =</span>
<a href="#l8.1504"></a><span id="l8.1504" class="difflineminus">-          &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l8.1505"></a><span id="l8.1505" class="difflineminus">-        if (dtFrom) {</span>
<a href="#l8.1506"></a><span id="l8.1506" class="difflineminus">-          dtFrom = this.session.getServerTime(dtFrom);</span>
<a href="#l8.1507"></a><span id="l8.1507" class="difflineminus">-        }</span>
<a href="#l8.1508"></a><span id="l8.1508" class="difflineminus">-        params += &quot;&amp;dtstart=&quot; + getIcalUTC(dtFrom);</span>
<a href="#l8.1509"></a><span id="l8.1509" class="difflineminus">-        params += &quot;&amp;dtend=&quot; + getIcalUTC(this.session.getServerTime(now));</span>
<a href="#l8.1510"></a><span id="l8.1510" class="difflineminus">-</span>
<a href="#l8.1511"></a><span id="l8.1511" class="difflineminus">-        log(&quot;replayChangesOn(): getting last modifications...&quot;, this);</span>
<a href="#l8.1512"></a><span id="l8.1512" class="difflineminus">-        this.issueNetworkRequest(</span>
<a href="#l8.1513"></a><span id="l8.1513" class="difflineminus">-          request,</span>
<a href="#l8.1514"></a><span id="l8.1514" class="difflineminus">-          (fetcherr, icalRootComp) =&gt; {</span>
<a href="#l8.1515"></a><span id="l8.1515" class="difflineminus">-            if (fetcherr) {</span>
<a href="#l8.1516"></a><span id="l8.1516" class="difflineminus">-              throw fetcherr;</span>
<a href="#l8.1517"></a><span id="l8.1517" class="difflineminus">-            }</span>
<a href="#l8.1518"></a><span id="l8.1518" class="difflineminus">-            request.m_modifiedItems = this.parseItems(</span>
<a href="#l8.1519"></a><span id="l8.1519" class="difflineminus">-              icalRootComp,</span>
<a href="#l8.1520"></a><span id="l8.1520" class="difflineminus">-              calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l8.1521"></a><span id="l8.1521" class="difflineminus">-              0,</span>
<a href="#l8.1522"></a><span id="l8.1522" class="difflineminus">-              null,</span>
<a href="#l8.1523"></a><span id="l8.1523" class="difflineminus">-              null</span>
<a href="#l8.1524"></a><span id="l8.1524" class="difflineminus">-            );</span>
<a href="#l8.1525"></a><span id="l8.1525" class="difflineminus">-          },</span>
<a href="#l8.1526"></a><span id="l8.1526" class="difflineminus">-          stringToIcal,</span>
<a href="#l8.1527"></a><span id="l8.1527" class="difflineminus">-          &quot;fetchcomponents_by_lastmod&quot;,</span>
<a href="#l8.1528"></a><span id="l8.1528" class="difflineminus">-          params + getItemFilterParams(itemFilter),</span>
<a href="#l8.1529"></a><span id="l8.1529" class="difflineminus">-          calIWcapCalendar.AC_COMP_READ</span>
<a href="#l8.1530"></a><span id="l8.1530" class="difflineminus">-        );</span>
<a href="#l8.1531"></a><span id="l8.1531" class="difflineminus">-</span>
<a href="#l8.1532"></a><span id="l8.1532" class="difflineminus">-        log(&quot;replayChangesOn(): getting deleted items...&quot;, this);</span>
<a href="#l8.1533"></a><span id="l8.1533" class="difflineminus">-        this.issueNetworkRequest(</span>
<a href="#l8.1534"></a><span id="l8.1534" class="difflineminus">-          request,</span>
<a href="#l8.1535"></a><span id="l8.1535" class="difflineminus">-          (fetcherr, icalRootComp) =&gt; {</span>
<a href="#l8.1536"></a><span id="l8.1536" class="difflineminus">-            if (fetcherr) {</span>
<a href="#l8.1537"></a><span id="l8.1537" class="difflineminus">-              throw fetcherr;</span>
<a href="#l8.1538"></a><span id="l8.1538" class="difflineminus">-            }</span>
<a href="#l8.1539"></a><span id="l8.1539" class="difflineminus">-            request.m_deletedItems = this.parseItems(</span>
<a href="#l8.1540"></a><span id="l8.1540" class="difflineminus">-              icalRootComp,</span>
<a href="#l8.1541"></a><span id="l8.1541" class="difflineminus">-              calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l8.1542"></a><span id="l8.1542" class="difflineminus">-              0,</span>
<a href="#l8.1543"></a><span id="l8.1543" class="difflineminus">-              null,</span>
<a href="#l8.1544"></a><span id="l8.1544" class="difflineminus">-              null</span>
<a href="#l8.1545"></a><span id="l8.1545" class="difflineminus">-            );</span>
<a href="#l8.1546"></a><span id="l8.1546" class="difflineminus">-          },</span>
<a href="#l8.1547"></a><span id="l8.1547" class="difflineminus">-          stringToIcal,</span>
<a href="#l8.1548"></a><span id="l8.1548" class="difflineminus">-          &quot;fetch_deletedcomponents&quot;,</span>
<a href="#l8.1549"></a><span id="l8.1549" class="difflineminus">-          params +</span>
<a href="#l8.1550"></a><span id="l8.1550" class="difflineminus">-            getItemFilterParams(</span>
<a href="#l8.1551"></a><span id="l8.1551" class="difflineminus">-              itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_ALL // only component types</span>
<a href="#l8.1552"></a><span id="l8.1552" class="difflineminus">-            ),</span>
<a href="#l8.1553"></a><span id="l8.1553" class="difflineminus">-          calIWcapCalendar.AC_COMP_READ</span>
<a href="#l8.1554"></a><span id="l8.1554" class="difflineminus">-        );</span>
<a href="#l8.1555"></a><span id="l8.1555" class="difflineminus">-      } catch (exc) {</span>
<a href="#l8.1556"></a><span id="l8.1556" class="difflineminus">-        request.execRespFunc(exc);</span>
<a href="#l8.1557"></a><span id="l8.1557" class="difflineminus">-      }</span>
<a href="#l8.1558"></a><span id="l8.1558" class="difflineminus">-    });</span>
<a href="#l8.1559"></a><span id="l8.1559" class="difflineminus">-  } catch (exc) {</span>
<a href="#l8.1560"></a><span id="l8.1560" class="difflineminus">-    request_.execRespFunc(exc);</span>
<a href="#l8.1561"></a><span id="l8.1561" class="difflineminus">-  }</span>
<a href="#l8.1562"></a><span id="l8.1562" class="difflineminus">-  return request_;</span>
<a href="#l8.1563"></a><span id="l8.1563" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,100 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-/* exported NS_OK, NS_ERROR_UNEXPECTED, nsIException, calIWcapSession,</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">- *          calIWcapCalendar, calIWcapErrors, calICalendar, calIItemBase,</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">- *          calIOperationListener, calIFreeBusyProvider, calIFreeBusyInterval,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- *          calICalendarSearchProvider, calIErrors, g_privateItemTitle,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">- *          g_confidentialItemTitle, g_busyItemTitle,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">- *          g_busyPhantomItemUuidPrefix, CACHE_LAST_RESULTS,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">- *          CACHE_LAST_RESULTS_INVALIDATE, LOG_LEVEL</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">- */</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-/* import-globals-from calWcapUtils.js */</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-/* import-globals-from calWcapErrors.js */</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-/* import-globals-from calWcapRequest.js */</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-/* import-globals-from calWcapSession.js */</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-/* import-globals-from calWcapCalendar.js */</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-/* import-globals-from calWcapCalendarItems.js */</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-var { XPCOMUtils } = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-//</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-// init code for globals, prefs:</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-//</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-// constants:</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-var NS_OK = Cr.NS_OK;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-var NS_ERROR_UNEXPECTED = Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-var nsIException = Ci.nsIException;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-var calIWcapSession = Ci.calIWcapSession;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-var calIWcapCalendar = Ci.calIWcapCalendar;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-var calIWcapErrors = Ci.calIWcapErrors;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-var calICalendar = Ci.calICalendar;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-var calIItemBase = Ci.calIItemBase;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-var calIOperationListener = Ci.calIOperationListener;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-var calIFreeBusyProvider = Ci.calIFreeBusyProvider;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-var calIFreeBusyInterval = Ci.calIFreeBusyInterval;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-var calICalendarSearchProvider = Ci.calICalendarSearchProvider;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-var calIErrors = Ci.calIErrors;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-// some string resources:</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-var g_privateItemTitle;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-var g_confidentialItemTitle;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-var g_busyItemTitle;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-var g_busyPhantomItemUuidPrefix;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-// global preferences:</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-// caching the last data retrievals:</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-var CACHE_LAST_RESULTS = 4;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-// timer secs for invalidation:</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-var CACHE_LAST_RESULTS_INVALIDATE = 120;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-// logging:</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-var LOG_LEVEL = 0;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-function initWcapProvider() {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  try {</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    initLogging();</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-    // some string resources:</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    g_privateItemTitle = getWcapString(&quot;privateItem.title.text&quot;);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-    g_confidentialItemTitle = getWcapString(&quot;confidentialItem.title.text&quot;);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    g_busyItemTitle = getWcapString(&quot;busyItem.title.text&quot;);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    g_busyPhantomItemUuidPrefix = &quot;PHANTOM_uuid_&quot; + cal.getUUID();</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-    CACHE_LAST_RESULTS = Services.prefs.getIntPref(&quot;calendar.wcap.cache_last_results&quot;, 4);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    CACHE_LAST_RESULTS_INVALIDATE = Services.prefs.getIntPref(</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-      &quot;calendar.wcap.cache_last_results_invalidate&quot;,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-      120</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    );</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  } catch (exc) {</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    logError(exc, &quot;error in init sequence&quot;);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  }</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-}</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-/** Module Registration */</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-this.NSGetFactory = cid =&gt; {</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  let scriptLoadOrder = [</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    &quot;resource://calendar/calendar-js/calWcapUtils.js&quot;,</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    &quot;resource://calendar/calendar-js/calWcapErrors.js&quot;,</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    &quot;resource://calendar/calendar-js/calWcapRequest.js&quot;,</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    &quot;resource://calendar/calendar-js/calWcapSession.js&quot;,</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-    &quot;resource://calendar/calendar-js/calWcapCalendar.js&quot;,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-    &quot;resource://calendar/calendar-js/calWcapCalendarItems.js&quot;,</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  ];</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  for (let script of scriptLoadOrder) {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    Services.scriptloader.loadSubScript(script, this);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  }</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-  initWcapProvider();</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  let components = [calWcapCalendar, calWcapNetworkRequest, calWcapSession];</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-  this.NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  return this.NSGetFactory(cid);</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarModule.manifest</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,8 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-component {cf4d93e5-af79-451a-95f3-109055b32ef0} calWcapCalendarModule.js</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-contract @mozilla.org/calendar/calendar;1?type=wcap {cf4d93e5-af79-451a-95f3-109055b32ef0}</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-component {cbf803fd-4469-4999-ae39-367af1c7b077} calWcapCalendarModule.js</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-contract @mozilla.org/calendar/wcap/session;1 {cbf803fd-4469-4999-ae39-367af1c7b077}</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-component {e3c62b37-83cf-41ec-9872-0af9f952430a} calWcapCalendarModule.js</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-contract @mozilla.org/calendar/wcap/network-request;1 {e3c62b37-83cf-41ec-9872-0af9f952430a}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,501 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-/* exported checkErrorCode, checkWcapXmlErrno, checkWcapIcalErrno,</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">- *          errorToString</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">- */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-/* import-globals-from calWcapCalendarModule.js */</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-var NS_ERROR_INVALID_ARG = Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-//</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-// Common netwerk errors:</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-//</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-var NS_ERROR_MODULE_BASE_OFFSET = 0x45;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-var NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-function generateFailure(module, code) {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  // 1&lt;&lt;31 generates negative number, so use literal, don't use logical operators:</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  return 0x80000000 + ((module + NS_ERROR_MODULE_BASE_OFFSET) &lt;&lt; 16) + code;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-}</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-function generateNetFailure(code) {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  return generateFailure(NS_ERROR_MODULE_NETWORK, code);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-}</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-function getResultCode(err) {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  if (err === undefined || err === null) {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  }</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-  if (isNaN(err)) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    return err instanceof nsIException ? err.result : Cr.NS_ERROR_FAILURE;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-  }</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  return err;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-}</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-function getErrorModule(err) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  let rc = getResultCode(err);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  return ((rc &gt;&gt;&gt; 16) &amp; 0x7fff) - NS_ERROR_MODULE_BASE_OFFSET;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-}</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-function checkErrorCode(err, rcBits, maskBits) {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  if (!maskBits) {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    maskBits = 0;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  }</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  let rc = getResultCode(err);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  return (rc ^ rcBits) &gt;&gt;&gt; maskBits == 0;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-}</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-// Cannot perform operation, because user is offline.</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-// The following error codes have been adopted from</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-// xpcom/base/nsError.h</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-// and ought to be defined in IDL. xxx todo</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-// The requested action could not be completed while the networking</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-// is in the offline state.</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-var NS_ERROR_OFFLINE = generateNetFailure(16);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-var NS_BINDING_FAILED = generateNetFailure(1);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-var NS_BINDING_ABORTED = generateNetFailure(2);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-var NS_BINDING_REDIRECTED = generateNetFailure(3);</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-var NS_BINDING_RETARGETED = generateNetFailure(4);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-var g_nsNetErrorCodes = [</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  NS_BINDING_FAILED,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  &quot;The async request failed for some unknown reason.&quot;,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  NS_BINDING_ABORTED,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  &quot;The async request failed because it was aborted by some user action.&quot;,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  NS_BINDING_REDIRECTED,</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  &quot;The async request has been redirected to a different async request.&quot;,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-  NS_BINDING_RETARGETED,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  &quot;The async request has been retargeted to a different handler.&quot;,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-  /* NS_ERROR_MALFORMED_URI */ generateNetFailure(10),</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-  &quot;The URI is malformed.&quot;,</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  /* NS_ERROR_UNKNOWN_PROTOCOL */ generateNetFailure(18),</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-  &quot;The URI scheme corresponds to an unknown protocol handler.&quot;,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-  /* NS_ERROR_CONNECTION_REFUSED */ generateNetFailure(13),</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  &quot;The connection attempt failed, for example, because no server was listening at specified host:port.&quot;,</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  /* NS_ERROR_PROXY_CONNECTION_REFUSED */ generateNetFailure(72),</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-  &quot;The connection attempt to a proxy failed.&quot;,</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-  /* NS_ERROR_NET_TIMEOUT */ generateNetFailure(14),</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-  &quot;The connection was lost due to a timeout error.&quot;,</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  NS_ERROR_OFFLINE,</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  &quot;The requested action could not be completed while the networking library is in the offline state.&quot;,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-  /* NS_ERROR_PORT_ACCESS_NOT_ALLOWED */ generateNetFailure(19),</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  &quot;The requested action was prohibited because it would have caused the networking library to establish a connection to an unsafe or otherwise banned port.&quot;,</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-  /* NS_ERROR_NET_RESET */ generateNetFailure(20),</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-  &quot;The connection was established, but no data was ever received.&quot;,</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-  /* NS_ERROR_NET_INTERRUPT */ generateNetFailure(71),</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-  &quot;The connection was established, but the data transfer was interrupted.&quot;,</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-  /* NS_ERROR_NOT_RESUMABLE */ generateNetFailure(25),</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-  &quot;This request is not resumable, but it was tried to resume it, or to request resume-specific data.&quot;,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-  /* NS_ERROR_ENTITY_CHANGED */ generateNetFailure(32),</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  &quot;It was attempted to resume the request, but the entity has changed in the meantime.&quot;,</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  /* NS_ERROR_REDIRECT_LOOP */ generateNetFailure(31),</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  &quot;The request failed as a result of a detected redirection loop.&quot;,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-  /* NS_ERROR_UNKNOWN_HOST */ generateNetFailure(30),</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  &quot;The lookup of a hostname failed. This generally refers to the hostname from the URL being loaded.&quot;,</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-  /* NS_ERROR_UNKNOWN_PROXY_HOST */ generateNetFailure(42),</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-  &quot;The lookup of a proxy hostname failed.&quot;,</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  /* NS_ERROR_UNKNOWN_SOCKET_TYPE */ generateNetFailure(51),</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-  &quot;The specified socket type does not exist.&quot;,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-  /* NS_ERROR_SOCKET_CREATE_FAILED */ generateNetFailure(52),</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  &quot;The specified socket type could not be created.&quot;,</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-];</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-function netErrorToString(rc) {</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-  if (!isNaN(rc) &amp;&amp; getErrorModule(rc) == NS_ERROR_MODULE_NETWORK) {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-    let i = 0;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-    while (i &lt; g_nsNetErrorCodes.length) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-      // however rc is kept unsigned, our generated code signed,</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-      // so == won't work here:</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-      if ((g_nsNetErrorCodes[i] ^ rc) == 0) {</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-        return g_nsNetErrorCodes[i + 1];</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-      }</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-      i += 2;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    }</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-  }</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-  throw new Components.Exception(</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-    &quot;No known network error code: &quot; + rc.toString(0x10),</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-    NS_ERROR_INVALID_ARG</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-  );</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-}</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-//</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-// WCAP error handling helpers</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-//</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-var g_wcapErrorCodes = [</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-  /* -1 */ NS_OK,</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  &quot;Logout successful.&quot;,</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  /*  0 */ NS_OK,</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  &quot;Command successful.&quot;,</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  /*  1 */ calIWcapErrors.WCAP_LOGIN_FAILED,</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-  getWcapString(&quot;loginFailed.text&quot;),</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-  /*  2 */ calIWcapErrors.WCAP_LOGIN_OK_DEFAULT_CALENDAR_NOT_FOUND,</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-  &quot;login.wcap was successful, but the default calendar for this user was not found. A new default calendar set to the userid was created.&quot;,</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-  /*  3 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-  /*  4 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-  /*  5 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-  /*  6 */ calIWcapErrors.WCAP_DELETE_EVENTS_BY_ID_FAILED,</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  &quot;WCAP_DELETE_EVENTS_BY_ID_FAILED&quot;,</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-  /*  7 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-  /*  8 */ calIWcapErrors.WCAP_SETCALPROPS_FAILED,</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-  &quot;WCAP_SETCALPROPS_FAILED&quot;,</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  /*  9 */ calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED,</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-  &quot;WCAP_FETCH_EVENTS_BY_ID_FAILED&quot;,</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-  /* 10 */ calIWcapErrors.WCAP_CREATECALENDAR_FAILED,</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  &quot;WCAP_CREATECALENDAR_FAILED&quot;,</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-  /* 11 */ calIWcapErrors.WCAP_DELETECALENDAR_FAILED,</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-  &quot;WCAP_DELETECALENDAR_FAILED&quot;,</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-  /* 12 */ calIWcapErrors.WCAP_ADDLINK_FAILED,</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-  &quot;WCAP_ADDLINK_FAILED&quot;,</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-  /* 13 */ calIWcapErrors.WCAP_FETCHBYDATERANGE_FAILED,</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-  &quot;WCAP_FETCHBYDATERANGE_FAILED&quot;,</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  /* 14 */ calIWcapErrors.WCAP_STOREEVENTS_FAILED,</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-  &quot;WCAP_STOREEVENTS_FAILED&quot;,</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-  /* 15 */ calIWcapErrors.WCAP_STORETODOS_FAILED,</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-  &quot;WCAP_STORETODOS_FAILED&quot;,</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-  /* 16 */ calIWcapErrors.WCAP_DELETE_TODOS_BY_ID_FAILED,</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-  &quot;WCAP_DELETE_TODOS_BY_ID_FAILED&quot;,</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-  /* 17 */ calIWcapErrors.WCAP_FETCH_TODOS_BY_ID_FAILED,</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-  &quot;WCAP_FETCH_TODOS_BY_ID_FAILED&quot;,</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-  /* 18 */ calIWcapErrors.WCAP_FETCHCOMPONENTS_FAILED_BAD_TZID,</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-  &quot;Command failed to find correct tzid. Applies to fetchcomponents_by_range.wcap, fetchevents_by_id.wcap, fetchtodos_by_id.wcap.&quot;,</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-  /* 19 */ calIWcapErrors.WCAP_SEARCH_CALPROPS_FAILED,</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-  &quot;WCAP_SEARCH_CALPROPS_FAILED&quot;,</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-  /* 20 */ calIWcapErrors.WCAP_GET_CALPROPS_FAILED,</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-  &quot;WCAP_GET_CALPROPS_FAILED&quot;,</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-  /* 21 */ calIWcapErrors.WCAP_DELETECOMPONENTS_BY_RANGE_FAILED,</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-  &quot;WCAP_DELETECOMPONENTS_BY_RANGE_FAILED&quot;,</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-  /* 22 */ calIWcapErrors.WCAP_DELETEEVENTS_BY_RANGE_FAILED,</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-  &quot;WCAP_DELETEEVENTS_BY_RANGE_FAILED&quot;,</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-  /* 23 */ calIWcapErrors.WCAP_DELETETODOS_BY_RANGE_FAILED,</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-  &quot;WCAP_DELETETODOS_BY_RANGE_FAILED&quot;,</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-  /* 24 */ calIWcapErrors.WCAP_GET_ALL_TIMEZONES_FAILED,</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-  &quot;WCAP_GET_ALL_TIMEZONES_FAILED&quot;,</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-  /* 25 */ calIWcapErrors.WCAP_CREATECALENDAR_ALREADY_EXISTS_FAILED,</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-  &quot;The command createcalendar.wcap failed. A calendar with that name already exists in the database.&quot;,</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  /* 26 */ calIWcapErrors.WCAP_SET_USERPREFS_FAILED,</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-  &quot;WCAP_SET_USERPREFS_FAILED&quot;,</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-  /* 27 */ calIWcapErrors.WCAP_CHANGE_PASSWORD_FAILED,</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  &quot;WCAP_CHANGE_PASSWORD_FAILED&quot;,</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-  /* 28 */ calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR,</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-  getWcapString(&quot;accessDenied.text&quot;),</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-  /* 29 */ calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST,</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-  &quot;Command failed. The requested calendar does not exist in the database.&quot;,</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-  /* 30 */ calIWcapErrors.WCAP_ILLEGAL_CALID_NAME,</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-  &quot;createcalendar.wcap failed. Invalid calid passed in.&quot;,</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-  /* 31 */ calIWcapErrors.WCAP_CANNOT_MODIFY_LINKED_EVENTS,</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-  &quot;storeevents.wcap failed. The event to modify was a linked event.&quot;,</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-  /* 32 */ calIWcapErrors.WCAP_CANNOT_MODIFY_LINKED_TODOS,</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-  &quot;storetodos.wcap failed. The todo to modify was a linked todo.&quot;,</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-  /* 33 */ calIWcapErrors.WCAP_CANNOT_SENT_EMAIL,</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-  &quot;Command failed. Email notification failed. Usually caused by the server not being properly configured to send email. This can occur in storeevents.wcap, storetodos.wcap, deleteevents_by_id.wcap, deletetodos_by_id.wcap.&quot;,</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-  /* 34 */ calIWcapErrors.WCAP_CALENDAR_DISABLED,</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-  &quot;Command failed. The calendar is disabled in the database.&quot;,</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-  /* 35 */ calIWcapErrors.WCAP_WRITE_IMPORT_FAILED,</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-  &quot;Import failed when writing files to the server.&quot;,</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-  /* 36 */ calIWcapErrors.WCAP_FETCH_BY_LAST_MODIFIED_FAILED,</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-  &quot;WCAP_FETCH_BY_LAST_MODIFIED_FAILED&quot;,</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-  /* 37 */ calIWcapErrors.WCAP_CAPI_NOT_SUPPORTED,</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-  &quot;Failed trying to read from unsupported format calendar data.&quot;,</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-  /* 38 */ calIWcapErrors.WCAP_CALID_NOT_SPECIFIED,</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-  &quot;Calendar ID was not specified.&quot;,</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-  /* 39 */ calIWcapErrors.WCAP_GET_FREEBUSY_FAILED,</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-  &quot;WCAP_GET_FREEBUSY_FAILED&quot;,</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-  /* 40 */ calIWcapErrors.WCAP_STORE_FAILED_DOUBLE_BOOKED,</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-  &quot;If double booking is not allowed in this calendar, storeevents.wcap fails with this error when attempting to store an event in a time slot that was already filled.&quot;,</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-  /* 41 */ calIWcapErrors.WCAP_FETCH_BY_ALARM_RANGE_FAILED,</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-  &quot;WCAP_FETCH_BY_ALARM_RANGE_FAILED&quot;,</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-  /* 42 */ calIWcapErrors.WCAP_FETCH_BY_ATTENDEE_ERROR_FAILED,</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-  &quot;WCAP_FETCH_BY_ATTENDEE_ERROR_FAILED&quot;,</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-  /* 43 */ calIWcapErrors.WCAP_ATTENDEE_GROUP_EXPANSION_CLIPPED,</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-  &quot;An LDAP group being expanded was too large and exceeded the maximum number allowed in an expansion. The expansion stopped at the specified maximum limit. The maximum limit defaults to 200. To change the maximum limit, set the server configuration preference calstore.group.attendee.maxsize.&quot;,</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-  /* 44 */ calIWcapErrors.WCAP_USERPREFS_ACCESS_DENIED,</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-  &quot;Either the server does not allow this administrator access to get or modify user preferences, or the requester is not an administrator.&quot;,</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-  /* 45 */ calIWcapErrors.WCAP_NOT_ALLOWED_TO_REQUEST_PUBLISH,</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-  &quot;The requester was not an organizer of the event, and, therefore, is not allowed to edit the component using the PUBLISH or REQUEST method.&quot;,</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-  /* 46 */ calIWcapErrors.WCAP_INSUFFICIENT_PARAMETERS,</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-  &quot;The caller tried to invoke verifyevents_by_ids.wcap, or verifytodos_by_ids.wcap with insufficient arguments (mismatched number of uid's and rid's).&quot;,</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-  /* 47 */ calIWcapErrors.WCAP_MUSTBEOWNER_OPERATION,</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-  &quot;The user needs to be an owner or co-owner of the calendar in questions to complete this operation. (Probably related to private or confidential component.)&quot;,</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-  /* 48 */ calIWcapErrors.WCAP_DWP_CONNECTION_FAILED,</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-  &quot;GSE scheduling engine failed to make connection to DWP.&quot;,</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-  /* 49 */ calIWcapErrors.WCAP_DWP_MAX_CONNECTION_REACHED,</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-  &quot;Reached the maximum number of connections. When some of the connections are freed, users can successfully connect. Same as error 11001.&quot;,</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-  /* 50 */ calIWcapErrors.WCAP_DWP_CANNOT_RESOLVE_CALENDAR,</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-  &quot;Front end can't resolve to a particular back end. Same as error 11002.&quot;,</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-  /* 51 */ calIWcapErrors.WCAP_DWP_BAD_DATA,</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-  &quot;Generic response. Check all DWP servers. One might be down. Same as error 11003.&quot;,</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-  /* 52 */ calIWcapErrors.WCAP_BAD_COMMAND,</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-  &quot;The command sent in was not recognized. This is an internal only error code. It should not appear in the error logs.&quot;,</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-  /* 53 */ calIWcapErrors.WCAP_NOT_FOUND,</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-  &quot;Returned for all errors from a write to the Berkeley DB. This is an internal only error code. It should not appear in the error logs.&quot;,</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-  /* 54 */ calIWcapErrors.WCAP_WRITE_IMPORT_CANT_EXPAND_CALID,</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-  &quot;Can't expand calid when importing file.&quot;,</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-  /* 55 */ calIWcapErrors.WCAP_GETTIME_FAILED,</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-  &quot;Get server time failed.&quot;,</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-  /* 56 */ calIWcapErrors.WCAP_FETCH_DELETEDCOMPONENTS_FAILED,</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-  &quot;fetch_deletedcomponents.wcap failed.&quot;,</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-  /* 57 */ calIWcapErrors.WCAP_FETCH_DELETEDCOMPONENTS_PARTIAL_RESULT,</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-  &quot;Success but partial result.&quot;,</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-  /* 58 */ calIWcapErrors.WCAP_WCAP_NO_SUCH_FORMAT,</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-  &quot;Returned in any of the commands when supplied fmt-out is not a supported format.&quot;,</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-  /* 59 */ calIWcapErrors.WCAP_COMPONENT_NOT_FOUND,</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-  &quot;Returned when a fetch or delete is attempted that does not exist.&quot;,</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-  /* 60 */ calIWcapErrors.WCAP_BAD_ARGUMENTS,</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-  &quot;Currently used when attendee or organizer specified does not have a valid email address.&quot;,</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-  /* 61 */ calIWcapErrors.WCAP_GET_USERPREFS_FAILED,</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-  &quot;get_userprefs.wcap failed. The following error conditions returns error code 61: LDAP access denied, no results found, LDAP limit exceeded, LDAP connection failed.&quot;,</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-  /* 62 */ calIWcapErrors.WCAP_WCAP_MODIFY_NO_EVENT,</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-  &quot;storeevents.wcap issued with storetype set to 2 (WCAP_STORE_TYPE_MODIFY) and the event doesn't exist.&quot;,</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-  /* 63 */ calIWcapErrors.WCAP_WCAP_CREATE_EXISTS,</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-  &quot;storeevents.wcap issued with storetype set to 1 (WCAP_STORE_TYPE_CREATE) and the event already exists.&quot;,</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-  /* 64 */ calIWcapErrors.WCAP_WCAP_MODIFY_CANT_MAKE_COPY,</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-  &quot;storevents.wcap issued and copy of event failed during processing.&quot;,</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-  /* 65 */ calIWcapErrors.WCAP_STORE_FAILED_RECUR_SKIP,</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-  &quot;One instance of a recurring event skips over another.&quot;,</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-  /* 66 */ calIWcapErrors.WCAP_STORE_FAILED_RECUR_SAMEDAY,</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-  &quot;Two instances of a recurring event can't occur on the same day.&quot;,</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-  /* 67 */ calIWcapErrors.WCAP_BAD_ORG_ARGUMENTS,</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-  'Bad organizer arguments. orgCalid or orgEmail must be passed if any other &quot;org&quot; parameter is sent. That is, orgUID can\'t be sent alone on a storeevents.wcap or a storetodos.wcao command if it is trying about to &quot;create&quot; the event or task. Note, if no &quot;org&quot; information is passed, the organizer defaults to the calid being passed with the command.',</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-  /* 68 */ calIWcapErrors.WCAP_STORE_FAILED_RECUR_PRIVACY,</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-  &quot;Error returned if you try to change the privacy or transparency of a single instance in a recurring series.&quot;,</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-  /* 69 */ calIWcapErrors.WCAP_LDAP_ERROR,</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-  &quot;For get_calprops.wcap, when there is an error is getting LDAP derived token values (X-S1CS-CALPROPS-FB-INCLUDE, X-S1CS-CALPROPS-COMMON-NAME).&quot;,</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-  /* 70 */ calIWcapErrors.WCAP_GET_INVITE_COUNT_FAILED,</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-  &quot;Error in getting invite count (for get_calprops.wcap and fetchcomponents_by_range.wcap commands).&quot;,</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-  /* 71 */ calIWcapErrors.WCAP_LIST_FAILED,</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-  &quot;list.wcap failed.&quot;,</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-  /* 72 */ calIWcapErrors.WCAP_LIST_SUBSCRIBED_FAILED,</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-  &quot;list_subscribed.wcap failed.&quot;,</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-  /* 73 */ calIWcapErrors.WCAP_SUBSCRIBE_FAILED,</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-  &quot;subscribe.wcap failed.&quot;,</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-  /* 74 */ calIWcapErrors.WCAP_UNSUBSCRIBE_FAILED,</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-  &quot;unsubscribe.wcap failed.&quot;,</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-  /* 75 */ calIWcapErrors.WCAP_ANONYMOUS_NOT_ALLOWED,</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-  &quot;Command cannot be executed as anonymous. Used only for list.wcap, list_subscribed.wcap, subscribe.wcap, and unsubscribe.wcap commands.&quot;,</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-  /* 76 */ calIWcapErrors.WCAP_ACCESS_DENIED,</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-  &quot;Generated if a non-administrator user tries to read or set the calendar-owned list or the calendar-subscribed list of some other user, or if the option is not turned on in the server.&quot;,</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-  /* 77 */ calIWcapErrors.WCAP_BAD_IMPORT_ARGUMENTS,</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-  &quot;Incorrect parameter received by import.wcap.&quot;,</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-  /* 78 */ calIWcapErrors.WCAP_READONLY_DATABASE,</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-  &quot;Database is in read-only mode (returned for all attempts to write to the database).&quot;,</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-  /* 79 */ calIWcapErrors.WCAP_ATTENDEE_NOT_ALLOWED_TO_REQUEST_ON_MODIFY,</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-  &quot;Attendee is not allowed to modify an event with method=request.&quot;,</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-  /* 80 */ calIWcapErrors.WCAP_TRANSP_RESOURCE_NOT_ALLOWED,</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-  &quot;Resources do not permit the transparency parameter.&quot;,</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-  /* 81 */ calIWcapErrors.WCAP_RECURRING_COMPONENT_NOT_FOUND,</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-  &quot;Recurring component not found. Only happens when recurring=1 is passed in by fetch commands. This code is returned if part of the recurring series (either the master or an exception) is missing.&quot;,</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-  /* new by WCAP 4.0: */</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-  /* 82 */ calIWcapErrors.WCAP_BAD_MIME_TYPE,</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-  &quot;The mime headers supplied while storing the attachment using storeevents.wcap/storetodos.wcap is malformatted.&quot;,</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-  /* 83 */ calIWcapErrors.WCAP_MISSING_BOUNDARY,</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-  &quot;While supplying attachments to the storeveents/storetodos commands the mime boundary was not found.&quot;,</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-  /* 84 */ calIWcapErrors.WCAP_INVALID_ATTACHMENT,</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-  &quot;The attachment supplied to be stored on the server is malformatted.&quot;,</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-  /* 85 */ calIWcapErrors.WCAP_ATTACH_DELETE_SUCCESS,</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-  &quot;All the attachments requested to be deleted from the server by supplying deleteattach were deleted successsfully.&quot;,</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-  /* 86 */ calIWcapErrors.WCAP_ATTACH_DELETE_PARTIAL,</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-  &quot;Of All attachments requested to be deleted from the server by supplying deleteattach , only few were deleted successfully.&quot;,</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-  /* 87 */ calIWcapErrors.WCAP_ATTACHMENT_NOT_FOUND,</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-  &quot;The attachent requested to be fetched or deleted from the server was not found.&quot;,</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-  /* / new by WCAP 4.0 */</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-  /* 88 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-  /* 89 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineminus">-  /* 90 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-  /* 91 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-  /* 92 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-  /* 93 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-  /* 94 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-  /* 95 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-  /* 96 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-  /* 97 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-  /* 98 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-  /* 99 */ NS_ERROR_INVALID_ARG,</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-  &quot;No WCAP error code.&quot;,</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-  /* 11000 */ calIWcapErrors.WCAP_CDWP_ERR_MAX_CONNECTION_REACHED,</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-  &quot;Maximum connections to back-end database reached. As connections are freed up, users can connect to the back-end.&quot;,</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-  /* 11001 */ calIWcapErrors.WCAP_CDWP_ERR_CANNOT_CONNECT,</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-  &quot;Cannot connect to back-end server. Back-end machine might be down or DWP server is not up and running.&quot;,</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-  /* 11002 */ calIWcapErrors.WCAP_CDWP_ERR_CANNOT_RESOLVE_CALENDAR,</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-  &quot;Front-end can't resolve calendar to a particular back-end server.&quot;,</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-  /* 11003 */ calIWcapErrors.WCAP_CDWP_ERR_BAD_DATA,</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-  &quot;Bad data received from DWP connection. This is a generic formatting error. Check all DWP servers. One might be down.&quot;,</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-  /* 11004 */ calIWcapErrors.WCAP_CDWP_ERR_DWPHOST_CTX_DOES_NOT_EXIST,</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineminus">-  &quot;For the back-end host, context doesn't exist in the context table.&quot;,</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineminus">-  /* 11005 */ calIWcapErrors.WCAP_CDWP_ERR_HOSTNAME_NOT_RESOLVABLE,</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-  &quot;DNS or NIS files, or hostname resolver is not set up properly or machine does not exist.&quot;,</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-  /* 11006 */ calIWcapErrors.WCAP_CDWP_ERR_NO_DATA,</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-  &quot;No data was received from reading the calendar properties from the DWP connection.&quot;,</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-  /* 11007 */ calIWcapErrors.WCAP_CDWP_ERR_AUTH_FAILED,</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-  &quot;DWP authentication failed.&quot;,</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-  /* 11008 */ calIWcapErrors.WCAP_CDWP_ERR_CHECKVERSION_FAILED,</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-  &quot;DWP version check failed.&quot;,</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineminus">-];</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineminus">-</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-function wcapErrorToString(rc) {</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-  if (isNaN(rc)) {</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-    throw new Components.Exception(</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-      &quot;No known WCAP error code: &quot; + rc.toString(0x10),</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-      NS_ERROR_INVALID_ARG</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-    );</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-  }</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-  if (rc == calIWcapErrors.WCAP_NO_ERRNO) {</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-    return &quot;No WCAP errno (missing X-NSCP-WCAP-ERRNO).&quot;;</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-  }</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineminus">-  let index = rc - calIWcapErrors.WCAP_ERROR_BASE + 1;</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineminus">-  if (index &gt;= 1 &amp;&amp; index &lt;= 108 &amp;&amp; g_wcapErrorCodes[index * 2] != NS_ERROR_INVALID_ARG) {</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineminus">-    return g_wcapErrorCodes[index * 2 + 1];</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-  }</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-  throw new Components.Exception(</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-    &quot;No known WCAP error code: &quot; + rc.toString(0x10),</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-    NS_ERROR_INVALID_ARG</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-  );</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-}</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineminus">-</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-function getWcapErrorCode(errno) {</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-  if (errno == -5000) {</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-    // semantically same error</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineminus">-    errno = 59;</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineminus">-  }</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">-  let index = -1;</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-  if (errno &gt;= -1 &amp;&amp; errno &lt;= 81) {</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-    index = errno + 1;</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-  } else if (errno &gt;= 11000 &amp;&amp; errno &lt;= 11008) {</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-    index = errno - 11000 + 100 + 1;</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-  }</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-  if (index &gt;= 0 &amp;&amp; g_wcapErrorCodes[index * 2] != NS_ERROR_INVALID_ARG) {</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-    return g_wcapErrorCodes[index * 2];</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineminus">-  }</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-  throw new Components.Exception(&quot;No known WCAP error no: &quot; + errno, NS_ERROR_INVALID_ARG);</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineminus">-}</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-function getWcapXmlErrno(xml) {</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-  let elem = xml.getElementsByTagName(&quot;X-NSCP-WCAP-ERRNO&quot;);</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-  if (elem) {</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-    elem = elem.item(0);</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-    if (elem) {</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-      return parseInt(elem.textContent, 10);</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-    }</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-  }</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-  // some commands just respond with an empty calendar, no errno. WTF.</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineminus">-  // assume success:</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-  return undefined;</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-}</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-function getWcapIcalErrno(icalRootComp) {</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-  let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-ERRNO&quot;);</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-  if (prop) {</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-    return parseInt(prop.value, 10);</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-  }</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-  // some commands just respond with an empty calendar, no errno. WTF.</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineminus">-  // assume success:</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineminus">-  return undefined;</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineminus">-}</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-function checkWcapErrno(errno, expectedErrno) {</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-  if (expectedErrno === undefined) {</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-    expectedErrno = 0; // i.e. Command successful.</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-  }</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-  if (errno !== undefined &amp;&amp; errno != expectedErrno) {</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-    let rc = getWcapErrorCode(errno);</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-    throw new Components.Exception(wcapErrorToString(rc), rc);</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-  }</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-}</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineminus">-function checkWcapXmlErrno(xml, expectedErrno) {</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineminus">-  checkWcapErrno(getWcapXmlErrno(xml), expectedErrno);</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineminus">-}</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-function checkWcapIcalErrno(icalRootComp, expectedErrno) {</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-  checkWcapErrno(getWcapIcalErrno(icalRootComp), expectedErrno);</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-}</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineminus">-</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-function errorToString(err) {</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineminus">-  if (err) {</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-    if (typeof err == &quot;string&quot;) {</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineminus">-      return err;</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-    }</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-    if (err instanceof Error) {</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-      return err.message;</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-    }</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineminus">-    if (err instanceof nsIException) {</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineminus">-      return err.toString(); // xxx todo: or just message?</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-    }</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineminus">-    if (isNaN(err)) {</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-      return &quot;[&quot; + err + &quot;] unknown error.&quot;;</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-    }</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-  }</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-  // numeric codes:</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-  switch (err) {</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-    case undefined:</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineminus">-    case null:</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineminus">-    case NS_OK:</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineminus">-      return &quot;NS_OK&quot;;</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineminus">-    case NS_ERROR_INVALID_ARG:</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineminus">-      return &quot;NS_ERROR_INVALID_ARG&quot;;</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-    case Cr.NS_ERROR_NO_INTERFACE:</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineminus">-      return &quot;NS_ERROR_NO_INTERFACE&quot;;</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-    case Cr.NS_ERROR_NOT_IMPLEMENTED:</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-      return &quot;NS_ERROR_NOT_IMPLEMENTED&quot;;</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-    case Cr.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-      return &quot;NS_ERROR_NOT_AVAILABLE&quot;;</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-    case Cr.NS_ERROR_FAILURE:</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineminus">-      return &quot;NS_ERROR_FAILURE&quot;;</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineminus">-    case Cr.NS_ERROR_BASE:</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineminus">-      return &quot;NS_ERROR_BASE&quot;;</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineminus">-    case Cr.NS_ERROR_NOT_INITIALIZED:</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineminus">-      return &quot;NS_ERROR_NOT_INITIALIZED&quot;;</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-    case Cr.NS_ERROR_ALREADY_INITIALIZED:</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-      return &quot;NS_ERROR_ALREADY_INITIALIZED&quot;;</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineminus">-    case Cr.NS_ERROR_NULL_POINTER:</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineminus">-      return &quot;NS_ERROR_NULL_POINTER&quot;;</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineminus">-    case Cr.NS_ERROR_ABORT:</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-      return &quot;NS_ERROR_ABORT&quot;;</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-    case Cr.NS_ERROR_UNEXPECTED:</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineminus">-      return &quot;NS_ERROR_UNEXPECTED&quot;;</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-    case Cr.NS_ERROR_OUT_OF_MEMORY:</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-      return &quot;NS_ERROR_OUT_OF_MEMORY&quot;;</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-    case Cr.NS_ERROR_ILLEGAL_VALUE:</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-      return &quot;NS_ERROR_ILLEGAL_VALUE&quot;;</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-    default:</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineminus">-      // probe for WCAP error:</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineminus">-      try {</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-        return wcapErrorToString(err);</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineminus">-      } catch (exc) {</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineminus">-        // probe for netwerk error:</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineminus">-        try {</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineminus">-          return netErrorToString(err);</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineminus">-        } catch (exc2) {</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineminus">-          if (err &amp; calIErrors.ERROR_BASE) {</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-            for (let err_ in calIErrors) {</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-              if (calIErrors[err_] == err) {</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineminus">-                return err_;</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineminus">-              }</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-            }</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-          }</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-          return &quot;[0x&quot; + err.toString(0x10) + &quot;] unknown error.&quot;;</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-        }</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineminus">-      }</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineminus">-  }</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,459 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-/**</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-   A request object is used to track an async action.</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-   While the action is running, isPending is true.</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-   Functions issuing an async action usually take a response function along</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-   with their parameters, typically named respFunc.</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-   That function is called *after* the action has ended (i.e. isPending of the</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-   issued action/request is false when called, status remains stable).</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-   The response function gets the ended request as first parameter to check</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-   whether the request has been successful and get its data.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-   The request function itself may return either</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-   - a further calIOperation request object, i.e. an async continuation</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-   - some data (incl null/undefined) which is the result of the async function,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-     indicating that there is no further continuation</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-*/</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-/* exported issueNetworkRequest, getWcapRequestStatusString, stringToIcal, stringToXml */</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-/* import-globals-from calWcapCalendarModule.js */</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-function generateRequestId() {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  if (!generateRequestId.mRequestPrefix) {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    generateRequestId.mRequestPrefix = cal.getUUID() + &quot;-&quot;;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    generateRequestId.mRequestId = 0;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  }</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  ++generateRequestId.mRequestId;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  return generateRequestId.mRequestPrefix + generateRequestId.mRequestId;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-}</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-function calWcapRequest(respFunc, logContext) {</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  this.m_logContext = logContext;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  this.m_id = generateRequestId();</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-  this.m_isPending = true;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-  this.m_status = NS_OK;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-  this.m_respFunc = respFunc;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  this.m_attachedRequests = [];</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-}</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-calWcapRequest.prototype = {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  m_logContext: null,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  m_parentRequest: null,</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  m_id: 0,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-  m_isPending: true,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-  m_status: NS_OK,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-  m_respFunc: null,</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-  m_attachedRequests: null,</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-  m_locked: false,</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-  get parentRequest() {</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-    return this.m_parentRequest;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-  },</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-  set parentRequest(req) {</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-    if (this.parentRequest) {</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-      logError(&quot;already has parent!&quot;, this);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-    }</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-    this.detachFromParent(); // detach without error</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    return (this.m_parentRequest = req);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  },</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-  /** The following locking is necessary when scheduling multiple async</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-        requests; one cannot be sure that e.g. the first completes quickly</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-        and responds the whole parent request when detaching.</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-    */</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  lockPending: function() {</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-    this.m_locked = true;</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-  },</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  unlockPending: function() {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-    if (this.m_locked) {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-      this.m_locked = false;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-      // assures that respFunc is executed:</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-      if (this.m_attachedRequests.length == 0) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-        this.execRespFunc();</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-      }</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-    }</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-  },</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  toString: function() {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-    let ret =</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-      &quot;calWcapRequest id=&quot; +</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-      this.id +</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-      &quot;, parent-id=&quot; +</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-      (this.parentRequest ? this.parentRequest.id : &quot;&lt;none&gt;&quot;) +</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-      &quot; (&quot; +</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-      this.m_logContext +</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-      &quot;)&quot;;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-    if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_attachedRequests.length &gt; 0) {</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-      ret += &quot;\nattached requests:&quot;;</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-      for (let req of this.m_attachedRequests) {</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-        ret += &quot;\n#&quot; + req.id + &quot;\t&quot; + req;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-      }</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    }</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    ret += &quot;, isPending=&quot; + this.isPending;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-    ret += &quot;, status=&quot; + errorToString(this.status);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-    return ret;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-  },</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-  attachSubRequest: function(req) {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-    if (req) {</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-      if (this.m_attachedRequests.some(req_ =&gt; req.id == req_.id)) {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-        logError(&quot;request already attached: &quot; + req.id, this);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-      } else if (req.isPending) {</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-        this.m_attachedRequests.push(req);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-        req.parentRequest = this;</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-        log(&quot;attachSubRequest()&quot;, this);</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-      } else if (!this.m_locked &amp;&amp; this.m_attachedRequests.length == 0) {</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-        this.execRespFunc(req.status);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-      }</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-    }</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  },</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-  detachSubRequest: function(req, err) {</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-    this.m_attachedRequests = this.m_attachedRequests.filter(req_ =&gt; req.id != req_.id);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-    if (err) {</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-      // first failing sub request stops parent request:</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-      this.execRespFunc(err);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-    } else if (!this.m_locked &amp;&amp; this.m_attachedRequests.length == 0) {</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-      // assures that respFunc is executed after all sub requests have been completed:</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-      this.execRespFunc();</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-    }</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-  },</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-  cancelAllSubRequests: function(status) {</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-    let attachedRequests = this.m_attachedRequests;</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-    this.m_attachedRequests = [];</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-    attachedRequests.forEach(req =&gt; req.cancel(null));</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  },</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-  detachFromParent: function(err) {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-    let parentRequest = this.m_parentRequest;</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-    if (parentRequest) {</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-      this.m_parentRequest = null;</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-      parentRequest.detachSubRequest(this, err);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-    }</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-  },</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  execRespFunc: function(err, data) {</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-    if (this.isPending) {</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-      this.m_isPending = false;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-      if (err) {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-        this.m_status = err;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-      }</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-      this.cancelAllSubRequests();</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-      let respFunc = this.m_respFunc;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-      if (respFunc) {</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-        this.m_respFunc = null; // call once only</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-        if (LOG_LEVEL &gt; 2) {</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-          log(&quot;response exec: &quot; + errorToString(err), this);</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-        }</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-        try {</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-          respFunc(this, err, data);</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-        } catch (exc) {</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-          this.m_status = exc;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-          // don't pump into error console, may be handled:</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-          log(&quot;error: &quot; + errorToString(exc), this);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-        }</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-      }</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-      this.detachFromParent(this.m_status);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-    }</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-  },</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-  execSubRespFunc: function(func, err, data) {</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-    try {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-      func(err, data);</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-    } catch (exc) {</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-      this.execRespFunc(exc);</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-    }</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-  },</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-  // calIOperation:</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-  get id() {</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-    return this.m_id;</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-  },</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-  get isPending() {</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-    return this.m_isPending;</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-  },</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  get status() {</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-    return this.m_status === null ? NS_OK : this.m_status;</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-  },</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineminus">-</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-  cancel: function(status) {</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-    if (!status) {</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-      status = calIErrors.OPERATION_CANCELLED;</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-    }</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-    this.execRespFunc(status);</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-  },</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-};</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-function calWcapNetworkRequest(url, respFunc, bLogging) {</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-  this.m_id = generateRequestId();</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-  this.m_url = url;</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-  this.m_respFunc = respFunc;</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-  this.m_bLogging = bLogging === undefined ? true : bLogging;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-}</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-var calWcapNetworkRequestClassID = Components.ID(&quot;{e3c62b37-83cf-41ec-9872-0af9f952430a}&quot;);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-var calWcapNetworkRequestInterfaces = [</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-  Ci.nsIInterfaceRequestor,</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-  Ci.nsIChannelEventSink,</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-  Ci.calIOperation,</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-];</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-calWcapNetworkRequest.prototype = {</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-  m_id: 0,</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-  m_url: null,</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-  m_loader: null,</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-  m_respFunc: null,</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-  m_bLogging: false,</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-  classID: calWcapNetworkRequestClassID,</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-  QueryInterface: cal.generateQI(calWcapNetworkRequestInterfaces),</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineminus">-  classInfo: cal.generateCI({</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineminus">-    classID: calWcapNetworkRequestClassID,</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/wcap/network-request;1&quot;,</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineminus">-    classDescription: &quot;Sun Java System Calendar Server WCAP Network Request&quot;,</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-    interfaces: calWcapNetworkRequestInterfaces,</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-  }),</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-  /**</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-   * @see nsIInterfaceRequestor</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-   * @see calProviderUtils.jsm</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-   */</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-  getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-  /**</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-   * prepareChannel</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-   * Prepares the passed channel to match this objects properties</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-   *</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-   * @param aChannel    The Channel to be prepared</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-   */</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-  prepareChannel: function(aChannel) {</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-    // No caching</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-    aChannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-    aChannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-    aChannel.requestMethod = &quot;GET&quot;;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineminus">-  },</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineminus">-</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-  /**</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-   * @see nsIChannelEventSink</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-   */</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineminus">-  asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-    // all we need to do to the new channel is the basic preparation</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-    this.prepareChannel(aNewChannel);</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-    aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-  },</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-  onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineminus">-    this.m_loader = null;</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-    if (LOG_LEVEL &gt; 0 &amp;&amp; this.m_bLogging) {</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-      log(&quot;status: &quot; + errorToString(aStatus), this);</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineminus">-    }</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-    if (aStatus != Cr.NS_OK) {</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-      this.execRespFunc(aStatus);</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineminus">-      return;</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-    }</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineminus">-    let httpChannel = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineminus">-    let encoding = httpChannel.contentCharset || &quot;utf-8&quot;;</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineminus">-    let result = aResultLength ? new TextDecoder(encoding).decode(Uint8Array.from(aResult)) : &quot;&quot;;</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineminus">-</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineminus">-    if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_bLogging) {</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-      log(&quot;contentCharset = &quot; + encoding + &quot;\nrequest result:\n&quot; + result, this);</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-    }</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-    switch (httpChannel.responseStatus / 100) {</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-      case 2 /* 2xx codes */:</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineminus">-        // Everything worked out, we are done</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-        this.execRespFunc(aStatus, result);</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-        break;</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineminus">-      default: {</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineminus">-        // Something else went wrong</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineminus">-        let error =</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">-          &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-          httpChannel.responseStatus +</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">-          &quot; &quot; +</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">-          httpChannel.responseStatusText +</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-          &quot; Body: &quot; +</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-          result;</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-        this.execRespFunc(Components.Exception(error, NS_BINDING_FAILED));</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineminus">-        break;</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-      }</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineminus">-    }</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineminus">-  },</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">-</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">-  toString: function() {</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineminus">-    let ret =</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">-      &quot;calWcapNetworkRequest id=&quot; +</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">-      this.id +</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineminus">-      &quot;, parent-id=&quot; +</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-      (this.parentRequest ? this.parentRequest.id : &quot;&lt;none&gt;&quot;);</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-    if (this.m_bLogging) {</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-      ret += &quot; (&quot; + this.m_url + &quot;)&quot;;</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-    }</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-    ret += &quot;, isPending=&quot; + this.isPending;</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-    ret += &quot;, status=&quot; + errorToString(this.status);</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-    return ret;</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-  },</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineminus">-</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-  m_parentRequest: null,</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineminus">-  get parentRequest() {</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineminus">-    return this.m_parentRequest;</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineminus">-  },</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-  set parentRequest(req) {</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-    if (this.parentRequest) {</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-      logError(&quot;already has parent!&quot;, this);</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-    }</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineminus">-    this.detachFromParent(); // detach without error</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineminus">-    return (this.m_parentRequest = req);</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineminus">-  },</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineminus">-</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineminus">-  // calIOperation:</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineminus">-  get id() {</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineminus">-    return this.m_id;</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineminus">-  },</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineminus">-</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineminus">-  m_isPending: true,</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineminus">-  get isPending() {</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineminus">-    return this.m_isPending;</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineminus">-  },</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineminus">-</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineminus">-  get status() {</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineminus">-    return this.request ? this.request.status : NS_OK;</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineminus">-  },</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineminus">-</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineminus">-  detachFromParent: function(err) {</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineminus">-    let parentRequest = this.m_parentRequest;</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-    if (parentRequest) {</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineminus">-      this.m_parentRequest = null;</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineminus">-      parentRequest.detachSubRequest(this, err);</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineminus">-    }</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineminus">-  },</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineminus">-</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-  get request() {</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineminus">-    return this.m_loader ? this.m_loader.channel : null;</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineminus">-  },</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineminus">-</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineminus">-  cancel: function(status) {</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineminus">-    if (!status) {</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineminus">-      status = calIErrors.OPERATION_CANCELLED;</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineminus">-    }</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineminus">-    this.execRespFunc(status);</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineminus">-    // xxx todo: check whether this works on redirected channels!</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineminus">-    let request = this.request;</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineminus">-    if (request &amp;&amp; request.isPending()) {</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineminus">-      log(&quot;canceling netwerk request...&quot;, this);</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineminus">-      request.cancel(NS_BINDING_FAILED);</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineminus">-      this.m_loader = null;</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineminus">-    }</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineminus">-  },</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineminus">-</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-  execRespFunc: function(err, str) {</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-    if (this.isPending) {</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-      this.m_isPending = false;</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-      let respFunc = this.m_respFunc;</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-      if (respFunc) {</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineminus">-        this.m_respFunc = null; // call once only</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineminus">-        if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_bLogging) {</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineminus">-          log(&quot;response exec: &quot; + errorToString(err), this);</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineminus">-        }</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineminus">-        try {</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-          respFunc(err, str);</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-          err = null; // may have been handled</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineminus">-        } catch (exc) {</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineminus">-          // don't pump into error console, may be handled:</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineminus">-          log(&quot;error: &quot; + errorToString(exc), this);</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineminus">-          err = exc;</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-        }</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineminus">-      }</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-      this.detachFromParent(err);</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineminus">-    }</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineminus">-  },</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineminus">-</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineminus">-  execSubRespFunc: function(func, err, data) {</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineminus">-    try {</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineminus">-      func(err, data);</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineminus">-    } catch (exc) {</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineminus">-      this.execRespFunc(exc);</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineminus">-    }</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineminus">-  },</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-};</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineminus">-</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineminus">-function issueNetworkRequest(parentRequest, respFunc, url, bLogging) {</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineminus">-  let netRequest = new calWcapNetworkRequest(url, respFunc, bLogging);</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineminus">-  if (parentRequest) {</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineminus">-    parentRequest.attachSubRequest(netRequest);</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineminus">-  }</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineminus">-  try {</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineminus">-    let uri = Services.io.newURI(url);</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineminus">-    let channel = Services.io.newChannelFromURI(</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineminus">-      uri,</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineminus">-      null,</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineminus">-      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineminus">-      null,</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineminus">-      Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineminus">-      Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineminus">-    );</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineminus">-    netRequest.prepareChannel(channel);</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineminus">-    channel = channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineminus">-    channel.redirectionLimit = 3;</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineminus">-    channel.notificationCallbacks = netRequest;</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineminus">-    let loader = cal.provider.createStreamLoader();</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineminus">-    netRequest.m_loader = loader;</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineminus">-</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineminus">-    log(&quot;opening channel.&quot;, netRequest);</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineminus">-    loader.init(netRequest);</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineminus">-    channel.asyncOpen(loader);</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineminus">-  } catch (exc) {</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineminus">-    netRequest.execRespFunc(exc);</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-  }</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineminus">-}</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineminus">-</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-function getWcapRequestStatusString(xml) {</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineminus">-  let str = &quot;request status: &quot;;</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineminus">-  let items = xml.getElementsByTagName(&quot;RSTATUS&quot;);</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineminus">-  if (items != null &amp;&amp; items.length &gt; 0) {</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineminus">-    str += items.item(0).textContent;</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineminus">-  } else {</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineminus">-    str += &quot;none&quot;;</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineminus">-  }</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineminus">-  return str;</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineminus">-}</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineminus">-</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineminus">-function stringToIcal(session, data, expectedErrno) {</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineminus">-  if (!data || data.length == 0) {</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineminus">-    // assuming time-out; WTF.</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineminus">-    throw new Components.Exception(</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineminus">-      errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-      calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-    );</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineminus">-  }</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineminus">-  let icalRootComp;</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineminus">-  try {</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineminus">-    icalRootComp = cal</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-      .getIcsService()</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineminus">-      .parseICS(data, session /* implements calITimezoneProvider */);</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-  } catch (exc) {</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineminus">-    // map into more useful error string:</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineminus">-    throw new Components.Exception(&quot;error parsing ical data!&quot;, calIErrors.ICS_PARSE);</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineminus">-  }</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineminus">-  checkWcapIcalErrno(icalRootComp, expectedErrno);</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineminus">-  return icalRootComp;</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineminus">-}</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineminus">-function stringToXml(session, data, expectedErrno) {</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineminus">-  if (!data || data.length == 0) {</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineminus">-    // assuming time-out</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineminus">-    throw new Components.Exception(</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-      errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-      calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-    );</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-  }</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineminus">-  let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineminus">-  checkWcapXmlErrno(xml, expectedErrno);</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineminus">-  return xml;</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,1284 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-/* exported getWcapSessionFor */</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-/* import-globals-from calWcapCalendarModule.js */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-function calWcapTimezone(tzProvider, tzid_, component_) {</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  this.provider = tzProvider;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  this.icalComponent = component_;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-  this.tzid = tzid_;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  this.isUTC = false;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  this.isFloating = false;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  this.latitude = null;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  this.longitude = null;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-}</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-calWcapTimezone.prototype = {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  get displayName() {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    if (this.mDisplayName === undefined) {</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-      // used l10n'ed display name if available:</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-      let timezone = cal.getTimezoneService().getTimezone(this.tzid);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-      this.mDisplayName = timezone ? timezone.displayName : this.tzid;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    }</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    return this.mDisplayName;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  },</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  toString: function() {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    return this.icalComponent.toString();</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  },</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-};</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-function splitUriParams(uri) {</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  let spec = uri.spec;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  let qmPos = spec.indexOf(&quot;?&quot;);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  return qmPos == -1 ? [spec, &quot;&quot;] : [spec.substring(0, qmPos), spec.substring(qmPos)];</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-}</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-function getWcapSessionFor(calendar, uri) {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  let contextId = calendar.getProperty(&quot;shared_context&quot;);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  if (!contextId) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    contextId = cal.getUUID();</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    calendar.setProperty(&quot;shared_context&quot;, contextId);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-  }</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  if (!getWcapSessionFor.m_sessions) {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    getWcapSessionFor.m_sessions = {};</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-  }</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  let session = getWcapSessionFor.m_sessions[contextId];</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-  if (!session) {</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-    session = new calWcapSession(contextId);</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-    getWcapSessionFor.m_sessions[contextId] = session;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    let defaultCal = null;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-    let registeredCalendars = session.getRegisteredCalendars();</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-    for (let regCal of registeredCalendars) {</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-      if (regCal.isDefaultCalendar) {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-        defaultCal = regCal;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-        break;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-      }</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-    }</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-    if (defaultCal) {</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-      session.defaultCalendar = defaultCal;</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-      // eslint-disable-next-line array-bracket-spacing</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-      let [defaultSpec] = splitUriParams(defaultCal.uri);</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-      session.uri = Services.io.newURI(defaultSpec);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-      session.credentials.userId = defaultCal.getProperty(&quot;user_id&quot;);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-      log(&quot;default calendar found.&quot;, defaultCal);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-      // check and fix changing urls (autoconf) of subscribed calendars here:</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-      for (let regCal of registeredCalendars) {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-        if (!regCal.isDefaultCalendar) {</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-          let [spec, params] = splitUriParams(regCal.uri);</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-          if (spec != defaultSpec) {</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-            log(&quot;fixing url of subscribed calendar: &quot; + regCal.calId, session);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-            let caluri = regCal.uri</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-              .mutate()</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-              .setSpec(defaultSpec + params)</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-              .finalize();</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-            regCal.uri = caluri;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-            regCal.setProperty(&quot;uri&quot;, caluri.spec);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-          }</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-        }</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-      }</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-    } else {</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-      // no default calendar found, dump all subscribed calendars:</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-      registeredCalendars.forEach(</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-        cal.getCalendarManager().unregisterCalendar,</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-        cal.getCalendarManager()</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-      );</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-    }</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-  }</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-  return session;</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-}</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-function calWcapSession(contextId) {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-  this.wrappedJSObject = this;</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-  this.m_contextId = contextId;</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-  this.m_loginQueue = [];</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-  // listen for shutdown, being logged out:</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-  Services.obs.addObserver(this, &quot;quit-application&quot;);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  cal.getCalendarManager().addObserver(this);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-}</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-var calWcapSessionClassID = Components.ID(&quot;{cbf803fd-4469-4999-ae39-367af1c7b077}&quot;);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-var calWcapSessionInterfaces = [</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-  calIWcapSession,</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-  calIFreeBusyProvider,</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-  calICalendarSearchProvider,</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-  Ci.calITimezoneProvider,</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  Ci.calICalendarManagerObserver,</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-];</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-calWcapSession.prototype = {</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-  classID: calWcapSessionClassID,</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  QueryInterface: cal.generateQI(calWcapSessionInterfaces),</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-  classInfo: cal.generateCI({</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-    classID: calWcapSessionClassID,</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/wcap/session;1&quot;,</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-    classDescription: &quot;Sun Java System Calendar Server WCAP Session&quot;,</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-    interfaces: calWcapSessionInterfaces,</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-  }),</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-  toString: function(msg) {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-    let str =</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-      &quot;context-id: &quot; + this.m_contextId + &quot;, uri: &quot; + (this.uri ? this.uri.spec : &quot;unknown&quot;);</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-    if (this.credentials.userId) {</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-      str += &quot;, userId=&quot; + this.credentials.userId;</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-    }</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-    if (!this.m_sessionId) {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-      str += Services.io.offline ? &quot;, offline&quot; : &quot;, not logged in&quot;;</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-    }</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-    return str;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-  },</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-  notifyError: function(err) {</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-    if (this.defaultCalendar) {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-      this.defaultCalendar.notifyError_(err, null, this);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-    } else {</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-      logError(&quot;no default calendar!&quot;, this);</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-      logError(err, this);</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-    }</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-  },</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-  // calITimezoneProvider:</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-  m_serverTimezones: null,</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-  get timezoneIds() {</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-    let tzids = [];</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-    for (let tzid in this.m_serverTimezones) {</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-      tzids.push(tzid);</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-    }</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-    return {</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-      // nsIUTF8StringEnumerator:</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-      m_index: 0,</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-      [Symbol.iterator]: function() {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-        return tzids.values();</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-      },</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-      getNext: function() {</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-        if (this.m_index &gt;= tzids) {</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-          cal.ASSERT(false, &quot;calWcapSession::timezoneIds enumerator!&quot;);</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-          throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-        }</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-        return tzids[this.m_index++];</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-      },</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-      hasMore: function() {</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-        return this.m_index &lt; tzids.length;</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-      },</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-    };</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-  },</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-  getTimezone: function(tzid) {</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-    switch (tzid) {</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-      case &quot;floating&quot;:</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-        return cal.dtz.floating;</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-      case &quot;UTC&quot;:</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-        return cal.dtz.UTC;</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-      default:</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-        if (this.m_serverTimezones) {</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-          return this.m_serverTimezones[tzid];</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-        }</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-        return null;</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-    }</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-  },</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-  m_serverTimeDiff: null,</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-  getServerTime: function(localTime) {</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-    if (this.m_serverTimeDiff === null) {</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-      throw new Components.Exception(&quot;early run into getServerTime()!&quot;, Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-    }</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-    let ret = localTime ? localTime.clone() : getTime();</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-    ret.addDuration(this.m_serverTimeDiff);</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-    return ret;</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-  },</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-  m_sessionId: null,</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-  m_loginQueue: null,</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-  m_loginLock: false,</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-  getSessionId: function(request, respFunc, timedOutSessionId) {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-    if (Services.io.offline) {</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-      log(&quot;in offline mode.&quot;, this);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-      respFunc(new Components.Exception(errorToString(NS_ERROR_OFFLINE), NS_ERROR_OFFLINE));</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-      return;</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-    }</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-    log(&quot;login queue lock: &quot; + this.m_loginLock + &quot;, length: &quot; + this.m_loginQueue.length, this);</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-    if (this.m_loginLock) {</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-      this.m_loginQueue.push(respFunc);</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-      log(&quot;login queue: &quot; + this.m_loginQueue.length);</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-    } else {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-      if (this.m_sessionId &amp;&amp; this.m_sessionId != timedOutSessionId) {</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-        respFunc(null, this.m_sessionId);</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-        return;</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-      }</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-      this.m_loginLock = true;</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-      log(&quot;locked login queue.&quot;, this);</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-      this.m_sessionId = null; // invalidate for relogin</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-      if (timedOutSessionId) {</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-        log(&quot;reconnecting due to session timeout...&quot;, this);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-        cal.getFreeBusyService().removeProvider(this);</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-        cal.getCalendarSearchService().removeProvider(this);</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-      }</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-      this.getSessionId_(</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-        null, // don't couple to parent request parent may be cancelled</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-        (err, sessionId) =&gt; {</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-          log(&quot;getSessionId_resp_(): &quot; + sessionId, this);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-          if (!err) {</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-            this.m_sessionId = sessionId;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-            cal.getFreeBusyService().addProvider(this);</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-            cal.getCalendarSearchService().addProvider(this);</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-          }</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-          let queue = this.m_loginQueue;</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-          this.m_loginLock = false;</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-          this.m_loginQueue = [];</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-          log(&quot;unlocked login queue.&quot;, this);</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-          let getSessionId_exec = func =&gt; {</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-            try {</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-              func(err, sessionId);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-            } catch (exc) {</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-              // unexpected</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-              this.notifyError(exc);</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-            }</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-          };</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-          // answer first request:</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-          getSessionId_exec(respFunc);</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-          // and any remaining:</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-          queue.forEach(getSessionId_exec);</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-        }</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-      );</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-    }</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-  },</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-  // this is a server limit for recurrencies; default is 60</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-  recurrenceBound: 60,</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-  getSessionId_: function(request, respFunc) {</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-    this.checkServerVersion(</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-      request,</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-      // probe whether server is accessible and responds:</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-      err =&gt; {</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-        if (err) {</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-          respFunc(err);</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-          return;</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-        }</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-        // lookup password manager, then try login or prompt/login:</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-        log(&quot;attempting to get a session id for &quot; + this.sessionUri.spec, this);</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-        if (!this.sessionUri.schemeIs(&quot;https&quot;) &amp;&amp; !confirmInsecureLogin(this.sessionUri)) {</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-          log(&quot;user rejected insecure login on &quot; + this.sessionUri.spec, this);</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-          respFunc(</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-            new Components.Exception(</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-              errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-              calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-            )</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-          );</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-          return;</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-        }</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineminus">-</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineminus">-        let outUser = { value: this.credentials.userId };</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-        let outPW = { value: this.credentials.pw };</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-        let outSavePW = { value: false };</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineminus">-</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-        if (outUser.value &amp;&amp; !outPW.value) {</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineminus">-          // lookup pw manager</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-          log(&quot;looking in pw db for: &quot; + this.uri.spec, this);</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-          cal.auth.passwordManagerGet(outUser.value, outPW, this.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-        }</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-        let promptAndLoginLoop_resp = (loginerr, sessionId) =&gt; {</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-          if (checkErrorCode(loginerr, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-            log(&quot;prompting for [user/]pw...&quot;, this);</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-            if (</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-              cal.auth.getCredentials(</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-                getWcapString(&quot;loginDialog.label&quot;),</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-                this.sessionUri.hostPort,</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-                outUser,</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-                outPW,</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-                outSavePW,</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-                this.credentials.userId != null</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-              )</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-            ) {</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-              this.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-            } else {</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-              log(&quot;login prompt cancelled.&quot;, this);</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-              this.defaultCalendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-              this.defaultCalendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-              respFunc(</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-                new Components.Exception(</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-                  errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-                  calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-                )</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-              );</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineminus">-            }</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-          } else if (loginerr) {</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-            respFunc(loginerr);</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-          } else {</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-            if (outSavePW.value) {</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-              // so try to remove old pw from db first:</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-              try {</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-                cal.auth.passwordManagerSave(</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-                  outUser.value,</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-                  outPW.value,</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-                  this.uri.spec,</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-                  &quot;wcap login&quot;</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-                );</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-              } catch (e) {</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-                // User might have cancelled the master password prompt, or password saving</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-                // could be disabled. That is ok, throw for everything else.</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-                if (e.result != Cr.NS_ERROR_ABORT &amp;&amp; e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-                  throw e;</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-                }</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-              }</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineminus">-            }</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-            this.credentials.userId = outUser.value;</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-            this.credentials.pw = outPW.value; // eslint-disable-line id-length</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-            this.setupSession(sessionId, request, setuperr =&gt; respFunc(setuperr, sessionId));</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-          }</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-        };</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-        if (outPW.value) {</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-          this.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-        } else {</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-          promptAndLoginLoop_resp(calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-        }</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-      }</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-    );</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-  },</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-  login: function(request, respFunc, user, password) {</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-    issueNetworkRequest(</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-      request,</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-      (err, str) =&gt; {</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-        let sessionId;</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-        try {</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-          if (err) {</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-            throw err;</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineminus">-          }</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-          // currently, xml parsing at an early stage during</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-          // process startup does not work reliably, so use</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-          // libical parsing for now:</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-          let icalRootComp = stringToIcal(this, str);</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-          let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-SESSION-ID&quot;);</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-          if (!prop) {</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-            throw new Components.Exception(&quot;missing X-NSCP-WCAP-SESSION-ID in\n&quot; + str);</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-          }</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-          sessionId = prop.value;</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-          prop = icalRootComp.getFirstProperty(&quot;X-NSCP-RECURRENCE-BOUND&quot;);</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineminus">-          if (prop) {</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineminus">-            let val = parseInt(prop.value, 10);</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-            if (!isNaN(val)) {</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-              this.recurrenceBound = val;</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-              log(&quot;X-NSCP-RECURRENCE-BOUND:&quot; + this.recurrenceBound);</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-            }</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-          }</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-          log(&quot;login succeeded: &quot; + sessionId, this);</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-        } catch (exc) {</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-          err = exc;</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineminus">-          if (checkErrorCode(err, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-            log(&quot;error: &quot; + errorToString(exc), this); // log login failure</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineminus">-          } else if (getErrorModule(err) == NS_ERROR_MODULE_NETWORK) {</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-            // server seems unavailable:</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-            err = new Components.Exception(</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineminus">-              getWcapString(&quot;accessingServerFailedError.text&quot;, [this.sessionUri.hostPort]),</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineminus">-              exc</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineminus">-            );</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-          }</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-        }</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-        respFunc(err, sessionId);</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-      },</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-      this.sessionUri.spec +</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-        &quot;login.wcap?fmt-out=text%2Fcalendar&amp;user=&quot; +</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-        encodeURIComponent(user) +</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineminus">-        &quot;&amp;password=&quot; +</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineminus">-        encodeURIComponent(password),</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-      false /* no logging */</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineminus">-    );</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineminus">-  },</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineminus">-</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineminus">-  logout: function(listener) {</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineminus">-    let request = new calWcapRequest((oprequest, err) =&gt; {</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-      if (err) {</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineminus">-        logError(err, this);</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineminus">-      } else {</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-        log(&quot;logout succeeded.&quot;, this);</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-      }</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineminus">-      if (listener) {</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-        listener.onResult(oprequest, null);</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineminus">-      }</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineminus">-    }, log(&quot;logout&quot;, this));</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineminus">-</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineminus">-    let url = null;</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineminus">-    if (this.m_sessionId) {</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineminus">-      log(&quot;attempting to log out...&quot;, this);</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineminus">-      // although io service's offline flag is already</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-      // set BEFORE notification</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-      // (about to go offline, nsIOService.cpp).</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-      // WTF.</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineminus">-      url = this.sessionUri.spec + &quot;logout.wcap?fmt-out=text%2Fxml&amp;id=&quot; + this.m_sessionId;</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineminus">-      this.m_sessionId = null;</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineminus">-      cal.getFreeBusyService().removeProvider(this);</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-      cal.getCalendarSearchService().removeProvider(this);</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-    }</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-    this.m_credentials = null;</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-    if (url) {</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-      issueNetworkRequest(</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-        request,</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-        (err, str) =&gt; {</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineminus">-          if (err) {</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineminus">-            throw err;</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineminus">-          }</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineminus">-          stringToXml(this, str, -1 /* logout successful */);</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-        },</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-        url</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-      );</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-    } else {</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineminus">-      request.execRespFunc();</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineminus">-    }</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineminus">-    return request;</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-  },</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-  checkServerVersion: function(request, respFunc) {</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-    // currently, xml parsing at an early stage during process startup</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-    // does not work reliably, so use libical:</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-    issueNetworkRequest(</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-      request,</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-      (err, str) =&gt; {</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-        try {</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-          let icalRootComp;</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineminus">-          if (!err) {</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineminus">-            try {</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-              icalRootComp = stringToIcal(this, str);</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-            } catch (exc) {</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-              err = exc;</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-            }</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineminus">-          }</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineminus">-          if (err) {</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineminus">-            if (checkErrorCode(err, calIErrors.OPERATION_CANCELLED)) {</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-              throw err;</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineminus">-            } else {</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-              // soft error; request denied etc.</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineminus">-              // map into localized message:</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-              throw new Components.Exception(</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineminus">-                getWcapString(&quot;accessingServerFailedError.text&quot;, [this.sessionUri.hostPort]),</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineminus">-                calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-              );</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-            }</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineminus">-          }</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineminus">-          let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAPVERSION&quot;);</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineminus">-          if (!prop) {</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineminus">-            throw new Components.Exception(&quot;missing X-NSCP-WCAPVERSION!&quot;);</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineminus">-          }</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineminus">-          let wcapVersion = parseInt(prop.value, 10);</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineminus">-          if (wcapVersion &lt; 3) {</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineminus">-            let strVers = prop.value;</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineminus">-            let vars = [this.sessionUri.hostPort];</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineminus">-            prop = icalRootComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineminus">-            vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineminus">-            prop = icalRootComp.getFirstProperty(&quot;X-NSCP-SERVERVERSION&quot;);</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineminus">-            vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineminus">-            vars.push(strVers);</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineminus">-</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineminus">-            let prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineminus">-            let labelText = getWcapString(&quot;insufficientWcapVersionConfirmation.label&quot;);</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineminus">-            if (</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineminus">-              !prompt.confirm(</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineminus">-                labelText,</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineminus">-                getWcapString(&quot;insufficientWcapVersionConfirmation.text&quot;, vars)</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineminus">-              )</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-            ) {</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineminus">-              throw new Components.Exception(labelText, calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineminus">-            }</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineminus">-          }</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineminus">-        } catch (exc) {</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineminus">-          err = exc;</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-        }</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineminus">-        respFunc(err);</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineminus">-      },</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineminus">-      this.sessionUri.spec + &quot;version.wcap?fmt-out=text%2Fcalendar&quot;</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineminus">-    );</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineminus">-  },</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineminus">-  setupSession: function(sessionId, request_, respFunc) {</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineminus">-    let request = new calWcapRequest((oprequest, err) =&gt; {</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineminus">-      log(&quot;setupSession_resp finished: &quot; + errorToString(err), this);</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineminus">-      respFunc(err);</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineminus">-    }, log(&quot;setupSession&quot;, this));</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineminus">-    if (request_) {</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineminus">-      request_.attachSubRequest(request);</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineminus">-    }</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineminus">-</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineminus">-    request.lockPending();</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineminus">-    try {</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineminus">-      this.issueNetworkRequest_(</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineminus">-        request,</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineminus">-        (err, data) =&gt; {</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineminus">-          if (err) {</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineminus">-            throw err;</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-          }</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineminus">-          this.credentials.userPrefs = data;</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineminus">-          log(&quot;installed user prefs.&quot;, this);</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineminus">-</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineminus">-          // get calprops for all registered calendars:</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineminus">-          let cals = this.getRegisteredCalendars(true);</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineminus">-</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineminus">-          let calprops_resp = null;</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineminus">-          let defaultCal = this.defaultCalendar;</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineminus">-          if (</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineminus">-            defaultCal &amp;&amp;</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineminus">-            cals[defaultCal.calId] &amp;&amp; // default calendar is registered</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineminus">-            getPref(&quot;calendar.wcap.subscriptions&quot;, true) &amp;&amp;</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineminus">-            !defaultCal.getProperty(&quot;subscriptions_registered&quot;)</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineminus">-          ) {</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineminus">-            let hasSubscriptions = false;</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineminus">-            // post register subscribed calendars:</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-            let list = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsSubscribed&quot;);</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineminus">-            for (let item of list) {</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineminus">-              let itemparts = item.split(&quot;,&quot;);</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineminus">-              // ',', '$' are not encoded. ',' can be handled here. WTF.</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineminus">-              for (let part of itemparts) {</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineminus">-                let dollar = part.indexOf(&quot;$&quot;);</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineminus">-                if (dollar &gt;= 0) {</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineminus">-                  let calId = part.substring(0, dollar);</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineminus">-                  if (calId != this.defaultCalId) {</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineminus">-                    cals[calId] = null;</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineminus">-                    hasSubscriptions = true;</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-                  }</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineminus">-                }</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineminus">-              }</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineminus">-            }</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineminus">-</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineminus">-            if (hasSubscriptions) {</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineminus">-              calprops_resp = aCalendar =&gt; {</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-                if (aCalendar.isDefaultCalendar) {</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineminus">-                  // tweak name:</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineminus">-                  aCalendar.setProperty(&quot;name&quot;, aCalendar.displayName);</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineminus">-                } else {</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineminus">-                  log(&quot;registering subscribed calendar: &quot; + aCalendar.calId, this);</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineminus">-                  cal.getCalendarManager().registerCalendar(aCalendar);</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineminus">-                }</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-              };</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-              // do only once:</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineminus">-              defaultCal.setProperty(&quot;subscriptions_registered&quot;, true);</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineminus">-            }</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineminus">-          }</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineminus">-</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineminus">-          if (!defaultCal.getProperty(&quot;user_id&quot;)) {</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineminus">-            // nail once:</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineminus">-            defaultCal.setProperty(&quot;user_id&quot;, this.credentials.userId);</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineminus">-          }</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineminus">-</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineminus">-          if (getPref(&quot;calendar.wcap.no_get_calprops&quot;, false)) {</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineminus">-            // hack around the get/search calprops mess:</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineminus">-            this.installCalProps_search_calprops(calprops_resp, sessionId, cals, request);</span>
<a href="#l13.588"></a><span id="l13.588" class="difflineminus">-          } else {</span>
<a href="#l13.589"></a><span id="l13.589" class="difflineminus">-            this.installCalProps_get_calprops(calprops_resp, sessionId, cals, request);</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineminus">-          }</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineminus">-        },</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineminus">-        stringToXml,</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineminus">-        &quot;get_userprefs&quot;,</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineminus">-        &quot;&amp;fmt-out=text%2Fxml&amp;userid=&quot; + encodeURIComponent(this.credentials.userId),</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineminus">-        sessionId</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineminus">-      );</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineminus">-      this.installServerTimeDiff(sessionId, request);</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineminus">-      this.installServerTimezones(sessionId, request);</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineminus">-    } finally {</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineminus">-      request.unlockPending();</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineminus">-    }</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineminus">-  },</span>
<a href="#l13.603"></a><span id="l13.603" class="difflineminus">-</span>
<a href="#l13.604"></a><span id="l13.604" class="difflineminus">-  installCalProps_get_calprops: function(respFunc, sessionId, cals, request) {</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineminus">-    let calprops_resp = (err, data) =&gt; {</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineminus">-      if (err) {</span>
<a href="#l13.607"></a><span id="l13.607" class="difflineminus">-        throw err;</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineminus">-      }</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineminus">-      // string to xml converter func without WCAP errno check:</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-      if (!data || data.length == 0) {</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineminus">-        // assuming time-out</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineminus">-        throw new Components.Exception(</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineminus">-          errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineminus">-          calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineminus">-        );</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineminus">-      }</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineminus">-      let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineminus">-      let nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineminus">-      for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineminus">-        try {</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineminus">-          let node = nodeList.item(i);</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineminus">-          checkWcapXmlErrno(node);</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineminus">-          let calid = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineminus">-          if (calid.length &gt; 0) {</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineminus">-            let calId = calid[0];</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineminus">-            let calendar = cals[calId];</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineminus">-            if (calendar === null) {</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineminus">-              calendar = new calWcapCalendar(this);</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineminus">-              let newPath = this.uri.pathQueryRef + &quot;?calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineminus">-              calendar.uri = this.uri</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineminus">-                .mutate()</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineminus">-                .setPathQueryRef(newPath)</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineminus">-                .finalize();</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineminus">-            }</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineminus">-            if (calendar) {</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineminus">-              calendar.m_calProps = node;</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineminus">-              if (respFunc) {</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineminus">-                respFunc(calendar);</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineminus">-              }</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineminus">-            }</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineminus">-          }</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineminus">-        } catch (exc) {</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineminus">-          // ignore but log any errors on subscribed calendars:</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineminus">-          logError(exc, this);</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineminus">-        }</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineminus">-      }</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineminus">-    };</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineminus">-</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineminus">-    let calidParam = &quot;&quot;;</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineminus">-    for (let calId in cals) {</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineminus">-      if (calidParam.length &gt; 0) {</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineminus">-        calidParam += &quot;;&quot;;</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineminus">-      }</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineminus">-      calidParam += encodeURIComponent(calId);</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineminus">-    }</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineminus">-    this.issueNetworkRequest_(</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineminus">-      request,</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineminus">-      calprops_resp,</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineminus">-      null,</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineminus">-      &quot;get_calprops&quot;,</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineminus">-      &quot;&amp;fmt-out=text%2Fxml&amp;calid=&quot; + calidParam,</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineminus">-      sessionId</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineminus">-    );</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineminus">-  },</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineminus">-</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineminus">-  installCalProps_search_calprops: function(respFunc, sessionId, cals, request) {</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineminus">-    let retrievedCals = {};</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineminus">-    let issuedSearchRequests = {};</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineminus">-    for (let calId in cals) {</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineminus">-      if (!retrievedCals[calId]) {</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineminus">-        let listener = {</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineminus">-          onResult: function(oprequest, result) {</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineminus">-            try {</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineminus">-              if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineminus">-                throw oprequest.status;</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineminus">-              }</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineminus">-              if (result.length &lt; 1) {</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineminus">-                throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineminus">-              }</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineminus">-              for (let calendar of result) {</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineminus">-                // user may have dangling users referred in his subscription list, so</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineminus">-                // retrieve each by each, don't break:</span>
<a href="#l13.683"></a><span id="l13.683" class="difflineminus">-                try {</span>
<a href="#l13.684"></a><span id="l13.684" class="difflineminus">-                  let thisCalId = calendar.calId;</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-                  if (cals[thisCalId] !== undefined &amp;&amp; !retrievedCals[thisCalId]) {</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineminus">-                    retrievedCals[thisCalId] = calendar;</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineminus">-                    if (respFunc) {</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineminus">-                      respFunc(calendar);</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineminus">-                    }</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineminus">-                  }</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineminus">-                } catch (exc) {</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineminus">-                  // ignore but log any errors on subscribed calendars:</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineminus">-                  logError(exc, this);</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineminus">-                }</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineminus">-              }</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineminus">-            } catch (exc) {</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineminus">-              // ignore but log any errors on subscribed calendars:</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineminus">-              logError(exc, this);</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineminus">-            }</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineminus">-          },</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineminus">-        };</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineminus">-</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineminus">-        let colon = calId.indexOf(&quot;:&quot;);</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineminus">-        if (colon &gt;= 0) {</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineminus">-          // searching for secondary calendars doesn't work. WTF.</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineminus">-          calId = calId.substring(0, colon);</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineminus">-        }</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineminus">-        if (!issuedSearchRequests[calId]) {</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineminus">-          issuedSearchRequests[calId] = true;</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineminus">-          this.searchForCalendars(calId, calICalendarSearchProvider.HINT_EXACT_MATCH, 20, listener);</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineminus">-        }</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineminus">-      }</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineminus">-    }</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineminus">-  },</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineminus">-</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineminus">-  installServerTimeDiff: function(sessionId, request) {</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineminus">-    this.issueNetworkRequest_(</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineminus">-      request,</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineminus">-      (err, data) =&gt; {</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineminus">-        if (err) {</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineminus">-          throw err;</span>
<a href="#l13.722"></a><span id="l13.722" class="difflineminus">-        }</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineminus">-        // xxx todo: think about</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineminus">-        // assure that locally calculated server time is smaller</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineminus">-        // than the current (real) server time:</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineminus">-        let localTime = getTime();</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineminus">-        let serverTime = getDatetimeFromIcalProp(data.getFirstProperty(&quot;X-NSCP-WCAPTIME&quot;));</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineminus">-        this.m_serverTimeDiff = serverTime.subtractDate(localTime);</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineminus">-        log(&quot;server time diff is: &quot; + this.m_serverTimeDiff, this);</span>
<a href="#l13.730"></a><span id="l13.730" class="difflineminus">-      },</span>
<a href="#l13.731"></a><span id="l13.731" class="difflineminus">-      stringToIcal,</span>
<a href="#l13.732"></a><span id="l13.732" class="difflineminus">-      &quot;gettime&quot;,</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineminus">-      &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineminus">-      sessionId</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineminus">-    );</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineminus">-  },</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineminus">-</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineminus">-  installServerTimezones: function(sessionId, request) {</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineminus">-    this.m_serverTimezones = {};</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineminus">-    this.issueNetworkRequest_(</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineminus">-      request,</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineminus">-      (err, data) =&gt; {</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineminus">-        if (err) {</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineminus">-          throw err;</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineminus">-        }</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineminus">-        for (let subComp of cal.iterate.icalComponent(data, &quot;VTIMEZONE&quot;)) {</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineminus">-          try {</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineminus">-            let tzid = subComp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineminus">-            this.m_serverTimezones[tzid] = new calWcapTimezone(this, tzid, subComp);</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineminus">-          } catch (exc) {</span>
<a href="#l13.751"></a><span id="l13.751" class="difflineminus">-            // ignore but errors:</span>
<a href="#l13.752"></a><span id="l13.752" class="difflineminus">-            logError(exc, this);</span>
<a href="#l13.753"></a><span id="l13.753" class="difflineminus">-          }</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineminus">-        }</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineminus">-        log(&quot;installed timezones.&quot;, this);</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineminus">-      },</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineminus">-      stringToIcal,</span>
<a href="#l13.758"></a><span id="l13.758" class="difflineminus">-      &quot;get_all_timezones&quot;,</span>
<a href="#l13.759"></a><span id="l13.759" class="difflineminus">-      &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l13.760"></a><span id="l13.760" class="difflineminus">-      sessionId</span>
<a href="#l13.761"></a><span id="l13.761" class="difflineminus">-    );</span>
<a href="#l13.762"></a><span id="l13.762" class="difflineminus">-  },</span>
<a href="#l13.763"></a><span id="l13.763" class="difflineminus">-</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineminus">-  getCommandUrl: function(wcapCommand, params, sessionId) {</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineminus">-    let url = this.sessionUri.spec;</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineminus">-    url += wcapCommand + &quot;.wcap?appid=mozilla-calendar&amp;id=&quot;;</span>
<a href="#l13.767"></a><span id="l13.767" class="difflineminus">-    url += sessionId;</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineminus">-    url += params;</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineminus">-    return url;</span>
<a href="#l13.770"></a><span id="l13.770" class="difflineminus">-  },</span>
<a href="#l13.771"></a><span id="l13.771" class="difflineminus">-</span>
<a href="#l13.772"></a><span id="l13.772" class="difflineminus">-  issueNetworkRequest: function(request, respFunc, dataConvFunc, wcapCommand, params) {</span>
<a href="#l13.773"></a><span id="l13.773" class="difflineminus">-    let getSessionId_resp = (err, sessionId) =&gt; {</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineminus">-      if (err) {</span>
<a href="#l13.775"></a><span id="l13.775" class="difflineminus">-        request.execSubRespFunc(respFunc, err);</span>
<a href="#l13.776"></a><span id="l13.776" class="difflineminus">-      } else {</span>
<a href="#l13.777"></a><span id="l13.777" class="difflineminus">-        // else have session uri and id:</span>
<a href="#l13.778"></a><span id="l13.778" class="difflineminus">-        this.issueNetworkRequest_(</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineminus">-          request,</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineminus">-          (loginerr, data) =&gt; {</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineminus">-            // timeout?</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineminus">-            if (checkErrorCode(loginerr, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineminus">-              // try again:</span>
<a href="#l13.784"></a><span id="l13.784" class="difflineminus">-              this.getSessionId(</span>
<a href="#l13.785"></a><span id="l13.785" class="difflineminus">-                request,</span>
<a href="#l13.786"></a><span id="l13.786" class="difflineminus">-                getSessionId_resp,</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineminus">-                sessionId /* (old) timed-out session */</span>
<a href="#l13.788"></a><span id="l13.788" class="difflineminus">-              );</span>
<a href="#l13.789"></a><span id="l13.789" class="difflineminus">-              return;</span>
<a href="#l13.790"></a><span id="l13.790" class="difflineminus">-            }</span>
<a href="#l13.791"></a><span id="l13.791" class="difflineminus">-            request.execSubRespFunc(respFunc, loginerr, data);</span>
<a href="#l13.792"></a><span id="l13.792" class="difflineminus">-          },</span>
<a href="#l13.793"></a><span id="l13.793" class="difflineminus">-          dataConvFunc,</span>
<a href="#l13.794"></a><span id="l13.794" class="difflineminus">-          wcapCommand,</span>
<a href="#l13.795"></a><span id="l13.795" class="difflineminus">-          params,</span>
<a href="#l13.796"></a><span id="l13.796" class="difflineminus">-          sessionId</span>
<a href="#l13.797"></a><span id="l13.797" class="difflineminus">-        );</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineminus">-      }</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineminus">-    };</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineminus">-    this.getSessionId(request, getSessionId_resp);</span>
<a href="#l13.801"></a><span id="l13.801" class="difflineminus">-  },</span>
<a href="#l13.802"></a><span id="l13.802" class="difflineminus">-</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineminus">-  issueNetworkRequest_: function(request, respFunc, dataConvFunc, wcapCommand, params, sessionId) {</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-    let url = this.getCommandUrl(wcapCommand, params, sessionId);</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineminus">-    issueNetworkRequest(</span>
<a href="#l13.806"></a><span id="l13.806" class="difflineminus">-      request,</span>
<a href="#l13.807"></a><span id="l13.807" class="difflineminus">-      (err, str) =&gt; {</span>
<a href="#l13.808"></a><span id="l13.808" class="difflineminus">-        let data;</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineminus">-        if (!err) {</span>
<a href="#l13.810"></a><span id="l13.810" class="difflineminus">-          try {</span>
<a href="#l13.811"></a><span id="l13.811" class="difflineminus">-            if (dataConvFunc) {</span>
<a href="#l13.812"></a><span id="l13.812" class="difflineminus">-              data = dataConvFunc(this, str);</span>
<a href="#l13.813"></a><span id="l13.813" class="difflineminus">-            } else {</span>
<a href="#l13.814"></a><span id="l13.814" class="difflineminus">-              data = str;</span>
<a href="#l13.815"></a><span id="l13.815" class="difflineminus">-            }</span>
<a href="#l13.816"></a><span id="l13.816" class="difflineminus">-          } catch (exc) {</span>
<a href="#l13.817"></a><span id="l13.817" class="difflineminus">-            err = exc;</span>
<a href="#l13.818"></a><span id="l13.818" class="difflineminus">-          }</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineminus">-        }</span>
<a href="#l13.820"></a><span id="l13.820" class="difflineminus">-        request.execSubRespFunc(respFunc, err, data);</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineminus">-      },</span>
<a href="#l13.822"></a><span id="l13.822" class="difflineminus">-      url</span>
<a href="#l13.823"></a><span id="l13.823" class="difflineminus">-    );</span>
<a href="#l13.824"></a><span id="l13.824" class="difflineminus">-  },</span>
<a href="#l13.825"></a><span id="l13.825" class="difflineminus">-</span>
<a href="#l13.826"></a><span id="l13.826" class="difflineminus">-  m_credentials: null,</span>
<a href="#l13.827"></a><span id="l13.827" class="difflineminus">-  get credentials() {</span>
<a href="#l13.828"></a><span id="l13.828" class="difflineminus">-    if (!this.m_credentials) {</span>
<a href="#l13.829"></a><span id="l13.829" class="difflineminus">-      this.m_credentials = {};</span>
<a href="#l13.830"></a><span id="l13.830" class="difflineminus">-    }</span>
<a href="#l13.831"></a><span id="l13.831" class="difflineminus">-    return this.m_credentials;</span>
<a href="#l13.832"></a><span id="l13.832" class="difflineminus">-  },</span>
<a href="#l13.833"></a><span id="l13.833" class="difflineminus">-</span>
<a href="#l13.834"></a><span id="l13.834" class="difflineminus">-  // calIWcapSession:</span>
<a href="#l13.835"></a><span id="l13.835" class="difflineminus">-</span>
<a href="#l13.836"></a><span id="l13.836" class="difflineminus">-  m_contextId: null,</span>
<a href="#l13.837"></a><span id="l13.837" class="difflineminus">-  m_uri: null,</span>
<a href="#l13.838"></a><span id="l13.838" class="difflineminus">-  m_sessionUri: null,</span>
<a href="#l13.839"></a><span id="l13.839" class="difflineminus">-  get uri() {</span>
<a href="#l13.840"></a><span id="l13.840" class="difflineminus">-    return this.m_uri;</span>
<a href="#l13.841"></a><span id="l13.841" class="difflineminus">-  },</span>
<a href="#l13.842"></a><span id="l13.842" class="difflineminus">-  get sessionUri() {</span>
<a href="#l13.843"></a><span id="l13.843" class="difflineminus">-    return this.m_sessionUri;</span>
<a href="#l13.844"></a><span id="l13.844" class="difflineminus">-  },</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineminus">-  set uri(thatUri) {</span>
<a href="#l13.846"></a><span id="l13.846" class="difflineminus">-    this.m_uri = thatUri;</span>
<a href="#l13.847"></a><span id="l13.847" class="difflineminus">-    this.m_sessionUri = thatUri</span>
<a href="#l13.848"></a><span id="l13.848" class="difflineminus">-      .mutate()</span>
<a href="#l13.849"></a><span id="l13.849" class="difflineminus">-      .setUserPass(&quot;&quot;)</span>
<a href="#l13.850"></a><span id="l13.850" class="difflineminus">-      .finalize();</span>
<a href="#l13.851"></a><span id="l13.851" class="difflineminus">-  },</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineminus">-</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineminus">-  get userId() {</span>
<a href="#l13.854"></a><span id="l13.854" class="difflineminus">-    return this.credentials.userId;</span>
<a href="#l13.855"></a><span id="l13.855" class="difflineminus">-  },</span>
<a href="#l13.856"></a><span id="l13.856" class="difflineminus">-</span>
<a href="#l13.857"></a><span id="l13.857" class="difflineminus">-  get defaultCalId() {</span>
<a href="#l13.858"></a><span id="l13.858" class="difflineminus">-    let list = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsCalendar&quot;);</span>
<a href="#l13.859"></a><span id="l13.859" class="difflineminus">-    let id = null;</span>
<a href="#l13.860"></a><span id="l13.860" class="difflineminus">-    for (let item of list) {</span>
<a href="#l13.861"></a><span id="l13.861" class="difflineminus">-      if (item.length &gt; 0) {</span>
<a href="#l13.862"></a><span id="l13.862" class="difflineminus">-        id = item;</span>
<a href="#l13.863"></a><span id="l13.863" class="difflineminus">-        break;</span>
<a href="#l13.864"></a><span id="l13.864" class="difflineminus">-      }</span>
<a href="#l13.865"></a><span id="l13.865" class="difflineminus">-    }</span>
<a href="#l13.866"></a><span id="l13.866" class="difflineminus">-    return id ? id : this.credentials.userId;</span>
<a href="#l13.867"></a><span id="l13.867" class="difflineminus">-  },</span>
<a href="#l13.868"></a><span id="l13.868" class="difflineminus">-</span>
<a href="#l13.869"></a><span id="l13.869" class="difflineminus">-  get isLoggedIn() {</span>
<a href="#l13.870"></a><span id="l13.870" class="difflineminus">-    return this.m_sessionId != null;</span>
<a href="#l13.871"></a><span id="l13.871" class="difflineminus">-  },</span>
<a href="#l13.872"></a><span id="l13.872" class="difflineminus">-</span>
<a href="#l13.873"></a><span id="l13.873" class="difflineminus">-  defaultCalendar: null,</span>
<a href="#l13.874"></a><span id="l13.874" class="difflineminus">-</span>
<a href="#l13.875"></a><span id="l13.875" class="difflineminus">-  belongsTo: function(calendar) {</span>
<a href="#l13.876"></a><span id="l13.876" class="difflineminus">-    try {</span>
<a href="#l13.877"></a><span id="l13.877" class="difflineminus">-      // xxx todo hack to get the unwrapped wcap calendar instance:</span>
<a href="#l13.878"></a><span id="l13.878" class="difflineminus">-      calendar = calendar.getProperty(&quot;cache.uncachedCalendar&quot;).QueryInterface(calIWcapCalendar)</span>
<a href="#l13.879"></a><span id="l13.879" class="difflineminus">-        .wrappedJSObject;</span>
<a href="#l13.880"></a><span id="l13.880" class="difflineminus">-      if (calendar &amp;&amp; calendar.session.m_contextId == this.m_contextId) {</span>
<a href="#l13.881"></a><span id="l13.881" class="difflineminus">-        return calendar;</span>
<a href="#l13.882"></a><span id="l13.882" class="difflineminus">-      }</span>
<a href="#l13.883"></a><span id="l13.883" class="difflineminus">-    } catch (exc) {</span>
<a href="#l13.884"></a><span id="l13.884" class="difflineminus">-      // Fall through to the return statement below in case the uncached</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineminus">-      // calendar can't be retrieved.</span>
<a href="#l13.886"></a><span id="l13.886" class="difflineminus">-    }</span>
<a href="#l13.887"></a><span id="l13.887" class="difflineminus">-    return null;</span>
<a href="#l13.888"></a><span id="l13.888" class="difflineminus">-  },</span>
<a href="#l13.889"></a><span id="l13.889" class="difflineminus">-</span>
<a href="#l13.890"></a><span id="l13.890" class="difflineminus">-  getRegisteredCalendars: function(asAssocObj) {</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineminus">-    let registeredCalendars = asAssocObj ? {} : [];</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineminus">-    let cals = cal.getCalendarManager().getCalendars();</span>
<a href="#l13.893"></a><span id="l13.893" class="difflineminus">-    for (let calendar of cals) {</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineminus">-      calendar = this.belongsTo(calendar);</span>
<a href="#l13.895"></a><span id="l13.895" class="difflineminus">-      if (calendar) {</span>
<a href="#l13.896"></a><span id="l13.896" class="difflineminus">-        if (asAssocObj) {</span>
<a href="#l13.897"></a><span id="l13.897" class="difflineminus">-          registeredCalendars[calendar.calId] = calendar;</span>
<a href="#l13.898"></a><span id="l13.898" class="difflineminus">-        } else {</span>
<a href="#l13.899"></a><span id="l13.899" class="difflineminus">-          registeredCalendars.push(calendar);</span>
<a href="#l13.900"></a><span id="l13.900" class="difflineminus">-        }</span>
<a href="#l13.901"></a><span id="l13.901" class="difflineminus">-      }</span>
<a href="#l13.902"></a><span id="l13.902" class="difflineminus">-    }</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineminus">-    return registeredCalendars;</span>
<a href="#l13.904"></a><span id="l13.904" class="difflineminus">-  },</span>
<a href="#l13.905"></a><span id="l13.905" class="difflineminus">-</span>
<a href="#l13.906"></a><span id="l13.906" class="difflineminus">-  getUserPreferences: function(prefName) {</span>
<a href="#l13.907"></a><span id="l13.907" class="difflineminus">-    let prefs = filterXmlNodes(prefName, this.credentials.userPrefs);</span>
<a href="#l13.908"></a><span id="l13.908" class="difflineminus">-    return prefs;</span>
<a href="#l13.909"></a><span id="l13.909" class="difflineminus">-  },</span>
<a href="#l13.910"></a><span id="l13.910" class="difflineminus">-</span>
<a href="#l13.911"></a><span id="l13.911" class="difflineminus">-  get defaultAlarmStart() {</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineminus">-    let alarmStart = null;</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineminus">-    let alarmStartPref = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmStart&quot;);</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineminus">-    if (alarmStartPref.length &gt; 0 &amp;&amp; alarmStartPref[0].length &gt; 0) {</span>
<a href="#l13.915"></a><span id="l13.915" class="difflineminus">-      // workarounding cs duration bug, missing &quot;T&quot;:</span>
<a href="#l13.916"></a><span id="l13.916" class="difflineminus">-      let dur = alarmStartPref[0].replace(/(^P)(\d+[HMS]$)/, &quot;$1T$2&quot;);</span>
<a href="#l13.917"></a><span id="l13.917" class="difflineminus">-      alarmStart = cal.createDuration(dur);</span>
<a href="#l13.918"></a><span id="l13.918" class="difflineminus">-      alarmStart.isNegative = !alarmStart.isNegative;</span>
<a href="#l13.919"></a><span id="l13.919" class="difflineminus">-    }</span>
<a href="#l13.920"></a><span id="l13.920" class="difflineminus">-    return alarmStart;</span>
<a href="#l13.921"></a><span id="l13.921" class="difflineminus">-  },</span>
<a href="#l13.922"></a><span id="l13.922" class="difflineminus">-</span>
<a href="#l13.923"></a><span id="l13.923" class="difflineminus">-  getDefaultAlarmEmails: function(out_count) {</span>
<a href="#l13.924"></a><span id="l13.924" class="difflineminus">-    let ret = [];</span>
<a href="#l13.925"></a><span id="l13.925" class="difflineminus">-    let alarmEmails = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmEmail&quot;);</span>
<a href="#l13.926"></a><span id="l13.926" class="difflineminus">-    if (alarmEmails.length &gt; 0 &amp;&amp; alarmEmails[0].length &gt; 0) {</span>
<a href="#l13.927"></a><span id="l13.927" class="difflineminus">-      for (let email of alarmEmails) {</span>
<a href="#l13.928"></a><span id="l13.928" class="difflineminus">-        ret = ret.concat(email.split(/[;,]/).map(mail =&gt; mail.trim()));</span>
<a href="#l13.929"></a><span id="l13.929" class="difflineminus">-      }</span>
<a href="#l13.930"></a><span id="l13.930" class="difflineminus">-    }</span>
<a href="#l13.931"></a><span id="l13.931" class="difflineminus">-    out_count.value = ret.length;</span>
<a href="#l13.932"></a><span id="l13.932" class="difflineminus">-    return ret;</span>
<a href="#l13.933"></a><span id="l13.933" class="difflineminus">-  },</span>
<a href="#l13.934"></a><span id="l13.934" class="difflineminus">-</span>
<a href="#l13.935"></a><span id="l13.935" class="difflineminus">-  // calICalendarSearchProvider:</span>
<a href="#l13.936"></a><span id="l13.936" class="difflineminus">-  searchForCalendars: function(searchString, hints, maxResults, listener) {</span>
<a href="#l13.937"></a><span id="l13.937" class="difflineminus">-    let request = new calWcapRequest((oprequest, err, data) =&gt; {</span>
<a href="#l13.938"></a><span id="l13.938" class="difflineminus">-      if (err &amp;&amp; !checkErrorCode(err, calIErrors.OPERATION_CANCELLED)) {</span>
<a href="#l13.939"></a><span id="l13.939" class="difflineminus">-        this.notifyError(err);</span>
<a href="#l13.940"></a><span id="l13.940" class="difflineminus">-      }</span>
<a href="#l13.941"></a><span id="l13.941" class="difflineminus">-      if (listener) {</span>
<a href="#l13.942"></a><span id="l13.942" class="difflineminus">-        listener.onResult(oprequest, data);</span>
<a href="#l13.943"></a><span id="l13.943" class="difflineminus">-      }</span>
<a href="#l13.944"></a><span id="l13.944" class="difflineminus">-    }, log(&quot;searchForCalendars, searchString=&quot; + searchString, this));</span>
<a href="#l13.945"></a><span id="l13.945" class="difflineminus">-</span>
<a href="#l13.946"></a><span id="l13.946" class="difflineminus">-    try {</span>
<a href="#l13.947"></a><span id="l13.947" class="difflineminus">-      let registeredCalendars = this.getRegisteredCalendars(true);</span>
<a href="#l13.948"></a><span id="l13.948" class="difflineminus">-</span>
<a href="#l13.949"></a><span id="l13.949" class="difflineminus">-      let params = &quot;&amp;fmt-out=text%2Fxml&amp;search-string=&quot; + encodeURIComponent(searchString);</span>
<a href="#l13.950"></a><span id="l13.950" class="difflineminus">-      if (maxResults &gt; 0) {</span>
<a href="#l13.951"></a><span id="l13.951" class="difflineminus">-        params += &quot;&amp;maxResults=&quot; + maxResults;</span>
<a href="#l13.952"></a><span id="l13.952" class="difflineminus">-      }</span>
<a href="#l13.953"></a><span id="l13.953" class="difflineminus">-      params +=</span>
<a href="#l13.954"></a><span id="l13.954" class="difflineminus">-        &quot;&amp;name=1&amp;calid=1&amp;primaryOwner=1&amp;searchOpts=&quot; +</span>
<a href="#l13.955"></a><span id="l13.955" class="difflineminus">-        (hints &amp; calICalendarSearchProvider.HINT_EXACT_MATCH ? &quot;3&quot; : &quot;0&quot;);</span>
<a href="#l13.956"></a><span id="l13.956" class="difflineminus">-</span>
<a href="#l13.957"></a><span id="l13.957" class="difflineminus">-      this.issueNetworkRequest(</span>
<a href="#l13.958"></a><span id="l13.958" class="difflineminus">-        request,</span>
<a href="#l13.959"></a><span id="l13.959" class="difflineminus">-        (err, data) =&gt; {</span>
<a href="#l13.960"></a><span id="l13.960" class="difflineminus">-          if (err) {</span>
<a href="#l13.961"></a><span id="l13.961" class="difflineminus">-            throw err;</span>
<a href="#l13.962"></a><span id="l13.962" class="difflineminus">-          }</span>
<a href="#l13.963"></a><span id="l13.963" class="difflineminus">-          // string to xml converter func without WCAP errno check:</span>
<a href="#l13.964"></a><span id="l13.964" class="difflineminus">-          if (!data || data.length == 0) {</span>
<a href="#l13.965"></a><span id="l13.965" class="difflineminus">-            // assuming time-out</span>
<a href="#l13.966"></a><span id="l13.966" class="difflineminus">-            throw new Components.Exception(</span>
<a href="#l13.967"></a><span id="l13.967" class="difflineminus">-              errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l13.968"></a><span id="l13.968" class="difflineminus">-              calIWcapErrors.WCAP_LOGIN_FAILED</span>
<a href="#l13.969"></a><span id="l13.969" class="difflineminus">-            );</span>
<a href="#l13.970"></a><span id="l13.970" class="difflineminus">-          }</span>
<a href="#l13.971"></a><span id="l13.971" class="difflineminus">-          let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l13.972"></a><span id="l13.972" class="difflineminus">-          let ret = [];</span>
<a href="#l13.973"></a><span id="l13.973" class="difflineminus">-          let nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l13.974"></a><span id="l13.974" class="difflineminus">-          for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l13.975"></a><span id="l13.975" class="difflineminus">-            let node = nodeList.item(i);</span>
<a href="#l13.976"></a><span id="l13.976" class="difflineminus">-            try {</span>
<a href="#l13.977"></a><span id="l13.977" class="difflineminus">-              checkWcapXmlErrno(node);</span>
<a href="#l13.978"></a><span id="l13.978" class="difflineminus">-              let calIdNodes = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l13.979"></a><span id="l13.979" class="difflineminus">-              if (calIdNodes.length &gt; 0) {</span>
<a href="#l13.980"></a><span id="l13.980" class="difflineminus">-                let calId = calIdNodes[0];</span>
<a href="#l13.981"></a><span id="l13.981" class="difflineminus">-                let calendar = registeredCalendars[calId];</span>
<a href="#l13.982"></a><span id="l13.982" class="difflineminus">-                if (calendar) {</span>
<a href="#l13.983"></a><span id="l13.983" class="difflineminus">-                  calendar.m_calProps = node; // update calprops</span>
<a href="#l13.984"></a><span id="l13.984" class="difflineminus">-                } else {</span>
<a href="#l13.985"></a><span id="l13.985" class="difflineminus">-                  calendar = new calWcapCalendar(this, node);</span>
<a href="#l13.986"></a><span id="l13.986" class="difflineminus">-                  let newPath = this.uri.pathQueryRef + &quot;?calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l13.987"></a><span id="l13.987" class="difflineminus">-                  calendar.uri = this.uri</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineminus">-                    .mutate()</span>
<a href="#l13.989"></a><span id="l13.989" class="difflineminus">-                    .setPathQueryRef(newPath)</span>
<a href="#l13.990"></a><span id="l13.990" class="difflineminus">-                    .finalize();</span>
<a href="#l13.991"></a><span id="l13.991" class="difflineminus">-                }</span>
<a href="#l13.992"></a><span id="l13.992" class="difflineminus">-                ret.push(calendar);</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineminus">-              }</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineminus">-            } catch (exc) {</span>
<a href="#l13.995"></a><span id="l13.995" class="difflineminus">-              switch (getResultCode(exc)) {</span>
<a href="#l13.996"></a><span id="l13.996" class="difflineminus">-                case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l13.997"></a><span id="l13.997" class="difflineminus">-                case calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR:</span>
<a href="#l13.998"></a><span id="l13.998" class="difflineminus">-                  log(&quot;searchForCalendars_netResp() ignored error: &quot; + errorToString(exc), this);</span>
<a href="#l13.999"></a><span id="l13.999" class="difflineminus">-                  break;</span>
<a href="#l13.1000"></a><span id="l13.1000" class="difflineminus">-                default:</span>
<a href="#l13.1001"></a><span id="l13.1001" class="difflineminus">-                  this.notifyError(exc);</span>
<a href="#l13.1002"></a><span id="l13.1002" class="difflineminus">-                  break;</span>
<a href="#l13.1003"></a><span id="l13.1003" class="difflineminus">-              }</span>
<a href="#l13.1004"></a><span id="l13.1004" class="difflineminus">-            }</span>
<a href="#l13.1005"></a><span id="l13.1005" class="difflineminus">-          }</span>
<a href="#l13.1006"></a><span id="l13.1006" class="difflineminus">-          log(&quot;search done. number of found calendars: &quot; + ret.length, this);</span>
<a href="#l13.1007"></a><span id="l13.1007" class="difflineminus">-          request.execRespFunc(null, ret);</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineminus">-        },</span>
<a href="#l13.1009"></a><span id="l13.1009" class="difflineminus">-        null,</span>
<a href="#l13.1010"></a><span id="l13.1010" class="difflineminus">-        &quot;search_calprops&quot;,</span>
<a href="#l13.1011"></a><span id="l13.1011" class="difflineminus">-        params</span>
<a href="#l13.1012"></a><span id="l13.1012" class="difflineminus">-      );</span>
<a href="#l13.1013"></a><span id="l13.1013" class="difflineminus">-    } catch (exc) {</span>
<a href="#l13.1014"></a><span id="l13.1014" class="difflineminus">-      request.execRespFunc(exc);</span>
<a href="#l13.1015"></a><span id="l13.1015" class="difflineminus">-    }</span>
<a href="#l13.1016"></a><span id="l13.1016" class="difflineminus">-    return request;</span>
<a href="#l13.1017"></a><span id="l13.1017" class="difflineminus">-  },</span>
<a href="#l13.1018"></a><span id="l13.1018" class="difflineminus">-</span>
<a href="#l13.1019"></a><span id="l13.1019" class="difflineminus">-  // calIFreeBusyProvider:</span>
<a href="#l13.1020"></a><span id="l13.1020" class="difflineminus">-  getFreeBusyIntervals: function(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l13.1021"></a><span id="l13.1021" class="difflineminus">-    rangeStart = cal.dtz.ensureDateTime(rangeStart);</span>
<a href="#l13.1022"></a><span id="l13.1022" class="difflineminus">-    rangeEnd = cal.dtz.ensureDateTime(rangeEnd);</span>
<a href="#l13.1023"></a><span id="l13.1023" class="difflineminus">-    let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineminus">-    let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l13.1025"></a><span id="l13.1025" class="difflineminus">-</span>
<a href="#l13.1026"></a><span id="l13.1026" class="difflineminus">-    let request = new calWcapRequest((oprequest, err, data) =&gt; {</span>
<a href="#l13.1027"></a><span id="l13.1027" class="difflineminus">-      let rc = getResultCode(err);</span>
<a href="#l13.1028"></a><span id="l13.1028" class="difflineminus">-      switch (rc) {</span>
<a href="#l13.1029"></a><span id="l13.1029" class="difflineminus">-        case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l13.1030"></a><span id="l13.1030" class="difflineminus">-        case calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR:</span>
<a href="#l13.1031"></a><span id="l13.1031" class="difflineminus">-        case calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST:</span>
<a href="#l13.1032"></a><span id="l13.1032" class="difflineminus">-          log(&quot;getFreeBusyIntervals_resp() error: &quot; + errorToString(err), this);</span>
<a href="#l13.1033"></a><span id="l13.1033" class="difflineminus">-          break;</span>
<a href="#l13.1034"></a><span id="l13.1034" class="difflineminus">-        default:</span>
<a href="#l13.1035"></a><span id="l13.1035" class="difflineminus">-          if (!Components.isSuccessCode(rc)) {</span>
<a href="#l13.1036"></a><span id="l13.1036" class="difflineminus">-            this.notifyError(err);</span>
<a href="#l13.1037"></a><span id="l13.1037" class="difflineminus">-          }</span>
<a href="#l13.1038"></a><span id="l13.1038" class="difflineminus">-          break;</span>
<a href="#l13.1039"></a><span id="l13.1039" class="difflineminus">-      }</span>
<a href="#l13.1040"></a><span id="l13.1040" class="difflineminus">-      if (listener) {</span>
<a href="#l13.1041"></a><span id="l13.1041" class="difflineminus">-        listener.onResult(oprequest, data);</span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineminus">-      }</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineminus">-    }, log(&quot;getFreeBusyIntervals():\n\tcalId=&quot; + calId + &quot;\n\trangeStart=&quot; + zRangeStart + &quot;,\n\trangeEnd=&quot; + zRangeEnd, this));</span>
<a href="#l13.1044"></a><span id="l13.1044" class="difflineminus">-</span>
<a href="#l13.1045"></a><span id="l13.1045" class="difflineminus">-    // cannot use stringToXml here, because cs 6.3 returns plain nothing</span>
<a href="#l13.1046"></a><span id="l13.1046" class="difflineminus">-    // on invalid user freebusy requests. WTF.</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineminus">-    let stringToXml_ = function(session, data) {</span>
<a href="#l13.1048"></a><span id="l13.1048" class="difflineminus">-      if (!data || data.length == 0) {</span>
<a href="#l13.1049"></a><span id="l13.1049" class="difflineminus">-        // assuming invalid user</span>
<a href="#l13.1050"></a><span id="l13.1050" class="difflineminus">-        throw new Components.Exception(</span>
<a href="#l13.1051"></a><span id="l13.1051" class="difflineminus">-          errorToString(calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST),</span>
<a href="#l13.1052"></a><span id="l13.1052" class="difflineminus">-          calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST</span>
<a href="#l13.1053"></a><span id="l13.1053" class="difflineminus">-        );</span>
<a href="#l13.1054"></a><span id="l13.1054" class="difflineminus">-      }</span>
<a href="#l13.1055"></a><span id="l13.1055" class="difflineminus">-      return stringToXml(session, data);</span>
<a href="#l13.1056"></a><span id="l13.1056" class="difflineminus">-    };</span>
<a href="#l13.1057"></a><span id="l13.1057" class="difflineminus">-</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineminus">-    try {</span>
<a href="#l13.1059"></a><span id="l13.1059" class="difflineminus">-      let params = &quot;&amp;calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l13.1060"></a><span id="l13.1060" class="difflineminus">-      params += &quot;&amp;busyonly=&quot; + (busyTypes &amp; calIFreeBusyInterval.FREE ? &quot;0&quot; : &quot;1&quot;);</span>
<a href="#l13.1061"></a><span id="l13.1061" class="difflineminus">-      params += &quot;&amp;dtstart=&quot; + zRangeStart;</span>
<a href="#l13.1062"></a><span id="l13.1062" class="difflineminus">-      params += &quot;&amp;dtend=&quot; + zRangeEnd;</span>
<a href="#l13.1063"></a><span id="l13.1063" class="difflineminus">-      params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l13.1064"></a><span id="l13.1064" class="difflineminus">-</span>
<a href="#l13.1065"></a><span id="l13.1065" class="difflineminus">-      this.issueNetworkRequest(</span>
<a href="#l13.1066"></a><span id="l13.1066" class="difflineminus">-        request,</span>
<a href="#l13.1067"></a><span id="l13.1067" class="difflineminus">-        (err, xml) =&gt; {</span>
<a href="#l13.1068"></a><span id="l13.1068" class="difflineminus">-          if (err) {</span>
<a href="#l13.1069"></a><span id="l13.1069" class="difflineminus">-            throw err;</span>
<a href="#l13.1070"></a><span id="l13.1070" class="difflineminus">-          }</span>
<a href="#l13.1071"></a><span id="l13.1071" class="difflineminus">-          if (LOG_LEVEL &gt; 0) {</span>
<a href="#l13.1072"></a><span id="l13.1072" class="difflineminus">-            log(&quot;getFreeBusyIntervals net_resp(): &quot; + getWcapRequestStatusString(xml), this);</span>
<a href="#l13.1073"></a><span id="l13.1073" class="difflineminus">-          }</span>
<a href="#l13.1074"></a><span id="l13.1074" class="difflineminus">-          if (listener) {</span>
<a href="#l13.1075"></a><span id="l13.1075" class="difflineminus">-            let ret = [];</span>
<a href="#l13.1076"></a><span id="l13.1076" class="difflineminus">-            let nodeList = xml.getElementsByTagName(&quot;FB&quot;);</span>
<a href="#l13.1077"></a><span id="l13.1077" class="difflineminus">-</span>
<a href="#l13.1078"></a><span id="l13.1078" class="difflineminus">-            let fbTypeMap = {};</span>
<a href="#l13.1079"></a><span id="l13.1079" class="difflineminus">-            fbTypeMap.FREE = calIFreeBusyInterval.FREE;</span>
<a href="#l13.1080"></a><span id="l13.1080" class="difflineminus">-            fbTypeMap.BUSY = calIFreeBusyInterval.BUSY;</span>
<a href="#l13.1081"></a><span id="l13.1081" class="difflineminus">-            fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l13.1082"></a><span id="l13.1082" class="difflineminus">-            fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l13.1083"></a><span id="l13.1083" class="difflineminus">-</span>
<a href="#l13.1084"></a><span id="l13.1084" class="difflineminus">-            for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l13.1085"></a><span id="l13.1085" class="difflineminus">-              let node = nodeList.item(i);</span>
<a href="#l13.1086"></a><span id="l13.1086" class="difflineminus">-              let fbType = fbTypeMap[node.attributes.getNamedItem(&quot;FBTYPE&quot;).nodeValue];</span>
<a href="#l13.1087"></a><span id="l13.1087" class="difflineminus">-              if (!fbType || fbType &amp; busyTypes) {</span>
<a href="#l13.1088"></a><span id="l13.1088" class="difflineminus">-                if (!fbType) {</span>
<a href="#l13.1089"></a><span id="l13.1089" class="difflineminus">-                  fbType = calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l13.1090"></a><span id="l13.1090" class="difflineminus">-                }</span>
<a href="#l13.1091"></a><span id="l13.1091" class="difflineminus">-                let str = node.textContent;</span>
<a href="#l13.1092"></a><span id="l13.1092" class="difflineminus">-                let slash = str.indexOf(&quot;/&quot;);</span>
<a href="#l13.1093"></a><span id="l13.1093" class="difflineminus">-                let start = getDatetimeFromIcalString(str.substr(0, slash));</span>
<a href="#l13.1094"></a><span id="l13.1094" class="difflineminus">-                let end = getDatetimeFromIcalString(str.substr(slash + 1));</span>
<a href="#l13.1095"></a><span id="l13.1095" class="difflineminus">-</span>
<a href="#l13.1096"></a><span id="l13.1096" class="difflineminus">-                ret.push(new cal.provider.FreeBusyInterval(calId, fbType, start, end));</span>
<a href="#l13.1097"></a><span id="l13.1097" class="difflineminus">-              }</span>
<a href="#l13.1098"></a><span id="l13.1098" class="difflineminus">-            }</span>
<a href="#l13.1099"></a><span id="l13.1099" class="difflineminus">-            request.execRespFunc(null, ret);</span>
<a href="#l13.1100"></a><span id="l13.1100" class="difflineminus">-          }</span>
<a href="#l13.1101"></a><span id="l13.1101" class="difflineminus">-        },</span>
<a href="#l13.1102"></a><span id="l13.1102" class="difflineminus">-        stringToXml_,</span>
<a href="#l13.1103"></a><span id="l13.1103" class="difflineminus">-        &quot;get_freebusy&quot;,</span>
<a href="#l13.1104"></a><span id="l13.1104" class="difflineminus">-        params</span>
<a href="#l13.1105"></a><span id="l13.1105" class="difflineminus">-      );</span>
<a href="#l13.1106"></a><span id="l13.1106" class="difflineminus">-    } catch (exc) {</span>
<a href="#l13.1107"></a><span id="l13.1107" class="difflineminus">-      request.execRespFunc(exc);</span>
<a href="#l13.1108"></a><span id="l13.1108" class="difflineminus">-    }</span>
<a href="#l13.1109"></a><span id="l13.1109" class="difflineminus">-    return request;</span>
<a href="#l13.1110"></a><span id="l13.1110" class="difflineminus">-  },</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineminus">-</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineminus">-  // nsIObserver:</span>
<a href="#l13.1113"></a><span id="l13.1113" class="difflineminus">-  observe: function(subject, topic, data) {</span>
<a href="#l13.1114"></a><span id="l13.1114" class="difflineminus">-    log(&quot;observing: &quot; + topic + &quot;, data: &quot; + data, this);</span>
<a href="#l13.1115"></a><span id="l13.1115" class="difflineminus">-    if (topic == &quot;quit-application&quot;) {</span>
<a href="#l13.1116"></a><span id="l13.1116" class="difflineminus">-      g_bShutdown = true;</span>
<a href="#l13.1117"></a><span id="l13.1117" class="difflineminus">-      this.logout(null);</span>
<a href="#l13.1118"></a><span id="l13.1118" class="difflineminus">-      // xxx todo: valid upon notification?</span>
<a href="#l13.1119"></a><span id="l13.1119" class="difflineminus">-      cal.getCalendarManager().removeObserver(this);</span>
<a href="#l13.1120"></a><span id="l13.1120" class="difflineminus">-      Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l13.1121"></a><span id="l13.1121" class="difflineminus">-    }</span>
<a href="#l13.1122"></a><span id="l13.1122" class="difflineminus">-  },</span>
<a href="#l13.1123"></a><span id="l13.1123" class="difflineminus">-</span>
<a href="#l13.1124"></a><span id="l13.1124" class="difflineminus">-  // calICalendarManagerObserver:</span>
<a href="#l13.1125"></a><span id="l13.1125" class="difflineminus">-</span>
<a href="#l13.1126"></a><span id="l13.1126" class="difflineminus">-  // called after the calendar is registered</span>
<a href="#l13.1127"></a><span id="l13.1127" class="difflineminus">-  onCalendarRegistered: function(aCalendar) {</span>
<a href="#l13.1128"></a><span id="l13.1128" class="difflineminus">-    function assureDefault(pref, val) {</span>
<a href="#l13.1129"></a><span id="l13.1129" class="difflineminus">-      if (aCalendar.getProperty(pref) === null) {</span>
<a href="#l13.1130"></a><span id="l13.1130" class="difflineminus">-        aCalendar.setProperty(pref, val);</span>
<a href="#l13.1131"></a><span id="l13.1131" class="difflineminus">-      }</span>
<a href="#l13.1132"></a><span id="l13.1132" class="difflineminus">-    }</span>
<a href="#l13.1133"></a><span id="l13.1133" class="difflineminus">-</span>
<a href="#l13.1134"></a><span id="l13.1134" class="difflineminus">-    try {</span>
<a href="#l13.1135"></a><span id="l13.1135" class="difflineminus">-      // make sure the calendar belongs to this session:</span>
<a href="#l13.1136"></a><span id="l13.1136" class="difflineminus">-      if (this.belongsTo(aCalendar)) {</span>
<a href="#l13.1137"></a><span id="l13.1137" class="difflineminus">-        assureDefault(&quot;shared_context&quot;, this.m_contextId);</span>
<a href="#l13.1138"></a><span id="l13.1138" class="difflineminus">-        assureDefault(&quot;name&quot;, aCalendar.name);</span>
<a href="#l13.1139"></a><span id="l13.1139" class="difflineminus">-</span>
<a href="#l13.1140"></a><span id="l13.1140" class="difflineminus">-        const s_colors = [</span>
<a href="#l13.1141"></a><span id="l13.1141" class="difflineminus">-          &quot;#FFCCCC&quot;,</span>
<a href="#l13.1142"></a><span id="l13.1142" class="difflineminus">-          &quot;#FFCC99&quot;,</span>
<a href="#l13.1143"></a><span id="l13.1143" class="difflineminus">-          &quot;#FFFF99&quot;,</span>
<a href="#l13.1144"></a><span id="l13.1144" class="difflineminus">-          &quot;#FFFFCC&quot;,</span>
<a href="#l13.1145"></a><span id="l13.1145" class="difflineminus">-          &quot;#99FF99&quot;,</span>
<a href="#l13.1146"></a><span id="l13.1146" class="difflineminus">-          &quot;#99FFFF&quot;,</span>
<a href="#l13.1147"></a><span id="l13.1147" class="difflineminus">-          &quot;#CCFFFF&quot;,</span>
<a href="#l13.1148"></a><span id="l13.1148" class="difflineminus">-          &quot;#CCCCFF&quot;,</span>
<a href="#l13.1149"></a><span id="l13.1149" class="difflineminus">-          &quot;#FFCCFF&quot;,</span>
<a href="#l13.1150"></a><span id="l13.1150" class="difflineminus">-          &quot;#FF6666&quot;,</span>
<a href="#l13.1151"></a><span id="l13.1151" class="difflineminus">-          &quot;#FF9966&quot;,</span>
<a href="#l13.1152"></a><span id="l13.1152" class="difflineminus">-          &quot;#FFFF66&quot;,</span>
<a href="#l13.1153"></a><span id="l13.1153" class="difflineminus">-          &quot;#FFFF33&quot;,</span>
<a href="#l13.1154"></a><span id="l13.1154" class="difflineminus">-          &quot;#66FF99&quot;,</span>
<a href="#l13.1155"></a><span id="l13.1155" class="difflineminus">-          &quot;#33FFFF&quot;,</span>
<a href="#l13.1156"></a><span id="l13.1156" class="difflineminus">-          &quot;#66FFFF&quot;,</span>
<a href="#l13.1157"></a><span id="l13.1157" class="difflineminus">-          &quot;#9999FF&quot;,</span>
<a href="#l13.1158"></a><span id="l13.1158" class="difflineminus">-          &quot;#FF99FF&quot;,</span>
<a href="#l13.1159"></a><span id="l13.1159" class="difflineminus">-          &quot;#FF0000&quot;,</span>
<a href="#l13.1160"></a><span id="l13.1160" class="difflineminus">-          &quot;#FF9900&quot;,</span>
<a href="#l13.1161"></a><span id="l13.1161" class="difflineminus">-          &quot;#FFCC66&quot;,</span>
<a href="#l13.1162"></a><span id="l13.1162" class="difflineminus">-          &quot;#FFFF00&quot;,</span>
<a href="#l13.1163"></a><span id="l13.1163" class="difflineminus">-          &quot;#33FF33&quot;,</span>
<a href="#l13.1164"></a><span id="l13.1164" class="difflineminus">-          &quot;#66CCCC&quot;,</span>
<a href="#l13.1165"></a><span id="l13.1165" class="difflineminus">-          &quot;#33CCFF&quot;,</span>
<a href="#l13.1166"></a><span id="l13.1166" class="difflineminus">-          &quot;#6666CC&quot;,</span>
<a href="#l13.1167"></a><span id="l13.1167" class="difflineminus">-          &quot;#CC66CC&quot;,</span>
<a href="#l13.1168"></a><span id="l13.1168" class="difflineminus">-          &quot;#CC0000&quot;,</span>
<a href="#l13.1169"></a><span id="l13.1169" class="difflineminus">-          &quot;#FF6600&quot;,</span>
<a href="#l13.1170"></a><span id="l13.1170" class="difflineminus">-          &quot;#FFCC33&quot;,</span>
<a href="#l13.1171"></a><span id="l13.1171" class="difflineminus">-          &quot;#FFCC00&quot;,</span>
<a href="#l13.1172"></a><span id="l13.1172" class="difflineminus">-          &quot;#33CC00&quot;,</span>
<a href="#l13.1173"></a><span id="l13.1173" class="difflineminus">-          &quot;#00CCCC&quot;,</span>
<a href="#l13.1174"></a><span id="l13.1174" class="difflineminus">-          &quot;#3366FF&quot;,</span>
<a href="#l13.1175"></a><span id="l13.1175" class="difflineminus">-          &quot;#6633FF&quot;,</span>
<a href="#l13.1176"></a><span id="l13.1176" class="difflineminus">-          &quot;#CC33CC&quot;,</span>
<a href="#l13.1177"></a><span id="l13.1177" class="difflineminus">-          &quot;#990000&quot;,</span>
<a href="#l13.1178"></a><span id="l13.1178" class="difflineminus">-          &quot;#CC6600&quot;,</span>
<a href="#l13.1179"></a><span id="l13.1179" class="difflineminus">-          &quot;#CC9933&quot;,</span>
<a href="#l13.1180"></a><span id="l13.1180" class="difflineminus">-          &quot;#999900&quot;,</span>
<a href="#l13.1181"></a><span id="l13.1181" class="difflineminus">-          &quot;#009900&quot;,</span>
<a href="#l13.1182"></a><span id="l13.1182" class="difflineminus">-          &quot;#339999&quot;,</span>
<a href="#l13.1183"></a><span id="l13.1183" class="difflineminus">-          &quot;#3333FF&quot;,</span>
<a href="#l13.1184"></a><span id="l13.1184" class="difflineminus">-          &quot;#6600CC&quot;,</span>
<a href="#l13.1185"></a><span id="l13.1185" class="difflineminus">-          &quot;#993399&quot;,</span>
<a href="#l13.1186"></a><span id="l13.1186" class="difflineminus">-          &quot;#660000&quot;,</span>
<a href="#l13.1187"></a><span id="l13.1187" class="difflineminus">-          &quot;#993300&quot;,</span>
<a href="#l13.1188"></a><span id="l13.1188" class="difflineminus">-          &quot;#996633&quot;,</span>
<a href="#l13.1189"></a><span id="l13.1189" class="difflineminus">-          &quot;#666600&quot;,</span>
<a href="#l13.1190"></a><span id="l13.1190" class="difflineminus">-          &quot;#006600&quot;,</span>
<a href="#l13.1191"></a><span id="l13.1191" class="difflineminus">-          &quot;#336666&quot;,</span>
<a href="#l13.1192"></a><span id="l13.1192" class="difflineminus">-          &quot;#000099&quot;,</span>
<a href="#l13.1193"></a><span id="l13.1193" class="difflineminus">-          &quot;#333399&quot;,</span>
<a href="#l13.1194"></a><span id="l13.1194" class="difflineminus">-          &quot;#663366&quot;,</span>
<a href="#l13.1195"></a><span id="l13.1195" class="difflineminus">-          &quot;#330000&quot;,</span>
<a href="#l13.1196"></a><span id="l13.1196" class="difflineminus">-          &quot;#663300&quot;,</span>
<a href="#l13.1197"></a><span id="l13.1197" class="difflineminus">-          &quot;#663333&quot;,</span>
<a href="#l13.1198"></a><span id="l13.1198" class="difflineminus">-          &quot;#333300&quot;,</span>
<a href="#l13.1199"></a><span id="l13.1199" class="difflineminus">-          &quot;#003300&quot;,</span>
<a href="#l13.1200"></a><span id="l13.1200" class="difflineminus">-          &quot;#003333&quot;,</span>
<a href="#l13.1201"></a><span id="l13.1201" class="difflineminus">-          &quot;#000066&quot;,</span>
<a href="#l13.1202"></a><span id="l13.1202" class="difflineminus">-          &quot;#330099&quot;,</span>
<a href="#l13.1203"></a><span id="l13.1203" class="difflineminus">-          &quot;#330033&quot;,</span>
<a href="#l13.1204"></a><span id="l13.1204" class="difflineminus">-        ];</span>
<a href="#l13.1205"></a><span id="l13.1205" class="difflineminus">-        assureDefault(&quot;color&quot;, s_colors[new Date().getUTCMilliseconds() % s_colors.length]);</span>
<a href="#l13.1206"></a><span id="l13.1206" class="difflineminus">-      }</span>
<a href="#l13.1207"></a><span id="l13.1207" class="difflineminus">-    } catch (exc) {</span>
<a href="#l13.1208"></a><span id="l13.1208" class="difflineminus">-      // never break the listener chain</span>
<a href="#l13.1209"></a><span id="l13.1209" class="difflineminus">-      this.notifyError(exc);</span>
<a href="#l13.1210"></a><span id="l13.1210" class="difflineminus">-    }</span>
<a href="#l13.1211"></a><span id="l13.1211" class="difflineminus">-  },</span>
<a href="#l13.1212"></a><span id="l13.1212" class="difflineminus">-</span>
<a href="#l13.1213"></a><span id="l13.1213" class="difflineminus">-  // called before the unregister actually takes place</span>
<a href="#l13.1214"></a><span id="l13.1214" class="difflineminus">-  onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l13.1215"></a><span id="l13.1215" class="difflineminus">-    try {</span>
<a href="#l13.1216"></a><span id="l13.1216" class="difflineminus">-      // make sure the calendar belongs to this session and is the default calendar,</span>
<a href="#l13.1217"></a><span id="l13.1217" class="difflineminus">-      // then remove all subscribed calendars:</span>
<a href="#l13.1218"></a><span id="l13.1218" class="difflineminus">-      aCalendar = this.belongsTo(aCalendar);</span>
<a href="#l13.1219"></a><span id="l13.1219" class="difflineminus">-      if (aCalendar &amp;&amp; aCalendar.isDefaultCalendar) {</span>
<a href="#l13.1220"></a><span id="l13.1220" class="difflineminus">-        cal.getFreeBusyService().removeProvider(this);</span>
<a href="#l13.1221"></a><span id="l13.1221" class="difflineminus">-        cal.getCalendarSearchService().removeProvider(this);</span>
<a href="#l13.1222"></a><span id="l13.1222" class="difflineminus">-        let registeredCalendars = this.getRegisteredCalendars();</span>
<a href="#l13.1223"></a><span id="l13.1223" class="difflineminus">-        for (let regCal of registeredCalendars) {</span>
<a href="#l13.1224"></a><span id="l13.1224" class="difflineminus">-          try {</span>
<a href="#l13.1225"></a><span id="l13.1225" class="difflineminus">-            if (!regCal.isDefaultCalendar) {</span>
<a href="#l13.1226"></a><span id="l13.1226" class="difflineminus">-              cal.getCalendarManager().unregisterCalendar(regCal);</span>
<a href="#l13.1227"></a><span id="l13.1227" class="difflineminus">-            }</span>
<a href="#l13.1228"></a><span id="l13.1228" class="difflineminus">-          } catch (exc) {</span>
<a href="#l13.1229"></a><span id="l13.1229" class="difflineminus">-            this.notifyError(exc);</span>
<a href="#l13.1230"></a><span id="l13.1230" class="difflineminus">-          }</span>
<a href="#l13.1231"></a><span id="l13.1231" class="difflineminus">-        }</span>
<a href="#l13.1232"></a><span id="l13.1232" class="difflineminus">-      }</span>
<a href="#l13.1233"></a><span id="l13.1233" class="difflineminus">-    } catch (exc) {</span>
<a href="#l13.1234"></a><span id="l13.1234" class="difflineminus">-      // never break the listener chain</span>
<a href="#l13.1235"></a><span id="l13.1235" class="difflineminus">-      this.notifyError(exc);</span>
<a href="#l13.1236"></a><span id="l13.1236" class="difflineminus">-    }</span>
<a href="#l13.1237"></a><span id="l13.1237" class="difflineminus">-  },</span>
<a href="#l13.1238"></a><span id="l13.1238" class="difflineminus">-</span>
<a href="#l13.1239"></a><span id="l13.1239" class="difflineminus">-  // called before the delete actually takes place</span>
<a href="#l13.1240"></a><span id="l13.1240" class="difflineminus">-  onCalendarDeleting: function(aCalendar) {},</span>
<a href="#l13.1241"></a><span id="l13.1241" class="difflineminus">-};</span>
<a href="#l13.1242"></a><span id="l13.1242" class="difflineminus">-</span>
<a href="#l13.1243"></a><span id="l13.1243" class="difflineminus">-function confirmInsecureLogin(uri) {</span>
<a href="#l13.1244"></a><span id="l13.1244" class="difflineminus">-  if (!confirmInsecureLogin.m_confirmedHttpLogins) {</span>
<a href="#l13.1245"></a><span id="l13.1245" class="difflineminus">-    confirmInsecureLogin.m_confirmedHttpLogins = {};</span>
<a href="#l13.1246"></a><span id="l13.1246" class="difflineminus">-    let confirmedHttpLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l13.1247"></a><span id="l13.1247" class="difflineminus">-    let tuples = confirmedHttpLogins.split(&quot;,&quot;);</span>
<a href="#l13.1248"></a><span id="l13.1248" class="difflineminus">-    for (let tuple of tuples) {</span>
<a href="#l13.1249"></a><span id="l13.1249" class="difflineminus">-      let part = tuple.split(&quot;:&quot;);</span>
<a href="#l13.1250"></a><span id="l13.1250" class="difflineminus">-      confirmInsecureLogin.m_confirmedHttpLogins[part[0]] = part[1];</span>
<a href="#l13.1251"></a><span id="l13.1251" class="difflineminus">-    }</span>
<a href="#l13.1252"></a><span id="l13.1252" class="difflineminus">-  }</span>
<a href="#l13.1253"></a><span id="l13.1253" class="difflineminus">-</span>
<a href="#l13.1254"></a><span id="l13.1254" class="difflineminus">-  let bConfirmed = false;</span>
<a href="#l13.1255"></a><span id="l13.1255" class="difflineminus">-</span>
<a href="#l13.1256"></a><span id="l13.1256" class="difflineminus">-  let host = uri.hostPort;</span>
<a href="#l13.1257"></a><span id="l13.1257" class="difflineminus">-  let encodedHost = encodeURIComponent(host);</span>
<a href="#l13.1258"></a><span id="l13.1258" class="difflineminus">-  let confirmedEntry = confirmInsecureLogin.m_confirmedHttpLogins[encodedHost];</span>
<a href="#l13.1259"></a><span id="l13.1259" class="difflineminus">-  if (confirmedEntry) {</span>
<a href="#l13.1260"></a><span id="l13.1260" class="difflineminus">-    bConfirmed = confirmedEntry == &quot;1&quot;;</span>
<a href="#l13.1261"></a><span id="l13.1261" class="difflineminus">-  } else {</span>
<a href="#l13.1262"></a><span id="l13.1262" class="difflineminus">-    let prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l13.1263"></a><span id="l13.1263" class="difflineminus">-    let out_dontAskAgain = { value: false };</span>
<a href="#l13.1264"></a><span id="l13.1264" class="difflineminus">-    bConfirmed = prompt.confirmCheck(</span>
<a href="#l13.1265"></a><span id="l13.1265" class="difflineminus">-      getWcapString(&quot;noHttpsConfirmation.label&quot;),</span>
<a href="#l13.1266"></a><span id="l13.1266" class="difflineminus">-      getWcapString(&quot;noHttpsConfirmation.text&quot;, [host]),</span>
<a href="#l13.1267"></a><span id="l13.1267" class="difflineminus">-      getWcapString(&quot;noHttpsConfirmation.check.text&quot;),</span>
<a href="#l13.1268"></a><span id="l13.1268" class="difflineminus">-      out_dontAskAgain</span>
<a href="#l13.1269"></a><span id="l13.1269" class="difflineminus">-    );</span>
<a href="#l13.1270"></a><span id="l13.1270" class="difflineminus">-</span>
<a href="#l13.1271"></a><span id="l13.1271" class="difflineminus">-    if (out_dontAskAgain.value) {</span>
<a href="#l13.1272"></a><span id="l13.1272" class="difflineminus">-      // save decision for all running calendars and</span>
<a href="#l13.1273"></a><span id="l13.1273" class="difflineminus">-      // all future confirmations:</span>
<a href="#l13.1274"></a><span id="l13.1274" class="difflineminus">-      let newConfirmedLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l13.1275"></a><span id="l13.1275" class="difflineminus">-      if (newConfirmedLogins.length &gt; 0) {</span>
<a href="#l13.1276"></a><span id="l13.1276" class="difflineminus">-        newConfirmedLogins += &quot;,&quot;;</span>
<a href="#l13.1277"></a><span id="l13.1277" class="difflineminus">-      }</span>
<a href="#l13.1278"></a><span id="l13.1278" class="difflineminus">-      confirmedEntry = bConfirmed ? &quot;1&quot; : &quot;0&quot;;</span>
<a href="#l13.1279"></a><span id="l13.1279" class="difflineminus">-      newConfirmedLogins += encodedHost + &quot;:&quot; + confirmedEntry;</span>
<a href="#l13.1280"></a><span id="l13.1280" class="difflineminus">-      Services.prefs.setStringPref(&quot;calendar.wcap.confirmed_http_logins&quot;, newConfirmedLogins);</span>
<a href="#l13.1281"></a><span id="l13.1281" class="difflineminus">-      getPref(&quot;calendar.wcap.confirmed_http_logins&quot;); // log written entry</span>
<a href="#l13.1282"></a><span id="l13.1282" class="difflineminus">-      confirmInsecureLogin.m_confirmedHttpLogins[encodedHost] = confirmedEntry;</span>
<a href="#l13.1283"></a><span id="l13.1283" class="difflineminus">-    }</span>
<a href="#l13.1284"></a><span id="l13.1284" class="difflineminus">-  }</span>
<a href="#l13.1285"></a><span id="l13.1285" class="difflineminus">-</span>
<a href="#l13.1286"></a><span id="l13.1286" class="difflineminus">-  log(&quot;returned: &quot; + bConfirmed, &quot;confirmInsecureLogin(&quot; + host + &quot;)&quot;);</span>
<a href="#l13.1287"></a><span id="l13.1287" class="difflineminus">-  return bConfirmed;</span>
<a href="#l13.1288"></a><span id="l13.1288" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,242 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-/* exported getCalendarSearchService, getDomParser, isParent, filterXmlNodes,</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">- *          getIcalUTC, getDatetimeFromIcalProp, getWcapString</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">- */</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-/* import-globals-from calWcapCalendarModule.js */</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-var { Preferences } = ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-var g_bShutdown = false;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-function initLogging() {</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-  initLogging.mLogTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-  if (initLogging.mLogFilestream) {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-    try {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-      initLogging.mLogFilestream.close();</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-    } catch (exc) {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-      cal.ASSERT(false, exc);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-    }</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    initLogging.mLogFilestream = null;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  }</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  LOG_LEVEL = getPref(&quot;calendar.wcap.log_level&quot;, 0);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  if (LOG_LEVEL &lt; 1 &amp;&amp; getPref(&quot;calendar.debug.log&quot;, false)) {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-    LOG_LEVEL = 1; // at least basic logging when calendar.debug.log is set</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-  }</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-  if (LOG_LEVEL &gt; 0) {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-    let logFileName = getPref(&quot;calendar.wcap.log_file&quot;, null);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    if (logFileName) {</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-      try {</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-        // set up file:</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-        let logFile = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-        logFile.initWithPath(logFileName);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-        // create output stream:</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-        let logFileStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].createInstance(</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-          Ci.nsIFileOutputStream</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-        );</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-        logFileStream.init(</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-          logFile,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-          0x02 /* PR_WRONLY */ |</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-          0x08 /* PR_CREATE_FILE */ |</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-            (getPref(&quot;calendar.wcap.log_file_append&quot;, false)</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-              ? 0x10 /* PR_APPEND */</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-              : 0x20) /* PR_TRUNCATE */,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-          parseInt(&quot;0700&quot;, 8) /* read, write, execute/search by owner */,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-          0 /* unused */</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-        );</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-        initLogging.mLogFilestream = logFileStream;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-      } catch (exc) {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-        logError(exc, &quot;init logging&quot;);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-      }</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-    }</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-    log(</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-      &quot;################################# NEW WCAP LOG #################################&quot;,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-      &quot;init logging&quot;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-    );</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-    logWarning(</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-      &quot;WCAP logging enabled! level=&quot; +</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-        LOG_LEVEL +</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-        (initLogging.mLogFilestream ? &quot;, file=&quot; + logFileName : &quot;&quot;)</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-    );</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-  }</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  if (!initLogging.mLogPrefObserver) {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    initLogging.mLogPrefObserver = {</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-      // nsIObserver:</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-      observe: function(subject, topic, data) {</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-        if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-          switch (data) {</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-            case &quot;calendar.wcap.log_level&quot;:</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-            case &quot;calendar.wcap.log_file&quot;:</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-            case &quot;calendar.debug.log&quot;:</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-              initLogging();</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-              break;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-          }</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-        }</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-      },</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-    };</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-    Services.prefs.addObserver(&quot;calendar.wcap.log_level&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-    Services.prefs.addObserver(&quot;calendar.wcap.log_file&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-    Services.prefs.addObserver(&quot;calendar.debug.log&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    let appObserver = {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-      // nsIObserver:</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-      observe: function(subject, topic, data) {</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-        if (topic == &quot;quit-application&quot;) {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-          Services.prefs.removeObserver(&quot;calendar.&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-        }</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-      },</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-    };</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-    Services.obs.addObserver(appObserver, &quot;quit-application&quot;);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-  }</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-}</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-function log(msg, context, bForce) {</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-  if (bForce || LOG_LEVEL &gt; 0) {</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-    let ret = &quot;&quot;;</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-    if (context) {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-      ret += &quot;[&quot; + context + &quot;]&quot;;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-    }</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-    if (ret.length &gt; 0) {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-      ret += &quot;\n&quot;;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-    }</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-    ret += msg;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-    let now = getTime();</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-    if (now &amp;&amp; initLogging.mLogTimezone) {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-      now = now.getInTimezone(initLogging.mLogTimezone);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-    }</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-    let str = &quot;### WCAP log entry: &quot; + now + &quot;\n&quot; + ret;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-    Services.console.logStringMessage(str);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-    str = &quot;\n&quot; + str + &quot;\n&quot;;</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-    dump(str);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-    if (initLogging.mLogFilestream) {</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-      try {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-        // xxx todo?</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-        // assuming ANSI chars here, for logging sufficient:</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-        initLogging.mLogFilestream.write(str, str.length);</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-      } catch (exc) {</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-        // catching any io errors here:</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-        let err = &quot;error writing log file: &quot; + errorToString(exc);</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-        Cu.reportError(exc);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-        Services.console.logStringMessage(err);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-        dump(err + &quot;\n\n&quot;);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-      }</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-    }</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-    return ret;</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-  } else {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-    return msg;</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-  }</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-}</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-function logWarning(err, context) {</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-  let msg = errorToString(err);</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-  let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(Ci.nsIScriptError);</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-  scriptError.init(</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-    log(&quot;warning: &quot; + msg, context, true),</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-    null,</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-    null,</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-    0,</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-    0,</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-    Ci.nsIScriptError.warningFlag,</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-    &quot;component javascript&quot;</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-  );</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-  Services.console.logMessage(scriptError);</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-  return msg;</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-}</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-function logError(err, context) {</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-  let msg = errorToString(err);</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-  Cu.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + cal.STACK(10), context, true));</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-  return msg;</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-}</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-// late-inited service accessors:</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-function getCalendarSearchService() {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-  if (!getCalendarSearchService.m_obj) {</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-    getCalendarSearchService.m_obj = Cc[</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-      &quot;@mozilla.org/calendar/calendarsearch-service;1&quot;</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-    ].getService(Ci.calICalendarSearchService);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-  }</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-  return getCalendarSearchService.m_obj;</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-}</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-function getDomParser() {</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-  if (!getDomParser.m_obj) {</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-    getDomParser.m_obj = new DOMParser();</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-  }</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-  return getDomParser.m_obj;</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-}</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-function isParent(item) {</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-  if (item.id != item.parentItem.id) {</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-    throw new Components.Exception(&quot;proxy has different id than its parent!&quot;);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-  }</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-  return !item.recurrenceId;</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-}</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-function filterXmlNodes(name, rootNode) {</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-  let ret = [];</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-  if (rootNode) {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-    let nodeList = rootNode.getElementsByTagName(name);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-    for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-      let node = nodeList.item(i);</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-      ret.push(node.textContent.trim());</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-    }</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-  }</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-  return ret;</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-}</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-function getTime() {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-  if (g_bShutdown) {</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-    return null;</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-  }</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-  return cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-}</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-function getIcalUTC(date) {</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-  if (!date || !date.isValid) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-    return &quot;0&quot;;</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-  } else {</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-    let dtz = date.timezone;</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-    if (dtz.isUTC || dtz.isFloating) {</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-      return date.icalString;</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-    } else {</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-      return date.getInTimezone(cal.dtz.UTC).icalString;</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-    }</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-  }</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-}</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-function getDatetimeFromIcalString(val) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-  if (!val || val.length == 0 || val == &quot;0&quot;) {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineminus">-    return null;</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-  }</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-  // assuming timezone is known:</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-  let date = cal.createDateTime();</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-  date.icalString = val;</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-  return date;</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-}</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-function getDatetimeFromIcalProp(prop) {</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-  if (!prop) {</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-    return null;</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-  }</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-  return getDatetimeFromIcalString(prop.valueAsIcalString);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-}</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-function getPref(prefName, defaultValue) {</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-  let ret = Preferences.get(prefName, defaultValue);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-  log(ret, &quot;getPref(): prefName=&quot; + prefName);</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-  return ret;</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-}</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-function getWcapString(aStringName, aParams) {</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-  return cal.l10n.getString(&quot;wcap&quot;, aStringName, aParams);</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/calendar/providers/wcap/moz.build</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,23 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-DIRS += ['public']</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    'calWcapCalendarModule.js',</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    'calWcapCalendarModule.manifest',</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-]</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-FINAL_TARGET_FILES['calendar-js'] += [</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-    'calWcapCalendar.js',</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    'calWcapCalendarItems.js',</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-    'calWcapErrors.js',</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-    'calWcapRequest.js',</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    'calWcapSession.js',</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    'calWcapUtils.js',</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-]</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-with Files('**'):</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-    BUG_COMPONENT = ('Calendar', 'Provider: WCAP')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/calendar/providers/wcap/public/calIWcapCalendar.idl</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,281 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-#include &quot;calICalendar.idl&quot;</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-interface calIDateTime;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-interface calIWcapSession;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-/** Adds WCAP specific capabilities to calICalendar.</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">- */</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-[scriptable, uuid(21A189DF-6C92-41f6-9E2B-1929EF25CAEE)]</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-interface calIWcapCalendar : calICalendar</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-{</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-    /**</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-     * User session this calendar instance belongs to.</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-     */</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-    readonly attribute calIWcapSession session;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-    /**</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-     * Current calId the calendar instance acts on; defaults to userId.</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-     */</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-    readonly attribute string calId;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-    /**</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-     * UserId of primary owner of this calendar instance.</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-     */</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-    readonly attribute string ownerId;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-    /**</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-     * Determines whether this calendar instance is the user's default calendar.</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-     */</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-    readonly attribute boolean isDefaultCalendar;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-    /**</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-     * Whether the currently selected calendar belongs to user.</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-     */</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-    readonly attribute boolean isOwnedCalendar;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-    /**</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-     * Calendar description.</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-     */</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-    readonly attribute string description;</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-    /**</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-     * Calendar display name.</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-     */</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-    readonly attribute string displayName;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-    /**</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-     * Gets this calendar's (calId) default timezone.</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-     */</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-    readonly attribute string defaultTimezone;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-    /**</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-     * Gets calendar properties.</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-     *</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-     * @param propName property name (e.g. X-S1CS-CALPROPS-COMMON-NAME)</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-     */</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-    Array&lt;AString&gt; getCalendarProperties(in string propName);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-    /* xxx todo: additional filters sensible for calICalendar, too?</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-                 claiming bits 24-30 for now.</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-                 Those bits are somehow handled special now:</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-                 If at least one of the below is set, then</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-                 that filter bit(s) are active.</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-                 If none of the below is set, then those compstate</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-                 filters are not taken into account at all.</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-                 So there is no need to OR all of the below together</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-                 (ITEM_FILTER_ALL_ITEMS does not cover these bits) if you</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-                 don't care about the REQUEST/REPLY states.</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-       xxx todo: ITEM_FILTER_CLASS_OCCURRENCES is not filter, rename?</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-    */</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-    /* xxx todo: limit to currently needed ones: NEEDS-ACTION */</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-//     /**</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-//      * Scope: getItems only</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-//      * Whether getItems should only return items that have alarms set for the</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-//      * specified range.</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-//      */</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-//     const unsigned long ITEM_FILTER_BY_ALARM_RANGE = 1 &lt;&lt; 23;</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-//     /**</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-//      * Scope: Attendee</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-//      * The event or todo is an invitation from another</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-//      * user and the current user has declined the invitation.</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-//      */</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-//     const unsigned long ITEM_FILTER_REPLY_DECLINED = 1 &lt;&lt; 24;</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-//     /**</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-//      * Scope: Attendee</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-//      * The event or todo is an invitation from another</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-//      * user and the current user has accepted the invitation.</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-//      */</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-//     const unsigned long ITEM_FILTER_REPLY_ACCEPTED = 1 &lt;&lt; 25;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-//     /**</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-//      * Scope: Organizer</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-//      * The event or todo is an invitation from the current</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-//      * user to other invitees, and all invitees have replied.</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-//      */</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-//     const unsigned long ITEM_FILTER_REQUEST_COMPLETED = 1 &lt;&lt; 26;</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-//     /**</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-//      * Scope: Attendee</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-//      * The event or todo is an invitation from another</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-//      * user and the current user has not replied to it yet.</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-//      */</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-//     const unsigned long ITEM_FILTER_REQUEST_NEEDS_ACTION = 1 &lt;&lt; 27;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-//     /**</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-//      * Scope: Attendee</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-//      * The event or todo is an invitation from another</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-//      * user and the current user is not required to reply.</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-//      */</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-//     const unsigned long ITEM_FILTER_REQUEST_NEEDSNOACTION  = 1 &lt;&lt; 28;</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-//     /**</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-//      * Scope: Organizer</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-//      * The event or todo is an invitation from the current</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-//      * user to other invitees, and is currently in the</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-//      * process of sending out invitations.</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-//      */</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-//     const unsigned long ITEM_FILTER_REQUEST_PENDING = 1 &lt;&lt; 29;</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-//     /**</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-//      * Scope: Organizer</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-//      * The event or todo is an invitation from the current</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-//      * user to other invitees, and is currently awaiting.</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-//      */</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-//     const unsigned long ITEM_FILTER_REQUEST_WAITFORREPLY = 1 &lt;&lt; 30;</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-    /* xxx todo:</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-       separate out into another interface and leave only an attribute</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-       readonly attribute calIWcapAccessControl accessControl;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-       here?</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-       This would bloat client code somehow like</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-       if (cal.accessControl &amp;&amp;</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-           cal.accessControl.check(calIAccessControl.AC_COMP_WRITE))</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-           cal.deleteItem(item, listener);</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-       but makes it easier for provider implementors not implementing the</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-       whole stuff...</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-       Right now, the below are similar to *nix fs rights, i.e. &quot;write&quot; includes</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-       &quot;add&quot;, &quot;delete&quot; and &quot;modify&quot;.</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-       Does it make sense to separate &quot;add&quot; and &quot;delete&quot; out of &quot;write&quot;?</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-    */</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-    /**</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-     * Whether it is allowed or denied to get availability information</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-     * (i.e. free-busy times).</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-     */</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-    const unsigned long AC_FREEBUSY = 1 &lt;&lt; 0;</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-    /**</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-     * Whether it is allowed or denied to invite a calendar's</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-     * owner placing an invitation into the calendar.</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-     */</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-    const unsigned long AC_SCHEDULE = 1 &lt;&lt; 1;</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-    /**</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-     * Whether it is allowed or denied to read components.</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-     */</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-    const unsigned long AC_COMP_READ = 1 &lt;&lt; 2;</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-    /**</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-     * Whether it is allowed or denied to add, modify or delete components.</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-     */</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-    const unsigned long AC_COMP_WRITE = 1 &lt;&lt; 3;</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-    /**</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-     * Whether it is allowed or denied to read properties.</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-     */</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-    const unsigned long AC_PROP_READ = 1 &lt;&lt; 4;</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-    /**</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-     * Whether it is allowed or denied to add, modify or delete properties.</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-     */</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineminus">-    const unsigned long AC_PROP_WRITE = 1 &lt;&lt; 5;</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-    /**</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-     * Full access, includes all of the above.</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineminus">-     */</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">-    const unsigned long AC_FULL = (AC_FREEBUSY    |</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-                                   AC_SCHEDULE    |</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-                                   AC_COMP_READ   |</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">-                                   AC_COMP_WRITE  |</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-                                   AC_PROP_READ   |</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-                                   AC_PROP_WRITE);</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-    /**</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-     * Checks whether the currently logged in user can perform the specified</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-     * actions. Clients should check these bits before performing operations</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-     * on a calendar instance, e.g.</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-     *</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-     * if (cal.checkAccess(calIWcapCalendar.AC_COMP_WRITE))</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-     *     cal.deleteItem(item, listener);</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-     *</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-     * or</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-     *</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-     * if (cal.checkAccess(calIWcapCalendar.AC_PROP_WRITE))</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-     *     cal.name = newName;</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-     *</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-     * @param accessControlBits access control bits (above AC_ definitions)</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-     * @return true if access is granted, false otherwise</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-     */</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-    boolean checkAccess(in unsigned long accessControlBits);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-//     /**</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-//      * Defines granted and denied permissions for a specific user or</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-//      * user domain. Specific user entries precede over domain entries.</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">-//      *</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineminus">-//      * Examples:</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-//      * a) Allow all users availability and read access,</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-//      *    but jdoe only availability access:</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-//      *    defineAccessControl(&quot;@&quot;, AC_FREEBUSY | AC_COMP_READ);</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-//      *    defineAccessControl(&quot;jdoe&quot;, AC_FREEBUSY);</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-//      *</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-//      * b) Restrict jdoe to have no access:</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-//      *    defineAccessControl(&quot;jdoe&quot;, 0);</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-//      *</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-//      * Follow-up definition calls for the same user will overwrite previous</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-//      * definitions.</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-//      *</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-//      * @param userId user that is affected by the access control bits</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-//      *               WCAP specific:</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-//      *                    - @ stands in for everybody</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-//      *                    xxx todo: change the above</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-//      * @param accessControlBits access control bits (above AC_ definitions)</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-//      * @param listener called when access control bits have been updated</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-//      * @return optional object to track operation</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">-//      */</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-//     calIOperation defineAccessControl(</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-//         in string userId, in unsigned long accessControlBits,</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-//         in calIGenericOperationListener listener);</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-//     /**</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-//      * To reset a user's access control definition to the default ones</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-//      * that everybody is granted.</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-//      * In case the user has no specific access control definition,</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-//      * Cr.NS_ERROR_INVALID_ARG is thrown.</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-//      *</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-//      * @param userId user id</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-//      * @param listener called when access control bits have been updated</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-//      * @return optional object to track operation</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-//      */</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-//     calIOperation resetAccessControl(</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-//         in string userId,</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-//         in calIGenericOperationListener listener);</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-//     /**</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-//      * Gets the set of access control definitions (including &quot;everybody&quot;).</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-//      * Both out arrays have the same length.</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-//      *</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-//      * @param count length of returned arrays</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineminus">-//      * @param users users ids</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineminus">-//      * @param accessControlBits access control bits</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-//      * @param listener called with xxx todo</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-//      * @return optional object to track operation</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-//      */</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineminus">-//     calIOperation getAccessControlDefinitions(</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineminus">-//         out unsigned long count,</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-//         [array, size_is(count)] out string users,</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-//         [array, size_is(count)] out unsigned long accessControlBits );</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-};</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/calendar/providers/wcap/public/calIWcapErrors.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,204 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-#include &quot;calIErrors.idl&quot;</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-/** WCAP error codes.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">- */</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-[scriptable, uuid(2ADC008C-A7A6-4f9a-91C8-A99742B68F3D)]</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-interface calIWcapErrors : calIErrors</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-{</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-    const unsigned long WCAP_NO_ERRNO = WCAP_ERROR_BASE + 0;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-    /* errno: */</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-    /*  1 */ const unsigned long WCAP_LOGIN_FAILED =</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-                 WCAP_ERROR_BASE + 1;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-    /*  2 */ const unsigned long WCAP_LOGIN_OK_DEFAULT_CALENDAR_NOT_FOUND =</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-                 WCAP_ERROR_BASE + 2;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-    /*  6 */ const unsigned long WCAP_DELETE_EVENTS_BY_ID_FAILED =</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-                 WCAP_ERROR_BASE + 6;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-    /*  8 */ const unsigned long WCAP_SETCALPROPS_FAILED =</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-                 WCAP_ERROR_BASE + 8;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    /*  9 */ const unsigned long WCAP_FETCH_EVENTS_BY_ID_FAILED =</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-                 WCAP_ERROR_BASE + 9;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-    /* 10 */ const unsigned long WCAP_CREATECALENDAR_FAILED =</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-                 WCAP_ERROR_BASE + 10;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-    /* 11 */ const unsigned long WCAP_DELETECALENDAR_FAILED =</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-                 WCAP_ERROR_BASE + 11;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    /* 12 */ const unsigned long WCAP_ADDLINK_FAILED =</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-                 WCAP_ERROR_BASE + 12;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-    /* 13 */ const unsigned long WCAP_FETCHBYDATERANGE_FAILED =</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-                 WCAP_ERROR_BASE + 13;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-    /* 14 */ const unsigned long WCAP_STOREEVENTS_FAILED =</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-                 WCAP_ERROR_BASE + 14;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-    /* 15 */ const unsigned long WCAP_STORETODOS_FAILED =</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-                 WCAP_ERROR_BASE + 15;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-    /* 16 */ const unsigned long WCAP_DELETE_TODOS_BY_ID_FAILED =</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-                 WCAP_ERROR_BASE + 16;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    /* 17 */ const unsigned long WCAP_FETCH_TODOS_BY_ID_FAILED =</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-                 WCAP_ERROR_BASE + 17;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-    /* 18 */ const unsigned long WCAP_FETCHCOMPONENTS_FAILED_BAD_TZID =</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-                 WCAP_ERROR_BASE + 18;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-    /* 19 */ const unsigned long WCAP_SEARCH_CALPROPS_FAILED =</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-                 WCAP_ERROR_BASE + 19;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    /* 20 */ const unsigned long WCAP_GET_CALPROPS_FAILED =</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-                 WCAP_ERROR_BASE + 20;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-    /* 21 */ const unsigned long WCAP_DELETECOMPONENTS_BY_RANGE_FAILED =</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-                 WCAP_ERROR_BASE + 21;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-    /* 22 */ const unsigned long WCAP_DELETEEVENTS_BY_RANGE_FAILED =</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-                 WCAP_ERROR_BASE + 22;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-    /* 23 */ const unsigned long WCAP_DELETETODOS_BY_RANGE_FAILED =</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-                 WCAP_ERROR_BASE + 23;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-    /* 24 */ const unsigned long WCAP_GET_ALL_TIMEZONES_FAILED =</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-                 WCAP_ERROR_BASE + 24;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-    /* 25 */ const unsigned long WCAP_CREATECALENDAR_ALREADY_EXISTS_FAILED =</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-                 WCAP_ERROR_BASE + 25;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-    /* 26 */ const unsigned long WCAP_SET_USERPREFS_FAILED =</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-                 WCAP_ERROR_BASE + 26;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-    /* 27 */ const unsigned long WCAP_CHANGE_PASSWORD_FAILED =</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-                 WCAP_ERROR_BASE + 27;</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-    /* 28 */ const unsigned long WCAP_ACCESS_DENIED_TO_CALENDAR =</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-                 WCAP_ERROR_BASE + 28;</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-    /* 29 */ const unsigned long WCAP_CALENDAR_DOES_NOT_EXIST =</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-                 WCAP_ERROR_BASE + 29;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-    /* 30 */ const unsigned long WCAP_ILLEGAL_CALID_NAME =</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-                 WCAP_ERROR_BASE + 30;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-    /* 31 */ const unsigned long WCAP_CANNOT_MODIFY_LINKED_EVENTS =</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-                 WCAP_ERROR_BASE + 31;</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-    /* 32 */ const unsigned long WCAP_CANNOT_MODIFY_LINKED_TODOS =</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-                 WCAP_ERROR_BASE + 32;</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-    /* 33 */ const unsigned long WCAP_CANNOT_SENT_EMAIL =</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-                 WCAP_ERROR_BASE + 33;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-    /* 34 */ const unsigned long WCAP_CALENDAR_DISABLED =</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-                 WCAP_ERROR_BASE + 34;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-    /* 35 */ const unsigned long WCAP_WRITE_IMPORT_FAILED =</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-                 WCAP_ERROR_BASE + 35;</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-    /* 36 */ const unsigned long WCAP_FETCH_BY_LAST_MODIFIED_FAILED =</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-                 WCAP_ERROR_BASE + 36;</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-    /* 37 */ const unsigned long WCAP_CAPI_NOT_SUPPORTED =</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-                 WCAP_ERROR_BASE + 37;</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-    /* 38 */ const unsigned long WCAP_CALID_NOT_SPECIFIED =</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-                 WCAP_ERROR_BASE + 38;</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-    /* 39 */ const unsigned long WCAP_GET_FREEBUSY_FAILED =</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-                 WCAP_ERROR_BASE + 39;</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-    /* 40 */ const unsigned long WCAP_STORE_FAILED_DOUBLE_BOOKED =</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-                 WCAP_ERROR_BASE + 40;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-    /* 41 */ const unsigned long WCAP_FETCH_BY_ALARM_RANGE_FAILED =</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-                 WCAP_ERROR_BASE + 41;</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-    /* 42 */ const unsigned long WCAP_FETCH_BY_ATTENDEE_ERROR_FAILED =</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-                 WCAP_ERROR_BASE + 42;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-    /* 43 */ const unsigned long WCAP_ATTENDEE_GROUP_EXPANSION_CLIPPED =</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-                 WCAP_ERROR_BASE + 43;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-    /* 44 */ const unsigned long WCAP_USERPREFS_ACCESS_DENIED =</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-                 WCAP_ERROR_BASE + 44;</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-    /* 45 */ const unsigned long WCAP_NOT_ALLOWED_TO_REQUEST_PUBLISH =</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-                 WCAP_ERROR_BASE + 45;</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-    /* 46 */ const unsigned long WCAP_INSUFFICIENT_PARAMETERS =</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-                 WCAP_ERROR_BASE + 46;</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-    /* 47 */ const unsigned long WCAP_MUSTBEOWNER_OPERATION =</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-                 WCAP_ERROR_BASE + 47;</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-    /* 48 */ const unsigned long WCAP_DWP_CONNECTION_FAILED =</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-                 WCAP_ERROR_BASE + 48;</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-    /* 49 */ const unsigned long WCAP_DWP_MAX_CONNECTION_REACHED =</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-                 WCAP_ERROR_BASE + 49;</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-    /* 50 */ const unsigned long WCAP_DWP_CANNOT_RESOLVE_CALENDAR =</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-                 WCAP_ERROR_BASE + 50;</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-    /* 51 */ const unsigned long WCAP_DWP_BAD_DATA =</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-                 WCAP_ERROR_BASE + 51;</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-    /* 52 */ const unsigned long WCAP_BAD_COMMAND =</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-                 WCAP_ERROR_BASE + 52;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    /* 53 */ const unsigned long WCAP_NOT_FOUND =</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-                 WCAP_ERROR_BASE + 53;</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-    /* 54 */ const unsigned long WCAP_WRITE_IMPORT_CANT_EXPAND_CALID =</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-                 WCAP_ERROR_BASE + 54;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-    /* 55 */ const unsigned long WCAP_GETTIME_FAILED =</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-                 WCAP_ERROR_BASE + 55;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-    /* 56 */ const unsigned long WCAP_FETCH_DELETEDCOMPONENTS_FAILED =</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-                 WCAP_ERROR_BASE + 56;</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-    /* 57 */ const unsigned long WCAP_FETCH_DELETEDCOMPONENTS_PARTIAL_RESULT =</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-                 WCAP_ERROR_BASE + 57;</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-    /* 58 */ const unsigned long WCAP_WCAP_NO_SUCH_FORMAT =</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-                 WCAP_ERROR_BASE + 58;</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-    /* 59 */ const unsigned long WCAP_COMPONENT_NOT_FOUND =</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-                 WCAP_ERROR_BASE + 59;</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-    /* 60 */ const unsigned long WCAP_BAD_ARGUMENTS =</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-                 WCAP_ERROR_BASE + 60;</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-    /* 61 */ const unsigned long WCAP_GET_USERPREFS_FAILED =</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-                 WCAP_ERROR_BASE + 61;</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-    /* 62 */ const unsigned long WCAP_WCAP_MODIFY_NO_EVENT =</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-                 WCAP_ERROR_BASE + 62;</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-    /* 63 */ const unsigned long WCAP_WCAP_CREATE_EXISTS =</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-                 WCAP_ERROR_BASE + 63;</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-    /* 64 */ const unsigned long WCAP_WCAP_MODIFY_CANT_MAKE_COPY =</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-                 WCAP_ERROR_BASE + 64;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-    /* 65 */ const unsigned long WCAP_STORE_FAILED_RECUR_SKIP =</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-                 WCAP_ERROR_BASE + 65;</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    /* 66 */ const unsigned long WCAP_STORE_FAILED_RECUR_SAMEDAY =</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-                 WCAP_ERROR_BASE + 66;</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-    /* 67 */ const unsigned long WCAP_BAD_ORG_ARGUMENTS =</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-                 WCAP_ERROR_BASE + 67;</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-    /* 68 */ const unsigned long WCAP_STORE_FAILED_RECUR_PRIVACY =</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-                 WCAP_ERROR_BASE + 68;</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-    /* 69 */ const unsigned long WCAP_LDAP_ERROR =</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-                 WCAP_ERROR_BASE + 69;</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-    /* 70 */ const unsigned long WCAP_GET_INVITE_COUNT_FAILED =</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-                 WCAP_ERROR_BASE + 70;</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-    /* 71 */ const unsigned long WCAP_LIST_FAILED =</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-                 WCAP_ERROR_BASE + 71;</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-    /* 72 */ const unsigned long WCAP_LIST_SUBSCRIBED_FAILED =</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-                 WCAP_ERROR_BASE + 72;</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-    /* 73 */ const unsigned long WCAP_SUBSCRIBE_FAILED =</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-                 WCAP_ERROR_BASE + 73;</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-    /* 74 */ const unsigned long WCAP_UNSUBSCRIBE_FAILED =</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-                 WCAP_ERROR_BASE + 74;</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-    /* 75 */ const unsigned long WCAP_ANONYMOUS_NOT_ALLOWED =</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-                 WCAP_ERROR_BASE + 75;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-    /* 76 */ const unsigned long WCAP_ACCESS_DENIED =</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-                 WCAP_ERROR_BASE + 76;</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-    /* 77 */ const unsigned long WCAP_BAD_IMPORT_ARGUMENTS =</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-                 WCAP_ERROR_BASE + 77;</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-    /* 78 */ const unsigned long WCAP_READONLY_DATABASE =</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-                 WCAP_ERROR_BASE + 78;</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-    /* 79 */ const unsigned long WCAP_ATTENDEE_NOT_ALLOWED_TO_REQUEST_ON_MODIFY=</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-                 WCAP_ERROR_BASE + 79;</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-    /* 80 */ const unsigned long WCAP_TRANSP_RESOURCE_NOT_ALLOWED =</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-                 WCAP_ERROR_BASE + 80;</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-    /* 81 */ const unsigned long WCAP_RECURRING_COMPONENT_NOT_FOUND =</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-                 WCAP_ERROR_BASE + 81;</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-    /* new by WCAP 4.0: */</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-    /* 82 */ const unsigned long WCAP_BAD_MIME_TYPE =</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-                 WCAP_ERROR_BASE + 82;</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-    /* 83 */ const unsigned long WCAP_MISSING_BOUNDARY =</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-                 WCAP_ERROR_BASE + 83;</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-    /* 84 */ const unsigned long WCAP_INVALID_ATTACHMENT =</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-                 WCAP_ERROR_BASE + 84;</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-    /* 85 */ const unsigned long WCAP_ATTACH_DELETE_SUCCESS =</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-                 WCAP_ERROR_BASE + 85;</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-    /* 86 */ const unsigned long WCAP_ATTACH_DELETE_PARTIAL =</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-                 WCAP_ERROR_BASE + 86;</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-    /* 87 */ const unsigned long WCAP_ATTACHMENT_NOT_FOUND =</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-                 WCAP_ERROR_BASE + 87;</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-    /* / new by WCAP 4.0 */</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-    /* 11000 */ const unsigned long WCAP_CDWP_ERR_MAX_CONNECTION_REACHED =</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-                    WCAP_ERROR_BASE + 100;</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-    /* 11001 */ const unsigned long WCAP_CDWP_ERR_CANNOT_CONNECT =</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-                    WCAP_ERROR_BASE + 101;</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-    /* 11002 */ const unsigned long WCAP_CDWP_ERR_CANNOT_RESOLVE_CALENDAR =</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-                    WCAP_ERROR_BASE + 102;</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-    /* 11003 */ const unsigned long WCAP_CDWP_ERR_BAD_DATA =</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-                    WCAP_ERROR_BASE + 103;</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-    /* 11004 */ const unsigned long WCAP_CDWP_ERR_DWPHOST_CTX_DOES_NOT_EXIST =</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-                    WCAP_ERROR_BASE + 104;</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-    /* 11005 */ const unsigned long WCAP_CDWP_ERR_HOSTNAME_NOT_RESOLVABLE =</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-                    WCAP_ERROR_BASE + 105;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-    /* 11006 */ const unsigned long WCAP_CDWP_ERR_NO_DATA =</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-                    WCAP_ERROR_BASE + 106;</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-    /* 11007 */ const unsigned long WCAP_CDWP_ERR_AUTH_FAILED =</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-                    WCAP_ERROR_BASE + 107;</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-    /* 11008 */ const unsigned long WCAP_CDWP_ERR_CHECKVERSION_FAILED =</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-                    WCAP_ERROR_BASE + 108;</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-};</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100755</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/calendar/providers/wcap/public/calIWcapSession.idl</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,39 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-interface calIWcapCalendar;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-interface nsIURI;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-/**</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">- * WCAP session.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">- */</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-[scriptable, uuid(477B4534-C297-40a1-ADF2-5A7E2A81816A)]</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-interface calIWcapSession : nsISupports</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-{</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-    /**</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-     * Setting this URI causes the session to logged out and disconnected.</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-     */</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-    attribute nsIURI uri;</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-    /**</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-     * User that has established this session.</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-     * @exception NS_ERROR_NOT_AVAILABLE if not logged in</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-     */</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-    readonly attribute string userId;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    /**</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-     * Determines whether the user is currently logged in.</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-     * Does _not_ check whether the user's ticket has timed out!</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-     */</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    readonly attribute boolean isLoggedIn;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-    /**</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-     * Gets the default calendar instance of this session.</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-     */</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-    readonly attribute calIWcapCalendar defaultCalendar;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-};</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/calendar/providers/wcap/public/moz.build</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,13 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-XPIDL_SOURCES += [</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-    'calIWcapCalendar.idl',</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    'calIWcapErrors.idl',</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-    'calIWcapSession.idl',</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-]</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-XPIDL_MODULE = 'wcap'</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/resources/content/calendarCreation.xul</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/resources/content/calendarCreation.xul</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -53,17 +53,16 @@</span>
<a href="#l20.4"></a><span id="l20.4">         &lt;html:tr&gt;</span>
<a href="#l20.5"></a><span id="l20.5">           &lt;html:th valign=&quot;top&quot;&gt;</span>
<a href="#l20.6"></a><span id="l20.6">             &lt;label value=&quot;&amp;calendarproperties.format.label;&quot; control=&quot;calendar-format&quot;/&gt;</span>
<a href="#l20.7"></a><span id="l20.7">           &lt;/html:th&gt;</span>
<a href="#l20.8"></a><span id="l20.8">           &lt;html:td&gt;</span>
<a href="#l20.9"></a><span id="l20.9">             &lt;radiogroup id=&quot;calendar-format&quot; onselect=&quot;onSelectProvider(this.value)&quot;&gt;</span>
<a href="#l20.10"></a><span id="l20.10">               &lt;radio value=&quot;ics&quot; label=&quot;&amp;calendarproperties.webdav.label;&quot; selected=&quot;true&quot; /&gt;</span>
<a href="#l20.11"></a><span id="l20.11">               &lt;radio value=&quot;caldav&quot; label=&quot;&amp;calendarproperties.caldav.label;&quot;/&gt;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-              &lt;radio id=&quot;wcap-radio&quot; value=&quot;wcap&quot; label=&quot;&amp;calendarproperties.wcap.label;&quot;/&gt;</span>
<a href="#l20.13"></a><span id="l20.13">             &lt;/radiogroup&gt;</span>
<a href="#l20.14"></a><span id="l20.14">           &lt;/html:td&gt;</span>
<a href="#l20.15"></a><span id="l20.15">         &lt;/html:tr&gt;</span>
<a href="#l20.16"></a><span id="l20.16">         &lt;html:tr id=&quot;calendar-username-row&quot;&gt;</span>
<a href="#l20.17"></a><span id="l20.17">           &lt;html:th&gt;</span>
<a href="#l20.18"></a><span id="l20.18">             &lt;label id=&quot;calendar-username-label&quot;</span>
<a href="#l20.19"></a><span id="l20.19">                    value=&quot;&amp;locationpage.username.label;&quot;</span>
<a href="#l20.20"></a><span id="l20.20">                    control=&quot;calendar-username&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/test/modules/CalendarUtils.jsm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/test/modules/CalendarUtils.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -518,17 +518,17 @@ function createCalendar(controller, name</span>
<a href="#l21.4"></a><span id="l21.4"> /**</span>
<a href="#l21.5"></a><span id="l21.5">  * Handles the &quot;Create New Calendar&quot; Wizard.</span>
<a href="#l21.6"></a><span id="l21.6">  *</span>
<a href="#l21.7"></a><span id="l21.7">  * @param wizard            wizard dialog controller</span>
<a href="#l21.8"></a><span id="l21.8">  * @param name              calendar name</span>
<a href="#l21.9"></a><span id="l21.9">  * @param data              (optional) dataset object</span>
<a href="#l21.10"></a><span id="l21.10">  *                              showReminders - False to disable reminders.</span>
<a href="#l21.11"></a><span id="l21.11">  *                              eMail - id of eMail account</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">- *                              network.format - ics/caldav/wcap</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+ *                              network.format - ics/caldav</span>
<a href="#l21.14"></a><span id="l21.14">  *                              network.location - URI (undefined for local ICS)</span>
<a href="#l21.15"></a><span id="l21.15">  *                              network.offline - False to disable cache.</span>
<a href="#l21.16"></a><span id="l21.16">  */</span>
<a href="#l21.17"></a><span id="l21.17"> function handleNewCalendarWizard(wizard, name, data = undefined) {</span>
<a href="#l21.18"></a><span id="l21.18">   let { lookup: wizardlookup, eid: wizardId } = helpersForController(wizard);</span>
<a href="#l21.19"></a><span id="l21.19">   let dlgButton = btn =&gt; wizard.window.document.querySelector(&quot;wizard&quot;).getButton(btn);</span>
<a href="#l21.20"></a><span id="l21.20">   if (data == undefined) {</span>
<a href="#l21.21"></a><span id="l21.21">     data = {};</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

