<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24289:e7b78654e6d77f473f089c12dfb143efcf00111e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e7b78654e6d77f473f089c12dfb143efcf00111e" />
<meta property="og:url" content="/comm-central/rev/e7b78654e6d77f473f089c12dfb143efcf00111e" />
<meta property="og:description" content="Bug 1466911 - Add workaround for exception when adding history entries during tab restore. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e7b78654e6d77f473f089c12dfb143efcf00111e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e7b78654e6d77f473f089c12dfb143efcf00111e">shortlog</a> |
<a href="/comm-central/log/e7b78654e6d77f473f089c12dfb143efcf00111e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e7b78654e6d77f473f089c12dfb143efcf00111e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e7b78654e6d77f473f089c12dfb143efcf00111e">files</a> |
changeset |
<a href="/comm-central/raw-rev/e7b78654e6d77f473f089c12dfb143efcf00111e">raw</a>  | <a href="/comm-central/archive/e7b78654e6d77f473f089c12dfb143efcf00111e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466911">Bug 1466911</a> - Add workaround for exception when adding history entries during tab restore. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#45;&#82;&#97;&#105;&#110;&#101;&#114;&#32;&#71;&#114;&#97;&#104;&#108;&#32;&#60;&#102;&#114;&#103;&#114;&#97;&#104;&#108;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 18 Jul 2018 14:01:47 +0200</td></tr>

<tr>
 <td>changeset 24289</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e7b78654e6d77f473f089c12dfb143efcf00111e">e7b78654e6d77f473f089c12dfb143efcf00111e</a></td>
</tr>



<tr>
<td>parent 24288</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/eaad7c4f5df4ea20b6f3d36124c415347e2a8112">eaad7c4f5df4ea20b6f3d36124c415347e2a8112</a>
</td>
</tr>

<tr>
<td>child 24290</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/80ecd5ae900ddcd1313680026c807c80f5edd8a9">80ecd5ae900ddcd1313680026c807c80f5edd8a9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e7b78654e6d77f473f089c12dfb143efcf00111e">14632</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 18 Jul 2018 12:12:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a712d22c0257 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a712d22c02573a76b17f35ccf8d91a112e110eb9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a712d22c02573a76b17f35ccf8d91a112e110eb9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a712d22c02573a76b17f35ccf8d91a112e110eb9&newProject=comm-central&newRevision=e7b78654e6d77f473f089c12dfb143efcf00111e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a712d22c02573a76b17f35ccf8d91a112e110eb9&newProject=comm-central&newRevision=e7b78654e6d77f473f089c12dfb143efcf00111e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a712d22c02573a76b17f35ccf8d91a112e110eb9&newProject=comm-central&newRevision=e7b78654e6d77f473f089c12dfb143efcf00111e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466911">1466911</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466911">Bug 1466911</a> - Add workaround for exception when adding history entries during tab restore. r=IanN
For some entries an exception is thrown when you try to add them to the history. This should
not happen and seems to be caused by an error elsewhere in the sessionstore code.
See the bug for more details.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7b78654e6d77f473f089c12dfb143efcf00111e/suite/components/sessionstore/nsSessionStore.js">suite/components/sessionstore/nsSessionStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7b78654e6d77f473f089c12dfb143efcf00111e/suite/components/sessionstore/nsSessionStore.js">file</a> |
<a href="/comm-central/annotate/e7b78654e6d77f473f089c12dfb143efcf00111e/suite/components/sessionstore/nsSessionStore.js">annotate</a> |
<a href="/comm-central/diff/e7b78654e6d77f473f089c12dfb143efcf00111e/suite/components/sessionstore/nsSessionStore.js">diff</a> |
<a href="/comm-central/comparison/e7b78654e6d77f473f089c12dfb143efcf00111e/suite/components/sessionstore/nsSessionStore.js">comparison</a> |
<a href="/comm-central/log/e7b78654e6d77f473f089c12dfb143efcf00111e/suite/components/sessionstore/nsSessionStore.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/components/sessionstore/nsSessionStore.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/components/sessionstore/nsSessionStore.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2609,21 +2609,44 @@ SessionStoreService.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">       tab.__SS_extdata = {};</span>
<a href="#l1.5"></a><span id="l1.5">       for (let key in tabData.extData)</span>
<a href="#l1.6"></a><span id="l1.6">         tab.__SS_extdata[key] = tabData.extData[key];</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8">     else</span>
<a href="#l1.9"></a><span id="l1.9">       delete tab.__SS_extdata;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     for (var i = 0; i &lt; tabData.entries.length; i++) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      let cloneEntry = false;</span>
<a href="#l1.13"></a><span id="l1.13">       //XXXzpao Wallpaper patch for bug 509315</span>
<a href="#l1.14"></a><span id="l1.14">       if (!tabData.entries[i].url)</span>
<a href="#l1.15"></a><span id="l1.15">         continue;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-      history.addEntry(this._deserializeHistoryEntry(tabData.entries[i],</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-                                                     aIdMap, aDocIdentMap), true);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+      let shEntry = this._deserializeHistoryEntry(tabData.entries[i],</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+                                                  aIdMap, aDocIdentMap);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+      try {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+        history.addEntry(shEntry, true);</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+      }</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+      catch (ex) {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+        cloneEntry = true;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+      }</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+      // Workaround for bug 1466911.</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+      // FIXME Remove this after the issue which caused the exception above</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+      // to be thrown has been fixed.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+      if (cloneEntry) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        shEntry = shEntry.clone();</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        shEntry.abandonBFCacheEntry();</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+        try {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+          history.addEntry(shEntry, true);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+        }</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        catch (ex) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+          Cu.reportError(ex);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+        }</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+      }</span>
<a href="#l1.42"></a><span id="l1.42">     }</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">     // make sure to reset the capabilities and attributes, in case this tab gets reused</span>
<a href="#l1.45"></a><span id="l1.45">     var disallow = (tabData.disallow)?tabData.disallow.split(&quot;,&quot;):[];</span>
<a href="#l1.46"></a><span id="l1.46">     CAPABILITIES.forEach(function(aCapability) {</span>
<a href="#l1.47"></a><span id="l1.47">       browser.docShell[&quot;allow&quot; + aCapability] = disallow.indexOf(aCapability) == -1;</span>
<a href="#l1.48"></a><span id="l1.48">     });</span>
<a href="#l1.49"></a><span id="l1.49">     for (let name in this.xulAttributes)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

