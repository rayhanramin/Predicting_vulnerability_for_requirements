<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12231:e650ba2dd55273a3ffd491ae678972bcbe564664</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e650ba2dd55273a3ffd491ae678972bcbe564664" />
<meta property="og:url" content="/comm-central/rev/e650ba2dd55273a3ffd491ae678972bcbe564664" />
<meta property="og:description" content="Bug 852690 - Remaining conversion to mailServices.js in /mail/ and /mailnews/: message views. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e650ba2dd55273a3ffd491ae678972bcbe564664 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e650ba2dd55273a3ffd491ae678972bcbe564664">shortlog</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e650ba2dd55273a3ffd491ae678972bcbe564664">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664">files</a> |
changeset |
<a href="/comm-central/raw-rev/e650ba2dd55273a3ffd491ae678972bcbe564664">raw</a>  | <a href="/comm-central/archive/e650ba2dd55273a3ffd491ae678972bcbe564664.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js in /mail/ and /mailnews/: message views. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 29 Mar 2013 11:01:42 +0100</td></tr>

<tr>
 <td>changeset 12231</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e650ba2dd55273a3ffd491ae678972bcbe564664">e650ba2dd55273a3ffd491ae678972bcbe564664</a></td>
</tr>



<tr>
<td>parent 12230</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5455891552e48fb6fac187c36fda444c9bde449d">5455891552e48fb6fac187c36fda444c9bde449d</a>
</td>
</tr>

<tr>
<td>child 12232</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0b0ff12d6f09c18c6c0ae7bf32f2561c9dada750">0b0ff12d6f09c18c6c0ae7bf32f2561c9dada750</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e650ba2dd55273a3ffd491ae678972bcbe564664">9052</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 29 Mar 2013 18:51:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0e410a62d2d8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0e410a62d2d81576f3fe043548d65cd73ab8af03">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0e410a62d2d81576f3fe043548d65cd73ab8af03&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">852690</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js in /mail/ and /mailnews/: message views. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWidgets.xml">mail/base/content/mailWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWidgets.xml">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWidgets.xml">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWidgets.xml">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWidgets.xml">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/newTagDialog.js">mail/base/content/newTagDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/newTagDialog.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/newTagDialog.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/newTagDialog.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/newTagDialog.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/newTagDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/selectionsummaries.js">mail/base/content/selectionsummaries.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/selectionsummaries.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/selectionsummaries.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/selectionsummaries.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/selectionsummaries.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/base/content/selectionsummaries.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/extensions/mailviews/content/msgViewPickerOverlay.js">mail/extensions/mailviews/content/msgViewPickerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/extensions/mailviews/content/msgViewPickerOverlay.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/extensions/mailviews/content/msgViewPickerOverlay.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/extensions/mailviews/content/msgViewPickerOverlay.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/extensions/mailviews/content/msgViewPickerOverlay.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/extensions/mailviews/content/msgViewPickerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-message-commands.js">mail/test/mozmill/folder-display/test-message-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-message-commands.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-message-commands.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-message-commands.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-message-commands.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-message-commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-summarization.js">mail/test/mozmill/folder-display/test-summarization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-summarization.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-summarization.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-summarization.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-summarization.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-display/test-summarization.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js">mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/multiple-identities/test-display-names.js">mail/test/mozmill/multiple-identities/test-display-names.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/multiple-identities/test-display-names.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/multiple-identities/test-display-names.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/multiple-identities/test-display-names.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/multiple-identities/test-display-names.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/multiple-identities/test-display-names.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_compactColumnSave.js">mailnews/base/test/unit/test_compactColumnSave.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_compactColumnSave.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_compactColumnSave.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_compactColumnSave.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_compactColumnSave.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_compactColumnSave.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_emptyTrash.js">mailnews/base/test/unit/test_emptyTrash.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_emptyTrash.js">file</a> |
<a href="/comm-central/annotate/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_emptyTrash.js">annotate</a> |
<a href="/comm-central/diff/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_emptyTrash.js">diff</a> |
<a href="/comm-central/comparison/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_emptyTrash.js">comparison</a> |
<a href="/comm-central/log/e650ba2dd55273a3ffd491ae678972bcbe564664/mailnews/base/test/unit/test_emptyTrash.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l1.12"></a><span id="l1.12"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> const kDefaultMode = &quot;all&quot;;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> /**</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineat">@@ -168,33 +169,29 @@ let gFolderTreeView = {</span>
<a href="#l1.20"></a><span id="l1.20">     }</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">     // Load our data</span>
<a href="#l1.23"></a><span id="l1.23">     this._rebuild();</span>
<a href="#l1.24"></a><span id="l1.24">     // And actually draw the tree</span>
<a href="#l1.25"></a><span id="l1.25">     aTree.view = this;</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">     // Add this listener so that we can update the tree when things change</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    let session = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    session.AddFolderListener(this, Ci.nsIFolderListener.all);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    MailServices.mailSession.AddFolderListener(this, Ci.nsIFolderListener.all);</span>
<a href="#l1.32"></a><span id="l1.32">   },</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   /**</span>
<a href="#l1.35"></a><span id="l1.35">    * Called when the window is being torn down.  Here we undo everything we did</span>
<a href="#l1.36"></a><span id="l1.36">    * onload.  That means removing our listener and serializing our JSON.</span>
<a href="#l1.37"></a><span id="l1.37">    */</span>
<a href="#l1.38"></a><span id="l1.38">   unload: function ftv_unload(aJSONFile) {</span>
<a href="#l1.39"></a><span id="l1.39">     const Cc = Components.classes;</span>
<a href="#l1.40"></a><span id="l1.40">     const Ci = Components.interfaces;</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">     // Remove our listener</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    let session = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-                     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    session.RemoveFolderListener(this);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">     if (aJSONFile) {</span>
<a href="#l1.49"></a><span id="l1.49">       // Write out our json file...</span>
<a href="#l1.50"></a><span id="l1.50">       let data = JSON.stringify(this._persistOpenMap);</span>
<a href="#l1.51"></a><span id="l1.51">       let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l1.52"></a><span id="l1.52">       file.append(aJSONFile);</span>
<a href="#l1.53"></a><span id="l1.53">       let foStream = Cc[&quot;@mozilla.org/network/safe-file-output-stream;1&quot;]</span>
<a href="#l1.54"></a><span id="l1.54">                         .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineat">@@ -594,18 +591,17 @@ let gFolderTreeView = {</span>
<a href="#l1.56"></a><span id="l1.56">   },</span>
<a href="#l1.57"></a><span id="l1.57">   drop: function ftv_drop(aRow, aOrientation) {</span>
<a href="#l1.58"></a><span id="l1.58">     const Cc = Components.classes;</span>
<a href="#l1.59"></a><span id="l1.59">     const Ci = Components.interfaces;</span>
<a href="#l1.60"></a><span id="l1.60">     let targetFolder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">     let dt = this._currentTransfer;</span>
<a href="#l1.63"></a><span id="l1.63">     let count = dt.mozItemCount;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    let cs = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-                .getService(Ci.nsIMsgCopyService);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    let cs = MailServices.copy;</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68">     // we only support drag of a single flavor at a time.</span>
<a href="#l1.69"></a><span id="l1.69">     let types = dt.mozTypesAt(0);</span>
<a href="#l1.70"></a><span id="l1.70">     if (Array.indexOf(types, &quot;text/x-moz-folder&quot;) != -1) {</span>
<a href="#l1.71"></a><span id="l1.71">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l1.72"></a><span id="l1.72">         let folders = new Array;</span>
<a href="#l1.73"></a><span id="l1.73">         folders.push(dt.mozGetDataAt(&quot;text/x-moz-folder&quot;, i)</span>
<a href="#l1.74"></a><span id="l1.74">                        .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineat">@@ -1051,19 +1047,17 @@ let gFolderTreeView = {</span>
<a href="#l1.76"></a><span id="l1.76">         dbFolderInfo.setCharProperty(&quot;searchStr&quot;, &quot;ALL&quot;);</span>
<a href="#l1.77"></a><span id="l1.77">         dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l1.78"></a><span id="l1.78">         dbFolderInfo.setUint32Property(&quot;searchFolderFlag&quot;, folderFlag);</span>
<a href="#l1.79"></a><span id="l1.79">         dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, true);</span>
<a href="#l1.80"></a><span id="l1.80">         vfdb.summaryValid = true;</span>
<a href="#l1.81"></a><span id="l1.81">         vfdb.Close(true);</span>
<a href="#l1.82"></a><span id="l1.82">       }</span>
<a href="#l1.83"></a><span id="l1.83">       parentFolder.NotifyItemAdded(newFolder);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-      Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-        .getService(Components.interfaces.nsIMsgAccountManager)</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-        .saveVirtualFolders();</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      MailServices.accounts.saveVirtualFolders();</span>
<a href="#l1.88"></a><span id="l1.88">     }</span>
<a href="#l1.89"></a><span id="l1.89">     catch(e) {</span>
<a href="#l1.90"></a><span id="l1.90">        throw(e);</span>
<a href="#l1.91"></a><span id="l1.91">        dump (&quot;Exception : creating virtual folder \n&quot;);</span>
<a href="#l1.92"></a><span id="l1.92">     }</span>
<a href="#l1.93"></a><span id="l1.93">     return newFolder;</span>
<a href="#l1.94"></a><span id="l1.94">   },</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96" class="difflineat">@@ -1369,29 +1363,26 @@ let gFolderTreeView = {</span>
<a href="#l1.97"></a><span id="l1.97">      */</span>
<a href="#l1.98"></a><span id="l1.98">     smart: {</span>
<a href="#l1.99"></a><span id="l1.99">       __proto__: IFolderTreeMode,</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">       /**</span>
<a href="#l1.102"></a><span id="l1.102">        * The smart server. This will create the server if it doesn't exist.</span>
<a href="#l1.103"></a><span id="l1.103">        */</span>
<a href="#l1.104"></a><span id="l1.104">       get _smartServer() {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-        let acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.107"></a><span id="l1.107">         let smartServer;</span>
<a href="#l1.108"></a><span id="l1.108">         try {</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-          smartServer = acctMgr.FindServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+          smartServer = MailServices.accounts.FindServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l1.111"></a><span id="l1.111">         }</span>
<a href="#l1.112"></a><span id="l1.112">         catch (ex) {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-          smartServer = acctMgr.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-                                                     &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+          smartServer = MailServices.accounts.createIncomingServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l1.116"></a><span id="l1.116">           // We don't want the &quot;smart&quot; server/account leaking out into the ui in</span>
<a href="#l1.117"></a><span id="l1.117">           // other places, so set it as hidden.</span>
<a href="#l1.118"></a><span id="l1.118">           smartServer.hidden = true;</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-          let account = acctMgr.createAccount();</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+          let account = MailServices.accounts.createAccount();</span>
<a href="#l1.121"></a><span id="l1.121">           account.incomingServer = smartServer;</span>
<a href="#l1.122"></a><span id="l1.122">         }</span>
<a href="#l1.123"></a><span id="l1.123">         delete this._smartServer;</span>
<a href="#l1.124"></a><span id="l1.124">         return this._smartServer = smartServer;</span>
<a href="#l1.125"></a><span id="l1.125">       },</span>
<a href="#l1.126"></a><span id="l1.126"> </span>
<a href="#l1.127"></a><span id="l1.127">       /**</span>
<a href="#l1.128"></a><span id="l1.128">        * A list of [flag, name, isDeep, isSearch] for smart folders. isDeep ==</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineat">@@ -1489,18 +1480,16 @@ let gFolderTreeView = {</span>
<a href="#l1.130"></a><span id="l1.130">       _getSmartFolderNamed: function ftv_smart__getSmartFolderNamed(aName) {</span>
<a href="#l1.131"></a><span id="l1.131">         let smartRoot = this._smartServer.rootFolder;</span>
<a href="#l1.132"></a><span id="l1.132">         return smartRoot.getChildWithURI(smartRoot.URI + &quot;/&quot; + encodeURI(aName), false,</span>
<a href="#l1.133"></a><span id="l1.133">                                          true);</span>
<a href="#l1.134"></a><span id="l1.134">       },</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136">       generateMap: function ftv_smart_generateMap(ftv) {</span>
<a href="#l1.137"></a><span id="l1.137">         let map = [];</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-        let acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.140"></a><span id="l1.140">         let accounts = gFolderTreeView._sortedAccounts();</span>
<a href="#l1.141"></a><span id="l1.141">         let smartServer = this._smartServer;</span>
<a href="#l1.142"></a><span id="l1.142">         smartServer.prettyName = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l1.143"></a><span id="l1.143">                                          .getString(&quot;unifiedAccountName&quot;);</span>
<a href="#l1.144"></a><span id="l1.144">         smartServer.canHaveFilters = false;</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146">         let smartRoot = smartServer.rootFolder;</span>
<a href="#l1.147"></a><span id="l1.147">         let smartChildren = [];</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineat">@@ -1625,19 +1614,17 @@ let gFolderTreeView = {</span>
<a href="#l1.149"></a><span id="l1.149">   /**</span>
<a href="#l1.150"></a><span id="l1.150">    * This is a helper attribute that simply returns a flat list of all folders</span>
<a href="#l1.151"></a><span id="l1.151">    */</span>
<a href="#l1.152"></a><span id="l1.152">   get _enumerateFolders() {</span>
<a href="#l1.153"></a><span id="l1.153">     const Cc = Components.classes;</span>
<a href="#l1.154"></a><span id="l1.154">     const Ci = Components.interfaces;</span>
<a href="#l1.155"></a><span id="l1.155">     let folders = [];</span>
<a href="#l1.156"></a><span id="l1.156"> </span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-    let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-                     .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    for each (let server in fixIterator(acctMgr.allServers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    for each (let server in fixIterator(MailServices.accounts.allServers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l1.161"></a><span id="l1.161">       // Skip deferred accounts</span>
<a href="#l1.162"></a><span id="l1.162">       if (server instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l1.163"></a><span id="l1.163">           server.deferredToAccount)</span>
<a href="#l1.164"></a><span id="l1.164">         continue;</span>
<a href="#l1.165"></a><span id="l1.165"> </span>
<a href="#l1.166"></a><span id="l1.166">       let rootFolder = server.rootFolder;</span>
<a href="#l1.167"></a><span id="l1.167">       folders.push(rootFolder);</span>
<a href="#l1.168"></a><span id="l1.168">       this.addSubFolders(rootFolder, folders);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineat">@@ -2038,21 +2025,17 @@ let gFolderTreeController = {</span>
<a href="#l1.170"></a><span id="l1.170">         // Remove the offline store, if any.</span>
<a href="#l1.171"></a><span id="l1.171">         let offlineStore = folder.filePath;</span>
<a href="#l1.172"></a><span id="l1.172">         if (offlineStore.exists())</span>
<a href="#l1.173"></a><span id="l1.173">           offlineStore.remove(false);</span>
<a href="#l1.174"></a><span id="l1.174">       }</span>
<a href="#l1.175"></a><span id="l1.175">       gFolderDisplay.view.close();</span>
<a href="#l1.176"></a><span id="l1.176"> </span>
<a href="#l1.177"></a><span id="l1.177">       // Send a notification that we are triggering a database rebuild.</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-      let notifier =</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-        Components.classes[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-                  .getService(</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-                    Components.interfaces.nsIMsgFolderNotificationService);</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-      notifier.notifyItemEvent(folder, &quot;FolderReindexTriggered&quot;, null);</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+      MailServices.mfn.notifyItemEvent(folder, &quot;FolderReindexTriggered&quot;, null);</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185">       folder.msgDatabase.summaryValid = false;</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187">       var msgDB = folder.msgDatabase;</span>
<a href="#l1.188"></a><span id="l1.188">       msgDB.summaryValid = false;</span>
<a href="#l1.189"></a><span id="l1.189">       try {</span>
<a href="#l1.190"></a><span id="l1.190">         folder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l1.191"></a><span id="l1.191">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1040,19 +1040,17 @@ function IsSendUnsentMsgsEnabled(unsentM</span>
<a href="#l2.4"></a><span id="l2.4">   // Otherwise, we don't know where we are, so use the current identity and</span>
<a href="#l2.5"></a><span id="l2.5">   // find out if we have messages or not via that.</span>
<a href="#l2.6"></a><span id="l2.6">   let identity;</span>
<a href="#l2.7"></a><span id="l2.7">   let folders = GetSelectedMsgFolders();</span>
<a href="#l2.8"></a><span id="l2.8">   if (folders.length &gt; 0)</span>
<a href="#l2.9"></a><span id="l2.9">     identity = getIdentityForServer(folders[0].server);</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   if (!identity)</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    identity = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                         .getService(Components.interfaces.nsIMsgAccountManager)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-                         .defaultAccount.defaultIdentity;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    identity = MailServices.accounts.defaultAccount.defaultIdentity;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   return msgSendlater.hasUnsentMessages(identity);</span>
<a href="#l2.18"></a><span id="l2.18"> }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> function IsFolderCharsetEnabled()</span>
<a href="#l2.21"></a><span id="l2.21"> {</span>
<a href="#l2.22"></a><span id="l2.22">   return IsFolderSelected();</span>
<a href="#l2.23"></a><span id="l2.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -426,26 +426,22 @@ function ViewPageSource(messages)</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   if (numMessages == 0)</span>
<a href="#l3.6"></a><span id="l3.6">   {</span>
<a href="#l3.7"></a><span id="l3.7">     dump(&quot;MsgViewPageSource(): No messages selected.\n&quot;);</span>
<a href="#l3.8"></a><span id="l3.8">     return false;</span>
<a href="#l3.9"></a><span id="l3.9">   }</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   try {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    // First, get the mail session</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    const nsIMsgMailSession = Components.interfaces.nsIMsgMailSession;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                                .getService(nsIMsgMailSession);</span>
<a href="#l3.16"></a><span id="l3.16">     var mailCharacterSet = &quot;charset=&quot; + msgWindow.mailCharacterSet;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     for (var i = 0; i &lt; numMessages; i++)</span>
<a href="#l3.19"></a><span id="l3.19">     {</span>
<a href="#l3.20"></a><span id="l3.20">       // Now, we need to get a URL from a URI</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-      var url = mailSession.ConvertMsgURIToMsgURL(messages[i], msgWindow);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      var url = MailServices.mailSession.ConvertMsgURIToMsgURL(messages[i], msgWindow);</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">       // Strip out the message-display parameter to ensure that attached emails</span>
<a href="#l3.25"></a><span id="l3.25">       // display the message source, not the processed HTML.</span>
<a href="#l3.26"></a><span id="l3.26">       url = url.replace(/type=application\/x-message-display&amp;/, &quot;&quot;);</span>
<a href="#l3.27"></a><span id="l3.27">       window.openDialog(&quot;chrome://global/content/viewSource.xul&quot;,</span>
<a href="#l3.28"></a><span id="l3.28">                         &quot;_blank&quot;, &quot;all,dialog=no&quot;, url,</span>
<a href="#l3.29"></a><span id="l3.29">                         mailCharacterSet);</span>
<a href="#l3.30"></a><span id="l3.30">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -132,55 +132,53 @@ function OpenBrowserWithMessageId(messag</span>
<a href="#l4.4"></a><span id="l4.4">  * Take the message id from the messageIdNode, search for the corresponding</span>
<a href="#l4.5"></a><span id="l4.5">  * message in all folders starting with the current selected folder, then the</span>
<a href="#l4.6"></a><span id="l4.6">  * current account followed by the other accounts and open corresponding</span>
<a href="#l4.7"></a><span id="l4.7">  * message if found.</span>
<a href="#l4.8"></a><span id="l4.8">  * @param messageId the message id to open</span>
<a href="#l4.9"></a><span id="l4.9">  */</span>
<a href="#l4.10"></a><span id="l4.10"> function OpenMessageForMessageId(messageId)</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  var startServer = msgWindow.openFolder.server;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  let startServer = msgWindow.openFolder.server;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">   window.setCursor(&quot;wait&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   // first search in current folder for message id</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  var messageHeader = CheckForMessageIdInFolder(msgWindow.openFolder, messageId);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  let messageHeader = CheckForMessageIdInFolder(msgWindow.openFolder, messageId);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   // if message id not found in current folder search in all folders</span>
<a href="#l4.22"></a><span id="l4.22">   if (!messageHeader)</span>
<a href="#l4.23"></a><span id="l4.23">   {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-    var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-                                   .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    let allServers = MailServices.accounts.allServers;</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">     messageHeader = SearchForMessageIdInSubFolder(startServer.rootFolder, messageId);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    for (var i = 0; i &lt; allServers.length &amp;&amp; !messageHeader; i++)</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    for (let i = 0; i &lt; allServers.length &amp;&amp; !messageHeader; i++)</span>
<a href="#l4.33"></a><span id="l4.33">     {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-      var currentServer =</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      let currentServer =</span>
<a href="#l4.36"></a><span id="l4.36">         allServers.queryElementAt(i, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l4.37"></a><span id="l4.37">       if (currentServer &amp;&amp; startServer != currentServer &amp;&amp;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-	  currentServer.canSearchMessages &amp;&amp; !currentServer.isDeferredTo)</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+          currentServer.canSearchMessages &amp;&amp; !currentServer.isDeferredTo)</span>
<a href="#l4.40"></a><span id="l4.40">       {</span>
<a href="#l4.41"></a><span id="l4.41">         messageHeader = SearchForMessageIdInSubFolder(currentServer.rootFolder, messageId);</span>
<a href="#l4.42"></a><span id="l4.42">       }</span>
<a href="#l4.43"></a><span id="l4.43">     }</span>
<a href="#l4.44"></a><span id="l4.44">   }</span>
<a href="#l4.45"></a><span id="l4.45">   window.setCursor(&quot;auto&quot;);</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">   // if message id was found open corresponding message</span>
<a href="#l4.48"></a><span id="l4.48">   // else show error message</span>
<a href="#l4.49"></a><span id="l4.49">   if (messageHeader)</span>
<a href="#l4.50"></a><span id="l4.50">     OpenMessageByHeader(messageHeader, Services.prefs.getBoolPref(&quot;mailnews.messageid.openInNewWindow&quot;));</span>
<a href="#l4.51"></a><span id="l4.51">   else</span>
<a href="#l4.52"></a><span id="l4.52">   {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    var messageIdStr = &quot;&lt;&quot; + messageId + &quot;&gt;&quot;;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    var errorTitle = bundle.getString(&quot;errorOpenMessageForMessageIdTitle&quot;);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-    var errorMessage = bundle.getFormattedString(&quot;errorOpenMessageForMessageIdMessage&quot;,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    let messageIdStr = &quot;&lt;&quot; + messageId + &quot;&gt;&quot;;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    let errorTitle = bundle.getString(&quot;errorOpenMessageForMessageIdTitle&quot;);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+    let errorMessage = bundle.getFormattedString(&quot;errorOpenMessageForMessageIdMessage&quot;,</span>
<a href="#l4.61"></a><span id="l4.61">                                                  [messageIdStr]);</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">     Services.prompt.alert(window, errorTitle, errorMessage);</span>
<a href="#l4.64"></a><span id="l4.64">   }</span>
<a href="#l4.65"></a><span id="l4.65"> }</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67"> function OpenMessageByHeader(messageHeader, openInNewWindow)</span>
<a href="#l4.68"></a><span id="l4.68"> {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineat">@@ -268,21 +266,19 @@ function CheckForMessageIdInFolder(folde</span>
<a href="#l4.70"></a><span id="l4.70">   {</span>
<a href="#l4.71"></a><span id="l4.71">     messageHeader = messageDatabase.getMsgHdrForMessageID(messageId);</span>
<a href="#l4.72"></a><span id="l4.72">   }</span>
<a href="#l4.73"></a><span id="l4.73">   catch (ex)</span>
<a href="#l4.74"></a><span id="l4.74">   {</span>
<a href="#l4.75"></a><span id="l4.75">     Components.utils.reportError(&quot;Failed to find message-id in folder; &quot; +</span>
<a href="#l4.76"></a><span id="l4.76">                                  &quot;messageId=&quot; + messageId);</span>
<a href="#l4.77"></a><span id="l4.77">   }</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-  var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-                              .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  if (!mailSession.IsFolderOpenInWindow(folder) &amp;&amp;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  if (!MailServices.mailSession.IsFolderOpenInWindow(folder) &amp;&amp;</span>
<a href="#l4.84"></a><span id="l4.84">       !(folder.flags &amp; (nsMsgFolderFlags.Trash | nsMsgFolderFlags.Inbox)))</span>
<a href="#l4.85"></a><span id="l4.85">   {</span>
<a href="#l4.86"></a><span id="l4.86">     folder.msgDatabase = null;</span>
<a href="#l4.87"></a><span id="l4.87">   }</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89">   return messageHeader;</span>
<a href="#l4.90"></a><span id="l4.90"> }</span>
<a href="#l4.91"></a><span id="l4.91"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailWidgets.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailWidgets.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1283,33 +1283,30 @@</span>
<a href="#l5.4"></a><span id="l5.4">             // aTags contains a list of actual tag names (not the keys), delimited by spaces</span>
<a href="#l5.5"></a><span id="l5.5">             // each tag name is encoded.</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">             // remove any existing tag items we've appended to the list</span>
<a href="#l5.8"></a><span id="l5.8">             var headerValueNode = document.getAnonymousElementByAttribute(this, 'anonid', 'headerValue');</span>
<a href="#l5.9"></a><span id="l5.9">             for (var i = headerValueNode.childNodes.length - 1; i &gt;= 0; --i)</span>
<a href="#l5.10"></a><span id="l5.10">               headerValueNode.removeChild(headerValueNode.childNodes[i]);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-            var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-</span>
<a href="#l5.15"></a><span id="l5.15">             // tokenize the keywords based on ' '</span>
<a href="#l5.16"></a><span id="l5.16">             var tagsArray = aTags.split(' ');</span>
<a href="#l5.17"></a><span id="l5.17">             for (var index = 0; index &lt; tagsArray.length; index++)</span>
<a href="#l5.18"></a><span id="l5.18">             {</span>
<a href="#l5.19"></a><span id="l5.19">               // for each tag, create a label, give it the font color that corresponds to the</span>
<a href="#l5.20"></a><span id="l5.20">               // color of the tag and append it.</span>
<a href="#l5.21"></a><span id="l5.21">               var tagName;</span>
<a href="#l5.22"></a><span id="l5.22">               try {</span>
<a href="#l5.23"></a><span id="l5.23">                 // if we got a bad tag name, getTagForKey will throw an exception, skip it</span>
<a href="#l5.24"></a><span id="l5.24">                 // and go to the next one.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-                tagName = tagService.getTagForKey(tagsArray[index]);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+                tagName = MailServices.tags.getTagForKey(tagsArray[index]);</span>
<a href="#l5.27"></a><span id="l5.27">               } catch (ex) { continue; }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-              var color = tagService.getColorForKey(tagsArray[index]);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+              let color = MailServices.tags.getColorForKey(tagsArray[index]);</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">               // now create a label for the tag name, and set the color</span>
<a href="#l5.33"></a><span id="l5.33">               var label = document.createElement(&quot;label&quot;);</span>
<a href="#l5.34"></a><span id="l5.34">               label.setAttribute('value', tagName);</span>
<a href="#l5.35"></a><span id="l5.35">               label.className = &quot;tagvalue blc-&quot; + color.substr(1);</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">               // Since the control attribute points to the</span>
<a href="#l5.38"></a><span id="l5.38">               // &lt;mail-headerfield-tags&gt; rather than the XUL &lt;label&gt;, screen</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineat">@@ -1324,16 +1321,21 @@</span>
<a href="#l5.40"></a><span id="l5.40">                 label.setAttribute(&quot;aria-label&quot;, ariaLabel);</span>
<a href="#l5.41"></a><span id="l5.41">               }</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">               headerValueNode.appendChild(label);</span>
<a href="#l5.44"></a><span id="l5.44">             }</span>
<a href="#l5.45"></a><span id="l5.45">         ]]&gt;</span>
<a href="#l5.46"></a><span id="l5.46">         &lt;/body&gt;</span>
<a href="#l5.47"></a><span id="l5.47">       &lt;/method&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+          Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+        ]]&gt;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l5.53"></a><span id="l5.53">     &lt;/implementation&gt;</span>
<a href="#l5.54"></a><span id="l5.54">   &lt;/binding&gt;</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56">   &lt;binding id=&quot;search-menulist-abstract&quot; name=&quot;searchMenulistAbstract&quot; extends=&quot;xul:box&quot;&gt;</span>
<a href="#l5.57"></a><span id="l5.57">     &lt;content&gt;</span>
<a href="#l5.58"></a><span id="l5.58">       &lt;xul:menulist class=&quot;search-menulist&quot; xbl:inherits=&quot;flex,disabled&quot; oncommand=&quot;this.parentNode.onSelect(event)&quot;&gt;</span>
<a href="#l5.59"></a><span id="l5.59">         &lt;xul:menupopup class=&quot;search-menulist-popup&quot;/&gt;</span>
<a href="#l5.60"></a><span id="l5.60">       &lt;/xul:menulist&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineat">@@ -1342,20 +1344,16 @@</span>
<a href="#l5.62"></a><span id="l5.62">     &lt;implementation&gt;</span>
<a href="#l5.63"></a><span id="l5.63">       &lt;field name=&quot;internalScope&quot;&gt;null&lt;/field&gt;</span>
<a href="#l5.64"></a><span id="l5.64">       &lt;field name=&quot;internalValue&quot;&gt;-1&lt;/field&gt;</span>
<a href="#l5.65"></a><span id="l5.65">       &lt;field readonly=&quot;true&quot; name=&quot;validityManager&quot;&gt;</span>
<a href="#l5.66"></a><span id="l5.66">         &lt;![CDATA[</span>
<a href="#l5.67"></a><span id="l5.67">            Components.classes['@mozilla.org/mail/search/validityManager;1'].getService(Components.interfaces.nsIMsgSearchValidityManager);</span>
<a href="#l5.68"></a><span id="l5.68">         ]]&gt;</span>
<a href="#l5.69"></a><span id="l5.69">       &lt;/field&gt;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-      &lt;field name=&quot;filterService&quot;&gt;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-        Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-                  .getService(Components.interfaces.nsIMsgFilterService)</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l5.74"></a><span id="l5.74">       &lt;property name=&quot;searchScope&quot; onget=&quot;return this.internalScope;&quot;&gt;</span>
<a href="#l5.75"></a><span id="l5.75">         &lt;!-- scope ID - retrieve the table --&gt;</span>
<a href="#l5.76"></a><span id="l5.76">         &lt;setter&gt;</span>
<a href="#l5.77"></a><span id="l5.77">           &lt;![CDATA[</span>
<a href="#l5.78"></a><span id="l5.78">             // if scope isn't changing this is a noop</span>
<a href="#l5.79"></a><span id="l5.79">             if (this.internalScope == val) return val;</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81">             this.internalScope = val;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineat">@@ -1547,17 +1545,17 @@</span>
<a href="#l5.83"></a><span id="l5.83">           this.Services.strings.createBundle(&quot;chrome://messenger/locale/search-attributes.properties&quot;)</span>
<a href="#l5.84"></a><span id="l5.84">         ]]&gt;</span>
<a href="#l5.85"></a><span id="l5.85">       &lt;/field&gt;</span>
<a href="#l5.86"></a><span id="l5.86">       &lt;property name=&quot;valueLabel&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l5.87"></a><span id="l5.87">         &lt;getter&gt;</span>
<a href="#l5.88"></a><span id="l5.88">           &lt;![CDATA[</span>
<a href="#l5.89"></a><span id="l5.89">             if (isNaN(this.value)) // is this a custom term?</span>
<a href="#l5.90"></a><span id="l5.90">             {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-              let customTerm = this.filterService.getCustomTerm(this.value);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+              let customTerm = MailServices.filters.getCustomTerm(this.value);</span>
<a href="#l5.93"></a><span id="l5.93">               if (customTerm)</span>
<a href="#l5.94"></a><span id="l5.94">                 return customTerm.name;</span>
<a href="#l5.95"></a><span id="l5.95">               else</span>
<a href="#l5.96"></a><span id="l5.96">               {</span>
<a href="#l5.97"></a><span id="l5.97">                 let scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l5.98"></a><span id="l5.98">                     .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l5.99"></a><span id="l5.99">                 scriptError.init(&quot;Missing custom search term &quot; + this.value,</span>
<a href="#l5.100"></a><span id="l5.100">                     null, null, 0, 0,</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineat">@@ -1573,17 +1571,17 @@</span>
<a href="#l5.102"></a><span id="l5.102">         &lt;/getter&gt;</span>
<a href="#l5.103"></a><span id="l5.103">       &lt;/property&gt;</span>
<a href="#l5.104"></a><span id="l5.104">       &lt;property name=&quot;valueIds&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l5.105"></a><span id="l5.105">         &lt;getter&gt;</span>
<a href="#l5.106"></a><span id="l5.106">           &lt;![CDATA[</span>
<a href="#l5.107"></a><span id="l5.107">             var length = new Object;</span>
<a href="#l5.108"></a><span id="l5.108">             let result = this.validityTable.getAvailableAttributes(length);</span>
<a href="#l5.109"></a><span id="l5.109">             // add any available custom search terms</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-            let customEnum = this.filterService.getCustomTerms();</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+            let customEnum = MailServices.filters.getCustomTerms();</span>
<a href="#l5.112"></a><span id="l5.112">             while (customEnum &amp;&amp; customEnum.hasMoreElements())</span>
<a href="#l5.113"></a><span id="l5.113">             {</span>
<a href="#l5.114"></a><span id="l5.114">               let customTerm =</span>
<a href="#l5.115"></a><span id="l5.115">                  customEnum.getNext()</span>
<a href="#l5.116"></a><span id="l5.116">                            .QueryInterface(Components.interfaces.nsIMsgSearchCustomTerm);</span>
<a href="#l5.117"></a><span id="l5.117">               // for custom terms, the array element is a string with the custom id</span>
<a href="#l5.118"></a><span id="l5.118">               // instead of the integer attribute</span>
<a href="#l5.119"></a><span id="l5.119">               if (customTerm.getAvailable(this.searchScope, null))</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineat">@@ -1609,17 +1607,17 @@</span>
<a href="#l5.121"></a><span id="l5.121">             {</span>
<a href="#l5.122"></a><span id="l5.122">             }</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124">             let j = 0;</span>
<a href="#l5.125"></a><span id="l5.125">             for (let i = 0; i &lt; ids.length; i++)</span>
<a href="#l5.126"></a><span id="l5.126">             {</span>
<a href="#l5.127"></a><span id="l5.127">               if (isNaN(ids[i])) // Is this a custom search term?</span>
<a href="#l5.128"></a><span id="l5.128">               {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-                let customTerm = this.filterService.getCustomTerm(ids[i]);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+                let customTerm = MailServices.filters.getCustomTerm(ids[i]);</span>
<a href="#l5.131"></a><span id="l5.131">                 if (customTerm)</span>
<a href="#l5.132"></a><span id="l5.132">                   strings[i] = customTerm.name;</span>
<a href="#l5.133"></a><span id="l5.133">                 else</span>
<a href="#l5.134"></a><span id="l5.134">                   strings[i] = &quot;&quot;;</span>
<a href="#l5.135"></a><span id="l5.135">               }</span>
<a href="#l5.136"></a><span id="l5.136">               else if(ids[i] &gt; Components.interfaces.nsMsgSearchAttrib.OtherHeader &amp;&amp; hdrsArray)</span>
<a href="#l5.137"></a><span id="l5.137">                 strings[i] = hdrsArray[j++];</span>
<a href="#l5.138"></a><span id="l5.138">               else</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineat">@@ -1627,16 +1625,17 @@</span>
<a href="#l5.140"></a><span id="l5.140">                                this.validityManager.getAttributeProperty(ids[i]));</span>
<a href="#l5.141"></a><span id="l5.141">             }</span>
<a href="#l5.142"></a><span id="l5.142">             return strings;</span>
<a href="#l5.143"></a><span id="l5.143">           ]]&gt;</span>
<a href="#l5.144"></a><span id="l5.144">         &lt;/getter&gt;</span>
<a href="#l5.145"></a><span id="l5.145">       &lt;/property&gt;</span>
<a href="#l5.146"></a><span id="l5.146">       &lt;constructor&gt;</span>
<a href="#l5.147"></a><span id="l5.147">       &lt;![CDATA[</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+        Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.149"></a><span id="l5.149">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l5.150"></a><span id="l5.150">         initializeTermFromId(this.id);</span>
<a href="#l5.151"></a><span id="l5.151">       ]]&gt;</span>
<a href="#l5.152"></a><span id="l5.152">       &lt;/constructor&gt;</span>
<a href="#l5.153"></a><span id="l5.153">     &lt;/implementation&gt;</span>
<a href="#l5.154"></a><span id="l5.154">   &lt;/binding&gt;</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156">   &lt;!-- searchoperator - Contains, Is Less than, etc --&gt;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineat">@@ -1658,17 +1657,17 @@</span>
<a href="#l5.158"></a><span id="l5.158">       &lt;/property&gt;</span>
<a href="#l5.159"></a><span id="l5.159">       &lt;property name=&quot;valueIds&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l5.160"></a><span id="l5.160">         &lt;getter&gt;</span>
<a href="#l5.161"></a><span id="l5.161">           &lt;![CDATA[</span>
<a href="#l5.162"></a><span id="l5.162">             var length = new Object;</span>
<a href="#l5.163"></a><span id="l5.163">             let isCustom = isNaN(this.searchAttribute);</span>
<a href="#l5.164"></a><span id="l5.164">             if (isCustom)</span>
<a href="#l5.165"></a><span id="l5.165">             {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-              let customTerm = this.filterService.getCustomTerm(this.searchAttribute);</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+              let customTerm = MailServices.filters.getCustomTerm(this.searchAttribute);</span>
<a href="#l5.168"></a><span id="l5.168">               if (customTerm)</span>
<a href="#l5.169"></a><span id="l5.169">                 return customTerm.getAvailableOperators(this.searchScope, length);</span>
<a href="#l5.170"></a><span id="l5.170">               return [Components.interfaces.nsMsgSearchOp.Contains];</span>
<a href="#l5.171"></a><span id="l5.171">             }</span>
<a href="#l5.172"></a><span id="l5.172">             return this.validityTable.getAvailableOperators(this.searchAttribute,length);</span>
<a href="#l5.173"></a><span id="l5.173">           ]]&gt;</span>
<a href="#l5.174"></a><span id="l5.174">         &lt;/getter&gt;</span>
<a href="#l5.175"></a><span id="l5.175">       &lt;/property&gt;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineat">@@ -1705,16 +1704,17 @@</span>
<a href="#l5.177"></a><span id="l5.177">         &lt;getter&gt;</span>
<a href="#l5.178"></a><span id="l5.178">           &lt;![CDATA[</span>
<a href="#l5.179"></a><span id="l5.179">             return this.searchAttribute;</span>
<a href="#l5.180"></a><span id="l5.180">           ]]&gt;</span>
<a href="#l5.181"></a><span id="l5.181">         &lt;/getter&gt;</span>
<a href="#l5.182"></a><span id="l5.182">       &lt;/property&gt;</span>
<a href="#l5.183"></a><span id="l5.183">       &lt;constructor&gt;</span>
<a href="#l5.184"></a><span id="l5.184">         &lt;![CDATA[</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+          Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.186"></a><span id="l5.186">           Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l5.187"></a><span id="l5.187">         ]]&gt;</span>
<a href="#l5.188"></a><span id="l5.188">       &lt;/constructor&gt;</span>
<a href="#l5.189"></a><span id="l5.189">     &lt;/implementation&gt;</span>
<a href="#l5.190"></a><span id="l5.190">   &lt;/binding&gt;</span>
<a href="#l5.191"></a><span id="l5.191"> </span>
<a href="#l5.192"></a><span id="l5.192">   &lt;!-- searchvalue - a widget which dynamically changes its user interface</span>
<a href="#l5.193"></a><span id="l5.193">        depending on what type of data it's supposed to be showing</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineat">@@ -1778,20 +1778,16 @@</span>
<a href="#l5.195"></a><span id="l5.195">       &lt;xul:textbox flex=&quot;1&quot; class=&quot;search-value-textbox&quot; xbl:inherits=&quot;disabled&quot;</span>
<a href="#l5.196"></a><span id="l5.196">                    type=&quot;number&quot;/&gt;</span>
<a href="#l5.197"></a><span id="l5.197">       &lt;xul:hbox flex=&quot;1&quot; class=&quot;search-value-custom&quot; xbl:inherits=&quot;disabled&quot;/&gt;</span>
<a href="#l5.198"></a><span id="l5.198">     &lt;/content&gt;</span>
<a href="#l5.199"></a><span id="l5.199">     &lt;implementation&gt;</span>
<a href="#l5.200"></a><span id="l5.200">       &lt;field name=&quot;internalOperator&quot;&gt;null&lt;/field&gt;</span>
<a href="#l5.201"></a><span id="l5.201">       &lt;field name=&quot;internalAttribute&quot;&gt;null&lt;/field&gt;</span>
<a href="#l5.202"></a><span id="l5.202">       &lt;field name=&quot;internalValue&quot;&gt;null&lt;/field&gt;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-      &lt;field name=&quot;filterService&quot;&gt;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-        Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-                  .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l5.207"></a><span id="l5.207">       &lt;property name=&quot;opParentValue&quot; onget=&quot;return this.internalOperator;&quot;&gt;</span>
<a href="#l5.208"></a><span id="l5.208">         &lt;setter&gt;</span>
<a href="#l5.209"></a><span id="l5.209">           &lt;![CDATA[</span>
<a href="#l5.210"></a><span id="l5.210">             // noop if we're not changing it</span>
<a href="#l5.211"></a><span id="l5.211">             if (this.internalOperator == val)</span>
<a href="#l5.212"></a><span id="l5.212">               return val;</span>
<a href="#l5.213"></a><span id="l5.213"> </span>
<a href="#l5.214"></a><span id="l5.214">             // Keywords has the null field IsEmpty</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineat">@@ -2080,19 +2076,17 @@</span>
<a href="#l5.216"></a><span id="l5.216">           ]]&gt;</span>
<a href="#l5.217"></a><span id="l5.217">         &lt;/body&gt;</span>
<a href="#l5.218"></a><span id="l5.218">       &lt;/method&gt;</span>
<a href="#l5.219"></a><span id="l5.219">       &lt;method name=&quot;fillInTags&quot;&gt;</span>
<a href="#l5.220"></a><span id="l5.220">         &lt;body&gt;</span>
<a href="#l5.221"></a><span id="l5.221">           &lt;![CDATA[</span>
<a href="#l5.222"></a><span id="l5.222">             var children = document.getAnonymousNodes(this);</span>
<a href="#l5.223"></a><span id="l5.223">             var popupMenu = children[5].firstChild;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-            var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-                                       .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-            var tagArray = tagService.getAllTags({});</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+            let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l5.228"></a><span id="l5.228">             for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l5.229"></a><span id="l5.229">             {</span>
<a href="#l5.230"></a><span id="l5.230">               var taginfo = tagArray[i];</span>
<a href="#l5.231"></a><span id="l5.231">               var newMenuItem = document.createElement('menuitem');</span>
<a href="#l5.232"></a><span id="l5.232">               newMenuItem.setAttribute('label', taginfo.tag);</span>
<a href="#l5.233"></a><span id="l5.233">               newMenuItem.setAttribute('value', taginfo.key);</span>
<a href="#l5.234"></a><span id="l5.234">               popupMenu.appendChild(newMenuItem);</span>
<a href="#l5.235"></a><span id="l5.235">               if (!i)</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineat">@@ -2125,16 +2119,17 @@</span>
<a href="#l5.237"></a><span id="l5.237">         &lt;body&gt;</span>
<a href="#l5.238"></a><span id="l5.238">           &lt;![CDATA[</span>
<a href="#l5.239"></a><span id="l5.239">             this.fillStringsForChildren(menulist.firstChild, bundle);</span>
<a href="#l5.240"></a><span id="l5.240">           ]]&gt;</span>
<a href="#l5.241"></a><span id="l5.241">         &lt;/body&gt;</span>
<a href="#l5.242"></a><span id="l5.242">       &lt;/method&gt;</span>
<a href="#l5.243"></a><span id="l5.243">       &lt;constructor&gt;</span>
<a href="#l5.244"></a><span id="l5.244">       &lt;![CDATA[</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+        Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.246"></a><span id="l5.246">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l5.247"></a><span id="l5.247"> </span>
<a href="#l5.248"></a><span id="l5.248">         // initialize strings</span>
<a href="#l5.249"></a><span id="l5.249">         var bundle = this.Services.strings.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251">         // intialize the priority picker</span>
<a href="#l5.252"></a><span id="l5.252">         this.initialize(document.getAnonymousNodes(this)[1], bundle);</span>
<a href="#l5.253"></a><span id="l5.253"> </span>
<a href="#l5.254"></a><span id="l5.254" class="difflineat">@@ -2507,18 +2502,16 @@</span>
<a href="#l5.255"></a><span id="l5.255">               if (aOutAsync.value &amp;&amp; aUrlListener)</span>
<a href="#l5.256"></a><span id="l5.256">                 return false;</span>
<a href="#l5.257"></a><span id="l5.257">               var unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l5.258"></a><span id="l5.258">                                     .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l5.259"></a><span id="l5.259">               unicodeConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l5.260"></a><span id="l5.260">               foundNewMsg = true;</span>
<a href="#l5.261"></a><span id="l5.261"> </span>
<a href="#l5.262"></a><span id="l5.262">               var index = 0;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-              var hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-                                        .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l5.265"></a><span id="l5.265">               while (document.getAnonymousNodes(this)[0].childNodes.length &lt; this.mMaxMsgHdrsInPopup &amp;&amp; index &lt; numMsgKeys.value)</span>
<a href="#l5.266"></a><span id="l5.266">               {</span>
<a href="#l5.267"></a><span id="l5.267">                 var msgPopup = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;folderSummaryMessage&quot;);</span>
<a href="#l5.268"></a><span id="l5.268">                 var msgHdr = msgDatabase.GetMsgHdrForKey(msgKeys.value[index++]);</span>
<a href="#l5.269"></a><span id="l5.269"> </span>
<a href="#l5.270"></a><span id="l5.270">                 var msgSubject = msgHdr.mime2DecodedSubject;</span>
<a href="#l5.271"></a><span id="l5.271">                 const kMsgFlagHasRe = 0x0010; // MSG_FLAG_HAS_RE</span>
<a href="#l5.272"></a><span id="l5.272">                 if(msgHdr.flags &amp; kMsgFlagHasRe)</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineat">@@ -2536,17 +2529,17 @@</span>
<a href="#l5.274"></a><span id="l5.274">                     if (text)</span>
<a href="#l5.275"></a><span id="l5.275">                       msgPopup.setAttribute('previewText', text);</span>
<a href="#l5.276"></a><span id="l5.276">                   }</span>
<a href="#l5.277"></a><span id="l5.277">                   catch (ex) { }</span>
<a href="#l5.278"></a><span id="l5.278">                 }</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280">                 var names = {};</span>
<a href="#l5.281"></a><span id="l5.281">                 var emails = {};</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-                var numAddresses = hdrParser.parseHeadersWithArray(msgHdr.mime2DecodedAuthor, emails, names, {});</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+                let numAddresses = MailServices.headerParser.parseHeadersWithArray(msgHdr.mime2DecodedAuthor, emails, names, {});</span>
<a href="#l5.284"></a><span id="l5.284">                 msgPopup.setAttribute('sender', names.value[0] ? names.value[0] : emails.value[0]);</span>
<a href="#l5.285"></a><span id="l5.285">                 msgPopup.msgHdr = msgHdr;</span>
<a href="#l5.286"></a><span id="l5.286">                 document.getAnonymousNodes(this)[0].appendChild(msgPopup);</span>
<a href="#l5.287"></a><span id="l5.287">               }</span>
<a href="#l5.288"></a><span id="l5.288">               if (document.getAnonymousNodes(this)[0].childNodes.length &gt;= this.mMaxMsgHdrsInPopup)</span>
<a href="#l5.289"></a><span id="l5.289">                 return true;</span>
<a href="#l5.290"></a><span id="l5.290">             }</span>
<a href="#l5.291"></a><span id="l5.291">             return foundNewMsg;</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineat">@@ -2594,16 +2587,17 @@</span>
<a href="#l5.293"></a><span id="l5.293">             var containingBox = document.getAnonymousNodes(this)[0];</span>
<a href="#l5.294"></a><span id="l5.294">             while (containingBox.hasChildNodes())</span>
<a href="#l5.295"></a><span id="l5.295">               containingBox.removeChild(containingBox.lastChild);</span>
<a href="#l5.296"></a><span id="l5.296">           ]]&gt;</span>
<a href="#l5.297"></a><span id="l5.297">         &lt;/body&gt;</span>
<a href="#l5.298"></a><span id="l5.298">       &lt;/method&gt;</span>
<a href="#l5.299"></a><span id="l5.299">       &lt;constructor&gt;</span>
<a href="#l5.300"></a><span id="l5.300">         &lt;![CDATA[</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+          Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.302"></a><span id="l5.302">           Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l5.303"></a><span id="l5.303">         ]]&gt;</span>
<a href="#l5.304"></a><span id="l5.304">       &lt;/constructor&gt;</span>
<a href="#l5.305"></a><span id="l5.305">     &lt;/implementation&gt;</span>
<a href="#l5.306"></a><span id="l5.306">   &lt;/binding&gt;</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308">   &lt;binding id=&quot;folderSummary-location&quot;&gt;</span>
<a href="#l5.309"></a><span id="l5.309">     &lt;content&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -31,19 +31,17 @@ function OnMailWindowUnload()</span>
<a href="#l6.4"></a><span id="l6.4"> {</span>
<a href="#l6.5"></a><span id="l6.5">   MailOfflineMgr.uninit();</span>
<a href="#l6.6"></a><span id="l6.6">   ClearPendingReadTimer();</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   // all dbview closing is handled by OnUnloadMessenger for the 3-pane (it closes</span>
<a href="#l6.9"></a><span id="l6.9">   //  the tabs which close their views) and OnUnloadMessageWindow for the</span>
<a href="#l6.10"></a><span id="l6.10">   //  standalone message window.</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                              .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  MailServices.mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l6.16"></a><span id="l6.16">   // the tabs have the FolderDisplayWidget close their 'messenger' instances for us</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">   window.QueryInterface(Components.interfaces.nsIDOMChromeWindow)</span>
<a href="#l6.19"></a><span id="l6.19">         .browserDOMWindow = null;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   msgWindow.closeWindow();</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   msgWindow.msgHeaderSink = null;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineat">@@ -85,31 +83,29 @@ function CreateMailWindowGlobals()</span>
<a href="#l6.25"></a><span id="l6.25">   Components.classes[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l6.26"></a><span id="l6.26">             .getService(Components.interfaces.nsIActivityManager)</span>
<a href="#l6.27"></a><span id="l6.27">             .addListener(window.MsgStatusFeedback);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   //Create message window object</span>
<a href="#l6.30"></a><span id="l6.30">   msgWindow = Components.classes[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l6.31"></a><span id="l6.31">                         .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  accountManager = MailServices.accounts;</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">   msgWindow.notificationCallbacks = new BadCertHandler();</span>
<a href="#l6.37"></a><span id="l6.37"> }</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39"> function InitMsgWindow()</span>
<a href="#l6.40"></a><span id="l6.40"> {</span>
<a href="#l6.41"></a><span id="l6.41">   msgWindow.windowCommands = new nsMsgWindowCommands();</span>
<a href="#l6.42"></a><span id="l6.42">   // set the domWindow before setting the status feedback and header sink objects</span>
<a href="#l6.43"></a><span id="l6.43">   msgWindow.domWindow = window;</span>
<a href="#l6.44"></a><span id="l6.44">   msgWindow.statusFeedback = statusFeedback;</span>
<a href="#l6.45"></a><span id="l6.45">   msgWindow.msgHeaderSink = messageHeaderSink;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-            .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-            .AddMsgWindow(msgWindow);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l6.50"></a><span id="l6.50">   let messagepane = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l6.51"></a><span id="l6.51">   messagepane.docShell.allowAuth = false;</span>
<a href="#l6.52"></a><span id="l6.52">   messagepane.docShell.allowDNSPrefetch = false;</span>
<a href="#l6.53"></a><span id="l6.53">   msgWindow.rootDocShell.allowAuth = true;</span>
<a href="#l6.54"></a><span id="l6.54">   msgWindow.rootDocShell.appType = Components.interfaces.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l6.55"></a><span id="l6.55">   // Ensure we don't load xul error pages into the main window</span>
<a href="#l6.56"></a><span id="l6.56">   msgWindow.rootDocShell.useErrorPages = false;</span>
<a href="#l6.57"></a><span id="l6.57"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> Components.utils.import(&quot;resource:///modules/gloda/dbview.js&quot;);</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.12"></a><span id="l7.12"> </span>
<a href="#l7.13"></a><span id="l7.13"> const ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> const kClassicMailLayout = 0;</span>
<a href="#l7.16"></a><span id="l7.16"> const kWideMailLayout = 1;</span>
<a href="#l7.17"></a><span id="l7.17"> const kVerticalMailLayout = 2;</span>
<a href="#l7.18"></a><span id="l7.18"> const kMailLayoutCommandMap =</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineat">@@ -30,19 +31,16 @@ const kMsgNotificationPhishingBar = 1;</span>
<a href="#l7.20"></a><span id="l7.20"> const kMsgNotificationJunkBar = 2;</span>
<a href="#l7.21"></a><span id="l7.21"> const kMsgNotificationRemoteImages = 3;</span>
<a href="#l7.22"></a><span id="l7.22"> const kMsgNotificationMDN = 4;</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l7.25"></a><span id="l7.25"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l7.26"></a><span id="l7.26"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-var gCopyService = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-</span>
<a href="#l7.31"></a><span id="l7.31"> // Timer to mark read, if the user has configured the app to mark a message as</span>
<a href="#l7.32"></a><span id="l7.32"> // read if it is viewed for more than n seconds.</span>
<a href="#l7.33"></a><span id="l7.33"> var gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35"> // the user preference,</span>
<a href="#l7.36"></a><span id="l7.36"> // if HTML is not allowed. I assume, that the user could have set this to a</span>
<a href="#l7.37"></a><span id="l7.37"> // value &gt; 1 in his prefs.js or user.js, but that the value will not</span>
<a href="#l7.38"></a><span id="l7.38"> // change during runtime other than through the MsgBody*() functions below.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineat">@@ -744,19 +742,17 @@ function SetMenuItemLabel(menuItemId, cu</span>
<a href="#l7.40"></a><span id="l7.40"> function RemoveAllMessageTags()</span>
<a href="#l7.41"></a><span id="l7.41"> {</span>
<a href="#l7.42"></a><span id="l7.42">   var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l7.43"></a><span id="l7.43">   if (!selectedMessages.length)</span>
<a href="#l7.44"></a><span id="l7.44">     return;</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l7.47"></a><span id="l7.47">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">   var allKeys = &quot;&quot;;</span>
<a href="#l7.54"></a><span id="l7.54">   for (var j = 0; j &lt; tagArray.length; ++j)</span>
<a href="#l7.55"></a><span id="l7.55">   {</span>
<a href="#l7.56"></a><span id="l7.56">     if (j)</span>
<a href="#l7.57"></a><span id="l7.57">       allKeys += &quot; &quot;;</span>
<a href="#l7.58"></a><span id="l7.58">     allKeys += tagArray[j].key;</span>
<a href="#l7.59"></a><span id="l7.59">   }</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineat">@@ -871,22 +867,20 @@ function AddTag()</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62"> function ManageTags()</span>
<a href="#l7.63"></a><span id="l7.63"> {</span>
<a href="#l7.64"></a><span id="l7.64">   openOptionsDialog(&quot;paneDisplay&quot;, &quot;tagTab&quot;);</span>
<a href="#l7.65"></a><span id="l7.65"> }</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67"> function AddTagCallback(name, color)</span>
<a href="#l7.68"></a><span id="l7.68"> {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  tagService.addTag(name, color, '');</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  MailServices.tags.addTag(name, color, '');</span>
<a href="#l7.73"></a><span id="l7.73">   try</span>
<a href="#l7.74"></a><span id="l7.74">   {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    ToggleMessageTag(tagService.getKeyForTag(name), true);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    ToggleMessageTag(MailServices.tags.getKeyForTag(name), true);</span>
<a href="#l7.77"></a><span id="l7.77">   }</span>
<a href="#l7.78"></a><span id="l7.78">   catch(ex)</span>
<a href="#l7.79"></a><span id="l7.79">   {</span>
<a href="#l7.80"></a><span id="l7.80">     return false;</span>
<a href="#l7.81"></a><span id="l7.81">   }</span>
<a href="#l7.82"></a><span id="l7.82">   return true;</span>
<a href="#l7.83"></a><span id="l7.83"> }</span>
<a href="#l7.84"></a><span id="l7.84"> </span>
<a href="#l7.85"></a><span id="l7.85" class="difflineat">@@ -901,19 +895,17 @@ function SetMessageTagLabel(menuitem, in</span>
<a href="#l7.86"></a><span id="l7.86">   var label = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l7.87"></a><span id="l7.87">                       .getFormattedString(&quot;mailnews.tags.format&quot;,</span>
<a href="#l7.88"></a><span id="l7.88">                                           [accesskey, name]);</span>
<a href="#l7.89"></a><span id="l7.89">   menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l7.90"></a><span id="l7.90"> }</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92"> function InitMessageTags(menuPopup)</span>
<a href="#l7.93"></a><span id="l7.93"> {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l7.98"></a><span id="l7.98">   var tagCount = tagArray.length;</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100">   // Remove any existing non-static entries... (clear tags list before rebuilding it)</span>
<a href="#l7.101"></a><span id="l7.101">   // &quot;5&quot; is the number of menu items (including separators) on the top of the menu</span>
<a href="#l7.102"></a><span id="l7.102">   // that should not be cleared.</span>
<a href="#l7.103"></a><span id="l7.103">   for (let i = menuPopup.childNodes.length; i &gt; 5; --i)</span>
<a href="#l7.104"></a><span id="l7.104">     menuPopup.removeChild(menuPopup.lastChild);</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106" class="difflineat">@@ -1159,22 +1151,20 @@ function IsReplyAllEnabled()</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">   // Check to see if my email address is in the list of addresses.</span>
<a href="#l7.109"></a><span id="l7.109">   let myEmail = getIdentityForHeader(msgHdr).email;</span>
<a href="#l7.110"></a><span id="l7.110">   // We aren't guaranteed to have an email address, so guard against that.</span>
<a href="#l7.111"></a><span id="l7.111">   let imInAddresses = myEmail &amp;&amp; (addresses.toLowerCase().contains(</span>
<a href="#l7.112"></a><span id="l7.112">                                     myEmail.toLowerCase()));</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114">   // Now, let's get the number of unique addresses.</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-  let hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-                            .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-  let uniqueAddresses = hdrParser.removeDuplicateAddresses(addresses, &quot;&quot;);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  let uniqueAddresses = MailServices.headerParser.removeDuplicateAddresses(addresses, &quot;&quot;);</span>
<a href="#l7.119"></a><span id="l7.119">   let emailAddresses = {};</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-  let numAddresses = hdrParser.parseHeadersWithArray(uniqueAddresses,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                                                     emailAddresses, {}, {});</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  let numAddresses = MailServices.headerParser.parseHeadersWithArray(uniqueAddresses,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                                                                     emailAddresses, {}, {});</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">   // XXX: This should be handled by the nsIMsgHeaderParser.  See Bug 498480.</span>
<a href="#l7.126"></a><span id="l7.126">   // Remove addresses that look like email groups, because we don't support</span>
<a href="#l7.127"></a><span id="l7.127">   // those yet.  (Any address with a : in it will be an empty email group,</span>
<a href="#l7.128"></a><span id="l7.128">   // or the colon and the groupname would be set as the first name, and not</span>
<a href="#l7.129"></a><span id="l7.129">   // show up in the address at all.)</span>
<a href="#l7.130"></a><span id="l7.130">   for (var i in emailAddresses.value)</span>
<a href="#l7.131"></a><span id="l7.131">   {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineat">@@ -1643,19 +1633,17 @@ BatchMessageMover.prototype = {</span>
<a href="#l7.133"></a><span id="l7.133">        if (! (copyBatchKey in this._batches)) {</span>
<a href="#l7.134"></a><span id="l7.134">         this._batches[copyBatchKey] = [msgHdr.folder, archiveFolderUri,</span>
<a href="#l7.135"></a><span id="l7.135">                                        archiveGranularity,</span>
<a href="#l7.136"></a><span id="l7.136">                                        archiveKeepFolderStructure,</span>
<a href="#l7.137"></a><span id="l7.137">                                        msgYear, monthFolderName];</span>
<a href="#l7.138"></a><span id="l7.138">       }</span>
<a href="#l7.139"></a><span id="l7.139">       this._batches[copyBatchKey].push(msgHdr);</span>
<a href="#l7.140"></a><span id="l7.140">     }</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-    let notificationService = Components.classes[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-                                        .getService(Components.interfaces.nsIMsgFolderNotificationService);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    notificationService.addListener(this, notificationService.folderAdded);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+    MailServices.mfn.addListener(this, MailServices.mfn.folderAdded);</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146">     // Now we launch the code iterating over all message copies, one in turn.</span>
<a href="#l7.147"></a><span id="l7.147">     this.processNextBatch();</span>
<a href="#l7.148"></a><span id="l7.148">   },</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150">   processNextBatch: function BatchMessageMover_processNextBatch ()</span>
<a href="#l7.151"></a><span id="l7.151">   {</span>
<a href="#l7.152"></a><span id="l7.152">     for (let key in this._batches)</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineat">@@ -1750,27 +1738,25 @@ BatchMessageMover.prototype = {</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155">       if (dstFolder != srcFolder)</span>
<a href="#l7.156"></a><span id="l7.156">       {</span>
<a href="#l7.157"></a><span id="l7.157">         let array = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l7.158"></a><span id="l7.158">                               .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l7.159"></a><span id="l7.159">         msgs.forEach(function(item){array.appendElement(item, false);});</span>
<a href="#l7.160"></a><span id="l7.160">         // If the source folder doesn't support deleting messages, we</span>
<a href="#l7.161"></a><span id="l7.161">         // make archive a copy, not a move.</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-        gCopyService.CopyMessages(srcFolder, array, dstFolder,</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-                                  srcFolder.canDeleteMessages, this, msgWindow, true);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+        MailServices.copy.CopyMessages(srcFolder, array, dstFolder,</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+                                       srcFolder.canDeleteMessages, this, msgWindow, true);</span>
<a href="#l7.166"></a><span id="l7.166">         return; // only do one.</span>
<a href="#l7.167"></a><span id="l7.167">       }</span>
<a href="#l7.168"></a><span id="l7.168">       delete this._batches[key];</span>
<a href="#l7.169"></a><span id="l7.169">     }</span>
<a href="#l7.170"></a><span id="l7.170">     gFolderDisplay.hintMassMoveCompleted();</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    Components.classes[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-              .getService(Components.interfaces.nsIMsgFolderNotificationService)</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-              .removeListener(this);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    MailServices.mfn.removeListener(this);</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177">   },</span>
<a href="#l7.178"></a><span id="l7.178">   OnStartRunningUrl: function(url) {</span>
<a href="#l7.179"></a><span id="l7.179">   },</span>
<a href="#l7.180"></a><span id="l7.180"> </span>
<a href="#l7.181"></a><span id="l7.181">   OnStopRunningUrl: function(url, exitCode)</span>
<a href="#l7.182"></a><span id="l7.182">   {</span>
<a href="#l7.183"></a><span id="l7.183">     // this will always be a create folder url, afaik.</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineat">@@ -1879,19 +1865,17 @@ function MsgComposeDraftMessage()</span>
<a href="#l7.185"></a><span id="l7.185">                  gFolderDisplay.displayedFolder,</span>
<a href="#l7.186"></a><span id="l7.186">                  gFolderDisplay.selectedMessageUris);</span>
<a href="#l7.187"></a><span id="l7.187"> }</span>
<a href="#l7.188"></a><span id="l7.188"> </span>
<a href="#l7.189"></a><span id="l7.189"> function MsgCreateFilter()</span>
<a href="#l7.190"></a><span id="l7.190"> {</span>
<a href="#l7.191"></a><span id="l7.191">   // retrieve Sender direct from selected message's headers</span>
<a href="#l7.192"></a><span id="l7.192">   var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-  var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-                               .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  var emailAddress = headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  let emailAddress = MailServices.headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l7.197"></a><span id="l7.197">   if (emailAddress)</span>
<a href="#l7.198"></a><span id="l7.198">     top.MsgFilters(emailAddress, null);</span>
<a href="#l7.199"></a><span id="l7.199"> }</span>
<a href="#l7.200"></a><span id="l7.200"> </span>
<a href="#l7.201"></a><span id="l7.201"> function MsgNewFolder(callBackFunctionName)</span>
<a href="#l7.202"></a><span id="l7.202"> {</span>
<a href="#l7.203"></a><span id="l7.203">   var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l7.204"></a><span id="l7.204">   var dualUseFolders = true;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineat">@@ -2311,67 +2295,60 @@ function MsgFilters(emailAddress, folder</span>
<a href="#l7.206"></a><span id="l7.206">   {</span>
<a href="#l7.207"></a><span id="l7.207">     args = { refresh: false, folder: folder };</span>
<a href="#l7.208"></a><span id="l7.208">     MsgFilterList(args);</span>
<a href="#l7.209"></a><span id="l7.209">   }</span>
<a href="#l7.210"></a><span id="l7.210"> }</span>
<a href="#l7.211"></a><span id="l7.211"> </span>
<a href="#l7.212"></a><span id="l7.212"> function MsgApplyFilters()</span>
<a href="#l7.213"></a><span id="l7.213"> {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-  var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  let preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l7.219"></a><span id="l7.219">   let selectedFolders = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l7.220"></a><span id="l7.220">                                   .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l7.221"></a><span id="l7.221">   selectedFolders.appendElement(preselectedFolder, false);</span>
<a href="#l7.222"></a><span id="l7.222"> </span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-  var curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+  let curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l7.225"></a><span id="l7.225">   // create a new filter list and copy over the enabled filters to it.</span>
<a href="#l7.226"></a><span id="l7.226">   // We do this instead of having the filter after the fact code ignore</span>
<a href="#l7.227"></a><span id="l7.227">   // disabled filters because the Filter Dialog filter after the fact</span>
<a href="#l7.228"></a><span id="l7.228">   // code would have to clone filters to allow disabled filters to run,</span>
<a href="#l7.229"></a><span id="l7.229">   // and we don't support cloning filters currently.</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-  var tempFilterList = filterService.getTempFilterList(preselectedFolder);</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-  var numFilters = curFilterList.filterCount;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  let tempFilterList = MailServices.filters.getTempFilterList(preselectedFolder);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+  let numFilters = curFilterList.filterCount;</span>
<a href="#l7.234"></a><span id="l7.234">   // make sure the temp filter list uses the same log stream</span>
<a href="#l7.235"></a><span id="l7.235">   tempFilterList.logStream = curFilterList.logStream;</span>
<a href="#l7.236"></a><span id="l7.236">   tempFilterList.loggingEnabled = curFilterList.loggingEnabled;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  var newFilterIndex = 0;</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  for (var i = 0; i &lt; numFilters; i++)</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  let newFilterIndex = 0;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  for (let i = 0; i &lt; numFilters; i++)</span>
<a href="#l7.241"></a><span id="l7.241">   {</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-    var curFilter = curFilterList.getFilterAt(i);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+    let curFilter = curFilterList.getFilterAt(i);</span>
<a href="#l7.244"></a><span id="l7.244">     // only add enabled, UI visibile filters that are in the manual context</span>
<a href="#l7.245"></a><span id="l7.245">     if (curFilter.enabled &amp;&amp; !curFilter.temporary &amp;&amp;</span>
<a href="#l7.246"></a><span id="l7.246">         (curFilter.filterType &amp; Components.interfaces.nsMsgFilterType.Manual))</span>
<a href="#l7.247"></a><span id="l7.247">     {</span>
<a href="#l7.248"></a><span id="l7.248">       tempFilterList.insertFilterAt(newFilterIndex, curFilter);</span>
<a href="#l7.249"></a><span id="l7.249">       newFilterIndex++;</span>
<a href="#l7.250"></a><span id="l7.250">     }</span>
<a href="#l7.251"></a><span id="l7.251">   }</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-  filterService.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+  MailServices.filters.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l7.254"></a><span id="l7.254"> }</span>
<a href="#l7.255"></a><span id="l7.255"> </span>
<a href="#l7.256"></a><span id="l7.256"> function MsgApplyFiltersToSelection()</span>
<a href="#l7.257"></a><span id="l7.257"> {</span>
<a href="#l7.258"></a><span id="l7.258">   // bail if we're dealing with a dummy header</span>
<a href="#l7.259"></a><span id="l7.259">   if (gMessageDisplay.isDummy)</span>
<a href="#l7.260"></a><span id="l7.260">     return;</span>
<a href="#l7.261"></a><span id="l7.261"> </span>
<a href="#l7.262"></a><span id="l7.262">   var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l7.263"></a><span id="l7.263">   if (selectedMessages.length) {</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-    var filterService =</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-      Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-    filterService.applyFilters(Components.interfaces.nsMsgFilterType.Manual,</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-                               toXPCOMArray(selectedMessages,</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-                                            Components.interfaces.nsIMutableArray),</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-                               gFolderDisplay.displayedFolder,</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-                               msgWindow);</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+    MailServices.filters.applyFilters(Components.interfaces.nsMsgFilterType.Manual,</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+                                      toXPCOMArray(selectedMessages,</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+                                                   Components.interfaces.nsIMutableArray),</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+                                      gFolderDisplay.displayedFolder,</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+                                      msgWindow);</span>
<a href="#l7.278"></a><span id="l7.278">   }</span>
<a href="#l7.279"></a><span id="l7.279"> }</span>
<a href="#l7.280"></a><span id="l7.280"> </span>
<a href="#l7.281"></a><span id="l7.281"> function ChangeMailLayout(newLayout)</span>
<a href="#l7.282"></a><span id="l7.282"> {</span>
<a href="#l7.283"></a><span id="l7.283">   Services.prefs.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l7.284"></a><span id="l7.284"> }</span>
<a href="#l7.285"></a><span id="l7.285"> </span>
<a href="#l7.286"></a><span id="l7.286" class="difflineat">@@ -2642,29 +2619,27 @@ function GetNewMsgs(server, folder)</span>
<a href="#l7.287"></a><span id="l7.287">   // Whenever we do get new messages, clear the old new messages.</span>
<a href="#l7.288"></a><span id="l7.288">   folder.biffState = nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l7.289"></a><span id="l7.289">   folder.clearNewMessages();</span>
<a href="#l7.290"></a><span id="l7.290">   server.getNewMessages(folder, msgWindow, null);</span>
<a href="#l7.291"></a><span id="l7.291"> }</span>
<a href="#l7.292"></a><span id="l7.292"> </span>
<a href="#l7.293"></a><span id="l7.293"> function SendUnsentMessages()</span>
<a href="#l7.294"></a><span id="l7.294"> {</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-  var msgSendlater = Components.classes[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+  let msgSendlater = Components.classes[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l7.297"></a><span id="l7.297">                                .getService(Components.interfaces.nsIMsgSendLater);</span>
<a href="#l7.298"></a><span id="l7.298"> </span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-  var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-  var allIdentities = accountManager.allIdentities;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-  var identitiesCount = allIdentities.length;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-  for (var i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-    var currentIdentity = allIdentities.queryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-    var msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  let allIdentities = MailServices.accounts.allIdentities;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+  let identitiesCount = allIdentities.length;</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+  for (let i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+    let currentIdentity = allIdentities.queryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+    let msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l7.311"></a><span id="l7.311">     if (msgFolder) {</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-      var numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-      if(numMessages &gt; 0) {</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+      let numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+      if (numMessages &gt; 0) {</span>
<a href="#l7.316"></a><span id="l7.316">         msgSendlater.sendUnsentMessages(currentIdentity);</span>
<a href="#l7.317"></a><span id="l7.317">         // Right now, all identities point to the same unsent messages</span>
<a href="#l7.318"></a><span id="l7.318">         // folder, so to avoid sending multiple copies of the</span>
<a href="#l7.319"></a><span id="l7.319">         // unsent messages, we only call messenger.SendUnsentMessages() once.</span>
<a href="#l7.320"></a><span id="l7.320">         // See bug #89150 for details.</span>
<a href="#l7.321"></a><span id="l7.321">         break;</span>
<a href="#l7.322"></a><span id="l7.322">       }</span>
<a href="#l7.323"></a><span id="l7.323">     }</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineat">@@ -2870,19 +2845,17 @@ var gMessageNotificationBar =</span>
<a href="#l7.325"></a><span id="l7.325">     this.updateMsgNotificationBar(kMsgNotificationJunkBar, isJunk);</span>
<a href="#l7.326"></a><span id="l7.326"> </span>
<a href="#l7.327"></a><span id="l7.327">     goUpdateCommand('button_junk');</span>
<a href="#l7.328"></a><span id="l7.328">   },</span>
<a href="#l7.329"></a><span id="l7.329"> </span>
<a href="#l7.330"></a><span id="l7.330">   setRemoteContentMsg: function(aMsgHdr)</span>
<a href="#l7.331"></a><span id="l7.331">   {</span>
<a href="#l7.332"></a><span id="l7.332">     // update the allow remote content for sender string</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-    var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-    var emailAddress = headerParser.extractHeaderAddressMailboxes(aMsgHdr.author);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+    let emailAddress = MailServices.headerParser.extractHeaderAddressMailboxes(aMsgHdr.author);</span>
<a href="#l7.337"></a><span id="l7.337">     var desc = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l7.338"></a><span id="l7.338">                        .getFormattedString(&quot;alwaysLoadRemoteContentForSender2&quot;,</span>
<a href="#l7.339"></a><span id="l7.339">                                            [emailAddress ? emailAddress : aMsgHdr.author]);</span>
<a href="#l7.340"></a><span id="l7.340">     var authorDesc = document.getElementById(&quot;allowRemoteContentForAuthorDesc&quot;);</span>
<a href="#l7.341"></a><span id="l7.341">     authorDesc.value = desc;</span>
<a href="#l7.342"></a><span id="l7.342">     authorDesc.setAttribute(&quot;tooltiptext&quot;, desc);</span>
<a href="#l7.343"></a><span id="l7.343">     this.updateMsgNotificationBar(kMsgNotificationRemoteImages, true);</span>
<a href="#l7.344"></a><span id="l7.344">   },</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineat">@@ -2895,22 +2868,20 @@ var gMessageNotificationBar =</span>
<a href="#l7.346"></a><span id="l7.346">   setMDNMsg: function(aMdnGenerator, aMsgHeader, aMimeHdr)</span>
<a href="#l7.347"></a><span id="l7.347">   {</span>
<a href="#l7.348"></a><span id="l7.348">     this.mdnGenerator = aMdnGenerator;</span>
<a href="#l7.349"></a><span id="l7.349">     // Return receipts can be RFC 3798 or not.</span>
<a href="#l7.350"></a><span id="l7.350">     let mdnHdr = aMimeHdr.extractHeader(&quot;Disposition-Notification-To&quot;, false) ||</span>
<a href="#l7.351"></a><span id="l7.351">                  aMimeHdr.extractHeader(&quot;Return-Receipt-To&quot;, false); // not</span>
<a href="#l7.352"></a><span id="l7.352">     let fromHdr = aMimeHdr.extractHeader(&quot;From&quot;, false);</span>
<a href="#l7.353"></a><span id="l7.353"> </span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-    let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-    let mdnAddr = headerParser.extractHeaderAddressMailboxes(mdnHdr);</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-    let fromAddr = headerParser.extractHeaderAddressMailboxes(fromHdr);</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-    let authorName = headerParser.extractHeaderAddressName(</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+    let mdnAddr = MailServices.headerParser.extractHeaderAddressMailboxes(mdnHdr);</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+    let fromAddr = MailServices.headerParser.extractHeaderAddressMailboxes(fromHdr);</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+    let authorName = MailServices.headerParser.extractHeaderAddressName(</span>
<a href="#l7.364"></a><span id="l7.364">                        aMsgHeader.mime2DecodedAuthor) || aMsgHeader.author;</span>
<a href="#l7.365"></a><span id="l7.365"> </span>
<a href="#l7.366"></a><span id="l7.366">     let mdnBarMsg = document.getElementById(&quot;mdnBarMessage&quot;);</span>
<a href="#l7.367"></a><span id="l7.367">     if (mdnBarMsg.firstChild) // might have to remove old text first</span>
<a href="#l7.368"></a><span id="l7.368">      mdnBarMsg.removeChild(mdnBarMsg.firstChild);</span>
<a href="#l7.369"></a><span id="l7.369"> </span>
<a href="#l7.370"></a><span id="l7.370">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l7.371"></a><span id="l7.371">     var barMsg;</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineat">@@ -2977,32 +2948,28 @@ function LoadMsgWithRemoteContent()</span>
<a href="#l7.373"></a><span id="l7.373">  */</span>
<a href="#l7.374"></a><span id="l7.374"> function allowRemoteContentForSender()</span>
<a href="#l7.375"></a><span id="l7.375"> {</span>
<a href="#l7.376"></a><span id="l7.376">   // get the sender of the msg hdr</span>
<a href="#l7.377"></a><span id="l7.377">   var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l7.378"></a><span id="l7.378">   if (!msgHdr)</span>
<a href="#l7.379"></a><span id="l7.379">     return;</span>
<a href="#l7.380"></a><span id="l7.380"> </span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-  var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-                               .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l7.383"></a><span id="l7.383">   var names = {};</span>
<a href="#l7.384"></a><span id="l7.384">   var addresses = {};</span>
<a href="#l7.385"></a><span id="l7.385">   var fullNames = {};</span>
<a href="#l7.386"></a><span id="l7.386">   var numAddresses;</span>
<a href="#l7.387"></a><span id="l7.387"> </span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-  numAddresses = headerParser.parseHeadersWithArray(msgHdr.author, addresses, names, fullNames);</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  numAddresses = MailServices.headerParser.parseHeadersWithArray(msgHdr.author, addresses, names, fullNames);</span>
<a href="#l7.390"></a><span id="l7.390">   var authorEmailAddress = addresses.value[0];</span>
<a href="#l7.391"></a><span id="l7.391">   if (!authorEmailAddress)</span>
<a href="#l7.392"></a><span id="l7.392">     return;</span>
<a href="#l7.393"></a><span id="l7.393"> </span>
<a href="#l7.394"></a><span id="l7.394">   // search through all of our local address books looking for a match.</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-                             .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-                             .directories;</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+  let enumerator = MailServices.ab.directories;</span>
<a href="#l7.399"></a><span id="l7.399">   var cardForEmailAddress;</span>
<a href="#l7.400"></a><span id="l7.400">   var addrbook;</span>
<a href="#l7.401"></a><span id="l7.401">   while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l7.402"></a><span id="l7.402">   {</span>
<a href="#l7.403"></a><span id="l7.403">     addrbook = enumerator.getNext()</span>
<a href="#l7.404"></a><span id="l7.404">                          .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l7.405"></a><span id="l7.405">     // Try/catch because some cardForEmailAddress functions may not be</span>
<a href="#l7.406"></a><span id="l7.406">     // implemented.</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineat">@@ -3295,19 +3262,17 @@ function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l7.408"></a><span id="l7.408"> {</span>
<a href="#l7.409"></a><span id="l7.409">   if (aCheckFirstUse) {</span>
<a href="#l7.410"></a><span id="l7.410">     if (!Services.prefs.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l7.411"></a><span id="l7.411">       return;</span>
<a href="#l7.412"></a><span id="l7.412">     Services.prefs.setBoolPref(&quot;mailnews.ui.junk.firstuse&quot;, false);</span>
<a href="#l7.413"></a><span id="l7.413"> </span>
<a href="#l7.414"></a><span id="l7.414">     // check to see if this is an existing profile where the user has started using</span>
<a href="#l7.415"></a><span id="l7.415">     // the junk mail feature already</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-    var junkmailPlugin = Components.classes[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-                                   .getService(Components.interfaces.nsIJunkMailPlugin);</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-    if (junkmailPlugin.userHasClassified)</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+    if (MailServices.junk.userHasClassified)</span>
<a href="#l7.420"></a><span id="l7.420">       return;</span>
<a href="#l7.421"></a><span id="l7.421">   }</span>
<a href="#l7.422"></a><span id="l7.422"> </span>
<a href="#l7.423"></a><span id="l7.423">   var desiredWindow = Services.wm.getMostRecentWindow(&quot;mailnews:junkmailinfo&quot;);</span>
<a href="#l7.424"></a><span id="l7.424"> </span>
<a href="#l7.425"></a><span id="l7.425">   if (desiredWindow)</span>
<a href="#l7.426"></a><span id="l7.426">     desiredWindow.focus();</span>
<a href="#l7.427"></a><span id="l7.427">   else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,24 +1,25 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.5"></a><span id="l8.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> Components.utils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l8.15"></a><span id="l8.15"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailInstrumentation.js&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> Components.utils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+Components.utils.import(&quot;resource:///modules/msgDBCacheManager.js&quot;);</span>
<a href="#l8.22"></a><span id="l8.22"> Components.utils.import(&quot;resource:///modules/sessionStoreManager.js&quot;);</span>
<a href="#l8.23"></a><span id="l8.23"> Components.utils.import(&quot;resource:///modules/summaryFrameManager.js&quot;);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-Components.utils.import(&quot;resource:///modules/mailInstrumentation.js&quot;);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-Components.utils.import(&quot;resource:///modules/msgDBCacheManager.js&quot;);</span>
<a href="#l8.26"></a><span id="l8.26"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> // from MailNewsTypes.h</span>
<a href="#l8.31"></a><span id="l8.31"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l8.32"></a><span id="l8.32"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l8.33"></a><span id="l8.33"> const kMailCheckOncePrefName = &quot;mail.startup.enabledMailCheckOnce&quot;;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -599,19 +600,17 @@ function OnUnloadMessenger()</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   TabsInTitlebar.uninit();</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.39"></a><span id="l8.39">   tabmail._teardown();</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   webSearchTabType.shutdown();</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-                              .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  MailServices.mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">   gPhishingDetector.shutdown();</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   Services.obs.removeObserver(gPluginHandler.pluginCrashed, &quot;plugin-crashed&quot;);</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l8.53"></a><span id="l8.53">   OnUnloadMsgHeaderPane();</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineat">@@ -855,21 +854,19 @@ function loadStartFolder(initialUri)</span>
<a href="#l8.56"></a><span id="l8.56">         if (MailOfflineMgr.shouldSendUnsentMessages())</span>
<a href="#l8.57"></a><span id="l8.57">           SendUnsentMessages();</span>
<a href="#l8.58"></a><span id="l8.58">       }, 0);</span>
<a href="#l8.59"></a><span id="l8.59">     }</span>
<a href="#l8.60"></a><span id="l8.60"> }</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62"> function AddToSession()</span>
<a href="#l8.63"></a><span id="l8.63"> {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-                              .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l8.66"></a><span id="l8.66">   var nsIFolderListener = Components.interfaces.nsIFolderListener;</span>
<a href="#l8.67"></a><span id="l8.67">   var notifyFlags = nsIFolderListener.intPropertyChanged | nsIFolderListener.event;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  mailSession.AddFolderListener(folderListener, notifyFlags);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  MailServices.mailSession.AddFolderListener(folderListener, notifyFlags);</span>
<a href="#l8.70"></a><span id="l8.70"> }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72"> function InitPanes()</span>
<a href="#l8.73"></a><span id="l8.73"> {</span>
<a href="#l8.74"></a><span id="l8.74">   gFolderTreeView.load(document.getElementById(&quot;folderTree&quot;),</span>
<a href="#l8.75"></a><span id="l8.75">                        &quot;folderTree.json&quot;);</span>
<a href="#l8.76"></a><span id="l8.76">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l8.77"></a><span id="l8.77">   folderTree.addEventListener(&quot;click&quot;,FolderPaneOnClick,true);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineat">@@ -1371,26 +1368,24 @@ function ThreadPaneOnDragOver(aEvent) {</span>
<a href="#l8.79"></a><span id="l8.79">       if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l8.80"></a><span id="l8.80">         ds.canDrop = true;</span>
<a href="#l8.81"></a><span id="l8.81">     }</span>
<a href="#l8.82"></a><span id="l8.82">   }</span>
<a href="#l8.83"></a><span id="l8.83"> }</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85"> function ThreadPaneOnDrop(aEvent) {</span>
<a href="#l8.86"></a><span id="l8.86">   let dt = aEvent.dataTransfer;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  let cs = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l8.89"></a><span id="l8.89">   for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l8.90"></a><span id="l8.90">     let extFile = dt.mozGetDataAt(&quot;application/x-moz-file&quot;, i)</span>
<a href="#l8.91"></a><span id="l8.91">                     .QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l8.92"></a><span id="l8.92">     if (extFile.isFile()) {</span>
<a href="#l8.93"></a><span id="l8.93">       let len = extFile.leafName.length;</span>
<a href="#l8.94"></a><span id="l8.94">       if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-        cs.CopyFileMessage(extFile, gFolderDisplay.displayedFolder, null, false,</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-                           1, &quot;&quot;, null, msgWindow);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+        MailServices.copy.CopyFileMessage(extFile, gFolderDisplay.displayedFolder,</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+                                          null, false, 1, &quot;&quot;, null, msgWindow);</span>
<a href="#l8.99"></a><span id="l8.99">     }</span>
<a href="#l8.100"></a><span id="l8.100">   }</span>
<a href="#l8.101"></a><span id="l8.101"> }</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103"> var LightWeightThemeWebInstaller = {</span>
<a href="#l8.104"></a><span id="l8.104">   handleEvent: function (event) {</span>
<a href="#l8.105"></a><span id="l8.105">     switch (event.type) {</span>
<a href="#l8.106"></a><span id="l8.106">       case &quot;InstallBrowserTheme&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/newTagDialog.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/newTagDialog.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l9.5"></a><span id="l9.5">  *</span>
<a href="#l9.6"></a><span id="l9.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> var dialog;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> /**</span>
<a href="#l9.16"></a><span id="l9.16">  * Pass in keyToEdit as a window argument to turn this dialog into an edit</span>
<a href="#l9.17"></a><span id="l9.17">  * tag dialog.</span>
<a href="#l9.18"></a><span id="l9.18">  */</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineat">@@ -40,60 +41,54 @@ function initializeForEditing(aTagKey)</span>
<a href="#l9.20"></a><span id="l9.20">   // Change the title of the dialog</span>
<a href="#l9.21"></a><span id="l9.21">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l9.22"></a><span id="l9.22">   document.title = messengerBundle.getString(&quot;editTagTitle&quot;);</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   // override the OK button</span>
<a href="#l9.25"></a><span id="l9.25">   document.documentElement.setAttribute(&quot;ondialogaccept&quot;, &quot;return onOKEditTag();&quot;);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   // extract the color and name for the current tag</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  document.getElementById(&quot;tagColorPicker&quot;).color = tagService.getColorForKey(aTagKey);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  dialog.nameField.value = tagService.getTagForKey(aTagKey);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  document.getElementById(&quot;tagColorPicker&quot;).color = MailServices.tags.getColorForKey(aTagKey);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  dialog.nameField.value = MailServices.tags.getTagForKey(aTagKey);</span>
<a href="#l9.34"></a><span id="l9.34"> }</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36"> /**</span>
<a href="#l9.37"></a><span id="l9.37">  * on OK handler for editing a new tag. </span>
<a href="#l9.38"></a><span id="l9.38">  */</span>
<a href="#l9.39"></a><span id="l9.39"> function onOKEditTag()</span>
<a href="#l9.40"></a><span id="l9.40"> {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l9.43"></a><span id="l9.43">   // get the tag name of the current key we are editing</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  var existingTagName = tagService.getTagForKey(dialog.editTagKey);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  new existingTagName = MailServices.tags.getTagForKey(dialog.editTagKey);</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47">   // it's ok if the name didn't change</span>
<a href="#l9.48"></a><span id="l9.48">   if (existingTagName != dialog.nameField.value)</span>
<a href="#l9.49"></a><span id="l9.49">   {</span>
<a href="#l9.50"></a><span id="l9.50">     // don't let the user edit a tag to the name of another existing tag</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-    if (tagService.getKeyForTag(dialog.nameField.value))</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    if (MailServices.tags.getKeyForTag(dialog.nameField.value))</span>
<a href="#l9.53"></a><span id="l9.53">     {</span>
<a href="#l9.54"></a><span id="l9.54">       alertForExistingTag();</span>
<a href="#l9.55"></a><span id="l9.55">       return false; // abort the OK</span>
<a href="#l9.56"></a><span id="l9.56">     }</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-    tagService.setTagForKey(dialog.editTagKey, dialog.nameField.value);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    MailServices.tags.setTagForKey(dialog.editTagKey, dialog.nameField.value);</span>
<a href="#l9.60"></a><span id="l9.60">   }</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  tagService.setColorForKey(dialog.editTagKey, document.getElementById(&quot;tagColorPicker&quot;).color);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  MailServices.tags.setColorForKey(dialog.editTagKey, document.getElementById(&quot;tagColorPicker&quot;).color);</span>
<a href="#l9.64"></a><span id="l9.64">   return dialog.okCallback();</span>
<a href="#l9.65"></a><span id="l9.65"> }</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67"> /**</span>
<a href="#l9.68"></a><span id="l9.68">  * on OK handler for creating a new tag. Alerts the user if a tag with </span>
<a href="#l9.69"></a><span id="l9.69">  * the name already exists.</span>
<a href="#l9.70"></a><span id="l9.70">  */</span>
<a href="#l9.71"></a><span id="l9.71"> function onOKNewTag()</span>
<a href="#l9.72"></a><span id="l9.72"> {</span>
<a href="#l9.73"></a><span id="l9.73">   var name = dialog.nameField.value;</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  if (tagService.getKeyForTag(name))</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  if (MailServices.tags.getKeyForTag(name))</span>
<a href="#l9.79"></a><span id="l9.79">   {</span>
<a href="#l9.80"></a><span id="l9.80">     alertForExistingTag();</span>
<a href="#l9.81"></a><span id="l9.81">     return false;</span>
<a href="#l9.82"></a><span id="l9.82">   }</span>
<a href="#l9.83"></a><span id="l9.83">   return dialog.okCallback(name, document.getElementById(&quot;tagColorPicker&quot;).color);</span>
<a href="#l9.84"></a><span id="l9.84"> }</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/selectionsummaries.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/selectionsummaries.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10"> Components.utils.import(&quot;resource:///modules/gloda/connotent.js&quot;);</span>
<a href="#l10.11"></a><span id="l10.11"> Components.utils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l10.13"></a><span id="l10.13"> Components.utils.import(&quot;resource:///modules/templateUtils.js&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> let gSelectionSummaryStrings = {</span>
<a href="#l10.16"></a><span id="l10.16">   NConversations: &quot;NConversations&quot;,</span>
<a href="#l10.17"></a><span id="l10.17">   numMsgs: &quot;numMsgs&quot;,</span>
<a href="#l10.18"></a><span id="l10.18">   countUnread: &quot;countUnread&quot;,</span>
<a href="#l10.19"></a><span id="l10.19">   Nmessages: &quot;Nmessages&quot;,</span>
<a href="#l10.20"></a><span id="l10.20">   messagesSize: &quot;messagesSize&quot;,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -128,18 +129,17 @@ function MultiMessageSummary(aMessages, </span>
<a href="#l10.22"></a><span id="l10.22">   this._listener = aListener;</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">   // Ensure the summary selection strings are loaded.</span>
<a href="#l10.25"></a><span id="l10.25">   loadSelectionSummaryStrings();</span>
<a href="#l10.26"></a><span id="l10.26"> }</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> MultiMessageSummary.prototype = {</span>
<a href="#l10.29"></a><span id="l10.29">   init: function() {</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    this._msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-                          getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    this._msgTagService = MailServices.tags;</span>
<a href="#l10.33"></a><span id="l10.33">     this._glodaQueries = [];</span>
<a href="#l10.34"></a><span id="l10.34">     this._msgNodes = {};</span>
<a href="#l10.35"></a><span id="l10.35">     if (this._listener)</span>
<a href="#l10.36"></a><span id="l10.36">       this._listener.onLoadStarted();</span>
<a href="#l10.37"></a><span id="l10.37">     this.summarize();</span>
<a href="#l10.38"></a><span id="l10.38">   },</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">   /**</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -195,18 +195,16 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.42"></a><span id="l10.42">    * Fill in the summary pane describing the selected messages</span>
<a href="#l10.43"></a><span id="l10.43">    **/</span>
<a href="#l10.44"></a><span id="l10.44">   _onLoad: function() {</span>
<a href="#l10.45"></a><span id="l10.45">     let htmlpane = document.getElementById('multimessage');</span>
<a href="#l10.46"></a><span id="l10.46">     // First, we group the messages in threads.</span>
<a href="#l10.47"></a><span id="l10.47">     // count threads</span>
<a href="#l10.48"></a><span id="l10.48">     let threads = {};</span>
<a href="#l10.49"></a><span id="l10.49">     let numThreads = 0;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-                         getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l10.52"></a><span id="l10.52">     let viewThreadId = function (aMsgHdr) {</span>
<a href="#l10.53"></a><span id="l10.53">       let thread = gDBView.getThreadContainingMsgHdr(aMsgHdr);</span>
<a href="#l10.54"></a><span id="l10.54">       return thread.threadKey;</span>
<a href="#l10.55"></a><span id="l10.55">     };</span>
<a href="#l10.56"></a><span id="l10.56">     for (let [,msgHdr] in Iterator(this._msgHdrs))</span>
<a href="#l10.57"></a><span id="l10.57">     {</span>
<a href="#l10.58"></a><span id="l10.58">       if (! threads[viewThreadId(msgHdr)]) {</span>
<a href="#l10.59"></a><span id="l10.59">         threads[viewThreadId(msgHdr)] = [msgHdr];</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineat">@@ -265,17 +263,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.61"></a><span id="l10.61">       if (numMsgs &gt; 1)</span>
<a href="#l10.62"></a><span id="l10.62">         msg_classes.push(&quot;thread&quot;);</span>
<a href="#l10.63"></a><span id="l10.63">       if (countUnread)</span>
<a href="#l10.64"></a><span id="l10.64">         msg_classes.push(&quot;unread&quot;);</span>
<a href="#l10.65"></a><span id="l10.65">       if (countStarred)</span>
<a href="#l10.66"></a><span id="l10.66">         msg_classes.push(&quot;starred&quot;);</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">       let subject = msgs[0].mime2DecodedSubject || gSelectionSummaryStrings['noSubject'];</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      let author = _mm_FormatDisplayName(headerParser, msgs[0].mime2DecodedAuthor, &quot;from&quot;);</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+      let author = _mm_FormatDisplayName(MailServices.headerParser, msgs[0].mime2DecodedAuthor, &quot;from&quot;);</span>
<a href="#l10.71"></a><span id="l10.71"> </span>
<a href="#l10.72"></a><span id="l10.72">       let countstring = &quot;&quot;;</span>
<a href="#l10.73"></a><span id="l10.73">       if (numMsgs &gt; 1) {</span>
<a href="#l10.74"></a><span id="l10.74">         countstring += &quot;(&quot;;</span>
<a href="#l10.75"></a><span id="l10.75">         countstring += PluralForm.get(numMsgs, gSelectionSummaryStrings[&quot;numMsgs&quot;]).replace('#1', numMsgs);</span>
<a href="#l10.76"></a><span id="l10.76">         if (countUnread)</span>
<a href="#l10.77"></a><span id="l10.77">           countstring += PluralForm.get(countUnread, gSelectionSummaryStrings[&quot;countUnread&quot;]).replace('#1', countUnread);</span>
<a href="#l10.78"></a><span id="l10.78">         countstring += &quot;)&quot;;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineat">@@ -526,18 +524,16 @@ ThreadSummary.prototype = {</span>
<a href="#l10.80"></a><span id="l10.80">     // enable/disable the archive button as appropriate</span>
<a href="#l10.81"></a><span id="l10.81">     let archiveBtn = htmlpane.contentDocument.getElementById('hdrArchiveButton');</span>
<a href="#l10.82"></a><span id="l10.82">     archiveBtn.collapsed = !gFolderDisplay.canArchiveSelectedMessages;</span>
<a href="#l10.83"></a><span id="l10.83"> </span>
<a href="#l10.84"></a><span id="l10.84">     let messagesElt = htmlpane.contentDocument.getElementById('messagelist');</span>
<a href="#l10.85"></a><span id="l10.85">     while (messagesElt.firstChild)</span>
<a href="#l10.86"></a><span id="l10.86">       messagesElt.removeChild(messagesElt.firstChild);</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-                                    .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l10.90"></a><span id="l10.90">     let count = 0;</span>
<a href="#l10.91"></a><span id="l10.91">     const MAX_THREADS = 100;</span>
<a href="#l10.92"></a><span id="l10.92">     const SNIPPET_LENGTH = 300;</span>
<a href="#l10.93"></a><span id="l10.93">     let maxCountExceeded = false;</span>
<a href="#l10.94"></a><span id="l10.94">     for (let i = 0; i &lt; numMessages; ++i) {</span>
<a href="#l10.95"></a><span id="l10.95">       count += 1;</span>
<a href="#l10.96"></a><span id="l10.96">       if (count &gt; MAX_THREADS) {</span>
<a href="#l10.97"></a><span id="l10.97">         maxCountExceeded = true;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineat">@@ -546,17 +542,17 @@ ThreadSummary.prototype = {</span>
<a href="#l10.99"></a><span id="l10.99">       let msgHdr = this._msgHdrs[i];</span>
<a href="#l10.100"></a><span id="l10.100"> </span>
<a href="#l10.101"></a><span id="l10.101">       let msg_classes = [&quot;message&quot;];</span>
<a href="#l10.102"></a><span id="l10.102">       if (! msgHdr.isRead)</span>
<a href="#l10.103"></a><span id="l10.103">         msg_classes.push(&quot;unread&quot;);</span>
<a href="#l10.104"></a><span id="l10.104">       if (msgHdr.isFlagged)</span>
<a href="#l10.105"></a><span id="l10.105">         msg_classes.push(&quot;starred&quot;);</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-      let senderName = _mm_FormatDisplayName(headerParser, msgHdr.mime2DecodedAuthor, &quot;from&quot;);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+      let senderName = _mm_FormatDisplayName(MailServices.headerParser, msgHdr.mime2DecodedAuthor, &quot;from&quot;);</span>
<a href="#l10.109"></a><span id="l10.109">       let date = makeFriendlyDateAgo(new Date(msgHdr.date/1000));</span>
<a href="#l10.110"></a><span id="l10.110"> </span>
<a href="#l10.111"></a><span id="l10.111">       let msgContents = '&lt;div class=&quot;row&quot;&gt;' +</span>
<a href="#l10.112"></a><span id="l10.112">                         '  &lt;div class=&quot;star&quot;/&gt;' +</span>
<a href="#l10.113"></a><span id="l10.113">                         '  &lt;div class=&quot;header&quot;&gt;' +</span>
<a href="#l10.114"></a><span id="l10.114">                         '    &lt;div class=&quot;wrappedsender&quot;&gt;' +</span>
<a href="#l10.115"></a><span id="l10.115">                         '      &lt;div class=&quot;sender link&quot;&gt;' +</span>
<a href="#l10.116"></a><span id="l10.116">                                  _mm_escapeHTML(senderName) + '&lt;/div&gt;' +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l11.9"></a><span id="l11.9"> Components.utils.import(&quot;resource:///modules/mailViewManager.js&quot;);</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> // these constants are now authoritatively defined in mailViewManager.js (above)</span>
<a href="#l11.12"></a><span id="l11.12"> // tag views have kViewTagMarker + their key as value</span>
<a href="#l11.13"></a><span id="l11.13"> const kViewItemAll         = MailViewConstants.kViewItemAll;</span>
<a href="#l11.14"></a><span id="l11.14"> const kViewItemUnread      = MailViewConstants.kViewItemUnread;</span>
<a href="#l11.15"></a><span id="l11.15"> const kViewItemTags        = MailViewConstants.kViewItemTags; // former labels used values 2-6</span>
<a href="#l11.16"></a><span id="l11.16"> const kViewItemNotDeleted  = MailViewConstants.kViewItemNotDeleted;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineat">@@ -226,31 +227,29 @@ function RefreshCustomViewsPopup(aMenupo</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> function RefreshTagsPopup(aMenupopup)</span>
<a href="#l11.20"></a><span id="l11.20"> {</span>
<a href="#l11.21"></a><span id="l11.21">   // remove all menuitems</span>
<a href="#l11.22"></a><span id="l11.22">   while (aMenupopup.hasChildNodes())</span>
<a href="#l11.23"></a><span id="l11.23">     aMenupopup.removeChild(aMenupopup.lastChild);</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   // create tag menuitems</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  var currentTagKey = gFolderDisplay.view.mailViewIndex == kViewItemTags ?</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  let currentTagKey = gFolderDisplay.view.mailViewIndex == kViewItemTags ?</span>
<a href="#l11.28"></a><span id="l11.28">                         gFolderDisplay.view.mailViewData : &quot;&quot;;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  for (let i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l11.35"></a><span id="l11.35">   {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    var tagInfo = tagArray[i];</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    let tagInfo = tagArray[i];</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l11.40"></a><span id="l11.40">     menuitem.setAttribute(&quot;label&quot;, tagInfo.tag);</span>
<a href="#l11.41"></a><span id="l11.41">     menuitem.setAttribute(&quot;value&quot;, kViewTagMarker + tagInfo.key);</span>
<a href="#l11.42"></a><span id="l11.42">     menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l11.43"></a><span id="l11.43">     if (tagInfo.key == currentTagKey)</span>
<a href="#l11.44"></a><span id="l11.44">       menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    var color = tagInfo.color;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+    let color = tagInfo.color;</span>
<a href="#l11.47"></a><span id="l11.47">     if (color)</span>
<a href="#l11.48"></a><span id="l11.48">       menuitem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l11.49"></a><span id="l11.49">     aMenupopup.appendChild(menuitem);</span>
<a href="#l11.50"></a><span id="l11.50">   }</span>
<a href="#l11.51"></a><span id="l11.51"> }</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53"> function ViewPickerOnLoad()</span>
<a href="#l11.54"></a><span id="l11.54"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -33,19 +33,17 @@ var setupModule = function(module) {</span>
<a href="#l12.4"></a><span id="l12.4">   archiveSrcFolder = create_folder(&quot;ArchiveSrc&quot;);</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">   make_new_sets_in_folder(unreadFolder, [{count: 2}]);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   // Create messages from 20 different months, which will mean 2 different</span>
<a href="#l12.9"></a><span id="l12.9">   // years as well.</span>
<a href="#l12.10"></a><span id="l12.10">   make_new_sets_in_folder(archiveSrcFolder, [{count: 20, age_incr: {weeks: 5}}]);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  let tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  tagArray = tagService.getAllTags({});</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l12.16"></a><span id="l12.16"> };</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> /**</span>
<a href="#l12.19"></a><span id="l12.19">  * Ensures that all messages have a particular read status</span>
<a href="#l12.20"></a><span id="l12.20">  * @param messages an array of nsIMsgDBHdrs to check</span>
<a href="#l12.21"></a><span id="l12.21">  * @param read true if the messages should be marked read, false otherwise</span>
<a href="#l12.22"></a><span id="l12.22">  */</span>
<a href="#l12.23"></a><span id="l12.23"> function check_read_status(messages, read) {</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -261,21 +259,18 @@ function test_yearly_archive() {</span>
<a href="#l12.25"></a><span id="l12.25">   yearly_archive(false);</span>
<a href="#l12.26"></a><span id="l12.26"> }</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28"> function yearly_archive(keep_structure) {</span>
<a href="#l12.29"></a><span id="l12.29">   be_in_folder(archiveSrcFolder);</span>
<a href="#l12.30"></a><span id="l12.30">   make_display_unthreaded();</span>
<a href="#l12.31"></a><span id="l12.31">   mc.folderDisplay.view.sort(Ci.nsMsgViewSortType.byDate, Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-              .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  let identity = acctMgr.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-                                                   .getMsgHdrAt(0).folder.server);</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  let identity = MailServices.accounts.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+                                                                 .getMsgHdrAt(0).folder.server);</span>
<a href="#l12.40"></a><span id="l12.40">   identity.archiveGranularity = Ci.nsIMsgIdentity.perYearArchiveFolders;</span>
<a href="#l12.41"></a><span id="l12.41">   // We need to get all the info about the messages before we do the archive,</span>
<a href="#l12.42"></a><span id="l12.42">   // because deleting the headers could make extracting values from them fail.</span>
<a href="#l12.43"></a><span id="l12.43">   let firstMsgHdr = mc.folderDisplay.view.dbView.getMsgHdrAt(0);</span>
<a href="#l12.44"></a><span id="l12.44">   let lastMsgHdr = mc.folderDisplay.view.dbView.getMsgHdrAt(12);</span>
<a href="#l12.45"></a><span id="l12.45">   let firstMsgHdrMsgId = firstMsgHdr.messageId;</span>
<a href="#l12.46"></a><span id="l12.46">   let lastMsgHdrMsgId = lastMsgHdr.messageId;</span>
<a href="#l12.47"></a><span id="l12.47">   let firstMsgDate = new Date(firstMsgHdr.date / 1000);</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineat">@@ -310,18 +305,18 @@ function yearly_archive(keep_structure) </span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50"> function test_monthly_archive() {</span>
<a href="#l12.51"></a><span id="l12.51">   enable_archiving(true);</span>
<a href="#l12.52"></a><span id="l12.52">   monthly_archive(false);</span>
<a href="#l12.53"></a><span id="l12.53"> }</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55"> function monthly_archive(keep_structure) {</span>
<a href="#l12.56"></a><span id="l12.56">   be_in_folder(archiveSrcFolder);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-  let identity = acctMgr.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-                                                   .getMsgHdrAt(0).folder.server);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  let identity = MailServices.accounts.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+                                                                 .getMsgHdrAt(0).folder.server);</span>
<a href="#l12.61"></a><span id="l12.61">   identity.archiveGranularity = Ci.nsIMsgIdentity.perMonthArchiveFolders;</span>
<a href="#l12.62"></a><span id="l12.62">   select_click_row(0);</span>
<a href="#l12.63"></a><span id="l12.63">   select_control_click_row(1);</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">   let firstMsgHdr = mc.folderDisplay.view.dbView.getMsgHdrAt(0);</span>
<a href="#l12.66"></a><span id="l12.66">   let lastMsgHdr = mc.folderDisplay.view.dbView.getMsgHdrAt(1);</span>
<a href="#l12.67"></a><span id="l12.67">   let firstMsgHdrMsgId = firstMsgHdr.messageId;</span>
<a href="#l12.68"></a><span id="l12.68">   let lastMsgHdrMsgId = lastMsgHdr.messageId;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineat">@@ -362,18 +357,18 @@ function test_folder_structure_archiving</span>
<a href="#l12.70"></a><span id="l12.70">   Services.prefs.setBoolPref(&quot;mail.identity.default.archive_keep_folder_structure&quot;, true);</span>
<a href="#l12.71"></a><span id="l12.71">   monthly_archive(true);</span>
<a href="#l12.72"></a><span id="l12.72">   yearly_archive(true);</span>
<a href="#l12.73"></a><span id="l12.73"> }</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75"> function test_selection_after_archive() {</span>
<a href="#l12.76"></a><span id="l12.76">   enable_archiving(true);</span>
<a href="#l12.77"></a><span id="l12.77">   be_in_folder(archiveSrcFolder);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  let identity = acctMgr.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-                                                   .getMsgHdrAt(0).folder.server);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  let identity = MailServices.accounts.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+                                                                 .getMsgHdrAt(0).folder.server);</span>
<a href="#l12.82"></a><span id="l12.82">   identity.archiveGranularity = Ci.nsIMsgIdentity.perMonthArchiveFolders;</span>
<a href="#l12.83"></a><span id="l12.83">   // We had a bug where we would always select the 0th message after an</span>
<a href="#l12.84"></a><span id="l12.84">   // archive, so test that we'll actually select the next remaining message</span>
<a href="#l12.85"></a><span id="l12.85">   // by archiving rows 1 &amp; 2 and verifying that the 3rd message gets selected.</span>
<a href="#l12.86"></a><span id="l12.86">   let hdrToSelect = select_click_row(3);</span>
<a href="#l12.87"></a><span id="l12.87">   select_click_row(1);</span>
<a href="#l12.88"></a><span id="l12.88">   select_control_click_row(2);</span>
<a href="#l12.89"></a><span id="l12.89">   archive_selected_messages();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -303,22 +303,20 @@ function test_summary_when_multiple_iden</span>
<a href="#l13.4"></a><span id="l13.4">   be_in_folder(folderVirtual);</span>
<a href="#l13.5"></a><span id="l13.5">   select_shift_click_row(1);</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">   assert_summary_contains_N_divs('author', 2);</span>
<a href="#l13.8"></a><span id="l13.8"> }</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> function extract_first_address(thread)</span>
<a href="#l13.11"></a><span id="l13.11"> {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  let headerParser = Cc[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                       .getService(Ci.nsIMsgHeaderParser);</span>
<a href="#l13.14"></a><span id="l13.14">   let addresses = {};</span>
<a href="#l13.15"></a><span id="l13.15">   let fullNames = {};</span>
<a href="#l13.16"></a><span id="l13.16">   let names = {};</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  let numAddresses = headerParser.parseHeadersWithArray(</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  let numAddresses = MailServices.headerParser.parseHeadersWithArray(</span>
<a href="#l13.19"></a><span id="l13.19">     thread1.getMsgHdr(0).mime2DecodedAuthor,</span>
<a href="#l13.20"></a><span id="l13.20">     addresses, names, fullNames);</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">   return {email: addresses.value[0], name: names.value[0]};</span>
<a href="#l13.23"></a><span id="l13.23"> }</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> function check_address_name(name) {</span>
<a href="#l13.26"></a><span id="l13.26">   let htmlframe = mc.e('multimessage');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -24,19 +24,17 @@ function setupModule(module) {</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> // Provided by the extension in test-extension</span>
<a href="#l14.6"></a><span id="l14.6"> const kTestModeID = &quot;testmode&quot;;</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> /**</span>
<a href="#l14.9"></a><span id="l14.9">  * Switch to the mode and verify that it displays correctly.</span>
<a href="#l14.10"></a><span id="l14.10">  */</span>
<a href="#l14.11"></a><span id="l14.11"> function test_switch_to_test_mode() {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-  let server = acctMgr.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l14.16"></a><span id="l14.16">   folder = server.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18">   mc.folderTreeView.mode = kTestModeID;</span>
<a href="#l14.19"></a><span id="l14.19">   assert_folder_mode(kTestModeID);</span>
<a href="#l14.20"></a><span id="l14.20">   assert_folder_visible(folder);</span>
<a href="#l14.21"></a><span id="l14.21"> }</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-extension/chrome/content/overlay.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,22 +1,20 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> (function () {</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+   Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l15.11"></a><span id="l15.11">    var testFolderTreeMode = {</span>
<a href="#l15.12"></a><span id="l15.12">      __proto__: IFolderTreeMode,</span>
<a href="#l15.13"></a><span id="l15.13">      generateMap: function testFolderTreeMode_generateMap(aFTV) {</span>
<a href="#l15.14"></a><span id="l15.14">        // Pick the tinderbox@foo.invalid inbox and use it as the only folder</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-       let acctMgr =</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-         Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-           .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-       let server = acctMgr.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+       let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l15.20"></a><span id="l15.20">        let item = new ftvItem(server.rootFolder.getChildNamed(&quot;Inbox&quot;));</span>
<a href="#l15.21"></a><span id="l15.21">        item.__defineGetter__(&quot;children&quot;, function () []);</span>
<a href="#l15.22"></a><span id="l15.22">        return [item];</span>
<a href="#l15.23"></a><span id="l15.23">      },</span>
<a href="#l15.24"></a><span id="l15.24">    };</span>
<a href="#l15.25"></a><span id="l15.25">    gFolderTreeView.registerFolderTreeMode(&quot;testmode&quot;, testFolderTreeMode,</span>
<a href="#l15.26"></a><span id="l15.26">                                           &quot;Test Mode&quot;);</span>
<a href="#l15.27"></a><span id="l15.27"> })();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -10,52 +10,49 @@ var MODULE_NAME = &quot;test-display-names&quot;;</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l16.6"></a><span id="l16.6"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> var folder;</span>
<a href="#l16.11"></a><span id="l16.11"> var decoyFolder;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-var acctMgr;</span>
<a href="#l16.13"></a><span id="l16.13"> var localAccount;</span>
<a href="#l16.14"></a><span id="l16.14"> var secondIdentity;</span>
<a href="#l16.15"></a><span id="l16.15"> var myEmail = &quot;sender@nul.invalid&quot;; // Dictated by messagerInjector.js</span>
<a href="#l16.16"></a><span id="l16.16"> var friendEmail = &quot;carl@sagan.invalid&quot;;</span>
<a href="#l16.17"></a><span id="l16.17"> var friendName = &quot;Carl Sagan&quot;;</span>
<a href="#l16.18"></a><span id="l16.18"> var headertoFieldMe;</span>
<a href="#l16.19"></a><span id="l16.19"> var collectedAddresses;</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> function setupModule(module) {</span>
<a href="#l16.22"></a><span id="l16.22">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l16.23"></a><span id="l16.23">   fdh.installInto(module);</span>
<a href="#l16.24"></a><span id="l16.24">   let abh = collector.getModule(&quot;address-book-helpers&quot;);</span>
<a href="#l16.25"></a><span id="l16.25">   abh.installInto(module);</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-  acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-              .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-  localAccount = acctMgr.FindAccountForServer(acctMgr.localFoldersServer);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  localAccount = MailServices.accounts.FindAccountForServer(MailServices.accounts.localFoldersServer);</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32">   // We need to make sure we have only one identity:</span>
<a href="#l16.33"></a><span id="l16.33">   // 1) Delete all accounts except for Local Folders</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  for (let i = acctMgr.accounts.length - 1; i &gt;= 0; i--) {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-    let account = acctMgr.accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  for (let i = MailServices.accounts.accounts.length - 1; i &gt;= 0; i--) {</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+    let account = MailServices.accounts.accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l16.38"></a><span id="l16.38">     if (account != localAccount)</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-      acctMgr.removeAccount(account);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+      MailServices.accounts.removeAccount(account);</span>
<a href="#l16.41"></a><span id="l16.41">   }</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43">   // 2) Delete all identities except for one</span>
<a href="#l16.44"></a><span id="l16.44">   for (let i = localAccount.identities.length - 1; i &gt;= 0; i--) {</span>
<a href="#l16.45"></a><span id="l16.45">     let identity = localAccount.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l16.46"></a><span id="l16.46">     if (identity.email != myEmail)</span>
<a href="#l16.47"></a><span id="l16.47">       localAccount.removeIdentity(identity);</span>
<a href="#l16.48"></a><span id="l16.48">   }</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50">   // 3) Create a second identity and hold onto it for later</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  secondIdentity = acctMgr.createIdentity();</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  secondIdentity = MailServices.accounts.createIdentity();</span>
<a href="#l16.53"></a><span id="l16.53">   secondIdentity.email = &quot;nobody@nowhere.invalid&quot;;</span>
<a href="#l16.54"></a><span id="l16.54"> </span>
<a href="#l16.55"></a><span id="l16.55">   folder = create_folder(&quot;DisplayNamesA&quot;);</span>
<a href="#l16.56"></a><span id="l16.56">   decoyFolder = create_folder(&quot;DisplayNamesB&quot;);</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58">   add_message_to_folder(folder, create_message({to: [[&quot;&quot;, myEmail]] }));</span>
<a href="#l16.59"></a><span id="l16.59">   add_message_to_folder(folder, create_message({from: [&quot;&quot;, friendEmail] }));</span>
<a href="#l16.60"></a><span id="l16.60">   add_message_to_folder(folder, create_message({from: [friendName, friendEmail] }));</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineat">@@ -68,25 +65,25 @@ function setupModule(module) {</span>
<a href="#l16.62"></a><span id="l16.62">   let bundle = Services.strings.createBundle(</span>
<a href="#l16.63"></a><span id="l16.63">                    &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l16.64"></a><span id="l16.64">   headertoFieldMe = bundle.GetStringFromName(&quot;headertoFieldMe&quot;);</span>
<a href="#l16.65"></a><span id="l16.65"> }</span>
<a href="#l16.66"></a><span id="l16.66"> </span>
<a href="#l16.67"></a><span id="l16.67"> function ensure_single_identity() {</span>
<a href="#l16.68"></a><span id="l16.68">   if (localAccount.identities.length &gt; 1)</span>
<a href="#l16.69"></a><span id="l16.69">     localAccount.removeIdentity(secondIdentity);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-  assert_true(acctMgr.allIdentities.length == 1,</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-              &quot;Expected 1 identity, but got &quot; + acctMgr.allIdentities.length +</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  assert_true(MailServices.accounts.allIdentities.length == 1,</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+              &quot;Expected 1 identity, but got &quot; + MailServices.accounts.allIdentities.length +</span>
<a href="#l16.74"></a><span id="l16.74">               &quot; identities&quot;);</span>
<a href="#l16.75"></a><span id="l16.75"> }</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77"> function ensure_multiple_identities() {</span>
<a href="#l16.78"></a><span id="l16.78">   if (localAccount.identities.length == 1)</span>
<a href="#l16.79"></a><span id="l16.79">     localAccount.addIdentity(secondIdentity);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-  assert_true(acctMgr.allIdentities.length &gt; 1,</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  assert_true(MailServices.accounts.allIdentities.length &gt; 1,</span>
<a href="#l16.82"></a><span id="l16.82">               &quot;Expected multiple identities, but got only one identity&quot;);</span>
<a href="#l16.83"></a><span id="l16.83"> }</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85"> function help_test_display_name(message, field, expectedValue) {</span>
<a href="#l16.86"></a><span id="l16.86">   // Switch to a decoy folder first to ensure that we refresh the message we're</span>
<a href="#l16.87"></a><span id="l16.87">   // looking at in order to update information changed in address book entries.</span>
<a href="#l16.88"></a><span id="l16.88">   be_in_folder(decoyFolder);</span>
<a href="#l16.89"></a><span id="l16.89">   be_in_folder(folder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -25,18 +25,19 @@ Cu.import(&quot;resource:///modules/gloda/log</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> const MODULE_NAME = 'folder-display-helpers';</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l17.8"></a><span id="l17.8"> // we need window-helpers for augment_controller</span>
<a href="#l17.9"></a><span id="l17.9"> const MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> const nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+Cu.import('resource:///modules/MailConsts.js');</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l17.14"></a><span id="l17.14"> Cu.import('resource:///modules/MailUtils.js');</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-Cu.import('resource:///modules/MailConsts.js');</span>
<a href="#l17.16"></a><span id="l17.16"> Cu.import('resource:///modules/mailViewManager.js');</span>
<a href="#l17.17"></a><span id="l17.17"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> const FILE_LOAD_PATHS = [</span>
<a href="#l17.20"></a><span id="l17.20">   &quot;../resources&quot;,</span>
<a href="#l17.21"></a><span id="l17.21">   &quot;../../../../mailnews/test/resources&quot;,</span>
<a href="#l17.22"></a><span id="l17.22">   &quot;../../../../mail/base/test/unit/resources&quot;,</span>
<a href="#l17.23"></a><span id="l17.23">   &quot;../../../../mailnews/test/fakeserver&quot;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineat">@@ -1330,19 +1331,17 @@ function middle_click_on_folder(aFolder)</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> /**</span>
<a href="#l17.27"></a><span id="l17.27">  * Get a reference to the smart folder with the given name.</span>
<a href="#l17.28"></a><span id="l17.28">  *</span>
<a href="#l17.29"></a><span id="l17.29">  * @param aFolderName The name of the smart folder (e.g. &quot;Inbox&quot;).</span>
<a href="#l17.30"></a><span id="l17.30">  * @returns An nsIMsgFolder representing the smart folder with the given name.</span>
<a href="#l17.31"></a><span id="l17.31">  */</span>
<a href="#l17.32"></a><span id="l17.32"> function get_smart_folder_named(aFolderName) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-  let smartServer = acctMgr.FindServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  let smartServer = MailServices.accounts.FindServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l17.37"></a><span id="l17.37">   return smartServer.rootFolder.getChildNamed(aFolderName);</span>
<a href="#l17.38"></a><span id="l17.38"> }</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40"> /**</span>
<a href="#l17.41"></a><span id="l17.41">  * Assuming the context popup is popped-up (via right_click_on_row), select</span>
<a href="#l17.42"></a><span id="l17.42">  *  the deletion option.  If the popup is not popped up, you are out of luck.</span>
<a href="#l17.43"></a><span id="l17.43">  */</span>
<a href="#l17.44"></a><span id="l17.44"> function delete_via_popup() {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineat">@@ -1628,21 +1627,18 @@ function wait_for_blank_content_pane(aCo</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48"> var FolderListener = {</span>
<a href="#l17.49"></a><span id="l17.49">   _inited: false,</span>
<a href="#l17.50"></a><span id="l17.50">   ensureInited: function() {</span>
<a href="#l17.51"></a><span id="l17.51">     if (this._inited)</span>
<a href="#l17.52"></a><span id="l17.52">       return;</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-    let mailSession =</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-      Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-    mailSession.AddFolderListener(this,</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-                                  Ci.nsIFolderListener.event);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+    MailServices.mailSession.AddFolderListener(this,</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+                                               Ci.nsIFolderListener.event);</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62">     this._inited = true;</span>
<a href="#l17.63"></a><span id="l17.63">   },</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65">   sawEvents: false,</span>
<a href="#l17.66"></a><span id="l17.66">   watchingFor: null,</span>
<a href="#l17.67"></a><span id="l17.67">   planToWaitFor: function FolderListener_planToWaitFor() {</span>
<a href="#l17.68"></a><span id="l17.68">     this.sawEvents = false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/test/unit/test_compactColumnSave.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_compactColumnSave.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -19,30 +19,29 @@</span>
<a href="#l18.4"></a><span id="l18.4">   *   Remove one message</span>
<a href="#l18.5"></a><span id="l18.5">   *   Compact folder2</span>
<a href="#l18.6"></a><span id="l18.6">   *   Close folder2</span>
<a href="#l18.7"></a><span id="l18.7">   *   Reopen folder2</span>
<a href="#l18.8"></a><span id="l18.8">   *   Check whether custom column headings are still there</span>
<a href="#l18.9"></a><span id="l18.9">   *</span>
<a href="#l18.10"></a><span id="l18.10">   */</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l18.15"></a><span id="l18.15">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> // Globals</span>
<a href="#l18.18"></a><span id="l18.18"> var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l18.19"></a><span id="l18.19"> var gLocalFolder2;</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> var gCurTestNum;</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> var gMsgHdrs = new Array();</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-</span>
<a href="#l18.28"></a><span id="l18.28"> const PERSISTED_COLUMN_PROPERTY_NAME = &quot;columnStates&quot;;</span>
<a href="#l18.29"></a><span id="l18.29"> const columnJSON = '{&quot;threadCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;1&quot;},&quot;flaggedCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;4&quot;},&quot;attachmentCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;5&quot;},&quot;subjectCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;7&quot;},&quot;unreadButtonColHeader&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;9&quot;},&quot;senderCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;11&quot;},&quot;recipientCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;13&quot;},&quot;junkStatusCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;15&quot;},&quot;receivedCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;17&quot;},&quot;dateCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;19&quot;},&quot;statusCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;21&quot;},&quot;sizeCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;23&quot;},&quot;tagsCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;25&quot;},&quot;accountCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;27&quot;},&quot;priorityCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;29&quot;},&quot;unreadCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;31&quot;},&quot;totalCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;33&quot;},&quot;locationCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;35&quot;},&quot;idCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;37&quot;}}';</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31"> function setColumnStates(folder) {</span>
<a href="#l18.32"></a><span id="l18.32">   let msgDatabase = folder.msgDatabase;</span>
<a href="#l18.33"></a><span id="l18.33">   let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l18.34"></a><span id="l18.34">   dbFolderInfo.setCharProperty(this.PERSISTED_COLUMN_PROPERTY_NAME, columnJSON);</span>
<a href="#l18.35"></a><span id="l18.35">   msgDatabase.Commit(Components.interfaces.nsMsgDBCommitType.kLargeCommit);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineat">@@ -97,17 +96,17 @@ var urlListener =</span>
<a href="#l18.37"></a><span id="l18.37">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l18.38"></a><span id="l18.38">     // to return</span>
<a href="#l18.39"></a><span id="l18.39">     do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l18.40"></a><span id="l18.40">   }</span>
<a href="#l18.41"></a><span id="l18.41"> };</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43"> function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l18.44"></a><span id="l18.44"> {</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l18.47"></a><span id="l18.47"> }</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49"> function deleteMessages(srcFolder, items)</span>
<a href="#l18.50"></a><span id="l18.50"> {</span>
<a href="#l18.51"></a><span id="l18.51">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l18.52"></a><span id="l18.52">   items.forEach(function (item) {</span>
<a href="#l18.53"></a><span id="l18.53">     array.appendElement(item, false);</span>
<a href="#l18.54"></a><span id="l18.54">   });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/test/unit/test_emptyTrash.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_emptyTrash.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -11,29 +11,27 @@</span>
<a href="#l19.4"></a><span id="l19.4">   *</span>
<a href="#l19.5"></a><span id="l19.5">   * Currently tested:</span>
<a href="#l19.6"></a><span id="l19.6">   * - Empty local trash</span>
<a href="#l19.7"></a><span id="l19.7">   * TODO</span>
<a href="#l19.8"></a><span id="l19.8">   * - Empty imap trash</span>
<a href="#l19.9"></a><span id="l19.9">   */</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> // Globals</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14"> var gMsgFile1;</span>
<a href="#l19.15"></a><span id="l19.15"> var gLocalTrashFolder;</span>
<a href="#l19.16"></a><span id="l19.16"> var gCurTestNum;</span>
<a href="#l19.17"></a><span id="l19.17"> var gMsgHdrs = new Array();</span>
<a href="#l19.18"></a><span id="l19.18"> var gRootFolder;</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-const mFNSContractID = &quot;@mozilla.org/messenger/msgnotificationservice;1&quot;;</span>
<a href="#l19.21"></a><span id="l19.21"> const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l19.22"></a><span id="l19.22"> const nsIMFListener = Ci.nsIMsgFolderListener;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-</span>
<a href="#l19.27"></a><span id="l19.27"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l19.28"></a><span id="l19.28"> var copyListener = </span>
<a href="#l19.29"></a><span id="l19.29"> {</span>
<a href="#l19.30"></a><span id="l19.30">   OnStartCopy: function() {},</span>
<a href="#l19.31"></a><span id="l19.31">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l19.32"></a><span id="l19.32">   SetMessageKey: function(aKey)</span>
<a href="#l19.33"></a><span id="l19.33">   {</span>
<a href="#l19.34"></a><span id="l19.34">     let hdr = gLocalInboxFolder.GetMessageHeader(aKey);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineat">@@ -64,17 +62,17 @@ var urlListener =</span>
<a href="#l19.36"></a><span id="l19.36">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l19.37"></a><span id="l19.37">     // to return</span>
<a href="#l19.38"></a><span id="l19.38">     do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l19.39"></a><span id="l19.39">   }</span>
<a href="#l19.40"></a><span id="l19.40"> };</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42"> function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l19.43"></a><span id="l19.43"> {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l19.46"></a><span id="l19.46"> }</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48"> function deleteMessages(srcFolder, items)</span>
<a href="#l19.49"></a><span id="l19.49"> {</span>
<a href="#l19.50"></a><span id="l19.50">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l19.51"></a><span id="l19.51">   items.forEach(function (item) {</span>
<a href="#l19.52"></a><span id="l19.52">     array.appendElement(item, false);</span>
<a href="#l19.53"></a><span id="l19.53">   });</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineat">@@ -116,18 +114,16 @@ const gTestArray =</span>
<a href="#l19.55"></a><span id="l19.55">     do_check_eq(0, gLocalTrashFolder.filePath.fileSize);</span>
<a href="#l19.56"></a><span id="l19.56">     do_check_eq(0, gLocalTrashFolder.msgDatabase.dBFolderInfo.numMessages);</span>
<a href="#l19.57"></a><span id="l19.57">     let enumerator = gLocalTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l19.58"></a><span id="l19.58">     do_check_eq(false, enumerator.hasMoreElements());</span>
<a href="#l19.59"></a><span id="l19.59">     urlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l19.60"></a><span id="l19.60">   }</span>
<a href="#l19.61"></a><span id="l19.61"> ];</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-var gMFNService = Cc[mFNSContractID].getService(nsIMFNService);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-</span>
<a href="#l19.65"></a><span id="l19.65"> // Our listener, which captures events.</span>
<a href="#l19.66"></a><span id="l19.66"> function gMFListener() {}</span>
<a href="#l19.67"></a><span id="l19.67"> gMFListener.prototype =</span>
<a href="#l19.68"></a><span id="l19.68"> {</span>
<a href="#l19.69"></a><span id="l19.69">   folderDeleted: function (aFolder)</span>
<a href="#l19.70"></a><span id="l19.70">   {</span>
<a href="#l19.71"></a><span id="l19.71">     aFolder.msgDatabase = null;</span>
<a href="#l19.72"></a><span id="l19.72">   },</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineat">@@ -136,17 +132,17 @@ gMFListener.prototype =</span>
<a href="#l19.74"></a><span id="l19.74"> function run_test()</span>
<a href="#l19.75"></a><span id="l19.75"> {</span>
<a href="#l19.76"></a><span id="l19.76">   loadLocalMailAccount();</span>
<a href="#l19.77"></a><span id="l19.77">   // Load up a message so that we can copy it in later.</span>
<a href="#l19.78"></a><span id="l19.78">   gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l19.79"></a><span id="l19.79">   // our front end code clears the msg db when it gets told the folder for</span>
<a href="#l19.80"></a><span id="l19.80">   // an open view has been deleted - so simulate that.</span>
<a href="#l19.81"></a><span id="l19.81">   var folderDeletedListener = new gMFListener();</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  gMFNService.addListener(folderDeletedListener, nsIMFNService.folderDeleted);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  MailServices.mfn.addListener(folderDeletedListener, nsIMFNService.folderDeleted);</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of all the operations.</span>
<a href="#l19.86"></a><span id="l19.86">   do_test_pending();</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88">   // Do the test.</span>
<a href="#l19.89"></a><span id="l19.89">   doTest(1);</span>
<a href="#l19.90"></a><span id="l19.90"> }</span>
<a href="#l19.91"></a><span id="l19.91"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

