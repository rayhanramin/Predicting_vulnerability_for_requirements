<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17419:f792bb59b8e582a65272d1fe29a45ba11ae8bb16</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f792bb59b8e582a65272d1fe29a45ba11ae8bb16" />
<meta property="og:url" content="/comm-central/rev/f792bb59b8e582a65272d1fe29a45ba11ae8bb16" />
<meta property="og:description" content="Bug 1113275 get imap tests working with maildir, part 2 test cleanup, r=sshhagarwal" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f792bb59b8e582a65272d1fe29a45ba11ae8bb16 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f792bb59b8e582a65272d1fe29a45ba11ae8bb16">shortlog</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f792bb59b8e582a65272d1fe29a45ba11ae8bb16">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16">files</a> |
changeset |
<a href="/comm-central/raw-rev/f792bb59b8e582a65272d1fe29a45ba11ae8bb16">raw</a>  | <a href="/comm-central/archive/f792bb59b8e582a65272d1fe29a45ba11ae8bb16.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1113275">Bug 1113275</a> get imap tests working with maildir, part 2 test cleanup, r=sshhagarwal
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#32;&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 28 Jan 2015 15:22:59 -0800</td></tr>

<tr>
 <td>changeset 17419</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f792bb59b8e582a65272d1fe29a45ba11ae8bb16">f792bb59b8e582a65272d1fe29a45ba11ae8bb16</a></td>
</tr>



<tr>
<td>parent 17418</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6e9559ab36ee9ffe54e07710a09e50e7eb5482e2">6e9559ab36ee9ffe54e07710a09e50e7eb5482e2</a>
</td>
</tr>

<tr>
<td>child 17420</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1f549a4e935186023fabf892f2098ad1d457f078">1f549a4e935186023fabf892f2098ad1d457f078</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f792bb59b8e582a65272d1fe29a45ba11ae8bb16">10732</a></td></tr>
<tr><td>push user</td><td>kent@caspia.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 28 Jan 2015 23:23:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1f549a4e9351 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1f549a4e935186023fabf892f2098ad1d457f078">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1f549a4e935186023fabf892f2098ad1d457f078&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f549a4e935186023fabf892f2098ad1d457f078&newProject=comm-central&newRevision=f792bb59b8e582a65272d1fe29a45ba11ae8bb16&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f549a4e935186023fabf892f2098ad1d457f078&newProject=comm-central&newRevision=f792bb59b8e582a65272d1fe29a45ba11ae8bb16&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f549a4e935186023fabf892f2098ad1d457f078&newProject=comm-central&newRevision=f792bb59b8e582a65272d1fe29a45ba11ae8bb16&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28sshhagarwal%29&revcount=50">sshhagarwal</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1113275">1113275</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1113275">Bug 1113275</a> get imap tests working with maildir, part 2 test cleanup, r=sshhagarwal</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_imapPump.js">mailnews/base/test/unit/test_imapPump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_imapPump.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_imapPump.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_imapPump.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_imapPump.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_imapPump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_searchChaining.js">mailnews/base/test/unit/test_searchChaining.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_searchChaining.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_searchChaining.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_searchChaining.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_searchChaining.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/base/test/unit/test_searchChaining.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/head_server.js">mailnews/imap/test/unit/head_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/head_server.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/head_server.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/head_server.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/head_server.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/head_server.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_downloadOffline.js">mailnews/imap/test/unit/test_downloadOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_downloadOffline.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_downloadOffline.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_downloadOffline.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_downloadOffline.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_downloadOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_filterNeedsBody.js">mailnews/imap/test/unit/test_filterNeedsBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_filterNeedsBody.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_filterNeedsBody.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_filterNeedsBody.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_filterNeedsBody.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_filterNeedsBody.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActions.js">mailnews/imap/test/unit/test_imapFilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActions.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActions.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActions.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActions.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapMove.js">mailnews/imap/test/unit/test_imapMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapMove.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapMove.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapMove.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapMove.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_imapMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlineCopy.js">mailnews/imap/test/unit/test_offlineCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlineCopy.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlineCopy.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlineCopy.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlineCopy.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlineCopy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlinePlayback.js">mailnews/imap/test/unit/test_offlinePlayback.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlinePlayback.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlinePlayback.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlinePlayback.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlinePlayback.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_offlinePlayback.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_subfolderLocation.js">mailnews/imap/test/unit/test_subfolderLocation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_subfolderLocation.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_subfolderLocation.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_subfolderLocation.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_subfolderLocation.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/test_subfolderLocation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/xpcshell.ini">mailnews/imap/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/imap/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/PromiseTestUtils.jsm">mailnews/test/resources/PromiseTestUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/PromiseTestUtils.jsm">file</a> |
<a href="/comm-central/annotate/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/PromiseTestUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/PromiseTestUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/PromiseTestUtils.jsm">comparison</a> |
<a href="/comm-central/log/f792bb59b8e582a65272d1fe29a45ba11ae8bb16/mailnews/test/resources/PromiseTestUtils.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -17,43 +17,59 @@ Components.utils.import(&quot;resource://test</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> // Globals</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l1.10"></a><span id="l1.10"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-setupIMAPPump();</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14"> // Definition of tests</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // load and update a message in the imap fake server</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-add_task(function* loadImapMessage() {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-  IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-  let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-  IMAPPump.inbox.updateFolderWithListener(gDummyMsgWindow, promiseUrlListener);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-  yield promiseUrlListener.promise;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+var gTestArray = </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+[</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  // initial setup of IMAP environment</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  setupIMAPPump,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  // optionally set server parameters, here enabling debug messages</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  function serverParms() {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    if (typeof fsDebugAll == &quot;undefined&quot;)</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      Components.utils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  },</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-});</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  // the main test</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  function* loadImapMessage()</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    IMAPPump.mailbox.addMessage(</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+      new imapMessage(specForFileName(gMessage),</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+                      IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(gDummyMsgWindow, promiseUrlListener);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    yield promiseUrlListener.promise;</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-// Cleanup at end</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-add_task(teardownIMAPPump);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    Assert.ok(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  },</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  // all done</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+];</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61"> function run_test() {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  gTestArray.forEach(add_task);</span>
<a href="#l1.65"></a><span id="l1.65">   run_next_test();</span>
<a href="#l1.66"></a><span id="l1.66"> }</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68"> /*</span>
<a href="#l1.69"></a><span id="l1.69">  * helper functions</span>
<a href="#l1.70"></a><span id="l1.70">  */</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> // given a test file, return the file uri spec</span>
<a href="#l1.73"></a><span id="l1.73"> function specForFileName(aFileName) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  let file = do_get_file(gDEPTH + &quot;mailnews/data/&quot; + aFileName);</span>
<a href="#l1.76"></a><span id="l1.76">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l1.77"></a><span id="l1.77">   return msgfileuri.spec;</span>
<a href="#l1.78"></a><span id="l1.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchChaining.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchChaining.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -8,86 +8,85 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> // main test</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Components.utils.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> Components.utils.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-function run_test()</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+function *setupFolder()</span>
<a href="#l2.16"></a><span id="l2.16"> {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  setupIMAPPump(&quot;&quot;);</span>
<a href="#l2.18"></a><span id="l2.18">   // add a single message to the imap inbox.</span>
<a href="#l2.19"></a><span id="l2.19">   let messages = [];</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  let gMessageGenerator = new MessageGenerator();</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  gSynthMessage = messages[0];</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  let messageGenerator = new MessageGenerator();</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  let synthMessage = messages[0];</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   let msgURI =</span>
<a href="#l2.28"></a><span id="l2.28">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-                       btoa(gSynthMessage.toMessageString()),</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+                       btoa(synthMessage.toMessageString()),</span>
<a href="#l2.31"></a><span id="l2.31">                        null, null);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  gMessage = new imapMessage(msgURI.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  IMAPPump.mailbox.addMessage(gMessage);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  let message = new imapMessage(msgURI.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   // update folder to download header.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  IMAPPump.inbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  do_test_pending();</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  yield listener.promise;</span>
<a href="#l2.43"></a><span id="l2.43"> }</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-var UrlListener = </span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-{</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    // Check for ok status.</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    searchTest();</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  }</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-};</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-function searchTest()</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+function *searchTest()</span>
<a href="#l2.58"></a><span id="l2.58"> {</span>
<a href="#l2.59"></a><span id="l2.59">   // Get the IMAP inbox...</span>
<a href="#l2.60"></a><span id="l2.60">   var emptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">   let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l2.63"></a><span id="l2.63">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">   let searchTerm = searchSession.createTerm();</span>
<a href="#l2.66"></a><span id="l2.66">   searchTerm.matchAll = true;</span>
<a href="#l2.67"></a><span id="l2.67">   searchSession.appendTerm(searchTerm);</span>
<a href="#l2.68"></a><span id="l2.68">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, emptyLocal1);</span>
<a href="#l2.69"></a><span id="l2.69">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.onlineMail, IMAPPump.inbox);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  searchSession.registerListener(searchListener);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseSearchNotify(</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+                       searchSession, searchListener);</span>
<a href="#l2.73"></a><span id="l2.73">   searchSession.search(null);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  yield listener.promise;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  // After the search completes, there still seem to be active URLs, so we</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  //   have to wait before we are done and clear.</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  yield PromiseTestUtils.promiseDelay(1000);</span>
<a href="#l2.79"></a><span id="l2.79"> }</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-var numTotalMessages;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-</span>
<a href="#l2.83"></a><span id="l2.83"> // nsIMsgSearchNotify implementation</span>
<a href="#l2.84"></a><span id="l2.84"> var searchListener =</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-{ </span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+{</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  numTotalMessages: 0,</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgSearchNotify]),</span>
<a href="#l2.89"></a><span id="l2.89">   onNewSearch: function() </span>
<a href="#l2.90"></a><span id="l2.90">   {</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-    numTotalMessages = 0;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+    this.numTotalMessages = 0;</span>
<a href="#l2.93"></a><span id="l2.93">   },</span>
<a href="#l2.94"></a><span id="l2.94">   onSearchHit: function(dbHdr, folder)</span>
<a href="#l2.95"></a><span id="l2.95">   {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    numTotalMessages++;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    this.numTotalMessages++;</span>
<a href="#l2.98"></a><span id="l2.98">   },</span>
<a href="#l2.99"></a><span id="l2.99">   onSearchDone: function(status)</span>
<a href="#l2.100"></a><span id="l2.100">   { </span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    do_check_eq(numTotalMessages, 1);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+    Assert.equal(this.numTotalMessages, 1);</span>
<a href="#l2.104"></a><span id="l2.104">     return true;</span>
<a href="#l2.105"></a><span id="l2.105">   }</span>
<a href="#l2.106"></a><span id="l2.106"> };</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-function endTest()</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-{</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-  // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  // server</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-  teardownIMAPPump();</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-  do_test_finished();</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+let tests = [</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  setupIMAPPump,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+  setupFolder,</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  searchTest,</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  teardownIMAPPump</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+];</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+function run_test() {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+  tests.forEach(add_task);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+  run_next_test();</span>
<a href="#l2.124"></a><span id="l2.124"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/test/unit/head_server.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/test/unit/head_server.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -4,16 +4,17 @@ if (typeof gDEPTH == &quot;undefined&quot;)</span>
<a href="#l3.4"></a><span id="l3.4">   var gDEPTH = &quot;../../../../&quot;;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.7"></a><span id="l3.7"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> Components.utils.import(&quot;resource://testing-common/mailnews/mailTestUtils.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> Components.utils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> Components.utils.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> var Cc = Components.classes;</span>
<a href="#l3.15"></a><span id="l3.15"> var Ci = Components.interfaces;</span>
<a href="#l3.16"></a><span id="l3.16"> var Cr = Components.results;</span>
<a href="#l3.17"></a><span id="l3.17"> var CC = Components.Constructor;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> // Ensure the profile directory is set up</span>
<a href="#l3.20"></a><span id="l3.20"> do_get_profile();</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -83,8 +84,24 @@ function do_check_transaction(fromServer</span>
<a href="#l3.22"></a><span id="l3.22">     else if (components[1] == &quot;authenticate&quot;)</span>
<a href="#l3.23"></a><span id="l3.23">       realTransaction.push(components[1] + &quot; &quot; + components[2].toUpperCase());</span>
<a href="#l3.24"></a><span id="l3.24">     else</span>
<a href="#l3.25"></a><span id="l3.25">       realTransaction.push(components[1]);</span>
<a href="#l3.26"></a><span id="l3.26">   }</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">   do_check_eq(realTransaction.join(&quot;, &quot;), expected.join(&quot;, &quot;));</span>
<a href="#l3.29"></a><span id="l3.29"> }</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+/**</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * add a simple message to the IMAP pump mailbox</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ */</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+function addImapMessage()</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+{</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  let messages = [];</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  let messageGenerator = new MessageGenerator();</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+                  btoa(messages[0].toMessageString()),</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                  null, null);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+}</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,29 +1,28 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /*</span>
<a href="#l4.6"></a><span id="l4.6">  * Test to ensure that downloadAllForOffline works correctly with imap folders</span>
<a href="#l4.7"></a><span id="l4.7">  * and returns success.</span>
<a href="#l4.8"></a><span id="l4.8">  */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l4.12"></a><span id="l4.12"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> const gFileName = &quot;bug460636&quot;;</span>
<a href="#l4.15"></a><span id="l4.15"> const gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> var tests = [</span>
<a href="#l4.18"></a><span id="l4.18">   setup,</span>
<a href="#l4.19"></a><span id="l4.19">   downloadAllForOffline,</span>
<a href="#l4.20"></a><span id="l4.20">   verifyDownloaded,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  teardown</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  teardownIMAPPump</span>
<a href="#l4.23"></a><span id="l4.23"> ];</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-function setup() {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+function *setup() {</span>
<a href="#l4.27"></a><span id="l4.27">   setupIMAPPump();</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">  /*</span>
<a href="#l4.30"></a><span id="l4.30">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l4.31"></a><span id="l4.31">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l4.32"></a><span id="l4.32">    */</span>
<a href="#l4.33"></a><span id="l4.33">   let msgfileuri =</span>
<a href="#l4.34"></a><span id="l4.34">     Services.io.newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineat">@@ -36,23 +35,25 @@ function setup() {</span>
<a href="#l4.36"></a><span id="l4.36">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l4.37"></a><span id="l4.37">                                    btoa(messages[0].toMessageString()),</span>
<a href="#l4.38"></a><span id="l4.38">                                    null, null);</span>
<a href="#l4.39"></a><span id="l4.39">   let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l4.40"></a><span id="l4.40">   imapMsg.setSize(5000);</span>
<a href="#l4.41"></a><span id="l4.41">   IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l4.42"></a><span id="l4.42">   </span>
<a href="#l4.43"></a><span id="l4.43">   // ...and download for offline use.</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  yield false;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(promiseUrlListener, null);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  yield promiseUrlListener.promise;</span>
<a href="#l4.49"></a><span id="l4.49"> }</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-function downloadAllForOffline() {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  yield false;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+function *downloadAllForOffline() {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(promiseUrlListener, null);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  yield promiseUrlListener.promise;</span>
<a href="#l4.58"></a><span id="l4.58"> }</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60"> function verifyDownloaded() {</span>
<a href="#l4.61"></a><span id="l4.61">   // verify that the message headers have the offline flag set.</span>
<a href="#l4.62"></a><span id="l4.62">   let msgEnumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l4.63"></a><span id="l4.63">   let offset = {};</span>
<a href="#l4.64"></a><span id="l4.64">   let size = {};</span>
<a href="#l4.65"></a><span id="l4.65">   while (msgEnumerator.hasMoreElements()) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineat">@@ -61,15 +62,12 @@ function verifyDownloaded() {</span>
<a href="#l4.67"></a><span id="l4.67">     if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l4.68"></a><span id="l4.68">         (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l4.69"></a><span id="l4.69">       IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l4.70"></a><span id="l4.70">     else</span>
<a href="#l4.71"></a><span id="l4.71">       do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l4.72"></a><span id="l4.72">   }</span>
<a href="#l4.73"></a><span id="l4.73"> }</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-function teardown() {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  teardownIMAPPump();</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+function run_test() {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  tests.forEach(add_task);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  run_next_test();</span>
<a href="#l4.80"></a><span id="l4.80"> }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-function run_test() {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  async_run_tests(tests);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,47 +2,44 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * This file tests the needsBody attribute added to a</span>
<a href="#l5.5"></a><span id="l5.5">  *  custom filter action in bug 555051.</span>
<a href="#l5.6"></a><span id="l5.6">  *</span>
<a href="#l5.7"></a><span id="l5.7">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l5.8"></a><span id="l5.8">  * adapted from test_imapFilterActions.js</span>
<a href="#l5.9"></a><span id="l5.9">  */</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> // Globals</span>
<a href="#l5.17"></a><span id="l5.17"> var gFilter; // a message filter with a subject search</span>
<a href="#l5.18"></a><span id="l5.18"> var gAction; // current message action (reused)</span>
<a href="#l5.19"></a><span id="l5.19"> const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> // Definition of tests</span>
<a href="#l5.22"></a><span id="l5.22"> var tests = [</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  setupIMAPPump,</span>
<a href="#l5.24"></a><span id="l5.24">   setup,</span>
<a href="#l5.25"></a><span id="l5.25">   function NeedsBodyTrue() {</span>
<a href="#l5.26"></a><span id="l5.26">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l5.27"></a><span id="l5.27">     gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l5.28"></a><span id="l5.28">     actionTestOffline.needsBody = true;</span>
<a href="#l5.29"></a><span id="l5.29">     gAction.strValue = 'true';</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    runFilterAction(gFilter, gAction);</span>
<a href="#l5.31"></a><span id="l5.31">   },</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  runFilterAction,</span>
<a href="#l5.33"></a><span id="l5.33">   function NeedsBodyFalse() {</span>
<a href="#l5.34"></a><span id="l5.34">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l5.35"></a><span id="l5.35">     gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l5.36"></a><span id="l5.36">     actionTestOffline.needsBody = false;</span>
<a href="#l5.37"></a><span id="l5.37">     gAction.strValue = 'false';</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    runFilterAction(gFilter, gAction);</span>
<a href="#l5.39"></a><span id="l5.39">   },</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  teardown</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  runFilterAction,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  teardownIMAPPump</span>
<a href="#l5.43"></a><span id="l5.43"> ];</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45"> function setup() {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  setupIMAPPump();</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">   // Create a test filter.</span>
<a href="#l5.49"></a><span id="l5.49">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l5.50"></a><span id="l5.50">   gFilter = filterList.createFilter(&quot;test offline&quot;);</span>
<a href="#l5.51"></a><span id="l5.51">   let searchTerm = gFilter.createTerm();</span>
<a href="#l5.52"></a><span id="l5.52">   searchTerm.matchAll = true;</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">   gFilter.appendTerm(searchTerm);</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineat">@@ -51,67 +48,64 @@ function setup() {</span>
<a href="#l5.56"></a><span id="l5.56">   // an action that can be modified by tests</span>
<a href="#l5.57"></a><span id="l5.57">   gAction = gFilter.createAction();</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">   // add the custom actions</span>
<a href="#l5.60"></a><span id="l5.60">   MailServices.filters.addCustomAction(actionTestOffline);</span>
<a href="#l5.61"></a><span id="l5.61"> }</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> // basic preparation done for each test</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-function runFilterAction(aFilter, aAction) {</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+function *runFilterAction() {</span>
<a href="#l5.66"></a><span id="l5.66">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l5.67"></a><span id="l5.67">   while (filterList.filterCount)</span>
<a href="#l5.68"></a><span id="l5.68">     filterList.removeFilterAt(0);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  if (aFilter) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    aFilter.clearActionList();</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    if (aAction) {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-      aFilter.appendAction(aAction);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-      filterList.insertFilterAt(0, aFilter);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  if (gFilter) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    gFilter.clearActionList();</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+    if (gAction) {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+      gFilter.appendAction(gAction);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      filterList.insertFilterAt(0, gFilter);</span>
<a href="#l5.79"></a><span id="l5.79">     }</span>
<a href="#l5.80"></a><span id="l5.80">   }</span>
<a href="#l5.81"></a><span id="l5.81">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-  yield false;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-}</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-function teardown() {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  teardownIMAPPump();</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+                              IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  yield listener.promise;</span>
<a href="#l5.93"></a><span id="l5.93"> }</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95"> function run_test() {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-  async_run_tests(tests);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  tests.forEach(add_task);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  run_next_test();</span>
<a href="#l5.99"></a><span id="l5.99"> }</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101"> // custom action to test offline status</span>
<a href="#l5.102"></a><span id="l5.102"> let actionTestOffline =</span>
<a href="#l5.103"></a><span id="l5.103"> {</span>
<a href="#l5.104"></a><span id="l5.104">   id: &quot;mailnews@mozilla.org#testOffline&quot;,</span>
<a href="#l5.105"></a><span id="l5.105">   name: &quot;test if offline&quot;,</span>
<a href="#l5.106"></a><span id="l5.106">   apply: function(aMsgHdrs, aActionValue, aListener, aType, aMsgWindow)</span>
<a href="#l5.107"></a><span id="l5.107">   {</span>
<a href="#l5.108"></a><span id="l5.108">     for (var i = 0; i &lt; aMsgHdrs.length; i++)</span>
<a href="#l5.109"></a><span id="l5.109">     {</span>
<a href="#l5.110"></a><span id="l5.110">       var msgHdr = aMsgHdrs.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l5.111"></a><span id="l5.111">       let isOffline = msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-      do_check_eq(isOffline, aActionValue == 'true');</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+      Assert.equal(!!isOffline, aActionValue == 'true');</span>
<a href="#l5.114"></a><span id="l5.114">     }</span>
<a href="#l5.115"></a><span id="l5.115">   },</span>
<a href="#l5.116"></a><span id="l5.116">   isValidForType: function(type, scope) {return true;},</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118">   validateActionValue: function(value, folder, type) { return null;},</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120">   allowDuplicates: false,</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122">   needsBody: false // set during test setup</span>
<a href="#l5.123"></a><span id="l5.123"> };</span>
<a href="#l5.124"></a><span id="l5.124"> </span>
<a href="#l5.125"></a><span id="l5.125"> /*</span>
<a href="#l5.126"></a><span id="l5.126">  * helper functions</span>
<a href="#l5.127"></a><span id="l5.127">  */</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129"> // given a test file, return the file uri spec</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-{</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  let file = do_get_file(gDEPTH + &quot;mailnews/data/&quot; + aFileName);</span>
<a href="#l5.135"></a><span id="l5.135">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l5.136"></a><span id="l5.136">   return msgfileuri.spec;</span>
<a href="#l5.137"></a><span id="l5.137"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -5,35 +5,27 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * on the message database of the filters. Effects on IMAP server</span>
<a href="#l6.5"></a><span id="l6.5">  * flags, if any, are not tested.</span>
<a href="#l6.6"></a><span id="l6.6">  *</span>
<a href="#l6.7"></a><span id="l6.7">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l6.8"></a><span id="l6.8">  * adapted from test_localToImapFilter.js</span>
<a href="#l6.9"></a><span id="l6.9">  */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Task.jsm&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l6.17"></a><span id="l6.17"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l6.18"></a><span id="l6.18"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l6.19"></a><span id="l6.19"> const Is = nsMsgSearchOp.Is;</span>
<a href="#l6.20"></a><span id="l6.20"> const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l6.21"></a><span id="l6.21"> const Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l6.22"></a><span id="l6.22"> const Body = nsMsgSearchAttrib.Body;</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> // Globals</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-var gIMAPDaemon; // the imap fake server daemon</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-var gServer; // the imap fake server</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-var gIMAPIncomingServer; // nsIMsgIncomingServer for the imap server</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-var gRootFolder; // root message folder for the imap server</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-var gIMAPInbox; // imap inbox message folder</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-var gIMAPMailbox; // imap mailbox</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-var gIMAPTrashFolder; // imap trash message folder</span>
<a href="#l6.32"></a><span id="l6.32"> var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l6.33"></a><span id="l6.33"> var gLastKey; // the last message key</span>
<a href="#l6.34"></a><span id="l6.34"> var gFilter; // a message filter with a subject search</span>
<a href="#l6.35"></a><span id="l6.35"> var gAction; // current message action (reused)</span>
<a href="#l6.36"></a><span id="l6.36"> var gBodyFilter; // a message filter with a body search</span>
<a href="#l6.37"></a><span id="l6.37"> var gInboxListener; // database listener object</span>
<a href="#l6.38"></a><span id="l6.38"> var gContinueListener; // what listener is used to continue the test?</span>
<a href="#l6.39"></a><span id="l6.39"> var gHeader; // the current message db header</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineat">@@ -60,323 +52,304 @@ const kFiltersAppliedAtom = Cc[&quot;@mozilla</span>
<a href="#l6.41"></a><span id="l6.41"> const kDeleteOrMoveMsgCompleted = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l6.42"></a><span id="l6.42">                                     .getService(Ci.nsIAtomService)</span>
<a href="#l6.43"></a><span id="l6.43">                                     .getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45"> // Definition of tests. The test function name is the filter action</span>
<a href="#l6.46"></a><span id="l6.46"> // being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l6.47"></a><span id="l6.47"> // application of filters due to a body search</span>
<a href="#l6.48"></a><span id="l6.48"> const gTestArray =</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-[  // The initial tests do not result in new messages added.</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-//  function MoveToFolder() {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-//    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-//    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-//    gChecks = function checkMoveToFolder() {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-//      testCounts(false, 0, 0, 0);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-//      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-      // no net messages were added to the inbox</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-//      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-//    }</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-//    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-//    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-//    setupTest(gFilter, gAction);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-//  },</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  function MoveToFolderBody() {</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+[ </span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  setupIMAPPump,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    // optionally set server parameters, here enabling debug messages</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  //function serverParms() {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  //  IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  //},</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  setupFilters,</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  // The initial tests do not result in new messages added.</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  function *MoveToFolder() {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  },</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  // do it again, sometimes that causes multiple downloads</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  function *MoveToFolder2() {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  },</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  /**/</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  function *MoveToFolderBody() {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+    // no net messsages were added to the inbox</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+    Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  },</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  function *MoveToFolderBody2() {</span>
<a href="#l6.109"></a><span id="l6.109">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l6.110"></a><span id="l6.110">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-    gChecks = function checkMoveToFolderBody() {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-      // no net messsages were added to the inbox</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    }</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.119"></a><span id="l6.119">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+    // no net messsages were added to the inbox</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+    Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l6.127"></a><span id="l6.127">   },</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-  function MarkRead() {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  function *MarkRead() {</span>
<a href="#l6.130"></a><span id="l6.130">     gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-    gChecks = function checkMarkRead() {</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-      do_check_true(gHeader.isRead);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    }</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    Assert.ok(gHeader.isRead);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l6.141"></a><span id="l6.141">   },</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  function MarkReadBody() {</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  function *MarkReadBody() {</span>
<a href="#l6.144"></a><span id="l6.144">     gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-    gChecks = function checkMarkReadBody() {</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-      do_check_true(gHeader.isRead);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    }</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    Assert.ok(gHeader.isRead);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+    Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l6.156"></a><span id="l6.156">   },</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-  function KillThread() {</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+  function *KillThread() {</span>
<a href="#l6.159"></a><span id="l6.159">     gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    gChecks = function checkKillThread() {</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    }</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+    let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+    Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.171"></a><span id="l6.171">   },</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  function KillThreadBody() {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  function *KillThreadBody() {</span>
<a href="#l6.174"></a><span id="l6.174">     gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-    gChecks = function checkKillThread() {</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    }</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+    let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+    Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.186"></a><span id="l6.186">   },</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  function KillSubthread() {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  function *KillSubthread() {</span>
<a href="#l6.189"></a><span id="l6.189">     gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    gChecks = function checkKillSubthread() {</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    }</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+    Assert.notEqual(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.199"></a><span id="l6.199">   },</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  function KillSubthreadBody() {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+  function *KillSubthreadBody() {</span>
<a href="#l6.202"></a><span id="l6.202">     gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    gChecks = function checkKillSubthreadBody() {</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-    }</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    Assert.notEqual(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+  },</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  function *DoNothing() {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+  },</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  function *DoNothingBody() {</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.224"></a><span id="l6.224">   },</span>
<a href="#l6.225"></a><span id="l6.225">   // this tests for marking message as junk</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-  function JunkScore() {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  function *JunkScore() {</span>
<a href="#l6.228"></a><span id="l6.228">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l6.229"></a><span id="l6.229">     gAction.junkScore = 100;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    gChecks = function checkJunkScore() {</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-      // marking as junk resets new but not unread</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-    }</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+    // marking as junk resets new but not unread</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.243"></a><span id="l6.243">   },</span>
<a href="#l6.244"></a><span id="l6.244">   // this tests for marking message as junk</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-  function JunkScoreBody() {</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+  function *JunkScoreBody() {</span>
<a href="#l6.247"></a><span id="l6.247">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l6.248"></a><span id="l6.248">     gAction.junkScore = 100;</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-    gChecks = function checkJunkScoreBody() {</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-      // marking as junk resets new but not unread</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-    }</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+    // marking as junk resets new but not unread</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.262"></a><span id="l6.262">   },</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-</span>
<a href="#l6.264"></a><span id="l6.264">   // The remaining tests add new messages</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-  function MarkUnread() {</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+  function *MarkUnread() {</span>
<a href="#l6.267"></a><span id="l6.267">     gAction.type = Ci.nsMsgFilterAction.MarkUnread;</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-    gChecks = function checkMarkUnread() {</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-      do_check_true(!gHeader.isRead);</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-    }</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+    Assert.ok(!gHeader.isRead);</span>
<a href="#l6.277"></a><span id="l6.277">   },</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-  function MarkUnreadBody() {</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+  function *MarkUnreadBody() {</span>
<a href="#l6.280"></a><span id="l6.280">     gAction.type = Ci.nsMsgFilterAction.MarkUnread;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    gChecks = function checkMarkUnreadBody() {</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-      do_check_true(!gHeader.isRead);</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-    }</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    Assert.ok(!gHeader.isRead);</span>
<a href="#l6.290"></a><span id="l6.290">   },</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-  function WatchThread() {</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+  function *WatchThread() {</span>
<a href="#l6.293"></a><span id="l6.293">     gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-    gChecks = function checkWatchThread() {</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-    }</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+    let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+    Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l6.305"></a><span id="l6.305">   },</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-  function WatchThreadBody() {</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+  function *WatchThreadBody() {</span>
<a href="#l6.308"></a><span id="l6.308">     gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-    gChecks = function checkWatchThreadBody() {</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-    }</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+    let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+    Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l6.320"></a><span id="l6.320">   },</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-  function MarkFlagged() {</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+  function *MarkFlagged() {</span>
<a href="#l6.323"></a><span id="l6.323">     gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-    gChecks = function checkMarkFlagged() {</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-      do_check_true(gHeader.isFlagged);</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-    }</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+    Assert.ok(gHeader.isFlagged);</span>
<a href="#l6.333"></a><span id="l6.333">   },</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-  function MarkFlaggedBody() {</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+  function *MarkFlaggedBody() {</span>
<a href="#l6.336"></a><span id="l6.336">     gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-    gChecks = function checkMarkFlaggedBody() {</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-      do_check_true(gHeader.isFlagged);</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-    }</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+    Assert.ok(gHeader.isFlagged);</span>
<a href="#l6.346"></a><span id="l6.346">   },</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-  function ChangePriority() {</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+  function *ChangePriority() {</span>
<a href="#l6.349"></a><span id="l6.349">     gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l6.350"></a><span id="l6.350">     gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    gChecks = function checkChangePriority() {</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-    }</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+    Assert.equal(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l6.360"></a><span id="l6.360">   },</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-  function ChangePriorityBody() {</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+  function *ChangePriorityBody() {</span>
<a href="#l6.363"></a><span id="l6.363">     gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l6.364"></a><span id="l6.364">     gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-    gChecks = function checkChangePriorityBody() {</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-    }</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+    Assert.equal(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l6.374"></a><span id="l6.374">   },</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-  function Label() {</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+  function *Label() {</span>
<a href="#l6.377"></a><span id="l6.377">     gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l6.378"></a><span id="l6.378">     gAction.label = 2;</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-    gChecks = function checkLabel() {</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-      do_check_eq(2, gHeader.label);</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-    }</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+    Assert.equal(2, gHeader.label);</span>
<a href="#l6.388"></a><span id="l6.388">   },</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-  function LabelBody() {</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+  function *LabelBody() {</span>
<a href="#l6.391"></a><span id="l6.391">     gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l6.392"></a><span id="l6.392">     gAction.label = 3;</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-    gChecks = function checkLabelBody() {</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-      do_check_eq(3, gHeader.label);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-    }</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+    Assert.equal(3, gHeader.label);</span>
<a href="#l6.402"></a><span id="l6.402">   },</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-  function AddTag() {</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+  function *AddTag() {</span>
<a href="#l6.405"></a><span id="l6.405">     gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l6.406"></a><span id="l6.406">     gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-    gChecks = function checkAddTag() {</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag&quot;);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-    }</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag&quot;);</span>
<a href="#l6.416"></a><span id="l6.416">   },</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-  function AddTagBody() {</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+  function *AddTagBody() {</span>
<a href="#l6.419"></a><span id="l6.419">     gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l6.420"></a><span id="l6.420">     gAction.strValue = &quot;TheTag2&quot;;</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-    gChecks = function checkAddTagBody() {</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag2&quot;);</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-    }</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag2&quot;);</span>
<a href="#l6.430"></a><span id="l6.430">   },</span>
<a href="#l6.431"></a><span id="l6.431">   // this tests for marking message as good</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-  function JunkScoreAsGood() {</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+  function *JunkScoreAsGood() {</span>
<a href="#l6.434"></a><span id="l6.434">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l6.435"></a><span id="l6.435">     gAction.junkScore = 0;</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-    gChecks = function checkJunkScore() {</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-    }</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.447"></a><span id="l6.447">   },</span>
<a href="#l6.448"></a><span id="l6.448">   // this tests for marking message as good</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-  function JunkScoreAsGoodBody() {</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+  function *JunkScoreAsGoodBody() {</span>
<a href="#l6.451"></a><span id="l6.451">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l6.452"></a><span id="l6.452">     gAction.junkScore = 0;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-    gChecks = function checkJunkScoreBody() {</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-    }</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l6.464"></a><span id="l6.464">   },</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-  function CopyToFolder() {</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+  function *CopyToFolder() {</span>
<a href="#l6.467"></a><span id="l6.467">     gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l6.468"></a><span id="l6.468">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-    gChecks = function checkCopyToFolder() {</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-    }</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.476"></a><span id="l6.476">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+    Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.483"></a><span id="l6.483">   },</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-  function CopyToFolderBody() {</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+  function *CopyToFolderBody() {</span>
<a href="#l6.486"></a><span id="l6.486">     gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l6.487"></a><span id="l6.487">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-    gChecks = function checkCopyToFolderBody() {</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">-    }</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l6.495"></a><span id="l6.495">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-    setupTest(gBodyFilter, gAction);</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineplus">+    Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l6.502"></a><span id="l6.502">   },</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+  /**/</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+  endTest</span>
<a href="#l6.505"></a><span id="l6.505"> </span>
<a href="#l6.506"></a><span id="l6.506"> ];</span>
<a href="#l6.507"></a><span id="l6.507"> </span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-function run_test()</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-{</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-  // Add a listener.</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer(gServer.port);</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">-  if (!localAccountUtils.inboxFolder)</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-    localAccountUtils.loadLocalMailAccount();</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-  let localAccount = MailServices.accounts.createAccount();</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-  localAccount.incomingServer = localAccountUtils.incomingServer;</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-  MailServices.accounts.defaultAccount = localAccount;</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-  let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+function run_test() {</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+  //Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+  gTestArray.forEach(add_task);</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+  run_next_test();</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+}</span>
<a href="#l6.537"></a><span id="l6.537"> </span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-  Services.prefs.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-  gSubfolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+function setupFilters()</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+{</span>
<a href="#l6.551"></a><span id="l6.551"> </span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-  gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-  // these hacks are required because we've created the inbox before</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-  // running initial folder discovery, and adding the folder bails</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-  // out before we set it as verified online, so we bail out, and</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-  // then remove the INBOX folder since it's not verified.</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-// Create a non-body filter.</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineplus">+  // Create a non-body filter.</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineplus">+  let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l6.568"></a><span id="l6.568">   gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l6.569"></a><span id="l6.569">   let searchTerm = gFilter.createTerm();</span>
<a href="#l6.570"></a><span id="l6.570">   searchTerm.attrib = Subject;</span>
<a href="#l6.571"></a><span id="l6.571">   searchTerm.op = Is;</span>
<a href="#l6.572"></a><span id="l6.572">   var value = searchTerm.value;</span>
<a href="#l6.573"></a><span id="l6.573">   value.attrib = Subject;</span>
<a href="#l6.574"></a><span id="l6.574">   value.str = gMessageSubject;</span>
<a href="#l6.575"></a><span id="l6.575">   searchTerm.value = value;</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineat">@@ -396,187 +369,89 @@ function run_test()</span>
<a href="#l6.577"></a><span id="l6.577">   searchTerm.value = value;</span>
<a href="#l6.578"></a><span id="l6.578">   searchTerm.booleanAnd = false;</span>
<a href="#l6.579"></a><span id="l6.579">   gBodyFilter.appendTerm(searchTerm);</span>
<a href="#l6.580"></a><span id="l6.580">   gBodyFilter.enabled = true;</span>
<a href="#l6.581"></a><span id="l6.581"> </span>
<a href="#l6.582"></a><span id="l6.582">   // an action that can be modified by tests</span>
<a href="#l6.583"></a><span id="l6.583">   gAction = gFilter.createAction();</span>
<a href="#l6.584"></a><span id="l6.584"> </span>
<a href="#l6.585"></a><span id="l6.585" class="difflineplus">+  gSubfolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineplus">+</span>
<a href="#l6.587"></a><span id="l6.587">   MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+  gPreviousUnread = 0;</span>
<a href="#l6.589"></a><span id="l6.589"> </span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-  // all the operations.</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-  do_test_pending();</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineplus">+  // When a message body is not downloaded, and then later a filter is</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+  //   applied that requires a download of message bodies, then the previous</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineplus">+  //   bodies are downloaded - and the message filters are applied twice!</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineplus">+  //   See bug 1116228, but for now workaround by always downloading bodies.</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineplus">+  IMAPPump.incomingServer.downloadBodiesOnGetNewMail = true;</span>
<a href="#l6.598"></a><span id="l6.598"> </span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-  //start first test</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-  gCurTestNum = 1;</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-  doTest();</span>
<a href="#l6.602"></a><span id="l6.602"> }</span>
<a href="#l6.603"></a><span id="l6.603"> </span>
<a href="#l6.604"></a><span id="l6.604"> /*</span>
<a href="#l6.605"></a><span id="l6.605">  * functions used to support test setup and execution</span>
<a href="#l6.606"></a><span id="l6.606">  */</span>
<a href="#l6.607"></a><span id="l6.607"> </span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-// if the source matches the listener used to continue a test,</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-// run the test checks, and start the next test.</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-function testContinue(source)</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-{</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-  if (gContinueListener === source)</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-  {</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-    if (gContinueListener == kDeleteOrMoveMsgCompleted &amp;&amp;</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-        gAction.type == Ci.nsMsgFilterAction.MoveToFolder)</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-    {</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-      // Moves give 2 events, just use the second.</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-      gMoveCallbackCount++;</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-      if (gMoveCallbackCount != 2)</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-        return;</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-    }</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-    gCurTestNum++;</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-    do_timeout(200, doTest);</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-  }</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-}</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-</span>
<a href="#l6.627"></a><span id="l6.627"> // basic preparation done for each test</span>
<a href="#l6.628"></a><span id="l6.628"> function setupTest(aFilter, aAction)</span>
<a href="#l6.629"></a><span id="l6.629"> {</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-  if (aAction &amp;&amp;</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-      ((aAction.type == Ci.nsMsgFilterAction.CopyToFolder) ||</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-       (aAction.type == Ci.nsMsgFilterAction.MoveToFolder)))</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-    gContinueListener = kDeleteOrMoveMsgCompleted;</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-  else if (aFilter === gBodyFilter)</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-    gContinueListener = kFiltersAppliedAtom;</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-  else</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-    gContinueListener = URLListener;</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-  while (filterList.filterCount)</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-    filterList.removeFilterAt(0);</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-  if (aFilter)</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-  {</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-    aFilter.clearActionList();</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-    if (aAction) {</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-      aFilter.appendAction(aAction);</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-      filterList.insertFilterAt(0, aFilter);</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+  return Task.spawn(function* () {</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineplus">+    let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineplus">+    while (filterList.filterCount)</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineplus">+      filterList.removeFilterAt(0);</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+    if (aFilter)</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineplus">+    {</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineplus">+      aFilter.clearActionList();</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineplus">+      if (aAction) {</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineplus">+        aFilter.appendAction(aAction);</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineplus">+        filterList.insertFilterAt(0, aFilter);</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineplus">+      }</span>
<a href="#l6.658"></a><span id="l6.658">     }</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-  }</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-  if (gInboxListener)</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-    gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-  gInboxListener = new DBListener();</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-  gDbService.registerPendingListener(gIMAPInbox, gInboxListener);</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-  gMoveCallbackCount = 0;</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-}</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+    if (gInboxListener)</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+      gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l6.672"></a><span id="l6.672"> </span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-// run the next test</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-function doTest()</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-{</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-  // Run the checks, if any, from the previous test.</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-  if (gChecks)</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-    gChecks();</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-  var test = gCurTestNum;</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-  {</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineplus">+    IMAPPump.inbox.clearNewMessages();</span>
<a href="#l6.684"></a><span id="l6.684"> </span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-        {</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-          if (gCurTestNum == test)</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-            do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-        }</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-      );</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-    try {</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-    testFn();</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-    } catch(ex) {</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-      gServer.stop();</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-    }</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-  }</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-  else</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineplus">+    gInboxListener = new DBListener();</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineplus">+    gDbService.registerPendingListener(IMAPPump.inbox, gInboxListener);</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineplus">+    gMoveCallbackCount = 0;</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineplus">+    IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineplus">+                            IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+    let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineplus">+    yield promiseUrlListener.promise;</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineplus">+    yield PromiseTestUtils.promiseDelay(200);</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineplus">+  });</span>
<a href="#l6.713"></a><span id="l6.713"> }</span>
<a href="#l6.714"></a><span id="l6.714"> </span>
<a href="#l6.715"></a><span id="l6.715"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l6.716"></a><span id="l6.716"> // server</span>
<a href="#l6.717"></a><span id="l6.717"> function endTest()</span>
<a href="#l6.718"></a><span id="l6.718"> {</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l6.720"></a><span id="l6.720">   if (gInboxListener)</span>
<a href="#l6.721"></a><span id="l6.721">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineplus">+  gInboxListener = null;</span>
<a href="#l6.723"></a><span id="l6.723">   MailServices.mailSession.RemoveFolderListener(FolderListener);</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-  gRootFolder = null;</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-  gSubfolder = null;</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-  gServer.performTest();</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-  gServer.stop();</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineminus">-</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l6.738"></a><span id="l6.738"> }</span>
<a href="#l6.739"></a><span id="l6.739"> </span>
<a href="#l6.740"></a><span id="l6.740"> /*</span>
<a href="#l6.741"></a><span id="l6.741">  * listener objects</span>
<a href="#l6.742"></a><span id="l6.742">  */</span>
<a href="#l6.743"></a><span id="l6.743"> </span>
<a href="#l6.744"></a><span id="l6.744"> // nsIFolderListener implementation</span>
<a href="#l6.745"></a><span id="l6.745"> var FolderListener = {</span>
<a href="#l6.746"></a><span id="l6.746">   OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l6.747"></a><span id="l6.747">     dump(&quot;received folder event &quot; + aEvent.toString() +</span>
<a href="#l6.748"></a><span id="l6.748">          &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l6.749"></a><span id="l6.749">          &quot;\n&quot;);</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-    testContinue(aEvent);</span>
<a href="#l6.751"></a><span id="l6.751">   }</span>
<a href="#l6.752"></a><span id="l6.752"> };</span>
<a href="#l6.753"></a><span id="l6.753"> </span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-// nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">-// is completed.</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-var CopyListener =</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-{</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineminus">-  OnStartCopy: function OnStartCopy() {},</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineminus">-  OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-  SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">-  {</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">-    gLastKey = aKey;</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">-  },</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-  SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-  OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-  {</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-    // to return</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">-    testContinue(this);</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineminus">-  }</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">-};</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineminus">-</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">-var URLListener =</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">-{</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">-  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-  {</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-    testContinue(this);</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-  }</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-}</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-</span>
<a href="#l6.790"></a><span id="l6.790"> // nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l6.791"></a><span id="l6.791"> // currently used in the tests. Current role is to provide a reference</span>
<a href="#l6.792"></a><span id="l6.792"> // to the new message header (plus give some examples of using db listeners</span>
<a href="#l6.793"></a><span id="l6.793"> // in javascript).</span>
<a href="#l6.794"></a><span id="l6.794"> function DBListener()</span>
<a href="#l6.795"></a><span id="l6.795"> {</span>
<a href="#l6.796"></a><span id="l6.796">   this.counts = {};</span>
<a href="#l6.797"></a><span id="l6.797">   let counts = this.counts;</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineat">@@ -618,17 +493,17 @@ DBListener.prototype =</span>
<a href="#l6.799"></a><span id="l6.799">       this.counts.onParentChanged++;</span>
<a href="#l6.800"></a><span id="l6.800">     },</span>
<a href="#l6.801"></a><span id="l6.801"> </span>
<a href="#l6.802"></a><span id="l6.802">   onAnnouncerGoingAway:</span>
<a href="#l6.803"></a><span id="l6.803">     function onAnnouncerGoingAway(instigator)</span>
<a href="#l6.804"></a><span id="l6.804">     {</span>
<a href="#l6.805"></a><span id="l6.805">       if (gInboxListener)</span>
<a href="#l6.806"></a><span id="l6.806">         try {</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-          gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineplus">+          IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l6.809"></a><span id="l6.809">         }</span>
<a href="#l6.810"></a><span id="l6.810">         catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l6.811"></a><span id="l6.811">       this.counts.onAnnouncerGoingAway++;</span>
<a href="#l6.812"></a><span id="l6.812">     },</span>
<a href="#l6.813"></a><span id="l6.813"> </span>
<a href="#l6.814"></a><span id="l6.814">   onReadChanged:</span>
<a href="#l6.815"></a><span id="l6.815">     function onReadChanged(aInstigator)</span>
<a href="#l6.816"></a><span id="l6.816">     {</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineat">@@ -671,103 +546,68 @@ function folderCount(folder)</span>
<a href="#l6.818"></a><span id="l6.818">     dbCount++;</span>
<a href="#l6.819"></a><span id="l6.819">     let hdr = enumerator.getNext();</span>
<a href="#l6.820"></a><span id="l6.820">   }</span>
<a href="#l6.821"></a><span id="l6.821"> </span>
<a href="#l6.822"></a><span id="l6.822">   // count using the folder</span>
<a href="#l6.823"></a><span id="l6.823">   let folderCount = folder.getTotalMessages(false);</span>
<a href="#l6.824"></a><span id="l6.824"> </span>
<a href="#l6.825"></a><span id="l6.825">   // compare the two</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-  do_check_eq(dbCount, folderCount);</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineplus">+  Assert.equal(dbCount, folderCount);</span>
<a href="#l6.828"></a><span id="l6.828">   return dbCount;</span>
<a href="#l6.829"></a><span id="l6.829"> }</span>
<a href="#l6.830"></a><span id="l6.830"> </span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-// list all of the messages in a folder for debug</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-function listMessages(folder) {</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-  var msgCount = 0;</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-  dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-  while(enumerator.hasMoreElements())</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-  {</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-    msgCount++;</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-    let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineminus">-    dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineminus">-  }</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineminus">-}</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineminus">-</span>
<a href="#l6.844"></a><span id="l6.844"> // given a test file, return the file uri spec</span>
<a href="#l6.845"></a><span id="l6.845"> function specForFileName(aFileName)</span>
<a href="#l6.846"></a><span id="l6.846"> {</span>
<a href="#l6.847"></a><span id="l6.847">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l6.848"></a><span id="l6.848">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l6.849"></a><span id="l6.849">   return msgfileuri.spec;</span>
<a href="#l6.850"></a><span id="l6.850"> }</span>
<a href="#l6.851"></a><span id="l6.851"> </span>
<a href="#l6.852"></a><span id="l6.852"> // shorthand for the inbox message summary database</span>
<a href="#l6.853"></a><span id="l6.853"> function db()</span>
<a href="#l6.854"></a><span id="l6.854"> {</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-  return gIMAPInbox.msgDatabase;</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-}</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-// This function may be used in the test array to show</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-// more detailed results after a particular test.</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineminus">-function showResults() {</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-  listMessages(gIMAPInbox);</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineminus">-  if (gInboxListener)</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineminus">-    printListener(gInboxListener);</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-  gCurTestNum++;</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-  do_timeout(100, doTest);</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineplus">+  return IMAPPump.inbox.msgDatabase;</span>
<a href="#l6.867"></a><span id="l6.867"> }</span>
<a href="#l6.868"></a><span id="l6.868"> </span>
<a href="#l6.869"></a><span id="l6.869"> // static variables used in testCounts</span>
<a href="#l6.870"></a><span id="l6.870"> var gPreviousUnread = 0;</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-var gPreviousDbNew = 0;</span>
<a href="#l6.872"></a><span id="l6.872"> </span>
<a href="#l6.873"></a><span id="l6.873"> // Test various counts.</span>
<a href="#l6.874"></a><span id="l6.874"> //</span>
<a href="#l6.875"></a><span id="l6.875"> //  aHasNew:         folder hasNew flag</span>
<a href="#l6.876"></a><span id="l6.876"> //  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l6.877"></a><span id="l6.877"> //  aFolderNewDelta: change in new count for the folder</span>
<a href="#l6.878"></a><span id="l6.878"> //  aDbNewDelta:     change in new count for the database</span>
<a href="#l6.879"></a><span id="l6.879"> //</span>
<a href="#l6.880"></a><span id="l6.880"> function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l6.881"></a><span id="l6.881"> {</span>
<a href="#l6.882"></a><span id="l6.882">   try {</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-  let folderNew = gIMAPInbox.getNumNewMessages(false);</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-  let hasNew = gIMAPInbox.hasNewMessages;</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineminus">-  let unread = gIMAPInbox.getNumUnread(false);</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineplus">+  let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineplus">+  let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineplus">+  let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l6.889"></a><span id="l6.889">   let countOut = {};</span>
<a href="#l6.890"></a><span id="l6.890">   let arrayOut = {};</span>
<a href="#l6.891"></a><span id="l6.891">   db().getNewList(countOut, arrayOut);</span>
<a href="#l6.892"></a><span id="l6.892">   let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-  let folderNewFlag = gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineplus">+  let folderNewFlag = IMAPPump.inbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l6.895"></a><span id="l6.895">   dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l6.896"></a><span id="l6.896">        &quot; unread: &quot; + unread +</span>
<a href="#l6.897"></a><span id="l6.897">        &quot; folderNew: &quot; + folderNew +</span>
<a href="#l6.898"></a><span id="l6.898">        &quot; folderNewFlag: &quot; + folderNewFlag +</span>
<a href="#l6.899"></a><span id="l6.899">        &quot; dbNew: &quot; + dbNew +</span>
<a href="#l6.900"></a><span id="l6.900">        &quot; prevUnread &quot; + gPreviousUnread +</span>
<a href="#l6.901"></a><span id="l6.901">        &quot;\n&quot;);</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-  do_check_eq(aHasNew, hasNew);</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-  do_check_eq(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineplus">+  Assert.equal(aHasNew, hasNew);</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineplus">+  Assert.equal(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l6.906"></a><span id="l6.906">   gPreviousUnread = unread;</span>
<a href="#l6.907"></a><span id="l6.907">   // This seems to be reset for each folder update.</span>
<a href="#l6.908"></a><span id="l6.908">   //</span>
<a href="#l6.909"></a><span id="l6.909">   // This check seems to be failing in SeaMonkey builds, yet I can see no ill</span>
<a href="#l6.910"></a><span id="l6.910">   // effects of this in the actual program. Fixing this is complex because of</span>
<a href="#l6.911"></a><span id="l6.911">   // the messiness of new count management (see bug 507638 for a</span>
<a href="#l6.912"></a><span id="l6.912">   // refactoring proposal, and attachment 398899 on bug 514801 for one possible</span>
<a href="#l6.913"></a><span id="l6.913">   // fix to this particular test). So I am disabling this.</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-  //do_check_eq(aFolderNewDelta, folderNew);</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">-  do_check_eq(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-  gPreviousDbNew = dbNew;</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineplus">+  //Assert.equal(aFolderNewDelta, folderNew);</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineplus">+  Assert.equal(aDbNewDelta, dbNew);</span>
<a href="#l6.919"></a><span id="l6.919">   } catch (e) {dump(e);}</span>
<a href="#l6.920"></a><span id="l6.920"> }</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-// print the counts for debugging purposes in this test</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-function printListener(listener)</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-{</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-  print(&quot;DBListener counts: &quot;);</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-  for (var item in listener.counts) {</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-      dump(item + &quot;: &quot; + listener.counts[item] + &quot; &quot;);</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-  }</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-  dump(&quot;\n&quot;);</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3,44 +3,37 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l7.6"></a><span id="l7.6">  * adapted from test_imapFilterActions.js</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Task.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l7.16"></a><span id="l7.16"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l7.17"></a><span id="l7.17"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l7.18"></a><span id="l7.18"> const Is = nsMsgSearchOp.Is;</span>
<a href="#l7.19"></a><span id="l7.19"> const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l7.20"></a><span id="l7.20"> const Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l7.21"></a><span id="l7.21"> const Body = nsMsgSearchAttrib.Body;</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-setupIMAPPump();</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-</span>
<a href="#l7.25"></a><span id="l7.25"> // Globals</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-var gIMAPIncomingServer = IMAPPump.incomingServer;  // nsIMsgIncomingServer for the imap server</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-var gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);  // imap inbox message folder</span>
<a href="#l7.28"></a><span id="l7.28"> var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-var gIMAPMailbox = IMAPPump.mailbox; // imap mailbox</span>
<a href="#l7.30"></a><span id="l7.30"> var gLastKey; // the last message key</span>
<a href="#l7.31"></a><span id="l7.31"> var gFilter; // a message filter with a subject search</span>
<a href="#l7.32"></a><span id="l7.32"> var gAction; // current message action (reused)</span>
<a href="#l7.33"></a><span id="l7.33"> var gInboxListener; // database listener object</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-var gContinueListener; // what listener is used to continue the test?</span>
<a href="#l7.35"></a><span id="l7.35"> var gHeader; // the current message db header</span>
<a href="#l7.36"></a><span id="l7.36"> var gChecks; // the function that will be used to check the results of the filter</span>
<a href="#l7.37"></a><span id="l7.37"> var gInboxCount; // the previous number of messages in the Inbox</span>
<a href="#l7.38"></a><span id="l7.38"> var gSubfolderCount; // the previous number of messages in the subfolder</span>
<a href="#l7.39"></a><span id="l7.39"> var gMoveCallbackCount; // the number of callbacks from the move listener</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-var gCurTestNum; // the current test number</span>
<a href="#l7.41"></a><span id="l7.41"> const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43"> // subject of the test message</span>
<a href="#l7.44"></a><span id="l7.44"> const gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46"> // a string in the body of the test message</span>
<a href="#l7.47"></a><span id="l7.47"> const gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineat">@@ -51,185 +44,157 @@ const kDeleteOrMoveMsgCompleted = Cc[&quot;@m</span>
<a href="#l7.50"></a><span id="l7.50">                                     .getService(Ci.nsIAtomService)</span>
<a href="#l7.51"></a><span id="l7.51">                                     .getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53"> // Definition of tests. The test function name is the filter action</span>
<a href="#l7.54"></a><span id="l7.54"> // being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l7.55"></a><span id="l7.55"> // application of filters due to a body search</span>
<a href="#l7.56"></a><span id="l7.56"> const gTestArray =</span>
<a href="#l7.57"></a><span id="l7.57"> [</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-/**/</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  function DoNothing() {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  setupIMAPPump,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  setupFilters,</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  function *DoNothing() {</span>
<a href="#l7.63"></a><span id="l7.63">     gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    gChecks = function checkDoNothing() {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    }</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l7.74"></a><span id="l7.74">   },</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  function Delete() {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  function *Delete() {</span>
<a href="#l7.78"></a><span id="l7.78">     gAction.type = Ci.nsMsgFilterAction.Delete;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    gChecks = function checkDelete() {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    }</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  },  </span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  function MoveToFolder() {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  },</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  function *MoveToFolder() {</span>
<a href="#l7.94"></a><span id="l7.94">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l7.95"></a><span id="l7.95">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-    gChecks = function checkMoveToFolder() {</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-    // no net messages were added to the inbox</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-    }</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l7.104"></a><span id="l7.104">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  // no net messages were added to the inbox</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+    Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l7.112"></a><span id="l7.112">   },</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-/**/</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  function MarkRead() {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  function *MarkRead() {</span>
<a href="#l7.116"></a><span id="l7.116">     gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    gChecks = function checkMarkRead() {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-      testCounts(false, 0, 0, 0);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-      do_check_true(gHeader.isRead);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    }</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+    testCounts(false, 0, 0, 0);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    Assert.ok(gHeader.isRead);</span>
<a href="#l7.125"></a><span id="l7.125">   },</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-  /**/</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-  function KillThread() {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  function *KillThread() {</span>
<a href="#l7.129"></a><span id="l7.129">     gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    gChecks = function checkKillThread() {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-      // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    }</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+    let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.142"></a><span id="l7.142">   },</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-  function WatchThread() {</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  function *WatchThread() {</span>
<a href="#l7.145"></a><span id="l7.145">     gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    gChecks = function checkWatchThread() {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-      // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    }</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l7.158"></a><span id="l7.158">   },</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  function KillSubthread() {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  function *KillSubthread() {</span>
<a href="#l7.161"></a><span id="l7.161">     gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-    gChecks = function checkKillSubthread() {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-      // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-    }</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  },/**/</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+    // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  },</span>
<a href="#l7.174"></a><span id="l7.174">   // this tests for marking message as junk</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  function JunkScore() {</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  function *JunkScore() {</span>
<a href="#l7.177"></a><span id="l7.177">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l7.178"></a><span id="l7.178">     gAction.junkScore = 100;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-    gChecks = function checkJunkScore() {</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-      // marking as junk resets new but not unread</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-      testCounts(false, 1, 0, 0);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-    }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+    // marking as junk resets new but not unread</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+    testCounts(false, 1, 0, 0);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.191"></a><span id="l7.191">   },</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-  function MarkUnread() {</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  function *MarkUnread() {</span>
<a href="#l7.194"></a><span id="l7.194">     gAction.type = Ci.nsMsgFilterAction.MarkUnread;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    gChecks = function checkMarkUnread() {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-      do_check_true(!gHeader.isRead);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-    }</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    Assert.ok(!gHeader.isRead);</span>
<a href="#l7.203"></a><span id="l7.203">   },</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-  function MarkFlagged() {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  function *MarkFlagged() {</span>
<a href="#l7.206"></a><span id="l7.206">     gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-    gChecks = function checkMarkFlagged() {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-      do_check_true(gHeader.isFlagged);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    }</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+    Assert.ok(gHeader.isFlagged);</span>
<a href="#l7.215"></a><span id="l7.215">   },</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-  function ChangePriority() {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  function *ChangePriority() {</span>
<a href="#l7.218"></a><span id="l7.218">     gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l7.219"></a><span id="l7.219">     gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-    gChecks = function checkChangePriority() {</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-    }</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    Assert.equal(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l7.228"></a><span id="l7.228">   },</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-  function Label() {</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  function *Label() {</span>
<a href="#l7.231"></a><span id="l7.231">     gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l7.232"></a><span id="l7.232">     gAction.label = 2;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-    gChecks = function checkLabel() {</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-      do_check_eq(2, gHeader.label);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-    }</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+    Assert.equal(2, gHeader.label);</span>
<a href="#l7.241"></a><span id="l7.241">   },</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-  function AddTag() {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+  function *AddTag() {</span>
<a href="#l7.244"></a><span id="l7.244">     gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l7.245"></a><span id="l7.245">     gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-    gChecks = function checkAddTag() {</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag&quot;);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    }</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag&quot;);</span>
<a href="#l7.254"></a><span id="l7.254">   },</span>
<a href="#l7.255"></a><span id="l7.255">   // this tests for marking message as good</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-  function JunkScoreAsGood() {</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  function *JunkScoreAsGood() {</span>
<a href="#l7.258"></a><span id="l7.258">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l7.259"></a><span id="l7.259">     gAction.junkScore = 0;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-    gChecks = function checkJunkScore() {</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-    }</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+    Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.270"></a><span id="l7.270">   },</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  function CopyToFolder() {</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+  function *CopyToFolder() {</span>
<a href="#l7.273"></a><span id="l7.273">     gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l7.274"></a><span id="l7.274">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-    gChecks = function checkCopyToFolder() {</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    }</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+    gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l7.282"></a><span id="l7.282">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+    Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+    Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.288"></a><span id="l7.288">   },</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-  function Custom() {</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+  function *Custom() {</span>
<a href="#l7.291"></a><span id="l7.291">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l7.292"></a><span id="l7.292">     gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l7.293"></a><span id="l7.293">     gAction.strValue = 'true';</span>
<a href="#l7.294"></a><span id="l7.294">     actionTestOffline.needsBody = true;</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-    gChecks = function checkCustom() {</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-      testCounts(true, 1, 1, 1);</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-    }</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+    yield setupTest(gFilter, gAction);</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+    testCounts(true, 1, 1, 1);</span>
<a href="#l7.301"></a><span id="l7.301">   },</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+  /**/</span>
<a href="#l7.303"></a><span id="l7.303">   endTest,</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-</span>
<a href="#l7.305"></a><span id="l7.305"> ];</span>
<a href="#l7.306"></a><span id="l7.306"> </span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-function run_test()</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+function run_test() {</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+  gTestArray.forEach(add_task);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  run_next_test();</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+}</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+function setupFilters()</span>
<a href="#l7.315"></a><span id="l7.315"> {</span>
<a href="#l7.316"></a><span id="l7.316"> // Create a non-body filter.</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l7.319"></a><span id="l7.319">   gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l7.320"></a><span id="l7.320">   let searchTerm = gFilter.createTerm();</span>
<a href="#l7.321"></a><span id="l7.321">   searchTerm.attrib = Subject;</span>
<a href="#l7.322"></a><span id="l7.322">   searchTerm.op = Is;</span>
<a href="#l7.323"></a><span id="l7.323">   var value = searchTerm.value;</span>
<a href="#l7.324"></a><span id="l7.324">   value.attrib = Subject;</span>
<a href="#l7.325"></a><span id="l7.325">   value.str = gMessageSubject;</span>
<a href="#l7.326"></a><span id="l7.326">   searchTerm.value = value;</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineat">@@ -239,175 +204,78 @@ function run_test()</span>
<a href="#l7.328"></a><span id="l7.328">   gFilter.enabled = true;</span>
<a href="#l7.329"></a><span id="l7.329"> </span>
<a href="#l7.330"></a><span id="l7.330">   // an action that can be modified by tests</span>
<a href="#l7.331"></a><span id="l7.331">   gAction = gFilter.createAction();</span>
<a href="#l7.332"></a><span id="l7.332"> </span>
<a href="#l7.333"></a><span id="l7.333">   MailServices.filters.addCustomAction(actionTestOffline);</span>
<a href="#l7.334"></a><span id="l7.334">   MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l7.335"></a><span id="l7.335">   gSubfolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-  // all the operations.</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-  do_test_pending();</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-  //start first test</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-  gCurTestNum = 1;</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-  doTest();</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+  gPreviousUnread = 0;</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+  gPreviousDbNew = 0;</span>
<a href="#l7.346"></a><span id="l7.346"> }</span>
<a href="#l7.347"></a><span id="l7.347"> </span>
<a href="#l7.348"></a><span id="l7.348"> /*</span>
<a href="#l7.349"></a><span id="l7.349">  * functions used to support test setup and execution</span>
<a href="#l7.350"></a><span id="l7.350">  */</span>
<a href="#l7.351"></a><span id="l7.351"> </span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-// if the source matches the listener used to continue a test,</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-// run the test checks, and start the next test.</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-function testContinue(source)</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-{</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-  if (gContinueListener === source)</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-  {</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-    if (gContinueListener == kDeleteOrMoveMsgCompleted &amp;&amp;</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-        gAction.type == Ci.nsMsgFilterAction.MoveToFolder)</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-    {</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-      // Moves give 2 events, just use the second.</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-      gMoveCallbackCount++;</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-      if (gMoveCallbackCount != 2)</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-        return;</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-    }</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-    gCurTestNum++;</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-    do_timeout(100, doTest);</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-  }</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-}</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-</span>
<a href="#l7.371"></a><span id="l7.371"> // basic preparation done for each test</span>
<a href="#l7.372"></a><span id="l7.372"> function setupTest(aFilter, aAction)</span>
<a href="#l7.373"></a><span id="l7.373"> {</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-  if (aAction &amp;&amp;</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-      ((aAction.type == Ci.nsMsgFilterAction.CopyToFolder) ||</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-       (aAction.type == Ci.nsMsgFilterAction.Delete) ||</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-       (aAction.type == Ci.nsMsgFilterAction.MoveToFolder)))</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-    gContinueListener = kDeleteOrMoveMsgCompleted;</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-  else</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-    gContinueListener = URLListener;</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-  while (filterList.filterCount)</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-    filterList.removeFilterAt(0);</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  if (aFilter)</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-  {</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-    aFilter.clearActionList();</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-    if (aAction) {</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-      aFilter.appendAction(aAction);</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-      filterList.insertFilterAt(0, aFilter);</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+  return Task.spawn(function* () {</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+    let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+    while (filterList.filterCount)</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+      filterList.removeFilterAt(0);</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+    if (aFilter)</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+    {</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+      aFilter.clearActionList();</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+      if (aAction) {</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+        aFilter.appendAction(aAction);</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+        filterList.insertFilterAt(0, aFilter);</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+      }</span>
<a href="#l7.401"></a><span id="l7.401">     }</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-  }</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-  if (gInboxListener)</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-    gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-  gInboxListener = new DBListener();</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-  gDbService.registerPendingListener(gIMAPInbox, gInboxListener);</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-  gMoveCallbackCount = 0;</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-}</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+    if (gInboxListener)</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+      gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l7.415"></a><span id="l7.415"> </span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-// run the next test</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-function doTest()</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-{</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-  // Run the checks, if any, from the previous test.</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-  if (gChecks)</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-    gChecks();</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-  var test = gCurTestNum;</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-  {</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-        {</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-          if (gCurTestNum == test)</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-            do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-        }</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-      );</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-    try {</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-    testFn();</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-    } catch(ex) {</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineminus">-      endTest();</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-    }</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-  }</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-  else</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-    do_timeout(500, endTest);</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+    gInboxListener = new DBListener();</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+    gDbService.registerPendingListener(IMAPPump.inbox, gInboxListener);</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+    gMoveCallbackCount = 0;</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+    IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+                            IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+    let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+    yield promiseUrlListener.promise;</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+    yield PromiseTestUtils.promiseDelay(200);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+  });</span>
<a href="#l7.455"></a><span id="l7.455"> }</span>
<a href="#l7.456"></a><span id="l7.456"> </span>
<a href="#l7.457"></a><span id="l7.457"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l7.458"></a><span id="l7.458"> // server</span>
<a href="#l7.459"></a><span id="l7.459"> function endTest()</span>
<a href="#l7.460"></a><span id="l7.460"> {</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l7.462"></a><span id="l7.462">   if (gInboxListener)</span>
<a href="#l7.463"></a><span id="l7.463">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+  gInboxListener = null;</span>
<a href="#l7.465"></a><span id="l7.465">   MailServices.mailSession.RemoveFolderListener(FolderListener);</span>
<a href="#l7.466"></a><span id="l7.466">   teardownIMAPPump();</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l7.469"></a><span id="l7.469"> }</span>
<a href="#l7.470"></a><span id="l7.470"> </span>
<a href="#l7.471"></a><span id="l7.471"> /*</span>
<a href="#l7.472"></a><span id="l7.472">  * listener objects</span>
<a href="#l7.473"></a><span id="l7.473">  */</span>
<a href="#l7.474"></a><span id="l7.474"> </span>
<a href="#l7.475"></a><span id="l7.475"> // nsIFolderListener implementation</span>
<a href="#l7.476"></a><span id="l7.476"> var FolderListener = {</span>
<a href="#l7.477"></a><span id="l7.477">   OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l7.478"></a><span id="l7.478">     dump(&quot;received folder event &quot; + aEvent.toString() +</span>
<a href="#l7.479"></a><span id="l7.479">          &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l7.480"></a><span id="l7.480">          &quot;\n&quot;);</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-    testContinue(aEvent);</span>
<a href="#l7.482"></a><span id="l7.482">   }</span>
<a href="#l7.483"></a><span id="l7.483"> };</span>
<a href="#l7.484"></a><span id="l7.484"> </span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-// nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineminus">-// is completed.</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-var CopyListener =</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-{</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-  OnStartCopy: function OnStartCopy() {},</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-  OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-  SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-  {</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-    gLastKey = aKey;</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineminus">-  },</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-  SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-  OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineminus">-  {</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineminus">-    // to return</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-    testContinue(this);</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-  }</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-};</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-var URLListener =</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineminus">-{</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineminus">-  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-  {</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-    testContinue(this);</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-  }</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-}</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineminus">-</span>
<a href="#l7.521"></a><span id="l7.521"> // nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l7.522"></a><span id="l7.522"> // currently used in the tests. Current role is to provide a reference</span>
<a href="#l7.523"></a><span id="l7.523"> // to the new message header (plus give some examples of using db listeners</span>
<a href="#l7.524"></a><span id="l7.524"> // in javascript).</span>
<a href="#l7.525"></a><span id="l7.525"> function DBListener()</span>
<a href="#l7.526"></a><span id="l7.526"> {</span>
<a href="#l7.527"></a><span id="l7.527">   this.counts = {};</span>
<a href="#l7.528"></a><span id="l7.528">   let counts = this.counts;</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineat">@@ -449,17 +317,17 @@ DBListener.prototype =</span>
<a href="#l7.530"></a><span id="l7.530">       this.counts.onParentChanged++;</span>
<a href="#l7.531"></a><span id="l7.531">     },</span>
<a href="#l7.532"></a><span id="l7.532"> </span>
<a href="#l7.533"></a><span id="l7.533">   onAnnouncerGoingAway:</span>
<a href="#l7.534"></a><span id="l7.534">     function onAnnouncerGoingAway(instigator)</span>
<a href="#l7.535"></a><span id="l7.535">     {</span>
<a href="#l7.536"></a><span id="l7.536">       if (gInboxListener)</span>
<a href="#l7.537"></a><span id="l7.537">         try {</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-          gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+          IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l7.540"></a><span id="l7.540">         }</span>
<a href="#l7.541"></a><span id="l7.541">         catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l7.542"></a><span id="l7.542">       this.counts.onAnnouncerGoingAway++;</span>
<a href="#l7.543"></a><span id="l7.543">     },</span>
<a href="#l7.544"></a><span id="l7.544"> </span>
<a href="#l7.545"></a><span id="l7.545">   onReadChanged:</span>
<a href="#l7.546"></a><span id="l7.546">     function onReadChanged(aInstigator)</span>
<a href="#l7.547"></a><span id="l7.547">     {</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineat">@@ -502,98 +370,75 @@ function folderCount(folder)</span>
<a href="#l7.549"></a><span id="l7.549">     dbCount++;</span>
<a href="#l7.550"></a><span id="l7.550">     let hdr = enumerator.getNext();</span>
<a href="#l7.551"></a><span id="l7.551">   }</span>
<a href="#l7.552"></a><span id="l7.552"> </span>
<a href="#l7.553"></a><span id="l7.553">   // count using the folder</span>
<a href="#l7.554"></a><span id="l7.554">   let folderCount = folder.getTotalMessages(false);</span>
<a href="#l7.555"></a><span id="l7.555"> </span>
<a href="#l7.556"></a><span id="l7.556">   // compare the two</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-  do_check_eq(dbCount, folderCount);</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+  Assert.equal(dbCount, folderCount);</span>
<a href="#l7.559"></a><span id="l7.559">   return dbCount;</span>
<a href="#l7.560"></a><span id="l7.560"> }</span>
<a href="#l7.561"></a><span id="l7.561"> </span>
<a href="#l7.562"></a><span id="l7.562" class="difflineminus">-// list all of the messages in a folder for debug</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineminus">-function listMessages(folder) {</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-  var msgCount = 0;</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-  dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-  while(enumerator.hasMoreElements())</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineminus">-  {</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineminus">-    msgCount++;</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-    let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-    dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-  }</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-}</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-</span>
<a href="#l7.575"></a><span id="l7.575"> // given a test file, return the file uri spec</span>
<a href="#l7.576"></a><span id="l7.576"> function specForFileName(aFileName)</span>
<a href="#l7.577"></a><span id="l7.577"> {</span>
<a href="#l7.578"></a><span id="l7.578">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l7.579"></a><span id="l7.579">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l7.580"></a><span id="l7.580">   return msgfileuri.spec;</span>
<a href="#l7.581"></a><span id="l7.581"> }</span>
<a href="#l7.582"></a><span id="l7.582"> </span>
<a href="#l7.583"></a><span id="l7.583"> // shorthand for the inbox message summary database</span>
<a href="#l7.584"></a><span id="l7.584"> function db()</span>
<a href="#l7.585"></a><span id="l7.585"> {</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-  return gIMAPInbox.msgDatabase;</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-}</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineminus">-// This function may be used in the test array to show</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineminus">-// more detailed results after a particular test.</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-function showResults() {</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineminus">-  listMessages(gIMAPInbox);</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-  if (gInboxListener)</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-    printListener(gInboxListener);</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-  gCurTestNum++;</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-  do_timeout(100, doTest);</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineplus">+  return IMAPPump.inbox.msgDatabase;</span>
<a href="#l7.598"></a><span id="l7.598"> }</span>
<a href="#l7.599"></a><span id="l7.599"> </span>
<a href="#l7.600"></a><span id="l7.600"> // static variables used in testCounts</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineminus">-var gPreviousUnread = 0;</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineminus">-var gPreviousDbNew = 0;</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+var gPreviousUnread;</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineplus">+var gPreviousDbNew;</span>
<a href="#l7.605"></a><span id="l7.605"> </span>
<a href="#l7.606"></a><span id="l7.606"> // Test various counts.</span>
<a href="#l7.607"></a><span id="l7.607"> //</span>
<a href="#l7.608"></a><span id="l7.608"> //  aHasNew:         folder hasNew flag</span>
<a href="#l7.609"></a><span id="l7.609"> //  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l7.610"></a><span id="l7.610"> //  aFolderNewDelta: change in new count for the folder</span>
<a href="#l7.611"></a><span id="l7.611"> //  aDbNewDelta:     change in new count for the database</span>
<a href="#l7.612"></a><span id="l7.612"> //</span>
<a href="#l7.613"></a><span id="l7.613"> function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l7.614"></a><span id="l7.614"> {</span>
<a href="#l7.615"></a><span id="l7.615">   try {</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-  let folderNew = gIMAPInbox.getNumNewMessages(false);</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-  let hasNew = gIMAPInbox.hasNewMessages;</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-  let unread = gIMAPInbox.getNumUnread(false);</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+  let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+  let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+  let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l7.622"></a><span id="l7.622">   let countOut = {};</span>
<a href="#l7.623"></a><span id="l7.623">   let arrayOut = {};</span>
<a href="#l7.624"></a><span id="l7.624">   db().getNewList(countOut, arrayOut);</span>
<a href="#l7.625"></a><span id="l7.625">   let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineminus">-  let folderNewFlag = gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+  let folderNewFlag = IMAPPump.inbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l7.628"></a><span id="l7.628">   dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l7.629"></a><span id="l7.629">        &quot; unread: &quot; + unread +</span>
<a href="#l7.630"></a><span id="l7.630">        &quot; folderNew: &quot; + folderNew +</span>
<a href="#l7.631"></a><span id="l7.631">        &quot; folderNewFlag: &quot; + folderNewFlag +</span>
<a href="#l7.632"></a><span id="l7.632">        &quot; dbNew: &quot; + dbNew +</span>
<a href="#l7.633"></a><span id="l7.633">        &quot; prevUnread &quot; + gPreviousUnread +</span>
<a href="#l7.634"></a><span id="l7.634">        &quot;\n&quot;);</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-  //do_check_eq(aHasNew, hasNew);</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-  do_check_eq(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineplus">+  //Assert.equal(aHasNew, hasNew);</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+  Assert.equal(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l7.639"></a><span id="l7.639">   gPreviousUnread = unread;</span>
<a href="#l7.640"></a><span id="l7.640">   // This seems to be reset for each folder update.</span>
<a href="#l7.641"></a><span id="l7.641">   //</span>
<a href="#l7.642"></a><span id="l7.642">   // This check seems to be failing in SeaMonkey builds, yet I can see no ill</span>
<a href="#l7.643"></a><span id="l7.643">   // effects of this in the actual program. Fixing this is complex because of</span>
<a href="#l7.644"></a><span id="l7.644">   // the messiness of new count management (see bug 507638 for a</span>
<a href="#l7.645"></a><span id="l7.645">   // refactoring proposal, and attachment 398899 on bug 514801 for one possible</span>
<a href="#l7.646"></a><span id="l7.646">   // fix to this particular test). So I am disabling this.</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-  //do_check_eq(aFolderNewDelta, folderNew);</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-  //do_check_eq(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineplus">+  //Assert.equal(aFolderNewDelta, folderNew);</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+  //Assert.equal(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l7.651"></a><span id="l7.651">   //gPreviousDbNew = dbNew;</span>
<a href="#l7.652"></a><span id="l7.652">   } catch (e) {dump(e);}</span>
<a href="#l7.653"></a><span id="l7.653"> }</span>
<a href="#l7.654"></a><span id="l7.654"> </span>
<a href="#l7.655"></a><span id="l7.655"> // print the counts for debugging purposes in this test</span>
<a href="#l7.656"></a><span id="l7.656"> function printListener(listener)</span>
<a href="#l7.657"></a><span id="l7.657"> {</span>
<a href="#l7.658"></a><span id="l7.658">   print(&quot;DBListener counts: &quot;);</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineat">@@ -614,21 +459,20 @@ var actionTestOffline =</span>
<a href="#l7.660"></a><span id="l7.660">     {</span>
<a href="#l7.661"></a><span id="l7.661">       var msgHdr = aMsgHdrs.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l7.662"></a><span id="l7.662">       let isOffline = (msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) ? true : false;</span>
<a href="#l7.663"></a><span id="l7.663">       dump(&quot;in actionTestOffline, flags are &quot; + msgHdr.flags +</span>
<a href="#l7.664"></a><span id="l7.664">             &quot; subject is &quot; + msgHdr.subject +</span>
<a href="#l7.665"></a><span id="l7.665">             &quot; isOffline is &quot; + isOffline +</span>
<a href="#l7.666"></a><span id="l7.666">             &quot;\n&quot;);</span>
<a href="#l7.667"></a><span id="l7.667">       // XXX TODO: the offline flag is not set here when it should be in postplugin filters</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineminus">-      //do_check_eq(isOffline, aActionValue == 'true');</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-      do_check_eq(msgHdr.subject, gMessageSubject);</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+      //Assert.equal(isOffline, aActionValue == 'true');</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+      Assert.equal(msgHdr.subject, gMessageSubject);</span>
<a href="#l7.672"></a><span id="l7.672">     }</span>
<a href="#l7.673"></a><span id="l7.673">   },</span>
<a href="#l7.674"></a><span id="l7.674">   isValidForType: function(type, scope) {return true;},</span>
<a href="#l7.675"></a><span id="l7.675"> </span>
<a href="#l7.676"></a><span id="l7.676">   validateActionValue: function(value, folder, type) { return null;},</span>
<a href="#l7.677"></a><span id="l7.677"> </span>
<a href="#l7.678"></a><span id="l7.678">   allowDuplicates: false,</span>
<a href="#l7.679"></a><span id="l7.679"> </span>
<a href="#l7.680"></a><span id="l7.680">   needsBody: true // set during test setup</span>
<a href="#l7.681"></a><span id="l7.681"> };</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,89 +2,64 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> // This tests that we use IMAP move if the IMAP server supports it.</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l8.16"></a><span id="l8.16"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-// IMAP pump</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-</span>
<a href="#l8.21"></a><span id="l8.21"> var gFolder1;</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> var tests = [</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  setupCUSTOM1,</span>
<a href="#l8.25"></a><span id="l8.25">   startTest,</span>
<a href="#l8.26"></a><span id="l8.26">   doMove,</span>
<a href="#l8.27"></a><span id="l8.27">   testMove,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-  endTest</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  teardownIMAPPump</span>
<a href="#l8.30"></a><span id="l8.30"> ];</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-function startTest()</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-{</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+function setupCUSTOM1() {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l8.36"></a><span id="l8.36">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  // Add folder listeners that will capture async events</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  MailServices.mfn.addListener(mfnListener, MailServices.mfn.folderAdded);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  yield false;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  let messages = [];</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  let gMessageGenerator = new MessageGenerator();</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-                  btoa(messages[0].toMessageString()),</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-                  null, null);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  yield false;</span>
<a href="#l8.53"></a><span id="l8.53"> }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-function doMove() {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+function *startTest()</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+{</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  yield PromiseTestUtils.promiseFolderAdded(&quot;folder 1&quot;);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  addImapMessage();</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  yield listener.promise;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+}</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+function *doMove() {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.69"></a><span id="l8.69">   let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l8.70"></a><span id="l8.70">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;)</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-               .QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l8.73"></a><span id="l8.73">   let msg = IMAPPump.inbox.msgDatabase.GetMsgHdrForKey(IMAPPump.mailbox.uidnext - 1);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  gMessages.appendElement(msg, false);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  messages.appendElement(msg, false);</span>
<a href="#l8.76"></a><span id="l8.76">   IMAPPump.server._test = true;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-  MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, true,</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-                            asyncCopyListener, null, false);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, true,</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                                 listener, null, false);</span>
<a href="#l8.82"></a><span id="l8.82">   IMAPPump.server.performTest(&quot;UID MOVE&quot;);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  yield false;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-}</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-function testMove() {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  do_check_eq(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  gFolder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  yield false;</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-  do_check_eq(gFolder1.getTotalMessages(false), 1);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-  yield true;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  yield listener.promise;</span>
<a href="#l8.93"></a><span id="l8.93"> }</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-var mfnListener =</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-{</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-  folderAdded: function folderAdded(aFolder)</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-  {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-    // we are only using async yield on the target folder add</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-    if (aFolder.name == &quot;folder 1&quot;)</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-      async_driver();</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  },</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-};</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-function run_test()</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-{</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  async_run_tests(tests);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+function *testMove() {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+  Assert.equal(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  gFolder1.updateFolderWithListener(null, listener);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  yield listener.promise;</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  Assert.equal(gFolder1.getTotalMessages(false), 1);</span>
<a href="#l8.114"></a><span id="l8.114"> }</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-function endTest()</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-{</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  teardownIMAPPump();</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-  do_test_finished();</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+function run_test() {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  tests.forEach(add_task);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  run_next_test();</span>
<a href="#l8.124"></a><span id="l8.124"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineCopy.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineCopy.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -17,17 +17,16 @@ Components.utils.import(&quot;resource://test</span>
<a href="#l9.4"></a><span id="l9.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l9.9"></a><span id="l9.9"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l9.10"></a><span id="l9.10"> var gMsgFile2 = do_get_file(&quot;../../../data/image-attach-test&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> const gMsgId2 = &quot;4A947F73.5030709@example.com&quot;;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l9.13"></a><span id="l9.13"> var gMsgFile3 = do_get_file(&quot;../../../data/SpamAssassinYes&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> var gMsg3Id = &quot;bugmail7.m47LtAEf007543@mrapp51.mozilla.org&quot;;</span>
<a href="#l9.15"></a><span id="l9.15"> var gMsgFile4 = do_get_file(&quot;../../../data/bug460636&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> var gMsg4Id = &quot;foo.12345@example&quot;;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> var gFolder1;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -57,17 +56,17 @@ var tests = [</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">     setupIMAPPump();</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">     let promiseFolderAdded = PromiseTestUtils.promiseFolderAdded(&quot;folder 1&quot;);</span>
<a href="#l9.26"></a><span id="l9.26">     IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l9.27"></a><span id="l9.27">     yield promiseFolderAdded;</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">     gFolder1 = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    do_check_true(gFolder1 instanceof Ci.nsIMsgFolder);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    Assert.ok(gFolder1 instanceof Ci.nsIMsgFolder);</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">     // these hacks are required because we've created the inbox before</span>
<a href="#l9.34"></a><span id="l9.34">     // running initial folder discovery, and adding the folder bails</span>
<a href="#l9.35"></a><span id="l9.35">     // out before we set it as verified online, so we bail out, and</span>
<a href="#l9.36"></a><span id="l9.36">     // then remove the INBOX folder since it's not verified.</span>
<a href="#l9.37"></a><span id="l9.37">     IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l9.38"></a><span id="l9.38">     IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40" class="difflineat">@@ -89,101 +88,110 @@ var tests = [</span>
<a href="#l9.41"></a><span id="l9.41">      yield promiseUrlListener.promise;</span>
<a href="#l9.42"></a><span id="l9.42">   },</span>
<a href="#l9.43"></a><span id="l9.43">   function *copyMessagesToInbox() {</span>
<a href="#l9.44"></a><span id="l9.44">     let promiseCopyListener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l9.45"></a><span id="l9.45">     MailServices.copy.CopyFileMessage(gMsgFile3, IMAPPump.inbox, null, false, 0,</span>
<a href="#l9.46"></a><span id="l9.46">                                       &quot;&quot;, promiseCopyListener, null);</span>
<a href="#l9.47"></a><span id="l9.47">     yield promiseCopyListener.promise;</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    promiseCopyListener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l9.50"></a><span id="l9.50">     MailServices.copy.CopyFileMessage(gMsgFile4, IMAPPump.inbox, null, false, 0,</span>
<a href="#l9.51"></a><span id="l9.51">                                       &quot;&quot;, promiseCopyListener, null);</span>
<a href="#l9.52"></a><span id="l9.52">     yield promiseCopyListener.promise;</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54">     let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l9.55"></a><span id="l9.55">     IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l9.56"></a><span id="l9.56">     yield promiseUrlListener.promise;</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">     // test the headers in the inbox</span>
<a href="#l9.61"></a><span id="l9.61">     let enumerator = db.EnumerateMessages();</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    let count = 0;</span>
<a href="#l9.63"></a><span id="l9.63">     while (enumerator.hasMoreElements())</span>
<a href="#l9.64"></a><span id="l9.64">     {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+      count++;</span>
<a href="#l9.66"></a><span id="l9.66">       var message = enumerator.getNext();</span>
<a href="#l9.67"></a><span id="l9.67">       message instanceof Ci.nsIMsgDBHdr;</span>
<a href="#l9.68"></a><span id="l9.68">       dump('message &lt;'+ message.subject +</span>
<a href="#l9.69"></a><span id="l9.69">            '&gt; storeToken: &lt;' + message.getStringProperty(&quot;storeToken&quot;) +</span>
<a href="#l9.70"></a><span id="l9.70">            '&gt; offset: &lt;' + message.messageOffset +</span>
<a href="#l9.71"></a><span id="l9.71">            '&gt; id: &lt;' + message.messageId +</span>
<a href="#l9.72"></a><span id="l9.72">            '&gt;\n');</span>
<a href="#l9.73"></a><span id="l9.73">       // This fails for file copies in bug 790912. Without  this, messages that</span>
<a href="#l9.74"></a><span id="l9.74">       //  are copied are not visible in pre-pluggableStores versions of TB (pre TB 12)</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-      do_check_eq(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+      if (IMAPPump.inbox.msgStore.storeType == &quot;mbox&quot;)</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+        Assert.equal(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l9.78"></a><span id="l9.78">     }</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    Assert.equal(count, 4);</span>
<a href="#l9.80"></a><span id="l9.80">   },</span>
<a href="#l9.81"></a><span id="l9.81">   function copyMessagesToSubfolder() {</span>
<a href="#l9.82"></a><span id="l9.82">     //  a message created from IMAP download</span>
<a href="#l9.83"></a><span id="l9.83">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l9.84"></a><span id="l9.84">     let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-    gMessages.appendElement(msg1, false);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+    let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+    messages.appendElement(msg1, false);</span>
<a href="#l9.88"></a><span id="l9.88">     // this is sync, I believe?</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, false,</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, false,</span>
<a href="#l9.91"></a><span id="l9.91">                                    null, null, true);</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">     // two messages originally created from file copies (like in Send)</span>
<a href="#l9.94"></a><span id="l9.94">     let msg3 = db.getMsgHdrForMessageID(gMsg3Id);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-    do_check_true(msg3 instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    gMessages.clear();</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    gMessages.appendElement(msg3, false);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, false,</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    Assert.ok(msg3 instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    messages.clear();</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+    messages.appendElement(msg3, false);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, false,</span>
<a href="#l9.103"></a><span id="l9.103">                                    null, null, true);</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105">     let msg4 = db.getMsgHdrForMessageID(gMsg4Id);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    do_check_true(msg4 instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+    Assert.ok(msg4 instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l9.108"></a><span id="l9.108"> </span>
<a href="#l9.109"></a><span id="l9.109">     // because bug 790912 created messages with correct storeToken but messageOffset=0,</span>
<a href="#l9.110"></a><span id="l9.110">     //  these messages may not copy correctly. Make sure that they do, as fixed in bug 790912</span>
<a href="#l9.111"></a><span id="l9.111">     msg4.messageOffset = 0;</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    gMessages.clear();</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    gMessages.appendElement(msg4, false);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-    MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, false,</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+    messages.clear();</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+    messages.appendElement(msg4, false);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, false,</span>
<a href="#l9.118"></a><span id="l9.118">                                    null, null, true);</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120">     // test the db headers in folder1</span>
<a href="#l9.121"></a><span id="l9.121">     db = gFolder1.msgDatabase;</span>
<a href="#l9.122"></a><span id="l9.122">     let enumerator = db.EnumerateMessages();</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    let count = 0;</span>
<a href="#l9.124"></a><span id="l9.124">     while (enumerator.hasMoreElements())</span>
<a href="#l9.125"></a><span id="l9.125">     {</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+      count++;</span>
<a href="#l9.127"></a><span id="l9.127">       var message = enumerator.getNext();</span>
<a href="#l9.128"></a><span id="l9.128">       message instanceof Ci.nsIMsgDBHdr;</span>
<a href="#l9.129"></a><span id="l9.129">       dump('message &lt;'+ message.subject +</span>
<a href="#l9.130"></a><span id="l9.130">            '&gt; storeToken: &lt;' + message.getStringProperty(&quot;storeToken&quot;) +</span>
<a href="#l9.131"></a><span id="l9.131">            '&gt; offset: &lt;' + message.messageOffset +</span>
<a href="#l9.132"></a><span id="l9.132">            '&gt; id: &lt;' + message.messageId +</span>
<a href="#l9.133"></a><span id="l9.133">            '&gt;\n');</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-      do_check_eq(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+      if (gFolder1.msgStore.storeType == &quot;mbox&quot;)</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+        Assert.equal(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l9.137"></a><span id="l9.137">     }</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    Assert.equal(count, 3);</span>
<a href="#l9.139"></a><span id="l9.139">   },</span>
<a href="#l9.140"></a><span id="l9.140">   function *test_headers() {</span>
<a href="#l9.141"></a><span id="l9.141">     let msgIds = [gMsgId1, gMsg3Id, gMsg4Id];</span>
<a href="#l9.142"></a><span id="l9.142">     for (let msgId of msgIds)</span>
<a href="#l9.143"></a><span id="l9.143">     {</span>
<a href="#l9.144"></a><span id="l9.144">       let newMsgHdr= gFolder1.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+      Assert.ok(newMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l9.146"></a><span id="l9.146">       let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l9.147"></a><span id="l9.147">       let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l9.148"></a><span id="l9.148">       let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l9.149"></a><span id="l9.149">       let promiseStreamListener = new PromiseTestUtils.PromiseStreamListener();</span>
<a href="#l9.150"></a><span id="l9.150">       msgServ.streamHeaders(msgURI, promiseStreamListener, null, true);</span>
<a href="#l9.151"></a><span id="l9.151">       let data = yield promiseStreamListener.promise;</span>
<a href="#l9.152"></a><span id="l9.152">       dump('\nheaders for messageId ' + msgId + '\n' + data + '\n\n');</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-      do_check_true(data.contains(msgId));</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+      Assert.ok(data.contains(msgId));</span>
<a href="#l9.155"></a><span id="l9.155">     }</span>
<a href="#l9.156"></a><span id="l9.156">   },</span>
<a href="#l9.157"></a><span id="l9.157">   teardownIMAPPump</span>
<a href="#l9.158"></a><span id="l9.158"> ];</span>
<a href="#l9.159"></a><span id="l9.159"> </span>
<a href="#l9.160"></a><span id="l9.160"> function run_test() {</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-  for (let test of tests)</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-    add_task(test);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  tests.forEach(add_task);</span>
<a href="#l9.165"></a><span id="l9.165">   run_next_test();</span>
<a href="#l9.166"></a><span id="l9.166"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -11,25 +11,30 @@ load(&quot;../../../resources/messageGenerato</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> var gSecondFolder, gThirdFolder;</span>
<a href="#l10.6"></a><span id="l10.6"> var gSynthMessage1, gSynthMessage2;</span>
<a href="#l10.7"></a><span id="l10.7"> // the message id of bugmail10</span>
<a href="#l10.8"></a><span id="l10.8"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l10.9"></a><span id="l10.9"> var gOfflineManager;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> var tests = [</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  setupIMAPPump,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  function serverParms() {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    Components.utils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+    IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  },</span>
<a href="#l10.17"></a><span id="l10.17">   setup,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  function *prepareToGoOffline() {</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  function prepareToGoOffline() {</span>
<a href="#l10.21"></a><span id="l10.21">     let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l10.22"></a><span id="l10.22">     gSecondFolder = rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l10.23"></a><span id="l10.23">                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l10.24"></a><span id="l10.24">     gThirdFolder =  rootFolder.getChildNamed(&quot;thirdFolder&quot;)</span>
<a href="#l10.25"></a><span id="l10.25">                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l10.26"></a><span id="l10.26">     IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-    yield PromiseTestUtils.promiseDelay(2000);</span>
<a href="#l10.28"></a><span id="l10.28">   },</span>
<a href="#l10.29"></a><span id="l10.29">   function *doOfflineOps() {</span>
<a href="#l10.30"></a><span id="l10.30">     IMAPPump.server.stop();</span>
<a href="#l10.31"></a><span id="l10.31">     Services.io.offline = true;</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">     // Flag the two messages, and then copy them to different folders. Since</span>
<a href="#l10.34"></a><span id="l10.34">     // we're offline, these operations are synchronous.</span>
<a href="#l10.35"></a><span id="l10.35">     let msgHdr1 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineat">@@ -84,21 +89,20 @@ var tests = [</span>
<a href="#l10.37"></a><span id="l10.37">   function checkDone() {</span>
<a href="#l10.38"></a><span id="l10.38">     let msgHdr1 = gSecondFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l10.39"></a><span id="l10.39">     let msgHdr2 = gThirdFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l10.40"></a><span id="l10.40">     let msgHdr3 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l10.41"></a><span id="l10.41">     do_check_neq(msgHdr1, null);</span>
<a href="#l10.42"></a><span id="l10.42">     do_check_neq(msgHdr2, null);</span>
<a href="#l10.43"></a><span id="l10.43">     do_check_neq(msgHdr3, null);</span>
<a href="#l10.44"></a><span id="l10.44">   },</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  teardown</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  teardownIMAPPump</span>
<a href="#l10.47"></a><span id="l10.47"> ];</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49"> function *setup() {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  setupIMAPPump();</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52">   /*</span>
<a href="#l10.53"></a><span id="l10.53">    * Set up an IMAP server.</span>
<a href="#l10.54"></a><span id="l10.54">    */</span>
<a href="#l10.55"></a><span id="l10.55">   IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l10.56"></a><span id="l10.56">   IMAPPump.daemon.createMailbox(&quot;thirdFolder&quot;, {subscribed : true});</span>
<a href="#l10.57"></a><span id="l10.57">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l10.58"></a><span id="l10.58">   // Don't prompt about offline download when going offline</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineat">@@ -127,17 +131,13 @@ function *setup() {</span>
<a href="#l10.60"></a><span id="l10.60">   imapInbox.addMessage(message);</span>
<a href="#l10.61"></a><span id="l10.61"> </span>
<a href="#l10.62"></a><span id="l10.62">   // update folder to download header.</span>
<a href="#l10.63"></a><span id="l10.63">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l10.64"></a><span id="l10.64">   IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l10.65"></a><span id="l10.65">   yield promiseUrlListener.promise;</span>
<a href="#l10.66"></a><span id="l10.66"> }</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-function teardown() {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  teardownIMAPPump();</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-}</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-</span>
<a href="#l10.72"></a><span id="l10.72"> function run_test() {</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l10.74"></a><span id="l10.74">   tests.forEach(add_task);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-</span>
<a href="#l10.76"></a><span id="l10.76">   run_next_test();</span>
<a href="#l10.77"></a><span id="l10.77"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_subfolderLocation.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_subfolderLocation.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -7,33 +7,23 @@ var Cc = Components.classes;</span>
<a href="#l11.4"></a><span id="l11.4"> var Ci = Components.interfaces;</span>
<a href="#l11.5"></a><span id="l11.5"> var Cr = Components.results;</span>
<a href="#l11.6"></a><span id="l11.6"> var CC = Components.Constructor;</span>
<a href="#l11.7"></a><span id="l11.7"> var Cu = Components.utils;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> // async support</span>
<a href="#l11.10"></a><span id="l11.10"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-Cu.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-Cu.import(&quot;resource://gre/modules/Promise.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-// IMAP pump</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-Cu.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-Cu.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> // Globals</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l11.24"></a><span id="l11.24"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26"> add_task(function () {</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-  Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-                             &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l11.29"></a><span id="l11.29">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l11.30"></a><span id="l11.30">   setupIMAPPump();</span>
<a href="#l11.31"></a><span id="l11.31"> });</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33"> // load and update a message in the imap fake server</span>
<a href="#l11.34"></a><span id="l11.34"> add_task(function* loadImapMessage() {</span>
<a href="#l11.35"></a><span id="l11.35">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l11.36"></a><span id="l11.36">                               IMAPPump.mailbox.uidnext++, []));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -30,16 +30,17 @@ skip-if = true</span>
<a href="#l12.4"></a><span id="l12.4"> [test_imapChunks.js]</span>
<a href="#l12.5"></a><span id="l12.5"> [test_imapContentLength.js]</span>
<a href="#l12.6"></a><span id="l12.6"> [test_imapCopyTimeout.js]</span>
<a href="#l12.7"></a><span id="l12.7"> # Disabled until bug 870864 is resolved</span>
<a href="#l12.8"></a><span id="l12.8"> skip-if = true</span>
<a href="#l12.9"></a><span id="l12.9"> [test_imapFilterActions.js]</span>
<a href="#l12.10"></a><span id="l12.10"> run-sequentially = failed once when run in parallel</span>
<a href="#l12.11"></a><span id="l12.11"> [test_imapFilterActionsPostplugin.js]</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+run-sequentially = test depends on delays for async completion</span>
<a href="#l12.13"></a><span id="l12.13"> [test_imapFlagChange.js]</span>
<a href="#l12.14"></a><span id="l12.14"> [test_imapFolderCopy.js]</span>
<a href="#l12.15"></a><span id="l12.15"> [test_imapHdrChunking.js]</span>
<a href="#l12.16"></a><span id="l12.16"> # Disabled until bug 870864 is resolved</span>
<a href="#l12.17"></a><span id="l12.17"> skip-if = true</span>
<a href="#l12.18"></a><span id="l12.18"> [test_imapHdrStreaming.js]</span>
<a href="#l12.19"></a><span id="l12.19"> [test_imapHighWater.js]</span>
<a href="#l12.20"></a><span id="l12.20"> # Disabled until bug 870864 is resolved</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -30,16 +30,17 @@ Components.utils.import(&quot;resource://test</span>
<a href="#l13.4"></a><span id="l13.4"> var IMAPPump = {</span>
<a href="#l13.5"></a><span id="l13.5">   daemon: null,         // the imap fake server daemon</span>
<a href="#l13.6"></a><span id="l13.6">   server: null,         // the imap fake server</span>
<a href="#l13.7"></a><span id="l13.7">   incomingServer: null, // nsIMsgIncomingServer for the imap server</span>
<a href="#l13.8"></a><span id="l13.8">   inbox: null,          // nsIMsgFolder/nsIMsgImapMailFolder for imap inbox</span>
<a href="#l13.9"></a><span id="l13.9">   mailbox: null         // imap fake server mailbox</span>
<a href="#l13.10"></a><span id="l13.10"> };</span>
<a href="#l13.11"></a><span id="l13.11"> var Ci = Components.interfaces;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+var Cc = Components.classes;</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> function setupIMAPPump(extensions)</span>
<a href="#l13.15"></a><span id="l13.15"> {</span>
<a href="#l13.16"></a><span id="l13.16">   // Create Application info if we need it.</span>
<a href="#l13.17"></a><span id="l13.17">   updateAppInfo();</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">   // These are copied from imap's head_server.js to here so we can run</span>
<a href="#l13.20"></a><span id="l13.20">   //   this from any directory.</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -106,23 +107,28 @@ function setupIMAPPump(extensions)</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   IMAPPump.incomingServer.performExpand(null);</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">   IMAPPump.inbox = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l13.26"></a><span id="l13.26">   IMAPPump.mailbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l13.27"></a><span id="l13.27">   IMAPPump.inbox instanceof Ci.nsIMsgImapMailFolder;</span>
<a href="#l13.28"></a><span id="l13.28"> }</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+// This will clear not only the imap accounts but also local accounts.</span>
<a href="#l13.31"></a><span id="l13.31"> function teardownIMAPPump()</span>
<a href="#l13.32"></a><span id="l13.32"> {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  IMAPPump.inbox = null;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  IMAPPump.server.resetTest();</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  try {</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-    serverSink.abortQueuedUrls();</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  } catch (ex) {dump(ex);}</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  IMAPPump.server.performTest();</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  IMAPPump.server.stop();</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  // try to finish any pending operations</span>
<a href="#l13.43"></a><span id="l13.43">   let thread = gThreadManager.currentThread;</span>
<a href="#l13.44"></a><span id="l13.44">   while (thread.hasPendingEvents())</span>
<a href="#l13.45"></a><span id="l13.45">     thread.processNextEvent(true);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  IMAPPump.inbox = null;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  try {</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    serverSink.abortQueuedUrls();</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    IMAPPump.server.resetTest();</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    IMAPPump.server.stop();</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+    MailServices.accounts.removeIncomingServer(IMAPPump.incomingServer, false);</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    localAccountUtils.clearAll();</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  } catch (ex) {dump(ex);}</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+</span>
<a href="#l13.58"></a><span id="l13.58"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/test/resources/PromiseTestUtils.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/test/resources/PromiseTestUtils.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -244,15 +244,54 @@ PromiseTestUtils.promiseFolderAdded = fu</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> /**</span>
<a href="#l14.6"></a><span id="l14.6">  * Timer to resolve a promise after a delay</span>
<a href="#l14.7"></a><span id="l14.7">  *</span>
<a href="#l14.8"></a><span id="l14.8">  * @param aDelay    delay in milliseconds</span>
<a href="#l14.9"></a><span id="l14.9">  * @return          promise that resolves after the delay</span>
<a href="#l14.10"></a><span id="l14.10">  */</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-PromiseTestUtils.promiseDelay= function promiseDelay(aDelay)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+PromiseTestUtils.promiseDelay = function promiseDelay(aDelay)</span>
<a href="#l14.14"></a><span id="l14.14"> {</span>
<a href="#l14.15"></a><span id="l14.15">   return new Promise((resolve, reject) =&gt; {</span>
<a href="#l14.16"></a><span id="l14.16">     let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l14.17"></a><span id="l14.17">     timer.initWithCallback(resolve, aDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l14.18"></a><span id="l14.18">   });</span>
<a href="#l14.19"></a><span id="l14.19"> }</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+/**</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Search listener to resolve a promise when a search completes</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ *</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ * @param [aSearchSession] The nsIMsgSearchSession to search</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * @param [aWrapped] The nsIMsgSearchNotify to pass all notifications through to.</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *     This gets called prior to the callback (or async resumption).</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ */</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+PromiseTestUtils.PromiseSearchNotify = function(aSearchSession, aWrapped) {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  this._searchSession = aSearchSession;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  this._searchSession.registerListener(this);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  this.wrapped = aWrapped ? aWrapped.QueryInterface(Ci.nsIMsgSearchNotify) : null;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  this._promise = new Promise((resolve, reject) =&gt; {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    this._resolve = resolve;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    this._reject = reject;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  });</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+}</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ </span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+PromiseTestUtils.PromiseSearchNotify.prototype = {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgSearchNotify]),</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  onSearchHit: function(aHeader, aFolder) {</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+    if (this.wrapped &amp;&amp; this.wrapped.onSearchHit)</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+      this.wrapped.onSearchHit(aHeader, aFolder);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  },</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  onSearchDone: function onSearchDone(aResult) {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+    this._searchSession.unregisterListener(this);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+    if (this.wrapped &amp;&amp; this.wrapped.onSearchDone)</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+      this.wrapped.onSearchDone(aResult);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    if (aResult == Cr.NS_OK)</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      this._resolve();</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    else</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+      this._reject(aResult);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  },</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  onNewSearch: function onNewSearch() {</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+    if (this.wrapped &amp;&amp; this.wrapped.onNewSearch)</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+      this.wrapped.onNewSearch();</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  }</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

